<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSIÓN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Variables CSS generales */
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
        }
        
        /* Estados de loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0d6efd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tarjetas de métricas */
        .metric-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0;
        }
        
        .metric-icon {
            font-size: 1.5rem;
        }
        
        /* Tarjetas de módulos */
        .module-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
            height: 100%;
            overflow: hidden;
        }
        
        .module-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 24px rgba(0,0,0,0.15);
            color: inherit;
            text-decoration: none;
        }
        
        .module-card-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .module-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }
        
        .module-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .module-description {
            font-size: 0.875rem;
            color: #6c757d;
            line-height: 1.4;
            margin-bottom: 0;
        }
        
        /* Header del dashboard */
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 24px 24px;
        }
        
        .dashboard-welcome {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .dashboard-subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .metric-value {
                font-size: 1.5rem;
            }
            
            .module-icon {
                width: 40px;
                height: 40px;
                font-size: 1.25rem;
            }
            
            .dashboard-welcome {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando dashboard...</p>
        </div>
    </div>

    <!-- Header del Dashboard -->
    <div class="dashboard-header">
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <h1 class="dashboard-welcome">
                        <i class="bi bi-grid-3x3-gap me-2"></i>
                        <span id="welcome-message">Bienvenido a SchoolNet</span>
                    </h1>
                    <p class="dashboard-subtitle" id="user-info">
                        Sistema de Gestión Educativa
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- SECCIÓN DE MÉTRICAS CON CARGA DIFERIDA -->
        <div class="row mb-5" id="metrics-section">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-muted mb-0">
                        <i class="bi bi-graph-up me-2"></i>Resumen General
                    </h5>
                    <!-- BOTÓN DE CARGA DE MÉTRICAS -->
                    <button class="btn btn-outline-primary btn-sm" id="btn-load-metrics" onclick="cargarMetricas()">
                        <i class="bi bi-bar-chart me-1"></i>Cargar Métricas
                    </button>
                </div>
                
                <div class="row g-3" id="metrics-container">
                    <!-- Métrica 1: Estudiantes Activos -->
                    <div class="col-6 col-lg-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="metric-value text-primary" id="metric-students-value">
                                        <span class="text-muted">--</span>
                                    </div>
                                    <i class="bi bi-mortarboard-fill metric-icon text-primary"></i>
                                </div>
                                <p class="metric-label">Estudiantes Activos</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Métrica 2: Trabajadores Activos -->
                    <div class="col-6 col-lg-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="metric-value text-success" id="metric-workers-value">
                                        <span class="text-muted">--</span>
                                    </div>
                                    <i class="bi bi-person-badge-fill metric-icon text-success"></i>
                                </div>
                                <p class="metric-label">Trabajadores Activos</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Métrica 3: Profesores -->
                    <div class="col-6 col-lg-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="metric-value text-info" id="metric-teachers-value">
                                        <span class="text-muted">--</span>
                                    </div>
                                    <i class="bi bi-journal-text metric-icon text-info"></i>
                                </div>
                                <p class="metric-label">Profesores</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Métrica 4: Educadores -->
                    <div class="col-6 col-lg-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="metric-value text-warning" id="metric-educators-value">
                                        <span class="text-muted">--</span>
                                    </div>
                                    <i class="bi bi-bookshelf metric-icon text-warning"></i>
                                </div>
                                <p class="metric-label">Educadores</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GRID DE MÓDULOS -->
        <div class="row mb-5">
            <div class="col-12">
                <h5 class="text-muted mb-3">
                    <i class="bi bi-grid-3x3-gap me-2"></i>Módulos del Sistema
                </h5>
                
                <div class="row g-3" id="modules-container">
                    <!-- Los módulos se cargarán dinámicamente -->
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPTS - ORDEN CRÍTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/config.js"></script>
    <script>
        // ==========================================
        // CONFIGURACIÓN DE MÓDULOS CON COLORES
        // ==========================================
        const MODULES_CONFIG = [
            {
                id: 'security',
                name: 'Seguridad',
                description: 'Gestión de usuarios, roles y permisos',
                icon: 'bi-shield-lock',
                path: '/modules/security/',
                color: '#dc3545',
                lightColor: '#f8d7da',
                modulePermissions: [
                    'Gestión de permisos',
                    'Gestión de usuarios',
                    'Asignar roles',
                    'Gestión de roles',
                    'Configurar permisos',
                    'Logs de auditoría'
                ]
            },
            {
                id: 'config',
                name: 'Configuración',
                description: 'Configuración general del sistema',
                icon: 'bi-gear',
                path: '/modules/config/',
                color: '#6f42c1',
                lightColor: '#e2d9f3',
                modulePermissions: [
                    'Configuración general',
                    'Años académicos',
                    'Gestionar secciones',
                    'Gestionar grados',
                    'Gestionar cursos',
                    'Gestionar áreas académicas',
                    'Gestionar programas',
                    'Gestionar estudiantes'
                ]
            },
            {
                id: 'indicators',
                name: 'Indicadores',
                description: 'Dashboard y métricas del sistema',
                icon: 'bi-graph-up',
                path: '/modules/indicators/',
                color: '#198754',
                lightColor: '#d1e7dd',
                modulePermissions: [
                    'Segmentaciones',
                    'Captura de datos',
                    'Variables',
                    'Asignar variables a usuarios',
                    'Indicadores'
                ]
            },
            {
                id: 'hr',
                name: 'Talento Humano',
                description: 'Gestión organizacional y personal',
                icon: 'bi-people',
                path: '/modules/hr/',
                color: '#fd7e14',
                lightColor: '#ffe5d0',
                modulePermissions: [
                    'Divisiones',
                    'Centros de costos',
                    'Secciones / Áreas',
                    'Subáreas',
                    'Roles y cargos',
                    'Gestionar trabajadores',
                    'Revisión de nómina'
                ]
            },
            {
                id: 'budget',
                name: 'Presupuesto',
                description: 'Gestión presupuestal y financiera',
                icon: 'bi-calculator',
                path: '/modules/budget/',
                color: '#0d6efd',
                lightColor: '#cfe2ff',
                modulePermissions: [
                    'Gestionar PUC',
                    'Subir el combo',
                    'Gestionar IVA asociado',
                    'Gestionar rubros',
                    'Gestionar subítems',
                    'Gestionar proveedores',
                    'Inicializar año presupuestal',
                    'Inicializar año presupuestal - Generales',
                    'Autorización de presupuesto',
                    'Asociar facturas',
                    'Diseño de informes',
                    'Informe de asignaciones',
                    'Cruce contable',
                    'Petición de presupuesto',
                    'Designar solicitantes',
                    'Solicitud de ejecución',
                    'Solicitud de cierre',
                    'Resolución de solicitudes',
                    'Cerrar requerimientos sobrejeecutados',
                    'Iniciar traslado presupuestal',
                    'Cerrar traslado presupuestal',
                    'Vista detallada por rubro',
                    'Vista particular del presupuesto',
                    'Consultas de presupuesto'
                ]
            },
            {
                id: 'new-students',
                name: 'Gestión de Estudiantes Nuevos',
                description: 'Proceso de inculturación para estudiantes nuevos',
                icon: 'bi-person-plus',
                path: '/modules/new-students/',
                color: '#20c997',
                lightColor: '#d2f4ea',
                modulePermissions: [
                    'Actividades',
                    'Actores',
                    'Reporte de estudiantes nuevos',
                    'Registrar actividades',
                    'Consulta de registro',
                    'Tablero de control'
                ]
            },
            {
                id: 'follow-ups',
                name: 'Seguimientos',
                description: 'Gestión de seguimientos académicos y disciplinarios',
                icon: 'bi-clipboard-check',
                path: '/modules/follow-ups/',
                color: '#ffc107',
                lightColor: '#fff3cd',
                modulePermissions: [
                    'Gestionar categorías',
                    'Asignar usuarios a cursos',
                    'Registrar asuntos individuales',
                    'Registrar asuntos EAE',
                    'Revisar asuntos individuales',
                    'Gestionar asuntos EAE',
                    'Seguimientos por cursos',
                    'Registrar asuntos grupales',
                    'Gestionar asuntos grupales',
                    'Gestionar asuntos no escalados',
                    'Gestionar tareas',
                    'Consultas a seguimientos por cursos',
                    'Consultas'
                ]
            }
        ];

        // ==========================================
        // CONFIGURACIÓN DE MÉTRICAS
        // ==========================================
        // ==========================================
        // CONFIGURACIÓN DE MÉTRICAS
        // ==========================================
        // ==========================================
        // CONFIGURACIÓN DE MÉTRICAS
        // ==========================================
        const METRICS_CONFIG = [
            {
                id: 'metric-students',
                label: 'Estudiantes Activos',
                icon: 'mortarboard-fill',
                query: '/students?select=worker_id,student_status!inner(status_description)&student_status.status_description=eq.Matriculado',
                format: 'number',
                allowedRoles: ['Estrategas', 'Directivos docentes'],
                customCount: true
            },
            {
                id: 'metric-workers',
                label: 'Trabajadores Activos',
                icon: 'person-badge-fill',
                query: '/workers?select=worker_id&worker_status=eq.active',
                format: 'number',
                allowedRoles: ['Estrategas'],
                customCount: true
            },
            {
                id: 'metric-teachers',
                label: 'Profesores',
                icon: 'journal-text',
                query: '/worker_job_roles?select=worker_id,workers!inner(worker_status),job_roles!inner(role_name)&workers.worker_status=eq.active&job_roles.role_name=eq.Profesor',
                format: 'number',
                allowedRoles: ['Estrategas', 'Directivos docentes'],
                customCount: true
            },
            {
                id: 'metric-educators',
                label: 'Educadores',
                icon: 'bookshelf',
                query: '/workers?select=worker_id,organizational_divisions!inner(division_name)&organizational_divisions.division_name=eq.Academia&worker_status=eq.active',
                format: 'number',
                allowedRoles: ['Estrategas', 'Directivos docentes'],
                customCount: true
            }
        ];
        
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let userRoles = [];
        let userPermissions = [];
        let metricsLoaded = false;

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando dashboard...');
            
            try {
                mostrarLoading();
                
                // Verificar sesión
                const session = getStoredSession();
                if (!session || !session.user) {
                    console.log('❌ No hay sesión activa');
                    window.location.href = '/login.html';
                    return;
                }
                
                currentUser = session.user;
                
                // Cargar datos del usuario
                await cargarDatosUsuario();
                
                // Personalizar bienvenida
                personalizarBienvenida();
                
                // Cargar módulos según permisos
                await cargarModulos();
                
                ocultarLoading();
                console.log('✅ Dashboard inicializado correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando dashboard:', error);
                showMessage('Error al cargar el dashboard: ' + error.message, 'danger');
                ocultarLoading();
            }
        });

        // ==========================================
        // CARGAR DATOS DE USUARIO Y ROLES
        // ==========================================
        async function cargarDatosUsuario() {
            try {
                // Obtener roles del usuario
                userRoles = await obtenerRolesUsuario(currentUser.user_id);
                
                // Obtener TODOS los permisos en una sola query
                userPermissions = await obtenerTodosLosPermisosUsuario(currentUser.user_id);
                
                console.log('✅ Datos de usuario cargados');
                console.log('🔑 Roles:', userRoles);
                console.log('🔐 Permisos:', userPermissions.length);
                
            } catch (error) {
                console.error('❌ Error cargando datos de usuario:', error);
            }
        }
        // ==========================================
        // OBTENER ROLES DEL USUARIO
        // ==========================================
        async function obtenerRolesUsuario(userId) {
            try {
                const data = await supabaseRequest(`/user_roles?select=roles(role_name)&user_id=eq.${userId}`);
                return data.map(ur => ur.roles.role_name);
            } catch (error) {
                console.error('❌ Error obteniendo roles:', error);
                return [];
            }
        }

        // ==========================================
        // OBTENER TODOS LOS PERMISOS DEL USUARIO - OPTIMIZADO
        // ==========================================
        async function obtenerTodosLosPermisosUsuario(userId) {
            try {
                // Verificar si es super admin primero
                const isSuperAdmin = await checkUserIsSuperAdmin(userId);
                if (isSuperAdmin) {
                    // Super admin tiene todos los permisos
                    return MODULES_CONFIG.flatMap(m => m.modulePermissions);
                }
                
                // Una sola query para obtener todos los permisos
                const data = await supabaseRequest(`/users?select=user_roles(role_id,roles(role_permissions(permissions(permission_name))))&user_id=eq.${userId}`);
                
                if (!data || data.length === 0) {
                    return [];
                }
                
                // Extraer todos los permisos en un array
                const permissions = [];
                data[0].user_roles?.forEach(userRole => {
                    userRole.roles?.role_permissions?.forEach(rolePermission => {
                        const permName = rolePermission.permissions?.permission_name;
                        if (permName && !permissions.includes(permName)) {
                            permissions.push(permName);
                        }
                    });
                });
                
                return permissions;
                
            } catch (error) {
                console.error('❌ Error obteniendo permisos:', error);
                return [];
            }
        }

        // ==========================================
        // VERIFICAR SI USUARIO ES SUPER ADMIN
        // ==========================================
        async function checkUserIsSuperAdmin(userId) {
            try {
                const userData = await supabaseRequest(`/user_roles?select=roles(is_super_admin)&user_id=eq.${userId}`);
                return userData.some(ur => ur.roles?.is_super_admin === true);
            } catch (error) {
                console.error('❌ Error verificando super admin:', error);
                return false;
            }
        }

        // ==========================================
        // PERSONALIZAR BIENVENIDA
        // ==========================================
        function personalizarBienvenida() {
            const welcomeMessage = document.getElementById('welcome-message');
            const userInfo = document.getElementById('user-info');
            
            if (currentUser.user_display_name) {
                welcomeMessage.innerHTML = `
                    <i class="bi bi-grid-3x3-gap me-2"></i>
                    Bienvenido, ${currentUser.user_display_name}
                `;
            }
            
            if (userRoles.length > 0) {
                userInfo.textContent = `Rol: ${userRoles.join(', ')}`;
            }
        }

        // ==========================================
        // CARGAR MÓDULOS SEGÚN PERMISOS
        // ==========================================
        async function cargarModulos() {
            try {
                console.log('📦 Cargando módulos según permisos...');
                
                const container = document.getElementById('modules-container');
                let modulesHtml = '';
                
                for (const module of MODULES_CONFIG) {
                    // Verificar si tiene AL MENOS un permiso del módulo
                    const hasAccess = module.modulePermissions.some(perm => 
                        userPermissions.includes(perm)
                    );
                    
                    if (!hasAccess) {
                        console.log(`⏭️ Módulo ${module.name} omitido - sin permisos`);
                        continue;
                    }
                    
                    modulesHtml += `
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="${module.path}index.html" class="module-card card">
                                <div class="module-card-header" style="background: linear-gradient(135deg, ${module.color} 0%, ${module.color}dd 100%);">
                                    <div class="module-icon" style="background-color: rgba(255,255,255,0.2);">
                                        <i class="bi ${module.icon}"></i>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <h6 class="module-title">${module.name}</h6>
                                    <p class="module-description">${module.description}</p>
                                </div>
                            </a>
                        </div>
                    `;
                }
                
                if (modulesHtml === '') {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-warning text-center">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                No tienes acceso a ningún módulo. Contacta al administrador.
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = modulesHtml;
                }
                
                console.log('✅ Módulos cargados correctamente');
                
            } catch (error) {
                console.error('❌ Error cargando módulos:', error);
                showMessage('Error al cargar módulos: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // CARGA DIFERIDA DE MÉTRICAS
        // ==========================================
        // ==========================================
        // CARGA DIFERIDA DE MÉTRICAS
        // ==========================================
        async function cargarMetricas() {
            // Evitar múltiples cargas
            if (metricsLoaded) {
                showMessage('Las métricas ya están cargadas', 'info');
                return;
            }
            
            const btnLoadMetrics = document.getElementById('btn-load-metrics');
            
            try {
                // Cambiar estado del botón
                btnLoadMetrics.disabled = true;
                btnLoadMetrics.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Cargando...';
                
                console.log('📊 Cargando métricas según roles del usuario...');
                
                for (const metric of METRICS_CONFIG) {
                    try {
                        // Verificar acceso a métrica
                        const tieneAccesoMetrica = verificarAccesoMetrica(metric, userRoles);
                        
                        if (!tieneAccesoMetrica) {
                            console.log(`⏭️ Métrica ${metric.id} omitida - sin roles requeridos`);
                            ocultarTarjetaMetrica(metric.id);
                            continue;
                        }
                        
                        let value = 0;
                        
                        // Ejecutar query para obtener métrica
                        if (metric.query) {
                            const data = await supabaseRequest(metric.query);
                            
                            // Si tiene customCount, contar workers únicos
                            if (metric.customCount && Array.isArray(data)) {
                                const uniqueWorkers = [...new Set(data.map(item => item.worker_id))];
                                value = uniqueWorkers.length;
                            }
                            // Manejar respuesta con count
                            else if (Array.isArray(data) && data.length > 0 && data[0].count !== undefined) {
                                value = data[0].count;
                            } else if (Array.isArray(data)) {
                                value = data.length;
                            } else {
                                value = data || 0;
                            }
                        }
                        
                        // Formatear y mostrar valor
                        const formattedValue = formatearValorMetrica(value, metric.format);
                        const elemento = document.getElementById(metric.id + '-value');
                        if (elemento) {
                            elemento.innerHTML = formattedValue;
                        }
                        
                    } catch (error) {
                        console.error(`❌ Error cargando métrica ${metric.id}:`, error);
                        const elemento = document.getElementById(metric.id + '-value');
                        if (elemento) {
                            elemento.innerHTML = '<span class="text-danger">Error</span>';
                        }
                    }
                }
                
                reorganizarGridMetricas();
                
                metricsLoaded = true;
                
                // Actualizar botón a modo "Actualizar"
                btnLoadMetrics.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Actualizar Métricas';
                btnLoadMetrics.disabled = false;
                
                console.log('✅ Métricas cargadas exitosamente');
                showMessage('Métricas cargadas correctamente', 'success');
                
            } catch (error) {
                console.error('❌ Error general cargando métricas:', error);
                btnLoadMetrics.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Error al cargar';
                btnLoadMetrics.disabled = false;
                showMessage('Error al cargar métricas: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // VERIFICAR ACCESO A MÉTRICA POR ROLES
        // ==========================================
        function verificarAccesoMetrica(metric, userRoles) {
            // Si no tiene restricción de roles, mostrar a todos
            if (!metric.allowedRoles || metric.allowedRoles.length === 0) {
                return true;
            }
            
            // Super Admin ve TODAS las métricas
            const hasAdminRole = userRoles.some(role => 
                role.toLowerCase().includes('admin') || 
                role.toLowerCase().includes('super')
            );
            
            if (hasAdminRole) {
                return true;
            }
            
            // Verificar si tiene algún rol permitido específico
            return metric.allowedRoles.some(roleRequired => 
                userRoles.includes(roleRequired)
            );
        }

        // ==========================================
        // FUNCIONES DE UTILIDAD PARA MÉTRICAS
        // ==========================================
        function ocultarTarjetaMetrica(metricId) {
            const elemento = document.getElementById(metricId + '-value');
            if (elemento) {
                const tarjeta = elemento.closest('.col-6, .col-lg-3');
                if (tarjeta) {
                    tarjeta.style.display = 'none';
                }
            }
        }
        
        function reorganizarGridMetricas() {
            const container = document.getElementById('metrics-container');
            const tarjetasVisibles = container.querySelectorAll('.col-6:not([style*="display: none"]), .col-lg-3:not([style*="display: none"])');
            
            // Si no hay métricas visibles, ocultar toda la sección
            if (tarjetasVisibles.length === 0) {
                document.getElementById('metrics-section').style.display = 'none';
            }
        }

        // ==========================================
        // FUNCIONES DE UTILIDAD GENERALES
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function formatearValorMetrica(value, format) {
            switch (format) {
                case 'percentage':
                    return value + '%';
                case 'currency':
                    return new Intl.NumberFormat('es-CO', {
                        style: 'currency',
                        currency: 'COP',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(value);
                case 'number':
                default:
                    return new Intl.NumberFormat('es-CO').format(value);
            }
        }

        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.cargarMetricas = cargarMetricas;
        
        console.log('🎉 Dashboard SchoolNet cargado correctamente');
    </script>
</body>
</html>
