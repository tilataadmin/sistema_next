<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de la comunidad - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* M√©tricas superiores */
        .metric-badge {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            margin: 0.25rem;
            display: inline-block;
        }
        
        .metric-badge strong {
            color: #495057;
            font-size: 1.25rem;
        }
        
        .metric-badge small {
            color: #6c757d;
            display: block;
            margin-top: 0.25rem;
        }
        
        /* Tarjetas de comunidad */
        .community-card {
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
            background: white;
        }
        
        .community-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .student-photo, .worker-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e9ecef;
        }
        
        .photo-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid #dee2e6;
        }
        
        .photo-placeholder i {
            font-size: 2rem;
            color: #adb5bd;
        }
        
        /* Fotos de hijos en familia */
        .child-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e9ecef;
            margin: 0.25rem;
        }
        
        .child-photo-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #dee2e6;
            margin: 0.25rem;
        }
        
        .child-photo-placeholder i {
            font-size: 1.5rem;
            color: #adb5bd;
        }
        
        .child-info {
            text-align: center;
            margin: 0.25rem;
            max-width: 60px;
        }
        
        .child-info small {
            display: block;
            font-size: 0.75rem;
            line-height: 1.2;
        }
        
        /* Paginaci√≥n */
        .pagination-info {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        /* Filtros */
        .filter-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        /* Tabs personalizados */
        .nav-tabs .nav-link {
            color: #495057;
            border: none;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            border-bottom: 3px solid #0d6efd;
            background: transparent;
        }
        
        .nav-tabs .nav-link:hover {
            border-bottom: 3px solid #0d6efd;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>
    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Consulta de la comunidad
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-people me-2"></i>
                    Consulta de la comunidad
                </h1>
                <p class="text-muted">
                    Busca y consulta informaci√≥n de estudiantes, familias y trabajadores de la instituci√≥n
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- PESTA√ëAS PRINCIPALES -->
        <ul class="nav nav-tabs mb-4" id="communityTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="students-tab" data-bs-toggle="tab" 
                        data-bs-target="#students-panel" type="button" role="tab">
                    <i class="bi bi-mortarboard me-2"></i>Estudiantes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="families-tab" data-bs-toggle="tab" 
                        data-bs-target="#families-panel" type="button" role="tab">
                    <i class="bi bi-house-heart me-2"></i>Familias
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="workers-tab" data-bs-toggle="tab" 
                        data-bs-target="#workers-panel" type="button" role="tab">
                    <i class="bi bi-person-badge me-2"></i>Trabajadores
                </button>
            </li>
        </ul>

        <!-- CONTENIDO DE LAS PESTA√ëAS -->
        <div class="tab-content" id="communityTabContent">
            
            <!-- ========================================= -->
            <!-- PESTA√ëA 1: ESTUDIANTES -->
            <!-- ========================================= -->
            <div class="tab-pane fade show active" id="students-panel" role="tabpanel">
                
                <!-- M√©tricas Estudiantes -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="metric-badge">
                            <strong id="students-total">0</strong>
                            <small>Total estudiantes</small>
                        </div>
                        <div class="metric-badge">
                            <strong id="students-male">0</strong>
                            <small>Masculino</small>
                        </div>
                        <div class="metric-badge">
                            <strong id="students-female">0</strong>
                            <small>Femenino</small>
                        </div>
                    </div>
                </div>

                <!-- Filtros y Buscador Estudiantes -->
                <div class="filter-section">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="student-status-filter">
                                <option value="active" selected>Activos</option>
                                <option value="inactive">Inactivos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Curso</label>
                            <select class="form-select" id="student-course-filter">
                                <option value="">Todos los cursos</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Buscar estudiante</label>
                            <input type="text" class="form-control" id="student-search" 
                                   placeholder="Buscar por nombre o apellidos...">
                        </div>
                    </div>
                </div>

                <!-- Listado de Estudiantes -->
                <div id="students-container" class="row g-3 mb-3">
                    <!-- Tarjetas generadas din√°micamente -->
                </div>

                <!-- Paginaci√≥n Estudiantes -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="pagination-info" id="students-pagination-info"></div>
                    </div>
                    <div class="col-md-6">
                        <nav>
                            <ul class="pagination justify-content-end mb-0" id="students-pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
            <!-- ========================================= -->
            <!-- PESTA√ëA 2: FAMILIAS -->
            <!-- ========================================= -->
            <div class="tab-pane fade" id="families-panel" role="tabpanel">
                
                <!-- M√©tricas Familias -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="metric-badge">
                            <strong id="families-total">0</strong>
                            <small>Total familias</small>
                        </div>
                        <div class="metric-badge">
                            <strong id="families-one-child">0</strong>
                            <small>Con 1 hijo</small>
                        </div>
                        <div class="metric-badge">
                            <strong id="families-two-children">0</strong>
                            <small>Con 2 hijos</small>
                        </div>
                        <div class="metric-badge">
                            <strong id="families-many-children">0</strong>
                            <small>Con m√°s de 2 hijos</small>
                        </div>
                    </div>
                </div>

                <!-- Filtros y Buscador Familias -->
                <div class="filter-section">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Curso</label>
                            <select class="form-select" id="family-course-filter">
                                <option value="">Todos los cursos</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Buscar familia</label>
                            <input type="text" class="form-control" id="family-search" 
                                   placeholder="Buscar por nombre de familia...">
                        </div>
                    </div>
                </div>

                <!-- Listado de Familias -->
                <div id="families-container" class="row g-3 mb-3">
                    <!-- Tarjetas generadas din√°micamente -->
                </div>

                <!-- Paginaci√≥n Familias -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="pagination-info" id="families-pagination-info"></div>
                    </div>
                    <div class="col-md-6">
                        <nav>
                            <ul class="pagination justify-content-end mb-0" id="families-pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- ========================================= -->
            <!-- PESTA√ëA 3: TRABAJADORES -->
            <!-- ========================================= -->
            <div class="tab-pane fade" id="workers-panel" role="tabpanel">
                
                <!-- M√©tricas Trabajadores -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="metric-badge">
                            <strong id="workers-total">0</strong>
                            <small>Total trabajadores activos</small>
                        </div>
                        <div class="metric-badge">
                            <strong id="workers-male">0</strong>
                            <small>Masculino</small>
                        </div>
                        <div class="metric-badge">
                            <strong id="workers-female">0</strong>
                            <small>Femenino</small>
                        </div>
                    </div>
                </div>

                <!-- Filtros y Buscador Trabajadores -->
                <div class="filter-section">
                    <div class="row g-3 mb-2">
                        <div class="col-md-2">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="worker-status-filter">
                                <option value="active" selected>Activos</option>
                                <option value="inactive">Inactivos</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">G√©nero</label>
                            <select class="form-select" id="worker-gender-filter">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Divisi√≥n</label>
                            <select class="form-select" id="worker-division-filter">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Centro de costo</label>
                            <select class="form-select" id="worker-cost-center-filter">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Rol/Cargo</label>
                            <select class="form-select" id="worker-role-filter">
                                <option value="">Todos</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-9">
                            <label class="form-label">Buscar trabajador</label>
                            <input type="text" class="form-control" id="worker-search" 
                                   placeholder="Buscar por nombre...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="alert alert-info mb-0 py-2">
                                <strong>Mostrando:</strong> <span id="workers-count">0</span> trabajadores
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Listado de Trabajadores -->
                <div id="workers-container" class="row g-3 mb-3">
                    <!-- Tarjetas generadas din√°micamente -->
                </div>

                <!-- Paginaci√≥n Trabajadores -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="pagination-info" id="workers-pagination-info"></div>
                    </div>
                    <div class="col-md-6">
                        <nav>
                            <ul class="pagination justify-content-end mb-0" id="workers-pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

        </div> <!-- Fin tab-content -->

    </div> <!-- Fin container-fluid -->

    <!-- SCRIPTS - ORDEN CR√çTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        // Datos crudos
        let allStudents = [];
        let allFamilies = [];
        let allWorkers = [];
        
        // Datos filtrados
        let filteredStudents = [];
        let filteredFamilies = [];
        let filteredWorkers = [];
        
        // Cat√°logos
        let courses = [];
        let genders = [];
        let divisions = [];
        let costCenters = [];
        let jobRoles = [];
        
        // Paginaci√≥n
        const ITEMS_PER_PAGE = 20;
        let currentStudentPage = 1;
        let currentFamilyPage = 1;
        let currentWorkerPage = 1;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando Consulta de la comunidad...');
            
            try {
                // Validar sesi√≥n (acceso universal, solo verificar que est√© logueado)
                const session = getStoredSession();
                if (!session || !session.user) {
                    console.log('‚ùå No hay sesi√≥n activa');
                    window.location.href = '../../login.html';
                    return;
                }
                
                console.log('‚úÖ Usuario autenticado:', session.user.user_display_name);
                
                // Inicializar p√°gina
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n:', error);
                showMessage('Error de autenticaci√≥n', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN PRINCIPAL
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Cargar cat√°logos
                await cargarCatalogos();
                
                // Configurar event listeners
                configurarEventListeners();
                
                // Cargar datos iniciales de la pesta√±a activa (Estudiantes)
                await cargarEstudiantes();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR CAT√ÅLOGOS
        // ==========================================
        async function cargarCatalogos() {
            try {
                console.log('üìã Cargando cat√°logos...');
                
                // Cargar cursos activos
                courses = await supabaseRequest('/courses?select=course_id,course_name,grades(grade_name,sections(section_name))&course_status=eq.active&order=course_name.asc');
                
                // Cargar g√©neros
                genders = await supabaseRequest('/genders?select=gender_id,gender_name&order=gender_name.asc');
                
                // Cargar divisiones
                divisions = await supabaseRequest('/organizational_divisions?select=division_id,division_name&division_status=eq.active&order=division_order.asc');
                
                // Cargar centros de costo
                costCenters = await supabaseRequest('/cost_centers?select=cost_center_id,cost_center_name&cost_center_status=eq.active&order=cost_center_order.asc');
                
                // Cargar roles/cargos
                jobRoles = await supabaseRequest('/job_roles?select=role_id,role_name&role_status=eq.active&order=role_name.asc');
                
                // Poblar dropdowns
                poblarDropdowns();
                
                console.log('‚úÖ Cat√°logos cargados');
                
            } catch (error) {
                console.error('‚ùå Error cargando cat√°logos:', error);
                throw error;
            }
        }
        
        // ==========================================
        // POBLAR DROPDOWNS
        // ==========================================
        function poblarDropdowns() {
            // Cursos para estudiantes
            const studentCourseFilter = document.getElementById('student-course-filter');
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.course_id;
                option.textContent = `${course.grades?.sections?.section_name || ''} - ${course.grades?.grade_name || ''} ${course.course_name}`;
                studentCourseFilter.appendChild(option);
            });
            
            // Cursos para familias
            const familyCourseFilter = document.getElementById('family-course-filter');
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.course_id;
                option.textContent = `${course.grades?.sections?.section_name || ''} - ${course.grades?.grade_name || ''} ${course.course_name}`;
                familyCourseFilter.appendChild(option);
            });
            
            // G√©neros para trabajadores
            const workerGenderFilter = document.getElementById('worker-gender-filter');
            genders.forEach(gender => {
                const option = document.createElement('option');
                option.value = gender.gender_id;
                option.textContent = gender.gender_name;
                workerGenderFilter.appendChild(option);
            });
            
            // Divisiones
            const workerDivisionFilter = document.getElementById('worker-division-filter');
            divisions.forEach(division => {
                const option = document.createElement('option');
                option.value = division.division_id;
                option.textContent = division.division_name;
                workerDivisionFilter.appendChild(option);
            });
            
            // Centros de costo
            const workerCostCenterFilter = document.getElementById('worker-cost-center-filter');
            costCenters.forEach(cc => {
                const option = document.createElement('option');
                option.value = cc.cost_center_id;
                option.textContent = cc.cost_center_name;
                workerCostCenterFilter.appendChild(option);
            });
            
            // Roles/Cargos
            const workerRoleFilter = document.getElementById('worker-role-filter');
            jobRoles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.role_id;
                option.textContent = role.role_name;
                workerRoleFilter.appendChild(option);
            });
        }
        
        // ==========================================
        // CONFIGURAR EVENT LISTENERS
        // ==========================================
        function configurarEventListeners() {
            // Cambio de pesta√±as
            document.getElementById('students-tab').addEventListener('click', () => {
                if (allStudents.length === 0) cargarEstudiantes();
            });
            
            document.getElementById('families-tab').addEventListener('click', () => {
                if (allFamilies.length === 0) cargarFamilias();
            });
            
            document.getElementById('workers-tab').addEventListener('click', () => {
                if (allWorkers.length === 0) cargarTrabajadores();
            });
            
            // Filtros y b√∫squeda - ESTUDIANTES
            document.getElementById('student-status-filter').addEventListener('change', filtrarEstudiantes);
            document.getElementById('student-course-filter').addEventListener('change', filtrarEstudiantes);
            document.getElementById('student-search').addEventListener('input', filtrarEstudiantes);
            
            // Filtros y b√∫squeda - FAMILIAS
            document.getElementById('family-course-filter').addEventListener('change', filtrarFamilias);
            document.getElementById('family-search').addEventListener('input', filtrarFamilias);
            
            // Filtros y b√∫squeda - TRABAJADORES
            document.getElementById('worker-status-filter').addEventListener('change', filtrarTrabajadores);
            document.getElementById('worker-gender-filter').addEventListener('change', filtrarTrabajadores);
            document.getElementById('worker-division-filter').addEventListener('change', filtrarTrabajadores);
            document.getElementById('worker-cost-center-filter').addEventListener('change', filtrarTrabajadores);
            document.getElementById('worker-role-filter').addEventListener('change', filtrarTrabajadores);
            document.getElementById('worker-search').addEventListener('input', filtrarTrabajadores);
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
      // ==========================================
        // CALCULAR EDAD DETALLADA
        // ==========================================
        function calcularEdadDetallada(fechaNacimiento) {
            if (!fechaNacimiento) return 'N/A';
            
            const hoy = new Date();
            const nacimiento = new Date(fechaNacimiento);
            
            let a√±os = hoy.getFullYear() - nacimiento.getFullYear();
            let meses = hoy.getMonth() - nacimiento.getMonth();
            let d√≠as = hoy.getDate() - nacimiento.getDate();
            
            if (d√≠as < 0) {
                meses--;
                const ultimoDiaMesAnterior = new Date(hoy.getFullYear(), hoy.getMonth(), 0).getDate();
                d√≠as += ultimoDiaMesAnterior;
            }
            
            if (meses < 0) {
                a√±os--;
                meses += 12;
            }
            
            return `${a√±os} a√±os, ${meses} meses, ${d√≠as} d√≠as`;
        }
        
        // ==========================================
        // CARGAR ESTUDIANTES
        // ==========================================
        async function cargarEstudiantes() {
            try {
                mostrarLoading();
                console.log('üìö Cargando estudiantes...');
                
                // Cargar estudiantes con sus relaciones
                allStudents = await supabaseRequest('/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2,student_birthday,courses(course_id,course_name,grades(grade_name,sections(section_name))),genders(gender_name),student_status(status_code)&order=student_last_name_1.asc,student_last_name_2.asc,student_first_name.asc');
                
                console.log(`‚úÖ ${allStudents.length} estudiantes cargados`);
                
                filtrarEstudiantes();
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error cargando estudiantes:', error);
                showMessage('Error al cargar estudiantes: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // FILTRAR ESTUDIANTES
        // ==========================================
        function filtrarEstudiantes() {
            const statusFilter = document.getElementById('student-status-filter').value;
            const courseFilter = document.getElementById('student-course-filter').value;
            const searchTerm = document.getElementById('student-search').value.toLowerCase().trim();
            
            filteredStudents = allStudents.filter(student => {
                // Filtro por estado
                const isActive = student.student_status?.status_code === 1;
                if (statusFilter === 'active' && !isActive) return false;
                if (statusFilter === 'inactive' && isActive) return false;
                
                // Filtro por curso
                if (courseFilter && student.courses?.course_id !== courseFilter) return false;
                
                // Filtro por b√∫squeda (nombre y apellidos)
                if (searchTerm) {
                    const fullName = `${student.student_first_name} ${student.student_last_name_1} ${student.student_last_name_2 || ''}`.toLowerCase();
                    if (!fullName.includes(searchTerm)) return false;
                }
                
                return true;
            });
            
            // Actualizar m√©tricas
            actualizarMetricasEstudiantes();
            
            // Resetear a p√°gina 1
            currentStudentPage = 1;
            
            // Renderizar
            renderizarEstudiantes();
        }
        
        // ==========================================
        // ACTUALIZAR M√âTRICAS ESTUDIANTES
        // ==========================================
        function actualizarMetricasEstudiantes() {
            const total = filteredStudents.length;
            const masculino = filteredStudents.filter(s => s.genders?.gender_name === 'Masculino').length;
            const femenino = filteredStudents.filter(s => s.genders?.gender_name === 'Femenino').length;
            
            document.getElementById('students-total').textContent = total;
            document.getElementById('students-male').textContent = masculino;
            document.getElementById('students-female').textContent = femenino;
        }
        
        // ==========================================
        // RENDERIZAR ESTUDIANTES
        // ==========================================
        function renderizarEstudiantes() {
            const container = document.getElementById('students-container');
            
            // Calcular paginaci√≥n
            const totalPages = Math.ceil(filteredStudents.length / ITEMS_PER_PAGE);
            const startIndex = (currentStudentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const studentsToShow = filteredStudents.slice(startIndex, endIndex);
            
            if (studentsToShow.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">No se encontraron estudiantes con los filtros aplicados.</div></div>';
                document.getElementById('students-pagination-info').textContent = '';
                document.getElementById('students-pagination').innerHTML = '';
                return;
            }
            
            // Renderizar tarjetas
            container.innerHTML = studentsToShow.map(student => {
                const fullName = `${student.student_first_name} ${student.student_last_name_1} ${student.student_last_name_2 || ''}`;
                const courseName = student.courses ? `${student.courses.grades?.sections?.section_name || ''} - ${student.courses.grades?.grade_name || ''} ${student.courses.course_name}` : 'Sin curso';
                const edad = calcularEdadDetallada(student.student_birthday);
                const fechaNacimiento = student.student_birthday ? formatDate(student.student_birthday) : 'N/A';
                
                return `
                    <div class="col-md-6 col-lg-4">
                        <div class="community-card">
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    ${renderStudentPhoto(student.student_code)}
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${escapeHtml(fullName)}</h6>
                                    <p class="mb-1 text-muted small">
                                        <i class="bi bi-book me-1"></i>${escapeHtml(courseName)}
                                    </p>
                                    <p class="mb-1 text-muted small">
                                        <i class="bi bi-calendar-event me-1"></i>${fechaNacimiento}
                                    </p>
                                    <p class="mb-0 text-muted small">
                                        <i class="bi bi-hourglass-split me-1"></i>${edad}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Actualizar info de paginaci√≥n
            document.getElementById('students-pagination-info').textContent = 
                `Mostrando ${startIndex + 1}-${Math.min(endIndex, filteredStudents.length)} de ${filteredStudents.length} estudiantes`;
            
            // Renderizar controles de paginaci√≥n
            renderizarPaginacion('students', totalPages, currentStudentPage, (page) => {
                currentStudentPage = page;
                renderizarEstudiantes();
            });
        }
        
        // ==========================================
        // RENDERIZAR FOTO DE ESTUDIANTE
        // ==========================================
        function renderStudentPhoto(studentCode) {
            if (!studentCode) {
                return `
                    <div class="photo-placeholder">
                        <i class="bi bi-person"></i>
                    </div>
                `;
            }
            
            return `
                <img src="${getStudentPhotoUrl(studentCode)}" 
                     class="student-photo" 
                     onerror="this.onerror=null; this.outerHTML='<div class=\\'photo-placeholder\\'><i class=\\'bi bi-person\\'></i></div>';"
                     alt="Foto estudiante">
            `;
        }
        
        // ==========================================
        // CARGAR FAMILIAS
        // ==========================================
        async function cargarFamilias() {
            try {
                mostrarLoading();
                console.log('üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Cargando familias...');
                
                // CORRECCI√ìN: usar students_family_fkey (sin _id)
                const familiesData = await supabaseRequest('/families?select=family_code,family_name,students!students_family_fkey(student_id,student_code,student_first_name,student_last_name_1,student_last_name_2,student_birthday,courses(course_id,course_name,grades(grade_name,sections(section_name))),student_status(status_code))&order=family_name.asc');
                
                // Filtrar solo familias con al menos un hijo activo
                allFamilies = familiesData.filter(family => {
                    const activeChildren = family.students?.filter(s => s.student_status?.status_code === 1) || [];
                    return activeChildren.length > 0;
                }).map(family => ({
                    ...family,
                    activeChildren: family.students.filter(s => s.student_status?.status_code === 1)
                }));
                
                console.log(`‚úÖ ${allFamilies.length} familias cargadas`);
                
                filtrarFamilias();
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error cargando familias:', error);
                showMessage('Error al cargar familias: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        
        
        // ==========================================
        // FILTRAR FAMILIAS
        // ==========================================
        function filtrarFamilias() {
            const courseFilter = document.getElementById('family-course-filter').value;
            const searchTerm = document.getElementById('family-search').value.toLowerCase().trim();
            
            filteredFamilies = allFamilies.filter(family => {
                // Filtro por curso (si alg√∫n hijo est√° en ese curso)
                if (courseFilter) {
                    const hasChildInCourse = family.activeChildren.some(child => 
                        child.courses?.course_id === courseFilter
                    );
                    if (!hasChildInCourse) return false;
                }
                
                // Filtro por b√∫squeda (nombre de familia)
                if (searchTerm) {
                    const familyName = (family.family_name || '').toLowerCase();
                    if (!familyName.includes(searchTerm)) return false;
                }
                
                return true;
            });
            
            // Actualizar m√©tricas
            actualizarMetricasFamilias();
            
            // Resetear a p√°gina 1
            currentFamilyPage = 1;
            
            // Renderizar
            renderizarFamilias();
        }
        
        // ==========================================
        // ACTUALIZAR M√âTRICAS FAMILIAS
        // ==========================================
        function actualizarMetricasFamilias() {
            const total = filteredFamilies.length;
            const oneChild = filteredFamilies.filter(f => f.activeChildren.length === 1).length;
            const twoChildren = filteredFamilies.filter(f => f.activeChildren.length === 2).length;
            const manyChildren = filteredFamilies.filter(f => f.activeChildren.length > 2).length;
            
            document.getElementById('families-total').textContent = total;
            document.getElementById('families-one-child').textContent = oneChild;
            document.getElementById('families-two-children').textContent = twoChildren;
            document.getElementById('families-many-children').textContent = manyChildren;
        }
      // ==========================================
        // RENDERIZAR FAMILIAS
        // ==========================================
        function renderizarFamilias() {
            const container = document.getElementById('families-container');
            
            // Calcular paginaci√≥n
            const totalPages = Math.ceil(filteredFamilies.length / ITEMS_PER_PAGE);
            const startIndex = (currentFamilyPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const familiesToShow = filteredFamilies.slice(startIndex, endIndex);
            
            if (familiesToShow.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">No se encontraron familias con los filtros aplicados.</div></div>';
                document.getElementById('families-pagination-info').textContent = '';
                document.getElementById('families-pagination').innerHTML = '';
                return;
            }
            
            // Renderizar tarjetas
            container.innerHTML = familiesToShow.map(family => {
                const childrenHtml = family.activeChildren
                    .sort((a, b) => {
                        const nameA = `${a.student_last_name_1} ${a.student_last_name_2} ${a.student_first_name}`.toLowerCase();
                        const nameB = `${b.student_last_name_1} ${b.student_last_name_2} ${b.student_first_name}`.toLowerCase();
                        return nameA.localeCompare(nameB);
                    })
                    .map(child => {
                        const courseName = child.courses ? `${child.courses.course_name}` : 'Sin curso';
                        const edad = calcularEdadDetallada(child.student_birthday);
                        
                        return `
                            <div class="d-inline-block child-info">
                                ${renderChildPhoto(child.student_code)}
                                <small><strong>${escapeHtml(child.student_first_name)}</strong></small>
                                <small class="text-muted">${escapeHtml(courseName)}</small>
                                <small class="text-muted">${edad}</small>
                            </div>
                        `;
                    }).join('');
                
                return `
                    <div class="col-12">
                        <div class="community-card">
                            <h6 class="mb-3">
                                <i class="bi bi-house-heart me-2"></i>${escapeHtml(family.family_name || 'Sin nombre')}
                                <span class="badge bg-secondary ms-2">${family.activeChildren.length} ${family.activeChildren.length === 1 ? 'hijo' : 'hijos'}</span>
                            </h6>
                            <div class="d-flex flex-wrap gap-2">
                                ${childrenHtml}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Actualizar info de paginaci√≥n
            document.getElementById('families-pagination-info').textContent = 
                `Mostrando ${startIndex + 1}-${Math.min(endIndex, filteredFamilies.length)} de ${filteredFamilies.length} familias`;
            
            // Renderizar controles de paginaci√≥n
            renderizarPaginacion('families', totalPages, currentFamilyPage, (page) => {
                currentFamilyPage = page;
                renderizarFamilias();
            });
        }
        
        // ==========================================
        // RENDERIZAR FOTO DE HIJO (FAMILIA)
        // ==========================================
        function renderChildPhoto(studentCode) {
            if (!studentCode) {
                return `
                    <div class="child-photo-placeholder">
                        <i class="bi bi-person"></i>
                    </div>
                `;
            }
            
            return `
                <img src="${getStudentPhotoUrl(studentCode)}" 
                     class="child-photo" 
                     onerror="this.onerror=null; this.outerHTML='<div class=\\'child-photo-placeholder\\'><i class=\\'bi bi-person\\'></i></div>';"
                     alt="Foto">
            `;
        }
        
        // ==========================================
        // CARGAR TRABAJADORES
        // ==========================================
        async function cargarTrabajadores() {
            try {
                mostrarLoading();
                console.log('üëî Cargando trabajadores...');
                
                // Cargar trabajadores con sus relaciones
                allWorkers = await supabaseRequest('/workers?select=worker_id,worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2,worker_birthday,worker_entry_date,email,worker_status,genders(gender_id,gender_name),sections(section_name),organizational_divisions(division_id,division_name),cost_centers(cost_center_id,cost_center_name),organizational_areas(area_name),organizational_subareas(subarea_name),worker_job_roles(job_roles(role_id,role_name))&order=worker_last_name_1.asc,worker_last_name_2.asc,worker_first_name.asc');
                
                console.log(`‚úÖ ${allWorkers.length} trabajadores cargados`);
                
                filtrarTrabajadores();
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error cargando trabajadores:', error);
                showMessage('Error al cargar trabajadores: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // FILTRAR TRABAJADORES
        // ==========================================
        function filtrarTrabajadores() {
            const statusFilter = document.getElementById('worker-status-filter').value;
            const genderFilter = document.getElementById('worker-gender-filter').value;
            const divisionFilter = document.getElementById('worker-division-filter').value;
            const costCenterFilter = document.getElementById('worker-cost-center-filter').value;
            const roleFilter = document.getElementById('worker-role-filter').value;
            const searchTerm = document.getElementById('worker-search').value.toLowerCase().trim();
            
            filteredWorkers = allWorkers.filter(worker => {
                // Filtro por estado
                const isActive = worker.worker_status === 'active';
                if (statusFilter === 'active' && !isActive) return false;
                if (statusFilter === 'inactive' && isActive) return false;
                
                // Filtro por g√©nero
                if (genderFilter && worker.genders?.gender_id !== genderFilter) return false;
                
                // Filtro por divisi√≥n
                if (divisionFilter && worker.organizational_divisions?.division_id !== divisionFilter) return false;
                
                // Filtro por centro de costo
                if (costCenterFilter && worker.cost_centers?.cost_center_id !== costCenterFilter) return false;
                
                // Filtro por rol
                if (roleFilter) {
                    const hasRole = worker.worker_job_roles?.some(wjr => wjr.job_roles?.role_id === roleFilter);
                    if (!hasRole) return false;
                }
                
                // Filtro por b√∫squeda (nombre)
                if (searchTerm) {
                    const fullName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.toLowerCase();
                    if (!fullName.includes(searchTerm)) return false;
                }
                
                return true;
            });
            
            // Actualizar m√©tricas
            actualizarMetricasTrabajadores();
            
            // Actualizar contador
            document.getElementById('workers-count').textContent = filteredWorkers.length;
            
            // Resetear a p√°gina 1
            currentWorkerPage = 1;
            
            // Renderizar
            renderizarTrabajadores();
        }
        
        // ==========================================
        // ACTUALIZAR M√âTRICAS TRABAJADORES
        // ==========================================
        function actualizarMetricasTrabajadores() {
            const activos = allWorkers.filter(w => w.worker_status === 'active');
            const total = activos.length;
            const masculino = activos.filter(w => w.genders?.gender_name === 'Masculino').length;
            const femenino = activos.filter(w => w.genders?.gender_name === 'Femenino').length;
            
            document.getElementById('workers-total').textContent = total;
            document.getElementById('workers-male').textContent = masculino;
            document.getElementById('workers-female').textContent = femenino;
        }
        
        // ==========================================
        // RENDERIZAR TRABAJADORES
        // ==========================================
        function renderizarTrabajadores() {
            const container = document.getElementById('workers-container');
            
            // Calcular paginaci√≥n
            const totalPages = Math.ceil(filteredWorkers.length / ITEMS_PER_PAGE);
            const startIndex = (currentWorkerPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const workersToShow = filteredWorkers.slice(startIndex, endIndex);
            
            if (workersToShow.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">No se encontraron trabajadores con los filtros aplicados.</div></div>';
                document.getElementById('workers-pagination-info').textContent = '';
                document.getElementById('workers-pagination').innerHTML = '';
                return;
            }
            
            // Renderizar tarjetas
            container.innerHTML = workersToShow.map(worker => {
                const fullName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`;
                const roles = worker.worker_job_roles?.map(wjr => wjr.job_roles?.role_name).filter(Boolean).join(', ') || 'Sin cargo';
                const area = worker.organizational_subareas?.subarea_name || worker.organizational_areas?.area_name || worker.sections?.section_name || 'Sin asignar';
                const fechaIngreso = worker.worker_entry_date ? formatDate(worker.worker_entry_date) : 'N/A';
                const cumplea√±os = worker.worker_birthday ? formatBirthday(worker.worker_birthday) : 'N/A';
                
                return `
                    <div class="col-md-6 col-lg-4">
                        <div class="community-card">
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    ${renderWorkerPhoto(worker.worker_id_doc)}
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${escapeHtml(fullName)}</h6>
                                    <p class="mb-1 text-muted small">
                                        <i class="bi bi-envelope me-1"></i>${escapeHtml(worker.email)}
                                    </p>
                                    <p class="mb-1 text-muted small">
                                        <i class="bi bi-briefcase me-1"></i>${escapeHtml(roles)}
                                    </p>
                                    <p class="mb-1 text-muted small">
                                        <i class="bi bi-building me-1"></i>${escapeHtml(area)}
                                    </p>
                                    <p class="mb-1 text-muted small">
                                        <i class="bi bi-calendar-check me-1"></i>Ingreso: ${fechaIngreso}
                                    </p>
                                    <p class="mb-0 text-muted small">
                                        <i class="bi bi-cake me-1"></i>Cumplea√±os: ${cumplea√±os}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Actualizar info de paginaci√≥n
            document.getElementById('workers-pagination-info').textContent = 
                `Mostrando ${startIndex + 1}-${Math.min(endIndex, filteredWorkers.length)} de ${filteredWorkers.length} trabajadores`;
            
            // Renderizar controles de paginaci√≥n
            renderizarPaginacion('workers', totalPages, currentWorkerPage, (page) => {
                currentWorkerPage = page;
                renderizarTrabajadores();
            });
        }
        
        // ==========================================
        // RENDERIZAR FOTO DE TRABAJADOR
        // ==========================================
        function renderWorkerPhoto(workerIdDoc) {
            if (!workerIdDoc) {
                return `
                    <div class="photo-placeholder">
                        <i class="bi bi-person"></i>
                    </div>
                `;
            }
            
            return `
                <img src="${getWorkerPhotoUrl(workerIdDoc)}" 
                     class="worker-photo" 
                     onerror="this.onerror=null; this.outerHTML='<div class=\\'photo-placeholder\\'><i class=\\'bi bi-person\\'></i></div>';"
                     alt="Foto trabajador">
            `;
        }
        
        // ==========================================
        // FORMATEAR CUMPLEA√ëOS (sin a√±o)
        // ==========================================
        function formatBirthday(date) {
            if (!date) return 'N/A';
            
            const d = new Date(date);
            const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 
                          'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
            
            return `${d.getDate()} de ${meses[d.getMonth()]}`;
        }
        
        // ==========================================
        // RENDERIZAR PAGINACI√ìN
        // ==========================================
        function renderizarPaginacion(tipo, totalPages, currentPage, callback) {
            const paginationContainer = document.getElementById(`${tipo}-pagination`);
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Bot√≥n anterior
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">Anterior</a>
                </li>
            `;
            
            // P√°ginas
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            
            if (endPage - startPage < maxPagesToShow - 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            
            if (startPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
            }
            
            // Bot√≥n siguiente
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">Siguiente</a>
                </li>
            `;
            
            paginationContainer.innerHTML = html;
            
            // Event listeners
            paginationContainer.querySelectorAll('a.page-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = parseInt(e.target.dataset.page);
                    if (page && page !== currentPage) {
                        callback(page);
                    }
                });
            });
        }
        
        console.log('‚úÖ Consulta de la comunidad cargada correctamente');
    </script>
</body>
</html>
