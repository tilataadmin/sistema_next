<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA -->
    <meta name="page-version" content="25.01.15.10.40">
    
    <title>Detalle de Proyecto - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Supabase JS para Storage -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Variables del m√≥dulo - Usa colores corporativos de system_config */
        :root {
            --module-primary: var(--system-primary-color, #6f42c1);
            --module-secondary: var(--system-secondary-color, #563d7c);
            --module-light: color-mix(in srgb, var(--system-primary-color, #6f42c1) 15%, white);
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden { display: none; }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--module-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Header del proyecto */
        .project-header {
            background: linear-gradient(135deg, var(--module-primary), var(--module-secondary));
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }
        
        .project-header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        /* Sem√°foro de salud */
        .health-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .health-critical { background-color: #dc3545; box-shadow: 0 0 8px rgba(220, 53, 69, 0.6); }
        .health-warning { background-color: #ffc107; box-shadow: 0 0 8px rgba(255, 193, 7, 0.6); }
        .health-healthy { background-color: #28a745; box-shadow: 0 0 8px rgba(40, 167, 69, 0.6); }
        
        /* Badges */
        .badge-estado {
            font-size: 0.8rem;
            padding: 0.4rem 0.75rem;
            border-radius: 1rem;
        }
        
        .badge-activo { background-color: rgba(255,255,255,0.2); color: white; }
        .badge-pausado { background-color: #fff3cd; color: #856404; }
        .badge-completado { background-color: #cce5ff; color: #004085; }
        .badge-cancelado { background-color: #f8d7da; color: #721c24; }
        
        /* Cards de secciones */
        .section-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        .section-card .card-header {
            background: transparent;
            border-bottom: 1px solid #eee;
            padding: 1rem 1.25rem;
        }
        
        .section-card .card-header h5 {
            margin-bottom: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Timeline de hitos */
        .milestone-item {
            position: relative;
            padding-left: 30px;
            padding-bottom: 1.5rem;
            border-left: 2px solid #dee2e6;
        }
        
        .milestone-item:last-child {
            border-left: 2px solid transparent;
            padding-bottom: 0;
        }
        
        .milestone-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #dee2e6;
            border: 2px solid white;
        }
        
        .milestone-item.completed::before { background: #28a745; }
        .milestone-item.overdue::before { background: #dc3545; }
        .milestone-item.upcoming::before { background: #ffc107; }
        .milestone-item.pending::before { background: #6c757d; }
        
        .milestone-title {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .milestone-date {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        /* Participantes */
        .participant-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
        }
        
        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--module-light);
            color: var(--module-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 0.75rem;
        }
        
        .participant-info { flex-grow: 1; }
        .participant-name { font-weight: 500; }
        .participant-email { font-size: 0.8rem; color: #6c757d; }
        
        .badge-rol-lider { background-color: var(--module-light); color: var(--module-primary); }
        .badge-rol-colaborador { background-color: #e7f3ff; color: #0066cc; }
        .badge-rol-observador { background-color: #f0f0f0; color: #666; }
        
        /* Minutas */
        .minute-item {
            padding: 1rem;
            border-radius: 8px;
            background: #f8f9fa;
            margin-bottom: 0.75rem;
        }
        
        .minute-date {
            font-weight: 600;
            color: var(--module-primary);
        }
        
        /* Documentos */
        .document-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            background: #f8f9fa;
            margin-bottom: 0.5rem;
        }
        
        .document-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--module-light);
            color: var(--module-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-right: 0.75rem;
        }
        
        .document-info { flex-grow: 1; }
        .document-name { font-weight: 500; word-break: break-word; }
        .document-meta { font-size: 0.8rem; color: #6c757d; }
        
        /* Tareas */
        .task-item {
            padding: 0.75rem;
            border-radius: 8px;
            background: #f8f9fa;
            margin-bottom: 0.5rem;
            border-left: 4px solid #dee2e6;
        }
        
        .task-item.priority-alta { border-left-color: #dc3545; }
        .task-item.priority-media { border-left-color: #ffc107; }
        .task-item.priority-baja { border-left-color: #28a745; }
        
        /* Progreso */
        .progress-thin {
            height: 8px;
            border-radius: 4px;
        }
        
        /* Info cards */
        .info-label {
            font-size: 0.8rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            font-size: 1rem;
            color: #2c3e50;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 2.5rem;
            color: #dee2e6;
            margin-bottom: 0.75rem;
        }
        
        /* Navegaci√≥n por tabs */
        .nav-pills .nav-link {
            color: #6c757d;
            border-radius: 8px;
            padding: 0.5rem 1rem;
        }
        
        .nav-pills .nav-link.active {
            background-color: var(--module-primary);
            color: white;
        }
        
        .nav-pills .nav-link:hover:not(.active) {
            background-color: var(--module-light);
            color: var(--module-primary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .project-header h1 { font-size: 1.25rem; }
            .nav-pills { flex-wrap: nowrap; overflow-x: auto; }
            .nav-pills .nav-link { white-space: nowrap; font-size: 0.85rem; }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando proyecto...</p>
        </div>
    </div>

    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="projects.html">Proyectos</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page" id="breadcrumb-proyecto">
                    Cargando...
                </li>
            </ol>
        </nav>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- HEADER DEL PROYECTO -->
        <div class="project-header" id="project-header">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                <div>
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="health-indicator" id="health-indicator" title=""></span>
                        <span class="badge badge-estado" id="badge-estado">Cargando...</span>
                        <span class="badge bg-light text-dark" id="badge-rol">Mi rol</span>
                    </div>
                    <h1 id="project-name">Cargando proyecto...</h1>
                    <p class="mb-0 opacity-75" id="project-purpose"></p>
                </div>
                <div class="d-flex gap-2" id="header-actions">
                    <!-- Botones de acci√≥n seg√∫n rol -->
                </div>
            </div>
        </div>

        <!-- INFO R√ÅPIDA -->
        <div class="row mb-4">
            <div class="col-6 col-md-3">
                <div class="info-label">L√≠der</div>
                <div class="info-value" id="info-leader">-</div>
            </div>
            <div class="col-6 col-md-3">
                <div class="info-label">Fecha Inicio</div>
                <div class="info-value" id="info-start-date">-</div>
            </div>
            <div class="col-6 col-md-3">
                <div class="info-label">Fecha Fin Esperada</div>
                <div class="info-value" id="info-end-date">-</div>
            </div>
            <div class="col-6 col-md-3">
                <div class="info-label">Progreso Hitos</div>
                <div class="info-value" id="info-progress">-</div>
            </div>
        </div>

        <!-- NAVEGACI√ìN POR TABS -->
        <ul class="nav nav-pills mb-4" id="project-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-info" data-bs-toggle="pill" 
                        data-bs-target="#panel-info" type="button" role="tab">
                    <i class="bi bi-info-circle me-1"></i>Informaci√≥n
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-milestones" data-bs-toggle="pill" 
                        data-bs-target="#panel-milestones" type="button" role="tab">
                    <i class="bi bi-flag me-1"></i>Hitos <span class="badge bg-secondary ms-1" id="count-milestones">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-participants" data-bs-toggle="pill" 
                        data-bs-target="#panel-participants" type="button" role="tab">
                    <i class="bi bi-people me-1"></i>Participantes <span class="badge bg-secondary ms-1" id="count-participants">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-tasks" data-bs-toggle="pill" 
                        data-bs-target="#panel-tasks" type="button" role="tab">
                    <i class="bi bi-check2-square me-1"></i>Tareas <span class="badge bg-secondary ms-1" id="count-tasks">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-minutes" data-bs-toggle="pill" 
                        data-bs-target="#panel-minutes" type="button" role="tab">
                    <i class="bi bi-journal-text me-1"></i>Minutas <span class="badge bg-secondary ms-1" id="count-minutes">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-documents" data-bs-toggle="pill" 
                        data-bs-target="#panel-documents" type="button" role="tab">
                    <i class="bi bi-folder me-1"></i>Documentos <span class="badge bg-secondary ms-1" id="count-documents">0</span>
                </button>
            </li>
        </ul>

        <!-- CONTENIDO DE LOS TABS -->
        <div class="tab-content" id="project-tab-content">
            
            <!-- TAB: INFORMACI√ìN -->
            <div class="tab-pane fade show active" id="panel-info" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card section-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="bi bi-card-text me-2"></i>Informaci√≥n del Proyecto</h5>
                                <button class="btn btn-sm btn-outline-primary" id="btn-edit-project" 
                                        onclick="abrirModalEditarProyecto()" style="display: none;">
                                    <i class="bi bi-pencil me-1"></i>Editar
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <div class="info-label">Descripci√≥n</div>
                                    <div class="info-value" id="detail-description">-</div>
                                </div>
                                <div class="mb-4">
                                    <div class="info-label">Prop√≥sito</div>
                                    <div class="info-value" id="detail-purpose">-</div>
                                </div>
                                <div class="mb-4">
                                    <div class="info-label">Objetivo</div>
                                    <div class="info-value" id="detail-objective">-</div>
                                </div>
                                <div id="objective-progress-container" style="display: none;">
                                    <div class="info-label">Progreso del Objetivo</div>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="progress progress-thin flex-grow-1">
                                            <div class="progress-bar bg-primary" id="objective-progress-bar" style="width: 0%"></div>
                                        </div>
                                        <span class="fw-semibold" id="objective-progress-text">0%</span>
                                    </div>
                                    <small class="text-muted" id="objective-progress-detail"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card section-card">
                            <div class="card-header">
                                <h5><i class="bi bi-calendar-event me-2"></i>Fechas</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="info-label">Fecha de Inicio</div>
                                    <div class="info-value" id="detail-start-date">-</div>
                                </div>
                                <div class="mb-3">
                                    <div class="info-label">Fecha Esperada de Fin</div>
                                    <div class="info-value" id="detail-end-date">-</div>
                                </div>
                                <div id="actual-end-date-container" style="display: none;">
                                    <div class="info-label">Fecha Real de Fin</div>
                                    <div class="info-value" id="detail-actual-end-date">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cambiar estado (solo l√≠der) -->
                        <div class="card section-card" id="card-change-status" style="display: none;">
                            <div class="card-header">
                                <h5><i class="bi bi-arrow-repeat me-2"></i>Cambiar Estado</h5>
                            </div>
                            <div class="card-body">
                                <select class="form-select mb-3" id="select-new-status">
                                    <option value="">Seleccionar nuevo estado...</option>
                                </select>
                                <textarea class="form-control mb-3" id="status-change-reason" 
                                          rows="2" placeholder="Motivo del cambio (opcional)"></textarea>
                                <button class="btn btn-primary w-100" onclick="cambiarEstadoProyecto()">
                                    <i class="bi bi-check-circle me-1"></i>Aplicar Cambio
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB: HITOS -->
            <div class="tab-pane fade" id="panel-milestones" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-flag me-2"></i>Hitos del Proyecto</h5>
                        <button class="btn btn-sm btn-primary" id="btn-add-milestone" 
                                onclick="abrirModalHito()" style="display: none;">
                            <i class="bi bi-plus-circle me-1"></i>Nuevo Hito
                        </button>
                    </div>
                    <div class="card-body" id="milestones-container">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB: PARTICIPANTES -->
            <div class="tab-pane fade" id="panel-participants" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-people me-2"></i>Participantes</h5>
                        <button class="btn btn-sm btn-primary" id="btn-add-participant" 
                                onclick="abrirModalParticipante()" style="display: none;">
                            <i class="bi bi-person-plus me-1"></i>Agregar
                        </button>
                    </div>
                    <div class="card-body" id="participants-container">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB: TAREAS -->
            <div class="tab-pane fade" id="panel-tasks" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-check2-square me-2"></i>Tareas del Proyecto</h5>
                        <button class="btn btn-sm btn-primary" id="btn-add-task" 
                                onclick="irACrearTarea()" style="display: none;">
                            <i class="bi bi-plus-circle me-1"></i>Nueva Tarea
                        </button>
                    </div>
                    <div class="card-body" id="tasks-container">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB: MINUTAS -->
            <div class="tab-pane fade" id="panel-minutes" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-journal-text me-2"></i>Minutas de Reuni√≥n</h5>
                        <button class="btn btn-sm btn-primary" id="btn-add-minute" 
                                onclick="abrirModalMinuta()" style="display: none;">
                            <i class="bi bi-plus-circle me-1"></i>Nueva Minuta
                        </button>
                    </div>
                    <div class="card-body" id="minutes-container">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB: DOCUMENTOS -->
            <div class="tab-pane fade" id="panel-documents" role="tabpanel">
                <div class="card section-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-folder me-2"></i>Documentos</h5>
                        <button class="btn btn-sm btn-primary" id="btn-add-document" 
                                onclick="document.getElementById('file-input').click()" style="display: none;">
                            <i class="bi bi-upload me-1"></i>Subir Archivo
                        </button>
                        <input type="file" id="file-input" style="display: none;" 
                               multiple onchange="subirDocumentos(this.files)">
                    </div>
                    <div class="card-body" id="documents-container">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

    </div>

    <!-- MODAL: EDITAR PROYECTO -->
    <div class="modal fade" id="modal-proyecto" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Editar Proyecto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-proyecto">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Nombre del Proyecto <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit-nombre" required maxlength="200">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n</label>
                            <textarea class="form-control" id="edit-descripcion" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Prop√≥sito <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="edit-proposito" rows="2" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Objetivo <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="edit-objetivo" rows="2" required></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="edit-cuantificable" 
                                       onchange="toggleEditCuantificable()">
                                <label class="form-check-label" for="edit-cuantificable">
                                    Objetivo cuantificable
                                </label>
                            </div>
                        </div>
                        <div class="row mb-3" id="edit-campos-cuantificables" style="display: none;">
                            <div class="col-md-4">
                                <label class="form-label">Valor Meta</label>
                                <input type="number" class="form-control" id="edit-meta" step="0.01">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Valor Actual</label>
                                <input type="number" class="form-control" id="edit-actual" step="0.01">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Unidad</label>
                                <input type="text" class="form-control" id="edit-unidad" maxlength="50">
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha de Inicio <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="edit-fecha-inicio" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Esperada de Fin <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="edit-fecha-fin" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btn-guardar-proyecto">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: HITO -->
    <div class="modal fade" id="modal-hito" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-hito-titulo"><i class="bi bi-flag me-2"></i>Nuevo Hito</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-hito">
                    <div class="modal-body">
                        <input type="hidden" id="hito-id">
                        <div class="mb-3">
                            <label class="form-label">Nombre del Hito <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="hito-nombre" required maxlength="200">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n</label>
                            <textarea class="form-control" id="hito-descripcion" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fecha Comprometida <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="hito-fecha" required>
                        </div>
                        <div id="hito-completion-section" style="display: none;">
                            <hr>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="hito-cumplido" 
                                       onchange="toggleHitoCumplido()">
                                <label class="form-check-label" for="hito-cumplido">
                                    Marcar como cumplido
                                </label>
                            </div>
                            <div id="hito-completion-fields" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Fecha Real de Cumplimiento</label>
                                    <input type="date" class="form-control" id="hito-fecha-real">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Notas de Cumplimiento</label>
                                    <textarea class="form-control" id="hito-notas" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: PARTICIPANTE -->
    <div class="modal fade" id="modal-participante" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Agregar Participante</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-participante">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Colaborador <span class="text-danger">*</span></label>
                            <select class="form-select" id="participante-worker" required>
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rol <span class="text-danger">*</span></label>
                            <select class="form-select" id="participante-rol" required>
                                <option value="Colaborador">Colaborador</option>
                                <option value="Observador">Observador</option>
                            </select>
                            <div class="form-text">
                                <strong>Colaborador:</strong> Puede crear tareas, registrar minutas y subir archivos.<br>
                                <strong>Observador:</strong> Solo puede ver informaci√≥n y descargar archivos.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-person-plus me-1"></i>Agregar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    
    <!-- MODAL: MINUTA -->
    <div class="modal fade" id="modal-minuta" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-minuta-titulo"><i class="bi bi-journal-text me-2"></i>Nueva Minuta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-minuta">
                    <div class="modal-body">
                        <input type="hidden" id="minuta-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha de la Reuni√≥n <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="minuta-fecha" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Hora</label>
                                <input type="time" class="form-control" id="minuta-hora">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Asistentes <span class="text-danger">*</span></label>
                            <div id="minuta-asistentes" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                <!-- Checkboxes de participantes -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Temas Tratados <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="minuta-temas" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Decisiones</label>
                            <textarea class="form-control" id="minuta-decisiones" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Compromisos</label>
                            <textarea class="form-control" id="minuta-compromisos" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notas Adicionales</label>
                            <textarea class="form-control" id="minuta-notas" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: VER MINUTA -->
    <div class="modal fade" id="modal-ver-minuta" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-journal-text me-2"></i>Detalle de Minuta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-minuta-content">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let proyecto = null;
        let projectId = null;
        let userRole = null; // 'L√≠der', 'Colaborador', 'Observador'
        let participantes = [];
        let hitos = [];
        let tareas = [];
        let minutas = [];
        let documentos = [];
        let workersCache = [];
        let supabaseClient = null;
        
              
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando detalle de proyecto...');
            
            try {
                mostrarLoading();
                
                // Validar acceso
                const hasAccess = await validatePageAccess('Proyectos');
                if (!hasAccess) return;
                
                // Obtener sesi√≥n
                const session = getStoredSession();
                if (!session || !session.user) {
                    showMessage('Sesi√≥n no v√°lida', 'warning');
                    setTimeout(() => window.location.href = '../../login.html', 2000);
                    return;
                }
                
                currentUser = session.user;
                
                // Obtener ID del proyecto de la URL
                const urlParams = new URLSearchParams(window.location.search);
                projectId = urlParams.get('id');
                
                if (!projectId) {
                    showMessage('No se especific√≥ un proyecto', 'danger');
                    setTimeout(() => window.location.href = 'projects.html', 2000);
                    return;
                }
                
                // Inicializar cliente Supabase para Storage
                supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                
                // Inicializar modales
                modalProyecto = new bootstrap.Modal(document.getElementById('modal-proyecto'));
                modalHito = new bootstrap.Modal(document.getElementById('modal-hito'));
                modalParticipante = new bootstrap.Modal(document.getElementById('modal-participante'));
                modalMinuta = new bootstrap.Modal(document.getElementById('modal-minuta'));
                modalVerMinuta = new bootstrap.Modal(document.getElementById('modal-ver-minuta'));
                
                // Cargar workers
                await cargarWorkers();
                
                // Cargar proyecto
                await cargarProyecto();
                
                // Configurar formularios
                configurarFormularios();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                showMessage('Error: ' + error.message, 'danger');
                ocultarLoading();
            }
        });
        
        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        async function cargarProyecto() {
            try {
                // Cargar proyecto
                const data = await supabaseRequest(`/projects?project_id=eq.${projectId}`);
                
                if (!data || data.length === 0) {
                    showMessage('Proyecto no encontrado', 'danger');
                    setTimeout(() => window.location.href = 'projects.html', 2000);
                    return;
                }
                
                proyecto = data[0];
                
                // Determinar rol del usuario
                await determinarRolUsuario();
                
                // Verificar acceso
                if (!userRole) {
                    showMessage('No tienes acceso a este proyecto', 'danger');
                    setTimeout(() => window.location.href = 'projects.html', 2000);
                    return;
                }
                
                // Cargar datos relacionados
                await Promise.all([
                    cargarParticipantes(),
                    cargarHitos(),
                    cargarTareas(),
                    cargarMinutas(),
                    cargarDocumentos()
                ]);
                
                // Renderizar todo
                renderizarProyecto();
                configurarPermisos();
                
            } catch (error) {
                console.error('‚ùå Error cargando proyecto:', error);
                throw error;
            }
        }
        
        async function determinarRolUsuario() {
            const userEmail = currentUser.user_mail;
            
            // ¬øEs l√≠der?
            if (proyecto.leader_email === userEmail) {
                userRole = 'L√≠der';
                return;
            }
            
            // ¬øEs participante?
            const participation = await supabaseRequest(
                `/project_participants?project_id=eq.${projectId}&worker_email=eq.${encodeURIComponent(userEmail)}&participant_status=eq.active`
            );
            
            if (participation && participation.length > 0) {
                userRole = participation[0].participant_role;
                return;
            }
            
            // Verificar si es super admin
            const isSuperAdmin = await checkUserIsSuperAdmin(currentUser.user_id);
            if (isSuperAdmin) {
                userRole = 'Observador'; // Super admin puede ver pero como observador
                return;
            }
            
            userRole = null;
        }
        
        async function cargarWorkers() {
            try {
                const workers = await supabaseRequest(
                    `/workers?select=worker_id,email,worker_first_name,worker_last_name_1,worker_last_name_2&worker_status=eq.active&order=worker_last_name_1`
                );
                workersCache = workers;
            } catch (error) {
                console.error('Error cargando workers:', error);
            }
        }
        
        async function cargarParticipantes() {
            try {
                participantes = await supabaseRequest(
                    `/project_participants?project_id=eq.${projectId}&participant_status=eq.active&order=participant_role,worker_name`
                );
                document.getElementById('count-participants').textContent = participantes.length + 1; // +1 por el l√≠der
            } catch (error) {
                console.error('Error cargando participantes:', error);
                participantes = [];
            }
        }
        
        async function cargarHitos() {
            try {
                hitos = await supabaseRequest(
                    `/project_milestones?project_id=eq.${projectId}&order=milestone_order,committed_date`
                );
                document.getElementById('count-milestones').textContent = hitos.length;
            } catch (error) {
                console.error('Error cargando hitos:', error);
                hitos = [];
            }
        }
        
        async function cargarTareas() {
            try {
                tareas = await supabaseRequest(
                    `/tasks?select=*&module_type=eq.projects&reference_id=eq.${projectId}&order=due_date`
                );
                document.getElementById('count-tasks').textContent = tareas.length;
            } catch (error) {
                console.error('Error cargando tareas:', error);
                tareas = [];
            }
        }
        
        async function cargarMinutas() {
            try {
                minutas = await supabaseRequest(
                    `/project_minutes?project_id=eq.${projectId}&order=meeting_date.desc`
                );
                document.getElementById('count-minutes').textContent = minutas.length;
            } catch (error) {
                console.error('Error cargando minutas:', error);
                minutas = [];
            }
        }
        
        async function cargarDocumentos() {
            try {
                documentos = await supabaseRequest(
                    `/project_documents?project_id=eq.${projectId}&document_status=eq.active&order=uploaded_at.desc`
                );
                document.getElementById('count-documents').textContent = documentos.length;
            } catch (error) {
                console.error('Error cargando documentos:', error);
                documentos = [];
            }
        }
        
        // ==========================================
        // RENDERIZADO
        // ==========================================
        function renderizarProyecto() {
            // Breadcrumb
            document.getElementById('breadcrumb-proyecto').textContent = truncateText(proyecto.project_name, 30);
            
            // Header
            document.getElementById('project-name').textContent = proyecto.project_name;
            document.getElementById('project-purpose').textContent = proyecto.project_purpose || '';
            document.getElementById('badge-estado').textContent = proyecto.project_status;
            document.getElementById('badge-estado').className = 'badge badge-estado ' + getBadgeEstadoClass(proyecto.project_status);
            document.getElementById('badge-rol').textContent = userRole;
            
            // Sem√°foro de salud
            const health = calcularSalud();
            const healthIndicator = document.getElementById('health-indicator');
            healthIndicator.className = 'health-indicator ' + getHealthClass(health);
            healthIndicator.title = getHealthTooltip(health);
            
            // Info r√°pida
            document.getElementById('info-leader').textContent = proyecto.leader_name;
            document.getElementById('info-start-date').textContent = formatearFecha(proyecto.start_date);
            document.getElementById('info-end-date').textContent = formatearFecha(proyecto.expected_end_date);
            
            const hitosCompletados = hitos.filter(h => h.milestone_status === 'Cumplido').length;
            const progressPercent = hitos.length > 0 ? Math.round((hitosCompletados / hitos.length) * 100) : 0;
            document.getElementById('info-progress').innerHTML = `
                <div class="d-flex align-items-center gap-2">
                    <div class="progress progress-thin flex-grow-1" style="width: 80px;">
                        <div class="progress-bar" style="width: ${progressPercent}%; background-color: var(--module-primary);"></div>
                    </div>
                    <span>${hitosCompletados}/${hitos.length}</span>
                </div>
            `;
            
            // Detalle - Informaci√≥n
            document.getElementById('detail-description').textContent = proyecto.project_description || 'Sin descripci√≥n';
            document.getElementById('detail-purpose').textContent = proyecto.project_purpose || '-';
            document.getElementById('detail-objective').textContent = proyecto.project_objective || '-';
            document.getElementById('detail-start-date').textContent = formatearFecha(proyecto.start_date);
            document.getElementById('detail-end-date').textContent = formatearFecha(proyecto.expected_end_date);
            
            // Progreso del objetivo cuantificable
            if (proyecto.objective_target_value !== null) {
                const container = document.getElementById('objective-progress-container');
                container.style.display = 'block';
                
                const current = proyecto.objective_current_value || 0;
                const target = proyecto.objective_target_value;
                const percent = target > 0 ? Math.min(100, Math.round((current / target) * 100)) : 0;
                
                document.getElementById('objective-progress-bar').style.width = percent + '%';
                document.getElementById('objective-progress-text').textContent = percent + '%';
                document.getElementById('objective-progress-detail').textContent = 
                    `${current} de ${target} ${proyecto.objective_unit || ''}`;
            }
            
            // Fecha real de fin
            if (proyecto.actual_end_date) {
                document.getElementById('actual-end-date-container').style.display = 'block';
                document.getElementById('detail-actual-end-date').textContent = formatearFecha(proyecto.actual_end_date);
            }
            
            // Renderizar secciones
            renderizarHitos();
            renderizarParticipantes();
            renderizarTareas();
            renderizarMinutas();
            renderizarDocumentos();
            
            // Configurar cambio de estado
            if (userRole === 'L√≠der' && !['Completado', 'Cancelado'].includes(proyecto.project_status)) {
                document.getElementById('card-change-status').style.display = 'block';
                configurarOpcionesEstado();
            }
        }
        
        function renderizarHitos() {
            const container = document.getElementById('milestones-container');
            
            if (hitos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-flag"></i>
                        <p>No hay hitos definidos</p>
                    </div>
                `;
                return;
            }
            
            const today = getCurrentDateColombia();
            
            container.innerHTML = hitos.map(h => {
                let statusClass = 'pending';
                let statusText = 'Pendiente';
                
                if (h.milestone_status === 'Cumplido') {
                    statusClass = 'completed';
                    statusText = 'Cumplido';
                } else if (h.committed_date < today) {
                    statusClass = 'overdue';
                    statusText = 'Vencido';
                } else {
                    const dueDate = new Date(h.committed_date);
                    const todayDate = new Date(today);
                    const diffDays = Math.ceil((dueDate - todayDate) / (1000 * 60 * 60 * 24));
                    if (diffDays <= 7) {
                        statusClass = 'upcoming';
                        statusText = `Vence en ${diffDays} d√≠a${diffDays !== 1 ? 's' : ''}`;
                    }
                }
                
                return `
                    <div class="milestone-item ${statusClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="milestone-title">${escapeHtml(h.milestone_name)}</div>
                                ${h.milestone_description ? `<p class="text-muted small mb-1">${escapeHtml(h.milestone_description)}</p>` : ''}
                                <div class="milestone-date">
                                    <i class="bi bi-calendar me-1"></i>
                                    Fecha comprometida: ${formatearFecha(h.committed_date)}
                                    ${h.actual_date ? `<br><i class="bi bi-calendar-check me-1"></i>Cumplido: ${formatearFecha(h.actual_date)}` : ''}
                                </div>
                                <span class="badge ${statusClass === 'completed' ? 'bg-success' : statusClass === 'overdue' ? 'bg-danger' : statusClass === 'upcoming' ? 'bg-warning text-dark' : 'bg-secondary'} mt-1">
                                    ${statusText}
                                </span>
                            </div>
                            ${userRole === 'L√≠der' ? `
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#" onclick="abrirModalHito('${h.milestone_id}')">
                                            <i class="bi bi-pencil me-2"></i>Editar
                                        </a></li>
                                        ${h.milestone_status !== 'Cumplido' ? `
                                            <li><a class="dropdown-item" href="#" onclick="marcarHitoCumplido('${h.milestone_id}')">
                                                <i class="bi bi-check-circle me-2"></i>Marcar cumplido
                                            </a></li>
                                        ` : ''}
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="eliminarHito('${h.milestone_id}')">
                                            <i class="bi bi-trash me-2"></i>Eliminar
                                        </a></li>
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderizarParticipantes() {
            const container = document.getElementById('participants-container');
            
            // Incluir al l√≠der primero
            let html = `
                <div class="participant-item">
                    <div class="participant-avatar">${getInitials(proyecto.leader_name)}</div>
                    <div class="participant-info">
                        <div class="participant-name">${escapeHtml(proyecto.leader_name)}</div>
                        <div class="participant-email">${escapeHtml(proyecto.leader_email)}</div>
                    </div>
                    <span class="badge badge-rol-lider">L√≠der</span>
                </div>
            `;
            
            // Agregar participantes
            participantes.forEach(p => {
                html += `
                    <div class="participant-item">
                        <div class="participant-avatar">${getInitials(p.worker_name)}</div>
                        <div class="participant-info">
                            <div class="participant-name">${escapeHtml(p.worker_name)}</div>
                            <div class="participant-email">${escapeHtml(p.worker_email)}</div>
                        </div>
                        <span class="badge badge-rol-${p.participant_role.toLowerCase()}">${p.participant_role}</span>
                        ${userRole === 'L√≠der' ? `
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="removerParticipante('${p.participant_id}')" title="Remover">
                                <i class="bi bi-x"></i>
                            </button>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function renderizarTareas() {
            const container = document.getElementById('tasks-container');
            
            if (tareas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-check2-square"></i>
                        <p>No hay tareas en este proyecto</p>
                    </div>
                `;
                return;
            }
            
            const statusBadges = {
                'Asignada': 'bg-info text-dark',
                'En Progreso': 'bg-warning text-dark',
                'Terminada': 'bg-success',
                'Cancelada': 'bg-secondary'
            };
            
            let html = tareas.map(t => {
                const prioridad = (t.task_priority || 'Normal').toLowerCase();
                const estadoClass = statusBadges[t.task_state] || 'bg-secondary';
                
                return `
                    <div class="task-item priority-${prioridad === 'alta' ? 'alta' : prioridad === 'baja' ? 'baja' : 'media'}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-semibold">${escapeHtml(t.task_description)}</div>
                                <div class="small text-muted">
                                    <i class="bi bi-person me-1"></i>${escapeHtml(t.assigned_to_name || 'Sin asignar')}
                                    ${t.due_date ? ` | <i class="bi bi-calendar me-1"></i>${formatearFecha(t.due_date)}` : ''}
                                </div>
                            </div>
                            <span class="badge ${estadoClass}">${t.task_state || 'Asignada'}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Agregar link para ver todas en tasks.html
            html += `
                <div class="text-center mt-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="irAVerTareas()">
                        <i class="bi bi-box-arrow-up-right me-1"></i>Ver todas en Gesti√≥n de Tareas
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // ==========================================
        // INTEGRACI√ìN CON TASKS.HTML
        // ==========================================
        function irACrearTarea() {
            const nombreProyecto = encodeURIComponent(proyecto.project_name);
            window.location.href = `tasks.html?module=projects&ref=${projectId}&action=new&name=${nombreProyecto}`;
        }
        
        function irAVerTareas() {
            const nombreProyecto = encodeURIComponent(proyecto.project_name);
            window.location.href = `tasks.html?module=projects&ref=${projectId}&name=${nombreProyecto}`;
        }
        
        function renderizarMinutas() {
            const container = document.getElementById('minutes-container');
            
            if (minutas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-journal-text"></i>
                        <p>No hay minutas registradas</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = minutas.map(m => {
                const asistentes = m.attendees || [];
                return `
                    <div class="minute-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="minute-date">
                                    <i class="bi bi-calendar me-1"></i>${formatearFecha(m.meeting_date)}
                                    ${m.meeting_time ? ` - ${m.meeting_time.substring(0, 5)}` : ''}
                                </div>
                                <div class="small text-muted mt-1">
                                    <i class="bi bi-people me-1"></i>${asistentes.length} asistente${asistentes.length !== 1 ? 's' : ''}
                                    | Registrado por: ${escapeHtml(m.recorded_by_name)}
                                </div>
                                <p class="mb-0 mt-2 small">${truncateText(m.topics_discussed, 150)}</p>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="verMinuta('${m.minute_id}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderizarDocumentos() {
            const container = document.getElementById('documents-container');
            
            if (documentos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-folder"></i>
                        <p>No hay documentos subidos</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = documentos.map(d => {
                const iconClass = getFileIcon(d.document_name);
                const canDelete = userRole === 'L√≠der' || d.uploaded_by === currentUser.user_id;
                
                return `
                    <div class="document-item">
                        <div class="document-icon">
                            <i class="bi ${iconClass}"></i>
                        </div>
                        <div class="document-info">
                            <div class="document-name">${escapeHtml(d.document_name)}</div>
                            <div class="document-meta">
                                ${formatFileSize(d.file_size)} | Subido por ${escapeHtml(d.uploaded_by_name)} | ${formatearFecha(d.uploaded_at)}
                            </div>
                        </div>
                        <div class="d-flex gap-1">
                            <a href="${getDocumentUrl(d.storage_path)}" target="_blank" class="btn btn-sm btn-outline-primary" title="Descargar">
                                <i class="bi bi-download"></i>
                            </a>
                            ${canDelete ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="eliminarDocumento('${d.document_id}')" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ==========================================
        // CONFIGURACI√ìN DE PERMISOS
        // ==========================================
        function configurarPermisos() {
            const esLider = userRole === 'L√≠der';
            const esColaborador = userRole === 'Colaborador';
            const puedeEditar = esLider || esColaborador;
            
            // Botones seg√∫n rol
            if (esLider) {
                document.getElementById('btn-edit-project').style.display = 'inline-block';
                document.getElementById('btn-add-milestone').style.display = 'inline-block';
                document.getElementById('btn-add-participant').style.display = 'inline-block';
            }
            
            if (puedeEditar) {
                document.getElementById('btn-add-task').style.display = 'inline-block';
                document.getElementById('btn-add-minute').style.display = 'inline-block';
                document.getElementById('btn-add-document').style.display = 'inline-block';
            }
        }
        
        function configurarOpcionesEstado() {
            const select = document.getElementById('select-new-status');
            const estadoActual = proyecto.project_status;
            
            const transiciones = {
                'Activo': ['En Pausa', 'Completado', 'Cancelado'],
                'En Pausa': ['Activo', 'Cancelado']
            };
            
            const opciones = transiciones[estadoActual] || [];
            
            select.innerHTML = '<option value="">Seleccionar nuevo estado...</option>';
            opciones.forEach(estado => {
                select.innerHTML += `<option value="${estado}">${estado}</option>`;
            });
        }
        
        // ==========================================
        // FORMULARIOS
        // ==========================================
        function configurarFormularios() {
            // Formulario proyecto
            document.getElementById('form-proyecto').addEventListener('submit', async (e) => {
                e.preventDefault();
                await guardarProyecto();
            });
            
            // Formulario hito
            document.getElementById('form-hito').addEventListener('submit', async (e) => {
                e.preventDefault();
                await guardarHito();
            });
            
            // Formulario participante
            document.getElementById('form-participante').addEventListener('submit', async (e) => {
                e.preventDefault();
                await agregarParticipante();
            });
            
                        
            // Formulario minuta
            document.getElementById('form-minuta').addEventListener('submit', async (e) => {
                e.preventDefault();
                await guardarMinuta();
            });
        }
        
        // ==========================================
        // MODALES Y ACCIONES
        // ==========================================
        
        // --- PROYECTO ---
        function abrirModalEditarProyecto() {
            document.getElementById('edit-nombre').value = proyecto.project_name || '';
            document.getElementById('edit-descripcion').value = proyecto.project_description || '';
            document.getElementById('edit-proposito').value = proyecto.project_purpose || '';
            document.getElementById('edit-objetivo').value = proyecto.project_objective || '';
            document.getElementById('edit-fecha-inicio').value = proyecto.start_date || '';
            document.getElementById('edit-fecha-fin').value = proyecto.expected_end_date || '';
            
            const esCuantificable = proyecto.objective_target_value !== null;
            document.getElementById('edit-cuantificable').checked = esCuantificable;
            toggleEditCuantificable();
            
            if (esCuantificable) {
                document.getElementById('edit-meta').value = proyecto.objective_target_value || '';
                document.getElementById('edit-actual').value = proyecto.objective_current_value || '';
                document.getElementById('edit-unidad').value = proyecto.objective_unit || '';
            }
            
            modalProyecto.show();
        }
        
        function toggleEditCuantificable() {
            const checked = document.getElementById('edit-cuantificable').checked;
            document.getElementById('edit-campos-cuantificables').style.display = checked ? 'flex' : 'none';
        }
        
        async function guardarProyecto() {
            try {
                const esCuantificable = document.getElementById('edit-cuantificable').checked;
                
                const datos = {
                    project_name: document.getElementById('edit-nombre').value.trim(),
                    project_description: document.getElementById('edit-descripcion').value.trim() || null,
                    project_purpose: document.getElementById('edit-proposito').value.trim(),
                    project_objective: document.getElementById('edit-objetivo').value.trim(),
                    objective_target_value: esCuantificable ? parseFloat(document.getElementById('edit-meta').value) || null : null,
                    objective_current_value: esCuantificable ? parseFloat(document.getElementById('edit-actual').value) || null : null,
                    objective_unit: esCuantificable ? document.getElementById('edit-unidad').value.trim() || null : null,
                    start_date: document.getElementById('edit-fecha-inicio').value,
                    expected_end_date: document.getElementById('edit-fecha-fin').value,
                    updated_at: new Date().toISOString()
                };
                
                await supabaseRequest(`/projects?project_id=eq.${projectId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(datos)
                });
                
                showMessage('Proyecto actualizado', 'success');
                modalProyecto.hide();
                await cargarProyecto();
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'danger');
            }
        }
        
        async function cambiarEstadoProyecto() {
            const nuevoEstado = document.getElementById('select-new-status').value;
            const motivo = document.getElementById('status-change-reason').value.trim();
            
            if (!nuevoEstado) {
                showMessage('Selecciona un estado', 'warning');
                return;
            }
            
            try {
                const datos = {
                    project_status: nuevoEstado,
                    status_change_reason: motivo || null,
                    updated_at: new Date().toISOString()
                };
                
                if (nuevoEstado === 'Completado') {
                    datos.actual_end_date = getCurrentDateColombia();
                }
                
                await supabaseRequest(`/projects?project_id=eq.${projectId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(datos)
                });
                
                showMessage('Estado actualizado', 'success');
                await cargarProyecto();
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'danger');
            }
        }
        
        // --- HITOS ---
        function abrirModalHito(hitoId = null) {
            document.getElementById('form-hito').reset();
            document.getElementById('hito-id').value = '';
            
            if (hitoId) {
                const hito = hitos.find(h => h.milestone_id === hitoId);
                if (hito) {
                    document.getElementById('modal-hito-titulo').innerHTML = '<i class="bi bi-flag me-2"></i>Editar Hito';
                    document.getElementById('hito-id').value = hito.milestone_id;
                    document.getElementById('hito-nombre').value = hito.milestone_name || '';
                    document.getElementById('hito-descripcion').value = hito.milestone_description || '';
                    document.getElementById('hito-fecha').value = hito.committed_date || '';
                    
                    // Mostrar secci√≥n de cumplimiento en edici√≥n
                    document.getElementById('hito-completion-section').style.display = 'block';
                    document.getElementById('hito-cumplido').checked = hito.milestone_status === 'Cumplido';
                    toggleHitoCumplido();
                    
                    if (hito.milestone_status === 'Cumplido') {
                        document.getElementById('hito-fecha-real').value = hito.actual_date || '';
                        document.getElementById('hito-notas').value = hito.completion_notes || '';
                    }
                }
            } else {
                document.getElementById('modal-hito-titulo').innerHTML = '<i class="bi bi-flag me-2"></i>Nuevo Hito';
                document.getElementById('hito-completion-section').style.display = 'none';
            }
            
            modalHito.show();
        }
        
        function toggleHitoCumplido() {
            const checked = document.getElementById('hito-cumplido').checked;
            document.getElementById('hito-completion-fields').style.display = checked ? 'block' : 'none';
            
            if (checked && !document.getElementById('hito-fecha-real').value) {
                document.getElementById('hito-fecha-real').value = getCurrentDateColombia();
            }
        }
        
        async function guardarHito() {
            try {
                const hitoId = document.getElementById('hito-id').value;
                const esCumplido = document.getElementById('hito-cumplido').checked;
                
                const datos = {
                    project_id: projectId,
                    milestone_name: document.getElementById('hito-nombre').value.trim(),
                    milestone_description: document.getElementById('hito-descripcion').value.trim() || null,
                    committed_date: document.getElementById('hito-fecha').value,
                    milestone_status: esCumplido ? 'Cumplido' : 'Pendiente',
                    actual_date: esCumplido ? document.getElementById('hito-fecha-real').value || null : null,
                    completion_notes: esCumplido ? document.getElementById('hito-notas').value.trim() || null : null,
                    updated_at: new Date().toISOString()
                };
                
                if (hitoId) {
                    await supabaseRequest(`/project_milestones?milestone_id=eq.${hitoId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(datos)
                    });
                } else {
                    datos.milestone_order = hitos.length + 1;
                    datos.created_by = currentUser.user_id;
                    datos.created_at = new Date().toISOString();
                    
                    await supabaseRequest('/project_milestones', {
                        method: 'POST',
                        body: JSON.stringify(datos)
                    });
                }
                
                showMessage('Hito guardado', 'success');
                modalHito.hide();
                await cargarHitos();
                renderizarHitos();
                renderizarProyecto();
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'danger');
            }
        }
        
        async function marcarHitoCumplido(hitoId) {
            const fecha = prompt('Fecha de cumplimiento (YYYY-MM-DD):', getCurrentDateColombia());
            if (!fecha) return;
            
            try {
                await supabaseRequest(`/project_milestones?milestone_id=eq.${hitoId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        milestone_status: 'Cumplido',
                        actual_date: fecha,
                        updated_at: new Date().toISOString()
                    })
                });
                
                showMessage('Hito marcado como cumplido', 'success');
                await cargarHitos();
                renderizarHitos();
                renderizarProyecto();
                
            } catch (error) {
                showMessage('Error: ' + error.message, 'danger');
            }
        }
        
        async function eliminarHito(hitoId) {
            if (!confirm('¬øEliminar este hito?')) return;
            
            try {
                await supabaseRequest(`/project_milestones?milestone_id=eq.${hitoId}`, {
                    method: 'DELETE'
                });
                
                showMessage('Hito eliminado', 'success');
                await cargarHitos();
                renderizarHitos();
                renderizarProyecto();
                
            } catch (error) {
                showMessage('Error: ' + error.message, 'danger');
            }
        }
        
        // --- PARTICIPANTES ---
        function abrirModalParticipante() {
            document.getElementById('form-participante').reset();
            
            // Poblar selector con workers que no est√°n en el proyecto
            const emailsEnProyecto = [proyecto.leader_email, ...participantes.map(p => p.worker_email)];
            const select = document.getElementById('participante-worker');
            select.innerHTML = '<option value="">Seleccionar...</option>';
            
            workersCache.filter(w => !emailsEnProyecto.includes(w.email)).forEach(w => {
                const nombre = formatWorkerName(w);
                select.innerHTML += `<option value="${w.email}" data-nombre="${nombre}">${nombre}</option>`;
            });
            
            modalParticipante.show();
        }
        
        async function agregarParticipante() {
            try {
                const select = document.getElementById('participante-worker');
                const email = select.value;
                const nombre = select.options[select.selectedIndex].dataset.nombre;
                const rol = document.getElementById('participante-rol').value;
                
                const datos = {
                    project_id: projectId,
                    worker_email: email,
                    worker_name: nombre,
                    participant_role: rol,
                    added_by: currentUser.user_id,
                    added_by_name: currentUser.user_display_name || currentUser.user_mail,
                    added_at: new Date().toISOString(),
                    participant_status: 'active'
                };
                
                await supabaseRequest('/project_participants', {
                    method: 'POST',
                    body: JSON.stringify(datos)
                });
                
                // Enviar notificaci√≥n
                try {
                    await sendNotification(email, 
                        `Has sido agregado al proyecto: ${proyecto.project_name}`,
                        `<p>Hola ${nombre},</p>
                         <p>Has sido agregado como <strong>${rol}</strong> al proyecto <strong>${proyecto.project_name}</strong>.</p>
                         <p>Puedes acceder al proyecto desde SchoolNet.</p>`
                    );
                } catch (e) {
                    console.warn('No se pudo enviar notificaci√≥n:', e);
                }
                
                showMessage('Participante agregado', 'success');
                modalParticipante.hide();
                await cargarParticipantes();
                renderizarParticipantes();
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'danger');
            }
        }
        
        async function removerParticipante(participantId) {
            if (!confirm('¬øRemover este participante del proyecto?')) return;
            
            try {
                await supabaseRequest(`/project_participants?participant_id=eq.${participantId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        participant_status: 'removed',
                        removed_at: new Date().toISOString(),
                        removed_by: currentUser.user_id
                    })
                });
                
                showMessage('Participante removido', 'success');
                await cargarParticipantes();
                renderizarParticipantes();
                
            } catch (error) {
                showMessage('Error: ' + error.message, 'danger');
            }
        }
        
        
        
        // --- MINUTAS ---
        function abrirModalMinuta() {
            document.getElementById('form-minuta').reset();
            document.getElementById('minuta-id').value = '';
            document.getElementById('minuta-fecha').value = getCurrentDateColombia();
            
            // Poblar checkboxes de asistentes
            const container = document.getElementById('minuta-asistentes');
            let html = '';
            
            // L√≠der
            html += `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${proyecto.leader_email}" 
                           id="asistente-leader" data-nombre="${proyecto.leader_name}" data-rol="L√≠der">
                    <label class="form-check-label" for="asistente-leader">
                        ${escapeHtml(proyecto.leader_name)} <small class="text-muted">(L√≠der)</small>
                    </label>
                </div>
            `;
            
            // Participantes
            participantes.forEach((p, i) => {
                html += `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${p.worker_email}" 
                               id="asistente-${i}" data-nombre="${p.worker_name}" data-rol="${p.participant_role}">
                        <label class="form-check-label" for="asistente-${i}">
                            ${escapeHtml(p.worker_name)} <small class="text-muted">(${p.participant_role})</small>
                        </label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            document.getElementById('modal-minuta-titulo').innerHTML = '<i class="bi bi-journal-text me-2"></i>Nueva Minuta';
            modalMinuta.show();
        }
        
        async function guardarMinuta() {
            try {
                // Obtener asistentes seleccionados
                const checkboxes = document.querySelectorAll('#minuta-asistentes input:checked');
                const asistentes = Array.from(checkboxes).map(cb => ({
                    email: cb.value,
                    name: cb.dataset.nombre,
                    role: cb.dataset.rol
                }));
                
                if (asistentes.length === 0) {
                    showMessage('Selecciona al menos un asistente', 'warning');
                    return;
                }
                
                const datos = {
                    project_id: projectId,
                    meeting_date: document.getElementById('minuta-fecha').value,
                    meeting_time: document.getElementById('minuta-hora').value || null,
                    attendees: asistentes,
                    topics_discussed: document.getElementById('minuta-temas').value.trim(),
                    decisions: document.getElementById('minuta-decisiones').value.trim() || null,
                    commitments: document.getElementById('minuta-compromisos').value.trim() || null,
                    additional_notes: document.getElementById('minuta-notas').value.trim() || null,
                    recorded_by: currentUser.user_id,
                    recorded_by_name: currentUser.user_display_name || currentUser.user_mail,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                await supabaseRequest('/project_minutes', {
                    method: 'POST',
                    body: JSON.stringify(datos)
                });
                
                showMessage('Minuta registrada', 'success');
                modalMinuta.hide();
                await cargarMinutas();
                renderizarMinutas();
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'danger');
            }
        }
        
        function verMinuta(minutaId) {
            const minuta = minutas.find(m => m.minute_id === minutaId);
            if (!minuta) return;
            
            const asistentes = minuta.attendees || [];
            
            document.getElementById('modal-minuta-content').innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="info-label">Fecha</div>
                        <div class="info-value">${formatearFecha(minuta.meeting_date)} ${minuta.meeting_time ? minuta.meeting_time.substring(0,5) : ''}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">Registrado por</div>
                        <div class="info-value">${escapeHtml(minuta.recorded_by_name)}</div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="info-label">Asistentes (${asistentes.length})</div>
                    <div class="d-flex flex-wrap gap-2">
                        ${asistentes.map(a => `<span class="badge bg-secondary">${escapeHtml(a.name)}</span>`).join('')}
                    </div>
                </div>
                <div class="mb-3">
                    <div class="info-label">Temas Tratados</div>
                    <div class="info-value">${escapeHtml(minuta.topics_discussed).replace(/\n/g, '<br>')}</div>
                </div>
                ${minuta.decisions ? `
                    <div class="mb-3">
                        <div class="info-label">Decisiones</div>
                        <div class="info-value">${escapeHtml(minuta.decisions).replace(/\n/g, '<br>')}</div>
                    </div>
                ` : ''}
                ${minuta.commitments ? `
                    <div class="mb-3">
                        <div class="info-label">Compromisos</div>
                        <div class="info-value">${escapeHtml(minuta.commitments).replace(/\n/g, '<br>')}</div>
                    </div>
                ` : ''}
                ${minuta.additional_notes ? `
                    <div class="mb-3">
                        <div class="info-label">Notas Adicionales</div>
                        <div class="info-value">${escapeHtml(minuta.additional_notes).replace(/\n/g, '<br>')}</div>
                    </div>
                ` : ''}
            `;
            
            modalVerMinuta.show();
        }
        
        // --- DOCUMENTOS ---
        async function subirDocumentos(files) {
            if (!files || files.length === 0) return;
            
            const maxSize = 10 * 1024 * 1024; // 10MB
            
            for (const file of files) {
                if (file.size > maxSize) {
                    showMessage(`${file.name} excede el l√≠mite de 10MB`, 'warning');
                    continue;
                }
                
                try {
                    mostrarLoading();
                    
                    // Subir a Supabase Storage
                    const timestamp = Date.now();
                    const fileName = `${timestamp}_${file.name}`;
                    const filePath = `${projectId}/${fileName}`;
                    
                    const { data, error } = await supabaseClient
                        .storage
                        .from('project-documents')
                        .upload(filePath, file);
                    
                    if (error) throw error;
                    
                    // Registrar en BD
                    await supabaseRequest('/project_documents', {
                        method: 'POST',
                        body: JSON.stringify({
                            project_id: projectId,
                            document_name: file.name,
                            storage_path: filePath,
                            file_size: file.size,
                            mime_type: file.type,
                            uploaded_by: currentUser.user_id,
                            uploaded_by_name: currentUser.user_display_name || currentUser.user_mail,
                            uploaded_at: new Date().toISOString(),
                            document_status: 'active'
                        })
                    });
                    
                    showMessage(`${file.name} subido correctamente`, 'success');
                    
                } catch (error) {
                    console.error('Error subiendo:', error);
                    showMessage(`Error subiendo ${file.name}: ${error.message}`, 'danger');
                }
            }
            
            document.getElementById('file-input').value = '';
            await cargarDocumentos();
            renderizarDocumentos();
            ocultarLoading();
        }
        
        async function eliminarDocumento(documentId) {
            if (!confirm('¬øEliminar este documento?')) return;
            
            try {
                const doc = documentos.find(d => d.document_id === documentId);
                
                // Eliminar de Storage
                if (doc && doc.storage_path) {
                    await supabaseClient.storage.from('project-documents').remove([doc.storage_path]);
                }
                
                // Marcar como eliminado en BD
                await supabaseRequest(`/project_documents?document_id=eq.${documentId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        document_status: 'deleted',
                        deleted_at: new Date().toISOString(),
                        deleted_by: currentUser.user_id
                    })
                });
                
                showMessage('Documento eliminado', 'success');
                await cargarDocumentos();
                renderizarDocumentos();
                
            } catch (error) {
                showMessage('Error: ' + error.message, 'danger');
            }
        }
        
        function getDocumentUrl(storagePath) {
            if (!storagePath) return '#';
            const { data } = supabaseClient.storage.from('project-documents').getPublicUrl(storagePath);
            return data.publicUrl;
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay')?.classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay')?.classList.add('hidden');
        }
        
        function formatearFecha(fecha) {
            if (!fecha) return '-';
            const d = new Date(fecha + 'T00:00:00');
            return d.toLocaleDateString('es-CO', { day: '2-digit', month: 'short', year: 'numeric' });
        }
        
        function getCurrentDateColombia() {
            const now = new Date();
            const colombiaOffset = -5 * 60;
            const localOffset = now.getTimezoneOffset();
            const colombiaTime = new Date(now.getTime() + (localOffset + colombiaOffset) * 60000);
            return colombiaTime.toISOString().split('T')[0];
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return escapeHtml(text);
            return escapeHtml(text.substring(0, maxLength)) + '...';
        }
        
        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }
        
        function getBadgeEstadoClass(estado) {
            const classes = {
                'Activo': 'badge-activo',
                'En Pausa': 'badge-pausado',
                'Completado': 'badge-completado',
                'Cancelado': 'badge-cancelado'
            };
            return classes[estado] || '';
        }
        
        function getTaskStatusBadge(status) {
            const badges = {
                'Pendiente': 'bg-secondary',
                'En progreso': 'bg-primary',
                'Completada': 'bg-success',
                'Cancelada': 'bg-danger'
            };
            return badges[status] || 'bg-secondary';
        }
        
        function getFileIcon(filename) {
            if (!filename) return 'bi-file';
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'bi-file-earmark-pdf',
                'doc': 'bi-file-earmark-word',
                'docx': 'bi-file-earmark-word',
                'xls': 'bi-file-earmark-excel',
                'xlsx': 'bi-file-earmark-excel',
                'ppt': 'bi-file-earmark-ppt',
                'pptx': 'bi-file-earmark-ppt',
                'jpg': 'bi-file-earmark-image',
                'jpeg': 'bi-file-earmark-image',
                'png': 'bi-file-earmark-image',
                'gif': 'bi-file-earmark-image',
                'zip': 'bi-file-earmark-zip',
                'rar': 'bi-file-earmark-zip'
            };
            return icons[ext] || 'bi-file-earmark';
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function calcularSalud() {
            if (['Completado', 'Cancelado'].includes(proyecto.project_status)) {
                return 'completed';
            }
            
            const today = getCurrentDateColombia();
            const hitosVencidos = hitos.filter(h => h.milestone_status === 'Pendiente' && h.committed_date < today).length;
            const tareasVencidas = tareas.filter(t => 
                ['Pendiente', 'En progreso'].includes(t.task_status) && 
                t.task_due_date && t.task_due_date < today
            ).length;
            
            if (hitosVencidos > 0 || tareasVencidas > 3) return 'critical';
            
            const hitosProximos = hitos.filter(h => {
                if (h.milestone_status !== 'Pendiente') return false;
                const dueDate = new Date(h.committed_date);
                const todayDate = new Date(today);
                const diffDays = Math.ceil((dueDate - todayDate) / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 7;
            }).length;
            
            if (hitosProximos > 0 || (tareasVencidas >= 1 && tareasVencidas <= 3)) return 'warning';
            
            return 'healthy';
        }
        
        function getHealthClass(health) {
            const classes = {
                'critical': 'health-critical',
                'warning': 'health-warning',
                'healthy': 'health-healthy',
                'completed': 'health-healthy'
            };
            return classes[health] || '';
        }
        
        function getHealthTooltip(health) {
            const tooltips = {
                'critical': 'Proyecto cr√≠tico - Requiere atenci√≥n inmediata',
                'warning': 'Proyecto requiere atenci√≥n',
                'healthy': 'Proyecto saludable',
                'completed': 'Proyecto finalizado'
            };
            return tooltips[health] || '';
        }
        
        console.log('‚úÖ Script de detalle de proyecto cargado');
    </script>
</body>
</html>
