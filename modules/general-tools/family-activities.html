<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia de familias a actividades - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSIÓN FIJA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Colores del módulo Herramientas Generales */
        :root {
            --module-primary: #6c757d;
            --module-secondary: #5a6268;
            --module-light: #e9ecef;
        }
        
        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link:hover {
            border-bottom-color: var(--module-light);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--module-primary);
            background-color: transparent;
            border-bottom-color: var(--module-primary);
        }
        
        .badge-estado {
            font-size: 0.8rem;
            padding: 0.35rem 0.75rem;
        }
        
        .activity-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .activity-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .student-check {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s;
        }
        
        .student-check:hover {
            background-color: #f8f9fa;
        }
        
        .student-check input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Asistencia de familias a actividades
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-calendar-check me-2"></i>
                    Asistencia de familias a actividades
                </h1>
                <p class="text-muted">
                    Gestiona actividades escolares y registra la asistencia de las familias
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- PESTAÑAS PRINCIPALES -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-actividades" data-bs-toggle="tab" 
                        data-bs-target="#panel-actividades" type="button" role="tab">
                    <i class="bi bi-list-task me-2"></i>Gestionar Actividades
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-asistencia" data-bs-toggle="tab" 
                        data-bs-target="#panel-asistencia" type="button" role="tab">
                    <i class="bi bi-check2-square me-2"></i>Registrar Asistencia
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-dashboard" data-bs-toggle="tab" 
                        data-bs-target="#panel-dashboard" type="button" role="tab">
                    <i class="bi bi-graph-up me-2"></i>Dashboard e Informes
                </button>
            </li>
        </ul>

        <!-- CONTENIDO DE PESTAÑAS -->
        <div class="tab-content" id="mainTabsContent">
          <!-- ============================================ -->
            <!-- PESTAÑA 1: GESTIONAR ACTIVIDADES -->
            <!-- ============================================ -->
            <div class="tab-pane fade show active" id="panel-actividades" role="tabpanel">
                
                <!-- Controles superiores -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-4">
                                <label class="form-label">Filtrar por estado</label>
                                <select class="form-select" id="filtro-estado-actividad">
                                    <option value="">Todas</option>
                                    <option value="abierta">Abiertas</option>
                                    <option value="cerrada">Cerradas</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Buscar por nombre</label>
                                <input type="text" class="form-control" id="buscar-actividad" 
                                       placeholder="Nombre de la actividad...">
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-primary" onclick="abrirModalCrearActividad()">
                                    <i class="bi bi-plus-circle me-1"></i>Nueva Actividad
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de actividades -->
                <div id="lista-actividades">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <div class="mt-2">Cargando actividades...</div>
                    </div>
                </div>

            </div>

            <!-- ============================================ -->
            <!-- PESTAÑA 2: REGISTRAR ASISTENCIA -->
            <!-- ============================================ -->
            <div class="tab-pane fade" id="panel-asistencia" role="tabpanel">
                
                <!-- Selección de actividad -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-calendar-event me-2"></i>Selecciona una actividad
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Actividad <span class="text-danger">*</span></label>
                                <select class="form-select" id="select-actividad-asistencia" 
                                        onchange="cargarCursosActividad()">
                                    <option value="">-- Selecciona una actividad --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Curso <span class="text-danger">*</span></label>
                                <select class="form-select" id="select-curso-asistencia" 
                                        onchange="cargarEstudiantesCurso()">
                                    <option value="">-- Primero selecciona una actividad --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de estudiantes -->
                <div class="card" id="card-lista-estudiantes" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-people me-2"></i>Registrar Asistencia
                        </h5>
                        <button class="btn btn-success" onclick="guardarAsistencias()">
                            <i class="bi bi-save me-1"></i>Guardar Asistencias
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="mb-3 p-3 bg-light border-bottom">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="check-todos" 
                                       onchange="toggleTodos()">
                                <label class="form-check-label fw-bold" for="check-todos">
                                    Marcar/Desmarcar todos
                                </label>
                            </div>
                        </div>
                        <div id="lista-estudiantes-asistencia">
                            <!-- Se llena dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- Mensaje inicial -->
                <div class="alert alert-info" id="mensaje-inicial-asistencia">
                    <i class="bi bi-info-circle me-2"></i>
                    Selecciona una actividad y un curso para registrar la asistencia
                </div>

            </div>

            <!-- ============================================ -->
            <!-- PESTAÑA 3: DASHBOARD E INFORMES -->
            <!-- ============================================ -->
            <div class="tab-pane fade" id="panel-dashboard" role="tabpanel">
                
                <!-- Filtros del dashboard -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-funnel me-2"></i>Filtros
                        </h5>
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Fecha desde</label>
                                <input type="date" class="form-control" id="fecha-desde-dashboard">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Fecha hasta</label>
                                <input type="date" class="form-control" id="fecha-hasta-dashboard">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Curso</label>
                                <select class="form-select" id="filtro-curso-dashboard">
                                    <option value="">Todos los cursos</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-primary w-100" onclick="cargarDashboard()">
                                    <i class="bi bi-search me-1"></i>Aplicar Filtros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alertas: Actividades sin registro -->
                <div class="card mb-4 border-warning">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                            Actividades sin registro de asistencia
                        </h5>
                    </div>
                    <div class="card-body" id="actividades-sin-registro">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-warning" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Métricas generales -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="mb-0" id="metric-total-actividades">-</h3>
                                <p class="text-muted mb-0">Total Actividades</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="mb-0" id="metric-promedio-asistencia">-</h3>
                                <p class="text-muted mb-0">Promedio Asistencia</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3 class="mb-0" id="metric-familias-participantes">-</h3>
                                <p class="text-muted mb-0">Familias Participantes</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ranking de familias -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success bg-opacity-10">
                                <h5 class="mb-0">
                                    <i class="bi bi-trophy text-success me-2"></i>
                                    Familias con Mayor Participación
                                </h5>
                            </div>
                            <div class="card-body" id="ranking-familias-top">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-danger bg-opacity-10">
                                <h5 class="mb-0">
                                    <i class="bi bi-arrow-down-circle text-danger me-2"></i>
                                    Familias con Menor Participación
                                </h5>
                            </div>
                            <div class="card-body" id="ranking-familias-bottom">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <!-- ============================================ -->
    <!-- MODAL: CREAR/EDITAR ACTIVIDAD -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-actividad" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-actividad-title">
                        <i class="bi bi-plus-circle me-2"></i>Nueva Actividad
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="form-actividad">
                    <div class="modal-body">
                        <input type="hidden" id="actividad-id">
                        <input type="hidden" id="actividad-propietario">
                        
                        <div class="mb-3">
                            <label for="actividad-nombre" class="form-label">
                                Nombre de la actividad <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="actividad-nombre" 
                                   name="nombre" required maxlength="255"
                                   placeholder="Ej: Reunión de padres de familia - Primer periodo">
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="actividad-fecha" class="form-label">
                                    Fecha <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="actividad-fecha" 
                                       name="fecha" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="actividad-estado" class="form-label">
                                    Estado <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="actividad-estado" name="estado" required>
                                    <option value="abierta">Abierta</option>
                                    <option value="cerrada">Cerrada</option>
                                </select>
                                <small class="text-muted">
                                    Las actividades cerradas no permiten registro de asistencia
                                </small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                Cursos asociados <span class="text-danger">*</span>
                            </label>
                            <div class="border rounded p-3 bg-light">
                                <div id="cursos-seleccionados" class="mb-2">
                                    <span class="text-muted" id="placeholder-cursos">
                                        <i class="bi bi-info-circle me-1"></i>
                                        No hay cursos asociados. Haz clic en el botón de abajo para seleccionar.
                                    </span>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                        onclick="abrirModalCursos()">
                                    <i class="bi bi-plus-circle me-1"></i>Seleccionar Cursos
                                </button>
                            </div>
                        </div>

                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            <small>
                                <strong>Importante:</strong> Los cursos asociados determinarán qué estudiantes 
                                (y por ende qué familias) están invitados a esta actividad.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" id="btn-guardar-actividad">
                            <i class="bi bi-save me-1"></i>Guardar Actividad
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL: SELECCIONAR CURSOS -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-cursos" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-list-check me-2"></i>Seleccionar Cursos
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Búsqueda rápida -->
                    <div class="mb-3">
                        <input type="text" class="form-control" id="buscar-curso" 
                               placeholder="Buscar curso...">
                    </div>

                    <!-- Selección por sección -->
                    <div class="accordion" id="accordion-secciones">
                        <!-- Se llena dinámicamente -->
                    </div>

                    <!-- Controles de selección masiva -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="seleccionarTodosCursos()">
                                <i class="bi bi-check-all me-1"></i>Seleccionar todos
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" 
                                    onclick="deseleccionarTodosCursos()">
                                <i class="bi bi-x-circle me-1"></i>Deseleccionar todos
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmarCursos()">
                        <i class="bi bi-check-circle me-1"></i>Confirmar Selección
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- MODAL: CONFIRMACIÓN DE ELIMINACIÓN -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-confirmar-eliminar" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminación
                    </h5>
                    <button type="button" class="btn-close btn-close-white" 
                            data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">¿Estás seguro de que deseas eliminar esta actividad?</p>
                    <div class="alert alert-warning mt-3 mb-0">
                        <small>
                            <i class="bi bi-info-circle me-1"></i>
                            Solo se pueden eliminar actividades que no tengan registros de asistencia.
                        </small>
                    </div>
                    <input type="hidden" id="eliminar-actividad-id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmarEliminarActividad()">
                        <i class="bi bi-trash me-1"></i>Sí, Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let cursosSeleccionados = []; // Array temporal para selección de cursos
        let cursosData = []; // Datos completos de cursos cargados
        let actividadEnEdicion = null; // ID de actividad en edición

      // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Validando acceso...');
            
            try {
                // Validar permisos
                const hasAccess = await validatePageAccess('Asistencia de familias');
                if (!hasAccess) return;
                
                // Obtener sesión
                const session = getStoredSession();
                if (!session || !session.user) {
                    window.location.href = '../../login.html';
                    return;
                }
                
                currentUser = session.user;
                console.log('✅ Usuario autenticado:', currentUser.user_display_name);
                
                // Inicializar página
                await inicializarPagina();
                
            } catch (error) {
                console.error('❌ Error en inicialización:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // INICIALIZACIÓN DE PÁGINA
        // ==========================================
        async function inicializarPagina() {
            try {
                // Cargar datos iniciales
                await Promise.all([
                    cargarActividades(),
                    cargarActividadesParaAsistencia(),
                    cargarCursosParaDashboard()
                ]);
                
                // Configurar filtros
                document.getElementById('filtro-estado-actividad').addEventListener('change', filtrarActividades);
                document.getElementById('buscar-actividad').addEventListener('input', filtrarActividades);
                document.getElementById('buscar-curso').addEventListener('input', filtrarCursosModal);
                
                console.log('✅ Página inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                showMessage('Error al cargar datos iniciales', 'danger');
            }
        }

        // ==========================================
        // PESTAÑA 1: GESTIÓN DE ACTIVIDADES
        // ==========================================
        
        // Cargar lista de actividades
        async function cargarActividades() {
            try {
                const container = document.getElementById('lista-actividades');
                container.innerHTML = '<div class="text-center py-3"><div class="spinner-border"></div></div>';
                
                // Obtener actividades con cursos asociados
                const actividades = await supabaseRequest(
                    '/familia_actividad_actividades?select=*,familia_actividad_cursos(curso_id,courses(course_name,sections(section_name)))&order=fecha.desc'
                );
                
                if (!actividades || actividades.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            No hay actividades registradas. Crea tu primera actividad usando el botón "Nueva Actividad".
                        </div>
                    `;
                    return;
                }
                
                renderizarActividades(actividades);
                
            } catch (error) {
                console.error('❌ Error cargando actividades:', error);
                document.getElementById('lista-actividades').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error al cargar actividades: ${error.message}
                    </div>
                `;
            }
        }

        // Renderizar lista de actividades
        function renderizarActividades(actividades) {
            const container = document.getElementById('lista-actividades');
            
            const html = actividades.map(actividad => {
                const cursos = actividad.familia_actividad_cursos || [];
                const cursosTexto = cursos.length > 0 
                    ? cursos.map(c => c.courses?.course_name || 'Sin nombre').join(', ')
                    : 'Sin cursos asociados';
                
                const estadoBadge = actividad.estado === 'abierta' 
                    ? '<span class="badge bg-success badge-estado">Abierta</span>'
                    : '<span class="badge bg-secondary badge-estado">Cerrada</span>';
                
                const puedeEditar = actividad.usuario_propietario_id === currentUser.user_id;
                
                return `
                    <div class="card activity-card mb-3" data-actividad='${JSON.stringify(actividad)}'>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="card-title mb-2">
                                        <i class="bi bi-calendar-event me-2"></i>
                                        ${escapeHtml(actividad.nombre)}
                                    </h5>
                                    <p class="text-muted mb-2">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        <strong>Fecha:</strong> ${formatDate(actividad.fecha)}
                                    </p>
                                    <p class="text-muted mb-0">
                                        <i class="bi bi-book me-1"></i>
                                        <strong>Cursos:</strong> ${escapeHtml(cursosTexto)}
                                    </p>
                                </div>
                                <div class="col-md-3">
                                    ${estadoBadge}
                                </div>
                                <div class="col-md-3 text-end">
                                    <div class="btn-group">
                                        ${puedeEditar ? `
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    onclick="editarActividad(${actividad.id})"
                                                    title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    onclick="abrirModalEliminar(${actividad.id})"
                                                    title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        ` : `
                                            <span class="text-muted small">
                                                <i class="bi bi-lock me-1"></i>Creada por otro usuario
                                            </span>
                                        `}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // Filtrar actividades
        function filtrarActividades() {
            const estado = document.getElementById('filtro-estado-actividad').value.toLowerCase();
            const busqueda = document.getElementById('buscar-actividad').value.toLowerCase();
            
            const tarjetas = document.querySelectorAll('.activity-card');
            
            tarjetas.forEach(tarjeta => {
                const actividad = JSON.parse(tarjeta.dataset.actividad);
                const nombreMatch = actividad.nombre.toLowerCase().includes(busqueda);
                const estadoMatch = !estado || actividad.estado === estado;
                
                tarjeta.style.display = (nombreMatch && estadoMatch) ? 'block' : 'none';
            });
        }

        // Abrir modal para crear actividad
        async function abrirModalCrearActividad() {
            try {
                // Limpiar formulario
                document.getElementById('form-actividad').reset();
                document.getElementById('actividad-id').value = '';
                document.getElementById('actividad-propietario').value = currentUser.user_id;
                document.getElementById('modal-actividad-title').innerHTML = 
                    '<i class="bi bi-plus-circle me-2"></i>Nueva Actividad';
                
                // Limpiar cursos seleccionados
                cursosSeleccionados = [];
                document.getElementById('cursos-seleccionados').innerHTML = 
                    '<span class="text-muted" id="placeholder-cursos"><i class="bi bi-info-circle me-1"></i>No hay cursos asociados. Haz clic en el botón de abajo para seleccionar.</span>';
                
                actividadEnEdicion = null;
                
                // Establecer fecha mínima como hoy
                const hoy = new Date().toISOString().split('T')[0];
                document.getElementById('actividad-fecha').setAttribute('min', hoy);
                
                // Abrir modal
                const modal = new bootstrap.Modal(document.getElementById('modal-actividad'));
                modal.show();
                
            } catch (error) {
                console.error('❌ Error abriendo modal:', error);
                showMessage('Error al abrir formulario', 'danger');
            }
        }

        // Editar actividad
        async function editarActividad(actividadId) {
            try {
                // Obtener datos de la actividad
                const actividades = await supabaseRequest(
                    `/familia_actividad_actividades?id=eq.${actividadId}&select=*,familia_actividad_cursos(curso_id)`
                );
                
                if (!actividades || actividades.length === 0) {
                    showMessage('Actividad no encontrada', 'danger');
                    return;
                }
                
                const actividad = actividades[0];
                
                // Verificar permisos
                if (actividad.usuario_propietario_id !== currentUser.user_id) {
                    showMessage('No tienes permisos para editar esta actividad', 'warning');
                    return;
                }
                
                // Llenar formulario
                document.getElementById('actividad-id').value = actividad.id;
                document.getElementById('actividad-propietario').value = actividad.usuario_propietario_id;
                document.getElementById('actividad-nombre').value = actividad.nombre;
                document.getElementById('actividad-fecha').value = actividad.fecha;
                document.getElementById('actividad-estado').value = actividad.estado;
                
                document.getElementById('modal-actividad-title').innerHTML = 
                    '<i class="bi bi-pencil me-2"></i>Editar Actividad';
                
                // Cargar cursos asociados
                cursosSeleccionados = actividad.familia_actividad_cursos.map(c => c.curso_id);
                await actualizarVisualizacionCursos();
                
                actividadEnEdicion = actividadId;
                
                // Abrir modal
                const modal = new bootstrap.Modal(document.getElementById('modal-actividad'));
                modal.show();
                
            } catch (error) {
                console.error('❌ Error editando actividad:', error);
                showMessage('Error al cargar actividad: ' + error.message, 'danger');
            }
        }

        // Guardar actividad (crear o actualizar)
        document.getElementById('form-actividad').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                // Validar que haya cursos seleccionados
                if (cursosSeleccionados.length === 0) {
                    showMessage('Debes seleccionar al menos un curso', 'warning');
                    return;
                }
                
                const btnGuardar = document.getElementById('btn-guardar-actividad');
                btnGuardar.disabled = true;
                btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';
                
                const actividadId = document.getElementById('actividad-id').value;
                const datos = {
                    nombre: document.getElementById('actividad-nombre').value,
                    fecha: document.getElementById('actividad-fecha').value,
                    estado: document.getElementById('actividad-estado').value,
                    usuario_propietario_id: document.getElementById('actividad-propietario').value
                };
                
                let actividadGuardadaId;
                
                if (actividadId) {
                    // Actualizar
                    await supabaseRequest(`/familia_actividad_actividades?id=eq.${actividadId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(datos)
                    });
                    actividadGuardadaId = actividadId;
                    showMessage('Actividad actualizada correctamente', 'success');
                } else {
                    // Crear
                    const resultado = await supabaseRequest('/familia_actividad_actividades', {
                        method: 'POST',
                        body: JSON.stringify(datos)
                    });
                    actividadGuardadaId = resultado[0].id;
                    showMessage('Actividad creada correctamente', 'success');
                }
                
                // Actualizar cursos asociados
                await actualizarCursosActividad(actividadGuardadaId);
                
                // Cerrar modal y recargar
                bootstrap.Modal.getInstance(document.getElementById('modal-actividad')).hide();
                await cargarActividades();
                await cargarActividadesParaAsistencia();
                
            } catch (error) {
                console.error('❌ Error guardando actividad:', error);
                showMessage('Error al guardar actividad: ' + error.message, 'danger');
            } finally {
                const btnGuardar = document.getElementById('btn-guardar-actividad');
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = '<i class="bi bi-save me-1"></i>Guardar Actividad';
            }
        });

        // Actualizar cursos de una actividad
        async function actualizarCursosActividad(actividadId) {
            try {
                // Eliminar cursos existentes
                await supabaseRequest(`/familia_actividad_cursos?actividad_id=eq.${actividadId}`, {
                    method: 'DELETE'
                });
                
                // Insertar nuevos cursos
                const cursosParaInsertar = cursosSeleccionados.map(cursoId => ({
                    actividad_id: actividadId,
                    curso_id: cursoId
                }));
                
                await supabaseRequest('/familia_actividad_cursos', {
                    method: 'POST',
                    body: JSON.stringify(cursosParaInsertar)
                });
                
            } catch (error) {
                console.error('❌ Error actualizando cursos:', error);
                throw error;
            }
        }

      // ==========================================
        // MODAL DE SELECCIÓN DE CURSOS
        // ==========================================
        
        // Abrir modal de selección de cursos
        async function abrirModalCursos() {
            try {
                // Cargar cursos si no están cargados
                if (cursosData.length === 0) {
                    const cursos = await supabaseRequest(
                        '/courses?select=course_id,course_name,section_id,sections(section_name,section_order)&order=sections(section_order),course_name'
                    );
                    cursosData = cursos;
                }
                
                // Agrupar por sección
                const secciones = {};
                cursosData.forEach(curso => {
                    const seccionNombre = curso.sections?.section_name || 'Sin sección';
                    if (!secciones[seccionNombre]) {
                        secciones[seccionNombre] = [];
                    }
                    secciones[seccionNombre].push(curso);
                });
                
                // Renderizar accordion
                const accordion = document.getElementById('accordion-secciones');
                accordion.innerHTML = Object.keys(secciones).map((seccion, index) => `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#collapse-${index}">
                                ${escapeHtml(seccion)} (${secciones[seccion].length} cursos)
                            </button>
                        </h2>
                        <div id="collapse-${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                             data-bs-parent="#accordion-secciones">
                            <div class="accordion-body">
                                ${secciones[seccion].map(curso => `
                                    <div class="form-check mb-2">
                                        <input class="form-check-input curso-checkbox" type="checkbox" 
                                               value="${curso.course_id}" 
                                               id="curso-${curso.course_id}"
                                               ${cursosSeleccionados.includes(curso.course_id) ? 'checked' : ''}>
                                        <label class="form-check-label" for="curso-${curso.course_id}">
                                            ${escapeHtml(curso.course_name)}
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Abrir modal
                const modal = new bootstrap.Modal(document.getElementById('modal-cursos'));
                modal.show();
                
            } catch (error) {
                console.error('❌ Error abriendo modal de cursos:', error);
                showMessage('Error al cargar cursos', 'danger');
            }
        }

        // Confirmar selección de cursos
        async function confirmarCursos() {
            const checkboxes = document.querySelectorAll('.curso-checkbox:checked');
            cursosSeleccionados = Array.from(checkboxes).map(cb => cb.value);
            
            await actualizarVisualizacionCursos();
            
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('modal-cursos')).hide();
        }

        // Actualizar visualización de cursos seleccionados
        async function actualizarVisualizacionCursos() {
            const container = document.getElementById('cursos-seleccionados');
            
            if (cursosSeleccionados.length === 0) {
                container.innerHTML = '<span class="text-muted" id="placeholder-cursos"><i class="bi bi-info-circle me-1"></i>No hay cursos asociados.</span>';
                return;
            }
            
            // Obtener nombres de cursos
            const cursosNombres = cursosSeleccionados.map(cursoId => {
                const curso = cursosData.find(c => c.course_id === cursoId);
                return curso ? curso.course_name : cursoId;
            });
            
            container.innerHTML = cursosNombres.map(nombre => 
                `<span class="badge bg-primary me-1 mb-1">${escapeHtml(nombre)}</span>`
            ).join('');
        }

        // Filtrar cursos en modal
        function filtrarCursosModal() {
            const busqueda = document.getElementById('buscar-curso').value.toLowerCase();
            const checkboxes = document.querySelectorAll('.curso-checkbox');
            
            checkboxes.forEach(checkbox => {
                const label = checkbox.nextElementSibling;
                const texto = label.textContent.toLowerCase();
                const div = checkbox.parentElement;
                div.style.display = texto.includes(busqueda) ? 'block' : 'none';
            });
        }

        // Seleccionar todos los cursos
        function seleccionarTodosCursos() {
            document.querySelectorAll('.curso-checkbox').forEach(cb => cb.checked = true);
        }

        // Deseleccionar todos los cursos
        function deseleccionarTodosCursos() {
            document.querySelectorAll('.curso-checkbox').forEach(cb => cb.checked = false);
        }

        // ==========================================
        // ELIMINACIÓN DE ACTIVIDADES
        // ==========================================
        
        function abrirModalEliminar(actividadId) {
            document.getElementById('eliminar-actividad-id').value = actividadId;
            const modal = new bootstrap.Modal(document.getElementById('modal-confirmar-eliminar'));
            modal.show();
        }

        async function confirmarEliminarActividad() {
            try {
                const actividadId = document.getElementById('eliminar-actividad-id').value;
                
                // Verificar si hay asistencias registradas
                const asistencias = await supabaseRequest(
                    `/familia_actividad_asistencias?actividad_id=eq.${actividadId}&select=id`
                );
                
                if (asistencias && asistencias.length > 0) {
                    showMessage('No se puede eliminar una actividad con asistencias registradas', 'warning');
                    bootstrap.Modal.getInstance(document.getElementById('modal-confirmar-eliminar')).hide();
                    return;
                }
                
                // Eliminar cursos asociados
                await supabaseRequest(`/familia_actividad_cursos?actividad_id=eq.${actividadId}`, {
                    method: 'DELETE'
                });
                
                // Eliminar actividad
                await supabaseRequest(`/familia_actividad_actividades?id=eq.${actividadId}`, {
                    method: 'DELETE'
                });
                
                showMessage('Actividad eliminada correctamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modal-confirmar-eliminar')).hide();
                
                await cargarActividades();
                await cargarActividadesParaAsistencia();
                
            } catch (error) {
                console.error('❌ Error eliminando actividad:', error);
                showMessage('Error al eliminar actividad: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // PESTAÑA 2: REGISTRO DE ASISTENCIA
        // ==========================================
        
        // Cargar actividades para registro de asistencia
        async function cargarActividadesParaAsistencia() {
            try {
                const select = document.getElementById('select-actividad-asistencia');
                select.innerHTML = '<option value="">-- Selecciona una actividad --</option>';
                
                // Cargar solo actividades abiertas
                const actividades = await supabaseRequest(
                    '/familia_actividad_actividades?estado=eq.abierta&select=id,nombre,fecha&order=fecha.desc'
                );
                
                actividades.forEach(act => {
                    const option = document.createElement('option');
                    option.value = act.id;
                    option.textContent = `${act.nombre} - ${formatDate(act.fecha)}`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('❌ Error cargando actividades:', error);
            }
        }

        // Cargar cursos de la actividad seleccionada
        async function cargarCursosActividad() {
            try {
                const actividadId = document.getElementById('select-actividad-asistencia').value;
                const selectCurso = document.getElementById('select-curso-asistencia');
                
                if (!actividadId) {
                    selectCurso.innerHTML = '<option value="">-- Primero selecciona una actividad --</option>';
                    document.getElementById('card-lista-estudiantes').style.display = 'none';
                    document.getElementById('mensaje-inicial-asistencia').style.display = 'block';
                    return;
                }
                
                selectCurso.innerHTML = '<option value="">-- Cargando cursos... --</option>';
                
                // Obtener cursos asociados a la actividad
                const cursos = await supabaseRequest(
                    `/familia_actividad_cursos?actividad_id=eq.${actividadId}&select=curso_id,courses(course_id,course_name)`
                );
                
                selectCurso.innerHTML = '<option value="">-- Selecciona un curso --</option>';
                cursos.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.courses.course_id;
                    option.textContent = c.courses.course_name;
                    selectCurso.appendChild(option);
                });
                
            } catch (error) {
                console.error('❌ Error cargando cursos:', error);
                showMessage('Error al cargar cursos', 'danger');
            }
        }

        // Cargar estudiantes del curso seleccionado
        async function cargarEstudiantesCurso() {
            try {
                const actividadId = document.getElementById('select-actividad-asistencia').value;
                const cursoId = document.getElementById('select-curso-asistencia').value;
                
                if (!actividadId || !cursoId) {
                    document.getElementById('card-lista-estudiantes').style.display = 'none';
                    document.getElementById('mensaje-inicial-asistencia').style.display = 'block';
                    return;
                }
                
                document.getElementById('mensaje-inicial-asistencia').style.display = 'none';
                document.getElementById('card-lista-estudiantes').style.display = 'block';
                
                const container = document.getElementById('lista-estudiantes-asistencia');
                container.innerHTML = '<div class="text-center py-3"><div class="spinner-border"></div></div>';
                
                // Obtener estudiantes del curso
                const estudiantes = await supabaseRequest(
                    `/students?course_id=eq.${cursoId}&select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2&order=student_last_name_1,student_first_name`
                );
                
                // Obtener asistencias ya registradas
                const asistenciasRegistradas = await supabaseRequest(
                    `/familia_actividad_asistencias?actividad_id=eq.${actividadId}&estudiante_id=in.(${estudiantes.map(e => e.student_id).join(',')})&select=estudiante_id,asistio`
                );
                
                const asistenciasMap = {};
                asistenciasRegistradas.forEach(a => {
                    asistenciasMap[a.estudiante_id] = a.asistio;
                });
                
                // Renderizar lista
                container.innerHTML = estudiantes.map(est => {
                    const nombreCompleto = `${est.student_first_name} ${est.student_last_name_1} ${est.student_last_name_2 || ''}`;
                    const yaRegistrado = asistenciasMap.hasOwnProperty(est.student_id);
                    const asistio = asistenciasMap[est.student_id] || false;
                    
                    return `
                        <div class="student-check">
                            <div class="form-check">
                                <input class="form-check-input student-checkbox" type="checkbox" 
                                       value="${est.student_id}" 
                                       id="student-${est.student_id}"
                                       ${asistio ? 'checked' : ''}>
                                <label class="form-check-label" for="student-${est.student_id}">
                                    <strong>${escapeHtml(nombreCompleto)}</strong>
                                    <small class="text-muted d-block">Código: ${est.student_code}</small>
                                    ${yaRegistrado ? '<span class="badge bg-info ms-2">Ya registrado</span>' : ''}
                                </label>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Reset check-todos
                document.getElementById('check-todos').checked = false;
                
            } catch (error) {
                console.error('❌ Error cargando estudiantes:', error);
                showMessage('Error al cargar estudiantes: ' + error.message, 'danger');
            }
        }

        // Toggle todos los checkboxes
        function toggleTodos() {
            const checkTodos = document.getElementById('check-todos');
            const checkboxes = document.querySelectorAll('.student-checkbox');
            checkboxes.forEach(cb => cb.checked = checkTodos.checked);
        }

        // Guardar asistencias
        async function guardarAsistencias() {
            try {
                const actividadId = document.getElementById('select-actividad-asistencia').value;
                const cursoId = document.getElementById('select-curso-asistencia').value;
                
                if (!actividadId || !cursoId) {
                    showMessage('Selecciona una actividad y un curso', 'warning');
                    return;
                }
                
                const checkboxes = document.querySelectorAll('.student-checkbox');
                const registros = [];
                
                checkboxes.forEach(cb => {
                    registros.push({
                        actividad_id: parseInt(actividadId),
                        estudiante_id: parseInt(cb.value),
                        asistio: cb.checked
                    });
                });
                
                if (registros.length === 0) {
                    showMessage('No hay estudiantes para registrar', 'warning');
                    return;
                }
                
                // Eliminar registros existentes para estos estudiantes
                const estudiantesIds = registros.map(r => r.estudiante_id).join(',');
                await supabaseRequest(
                    `/familia_actividad_asistencias?actividad_id=eq.${actividadId}&estudiante_id=in.(${estudiantesIds})`,
                    { method: 'DELETE' }
                );
                
                // Insertar nuevos registros
                await supabaseRequest('/familia_actividad_asistencias', {
                    method: 'POST',
                    body: JSON.stringify(registros)
                });
                
                showMessage('Asistencias guardadas correctamente', 'success');
                
            } catch (error) {
                console.error('❌ Error guardando asistencias:', error);
                showMessage('Error al guardar asistencias: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // PESTAÑA 3: DASHBOARD E INFORMES
        // ==========================================
        
        // Cargar cursos para filtro del dashboard
        async function cargarCursosParaDashboard() {
            try {
                const select = document.getElementById('filtro-curso-dashboard');
                const cursos = await supabaseRequest('/courses?select=course_id,course_name&order=course_name');
                
                cursos.forEach(curso => {
                    const option = document.createElement('option');
                    option.value = curso.course_id;
                    option.textContent = curso.course_name;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('❌ Error cargando cursos:', error);
            }
        }

        // Cargar dashboard
        async function cargarDashboard() {
            try {
                const fechaDesde = document.getElementById('fecha-desde-dashboard').value;
                const fechaHasta = document.getElementById('fecha-hasta-dashboard').value;
                const cursoId = document.getElementById('filtro-curso-dashboard').value;
                
                // Cargar actividades sin registro
                await cargarActividadesSinRegistro(fechaDesde, fechaHasta, cursoId);
                
                // Cargar métricas
                await cargarMetricasDashboard(fechaDesde, fechaHasta, cursoId);
                
                // Cargar rankings
                await cargarRankingFamilias(fechaDesde, fechaHasta, cursoId);
                
            } catch (error) {
                console.error('❌ Error cargando dashboard:', error);
                showMessage('Error al cargar dashboard: ' + error.message, 'danger');
            }
        }

        // Cargar actividades sin registro de asistencia
        async function cargarActividadesSinRegistro(fechaDesde, fechaHasta, cursoId) {
            try {
                const container = document.getElementById('actividades-sin-registro');
                container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>';
                
                const hoy = new Date().toISOString().split('T')[0];
                let query = `/familia_actividad_actividades?fecha=lt.${hoy}&select=id,nombre,fecha,familia_actividad_cursos(curso_id)`;
                
                if (fechaDesde) query += `&fecha=gte.${fechaDesde}`;
                if (fechaHasta) query += `&fecha=lte.${fechaHasta}`;
                
                const actividades = await supabaseRequest(query);
                
                // Filtrar actividades que no tienen asistencias
                const actividadesSinRegistro = [];
                for (const act of actividades) {
                    const asistencias = await supabaseRequest(
                        `/familia_actividad_asistencias?actividad_id=eq.${act.id}&select=id&limit=1`
                    );
                    if (!asistencias || asistencias.length === 0) {
                        actividadesSinRegistro.push(act);
                    }
                }
                
                if (actividadesSinRegistro.length === 0) {
                    container.innerHTML = '<p class="text-muted mb-0"><i class="bi bi-check-circle text-success me-2"></i>No hay actividades pendientes de registro</p>';
                    return;
                }
                
                container.innerHTML = `
                    <ul class="list-group list-group-flush">
                        ${actividadesSinRegistro.map(act => `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${escapeHtml(act.nombre)}</strong>
                                    <br><small class="text-muted">${formatDate(act.fecha)}</small>
                                </div>
                                <span class="badge bg-warning">Sin registro</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
                
            } catch (error) {
                console.error('❌ Error cargando actividades sin registro:', error);
                document.getElementById('actividades-sin-registro').innerHTML = 
                    '<p class="text-danger mb-0">Error al cargar datos</p>';
            }
        }

        // Cargar métricas del dashboard
        async function cargarMetricasDashboard(fechaDesde, fechaHasta, cursoId) {
            try {
                let query = '/familia_actividad_actividades?select=id,familia_actividad_asistencias(asistio,estudiante_id,students(family_id))';
                
                if (fechaDesde) query += `&fecha=gte.${fechaDesde}`;
                if (fechaHasta) query += `&fecha=lte.${fechaHasta}`;
                
                const actividades = await supabaseRequest(query);
                
                // Total actividades
                document.getElementById('metric-total-actividades').textContent = actividades.length;
                
                // Calcular promedio de asistencia
                let totalInvitaciones = 0;
                let totalAsistencias = 0;
                const familiasSet = new Set();
                
                actividades.forEach(act => {
                    act.familia_actividad_asistencias.forEach(asist => {
                        totalInvitaciones++;
                        if (asist.asistio) {
                            totalAsistencias++;
                            if (asist.students?.family_id) {
                                familiasSet.add(asist.students.family_id);
                            }
                        }
                    });
                });
                
                const promedio = totalInvitaciones > 0 
                    ? Math.round((totalAsistencias / totalInvitaciones) * 100) 
                    : 0;
                
                document.getElementById('metric-promedio-asistencia').textContent = `${promedio}%`;
                document.getElementById('metric-familias-participantes').textContent = familiasSet.size;
                
            } catch (error) {
                console.error('❌ Error cargando métricas:', error);
            }
        }

        // Cargar ranking de familias
        async function cargarRankingFamilias(fechaDesde, fechaHasta, cursoId) {
            try {
                let query = '/familia_actividad_asistencias?select=asistio,estudiante_id,students(family_id,families(family_code))';
                
                if (fechaDesde || fechaHasta) {
                    query += ',actividad_id,familia_actividad_actividades(fecha)';
                }
                
                const asistencias = await supabaseRequest(query);
                
                // Agrupar por familia
                const familias = {};
                
                asistencias.forEach(asist => {
                    const familyId = asist.students?.family_id;
                    const familyCode = asist.students?.families?.family_code;
                    
                    if (!familyId) return;
                    
                    if (!familias[familyId]) {
                        familias[familyId] = {
                            code: familyCode,
                            invitaciones: 0,
                            asistencias: 0
                        };
                    }
                    
                    familias[familyId].invitaciones++;
                    if (asist.asistio) {
                        familias[familyId].asistencias++;
                    }
                });
                
                // Calcular porcentajes y ordenar
                const familiasArray = Object.keys(familias).map(id => {
                    const fam = familias[id];
                    return {
                        id: id,
                        code: fam.code,
                        porcentaje: Math.round((fam.asistencias / fam.invitaciones) * 100),
                        asistencias: fam.asistencias,
                        invitaciones: fam.invitaciones
                    };
                });
                
                familiasArray.sort((a, b) => b.porcentaje - a.porcentaje);
                
                // Top 10
                const top = familiasArray.slice(0, 10);
                document.getElementById('ranking-familias-top').innerHTML = top.length > 0
                    ? `<ul class="list-group list-group-flush">${top.map((fam, idx) => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <strong>${idx + 1}.</strong> Familia ${fam.code}
                                <small class="text-muted d-block">${fam.asistencias} de ${fam.invitaciones} invitaciones</small>
                            </span>
                            <span class="badge bg-success">${fam.porcentaje}%</span>
                        </li>
                    `).join('')}</ul>`
                    : '<p class="text-muted mb-0">No hay datos disponibles</p>';
                
                // Bottom 10
                const bottom = familiasArray.slice(-10).reverse();
                document.getElementById('ranking-familias-bottom').innerHTML = bottom.length > 0
                    ? `<ul class="list-group list-group-flush">${bottom.map(fam => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                Familia ${fam.code}
                                <small class="text-muted d-block">${fam.asistencias} de ${fam.invitaciones} invitaciones</small>
                            </span>
                            <span class="badge bg-danger">${fam.porcentaje}%</span>
                        </li>
                    `).join('')}</ul>`
                    : '<p class="text-muted mb-0">No hay datos disponibles</p>';
                
            } catch (error) {
                console.error('❌ Error cargando ranking:', error);
            }
        }

        // ==========================================
        // FUNCIONES AUXILIARES
        // ==========================================
        
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }

        console.log('✅ Módulo de Asistencia de familias cargado');
    </script>
</body>
</html>
