<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSIÓN DE LA PÁGINA -->
    <meta name="page-version" content="25.10.29.07.25">
    
    <title>Registro de Asistencia - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSIÓN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Scanner Container */
        .scanner-container {
            border: 3px dashed #007bff;
            border-radius: 12px;
            padding: 2rem;
            background: #f8f9fa;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #reader {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .scanner-icon {
            font-size: 4rem;
            color: #007bff;
            margin-bottom: 1rem;
        }
        
        /* Success/Error Feedback */
        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .feedback-overlay.show {
            display: flex;
        }
        
        .feedback-content {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
            animation: feedbackPop 0.3s ease;
        }
        
        @keyframes feedbackPop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .feedback-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
        }
        
        .feedback-icon.success {
            color: #28a745;
        }
        
        .feedback-icon.error {
            color: #dc3545;
        }
        
        .feedback-icon.warning {
            color: #ffc107;
        }
        
        /* Recent Records */
        .recent-record {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s;
        }
        
        .recent-record:hover {
            background: #f8f9fa;
        }
        
        .recent-record:last-child {
            border-bottom: none;
        }
        
        .record-time {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .record-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .record-type {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        
        .record-type.entrada {
            background: #d4edda;
            color: #155724;
        }
        
        .record-type.salida {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Search Results */
        .search-result-item {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .search-result-item:hover {
            background: #e7f3ff;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .person-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
        
        .person-badge.student {
            background: #cfe2ff;
            color: #084298;
        }
        
        .person-badge.worker {
            background: #d1e7dd;
            color: #0f5132;
        }
        
        /* Stats Bar */
        .stats-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .scanner-container {
                padding: 1rem;
                min-height: 250px;
            }
            
            .scanner-icon {
                font-size: 3rem;
            }
            
            .feedback-content {
                padding: 2rem;
            }
            
            .feedback-icon {
                font-size: 4rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- Feedback Overlay -->
    <div id="feedback-overlay" class="feedback-overlay">
        <div class="feedback-content">
            <div id="feedback-icon" class="feedback-icon"></div>
            <h4 id="feedback-title"></h4>
            <p id="feedback-message" class="mb-0"></p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Registro de Asistencia
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE PÁGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Registro de Asistencia
                </h1>
                <p class="text-muted">
                    Registro de asistencia mediante lectura de carnets o búsqueda manual
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- ESTADÍSTICAS DEL DÍA -->
        <div class="stats-bar">
            <div class="row">
                <div class="col-6 col-md-3 stat-item">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">Total Registros</div>
                </div>
                <div class="col-6 col-md-3 stat-item">
                    <div class="stat-value" id="stat-entradas">0</div>
                    <div class="stat-label">Entradas</div>
                </div>
                <div class="col-6 col-md-3 stat-item">
                    <div class="stat-value" id="stat-salidas">0</div>
                    <div class="stat-label">Salidas</div>
                </div>
                <div class="col-6 col-md-3 stat-item">
                    <div class="stat-value" id="stat-ultima-hora">0</div>
                    <div class="stat-label">Última Hora</div>
                </div>
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div class="row">
            <!-- COLUMNA IZQUIERDA: SCANNER -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-camera me-2"></i>Registro de Asistencia
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Selector de modo -->
                        <div class="mb-3 text-center">
                            <label class="form-label fw-bold">Modo de registro:</label>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="registro-mode" id="mode-camera" value="camera" checked>
                                <label class="btn btn-outline-primary" for="mode-camera">
                                    <i class="bi bi-camera me-1"></i>Cámara
                                </label>
                                
                                <input type="radio" class="btn-check" name="registro-mode" id="mode-rfid" value="rfid">
                                <label class="btn btn-outline-primary" for="mode-rfid">
                                    <i class="bi bi-credit-card me-1"></i>Lector RFID
                                </label>
                            </div>
                        </div>

                        <!-- Scanner Container (Cámara) -->
                        <div class="scanner-container" id="scanner-container">
                            <i class="bi bi-upc-scan scanner-icon"></i>
                            <h4>Listo para escanear</h4>
                            <p class="text-muted mb-3">Acerca el código de barras del carnet a la cámara</p>
                            <div id="reader" style="display: none;"></div>
                            <button class="btn btn-primary btn-lg" id="start-scanner-btn" onclick="iniciarScanner()">
                                <i class="bi bi-camera me-2"></i>Activar Cámara
                            </button>
                            <button class="btn btn-danger btn-lg" id="stop-scanner-btn" onclick="detenerScanner()" style="display: none;">
                                <i class="bi bi-x-circle me-2"></i>Detener Cámara
                            </button>
                        </div>

                        <!-- RFID Container -->
                        <div class="scanner-container" id="rfid-container" style="display: none;">
                            <i class="bi bi-credit-card scanner-icon"></i>
                            <h4>Lector RFID Activo</h4>
                            <p class="text-muted mb-3">Acerca el carnet al lector RFID</p>
                            <div class="alert alert-success mb-0">
                                <i class="bi bi-wifi me-2"></i>
                                <strong>Esperando tarjeta...</strong>
                                <br>
                                <small>El lector está activo y capturando códigos automáticamente</small>
                            </div>
                        </div>

                        <!-- Campo oculto para capturar RFID -->
                        <input 
                            type="text" 
                            id="rfid-input" 
                            autocomplete="off"
                            style="position: absolute; left: -9999px;"
                        >

                        <!-- Botón de Registro Manual (discreto) -->
                        <div class="text-center mt-3">
                            <button class="btn btn-sm btn-outline-secondary" onclick="mostrarRegistroManual()">
                                <i class="bi bi-pencil me-1"></i>Registro Manual
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ÚLTIMOS REGISTROS -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-clock-history me-2"></i>Últimos Registros
                        </h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="cargarUltimosRegistros()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="recent-records" class="p-2">
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-inbox"></i>
                                <p class="mb-0">No hay registros recientes</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA: TIPS Y ESTADÍSTICAS -->
            <div class="col-lg-4">
                <!-- TIPS -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-lightbulb me-2"></i>Consejos
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="mb-0 ps-3">
                            <li class="mb-2">Mantén el código de barras centrado en la cámara</li>
                            <li class="mb-2">Asegúrate de tener buena iluminación</li>
                            <li class="mb-2">El sistema detecta automáticamente entrada/salida</li>
                            <li class="mb-2">Si el carnet no funciona, usa el registro manual</li>
                        </ul>
                    </div>
                </div>

                <!-- ESTADO DEL SISTEMA -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>Estado del Sistema
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Conexión:</span>
                            <span class="badge bg-success" id="connection-status">
                                <i class="bi bi-wifi"></i> Online
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Cámara:</span>
                            <span class="badge bg-secondary" id="camera-status">
                                <i class="bi bi-camera-video-off"></i> Inactiva
                            </span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Fecha:</span>
                            <span class="fw-bold" id="current-date"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE REGISTRO MANUAL -->
    <div class="modal fade" id="manual-registration-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil me-2"></i>Registro Manual
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Tipo de búsqueda -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Buscar por:</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="search-type" id="search-by-document" value="document" checked>
                            <label class="btn btn-outline-primary" for="search-by-document">
                                <i class="bi bi-card-text me-1"></i>Documento
                            </label>
                            
                            <input type="radio" class="btn-check" name="search-type" id="search-by-name" value="name">
                            <label class="btn btn-outline-primary" for="search-by-name">
                                <i class="bi bi-person me-1"></i>Nombre
                            </label>
                        </div>
                    </div>

                    <!-- Campo de búsqueda por documento -->
                    <div class="mb-3" id="search-document-container">
                        <label for="search-document" class="form-label">Número de documento</label>
                        <input type="text" class="form-control" id="search-document" placeholder="Ingrese el documento...">
                    </div>

                    <!-- Campo de búsqueda por nombre -->
                    <div class="mb-3" id="search-name-container" style="display: none;">
                        <label for="search-name" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="search-name" placeholder="Ingrese el nombre...">
                        <small class="text-muted">El sistema buscará en estudiantes y trabajadores</small>
                    </div>

                    <!-- Botón de búsqueda -->
                    <button class="btn btn-primary w-100 mb-3" onclick="buscarPersona()">
                        <i class="bi bi-search me-2"></i>Buscar
                    </button>

                    <!-- Resultados de búsqueda -->
                    <div id="search-results" style="display: none;">
                        <hr>
                        <h6>Resultados:</h6>
                        <div id="search-results-list" class="border rounded" style="max-height: 200px; overflow-y: auto;">
                            <!-- Los resultados se cargarán aquí -->
                        </div>
                    </div>

                    <!-- Persona seleccionada -->
                    <div id="selected-person" style="display: none;">
                        <hr>
                        <div class="alert alert-info">
                            <h6>Persona seleccionada:</h6>
                            <p class="mb-1 fw-bold" id="selected-person-name"></p>
                            <small id="selected-person-details"></small>
                        </div>

                        <!-- Observaciones -->
                        <div class="mb-3">
                            <label for="observations" class="form-label">Observaciones (opcional)</label>
                            <textarea class="form-control" id="observations" rows="3" placeholder="Ej: Olvidó el carnet..."></textarea>
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg" onclick="registrarAsistenciaManual()">
                                <i class="bi bi-check-circle me-2"></i>Registrar Asistencia
                            </button>
                            <button class="btn btn-outline-secondary" onclick="limpiarBusqueda()">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>Nueva Búsqueda
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts - ORDEN CRÍTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <!-- Librería para lectura de códigos de barras -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let html5QrcodeScanner = null;
        let selectedPerson = null;
        let manualRegistrationModal = null;
        let currentMode = 'camera'; // camera o rfid
        let rfidBuffer = ''; // Buffer para capturar código RFID

        // ==========================================
        // OBTENER FECHA Y HORA DE COLOMBIA (UTC-5)
        // ==========================================
        function obtenerFechaHoraColombia() {
            // Crear fecha actual en zona horaria de Colombia (America/Bogota = UTC-5)
            const ahora = new Date();
            const colombiaTime = new Date(ahora.toLocaleString('en-US', { timeZone: 'America/Bogota' }));
            
            // Formatear fecha (YYYY-MM-DD)
            const año = colombiaTime.getFullYear();
            const mes = String(colombiaTime.getMonth() + 1).padStart(2, '0');
            const dia = String(colombiaTime.getDate()).padStart(2, '0');
            const fecha = `${año}-${mes}-${dia}`;
            
            // Formatear hora (HH:MM:SS)
            const horas = String(colombiaTime.getHours()).padStart(2, '0');
            const minutos = String(colombiaTime.getMinutes()).padStart(2, '0');
            const segundos = String(colombiaTime.getSeconds()).padStart(2, '0');
            const hora = `${horas}:${minutos}:${segundos}`;
            
            // Formatear timestamp completo con zona horaria
            const timestamp = `${fecha}T${hora}-05:00`; // UTC-5 para Colombia
            
            return { fecha, hora, timestamp };
        }


        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Validando acceso al módulo de Asistencia...');
            
            try {
                // Validar permisos
                const hasAccess = await validatePageAccess('Registrar asistencia');
                if (!hasAccess) return;

                // Obtener usuario actual
                const session = getStoredSession();
                if (!session || !session.user) {
                    console.log('❌ No hay sesión activa');
                    window.location.href = '../../login.html';
                    return;
                }
                
                currentUser = session.user;
                console.log('✅ Usuario autenticado:', currentUser.user_display_name);

                // Inicializar componentes
                await inicializarPagina();
                
            } catch (error) {
                console.error('❌ Error validando acceso:', error);
                showMessage('Error de autenticación', 'danger');
            }
        });

        // ==========================================
        // INICIALIZACIÓN DE LA PÁGINA
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();

                // Inicializar modal
                manualRegistrationModal = new bootstrap.Modal(document.getElementById('manual-registration-modal'));

                // Configurar eventos
                configurarEventos();

                // Cargar estadísticas del día
                await cargarEstadisticas();

                // Cargar últimos registros
                await cargarUltimosRegistros();

                // Actualizar fecha actual
                actualizarFechaActual();

                ocultarLoading();
                console.log('✅ Página de asistencia inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // CONFIGURAR EVENTOS
        // ==========================================
        function configurarEventos() {
            // Cambio de modo de registro (Cámara / RFID)
            document.querySelectorAll('input[name="registro-mode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    cambiarModoRegistro(this.value);
                });
            });

            // Cambio de tipo de búsqueda
            document.querySelectorAll('input[name="search-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'document') {
                        document.getElementById('search-document-container').style.display = 'block';
                        document.getElementById('search-name-container').style.display = 'none';
                        document.getElementById('search-document').value = '';
                    } else {
                        document.getElementById('search-document-container').style.display = 'none';
                        document.getElementById('search-name-container').style.display = 'block';
                        document.getElementById('search-name').value = '';
                    }
                    limpiarBusqueda();
                });
            });

            // Enter en campos de búsqueda
            document.getElementById('search-document').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarPersona();
                }
            });

            document.getElementById('search-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarPersona();
                }
            });

            // Cerrar feedback al hacer clic
            document.getElementById('feedback-overlay').addEventListener('click', function() {
                ocultarFeedback();
            });

            // Captura de RFID
            document.getElementById('rfid-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const rfidCode = this.value.trim();
                    if (rfidCode) {
                        procesarRFID(rfidCode);
                        this.value = ''; // Limpiar campo
                    }
                }
            });

            // Mantener foco en campo RFID cuando está en modo RFID
            // CORRECCIÓN: No enfocar si el modal está abierto
            document.addEventListener('click', function(e) {
                if (currentMode === 'rfid') {
                    // Verificar si el modal de registro manual está abierto
                    const modalElement = document.getElementById('manual-registration-modal');
                    const isModalOpen = modalElement && modalElement.classList.contains('show');
                    
                    // No reenfocar RFID si el modal está abierto o si se hizo clic dentro del modal
                    if (!isModalOpen && !e.target.closest('.modal')) {
                        setTimeout(() => {
                            document.getElementById('rfid-input').focus();
                        }, 100);
                    }
                }
            });
        }

        // ==========================================
        // ACTUALIZAR FECHA ACTUAL
        // ==========================================
        function actualizarFechaActual() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('es-CO', options);
        }

        // ==========================================
        // CAMBIAR MODO DE REGISTRO
        // ==========================================
        function cambiarModoRegistro(modo) {
            currentMode = modo;
            
            if (modo === 'camera') {
                // Mostrar cámara, ocultar RFID
                document.getElementById('scanner-container').style.display = 'flex';
                document.getElementById('rfid-container').style.display = 'none';
                
                // Detener scanner si está activo
                detenerScanner();
                
            } else if (modo === 'rfid') {
                // Mostrar RFID, ocultar cámara
                document.getElementById('scanner-container').style.display = 'none';
                document.getElementById('rfid-container').style.display = 'flex';
                
                // Detener scanner si está activo
                detenerScanner();
                
                // Enfocar campo RFID
                setTimeout(() => {
                    document.getElementById('rfid-input').focus();
                }, 100);
                
                console.log('✅ Modo RFID activado - Lector listo');
            }
        }

        // ==========================================
        // PROCESAR CÓDIGO RFID
        // ==========================================
        async function procesarRFID(rfidCode) {
            try {
                console.log('🔖 Código RFID recibido:', rfidCode);
                mostrarLoading();

                // Buscar en estudiantes por RFID
                let persona = await supabaseRequest(`/students?select=student_id_document,student_first_name,student_last_name_1,student_last_name_2,student_code,student_rfid_code&student_rfid_code=eq.${rfidCode}`);
                let tipoPersona = 'student';
                
                // Si no es estudiante, buscar en trabajadores
                if (!persona || persona.length === 0) {
                    persona = await supabaseRequest(`/workers?select=worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2,worker_rfid_code&worker_rfid_code=eq.${rfidCode}`);
                    tipoPersona = 'worker';
                }

                if (!persona || persona.length === 0) {
                    ocultarLoading();
                    mostrarFeedback('error', 'Carnet no registrado', `El código RFID ${rfidCode} no está asociado a ninguna persona`);
                    reproducirSonido('error');
                    
                    // Reenfocar campo RFID
                    setTimeout(() => {
                        document.getElementById('rfid-input').focus();
                    }, 2000);
                    return;
                }

                // Construir nombre completo
                const p = persona[0];
                let nombreCompleto = '';
                let documento = '';
                
                if (tipoPersona === 'student') {
                    nombreCompleto = `${p.student_last_name_1} ${p.student_last_name_2 || ''} ${p.student_first_name}`.trim();
                    documento = p.student_id_document;
                } else {
                    nombreCompleto = `${p.worker_last_name_1} ${p.worker_last_name_2 || ''} ${p.worker_first_name}`.trim();
                    documento = p.worker_id_doc;
                }

                // Determinar si es entrada o salida
                const today = new Date().toISOString().split('T')[0];
                const registrosHoy = await supabaseRequest(`/attendance?select=*&person_id_document=eq.${documento}&attendance_date=eq.${today}`);
                const tipoRegistro = registrosHoy.length % 2 === 0 ? 'Entrada' : 'Salida';

                // Insertar registro
                // Obtener fecha y hora de Colombia
                const { fecha, hora, timestamp } = obtenerFechaHoraColombia();
                
                // Insertar registro con fecha/hora de Colombia
                const nuevoRegistro = {
                    person_id_document: documento,
                    person_type: tipoPersona,
                    registration_method: 'carnet',
                    attendance_date: fecha,
                    attendance_time: hora,
                    attendance_timestamp: timestamp
                };

                await supabaseRequest('/attendance', {
                    method: 'POST',
                    body: JSON.stringify(nuevoRegistro)
                });

                ocultarLoading();

                // Mostrar feedback
                mostrarFeedback('success', `${tipoRegistro} registrada`, nombreCompleto);

                // Reproducir sonido
                reproducirSonido('success');

                // Actualizar estadísticas y registros
                await cargarEstadisticas();
                await cargarUltimosRegistros();

                // Reenfocar campo RFID
                setTimeout(() => {
                    document.getElementById('rfid-input').focus();
                }, 2000);

            } catch (error) {
                console.error('❌ Error procesando RFID:', error);
                ocultarLoading();
                mostrarFeedback('error', 'Error', 'No se pudo registrar la asistencia');
                reproducirSonido('error');
                
                // Reenfocar campo RFID
                setTimeout(() => {
                    document.getElementById('rfid-input').focus();
                }, 2000);
            }
        }

        // ==========================================
        // CARGAR ESTADÍSTICAS DEL DÍA
        // ==========================================
        async function cargarEstadisticas() {
            try {
                // Usar fecha de Colombia
                const { fecha: today } = obtenerFechaHoraColombia();
                
                // Obtener todos los registros del día
                const registros = await supabaseRequest(`/attendance?select=*&attendance_date=eq.${today}&order=attendance_time.desc`);
                
                if (!registros) {
                    console.warn('No se pudieron cargar las estadísticas');
                    return;
                }

                // Calcular estadísticas
                const total = registros.length;
                
                // Contar entradas y salidas
                const registrosPorPersona = {};
                registros.forEach(reg => {
                    const key = reg.person_id_document;
                    if (!registrosPorPersona[key]) {
                        registrosPorPersona[key] = [];
                    }
                    registrosPorPersona[key].push(reg);
                });

                let entradas = 0;
                let salidas = 0;
                
                Object.values(registrosPorPersona).forEach(regs => {
                    if (regs.length === 1) {
                        entradas++;
                    } else if (regs.length >= 2) {
                        entradas++;
                        salidas++;
                    }
                });

                // Registros de la última hora
                const unaHoraAtras = new Date();
                unaHoraAtras.setHours(unaHoraAtras.getHours() - 1);
                const ultimaHora = registros.filter(reg => {
                    const regTime = new Date(`${reg.attendance_date}T${reg.attendance_time}`);
                    return regTime >= unaHoraAtras;
                }).length;

                // Actualizar UI
                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-entradas').textContent = entradas;
                document.getElementById('stat-salidas').textContent = salidas;
                document.getElementById('stat-ultima-hora').textContent = ultimaHora;

            } catch (error) {
                console.error('❌ Error cargando estadísticas:', error);
            }
        }

        // ==========================================
        // CARGAR ÚLTIMOS REGISTROS
        // ==========================================
        async function cargarUltimosRegistros() {
            try {
                // Usar fecha de Colombia
                const { fecha: today } = obtenerFechaHoraColombia();
                
                // Obtener últimos 10 registros del día
                const registros = await supabaseRequest(`/attendance?select=*&attendance_date=eq.${today}&order=attendance_time.desc&limit=10`);
                
                const container = document.getElementById('recent-records');
                
                if (!registros || registros.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-inbox"></i>
                            <p class="mb-0">No hay registros recientes</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                for (const reg of registros) {
                    // Obtener nombre de la persona
                    const nombre = await obtenerNombrePersona(reg.person_id_document, reg.person_type);
                    
                    // Determinar si es entrada o salida
                    const tipoRegistro = await determinarTipoRegistro(reg.person_id_document, reg.attendance_time);
                    
                    html += `
                        <div class="recent-record">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="record-name">${nombre}</div>
                                    <div class="record-time">
                                        <i class="bi bi-clock me-1"></i>${reg.attendance_time.substring(0, 5)}
                                        ${reg.registration_method === 'manual' ? '<i class="bi bi-pencil ms-2" title="Registro manual"></i>' : ''}
                                    </div>
                                </div>
                                <span class="record-type ${tipoRegistro}">${tipoRegistro === 'entrada' ? 'Entrada' : 'Salida'}</span>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;

            } catch (error) {
                console.error('❌ Error cargando últimos registros:', error);
            }
        }

        // ==========================================
        // DETERMINAR TIPO DE REGISTRO (ENTRADA/SALIDA)
        // ==========================================
        async function determinarTipoRegistro(documento, horaActual) {
            try {
                // Usar fecha de Colombia
                const { fecha: today } = obtenerFechaHoraColombia();
                
                // Obtener registros previos del día para esta persona
                const registros = await supabaseRequest(`/attendance?select=attendance_time&person_id_document=eq.${documento}&attendance_date=eq.${today}&order=attendance_time.asc`);
                
                if (!registros || registros.length === 0) {
                    return 'entrada';
                }

                // Encontrar la posición del registro actual
                const index = registros.findIndex(r => r.attendance_time === horaActual);
                
                // Si el índice es par (0, 2, 4...) es entrada, si es impar (1, 3, 5...) es salida
                return index % 2 === 0 ? 'entrada' : 'salida';

            } catch (error) {
                console.error('Error determinando tipo de registro:', error);
                return 'entrada';
            }
        }

        // ==========================================
        // OBTENER NOMBRE DE PERSONA
        // ==========================================
        async function obtenerNombrePersona(documento, tipo) {
            try {
                if (tipo === 'student') {
                    const estudiante = await supabaseRequest(`/students?select=student_first_name,student_last_name_1,student_last_name_2&student_id_document=eq.${documento}`);
                    if (estudiante && estudiante.length > 0) {
                        const e = estudiante[0];
                        return `${e.student_last_name_1} ${e.student_last_name_2 || ''} ${e.student_first_name}`.trim();
                    }
                } else if (tipo === 'worker') {
                    const trabajador = await supabaseRequest(`/workers?select=worker_first_name,worker_last_name_1,worker_last_name_2&worker_id_doc=eq.${documento}`);
                    if (trabajador && trabajador.length > 0) {
                        const t = trabajador[0];
                        return `${t.worker_last_name_1} ${t.worker_last_name_2 || ''} ${t.worker_first_name}`.trim();
                    }
                }
                return 'Desconocido';
            } catch (error) {
                console.error('Error obteniendo nombre:', error);
                return 'Error';
            }
        }

        // ==========================================
        // INICIAR SCANNER
        // ==========================================
        async function iniciarScanner() {
            try {
                document.getElementById('start-scanner-btn').style.display = 'none';
                document.getElementById('reader').style.display = 'block';
                document.querySelector('.scanner-icon').style.display = 'none';
                document.querySelector('.scanner-container h4').style.display = 'none';
                document.querySelector('.scanner-container p').style.display = 'none';

                // Configurar scanner
                html5QrcodeScanner = new Html5Qrcode("reader");
                
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                };

                // Iniciar scanner con cámara trasera
                await html5QrcodeScanner.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanError
                );

                document.getElementById('stop-scanner-btn').style.display = 'inline-block';
                document.getElementById('camera-status').innerHTML = '<i class="bi bi-camera-video"></i> Activa';
                document.getElementById('camera-status').className = 'badge bg-success';

                console.log('✅ Scanner iniciado correctamente');

            } catch (error) {
                console.error('❌ Error iniciando scanner:', error);
                showMessage('Error al iniciar la cámara. Verifica los permisos del navegador.', 'danger');
                
                // Restaurar botones
                document.getElementById('start-scanner-btn').style.display = 'inline-block';
                document.getElementById('reader').style.display = 'none';
                document.querySelector('.scanner-icon').style.display = 'block';
                document.querySelector('.scanner-container h4').style.display = 'block';
                document.querySelector('.scanner-container p').style.display = 'block';
            }
        }

        // ==========================================
        // DETENER SCANNER
        // ==========================================
        async function detenerScanner() {
            try {
                if (html5QrcodeScanner) {
                    await html5QrcodeScanner.stop();
                    html5QrcodeScanner = null;
                }

                document.getElementById('reader').style.display = 'none';
                document.getElementById('start-scanner-btn').style.display = 'inline-block';
                document.getElementById('stop-scanner-btn').style.display = 'none';
                document.querySelector('.scanner-icon').style.display = 'block';
                document.querySelector('.scanner-container h4').style.display = 'block';
                document.querySelector('.scanner-container p').style.display = 'block';

                document.getElementById('camera-status').innerHTML = '<i class="bi bi-camera-video-off"></i> Inactiva';
                document.getElementById('camera-status').className = 'badge bg-secondary';

            } catch (error) {
                console.error('Error deteniendo scanner:', error);
            }
        }

        // ==========================================
        // CALLBACK: ESCANEO EXITOSO
        // ==========================================
        async function onScanSuccess(decodedText, decodedResult) {
            console.log('✅ Código escaneado:', decodedText);
            
            // Detener scanner temporalmente
            await detenerScanner();

            // Registrar asistencia automáticamente
            await registrarAsistencia(decodedText, 'carnet');
        }

        // ==========================================
        // CALLBACK: ERROR EN ESCANEO
        // ==========================================
        function onScanError(errorMessage) {
            // Ignorar errores de escaneo (son muy frecuentes mientras busca)
            // console.log('Escaneando...', errorMessage);
        }

        // ==========================================
        // REGISTRAR ASISTENCIA (DESDE CARNET)
        // ==========================================
        async function registrarAsistencia(documento, metodo = 'carnet') {
            try {
                mostrarLoading();

                // Buscar en estudiantes
                let persona = await supabaseRequest(`/students?select=student_id_document,student_first_name,student_last_name_1,student_last_name_2,student_code&student_id_document=eq.${documento}`);
                let tipoPersona = 'student';
                
                // Si no es estudiante, buscar en trabajadores
                if (!persona || persona.length === 0) {
                    persona = await supabaseRequest(`/workers?select=worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2&worker_id_doc=eq.${documento}`);
                    tipoPersona = 'worker';
                }

                if (!persona || persona.length === 0) {
                    ocultarLoading();
                    mostrarFeedback('error', 'Persona no encontrada', `El documento ${documento} no está registrado en el sistema`);
                    setTimeout(() => iniciarScanner(), 2000);
                    return;
                }

                // Construir nombre completo
                const p = persona[0];
                let nombreCompleto = '';
                if (tipoPersona === 'student') {
                    nombreCompleto = `${p.student_last_name_1} ${p.student_last_name_2 || ''} ${p.student_first_name}`.trim();
                } else {
                    nombreCompleto = `${p.worker_last_name_1} ${p.worker_last_name_2 || ''} ${p.worker_first_name}`.trim();
                }

                // Determinar si es entrada o salida
                // Obtener fecha y hora de Colombia
                const { fecha: today, hora, timestamp } = obtenerFechaHoraColombia();
                
                // Determinar si es entrada o salida
                const registrosHoy = await supabaseRequest(`/attendance?select=*&person_id_document=eq.${documento}&attendance_date=eq.${today}`);
                const tipoRegistro = registrosHoy.length % 2 === 0 ? 'Entrada' : 'Salida';

                // CORRECCIÓN: Buscar worker_id si es registro manual usando EMAIL
                let registeredByWorkerId = null;
                if (metodo === 'manual' && currentUser.user_email) {
                    try {
                        const workerData = await supabaseRequest(`/workers?select=worker_id&email=eq.${currentUser.user_email}&limit=1`);
                        if (workerData && workerData.length > 0) {
                            registeredByWorkerId = workerData[0].worker_id;
                            console.log('✅ Worker encontrado:', registeredByWorkerId);
                        }
                    } catch (error) {
                        console.warn('⚠️ Error buscando trabajador:', error.message);
                    }
                }

                // Insertar registro con fecha/hora de Colombia
                const nuevoRegistro = {
                    person_id_document: documento,
                    person_type: tipoPersona,
                    registration_method: metodo,
                    registered_by_worker_id: registeredByWorkerId,
                    attendance_date: today,
                    attendance_time: hora,
                    attendance_timestamp: timestamp
                };
                await supabaseRequest('/attendance', {
                    method: 'POST',
                    body: JSON.stringify(nuevoRegistro)
                });

                ocultarLoading();

                // Mostrar feedback
                mostrarFeedback('success', `${tipoRegistro} registrada`, nombreCompleto);

                // Reproducir sonido
                reproducirSonido('success');

                // Actualizar estadísticas y registros
                await cargarEstadisticas();
                await cargarUltimosRegistros();

                // Reiniciar scanner después de 2 segundos
                setTimeout(() => iniciarScanner(), 2000);

            } catch (error) {
                console.error('❌ Error registrando asistencia:', error);
                ocultarLoading();
                mostrarFeedback('error', 'Error', 'No se pudo registrar la asistencia');
                setTimeout(() => iniciarScanner(), 2000);
            }
        }

        // ==========================================
        // MOSTRAR MODAL DE REGISTRO MANUAL
        // ==========================================
        function mostrarRegistroManual() {
            // Detener scanner si está activo
            detenerScanner();
            
            // CORRECCIÓN: Pausar temporalmente el modo RFID
            const previousMode = currentMode;
            if (currentMode === 'rfid') {
                console.log('⏸️ Pausando modo RFID temporalmente para registro manual');
            }
            
            // Limpiar formulario
            limpiarBusqueda();
            
            // Mostrar modal
            manualRegistrationModal.show();
            
            // CORRECCIÓN: Restaurar foco en campos del modal
            setTimeout(() => {
                const searchDocField = document.getElementById('search-document');
                if (searchDocField && searchDocField.offsetParent !== null) {
                    searchDocField.focus();
                }
            }, 300);
        }
        
        // ==========================================
        // BUSCAR PERSONA
        // ==========================================
        async function buscarPersona() {
            try {
                mostrarLoading();

                const tipoBusqueda = document.querySelector('input[name="search-type"]:checked').value;
                let resultados = [];

                if (tipoBusqueda === 'document') {
                    const documento = document.getElementById('search-document').value.trim();
                    
                    if (!documento) {
                        showMessage('Por favor ingrese un documento', 'warning');
                        ocultarLoading();
                        return;
                    }

                    // Buscar en estudiantes
                    const estudiantes = await supabaseRequest(`/students?select=student_id_document,student_code,student_first_name,student_last_name_1,student_last_name_2&student_id_document=eq.${documento}`);
                    if (estudiantes && estudiantes.length > 0) {
                        estudiantes.forEach(e => {
                            resultados.push({
                                tipo: 'student',
                                documento: e.student_id_document,
                                codigo: e.student_code,
                                nombre: `${e.student_last_name_1} ${e.student_last_name_2 || ''} ${e.student_first_name}`.trim()
                            });
                        });
                    }

                    // Buscar en trabajadores
                    const trabajadores = await supabaseRequest(`/workers?select=worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2&worker_id_doc=eq.${documento}`);
                    if (trabajadores && trabajadores.length > 0) {
                        trabajadores.forEach(t => {
                            resultados.push({
                                tipo: 'worker',
                                documento: t.worker_id_doc,
                                codigo: null,
                                nombre: `${t.worker_last_name_1} ${t.worker_last_name_2 || ''} ${t.worker_first_name}`.trim()
                            });
                        });
                    }

                } else {
                    // Búsqueda por nombre
                    const nombre = document.getElementById('search-name').value.trim().toLowerCase();
                    
                    if (!nombre || nombre.length < 3) {
                        showMessage('Por favor ingrese al menos 3 caracteres', 'warning');
                        ocultarLoading();
                        return;
                    }

                    // Buscar en estudiantes
                    const estudiantes = await supabaseRequest(`/students?select=student_id_document,student_code,student_first_name,student_last_name_1,student_last_name_2`);
                    if (estudiantes) {
                        estudiantes.forEach(e => {
                            const nombreCompleto = `${e.student_last_name_1} ${e.student_last_name_2 || ''} ${e.student_first_name}`.toLowerCase();
                            if (nombreCompleto.includes(nombre)) {
                                resultados.push({
                                    tipo: 'student',
                                    documento: e.student_id_document,
                                    codigo: e.student_code,
                                    nombre: `${e.student_last_name_1} ${e.student_last_name_2 || ''} ${e.student_first_name}`.trim()
                                });
                            }
                        });
                    }

                    // Buscar en trabajadores
                    const trabajadores = await supabaseRequest(`/workers?select=worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2`);
                    if (trabajadores) {
                        trabajadores.forEach(t => {
                            const nombreCompleto = `${t.worker_last_name_1} ${t.worker_last_name_2 || ''} ${t.worker_first_name}`.toLowerCase();
                            if (nombreCompleto.includes(nombre)) {
                                resultados.push({
                                    tipo: 'worker',
                                    documento: t.worker_id_doc,
                                    codigo: null,
                                    nombre: `${t.worker_last_name_1} ${t.worker_last_name_2 || ''} ${t.worker_first_name}`.trim()
                                });
                            }
                        });
                    }
                }

                ocultarLoading();

                // Mostrar resultados
                mostrarResultadosBusqueda(resultados);

            } catch (error) {
                console.error('❌ Error buscando persona:', error);
                ocultarLoading();
                showMessage('Error en la búsqueda', 'danger');
            }
        }

        // ==========================================
        // MOSTRAR RESULTADOS DE BÚSQUEDA
        // ==========================================
        function mostrarResultadosBusqueda(resultados) {
            const container = document.getElementById('search-results-list');
            
            if (resultados.length === 0) {
                document.getElementById('search-results').style.display = 'block';
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-search"></i>
                        <p class="mb-0">No se encontraron resultados</p>
                    </div>
                `;
                return;
            }

            let html = '';
            resultados.forEach(persona => {
                const badgeClass = persona.tipo === 'student' ? 'student' : 'worker';
                const badgeText = persona.tipo === 'student' ? '📚 Estudiante' : '👔 Trabajador';
                const codigoText = persona.codigo ? ` - Código: ${persona.codigo}` : '';
                
                html += `
                    <div class="search-result-item" onclick='seleccionarPersona(${JSON.stringify(persona)})'>
                        <span class="person-badge ${badgeClass}">${badgeText}</span>
                        <div class="fw-bold">${persona.nombre}</div>
                        <small class="text-muted">Doc: ${persona.documento}${codigoText}</small>
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('search-results').style.display = 'block';
        }

        // ==========================================
        // SELECCIONAR PERSONA
        // ==========================================
        function seleccionarPersona(persona) {
            selectedPerson = persona;

            // Ocultar resultados
            document.getElementById('search-results').style.display = 'none';

            // Mostrar persona seleccionada
            document.getElementById('selected-person-name').textContent = persona.nombre;
            const tipoTexto = persona.tipo === 'student' ? 'Estudiante' : 'Trabajador';
            const codigoTexto = persona.codigo ? ` - Código: ${persona.codigo}` : '';
            document.getElementById('selected-person-details').textContent = `${tipoTexto} - Doc: ${persona.documento}${codigoTexto}`;
            
            document.getElementById('selected-person').style.display = 'block';
        }

        // ==========================================
        // REGISTRAR ASISTENCIA MANUAL
        // ==========================================
        async function registrarAsistenciaManual() {
            if (!selectedPerson) {
                showMessage('No hay una persona seleccionada', 'warning');
                return;
            }

            try {
                mostrarLoading();

                const observaciones = document.getElementById('observations').value.trim();

                // Obtener fecha y hora de Colombia
                const { fecha: today, hora, timestamp } = obtenerFechaHoraColombia();
                
                // Determinar si es entrada o salida
                const registrosHoy = await supabaseRequest(`/attendance?select=*&person_id_document=eq.${selectedPerson.documento}&attendance_date=eq.${today}`);
                const tipoRegistro = registrosHoy.length % 2 === 0 ? 'Entrada' : 'Salida';

                // CORRECCIÓN: Buscar worker_id del usuario actual usando EMAIL
                let registeredByWorkerId = null;
                if (currentUser.user_email) {
                    try {
                        const workerData = await supabaseRequest(`/workers?select=worker_id&email=eq.${currentUser.user_email}&limit=1`);
                        if (workerData && workerData.length > 0) {
                            registeredByWorkerId = workerData[0].worker_id;
                            console.log('✅ Worker encontrado:', registeredByWorkerId);
                        } else {
                            console.log('⚠️ Usuario no existe como trabajador, se guardará sin registered_by');
                        }
                    } catch (error) {
                        console.warn('⚠️ Error buscando trabajador:', error.message);
                    }
                } else {
                    console.warn('⚠️ Usuario no tiene email, se guardará sin registered_by');
                }

                // Insertar registro con fecha/hora de Colombia
                const nuevoRegistro = {
                    person_id_document: selectedPerson.documento,
                    person_type: selectedPerson.tipo,
                    registration_method: 'manual',
                    observations: observaciones || null,
                    registered_by_worker_id: registeredByWorkerId, // Ahora puede ser null si el usuario no es trabajador
                    attendance_date: today,
                    attendance_time: hora,
                    attendance_timestamp: timestamp
                };
        
                await supabaseRequest('/attendance', {
                    method: 'POST',
                    body: JSON.stringify(nuevoRegistro)
                });

                ocultarLoading();

                // Cerrar modal
                manualRegistrationModal.hide();

                // Mostrar feedback
                mostrarFeedback('success', `${tipoRegistro} registrada`, selectedPerson.nombre);

                // Reproducir sonido
                reproducirSonido('success');

                // Actualizar estadísticas y registros
                await cargarEstadisticas();
                await cargarUltimosRegistros();

            } catch (error) {
                console.error('❌ Error registrando asistencia manual:', error);
                ocultarLoading();
                showMessage('Error al registrar la asistencia', 'danger');
            }
        }

        // ==========================================
        // LIMPIAR BÚSQUEDA
        // ==========================================
        function limpiarBusqueda() {
            document.getElementById('search-document').value = '';
            document.getElementById('search-name').value = '';
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('selected-person').style.display = 'none';
            document.getElementById('observations').value = '';
            selectedPerson = null;
        }

        // ==========================================
        // EVENTO: Al cerrar el modal, restaurar modo RFID si corresponde
        // ==========================================
        document.getElementById('manual-registration-modal').addEventListener('hidden.bs.modal', function() {
            // Restaurar foco en RFID si estaba en ese modo
            if (currentMode === 'rfid') {
                setTimeout(() => {
                    document.getElementById('rfid-input').focus();
                    console.log('✅ Modo RFID reactivado');
                }, 100);
            }
        });

        // ==========================================
        // MOSTRAR/OCULTAR FEEDBACK
        // ==========================================
        function mostrarFeedback(tipo, titulo, mensaje) {
            const overlay = document.getElementById('feedback-overlay');
            const icon = document.getElementById('feedback-icon');
            const titleEl = document.getElementById('feedback-title');
            const messageEl = document.getElementById('feedback-message');

            // Configurar icono según tipo
            if (tipo === 'success') {
                icon.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
                icon.className = 'feedback-icon success';
            } else if (tipo === 'error') {
                icon.innerHTML = '<i class="bi bi-x-circle-fill"></i>';
                icon.className = 'feedback-icon error';
            } else if (tipo === 'warning') {
                icon.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i>';
                icon.className = 'feedback-icon warning';
            }

            titleEl.textContent = titulo;
            messageEl.textContent = mensaje;

            overlay.classList.add('show');

            // Auto-ocultar después de 2 segundos
            setTimeout(() => ocultarFeedback(), 2000);
        }

        function ocultarFeedback() {
            document.getElementById('feedback-overlay').classList.remove('show');
        }

        // ==========================================
        // REPRODUCIR SONIDO
        // ==========================================
        function reproducirSonido(tipo) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                if (tipo === 'success') {
                    oscillator.frequency.value = 800;
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                } else if (tipo === 'error') {
                    oscillator.frequency.value = 400;
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                }
            } catch (error) {
                // Sonido no disponible
                console.log('Audio no disponible');
            }
        }

        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        console.log('✅ Sistema de asistencia cargado correctamente');
    </script>
</body>
</html>
