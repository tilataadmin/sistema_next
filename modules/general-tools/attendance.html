<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA -->
    <meta name="page-version" content="25.11.13.07.42">
    
    <title>Registro de Asistencia - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Scanner Container */
        .scanner-container {
            border: 3px dashed #007bff;
            border-radius: 12px;
            padding: 2rem;
            background: #f8f9fa;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #reader {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #facial-video-container {
            position: relative;
            max-width: 640px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
        }

        #facial-video {
            width: 100%;
            display: block;
        }

        #facial-canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .detection-status {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            display: none;
        }

        .detection-status.show {
            display: block;
        }

        .detection-status.success {
            background: rgba(40, 167, 69, 0.9);
        }

        .detection-status.error {
            background: rgba(220, 53, 69, 0.9);
        }
        
        .scanner-icon {
            font-size: 4rem;
            color: #007bff;
            margin-bottom: 1rem;
        }
        
        /* Success/Error Feedback */
        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .feedback-overlay.show {
            display: flex;
        }
        
        .feedback-content {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
            animation: feedbackPop 0.3s ease;
        }
        
        @keyframes feedbackPop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .feedback-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
        }
        
        .feedback-icon.success {
            color: #28a745;
        }
        
        .feedback-icon.error {
            color: #dc3545;
        }
        
        .feedback-icon.warning {
            color: #ffc107;
        }
        
        /* Recent Records */
        .recent-record {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s;
        }
        
        .recent-record:hover {
            background: #f8f9fa;
        }
        
        .recent-record:last-child {
            border-bottom: none;
        }
        
        .record-time {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .record-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .record-type {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        
        .record-type.entrada {
            background: #d4edda;
            color: #155724;
        }
        
        .record-type.salida {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Search Results */
        .search-result-item {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .search-result-item:hover {
            background: #e7f3ff;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .person-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
        
        .person-badge.student {
            background: #cfe2ff;
            color: #084298;
        }
        
        .person-badge.worker {
            background: #d1e7dd;
            color: #0f5132;
        }
        
        /* Stats Bar */
        .stats-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .scanner-container {
                padding: 1rem;
                min-height: 250px;
            }
            
            .scanner-icon {
                font-size: 3rem;
            }
            
            .feedback-content {
                padding: 2rem;
            }
            
            .feedback-icon {
                font-size: 4rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0" id="loading-message">Cargando...</p>
        </div>
    </div>

    <!-- Feedback Overlay -->
    <div id="feedback-overlay" class="feedback-overlay">
        <div class="feedback-content">
            <div id="feedback-icon" class="feedback-icon"></div>
            <h4 id="feedback-title"></h4>
            <p id="feedback-message" class="mb-0"></p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Registro de Asistencia
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Registro de Asistencia
                </h1>
                <p class="text-muted">
                    Registro de asistencia mediante lectura de carnets, reconocimiento facial o b√∫squeda manual
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- ESTAD√çSTICAS DEL D√çA -->
        <div class="stats-bar">
            <div class="row">
                <div class="col-6 col-md-3 stat-item">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">Total Registros</div>
                </div>
                <div class="col-6 col-md-3 stat-item">
                    <div class="stat-value" id="stat-entradas">0</div>
                    <div class="stat-label">Entradas</div>
                </div>
                <div class="col-6 col-md-3 stat-item">
                    <div class="stat-value" id="stat-salidas">0</div>
                    <div class="stat-label">Salidas</div>
                </div>
                <div class="col-6 col-md-3 stat-item">
                    <div class="stat-value" id="stat-ultima-hora">0</div>
                    <div class="stat-label">√öltima Hora</div>
                </div>
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div class="row">
            <!-- COLUMNA IZQUIERDA: SCANNER -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-camera me-2"></i>Registro de Asistencia
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Selector de modo -->
                        <div class="mb-3 text-center">
                            <label class="form-label fw-bold">Modo de registro:</label>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="registro-mode" id="mode-camera" value="camera" checked>
                                <label class="btn btn-outline-primary" for="mode-camera">
                                    <i class="bi bi-camera me-1"></i>C√°mara
                                </label>
                                
                                <input type="radio" class="btn-check" name="registro-mode" id="mode-rfid" value="rfid">
                                <label class="btn btn-outline-primary" for="mode-rfid">
                                    <i class="bi bi-credit-card me-1"></i>RFID
                                </label>

                                <input type="radio" class="btn-check" name="registro-mode" id="mode-facial" value="facial">
                                <label class="btn btn-outline-primary" for="mode-facial">
                                    <i class="bi bi-person-bounding-box me-1"></i>Facial
                                </label>
                            </div>
                        </div>

                        <!-- Scanner Container (C√°mara - C√≥digo de barras) -->
                        <div class="scanner-container" id="scanner-container">
                            <i class="bi bi-upc-scan scanner-icon"></i>
                            <h4>Listo para escanear</h4>
                            <p class="text-muted mb-3">Acerca el c√≥digo de barras del carnet a la c√°mara</p>
                            <div id="reader" style="display: none;"></div>
                            <button class="btn btn-primary btn-lg" id="start-scanner-btn" onclick="iniciarScanner()">
                                <i class="bi bi-camera me-2"></i>Activar C√°mara
                            </button>
                            <button class="btn btn-danger btn-lg" id="stop-scanner-btn" onclick="detenerScanner()" style="display: none;">
                                <i class="bi bi-x-circle me-2"></i>Detener C√°mara
                            </button>
                        </div>

                        <!-- RFID Container -->
                        <div class="scanner-container" id="rfid-container" style="display: none;">
                            <i class="bi bi-credit-card scanner-icon"></i>
                            <h4>Lector RFID Activo</h4>
                            <p class="text-muted mb-3">Acerca el carnet al lector RFID</p>
                            <div class="alert alert-success mb-0">
                                <i class="bi bi-wifi me-2"></i>
                                <strong>Esperando tarjeta...</strong>
                                <br>
                                <small>El lector est√° activo y capturando c√≥digos autom√°ticamente</small>
                            </div>
                        </div>

                        <!-- Facial Recognition Container -->
                        <div class="scanner-container" id="facial-container" style="display: none;">
                            <div id="facial-video-container" style="display: none;">
                                <video id="facial-video" autoplay muted playsinline></video>
                                <canvas id="facial-canvas"></canvas>
                                <div id="facial-detection-status" class="detection-status"></div>
                            </div>
                            
                            <div id="facial-init">
                                <i class="bi bi-person-bounding-box scanner-icon"></i>
                                <h4>Reconocimiento Facial</h4>
                                <p class="text-muted mb-3">El sistema reconocer√° tu rostro autom√°ticamente</p>
                                <button class="btn btn-success btn-lg" id="start-facial-btn" onclick="iniciarReconocimientoFacial()">
                                    <i class="bi bi-camera me-2"></i>Activar Reconocimiento
                                </button>
                            </div>
                        </div>

                        <!-- Campo oculto para capturar RFID -->
                        <input 
                            type="text" 
                            id="rfid-input" 
                            autocomplete="off"
                            style="position: absolute; left: -9999px;"
                        >

                        <!-- Bot√≥n de Registro Manual (discreto) -->
                        <div class="text-center mt-3">
                            <button class="btn btn-sm btn-outline-secondary" onclick="mostrarRegistroManual()">
                                <i class="bi bi-pencil me-1"></i>Registro Manual
                            </button>
                        </div>
                    </div>
                </div>

                <!-- √öLTIMOS REGISTROS -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-clock-history me-2"></i>√öltimos Registros
                        </h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="cargarUltimosRegistros()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="recent-records" class="p-2">
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-inbox"></i>
                                <p class="mb-0">No hay registros recientes</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA: TIPS Y ESTAD√çSTICAS -->
            <div class="col-lg-4">
                <!-- TIPS -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-lightbulb me-2"></i>Consejos
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="mb-0 ps-3" id="tips-list">
                            <li class="mb-2">Mant√©n el c√≥digo de barras centrado en la c√°mara</li>
                            <li class="mb-2">Aseg√∫rate de tener buena iluminaci√≥n</li>
                            <li class="mb-2">El sistema detecta autom√°ticamente entrada/salida</li>
                            <li class="mb-2">Si el carnet no funciona, usa el registro manual</li>
                        </ul>
                    </div>
                </div>

                <!-- ESTADO DEL SISTEMA -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>Estado del Sistema
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Conexi√≥n:</span>
                            <span class="badge bg-success" id="connection-status">
                                <i class="bi bi-wifi"></i> Online
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mb-2" id="models-status-container" style="display: none;">
                            <span>Modelos ML:</span>
                            <span class="badge bg-secondary" id="models-status">
                                <i class="bi bi-hourglass-split"></i> Cargando...
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>C√°mara:</span>
                            <span class="badge bg-secondary" id="camera-status">
                                <i class="bi bi-camera-video-off"></i> Inactiva
                            </span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Fecha:</span>
                            <span class="fw-bold" id="current-date"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE REGISTRO MANUAL -->
    <div class="modal fade" id="manual-registration-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil me-2"></i>Registro Manual
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Tipo de b√∫squeda -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Buscar por:</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="search-type" id="search-by-document" value="document" checked>
                            <label class="btn btn-outline-primary" for="search-by-document">
                                <i class="bi bi-card-text me-1"></i>Documento
                            </label>
                            
                            <input type="radio" class="btn-check" name="search-type" id="search-by-name" value="name">
                            <label class="btn btn-outline-primary" for="search-by-name">
                                <i class="bi bi-person me-1"></i>Nombre
                            </label>
                        </div>
                    </div>

                    <!-- Campo de b√∫squeda por documento -->
                    <div class="mb-3" id="search-document-container">
                        <label for="search-document" class="form-label">N√∫mero de documento</label>
                        <input type="text" class="form-control" id="search-document" placeholder="Ingrese el documento...">
                    </div>

                    <!-- Campo de b√∫squeda por nombre -->
                    <div class="mb-3" id="search-name-container" style="display: none;">
                        <label for="search-name" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="search-name" placeholder="Ingrese el nombre...">
                        <small class="text-muted">El sistema buscar√° en estudiantes y trabajadores</small>
                    </div>

                    <!-- Bot√≥n de b√∫squeda -->
                    <button class="btn btn-primary w-100 mb-3" onclick="buscarPersona()">
                        <i class="bi bi-search me-2"></i>Buscar
                    </button>

                    <!-- Resultados de b√∫squeda -->
                    <div id="search-results" style="display: none;">
                        <hr>
                        <h6>Resultados:</h6>
                        <div id="search-results-list" class="border rounded" style="max-height: 200px; overflow-y: auto;">
                            <!-- Los resultados se cargar√°n aqu√≠ -->
                        </div>
                    </div>

                    <!-- Persona seleccionada -->
                    <div id="selected-person" style="display: none;">
                        <hr>
                        <div class="alert alert-info">
                            <h6>Persona seleccionada:</h6>
                            <p class="mb-1 fw-bold" id="selected-person-name"></p>
                            <small id="selected-person-details"></small>
                        </div>

                        <!-- Observaciones -->
                        <div class="mb-3">
                            <label for="observations" class="form-label">Observaciones (opcional)</label>
                            <textarea class="form-control" id="observations" rows="3" placeholder="Ej: Olvid√≥ el carnet..."></textarea>
                        </div>

                        <!-- Botones de acci√≥n -->
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg" onclick="registrarAsistenciaManual()">
                                <i class="bi bi-check-circle me-2"></i>Registrar Asistencia
                            </button>
                            <button class="btn btn-outline-secondary" onclick="limpiarBusqueda()">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>Nueva B√∫squeda
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts - ORDEN CR√çTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <!-- Librer√≠a para lectura de c√≥digos de barras -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <!-- Face-api.js - SOLO SE CARGA SI SE USA MODO FACIAL -->
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let html5QrcodeScanner = null;
        let selectedPerson = null;
        let manualRegistrationModal = null;
        let currentMode = 'camera'; // camera, rfid, facial
        let rfidBuffer = '';
        
        // Variables para reconocimiento facial
        let facialVideoStream = null;
        let facialDetectionInterval = null;
        let facialModelsLoaded = false;
        let allFaceDescriptors = []; // Cache de descriptores

        // ==========================================
        // OBTENER FECHA Y HORA DE COLOMBIA (UTC-5)
        // ==========================================
        function obtenerFechaHoraColombia() {
            const ahora = new Date();
            const colombiaTime = new Date(ahora.toLocaleString('en-US', { timeZone: 'America/Bogota' }));
            
            const a√±o = colombiaTime.getFullYear();
            const mes = String(colombiaTime.getMonth() + 1).padStart(2, '0');
            const dia = String(colombiaTime.getDate()).padStart(2, '0');
            const fecha = `${a√±o}-${mes}-${dia}`;
            
            const horas = String(colombiaTime.getHours()).padStart(2, '0');
            const minutos = String(colombiaTime.getMinutes()).padStart(2, '0');
            const segundos = String(colombiaTime.getSeconds()).padStart(2, '0');
            const hora = `${horas}:${minutos}:${segundos}`;
            
            const timestamp = `${fecha}T${hora}-05:00`;
            
            return { fecha, hora, timestamp };
        }

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Validando acceso al m√≥dulo de Asistencia...');
            
            try {
                const hasAccess = await validatePageAccess('Registrar asistencia');
                if (!hasAccess) return;

                const session = getStoredSession();
                if (!session || !session.user) {
                    console.log('‚ùå No hay sesi√≥n activa');
                    window.location.href = '../../login.html';
                    return;
                }
                
                currentUser = session.user;
                console.log('‚úÖ Usuario autenticado:', currentUser.user_display_name);
                
                if (!currentUser.user_mail) {
                    console.warn('‚ö†Ô∏è Email no disponible en sesi√≥n, obteniendo de BD...');
                    try {
                        const userData = await supabaseRequest(`/users?select=user_mail&user_id=eq.${currentUser.user_id}&limit=1`);
                        if (userData && userData.length > 0 && userData[0].user_mail) {
                            currentUser.user_mail = userData[0].user_mail;
                            console.log('‚úÖ Email obtenido de BD:', currentUser.user_mail);
                        }
                    } catch (error) {
                        console.error('‚ùå Error obteniendo email:', error);
                    }
                }
                
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error validando acceso:', error);
                showMessage('Error de autenticaci√≥n', 'danger');
            }
        });

        // ==========================================
        // INICIALIZACI√ìN DE LA P√ÅGINA
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();

                manualRegistrationModal = new bootstrap.Modal(document.getElementById('manual-registration-modal'));
                configurarEventos();
                await cargarEstadisticas();
                await cargarUltimosRegistros();
                actualizarFechaActual();

                ocultarLoading();
                console.log('‚úÖ P√°gina de asistencia inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // CONFIGURAR EVENTOS
        // ==========================================
        function configurarEventos() {
            document.querySelectorAll('input[name="registro-mode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    cambiarModoRegistro(this.value);
                });
            });

            document.querySelectorAll('input[name="search-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'document') {
                        document.getElementById('search-document-container').style.display = 'block';
                        document.getElementById('search-name-container').style.display = 'none';
                        document.getElementById('search-document').value = '';
                    } else {
                        document.getElementById('search-document-container').style.display = 'none';
                        document.getElementById('search-name-container').style.display = 'block';
                        document.getElementById('search-name').value = '';
                    }
                    limpiarBusqueda();
                });
            });

            document.getElementById('search-document').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarPersona();
                }
            });

            document.getElementById('search-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarPersona();
                }
            });

            document.getElementById('feedback-overlay').addEventListener('click', function() {
                ocultarFeedback();
            });

            document.getElementById('rfid-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const rfidCode = this.value.trim();
                    if (rfidCode) {
                        procesarRFID(rfidCode);
                        this.value = '';
                    }
                }
            });

            document.addEventListener('click', function(e) {
                if (currentMode === 'rfid') {
                    const modalElement = document.getElementById('manual-registration-modal');
                    const isModalOpen = modalElement && modalElement.classList.contains('show');
                    
                    if (!isModalOpen && !e.target.closest('.modal')) {
                        setTimeout(() => {
                            document.getElementById('rfid-input').focus();
                        }, 100);
                    }
                }
            });
        }

        // ==========================================
        // ACTUALIZAR FECHA ACTUAL
        // ==========================================
        function actualizarFechaActual() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('es-CO', options);
        }

        // ==========================================
        // CAMBIAR MODO DE REGISTRO
        // ==========================================
        function cambiarModoRegistro(modo) {
            currentMode = modo;
            
            // Ocultar todos los contenedores
            document.getElementById('scanner-container').style.display = 'none';
            document.getElementById('rfid-container').style.display = 'none';
            document.getElementById('facial-container').style.display = 'none';
            
            // Detener lo que est√© activo
            detenerScanner();
            detenerReconocimientoFacial();
            
            // Actualizar tips seg√∫n el modo
            actualizarTips(modo);
            
            if (modo === 'camera') {
                document.getElementById('scanner-container').style.display = 'flex';
            } else if (modo === 'rfid') {
                document.getElementById('rfid-container').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('rfid-input').focus();
                }, 100);
                console.log('‚úÖ Modo RFID activado');
            } else if (modo === 'facial') {
                document.getElementById('facial-container').style.display = 'flex';
                document.getElementById('models-status-container').style.display = 'flex';
                console.log('‚úÖ Modo Facial activado');
            }
        }

        // ==========================================
        // ACTUALIZAR TIPS SEG√öN MODO
        // ==========================================
        function actualizarTips(modo) {
            const tipsList = document.getElementById('tips-list');
            
            if (modo === 'camera') {
                tipsList.innerHTML = `
                    <li class="mb-2">Mant√©n el c√≥digo de barras centrado en la c√°mara</li>
                    <li class="mb-2">Aseg√∫rate de tener buena iluminaci√≥n</li>
                    <li class="mb-2">El sistema detecta autom√°ticamente entrada/salida</li>
                    <li class="mb-2">Si el carnet no funciona, usa el registro manual</li>
                `;
            } else if (modo === 'rfid') {
                tipsList.innerHTML = `
                    <li class="mb-2">Acerca el carnet al lector RFID</li>
                    <li class="mb-2">Espera el sonido de confirmaci√≥n</li>
                    <li class="mb-2">El registro es autom√°tico e inmediato</li>
                    <li class="mb-2">No es necesario presionar ning√∫n bot√≥n</li>
                `;
            } else if (modo === 'facial') {
                tipsList.innerHTML = `
                    <li class="mb-2">Mant√©n tu rostro centrado en la c√°mara</li>
                    <li class="mb-2">Aseg√∫rate de tener buena iluminaci√≥n</li>
                    <li class="mb-2">El rostro debe estar de frente</li>
                    <li class="mb-2">El reconocimiento es autom√°tico en 1-2 segundos</li>
                    <li class="mb-2">Si usas gafas, aseg√∫rate de tenerlas puestas (si las usaste en el entrenamiento)</li>
                `;
            }
        }

        // ==========================================
        // CARGAR MODELOS DE FACE-API.JS
        // ==========================================
        async function cargarModelosFaciales() {
            if (facialModelsLoaded) {
                console.log('‚úÖ Modelos ya cargados');
                return true;
            }

            try {
                mostrarLoading('Cargando modelos de reconocimiento facial...');
                document.getElementById('models-status').innerHTML = '<i class="bi bi-hourglass-split"></i> Cargando...';
                
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
                
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                
                facialModelsLoaded = true;
                document.getElementById('models-status').innerHTML = '<i class="bi bi-check-circle"></i> Listos';
                document.getElementById('models-status').className = 'badge bg-success';
                
                ocultarLoading();
                console.log('‚úÖ Modelos cargados correctamente');
                return true;
                
            } catch (error) {
                console.error('‚ùå Error cargando modelos:', error);
                document.getElementById('models-status').innerHTML = '<i class="bi bi-x-circle"></i> Error';
                document.getElementById('models-status').className = 'badge bg-danger';
                ocultarLoading();
                showMessage('Error cargando modelos de reconocimiento. Verifica tu conexi√≥n.', 'danger');
                return false;
            }
        }

        // ==========================================
        // CARGAR DESCRIPTORES FACIALES DE LA BD
        // ==========================================
        async function cargarDescriptoresFaciales() {
            try {
                console.log('üì• Cargando descriptores faciales de la base de datos...');
                
                // Cargar estudiantes con registro facial activo
                const estudiantes = await supabaseRequest(`/students?select=student_id_document,student_first_name,student_last_name_1,student_last_name_2,student_face_descriptor&student_face_status=eq.active`);
                
                // Cargar trabajadores con registro facial activo
                const trabajadores = await supabaseRequest(`/workers?select=worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2,worker_face_descriptor&worker_face_status=eq.active`);
                
                allFaceDescriptors = [];
                
                if (estudiantes) {
                    estudiantes.forEach(e => {
                        if (e.student_face_descriptor) {
                            try {
                                const descriptor = JSON.parse(e.student_face_descriptor);
                                allFaceDescriptors.push({
                                    documento: e.student_id_document,
                                    tipo: 'student',
                                    nombre: `${e.student_last_name_1} ${e.student_last_name_2 || ''} ${e.student_first_name}`.trim(),
                                    descriptor: new Float32Array(descriptor)
                                });
                            } catch (err) {
                                console.warn('Error parseando descriptor de estudiante:', e.student_id_document);
                            }
                        }
                    });
                }
                
                if (trabajadores) {
                    trabajadores.forEach(t => {
                        if (t.worker_face_descriptor) {
                            try {
                                const descriptor = JSON.parse(t.worker_face_descriptor);
                                allFaceDescriptors.push({
                                    documento: t.worker_id_doc,
                                    tipo: 'worker',
                                    nombre: `${t.worker_last_name_1} ${t.worker_last_name_2 || ''} ${t.worker_first_name}`.trim(),
                                    descriptor: new Float32Array(descriptor)
                                });
                            } catch (err) {
                                console.warn('Error parseando descriptor de trabajador:', t.worker_id_doc);
                            }
                        }
                    });
                }
                
                console.log(`‚úÖ ${allFaceDescriptors.length} descriptores faciales cargados`);
                return allFaceDescriptors.length > 0;
                
            } catch (error) {
                console.error('‚ùå Error cargando descriptores:', error);
                return false;
            }
        }

        // ==========================================
        // INICIAR RECONOCIMIENTO FACIAL
        // ==========================================
        async function iniciarReconocimientoFacial() {
            try {
                // Cargar modelos si no est√°n cargados
                const modelosOK = await cargarModelosFaciales();
                if (!modelosOK) return;
                
                // Cargar descriptores de la BD
                const descriptoresOK = await cargarDescriptoresFaciales();
                if (!descriptoresOK) {
                    showMessage('No hay personas con registro facial activo. Por favor, registra rostros primero.', 'warning');
                    return;
                }
                
                // Ocultar bot√≥n de inicio y mostrar video
                document.getElementById('facial-init').style.display = 'none';
                document.getElementById('facial-video-container').style.display = 'block';
                
                // Iniciar c√°mara
                const video = document.getElementById('facial-video');
                
                facialVideoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    }
                });

                video.srcObject = facialVideoStream;
                await video.play();

                // Configurar canvas
                const canvas = document.getElementById('facial-canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                document.getElementById('camera-status').innerHTML = '<i class="bi bi-camera-video"></i> Activa (Facial)';
                document.getElementById('camera-status').className = 'badge bg-success';

                // Iniciar detecci√≥n continua
                iniciarDeteccionFacialContinua();

                console.log('‚úÖ Reconocimiento facial iniciado');

            } catch (error) {
                console.error('‚ùå Error iniciando reconocimiento facial:', error);
                showMessage('Error al iniciar la c√°mara: ' + error.message, 'danger');
                detenerReconocimientoFacial();
            }
        }

        // ==========================================
        // DETECCI√ìN FACIAL CONTINUA
        // ==========================================
        function iniciarDeteccionFacialContinua() {
            const video = document.getElementById('facial-video');
            const canvas = document.getElementById('facial-canvas');
            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            
            faceapi.matchDimensions(canvas, displaySize);

            facialDetectionInterval = setInterval(async () => {
                const detection = await faceapi.detectSingleFace(video)
                    .withFaceLandmarks()
                    .withFaceDescriptor();
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const statusDiv = document.getElementById('facial-detection-status');

                if (!detection) {
                    statusDiv.textContent = 'No se detecta ning√∫n rostro';
                    statusDiv.className = 'detection-status error show';
                    return;
                }
                
                // Dibujar detecci√≥n
                const resizedDetection = faceapi.resizeResults(detection, displaySize);
                faceapi.draw.drawDetections(canvas, resizedDetection);
                faceapi.draw.drawFaceLandmarks(canvas, resizedDetection);
                
                statusDiv.textContent = '‚úì Rostro detectado - Identificando...';
                statusDiv.className = 'detection-status success show';
                
                // Buscar coincidencia
                const bestMatch = encontrarMejorCoincidencia(detection.descriptor);
                
                if (bestMatch) {
                    // ¬°Encontrado! Registrar asistencia
                    clearInterval(facialDetectionInterval);
                    facialDetectionInterval = null;
                    
                    detenerReconocimientoFacial();
                    await registrarAsistenciaFacial(bestMatch);
                }

            }, 100);
        }

        // ==========================================
        // ENCONTRAR MEJOR COINCIDENCIA
        // ==========================================
        function encontrarMejorCoincidencia(detectedDescriptor) {
            const threshold = 0.6; // Umbral de confianza (ajustable)
            let bestMatch = null;
            let bestDistance = Infinity;
            
            allFaceDescriptors.forEach(person => {
                const distance = faceapi.euclideanDistance(detectedDescriptor, person.descriptor);
                
                if (distance < bestDistance && distance < threshold) {
                    bestDistance = distance;
                    bestMatch = {
                        ...person,
                        distance: distance,
                        confidence: (1 - distance) * 100
                    };
                }
            });
            
            if (bestMatch) {
                console.log(`‚úÖ Persona reconocida: ${bestMatch.nombre} (confianza: ${bestMatch.confidence.toFixed(1)}%)`);
            }
            
            return bestMatch;
        }

        // ==========================================
        // REGISTRAR ASISTENCIA FACIAL
        // ==========================================
        async function registrarAsistenciaFacial(match) {
            try {
                mostrarLoading();

                const { fecha: today, hora, timestamp } = obtenerFechaHoraColombia();
                const registrosHoy = await supabaseRequest(`/attendance?select=*&person_id_document=eq.${match.documento}&attendance_date=eq.${today}`);
                const tipoRegistro = registrosHoy.length % 2 === 0 ? 'Entrada' : 'Salida';

                const nuevoRegistro = {
                    person_id_document: match.documento,
                    person_type: match.tipo,
                    registration_method: 'facial',
                    registered_by_worker_id: null,
                    attendance_date: today,
                    attendance_time: hora,
                    attendance_timestamp: timestamp
                };
                
                await supabaseRequest('/attendance', {
                    method: 'POST',
                    body: JSON.stringify(nuevoRegistro)
                });

                // Log del reconocimiento
                await supabaseRequest('/facial_recognition_logs', {
                    method: 'POST',
                    body: JSON.stringify({
                        recognition_success: true,
                        person_id_document: match.documento,
                        person_type: match.tipo,
                        confidence_score: match.confidence,
                        distance_score: match.distance,
                        recognition_context: 'attendance',
                        face_detected: true,
                        face_quality: 'good'
                    })
                });

                ocultarLoading();
                mostrarFeedback('success', `${tipoRegistro} registrada`, match.nombre);
                reproducirSonido('success');

                await cargarEstadisticas();
                await cargarUltimosRegistros();

                // Reiniciar reconocimiento despu√©s de 2 segundos
                setTimeout(() => iniciarReconocimientoFacial(), 2000);

            } catch (error) {
                console.error('‚ùå Error registrando asistencia facial:', error);
                ocultarLoading();
                mostrarFeedback('error', 'Error', 'No se pudo registrar la asistencia');
                setTimeout(() => iniciarReconocimientoFacial(), 2000);
            }
        }

        // ==========================================
        // DETENER RECONOCIMIENTO FACIAL
        // ==========================================
        function detenerReconocimientoFacial() {
            if (facialDetectionInterval) {
                clearInterval(facialDetectionInterval);
                facialDetectionInterval = null;
            }

            if (facialVideoStream) {
                facialVideoStream.getTracks().forEach(track => track.stop());
                facialVideoStream = null;
            }

            document.getElementById('facial-init').style.display = 'block';
            document.getElementById('facial-video-container').style.display = 'none';
            
            if (currentMode !== 'facial') {
                document.getElementById('camera-status').innerHTML = '<i class="bi bi-camera-video-off"></i> Inactiva';
                document.getElementById('camera-status').className = 'badge bg-secondary';
            }
        }

        // ==========================================
        // PROCESAR C√ìDIGO RFID
        // ==========================================
        async function procesarRFID(rfidCode) {
            try {
                console.log('üîñ C√≥digo RFID recibido:', rfidCode);
                mostrarLoading();

                let persona = await supabaseRequest(`/students?select=student_id_document,student_first_name,student_last_name_1,student_last_name_2,student_code,student_rfid_code&student_rfid_code=eq.${rfidCode}`);
                let tipoPersona = 'student';
                
                if (!persona || persona.length === 0) {
                    persona = await supabaseRequest(`/workers?select=worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2,worker_rfid_code&worker_rfid_code=eq.${rfidCode}`);
                    tipoPersona = 'worker';
                }

                if (!persona || persona.length === 0) {
                    ocultarLoading();
                    mostrarFeedback('error', 'Carnet no registrado', `El c√≥digo RFID ${rfidCode} no est√° asociado a ninguna persona`);
                    reproducirSonido('error');
                    
                    setTimeout(() => {
                        document.getElementById('rfid-input').focus();
                    }, 2000);
                    return;
                }

                const p = persona[0];
                let nombreCompleto = '';
                let documento = '';
                
                if (tipoPersona === 'student') {
                    nombreCompleto = `${p.student_last_name_1} ${p.student_last_name_2 || ''} ${p.student_first_name}`.trim();
                    documento = p.student_id_document;
                } else {
                    nombreCompleto = `${p.worker_last_name_1} ${p.worker_last_name_2 || ''} ${p.worker_first_name}`.trim();
                    documento = p.worker_id_doc;
                }

                const { fecha, hora, timestamp } = obtenerFechaHoraColombia();
                const registrosHoy = await supabaseRequest(`/attendance?select=*&person_id_document=eq.${documento}&attendance_date=eq.${fecha}`);
                const tipoRegistro = registrosHoy.length % 2 === 0 ? 'Entrada' : 'Salida';

                const nuevoRegistro = {
                    person_id_document: documento,
                    person_type: tipoPersona,
                    registration_method: 'rfid',
                    registered_by_worker_id: null,
                    attendance_date: fecha,
                    attendance_time: hora,
                    attendance_timestamp: timestamp
                };
                
                await supabaseRequest('/attendance', {
                    method: 'POST',
                    body: JSON.stringify(nuevoRegistro)
                });

                ocultarLoading();
                mostrarFeedback('success', `${tipoRegistro} registrada`, nombreCompleto);
                reproducirSonido('success');

                await cargarEstadisticas();
                await cargarUltimosRegistros();

                setTimeout(() => {
                    document.getElementById('rfid-input').focus();
                }, 2000);

            } catch (error) {
                console.error('‚ùå Error procesando RFID:', error);
                ocultarLoading();
                mostrarFeedback('error', 'Error', 'No se pudo registrar la asistencia');
                reproducirSonido('error');
                
                setTimeout(() => {
                    document.getElementById('rfid-input').focus();
                }, 2000);
            }
        }

        // ==========================================
        // CARGAR ESTAD√çSTICAS DEL D√çA
        // ==========================================
        async function cargarEstadisticas() {
            try {
                const { fecha: today } = obtenerFechaHoraColombia();
                const registros = await supabaseRequest(`/attendance?select=*&attendance_date=eq.${today}&order=attendance_time.desc`);
                
                if (!registros) {
                    console.warn('No se pudieron cargar las estad√≠sticas');
                    return;
                }

                const total = registros.length;
                const registrosPorPersona = {};
                registros.forEach(reg => {
                    const key = reg.person_id_document;
                    if (!registrosPorPersona[key]) {
                        registrosPorPersona[key] = [];
                    }
                    registrosPorPersona[key].push(reg);
                });

                let entradas = 0;
                let salidas = 0;
                
                Object.values(registrosPorPersona).forEach(regs => {
                    if (regs.length === 1) {
                        entradas++;
                    } else if (regs.length >= 2) {
                        entradas++;
                        salidas++;
                    }
                });

                const unaHoraAtras = new Date();
                unaHoraAtras.setHours(unaHoraAtras.getHours() - 1);
                const ultimaHora = registros.filter(reg => {
                    const regTime = new Date(`${reg.attendance_date}T${reg.attendance_time}`);
                    return regTime >= unaHoraAtras;
                }).length;

                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-entradas').textContent = entradas;
                document.getElementById('stat-salidas').textContent = salidas;
                document.getElementById('stat-ultima-hora').textContent = ultimaHora;

            } catch (error) {
                console.error('‚ùå Error cargando estad√≠sticas:', error);
            }
        }

        // ==========================================
        // CARGAR √öLTIMOS REGISTROS
        // ==========================================
        async function cargarUltimosRegistros() {
            try {
                const { fecha: today } = obtenerFechaHoraColombia();
                const registros = await supabaseRequest(`/attendance?select=*&attendance_date=eq.${today}&order=attendance_time.desc&limit=10`);
                
                const container = document.getElementById('recent-records');
                
                if (!registros || registros.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-inbox"></i>
                            <p class="mb-0">No hay registros recientes</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                for (const reg of registros) {
                    const nombre = await obtenerNombrePersona(reg.person_id_document, reg.person_type);
                    const tipoRegistro = await determinarTipoRegistro(reg.person_id_document, reg.attendance_time);
                    
                    let methodIcon = '';
                    if (reg.registration_method === 'manual') methodIcon = '<i class="bi bi-pencil ms-2" title="Registro manual"></i>';
                    else if (reg.registration_method === 'facial') methodIcon = '<i class="bi bi-person-bounding-box ms-2" title="Reconocimiento facial"></i>';
                    else if (reg.registration_method === 'rfid') methodIcon = '<i class="bi bi-credit-card ms-2" title="RFID"></i>';
                    
                    html += `
                        <div class="recent-record">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="record-name">${nombre}</div>
                                    <div class="record-time">
                                        <i class="bi bi-clock me-1"></i>${reg.attendance_time.substring(0, 5)}
                                        ${methodIcon}
                                    </div>
                                </div>
                                <span class="record-type ${tipoRegistro}">${tipoRegistro === 'entrada' ? 'Entrada' : 'Salida'}</span>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;

            } catch (error) {
                console.error('‚ùå Error cargando √∫ltimos registros:', error);
            }
        }

        // ==========================================
        // DETERMINAR TIPO DE REGISTRO
        // ==========================================
        async function determinarTipoRegistro(documento, horaActual) {
            try {
                const { fecha: today } = obtenerFechaHoraColombia();
                const registros = await supabaseRequest(`/attendance?select=attendance_time&person_id_document=eq.${documento}&attendance_date=eq.${today}&order=attendance_time.asc`);
                
                if (!registros || registros.length === 0) {
                    return 'entrada';
                }

                const index = registros.findIndex(r => r.attendance_time === horaActual);
                return index % 2 === 0 ? 'entrada' : 'salida';

            } catch (error) {
                console.error('Error determinando tipo de registro:', error);
                return 'entrada';
            }
        }

        // ==========================================
        // OBTENER NOMBRE DE PERSONA
        // ==========================================
        async function obtenerNombrePersona(documento, tipo) {
            try {
                if (tipo === 'student') {
                    const estudiante = await supabaseRequest(`/students?select=student_first_name,student_last_name_1,student_last_name_2&student_id_document=eq.${documento}`);
                    if (estudiante && estudiante.length > 0) {
                        const e = estudiante[0];
                        return `${e.student_last_name_1} ${e.student_last_name_2 || ''} ${e.student_first_name}`.trim();
                    }
                } else if (tipo === 'worker') {
                    const trabajador = await supabaseRequest(`/workers?select=worker_first_name,worker_last_name_1,worker_last_name_2&worker_id_doc=eq.${documento}`);
                    if (trabajador && trabajador.length > 0) {
                        const t = trabajador[0];
                        return `${t.worker_last_name_1} ${t.worker_last_name_2 || ''} ${t.worker_first_name}`.trim();
                    }
                }
                return 'Desconocido';
            } catch (error) {
                console.error('Error obteniendo nombre:', error);
                return 'Error';
            }
        }

        // ==========================================
        // INICIAR SCANNER
        // ==========================================
        async function iniciarScanner() {
            try {
                document.getElementById('start-scanner-btn').style.display = 'none';
                document.getElementById('reader').style.display = 'block';
                document.querySelector('.scanner-icon').style.display = 'none';
                document.querySelector('.scanner-container h4').style.display = 'none';
                document.querySelector('.scanner-container p').style.display = 'none';

                html5QrcodeScanner = new Html5Qrcode("reader");
                
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                };

                await html5QrcodeScanner.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanError
                );

                document.getElementById('stop-scanner-btn').style.display = 'inline-block';
                document.getElementById('camera-status').innerHTML = '<i class="bi bi-camera-video"></i> Activa (Barcode)';
                document.getElementById('camera-status').className = 'badge bg-success';

                console.log('‚úÖ Scanner iniciado correctamente');

            } catch (error) {
                console.error('‚ùå Error iniciando scanner:', error);
                showMessage('Error al iniciar la c√°mara. Verifica los permisos del navegador.', 'danger');
                
                document.getElementById('start-scanner-btn').style.display = 'inline-block';
                document.getElementById('reader').style.display = 'none';
                document.querySelector('.scanner-icon').style.display = 'block';
                document.querySelector('.scanner-container h4').style.display = 'block';
                document.querySelector('.scanner-container p').style.display = 'block';
            }
        }

        // ==========================================
        // DETENER SCANNER
        // ==========================================
        async function detenerScanner() {
            try {
                if (html5QrcodeScanner) {
                    await html5QrcodeScanner.stop();
                    html5QrcodeScanner = null;
                }

                document.getElementById('reader').style.display = 'none';
                document.getElementById('start-scanner-btn').style.display = 'inline-block';
                document.getElementById('stop-scanner-btn').style.display = 'none';
                document.querySelector('.scanner-icon').style.display = 'block';
                document.querySelector('.scanner-container h4').style.display = 'block';
                document.querySelector('.scanner-container p').style.display = 'block';

                if (currentMode !== 'facial' && currentMode !== 'rfid') {
                    document.getElementById('camera-status').innerHTML = '<i class="bi bi-camera-video-off"></i> Inactiva';
                    document.getElementById('camera-status').className = 'badge bg-secondary';
                }

            } catch (error) {
                console.error('Error deteniendo scanner:', error);
            }
        }

        // ==========================================
        // CALLBACK: ESCANEO EXITOSO
        // ==========================================
        async function onScanSuccess(decodedText, decodedResult) {
            console.log('‚úÖ C√≥digo escaneado:', decodedText);
            await detenerScanner();
            await registrarAsistencia(decodedText, 'carnet');
        }

        // ==========================================
        // CALLBACK: ERROR EN ESCANEO
        // ==========================================
        function onScanError(errorMessage) {
            // Ignorar errores de escaneo
        }

        // ==========================================
        // REGISTRAR ASISTENCIA (DESDE CARNET)
        // ==========================================
        async function registrarAsistencia(documento, metodo = 'carnet') {
            try {
                mostrarLoading();

                let persona = await supabaseRequest(`/students?select=student_id_document,student_first_name,student_last_name_1,student_last_name_2,student_code&student_id_document=eq.${documento}`);
                let tipoPersona = 'student';
                
                if (!persona || persona.length === 0) {
                    persona = await supabaseRequest(`/workers?select=worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2&worker_id_doc=eq.${documento}`);
                    tipoPersona = 'worker';
                }

                if (!persona || persona.length === 0) {
                    ocultarLoading();
                    mostrarFeedback('error', 'Persona no encontrada', `El documento ${documento} no est√° registrado en el sistema`);
                    setTimeout(() => iniciarScanner(), 2000);
                    return;
                }

                const p = persona[0];
                let nombreCompleto = '';
                if (tipoPersona === 'student') {
                    nombreCompleto = `${p.student_last_name_1} ${p.student_last_name_2 || ''} ${p.student_first_name}`.trim();
                } else {
                    nombreCompleto = `${p.worker_last_name_1} ${p.worker_last_name_2 || ''} ${p.worker_first_name}`.trim();
                }

                const { fecha: today, hora, timestamp } = obtenerFechaHoraColombia();
                const registrosHoy = await supabaseRequest(`/attendance?select=*&person_id_document=eq.${documento}&attendance_date=eq.${today}`);
                const tipoRegistro = registrosHoy.length % 2 === 0 ? 'Entrada' : 'Salida';

                let registeredByWorkerId = null;
                if (metodo === 'manual' && currentUser.user_mail) {
                    try {
                        const workerData = await supabaseRequest(`/workers?select=worker_id&email=eq.${currentUser.user_mail}&limit=1`);
                        if (workerData && workerData.length > 0) {
                            registeredByWorkerId = workerData[0].worker_id;
                            console.log('‚úÖ Worker encontrado:', registeredByWorkerId);
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error buscando trabajador:', error.message);
                    }
                }

                const nuevoRegistro = {
                    person_id_document: documento,
                    person_type: tipoPersona,
                    registration_method: metodo,
                    registered_by_worker_id: registeredByWorkerId,
                    attendance_date: today,
                    attendance_time: hora,
                    attendance_timestamp: timestamp
                };
                await supabaseRequest('/attendance', {
                    method: 'POST',
                    body: JSON.stringify(nuevoRegistro)
                });

                ocultarLoading();
                mostrarFeedback('success', `${tipoRegistro} registrada`, nombreCompleto);
                reproducirSonido('success');

                await cargarEstadisticas();
                await cargarUltimosRegistros();

                setTimeout(() => iniciarScanner(), 2000);

            } catch (error) {
                console.error('‚ùå Error registrando asistencia:', error);
                ocultarLoading();
                mostrarFeedback('error', 'Error', 'No se pudo registrar la asistencia');
                setTimeout(() => iniciarScanner(), 2000);
            }
        }

        // ==========================================
        // MOSTRAR MODAL DE REGISTRO MANUAL
        // ==========================================
        function mostrarRegistroManual() {
            detenerScanner();
            detenerReconocimientoFacial();
            
            if (currentMode === 'rfid') {
                console.log('‚è∏Ô∏è Pausando modo RFID temporalmente');
            }
            
            limpiarBusqueda();
            manualRegistrationModal.show();
            
            setTimeout(() => {
                const searchDocField = document.getElementById('search-document');
                if (searchDocField && searchDocField.offsetParent !== null) {
                    searchDocField.focus();
                }
            }, 300);
        }
        
        // ==========================================
        // BUSCAR PERSONA
        // ==========================================
        async function buscarPersona() {
            try {
                mostrarLoading();

                const tipoBusqueda = document.querySelector('input[name="search-type"]:checked').value;
                let resultados = [];

                if (tipoBusqueda === 'document') {
                    const documento = document.getElementById('search-document').value.trim();
                    
                    if (!documento) {
                        showMessage('Por favor ingrese un documento', 'warning');
                        ocultarLoading();
                        return;
                    }

                    const estudiantes = await supabaseRequest(`/students?select=student_id_document,student_code,student_first_name,student_last_name_1,student_last_name_2&student_id_document=eq.${documento}`);
                    if (estudiantes && estudiantes.length > 0) {
                        estudiantes.forEach(e => {
                            resultados.push({
                                tipo: 'student',
                                documento: e.student_id_document,
                                codigo: e.student_code,
                                nombre: `${e.student_last_name_1} ${e.student_last_name_2 || ''} ${e.student_first_name}`.trim()
                            });
                        });
                    }

                    const trabajadores = await supabaseRequest(`/workers?select=worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2&worker_id_doc=eq.${documento}`);
                    if (trabajadores && trabajadores.length > 0) {
                        trabajadores.forEach(t => {
                            resultados.push({
                                tipo: 'worker',
                                documento: t.worker_id_doc,
                                codigo: null,
                                nombre: `${t.worker_last_name_1} ${t.worker_last_name_2 || ''} ${t.worker_first_name}`.trim()
                            });
                        });
                    }

                } else {
                    const nombre = document.getElementById('search-name').value.trim().toLowerCase();
                    
                    if (!nombre || nombre.length < 3) {
                        showMessage('Por favor ingrese al menos 3 caracteres', 'warning');
                        ocultarLoading();
                        return;
                    }

                    const estudiantes = await supabaseRequest(`/students?select=student_id_document,student_code,student_first_name,student_last_name_1,student_last_name_2`);
                    if (estudiantes) {
                        estudiantes.forEach(e => {
                            const nombreCompleto = `${e.student_last_name_1} ${e.student_last_name_2 || ''} ${e.student_first_name}`.toLowerCase();
                            if (nombreCompleto.includes(nombre)) {
                                resultados.push({
                                    tipo: 'student',
                                    documento: e.student_id_document,
                                    codigo: e.student_code,
                                    nombre: `${e.student_last_name_1} ${e.student_last_name_2 || ''} ${e.student_first_name}`.trim()
                                });
                            }
                        });
                    }

                    const trabajadores = await supabaseRequest(`/workers?select=worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2`);
                    if (trabajadores) {
                        trabajadores.forEach(t => {
                            const nombreCompleto = `${t.worker_last_name_1} ${t.worker_last_name_2 || ''} ${t.worker_first_name}`.toLowerCase();
                            if (nombreCompleto.includes(nombre)) {
                                resultados.push({
                                    tipo: 'worker',
                                    documento: t.worker_id_doc,
                                    codigo: null,
                                    nombre: `${t.worker_last_name_1} ${t.worker_last_name_2 || ''} ${t.worker_first_name}`.trim()
                                });
                            }
                        });
                    }
                }

                ocultarLoading();
                mostrarResultadosBusqueda(resultados);

            } catch (error) {
                console.error('‚ùå Error buscando persona:', error);
                ocultarLoading();
                showMessage('Error en la b√∫squeda', 'danger');
            }
        }

        // ==========================================
        // MOSTRAR RESULTADOS DE B√öSQUEDA
        // ==========================================
        function mostrarResultadosBusqueda(resultados) {
            const container = document.getElementById('search-results-list');
            
            if (resultados.length === 0) {
                document.getElementById('search-results').style.display = 'block';
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-search"></i>
                        <p class="mb-0">No se encontraron resultados</p>
                    </div>
                `;
                return;
            }

            let html = '';
            resultados.forEach(persona => {
                const badgeClass = persona.tipo === 'student' ? 'student' : 'worker';
                const badgeText = persona.tipo === 'student' ? 'üìö Estudiante' : 'üëî Trabajador';
                const codigoText = persona.codigo ? ` - C√≥digo: ${persona.codigo}` : '';
                
                html += `
                    <div class="search-result-item" onclick='seleccionarPersona(${JSON.stringify(persona)})'>
                        <span class="person-badge ${badgeClass}">${badgeText}</span>
                        <div class="fw-bold">${persona.nombre}</div>
                        <small class="text-muted">Doc: ${persona.documento}${codigoText}</small>
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('search-results').style.display = 'block';
        }

        // ==========================================
        // SELECCIONAR PERSONA
        // ==========================================
        function seleccionarPersona(persona) {
            selectedPerson = persona;
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('selected-person-name').textContent = persona.nombre;
            const tipoTexto = persona.tipo === 'student' ? 'Estudiante' : 'Trabajador';
            const codigoTexto = persona.codigo ? ` - C√≥digo: ${persona.codigo}` : '';
            document.getElementById('selected-person-details').textContent = `${tipoTexto} - Doc: ${persona.documento}${codigoTexto}`;
            
            document.getElementById('selected-person').style.display = 'block';
        }

        // ==========================================
        // REGISTRAR ASISTENCIA MANUAL
        // ==========================================
        async function registrarAsistenciaManual() {
            if (!selectedPerson) {
                showMessage('No hay una persona seleccionada', 'warning');
                return;
            }

            try {
                mostrarLoading();

                const observaciones = document.getElementById('observations').value.trim();
                const { fecha: today, hora, timestamp } = obtenerFechaHoraColombia();
                const registrosHoy = await supabaseRequest(`/attendance?select=*&person_id_document=eq.${selectedPerson.documento}&attendance_date=eq.${today}`);
                const tipoRegistro = registrosHoy.length % 2 === 0 ? 'Entrada' : 'Salida';

                let registeredByWorkerId = null;
                if (currentUser.user_mail) {
                    try {
                        const workerData = await supabaseRequest(`/workers?select=worker_id&email=eq.${currentUser.user_mail}&limit=1`);
                        if (workerData && workerData.length > 0) {
                            registeredByWorkerId = workerData[0].worker_id;
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error buscando trabajador:', error.message);
                    }
                }

                const nuevoRegistro = {
                    person_id_document: selectedPerson.documento,
                    person_type: selectedPerson.tipo,
                    registration_method: 'manual',
                    observations: observaciones || null,
                    registered_by_worker_id: registeredByWorkerId,
                    attendance_date: today,
                    attendance_time: hora,
                    attendance_timestamp: timestamp
                };

                await supabaseRequest('/attendance', {
                    method: 'POST',
                    body: JSON.stringify(nuevoRegistro)
                });

                ocultarLoading();
                manualRegistrationModal.hide();
                mostrarFeedback('success', `${tipoRegistro} registrada`, selectedPerson.nombre);
                reproducirSonido('success');

                await cargarEstadisticas();
                await cargarUltimosRegistros();

            } catch (error) {
                console.error('‚ùå Error registrando asistencia manual:', error);
                ocultarLoading();
                showMessage('Error al registrar la asistencia', 'danger');
            }
        }

        // ==========================================
        // LIMPIAR B√öSQUEDA
        // ==========================================
        function limpiarBusqueda() {
            document.getElementById('search-document').value = '';
            document.getElementById('search-name').value = '';
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('selected-person').style.display = 'none';
            document.getElementById('observations').value = '';
            selectedPerson = null;
        }

        // ==========================================
        // EVENTO: Al cerrar el modal
        // ==========================================
        document.getElementById('manual-registration-modal').addEventListener('hidden.bs.modal', function() {
            if (currentMode === 'rfid') {
                setTimeout(() => {
                    document.getElementById('rfid-input').focus();
                    console.log('‚úÖ Modo RFID reactivado');
                }, 100);
            }
        });

        // ==========================================
        // MOSTRAR/OCULTAR FEEDBACK
        // ==========================================
        function mostrarFeedback(tipo, titulo, mensaje) {
            const overlay = document.getElementById('feedback-overlay');
            const icon = document.getElementById('feedback-icon');
            const titleEl = document.getElementById('feedback-title');
            const messageEl = document.getElementById('feedback-message');

            if (tipo === 'success') {
                icon.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
                icon.className = 'feedback-icon success';
            } else if (tipo === 'error') {
                icon.innerHTML = '<i class="bi bi-x-circle-fill"></i>';
                icon.className = 'feedback-icon error';
            } else if (tipo === 'warning') {
                icon.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i>';
                icon.className = 'feedback-icon warning';
            }

            titleEl.textContent = titulo;
            messageEl.textContent = mensaje;
            overlay.classList.add('show');
            setTimeout(() => ocultarFeedback(), 2000);
        }

        function ocultarFeedback() {
            document.getElementById('feedback-overlay').classList.remove('show');
        }

        // ==========================================
        // REPRODUCIR SONIDO
        // ==========================================
        function reproducirSonido(tipo) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                if (tipo === 'success') {
                    oscillator.frequency.value = 800;
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                } else if (tipo === 'error') {
                    oscillator.frequency.value = 400;
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                }
            } catch (error) {
                console.log('Audio no disponible');
            }
        }

        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading(mensaje = 'Cargando...') {
            document.getElementById('loading-message').textContent = mensaje;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Limpiar al salir
        window.addEventListener('beforeunload', () => {
            detenerScanner();
            detenerReconocimientoFacial();
        });

        console.log('‚úÖ Sistema de asistencia con reconocimiento facial cargado correctamente');
    </script>
</body>
</html>
