<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.01.22.12.07">
    <title>Gestión de Tareas - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSIÓN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Quill.js Editor de texto enriquecido -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tarjetas de tareas */
        .task-card {
            border-left: 4px solid #6c757d;
            transition: all 0.3s ease;
        }
        
        .task-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .task-card.priority-high, .task-card.priority-alta {
            border-left-color: #dc3545;
        }
        
        .task-card.priority-normal {
            border-left-color: #0d6efd;
        }
        
        .task-card.priority-low, .task-card.priority-baja {
            border-left-color: #6c757d;
        }
        
        .task-card.overdue {
            background-color: #fff3cd;
        }
        
        /* Badges */
        .badge-priority-high, .badge-priority-Alta {
            background-color: #dc3545;
        }
        
        .badge-priority-normal, .badge-priority-Normal {
            background-color: #0d6efd;
        }
        
        .badge-priority-low, .badge-priority-Baja {
            background-color: #6c757d;
        }
        
        .badge-status-assigned {
            background-color: #0dcaf0;
            color: #000;
        }
        
        .badge-status-progress {
            background-color: #ffc107;
            color: #000;
        }
        
        .badge-status-completed {
            background-color: #198754;
        }
        
        .badge-status-cancelled {
            background-color: #6c757d;
        }
        
        /* Filtros */
        .filters-section {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        /* Estados vacíos */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Estilos para notas de progreso */
        .note-item {
            border-left: 3px solid #0d6efd;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            background-color: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }
        
        .note-item .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .note-item .note-author {
            font-weight: 600;
            color: #0d6efd;
        }
        
        .note-item .note-date {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .note-item .note-content {
            color: #333;
            white-space: pre-wrap;
        }
        
        /* Estilos para colaboradores */
        .collaborator-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .collaborator-item:last-child {
            border-bottom: none;
        }
        
        .collaborator-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .collaborator-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #0d6efd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        /* Badge contador */
        .badge-counter {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }
        
        /* Historial de notas scrolleable */
        .notes-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Colaboradores scrolleable */
        .collaborators-list {
            max-height: 250px;
            overflow-y: auto;
        }

        /* Estilos para categorías */
        .badge-category {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            padding: 0.35rem 0.6rem;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .category-select-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .category-color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Estilos para Quill Editor */
        .ql-container {
            font-size: 14px;
            min-height: 100px;
        }
        
        .ql-editor {
            min-height: 100px;
        }
        
        .ql-toolbar {
            background: #f8f9fa;
            border-radius: 4px 4px 0 0;
        }
        
        .ql-container.ql-snow {
            border-radius: 0 0 4px 4px;
        }
        
        /* Contenido HTML renderizado */
        .html-content {
            line-height: 1.6;
        }
        
        .html-content p {
            margin-bottom: 0.5rem;
        }
        
        .html-content ul, .html-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .html-content a {
            color: #0d6efd;
            text-decoration: underline;
        }
        
        /* Estilos para archivos adjuntos */
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            border: 1px solid #dee2e6;
        }
        
        .file-item:hover {
            background: #e9ecef;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            overflow: hidden;
        }
        
        .file-info i {
            font-size: 1.2rem;
            color: #6c757d;
        }
        
        .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .file-size {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .file-actions {
            display: flex;
            gap: 0.25rem;
        }
        
        .files-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafafa;
        }
        
        .files-upload-area:hover {
            border-color: #0d6efd;
            background: #f0f7ff;
        }
        
        .files-upload-area.dragover {
            border-color: #0d6efd;
            background: #e7f1ff;
        }
        
        .files-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gestión de Tareas
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE PÁGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-check2-square me-2"></i>
                    Gestión de Tareas
                </h1>
                <p class="text-muted">
                    Administra y da seguimiento a las tareas asignadas
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>
        
        <!-- SECCIÓN DE FILTROS -->
        <div class="filters-section">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="filter-status" class="form-label">
                        <i class="bi bi-funnel me-1"></i>Estado
                    </label>
                    <select class="form-select" id="filter-status">
                        <option value="">Todos los estados</option>
                        <option value="Asignada">Asignada</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Terminada">Terminada</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="filter-priority" class="form-label">
                        <i class="bi bi-exclamation-circle me-1"></i>Prioridad
                    </label>
                    <select class="form-select" id="filter-priority">
                        <option value="">Todas las prioridades</option>
                        <option value="Alta">Alta</option>
                        <option value="Normal">Normal</option>
                        <option value="Baja">Baja</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="filter-module" class="form-label">
                        <i class="bi bi-box me-1"></i>Módulo Origen
                    </label>
                    <select class="form-select" id="filter-module">
                        <option value="">Todos los módulos</option>
                        <option value="follow-ups">Seguimientos</option>
                        <option value="early-alerts">Alertas Tempranas</option>
                        <option value="general-tools">Herramientas Generales</option>
                    </select>
                </div>

                <div class="col-md-3" id="filter-category-container">
                    <label for="filter-category" class="form-label">
                        <i class="bi bi-tag me-1"></i>Categoría
                    </label>
                    <select class="form-select" id="filter-category">
                        <option value="">Todas las categorías</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="filter-responsable" class="form-label">
                        <i class="bi bi-person-check me-1"></i>Responsable
                    </label>
                    <select class="form-select" id="filter-responsable">
                        <option value="">Todos los responsables</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="filter-search" class="form-label">
                        <i class="bi bi-search me-1"></i>Buscar
                    </label>
                    <input type="text" class="form-control" id="filter-search" 
                           placeholder="Buscar en descripción...">
                </div>
                <div class="col-md-3">
                    <label for="filter-order" class="form-label">
                        <i class="bi bi-sort-down me-1"></i>Ordenar por
                    </label>
                    <select class="form-select" id="filter-order">
                        <option value="created_desc">Creación (recientes primero)</option>
                        <option value="created_asc">Creación (antiguas primero)</option>
                        <option value="due_asc">Fecha límite (próximas primero)</option>
                        <option value="due_desc">Fecha límite (lejanas primero)</option>
                        <option value="priority_desc">Prioridad (alta → baja)</option>
                        <option value="priority_asc">Prioridad (baja → alta)</option>
                    </select>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col">
                    <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                        <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                    </button>
                    <button class="btn btn-primary" id="btn-nueva-tarea" onclick="abrirModalNuevaTarea()" style="display: none;">
                        <i class="bi bi-plus-circle me-1"></i>Nueva Tarea
                    </button>
                    <span id="link-volver-proyecto"></span>
                </div>
            </div>
        </div>

        <!-- LISTADO DE TAREAS -->
        <div class="row" id="tasks-container">
            <div class="col-12">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <div class="mt-2">Cargando tareas...</div>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL: NUEVA TAREA -->
    <div class="modal fade" id="modal-nueva-tarea" tabindex="-1" aria-labelledby="modalNuevaTareaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNuevaTareaLabel">
                        <i class="bi bi-plus-circle me-2"></i>Nueva Tarea
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="form-nueva-tarea">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">
                                Descripción de la tarea <span class="text-danger">*</span>
                            </label>
                            <div id="editor-nueva-descripcion"></div>
                            <input type="hidden" id="nueva-descripcion" name="task_description">
                        </div>
                        
                        <div class="mb-3">
                            <label for="nueva-asignada-a" class="form-label">
                                Asignada a <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="nueva-asignada-a" name="assigned_to_mail" required>
                                <option value="">Seleccione un trabajador...</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nueva-fecha-limite" class="form-label">
                                    Fecha límite <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="nueva-fecha-limite" 
                                       name="due_date" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="nueva-prioridad" class="form-label">
                                    Prioridad <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="nueva-prioridad" name="task_priority" required>
                                    <option value="">Seleccione prioridad...</option>
                                    <option value="Alta">Alta</option>
                                    <option value="Normal" selected>Normal</option>
                                    <option value="Baja">Baja</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="nueva-categoria" class="form-label">
                                <i class="bi bi-tag me-1"></i>Categoría
                                <small class="text-muted">(opcional)</small>
                            </label>
                            <select class="form-select" id="nueva-categoria" name="category_id">
                                <option value="">Sin categoría</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                Contexto inicial
                                <button type="button" class="btn btn-link btn-sm p-0 ms-1" data-bs-toggle="modal" data-bs-target="#modal-ayuda-contexto" title="¿Cómo redactar un buen contexto?">
                                    <i class="bi bi-question-circle text-info"></i>
                                </button>
                            </label>
                            <div id="editor-nueva-contexto"></div>
                            <input type="hidden" id="nueva-notas" name="task_progress">
                            <small class="text-muted">Aplica el principio Ganar-Ganar: define resultados, directrices, recursos y forma de seguimiento para generar compromiso mutuo.</small>
                        </div>
                        
                        <!-- Sección de Archivos Adjuntos -->
                        <div class="card border-secondary mb-3">
                            <div class="card-header bg-secondary bg-opacity-10 d-flex justify-content-between align-items-center"
                                 style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#seccion-archivos-nueva">
                                <span>
                                    <i class="bi bi-paperclip me-1"></i>Archivos Adjuntos
                                    <span class="badge bg-secondary" id="badge-archivos-nueva">0</span>
                                    <small class="text-muted ms-2">(opcional)</small>
                                </span>
                                <i class="bi bi-chevron-down"></i>
                            </div>
                            <div class="collapse" id="seccion-archivos-nueva">
                                <div class="card-body">
                                    <div class="files-upload-area" id="upload-area-nueva" onclick="document.getElementById('input-archivos-nueva').click()">
                                        <i class="bi bi-cloud-upload fs-2 text-muted"></i>
                                        <p class="mb-0 mt-2">Haz clic o arrastra archivos aquí</p>
                                        <small class="text-muted">Máximo 10 MB por archivo</small>
                                    </div>
                                    <input type="file" id="input-archivos-nueva" multiple style="display: none;" onchange="agregarArchivosNuevaTarea(this.files)">
                                    <div class="files-list mt-3" id="lista-archivos-nueva"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sección de Colaboradores (opcional) -->
                        <div class="card border-info mb-3">
                            <div class="card-header bg-info bg-opacity-10 d-flex justify-content-between align-items-center" 
                                 style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#seccion-colaboradores-nueva">
                                <span>
                                    <i class="bi bi-people me-1"></i>Colaboradores 
                                    <span class="badge bg-secondary" id="badge-colaboradores-nueva">0</span>
                                    <small class="text-muted ms-2">(opcional)</small>
                                </span>
                                <i class="bi bi-chevron-down" id="icono-collapse-colaboradores"></i>
                            </div>
                            <div class="collapse" id="seccion-colaboradores-nueva">
                                <div class="card-body">
                                    <div class="row g-2 align-items-end mb-3">
                                        <div class="col-md-9">
                                            <label for="select-colaborador-nueva" class="form-label">
                                                Agregar colaborador
                                            </label>
                                            <select class="form-select" id="select-colaborador-nueva">
                                                <option value="">Seleccione un trabajador...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-outline-success w-100" onclick="agregarColaboradorNuevaTarea()">
                                                <i class="bi bi-plus"></i> Agregar
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Lista de colaboradores agregados -->
                                    <div id="lista-colaboradores-nueva">
                                        <div class="text-center text-muted py-2" id="sin-colaboradores-msg">
                                            <small>No se han agregado colaboradores</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Crear Tarea
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- MODAL: EDITAR PROGRESO -->
    <div class="modal fade" id="modal-editar-progreso" tabindex="-1" aria-labelledby="modalEditarProgresoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarProgresoLabel">
                        <i class="bi bi-pencil-square me-2"></i>Editar Progreso de Tarea
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="form-editar-progreso">
                    <div class="modal-body">
                        <!-- Información de la tarea (readonly) -->
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Información de la Tarea</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Descripción:</strong></p>
                                        <p class="text-muted" id="progreso-descripcion"></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Responsable:</strong></p>
                                        <p class="text-muted" id="progreso-asignada"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Fecha límite:</strong></p>
                                        <p class="text-muted" id="progreso-fecha"></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Prioridad:</strong></p>
                                        <p class="text-muted" id="progreso-prioridad"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Estado actual:</strong></p>
                                        <p class="text-muted" id="progreso-estado"></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Estudiante:</strong></p>
                                        <p class="text-muted" id="progreso-estudiante"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campo editable de contexto general (solo responsable principal) -->
                        <div class="mb-3" id="seccion-contexto-general">
                            <label class="form-label">
                                <i class="bi bi-card-text me-1"></i>Contexto General
                                <small class="text-muted">(solo responsable principal)</small>
                            </label>
                            <div id="editor-editar-contexto"></div>
                            <input type="hidden" id="editar-progreso-text" name="task_progress">
                            <small class="text-muted">Resumen ejecutivo de la tarea</small>
                        </div>
                        
                        <!-- Cambiar estado (solo responsable principal) -->
                        <!-- Cambiar categoría (solo creador, solo general-tools) -->
                        <div class="mb-3" id="seccion-cambiar-categoria" style="display: none;">
                            <label for="editar-categoria" class="form-label">
                                <i class="bi bi-tag me-1"></i>Categoría
                            </label>
                            <select class="form-select" id="editar-categoria" name="category_id">
                                <option value="">Sin categoría</option>
                            </select>
                        </div>
                        <div class="mb-3" id="seccion-cambiar-estado">
                            <label for="editar-estado" class="form-label">
                                Estado de la tarea
                            </label>
                            <select class="form-select" id="editar-estado" name="task_state">
                                <option value="Asignada">Asignada</option>
                                <option value="En Progreso">En Progreso</option>
                                <option value="Terminada">Terminada</option>
                            </select>
                        </div>
                        
                        <!-- Cambiar fecha límite (solo creador) -->
                        <div class="mb-3" id="seccion-cambiar-fecha" style="display: none;">
                            <label for="editar-fecha-limite" class="form-label">
                                <i class="bi bi-calendar-event me-1"></i>Fecha límite
                                <small class="text-muted">(solo creador)</small>
                            </label>
                            <input type="date" class="form-control" id="editar-fecha-limite" name="due_date">
                        </div>
                        
                        <hr>
                        
                        <!-- Sección de notas de progreso -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-journal-text me-1"></i>Agregar Nota de Progreso
                            </label>
                            <div id="editor-nueva-nota"></div>
                            <input type="hidden" id="nueva-nota-progreso">
                            <small class="text-muted">Esta nota se agregará al historial con tu nombre y fecha</small>
                        </div>
                        
                        <!-- Archivos para la nota -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-paperclip me-1"></i>Adjuntar archivos a esta nota
                            </label>
                            <div class="files-upload-area" id="upload-area-nota" onclick="document.getElementById('input-archivos-nota').click()">
                                <i class="bi bi-cloud-upload fs-3 text-muted"></i>
                                <p class="mb-0 mt-1 small">Haz clic o arrastra archivos</p>
                            </div>
                            <input type="file" id="input-archivos-nota" multiple style="display: none;" onchange="agregarArchivosNota(this.files)">
                            <div class="files-list mt-2" id="lista-archivos-nota"></div>
                        </div>
                        
                        <!-- Historial de notas -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-clock-history me-1"></i>Historial de Notas
                                <span class="badge bg-secondary badge-counter" id="contador-notas-progreso">0</span>
                            </label>
                            <div class="notes-container" id="historial-notas-progreso">
                                <div class="text-center text-muted py-3">
                                    <i class="bi bi-journal-x"></i> No hay notas registradas
                                </div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="editar-task-id" name="task_id">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: VER DETALLE -->
    <div class="modal fade" id="modal-ver-detalle" tabindex="-1" aria-labelledby="modalVerDetalleLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalVerDetalleLabel">
                        <i class="bi bi-info-circle me-2"></i>Detalle de Tarea
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Columna izquierda: Información básica -->
                        <div class="col-md-6">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6 class="text-muted mb-2">Descripción</h6>
                                    <p id="detalle-descripcion"></p>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2">Estado</h6>
                                    <p id="detalle-estado"></p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2">Prioridad</h6>
                                    <p id="detalle-prioridad"></p>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2">Responsable Principal</h6>
                                    <p id="detalle-asignada"></p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2">Estudiante asociado</h6>
                                    <p id="detalle-estudiante"></p>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-2">Módulo origen</h6>
                                    <p id="detalle-modulo"></p>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-2">Fecha límite</h6>
                                    <p id="detalle-fecha-limite"></p>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-2">Fecha de cierre</h6>
                                    <p id="detalle-fecha-cierre"></p>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6 class="text-muted mb-2">Categoría</h6>
                                    <p id="detalle-categoria"></p>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">Contexto General</h6>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <p id="detalle-progreso" class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Colaboradores en detalle -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">
                                    <i class="bi bi-people me-1"></i>Colaboradores
                                    <span class="badge bg-secondary badge-counter" id="detalle-contador-colaboradores">0</span>
                                </h6>
                                <div class="card">
                                    <div class="card-body p-2">
                                        <div class="collaborators-list" id="detalle-lista-colaboradores">
                                            <div class="text-center text-muted py-2">
                                                <small>Sin colaboradores adicionales</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Archivos adjuntos en detalle -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">
                                    <i class="bi bi-paperclip me-1"></i>Archivos Adjuntos
                                    <span class="badge bg-secondary badge-counter" id="detalle-contador-archivos">0</span>
                                </h6>
                                <div class="card">
                                    <div class="card-body p-2">
                                        <div class="files-list" id="detalle-lista-archivos">
                                            <div class="text-center text-muted py-2">
                                                <small>Sin archivos adjuntos</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Columna derecha: Historial de notas -->
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-journal-text me-1"></i>Historial de Notas
                                <span class="badge bg-secondary badge-counter" id="detalle-contador-notas">0</span>
                            </h6>
                            <div class="card">
                                <div class="card-body">
                                    <div class="notes-container" id="detalle-historial-notas" style="max-height: 400px;">
                                        <div class="text-center text-muted py-3">
                                            <i class="bi bi-journal-x"></i> No hay notas registradas
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: GESTIONAR COLABORADORES -->
    <div class="modal fade" id="modal-colaboradores" tabindex="-1" aria-labelledby="modalColaboradoresLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalColaboradoresLabel">
                        <i class="bi bi-people me-2"></i>Gestionar Colaboradores
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Información de la tarea -->
                    <div class="alert alert-info">
                        <strong>Tarea:</strong> <span id="colab-descripcion-tarea"></span>
                    </div>
                    
                    <!-- Agregar nuevo colaborador -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <i class="bi bi-person-plus me-1"></i>Agregar Colaborador
                        </div>
                        <div class="card-body">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-8">
                                    <label for="select-nuevo-colaborador" class="form-label">
                                        Seleccionar trabajador
                                    </label>
                                    <select class="form-select" id="select-nuevo-colaborador">
                                        <option value="">Seleccione un trabajador...</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-success w-100" onclick="agregarColaborador()">
                                        <i class="bi bi-plus-circle me-1"></i>Agregar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de colaboradores actuales -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-people me-1"></i>Colaboradores Actuales</span>
                            <span class="badge bg-primary" id="badge-total-colaboradores">0</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="collaborators-list" id="lista-colaboradores">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-people" style="font-size: 2rem;"></i>
                                    <p class="mb-0 mt-2">No hay colaboradores en esta tarea</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="colab-task-id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: AYUDA CONTEXTO INICIAL -->
        <div class="modal fade" id="modal-ayuda-contexto" tabindex="-1" aria-labelledby="modalAyudaContextoLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-light">
                        <h5 class="modal-title" id="modalAyudaContextoLabel">
                            <i class="bi bi-lightbulb me-2 text-warning"></i>Principio Ganar-Ganar: ¿Cómo redactar un buen contexto?
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted mb-3">
                            Define el <strong>qué</strong> (resultado esperado), no el <strong>cómo</strong> (el método). Incluye estos 4 elementos:
                        </p>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card h-100 border-primary">
                                    <div class="card-header bg-primary text-white py-2">
                                        <strong>1. Resultados Deseados</strong>
                                    </div>
                                    <div class="card-body py-2">
                                        <p class="mb-1 fst-italic text-muted small">¿Qué se debe lograr?</p>
                                        <ul class="mb-0 small">
                                            <li>Describe el resultado final esperado</li>
                                            <li>Sé específico y medible</li>
                                            <li>No dictes el método, solo el objetivo</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100 border-warning">
                                    <div class="card-header bg-warning text-dark py-2">
                                        <strong>2. Directrices</strong>
                                    </div>
                                    <div class="card-body py-2">
                                        <p class="mb-1 fst-italic text-muted small">¿Qué límites debe respetar?</p>
                                        <ul class="mb-0 small">
                                            <li>Políticas institucionales aplicables</li>
                                            <li>Restricciones de tiempo o presupuesto</li>
                                            <li>Personas que debe (o no debe) involucrar</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100 border-success">
                                    <div class="card-header bg-success text-white py-2">
                                        <strong>3. Recursos Disponibles</strong>
                                    </div>
                                    <div class="card-body py-2">
                                        <p class="mb-1 fst-italic text-muted small">¿Con qué cuenta para lograrlo?</p>
                                        <ul class="mb-0 small">
                                            <li>Documentos o información relevante</li>
                                            <li>Personas de apoyo o contactos</li>
                                            <li>Herramientas, sistemas o presupuesto</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100 border-info">
                                    <div class="card-header bg-info text-dark py-2">
                                        <strong>4. Rendición de Cuentas</strong>
                                    </div>
                                    <div class="card-body py-2">
                                        <p class="mb-1 fst-italic text-muted small">¿Cómo se medirá el avance?</p>
                                        <ul class="mb-0 small">
                                            <li>Frecuencia de reportes de avance</li>
                                            <li>Indicadores de éxito</li>
                                            <li>Puntos de revisión intermedios</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-light border mt-3 mb-0">
                            <small>
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>Tip:</strong> Invertir 2 minutos en un buen contexto te ahorrará múltiples conversaciones de aclaración.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer py-2">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Entendido</button>
                    </div>
                </div>
            </div>
        </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase JS para Storage -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Quill.js Editor -->
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let tareasCache = [];
        let trabajadoresCache = [];
        // Variables para Quill editors
        let quillNuevaDescripcion = null;
        let quillNuevaContexto = null;
        let quillEditarContexto = null;
        let quillNuevaNota = null;
        
        // Variables para archivos
        let archivosNuevaTarea = [];
        let archivosNuevaNota = [];
        let supabaseClient = null;
        const BUCKET_NAME = 'tasks_docs';
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10 MB
        let categoriasCache = [];     // Cache de categorías activas
        let estudiantesCache = [];
        let colaboradoresCache = {};  // Objeto: {task_id: cantidad}
        let notasCache = {};          // Objeto: {task_id: cantidad}
        let colaboradoresNuevaTarea = []; // Array temporal para nueva tarea
        let misColaboraciones = []; // IDs de tareas donde el usuario actual es colaborador
        
        let currentUser = null;
        let userHasPermission = false;
        let userCanViewAll = false;
        
        let modalNuevaTarea = null;
        let modalEditarProgreso = null;
        let modalVerDetalle = null;
        let modalColaboradores = null;

        // ==========================================
        // SOPORTE PARA INTEGRACIÓN CON PROYECTOS
        // ==========================================
        function obtenerParametrosURL() {
            const params = new URLSearchParams(window.location.search);
            return {
                module: params.get('module'),      // 'projects', 'follow-ups', etc.
                ref: params.get('ref'),            // ID del proyecto u otro módulo
                action: params.get('action'),      // 'new' para abrir modal
                projectName: params.get('name')    // Nombre del proyecto (opcional, para mostrar)
            };
        }

        
        // ==========================================
        // INICIALIZACIÓN - PATRÓN OBLIGATORIO
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                // Obtener sesión
                const session = getStoredSession();
                if (!session || !session.user) {
                    console.log('❌ No hay sesión activa');
                    window.location.href = '../../login.html';
                    return;
                }
                
                currentUser = session.user;
                console.log('✅ Usuario autenticado:', currentUser.user_display_name);
                
                // Verificar permisos
                userHasPermission = await checkUserPermission(currentUser.user_id, 'Gestionar tareas');
                userCanViewAll = await checkUserPermission(currentUser.user_id, 'Ver todas las tareas');
                console.log('🔑 Permiso "Gestionar tareas":', userHasPermission);
                console.log('🔑 Permiso "Ver todas las tareas":', userCanViewAll);
                
                // Mostrar botón de nueva tarea solo si tiene permiso
                if (userHasPermission) {
                    document.getElementById('btn-nueva-tarea').style.display = 'inline-block';
                }
                
                // Inicializar página
                await inicializarPagina();
                
            } catch (error) {
                console.error('❌ Error en validación de acceso:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCIÓN DE INICIALIZACIÓN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Inicializar modales
                modalNuevaTarea = new bootstrap.Modal(document.getElementById('modal-nueva-tarea'));
                modalEditarProgreso = new bootstrap.Modal(document.getElementById('modal-editar-progreso'));
                modalVerDetalle = new bootstrap.Modal(document.getElementById('modal-ver-detalle'));
                modalColaboradores = new bootstrap.Modal(document.getElementById('modal-colaboradores'));
                // Inicializar cliente Supabase para Storage
                supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                
                // Inicializar editores Quill
                inicializarEditoresQuill();
                
                // Configurar event listeners
                configurarEventos();
                
                // Cargar datos iniciales
                await cargarCategorias();
                await cargarTrabajadores();
                await cargarTareas();

                // Aplicar filtros de URL si vienen de otro módulo
                const urlParams = obtenerParametrosURL();
                if (urlParams.module) {
                    document.getElementById('filter-module').value = urlParams.module;
                    aplicarFiltros();
                    
                    // Mostrar indicador de contexto
                    if (urlParams.projectName) {
                        showMessage(`Mostrando tareas del proyecto: ${urlParams.projectName}`, 'info');
                    }
                }
                
                // Abrir modal si viene action=new
                if (urlParams.action === 'new' && userHasPermission) {
                    abrirModalNuevaTarea();
                }
                
                // Mostrar botón volver si viene de proyecto
                if (urlParams.module === 'projects' && urlParams.ref) {
                    document.getElementById('link-volver-proyecto').innerHTML = `
                        <a href="project-detail.html?id=${urlParams.ref}" class="btn btn-outline-info">
                            <i class="bi bi-arrow-left me-1"></i>Volver al Proyecto
                        </a>
                    `;
                }
                
                ocultarLoading();
                console.log('✅ Página inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CONFIGURACIÓN DE EVENTOS
        // ==========================================
        function configurarEventos() {
            // Formulario nueva tarea
            document.getElementById('form-nueva-tarea').addEventListener('submit', manejarCrearTarea);
            
            // Formulario editar progreso
            document.getElementById('form-editar-progreso').addEventListener('submit', manejarEditarProgreso);
            
            // Filtros
            document.getElementById('filter-status').addEventListener('change', aplicarFiltros);
            document.getElementById('filter-priority').addEventListener('change', aplicarFiltros);
            document.getElementById('filter-module').addEventListener('change', aplicarFiltros);
            document.getElementById('filter-search').addEventListener('input', aplicarFiltros);
            document.getElementById('filter-responsable').addEventListener('change', aplicarFiltros);
            document.getElementById('filter-category').addEventListener('change', aplicarFiltros);
            document.getElementById('filter-order').addEventListener('change', aplicarFiltros);
            
            // Validar fecha mínima al abrir modal
            document.getElementById('modal-nueva-tarea').addEventListener('show.bs.modal', function() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('nueva-fecha-limite').setAttribute('min', today);
            });
            
            // Actualizar dropdown de colaboradores cuando cambia el responsable
            document.getElementById('nueva-asignada-a').addEventListener('change', function() {
                actualizarDropdownColaboradoresNueva();
            });
            
            console.log('✅ Event listeners configurados');
        }
        
        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        async function cargarTrabajadores() {
            try {
                console.log('📡 Cargando trabajadores activos...');
                const data = await supabaseRequest('/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,email&worker_status=eq.active&order=worker_last_name_1.asc,worker_last_name_2.asc,worker_first_name.asc');
                
                trabajadoresCache = data || [];
                
                // Llenar dropdown de nueva tarea
                const select = document.getElementById('nueva-asignada-a');
                select.innerHTML = '<option value="">Seleccione un trabajador...</option>';
                
                trabajadoresCache.forEach(worker => {
                    const nombreCompleto = `${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}, ${worker.worker_first_name}`.trim();
                    const option = document.createElement('option');
                    option.value = worker.email;
                    option.textContent = nombreCompleto;
                    option.dataset.workerId = worker.worker_id;
                    option.dataset.workerName = nombreCompleto;
                    select.appendChild(option);
                });
                
                console.log(`✅ ${trabajadoresCache.length} trabajadores cargados`);
                
            } catch (error) {
                console.error('❌ Error cargando trabajadores:', error);
                showMessage('Error al cargar trabajadores: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // CARGA DE CATEGORÍAS
        // ==========================================
        async function cargarCategorias() {
            try {
                console.log('📡 Cargando categorías activas...');
                const data = await supabaseRequest(
                    '/indicator_categories?select=category_id,category_name,category_icon,category_color,category_order&is_active=eq.true&order=category_order.asc'
                );
                
                categoriasCache = data || [];
                
                // Llenar dropdown en modal de nueva tarea
                llenarDropdownCategorias('nueva-categoria', true);
                
                console.log(`✅ ${categoriasCache.length} categorías cargadas`);
                
            } catch (error) {
                console.error('❌ Error cargando categorías:', error);
            }
        }
        
        // Llenar un dropdown de categorías
        function llenarDropdownCategorias(selectId, incluirVacio = true) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = incluirVacio 
                ? '<option value="">Sin categoría</option>' 
                : '';
            
            categoriasCache.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.category_id;
                option.dataset.icon = cat.category_icon;
                option.dataset.color = cat.category_color;
                option.textContent = cat.category_name;
                select.appendChild(option);
            });
        }
        
        // Obtener HTML del badge de categoría
        function getCategoryBadgeHtml(categoryId) {
            if (!categoryId) return '';
            
            const categoria = categoriasCache.find(c => c.category_id === categoryId);
            if (!categoria) return '';
            
            return `
                <span class="badge badge-category" style="background-color: ${categoria.category_color}20; color: ${categoria.category_color}; border: 1px solid ${categoria.category_color}40;">
                    <i class="bi bi-${categoria.category_icon}"></i>
                    ${escapeHtml(categoria.category_name)}
                </span>
            `;
        }
        
        // Llenar dropdown de colaboradores (excluyendo al responsable y colaboradores existentes)
        function llenarDropdownColaboradores(excludeEmail, colaboradoresExistentes = []) {
            const select = document.getElementById('select-nuevo-colaborador');
            select.innerHTML = '<option value="">Seleccione un trabajador...</option>';
            
            const emailsExcluir = [excludeEmail, ...colaboradoresExistentes];
            
            trabajadoresCache.forEach(worker => {
                if (emailsExcluir.includes(worker.email)) return;
                
                const nombreCompleto = `${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}, ${worker.worker_first_name}`.trim();
                const option = document.createElement('option');
                option.value = worker.email;
                option.textContent = nombreCompleto;
                option.dataset.workerName = nombreCompleto;
                select.appendChild(option);
            });
        }

        // ==========================================
        // VERIFICAR SI USUARIO ESTÁ IMPLICADO EN TAREA
        // ==========================================
        function esImplicadoEnTarea(tarea) {
            const esCreador = tarea.created_by === currentUser.user_id;
            const esResponsable = tarea.assigned_to_mail === currentUser.user_mail;
            const esColaborador = misColaboraciones.includes(tarea.task_id);
            return esCreador || esResponsable || esColaborador;
        }

        // ==========================================
        // CARGAR COLABORACIONES DEL USUARIO ACTUAL
        // ==========================================
        async function cargarMisColaboraciones() {
            try {
                const colaboraciones = await supabaseRequest(
                    `/task_collaborators?select=task_id&worker_email=eq.${currentUser.user_mail}&collaborator_status=eq.active`
                );
                misColaboraciones = colaboraciones ? colaboraciones.map(c => c.task_id) : [];
                console.log(`📋 Usuario es colaborador en ${misColaboraciones.length} tareas`);
            } catch (error) {
                console.error('⚠️ Error cargando colaboraciones del usuario:', error);
                misColaboraciones = [];
            }
        }

        async function cargarTareas() {
            try {
                console.log('📡 Cargando tareas...');
                
                // Primero cargar las colaboraciones del usuario actual
                await cargarMisColaboraciones();
                
                let query = '/tasks?select=*,students!fk_tasks_student(student_first_name,student_last_name_1,student_last_name_2,courses(course_name)),indicator_categories(category_id,category_name,category_icon,category_color)&order=created_at.desc';
                
                // Si tiene permiso "Ver todas las tareas", cargar todas
                if (userCanViewAll) {
                    console.log('👁️ Usuario puede ver todas las tareas');
                    // No agregar filtro, trae todas
                } else {
                    // Solo tareas donde está implicado (creador o responsable)
                    // Las de colaborador se agregan después
                    query += `&or=(created_by.eq.${currentUser.user_id},assigned_to_mail.eq.${currentUser.user_mail})`;
                }
                
                const data = await supabaseRequest(query);
                tareasCache = data || [];
                
                // Si NO tiene "Ver todas", agregar tareas donde es colaborador
                if (!userCanViewAll) {
                    await cargarTareasComoColaborador();
                }
                
                // Cargar conteos de colaboradores y notas
                await cargarConteosTareas();
                
                console.log(`✅ ${tareasCache.length} tareas cargadas`);
                llenarFiltroResponsables();
                llenarFiltroCategorias();
                renderizarTareas(tareasCache);
                
            } catch (error) {
                console.error('❌ Error cargando tareas:', error);
                showMessage('Error al cargar tareas: ' + error.message, 'danger');
                mostrarEstadoVacio('Error al cargar datos');
            }
        }
        
        function llenarFiltroResponsables() {
            const select = document.getElementById('filter-responsable');
            const valorActual = select.value; // Preservar selección actual
            
            // Obtener responsables únicos de las tareas cargadas
            const responsablesMap = new Map();
            
            tareasCache.forEach(tarea => {
                if (tarea.assigned_to_mail && !responsablesMap.has(tarea.assigned_to_mail)) {
                    responsablesMap.set(tarea.assigned_to_mail, {
                        email: tarea.assigned_to_mail,
                        nombre: tarea.assigned_to_name || tarea.assigned_to_mail
                    });
                }
            });
            
            // Convertir a array y ordenar por nombre
            const responsables = Array.from(responsablesMap.values())
                .sort((a, b) => a.nombre.localeCompare(b.nombre));
            
            // Reconstruir el select
            select.innerHTML = '<option value="">Todos los responsables</option>';
            
            responsables.forEach(resp => {
                const option = document.createElement('option');
                option.value = resp.email;
                option.textContent = resp.nombre;
                select.appendChild(option);
            });
            
            // Restaurar selección si aún existe
            if (valorActual && responsablesMap.has(valorActual)) {
                select.value = valorActual;
            }
        }

        function llenarFiltroCategorias() {
            const select = document.getElementById('filter-category');
            if (!select) return;
            
            select.innerHTML = '<option value="">Todas las categorías</option>';
            
            categoriasCache.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.category_id;
                option.textContent = cat.category_name;
                select.appendChild(option);
            });
        }

        async function cargarTareasComoColaborador() {
            try {
                if (misColaboraciones.length === 0) return;
                
                // Filtrar solo las que no están ya en cache
                const tareasExistentes = new Set(tareasCache.map(t => t.task_id));
                const taskIdsNuevos = misColaboraciones.filter(id => !tareasExistentes.has(id));
                
                if (taskIdsNuevos.length === 0) return;
                
                const tareasColaborador = await supabaseRequest(
                    `/tasks?select=*,students(student_first_name,student_last_name_1,student_last_name_2,courses(course_name)),indicator_categories(category_id,category_name,category_icon,category_color)&task_id=in.(${taskIdsNuevos.join(',')})`
                );
                
                if (tareasColaborador && tareasColaborador.length > 0) {
                    tareasCache = [...tareasCache, ...tareasColaborador];
                    console.log(`📋 ${tareasColaborador.length} tareas adicionales como colaborador`);
                }
                
            } catch (error) {
                console.error('⚠️ Error cargando tareas como colaborador:', error);
            }
        }
 
        
        async function cargarConteosTareas() {
            try {
                const taskIds = tareasCache.map(t => t.task_id);
                if (taskIds.length === 0) return;
                
                const colaboradores = await supabaseRequest(
                    `/task_collaborators?select=task_id,collaborator_id&collaborator_status=eq.active&task_id=in.(${taskIds.join(',')})`
                );
                
                const notas = await supabaseRequest(
                    `/task_progress_notes?select=task_id,note_id&is_visible=eq.true&task_id=in.(${taskIds.join(',')})`
                );
                
                colaboradoresCache = {};
                notasCache = {};
                
                if (colaboradores) {
                    colaboradores.forEach(c => {
                        if (!colaboradoresCache[c.task_id]) colaboradoresCache[c.task_id] = 0;
                        colaboradoresCache[c.task_id]++;
                    });
                }
                
                if (notas) {
                    notas.forEach(n => {
                        if (!notasCache[n.task_id]) notasCache[n.task_id] = 0;
                        notasCache[n.task_id]++;
                    });
                }
                
            } catch (error) {
                console.error('⚠️ Error cargando conteos:', error);
            }
        }
        
        // ==========================================
        // RENDERIZADO DE TAREAS
        // ==========================================
        function renderizarTareas(tareas) {
            const container = document.getElementById('tasks-container');
            
            if (!tareas || tareas.length === 0) {
                mostrarEstadoVacio('No hay tareas disponibles');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let html = '';
            
            tareas.forEach(tarea => {
                const dueDate = new Date(tarea.due_date);
                const isOverdue = tarea.task_state !== 'Terminada' && tarea.task_state !== 'Cancelada' && dueDate < today;
                
                const priorityClass = `priority-${tarea.task_priority || 'normal'}`;
                const overdueClass = isOverdue ? 'overdue' : '';
                
                const studentName = tarea.students 
                    ? `${tarea.students.student_first_name} ${tarea.students.student_last_name_1} ${tarea.students.student_last_name_2 || ''}`.trim()
                    : 'Sin estudiante';
                
                const courseName = tarea.students?.courses?.course_name || '';
                
                const moduleNames = {
                    'follow-ups': 'Seguimientos',
                    'early-alerts': 'Alertas Tempranas',
                    'general-tools': 'Herramientas Generales'
                };
                
                const statusBadgeClass = {
                    'Asignada': 'badge-status-assigned',
                    'En Progreso': 'badge-status-progress',
                    'Terminada': 'badge-status-completed',
                    'Cancelada': 'badge-status-cancelled'
                };
                
                const priorityBadgeClass = {
                    'Alta': 'badge-priority-Alta',
                    'Normal': 'badge-priority-Normal',
                    'Baja': 'badge-priority-Baja'
                };
                
                const esResponsable = tarea.assigned_to_mail === currentUser.user_mail;
                const esCreador = tarea.created_by === currentUser.user_id;
                const esColaborador = misColaboraciones.includes(tarea.task_id);
                const estaImplicado = esCreador || esResponsable || esColaborador;
                
                // Determinar permisos de edición
                // - Solo puede editar si está implicado en la tarea
                // - "Ver todas las tareas" NO da permiso de edición
                const canEdit = estaImplicado;
                const canManageCollaborators = esResponsable || esCreador;
                const canAddProgress = estaImplicado;
                
                const numColaboradores = colaboradoresCache[tarea.task_id] || 0;
                const numNotas = notasCache[tarea.task_id] || 0;
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card task-card ${priorityClass} ${overdueClass} h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="badge ${priorityBadgeClass[tarea.task_priority] || 'badge-priority-Normal'}">
                                        ${escapeHtml(tarea.task_priority || 'Normal')}
                                    </span>
                                    <span class="badge ${statusBadgeClass[tarea.task_state] || 'bg-secondary'}">
                                        ${escapeHtml(tarea.task_state || 'Asignada')}
                                    </span>
                                </div>
                                
                                <span class="badge bg-info text-dark mb-2">
                                    ${moduleNames[tarea.module_type] || tarea.module_type}
                                </span>
                                ${tarea.category_id ? getCategoryBadgeHtml(tarea.category_id) : ''}
                                
                                <h6 class="card-title mt-2">
                                    ${escapeHtml(stripHtml(tarea.task_description)?.substring(0, 80) || '')}${stripHtml(tarea.task_description)?.length > 80 ? '...' : ''}
                                    </h6>
                                
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-person-check me-1"></i>
                                        <strong>Responsable:</strong> ${escapeHtml(tarea.assigned_to_name || tarea.assigned_to_mail || 'N/A')}
                                    </small>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-mortarboard me-1"></i>
                                        <strong>Estudiante:</strong> ${escapeHtml(studentName)}
                                        ${courseName ? `<span class="badge bg-light text-dark ms-1">${escapeHtml(courseName)}</span>` : ''}
                                    </small>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="${isOverdue ? 'text-danger fw-bold' : 'text-muted'}">
                                        <i class="bi bi-calendar-event me-1"></i>
                                        <strong>Fecha límite:</strong> ${formatDate(tarea.due_date)}
                                        ${isOverdue ? '<span class="badge bg-danger ms-1">VENCIDA</span>' : ''}
                                    </small>
                                </div>
                                
                                <!-- Badges de colaboradores y notas -->
                                <div class="mb-2 d-flex gap-2">
                                    ${numColaboradores > 0 ? `
                                        <span class="badge bg-primary" title="Colaboradores">
                                            <i class="bi bi-people me-1"></i>${numColaboradores}
                                        </span>
                                    ` : ''}
                                    ${numNotas > 0 ? `
                                        <span class="badge bg-secondary" title="Notas de progreso">
                                            <i class="bi bi-journal-text me-1"></i>${numNotas}
                                        </span>
                                    ` : ''}
                                </div>
                                
                                ${tarea.task_progress ? `
                                    <div class="mb-2">
                                        <small class="text-muted">
                                            <i class="bi bi-card-text me-1"></i>
                                            <strong>Contexto:</strong> ${escapeHtml(stripHtml(tarea.task_progress).substring(0, 50))}${stripHtml(tarea.task_progress).length > 50 ? '...' : ''}
                                        </small>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="card-footer bg-transparent">
                                <div class="btn-group btn-group-sm w-100" role="group">
                                    <button class="btn btn-outline-primary" onclick="verDetalle(${tarea.task_id})" title="Ver detalle">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    ${canManageCollaborators && tarea.task_state !== 'Terminada' && tarea.task_state !== 'Cancelada' ? `
                                        <button class="btn btn-outline-info" onclick="gestionarColaboradores(${tarea.task_id})" title="Colaboradores">
                                            <i class="bi bi-people"></i>
                                        </button>
                                    ` : ''}
                                    ${canAddProgress && tarea.task_state !== 'Terminada' && tarea.task_state !== 'Cancelada' ? `
                                        <button class="btn btn-outline-success" onclick="editarProgreso(${tarea.task_id})" title="Editar progreso">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    ` : ''}
                                    ${canEdit && tarea.task_state !== 'Terminada' && tarea.task_state !== 'Cancelada' ? `
                                        <button class="btn btn-outline-warning" onclick="cerrarTarea(${tarea.task_id})" title="Cerrar tarea">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                    ` : ''}
                                    ${canEdit && tarea.task_state !== 'Cancelada' && tarea.task_state !== 'Terminada' ? `
                                        <button class="btn btn-outline-danger" onclick="cancelarTarea(${tarea.task_id})" title="Cancelar">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function mostrarEstadoVacio(mensaje) {
            const container = document.getElementById('tasks-container');
            container.innerHTML = `
                <div class="col-12">
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <h5>${mensaje}</h5>
                        <p class="text-muted">No se encontraron tareas con los filtros aplicados</p>
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // FILTROS
        // ==========================================
        function aplicarFiltros() {
            const statusFilter = document.getElementById('filter-status').value;
            const priorityFilter = document.getElementById('filter-priority').value;
            const moduleFilter = document.getElementById('filter-module').value;
            const responsableFilter = document.getElementById('filter-responsable').value;
            const categoryFilter = document.getElementById('filter-category').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();
            const orderFilter = document.getElementById('filter-order').value;
            
            let tareasFiltradas = tareasCache.filter(tarea => {
                const matchStatus = !statusFilter || tarea.task_state === statusFilter;
                const matchPriority = !priorityFilter || tarea.task_priority === priorityFilter;
                const matchModule = !moduleFilter || tarea.module_type === moduleFilter;
                const matchResponsable = !responsableFilter || tarea.assigned_to_mail === responsableFilter;
                const matchCategory = !categoryFilter || tarea.category_id === categoryFilter;
                const matchSearch = !searchFilter || tarea.task_description?.toLowerCase().includes(searchFilter);
                
                return matchStatus && matchPriority && matchModule && matchResponsable && matchCategory && matchSearch;
            });
            
            // Aplicar ordenamiento
            tareasFiltradas = ordenarTareas(tareasFiltradas, orderFilter);
            
            renderizarTareas(tareasFiltradas);
        }

        function ordenarTareas(tareas, criterio) {
            const prioridadValor = { 'Alta': 3, 'Normal': 2, 'Baja': 1 };
            
            return [...tareas].sort((a, b) => {
                switch (criterio) {
                    case 'created_desc':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'created_asc':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'due_asc':
                        return new Date(a.due_date) - new Date(b.due_date);
                    case 'due_desc':
                        return new Date(b.due_date) - new Date(a.due_date);
                    case 'priority_desc':
                        return (prioridadValor[b.task_priority] || 2) - (prioridadValor[a.task_priority] || 2);
                    case 'priority_asc':
                        return (prioridadValor[a.task_priority] || 2) - (prioridadValor[b.task_priority] || 2);
                    default:
                        return new Date(b.created_at) - new Date(a.created_at);
                }
            });
        }
        
        function limpiarFiltros() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-priority').value = '';
            document.getElementById('filter-module').value = '';
            document.getElementById('filter-responsable').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-search').value = '';
            document.getElementById('filter-order').value = 'created_desc';
            renderizarTareas(tareasCache);
            
            // AGREGAR: Limpiar parámetros de URL
            if (window.location.search) {
                window.history.replaceState({}, '', window.location.pathname);
            }
        }
        
        // ==========================================
        // MODAL NUEVA TAREA
        // ==========================================
        function abrirModalNuevaTarea() {
            document.getElementById('form-nueva-tarea').reset();
            // Limpiar editores Quill
            if (quillNuevaDescripcion) quillNuevaDescripcion.setContents([]);
            if (quillNuevaContexto) quillNuevaContexto.setContents([]);
            
            // Limpiar archivos
            archivosNuevaTarea = [];
            renderizarArchivosNuevaTarea();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('nueva-fecha-limite').setAttribute('min', today);
            
            // Limpiar colaboradores
            colaboradoresNuevaTarea = [];
            actualizarListaColaboradoresNueva();
            actualizarDropdownColaboradoresNueva();
            
            // PRE-LLENAR SI VIENE DE UN PROYECTO
            const urlParams = obtenerParametrosURL();
            if (urlParams.module && urlParams.ref) {
                // Guardar en campos ocultos para usar al crear
                if (!document.getElementById('nueva-module-type')) {
                    // Crear campos ocultos si no existen
                    const form = document.getElementById('form-nueva-tarea');
                    form.insertAdjacentHTML('beforeend', `
                        <input type="hidden" id="nueva-module-type" name="module_type" value="">
                        <input type="hidden" id="nueva-reference-id" name="reference_id" value="">
                    `);
                }
                document.getElementById('nueva-module-type').value = urlParams.module;
                document.getElementById('nueva-reference-id').value = urlParams.ref;
                
                // Mostrar indicador visual
                if (urlParams.projectName) {
                    const modalTitle = document.getElementById('modalNuevaTareaLabel');
                    modalTitle.innerHTML = `
                        <i class="bi bi-plus-circle me-2"></i>Nueva Tarea
                        <span class="badge bg-info ms-2">${escapeHtml(urlParams.projectName)}</span>
                    `;
                }
            }
            
            modalNuevaTarea.show();
        }
        
        // Actualizar dropdown de colaboradores cuando cambia el responsable
        function actualizarDropdownColaboradoresNueva() {
            const responsableEmail = document.getElementById('nueva-asignada-a').value;
            const select = document.getElementById('select-colaborador-nueva');
            select.innerHTML = '<option value="">Seleccione un trabajador...</option>';
            
            // Emails a excluir: responsable + colaboradores ya agregados
            const emailsExcluir = [responsableEmail, ...colaboradoresNuevaTarea.map(c => c.email)];
            
            trabajadoresCache.forEach(worker => {
                if (emailsExcluir.includes(worker.email)) return;
                
                const nombreCompleto = `${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}, ${worker.worker_first_name}`.trim();
                const option = document.createElement('option');
                option.value = worker.email;
                option.textContent = nombreCompleto;
                option.dataset.workerName = nombreCompleto;
                select.appendChild(option);
            });
        }
        
        // Agregar colaborador a la lista temporal
        function agregarColaboradorNuevaTarea() {
            const select = document.getElementById('select-colaborador-nueva');
            if (!select.value) {
                showMessage('Selecciona un trabajador para agregar', 'warning');
                return;
            }
            
            const email = select.value;
            const nombre = select.selectedOptions[0].dataset.workerName;
            
            // Verificar que no esté ya agregado
            if (colaboradoresNuevaTarea.find(c => c.email === email)) {
                showMessage('Este colaborador ya fue agregado', 'warning');
                return;
            }
            
            colaboradoresNuevaTarea.push({ email, nombre });
            actualizarListaColaboradoresNueva();
            actualizarDropdownColaboradoresNueva();
        }
        
        // Quitar colaborador de la lista temporal
        function quitarColaboradorNuevaTarea(email) {
            colaboradoresNuevaTarea = colaboradoresNuevaTarea.filter(c => c.email !== email);
            actualizarListaColaboradoresNueva();
            actualizarDropdownColaboradoresNueva();
        }
        
        // Renderizar lista de colaboradores en modal nueva tarea
        function actualizarListaColaboradoresNueva() {
            const container = document.getElementById('lista-colaboradores-nueva');
            const badge = document.getElementById('badge-colaboradores-nueva');
            const msgVacio = document.getElementById('sin-colaboradores-msg');
            
            badge.textContent = colaboradoresNuevaTarea.length;
            
            if (colaboradoresNuevaTarea.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-2" id="sin-colaboradores-msg"><small>No se han agregado colaboradores</small></div>';
                return;
            }
            
            let html = '';
            colaboradoresNuevaTarea.forEach(colab => {
                const iniciales = obtenerIniciales(colab.nombre);
                html += `
                    <div class="collaborator-item">
                        <div class="collaborator-info">
                            <div class="collaborator-avatar">${iniciales}</div>
                            <div>
                                <div class="small fw-semibold">${escapeHtml(colab.nombre)}</div>
                                <small class="text-muted">${escapeHtml(colab.email)}</small>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="quitarColaboradorNuevaTarea('${colab.email}')" title="Quitar">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // ==========================================
        // PLANTILLAS DE EMAIL
        // ==========================================
        function getTaskAssignmentEmailTemplate(taskDescription, dueDate, priority, assignedBy) {
            const priorityColors = { 'Alta': '#dc3545', 'Normal': '#0d6efd', 'Baja': '#6c757d' };
            const priorityColor = priorityColors[priority] || '#0d6efd';
            const dueDateFormatted = formatDate(dueDate);
            
            return `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
                    <div style="background-color: ${priorityColor}; color: white; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <h2 style="margin: 0; font-size: 20px;">Nueva tarea asignada</h2>
                        <p style="margin: 5px 0 0 0; font-size: 14px;">SchoolNet - Sistema de Gestión Educativa</p>
                    </div>
                    <div style="background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <p style="margin-top: 0;">Se te ha asignado una nueva tarea:</p>
                        <div style="background-color: #f8f9fa; padding: 15px; border-left: 4px solid ${priorityColor}; margin: 20px 0;">
                            <p style="margin: 0; font-size: 16px; font-weight: bold;">${escapeHtml(taskDescription)}</p>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <tr><td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold; width: 40%;">Prioridad:</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;"><span style="background-color: ${priorityColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">${escapeHtml(priority)}</span></td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold;">Fecha límite:</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${dueDateFormatted}</td></tr>
                            <tr><td style="padding: 10px; font-weight: bold;">Asignada por:</td>
                                <td style="padding: 10px;">${escapeHtml(assignedBy)}</td></tr>
                        </table>
                        <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 15px; margin: 20px 0;">
                            <p style="margin: 0; color: #0c5460;"><strong>Recuerda:</strong> Ingresa al sistema SchoolNet para gestionar esta tarea y documentar tu progreso.</p>
                        </div>
                    </div>
                    <hr style="margin: 30px 0; border: none; border-top: 1px solid #dee2e6;">
                    <p style="color: #6c757d; font-size: 12px; margin: 0; text-align: center;">Este correo es generado automáticamente por SchoolNet. Por favor, no responder a este mensaje.<br>Colegio Tilata - Sistema de Gestión Educativa</p>
                </div>
            `;
        }

        function getCollaboratorEmailTemplate(taskDescription, dueDate, priority, responsable, addedBy) {
            const priorityColors = { 'Alta': '#dc3545', 'Normal': '#0d6efd', 'Baja': '#6c757d' };
            const priorityColor = priorityColors[priority] || '#0d6efd';
            const dueDateFormatted = formatDate(dueDate);
            
            return `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
                    <div style="background-color: #17a2b8; color: white; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <h2 style="margin: 0; font-size: 20px;">Has sido agregado como colaborador</h2>
                        <p style="margin: 5px 0 0 0; font-size: 14px;">SchoolNet - Sistema de Gestión Educativa</p>
                    </div>
                    <div style="background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <p style="margin-top: 0;">Has sido agregado como colaborador en la siguiente tarea:</p>
                        <div style="background-color: #f8f9fa; padding: 15px; border-left: 4px solid ${priorityColor}; margin: 20px 0;">
                            <p style="margin: 0; font-size: 16px; font-weight: bold;">${escapeHtml(taskDescription)}</p>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <tr><td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold; width: 40%;">Responsable principal:</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${escapeHtml(responsable)}</td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold;">Prioridad:</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;"><span style="background-color: ${priorityColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">${escapeHtml(priority)}</span></td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold;">Fecha límite:</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${dueDateFormatted}</td></tr>
                            <tr><td style="padding: 10px; font-weight: bold;">Agregado por:</td>
                                <td style="padding: 10px;">${escapeHtml(addedBy)}</td></tr>
                        </table>
                        <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 15px; margin: 20px 0;">
                            <p style="margin: 0; color: #0c5460;"><strong>Como colaborador puedes:</strong><br>• Ver toda la información de la tarea<br>• Agregar notas de progreso<br><br>Ingresa al sistema SchoolNet para participar en esta tarea.</p>
                        </div>
                    </div>
                    <hr style="margin: 30px 0; border: none; border-top: 1px solid #dee2e6;">
                    <p style="color: #6c757d; font-size: 12px; margin: 0; text-align: center;">Este correo es generado automáticamente por SchoolNet. Por favor, no responder a este mensaje.<br>Colegio Tilata - Sistema de Gestión Educativa</p>
                </div>
            `;
        }

        // ==========================================
        // ENVIAR NOTIFICACIONES
        // ==========================================
        async function enviarNotificacionTarea(workerEmail, taskDescription, dueDate, priority, assignedBy) {
            try {
                console.log('📧 Enviando notificación de tarea a:', workerEmail);
                const subject = 'Nueva tarea asignada';
                const htmlContent = getTaskAssignmentEmailTemplate(taskDescription, dueDate, priority, assignedBy);
                const result = await sendNotification(workerEmail, subject, htmlContent, true);
                if (result) { console.log('✅ Notificación enviada exitosamente'); return true; }
                else { console.warn('⚠️ No se pudo enviar la notificación'); return false; }
            } catch (error) { console.error('❌ Error enviando notificación:', error); return false; }
        }
        
        async function enviarNotificacionColaborador(workerEmail, taskDescription, dueDate, priority, responsable, addedBy) {
            try {
                console.log('📧 Enviando notificación de colaborador a:', workerEmail);
                const subject = 'Has sido agregado como colaborador en una tarea';
                const htmlContent = getCollaboratorEmailTemplate(taskDescription, dueDate, priority, responsable, addedBy);
                const result = await sendNotification(workerEmail, subject, htmlContent, true);
                if (result) { console.log('✅ Notificación de colaborador enviada'); return true; }
                else { console.warn('⚠️ No se pudo enviar notificación de colaborador'); return false; }
            } catch (error) { console.error('❌ Error enviando notificación de colaborador:', error); return false; }
        }
        
        async function manejarCrearTarea(e) {
            e.preventDefault();
            try {
                mostrarLoading();
                const formData = new FormData(e.target);
                const selectedWorker = document.getElementById('nueva-asignada-a').selectedOptions[0];
                
                const datos = {
                    task_description: quillNuevaDescripcion ? quillNuevaDescripcion.root.innerHTML : '',    
                    assigned_to_mail: formData.get('assigned_to_mail'),
                    assigned_to_name: selectedWorker.dataset.workerName,
                    student_id: null,
                    due_date: formData.get('due_date'),
                    task_priority: formData.get('task_priority'),
                    task_progress: quillNuevaContexto && quillNuevaContexto.getText().trim() ? quillNuevaContexto.root.innerHTML : null,
                    task_state: 'Asignada',
                    category_id: formData.get('category_id') || null,
                    created_by: currentUser.user_id,
                    // AGREGAR ESTAS DOS LÍNEAS:
                    module_type: formData.get('module_type') || 'general-tools',
                    reference_id: formData.get('reference_id') || null
                };
                
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const selectedDate = new Date(datos.due_date);
                if (selectedDate < today) { showMessage('La fecha límite no puede ser anterior a hoy', 'warning'); ocultarLoading(); return; }
                
                // Crear la tarea
                await supabaseRequest('/tasks', { 
                    method: 'POST', 
                    body: JSON.stringify(datos)
                });

                // Subir archivos si hay
                if (archivosNuevaTarea.length > 0) {
                    // Buscar el task_id de la tarea recién creada
                    const tareasRecientes = await supabaseRequest(
                        `/tasks?select=task_id&created_by=eq.${currentUser.user_id}&order=created_at.desc&limit=1`
                    );
                    
                    if (tareasRecientes && tareasRecientes[0]) {
                        await subirArchivos(tareasRecientes[0].task_id, null);
                    }
                }
                
                // Enviar notificación al responsable principal
                const emailSent = await enviarNotificacionTarea(datos.assigned_to_mail, datos.task_description, datos.due_date, datos.task_priority, currentUser.user_display_name || currentUser.user_mail);
                
                // Si hay colaboradores, buscar el task_id de la tarea recién creada
                let colaboradoresCreados = 0;
                let colaboradoresNotificados = 0;
                
                if (colaboradoresNuevaTarea.length > 0) {
                    // Buscar la tarea recién creada
                    const tareasRecientes = await supabaseRequest(
                        `/tasks?select=task_id&task_description=eq.${encodeURIComponent(datos.task_description)}&created_by=eq.${currentUser.user_id}&order=created_at.desc&limit=1`
                    );
                    
                    const taskId = tareasRecientes && tareasRecientes[0] ? tareasRecientes[0].task_id : null;
                    
                    if (taskId) {
                        for (const colab of colaboradoresNuevaTarea) {
                            try {
                                await supabaseRequest('/task_collaborators', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        task_id: taskId,
                                        worker_email: colab.email,
                                        worker_name: colab.nombre,
                                        added_by: currentUser.user_id,
                                        added_by_name: currentUser.user_display_name || currentUser.user_mail,
                                        collaborator_status: 'active'
                                    })
                                });
                                colaboradoresCreados++;
                                
                                // Enviar notificación al colaborador
                                const notifColab = await enviarNotificacionColaborador(
                                    colab.email, 
                                    datos.task_description, 
                                    datos.due_date, 
                                    datos.task_priority, 
                                    datos.assigned_to_name, 
                                    currentUser.user_display_name || currentUser.user_mail
                                );
                                if (notifColab) colaboradoresNotificados++;
                                
                            } catch (err) {
                                console.error('Error creando colaborador:', colab.email, err);
                            }
                        }
                    } else {
                        console.warn('No se pudo obtener task_id para agregar colaboradores');
                    }
                }
                
                // Mensaje según resultados
                let mensaje = 'Tarea creada';
                if (emailSent) mensaje += ' y responsable notificado';
                if (colaboradoresCreados > 0) {
                    mensaje += `. ${colaboradoresCreados} colaborador(es) agregado(s)`;
                    if (colaboradoresNotificados > 0) mensaje += ` y notificado(s)`;
                }
                
                showMessage(mensaje, 'success');
                
                // Limpiar colaboradores temporales
                colaboradoresNuevaTarea = [];
                
                modalNuevaTarea.hide();
                await cargarTareas();
            } catch (error) { console.error('❌ Error creando tarea:', error); showMessage('Error al crear tarea: ' + error.message, 'danger'); }
            finally { ocultarLoading(); }
        }

        // ==========================================
        // GESTIONAR COLABORADORES
        // ==========================================
        async function gestionarColaboradores(taskId) {
            const tarea = tareasCache.find(t => t.task_id === taskId);
            if (!tarea) { showMessage('Tarea no encontrada', 'danger'); return; }
            
            document.getElementById('colab-task-id').value = taskId;
            document.getElementById('colab-descripcion-tarea').textContent = tarea.task_description || 'Sin descripción';
            
            await cargarColaboradoresTarea(taskId);
            modalColaboradores.show();
        }
        
        async function cargarColaboradoresTarea(taskId) {
            try {
                const tarea = tareasCache.find(t => t.task_id == taskId);
                const colaboradores = await supabaseRequest(`/task_collaborators?select=*&task_id=eq.${taskId}&collaborator_status=eq.active&order=added_at.asc`);
                
                const container = document.getElementById('lista-colaboradores');
                const badge = document.getElementById('badge-total-colaboradores');
                
                // Actualizar dropdown excluyendo colaboradores existentes
                const emailsColaboradores = colaboradores ? colaboradores.map(c => c.worker_email) : [];
                llenarDropdownColaboradores(tarea?.assigned_to_mail, emailsColaboradores);
                
                if (!colaboradores || colaboradores.length === 0) {
                    container.innerHTML = `<div class="text-center text-muted py-4"><i class="bi bi-people" style="font-size: 2rem;"></i><p class="mb-0 mt-2">No hay colaboradores en esta tarea</p></div>`;
                    badge.textContent = '0';
                    return;
                }
                
                badge.textContent = colaboradores.length;
                
                let html = '';
                colaboradores.forEach(colab => {
                    const iniciales = obtenerIniciales(colab.worker_name);
                    html += `
                        <div class="collaborator-item">
                            <div class="collaborator-info">
                                <div class="collaborator-avatar">${iniciales}</div>
                                <div>
                                    <div class="fw-semibold">${escapeHtml(colab.worker_name)}</div>
                                    <small class="text-muted">${escapeHtml(colab.worker_email)}</small>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removerColaborador('${colab.collaborator_id}')" title="Remover colaborador">
                                <i class="bi bi-person-x"></i>
                            </button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) { console.error('❌ Error cargando colaboradores:', error); showMessage('Error al cargar colaboradores', 'danger'); }
        }
        
        async function agregarColaborador() {
            const select = document.getElementById('select-nuevo-colaborador');
            const taskId = document.getElementById('colab-task-id').value;
            
            if (!select.value) { showMessage('Selecciona un trabajador para agregar', 'warning'); return; }
            
            const tarea = tareasCache.find(t => t.task_id == taskId);
            if (!tarea) { showMessage('Tarea no encontrada', 'danger'); return; }
            
            const workerEmail = select.value;
            const workerName = select.selectedOptions[0].dataset.workerName;
            
            try {
                mostrarLoading();
                await supabaseRequest('/task_collaborators', {
                    method: 'POST',
                    body: JSON.stringify({
                        task_id: parseInt(taskId),
                        worker_email: workerEmail,
                        worker_name: workerName,
                        added_by: currentUser.user_id,
                        added_by_name: currentUser.user_display_name || currentUser.user_mail,
                        collaborator_status: 'active'
                    })
                });
                
                const emailSent = await enviarNotificacionColaborador(workerEmail, tarea.task_description, tarea.due_date, tarea.task_priority, tarea.assigned_to_name || tarea.assigned_to_mail, currentUser.user_display_name || currentUser.user_mail);
                
                if (emailSent) { showMessage('Colaborador agregado y notificado exitosamente', 'success'); }
                else { showMessage('Colaborador agregado, pero no se pudo enviar notificación', 'warning'); }
                
                await cargarColaboradoresTarea(taskId);
                if (!colaboradoresCache[taskId]) colaboradoresCache[taskId] = 0;
                colaboradoresCache[taskId]++;
            } catch (error) { console.error('❌ Error agregando colaborador:', error); showMessage('Error al agregar colaborador: ' + error.message, 'danger'); }
            finally { ocultarLoading(); }
        }
        
        async function removerColaborador(collaboratorId) {
            if (!confirm('¿Estás seguro de remover a este colaborador?')) return;
            
            const taskId = document.getElementById('colab-task-id').value;
            try {
                mostrarLoading();
                await supabaseRequest(`/task_collaborators?collaborator_id=eq.${collaboratorId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ collaborator_status: 'removed', removed_at: new Date().toISOString(), removed_by: currentUser.user_id })
                });
                showMessage('Colaborador removido exitosamente', 'success');
                await cargarColaboradoresTarea(taskId);
                if (colaboradoresCache[taskId] > 0) colaboradoresCache[taskId]--;
            } catch (error) { console.error('❌ Error removiendo colaborador:', error); showMessage('Error al remover colaborador: ' + error.message, 'danger'); }
            finally { ocultarLoading(); }
        }

        // ==========================================
        // EDITAR PROGRESO
        // ==========================================
        async function editarProgreso(taskId) {
            const tarea = tareasCache.find(t => t.task_id === taskId);
            if (!tarea) { showMessage('Tarea no encontrada', 'danger'); return; }
            
            document.getElementById('progreso-descripcion').textContent = tarea.task_description || 'N/A';
            document.getElementById('progreso-asignada').textContent = tarea.assigned_to_name || tarea.assigned_to_mail || 'N/A';
            document.getElementById('progreso-fecha').textContent = formatDate(tarea.due_date);
            document.getElementById('progreso-prioridad').textContent = tarea.task_priority || 'Normal';
            document.getElementById('progreso-estado').textContent = tarea.task_state || 'Asignada';
            
            const studentName = tarea.students ? `${tarea.students.student_first_name} ${tarea.students.student_last_name_1} ${tarea.students.student_last_name_2 || ''}`.trim() : 'Sin estudiante';
            document.getElementById('progreso-estudiante').textContent = studentName;
            
            // Cargar contenido en editor Quill
            if (quillEditarContexto) {
                if (tarea.task_progress) {
                    quillEditarContexto.root.innerHTML = tarea.task_progress;
                } else {
                    quillEditarContexto.setContents([]);
                }
            }
            document.getElementById('editar-estado').value = tarea.task_state || 'Asignada';
            document.getElementById('editar-task-id').value = tarea.task_id;
            // Limpiar editor de nueva nota
            if (quillNuevaNota) quillNuevaNota.setContents([]);
            
            // Limpiar archivos de nota
            archivosNuevaNota = [];
            renderizarArchivosNota();
            
            const esResponsable = tarea.assigned_to_mail === currentUser.user_mail || userHasPermission;
            const esCreador = tarea.created_by === currentUser.user_id;
            const esGeneralTools = tarea.module_type === 'general-tools';
            
            // Mostrar/ocultar sección de categoría (solo creador y solo general-tools)
            const seccionCategoria = document.getElementById('seccion-cambiar-categoria');
            if (esCreador && esGeneralTools) {
                seccionCategoria.style.display = 'block';
                llenarDropdownCategorias('editar-categoria', true);
                document.getElementById('editar-categoria').value = tarea.category_id || '';
            } else {
                seccionCategoria.style.display = 'none';
            }
            document.getElementById('seccion-contexto-general').style.display = esResponsable ? 'block' : 'none';
            document.getElementById('seccion-cambiar-estado').style.display = esResponsable ? 'block' : 'none';
            
            // Mostrar campo de fecha solo al creador
            const esCreadorTarea = tarea.created_by === currentUser.user_id;
            document.getElementById('seccion-cambiar-fecha').style.display = esCreadorTarea ? 'block' : 'none';
            if (esCreadorTarea) {
                document.getElementById('editar-fecha-limite').value = tarea.due_date || '';
                // Fecha mínima: hoy
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('editar-fecha-limite').setAttribute('min', today);
            }
            
            await cargarNotasProgreso(taskId);
            modalEditarProgreso.show();
        }
        
        async function cargarNotasProgreso(taskId) {
            try {
                const notas = await supabaseRequest(`/task_progress_notes?select=*&task_id=eq.${taskId}&is_visible=eq.true&order=note_date.desc`);
                const container = document.getElementById('historial-notas-progreso');
                const contador = document.getElementById('contador-notas-progreso');
                
                if (!notas || notas.length === 0) {
                    container.innerHTML = `<div class="text-center text-muted py-3"><i class="bi bi-journal-x"></i> No hay notas registradas</div>`;
                    contador.textContent = '0';
                    return;
                }
                
                contador.textContent = notas.length;
                let html = '';
                notas.forEach(nota => {
                    html += `<div class="note-item"><div class="note-header"><span class="note-author"><i class="bi bi-person-circle me-1"></i>${escapeHtml(nota.worker_name)}</span><span class="note-date"><i class="bi bi-clock me-1"></i>${formatDateTime(nota.note_date)}</span></div><div class="note-content html-content">${nota.note_content}</div></div>`;
                });
                container.innerHTML = html;
            } catch (error) { console.error('❌ Error cargando notas:', error); }
        }
        
        async function manejarEditarProgreso(e) {
            e.preventDefault();
            try {
                mostrarLoading();
                const taskId = document.getElementById('editar-task-id').value;
                const taskProgress = quillEditarContexto && quillEditarContexto.getText().trim() 
                    ? quillEditarContexto.root.innerHTML 
                    : '';
                const taskState = document.getElementById('editar-estado').value;
                const nuevaNota = quillNuevaNota && quillNuevaNota.getText().trim() 
                    ? quillNuevaNota.root.innerHTML 
                    : '';
                
                const tarea = tareasCache.find(t => t.task_id == taskId);
                const esCreador = tarea.created_by === currentUser.user_id;
                const esGeneralTools = tarea.module_type === 'general-tools';
                const esResponsable = tarea.assigned_to_mail === currentUser.user_mail || userHasPermission;
                
                // ✅ CÓDIGO CORRECTO:
                if (esResponsable) {
                    const datos = { 
                        task_progress: taskProgress, 
                        task_state: taskState, 
                        updated_at: new Date().toISOString() 
                    };
                    
                    if (esCreador && esGeneralTools) {
                        const nuevaCategoria = document.getElementById('editar-categoria').value;
                        datos.category_id = nuevaCategoria || null;
                    }
                    
                    if (taskState === 'Terminada') datos.close_date = new Date().toISOString().split('T')[0];
                    await supabaseRequest('/tasks?task_id=eq.' + taskId, { method: 'PATCH', body: JSON.stringify(datos) });
                }
                
                // Actualizar fecha límite si el creador la cambió
                const esCreadorTarea = tarea.created_by === currentUser.user_id;
                if (esCreadorTarea) {
                    const nuevaFechaLimite = document.getElementById('editar-fecha-limite').value;
                    if (nuevaFechaLimite && nuevaFechaLimite !== tarea.due_date) {
                        await supabaseRequest('/tasks?task_id=eq.' + taskId, { 
                            method: 'PATCH', 
                            body: JSON.stringify({ 
                                due_date: nuevaFechaLimite,
                                updated_at: new Date().toISOString() 
                            }) 
                        });
                    }
                }
                
                if (nuevaNota) {
                    // Crear la nota
                    await supabaseRequest('/task_progress_notes', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            task_id: parseInt(taskId), 
                            worker_email: currentUser.user_mail, 
                            worker_name: currentUser.user_display_name || currentUser.user_mail, 
                            note_content: nuevaNota 
                        })
                    });
                    
                    // Subir archivos de la nota si hay
                    if (archivosNuevaNota.length > 0) {
                        // Buscar el note_id recién creado
                        const notasRecientes = await supabaseRequest(
                            `/task_progress_notes?select=note_id&task_id=eq.${taskId}&worker_email=eq.${currentUser.user_mail}&order=created_at.desc&limit=1`
                        );
                        
                        if (notasRecientes && notasRecientes[0]) {
                            await subirArchivos(taskId, notasRecientes[0].note_id);
                        }
                    }
                    if (!notasCache[taskId]) notasCache[taskId] = 0;
                    notasCache[taskId]++;
                }
                
                showMessage('Cambios guardados exitosamente', 'success');
                modalEditarProgreso.hide();
                await cargarTareas();
            } catch (error) { console.error('❌ Error actualizando progreso:', error); showMessage('Error al actualizar progreso: ' + error.message, 'danger'); }
            finally { ocultarLoading(); }
        }
        
        // ==========================================
        // VER DETALLE
        // ==========================================
        async function verDetalle(taskId) {
            const tarea = tareasCache.find(t => t.task_id === taskId);
            if (!tarea) { showMessage('Tarea no encontrada', 'danger'); return; }
            
            document.getElementById('detalle-descripcion').innerHTML = tarea.task_description || 'N/A';
            
            const statusBadges = { 'Asignada': '<span class="badge bg-info text-dark">Asignada</span>', 'En Progreso': '<span class="badge bg-warning text-dark">En Progreso</span>', 'Terminada': '<span class="badge bg-success">Terminada</span>', 'Cancelada': '<span class="badge bg-secondary">Cancelada</span>' };
            document.getElementById('detalle-estado').innerHTML = statusBadges[tarea.task_state] || tarea.task_state;
            
            document.getElementById('detalle-asignada').textContent = tarea.assigned_to_name || tarea.assigned_to_mail || 'N/A';
            
            const studentName = tarea.students ? `${tarea.students.student_first_name} ${tarea.students.student_last_name_1} ${tarea.students.student_last_name_2 || ''}`.trim() : 'Sin estudiante';
            const courseName = tarea.students?.courses?.course_name || '';
            document.getElementById('detalle-estudiante').textContent = studentName + (courseName ? ` (${courseName})` : '');
            
            const priorityBadges = { 'Alta': '<span class="badge bg-danger">Alta</span>', 'Normal': '<span class="badge bg-primary">Normal</span>', 'Baja': '<span class="badge bg-secondary">Baja</span>' };
            document.getElementById('detalle-prioridad').innerHTML = priorityBadges[tarea.task_priority] || tarea.task_priority;
            
            const moduleNames = { 'follow-ups': 'Seguimientos', 'early-alerts': 'Alertas Tempranas', 'general-tools': 'Herramientas Generales' };
            document.getElementById('detalle-modulo').textContent = moduleNames[tarea.module_type] || tarea.module_type;
            // Mostrar categoría
            if (tarea.indicator_categories) {
                document.getElementById('detalle-categoria').innerHTML = getCategoryBadgeHtml(tarea.category_id);
            } else {
                document.getElementById('detalle-categoria').textContent = 'Sin categoría';
            }
            
            document.getElementById('detalle-fecha-limite').textContent = formatDate(tarea.due_date);
            document.getElementById('detalle-fecha-cierre').textContent = tarea.close_date ? formatDate(tarea.close_date) : 'No cerrada';
            document.getElementById('detalle-progreso').innerHTML = tarea.task_progress || 'Sin contexto documentado';

            
            await cargarColaboradoresDetalle(taskId);
            await cargarNotasDetalle(taskId);
            await cargarArchivosDetalle(taskId);
            modalVerDetalle.show();
        }
        
        async function cargarColaboradoresDetalle(taskId) {
            try {
                const colaboradores = await supabaseRequest(`/task_collaborators?select=worker_name,worker_email&task_id=eq.${taskId}&collaborator_status=eq.active`);
                const container = document.getElementById('detalle-lista-colaboradores');
                const contador = document.getElementById('detalle-contador-colaboradores');
                
                if (!colaboradores || colaboradores.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-2"><small>Sin colaboradores adicionales</small></div>';
                    contador.textContent = '0';
                    return;
                }
                
                contador.textContent = colaboradores.length;
                let html = '';
                colaboradores.forEach(colab => {
                    const iniciales = obtenerIniciales(colab.worker_name);
                    html += `<div class="collaborator-item"><div class="collaborator-info"><div class="collaborator-avatar">${iniciales}</div><div><div class="small fw-semibold">${escapeHtml(colab.worker_name)}</div><small class="text-muted">${escapeHtml(colab.worker_email)}</small></div></div></div>`;
                });
                container.innerHTML = html;
            } catch (error) { console.error('⚠️ Error cargando colaboradores detalle:', error); }
        }
        
        async function cargarNotasDetalle(taskId) {
            try {
                const notas = await supabaseRequest(`/task_progress_notes?select=*&task_id=eq.${taskId}&is_visible=eq.true&order=note_date.desc`);
                const container = document.getElementById('detalle-historial-notas');
                const contador = document.getElementById('detalle-contador-notas');
                
                if (!notas || notas.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-journal-x"></i> No hay notas registradas</div>';
                    contador.textContent = '0';
                    return;
                }
                
                contador.textContent = notas.length;
                let html = '';
                notas.forEach(nota => {
                    html += `<div class="note-item"><div class="note-header"><span class="note-author"><i class="bi bi-person-circle me-1"></i>${escapeHtml(nota.worker_name)}</span><span class="note-date"><i class="bi bi-clock me-1"></i>${formatDateTime(nota.note_date)}</span></div><div class="note-content html-content">${nota.note_content}</div></div>`;
                });
                container.innerHTML = html;
            } catch (error) { console.error('⚠️ Error cargando notas detalle:', error); }
        }
        
        // ==========================================
        // CERRAR Y CANCELAR TAREA
        // ==========================================
        async function cerrarTarea(taskId) {
            const tarea = tareasCache.find(t => t.task_id === taskId);
            if (!tarea) { showMessage('Tarea no encontrada', 'danger'); return; }
            
            const tieneProgreso = tarea.task_progress && tarea.task_progress.trim() !== '';
            const tieneNotas = notasCache[taskId] && notasCache[taskId] > 0;
            
            if (!tieneProgreso && !tieneNotas) {
                showMessage('No puedes cerrar una tarea sin progreso documentado. Agrega al menos una nota de progreso.', 'warning');
                return;
            }
            
            if (!confirm('¿Estás seguro de que deseas marcar esta tarea como Terminada?')) return;
            
            try {
                mostrarLoading();
                await supabaseRequest('/tasks?task_id=eq.' + taskId, {
                    method: 'PATCH',
                    body: JSON.stringify({ task_state: 'Terminada', close_date: new Date().toISOString().split('T')[0], updated_at: new Date().toISOString() })
                });
                showMessage('Tarea cerrada exitosamente', 'success');
                await cargarTareas();
            } catch (error) { console.error('❌ Error cerrando tarea:', error); showMessage('Error al cerrar tarea: ' + error.message, 'danger'); }
            finally { ocultarLoading(); }
        }
        
        async function cancelarTarea(taskId) {
            if (!confirm('¿Estás seguro de que deseas CANCELAR esta tarea?\n\nEsta acción no se puede deshacer.')) return;
            
            try {
                mostrarLoading();
                await supabaseRequest('/tasks?task_id=eq.' + taskId, {
                    method: 'PATCH',
                    body: JSON.stringify({ task_state: 'Cancelada', close_date: new Date().toISOString().split('T')[0], updated_at: new Date().toISOString() })
                });
                showMessage('Tarea cancelada', 'info');
                await cargarTareas();
            } catch (error) { console.error('❌ Error cancelando tarea:', error); showMessage('Error al cancelar tarea: ' + error.message, 'danger'); }
            finally { ocultarLoading(); }
        }

        // ==========================================
        // INICIALIZACIÓN DE EDITORES QUILL
        // ==========================================
        function inicializarEditoresQuill() {
            const toolbarOptions = [
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link'],
                ['clean']
            ];
        
            // Editor para descripción en nueva tarea
            if (document.getElementById('editor-nueva-descripcion')) {
                quillNuevaDescripcion = new Quill('#editor-nueva-descripcion', {
                    theme: 'snow',
                    modules: { toolbar: toolbarOptions },
                    placeholder: 'Describe la tarea...'
                });
            }
        
            // Editor para contexto en nueva tarea
            if (document.getElementById('editor-nueva-contexto')) {
                quillNuevaContexto = new Quill('#editor-nueva-contexto', {
                    theme: 'snow',
                    modules: { toolbar: toolbarOptions },
                    placeholder: 'Acuerdo Ganar-Ganar: (1) Resultado esperado (qué lograr, no cómo), (2) Directrices o límites a respetar, (3) Recursos disponibles, (4) Cómo y cuándo revisarás el avance.  -> Ver detalles en el manual <-'
                });
            }
        
            // Editor para contexto en editar progreso
            if (document.getElementById('editor-editar-contexto')) {
                quillEditarContexto = new Quill('#editor-editar-contexto', {
                    theme: 'snow',
                    modules: { toolbar: toolbarOptions },
                    placeholder: 'Contexto general de la tarea...'
                });
            }
        
            // Editor para nueva nota de progreso
            if (document.getElementById('editor-nueva-nota')) {
                quillNuevaNota = new Quill('#editor-nueva-nota', {
                    theme: 'snow',
                    modules: { toolbar: toolbarOptions },
                    placeholder: 'Escribe tu nota de progreso...'
                });
            }
        
            console.log('✅ Editores Quill inicializados');
        }
        
        // ==========================================
        // FUNCIONES DE ARCHIVOS - NUEVA TAREA
        // ==========================================
        function agregarArchivosNuevaTarea(files) {
            for (const file of files) {
                if (file.size > MAX_FILE_SIZE) {
                    showMessage(`El archivo "${file.name}" excede el límite de 10 MB`, 'warning');
                    continue;
                }
                if (!archivosNuevaTarea.find(f => f.name === file.name)) {
                    archivosNuevaTarea.push(file);
                }
            }
            renderizarArchivosNuevaTarea();
        }
        
        function quitarArchivoNuevaTarea(index) {
            archivosNuevaTarea.splice(index, 1);
            renderizarArchivosNuevaTarea();
        }
        
        function renderizarArchivosNuevaTarea() {
            const container = document.getElementById('lista-archivos-nueva');
            const badge = document.getElementById('badge-archivos-nueva');
            
            badge.textContent = archivosNuevaTarea.length;
            
            if (archivosNuevaTarea.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = archivosNuevaTarea.map((file, index) => `
                <div class="file-item">
                    <div class="file-info">
                        <i class="bi ${getFileIcon(file.type)}"></i>
                        <span class="file-name" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</span>
                        <span class="file-size">(${formatFileSize(file.size)})</span>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="quitarArchivoNuevaTarea(${index})">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // ==========================================
        // FUNCIONES DE ARCHIVOS - NOTA DE PROGRESO
        // ==========================================
        function agregarArchivosNota(files) {
            for (const file of files) {
                if (file.size > MAX_FILE_SIZE) {
                    showMessage(`El archivo "${file.name}" excede el límite de 10 MB`, 'warning');
                    continue;
                }
                if (!archivosNuevaNota.find(f => f.name === file.name)) {
                    archivosNuevaNota.push(file);
                }
            }
            renderizarArchivosNota();
        }
        
        function quitarArchivoNota(index) {
            archivosNuevaNota.splice(index, 1);
            renderizarArchivosNota();
        }
        
        function renderizarArchivosNota() {
            const container = document.getElementById('lista-archivos-nota');
            
            if (archivosNuevaNota.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = archivosNuevaNota.map((file, index) => `
                <div class="file-item">
                    <div class="file-info">
                        <i class="bi ${getFileIcon(file.type)}"></i>
                        <span class="file-name" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</span>
                        <span class="file-size">(${formatFileSize(file.size)})</span>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="quitarArchivoNota(${index})">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // ==========================================
        // SUBIR ARCHIVOS A SUPABASE STORAGE
        // ==========================================
        async function subirArchivos(taskId, noteId = null) {
            const archivos = noteId ? archivosNuevaNota : archivosNuevaTarea;
            const resultados = [];
            
            for (const file of archivos) {
                try {
                    const timestamp = Date.now();
                    const fileName = `${timestamp}_${file.name}`;
                    const folderPath = noteId 
                        ? `tasks/${taskId}/notes/${noteId}` 
                        : `tasks/${taskId}/general`;
                    const filePath = `${folderPath}/${fileName}`;
                    
                    // Subir a Storage
                    const { data, error } = await supabaseClient
                        .storage
                        .from(BUCKET_NAME)
                        .upload(filePath, file, { cacheControl: '3600', upsert: false });
                    
                    if (error) throw error;
                    
                    // Obtener URL pública
                    const { data: urlData } = supabaseClient
                        .storage
                        .from(BUCKET_NAME)
                        .getPublicUrl(filePath);
                    
                    // Registrar en base de datos
                    await supabaseRequest('/task_documents', {
                        method: 'POST',
                        body: JSON.stringify({
                            task_id: parseInt(taskId),
                            note_id: noteId || null,
                            file_name: file.name,
                            file_path: filePath,
                            file_size: file.size,
                            file_type: file.type,
                            uploaded_by: currentUser.user_mail,
                            uploaded_by_name: currentUser.user_display_name || currentUser.user_mail
                        })
                    });
                    
                    resultados.push({ success: true, fileName: file.name });
                    
                } catch (error) {
                    console.error('Error subiendo archivo:', file.name, error);
                    resultados.push({ success: false, fileName: file.name, error: error.message });
                }
            }
            
            return resultados;
        }
        
        // ==========================================
        // CARGAR Y MOSTRAR ARCHIVOS
        // ==========================================
        async function cargarArchivosDetalle(taskId) {
            try {
                const archivos = await supabaseRequest(
                    `/task_documents?select=*&task_id=eq.${taskId}&is_active=eq.true&order=uploaded_at.desc`
                );
                
                const container = document.getElementById('detalle-lista-archivos');
                const contador = document.getElementById('detalle-contador-archivos');
                
                if (!archivos || archivos.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-2"><small>Sin archivos adjuntos</small></div>';
                    contador.textContent = '0';
                    return;
                }
                
                contador.textContent = archivos.length;
                
                container.innerHTML = archivos.map(archivo => {
                    const publicUrl = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(archivo.file_path).data.publicUrl;
                    
                    return `
                        <div class="file-item">
                            <div class="file-info">
                                <i class="bi ${getFileIcon(archivo.file_type)}"></i>
                                <span class="file-name" title="${escapeHtml(archivo.file_name)}">${escapeHtml(archivo.file_name)}</span>
                                <span class="file-size">(${formatFileSize(archivo.file_size)})</span>
                            </div>
                            <div class="file-actions">
                                <a href="${publicUrl}" target="_blank" class="btn btn-sm btn-outline-primary" title="Ver">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="${publicUrl}" download="${escapeHtml(archivo.file_name)}" class="btn btn-sm btn-outline-secondary" title="Descargar">
                                    <i class="bi bi-download"></i>
                                </a>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error cargando archivos:', error);
            }
        }
        
        // ==========================================
        // UTILIDADES DE ARCHIVOS
        // ==========================================
        function getFileIcon(mimeType) {
            if (!mimeType) return 'bi-file-earmark';
            if (mimeType.startsWith('image/')) return 'bi-file-earmark-image';
            if (mimeType.includes('pdf')) return 'bi-file-earmark-pdf';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'bi-file-earmark-word';
            if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'bi-file-earmark-excel';
            if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'bi-file-earmark-ppt';
            if (mimeType.startsWith('video/')) return 'bi-file-earmark-play';
            if (mimeType.startsWith('audio/')) return 'bi-file-earmark-music';
            if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('compressed')) return 'bi-file-earmark-zip';
            return 'bi-file-earmark';
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function ocultarLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function stripHtml(html) {
            if (!html) return '';
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }
        
        function obtenerIniciales(nombre) {
            if (!nombre) return '?';
            const partes = nombre.split(' ').filter(p => p.length > 0);
            if (partes.length >= 2) return (partes[0][0] + partes[1][0]).toUpperCase();
            return nombre.substring(0, 2).toUpperCase();
        }
        
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('es-CO', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.abrirModalNuevaTarea = abrirModalNuevaTarea;
        window.editarProgreso = editarProgreso;
        window.verDetalle = verDetalle;
        window.cerrarTarea = cerrarTarea;
        window.cancelarTarea = cancelarTarea;
        window.limpiarFiltros = limpiarFiltros;
        window.gestionarColaboradores = gestionarColaboradores;
        window.agregarColaborador = agregarColaborador;
        window.removerColaborador = removerColaborador;
        window.agregarColaboradorNuevaTarea = agregarColaboradorNuevaTarea;
        window.quitarColaboradorNuevaTarea = quitarColaboradorNuevaTarea;
        window.agregarArchivosNuevaTarea = agregarArchivosNuevaTarea;
window.quitarArchivoNuevaTarea = quitarArchivoNuevaTarea;
window.agregarArchivosNota = agregarArchivosNota;
window.quitarArchivoNota = quitarArchivoNota;
        
        console.log('🎉 tasks.html v2.0 con colaboradores y notas cargado correctamente');
    </script>
</body>
</html>
