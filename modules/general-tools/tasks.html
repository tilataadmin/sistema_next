<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.27.09.21">
    <title>Gesti√≥n de Tareas - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tarjetas de tareas */
        .task-card {
            border-left: 4px solid #6c757d;
            transition: all 0.3s ease;
        }
        
        .task-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .task-card.priority-high, .task-card.priority-alta {
            border-left-color: #dc3545;
        }
        
        .task-card.priority-normal {
            border-left-color: #0d6efd;
        }
        
        .task-card.priority-low, .task-card.priority-baja {
            border-left-color: #6c757d;
        }
        
        .task-card.overdue {
            background-color: #fff3cd;
        }
        
        /* Badges */
        .badge-priority-high, .badge-priority-Alta {
            background-color: #dc3545;
        }
        
        .badge-priority-normal, .badge-priority-Normal {
            background-color: #0d6efd;
        }
        
        .badge-priority-low, .badge-priority-Baja {
            background-color: #6c757d;
        }
        
        .badge-status-assigned {
            background-color: #0dcaf0;
            color: #000;
        }
        
        .badge-status-progress {
            background-color: #ffc107;
            color: #000;
        }
        
        .badge-status-completed {
            background-color: #198754;
        }
        
        .badge-status-cancelled {
            background-color: #6c757d;
        }
        
        /* Filtros */
        .filters-section {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        /* Estados vac√≠os */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Estilos para notas de progreso */
        .note-item {
            border-left: 3px solid #0d6efd;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            background-color: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }
        
        .note-item .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .note-item .note-author {
            font-weight: 600;
            color: #0d6efd;
        }
        
        .note-item .note-date {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .note-item .note-content {
            color: #333;
            white-space: pre-wrap;
        }
        
        /* Estilos para colaboradores */
        .collaborator-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .collaborator-item:last-child {
            border-bottom: none;
        }
        
        .collaborator-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .collaborator-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #0d6efd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        /* Badge contador */
        .badge-counter {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }
        
        /* Historial de notas scrolleable */
        .notes-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Colaboradores scrolleable */
        .collaborators-list {
            max-height: 250px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gesti√≥n de Tareas
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-check2-square me-2"></i>
                    Gesti√≥n de Tareas
                </h1>
                <p class="text-muted">
                    Administra y da seguimiento a las tareas asignadas
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>
        
        <!-- SECCI√ìN DE FILTROS -->
        <div class="filters-section">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="filter-status" class="form-label">
                        <i class="bi bi-funnel me-1"></i>Estado
                    </label>
                    <select class="form-select" id="filter-status">
                        <option value="">Todos los estados</option>
                        <option value="Asignada">Asignada</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Terminada">Terminada</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="filter-priority" class="form-label">
                        <i class="bi bi-exclamation-circle me-1"></i>Prioridad
                    </label>
                    <select class="form-select" id="filter-priority">
                        <option value="">Todas las prioridades</option>
                        <option value="Alta">Alta</option>
                        <option value="Normal">Normal</option>
                        <option value="Baja">Baja</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="filter-module" class="form-label">
                        <i class="bi bi-box me-1"></i>M√≥dulo Origen
                    </label>
                    <select class="form-select" id="filter-module">
                        <option value="">Todos los m√≥dulos</option>
                        <option value="follow-ups">Seguimientos</option>
                        <option value="early-alerts">Alertas Tempranas</option>
                        <option value="general-tools">Herramientas Generales</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="filter-search" class="form-label">
                        <i class="bi bi-search me-1"></i>Buscar
                    </label>
                    <input type="text" class="form-control" id="filter-search" 
                           placeholder="Buscar en descripci√≥n...">
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col">
                    <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                        <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                    </button>
                    <button class="btn btn-primary" id="btn-nueva-tarea" onclick="abrirModalNuevaTarea()" style="display: none;">
                        <i class="bi bi-plus-circle me-1"></i>Nueva Tarea
                    </button>
                </div>
            </div>
        </div>

        <!-- LISTADO DE TAREAS -->
        <div class="row" id="tasks-container">
            <div class="col-12">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <div class="mt-2">Cargando tareas...</div>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL: NUEVA TAREA -->
    <div class="modal fade" id="modal-nueva-tarea" tabindex="-1" aria-labelledby="modalNuevaTareaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNuevaTareaLabel">
                        <i class="bi bi-plus-circle me-2"></i>Nueva Tarea
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="form-nueva-tarea">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="nueva-descripcion" class="form-label">
                                Descripci√≥n de la tarea <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="nueva-descripcion" name="task_description" 
                                      rows="3" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="nueva-asignada-a" class="form-label">
                                Asignada a <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="nueva-asignada-a" name="assigned_to_mail" required>
                                <option value="">Seleccione un trabajador...</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nueva-fecha-limite" class="form-label">
                                    Fecha l√≠mite <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="nueva-fecha-limite" 
                                       name="due_date" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="nueva-prioridad" class="form-label">
                                    Prioridad <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="nueva-prioridad" name="task_priority" required>
                                    <option value="">Seleccione prioridad...</option>
                                    <option value="Alta">Alta</option>
                                    <option value="Normal" selected>Normal</option>
                                    <option value="Baja">Baja</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="nueva-notas" class="form-label">
                                Contexto inicial
                            </label>
                            <textarea class="form-control" id="nueva-notas" name="task_progress" rows="2"></textarea>
                            <small class="text-muted">Informaci√≥n adicional sobre la tarea (resumen ejecutivo)</small>
                        </div>
                        
                        <!-- Secci√≥n de Colaboradores (opcional) -->
                        <div class="card border-info mb-3">
                            <div class="card-header bg-info bg-opacity-10 d-flex justify-content-between align-items-center" 
                                 style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#seccion-colaboradores-nueva">
                                <span>
                                    <i class="bi bi-people me-1"></i>Colaboradores 
                                    <span class="badge bg-secondary" id="badge-colaboradores-nueva">0</span>
                                    <small class="text-muted ms-2">(opcional)</small>
                                </span>
                                <i class="bi bi-chevron-down" id="icono-collapse-colaboradores"></i>
                            </div>
                            <div class="collapse" id="seccion-colaboradores-nueva">
                                <div class="card-body">
                                    <div class="row g-2 align-items-end mb-3">
                                        <div class="col-md-9">
                                            <label for="select-colaborador-nueva" class="form-label">
                                                Agregar colaborador
                                            </label>
                                            <select class="form-select" id="select-colaborador-nueva">
                                                <option value="">Seleccione un trabajador...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-outline-success w-100" onclick="agregarColaboradorNuevaTarea()">
                                                <i class="bi bi-plus"></i> Agregar
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Lista de colaboradores agregados -->
                                    <div id="lista-colaboradores-nueva">
                                        <div class="text-center text-muted py-2" id="sin-colaboradores-msg">
                                            <small>No se han agregado colaboradores</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Crear Tarea
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- MODAL: EDITAR PROGRESO -->
    <div class="modal fade" id="modal-editar-progreso" tabindex="-1" aria-labelledby="modalEditarProgresoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarProgresoLabel">
                        <i class="bi bi-pencil-square me-2"></i>Editar Progreso de Tarea
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="form-editar-progreso">
                    <div class="modal-body">
                        <!-- Informaci√≥n de la tarea (readonly) -->
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Informaci√≥n de la Tarea</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Descripci√≥n:</strong></p>
                                        <p class="text-muted" id="progreso-descripcion"></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Responsable:</strong></p>
                                        <p class="text-muted" id="progreso-asignada"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Fecha l√≠mite:</strong></p>
                                        <p class="text-muted" id="progreso-fecha"></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Prioridad:</strong></p>
                                        <p class="text-muted" id="progreso-prioridad"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Estado actual:</strong></p>
                                        <p class="text-muted" id="progreso-estado"></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Estudiante:</strong></p>
                                        <p class="text-muted" id="progreso-estudiante"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campo editable de contexto general (solo responsable principal) -->
                        <div class="mb-3" id="seccion-contexto-general">
                            <label for="editar-progreso-text" class="form-label">
                                <i class="bi bi-card-text me-1"></i>Contexto General
                                <small class="text-muted">(solo responsable principal)</small>
                            </label>
                            <textarea class="form-control" id="editar-progreso-text" name="task_progress" 
                                      rows="2"></textarea>
                            <small class="text-muted">Resumen ejecutivo de la tarea</small>
                        </div>
                        
                        <!-- Cambiar estado (solo responsable principal) -->
                        <div class="mb-3" id="seccion-cambiar-estado">
                            <label for="editar-estado" class="form-label">
                                Estado de la tarea
                            </label>
                            <select class="form-select" id="editar-estado" name="task_state">
                                <option value="Asignada">Asignada</option>
                                <option value="En Progreso">En Progreso</option>
                                <option value="Terminada">Terminada</option>
                            </select>
                        </div>
                        
                        <hr>
                        
                        <!-- Secci√≥n de notas de progreso -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-journal-text me-1"></i>Agregar Nota de Progreso
                            </label>
                            <textarea class="form-control" id="nueva-nota-progreso" rows="3" 
                                      placeholder="Escribe aqu√≠ tu nota sobre el avance de la tarea..."></textarea>
                            <small class="text-muted">Esta nota se agregar√° al historial con tu nombre y fecha</small>
                        </div>
                        
                        <!-- Historial de notas -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-clock-history me-1"></i>Historial de Notas
                                <span class="badge bg-secondary badge-counter" id="contador-notas-progreso">0</span>
                            </label>
                            <div class="notes-container" id="historial-notas-progreso">
                                <div class="text-center text-muted py-3">
                                    <i class="bi bi-journal-x"></i> No hay notas registradas
                                </div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="editar-task-id" name="task_id">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: VER DETALLE -->
    <div class="modal fade" id="modal-ver-detalle" tabindex="-1" aria-labelledby="modalVerDetalleLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalVerDetalleLabel">
                        <i class="bi bi-info-circle me-2"></i>Detalle de Tarea
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Columna izquierda: Informaci√≥n b√°sica -->
                        <div class="col-md-6">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6 class="text-muted mb-2">Descripci√≥n</h6>
                                    <p id="detalle-descripcion"></p>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2">Estado</h6>
                                    <p id="detalle-estado"></p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2">Prioridad</h6>
                                    <p id="detalle-prioridad"></p>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2">Responsable Principal</h6>
                                    <p id="detalle-asignada"></p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2">Estudiante asociado</h6>
                                    <p id="detalle-estudiante"></p>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-2">M√≥dulo origen</h6>
                                    <p id="detalle-modulo"></p>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-2">Fecha l√≠mite</h6>
                                    <p id="detalle-fecha-limite"></p>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-2">Fecha de cierre</h6>
                                    <p id="detalle-fecha-cierre"></p>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">Contexto General</h6>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <p id="detalle-progreso" class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Colaboradores en detalle -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">
                                    <i class="bi bi-people me-1"></i>Colaboradores
                                    <span class="badge bg-secondary badge-counter" id="detalle-contador-colaboradores">0</span>
                                </h6>
                                <div class="card">
                                    <div class="card-body p-2">
                                        <div class="collaborators-list" id="detalle-lista-colaboradores">
                                            <div class="text-center text-muted py-2">
                                                <small>Sin colaboradores adicionales</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Columna derecha: Historial de notas -->
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-journal-text me-1"></i>Historial de Notas
                                <span class="badge bg-secondary badge-counter" id="detalle-contador-notas">0</span>
                            </h6>
                            <div class="card">
                                <div class="card-body">
                                    <div class="notes-container" id="detalle-historial-notas" style="max-height: 400px;">
                                        <div class="text-center text-muted py-3">
                                            <i class="bi bi-journal-x"></i> No hay notas registradas
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: GESTIONAR COLABORADORES -->
    <div class="modal fade" id="modal-colaboradores" tabindex="-1" aria-labelledby="modalColaboradoresLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalColaboradoresLabel">
                        <i class="bi bi-people me-2"></i>Gestionar Colaboradores
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Informaci√≥n de la tarea -->
                    <div class="alert alert-info">
                        <strong>Tarea:</strong> <span id="colab-descripcion-tarea"></span>
                    </div>
                    
                    <!-- Agregar nuevo colaborador -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <i class="bi bi-person-plus me-1"></i>Agregar Colaborador
                        </div>
                        <div class="card-body">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-8">
                                    <label for="select-nuevo-colaborador" class="form-label">
                                        Seleccionar trabajador
                                    </label>
                                    <select class="form-select" id="select-nuevo-colaborador">
                                        <option value="">Seleccione un trabajador...</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-success w-100" onclick="agregarColaborador()">
                                        <i class="bi bi-plus-circle me-1"></i>Agregar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de colaboradores actuales -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-people me-1"></i>Colaboradores Actuales</span>
                            <span class="badge bg-primary" id="badge-total-colaboradores">0</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="collaborators-list" id="lista-colaboradores">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-people" style="font-size: 2rem;"></i>
                                    <p class="mb-0 mt-2">No hay colaboradores en esta tarea</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="colab-task-id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let tareasCache = [];
        let trabajadoresCache = [];
        let estudiantesCache = [];
        let colaboradoresCache = {};  // Objeto: {task_id: cantidad}
        let notasCache = {};          // Objeto: {task_id: cantidad}
        let colaboradoresNuevaTarea = []; // Array temporal para nueva tarea
        let currentUser = null;
        let userHasPermission = false;
        
        let modalNuevaTarea = null;
        let modalEditarProgreso = null;
        let modalVerDetalle = null;
        let modalColaboradores = null;
        
        // ==========================================
        // INICIALIZACI√ìN - PATR√ìN OBLIGATORIO
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // Obtener sesi√≥n
                const session = getStoredSession();
                if (!session || !session.user) {
                    console.log('‚ùå No hay sesi√≥n activa');
                    window.location.href = '../../login.html';
                    return;
                }
                
                currentUser = session.user;
                console.log('‚úÖ Usuario autenticado:', currentUser.user_display_name);
                
                // Verificar permiso "Gestionar tareas"
                userHasPermission = await checkUserPermission(currentUser.user_id, 'Gestionar tareas');
                console.log('üîë Permiso "Gestionar tareas":', userHasPermission);
                
                // Mostrar bot√≥n de nueva tarea solo si tiene permiso
                if (userHasPermission) {
                    document.getElementById('btn-nueva-tarea').style.display = 'inline-block';
                }
                
                // Inicializar p√°gina
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Inicializar modales
                modalNuevaTarea = new bootstrap.Modal(document.getElementById('modal-nueva-tarea'));
                modalEditarProgreso = new bootstrap.Modal(document.getElementById('modal-editar-progreso'));
                modalVerDetalle = new bootstrap.Modal(document.getElementById('modal-ver-detalle'));
                modalColaboradores = new bootstrap.Modal(document.getElementById('modal-colaboradores'));
                
                // Configurar event listeners
                configurarEventos();
                
                // Cargar datos iniciales
                await cargarTrabajadores();
                await cargarTareas();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CONFIGURACI√ìN DE EVENTOS
        // ==========================================
        function configurarEventos() {
            // Formulario nueva tarea
            document.getElementById('form-nueva-tarea').addEventListener('submit', manejarCrearTarea);
            
            // Formulario editar progreso
            document.getElementById('form-editar-progreso').addEventListener('submit', manejarEditarProgreso);
            
            // Filtros
            document.getElementById('filter-status').addEventListener('change', aplicarFiltros);
            document.getElementById('filter-priority').addEventListener('change', aplicarFiltros);
            document.getElementById('filter-module').addEventListener('change', aplicarFiltros);
            document.getElementById('filter-search').addEventListener('input', aplicarFiltros);
            
            // Validar fecha m√≠nima al abrir modal
            document.getElementById('modal-nueva-tarea').addEventListener('show.bs.modal', function() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('nueva-fecha-limite').setAttribute('min', today);
            });
            
            // Actualizar dropdown de colaboradores cuando cambia el responsable
            document.getElementById('nueva-asignada-a').addEventListener('change', function() {
                actualizarDropdownColaboradoresNueva();
            });
            
            console.log('‚úÖ Event listeners configurados');
        }
        
        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        async function cargarTrabajadores() {
            try {
                console.log('üì° Cargando trabajadores activos...');
                const data = await supabaseRequest('/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,email&worker_status=eq.active&order=worker_last_name_1.asc,worker_last_name_2.asc,worker_first_name.asc');
                
                trabajadoresCache = data || [];
                
                // Llenar dropdown de nueva tarea
                const select = document.getElementById('nueva-asignada-a');
                select.innerHTML = '<option value="">Seleccione un trabajador...</option>';
                
                trabajadoresCache.forEach(worker => {
                    const nombreCompleto = `${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}, ${worker.worker_first_name}`.trim();
                    const option = document.createElement('option');
                    option.value = worker.email;
                    option.textContent = nombreCompleto;
                    option.dataset.workerId = worker.worker_id;
                    option.dataset.workerName = nombreCompleto;
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ ${trabajadoresCache.length} trabajadores cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando trabajadores:', error);
                showMessage('Error al cargar trabajadores: ' + error.message, 'danger');
            }
        }
        
        // Llenar dropdown de colaboradores (excluyendo al responsable y colaboradores existentes)
        function llenarDropdownColaboradores(excludeEmail, colaboradoresExistentes = []) {
            const select = document.getElementById('select-nuevo-colaborador');
            select.innerHTML = '<option value="">Seleccione un trabajador...</option>';
            
            const emailsExcluir = [excludeEmail, ...colaboradoresExistentes];
            
            trabajadoresCache.forEach(worker => {
                if (emailsExcluir.includes(worker.email)) return;
                
                const nombreCompleto = `${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}, ${worker.worker_first_name}`.trim();
                const option = document.createElement('option');
                option.value = worker.email;
                option.textContent = nombreCompleto;
                option.dataset.workerName = nombreCompleto;
                select.appendChild(option);
            });
        }
         
        async function cargarTareas() {
            try {
                console.log('üì° Cargando tareas...');
                
                let query = '/tasks?select=*,students(student_first_name,student_last_name_1,student_last_name_2,courses(course_name))&order=created_at.desc';
                
                if (userHasPermission) {
                    query += '&or=(student_id.not.is.null,and(student_id.is.null,created_by.eq.' + currentUser.user_id + '))';
                } else {
                    query += '&assigned_to_mail=eq.' + currentUser.user_mail;
                }
                
                const data = await supabaseRequest(query);
                tareasCache = data || [];
                
                // Cargar tambi√©n tareas donde el usuario es colaborador
                if (!userHasPermission) {
                    await cargarTareasComoColaborador();
                }
                
                // Cargar conteos de colaboradores y notas
                await cargarConteosTareas();
                
                console.log(`‚úÖ ${tareasCache.length} tareas cargadas`);
                renderizarTareas(tareasCache);
                
            } catch (error) {
                console.error('‚ùå Error cargando tareas:', error);
                showMessage('Error al cargar tareas: ' + error.message, 'danger');
                mostrarEstadoVacio('Error al cargar datos');
            }
        }
        
        async function cargarTareasComoColaborador() {
            try {
                const colaboraciones = await supabaseRequest(
                    `/task_collaborators?select=task_id&worker_email=eq.${currentUser.user_mail}&collaborator_status=eq.active`
                );
                
                if (!colaboraciones || colaboraciones.length === 0) return;
                
                const taskIds = colaboraciones.map(c => c.task_id);
                const tareasExistentes = new Set(tareasCache.map(t => t.task_id));
                const taskIdsNuevos = taskIds.filter(id => !tareasExistentes.has(id));
                
                if (taskIdsNuevos.length === 0) return;
                
                const tareasColaborador = await supabaseRequest(
                    `/tasks?select=*,students(student_first_name,student_last_name_1,student_last_name_2,courses(course_name))&task_id=in.(${taskIdsNuevos.join(',')})`
                );
                
                if (tareasColaborador && tareasColaborador.length > 0) {
                    tareasCache = [...tareasCache, ...tareasColaborador];
                    console.log(`üìã ${tareasColaborador.length} tareas adicionales como colaborador`);
                }
                
            } catch (error) {
                console.error('‚ö†Ô∏è Error cargando tareas como colaborador:', error);
            }
        }
        
        async function cargarConteosTareas() {
            try {
                const taskIds = tareasCache.map(t => t.task_id);
                if (taskIds.length === 0) return;
                
                const colaboradores = await supabaseRequest(
                    `/task_collaborators?select=task_id,collaborator_id&collaborator_status=eq.active&task_id=in.(${taskIds.join(',')})`
                );
                
                const notas = await supabaseRequest(
                    `/task_progress_notes?select=task_id,note_id&is_visible=eq.true&task_id=in.(${taskIds.join(',')})`
                );
                
                colaboradoresCache = {};
                notasCache = {};
                
                if (colaboradores) {
                    colaboradores.forEach(c => {
                        if (!colaboradoresCache[c.task_id]) colaboradoresCache[c.task_id] = 0;
                        colaboradoresCache[c.task_id]++;
                    });
                }
                
                if (notas) {
                    notas.forEach(n => {
                        if (!notasCache[n.task_id]) notasCache[n.task_id] = 0;
                        notasCache[n.task_id]++;
                    });
                }
                
            } catch (error) {
                console.error('‚ö†Ô∏è Error cargando conteos:', error);
            }
        }
        
        // ==========================================
        // RENDERIZADO DE TAREAS
        // ==========================================
        function renderizarTareas(tareas) {
            const container = document.getElementById('tasks-container');
            
            if (!tareas || tareas.length === 0) {
                mostrarEstadoVacio('No hay tareas disponibles');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let html = '';
            
            tareas.forEach(tarea => {
                const dueDate = new Date(tarea.due_date);
                const isOverdue = tarea.task_state !== 'Terminada' && tarea.task_state !== 'Cancelada' && dueDate < today;
                
                const priorityClass = `priority-${tarea.task_priority || 'normal'}`;
                const overdueClass = isOverdue ? 'overdue' : '';
                
                const studentName = tarea.students 
                    ? `${tarea.students.student_first_name} ${tarea.students.student_last_name_1} ${tarea.students.student_last_name_2 || ''}`.trim()
                    : 'Sin estudiante';
                
                const courseName = tarea.students?.courses?.course_name || '';
                
                const moduleNames = {
                    'follow-ups': 'Seguimientos',
                    'early-alerts': 'Alertas Tempranas',
                    'general-tools': 'Herramientas Generales'
                };
                
                const statusBadgeClass = {
                    'Asignada': 'badge-status-assigned',
                    'En Progreso': 'badge-status-progress',
                    'Terminada': 'badge-status-completed',
                    'Cancelada': 'badge-status-cancelled'
                };
                
                const priorityBadgeClass = {
                    'Alta': 'badge-priority-Alta',
                    'Normal': 'badge-priority-Normal',
                    'Baja': 'badge-priority-Baja'
                };
                
                const esResponsable = tarea.assigned_to_mail === currentUser.user_mail;
                const canEdit = userHasPermission || esResponsable;
                const canManageCollaborators = userHasPermission || esResponsable;
                
                const numColaboradores = colaboradoresCache[tarea.task_id] || 0;
                const numNotas = notasCache[tarea.task_id] || 0;
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card task-card ${priorityClass} ${overdueClass} h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="badge ${priorityBadgeClass[tarea.task_priority] || 'badge-priority-Normal'}">
                                        ${escapeHtml(tarea.task_priority || 'Normal')}
                                    </span>
                                    <span class="badge ${statusBadgeClass[tarea.task_state] || 'bg-secondary'}">
                                        ${escapeHtml(tarea.task_state || 'Asignada')}
                                    </span>
                                </div>
                                
                                <span class="badge bg-info text-dark mb-2">
                                    ${moduleNames[tarea.module_type] || tarea.module_type}
                                </span>
                                
                                <h6 class="card-title mt-2">
                                    ${escapeHtml(tarea.task_description?.substring(0, 80) || '')}${tarea.task_description?.length > 80 ? '...' : ''}
                                </h6>
                                
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-person-check me-1"></i>
                                        <strong>Responsable:</strong> ${escapeHtml(tarea.assigned_to_name || tarea.assigned_to_mail || 'N/A')}
                                    </small>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-mortarboard me-1"></i>
                                        <strong>Estudiante:</strong> ${escapeHtml(studentName)}
                                        ${courseName ? `<span class="badge bg-light text-dark ms-1">${escapeHtml(courseName)}</span>` : ''}
                                    </small>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="${isOverdue ? 'text-danger fw-bold' : 'text-muted'}">
                                        <i class="bi bi-calendar-event me-1"></i>
                                        <strong>Fecha l√≠mite:</strong> ${formatDate(tarea.due_date)}
                                        ${isOverdue ? '<span class="badge bg-danger ms-1">VENCIDA</span>' : ''}
                                    </small>
                                </div>
                                
                                <!-- Badges de colaboradores y notas -->
                                <div class="mb-2 d-flex gap-2">
                                    ${numColaboradores > 0 ? `
                                        <span class="badge bg-primary" title="Colaboradores">
                                            <i class="bi bi-people me-1"></i>${numColaboradores}
                                        </span>
                                    ` : ''}
                                    ${numNotas > 0 ? `
                                        <span class="badge bg-secondary" title="Notas de progreso">
                                            <i class="bi bi-journal-text me-1"></i>${numNotas}
                                        </span>
                                    ` : ''}
                                </div>
                                
                                ${tarea.task_progress ? `
                                    <div class="mb-2">
                                        <small class="text-muted">
                                            <i class="bi bi-card-text me-1"></i>
                                            <strong>Contexto:</strong> ${escapeHtml(tarea.task_progress.substring(0, 50))}${tarea.task_progress.length > 50 ? '...' : ''}
                                        </small>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="card-footer bg-transparent">
                                <div class="btn-group btn-group-sm w-100" role="group">
                                    <button class="btn btn-outline-primary" onclick="verDetalle(${tarea.task_id})" title="Ver detalle">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    ${canManageCollaborators && tarea.task_state !== 'Terminada' && tarea.task_state !== 'Cancelada' ? `
                                        <button class="btn btn-outline-info" onclick="gestionarColaboradores(${tarea.task_id})" title="Colaboradores">
                                            <i class="bi bi-people"></i>
                                        </button>
                                    ` : ''}
                                    ${tarea.task_state !== 'Terminada' && tarea.task_state !== 'Cancelada' ? `
                                        <button class="btn btn-outline-success" onclick="editarProgreso(${tarea.task_id})" title="Editar progreso">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    ` : ''}
                                    ${canEdit && tarea.task_state !== 'Terminada' && tarea.task_state !== 'Cancelada' ? `
                                        <button class="btn btn-outline-warning" onclick="cerrarTarea(${tarea.task_id})" title="Cerrar tarea">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                    ` : ''}
                                    ${canEdit && tarea.task_state !== 'Cancelada' && tarea.task_state !== 'Terminada' ? `
                                        <button class="btn btn-outline-danger" onclick="cancelarTarea(${tarea.task_id})" title="Cancelar">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function mostrarEstadoVacio(mensaje) {
            const container = document.getElementById('tasks-container');
            container.innerHTML = `
                <div class="col-12">
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <h5>${mensaje}</h5>
                        <p class="text-muted">No se encontraron tareas con los filtros aplicados</p>
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // FILTROS
        // ==========================================
        function aplicarFiltros() {
            const statusFilter = document.getElementById('filter-status').value;
            const priorityFilter = document.getElementById('filter-priority').value;
            const moduleFilter = document.getElementById('filter-module').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();
            
            const tareasFiltradas = tareasCache.filter(tarea => {
                const matchStatus = !statusFilter || tarea.task_state === statusFilter;
                const matchPriority = !priorityFilter || tarea.task_priority === priorityFilter;
                const matchModule = !moduleFilter || tarea.module_type === moduleFilter;
                const matchSearch = !searchFilter || tarea.task_description?.toLowerCase().includes(searchFilter);
                
                return matchStatus && matchPriority && matchModule && matchSearch;
            });
            
            renderizarTareas(tareasFiltradas);
        }
        
        function limpiarFiltros() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-priority').value = '';
            document.getElementById('filter-module').value = '';
            document.getElementById('filter-search').value = '';
            renderizarTareas(tareasCache);
        }
        
        // ==========================================
        // MODAL NUEVA TAREA
        // ==========================================
        function abrirModalNuevaTarea() {
            document.getElementById('form-nueva-tarea').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('nueva-fecha-limite').setAttribute('min', today);
            
            // Limpiar colaboradores
            colaboradoresNuevaTarea = [];
            actualizarListaColaboradoresNueva();
            actualizarDropdownColaboradoresNueva();
            
            modalNuevaTarea.show();
        }
        
        // Actualizar dropdown de colaboradores cuando cambia el responsable
        function actualizarDropdownColaboradoresNueva() {
            const responsableEmail = document.getElementById('nueva-asignada-a').value;
            const select = document.getElementById('select-colaborador-nueva');
            select.innerHTML = '<option value="">Seleccione un trabajador...</option>';
            
            // Emails a excluir: responsable + colaboradores ya agregados
            const emailsExcluir = [responsableEmail, ...colaboradoresNuevaTarea.map(c => c.email)];
            
            trabajadoresCache.forEach(worker => {
                if (emailsExcluir.includes(worker.email)) return;
                
                const nombreCompleto = `${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}, ${worker.worker_first_name}`.trim();
                const option = document.createElement('option');
                option.value = worker.email;
                option.textContent = nombreCompleto;
                option.dataset.workerName = nombreCompleto;
                select.appendChild(option);
            });
        }
        
        // Agregar colaborador a la lista temporal
        function agregarColaboradorNuevaTarea() {
            const select = document.getElementById('select-colaborador-nueva');
            if (!select.value) {
                showMessage('Selecciona un trabajador para agregar', 'warning');
                return;
            }
            
            const email = select.value;
            const nombre = select.selectedOptions[0].dataset.workerName;
            
            // Verificar que no est√© ya agregado
            if (colaboradoresNuevaTarea.find(c => c.email === email)) {
                showMessage('Este colaborador ya fue agregado', 'warning');
                return;
            }
            
            colaboradoresNuevaTarea.push({ email, nombre });
            actualizarListaColaboradoresNueva();
            actualizarDropdownColaboradoresNueva();
        }
        
        // Quitar colaborador de la lista temporal
        function quitarColaboradorNuevaTarea(email) {
            colaboradoresNuevaTarea = colaboradoresNuevaTarea.filter(c => c.email !== email);
            actualizarListaColaboradoresNueva();
            actualizarDropdownColaboradoresNueva();
        }
        
        // Renderizar lista de colaboradores en modal nueva tarea
        function actualizarListaColaboradoresNueva() {
            const container = document.getElementById('lista-colaboradores-nueva');
            const badge = document.getElementById('badge-colaboradores-nueva');
            const msgVacio = document.getElementById('sin-colaboradores-msg');
            
            badge.textContent = colaboradoresNuevaTarea.length;
            
            if (colaboradoresNuevaTarea.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-2" id="sin-colaboradores-msg"><small>No se han agregado colaboradores</small></div>';
                return;
            }
            
            let html = '';
            colaboradoresNuevaTarea.forEach(colab => {
                const iniciales = obtenerIniciales(colab.nombre);
                html += `
                    <div class="collaborator-item">
                        <div class="collaborator-info">
                            <div class="collaborator-avatar">${iniciales}</div>
                            <div>
                                <div class="small fw-semibold">${escapeHtml(colab.nombre)}</div>
                                <small class="text-muted">${escapeHtml(colab.email)}</small>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="quitarColaboradorNuevaTarea('${colab.email}')" title="Quitar">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // ==========================================
        // PLANTILLAS DE EMAIL
        // ==========================================
        function getTaskAssignmentEmailTemplate(taskDescription, dueDate, priority, assignedBy) {
            const priorityColors = { 'Alta': '#dc3545', 'Normal': '#0d6efd', 'Baja': '#6c757d' };
            const priorityColor = priorityColors[priority] || '#0d6efd';
            const dueDateFormatted = formatDate(dueDate);
            
            return `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
                    <div style="background-color: ${priorityColor}; color: white; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <h2 style="margin: 0; font-size: 20px;">üìã Nueva tarea asignada</h2>
                        <p style="margin: 5px 0 0 0; font-size: 14px;">SchoolNet - Sistema de Gesti√≥n Educativa</p>
                    </div>
                    <div style="background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <p style="margin-top: 0;">Se te ha asignado una nueva tarea:</p>
                        <div style="background-color: #f8f9fa; padding: 15px; border-left: 4px solid ${priorityColor}; margin: 20px 0;">
                            <p style="margin: 0; font-size: 16px; font-weight: bold;">${escapeHtml(taskDescription)}</p>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <tr><td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold; width: 40%;">Prioridad:</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;"><span style="background-color: ${priorityColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">${escapeHtml(priority)}</span></td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold;">Fecha l√≠mite:</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${dueDateFormatted}</td></tr>
                            <tr><td style="padding: 10px; font-weight: bold;">Asignada por:</td>
                                <td style="padding: 10px;">${escapeHtml(assignedBy)}</td></tr>
                        </table>
                        <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 15px; margin: 20px 0;">
                            <p style="margin: 0; color: #0c5460;"><strong>Recuerda:</strong> Ingresa al sistema SchoolNet para gestionar esta tarea y documentar tu progreso.</p>
                        </div>
                    </div>
                    <hr style="margin: 30px 0; border: none; border-top: 1px solid #dee2e6;">
                    <p style="color: #6c757d; font-size: 12px; margin: 0; text-align: center;">Este correo es generado autom√°ticamente por SchoolNet. Por favor, no responder a este mensaje.<br>Colegio Tilata - Sistema de Gesti√≥n Educativa</p>
                </div>
            `;
        }

        function getCollaboratorEmailTemplate(taskDescription, dueDate, priority, responsable, addedBy) {
            const priorityColors = { 'Alta': '#dc3545', 'Normal': '#0d6efd', 'Baja': '#6c757d' };
            const priorityColor = priorityColors[priority] || '#0d6efd';
            const dueDateFormatted = formatDate(dueDate);
            
            return `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
                    <div style="background-color: #17a2b8; color: white; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <h2 style="margin: 0; font-size: 20px;">üë• Has sido agregado como colaborador</h2>
                        <p style="margin: 5px 0 0 0; font-size: 14px;">SchoolNet - Sistema de Gesti√≥n Educativa</p>
                    </div>
                    <div style="background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <p style="margin-top: 0;">Has sido agregado como colaborador en la siguiente tarea:</p>
                        <div style="background-color: #f8f9fa; padding: 15px; border-left: 4px solid ${priorityColor}; margin: 20px 0;">
                            <p style="margin: 0; font-size: 16px; font-weight: bold;">${escapeHtml(taskDescription)}</p>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <tr><td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold; width: 40%;">Responsable principal:</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${escapeHtml(responsable)}</td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold;">Prioridad:</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;"><span style="background-color: ${priorityColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">${escapeHtml(priority)}</span></td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #dee2e6; font-weight: bold;">Fecha l√≠mite:</td>
                                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${dueDateFormatted}</td></tr>
                            <tr><td style="padding: 10px; font-weight: bold;">Agregado por:</td>
                                <td style="padding: 10px;">${escapeHtml(addedBy)}</td></tr>
                        </table>
                        <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 15px; margin: 20px 0;">
                            <p style="margin: 0; color: #0c5460;"><strong>Como colaborador puedes:</strong><br>‚Ä¢ Ver toda la informaci√≥n de la tarea<br>‚Ä¢ Agregar notas de progreso<br><br>Ingresa al sistema SchoolNet para participar en esta tarea.</p>
                        </div>
                    </div>
                    <hr style="margin: 30px 0; border: none; border-top: 1px solid #dee2e6;">
                    <p style="color: #6c757d; font-size: 12px; margin: 0; text-align: center;">Este correo es generado autom√°ticamente por SchoolNet. Por favor, no responder a este mensaje.<br>Colegio Tilata - Sistema de Gesti√≥n Educativa</p>
                </div>
            `;
        }

        // ==========================================
        // ENVIAR NOTIFICACIONES
        // ==========================================
        async function enviarNotificacionTarea(workerEmail, taskDescription, dueDate, priority, assignedBy) {
            try {
                console.log('üìß Enviando notificaci√≥n de tarea a:', workerEmail);
                const subject = 'Nueva tarea asignada';
                const htmlContent = getTaskAssignmentEmailTemplate(taskDescription, dueDate, priority, assignedBy);
                const result = await sendNotification(workerEmail, subject, htmlContent, true);
                if (result) { console.log('‚úÖ Notificaci√≥n enviada exitosamente'); return true; }
                else { console.warn('‚ö†Ô∏è No se pudo enviar la notificaci√≥n'); return false; }
            } catch (error) { console.error('‚ùå Error enviando notificaci√≥n:', error); return false; }
        }
        
        async function enviarNotificacionColaborador(workerEmail, taskDescription, dueDate, priority, responsable, addedBy) {
            try {
                console.log('üìß Enviando notificaci√≥n de colaborador a:', workerEmail);
                const subject = 'Has sido agregado como colaborador en una tarea';
                const htmlContent = getCollaboratorEmailTemplate(taskDescription, dueDate, priority, responsable, addedBy);
                const result = await sendNotification(workerEmail, subject, htmlContent, true);
                if (result) { console.log('‚úÖ Notificaci√≥n de colaborador enviada'); return true; }
                else { console.warn('‚ö†Ô∏è No se pudo enviar notificaci√≥n de colaborador'); return false; }
            } catch (error) { console.error('‚ùå Error enviando notificaci√≥n de colaborador:', error); return false; }
        }
        
        async function manejarCrearTarea(e) {
            e.preventDefault();
            try {
                mostrarLoading();
                const formData = new FormData(e.target);
                const selectedWorker = document.getElementById('nueva-asignada-a').selectedOptions[0];
                
                const datos = {
                    task_description: formData.get('task_description'),
                    assigned_to_mail: formData.get('assigned_to_mail'),
                    assigned_to_name: selectedWorker.dataset.workerName,
                    student_id: null,
                    due_date: formData.get('due_date'),
                    task_priority: formData.get('task_priority'),
                    module_type: 'general-tools',
                    task_progress: formData.get('task_progress') || null,
                    task_state: 'Asignada',
                    created_by: currentUser.user_id
                };
                
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const selectedDate = new Date(datos.due_date);
                if (selectedDate < today) { showMessage('La fecha l√≠mite no puede ser anterior a hoy', 'warning'); ocultarLoading(); return; }
                
                // Crear la tarea
                await supabaseRequest('/tasks', { 
                    method: 'POST', 
                    body: JSON.stringify(datos)
                });
                
                // Enviar notificaci√≥n al responsable principal
                const emailSent = await enviarNotificacionTarea(datos.assigned_to_mail, datos.task_description, datos.due_date, datos.task_priority, currentUser.user_display_name || currentUser.user_mail);
                
                // Si hay colaboradores, buscar el task_id de la tarea reci√©n creada
                let colaboradoresCreados = 0;
                let colaboradoresNotificados = 0;
                
                if (colaboradoresNuevaTarea.length > 0) {
                    // Buscar la tarea reci√©n creada
                    const tareasRecientes = await supabaseRequest(
                        `/tasks?select=task_id&task_description=eq.${encodeURIComponent(datos.task_description)}&created_by=eq.${currentUser.user_id}&order=created_at.desc&limit=1`
                    );
                    
                    const taskId = tareasRecientes && tareasRecientes[0] ? tareasRecientes[0].task_id : null;
                    
                    if (taskId) {
                        for (const colab of colaboradoresNuevaTarea) {
                            try {
                                await supabaseRequest('/task_collaborators', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        task_id: taskId,
                                        worker_email: colab.email,
                                        worker_name: colab.nombre,
                                        added_by: currentUser.user_id,
                                        added_by_name: currentUser.user_display_name || currentUser.user_mail,
                                        collaborator_status: 'active'
                                    })
                                });
                                colaboradoresCreados++;
                                
                                // Enviar notificaci√≥n al colaborador
                                const notifColab = await enviarNotificacionColaborador(
                                    colab.email, 
                                    datos.task_description, 
                                    datos.due_date, 
                                    datos.task_priority, 
                                    datos.assigned_to_name, 
                                    currentUser.user_display_name || currentUser.user_mail
                                );
                                if (notifColab) colaboradoresNotificados++;
                                
                            } catch (err) {
                                console.error('Error creando colaborador:', colab.email, err);
                            }
                        }
                    } else {
                        console.warn('No se pudo obtener task_id para agregar colaboradores');
                    }
                }
                
                // Mensaje seg√∫n resultados
                let mensaje = 'Tarea creada';
                if (emailSent) mensaje += ' y responsable notificado';
                if (colaboradoresCreados > 0) {
                    mensaje += `. ${colaboradoresCreados} colaborador(es) agregado(s)`;
                    if (colaboradoresNotificados > 0) mensaje += ` y notificado(s)`;
                }
                
                showMessage(mensaje, 'success');
                
                // Limpiar colaboradores temporales
                colaboradoresNuevaTarea = [];
                
                modalNuevaTarea.hide();
                await cargarTareas();
            } catch (error) { console.error('‚ùå Error creando tarea:', error); showMessage('Error al crear tarea: ' + error.message, 'danger'); }
            finally { ocultarLoading(); }
        }

        // ==========================================
        // GESTIONAR COLABORADORES
        // ==========================================
        async function gestionarColaboradores(taskId) {
            const tarea = tareasCache.find(t => t.task_id === taskId);
            if (!tarea) { showMessage('Tarea no encontrada', 'danger'); return; }
            
            document.getElementById('colab-task-id').value = taskId;
            document.getElementById('colab-descripcion-tarea').textContent = tarea.task_description || 'Sin descripci√≥n';
            
            await cargarColaboradoresTarea(taskId);
            modalColaboradores.show();
        }
        
        async function cargarColaboradoresTarea(taskId) {
            try {
                const tarea = tareasCache.find(t => t.task_id == taskId);
                const colaboradores = await supabaseRequest(`/task_collaborators?select=*&task_id=eq.${taskId}&collaborator_status=eq.active&order=added_at.asc`);
                
                const container = document.getElementById('lista-colaboradores');
                const badge = document.getElementById('badge-total-colaboradores');
                
                // Actualizar dropdown excluyendo colaboradores existentes
                const emailsColaboradores = colaboradores ? colaboradores.map(c => c.worker_email) : [];
                llenarDropdownColaboradores(tarea?.assigned_to_mail, emailsColaboradores);
                
                if (!colaboradores || colaboradores.length === 0) {
                    container.innerHTML = `<div class="text-center text-muted py-4"><i class="bi bi-people" style="font-size: 2rem;"></i><p class="mb-0 mt-2">No hay colaboradores en esta tarea</p></div>`;
                    badge.textContent = '0';
                    return;
                }
                
                badge.textContent = colaboradores.length;
                
                let html = '';
                colaboradores.forEach(colab => {
                    const iniciales = obtenerIniciales(colab.worker_name);
                    html += `
                        <div class="collaborator-item">
                            <div class="collaborator-info">
                                <div class="collaborator-avatar">${iniciales}</div>
                                <div>
                                    <div class="fw-semibold">${escapeHtml(colab.worker_name)}</div>
                                    <small class="text-muted">${escapeHtml(colab.worker_email)}</small>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removerColaborador('${colab.collaborator_id}')" title="Remover colaborador">
                                <i class="bi bi-person-x"></i>
                            </button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) { console.error('‚ùå Error cargando colaboradores:', error); showMessage('Error al cargar colaboradores', 'danger'); }
        }
        
        async function agregarColaborador() {
            const select = document.getElementById('select-nuevo-colaborador');
            const taskId = document.getElementById('colab-task-id').value;
            
            if (!select.value) { showMessage('Selecciona un trabajador para agregar', 'warning'); return; }
            
            const tarea = tareasCache.find(t => t.task_id == taskId);
            if (!tarea) { showMessage('Tarea no encontrada', 'danger'); return; }
            
            const workerEmail = select.value;
            const workerName = select.selectedOptions[0].dataset.workerName;
            
            try {
                mostrarLoading();
                await supabaseRequest('/task_collaborators', {
                    method: 'POST',
                    body: JSON.stringify({
                        task_id: parseInt(taskId),
                        worker_email: workerEmail,
                        worker_name: workerName,
                        added_by: currentUser.user_id,
                        added_by_name: currentUser.user_display_name || currentUser.user_mail,
                        collaborator_status: 'active'
                    })
                });
                
                const emailSent = await enviarNotificacionColaborador(workerEmail, tarea.task_description, tarea.due_date, tarea.task_priority, tarea.assigned_to_name || tarea.assigned_to_mail, currentUser.user_display_name || currentUser.user_mail);
                
                if (emailSent) { showMessage('Colaborador agregado y notificado exitosamente', 'success'); }
                else { showMessage('Colaborador agregado, pero no se pudo enviar notificaci√≥n', 'warning'); }
                
                await cargarColaboradoresTarea(taskId);
                if (!colaboradoresCache[taskId]) colaboradoresCache[taskId] = 0;
                colaboradoresCache[taskId]++;
            } catch (error) { console.error('‚ùå Error agregando colaborador:', error); showMessage('Error al agregar colaborador: ' + error.message, 'danger'); }
            finally { ocultarLoading(); }
        }
        
        async function removerColaborador(collaboratorId) {
            if (!confirm('¬øEst√°s seguro de remover a este colaborador?')) return;
            
            const taskId = document.getElementById('colab-task-id').value;
            try {
                mostrarLoading();
                await supabaseRequest(`/task_collaborators?collaborator_id=eq.${collaboratorId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ collaborator_status: 'removed', removed_at: new Date().toISOString(), removed_by: currentUser.user_id })
                });
                showMessage('Colaborador removido exitosamente', 'success');
                await cargarColaboradoresTarea(taskId);
                if (colaboradoresCache[taskId] > 0) colaboradoresCache[taskId]--;
            } catch (error) { console.error('‚ùå Error removiendo colaborador:', error); showMessage('Error al remover colaborador: ' + error.message, 'danger'); }
            finally { ocultarLoading(); }
        }

        // ==========================================
        // EDITAR PROGRESO
        // ==========================================
        async function editarProgreso(taskId) {
            const tarea = tareasCache.find(t => t.task_id === taskId);
            if (!tarea) { showMessage('Tarea no encontrada', 'danger'); return; }
            
            document.getElementById('progreso-descripcion').textContent = tarea.task_description || 'N/A';
            document.getElementById('progreso-asignada').textContent = tarea.assigned_to_name || tarea.assigned_to_mail || 'N/A';
            document.getElementById('progreso-fecha').textContent = formatDate(tarea.due_date);
            document.getElementById('progreso-prioridad').textContent = tarea.task_priority || 'Normal';
            document.getElementById('progreso-estado').textContent = tarea.task_state || 'Asignada';
            
            const studentName = tarea.students ? `${tarea.students.student_first_name} ${tarea.students.student_last_name_1} ${tarea.students.student_last_name_2 || ''}`.trim() : 'Sin estudiante';
            document.getElementById('progreso-estudiante').textContent = studentName;
            
            document.getElementById('editar-progreso-text').value = tarea.task_progress || '';
            document.getElementById('editar-estado').value = tarea.task_state || 'Asignada';
            document.getElementById('editar-task-id').value = tarea.task_id;
            document.getElementById('nueva-nota-progreso').value = '';
            
            const esResponsable = tarea.assigned_to_mail === currentUser.user_mail || userHasPermission;
            document.getElementById('seccion-contexto-general').style.display = esResponsable ? 'block' : 'none';
            document.getElementById('seccion-cambiar-estado').style.display = esResponsable ? 'block' : 'none';
            
            await cargarNotasProgreso(taskId);
            modalEditarProgreso.show();
        }
        
        async function cargarNotasProgreso(taskId) {
            try {
                const notas = await supabaseRequest(`/task_progress_notes?select=*&task_id=eq.${taskId}&is_visible=eq.true&order=note_date.desc`);
                const container = document.getElementById('historial-notas-progreso');
                const contador = document.getElementById('contador-notas-progreso');
                
                if (!notas || notas.length === 0) {
                    container.innerHTML = `<div class="text-center text-muted py-3"><i class="bi bi-journal-x"></i> No hay notas registradas</div>`;
                    contador.textContent = '0';
                    return;
                }
                
                contador.textContent = notas.length;
                let html = '';
                notas.forEach(nota => {
                    html += `<div class="note-item"><div class="note-header"><span class="note-author"><i class="bi bi-person-circle me-1"></i>${escapeHtml(nota.worker_name)}</span><span class="note-date"><i class="bi bi-clock me-1"></i>${formatDateTime(nota.note_date)}</span></div><div class="note-content">${escapeHtml(nota.note_content)}</div></div>`;
                });
                container.innerHTML = html;
            } catch (error) { console.error('‚ùå Error cargando notas:', error); }
        }
        
        async function manejarEditarProgreso(e) {
            e.preventDefault();
            try {
                mostrarLoading();
                const taskId = document.getElementById('editar-task-id').value;
                const taskProgress = document.getElementById('editar-progreso-text').value.trim();
                const taskState = document.getElementById('editar-estado').value;
                const nuevaNota = document.getElementById('nueva-nota-progreso').value.trim();
                
                const tarea = tareasCache.find(t => t.task_id == taskId);
                const esResponsable = tarea.assigned_to_mail === currentUser.user_mail || userHasPermission;
                
                if (esResponsable) {
                    const datos = { task_progress: taskProgress, task_state: taskState, updated_at: new Date().toISOString() };
                    if (taskState === 'Terminada') datos.close_date = new Date().toISOString().split('T')[0];
                    await supabaseRequest('/tasks?task_id=eq.' + taskId, { method: 'PATCH', body: JSON.stringify(datos) });
                }
                
                if (nuevaNota) {
                    await supabaseRequest('/task_progress_notes', {
                        method: 'POST',
                        body: JSON.stringify({ task_id: parseInt(taskId), worker_email: currentUser.user_mail, worker_name: currentUser.user_display_name || currentUser.user_mail, note_content: nuevaNota })
                    });
                    if (!notasCache[taskId]) notasCache[taskId] = 0;
                    notasCache[taskId]++;
                }
                
                showMessage('Cambios guardados exitosamente', 'success');
                modalEditarProgreso.hide();
                await cargarTareas();
            } catch (error) { console.error('‚ùå Error actualizando progreso:', error); showMessage('Error al actualizar progreso: ' + error.message, 'danger'); }
            finally { ocultarLoading(); }
        }
        
        // ==========================================
        // VER DETALLE
        // ==========================================
        async function verDetalle(taskId) {
            const tarea = tareasCache.find(t => t.task_id === taskId);
            if (!tarea) { showMessage('Tarea no encontrada', 'danger'); return; }
            
            document.getElementById('detalle-descripcion').textContent = tarea.task_description || 'N/A';
            
            const statusBadges = { 'Asignada': '<span class="badge bg-info text-dark">Asignada</span>', 'En Progreso': '<span class="badge bg-warning text-dark">En Progreso</span>', 'Terminada': '<span class="badge bg-success">Terminada</span>', 'Cancelada': '<span class="badge bg-secondary">Cancelada</span>' };
            document.getElementById('detalle-estado').innerHTML = statusBadges[tarea.task_state] || tarea.task_state;
            
            document.getElementById('detalle-asignada').textContent = tarea.assigned_to_name || tarea.assigned_to_mail || 'N/A';
            
            const studentName = tarea.students ? `${tarea.students.student_first_name} ${tarea.students.student_last_name_1} ${tarea.students.student_last_name_2 || ''}`.trim() : 'Sin estudiante';
            const courseName = tarea.students?.courses?.course_name || '';
            document.getElementById('detalle-estudiante').textContent = studentName + (courseName ? ` (${courseName})` : '');
            
            const priorityBadges = { 'Alta': '<span class="badge bg-danger">Alta</span>', 'Normal': '<span class="badge bg-primary">Normal</span>', 'Baja': '<span class="badge bg-secondary">Baja</span>' };
            document.getElementById('detalle-prioridad').innerHTML = priorityBadges[tarea.task_priority] || tarea.task_priority;
            
            const moduleNames = { 'follow-ups': 'Seguimientos', 'early-alerts': 'Alertas Tempranas', 'general-tools': 'Herramientas Generales' };
            document.getElementById('detalle-modulo').textContent = moduleNames[tarea.module_type] || tarea.module_type;
            
            document.getElementById('detalle-fecha-limite').textContent = formatDate(tarea.due_date);
            document.getElementById('detalle-fecha-cierre').textContent = tarea.close_date ? formatDate(tarea.close_date) : 'No cerrada';
            document.getElementById('detalle-progreso').textContent = tarea.task_progress || 'Sin contexto documentado';
            
            await cargarColaboradoresDetalle(taskId);
            await cargarNotasDetalle(taskId);
            modalVerDetalle.show();
        }
        
        async function cargarColaboradoresDetalle(taskId) {
            try {
                const colaboradores = await supabaseRequest(`/task_collaborators?select=worker_name,worker_email&task_id=eq.${taskId}&collaborator_status=eq.active`);
                const container = document.getElementById('detalle-lista-colaboradores');
                const contador = document.getElementById('detalle-contador-colaboradores');
                
                if (!colaboradores || colaboradores.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-2"><small>Sin colaboradores adicionales</small></div>';
                    contador.textContent = '0';
                    return;
                }
                
                contador.textContent = colaboradores.length;
                let html = '';
                colaboradores.forEach(colab => {
                    const iniciales = obtenerIniciales(colab.worker_name);
                    html += `<div class="collaborator-item"><div class="collaborator-info"><div class="collaborator-avatar">${iniciales}</div><div><div class="small fw-semibold">${escapeHtml(colab.worker_name)}</div><small class="text-muted">${escapeHtml(colab.worker_email)}</small></div></div></div>`;
                });
                container.innerHTML = html;
            } catch (error) { console.error('‚ö†Ô∏è Error cargando colaboradores detalle:', error); }
        }
        
        async function cargarNotasDetalle(taskId) {
            try {
                const notas = await supabaseRequest(`/task_progress_notes?select=*&task_id=eq.${taskId}&is_visible=eq.true&order=note_date.desc`);
                const container = document.getElementById('detalle-historial-notas');
                const contador = document.getElementById('detalle-contador-notas');
                
                if (!notas || notas.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-journal-x"></i> No hay notas registradas</div>';
                    contador.textContent = '0';
                    return;
                }
                
                contador.textContent = notas.length;
                let html = '';
                notas.forEach(nota => {
                    html += `<div class="note-item"><div class="note-header"><span class="note-author"><i class="bi bi-person-circle me-1"></i>${escapeHtml(nota.worker_name)}</span><span class="note-date"><i class="bi bi-clock me-1"></i>${formatDateTime(nota.note_date)}</span></div><div class="note-content">${escapeHtml(nota.note_content)}</div></div>`;
                });
                container.innerHTML = html;
            } catch (error) { console.error('‚ö†Ô∏è Error cargando notas detalle:', error); }
        }
        
        // ==========================================
        // CERRAR Y CANCELAR TAREA
        // ==========================================
        async function cerrarTarea(taskId) {
            const tarea = tareasCache.find(t => t.task_id === taskId);
            if (!tarea) { showMessage('Tarea no encontrada', 'danger'); return; }
            
            const tieneProgreso = tarea.task_progress && tarea.task_progress.trim() !== '';
            const tieneNotas = notasCache[taskId] && notasCache[taskId] > 0;
            
            if (!tieneProgreso && !tieneNotas) {
                showMessage('No puedes cerrar una tarea sin progreso documentado. Agrega al menos una nota de progreso.', 'warning');
                return;
            }
            
            if (!confirm('¬øEst√°s seguro de que deseas marcar esta tarea como Terminada?')) return;
            
            try {
                mostrarLoading();
                await supabaseRequest('/tasks?task_id=eq.' + taskId, {
                    method: 'PATCH',
                    body: JSON.stringify({ task_state: 'Terminada', close_date: new Date().toISOString().split('T')[0], updated_at: new Date().toISOString() })
                });
                showMessage('Tarea cerrada exitosamente', 'success');
                await cargarTareas();
            } catch (error) { console.error('‚ùå Error cerrando tarea:', error); showMessage('Error al cerrar tarea: ' + error.message, 'danger'); }
            finally { ocultarLoading(); }
        }
        
        async function cancelarTarea(taskId) {
            if (!confirm('¬øEst√°s seguro de que deseas CANCELAR esta tarea?\n\nEsta acci√≥n no se puede deshacer.')) return;
            
            try {
                mostrarLoading();
                await supabaseRequest('/tasks?task_id=eq.' + taskId, {
                    method: 'PATCH',
                    body: JSON.stringify({ task_state: 'Cancelada', close_date: new Date().toISOString().split('T')[0], updated_at: new Date().toISOString() })
                });
                showMessage('Tarea cancelada', 'info');
                await cargarTareas();
            } catch (error) { console.error('‚ùå Error cancelando tarea:', error); showMessage('Error al cancelar tarea: ' + error.message, 'danger'); }
            finally { ocultarLoading(); }
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function ocultarLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function obtenerIniciales(nombre) {
            if (!nombre) return '?';
            const partes = nombre.split(' ').filter(p => p.length > 0);
            if (partes.length >= 2) return (partes[0][0] + partes[1][0]).toUpperCase();
            return nombre.substring(0, 2).toUpperCase();
        }
        
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('es-CO', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.abrirModalNuevaTarea = abrirModalNuevaTarea;
        window.editarProgreso = editarProgreso;
        window.verDetalle = verDetalle;
        window.cerrarTarea = cerrarTarea;
        window.cancelarTarea = cancelarTarea;
        window.limpiarFiltros = limpiarFiltros;
        window.gestionarColaboradores = gestionarColaboradores;
        window.agregarColaborador = agregarColaborador;
        window.removerColaborador = removerColaborador;
        window.agregarColaboradorNuevaTarea = agregarColaboradorNuevaTarea;
        window.quitarColaboradorNuevaTarea = quitarColaboradorNuevaTarea;
        
        console.log('üéâ tasks.html v2.0 con colaboradores y notas cargado correctamente');
    </script>
</body>
</html>
