<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Tareas - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSIÓN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tarjetas de tareas */
        .task-card {
            border-left: 4px solid #6c757d;
            transition: all 0.3s ease;
        }
        
        .task-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .task-card.priority-high {
            border-left-color: #dc3545;
        }
        
        .task-card.priority-normal {
            border-left-color: #0d6efd;
        }
        
        .task-card.priority-low {
            border-left-color: #6c757d;
        }
        
        .task-card.overdue {
            background-color: #fff3cd;
        }
        
        /* Badges */
        .badge-priority-high {
            background-color: #dc3545;
        }
        
        .badge-priority-normal {
            background-color: #0d6efd;
        }
        
        .badge-priority-low {
            background-color: #6c757d;
        }
        
        .badge-status-assigned {
            background-color: #0dcaf0;
            color: #000;
        }
        
        .badge-status-progress {
            background-color: #ffc107;
            color: #000;
        }
        
        .badge-status-completed {
            background-color: #198754;
        }
        
        .badge-status-cancelled {
            background-color: #6c757d;
        }
        
        /* Filtros */
        .filters-section {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        /* Estados vacíos */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gestión de Tareas
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE PÁGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-check2-square me-2"></i>
                    Gestión de Tareas
                </h1>
                <p class="text-muted">
                    Administra y da seguimiento a las tareas asignadas
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>
        <!-- SECCIÓN DE FILTROS -->
        <div class="filters-section">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="filter-status" class="form-label">
                        <i class="bi bi-funnel me-1"></i>Estado
                    </label>
                    <select class="form-select" id="filter-status">
                        <option value="">Todos los estados</option>
                        <option value="Asignada">Asignada</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Terminada">Terminada</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="filter-priority" class="form-label">
                        <i class="bi bi-exclamation-circle me-1"></i>Prioridad
                    </label>
                    <select class="form-select" id="filter-priority">
                        <option value="">Todas las prioridades</option>
                        <option value="Alta">Alta</option>
                        <option value="Normal">Normal</option>
                        <option value="Baja">Baja</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="filter-module" class="form-label">
                        <i class="bi bi-box me-1"></i>Módulo Origen
                    </label>
                    <select class="form-select" id="filter-module">
                        <option value="">Todos los módulos</option>
                        <option value="follow-ups">Seguimientos</option>
                        <option value="early-alerts">Alertas Tempranas</option>
                        <option value="general-tools">Herramientas Generales</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="filter-search" class="form-label">
                        <i class="bi bi-search me-1"></i>Buscar
                    </label>
                    <input type="text" class="form-control" id="filter-search" 
                           placeholder="Buscar en descripción...">
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col">
                    <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                        <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                    </button>
                    <button class="btn btn-primary" id="btn-nueva-tarea" onclick="abrirModalNuevaTarea()" style="display: none;">
                        <i class="bi bi-plus-circle me-1"></i>Nueva Tarea
                    </button>
                </div>
            </div>
        </div>

        <!-- LISTADO DE TAREAS -->
        <div class="row" id="tasks-container">
            <div class="col-12">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <div class="mt-2">Cargando tareas...</div>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL: NUEVA TAREA -->
    <div class="modal fade" id="modal-nueva-tarea" tabindex="-1" aria-labelledby="modalNuevaTareaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNuevaTareaLabel">
                        <i class="bi bi-plus-circle me-2"></i>Nueva Tarea
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="form-nueva-tarea">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="nueva-descripcion" class="form-label">
                                Descripción de la tarea <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="nueva-descripcion" name="task_description" 
                                      rows="3" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="nueva-asignada-a" class="form-label">
                                Asignada a <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="nueva-asignada-a" name="assigned_to_mail" required>
                                <option value="">Seleccione un trabajador...</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nueva-fecha-limite" class="form-label">
                                    Fecha límite <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="nueva-fecha-limite" 
                                       name="due_date" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="nueva-prioridad" class="form-label">
                                    Prioridad <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="nueva-prioridad" name="task_priority" required>
                                    <option value="">Seleccione prioridad...</option>
                                    <option value="Alta">Alta</option>
                                    <option value="Normal" selected>Normal</option>
                                    <option value="Baja">Baja</option>
                                </select>
                            </div>
                        </div>
                    
                        
                        <div class="mb-3">
                            <label for="nueva-notas" class="form-label">
                                Notas adicionales
                            </label>
                            <textarea class="form-control" id="nueva-notas" name="task_progress" rows="2"></textarea>
                            <small class="text-muted">Información adicional sobre la tarea</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Crear Tarea
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- MODAL: EDITAR PROGRESO -->
    <div class="modal fade" id="modal-editar-progreso" tabindex="-1" aria-labelledby="modalEditarProgresoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarProgresoLabel">
                        <i class="bi bi-pencil-square me-2"></i>Editar Progreso de Tarea
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="form-editar-progreso">
                    <div class="modal-body">
                        <!-- Información de la tarea (readonly) -->
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Información de la Tarea</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Descripción:</strong></p>
                                        <p class="text-muted" id="progreso-descripcion"></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Asignada a:</strong></p>
                                        <p class="text-muted" id="progreso-asignada"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Fecha límite:</strong></p>
                                        <p class="text-muted" id="progreso-fecha"></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Prioridad:</strong></p>
                                        <p class="text-muted" id="progreso-prioridad"></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Estado actual:</strong></p>
                                        <p class="text-muted" id="progreso-estado"></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Estudiante:</strong></p>
                                        <p class="text-muted" id="progreso-estudiante"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campo editable de progreso -->
                        <div class="mb-3">
                            <label for="editar-progreso-text" class="form-label">
                                Progreso / Notas <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="editar-progreso-text" name="task_progress" 
                                      rows="4" required></textarea>
                            <small class="text-muted">Documenta el avance de la tarea</small>
                        </div>
                        
                        <!-- Cambiar estado -->
                        <div class="mb-3">
                            <label for="editar-estado" class="form-label">
                                Estado de la tarea
                            </label>
                            <select class="form-select" id="editar-estado" name="task_state">
                                <option value="Asignada">Asignada</option>
                                <option value="En Progreso">En Progreso</option>
                                <option value="Terminada">Terminada</option>
                            </select>
                        </div>
                        
                        <input type="hidden" id="editar-task-id" name="task_id">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: VER DETALLE -->
    <div class="modal fade" id="modal-ver-detalle" tabindex="-1" aria-labelledby="modalVerDetalleLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalVerDetalleLabel">
                        <i class="bi bi-info-circle me-2"></i>Detalle de Tarea
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Descripción</h6>
                            <p id="detalle-descripcion"></p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Estado</h6>
                            <p id="detalle-estado"></p>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Asignada a</h6>
                            <p id="detalle-asignada"></p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Estudiante asociado</h6>
                            <p id="detalle-estudiante"></p>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <h6 class="text-muted mb-2">Prioridad</h6>
                            <p id="detalle-prioridad"></p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted mb-2">Módulo origen</h6>
                            <p id="detalle-modulo"></p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted mb-2">Fecha límite</h6>
                            <p id="detalle-fecha-limite"></p>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Fecha de creación</h6>
                            <p id="detalle-fecha-creacion"></p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Fecha de cierre</h6>
                            <p id="detalle-fecha-cierre"></p>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Progreso / Notas</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p id="detalle-progreso" class="mb-0"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let tareasCache = [];
        let trabajadoresCache = [];
        let estudiantesCache = [];
        let currentUser = null;
        let userHasPermission = false;
        
        let modalNuevaTarea = null;
        let modalEditarProgreso = null;
        let modalVerDetalle = null;
        
        // ==========================================
        // INICIALIZACIÓN - PATRÓN OBLIGATORIO
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                // Obtener sesión
                const session = getStoredSession();
                if (!session || !session.user) {
                    console.log('❌ No hay sesión activa');
                    window.location.href = '../../login.html';
                    return;
                }
                
                currentUser = session.user;
                console.log('✅ Usuario autenticado:', currentUser.user_display_name);
                
                // Verificar permiso "Gestionar tareas"
                userHasPermission = await checkUserPermission(currentUser.user_id, 'Gestionar tareas');
                console.log('🔑 Permiso "Gestionar tareas":', userHasPermission);
                
                // Mostrar botón de nueva tarea solo si tiene permiso
                if (userHasPermission) {
                    document.getElementById('btn-nueva-tarea').style.display = 'inline-block';
                }
                
                // Inicializar página
                await inicializarPagina();
                
            } catch (error) {
                console.error('❌ Error en validación de acceso:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCIÓN DE INICIALIZACIÓN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Inicializar modales
                modalNuevaTarea = new bootstrap.Modal(document.getElementById('modal-nueva-tarea'));
                modalEditarProgreso = new bootstrap.Modal(document.getElementById('modal-editar-progreso'));
                modalVerDetalle = new bootstrap.Modal(document.getElementById('modal-ver-detalle'));
                
                // Configurar event listeners
                configurarEventos();
                
                // Cargar datos iniciales
                await cargarTrabajadores();
                await cargarTareas();
                
                ocultarLoading();
                console.log('✅ Página inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CONFIGURACIÓN DE EVENTOS
        // ==========================================
        function configurarEventos() {
            // Formulario nueva tarea
            document.getElementById('form-nueva-tarea').addEventListener('submit', manejarCrearTarea);
            
            // Formulario editar progreso
            document.getElementById('form-editar-progreso').addEventListener('submit', manejarEditarProgreso);
            
            // Filtros
            document.getElementById('filter-status').addEventListener('change', aplicarFiltros);
            document.getElementById('filter-priority').addEventListener('change', aplicarFiltros);
            document.getElementById('filter-module').addEventListener('change', aplicarFiltros);
            document.getElementById('filter-search').addEventListener('input', aplicarFiltros);
            
            // Validar fecha mínima al abrir modal
            document.getElementById('modal-nueva-tarea').addEventListener('show.bs.modal', function() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('nueva-fecha-limite').setAttribute('min', today);
            });
            
            console.log('✅ Event listeners configurados');
        }
        
        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        async function cargarTrabajadores() {
            try {
                console.log('📡 Cargando trabajadores activos...');
                const data = await supabaseRequest('/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,email&worker_status=eq.active&order=worker_first_name.asc');
                
                trabajadoresCache = data || [];
                
                // Llenar dropdown
                const select = document.getElementById('nueva-asignada-a');
                select.innerHTML = '<option value="">Seleccione un trabajador...</option>';
                
                trabajadoresCache.forEach(worker => {
                    const nombreCompleto = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
                    const option = document.createElement('option');
                    option.value = worker.email;
                    option.textContent = nombreCompleto;
                    option.dataset.workerId = worker.worker_id;
                    option.dataset.workerName = nombreCompleto;
                    select.appendChild(option);
                });
                
                console.log(`✅ ${trabajadoresCache.length} trabajadores cargados`);
                
            } catch (error) {
                console.error('❌ Error cargando trabajadores:', error);
                showMessage('Error al cargar trabajadores: ' + error.message, 'danger');
            }
        }
        
         
        async function cargarTareas() {
            try {
                console.log('📡 Cargando tareas...');
                
                // Construir query según permisos
                let query = '/tasks?select=*,students(student_first_name,student_last_name_1,student_last_name_2,courses(course_name))&order=created_at.desc';
                
                if (userHasPermission) {
                    // Usuario con permiso: ve tareas con estudiante + las suyas sin estudiante
                    query += '&or=(student_id.not.is.null,and(student_id.is.null,created_by.eq.' + currentUser.user_id + '))';
                } else {
                    // Usuario sin permiso: solo sus tareas asignadas
                    query += '&assigned_to_mail=eq.' + currentUser.user_mail;
                }
                
                const data = await supabaseRequest(query);
                tareasCache = data || [];
                
                console.log(`✅ ${tareasCache.length} tareas cargadas`);
                renderizarTareas(tareasCache);
                
            } catch (error) {
                console.error('❌ Error cargando tareas:', error);
                showMessage('Error al cargar tareas: ' + error.message, 'danger');
                mostrarEstadoVacio('Error al cargar datos');
            }
        }
      // ==========================================
        // RENDERIZADO DE TAREAS
        // ==========================================
        function renderizarTareas(tareas) {
            const container = document.getElementById('tasks-container');
            
            if (!tareas || tareas.length === 0) {
                mostrarEstadoVacio('No hay tareas disponibles');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let html = '';
            
            tareas.forEach(tarea => {
                const dueDate = new Date(tarea.due_date);
                const isOverdue = tarea.task_state !== 'Terminada' && tarea.task_state !== 'Cancelada' && dueDate < today;
                
                const priorityClass = `priority-${tarea.task_priority?.toLowerCase() || 'normal'}`;
                const overdueClass = isOverdue ? 'overdue' : '';
                
                const studentName = tarea.students 
                    ? `${tarea.students.student_first_name} ${tarea.students.student_last_name_1} ${tarea.students.student_last_name_2 || ''}`.trim()
                    : 'Sin estudiante';
                
                const courseName = tarea.students?.courses?.course_name || '';
                
                const moduleNames = {
                    'follow-ups': 'Seguimientos',
                    'early-alerts': 'Alertas Tempranas',
                    'general-tools': 'Herramientas Generales'
                };
                
                const statusBadgeClass = {
                    'Asignada': 'badge-status-assigned',
                    'En Progreso': 'badge-status-progress',
                    'Terminada': 'badge-status-completed',
                    'Cancelada': 'badge-status-cancelled'
                };
                
                const priorityBadgeClass = {
                    'Alta': 'badge-priority-high',
                    'Normal': 'badge-priority-normal',
                    'Baja': 'badge-priority-low'
                };
                
                // Determinar si puede editar
                const canEdit = userHasPermission || tarea.assigned_to_mail === currentUser.user_mail;
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card task-card ${priorityClass} ${overdueClass} h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="badge ${priorityBadgeClass[tarea.task_priority] || 'badge-priority-normal'}">
                                        ${escapeHtml(tarea.task_priority || 'Normal')}
                                    </span>
                                    <span class="badge ${statusBadgeClass[tarea.task_state] || 'bg-secondary'}">
                                        ${escapeHtml(tarea.task_state || 'Asignada')}
                                    </span>
                                </div>
                                
                                <span class="badge bg-info text-dark mb-2">
                                    ${moduleNames[tarea.module_type] || tarea.module_type}
                                </span>
                                
                                <h6 class="card-title mt-2">
                                    ${escapeHtml(tarea.task_description?.substring(0, 80) || '')}${tarea.task_description?.length > 80 ? '...' : ''}
                                </h6>
                                
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-person me-1"></i>
                                        <strong>Asignada a:</strong> ${escapeHtml(tarea.assigned_to_name || tarea.assigned_to_mail || 'N/A')}
                                    </small>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-mortarboard me-1"></i>
                                        <strong>Estudiante:</strong> ${escapeHtml(studentName)}
                                        ${courseName ? `<span class="badge bg-light text-dark ms-1">${escapeHtml(courseName)}</span>` : ''}
                                    </small>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="${isOverdue ? 'text-danger fw-bold' : 'text-muted'}">
                                        <i class="bi bi-calendar-event me-1"></i>
                                        <strong>Fecha límite:</strong> ${formatDate(tarea.due_date)}
                                        ${isOverdue ? '<span class="badge bg-danger ms-1">VENCIDA</span>' : ''}
                                    </small>
                                </div>
                                
                                ${tarea.close_date ? `
                                    <div class="mb-2">
                                        <small class="text-muted">
                                            <i class="bi bi-check-circle me-1"></i>
                                            <strong>Cerrada:</strong> ${formatDate(tarea.close_date)}
                                        </small>
                                    </div>
                                ` : ''}
                                
                                ${tarea.task_progress ? `
                                    <div class="mb-2">
                                        <small class="text-muted">
                                            <i class="bi bi-journal-text me-1"></i>
                                            <strong>Progreso:</strong> ${escapeHtml(tarea.task_progress.substring(0, 50))}${tarea.task_progress.length > 50 ? '...' : ''}
                                        </small>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="card-footer bg-transparent">
                                <div class="btn-group btn-group-sm w-100" role="group">
                                    <button class="btn btn-outline-primary" onclick="verDetalle(${tarea.task_id})" title="Ver detalle">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    ${canEdit && tarea.task_state !== 'Terminada' && tarea.task_state !== 'Cancelada' ? `
                                        <button class="btn btn-outline-success" onclick="editarProgreso(${tarea.task_id})" title="Editar progreso">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="cerrarTarea(${tarea.task_id})" title="Cerrar tarea">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                    ` : ''}
                                    ${canEdit && tarea.task_state !== 'Cancelada' && tarea.task_state !== 'Terminada' ? `
                                        <button class="btn btn-outline-danger" onclick="cancelarTarea(${tarea.task_id})" title="Cancelar">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function mostrarEstadoVacio(mensaje) {
            const container = document.getElementById('tasks-container');
            container.innerHTML = `
                <div class="col-12">
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <h5>${mensaje}</h5>
                        <p class="text-muted">No se encontraron tareas con los filtros aplicados</p>
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // FILTROS
        // ==========================================
        function aplicarFiltros() {
            const statusFilter = document.getElementById('filter-status').value;
            const priorityFilter = document.getElementById('filter-priority').value;
            const moduleFilter = document.getElementById('filter-module').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();
            
            const tareasFiltradas = tareasCache.filter(tarea => {
                const matchStatus = !statusFilter || tarea.task_state === statusFilter;
                const matchPriority = !priorityFilter || tarea.task_priority === priorityFilter;
                const matchModule = !moduleFilter || tarea.module_type === moduleFilter;
                const matchSearch = !searchFilter || tarea.task_description?.toLowerCase().includes(searchFilter);
                
                return matchStatus && matchPriority && matchModule && matchSearch;
            });
            
            renderizarTareas(tareasFiltradas);
        }
        
        function limpiarFiltros() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-priority').value = '';
            document.getElementById('filter-module').value = '';
            document.getElementById('filter-search').value = '';
            renderizarTareas(tareasCache);
        }
        
        // ==========================================
        // MODAL NUEVA TAREA
        // ==========================================
        function abrirModalNuevaTarea() {
            document.getElementById('form-nueva-tarea').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('nueva-fecha-limite').setAttribute('min', today);
            modalNuevaTarea.show();
        }
        
        async function manejarCrearTarea(e) {
            e.preventDefault();
            
            try {
                mostrarLoading();
                
                const formData = new FormData(e.target);
                const selectedWorker = document.getElementById('nueva-asignada-a').selectedOptions[0];
                
                const datos = {
                    task_description: formData.get('task_description'),
                    assigned_to_mail: formData.get('assigned_to_mail'),
                    assigned_to_name: selectedWorker.dataset.workerName,
                    student_id: null,  // Siempre null desde esta página
                    due_date: formData.get('due_date'),
                    task_priority: formData.get('task_priority'),
                    module_type: 'general-tools',  // Siempre general-tools desde esta página
                    task_progress: formData.get('task_progress') || null,
                    task_state: 'Asignada',
                    created_by: currentUser.user_id
                };
                
                // Validar fecha no en el pasado
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const selectedDate = new Date(datos.due_date);
                
                if (selectedDate < today) {
                    showMessage('La fecha límite no puede ser anterior a hoy', 'warning');
                    ocultarLoading();
                    return;
                }
                
                await supabaseRequest('/tasks', {
                    method: 'POST',
                    body: JSON.stringify(datos)
                });
                
                showMessage('Tarea creada exitosamente', 'success');
                modalNuevaTarea.hide();
                await cargarTareas();
                
            } catch (error) {
                console.error('❌ Error creando tarea:', error);
                showMessage('Error al crear tarea: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
      // ==========================================
        // EDITAR PROGRESO
        // ==========================================
        function editarProgreso(taskId) {
            const tarea = tareasCache.find(t => t.task_id === taskId);
            if (!tarea) {
                showMessage('Tarea no encontrada', 'danger');
                return;
            }
            
            // Llenar información readonly
            document.getElementById('progreso-descripcion').textContent = tarea.task_description || 'N/A';
            document.getElementById('progreso-asignada').textContent = tarea.assigned_to_name || tarea.assigned_to_mail || 'N/A';
            document.getElementById('progreso-fecha').textContent = formatDate(tarea.due_date);
            document.getElementById('progreso-prioridad').textContent = tarea.task_priority || 'Normal';
            document.getElementById('progreso-estado').textContent = tarea.task_state || 'Asignada';
            
            const studentName = tarea.students 
                ? `${tarea.students.student_first_name} ${tarea.students.student_last_name_1} ${tarea.students.student_last_name_2 || ''}`.trim()
                : 'Sin estudiante';
            document.getElementById('progreso-estudiante').textContent = studentName;
            
            // Llenar campos editables
            document.getElementById('editar-progreso-text').value = tarea.task_progress || '';
            document.getElementById('editar-estado').value = tarea.task_state || 'Asignada';
            document.getElementById('editar-task-id').value = tarea.task_id;
            
            modalEditarProgreso.show();
        }
        
        async function manejarEditarProgreso(e) {
            e.preventDefault();
            
            try {
                mostrarLoading();
                
                const taskId = document.getElementById('editar-task-id').value;
                const taskProgress = document.getElementById('editar-progreso-text').value.trim();
                const taskState = document.getElementById('editar-estado').value;
                
                if (!taskProgress) {
                    showMessage('Debes documentar el progreso antes de guardar', 'warning');
                    ocultarLoading();
                    return;
                }
                
                const datos = {
                    task_progress: taskProgress,
                    task_state: taskState,
                    updated_at: new Date().toISOString()
                };
                
                // Si cambia a Terminada, agregar close_date
                if (taskState === 'Terminada') {
                    datos.close_date = new Date().toISOString().split('T')[0];
                }
                
                await supabaseRequest('/tasks?task_id=eq.' + taskId, {
                    method: 'PATCH',
                    body: JSON.stringify(datos)
                });
                
                showMessage('Progreso actualizado exitosamente', 'success');
                modalEditarProgreso.hide();
                await cargarTareas();
                
            } catch (error) {
                console.error('❌ Error actualizando progreso:', error);
                showMessage('Error al actualizar progreso: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // VER DETALLE
        // ==========================================
        function verDetalle(taskId) {
            const tarea = tareasCache.find(t => t.task_id === taskId);
            if (!tarea) {
                showMessage('Tarea no encontrada', 'danger');
                return;
            }
            
            document.getElementById('detalle-descripcion').textContent = tarea.task_description || 'N/A';
            
            const statusBadges = {
                'Asignada': '<span class="badge bg-info text-dark">Asignada</span>',
                'En Progreso': '<span class="badge bg-warning text-dark">En Progreso</span>',
                'Terminada': '<span class="badge bg-success">Terminada</span>',
                'Cancelada': '<span class="badge bg-secondary">Cancelada</span>'
            };
            document.getElementById('detalle-estado').innerHTML = statusBadges[tarea.task_state] || tarea.task_state;
            
            document.getElementById('detalle-asignada').textContent = tarea.assigned_to_name || tarea.assigned_to_mail || 'N/A';
            
            const studentName = tarea.students 
                ? `${tarea.students.student_first_name} ${tarea.students.student_last_name_1} ${tarea.students.student_last_name_2 || ''}`.trim()
                : 'Sin estudiante';
            const courseName = tarea.students?.courses?.course_name || '';
            document.getElementById('detalle-estudiante').textContent = studentName + (courseName ? ` (${courseName})` : '');
            
            const priorityBadges = {
                'Alta': '<span class="badge bg-danger">Alta</span>',
                'Normal': '<span class="badge bg-primary">Normal</span>',
                'Baja': '<span class="badge bg-secondary">Baja</span>'
            };
            document.getElementById('detalle-prioridad').innerHTML = priorityBadges[tarea.task_priority] || tarea.task_priority;
            
            const moduleNames = {
                'follow-ups': 'Seguimientos',
                'early-alerts': 'Alertas Tempranas',
                'general-tools': 'Herramientas Generales'
            };
            document.getElementById('detalle-modulo').textContent = moduleNames[tarea.module_type] || tarea.module_type;
            
            document.getElementById('detalle-fecha-limite').textContent = formatDate(tarea.due_date);
            document.getElementById('detalle-fecha-creacion').textContent = formatDate(tarea.created_at);
            document.getElementById('detalle-fecha-cierre').textContent = tarea.close_date ? formatDate(tarea.close_date) : 'No cerrada';
            
            document.getElementById('detalle-progreso').textContent = tarea.task_progress || 'Sin progreso documentado';
            
            modalVerDetalle.show();
        }
        
        // ==========================================
        // CERRAR TAREA
        // ==========================================
        async function cerrarTarea(taskId) {
            const tarea = tareasCache.find(t => t.task_id === taskId);
            if (!tarea) {
                showMessage('Tarea no encontrada', 'danger');
                return;
            }
            
            if (!tarea.task_progress || tarea.task_progress.trim() === '') {
                showMessage('No puedes cerrar una tarea sin progreso documentado. Edita el progreso primero.', 'warning');
                return;
            }
            
            if (!confirm('¿Estás seguro de que deseas marcar esta tarea como Terminada?')) {
                return;
            }
            
            try {
                mostrarLoading();
                
                const datos = {
                    task_state: 'Terminada',
                    close_date: new Date().toISOString().split('T')[0],
                    updated_at: new Date().toISOString()
                };
                
                await supabaseRequest('/tasks?task_id=eq.' + taskId, {
                    method: 'PATCH',
                    body: JSON.stringify(datos)
                });
                
                showMessage('Tarea cerrada exitosamente', 'success');
                await cargarTareas();
                
            } catch (error) {
                console.error('❌ Error cerrando tarea:', error);
                showMessage('Error al cerrar tarea: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CANCELAR TAREA
        // ==========================================
        async function cancelarTarea(taskId) {
            if (!confirm('¿Estás seguro de que deseas CANCELAR esta tarea?\n\nEsta acción no se puede deshacer.')) {
                return;
            }
            
            try {
                mostrarLoading();
                
                const datos = {
                    task_state: 'Cancelada',
                    close_date: new Date().toISOString().split('T')[0],
                    updated_at: new Date().toISOString()
                };
                
                await supabaseRequest('/tasks?task_id=eq.' + taskId, {
                    method: 'PATCH',
                    body: JSON.stringify(datos)
                });
                
                showMessage('Tarea cancelada', 'info');
                await cargarTareas();
                
            } catch (error) {
                console.error('❌ Error cancelando tarea:', error);
                showMessage('Error al cancelar tarea: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.abrirModalNuevaTarea = abrirModalNuevaTarea;
        window.editarProgreso = editarProgreso;
        window.verDetalle = verDetalle;
        window.cerrarTarea = cerrarTarea;
        window.cancelarTarea = cancelarTarea;
        window.limpiarFiltros = limpiarFiltros;
        
        console.log('🎉 tasks.html cargado correctamente');
    </script>
</body>
</html>
