<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Contratos - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .metric-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        .table-actions {
            white-space: nowrap;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 2rem;
        }
        
        .pdf-viewer-container {
            width: 100%;
            height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .pdf-viewer-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .results-count {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 mb-0" id="loading-text">Procesando...</p>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Dashboard de Contratos
                </li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3 mb-2">
                    <i class="bi bi-graph-up me-2"></i>
                    Dashboard de Contratos
                </h1>
                <p class="text-muted">Vista gerencial de todos los contratos generados en el sistema</p>
            </div>
        </div>

        <!-- Contenedor de Alertas -->
        <div id="alertContainer"></div>

        <!-- M√©tricas Generales -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="metric-label">Total Contratos</p>
                                <h3 class="metric-value text-primary" id="metric-total">0</h3>
                            </div>
                            <div>
                                <i class="bi bi-file-text" style="font-size: 2rem; color: #0d6efd;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="metric-label">Este Mes</p>
                                <h3 class="metric-value text-success" id="metric-month">0</h3>
                            </div>
                            <div>
                                <i class="bi bi-calendar-check" style="font-size: 2rem; color: #198754;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="metric-label">Por Categor√≠a</p>
                                <h3 class="metric-value text-info" id="metric-categories">-</h3>
                            </div>
                            <div>
                                <i class="bi bi-folder-check" style="font-size: 2rem; color: #0dcaf0;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="metric-label">Top Generador</p>
                                <h3 class="metric-value text-warning" id="metric-top" style="font-size: 1rem;">-</h3>
                            </div>
                            <div>
                                <i class="bi bi-person-badge" style="font-size: 2rem; color: #ffc107;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros Avanzados -->
        <div class="filter-section">
            <h5 class="mb-3">
                <i class="bi bi-funnel me-2"></i>Filtros Avanzados
            </h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small">Categor√≠a</label>
                    <select class="form-select" id="filter-category">
                        <option value="">Todas las categor√≠as</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Plantilla</label>
                    <select class="form-select" id="filter-template">
                        <option value="">Todas las plantillas</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Generado por</label>
                    <select class="form-select" id="filter-user">
                        <option value="">Todos los usuarios</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Buscar</label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="filter-search" 
                        placeholder="Buscar por nombre..."
                    >
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Desde</label>
                    <input 
                        type="date" 
                        class="form-control" 
                        id="filter-date-from"
                    >
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Hasta</label>
                    <input 
                        type="date" 
                        class="form-control" 
                        id="filter-date-to"
                    >
                </div>
                <div class="col-md-6">
                    <label class="form-label small">&nbsp;</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="aplicarFiltros()">
                            <i class="bi bi-search me-1"></i>Buscar
                        </button>
                        <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                            <i class="bi bi-x-circle me-1"></i>Limpiar
                        </button>
                        <button class="btn btn-outline-secondary" onclick="cargarDatos()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Contratos -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-table me-2"></i>Contratos
                    </h5>
                    <span class="results-count" id="results-count">0 resultados</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 12%;">Categor√≠a</th>
                                <th style="width: 18%;">Plantilla</th>
                                <th style="width: 25%;">Nombre del Contrato</th>
                                <th style="width: 15%;">Generado por</th>
                                <th style="width: 12%;">Fecha</th>
                                <th style="width: 18%;" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-contratos-body">
                            <!-- Datos cargados din√°micamente -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Estado Vac√≠o -->
                <div id="empty-state" class="empty-state d-none">
                    <i class="bi bi-inbox"></i>
                    <p class="mb-0">No se encontraron contratos con los filtros aplicados</p>
                    <button class="btn btn-sm btn-outline-secondary mt-3" onclick="limpiarFiltros()">
                        <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                    </button>
                </div>
            </div>
            
            <!-- Paginaci√≥n -->
            <div class="card-footer bg-white">
                <div class="pagination-container" id="pagination-container">
                    <!-- Paginaci√≥n generada din√°micamente -->
                </div>
            </div>
        </div>
        <!-- Estad√≠sticas Visuales -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">
                            <i class="bi bi-pie-chart me-2"></i>Contratos por Categor√≠a
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chart-categories"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">
                            <i class="bi bi-bar-chart me-2"></i>Contratos por Mes
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chart-months"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- MODAL: VER PDF -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal fade" id="modal-pdf" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-pdf me-2"></i><span id="pdf-title">Vista Previa del Contrato</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="pdf-viewer-container" id="pdf-viewer">
                        <!-- PDF se carga aqu√≠ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cerrar
                    </button>
                    <a href="#" id="pdf-download-btn" class="btn btn-primary" download>
                        <i class="bi bi-download me-1"></i>Descargar PDF
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let contratosCache = [];
        let contratosFiltrados = [];
        let categoriasCache = [];
        let plantillasCache = [];
        let usuariosCache = [];
        let currentUser = null;
        
        // Gr√°ficos
        let chartCategories = null;
        let chartMonths = null;
        
        // Modal
        let modalPdf = null;
        
        // Paginaci√≥n
        const ITEMS_PER_PAGE = 50;
        let currentPage = 1;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // Validar permisos
                const hasAccess = await validatePageAccess('Ver dashboard de contratos');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - inicializando dashboard');
                await inicializarDashboard();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });

        // ==========================================
        // INICIALIZAR DASHBOARD
        // ==========================================
        async function inicializarDashboard() {
            try {
                mostrarLoading('Iniciando dashboard...');
                
                // Obtener usuario actual
                const session = getStoredSession();
                currentUser = session.user;
                
                // Inicializar modal
                modalPdf = new bootstrap.Modal(document.getElementById('modal-pdf'));
                
                // Cargar datos
                await cargarDatos();
                
                // Inicializar gr√°ficos
                inicializarGraficos();
                
                ocultarLoading();
                console.log('‚úÖ Dashboard inicializado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando dashboard:', error);
                showMessage('Error al cargar el dashboard: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // CARGAR DATOS
        // ==========================================
        async function cargarDatos() {
            try {
                mostrarLoading('Cargando datos...');
                
                // Cargar en paralelo
                await Promise.all([
                    cargarContratos(),
                    cargarCategorias(),
                    cargarPlantillas(),
                    cargarUsuarios()
                ]);
                
                // Aplicar filtros iniciales
                contratosFiltrados = [...contratosCache];
                
                // Actualizar vista
                actualizarMetricas();
                actualizarGraficos();
                renderizarTabla();
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                showMessage('Error al cargar datos: ' + error.message, 'danger');
                throw error;
            }
        }

        // ==========================================
        // CARGAR CONTRATOS
        // ==========================================
        async function cargarContratos() {
            try {
                console.log('üì° Cargando contratos...');
                
                const datos = await supabaseRequest('/generated_contracts?select=*,contract_templates(template_name),contract_categories(category_name),users!generated_contracts_generated_by_fkey(user_display_name,user_mail)&order=generated_at.desc');
                
                contratosCache = datos || [];
                
                console.log(`‚úÖ ${contratosCache.length} contratos cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando contratos:', error);
                throw error;
            }
        }

        // ==========================================
        // CARGAR CATEGOR√çAS
        // ==========================================
        async function cargarCategorias() {
            try {
                console.log('üì° Cargando categor√≠as...');
                
                const datos = await supabaseRequest('/contract_categories?select=*&is_active=eq.true&order=category_name.asc');
                
                categoriasCache = datos || [];
                
                // Llenar filtro
                const filterCategory = document.getElementById('filter-category');
                filterCategory.innerHTML = '<option value="">Todas las categor√≠as</option>' +
                    categoriasCache.map(cat => `<option value="${cat.category_id}">${escapeHtml(cat.category_name)}</option>`).join('');
                
                console.log(`‚úÖ ${categoriasCache.length} categor√≠as cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando categor√≠as:', error);
                throw error;
            }
        }

        // ==========================================
        // CARGAR PLANTILLAS
        // ==========================================
        async function cargarPlantillas() {
            try {
                console.log('üì° Cargando plantillas...');
                
                const datos = await supabaseRequest('/contract_templates?select=template_id,template_name&is_active=eq.true&order=template_name.asc');
                
                plantillasCache = datos || [];
                
                // Llenar filtro
                const filterTemplate = document.getElementById('filter-template');
                filterTemplate.innerHTML = '<option value="">Todas las plantillas</option>' +
                    plantillasCache.map(t => `<option value="${t.template_id}">${escapeHtml(t.template_name)}</option>`).join('');
                
                console.log(`‚úÖ ${plantillasCache.length} plantillas cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando plantillas:', error);
                throw error;
            }
        }

        // ==========================================
        // CARGAR USUARIOS QUE HAN GENERADO CONTRATOS
        // ==========================================
        async function cargarUsuarios() {
            try {
                console.log('üì° Cargando usuarios...');
                
                // Extraer usuarios √∫nicos de los contratos
                const usuariosUnicos = [...new Set(contratosCache.map(c => c.generated_by))];
                
                const datos = await supabaseRequest('/users?select=user_id,user_display_name,user_mail&user_id=in.(' + usuariosUnicos.join(',') + ')&order=user_display_name.asc');
                
                usuariosCache = datos || [];
                
                // Llenar filtro
                const filterUser = document.getElementById('filter-user');
                filterUser.innerHTML = '<option value="">Todos los usuarios</option>' +
                    usuariosCache.map(u => `<option value="${u.user_id}">${escapeHtml(u.user_display_name || u.user_mail)}</option>`).join('');
                
                console.log(`‚úÖ ${usuariosCache.length} usuarios cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando usuarios:', error);
                throw error;
            }
        }

        // ==========================================
        // ACTUALIZAR M√âTRICAS
        // ==========================================
        function actualizarMetricas() {
            // Total de contratos
            const total = contratosFiltrados.length;
            document.getElementById('metric-total').textContent = total;
            
            // Contratos este mes
            const ahora = new Date();
            const primerDiaMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
            const esteMes = contratosFiltrados.filter(c => {
                const fecha = new Date(c.generated_at);
                return fecha >= primerDiaMes;
            }).length;
            document.getElementById('metric-month').textContent = esteMes;
            
            // Por categor√≠a (top 3)
            const porCategoria = {};
            contratosFiltrados.forEach(c => {
                const catName = c.contract_categories?.category_name || 'Sin categor√≠a';
                porCategoria[catName] = (porCategoria[catName] || 0) + 1;
            });
            
            const topCategorias = Object.entries(porCategoria)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([name, count]) => `${name.substring(0, 3)}:${count}`)
                .join(' ');
            
            document.getElementById('metric-categories').textContent = topCategorias || '-';
            
            // Top generador
            const porUsuario = {};
            contratosFiltrados.forEach(c => {
                const userName = c.users?.user_display_name || 'Desconocido';
                porUsuario[userName] = (porUsuario[userName] || 0) + 1;
            });
            
            const topUsuario = Object.entries(porUsuario)
                .sort((a, b) => b[1] - a[1])[0];
            
            if (topUsuario) {
                document.getElementById('metric-top').textContent = `${topUsuario[0]}: ${topUsuario[1]}`;
            } else {
                document.getElementById('metric-top').textContent = '-';
            }
        }
      // ==========================================
        // APLICAR FILTROS
        // ==========================================
        function aplicarFiltros() {
            const categoryFilter = document.getElementById('filter-category').value;
            const templateFilter = document.getElementById('filter-template').value;
            const userFilter = document.getElementById('filter-user').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;
            
            contratosFiltrados = contratosCache.filter(contrato => {
                // Filtro por categor√≠a
                if (categoryFilter && contrato.category_id !== categoryFilter) {
                    return false;
                }
                
                // Filtro por plantilla
                if (templateFilter && contrato.template_id !== templateFilter) {
                    return false;
                }
                
                // Filtro por usuario
                if (userFilter && contrato.generated_by !== userFilter) {
                    return false;
                }
                
                // Filtro por b√∫squeda de texto
                if (searchFilter) {
                    const nombre = contrato.contract_name?.toLowerCase() || '';
                    const notas = contrato.notes?.toLowerCase() || '';
                    if (!nombre.includes(searchFilter) && !notas.includes(searchFilter)) {
                        return false;
                    }
                }
                
                // Filtro por rango de fechas
                const fechaContrato = new Date(contrato.generated_at);
                
                if (dateFrom) {
                    const desde = new Date(dateFrom);
                    desde.setHours(0, 0, 0, 0);
                    if (fechaContrato < desde) {
                        return false;
                    }
                }
                
                if (dateTo) {
                    const hasta = new Date(dateTo);
                    hasta.setHours(23, 59, 59, 999);
                    if (fechaContrato > hasta) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Resetear a p√°gina 1
            currentPage = 1;
            
            // Actualizar vista
            actualizarMetricas();
            actualizarGraficos();
            renderizarTabla();
            
            showMessage(`Se encontraron ${contratosFiltrados.length} contratos`, 'info');
        }

        // ==========================================
        // LIMPIAR FILTROS
        // ==========================================
        function limpiarFiltros() {
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-template').value = '';
            document.getElementById('filter-user').value = '';
            document.getElementById('filter-search').value = '';
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            
            contratosFiltrados = [...contratosCache];
            currentPage = 1;
            
            actualizarMetricas();
            actualizarGraficos();
            renderizarTabla();
            
            showMessage('Filtros limpiados', 'success');
        }

        // ==========================================
        // RENDERIZAR TABLA
        // ==========================================
        function renderizarTabla() {
            const tbody = document.getElementById('tabla-contratos-body');
            const emptyState = document.getElementById('empty-state');
            const resultsCount = document.getElementById('results-count');
            
            if (contratosFiltrados.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('d-none');
                resultsCount.textContent = '0 resultados';
                document.getElementById('pagination-container').innerHTML = '';
                return;
            }
            
            emptyState.classList.add('d-none');
            resultsCount.textContent = `${contratosFiltrados.length} resultado${contratosFiltrados.length !== 1 ? 's' : ''}`;
            
            // Paginaci√≥n
            const inicio = (currentPage - 1) * ITEMS_PER_PAGE;
            const fin = inicio + ITEMS_PER_PAGE;
            const datosPagina = contratosFiltrados.slice(inicio, fin);
            
            tbody.innerHTML = datosPagina.map(contrato => {
                const categoryName = contrato.contract_categories?.category_name || '-';
                const templateName = contrato.contract_templates?.template_name || '-';
                const userName = contrato.users?.user_display_name || contrato.users?.user_mail || 'Desconocido';
                
                return `
                    <tr>
                        <td>
                            <span class="badge bg-secondary">${escapeHtml(categoryName)}</span>
                        </td>
                        <td>
                            <small class="text-muted">${escapeHtml(templateName)}</small>
                        </td>
                        <td>
                            <strong>${escapeHtml(contrato.contract_name)}</strong>
                            ${contrato.notes ? `<br><small class="text-muted">${escapeHtml(contrato.notes)}</small>` : ''}
                        </td>
                        <td>
                            <small>${escapeHtml(userName)}</small>
                        </td>
                        <td>
                            <small>${formatDate(contrato.generated_at)}</small>
                        </td>
                        <td class="text-center table-actions">
                            <button 
                                class="btn btn-sm btn-outline-primary" 
                                onclick="verPDF('${contrato.contract_id}')"
                                title="Ver PDF">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button 
                                class="btn btn-sm btn-outline-success" 
                                onclick="descargarPDF('${contrato.contract_id}')"
                                title="Descargar">
                                <i class="bi bi-download"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            renderizarPaginacion();
        }

        // ==========================================
        // RENDERIZAR PAGINACI√ìN
        // ==========================================
        function renderizarPaginacion() {
            const container = document.getElementById('pagination-container');
            const totalPages = Math.ceil(contratosFiltrados.length / ITEMS_PER_PAGE);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let paginationHTML = '<ul class="pagination mb-0">';
            
            // Bot√≥n anterior
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="cambiarPagina(${currentPage - 1}); return false;">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // N√∫meros de p√°gina
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="cambiarPagina(1); return false;">1</a>
                    </li>
                `;
                if (startPage > 2) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="cambiarPagina(${i}); return false;">${i}</a>
                    </li>
                `;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="cambiarPagina(${totalPages}); return false;">${totalPages}</a>
                    </li>
                `;
            }
            
            // Bot√≥n siguiente
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="cambiarPagina(${currentPage + 1}); return false;">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;
            
            paginationHTML += '</ul>';
            container.innerHTML = paginationHTML;
        }

        // ==========================================
        // CAMBIAR P√ÅGINA
        // ==========================================
        function cambiarPagina(pagina) {
            const totalPages = Math.ceil(contratosFiltrados.length / ITEMS_PER_PAGE);
            
            if (pagina < 1 || pagina > totalPages) {
                return;
            }
            
            currentPage = pagina;
            renderizarTabla();
            
            // Scroll al inicio de la tabla
            document.querySelector('.table-responsive').scrollIntoView({ behavior: 'smooth' });
        }

        // ==========================================
        // VER PDF
        // ==========================================
        async function verPDF(contractId) {
            try {
                const contrato = contratosFiltrados.find(c => c.contract_id === contractId) || 
                                contratosCache.find(c => c.contract_id === contractId);
                
                if (!contrato) {
                    showMessage('Contrato no encontrado', 'danger');
                    return;
                }
                
                const pdfViewer = document.getElementById('pdf-viewer');
                const pdfTitle = document.getElementById('pdf-title');
                const downloadBtn = document.getElementById('pdf-download-btn');
                
                pdfTitle.textContent = contrato.contract_name;
                downloadBtn.href = contrato.pdf_url;
                downloadBtn.download = `${contrato.contract_name}.pdf`;
                
                pdfViewer.innerHTML = `<iframe src="${contrato.pdf_url}" width="100%" height="100%"></iframe>`;
                
                modalPdf.show();
                
            } catch (error) {
                console.error('‚ùå Error viendo PDF:', error);
                showMessage('Error al abrir PDF: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // DESCARGAR PDF
        // ==========================================
        async function descargarPDF(contractId) {
            try {
                const contrato = contratosFiltrados.find(c => c.contract_id === contractId) || 
                                contratosCache.find(c => c.contract_id === contractId);
                
                if (!contrato) {
                    showMessage('Contrato no encontrado', 'danger');
                    return;
                }
                
                const a = document.createElement('a');
                a.href = contrato.pdf_url;
                a.download = `${contrato.contract_name}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showMessage('Descargando PDF...', 'info');
                
            } catch (error) {
                console.error('‚ùå Error descargando PDF:', error);
                showMessage('Error al descargar PDF: ' + error.message, 'danger');
            }
        }
      // ==========================================
        // INICIALIZAR GR√ÅFICOS
        // ==========================================
        function inicializarGraficos() {
            // Gr√°fico de Categor√≠as (Pie Chart)
            const ctxCategories = document.getElementById('chart-categories').getContext('2d');
            chartCategories = new Chart(ctxCategories, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#0d6efd',
                            '#198754',
                            '#ffc107',
                            '#dc3545',
                            '#0dcaf0',
                            '#6c757d',
                            '#6f42c1',
                            '#fd7e14'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Gr√°fico de Meses (Bar Chart)
            const ctxMonths = document.getElementById('chart-months').getContext('2d');
            chartMonths = new Chart(ctxMonths, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Contratos',
                        data: [],
                        backgroundColor: '#0d6efd',
                        borderColor: '#0a58ca',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // ==========================================
        // ACTUALIZAR GR√ÅFICOS
        // ==========================================
        function actualizarGraficos() {
            actualizarGraficoCategories();
            actualizarGraficoMeses();
        }

        // ==========================================
        // ACTUALIZAR GR√ÅFICO DE CATEGOR√çAS
        // ==========================================
        function actualizarGraficoCategories() {
            // Contar por categor√≠a
            const porCategoria = {};
            
            contratosFiltrados.forEach(contrato => {
                const catName = contrato.contract_categories?.category_name || 'Sin categor√≠a';
                porCategoria[catName] = (porCategoria[catName] || 0) + 1;
            });
            
            const labels = Object.keys(porCategoria);
            const data = Object.values(porCategoria);
            
            chartCategories.data.labels = labels;
            chartCategories.data.datasets[0].data = data;
            chartCategories.update();
        }

        // ==========================================
        // ACTUALIZAR GR√ÅFICO DE MESES
        // ==========================================
        function actualizarGraficoMeses() {
            // Obtener √∫ltimos 6 meses
            const meses = [];
            const conteos = [];
            const nombresMeses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            
            const ahora = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const fecha = new Date(ahora.getFullYear(), ahora.getMonth() - i, 1);
                const mesNombre = nombresMeses[fecha.getMonth()];
                const anio = fecha.getFullYear();
                
                meses.push(`${mesNombre} ${anio}`);
                
                // Contar contratos en este mes
                const primerDia = new Date(fecha.getFullYear(), fecha.getMonth(), 1);
                const ultimoDia = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0, 23, 59, 59);
                
                const count = contratosFiltrados.filter(c => {
                    const fechaContrato = new Date(c.generated_at);
                    return fechaContrato >= primerDia && fechaContrato <= ultimoDia;
                }).length;
                
                conteos.push(count);
            }
            
            chartMonths.data.labels = meses;
            chartMonths.data.datasets[0].data = conteos;
            chartMonths.update();
        }

        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading(texto = 'Procesando...') {
            document.getElementById('loading-text').textContent = texto;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.cargarDatos = cargarDatos;
        window.aplicarFiltros = aplicarFiltros;
        window.limpiarFiltros = limpiarFiltros;
        window.cambiarPagina = cambiarPagina;
        window.verPDF = verPDF;
        window.descargarPDF = descargarPDF;
        
        console.log('‚úÖ contracts-dashboard.html cargado correctamente');
    </script>
</body>
</html>
