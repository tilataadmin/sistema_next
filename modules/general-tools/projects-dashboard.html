<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA -->
    <meta name="page-version" content="25.01.15.12.15">
    
    <title>Dashboard de Proyectos - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Variables - Usa colores corporativos de system_config */
        :root {
            --module-primary: var(--system-primary-color, #1B365D);
            --module-secondary: var(--system-secondary-color, #2c5282);
            --module-light: color-mix(in srgb, var(--system-primary-color, #1B365D) 15%, white);
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden { display: none; }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--module-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tarjetas de m√©tricas */
        .metric-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
            height: 100%;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .metric-card .card-body {
            padding: 1.25rem;
        }
        
        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        /* Tarjetas de secci√≥n */
        .section-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        .section-card .card-header {
            background: transparent;
            border-bottom: 1px solid #eee;
            padding: 1rem 1.25rem;
        }
        
        .section-card .card-header h5 {
            margin-bottom: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Alertas */
        .alert-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .alert-item:hover {
            background: #f8f9fa;
        }
        
        .alert-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-size: 1rem;
        }
        
        .alert-critical .alert-icon { background: #fee2e2; color: #dc2626; }
        .alert-warning .alert-icon { background: #fef3c7; color: #d97706; }
        .alert-info .alert-icon { background: #dbeafe; color: #2563eb; }
        
        .alert-count {
            font-size: 1.25rem;
            font-weight: 700;
            margin-left: auto;
        }
        
        /* Sem√°foro de salud */
        .health-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .health-critical { background-color: #dc3545; }
        .health-warning { background-color: #ffc107; }
        .health-healthy { background-color: #28a745; }
        
        /* Tabla de proyectos */
        .projects-table {
            font-size: 0.9rem;
        }
        
        .projects-table th {
            font-weight: 600;
            color: #6c757d;
            border-bottom: 2px solid #dee2e6;
            padding: 0.75rem;
        }
        
        .projects-table td {
            padding: 0.75rem;
            vertical-align: middle;
        }
        
        .projects-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .project-link {
            color: var(--module-primary);
            text-decoration: none;
            font-weight: 500;
        }
        
        .project-link:hover {
            text-decoration: underline;
        }
        
        /* Gr√°ficos */
        .chart-container {
            position: relative;
            height: 250px;
        }
        
        .chart-container-sm {
            height: 200px;
        }
        
        /* KPI cards */
        .kpi-card {
            text-align: center;
            padding: 1.5rem;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--module-light) 0%, white 100%);
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--module-primary);
        }
        
        .kpi-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        /* Filtros */
        .filters-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        /* Badge de estado */
        .badge-estado {
            font-size: 0.75rem;
            padding: 0.35rem 0.65rem;
            border-radius: 1rem;
        }
        
        .badge-activo { background-color: #d4edda; color: #155724; }
        .badge-pausado { background-color: #fff3cd; color: #856404; }
        .badge-completado { background-color: #cce5ff; color: #004085; }
        .badge-cancelado { background-color: #f8d7da; color: #721c24; }
        
        /* Barras de carga por l√≠der */
        .leader-bar {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .leader-name {
            width: 150px;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .leader-bar-container {
            flex-grow: 1;
            margin: 0 1rem;
        }
        
        .leader-bar-fill {
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.5rem;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 30px;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 2.5rem;
            color: #dee2e6;
        }
        
        /* Modal de detalle */
        .modal-project-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .modal-project-item {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .metric-value { font-size: 1.5rem; }
            .kpi-value { font-size: 2rem; }
            .leader-name { width: 100px; }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando dashboard...</p>
        </div>
    </div>

    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Dashboard de Proyectos
                </li>
            </ol>
        </nav>

        <!-- HEADER -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3 mb-1">
                    <i class="bi bi-speedometer2 me-2" style="color: var(--module-primary);"></i>
                    Dashboard de Proyectos
                </h1>
                <p class="text-muted mb-0">
                    Vista ejecutiva de todos los proyectos institucionales
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- FILTROS -->
        <div class="card filters-card">
            <div class="card-body py-3">
                <div class="row g-3 align-items-end">
                    <div class="col-6 col-md-2">
                        <label class="form-label small text-muted">Estado</label>
                        <select class="form-select form-select-sm" id="filtro-estado">
                            <option value="">Todos</option>
                            <option value="Activo" selected>Activos</option>
                            <option value="En Pausa">En Pausa</option>
                            <option value="Completado">Completados</option>
                            <option value="Cancelado">Cancelados</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-2">
                        <label class="form-label small text-muted">L√≠der</label>
                        <select class="form-select form-select-sm" id="filtro-lider">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-2">
                        <label class="form-label small text-muted">Salud</label>
                        <select class="form-select form-select-sm" id="filtro-salud">
                            <option value="">Todas</option>
                            <option value="critical">üî¥ Cr√≠tico</option>
                            <option value="warning">üü° Atenci√≥n</option>
                            <option value="healthy">üü¢ Saludable</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-2">
                        <label class="form-label small text-muted">Per√≠odo</label>
                        <select class="form-select form-select-sm" id="filtro-periodo">
                            <option value="all">Todo</option>
                            <option value="year" selected>Este a√±o</option>
                            <option value="semester">Este semestre</option>
                            <option value="quarter">Este trimestre</option>
                            <option value="month">Este mes</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-4 text-end">
                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="limpiarFiltros()">
                            <i class="bi bi-x-circle me-1"></i>Limpiar
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="cargarDashboard()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESUMEN EJECUTIVO -->
        <div class="row mb-4">
            <div class="col-6 col-lg-3 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="metric-icon" style="background: #d4edda; color: #155724;">
                                <i class="bi bi-play-circle"></i>
                            </div>
                            <div class="ms-3">
                                <div class="metric-value text-success" id="count-activos">0</div>
                                <div class="metric-label">Activos</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="metric-icon" style="background: #fff3cd; color: #856404;">
                                <i class="bi bi-pause-circle"></i>
                            </div>
                            <div class="ms-3">
                                <div class="metric-value text-warning" id="count-pausados">0</div>
                                <div class="metric-label">En Pausa</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="metric-icon" style="background: #cce5ff; color: #004085;">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div class="ms-3">
                                <div class="metric-value text-primary" id="count-completados">0</div>
                                <div class="metric-label">Completados</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3 mb-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="metric-icon" style="background: #f8d7da; color: #721c24;">
                                <i class="bi bi-x-circle"></i>
                            </div>
                            <div class="ms-3">
                                <div class="metric-value text-danger" id="count-cancelados">0</div>
                                <div class="metric-label">Cancelados</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- COLUMNA IZQUIERDA -->
            <div class="col-lg-8">
                
                <!-- ATENCI√ìN REQUERIDA -->
                <div class="card section-card">
                    <div class="card-header">
                        <h5><i class="bi bi-exclamation-triangle me-2"></i>Atenci√≥n Requerida</h5>
                    </div>
                    <div class="card-body" id="alertas-container">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary"></div>
                        </div>
                    </div>
                </div>
                
                <!-- TABLA DE PROYECTOS -->
                <div class="card section-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-table me-2"></i>Salud de los Proyectos</h5>
                        <span class="badge bg-secondary" id="count-tabla">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table projects-table mb-0">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"></th>
                                        <th>Proyecto</th>
                                        <th>L√≠der</th>
                                        <th>Hitos</th>
                                        <th>Tareas</th>
                                        <th>Fecha L√≠mite</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-proyectos">
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <div class="spinner-border spinner-border-sm text-primary"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- COLUMNA DERECHA -->
            <div class="col-lg-4">
                
                <!-- DISTRIBUCI√ìN POR ESTADO -->
                <div class="card section-card">
                    <div class="card-header">
                        <h5><i class="bi bi-pie-chart me-2"></i>Distribuci√≥n por Estado</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container chart-container-sm">
                            <canvas id="chart-estados"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- CARGA POR L√çDER -->
                <div class="card section-card">
                    <div class="card-header">
                        <h5><i class="bi bi-bar-chart me-2"></i>Carga por L√≠der</h5>
                    </div>
                    <div class="card-body" id="carga-lideres-container">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary"></div>
                        </div>
                    </div>
                </div>
                
                <!-- M√âTRICAS DE CUMPLIMIENTO -->
                <div class="card section-card">
                    <div class="card-header">
                        <h5><i class="bi bi-graph-up me-2"></i>M√©tricas de Cumplimiento</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="kpi-card">
                                    <div class="kpi-value" id="kpi-hitos-tiempo">-</div>
                                    <div class="kpi-label">Hitos cumplidos a tiempo</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="kpi-card">
                                    <div class="kpi-value" id="kpi-proyectos-fecha">-</div>
                                    <div class="kpi-label">Proyectos en fecha</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="kpi-card">
                                    <div class="kpi-value" id="kpi-tiempo-promedio">-</div>
                                    <div class="kpi-label">D√≠as promedio</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

    </div>

    <!-- MODAL: DETALLE DE ALERTA -->
    <div class="modal fade" id="modal-alerta" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-alerta-titulo">Detalle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="modal-project-list" id="modal-alerta-contenido">
                        <!-- Contenido din√°mico -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let todosProyectos = [];
        let proyectosFiltrados = [];
        let hitos = [];
        let tareas = [];
        let chartEstados = null;
        let modalAlerta = null;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando Dashboard de Proyectos...');
            
            try {
                mostrarLoading();
                
                // Validar acceso con permiso espec√≠fico
                const hasAccess = await validatePageAccess('Dashboard proyectos');
                if (!hasAccess) return;
                
                const session = getStoredSession();
                if (!session || !session.user) {
                    showMessage('Sesi√≥n no v√°lida', 'warning');
                    setTimeout(() => window.location.href = '../../login.html', 2000);
                    return;
                }
                
                currentUser = session.user;
                
                // Inicializar modal
                modalAlerta = new bootstrap.Modal(document.getElementById('modal-alerta'));
                
                // Configurar eventos de filtros
                configurarFiltros();
                
                // Cargar dashboard
                await cargarDashboard();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                showMessage('Error: ' + error.message, 'danger');
                ocultarLoading();
            }
        });
        
        // ==========================================
        // CONFIGURACI√ìN
        // ==========================================
        function configurarFiltros() {
            ['filtro-estado', 'filtro-lider', 'filtro-salud', 'filtro-periodo'].forEach(id => {
                document.getElementById(id).addEventListener('change', aplicarFiltros);
            });
        }
        
        function limpiarFiltros() {
            document.getElementById('filtro-estado').value = '';
            document.getElementById('filtro-lider').value = '';
            document.getElementById('filtro-salud').value = '';
            document.getElementById('filtro-periodo').value = 'all';
            aplicarFiltros();
        }
        
        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        async function cargarDashboard() {
            try {
                console.log('üìä Cargando dashboard...');
                
                // Cargar todos los proyectos
                todosProyectos = await supabaseRequest('/projects?select=*&order=created_at.desc');
                
                // Cargar hitos de todos los proyectos
                hitos = await supabaseRequest('/project_milestones?select=*');
                
                // Cargar tareas de todos los proyectos
                tareas = await supabaseRequest('/tasks?select=*&module_type=eq.projects');
                
                // Calcular m√©tricas para cada proyecto
                calcularMetricasProyectos();
                
                // Poblar filtro de l√≠deres
                poblarFiltroLideres();
                
                // Aplicar filtros y renderizar
                aplicarFiltros();
                
                console.log('‚úÖ Dashboard cargado');
                
            } catch (error) {
                console.error('‚ùå Error cargando dashboard:', error);
                throw error;
            }
        }
        
        function calcularMetricasProyectos() {
            const today = getCurrentDateColombia();
            
            todosProyectos.forEach(p => {
                // Hitos del proyecto
                const hitosProyecto = hitos.filter(h => h.project_id === p.project_id);
                p.milestones = {
                    total: hitosProyecto.length,
                    completed: hitosProyecto.filter(h => h.milestone_status === 'Cumplido').length,
                    overdue: hitosProyecto.filter(h => h.milestone_status === 'Pendiente' && h.committed_date < today).length,
                    dueSoon: hitosProyecto.filter(h => {
                        if (h.milestone_status !== 'Pendiente') return false;
                        const diffDays = daysDiff(today, h.committed_date);
                        return diffDays >= 0 && diffDays <= 7;
                    }).length
                };
                
                // Tareas del proyecto
                const tareasProyecto = tareas.filter(t => t.reference_id === p.project_id);
                p.tasks = {
                    total: tareasProyecto.length,
                    pending: tareasProyecto.filter(t => ['Pendiente', 'En progreso'].includes(t.task_status)).length,
                    overdue: tareasProyecto.filter(t => 
                        ['Pendiente', 'En progreso'].includes(t.task_status) && 
                        t.task_due_date && t.task_due_date < today
                    ).length
                };
                
                // Salud del proyecto
                p.health = calcularSalud(p);
            });
        }
        
        function calcularSalud(proyecto) {
            if (['Completado', 'Cancelado'].includes(proyecto.project_status)) {
                return 'completed';
            }
            
            const m = proyecto.milestones || {};
            const t = proyecto.tasks || {};
            
            if (m.overdue > 0 || t.overdue > 3) return 'critical';
            if (m.dueSoon > 0 || (t.overdue >= 1 && t.overdue <= 3)) return 'warning';
            return 'healthy';
        }
        
        function poblarFiltroLideres() {
            const lideres = [...new Set(todosProyectos.map(p => p.leader_name))].sort();
            const select = document.getElementById('filtro-lider');
            select.innerHTML = '<option value="">Todos</option>';
            lideres.forEach(l => {
                select.innerHTML += `<option value="${l}">${l}</option>`;
            });
        }
        
        // ==========================================
        // FILTROS
        // ==========================================
        function aplicarFiltros() {
            const estado = document.getElementById('filtro-estado').value;
            const lider = document.getElementById('filtro-lider').value;
            const salud = document.getElementById('filtro-salud').value;
            const periodo = document.getElementById('filtro-periodo').value;
            
            const today = new Date();
            let fechaInicio = null;
            
            switch (periodo) {
                case 'month':
                    fechaInicio = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'quarter':
                    const quarter = Math.floor(today.getMonth() / 3);
                    fechaInicio = new Date(today.getFullYear(), quarter * 3, 1);
                    break;
                case 'semester':
                    const semester = today.getMonth() < 6 ? 0 : 6;
                    fechaInicio = new Date(today.getFullYear(), semester, 1);
                    break;
                case 'year':
                    fechaInicio = new Date(today.getFullYear(), 0, 1);
                    break;
            }
            
            proyectosFiltrados = todosProyectos.filter(p => {
                if (estado && p.project_status !== estado) return false;
                if (lider && p.leader_name !== lider) return false;
                if (salud && p.health !== salud) return false;
                if (fechaInicio) {
                    const fechaProyecto = new Date(p.created_at);
                    if (fechaProyecto < fechaInicio) return false;
                }
                return true;
            });
            
            renderizarDashboard();
        }
        
        // ==========================================
        // RENDERIZADO
        // ==========================================
        function renderizarDashboard() {
            renderizarContadores();
            renderizarAlertas();
            renderizarTabla();
            renderizarGraficoEstados();
            renderizarCargaLideres();
            renderizarKPIs();
        }
        
        function renderizarContadores() {
            const activos = todosProyectos.filter(p => p.project_status === 'Activo').length;
            const pausados = todosProyectos.filter(p => p.project_status === 'En Pausa').length;
            const completados = todosProyectos.filter(p => p.project_status === 'Completado').length;
            const cancelados = todosProyectos.filter(p => p.project_status === 'Cancelado').length;
            
            document.getElementById('count-activos').textContent = activos;
            document.getElementById('count-pausados').textContent = pausados;
            document.getElementById('count-completados').textContent = completados;
            document.getElementById('count-cancelados').textContent = cancelados;
        }
        
        function renderizarAlertas() {
            const container = document.getElementById('alertas-container');
            const today = getCurrentDateColombia();
            
            // Proyectos activos con hitos vencidos
            const conHitosVencidos = proyectosFiltrados.filter(p => 
                p.project_status === 'Activo' && p.milestones.overdue > 0
            );
            
            // Proyectos pr√≥ximos a fecha l√≠mite (15 d√≠as)
            const proximosFechaLimite = proyectosFiltrados.filter(p => {
                if (p.project_status !== 'Activo') return false;
                const diffDays = daysDiff(today, p.expected_end_date);
                return diffDays >= 0 && diffDays <= 15;
            });
            
            // Hitos que vencen esta semana
            const hitosEstaSemana = proyectosFiltrados.filter(p => 
                p.project_status === 'Activo' && p.milestones.dueSoon > 0
            );
            
            // Proyectos con muchas tareas atrasadas
            const conTareasAtrasadas = proyectosFiltrados.filter(p => 
                p.project_status === 'Activo' && p.tasks.overdue > 3
            );
            
            if (conHitosVencidos.length === 0 && proximosFechaLimite.length === 0 && 
                hitosEstaSemana.length === 0 && conTareasAtrasadas.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-3 text-success">
                        <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                        <p class="mb-0 mt-2">No hay alertas pendientes</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            if (conHitosVencidos.length > 0) {
                html += `
                    <div class="alert-item alert-critical" onclick="mostrarDetalleAlerta('hitos-vencidos')">
                        <div class="alert-icon"><i class="bi bi-flag-fill"></i></div>
                        <div>
                            <div class="fw-semibold">Proyectos con hitos vencidos</div>
                            <small class="text-muted">Requieren atenci√≥n inmediata</small>
                        </div>
                        <div class="alert-count text-danger">${conHitosVencidos.length}</div>
                    </div>
                `;
            }
            
            if (conTareasAtrasadas.length > 0) {
                html += `
                    <div class="alert-item alert-critical" onclick="mostrarDetalleAlerta('tareas-atrasadas')">
                        <div class="alert-icon"><i class="bi bi-list-check"></i></div>
                        <div>
                            <div class="fw-semibold">Proyectos con muchas tareas atrasadas</div>
                            <small class="text-muted">M√°s de 3 tareas vencidas</small>
                        </div>
                        <div class="alert-count text-danger">${conTareasAtrasadas.length}</div>
                    </div>
                `;
            }
            
            if (hitosEstaSemana.length > 0) {
                html += `
                    <div class="alert-item alert-warning" onclick="mostrarDetalleAlerta('hitos-semana')">
                        <div class="alert-icon"><i class="bi bi-calendar-event"></i></div>
                        <div>
                            <div class="fw-semibold">Hitos que vencen esta semana</div>
                            <small class="text-muted">Pr√≥ximos 7 d√≠as</small>
                        </div>
                        <div class="alert-count text-warning">${hitosEstaSemana.length}</div>
                    </div>
                `;
            }
            
            if (proximosFechaLimite.length > 0) {
                html += `
                    <div class="alert-item alert-info" onclick="mostrarDetalleAlerta('proximos-limite')">
                        <div class="alert-icon"><i class="bi bi-clock-history"></i></div>
                        <div>
                            <div class="fw-semibold">Proyectos pr√≥ximos a fecha l√≠mite</div>
                            <small class="text-muted">Pr√≥ximos 15 d√≠as</small>
                        </div>
                        <div class="alert-count text-primary">${proximosFechaLimite.length}</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function renderizarTabla() {
            const tbody = document.getElementById('tabla-proyectos');
            const proyectosActivos = proyectosFiltrados.filter(p => 
                ['Activo', 'En Pausa'].includes(p.project_status)
            );
            
            document.getElementById('count-tabla').textContent = proyectosActivos.length;
            
            if (proyectosActivos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            No hay proyectos que mostrar
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ordenar por salud (cr√≠ticos primero)
            proyectosActivos.sort((a, b) => {
                const orden = { critical: 0, warning: 1, healthy: 2 };
                return (orden[a.health] || 3) - (orden[b.health] || 3);
            });
            
            tbody.innerHTML = proyectosActivos.map(p => {
                const m = p.milestones || { completed: 0, total: 0 };
                const t = p.tasks || { pending: 0 };
                
                return `
                    <tr>
                        <td>
                            <span class="health-indicator ${getHealthClass(p.health)}" 
                                  title="${getHealthTooltip(p.health)}"></span>
                        </td>
                        <td>
                            <a href="project-detail.html?id=${p.project_id}" class="project-link">
                                ${escapeHtml(truncateText(p.project_name, 40))}
                            </a>
                        </td>
                        <td class="text-muted">${escapeHtml(truncateText(p.leader_name, 20))}</td>
                        <td>
                            <span class="${m.overdue > 0 ? 'text-danger fw-semibold' : ''}">
                                ${m.completed}/${m.total}
                            </span>
                        </td>
                        <td>
                            <span class="${t.overdue > 0 ? 'text-danger fw-semibold' : ''}">
                                ${t.pending} pend.
                            </span>
                        </td>
                        <td class="text-muted">${formatearFecha(p.expected_end_date)}</td>
                        <td>
                            <span class="badge badge-estado ${getBadgeEstadoClass(p.project_status)}">
                                ${p.project_status}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function renderizarGraficoEstados() {
            const ctx = document.getElementById('chart-estados').getContext('2d');
            
            const datos = {
                activos: proyectosFiltrados.filter(p => p.project_status === 'Activo').length,
                pausados: proyectosFiltrados.filter(p => p.project_status === 'En Pausa').length,
                completados: proyectosFiltrados.filter(p => p.project_status === 'Completado').length,
                cancelados: proyectosFiltrados.filter(p => p.project_status === 'Cancelado').length
            };
            
            if (chartEstados) {
                chartEstados.destroy();
            }
            
            chartEstados = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Activos', 'En Pausa', 'Completados', 'Cancelados'],
                    datasets: [{
                        data: [datos.activos, datos.pausados, datos.completados, datos.cancelados],
                        backgroundColor: ['#28a745', '#ffc107', '#007bff', '#dc3545'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }
        
        function renderizarCargaLideres() {
            const container = document.getElementById('carga-lideres-container');
            
            // Contar proyectos activos por l√≠der
            const cargaPorLider = {};
            proyectosFiltrados
                .filter(p => p.project_status === 'Activo')
                .forEach(p => {
                    cargaPorLider[p.leader_name] = (cargaPorLider[p.leader_name] || 0) + 1;
                });
            
            const lideres = Object.entries(cargaPorLider)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8); // Top 8
            
            if (lideres.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-person"></i>
                        <p class="mb-0 mt-2">Sin proyectos activos</p>
                    </div>
                `;
                return;
            }
            
            const maxCarga = Math.max(...lideres.map(l => l[1]));
            
            // Obtener color primario del sistema
            const primaryColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--system-primary-color').trim() || '#1B365D';
            
            container.innerHTML = lideres.map(([nombre, cantidad]) => {
                const porcentaje = (cantidad / maxCarga) * 100;
                return `
                    <div class="leader-bar">
                        <div class="leader-name" title="${nombre}">${truncateText(nombre, 18)}</div>
                        <div class="leader-bar-container">
                            <div class="leader-bar-fill" style="width: ${porcentaje}%; background-color: ${primaryColor};">
                                ${cantidad}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderizarKPIs() {
            // Hitos cumplidos a tiempo
            const hitosCompletados = hitos.filter(h => h.milestone_status === 'Cumplido');
            const hitosATiempo = hitosCompletados.filter(h => 
                h.actual_date && h.actual_date <= h.committed_date
            );
            const pctHitosTiempo = hitosCompletados.length > 0 
                ? Math.round((hitosATiempo.length / hitosCompletados.length) * 100) 
                : 0;
            document.getElementById('kpi-hitos-tiempo').textContent = pctHitosTiempo + '%';
            
            // Proyectos completados en fecha
            const completados = todosProyectos.filter(p => p.project_status === 'Completado');
            const enFecha = completados.filter(p => 
                p.actual_end_date && p.actual_end_date <= p.expected_end_date
            );
            const pctEnFecha = completados.length > 0 
                ? Math.round((enFecha.length / completados.length) * 100) 
                : 0;
            document.getElementById('kpi-proyectos-fecha').textContent = pctEnFecha + '%';
            
            // Tiempo promedio de completaci√≥n
            let totalDias = 0;
            let conteo = 0;
            completados.forEach(p => {
                if (p.actual_end_date && p.start_date) {
                    const dias = daysDiff(p.start_date, p.actual_end_date);
                    if (dias > 0) {
                        totalDias += dias;
                        conteo++;
                    }
                }
            });
            const promedioDias = conteo > 0 ? Math.round(totalDias / conteo) : '-';
            document.getElementById('kpi-tiempo-promedio').textContent = promedioDias;
        }
        
        // ==========================================
        // MODAL DE DETALLE
        // ==========================================
        function mostrarDetalleAlerta(tipo) {
            const today = getCurrentDateColombia();
            let titulo = '';
            let proyectos = [];
            
            switch (tipo) {
                case 'hitos-vencidos':
                    titulo = 'Proyectos con Hitos Vencidos';
                    proyectos = proyectosFiltrados.filter(p => 
                        p.project_status === 'Activo' && p.milestones.overdue > 0
                    );
                    break;
                case 'tareas-atrasadas':
                    titulo = 'Proyectos con Tareas Atrasadas';
                    proyectos = proyectosFiltrados.filter(p => 
                        p.project_status === 'Activo' && p.tasks.overdue > 3
                    );
                    break;
                case 'hitos-semana':
                    titulo = 'Proyectos con Hitos por Vencer';
                    proyectos = proyectosFiltrados.filter(p => 
                        p.project_status === 'Activo' && p.milestones.dueSoon > 0
                    );
                    break;
                case 'proximos-limite':
                    titulo = 'Proyectos Pr√≥ximos a Fecha L√≠mite';
                    proyectos = proyectosFiltrados.filter(p => {
                        if (p.project_status !== 'Activo') return false;
                        const diffDays = daysDiff(today, p.expected_end_date);
                        return diffDays >= 0 && diffDays <= 15;
                    });
                    break;
            }
            
            document.getElementById('modal-alerta-titulo').textContent = titulo;
            
            document.getElementById('modal-alerta-contenido').innerHTML = proyectos.map(p => `
                <div class="modal-project-item">
                    <div>
                        <div class="fw-semibold">${escapeHtml(p.project_name)}</div>
                        <small class="text-muted">L√≠der: ${escapeHtml(p.leader_name)}</small>
                    </div>
                    <a href="project-detail.html?id=${p.project_id}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye"></i>
                    </a>
                </div>
            `).join('');
            
            modalAlerta.show();
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay')?.classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay')?.classList.add('hidden');
        }
        
        function formatearFecha(fecha) {
            if (!fecha) return '-';
            const d = new Date(fecha + 'T00:00:00');
            return d.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
        }
        
        function getCurrentDateColombia() {
            const now = new Date();
            const colombiaOffset = -5 * 60;
            const localOffset = now.getTimezoneOffset();
            const colombiaTime = new Date(now.getTime() + (localOffset + colombiaOffset) * 60000);
            return colombiaTime.toISOString().split('T')[0];
        }
        
        function daysDiff(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            return Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        function getHealthClass(health) {
            const classes = {
                'critical': 'health-critical',
                'warning': 'health-warning',
                'healthy': 'health-healthy'
            };
            return classes[health] || '';
        }
        
        function getHealthTooltip(health) {
            const tooltips = {
                'critical': 'Cr√≠tico',
                'warning': 'Requiere atenci√≥n',
                'healthy': 'Saludable'
            };
            return tooltips[health] || '';
        }
        
        function getBadgeEstadoClass(estado) {
            const classes = {
                'Activo': 'badge-activo',
                'En Pausa': 'badge-pausado',
                'Completado': 'badge-completado',
                'Cancelado': 'badge-cancelado'
            };
            return classes[estado] || '';
        }
        
        console.log('‚úÖ Dashboard de Proyectos cargado');
    </script>
</body>
</html>
