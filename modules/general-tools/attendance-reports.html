<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA -->
    <meta name="page-version" content="25.11.26.16.39">
    
    <title>Reportes de Asistencia - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stats Cards */
        .stat-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-card.present {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .stat-card.absent {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .stat-card.alert {
            background: linear-gradient(135deg, #ffc107 0%, #ff6b6b 100%);
            color: white;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Person List */
        .person-item {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s;
        }

        .person-item:hover {
            background: #f8f9fa;
        }

        .person-item:last-child {
            border-bottom: none;
        }

        .person-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .person-time {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .person-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .person-badge.student {
            background: #cfe2ff;
            color: #084298;
        }

        .person-badge.worker {
            background: #d1e7dd;
            color: #0f5132;
        }

        /* Filtros */
        .filter-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        /* Tabs personalizados */
        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 0.75rem 1.5rem;
        }

        .nav-tabs .nav-link:hover {
            border-color: #e9ecef;
            color: #495057;
        }

        .nav-tabs .nav-link.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: transparent;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Table styles */
        .table-hover tbody tr {
            cursor: pointer;
        }

        .attendance-table td {
            vertical-align: middle;
        }

        .badge-entrada {
            background: #d4edda;
            color: #155724;
        }

        .badge-salida {
            background: #fff3cd;
            color: #856404;
        }

        .badge-tardanza {
            background: #f8d7da;
            color: #721c24;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stat-value {
                font-size: 2rem;
            }

            .nav-tabs .nav-link {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Reportes de Asistencia
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-file-bar-graph me-2"></i>
                    Reportes de Asistencia
                </h1>
                <p class="text-muted">
                    Consultas y an√°lisis de registros de asistencia
                </p>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-primary" onclick="window.location.href='attendance.html'">
                    <i class="bi bi-arrow-left me-1"></i>Volver a Registro
                </button>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- ESTAD√çSTICAS GENERALES -->
        <div class="row mb-4" id="stats-container">
            <div class="col-md-4 mb-3">
                <div class="stat-card present p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="stat-value" id="stat-present">0</p>
                            <p class="stat-label mb-0">Presentes Ahora</p>
                        </div>
                        <i class="bi bi-check-circle" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stat-card absent p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="stat-value" id="stat-absent">0</p>
                            <p class="stat-label mb-0">Ausentes Hoy</p>
                        </div>
                        <i class="bi bi-x-circle" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stat-card alert p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="stat-value" id="stat-alerts">0</p>
                            <p class="stat-label mb-0">Alertas</p>
                        </div>
                        <i class="bi bi-exclamation-triangle" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- PESTA√ëAS DE REPORTES -->
        <ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="presencia-tab" data-bs-toggle="tab" data-bs-target="#presencia" type="button">
                    <i class="bi bi-people me-1"></i>Presencia Actual
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ausentes-tab" data-bs-toggle="tab" data-bs-target="#ausentes" type="button">
                    <i class="bi bi-person-x me-1"></i>Ausentes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button">
                    <i class="bi bi-clock-history me-1"></i>Historial
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="alertas-tab" data-bs-toggle="tab" data-bs-target="#alertas" type="button">
                    <i class="bi bi-exclamation-triangle me-1"></i>Alertas
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cursos-tab" data-bs-toggle="tab" data-bs-target="#cursos" type="button">
                    <i class="bi bi-mortarboard me-1"></i>Por Curso
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="areas-tab" data-bs-toggle="tab" data-bs-target="#areas" type="button">
                    <i class="bi bi-building me-1"></i>Por √Årea
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="puntualidad-tab" data-bs-toggle="tab" data-bs-target="#puntualidad" type="button">
                    <i class="bi bi-alarm me-1"></i>Puntualidad
                </button>
            </li>
        </ul>

        <!-- CONTENIDO DE LAS PESTA√ëAS -->
        <div class="tab-content" id="reportTabsContent">
            
            <!-- TAB 1: PRESENCIA ACTUAL -->
            <div class="tab-pane fade show active" id="presencia" role="tabpanel">
                <div class="row">
                    <!-- Estudiantes Presentes -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-mortarboard me-2"></i>Estudiantes Presentes
                                </h5>
                                <span class="badge bg-light text-success" id="count-students-present">0</span>
                            </div>
                            <div class="card-body p-0">
                                <!-- ‚úÖ NUEVO: Filtro por curso -->
                                <div class="filter-section mx-3 mt-3">
                                    <label class="form-label fw-bold">Filtrar por curso:</label>
                                    <select class="form-select form-select-sm" id="filter-course-present" onchange="cargarPresenciaActual()">
                                        <option value="">Todos los cursos</option>
                                    </select>
                                </div>
                                <div id="students-present-list" style="max-height: 500px; overflow-y: auto;">
                                    <div class="empty-state">
                                        <i class="bi bi-inbox"></i>
                                        <p>No hay estudiantes presentes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trabajadores Presentes -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-people me-2"></i>Trabajadores Presentes
                                </h5>
                                <span class="badge bg-light text-success" id="count-workers-present">0</span>
                            </div>
                            <div class="card-body p-0">
                                <div id="workers-present-list" style="max-height: 500px; overflow-y: auto;">
                                    <div class="empty-state">
                                        <i class="bi bi-inbox"></i>
                                        <p>No hay trabajadores presentes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: AUSENTES -->
            <div class="tab-pane fade" id="ausentes" role="tabpanel">
                <div class="row">
                    <!-- Estudiantes Ausentes -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-mortarboard me-2"></i>Estudiantes Ausentes
                                </h5>
                                <span class="badge bg-light text-danger" id="count-students-absent">0</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="filter-section mx-3 mt-3">
                                    <label class="form-label fw-bold">Filtrar por curso:</label>
                                    <select class="form-select form-select-sm" id="filter-course-absent" onchange="cargarAusentes()">
                                        <option value="">Todos los cursos</option>
                                    </select>
                                </div>
                                <div id="students-absent-list" style="max-height: 500px; overflow-y: auto;">
                                    <div class="empty-state">
                                        <i class="bi bi-inbox"></i>
                                        <p>Cargando...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trabajadores Ausentes -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-people me-2"></i>Trabajadores Ausentes
                                </h5>
                                <span class="badge bg-light text-danger" id="count-workers-absent">0</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="filter-section mx-3 mt-3">
                                    <label class="form-label fw-bold">Filtrar por √°rea:</label>
                                    <select class="form-select form-select-sm" id="filter-area-absent" onchange="cargarAusentes()">
                                        <option value="">Todas las √°reas</option>
                                    </select>
                                </div>
                                <div id="workers-absent-list" style="max-height: 500px; overflow-y: auto;">
                                    <div class="empty-state">
                                        <i class="bi bi-inbox"></i>
                                        <p>Cargando...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: HISTORIAL DE PERSONA -->
            <div class="tab-pane fade" id="historial" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-search me-2"></i>Buscar Historial de Asistencia
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- B√∫squeda -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Buscar persona:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="search-person-history" 
                                           placeholder="Nombre o documento...">
                                    <button class="btn btn-primary" onclick="buscarPersonaHistorial()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Fecha inicio:</label>
                                <input type="date" class="form-control" id="history-date-start">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Fecha fin:</label>
                                <input type="date" class="form-control" id="history-date-end">
                            </div>
                        </div>

                        <!-- Resultados de b√∫squeda de persona -->
                        <div id="person-search-results" style="display: none;">
                            <h6>Resultados de b√∫squeda:</h6>
                            <div id="person-search-list" class="border rounded mb-3" style="max-height: 150px; overflow-y: auto;">
                            </div>
                        </div>

                        <!-- Historial de la persona seleccionada -->
                        <div id="person-history-container" style="display: none;">
                            <hr>
                            <div class="alert alert-info">
                                <h6 id="selected-person-name"></h6>
                                <small id="selected-person-details"></small>
                            </div>

                            <!-- Tabla de historial -->
                            <div class="table-responsive">
                                <table class="table table-hover attendance-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Entrada</th>
                                            <th>Salida</th>
                                            <th>Permanencia</th>
                                            <th>M√©todo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-table-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 4: ALERTAS -->
            <div class="tab-pane fade" id="alertas" role="tabpanel">
                <div class="row">
                    <!-- Registros Irregulares -->
                    <div class="col-lg-12 mb-4">
                        <div class="card">
                            <div class="card-header bg-warning">
                                <h5 class="mb-0">
                                    <i class="bi bi-exclamation-circle me-2"></i>Registros Irregulares
                                </h5>
                                <small class="text-muted">Personas con m√°s de 2 entradas/salidas en el d√≠a</small>
                            </div>
                            <div class="card-body p-0">
                                <div id="alert-irregular-list" style="max-height: 600px; overflow-y: auto;">
                                    <div class="empty-state">
                                        <i class="bi bi-inbox"></i>
                                        <p>No hay alertas</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- TAB 5: POR CURSO -->
            <div class="tab-pane fade" id="cursos" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-mortarboard me-2"></i>Asistencia por Curso
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Filtros -->
                        <div class="filter-section mb-4">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Fecha:</label>
                                    <input type="date" class="form-control" id="course-report-date" onchange="cargarReporteCursos()">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Grado:</label>
                                    <select class="form-select" id="filter-grade-course" onchange="cargarReporteCursos()">
                                        <option value="">Todos los grados</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de resultados -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Curso</th>
                                        <th>Total Estudiantes</th>
                                        <th>Presentes</th>
                                        <th>Ausentes</th>
                                        <th>% Asistencia</th>
                                    </tr>
                                </thead>
                                <tbody id="courses-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Seleccione una fecha</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 6: POR √ÅREA -->
            <div class="tab-pane fade" id="areas" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-building me-2"></i>Asistencia por √Årea Organizacional
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Filtros -->
                        <div class="filter-section mb-4">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Fecha:</label>
                                    <input type="date" class="form-control" id="area-report-date" onchange="cargarReporteAreas()">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Divisi√≥n:</label>
                                    <select class="form-select" id="filter-division" onchange="cargarReporteAreas()">
                                        <option value="">Todas las divisiones</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de resultados -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>√Årea</th>
                                        <th>Divisi√≥n</th>
                                        <th>Total Trabajadores</th>
                                        <th>Presentes</th>
                                        <th>Ausentes</th>
                                        <th>% Asistencia</th>
                                    </tr>
                                </thead>
                                <tbody id="areas-table-body">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">Seleccione una fecha</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 7: PUNTUALIDAD - ¬°ESTA SECCI√ìN FALTABA! -->
            <div class="tab-pane fade" id="puntualidad" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-alarm me-2"></i>An√°lisis de Puntualidad
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Informaci√≥n de hora de referencia -->
                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Hora de referencia para puntualidad:</strong> 
                            <span id="punctuality-time">7:00 AM</span>
                        </div>

                        <!-- Filtros -->
                        <div class="filter-section mb-4">
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Fecha:</label>
                                    <input type="date" class="form-control" id="punctuality-date" onchange="cargarReportePuntualidad()">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Tipo de persona:</label>
                                    <select class="form-select" id="punctuality-type" onchange="cargarReportePuntualidad()">
                                        <option value="">Todos</option>
                                        <option value="student">Estudiantes</option>
                                        <option value="worker">Trabajadores</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Estado:</label>
                                    <select class="form-select" id="punctuality-status" onchange="cargarReportePuntualidad()">
                                        <option value="">Todos</option>
                                        <option value="ontime">A tiempo</option>
                                        <option value="late">Tardanza</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" onclick="cargarReportePuntualidad()">
                                        <i class="bi bi-search me-1"></i>Buscar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de resultados -->
                        <div class="table-responsive">
                            <table class="table table-hover attendance-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Persona</th>
                                        <th>Tipo</th>
                                        <th>Hora de Entrada</th>
                                        <th>Estado</th>
                                        <th>Diferencia</th>
                                    </tr>
                                </thead>
                                <tbody id="punctuality-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Seleccione una fecha y haga clic en Buscar</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Scripts - ORDEN CR√çTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let selectedPersonHistory = null;
        let punctualityReferenceTimeStudents = null;
        let punctualityReferenceTimeWorkers = null;
        
        // ‚úÖ NUEVO: Cache de nombres para evitar consultas repetidas
        let nombresCache = {
            students: {},
            workers: {}
        };
        // Cache de trabajadores con trabajo remoto aprobado para hoy
        let trabajadoresRemotos = new Set();
        // Indica si hoy es un d√≠a virtual completo (todo el personal remoto)
        let esDiaVirtual = false;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Validando acceso al m√≥dulo de Reportes de Asistencia...');
            
            try {
                // Validar permisos
                const hasAccess = await validatePageAccess('Reportes de asistencia');
                if (!hasAccess) return;

                // Obtener usuario actual
                const session = getStoredSession();
                if (!session || !session.user) {
                    console.log('‚ùå No hay sesi√≥n activa');
                    window.location.href = '../../login.html';
                    return;
                }
                
                currentUser = session.user;
                console.log('‚úÖ Usuario autenticado:', currentUser.user_display_name);

                // Inicializar componentes
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error validando acceso:', error);
                showMessage('Error de autenticaci√≥n', 'danger');
            }
        });

        // ==========================================
        // INICIALIZACI√ìN DE LA P√ÅGINA
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
        
                // Cargar cache de nombres PRIMERO
                await cargarCacheNombres();
                
                // Cargar trabajadores con trabajo remoto aprobado
                await cargarTrabajadoresRemotos();
                
                // Verificar si hoy es d√≠a virtual
                await verificarDiaVirtual();
                
                // Cargar hora de puntualidad desde system_config
                await cargarHoraPuntualidad();
                
                // Configurar fechas por defecto (hoy)
                const today = new Date().toISOString().split('T')[0];
                const historyStartElement = document.getElementById('history-date-start');
                const historyEndElement = document.getElementById('history-date-end');
                const courseReportElement = document.getElementById('course-report-date');
                const areaReportElement = document.getElementById('area-report-date');
                const punctualityDateElement = document.getElementById('punctuality-date');
        
                if (historyStartElement) historyStartElement.value = today;
                if (historyEndElement) historyEndElement.value = today;
                if (courseReportElement) courseReportElement.value = today;
                if (areaReportElement) areaReportElement.value = today;
                if (punctualityDateElement) punctualityDateElement.value = today;
        
                // Cargar filtros
                await cargarFiltros();
        
                // Cargar estad√≠sticas generales
                await cargarEstadisticasGenerales();
        
                // Cargar presencia actual (tab activo por defecto)
                await cargarPresenciaActual();
        
                // Configurar eventos de pesta√±as
                configurarEventosPestanas();
        
                // Mostrar banner si es d√≠a virtual
                if (esDiaVirtual) {
                    mostrarBannerDiaVirtual();
                }
        
                ocultarLoading();
                console.log('‚úÖ P√°gina de reportes inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // CARGAR CACHE DE NOMBRES
        // ==========================================
        async function cargarCacheNombres() {
            try {
                console.log('üìù Cargando cache de nombres...');
                
                // Cargar TODOS los estudiantes de una vez
                const estudiantes = await supabaseRequest('/students?select=student_id_document,student_first_name,student_last_name_1,student_last_name_2');
                if (estudiantes) {
                    estudiantes.forEach(e => {
                        if (e.student_id_document) {
                            nombresCache.students[e.student_id_document] = 
                                `${e.student_last_name_1} ${e.student_last_name_2 || ''} ${e.student_first_name}`.trim();
                        }
                    });
                }
                
                // Cargar TODOS los trabajadores de una vez
                const trabajadores = await supabaseRequest('/workers?select=worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2');
                if (trabajadores) {
                    trabajadores.forEach(t => {
                        if (t.worker_id_doc) {
                            nombresCache.workers[t.worker_id_doc] = 
                                `${t.worker_last_name_1} ${t.worker_last_name_2 || ''} ${t.worker_first_name}`.trim();
                        }
                    });
                }
                
                console.log(`‚úÖ Cache cargado: ${Object.keys(nombresCache.students).length} estudiantes, ${Object.keys(nombresCache.workers).length} trabajadores`);
            } catch (error) {
                console.error('‚ùå Error cargando cache de nombres:', error);
            }
        }

        // ==========================================
        // CARGAR TRABAJADORES CON TRABAJO REMOTO APROBADO HOY
        // ==========================================
        async function cargarTrabajadoresRemotos() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Obtener categor√≠as de trabajo remoto
                const categoriasRemotas = await supabaseRequest(
                    '/hr_absence_categories?select=category_id&is_remote_work=eq.true&is_active=eq.true'
                );
                
                if (!categoriasRemotas || categoriasRemotas.length === 0) {
                    console.log('‚ÑπÔ∏è No hay categor√≠as de trabajo remoto configuradas');
                    trabajadoresRemotos = new Set();
                    return;
                }
                
                const categoryIds = categoriasRemotas.map(c => c.category_id);
                
                // Obtener solicitudes aprobadas de trabajo remoto para hoy
                const solicitudes = await supabaseRequest(
                    `/hr_absence_requests?select=worker_id,workers(worker_id_doc)&status=eq.approved&category_id=in.(${categoryIds.join(',')})&start_date=lte.${today}&end_date=gte.${today}`
                );
                
                trabajadoresRemotos = new Set();
                
                if (solicitudes && solicitudes.length > 0) {
                    solicitudes.forEach(s => {
                        if (s.workers && s.workers.worker_id_doc) {
                            trabajadoresRemotos.add(s.workers.worker_id_doc);
                        }
                    });
                }
                
                console.log(`üè† ${trabajadoresRemotos.size} trabajadores con trabajo remoto aprobado hoy`);
                
            } catch (error) {
                console.error('‚ùå Error cargando trabajadores remotos:', error);
                trabajadoresRemotos = new Set();
            }
        }

        // ==========================================
        // VERIFICAR SI HOY ES D√çA VIRTUAL
        // ==========================================
        async function verificarDiaVirtual() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                const diasVirtuales = await supabaseRequest(
                    `/hr_non_work_days?select=non_work_day_id,description&day_type=eq.virtual_day&start_date=lte.${today}&end_date=gte.${today}`
                );
                
                if (diasVirtuales && diasVirtuales.length > 0) {
                    esDiaVirtual = true;
                    console.log('üè† Hoy es D√çA VIRTUAL:', diasVirtuales[0].description);
                } else {
                    esDiaVirtual = false;
                }
                
            } catch (error) {
                console.error('‚ùå Error verificando d√≠a virtual:', error);
                esDiaVirtual = false;
            }
        }

        // ==========================================
        // MOSTRAR BANNER DE D√çA VIRTUAL
        // ==========================================
        function mostrarBannerDiaVirtual() {
            const alertContainer = document.getElementById('alertContainer');
            
            const bannerHtml = `
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-house-door fs-4 me-3"></i>
                        <div>
                            <strong>üè† D√≠a Virtual Activo</strong>
                            <p class="mb-0">Hoy est√° configurado como d√≠a de trabajo virtual. Todo el personal trabaja de forma remota.</p>
                            <small class="text-muted">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                En caso de emergencia: No hay personal f√≠sicamente en el edificio.
                            </small>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            alertContainer.innerHTML = bannerHtml + alertContainer.innerHTML;
        }

        // ==========================================
        // CARGAR HORA DE PUNTUALIDAD
        // ==========================================
        async function cargarHoraPuntualidad() {
            try {
                const config = await supabaseRequest('/system_config?select=punctuality_reference_time_students,punctuality_reference_time_workers&limit=1');
                if (config && config.length > 0) {
                    punctualityReferenceTimeStudents = config[0].punctuality_reference_time_students || '08:20:00';
                    punctualityReferenceTimeWorkers = config[0].punctuality_reference_time_workers || '07:00:00';
                    
                    // Formatear para mostrar (mostramos ambas)
                    const formatTime = (time) => {
                        const [hours, minutes] = time.split(':');
                        const hour = parseInt(hours);
                        const ampm = hour >= 12 ? 'PM' : 'AM';
                        const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                        return `${displayHour}:${minutes} ${ampm}`;
                    };
                    
                    const punctualityTimeElement = document.getElementById('punctuality-time');
                    if (punctualityTimeElement) {
                        punctualityTimeElement.innerHTML = `
                            <strong>Estudiantes:</strong> ${formatTime(punctualityReferenceTimeStudents)} | 
                            <strong>Trabajadores:</strong> ${formatTime(punctualityReferenceTimeWorkers)}
                        `;
                    }
                    console.log('‚úÖ Horas de puntualidad cargadas - Estudiantes:', punctualityReferenceTimeStudents, 'Trabajadores:', punctualityReferenceTimeWorkers);
                }
            } catch (error) {
                console.error('Error cargando horas de puntualidad:', error);
            }
        }

        
        // ==========================================
        // CARGAR FILTROS
        // ==========================================
       async function cargarFiltros() {
            try {
                // Cargar cursos √∫nicos para filtro de ausentes
                const courses = await supabaseRequest('/courses?select=course_id,course_name&course_status=eq.active&order=course_name.asc');
                if (courses) {
                    const courseSelect = document.getElementById('filter-course-absent');
                    const coursePresentSelect = document.getElementById('filter-course-present'); // ‚úÖ NUEVO
                    const gradeSelect = document.getElementById('filter-grade-course');
                    
                    courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.course_id;
                        option.textContent = course.course_name;
                        if (courseSelect) courseSelect.appendChild(option);
                        
                        // ‚úÖ NUEVO: Agregar al filtro de presentes
                        if (coursePresentSelect) {
                            const option2 = option.cloneNode(true);
                            coursePresentSelect.appendChild(option2);
                        }
                        
                        if (gradeSelect) {
                            const option3 = option.cloneNode(true);
                            gradeSelect.appendChild(option3);
                        }
                    });
                }

                // Cargar divisiones para filtro de trabajadores ausentes
                const divisions = await supabaseRequest('/organizational_divisions?select=division_id,division_name&division_status=eq.active&order=division_name.asc');
                if (divisions) {
                    const divisionSelect = document.getElementById('filter-area-absent');
                    const divisionSelect2 = document.getElementById('filter-division');
                    
                    divisions.forEach(division => {
                        const option = document.createElement('option');
                        option.value = division.division_id;
                        option.textContent = division.division_name;
                        if (divisionSelect) divisionSelect.appendChild(option);
                        
                        if (divisionSelect2) {
                            const option2 = option.cloneNode(true);
                            divisionSelect2.appendChild(option2);
                        }
                    });
                }

            } catch (error) {
                console.error('Error cargando filtros:', error);
            }
        }

        // ==========================================
        // CONFIGURAR EVENTOS DE PESTA√ëAS
        // ==========================================
        function configurarEventosPestanas() {
            const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
            
            tabButtons.forEach(button => {
                button.addEventListener('shown.bs.tab', async function (event) {
                    const targetId = event.target.getAttribute('data-bs-target');
                    
                    switch(targetId) {
                        case '#presencia':
                            await cargarPresenciaActual();
                            break;
                        case '#ausentes':
                            await cargarAusentes();
                            break;
                        case '#alertas':
                            await cargarAlertas();
                            break;
                        case '#cursos':
                            await cargarReporteCursos(); // ‚úÖ NUEVO
                            break;
                        case '#areas':
                            await cargarReporteAreas(); // ‚úÖ NUEVO
                            break;
                        case '#puntualidad':
                            await cargarReportePuntualidad();
                            break;
                    }
                });
            });
        }

        // ==========================================
        // CARGAR ESTAD√çSTICAS GENERALES
        // ==========================================
        async function cargarEstadisticasGenerales() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Si es d√≠a virtual, mostrar estad√≠sticas especiales
                if (esDiaVirtual) {
                    document.getElementById('stat-present').textContent = '0';
                    document.getElementById('stat-absent').textContent = '0';
                    document.getElementById('stat-alerts').textContent = 'üè†';
                    return;
                }
                
                // Obtener todos los registros del d√≠a
                const registros = await supabaseRequest(`/attendance?select=*&attendance_date=eq.${today}`);
                
                if (!registros) {
                    console.warn('No se pudieron cargar las estad√≠sticas');
                    return;
                }
        
                // Calcular presentes (personas con entrada sin salida o con ambos registros)
                const personasConRegistro = {};
                registros.forEach(reg => {
                    const key = reg.person_id_document;
                    if (!personasConRegistro[key]) {
                        personasConRegistro[key] = [];
                    }
                    personasConRegistro[key].push(reg);
                });
        
                // Personas presentes = tienen n√∫mero impar de registros (√∫ltima fue entrada)
                let presentes = 0;
                Object.values(personasConRegistro).forEach(regs => {
                    if (regs.length % 2 === 1) {
                        presentes++;
                    }
                });
        
                // Obtener total de personas (estudiantes + trabajadores activos)
                // Para students: buscar el status_id que corresponde a "Activo"
                const activeStatus = await supabaseRequest('/student_status?select=status_id&status_description=eq.Activo&limit=1');
                const activeStatusId = activeStatus && activeStatus.length > 0 ? activeStatus[0].status_id : null;
                
                let totalStudents = { length: 0 };
                if (activeStatusId) {
                    totalStudents = await supabaseRequest(`/students?select=student_id_document&status_id=eq.${activeStatusId}`);
                }
                
                const totalWorkers = await supabaseRequest('/workers?select=worker_id_doc&worker_status=eq.active');
                const totalPersonas = (totalStudents?.length || 0) + (totalWorkers?.length || 0);
                
                // Calcular ausentes excluyendo trabajadores remotos
                const personasConRegistroORemoto = new Set([
                    ...Object.keys(personasConRegistro),
                    ...trabajadoresRemotos
                ]);
                const ausentes = totalPersonas - personasConRegistroORemoto.size;
                
                // Calcular alertas (solo registros irregulares: m√°s de 4 registros)
                let alertas = 0;
                Object.values(personasConRegistro).forEach(regs => {
                    if (regs.length > 4) {
                        alertas++;
                    }
                });
        
                // Actualizar UI
                document.getElementById('stat-present').textContent = presentes;
                document.getElementById('stat-absent').textContent = ausentes;
                document.getElementById('stat-alerts').textContent = alertas;
        
            } catch (error) {
                console.error('‚ùå Error cargando estad√≠sticas generales:', error);
            }
        }
        
        
        // ==========================================
        // CARGAR PRESENCIA ACTUAL
        // ==========================================
        async function cargarPresenciaActual() {
            try {
                mostrarLoading();
                const today = new Date().toISOString().split('T')[0];
                
                // Obtener todos los registros del d√≠a
                const registros = await supabaseRequest(`/attendance?select=*&attendance_date=eq.${today}&order=attendance_timestamp.desc`);
                
                if (!registros) {
                    ocultarLoading();
                    return;
                }

                // Agrupar por persona
                const personasConRegistro = {};
                registros.forEach(reg => {
                    const key = reg.person_id_document;
                    if (!personasConRegistro[key]) {
                        personasConRegistro[key] = {
                            documento: reg.person_id_document,
                            tipo: reg.person_type,
                            registros: []
                        };
                    }
                    personasConRegistro[key].registros.push(reg);
                });

                // ‚úÖ NUEVO: Obtener filtro de curso
                const cursoFiltro = document.getElementById('filter-course-present')?.value || '';
                
                // ‚úÖ NUEVO: Si hay filtro, obtener estudiantes de ese curso para filtrar
                let estudiantesDelCurso = null;
                if (cursoFiltro) {
                    estudiantesDelCurso = await supabaseRequest(`/students?select=student_id_document&course_id=eq.${cursoFiltro}`);
                    estudiantesDelCurso = new Set(estudiantesDelCurso?.map(e => e.student_id_document) || []);
                }
                
                // Filtrar solo presentes (n√∫mero impar de registros = √∫ltima fue entrada)
                const estudiantesPresentes = [];
                const trabajadoresPresentes = [];
                
                for (const [doc, data] of Object.entries(personasConRegistro)) {
                    if (data.registros.length % 2 === 1) {
                        // Est√° presente (√∫ltima fue entrada)
                        const primerRegistro = data.registros[data.registros.length - 1]; // El m√°s antiguo (entrada)
                        
                        if (data.tipo === 'student') {
                            // ‚úÖ NUEVO: Aplicar filtro de curso si existe
                            if (cursoFiltro && estudiantesDelCurso && !estudiantesDelCurso.has(doc)) {
                                continue; // Saltar si no est√° en el curso filtrado
                            }
                            
                            estudiantesPresentes.push({
                                documento: doc,
                                entrada: primerRegistro.attendance_time,
                                timestamp: primerRegistro.attendance_timestamp
                            });
                        } else {
                            trabajadoresPresentes.push({
                                documento: doc,
                                entrada: primerRegistro.attendance_time,
                                timestamp: primerRegistro.attendance_timestamp
                            });
                        }
                    }
                }
                // Obtener nombres y mostrar
                await mostrarListaPresentes(estudiantesPresentes, 'student');
                await mostrarListaPresentes(trabajadoresPresentes, 'worker');

                ocultarLoading();

            } catch (error) {
                console.error('‚ùå Error cargando presencia actual:', error);
                ocultarLoading();
            }
        }

        // ==========================================
        // MOSTRAR LISTA DE PRESENTES
        // ==========================================
        async function mostrarListaPresentes(personas, tipo) {
            const containerId = tipo === 'student' ? 'students-present-list' : 'workers-present-list';
            const countId = tipo === 'student' ? 'count-students-present' : 'count-workers-present';
            const container = document.getElementById(containerId);

            if (personas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <p>No hay ${tipo === 'student' ? 'estudiantes' : 'trabajadores'} presentes</p>
                    </div>
                `;
                document.getElementById(countId).textContent = '0';
                return;
            }

            // Obtener nombres
            let html = '';
            for (const persona of personas) {
                const nombre = await obtenerNombrePersona(persona.documento, tipo);
                const horaEntrada = persona.entrada ? persona.entrada.substring(0, 5) : '';
                
                html += `
                    <div class="person-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="person-name">${nombre}</div>
                                <div class="person-time">
                                    <i class="bi bi-clock me-1"></i>Entrada: ${horaEntrada}
                                </div>
                            </div>
                            <span class="person-badge ${tipo}">${tipo === 'student' ? 'üìö' : 'üëî'}</span>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
            document.getElementById(countId).textContent = personas.length;
        }

        // ==========================================
        // CARGAR AUSENTES
        // ==========================================
        async function cargarAusentes() {
            try {
                mostrarLoading();
                const today = new Date().toISOString().split('T')[0];
                
                // Filtros
                const cursoFiltro = document.getElementById('filter-course-absent').value;
                const areaFiltro = document.getElementById('filter-area-absent').value;

                // Obtener status "Activo" para estudiantes
                const activeStatus = await supabaseRequest('/student_status?select=status_id&status_description=eq.Activo&limit=1');
                const activeStatusId = activeStatus && activeStatus.length > 0 ? activeStatus[0].status_id : null;

                // Obtener todos los estudiantes activos con JOIN a courses
                let queryStudents = '/students?select=student_id_document,student_first_name,student_last_name_1,student_last_name_2,course_id,courses(course_name)';
                if (activeStatusId) {
                    queryStudents += `&status_id=eq.${activeStatusId}`;
                }
                if (cursoFiltro) {
                    queryStudents += `&course_id=eq.${cursoFiltro}`;
                }
                const todosEstudiantes = await supabaseRequest(queryStudents);

                // Obtener todos los trabajadores activos con JOIN a organizational_divisions
                let queryWorkers = '/workers?select=worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2,organizational_division_id,organizational_divisions(division_name)&worker_status=eq.active';
                if (areaFiltro) {
                    queryWorkers += `&organizational_division_id=eq.${areaFiltro}`;
                }
                const todosTrabajadores = await supabaseRequest(queryWorkers);

                // Obtener quienes tienen registro hoy
                const registrosHoy = await supabaseRequest(`/attendance?select=person_id_document,person_type&attendance_date=eq.${today}`);
                const documentosConRegistro = new Set(registrosHoy?.map(r => r.person_id_document) || []);

                // Filtrar ausentes (estudiantes no tienen trabajo remoto)
                const estudiantesAusentes = todosEstudiantes?.filter(e => !documentosConRegistro.has(e.student_id_document)) || [];
                
                // Filtrar trabajadores ausentes EXCLUYENDO los que tienen trabajo remoto aprobado
                const trabajadoresAusentes = todosTrabajadores?.filter(t => 
                    !documentosConRegistro.has(t.worker_id_doc) && 
                    !trabajadoresRemotos.has(t.worker_id_doc)
                ) || [];
                
                // Mostrar listas
                mostrarListaAusentes(estudiantesAusentes, 'student');
                mostrarListaAusentes(trabajadoresAusentes, 'worker');
                
                // Mostrar trabajadores remotos si hay
                if (trabajadoresRemotos.size > 0) {
                    mostrarTrabajadoresRemotos(todosTrabajadores);
                }

                ocultarLoading();

            } catch (error) {
                console.error('‚ùå Error cargando ausentes:', error);
                ocultarLoading();
            }
        }

        // ==========================================
        // MOSTRAR LISTA DE AUSENTES
        // ==========================================
        function mostrarListaAusentes(personas, tipo) {
            const containerId = tipo === 'student' ? 'students-absent-list' : 'workers-absent-list';
            const countId = tipo === 'student' ? 'count-students-absent' : 'count-workers-absent';
            const container = document.getElementById(containerId);

            if (personas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <p>No hay ${tipo === 'student' ? 'estudiantes' : 'trabajadores'} ausentes</p>
                    </div>
                `;
                document.getElementById(countId).textContent = '0';
                return;
            }

            let html = '';
            personas.forEach(persona => {
                let nombre = '';
                let info = '';
                
                if (tipo === 'student') {
                    nombre = `${persona.student_last_name_1} ${persona.student_last_name_2 || ''} ${persona.student_first_name}`.trim();
                    info = persona.courses?.course_name || '';
                } else {
                    nombre = `${persona.worker_last_name_1} ${persona.worker_last_name_2 || ''} ${persona.worker_first_name}`.trim();
                    info = persona.organizational_divisions?.division_name || '';
                }
                
                html += `
                    <div class="person-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="person-name">${nombre}</div>
                                ${info ? `<small class="text-muted">${info}</small>` : ''}
                            </div>
                            <span class="person-badge ${tipo}">${tipo === 'student' ? 'üìö' : 'üëî'}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById(countId).textContent = personas.length;
        }

        // ==========================================
        // MOSTRAR TRABAJADORES EN TRABAJO REMOTO
        // ==========================================
        function mostrarTrabajadoresRemotos(todosTrabajadores) {
            // Filtrar solo los que est√°n en trabajo remoto
            const remotos = todosTrabajadores?.filter(t => trabajadoresRemotos.has(t.worker_id_doc)) || [];
            
            if (remotos.length === 0) return;
            
            // Verificar si ya existe el contenedor de remotos
            let containerCard = document.getElementById('workers-remote-card');
            
            if (!containerCard) {
                // Crear la tarjeta si no existe
                const ausentesTab = document.getElementById('ausentes');
                const rowDiv = ausentesTab.querySelector('.row');
                
                const newCol = document.createElement('div');
                newCol.className = 'col-lg-12 mb-4';
                newCol.innerHTML = `
                    <div class="card" id="workers-remote-card">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-house-door me-2"></i>Trabajadores en Modalidad Remota
                            </h5>
                            <span class="badge bg-light text-info" id="count-workers-remote">0</span>
                        </div>
                        <div class="card-body p-0">
                            <div id="workers-remote-list" style="max-height: 300px; overflow-y: auto;">
                            </div>
                        </div>
                    </div>
                `;
                rowDiv.appendChild(newCol);
            }
            
            const container = document.getElementById('workers-remote-list');
            const countBadge = document.getElementById('count-workers-remote');
            
            let html = '';
            remotos.forEach(t => {
                const nombre = `${t.worker_last_name_1} ${t.worker_last_name_2 || ''} ${t.worker_first_name}`.trim();
                const division = t.organizational_divisions?.division_name || '';
                
                html += `
                    <div class="person-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="person-name">${nombre}</div>
                                ${division ? `<small class="text-muted">${division}</small>` : ''}
                            </div>
                            <span class="badge bg-info">üè† Remoto</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            countBadge.textContent = remotos.length;
        }

        // ==========================================
        // CARGAR ALERTAS
        // ==========================================
        async function cargarAlertas() {
            try {
                mostrarLoading();
                const today = new Date().toISOString().split('T')[0];
                
                // Obtener todos los registros del d√≠a
                const registros = await supabaseRequest(`/attendance?select=*&attendance_date=eq.${today}&order=attendance_timestamp.asc`);
                
                if (!registros) {
                    ocultarLoading();
                    return;
                }
        
                // Agrupar por persona
                const personasConRegistro = {};
                registros.forEach(reg => {
                    const key = reg.person_id_document;
                    if (!personasConRegistro[key]) {
                        personasConRegistro[key] = {
                            documento: reg.person_id_document,
                            tipo: reg.person_type,
                            registros: []
                        };
                    }
                    personasConRegistro[key].registros.push(reg);
                });
        
                // Alertas: Solo registros irregulares (m√°s de 2 entradas/salidas = m√°s de 4 registros)
                const irregulares = [];
        
                for (const [doc, data] of Object.entries(personasConRegistro)) {
                    const numRegistros = data.registros.length;
                    
                    if (numRegistros > 4) {
                        // Irregular (m√°s de 2 entradas/salidas)
                        irregulares.push({
                            documento: doc,
                            tipo: data.tipo,
                            numRegistros: numRegistros
                        });
                    }
                }
        
                // Mostrar alertas
                await mostrarAlertaIrregular(irregulares);
        
                ocultarLoading();
        
            } catch (error) {
                console.error('‚ùå Error cargando alertas:', error);
                ocultarLoading();
            }
        }
        
        // ==========================================
        // MOSTRAR ALERTA IRREGULAR
        // ==========================================
        async function mostrarAlertaIrregular(personas) {
            const container = document.getElementById('alert-irregular-list');

            if (personas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-check-circle"></i>
                        <p>No hay registros irregulares</p>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const persona of personas) {
                const nombre = await obtenerNombrePersona(persona.documento, persona.tipo);
                
                html += `
                    <div class="person-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="person-name">${nombre}</div>
                                <div class="person-time">
                                    <i class="bi bi-exclamation-triangle me-1"></i>${persona.numRegistros} registros en el d√≠a
                                </div>
                            </div>
                            <span class="person-badge ${persona.tipo}">${persona.tipo === 'student' ? 'üìö' : 'üëî'}</span>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // ==========================================
        // OBTENER NOMBRE DE PERSONA
        // ==========================================
        // ‚úÖ OPTIMIZADO: Usa cache en lugar de consultar BD cada vez
        function obtenerNombrePersona(documento, tipo) {
            if (tipo === 'student') {
                return nombresCache.students[documento] || 'Desconocido';
            } else if (tipo === 'worker') {
                return nombresCache.workers[documento] || 'Desconocido';
            }
            return 'Desconocido';
        }
        
        // ==========================================
        // BUSCAR PERSONA PARA HISTORIAL
        // ==========================================
        async function buscarPersonaHistorial() {
            try {
                mostrarLoading();
                const searchTerm = document.getElementById('search-person-history').value.trim().toLowerCase();
                
                if (!searchTerm || searchTerm.length < 3) {
                    showMessage('Por favor ingrese al menos 3 caracteres', 'warning');
                    ocultarLoading();
                    return;
                }

                let resultados = [];

                // Buscar en estudiantes con JOIN a courses
                const estudiantes = await supabaseRequest(`/students?select=student_id_document,student_code,student_first_name,student_last_name_1,student_last_name_2,course_id,courses(course_name)`);
                if (estudiantes) {
                    estudiantes.forEach(e => {
                        // Validar que los campos necesarios no sean null
                        if (!e.student_id_document || !e.student_first_name || !e.student_last_name_1) {
                            return; // Saltar este registro
                        }
                        
                        const nombreCompleto = `${e.student_last_name_1} ${e.student_last_name_2 || ''} ${e.student_first_name}`.toLowerCase();
                        const documento = e.student_id_document.toLowerCase();
                        
                        if (nombreCompleto.includes(searchTerm) || documento.includes(searchTerm)) {
                            resultados.push({
                                tipo: 'student',
                                documento: e.student_id_document,
                                codigo: e.student_code,
                                curso: e.courses?.course_name || '',
                                nombre: `${e.student_last_name_1} ${e.student_last_name_2 || ''} ${e.student_first_name}`.trim()
                            });
                        }
                    });
                }

                // Buscar en trabajadores con JOIN a organizational_divisions
                const trabajadores = await supabaseRequest(`/workers?select=worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2,organizational_division_id,organizational_divisions(division_name)`);
                if (trabajadores) {
                    trabajadores.forEach(t => {
                        // CORRECCI√ìN CR√çTICA: Validar que los campos necesarios no sean null
                        if (!t.worker_id_doc || !t.worker_first_name || !t.worker_last_name_1) {
                            return; // Saltar este registro si faltan datos cr√≠ticos
                        }
                        
                        const nombreCompleto = `${t.worker_last_name_1} ${t.worker_last_name_2 || ''} ${t.worker_first_name}`.toLowerCase();
                        const documento = t.worker_id_doc.toLowerCase();
                        
                        if (nombreCompleto.includes(searchTerm) || documento.includes(searchTerm)) {
                            resultados.push({
                                tipo: 'worker',
                                documento: t.worker_id_doc,
                                division: t.organizational_divisions?.division_name || '',
                                nombre: `${t.worker_last_name_1} ${t.worker_last_name_2 || ''} ${t.worker_first_name}`.trim()
                            });
                        }
                    });
                }

                ocultarLoading();
                mostrarResultadosBusquedaHistorial(resultados);

            } catch (error) {
                console.error('‚ùå Error buscando persona:', error);
                ocultarLoading();
                showMessage('Error en la b√∫squeda', 'danger');
            }
        }
        
        // ==========================================
        // MOSTRAR RESULTADOS B√öSQUEDA HISTORIAL
        // ==========================================
        function mostrarResultadosBusquedaHistorial(resultados) {
            const container = document.getElementById('person-search-list');
            
            if (resultados.length === 0) {
                document.getElementById('person-search-results').style.display = 'block';
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-search"></i>
                        <p class="mb-0">No se encontraron resultados</p>
                    </div>
                `;
                return;
            }

            let html = '';
            resultados.forEach(persona => {
                const badgeClass = persona.tipo === 'student' ? 'student' : 'worker';
                const badgeText = persona.tipo === 'student' ? 'üìö Estudiante' : 'üëî Trabajador';
                const infoExtra = persona.tipo === 'student' ? 
                    (persona.curso ? ` - ${persona.curso}` : '') : 
                    (persona.division ? ` - ${persona.division}` : '');
                
                html += `
                    <div class="person-item" onclick='seleccionarPersonaHistorial(${JSON.stringify(persona)})' style="cursor: pointer;">
                        <span class="person-badge ${badgeClass}">${badgeText}</span>
                        <div class="fw-bold">${persona.nombre}</div>
                        <small class="text-muted">Doc: ${persona.documento}${infoExtra}</small>
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('person-search-results').style.display = 'block';
        }

        // ==========================================
        // SELECCIONAR PERSONA PARA HISTORIAL
        // ==========================================
        async function seleccionarPersonaHistorial(persona) {
            selectedPersonHistory = persona;

            // Ocultar resultados de b√∫squeda
            document.getElementById('person-search-results').style.display = 'none';

            // Mostrar informaci√≥n de persona seleccionada
            const tipoTexto = persona.tipo === 'student' ? 'Estudiante' : 'Trabajador';
            const infoExtra = persona.tipo === 'student' ? 
                (persona.curso ? ` - ${persona.curso}` : '') : 
                (persona.division ? ` - ${persona.division}` : '');
            
            document.getElementById('selected-person-name').textContent = persona.nombre;
            document.getElementById('selected-person-details').textContent = `${tipoTexto} - Doc: ${persona.documento}${infoExtra}`;
            document.getElementById('person-history-container').style.display = 'block';

            // Cargar historial
            await cargarHistorialPersona();
        }

        // ==========================================
        // CARGAR HISTORIAL DE PERSONA
        // ==========================================
        async function cargarHistorialPersona() {
            if (!selectedPersonHistory) return;

            try {
                mostrarLoading();

                const fechaInicio = document.getElementById('history-date-start').value;
                const fechaFin = document.getElementById('history-date-end').value;

                // Obtener registros en el rango de fechas
                let query = `/attendance?select=*&person_id_document=eq.${selectedPersonHistory.documento}&attendance_date=gte.${fechaInicio}&attendance_date=lte.${fechaFin}&order=attendance_date.desc,attendance_timestamp.asc`;
                
                const registros = await supabaseRequest(query);

                if (!registros || registros.length === 0) {
                    document.getElementById('history-table-body').innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted">No hay registros en el per√≠odo seleccionado</td>
                        </tr>
                    `;
                    ocultarLoading();
                    return;
                }

                // Agrupar por fecha
                const registrosPorFecha = {};
                registros.forEach(reg => {
                    if (!registrosPorFecha[reg.attendance_date]) {
                        registrosPorFecha[reg.attendance_date] = [];
                    }
                    registrosPorFecha[reg.attendance_date].push(reg);
                });

                // Generar tabla
                let html = '';
                Object.keys(registrosPorFecha).sort().reverse().forEach(fecha => {
                    const regs = registrosPorFecha[fecha];
                    
                    // Primer registro = entrada, √∫ltimo = salida
                    const entrada = regs[0].attendance_time.substring(0, 5);
                    const salida = regs.length > 1 ? regs[regs.length - 1].attendance_time.substring(0, 5) : '-';
                    
                    // Calcular permanencia
                    let permanencia = '-';
                    if (regs.length > 1) {
                        const entradaTime = new Date(`2000-01-01 ${regs[0].attendance_time}`);
                        const salidaTime = new Date(`2000-01-01 ${regs[regs.length - 1].attendance_time}`);
                        const diff = Math.abs(salidaTime - entradaTime);
                        const hours = Math.floor(diff / 3600000);
                        const minutes = Math.floor((diff % 3600000) / 60000);
                        permanencia = `${hours}h ${minutes}m`;
                    }

                    // M√©todo de registro
                    const metodos = [...new Set(regs.map(r => r.registration_method))];
                    const metodoTexto = metodos.includes('manual') ? 
                        '<span class="badge bg-warning">Manual</span>' : 
                        '<span class="badge bg-success">Carnet</span>';

                    html += `
                        <tr>
                            <td>${fecha}</td>
                            <td><span class="badge badge-entrada">${entrada}</span></td>
                            <td>${salida !== '-' ? `<span class="badge badge-salida">${salida}</span>` : salida}</td>
                            <td>${permanencia}</td>
                            <td>${metodoTexto}</td>
                        </tr>
                    `;
                });

                document.getElementById('history-table-body').innerHTML = html;
                ocultarLoading();

            } catch (error) {
                console.error('‚ùå Error cargando historial:', error);
                ocultarLoading();
                showMessage('Error al cargar el historial', 'danger');
            }
        }

        // ==========================================
        // CARGAR REPORTE POR CURSOS
        // ==========================================
        async function cargarReporteCursos() {
            try {
                mostrarLoading();
                
                const fecha = document.getElementById('course-report-date').value;
                const gradoFiltro = document.getElementById('filter-grade-course').value;

                if (!fecha) {
                    document.getElementById('courses-table-body').innerHTML = `
                        <tr><td colspan="5" class="text-center text-muted">Seleccione una fecha</td></tr>
                    `;
                    ocultarLoading();
                    return;
                }

                // Obtener status "Activo" para estudiantes
                const activeStatus = await supabaseRequest('/student_status?select=status_id&status_description=eq.Activo&limit=1');
                const activeStatusId = activeStatus && activeStatus.length > 0 ? activeStatus[0].status_id : null;

                // Obtener todos los estudiantes activos con JOIN a courses
                let queryStudents = '/students?select=student_id_document,course_id,courses(course_name)';
                if (activeStatusId) {
                    queryStudents += `&status_id=eq.${activeStatusId}`;
                }
                if (gradoFiltro) {
                    queryStudents += `&course_id=eq.${gradoFiltro}`;
                }
                const estudiantes = await supabaseRequest(queryStudents);

                // Obtener registros de la fecha
                const registros = await supabaseRequest(`/attendance?select=person_id_document&person_type=eq.student&attendance_date=eq.${fecha}`);
                const documentosConRegistro = new Set(registros?.map(r => r.person_id_document) || []);

                // Agrupar por curso
                const cursos = {};
                estudiantes?.forEach(e => {
                    const cursoNombre = e.courses?.course_name || 'Sin curso';
                    if (!cursos[cursoNombre]) {
                        cursos[cursoNombre] = { total: 0, presentes: 0 };
                    }
                    cursos[cursoNombre].total++;
                    if (documentosConRegistro.has(e.student_id_document)) {
                        cursos[cursoNombre].presentes++;
                    }
                });

                // Generar tabla
                let html = '';
                Object.keys(cursos).sort().forEach(curso => {
                    const data = cursos[curso];
                    const ausentes = data.total - data.presentes;
                    const porcentaje = data.total > 0 ? ((data.presentes / data.total) * 100).toFixed(1) : 0;
                    
                    html += `
                        <tr>
                            <td>${curso}</td>
                            <td>${data.total}</td>
                            <td><span class="badge bg-success">${data.presentes}</span></td>
                            <td><span class="badge bg-danger">${ausentes}</span></td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar ${porcentaje >= 80 ? 'bg-success' : porcentaje >= 60 ? 'bg-warning' : 'bg-danger'}" 
                                         style="width: ${porcentaje}%">${porcentaje}%</div>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('courses-table-body').innerHTML = html || `
                    <tr><td colspan="5" class="text-center text-muted">No hay datos disponibles</td></tr>
                `;

                ocultarLoading();

            } catch (error) {
                console.error('‚ùå Error cargando reporte por cursos:', error);
                ocultarLoading();
                showMessage('Error al cargar el reporte', 'danger');
            }
        }

        // ==========================================
        // CARGAR REPORTE POR √ÅREAS
        // ==========================================
        async function cargarReporteAreas() {
            try {
                mostrarLoading();
                
                const fecha = document.getElementById('area-report-date').value;
                const divisionFiltro = document.getElementById('filter-division').value;

                if (!fecha) {
                    document.getElementById('areas-table-body').innerHTML = `
                        <tr><td colspan="6" class="text-center text-muted">Seleccione una fecha</td></tr>
                    `;
                    ocultarLoading();
                    return;
                }

                // Obtener todos los trabajadores activos con JOINs
                let queryWorkers = '/workers?select=worker_id_doc,organizational_area_id,organizational_division_id,organizational_areas(area_name),organizational_divisions(division_name)&worker_status=eq.active';
                if (divisionFiltro) {
                    queryWorkers += `&organizational_division_id=eq.${divisionFiltro}`;
                }
                const trabajadores = await supabaseRequest(queryWorkers);

                // Obtener registros de la fecha
                const registros = await supabaseRequest(`/attendance?select=person_id_document&person_type=eq.worker&attendance_date=eq.${fecha}`);
                const documentosConRegistro = new Set(registros?.map(r => r.person_id_document) || []);

                // Agrupar por √°rea y divisi√≥n
                const areas = {};
                trabajadores?.forEach(t => {
                    const area = t.organizational_areas?.area_name || 'Sin √°rea';
                    const division = t.organizational_divisions?.division_name || 'Sin divisi√≥n';
                    const key = `${area}|${division}`;
                    
                    if (!areas[key]) {
                        areas[key] = { area, division, total: 0, presentes: 0 };
                    }
                    areas[key].total++;
                    if (documentosConRegistro.has(t.worker_id_doc)) {
                        areas[key].presentes++;
                    }
                });

                // Generar tabla
                let html = '';
                Object.values(areas).sort((a, b) => a.division.localeCompare(b.division)).forEach(data => {
                    const ausentes = data.total - data.presentes;
                    const porcentaje = data.total > 0 ? ((data.presentes / data.total) * 100).toFixed(1) : 0;
                    
                    html += `
                        <tr>
                            <td>${data.area}</td>
                            <td>${data.division}</td>
                            <td>${data.total}</td>
                            <td><span class="badge bg-success">${data.presentes}</span></td>
                            <td><span class="badge bg-danger">${ausentes}</span></td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar ${porcentaje >= 80 ? 'bg-success' : porcentaje >= 60 ? 'bg-warning' : 'bg-danger'}" 
                                         style="width: ${porcentaje}%">${porcentaje}%</div>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('areas-table-body').innerHTML = html || `
                    <tr><td colspan="6" class="text-center text-muted">No hay datos disponibles</td></tr>
                `;

                ocultarLoading();

            } catch (error) {
                console.error('‚ùå Error cargando reporte por √°reas:', error);
                ocultarLoading();
                showMessage('Error al cargar el reporte', 'danger');
            }
        }

        // ==========================================
        // CARGAR REPORTE DE PUNTUALIDAD
        // ==========================================
        async function cargarReportePuntualidad() {
            try {
                mostrarLoading();
                
                const fecha = document.getElementById('punctuality-date').value;
                const tipoFiltro = document.getElementById('punctuality-type').value;
                const statusFiltro = document.getElementById('punctuality-status').value;

                if (!fecha) {
                    document.getElementById('punctuality-table-body').innerHTML = `
                        <tr><td colspan="5" class="text-center text-muted">Seleccione una fecha</td></tr>
                    `;
                    ocultarLoading();
                    return;
                }

                // Obtener registros de la fecha (solo primeros registros = entradas)
                let query = `/attendance?select=*&attendance_date=eq.${fecha}&order=person_id_document,attendance_timestamp.asc`;
                const registros = await supabaseRequest(query);

                if (!registros || registros.length === 0) {
                    document.getElementById('punctuality-table-body').innerHTML = `
                        <tr><td colspan="5" class="text-center text-muted">No hay registros en esta fecha</td></tr>
                    `;
                    ocultarLoading();
                    return;
                }

                // Obtener solo el primer registro de cada persona (entrada)
                const entradas = {};
                registros.forEach(reg => {
                    if (!entradas[reg.person_id_document]) {
                        entradas[reg.person_id_document] = reg;
                    }
                });

                // Procesar puntualidad
                const resultados = [];
                for (const [doc, reg] of Object.entries(entradas)) {
                    // Filtrar por tipo si es necesario
                    if (tipoFiltro && reg.person_type !== tipoFiltro) continue;

                    const horaEntrada = reg.attendance_time;
                    // Usar hora de referencia seg√∫n el tipo de persona
                    const horaReferencia = reg.person_type === 'student' ? punctualityReferenceTimeStudents : punctualityReferenceTimeWorkers;
                    const esTarde = horaEntrada > horaReferencia;
                    // Filtrar por estado si es necesario
                    if (statusFiltro === 'ontime' && esTarde) continue;
                    if (statusFiltro === 'late' && !esTarde) continue;

                    // Calcular diferencia
                    // Calcular diferencia
                    const refTime = new Date(`2000-01-01 ${horaReferencia}`);
                    const entradaTime = new Date(`2000-01-01 ${horaEntrada}`);
                    const diff = Math.abs(entradaTime - refTime);
                    const minutes = Math.floor(diff / 60000);
                    const diferencia = esTarde ? `+${minutes} min` : `-${minutes} min`;

                    resultados.push({
                        documento: doc,
                        tipo: reg.person_type,
                        hora: horaEntrada.substring(0, 5),
                        esTarde,
                        diferencia
                    });
                }

                // Obtener nombres y generar tabla
                let html = '';
                for (const item of resultados) {
                    const nombre = await obtenerNombrePersona(item.documento, item.tipo);
                    const tipoTexto = item.tipo === 'student' ? 'Estudiante' : 'Trabajador';
                    const estadoBadge = item.esTarde ? 
                        '<span class="badge badge-tardanza">Tardanza</span>' : 
                        '<span class="badge badge-entrada">A tiempo</span>';

                    html += `
                        <tr>
                            <td>${nombre}</td>
                            <td><span class="person-badge ${item.tipo}">${tipoTexto}</span></td>
                            <td>${item.hora}</td>
                            <td>${estadoBadge}</td>
                            <td>${item.diferencia}</td>
                        </tr>
                    `;
                }

                document.getElementById('punctuality-table-body').innerHTML = html || `
                    <tr><td colspan="5" class="text-center text-muted">No hay resultados con los filtros seleccionados</td></tr>
                `;

                ocultarLoading();

            } catch (error) {
                console.error('‚ùå Error cargando reporte de puntualidad:', error);
                ocultarLoading();
                showMessage('Error al cargar el reporte', 'danger');
            }
        }

        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        console.log('‚úÖ Sistema de reportes de asistencia cargado correctamente');
    </script>
</body>
</html>
