<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="2025.11.21.08.10">
    <title>Listas - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- jsPDF para generar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- docx para generar archivos Word -->
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <style>
        /* Estilos generales */
        :root {
            --primary-color: #6c757d;
            --secondary-color: #5a6268;
            --light-color: #e9ecef;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .nav-tabs .nav-link {
            color: var(--primary-color);
            font-weight: 500;
        }

        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-generate {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 10px 30px;
            border: none;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .btn-generate:hover {
            background-color: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .form-check-label {
            font-weight: 500;
        }

        .filter-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .column-input-group {
            margin-bottom: 15px;
            padding: 15px;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .badge-custom {
            background-color: var(--light-color);
            color: var(--primary-color);
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }

        .spinner-border-custom {
            width: 3rem;
            height: 3rem;
            border-width: 0.3rem;
            color: var(--primary-color);
        }

        select[multiple] {
            min-height: 150px;
        }

        .help-text {
            font-size: 0.875rem;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner-border spinner-border-custom mb-3" role="status"></div>
            <h5 id="loadingMessage">Generando PDF...</h5>
            <p class="text-muted mb-0">Por favor espere</p>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Listas</li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3 mb-2">
                    <i class="bi bi-list-ul me-2" style="color: var(--primary-color);"></i>
                    Generador de Listas
                </h1>
                <p class="text-muted">Genera listas personalizadas de estudiantes, familias y trabajadores en formato PDF</p>
            </div>
        </div>

        <!-- Contenedor de Alertas -->
        <div id="alertContainer"></div>

        <!-- Tarjeta Principal con Pesta√±as -->
        <div class="card shadow-sm">
            <div class="card-header">
                <i class="bi bi-gear-fill me-2"></i>Configuraci√≥n de Listas
            </div>
            <div class="card-body">
                
                <!-- Pesta√±as -->
                <ul class="nav nav-tabs mb-4" id="listTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="estudiantes-tab" data-bs-toggle="tab" 
                                data-bs-target="#estudiantes" type="button" role="tab">
                            <i class="bi bi-mortarboard-fill me-2"></i>Estudiantes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="familias-tab" data-bs-toggle="tab" 
                                data-bs-target="#familias" type="button" role="tab">
                            <i class="bi bi-people-fill me-2"></i>Familias
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="trabajadores-tab" data-bs-toggle="tab" 
                                data-bs-target="#trabajadores" type="button" role="tab">
                            <i class="bi bi-person-badge-fill me-2"></i>Trabajadores
                        </button>
                    </li>
                </ul>

                <!-- Contenido de Pesta√±as -->
                <div class="tab-content" id="listTabsContent">
                    
                    <!-- PESTA√ëA 1: ESTUDIANTES -->
                    <div class="tab-pane fade show active" id="estudiantes" role="tabpanel">
                        <h5 class="mb-3"><i class="bi bi-mortarboard me-2"></i>Lista de Estudiantes por Curso</h5>
                        <p class="text-muted">Genera listas de estudiantes activos ordenados alfab√©ticamente</p>
                        <!-- Campo de T√≠tulo Personalizado -->
                        <div class="mb-4">
                            <label for="tituloListaEst" class="form-label fw-bold">
                                <i class="bi bi-pencil me-1"></i>T√≠tulo del documento (opcional)
                            </label>
                            <input type="text" class="form-control" id="tituloListaEst" 
                                   placeholder='Ejemplo: "Lista para excursi√≥n 2025" o "Control de asistencia"'>
                            <div class="help-text mt-1">
                                <i class="bi bi-info-circle me-1"></i>Si se deja vac√≠o, se usar√° el t√≠tulo predeterminado
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <!-- Selecci√≥n de Cursos -->
                                <div class="mb-3">
                                    <label for="selectCursosEstudiantes" class="form-label">
                                        <i class="bi bi-book me-1"></i>Seleccionar Cursos <span class="text-danger">*</span>
                                    </label>
                                    <select id="selectCursosEstudiantes" class="form-select" multiple size="8">
                                        <option value="" disabled>Cargando cursos...</option>
                                    </select>
                                    <div class="help-text mt-1">
                                        <i class="bi bi-info-circle me-1"></i>Mant√©n presionado Ctrl (Cmd en Mac) para seleccionar m√∫ltiples cursos
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <!-- Opciones de Columnas -->
                                <div class="filter-section">
                                    <div class="filter-title">
                                        <i class="bi bi-sliders me-2"></i>Opciones de Columnas
                                    </div>

                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkNumeracionEst">
                                        <label class="form-check-label" for="checkNumeracionEst">
                                            Con numeraci√≥n (1, 2, 3...)
                                        </label>
                                    </div>

                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkCodigoEst">
                                        <label class="form-check-label" for="checkCodigoEst">
                                            Con c√≥digo de estudiante
                                        </label>
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="checkFirmasEst">
                                        <label class="form-check-label" for="checkFirmasEst">
                                            Con firmas de familias
                                        </label>
                                    </div>

                                    <!-- Contenedor de columnas personalizadas -->
                                    <div id="columnasPersonalizadasEst" style="display: none;">
                                        <hr>
                                        <label class="form-label fw-bold">Columnas Personalizadas</label>
                                        
                                        <div class="mb-3">
                                            <label for="numColumnasEst" class="form-label">
                                                N√∫mero de columnas (m√°ximo 6)
                                            </label>
                                            <input type="number" class="form-control" id="numColumnasEst" 
                                                   min="1" max="6" value="1">
                                        </div>

                                        <div id="encabezadosColumnasEst">
                                            <!-- Se generar√°n din√°micamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-generate me-2" onclick="generarListaEstudiantes('pdf')">
                                <i class="bi bi-file-pdf me-2"></i>Generar PDF
                            </button>
                            <button type="button" class="btn btn-generate" onclick="generarListaEstudiantes('docx')" 
                                    style="background-color: #2b579a;">
                                <i class="bi bi-file-word me-2"></i>Generar Word
                            </button>
                        </div>
                    </div>

                    <!-- PESTA√ëA 2: FAMILIAS -->
                    <div class="tab-pane fade" id="familias" role="tabpanel">
                        <h5 class="mb-3"><i class="bi bi-people me-2"></i>Listas de Familias</h5>
                        <p class="text-muted">Genera listas de familias activas con sus hijos</p>
                        <!-- Campo de T√≠tulo Personalizado -->
                        <div class="mb-4">
                            <label for="tituloListaFam" class="form-label fw-bold">
                                <i class="bi bi-pencil me-1"></i>T√≠tulo del documento (opcional)
                            </label>
                            <input type="text" class="form-control" id="tituloListaFam" 
                                   placeholder='Ejemplo: "Familias para reuni√≥n" o "Directorio de contactos"'>
                            <div class="help-text mt-1">
                                <i class="bi bi-info-circle me-1"></i>Si se deja vac√≠o, se usar√° el t√≠tulo predeterminado
                            </div>
                        </div>

                        <!-- Selector de tipo de lista -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Tipo de Lista</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoListaFam" 
                                       id="radioFamGeneral" value="general" checked>
                                <label class="form-check-label" for="radioFamGeneral">
                                    <strong>Listado General</strong> - Todas las familias en un solo PDF
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoListaFam" 
                                       id="radioFamCurso" value="curso">
                                <label class="form-check-label" for="radioFamCurso">
                                    <strong>Listado por Cursos</strong> - Un PDF por cada curso seleccionado
                                </label>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <!-- Selecci√≥n de Cursos (solo visible para listado por cursos) -->
                                <div id="selectorCursosFam" style="display: none;">
                                    <div class="mb-3">
                                        <label for="selectCursosFamilias" class="form-label">
                                            <i class="bi bi-book me-1"></i>Seleccionar Cursos <span class="text-danger">*</span>
                                        </label>
                                        <select id="selectCursosFamilias" class="form-select" multiple size="8">
                                            <option value="" disabled>Cargando cursos...</option>
                                        </select>
                                        <div class="help-text mt-1">
                                            <i class="bi bi-info-circle me-1"></i>Mant√©n presionado Ctrl (Cmd en Mac) para seleccionar m√∫ltiples
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <!-- Columnas Personalizadas -->
                                <div class="filter-section">
                                    <div class="filter-title">
                                        <i class="bi bi-sliders me-2"></i>Columnas Personalizadas
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="numColumnasFam" class="form-label">
                                            N√∫mero de columnas adicionales (m√°ximo 6)
                                        </label>
                                        <input type="number" class="form-control" id="numColumnasFam" 
                                               min="1" max="6" value="1">
                                    </div>

                                    <div id="encabezadosColumnasFam">
                                        <!-- Se generar√°n din√°micamente -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-generate me-2" onclick="generarListaFamilias('pdf')">
                                <i class="bi bi-file-pdf me-2"></i>Generar PDF
                            </button>
                            <button type="button" class="btn btn-generate" onclick="generarListaFamilias('docx')" 
                                    style="background-color: #2b579a;">
                                <i class="bi bi-file-word me-2"></i>Generar Word
                            </button>
                        </div>
                    </div>

                    <!-- PESTA√ëA 3: TRABAJADORES -->
                    <div class="tab-pane fade" id="trabajadores" role="tabpanel">
                        <h5 class="mb-3"><i class="bi bi-person-badge me-2"></i>Lista de Trabajadores</h5>
                        <p class="text-muted">Genera listas de trabajadores activos con filtros avanzados</p>
                        <!-- Campo de T√≠tulo Personalizado -->
                        <div class="mb-4">
                            <label for="tituloListaTrab" class="form-label fw-bold">
                                <i class="bi bi-pencil me-1"></i>T√≠tulo del documento (opcional)
                            </label>
                            <input type="text" class="form-control" id="tituloListaTrab" 
                                   placeholder='Ejemplo: "N√≥mina de personal" o "Lista de cumplea√±os"'>
                            <div class="help-text mt-1">
                                <i class="bi bi-info-circle me-1"></i>Si se deja vac√≠o, se usar√° el t√≠tulo predeterminado
                            </div>
                        </div>

                        <div class="row">
                            <!-- Columna Izquierda: Opciones y Filtros -->
                            <div class="col-md-6">
                                <!-- Opciones de Columnas -->
                                <div class="filter-section mb-3">
                                    <div class="filter-title">
                                        <i class="bi bi-sliders me-2"></i>Opciones de Columnas
                                    </div>

                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkNumeracionTrab">
                                        <label class="form-check-label" for="checkNumeracionTrab">
                                            Con numeraci√≥n (1, 2, 3...)
                                        </label>
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="checkDocumentoTrab">
                                        <label class="form-check-label" for="checkDocumentoTrab">
                                            Con documento de identidad
                                        </label>
                                    </div>
                                </div>

                                <!-- Filtros -->
                                <div class="filter-section">
                                    <div class="filter-title">
                                        <i class="bi bi-funnel me-2"></i>Filtros (Opcionales)
                                    </div>

                                    <div class="mb-3">
                                        <label for="selectGenero" class="form-label">G√©nero</label>
                                        <select id="selectGenero" class="form-select" multiple size="3">
                                            <option value="">Cargando...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="selectSeccion" class="form-label">Secci√≥n</label>
                                        <select id="selectSeccion" class="form-select" multiple size="4">
                                            <option value="">Cargando...</option>
                                        </select>
                                        <div class="help-text mt-1">
                                            <i class="bi bi-info-circle me-1"></i>Solo trabajadores asignados a secciones espec√≠ficas
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="selectDivision" class="form-label">
                                            <i class="bi bi-diagram-3 me-1"></i>Filtrar por Divisi√≥n <span class="text-danger">*</span>
                                        </label>
                                        <select id="selectDivision" class="form-select">
                                            <option value="">Seleccione una divisi√≥n</option>
                                        </select>
                                        <small class="text-muted">Seleccione una divisi√≥n para habilitar los dem√°s filtros</small>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="selectCentroCosto" class="form-label">
                                            <i class="bi bi-building me-1"></i>Filtrar por Centro de Costo
                                        </label>
                                        <select id="selectCentroCosto" class="form-select" multiple disabled>
                                            <option value="">Seleccione primero una divisi√≥n</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="selectArea" class="form-label">
                                            <i class="bi bi-diagram-2 me-1"></i>Filtrar por √Årea
                                        </label>
                                        <select id="selectArea" class="form-select" multiple disabled>
                                            <option value="">Seleccione primero un centro de costo</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="selectSubarea" class="form-label">
                                            <i class="bi bi-diagram-3-fill me-1"></i>Filtrar por Sub-√°rea
                                        </label>
                                        <select id="selectSubarea" class="form-select" multiple disabled>
                                            <option value="">Seleccione primero un √°rea</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="selectRoles" class="form-label">Roles</label>
                                        <select id="selectRoles" class="form-select" multiple size="4">
                                            <option value="">Cargando...</option>
                                        </select>
                                    </div>

                                    <div class="help-text">
                                        <i class="bi bi-info-circle me-1"></i>Los filtros se combinan con l√≥gica AND. 
                                        Deja vac√≠o para no filtrar.
                                    </div>
                                </div>
                            </div>

                            <!-- Columna Derecha: Columnas Personalizadas -->
                            <div class="col-md-6">
                                <div class="filter-section">
                                    <div class="filter-title">
                                        <i class="bi bi-sliders me-2"></i>Columnas Personalizadas
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="numColumnasTrab" class="form-label">
                                            N√∫mero de columnas adicionales (m√°ximo 6)
                                        </label>
                                        <input type="number" class="form-control" id="numColumnasTrab" 
                                               min="1" max="6" value="1">
                                    </div>

                                    <div id="encabezadosColumnasTrab">
                                        <!-- Se generar√°n din√°micamente -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-generate me-2" onclick="generarListaTrabajadores('pdf')">
                                <i class="bi bi-file-pdf me-2"></i>Generar PDF
                            </button>
                            <button type="button" class="btn btn-generate" onclick="generarListaTrabajadores('docx')" 
                                    style="background-color: #2b579a;">
                                <i class="bi bi-file-word me-2"></i>Generar Word
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <!-- AQU√ç VA EL JAVASCRIPT DE LA PARTE 2 -->
</body>
</html>
<script>
// ==========================================
// VARIABLES GLOBALES
// ==========================================
let cursosData = [];
let generosData = [];
let centrosCostosData = [];
let areasData = [];
let subareasData = [];
let rolesData = [];
let systemConfig = null;
let currentUser = null;
let divisionesData = [];

// ==========================================
// INICIALIZACI√ìN
// ==========================================
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üîê Iniciando validaci√≥n de acceso...');
    
    try {
        const hasAccess = await validatePageAccess('Listas');
        if (!hasAccess) {
            console.log('‚ùå Acceso denegado');
            return;
        }
        
        console.log('‚úÖ Acceso permitido - Inicializando p√°gina');
        await inicializarPagina();
        
    } catch (error) {
        console.error('‚ùå Error en validaci√≥n de acceso:', error);
        showMessage('Error de validaci√≥n de permisos', 'danger');
    }
});

async function inicializarPagina() {
    try {
        mostrarLoading('Cargando configuraci√≥n...');
        
        const session = getStoredSession();
        if (session && session.user) {
            currentUser = session.user;
        }
        
        await cargarConfiguracionSistema();
        configurarEventListeners();
        await cargarDatosIniciales();
        
        ocultarLoading();
        console.log('‚úÖ P√°gina inicializada correctamente');
        
    } catch (error) {
        console.error('‚ùå Error inicializando p√°gina:', error);
        showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
        ocultarLoading();
    }
}

async function cargarConfiguracionSistema() {
    try {
        const config = await supabaseRequest('/system_config?select=*&limit=1');
        if (config && config.length > 0) {
            systemConfig = config[0];
            console.log('‚úÖ Configuraci√≥n del sistema cargada');
        }
    } catch (error) {
        console.error('‚ùå Error cargando configuraci√≥n:', error);
    }
}

function configurarEventListeners() {
    // Estudiantes
    document.getElementById('checkFirmasEst').addEventListener('change', function() {
        const columnasDiv = document.getElementById('columnasPersonalizadasEst');
        if (this.checked) {
            columnasDiv.style.display = 'none';
        } else {
            columnasDiv.style.display = 'block';
            generarCamposColumnasPersonalizadas('Est');
        }
    });
    
    document.getElementById('numColumnasEst').addEventListener('change', function() {
        generarCamposColumnasPersonalizadas('Est');
    });
    
    // Familias
    document.querySelectorAll('input[name="tipoListaFam"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const selectorCursos = document.getElementById('selectorCursosFam');
            selectorCursos.style.display = this.value === 'curso' ? 'block' : 'none';
        });
    });
    
    document.getElementById('numColumnasFam').addEventListener('change', function() {
        generarCamposColumnasPersonalizadas('Fam');
    });
    
    // Trabajadores
    document.getElementById('numColumnasTrab').addEventListener('change', function() {
        generarCamposColumnasPersonalizadas('Trab');
    });

    // Event listener para Divisi√≥n (controla la cascada)
    document.getElementById('selectDivision').addEventListener('change', async function() {
        const divisionId = this.value;
        const selectCentroCosto = document.getElementById('selectCentroCosto');
        const selectArea = document.getElementById('selectArea');
        const selectSubarea = document.getElementById('selectSubarea');
        
        // Limpiar y deshabilitar los selects dependientes
        selectCentroCosto.innerHTML = '<option value="">Seleccione primero una divisi√≥n</option>';
        selectCentroCosto.disabled = true;
        selectArea.innerHTML = '<option value="">Seleccione primero un centro de costo</option>';
        selectArea.disabled = true;
        selectSubarea.innerHTML = '<option value="">Seleccione primero un √°rea</option>';
        selectSubarea.disabled = true;
        
        if (divisionId) {
            selectCentroCosto.innerHTML = '<option value="">Cargando...</option>';
            
            // Cargar centros de costo de esta divisi√≥n
            const centros = await supabaseRequest(
                `/cost_centers?select=cost_center_id,cost_center_name&division_id=eq.${divisionId}&cost_center_status=eq.active&order=cost_center_name.asc`
            );
            selectCentroCosto.innerHTML = '<option value="">Todos los centros de costo</option>';
            centros.forEach(cc => {
                const option = document.createElement('option');
                option.value = cc.cost_center_id;
                option.textContent = cc.cost_center_name;
                selectCentroCosto.appendChild(option);
            });
            selectCentroCosto.disabled = false;
            console.log(`‚úÖ ${centros.length} centros de costo cargados para la divisi√≥n`);
        }
    });
    
    // Event listener para Centro de Costo
    document.getElementById('selectCentroCosto').addEventListener('change', function() {
        cargarAreas();
    });
    
    // Event listener para √Årea
    document.getElementById('selectArea').addEventListener('change', function() {
        cargarSubareas();
    });
    
    console.log('‚úÖ Event listeners configurados');
}

async function cargarDatosIniciales() {
    try {
        console.log('üì° Cargando datos iniciales...');
        
        await cargarCursos();
        await cargarGeneros();
        await cargarCentrosCostos();
        await cargarDivisiones();
        await cargarRoles();
        await cargarSecciones();
        
        generarCamposColumnasPersonalizadas('Est');
        generarCamposColumnasPersonalizadas('Fam');
        generarCamposColumnasPersonalizadas('Trab');
        
        // Mostrar columnas personalizadas de Estudiantes por defecto
        document.getElementById('columnasPersonalizadasEst').style.display = 'block';
        
        console.log('‚úÖ Datos iniciales cargados');
        
    } catch (error) {
        console.error('‚ùå Error cargando datos iniciales:', error);
        showMessage('Error al cargar datos iniciales: ' + error.message, 'danger');
    }
}

async function cargarCursos() {
    try {
        cursosData = await supabaseRequest('/courses?select=course_id,course_name,course_order&order=course_order.asc');
        
        const selectEst = document.getElementById('selectCursosEstudiantes');
        selectEst.innerHTML = '';
        
        cursosData.forEach(curso => {
            const option = document.createElement('option');
            option.value = curso.course_id;
            option.textContent = curso.course_name;
            selectEst.appendChild(option);
        });
        
        const selectFam = document.getElementById('selectCursosFamilias');
        selectFam.innerHTML = '';
        
        cursosData.forEach(curso => {
            const option = document.createElement('option');
            option.value = curso.course_id;
            option.textContent = curso.course_name;
            selectFam.appendChild(option);
        });
        
        console.log(`‚úÖ ${cursosData.length} cursos cargados`);
        
    } catch (error) {
        console.error('‚ùå Error cargando cursos:', error);
        throw error;
    }
}

async function cargarGeneros() {
    try {
        generosData = await supabaseRequest('/genders?select=gender_id,gender_name&order=gender_name.asc');
        
        const select = document.getElementById('selectGenero');
        select.innerHTML = '';
        
        generosData.forEach(genero => {
            const option = document.createElement('option');
            option.value = genero.gender_id;
            option.textContent = genero.gender_name;
            select.appendChild(option);
        });
        
        console.log(`‚úÖ ${generosData.length} g√©neros cargados`);
        
    } catch (error) {
        console.error('‚ùå Error cargando g√©neros:', error);
    }
}

async function cargarSecciones() {
    try {
        const seccionesData = await supabaseRequest('/sections?select=section_id,section_name&section_status=eq.active&order=section_name.asc');
        
        const select = document.getElementById('selectSeccion');
        select.innerHTML = '';
        
        seccionesData.forEach(seccion => {
            const option = document.createElement('option');
            option.value = seccion.section_id;
            option.textContent = seccion.section_name;
            select.appendChild(option);
        });
        
        console.log(`‚úÖ ${seccionesData.length} secciones cargadas`);
        
    } catch (error) {
        console.error('‚ùå Error cargando secciones:', error);
    }
}
    
async function cargarCentrosCostos() {
    try {
        centrosCostosData = await supabaseRequest('/cost_centers?select=cost_center_id,cost_center_name&order=cost_center_name.asc');
        
        const select = document.getElementById('selectCentroCosto');
        select.innerHTML = '<option value="">-- Todos --</option>';
        
        centrosCostosData.forEach(cc => {
            const option = document.createElement('option');
            option.value = cc.cost_center_id;
            option.textContent = cc.cost_center_name;
            select.appendChild(option);
        });
        
        console.log(`‚úÖ ${centrosCostosData.length} centros de costos cargados`);
        
    } catch (error) {
        console.error('‚ùå Error cargando centros de costos:', error);
    }
}

async function cargarDivisiones() {
    try {
        divisionesData = await supabaseRequest(
            '/organizational_divisions?select=division_id,division_name&division_status=eq.active&order=division_name.asc'
        );
        
        const select = document.getElementById('selectDivision');
        select.innerHTML = '<option value="">Seleccione una divisi√≥n</option>';
        
        divisionesData.forEach(div => {
            const option = document.createElement('option');
            option.value = div.division_id;
            option.textContent = div.division_name;
            select.appendChild(option);
        });
        
        console.log(`‚úÖ ${divisionesData.length} divisiones cargadas`);
        
    } catch (error) {
        console.error('‚ùå Error cargando divisiones:', error);
    }
}

async function cargarAreas() {
    try {
        const centrosSeleccionados = Array.from(document.getElementById('selectCentroCosto').selectedOptions)
            .map(option => option.value)
            .filter(v => v);
        
        const select = document.getElementById('selectArea');
        const selectSubarea = document.getElementById('selectSubarea');
        
        // Limpiar sub√°rea
        selectSubarea.innerHTML = '<option value="">Seleccione primero un √°rea</option>';
        selectSubarea.disabled = true;
        
        if (centrosSeleccionados.length === 0) {
            select.innerHTML = '<option value="">Seleccione primero un centro de costo</option>';
            select.disabled = true;
            return;
        }
        
        select.innerHTML = '<option value="">Cargando...</option>';
        
        const areasPromises = centrosSeleccionados.map(ccId => 
            supabaseRequest(
                `/organizational_areas?select=area_id,area_name&cost_center_id=eq.${ccId}&area_status=eq.active&order=area_name.asc`
            )
        );
        const areasArrays = await Promise.all(areasPromises);
        areasData = areasArrays.flat();
        
        // Eliminar duplicados
        areasData = areasData.filter((area, index, self) => 
            index === self.findIndex(a => a.area_id === area.area_id)
        );
        
        select.innerHTML = '<option value="">Todas las √°reas</option>';
        areasData.forEach(area => {
            const option = document.createElement('option');
            option.value = area.area_id;
            option.textContent = area.area_name;
            select.appendChild(option);
        });
        select.disabled = false;
        
        console.log(`‚úÖ ${areasData.length} √°reas cargadas`);
        
    } catch (error) {
        console.error('‚ùå Error cargando √°reas:', error);
    }
}    

async function cargarSubareas() {
    try {
        const areasSeleccionadas = Array.from(document.getElementById('selectArea').selectedOptions)
            .map(option => option.value)
            .filter(v => v);
        
        const select = document.getElementById('selectSubarea');
        
        if (areasSeleccionadas.length === 0) {
            select.innerHTML = '<option value="">Seleccione primero un √°rea</option>';
            select.disabled = true;
            return;
        }
        
        select.innerHTML = '<option value="">Cargando...</option>';
        
        const subareasPromises = areasSeleccionadas.map(areaId => 
            supabaseRequest(
                `/organizational_subareas?select=subarea_id,subarea_name&area_id=eq.${areaId}&subarea_status=eq.active&order=subarea_name.asc`
            )
        );
        const subareasArrays = await Promise.all(subareasPromises);
        subareasData = subareasArrays.flat();
        
        // Eliminar duplicados
        subareasData = subareasData.filter((sub, index, self) => 
            index === self.findIndex(s => s.subarea_id === sub.subarea_id)
        );
        
        select.innerHTML = '<option value="">Todas las sub√°reas</option>';
        subareasData.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub.subarea_id;
            option.textContent = sub.subarea_name;
            select.appendChild(option);
        });
        select.disabled = false;
        
        console.log(`‚úÖ ${subareasData.length} sub√°reas cargadas`);
        
    } catch (error) {
        console.error('‚ùå Error cargando sub√°reas:', error);
    }
}
    
async function cargarRoles() {
    try {
        rolesData = await supabaseRequest('/job_roles?select=role_id,role_name&order=role_name.asc');
        
        const select = document.getElementById('selectRoles');
        select.innerHTML = '';
        
        rolesData.forEach(rol => {
            const option = document.createElement('option');
            option.value = rol.role_id;
            option.textContent = rol.role_name;
            select.appendChild(option);
        });
        
        console.log(`‚úÖ ${rolesData.length} roles cargados`);
        
    } catch (error) {
        console.error('‚ùå Error cargando roles:', error);
    }
}

function generarCamposColumnasPersonalizadas(tipo) {
    const numColumnas = parseInt(document.getElementById(`numColumnas${tipo}`).value) || 1;
    const container = document.getElementById(`encabezadosColumnas${tipo}`);
    
    container.innerHTML = '';
    
    for (let i = 1; i <= numColumnas; i++) {
        const div = document.createElement('div');
        div.className = 'column-input-group';
        div.innerHTML = `
            <label class="form-label fw-bold">Columna ${i}</label>
            <input type="text" class="form-control" id="colHeader${tipo}${i}" 
                   placeholder="Ej: Firma, Observaciones, Nota...">
        `;
        container.appendChild(div);
    }
}

// ==========================================
// GENERAR LISTA DE ESTUDIANTES
// ==========================================
async function generarListaEstudiantes(formato = 'pdf') {
    try {
        const cursosSeleccionados = Array.from(document.getElementById('selectCursosEstudiantes').selectedOptions)
            .map(option => option.value);
        
        if (cursosSeleccionados.length === 0) {
            showMessage('Debe seleccionar al menos un curso', 'warning');
            return;
        }
        
        const tituloPersonalizado = document.getElementById('tituloListaEst').value.trim();
        
        const opciones = {
            conNumeracion: document.getElementById('checkNumeracionEst').checked,
            conCodigo: document.getElementById('checkCodigoEst').checked,
            conFirmas: document.getElementById('checkFirmasEst').checked,
            columnasPersonalizadas: [],
            tituloPersonalizado: tituloPersonalizado
        };
        
        if (!opciones.conFirmas) {
            const numColumnas = parseInt(document.getElementById('numColumnasEst').value) || 0;
            for (let i = 1; i <= numColumnas; i++) {
                const header = document.getElementById(`colHeaderEst${i}`).value.trim();
                if (header) {
                    opciones.columnasPersonalizadas.push(header);
                }
            }
            
            if (opciones.columnasPersonalizadas.length === 0) {
                showMessage('Debe especificar al menos un encabezado para las columnas personalizadas', 'warning');
                return;
            }
        }
        
        const mensajeCarga = formato === 'pdf' ? 'Generando PDFs de estudiantes...' : 'Generando documentos Word de estudiantes...';
        mostrarLoading(mensajeCarga);
        
        for (const cursoId of cursosSeleccionados) {
            const curso = cursosData.find(c => c.course_id === cursoId);

            const estudiantes = await supabaseRequest(
                `/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2,student_status!inner(status_description)&course_id=eq.${cursoId}&student_status.status_description=eq.Activo&order=student_last_name_1.asc,student_last_name_2.asc,student_first_name.asc`
            );
            
            const estudiantesActivos = estudiantes;
             
            if (estudiantesActivos.length === 0) {
                console.warn(`‚ö†Ô∏è No hay estudiantes activos en ${curso.course_name}`);
                continue;
            }
            
            if (formato === 'pdf') {
                await generarPDFEstudiantes(curso, estudiantesActivos, opciones);
            } else {
                await generarDOCXEstudiantes(curso, estudiantesActivos, opciones);
            }
        }
        
        ocultarLoading();
        const tipoDoc = formato === 'pdf' ? 'PDF(s)' : 'documento(s) Word';
        showMessage(`${cursosSeleccionados.length} ${tipoDoc} generados exitosamente`, 'success');
        
    } catch (error) {
        console.error('‚ùå Error generando lista de estudiantes:', error);
        ocultarLoading();
        showMessage('Error al generar documentos: ' + error.message, 'danger');
    }
}
    
async function generarPDFEstudiantes(curso, estudiantes, opciones) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'letter');
    
    const nombreInstitucion = systemConfig?.organization_name || 'Instituci√≥n Educativa';
    const fechaActual = new Date().toLocaleDateString('es-CO');
    const usuario = currentUser?.user_display_name || 'Usuario';
    
    doc.setFontSize(16);
    doc.setTextColor(19, 128, 226);
    doc.text(nombreInstitucion, doc.internal.pageSize.width / 2, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100);
    const tituloDoc = opciones.tituloPersonalizado || `Lista de Estudiantes - ${curso.course_name}`;
    doc.text(tituloDoc, doc.internal.pageSize.width / 2, 28, { align: 'center' });

    
    doc.setFontSize(9);
    doc.text(`Generado por: ${usuario} | Fecha: ${fechaActual}`, doc.internal.pageSize.width / 2, 34, { align: 'center' });
    
    const columnas = [];
    if (opciones.conNumeracion) columnas.push('#');
    if (opciones.conCodigo) columnas.push('C√≥digo');
    columnas.push('Nombre Completo');
    
    if (opciones.conFirmas) {
        columnas.push('Firma Familia');
    } else {
        columnas.push(...opciones.columnasPersonalizadas);
    }
    
    const filas = estudiantes.map((est, idx) => {
        const fila = [];
        if (opciones.conNumeracion) fila.push((idx + 1).toString());
        if (opciones.conCodigo) fila.push(est.student_code || '');
        
        const nombreCompleto = `${est.student_last_name_1} ${est.student_last_name_2 || ''} ${est.student_first_name}`.trim();
        fila.push(nombreCompleto);
        
        const numColumnasVacias = opciones.conFirmas ? 1 : opciones.columnasPersonalizadas.length;
        for (let i = 0; i < numColumnasVacias; i++) {
            fila.push('');
        }
        
        return fila;
    });
    
    doc.autoTable({
        head: [columnas],
        body: filas,
        startY: 40,
        theme: 'grid',
        styles: {
            fontSize: 9,
            cellPadding: 3
        },
        headStyles: {
            fillColor: [19, 128, 226],
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center'
        },
        alternateRowStyles: {
            fillColor: [248, 249, 250]
        }
    });
    
    const finalY = doc.lastAutoTable.finalY || 40;
    doc.setFontSize(10);
    doc.setTextColor(0);
    doc.text(`Total de estudiantes: ${estudiantes.length}`, 14, finalY + 10);

    const nombreBase = opciones.tituloPersonalizado 
        ? opciones.tituloPersonalizado.replace(/\s+/g, '_')
        : `Lista_Estudiantes_${curso.course_name.replace(/\s+/g, '_')}`;
    const nombreArchivo = `${nombreBase}_${Date.now()}.pdf`;

    
    doc.save(nombreArchivo);
    
    console.log(`‚úÖ PDF generado: ${nombreArchivo}`);
}

// ==========================================
// GENERAR LISTA DE FAMILIAS
// ==========================================
async function generarListaFamilias(formato = 'pdf') {
    try {
        const tipoLista = document.querySelector('input[name="tipoListaFam"]:checked').value;
        const tituloPersonalizado = document.getElementById('tituloListaFam').value.trim();
        
        const numColumnas = parseInt(document.getElementById('numColumnasFam').value) || 0;
        const columnasPersonalizadas = [];
        
        for (let i = 1; i <= numColumnas; i++) {
            const header = document.getElementById(`colHeaderFam${i}`).value.trim();
            if (header) {
                columnasPersonalizadas.push(header);
            }
        }
        
        if (columnasPersonalizadas.length === 0) {
            showMessage('Debe especificar al menos un encabezado para las columnas personalizadas', 'warning');
            return;
        }
        
        const mensajeCarga = formato === 'pdf' ? 'Generando PDFs de familias...' : 'Generando documentos Word de familias...';
        mostrarLoading(mensajeCarga);
        
        if (tipoLista === 'general') {
            if (formato === 'pdf') {
                await generarPDFFamiliasGeneral(columnasPersonalizadas, tituloPersonalizado);
            } else {
                await generarDOCXFamiliasGeneral(columnasPersonalizadas, tituloPersonalizado);
            }
        } else {
            const cursosSeleccionados = Array.from(document.getElementById('selectCursosFamilias').selectedOptions)
                .map(option => option.value);
            
            if (cursosSeleccionados.length === 0) {
                showMessage('Debe seleccionar al menos un curso', 'warning');
                ocultarLoading();
                return;
            }
            
            for (const cursoId of cursosSeleccionados) {
                const curso = cursosData.find(c => c.course_id === cursoId);
                if (formato === 'pdf') {
                    await generarPDFFamiliasPorCurso(curso, cursoId, columnasPersonalizadas, tituloPersonalizado);
                } else {
                    await generarDOCXFamiliasPorCurso(curso, cursoId, columnasPersonalizadas, tituloPersonalizado);
                }
            }
        }
        
        ocultarLoading();
        const tipoDoc = formato === 'pdf' ? 'PDF(s)' : 'documento(s) Word';
        showMessage(`${tipoDoc} generado(s) exitosamente`, 'success');
        
    } catch (error) {
        console.error('‚ùå Error generando lista de familias:', error);
        ocultarLoading();
        showMessage('Error al generar documentos: ' + error.message, 'danger');
    }
}

async function generarPDFFamiliasGeneral(columnasPersonalizadas, tituloPersonalizado = '') {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'letter');
    
   const familias = await supabaseRequest(
        '/families?select=family_code,family_name&family_status=eq.active&order=family_name.asc'
    );
    
    // Ya vienen filtradas por active desde la query
    const familiasActivas = familias;
    
    const familiasConHijos = [];
    
    for (const familia of familiasActivas) {
        const hijos = await supabaseRequest(
            `/students?select=student_first_name,student_last_name_1,courses(course_name),student_status!inner(status_description)&family_id=eq.${familia.family_code}&student_status.status_description=eq.Activo&order=student_first_name.asc`
        );
        
        // Ya vienen filtrados por Activo desde la query
        const hijosActivos = hijos;
        
        if (hijosActivos.length > 0) {
            const hijosTexto = hijosActivos.map(h => 
                `${h.student_first_name} ${h.student_last_name_1} (${h.courses?.course_name || 'Sin curso'})`
            ).join('; ');
            
            familiasConHijos.push({
                familia: familia.family_name,
                hijos: hijosTexto
            });
        }
    }
    
    const nombreInstitucion = systemConfig?.organization_name || 'Instituci√≥n Educativa';
    const fechaActual = new Date().toLocaleDateString('es-CO');
    const usuario = currentUser?.user_display_name || 'Usuario';
    
    doc.setFontSize(16);
    doc.setTextColor(19, 128, 226);
    doc.text(nombreInstitucion, doc.internal.pageSize.width / 2, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100);
    const tituloDoc = tituloPersonalizado || 'Lista General de Familias';
    doc.text(tituloDoc, doc.internal.pageSize.width / 2, 28, { align: 'center' });

    doc.setFontSize(9);
    doc.text(`Generado por: ${usuario} | Fecha: ${fechaActual}`, doc.internal.pageSize.width / 2, 34, { align: 'center' });
    
    const columnas = ['Familia', 'Hijos y Cursos', ...columnasPersonalizadas];
    
    const filas = familiasConHijos.map(fam => {
        const fila = [fam.familia, fam.hijos];
        for (let i = 0; i < columnasPersonalizadas.length; i++) {
            fila.push('');
        }
        return fila;
    });
    
    doc.autoTable({
        head: [columnas],
        body: filas,
        startY: 40,
        theme: 'grid',
        styles: {
            fontSize: 8,
            cellPadding: 3
        },
        headStyles: {
            fillColor: [19, 128, 226],
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center'
        },
        columnStyles: {
            0: { cellWidth: 50 },
            1: { cellWidth: 80 }
        },
        alternateRowStyles: {
            fillColor: [248, 249, 250]
        }
    });
    
    const finalY = doc.lastAutoTable.finalY || 40;
    doc.setFontSize(10);
    doc.setTextColor(0);
    doc.text(`Total de familias: ${familiasConHijos.length}`, 14, finalY + 10);
    const nombreBase = tituloPersonalizado 
        ? tituloPersonalizado.replace(/\s+/g, '_')
        : 'Lista_Familias_General';
    const nombreArchivo = `${nombreBase}_${Date.now()}.pdf`;
    doc.save(nombreArchivo);
    
    console.log(`‚úÖ PDF generado: ${nombreArchivo}`);
}

async function generarPDFFamiliasPorCurso(curso, cursoId, columnasPersonalizadas, tituloPersonalizado = '') {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'letter');

   // PASO 1: Obtener estudiantes activos del curso
    const estudiantes = await supabaseRequest(
        `/students?select=student_id,family_id,student_first_name,student_last_name_1,student_status!inner(status_description)&course_id=eq.${cursoId}&student_status.status_description=eq.Activo&order=student_first_name.asc`
    );
    
    if (estudiantes.length === 0) {
        throw new Error(`No hay estudiantes activos en el curso ${curso.course_name}`);
    }
    
    // PASO 2: Obtener c√≥digos √∫nicos de familias
    const familyCodesUnicos = [...new Set(estudiantes.map(e => e.family_id))];
    
    // PASO 3: Para cada familia, obtener su nombre
    const familiasMap = new Map();
    
    for (const familyCode of familyCodesUnicos) {
        // Obtener datos de la familia
        const familiaData = await supabaseRequest(
            `/families?select=family_name&family_code=eq.${familyCode}&limit=1`
        );
        
        const nombreFamilia = familiaData[0]?.family_name || `Familia ${familyCode}`;
        familiasMap.set(familyCode, nombreFamilia);
    }
    
    // PASO 4: Agrupar estudiantes por familia
    const familiasConHijosMap = new Map();
    
    estudiantes.forEach(est => {
        const familyCode = est.family_id;
        const nombreFamilia = familiasMap.get(familyCode) || `Familia ${familyCode}`;
        
        if (!familiasConHijosMap.has(familyCode)) {
            familiasConHijosMap.set(familyCode, {
                familia: nombreFamilia,
                hijos: []
            });
        }
        
        familiasConHijosMap.get(familyCode).hijos.push(`${est.student_first_name} ${est.student_last_name_1}`);
    });
    
    const familiasConHijos = Array.from(familiasConHijosMap.values())
    .map(fam => ({
        familia: fam.familia,
        hijos: fam.hijos.join(', ')
    }))
    .sort((a, b) => a.familia.localeCompare(b.familia, 'es', { sensitivity: 'base' }));
    
    const nombreInstitucion = systemConfig?.organization_name || 'Instituci√≥n Educativa';
    const fechaActual = new Date().toLocaleDateString('es-CO');
    const usuario = currentUser?.user_display_name || 'Usuario';
    
    doc.setFontSize(16);
    doc.setTextColor(19, 128, 226);
    doc.text(nombreInstitucion, doc.internal.pageSize.width / 2, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100);
    const tituloDoc = tituloPersonalizado || `Lista de Familias - ${curso.course_name}`;
    doc.text(tituloDoc, doc.internal.pageSize.width / 2, 28, { align: 'center' });
    doc.setFontSize(9);
    doc.text(`Generado por: ${usuario} | Fecha: ${fechaActual}`, doc.internal.pageSize.width / 2, 34, { align: 'center' });
    
    const columnas = ['Familia', 'Hijos', ...columnasPersonalizadas];
    
    const filas = familiasConHijos.map(fam => {
        const fila = [fam.familia, fam.hijos];
        for (let i = 0; i < columnasPersonalizadas.length; i++) {
            fila.push('');
        }
        return fila;
    });
    
    doc.autoTable({
        head: [columnas],
        body: filas,
        startY: 40,
        theme: 'grid',
        styles: {
            fontSize: 9,
            cellPadding: 3
        },
        headStyles: {
            fillColor: [19, 128, 226],
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center'
        },
        columnStyles: {
            0: { cellWidth: 60 },
            1: { cellWidth: 70 }
        },
        alternateRowStyles: {
            fillColor: [248, 249, 250]
        }
    });
    
    const finalY = doc.lastAutoTable.finalY || 40;
    doc.setFontSize(10);
    doc.setTextColor(0);
    doc.text(`Total de familias: ${familiasConHijos.length}`, 14, finalY + 10);

    const nombreBase = tituloPersonalizado 
        ? tituloPersonalizado.replace(/\s+/g, '_')
        : `Lista_Familias_${curso.course_name.replace(/\s+/g, '_')}`;
    const nombreArchivo = `${nombreBase}_${Date.now()}.pdf`;
    
    doc.save(nombreArchivo);
    
    console.log(`‚úÖ PDF generado: ${nombreArchivo}`);
}

// ==========================================
// GENERAR LISTA DE TRABAJADORES
// ==========================================
async function generarListaTrabajadores(formato = 'pdf') {
    try {
        const tituloPersonalizado = document.getElementById('tituloListaTrab').value.trim();
        
        const opciones = {
            conNumeracion: document.getElementById('checkNumeracionTrab').checked,
            conDocumento: document.getElementById('checkDocumentoTrab').checked,
            columnasPersonalizadas: [],
            tituloPersonalizado: tituloPersonalizado
        };
        
        const numColumnas = parseInt(document.getElementById('numColumnasTrab').value) || 0;
        for (let i = 1; i <= numColumnas; i++) {
            const header = document.getElementById(`colHeaderTrab${i}`).value.trim();
            if (header) {
                opciones.columnasPersonalizadas.push(header);
            }
        }
        
        if (opciones.columnasPersonalizadas.length === 0) {
            showMessage('Debe especificar al menos un encabezado para las columnas personalizadas', 'warning');
            return;
        }
        
        const filtros = {
            generos: Array.from(document.getElementById('selectGenero').selectedOptions)
                .map(o => o.value).filter(v => v),
            secciones: Array.from(document.getElementById('selectSeccion').selectedOptions)
                .map(o => o.value).filter(v => v),
            centrosCostos: Array.from(document.getElementById('selectCentroCosto').selectedOptions)
                .map(o => o.value).filter(v => v),
            areas: Array.from(document.getElementById('selectArea').selectedOptions)
                .map(o => o.value).filter(v => v),
            subareas: Array.from(document.getElementById('selectSubarea').selectedOptions)
                .map(o => o.value).filter(v => v),
            roles: Array.from(document.getElementById('selectRoles').selectedOptions)
                .map(o => o.value).filter(v => v)
        };

        // Capturar divisi√≥n seleccionada
        const divisionSeleccionada = document.getElementById('selectDivision').value;
        let divisionNombre = '';
        
        if (divisionSeleccionada) {
            const division = divisionesData.find(d => d.division_id === divisionSeleccionada);
            divisionNombre = division ? division.division_name : '';
        }

        // Capturar divisi√≥n seleccionada
        const divisionId = document.getElementById('selectDivision').value;
        let divisionNombre = '';
        
        if (divisionId) {
            const division = divisionesData.find(d => d.division_id === divisionId);
            divisionNombre = division ? division.division_name : '';
        }
        
        // Si hay divisi√≥n seleccionada pero NO hay centros de costo seleccionados,
        // informar al usuario que se generar√°n secciones por centro de costo
        if (divisionId && filtros.centrosCostos.length === 0) {
            console.log('‚ÑπÔ∏è Se generar√°n secciones por centro de costo dentro de la divisi√≥n:', divisionNombre);
        }
        mostrarLoading('Obteniendo trabajadores...');
        
        const trabajadores = await obtenerTrabajadoresFiltrados(filtros);
        
        if (trabajadores.length === 0) {
            showMessage('No se encontraron trabajadores con los filtros especificados', 'warning');
            ocultarLoading();
            return;
        }
        
        if (formato === 'pdf') {
            await generarPDFTrabajadores(trabajadores, opciones, divisionSeleccionada, divisionNombre, filtros);
        } else {
            await generarDOCXTrabajadores(trabajadores, opciones, divisionSeleccionada, divisionNombre, filtros);
        }
        
        ocultarLoading();
        const tipoDoc = formato === 'pdf' ? 'PDF' : 'documento Word';
        showMessage(`${tipoDoc} generado exitosamente`, 'success');
        
    } catch (error) {
        console.error('‚ùå Error generando lista de trabajadores:', error);
        ocultarLoading();
        showMessage('Error al generar documento: ' + error.message, 'danger');
    }
}
    
async function obtenerTrabajadoresFiltrados(filtros) {
    try {
        // Construir query base - SOLO filtrar por worker_status
        let query = '/workers?select=worker_id,worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2,organizational_division_id,organizational_cost_center_id,organizational_area_id,organizational_subarea_id,section_id,gender_id&worker_status=eq.active';
        let trabajadores = await supabaseRequest(query);
        
        // Aplicar filtros en cascada (cliente-side)
        // Filtro por divisi√≥n (si existe en la interfaz, aunque no est√© en filtros)
        const divisionSeleccionada = document.getElementById('selectDivision').value;
        if (divisionSeleccionada) {
            trabajadores = trabajadores.filter(t => t.organizational_division_id === divisionSeleccionada);
        }
        
        // Filtro por centros de costo
        if (filtros.centrosCostos.length > 0) {
            trabajadores = trabajadores.filter(t => 
                filtros.centrosCostos.includes(t.organizational_cost_center_id)
            );
        }
        
        // Filtro por √°reas
        if (filtros.areas.length > 0) {
            trabajadores = trabajadores.filter(t => 
                filtros.areas.includes(t.organizational_area_id)
            );
        }
        
        // Filtro por sub√°reas
        if (filtros.subareas.length > 0) {
            trabajadores = trabajadores.filter(t => 
                filtros.subareas.includes(t.organizational_subarea_id)
            );
        }
        
        // Filtro por g√©neros
        if (filtros.generos.length > 0) {
            trabajadores = trabajadores.filter(t => 
                filtros.generos.includes(t.gender_id)
            );
        }

        // Filtro por secciones
        if (filtros.secciones.length > 0) {
            trabajadores = trabajadores.filter(t => 
                filtros.secciones.includes(t.section_id)
            );
        }
        
        // Filtro por roles (requiere consulta adicional)
        if (filtros.roles.length > 0) {
            const trabajadoresConRoles = [];
            
            for (const trabajador of trabajadores) {
                const rolesDelTrabajador = await supabaseRequest(
                    `/worker_job_roles?select=job_role_id&worker_id=eq.${trabajador.worker_id}`
                );
                
                const rolesIds = rolesDelTrabajador.map(r => r.job_role_id);
                const tieneRol = filtros.roles.some(rolId => rolesIds.includes(rolId));
                
                if (tieneRol) {
                    trabajadoresConRoles.push(trabajador);
                }
            }
            
            trabajadores = trabajadoresConRoles;
        }
        
        // Mapear y ordenar
        return trabajadores.map(trab => ({
            ...trab,
            nombreCompleto: `${trab.worker_last_name_1} ${trab.worker_last_name_2 || ''} ${trab.worker_first_name}`.trim()
        })).sort((a, b) => a.nombreCompleto.localeCompare(b.nombreCompleto));
        
    } catch (error) {
        console.error('‚ùå Error obteniendo trabajadores:', error);
        throw error;
    }
}

async function generarPDFTrabajadores(trabajadores, opciones, divisionId, divisionNombre, filtros) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'letter');
    
    const nombreInstitucion = systemConfig?.organization_name || 'Instituci√≥n Educativa';
    const fechaActual = new Date().toLocaleDateString('es-CO');
    const usuario = currentUser?.user_display_name || 'Usuario';
    
    // Determinar t√≠tulo del documento
    let tituloDoc = opciones.tituloPersonalizado || 'Lista de Trabajadores';
    
    // Si hay divisi√≥n, agregar al t√≠tulo
    if (divisionNombre) {
        tituloDoc += ` - ${divisionNombre}`;
    }
    
    // Si hay un centro de costo espec√≠fico seleccionado, agregarlo
    if (filtros.centrosCostos.length === 1) {
        const centroCosto = centrosCostosData.find(cc => cc.cost_center_id === filtros.centrosCostos[0]);
        if (centroCosto) {
            tituloDoc += ` - ${centroCosto.cost_center_name}`;
        }
    }
    
    // Encabezado principal
    doc.setFontSize(16);
    doc.setTextColor(19, 128, 226);
    doc.text(nombreInstitucion, doc.internal.pageSize.width / 2, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100);
    doc.text(tituloDoc, doc.internal.pageSize.width / 2, 28, { align: 'center' });
    
    doc.setFontSize(9);
    doc.text(`Generado por: ${usuario} | Fecha: ${fechaActual}`, doc.internal.pageSize.width / 2, 34, { align: 'center' });
    
    let currentY = 40;
    
    // Determinar si se debe dividir por centros de costo
    const dividirPorCentroCosto = divisionId && filtros.centrosCostos.length === 0;
    
    if (dividirPorCentroCosto) {
        // MODO: Divisi√≥n por centros de costo
        
        // Obtener todos los centros de costo de la divisi√≥n
        const centrosCostosDivision = await supabaseRequest(
            `/cost_centers?select=cost_center_id,cost_center_name&division_id=eq.${divisionId}&cost_center_status=eq.active&order=cost_center_name.asc`
        );
        
        // Agrupar trabajadores por centro de costo
        const trabajadoresPorCentro = {};
        const trabajadoresSinCentro = [];
        
        trabajadores.forEach(trab => {
            if (trab.organizational_cost_center_id) {
                if (!trabajadoresPorCentro[trab.organizational_cost_center_id]) {
                    trabajadoresPorCentro[trab.organizational_cost_center_id] = [];
                }
                trabajadoresPorCentro[trab.organizational_cost_center_id].push(trab);
            } else {
                trabajadoresSinCentro.push(trab);
            }
        });
        
        // Generar secciones por centro de costo (orden alfab√©tico)
        for (const centro of centrosCostosDivision) {
            const trabajadoresCentro = trabajadoresPorCentro[centro.cost_center_id] || [];
            
            if (trabajadoresCentro.length === 0) continue;
            
            // Verificar si necesita nueva p√°gina
            if (currentY > 240) {
                doc.addPage();
                currentY = 20;
            }
            
            // Encabezado de secci√≥n
            doc.setFontSize(11);
            doc.setTextColor(19, 128, 226);
            doc.setFont(undefined, 'bold');
            doc.text(`Centro de Costo: ${centro.cost_center_name}`, 14, currentY);
            currentY += 8;
            doc.setFont(undefined, 'normal');
            
            // Preparar columnas
            const columnas = [];
            if (opciones.conNumeracion) columnas.push('#');
            if (opciones.conDocumento) columnas.push('Documento');
            columnas.push('Nombre Completo');
            columnas.push(...opciones.columnasPersonalizadas);
            
            // Preparar filas
            const filas = trabajadoresCentro.map((trab, idx) => {
                const fila = [];
                if (opciones.conNumeracion) fila.push((idx + 1).toString());
                if (opciones.conDocumento) fila.push(trab.worker_id_doc || '');
                fila.push(trab.nombreCompleto);
                
                for (let i = 0; i < opciones.columnasPersonalizadas.length; i++) {
                    fila.push('');
                }
                
                return fila;
            });
            
            // Generar tabla
            doc.autoTable({
                head: [columnas],
                body: filas,
                startY: currentY,
                theme: 'grid',
                styles: {
                    fontSize: 9,
                    cellPadding: 3
                },
                headStyles: {
                    fillColor: [19, 128, 226],
                    textColor: 255,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                columnStyles: (() => {
                    const styles = {};
                    let colIndex = 0;
                    
                    if (opciones.conNumeracion) {
                        styles[colIndex] = { cellWidth: 8 };
                        colIndex++;
                    }
                    
                    if (opciones.conDocumento) {
                        styles[colIndex] = { cellWidth: 28 };
                        colIndex++;
                    }
                    
                    styles[colIndex] = { cellWidth: 85 };
                    
                    return styles;
                })(),
                alternateRowStyles: {
                    fillColor: [248, 249, 250]
                }
            });
            
            currentY = doc.lastAutoTable.finalY + 5;
            
            // Total de trabajadores de este centro
            doc.setFontSize(9);
            doc.setTextColor(0);
            doc.text(`Total: ${trabajadoresCentro.length} trabajadores`, 14, currentY);
            currentY += 10;
        }
        
        // Trabajadores sin centro de costo al final
        if (trabajadoresSinCentro.length > 0) {
            if (currentY > 240) {
                doc.addPage();
                currentY = 20;
            }
            
            doc.setFontSize(11);
            doc.setTextColor(19, 128, 226);
            doc.setFont(undefined, 'bold');
            doc.text('Sin Centro de Costo', 14, currentY);
            currentY += 8;
            doc.setFont(undefined, 'normal');
            
            const columnas = [];
            if (opciones.conNumeracion) columnas.push('#');
            if (opciones.conDocumento) columnas.push('Documento');
            columnas.push('Nombre Completo');
            columnas.push(...opciones.columnasPersonalizadas);
            
            const filas = trabajadoresSinCentro.map((trab, idx) => {
                const fila = [];
                if (opciones.conNumeracion) fila.push((idx + 1).toString());
                if (opciones.conDocumento) fila.push(trab.worker_id_doc || '');
                fila.push(trab.nombreCompleto);
                
                for (let i = 0; i < opciones.columnasPersonalizadas.length; i++) {
                    fila.push('');
                }
                
                return fila;
            });
            
            doc.autoTable({
                head: [columnas],
                body: filas,
                startY: currentY,
                theme: 'grid',
                styles: {
                    fontSize: 9,
                    cellPadding: 3
                },
                headStyles: {
                    fillColor: [19, 128, 226],
                    textColor: 255,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                columnStyles: (() => {
                    const styles = {};
                    let colIndex = 0;
                    
                    if (opciones.conNumeracion) {
                        styles[colIndex] = { cellWidth: 8 };
                        colIndex++;
                    }
                    
                    if (opciones.conDocumento) {
                        styles[colIndex] = { cellWidth: 28 };
                        colIndex++;
                    }
                    
                    styles[colIndex] = { cellWidth: 85 };
                    
                    return styles;
                })(),
                alternateRowStyles: {
                    fillColor: [248, 249, 250]
                }
            });
            
            currentY = doc.lastAutoTable.finalY + 5;
            doc.setFontSize(9);
            doc.setTextColor(0);
            doc.text(`Total: ${trabajadoresSinCentro.length} trabajadores`, 14, currentY);
        }
        
        // Total general al final
        if (currentY > 260) {
            doc.addPage();
            currentY = 20;
        } else {
            currentY += 10;
        }
        
        doc.setFontSize(10);
        doc.setTextColor(0);
        doc.setFont(undefined, 'bold');
        doc.text(`TOTAL GENERAL: ${trabajadores.length} trabajadores`, 14, currentY);
        
    } else {
        // MODO: Lista √∫nica (sin divisi√≥n o con centro espec√≠fico)
        
        const columnas = [];
        if (opciones.conNumeracion) columnas.push('#');
        if (opciones.conDocumento) columnas.push('Documento');
        columnas.push('Nombre Completo');
        columnas.push(...opciones.columnasPersonalizadas);
        
        const filas = trabajadores.map((trab, idx) => {
            const fila = [];
            if (opciones.conNumeracion) fila.push((idx + 1).toString());
            if (opciones.conDocumento) fila.push(trab.worker_id_doc || '');
            fila.push(trab.nombreCompleto);
            
            for (let i = 0; i < opciones.columnasPersonalizadas.length; i++) {
                fila.push('');
            }
            
            return fila;
        });
        
        doc.autoTable({
            head: [columnas],
            body: filas,
            startY: currentY,
            theme: 'grid',
            styles: {
                fontSize: 9,
                cellPadding: 3
            },
            headStyles: {
                fillColor: [19, 128, 226],
                textColor: 255,
                fontStyle: 'bold',
                halign: 'center'
            },
            columnStyles: (() => {
                const styles = {};
                let colIndex = 0;
                
                if (opciones.conNumeracion) {
                    styles[colIndex] = { cellWidth: 8 };
                    colIndex++;
                }
                
                if (opciones.conDocumento) {
                    styles[colIndex] = { cellWidth: 28 };
                    colIndex++;
                }
                
                styles[colIndex] = { cellWidth: 85 };
                
                return styles;
            })(),
            alternateRowStyles: {
                fillColor: [248, 249, 250]
            }
        });
        
        const finalY = doc.lastAutoTable.finalY || currentY;
        doc.setFontSize(10);
        doc.setTextColor(0);
        doc.text(`Total de trabajadores: ${trabajadores.length}`, 14, finalY + 10);
    }
    
    const nombreBase = opciones.tituloPersonalizado 
        ? opciones.tituloPersonalizado.replace(/\s+/g, '_')
        : 'Lista_Trabajadores';
    const nombreArchivo = `${nombreBase}_${Date.now()}.pdf`;
    
    doc.save(nombreArchivo);
    
    console.log(`‚úÖ PDF generado: ${nombreArchivo}`);
}
    
// ==========================================
// UTILIDADES
// ==========================================
function mostrarLoading(mensaje = 'Cargando...') {
    document.getElementById('loadingMessage').textContent = mensaje;
    document.getElementById('loadingOverlay').classList.add('show');
}

function ocultarLoading() {
    document.getElementById('loadingOverlay').classList.remove('show');
}

// ==========================================
// FUNCIONES PARA GENERAR DOCX (WORD)
// ==========================================

/**
 * Genera documento Word para lista de estudiantes
 */
async function generarDOCXEstudiantes(curso, estudiantes, opciones) {
    try {
        const { Document, Packer, Paragraph, Table, TableCell, TableRow, TextRun, WidthType, AlignmentType, BorderStyle } = docx;
        
        const nombreInstitucion = systemConfig?.organization_name || 'Instituci√≥n Educativa';
        const fechaActual = new Date().toLocaleDateString('es-CO');
        const usuario = currentUser?.user_display_name || 'Usuario';
        const tituloDoc = opciones.tituloPersonalizado || `Lista de Estudiantes - ${curso.course_name}`;
        
        // Construir encabezados de tabla
        const columnas = [];
        if (opciones.conNumeracion) columnas.push('#');
        if (opciones.conCodigo) columnas.push('C√≥digo');
        columnas.push('Nombre Completo');
        
        if (opciones.conFirmas) {
            columnas.push('Firma Familia');
        } else {
            columnas.push(...opciones.columnasPersonalizadas);
        }
        
        // Crear filas de encabezado
        const headerCells = columnas.map(col => 
            new TableCell({
                children: [new Paragraph({
                    text: col,
                    alignment: AlignmentType.CENTER,
                    style: 'headerStyle'
                })],
                shading: { fill: '1380E2' },
                margins: { top: 100, bottom: 100, left: 100, right: 100 }
            })
        );
        
        // Crear filas de datos
        const dataRows = estudiantes.map((est, idx) => {
            const cells = [];
            
            if (opciones.conNumeracion) {
                cells.push(new TableCell({
                    children: [new Paragraph({ text: (idx + 1).toString(), alignment: AlignmentType.CENTER })],
                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                }));
            }
            
            if (opciones.conCodigo) {
                cells.push(new TableCell({
                    children: [new Paragraph({ text: est.student_code?.toString() || '', alignment: AlignmentType.CENTER })],
                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                }));
            }
            
            const nombreCompleto = `${est.student_last_name_1} ${est.student_last_name_2 || ''} ${est.student_first_name}`.trim();
            cells.push(new TableCell({
                children: [new Paragraph({ text: nombreCompleto })],
                margins: { top: 100, bottom: 100, left: 100, right: 100 }
            }));
            
            // Columnas vac√≠as para firmas o personalizadas
            const numColumnasVacias = opciones.conFirmas ? 1 : opciones.columnasPersonalizadas.length;
            for (let i = 0; i < numColumnasVacias; i++) {
                cells.push(new TableCell({
                    children: [new Paragraph({ text: '' })],
                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                }));
            }
            
            return new TableRow({ children: cells });
        });
        
        // Crear tabla
        const table = new Table({
            rows: [
                new TableRow({ children: headerCells, tableHeader: true }),
                ...dataRows
            ],
            width: { size: 100, type: WidthType.PERCENTAGE },
            borders: {
                top: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                bottom: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                left: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                right: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                insideVertical: { style: BorderStyle.SINGLE, size: 1, color: '000000' }
            }
        });
        
        // Crear documento
        const doc = new Document({
            sections: [{
                properties: {},
                children: [
                    // Encabezado
                    new Paragraph({
                        text: nombreInstitucion,
                        heading: 'Heading1',
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 200 }
                    }),
                    new Paragraph({
                        text: tituloDoc,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 100 }
                    }),
                    new Paragraph({
                        text: `Generado por: ${usuario} | Fecha: ${fechaActual}`,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 400 }
                    }),
                    
                    // Tabla
                    table,
                    
                    // Pie
                    new Paragraph({
                        text: `Total de estudiantes: ${estudiantes.length}`,
                        spacing: { before: 400 }
                    })
                ]
            }]
        });
        
        // Generar y descargar
        const blob = await Packer.toBlob(doc);
        const nombreBase = opciones.tituloPersonalizado 
            ? opciones.tituloPersonalizado.replace(/\s+/g, '_')
            : `Lista_Estudiantes_${curso.course_name.replace(/\s+/g, '_')}`;
        const nombreArchivo = `${nombreBase}_${Date.now()}.docx`;
        
        descargarBlob(blob, nombreArchivo);
        console.log(`‚úÖ DOCX generado: ${nombreArchivo}`);
        
    } catch (error) {
        console.error('‚ùå Error generando DOCX de estudiantes:', error);
        throw error;
    }
}

/**
 * Genera documento Word para lista general de familias
 */
async function generarDOCXFamiliasGeneral(columnasPersonalizadas, tituloPersonalizado = '') {
    try {
        const { Document, Packer, Paragraph, Table, TableCell, TableRow, WidthType, AlignmentType, BorderStyle } = docx;
        
        const familias = await supabaseRequest(
            '/families?select=family_code,family_name&family_status=eq.active&order=family_name.asc'
        );
        
        const familiasActivas = familias;
        const familiasConHijos = [];
        
        for (const familia of familiasActivas) {
            const hijos = await supabaseRequest(
                `/students?select=student_first_name,student_last_name_1,courses(course_name),student_status!inner(status_description)&family_id=eq.${familia.family_code}&student_status.status_description=eq.Activo&order=student_first_name.asc`
            );
            
            const hijosActivos = hijos;
            
            if (hijosActivos.length > 0) {
                const hijosTexto = hijosActivos.map(h => 
                    `${h.student_first_name} ${h.student_last_name_1} (${h.courses?.course_name || 'Sin curso'})`
                ).join('; ');
                
                familiasConHijos.push({
                    familia: familia.family_name,
                    hijos: hijosTexto
                });
            }
        }
        
        const nombreInstitucion = systemConfig?.organization_name || 'Instituci√≥n Educativa';
        const fechaActual = new Date().toLocaleDateString('es-CO');
        const usuario = currentUser?.user_display_name || 'Usuario';
        const tituloDoc = tituloPersonalizado || 'Lista General de Familias';
        
        // Construir encabezados
        const columnas = ['Familia', 'Hijos y Cursos', ...columnasPersonalizadas];
        
        const headerCells = columnas.map(col => 
            new TableCell({
                children: [new Paragraph({
                    text: col,
                    alignment: AlignmentType.CENTER,
                    style: 'headerStyle'
                })],
                shading: { fill: '1380E2' },
                margins: { top: 100, bottom: 100, left: 100, right: 100 }
            })
        );
        
        // Crear filas de datos
        const dataRows = familiasConHijos.map(fam => {
            const cells = [
                new TableCell({
                    children: [new Paragraph({ text: fam.familia })],
                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                }),
                new TableCell({
                    children: [new Paragraph({ text: fam.hijos })],
                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                })
            ];
            
            // Columnas personalizadas vac√≠as
            for (let i = 0; i < columnasPersonalizadas.length; i++) {
                cells.push(new TableCell({
                    children: [new Paragraph({ text: '' })],
                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                }));
            }
            
            return new TableRow({ children: cells });
        });
        
        // Crear tabla
        const table = new Table({
            rows: [
                new TableRow({ children: headerCells, tableHeader: true }),
                ...dataRows
            ],
            width: { size: 100, type: WidthType.PERCENTAGE },
            borders: {
                top: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                bottom: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                left: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                right: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                insideVertical: { style: BorderStyle.SINGLE, size: 1, color: '000000' }
            }
        });
        
        // Crear documento
        const doc = new Document({
            sections: [{
                properties: {},
                children: [
                    new Paragraph({
                        text: nombreInstitucion,
                        heading: 'Heading1',
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 200 }
                    }),
                    new Paragraph({
                        text: tituloDoc,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 100 }
                    }),
                    new Paragraph({
                        text: `Generado por: ${usuario} | Fecha: ${fechaActual}`,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 400 }
                    }),
                    table,
                    new Paragraph({
                        text: `Total de familias: ${familiasConHijos.length}`,
                        spacing: { before: 400 }
                    })
                ]
            }]
        });
        
        const blob = await Packer.toBlob(doc);
        const nombreBase = tituloPersonalizado 
            ? tituloPersonalizado.replace(/\s+/g, '_')
            : 'Lista_Familias_General';
        const nombreArchivo = `${nombreBase}_${Date.now()}.docx`;
        
        descargarBlob(blob, nombreArchivo);
        console.log(`‚úÖ DOCX generado: ${nombreArchivo}`);
        
    } catch (error) {
        console.error('‚ùå Error generando DOCX de familias general:', error);
        throw error;
    }
}

/**
 * Genera documento Word para lista de familias por curso
 */
async function generarDOCXFamiliasPorCurso(curso, cursoId, columnasPersonalizadas, tituloPersonalizado = '') {
    try {
        const { Document, Packer, Paragraph, Table, TableCell, TableRow, WidthType, AlignmentType, BorderStyle } = docx;
        
        const estudiantes = await supabaseRequest(
            `/students?select=student_id,family_id,student_first_name,student_last_name_1,student_status!inner(status_description)&course_id=eq.${cursoId}&student_status.status_description=eq.Activo&order=student_first_name.asc`
        );
        
        if (estudiantes.length === 0) {
            throw new Error(`No hay estudiantes activos en el curso ${curso.course_name}`);
        }
        
        const familyCodesUnicos = [...new Set(estudiantes.map(e => e.family_id))];
        const familiasMap = new Map();
        
        for (const familyCode of familyCodesUnicos) {
            const familiaData = await supabaseRequest(
                `/families?select=family_name&family_code=eq.${familyCode}&limit=1`
            );
            const nombreFamilia = familiaData[0]?.family_name || `Familia ${familyCode}`;
            familiasMap.set(familyCode, nombreFamilia);
        }
        
        const familiasConHijosMap = new Map();
        
        estudiantes.forEach(est => {
            const familyCode = est.family_id;
            const nombreFamilia = familiasMap.get(familyCode) || `Familia ${familyCode}`;
            
            if (!familiasConHijosMap.has(familyCode)) {
                familiasConHijosMap.set(familyCode, {
                    familia: nombreFamilia,
                    hijos: []
                });
            }
            
            familiasConHijosMap.get(familyCode).hijos.push(`${est.student_first_name} ${est.student_last_name_1}`);
        });
        
        const familiasConHijos = Array.from(familiasConHijosMap.values())
            .map(fam => ({
                familia: fam.familia,
                hijos: fam.hijos.join(', ')
            }))
            .sort((a, b) => a.familia.localeCompare(b.familia, 'es', { sensitivity: 'base' }));
        
        const nombreInstitucion = systemConfig?.organization_name || 'Instituci√≥n Educativa';
        const fechaActual = new Date().toLocaleDateString('es-CO');
        const usuario = currentUser?.user_display_name || 'Usuario';
        const tituloDoc = tituloPersonalizado || `Lista de Familias - ${curso.course_name}`;
        
        const columnas = ['Familia', 'Hijos', ...columnasPersonalizadas];
        
        const headerCells = columnas.map(col => 
            new TableCell({
                children: [new Paragraph({
                    text: col,
                    alignment: AlignmentType.CENTER,
                    style: 'headerStyle'
                })],
                shading: { fill: '1380E2' },
                margins: { top: 100, bottom: 100, left: 100, right: 100 }
            })
        );
        
        const dataRows = familiasConHijos.map(fam => {
            const cells = [
                new TableCell({
                    children: [new Paragraph({ text: fam.familia })],
                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                }),
                new TableCell({
                    children: [new Paragraph({ text: fam.hijos })],
                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                })
            ];
            
            for (let i = 0; i < columnasPersonalizadas.length; i++) {
                cells.push(new TableCell({
                    children: [new Paragraph({ text: '' })],
                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                }));
            }
            
            return new TableRow({ children: cells });
        });
        
        const table = new Table({
            rows: [
                new TableRow({ children: headerCells, tableHeader: true }),
                ...dataRows
            ],
            width: { size: 100, type: WidthType.PERCENTAGE },
            borders: {
                top: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                bottom: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                left: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                right: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                insideVertical: { style: BorderStyle.SINGLE, size: 1, color: '000000' }
            }
        });
        
        const doc = new Document({
            sections: [{
                properties: {},
                children: [
                    new Paragraph({
                        text: nombreInstitucion,
                        heading: 'Heading1',
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 200 }
                    }),
                    new Paragraph({
                        text: tituloDoc,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 100 }
                    }),
                    new Paragraph({
                        text: `Generado por: ${usuario} | Fecha: ${fechaActual}`,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 400 }
                    }),
                    table,
                    new Paragraph({
                        text: `Total de familias: ${familiasConHijos.length}`,
                        spacing: { before: 400 }
                    })
                ]
            }]
        });
        
        const blob = await Packer.toBlob(doc);
        const nombreBase = tituloPersonalizado 
            ? tituloPersonalizado.replace(/\s+/g, '_')
            : `Lista_Familias_${curso.course_name.replace(/\s+/g, '_')}`;
        const nombreArchivo = `${nombreBase}_${Date.now()}.docx`;
        
        descargarBlob(blob, nombreArchivo);
        console.log(`‚úÖ DOCX generado: ${nombreArchivo}`);
        
    } catch (error) {
        console.error('‚ùå Error generando DOCX de familias por curso:', error);
        throw error;
    }
}

/**
 * Genera documento Word para lista de trabajadores
 */

async function generarDOCXTrabajadores(trabajadores, opciones, divisionId, divisionNombre, filtros) {
    try {
        const { Document, Packer, Paragraph, Table, TableCell, TableRow, WidthType, AlignmentType, BorderStyle, TextRun } = docx;
        
        const nombreInstitucion = systemConfig?.organization_name || 'Instituci√≥n Educativa';
        const fechaActual = new Date().toLocaleDateString('es-CO');
        const usuario = currentUser?.user_display_name || 'Usuario';
        
        // Determinar t√≠tulo del documento
        let tituloDoc = opciones.tituloPersonalizado || 'Lista de Trabajadores';
        
        // Si hay divisi√≥n, agregar al t√≠tulo
        if (divisionNombre) {
            tituloDoc += ` - ${divisionNombre}`;
        }
        
        // Si hay un centro de costo espec√≠fico seleccionado, agregarlo
        if (filtros.centrosCostos.length === 1) {
            const centroCosto = centrosCostosData.find(cc => cc.cost_center_id === filtros.centrosCostos[0]);
            if (centroCosto) {
                tituloDoc += ` - ${centroCosto.cost_center_name}`;
            }
        }
        
        // Elementos del documento
        const docElements = [];
        
        // Encabezado principal
        docElements.push(
            new Paragraph({
                text: nombreInstitucion,
                heading: 'Heading1',
                alignment: AlignmentType.CENTER,
                spacing: { after: 200 }
            }),
            new Paragraph({
                text: tituloDoc,
                alignment: AlignmentType.CENTER,
                spacing: { after: 100 }
            }),
            new Paragraph({
                text: `Generado por: ${usuario} | Fecha: ${fechaActual}`,
                alignment: AlignmentType.CENTER,
                spacing: { after: 400 }
            })
        );
        
        // Determinar si se debe dividir por centros de costo
        const dividirPorCentroCosto = divisionId && filtros.centrosCostos.length === 0;
        
        if (dividirPorCentroCosto) {
            // MODO: Divisi√≥n por centros de costo
            
            // Obtener todos los centros de costo de la divisi√≥n
            const centrosCostosDivision = await supabaseRequest(
                `/cost_centers?select=cost_center_id,cost_center_name&division_id=eq.${divisionId}&cost_center_status=eq.active&order=cost_center_name.asc`
            );
            
            // Agrupar trabajadores por centro de costo
            const trabajadoresPorCentro = {};
            const trabajadoresSinCentro = [];
            
            trabajadores.forEach(trab => {
                if (trab.organizational_cost_center_id) {
                    if (!trabajadoresPorCentro[trab.organizational_cost_center_id]) {
                        trabajadoresPorCentro[trab.organizational_cost_center_id] = [];
                    }
                    trabajadoresPorCentro[trab.organizational_cost_center_id].push(trab);
                } else {
                    trabajadoresSinCentro.push(trab);
                }
            });
            
            // Preparar encabezados de tabla
            const columnas = [];
            if (opciones.conNumeracion) columnas.push('#');
            if (opciones.conDocumento) columnas.push('Documento');
            columnas.push('Nombre Completo');
            columnas.push(...opciones.columnasPersonalizadas);
            
            // Generar secciones por centro de costo (orden alfab√©tico)
            for (const centro of centrosCostosDivision) {
                const trabajadoresCentro = trabajadoresPorCentro[centro.cost_center_id] || [];
                
                if (trabajadoresCentro.length === 0) continue;
                
                // Encabezado de secci√≥n
                docElements.push(
                    new Paragraph({
                        children: [
                            new TextRun({
                                text: `Centro de Costo: ${centro.cost_center_name}`,
                                bold: true,
                                size: 24,
                                color: '1380E2'
                            })
                        ],
                        spacing: { before: 400, after: 200 }
                    })
                );
                
                // Crear encabezados de tabla
                const headerCells = columnas.map(col => 
                    new TableCell({
                        children: [new Paragraph({
                            text: col,
                            alignment: AlignmentType.CENTER,
                            style: 'headerStyle'
                        })],
                        shading: { fill: '1380E2' },
                        margins: { top: 100, bottom: 100, left: 100, right: 100 }
                    })
                );
                
                // Crear filas de datos
                const dataRows = trabajadoresCentro.map((trab, idx) => {
                    const cells = [];
                    
                    if (opciones.conNumeracion) {
                        cells.push(new TableCell({
                            children: [new Paragraph({ text: (idx + 1).toString(), alignment: AlignmentType.CENTER })],
                            margins: { top: 100, bottom: 100, left: 100, right: 100 }
                        }));
                    }
                    
                    if (opciones.conDocumento) {
                        cells.push(new TableCell({
                            children: [new Paragraph({ text: trab.worker_id_doc || '', alignment: AlignmentType.CENTER })],
                            margins: { top: 100, bottom: 100, left: 100, right: 100 }
                        }));
                    }
                    
                    cells.push(new TableCell({
                        children: [new Paragraph({ text: trab.nombreCompleto })],
                        margins: { top: 100, bottom: 100, left: 100, right: 100 }
                    }));
                    
                    for (let i = 0; i < opciones.columnasPersonalizadas.length; i++) {
                        cells.push(new TableCell({
                            children: [new Paragraph({ text: '' })],
                            margins: { top: 100, bottom: 100, left: 100, right: 100 }
                        }));
                    }
                    
                    return new TableRow({ children: cells });
                });
                
                // Crear tabla
                const table = new Table({
                    rows: [
                        new TableRow({ children: headerCells, tableHeader: true }),
                        ...dataRows
                    ],
                    width: { size: 100, type: WidthType.PERCENTAGE },
                    borders: {
                        top: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                        bottom: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                        left: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                        right: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                        insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                        insideVertical: { style: BorderStyle.SINGLE, size: 1, color: '000000' }
                    }
                });
                
                docElements.push(table);
                
                // Total de trabajadores de este centro
                docElements.push(
                    new Paragraph({
                        text: `Total: ${trabajadoresCentro.length} trabajadores`,
                        spacing: { before: 200, after: 200 }
                    })
                );
            }
            
            // Trabajadores sin centro de costo al final
            if (trabajadoresSinCentro.length > 0) {
                docElements.push(
                    new Paragraph({
                        children: [
                            new TextRun({
                                text: 'Sin Centro de Costo',
                                bold: true,
                                size: 24,
                                color: '1380E2'
                            })
                        ],
                        spacing: { before: 400, after: 200 }
                    })
                );
                
                const headerCells = columnas.map(col => 
                    new TableCell({
                        children: [new Paragraph({
                            text: col,
                            alignment: AlignmentType.CENTER,
                            style: 'headerStyle'
                        })],
                        shading: { fill: '1380E2' },
                        margins: { top: 100, bottom: 100, left: 100, right: 100 }
                    })
                );
                
                const dataRows = trabajadoresSinCentro.map((trab, idx) => {
                    const cells = [];
                    
                    if (opciones.conNumeracion) {
                        cells.push(new TableCell({
                            children: [new Paragraph({ text: (idx + 1).toString(), alignment: AlignmentType.CENTER })],
                            margins: { top: 100, bottom: 100, left: 100, right: 100 }
                        }));
                    }
                    
                    if (opciones.conDocumento) {
                        cells.push(new TableCell({
                            children: [new Paragraph({ text: trab.worker_id_doc || '', alignment: AlignmentType.CENTER })],
                            margins: { top: 100, bottom: 100, left: 100, right: 100 }
                        }));
                    }
                    
                    cells.push(new TableCell({
                        children: [new Paragraph({ text: trab.nombreCompleto })],
                        margins: { top: 100, bottom: 100, left: 100, right: 100 }
                    }));
                    
                    for (let i = 0; i < opciones.columnasPersonalizadas.length; i++) {
                        cells.push(new TableCell({
                            children: [new Paragraph({ text: '' })],
                            margins: { top: 100, bottom: 100, left: 100, right: 100 }
                        }));
                    }
                    
                    return new TableRow({ children: cells });
                });
                
                const table = new Table({
                    rows: [
                        new TableRow({ children: headerCells, tableHeader: true }),
                        ...dataRows
                    ],
                    width: { size: 100, type: WidthType.PERCENTAGE },
                    borders: {
                        top: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                        bottom: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                        left: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                        right: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                        insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                        insideVertical: { style: BorderStyle.SINGLE, size: 1, color: '000000' }
                    }
                });
                
                docElements.push(table);
                
                docElements.push(
                    new Paragraph({
                        text: `Total: ${trabajadoresSinCentro.length} trabajadores`,
                        spacing: { before: 200, after: 200 }
                    })
                );
            }
            
            // Total general
            docElements.push(
                new Paragraph({
                    children: [
                        new TextRun({
                            text: `TOTAL GENERAL: ${trabajadores.length} trabajadores`,
                            bold: true
                        })
                    ],
                    spacing: { before: 400 }
                })
            );
            
        } else {
            // MODO: Lista √∫nica (sin divisi√≥n o con centro espec√≠fico)
            
            const columnas = [];
            if (opciones.conNumeracion) columnas.push('#');
            if (opciones.conDocumento) columnas.push('Documento');
            columnas.push('Nombre Completo');
            columnas.push(...opciones.columnasPersonalizadas);
            
            const headerCells = columnas.map(col => 
                new TableCell({
                    children: [new Paragraph({
                        text: col,
                        alignment: AlignmentType.CENTER,
                        style: 'headerStyle'
                    })],
                    shading: { fill: '1380E2' },
                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                })
            );
            
            const dataRows = trabajadores.map((trab, idx) => {
                const cells = [];
                
                if (opciones.conNumeracion) {
                    cells.push(new TableCell({
                        children: [new Paragraph({ text: (idx + 1).toString(), alignment: AlignmentType.CENTER })],
                        margins: { top: 100, bottom: 100, left: 100, right: 100 }
                    }));
                }
                
                if (opciones.conDocumento) {
                    cells.push(new TableCell({
                        children: [new Paragraph({ text: trab.worker_id_doc || '', alignment: AlignmentType.CENTER })],
                        margins: { top: 100, bottom: 100, left: 100, right: 100 }
                    }));
                }
                
                cells.push(new TableCell({
                    children: [new Paragraph({ text: trab.nombreCompleto })],
                    margins: { top: 100, bottom: 100, left: 100, right: 100 }
                }));
                
                for (let i = 0; i < opciones.columnasPersonalizadas.length; i++) {
                    cells.push(new TableCell({
                        children: [new Paragraph({ text: '' })],
                        margins: { top: 100, bottom: 100, left: 100, right: 100 }
                    }));
                }
                
                return new TableRow({ children: cells });
            });
            
            const table = new Table({
                rows: [
                    new TableRow({ children: headerCells, tableHeader: true }),
                    ...dataRows
                ],
                width: { size: 100, type: WidthType.PERCENTAGE },
                borders: {
                    top: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                    bottom: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                    left: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                    right: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                    insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: '000000' },
                    insideVertical: { style: BorderStyle.SINGLE, size: 1, color: '000000' }
                }
            });
            
            docElements.push(table);
            
            docElements.push(
                new Paragraph({
                    text: `Total de trabajadores: ${trabajadores.length}`,
                    spacing: { before: 400 }
                })
            );
        }
        
        // Crear documento
        const doc = new Document({
            sections: [{
                properties: {},
                children: docElements
            }]
        });
        
        const blob = await Packer.toBlob(doc);
        const nombreBase = opciones.tituloPersonalizado 
            ? opciones.tituloPersonalizado.replace(/\s+/g, '_')
            : 'Lista_Trabajadores';
        const nombreArchivo = `${nombreBase}_${Date.now()}.docx`;
        
        descargarBlob(blob, nombreArchivo);
        console.log(`‚úÖ DOCX generado: ${nombreArchivo}`);
        
    } catch (error) {
        console.error('‚ùå Error generando DOCX de trabajadores:', error);
        throw error;
    }
}
    
/**
 * Funci√≥n auxiliar para descargar blobs
 */
function descargarBlob(blob, nombreArchivo) {
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = nombreArchivo;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}
</script>
