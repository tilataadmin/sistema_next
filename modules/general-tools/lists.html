<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listas - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Estilos generales */
        :root {
            --primary-color: #6c757d;
            --secondary-color: #5a6268;
            --light-color: #e9ecef;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .nav-tabs .nav-link {
            color: var(--primary-color);
            font-weight: 500;
        }

        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-generate {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 10px 30px;
            border: none;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .btn-generate:hover {
            background-color: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .form-check-label {
            font-weight: 500;
        }

        .filter-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .column-input-group {
            margin-bottom: 15px;
            padding: 15px;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .badge-custom {
            background-color: var(--light-color);
            color: var(--primary-color);
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }

        .spinner-border-custom {
            width: 3rem;
            height: 3rem;
            border-width: 0.3rem;
            color: var(--primary-color);
        }

        select[multiple] {
            min-height: 150px;
        }

        .help-text {
            font-size: 0.875rem;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner-border spinner-border-custom mb-3" role="status"></div>
            <h5 id="loadingMessage">Generando PDF...</h5>
            <p class="text-muted mb-0">Por favor espere</p>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Listas</li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3 mb-2">
                    <i class="bi bi-list-ul me-2" style="color: var(--primary-color);"></i>
                    Generador de Listas
                </h1>
                <p class="text-muted">Genera listas personalizadas de estudiantes, familias y trabajadores en formato PDF</p>
            </div>
        </div>

        <!-- Contenedor de Alertas -->
        <div id="alertContainer"></div>

        <!-- Tarjeta Principal con Pestañas -->
        <div class="card shadow-sm">
            <div class="card-header">
                <i class="bi bi-gear-fill me-2"></i>Configuración de Listas
            </div>
            <div class="card-body">
                
                <!-- Pestañas -->
                <ul class="nav nav-tabs mb-4" id="listTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="estudiantes-tab" data-bs-toggle="tab" 
                                data-bs-target="#estudiantes" type="button" role="tab">
                            <i class="bi bi-mortarboard-fill me-2"></i>Estudiantes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="familias-tab" data-bs-toggle="tab" 
                                data-bs-target="#familias" type="button" role="tab">
                            <i class="bi bi-people-fill me-2"></i>Familias
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="trabajadores-tab" data-bs-toggle="tab" 
                                data-bs-target="#trabajadores" type="button" role="tab">
                            <i class="bi bi-person-badge-fill me-2"></i>Trabajadores
                        </button>
                    </li>
                </ul>

                <!-- Contenido de Pestañas -->
                <div class="tab-content" id="listTabsContent">
                    
                    <!-- PESTAÑA 1: ESTUDIANTES -->
                    <div class="tab-pane fade show active" id="estudiantes" role="tabpanel">
                        <h5 class="mb-3"><i class="bi bi-mortarboard me-2"></i>Lista de Estudiantes por Curso</h5>
                        <p class="text-muted">Genera listas de estudiantes activos ordenados alfabéticamente</p>

                        <div class="row">
                            <div class="col-md-6">
                                <!-- Selección de Cursos -->
                                <div class="mb-3">
                                    <label for="selectCursosEstudiantes" class="form-label">
                                        <i class="bi bi-book me-1"></i>Seleccionar Cursos <span class="text-danger">*</span>
                                    </label>
                                    <select id="selectCursosEstudiantes" class="form-select" multiple size="8">
                                        <option value="" disabled>Cargando cursos...</option>
                                    </select>
                                    <div class="help-text mt-1">
                                        <i class="bi bi-info-circle me-1"></i>Mantén presionado Ctrl (Cmd en Mac) para seleccionar múltiples cursos
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <!-- Opciones de Columnas -->
                                <div class="filter-section">
                                    <div class="filter-title">
                                        <i class="bi bi-sliders me-2"></i>Opciones de Columnas
                                    </div>

                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkNumeracionEst">
                                        <label class="form-check-label" for="checkNumeracionEst">
                                            Con numeración (1, 2, 3...)
                                        </label>
                                    </div>

                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkCodigoEst">
                                        <label class="form-check-label" for="checkCodigoEst">
                                            Con código de estudiante
                                        </label>
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="checkFirmasEst">
                                        <label class="form-check-label" for="checkFirmasEst">
                                            Con firmas de familias
                                        </label>
                                    </div>

                                    <!-- Contenedor de columnas personalizadas -->
                                    <div id="columnasPersonalizadasEst" style="display: none;">
                                        <hr>
                                        <label class="form-label fw-bold">Columnas Personalizadas</label>
                                        
                                        <div class="mb-3">
                                            <label for="numColumnasEst" class="form-label">
                                                Número de columnas (máximo 6)
                                            </label>
                                            <input type="number" class="form-control" id="numColumnasEst" 
                                                   min="1" max="6" value="1">
                                        </div>

                                        <div id="encabezadosColumnasEst">
                                            <!-- Se generarán dinámicamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-generate" onclick="generarListaEstudiantes()">
                                <i class="bi bi-file-pdf me-2"></i>Generar PDF
                            </button>
                        </div>
                    </div>

                    <!-- PESTAÑA 2: FAMILIAS -->
                    <div class="tab-pane fade" id="familias" role="tabpanel">
                        <h5 class="mb-3"><i class="bi bi-people me-2"></i>Listas de Familias</h5>
                        <p class="text-muted">Genera listas de familias activas con sus hijos</p>

                        <!-- Selector de tipo de lista -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Tipo de Lista</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoListaFam" 
                                       id="radioFamGeneral" value="general" checked>
                                <label class="form-check-label" for="radioFamGeneral">
                                    <strong>Listado General</strong> - Todas las familias en un solo PDF
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoListaFam" 
                                       id="radioFamCurso" value="curso">
                                <label class="form-check-label" for="radioFamCurso">
                                    <strong>Listado por Cursos</strong> - Un PDF por cada curso seleccionado
                                </label>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <!-- Selección de Cursos (solo visible para listado por cursos) -->
                                <div id="selectorCursosFam" style="display: none;">
                                    <div class="mb-3">
                                        <label for="selectCursosFamilias" class="form-label">
                                            <i class="bi bi-book me-1"></i>Seleccionar Cursos <span class="text-danger">*</span>
                                        </label>
                                        <select id="selectCursosFamilias" class="form-select" multiple size="8">
                                            <option value="" disabled>Cargando cursos...</option>
                                        </select>
                                        <div class="help-text mt-1">
                                            <i class="bi bi-info-circle me-1"></i>Mantén presionado Ctrl (Cmd en Mac) para seleccionar múltiples
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <!-- Columnas Personalizadas -->
                                <div class="filter-section">
                                    <div class="filter-title">
                                        <i class="bi bi-sliders me-2"></i>Columnas Personalizadas
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="numColumnasFam" class="form-label">
                                            Número de columnas adicionales (máximo 6)
                                        </label>
                                        <input type="number" class="form-control" id="numColumnasFam" 
                                               min="1" max="6" value="1">
                                    </div>

                                    <div id="encabezadosColumnasFam">
                                        <!-- Se generarán dinámicamente -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-generate" onclick="generarListaFamilias()">
                                <i class="bi bi-file-pdf me-2"></i>Generar PDF
                            </button>
                        </div>
                    </div>

                    <!-- PESTAÑA 3: TRABAJADORES -->
                    <div class="tab-pane fade" id="trabajadores" role="tabpanel">
                        <h5 class="mb-3"><i class="bi bi-person-badge me-2"></i>Lista de Trabajadores</h5>
                        <p class="text-muted">Genera listas de trabajadores activos con filtros avanzados</p>

                        <div class="row">
                            <!-- Columna Izquierda: Opciones y Filtros -->
                            <div class="col-md-6">
                                <!-- Opciones de Columnas -->
                                <div class="filter-section mb-3">
                                    <div class="filter-title">
                                        <i class="bi bi-sliders me-2"></i>Opciones de Columnas
                                    </div>

                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkNumeracionTrab">
                                        <label class="form-check-label" for="checkNumeracionTrab">
                                            Con numeración (1, 2, 3...)
                                        </label>
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="checkDocumentoTrab">
                                        <label class="form-check-label" for="checkDocumentoTrab">
                                            Con documento de identidad
                                        </label>
                                    </div>
                                </div>

                                <!-- Filtros -->
                                <div class="filter-section">
                                    <div class="filter-title">
                                        <i class="bi bi-funnel me-2"></i>Filtros (Opcionales)
                                    </div>

                                    <div class="mb-3">
                                        <label for="selectGenero" class="form-label">Género</label>
                                        <select id="selectGenero" class="form-select" multiple size="3">
                                            <option value="">Cargando...</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="selectCentroCosto" class="form-label">Centro de Costos</label>
                                        <select id="selectCentroCosto" class="form-select" multiple size="3">
                                            <option value="">Cargando...</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="selectArea" class="form-label">Área</label>
                                        <select id="selectArea" class="form-select" multiple size="3">
                                            <option value="">Seleccione centro de costos primero...</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="selectSubarea" class="form-label">Subárea</label>
                                        <select id="selectSubarea" class="form-select" multiple size="3">
                                            <option value="">Seleccione área primero...</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="selectRoles" class="form-label">Roles</label>
                                        <select id="selectRoles" class="form-select" multiple size="4">
                                            <option value="">Cargando...</option>
                                        </select>
                                    </div>

                                    <div class="help-text">
                                        <i class="bi bi-info-circle me-1"></i>Los filtros se combinan con lógica AND. 
                                        Deja vacío para no filtrar.
                                    </div>
                                </div>
                            </div>

                            <!-- Columna Derecha: Columnas Personalizadas -->
                            <div class="col-md-6">
                                <div class="filter-section">
                                    <div class="filter-title">
                                        <i class="bi bi-sliders me-2"></i>Columnas Personalizadas
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="numColumnasTrab" class="form-label">
                                            Número de columnas adicionales (máximo 6)
                                        </label>
                                        <input type="number" class="form-control" id="numColumnasTrab" 
                                               min="1" max="6" value="1">
                                    </div>

                                    <div id="encabezadosColumnasTrab">
                                        <!-- Se generarán dinámicamente -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-generate" onclick="generarListaTrabajadores()">
                                <i class="bi bi-file-pdf me-2"></i>Generar PDF
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
// ==========================================
// VARIABLES GLOBALES
// ==========================================
let cursosData = [];
let generosData = [];
let centrosCostosData = [];
let areasData = [];
let subareasData = [];
let rolesData = [];
let systemConfig = null;
let currentUser = null;

// ==========================================
// INICIALIZACIÓN
// ==========================================
document.addEventListener('DOMContentLoaded', async function() {
    console.log('🔐 Iniciando validación de acceso...');
    
    try {
        // Validar permisos
        const hasAccess = await validatePageAccess('Listas');
        if (!hasAccess) {
            console.log('❌ Acceso denegado');
            return;
        }
        
        console.log('✅ Acceso permitido - Inicializando página');
        
        // Inicializar página
        await inicializarPagina();
        
    } catch (error) {
        console.error('❌ Error en validación de acceso:', error);
        showMessage('Error de validación de permisos', 'danger');
    }
});

// ==========================================
// FUNCIÓN DE INICIALIZACIÓN PRINCIPAL
// ==========================================
async function inicializarPagina() {
    try {
        mostrarLoading('Cargando configuración...');
        
        // Obtener sesión y configuración del sistema
        const session = getStoredSession();
        if (session && session.user) {
            currentUser = session.user;
        }
        
        // Cargar configuración del sistema (logo)
        await cargarConfiguracionSistema();
        
        // Configurar event listeners
        configurarEventListeners();
        
        // Cargar datos iniciales
        await cargarDatosIniciales();
        
        ocultarLoading();
        console.log('✅ Página inicializada correctamente');
        
    } catch (error) {
        console.error('❌ Error inicializando página:', error);
        showMessage('Error al cargar la página: ' + error.message, 'danger');
        ocultarLoading();
    }
}

// ==========================================
// CARGAR CONFIGURACIÓN DEL SISTEMA
// ==========================================
async function cargarConfiguracionSistema() {
    try {
        // ✅ CORRECCIÓN: system_config en lugar de systems_config
        const config = await supabaseRequest('/system_config?select=*&limit=1');
        if (config && config.length > 0) {
            systemConfig = config[0];
            console.log('✅ Configuración del sistema cargada');
        }
    } catch (error) {
        console.error('❌ Error cargando configuración:', error);
    }
}

// ==========================================
// CONFIGURAR EVENT LISTENERS
// ==========================================
function configurarEventListeners() {
    // Pestaña Estudiantes
    document.getElementById('checkFirmasEst').addEventListener('change', function() {
        const columnasDiv = document.getElementById('columnasPersonalizadasEst');
        columnasDiv.style.display = this.checked ? 'none' : 'block';
        if (!this.checked) {
            generarCamposColumnasPersonalizadas('Est');
        }
    });
    
    document.getElementById('numColumnasEst').addEventListener('change', function() {
        generarCamposColumnasPersonalizadas('Est');
    });
    
    // Pestaña Familias
    document.querySelectorAll('input[name="tipoListaFam"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const selectorCursos = document.getElementById('selectorCursosFam');
            selectorCursos.style.display = this.value === 'curso' ? 'block' : 'none';
        });
    });
    
    document.getElementById('numColumnasFam').addEventListener('change', function() {
        generarCamposColumnasPersonalizadas('Fam');
    });
    
    // Pestaña Trabajadores
    document.getElementById('numColumnasTrab').addEventListener('change', function() {
        generarCamposColumnasPersonalizadas('Trab');
    });
    
    // Filtros en cascada para trabajadores
    document.getElementById('selectCentroCosto').addEventListener('change', function() {
        cargarAreas();
    });
    
    document.getElementById('selectArea').addEventListener('change', function() {
        cargarSubareas();
    });
    
    console.log('✅ Event listeners configurados');
}

// ==========================================
// CARGAR DATOS INICIALES
// ==========================================
async function cargarDatosIniciales() {
    try {
        console.log('📡 Cargando datos iniciales...');
        
        // Cargar cursos para estudiantes y familias
        await cargarCursos();
        
        // Cargar géneros para trabajadores
        await cargarGeneros();
        
        // Cargar centros de costos
        await cargarCentrosCostos();
        
        // Cargar roles para trabajadores
        await cargarRoles();
        
        // Generar campos iniciales de columnas personalizadas
        generarCamposColumnasPersonalizadas('Est');
        generarCamposColumnasPersonalizadas('Fam');
        generarCamposColumnasPersonalizadas('Trab');
        
        console.log('✅ Datos iniciales cargados');
        
    } catch (error) {
        console.error('❌ Error cargando datos iniciales:', error);
        showMessage('Error al cargar datos iniciales: ' + error.message, 'danger');
    }
}

// ==========================================
// CARGAR CURSOS
// ==========================================
async function cargarCursos() {
    try {
        cursosData = await supabaseRequest('/courses?select=course_id,course_name,course_order&order=course_order.asc');
        
        // Llenar select de estudiantes
        const selectEst = document.getElementById('selectCursosEstudiantes');
        selectEst.innerHTML = '';
        
        cursosData.forEach(curso => {
            const option = document.createElement('option');
            option.value = curso.course_id;
            option.textContent = curso.course_name;
            selectEst.appendChild(option);
        });
        
        // Llenar select de familias
        const selectFam = document.getElementById('selectCursosFamilias');
        selectFam.innerHTML = '';
        
        cursosData.forEach(curso => {
            const option = document.createElement('option');
            option.value = curso.course_id;
            option.textContent = curso.course_name;
            selectFam.appendChild(option);
        });
        
        console.log(`✅ ${cursosData.length} cursos cargados`);
        
    } catch (error) {
        console.error('❌ Error cargando cursos:', error);
        throw error;
    }
}

// ==========================================
// CARGAR GÉNEROS
// ==========================================
async function cargarGeneros() {
    try {
        generosData = await supabaseRequest('/genders?select=gender_id,gender_name&order=gender_name.asc');
        
        const select = document.getElementById('selectGenero');
        select.innerHTML = '';
        
        generosData.forEach(genero => {
            const option = document.createElement('option');
            option.value = genero.gender_id;
            option.textContent = genero.gender_name;
            select.appendChild(option);
        });
        
        console.log(`✅ ${generosData.length} géneros cargados`);
        
    } catch (error) {
        console.error('❌ Error cargando géneros:', error);
    }
}

// ==========================================
// CARGAR CENTROS DE COSTOS
// ==========================================
async function cargarCentrosCostos() {
    try {
        centrosCostosData = await supabaseRequest('/cost_centers?select=cost_center_id,cost_center_name&order=cost_center_name.asc');
        
        const select = document.getElementById('selectCentroCosto');
        select.innerHTML = '<option value="">-- Todos --</option>';
        
        centrosCostosData.forEach(cc => {
            const option = document.createElement('option');
            option.value = cc.cost_center_id;
            option.textContent = cc.cost_center_name;
            select.appendChild(option);
        });
        
        console.log(`✅ ${centrosCostosData.length} centros de costos cargados`);
        
    } catch (error) {
        console.error('❌ Error cargando centros de costos:', error);
    }
}

// ==========================================
// CARGAR ÁREAS (FILTRADO POR CENTRO DE COSTOS)
// ==========================================
async function cargarAreas() {
    try {
        const centrosSeleccionados = Array.from(document.getElementById('selectCentroCosto').selectedOptions)
            .map(option => option.value)
            .filter(v => v);
        
        const select = document.getElementById('selectArea');
        select.innerHTML = '<option value="">-- Todos --</option>';
        
        if (centrosSeleccionados.length === 0) {
            select.innerHTML = '<option value="">Seleccione centro de costos primero...</option>';
            return;
        }
        
        const filter = centrosSeleccionados.map(id => `cost_center_id.eq.${id}`).join(',');
        areasData = await supabaseRequest(`/areas?select=area_id,area_name,cost_center_id&or=(${filter})&order=area_name.asc`);
        
        areasData.forEach(area => {
            const option = document.createElement('option');
            option.value = area.area_id;
            option.textContent = area.area_name;
            select.appendChild(option);
        });
        
        // Limpiar selección dependiente
        document.getElementById('selectSubarea').innerHTML = '<option value="">Seleccione área primero...</option>';
        
    } catch (error) {
        console.error('❌ Error cargando áreas:', error);
    }
}

// ==========================================
// CARGAR SUBÁREAS (FILTRADO POR ÁREAS)
// ==========================================
async function cargarSubareas() {
    try {
        const areasSeleccionadas = Array.from(document.getElementById('selectArea').selectedOptions)
            .map(option => option.value)
            .filter(v => v);
        
        const select = document.getElementById('selectSubarea');
        select.innerHTML = '<option value="">-- Todos --</option>';
        
        if (areasSeleccionadas.length === 0) {
            select.innerHTML = '<option value="">Seleccione área primero...</option>';
            return;
        }
        
        const filter = areasSeleccionadas.map(id => `area_id.eq.${id}`).join(',');
        subareasData = await supabaseRequest(`/subareas?select=subarea_id,subarea_name,area_id&or=(${filter})&order=subarea_name.asc`);
        
        subareasData.forEach(subarea => {
            const option = document.createElement('option');
            option.value = subarea.subarea_id;
            option.textContent = subarea.subarea_name;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('❌ Error cargando subáreas:', error);
    }
}

// ==========================================
// CARGAR ROLES
// ==========================================
async function cargarRoles() {
    try {
        rolesData = await supabaseRequest('/job_roles?select=role_id,role_name&order=role_name.asc');
        
        const select = document.getElementById('selectRoles');
        select.innerHTML = '';
        
        rolesData.forEach(rol => {
            const option = document.createElement('option');
            option.value = rol.role_id;
            option.textContent = rol.role_name;
            select.appendChild(option);
        });
        
        console.log(`✅ ${rolesData.length} roles cargados`);
        
    } catch (error) {
        console.error('❌ Error cargando roles:', error);
    }
}

// ==========================================
// GENERAR CAMPOS DE COLUMNAS PERSONALIZADAS
// ==========================================
function generarCamposColumnasPersonalizadas(tipo) {
    const numColumnas = parseInt(document.getElementById(`numColumnas${tipo}`).value) || 1;
    const container = document.getElementById(`encabezadosColumnas${tipo}`);
    
    container.innerHTML = '';
    
    for (let i = 1; i <= numColumnas; i++) {
        const div = document.createElement('div');
        div.className = 'column-input-group';
        div.innerHTML = `
            <label class="form-label fw-bold">Columna ${i}</label>
            <input type="text" class="form-control" id="colHeader${tipo}${i}" 
                   placeholder="Ej: Firma, Observaciones, Nota...">
        `;
        container.appendChild(div);
    }
}

// ==========================================
// GENERAR LISTA DE ESTUDIANTES
// ==========================================
async function generarListaEstudiantes() {
    try {
        const cursosSeleccionados = Array.from(document.getElementById('selectCursosEstudiantes').selectedOptions)
            .map(option => option.value);
        
        if (cursosSeleccionados.length === 0) {
            showMessage('Debe seleccionar al menos un curso', 'warning');
            return;
        }
        
        const opciones = {
            conNumeracion: document.getElementById('checkNumeracionEst').checked,
            conCodigo: document.getElementById('checkCodigoEst').checked,
            conFirmas: document.getElementById('checkFirmasEst').checked,
            columnasPersonalizadas: []
        };
        
        if (!opciones.conFirmas) {
            const numColumnas = parseInt(document.getElementById('numColumnasEst').value) || 0;
            for (let i = 1; i <= numColumnas; i++) {
                const header = document.getElementById(`colHeaderEst${i}`).value.trim();
                if (header) {
                    opciones.columnasPersonalizadas.push(header);
                }
            }
            
            if (opciones.columnasPersonalizadas.length === 0) {
                showMessage('Debe especificar al menos un encabezado para las columnas personalizadas', 'warning');
                return;
            }
        }
        
        mostrarLoading('Generando PDFs de estudiantes...');
        
        // SIMULACIÓN - Aquí iría la llamada al backend
        console.log('📦 Datos para generar PDFs:', { cursosSeleccionados, opciones });
        
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        ocultarLoading();
        showMessage(`${cursosSeleccionados.length} PDF(s) generados exitosamente`, 'success');
        
    } catch (error) {
        console.error('❌ Error generando lista de estudiantes:', error);
        ocultarLoading();
        showMessage('Error al generar PDFs: ' + error.message, 'danger');
    }
}

// ==========================================
// GENERAR LISTA DE FAMILIAS
// ==========================================
async function generarListaFamilias() {
    try {
        const tipoLista = document.querySelector('input[name="tipoListaFam"]:checked').value;
        
        const numColumnas = parseInt(document.getElementById('numColumnasFam').value) || 0;
        const columnasPersonalizadas = [];
        
        for (let i = 1; i <= numColumnas; i++) {
            const header = document.getElementById(`colHeaderFam${i}`).value.trim();
            if (header) {
                columnasPersonalizadas.push(header);
            }
        }
        
        if (columnasPersonalizadas.length === 0) {
            showMessage('Debe especificar al menos un encabezado para las columnas personalizadas', 'warning');
            return;
        }
        
        if (tipoLista === 'curso') {
            const cursosSeleccionados = Array.from(document.getElementById('selectCursosFamilias').selectedOptions)
                .map(option => option.value);
            
            if (cursosSeleccionados.length === 0) {
                showMessage('Debe seleccionar al menos un curso', 'warning');
                return;
            }
        }
        
        mostrarLoading('Generando PDFs de familias...');
        
        // SIMULACIÓN - Aquí iría la llamada al backend
        console.log('📦 Datos para generar PDFs:', { tipoLista, columnasPersonalizadas });
        
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        ocultarLoading();
        showMessage('PDF(s) generados exitosamente', 'success');
        
    } catch (error) {
        console.error('❌ Error generando lista de familias:', error);
        ocultarLoading();
        showMessage('Error al generar PDFs: ' + error.message, 'danger');
    }
}

// ==========================================
// GENERAR LISTA DE TRABAJADORES
// ==========================================
async function generarListaTrabajadores() {
    try {
        const opciones = {
            conNumeracion: document.getElementById('checkNumeracionTrab').checked,
            conDocumento: document.getElementById('checkDocumentoTrab').checked,
            columnasPersonalizadas: []
        };
        
        const numColumnas = parseInt(document.getElementById('numColumnasTrab').value) || 0;
        for (let i = 1; i <= numColumnas; i++) {
            const header = document.getElementById(`colHeaderTrab${i}`).value.trim();
            if (header) {
                opciones.columnasPersonalizadas.push(header);
            }
        }
        
        if (opciones.columnasPersonalizadas.length === 0) {
            showMessage('Debe especificar al menos un encabezado para las columnas personalizadas', 'warning');
            return;
        }
        
        const filtros = {
            generos: Array.from(document.getElementById('selectGenero').selectedOptions)
                .map(o => o.value).filter(v => v),
            centrosCostos: Array.from(document.getElementById('selectCentroCosto').selectedOptions)
                .map(o => o.value).filter(v => v),
            areas: Array.from(document.getElementById('selectArea').selectedOptions)
                .map(o => o.value).filter(v => v),
            subareas: Array.from(document.getElementById('selectSubarea').selectedOptions)
                .map(o => o.value).filter(v => v),
            roles: Array.from(document.getElementById('selectRoles').selectedOptions)
                .map(o => o.value).filter(v => v)
        };
        
        mostrarLoading('Generando PDF de trabajadores...');
        
        // SIMULACIÓN - Aquí iría la llamada al backend
        console.log('📦 Datos para generar PDF:', { opciones, filtros });
        
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        ocultarLoading();
        showMessage('PDF generado exitosamente', 'success');
        
    } catch (error) {
        console.error('❌ Error generando lista de trabajadores:', error);
        ocultarLoading();
        showMessage('Error al generar PDF: ' + error.message, 'danger');
    }
}

// ==========================================
// UTILIDADES
// ==========================================
function mostrarLoading(mensaje = 'Cargando...') {
    document.getElementById('loadingMessage').textContent = mensaje;
    document.getElementById('loadingOverlay').classList.add('show');
}

function ocultarLoading() {
    document.getElementById('loadingOverlay').classList.remove('show');
}
    </script>
</body>
</html>
