<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listas - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- jsPDF para generar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Estilos generales */
        :root {
            --primary-color: #6c757d;
            --secondary-color: #5a6268;
            --light-color: #e9ecef;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .nav-tabs .nav-link {
            color: var(--primary-color);
            font-weight: 500;
        }

        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-generate {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 10px 30px;
            border: none;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .btn-generate:hover {
            background-color: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .form-check-label {
            font-weight: 500;
        }

        .filter-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .column-input-group {
            margin-bottom: 15px;
            padding: 15px;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .badge-custom {
            background-color: var(--light-color);
            color: var(--primary-color);
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }

        .spinner-border-custom {
            width: 3rem;
            height: 3rem;
            border-width: 0.3rem;
            color: var(--primary-color);
        }

        select[multiple] {
            min-height: 150px;
        }

        .help-text {
            font-size: 0.875rem;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner-border spinner-border-custom mb-3" role="status"></div>
            <h5 id="loadingMessage">Generando PDF...</h5>
            <p class="text-muted mb-0">Por favor espere</p>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Listas</li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3 mb-2">
                    <i class="bi bi-list-ul me-2" style="color: var(--primary-color);"></i>
                    Generador de Listas
                </h1>
                <p class="text-muted">Genera listas personalizadas de estudiantes, familias y trabajadores en formato PDF</p>
            </div>
        </div>

        <!-- Contenedor de Alertas -->
        <div id="alertContainer"></div>

        <!-- Tarjeta Principal con Pesta√±as -->
        <div class="card shadow-sm">
            <div class="card-header">
                <i class="bi bi-gear-fill me-2"></i>Configuraci√≥n de Listas
            </div>
            <div class="card-body">
                
                <!-- Pesta√±as -->
                <ul class="nav nav-tabs mb-4" id="listTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="estudiantes-tab" data-bs-toggle="tab" 
                                data-bs-target="#estudiantes" type="button" role="tab">
                            <i class="bi bi-mortarboard-fill me-2"></i>Estudiantes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="familias-tab" data-bs-toggle="tab" 
                                data-bs-target="#familias" type="button" role="tab">
                            <i class="bi bi-people-fill me-2"></i>Familias
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="trabajadores-tab" data-bs-toggle="tab" 
                                data-bs-target="#trabajadores" type="button" role="tab">
                            <i class="bi bi-person-badge-fill me-2"></i>Trabajadores
                        </button>
                    </li>
                </ul>

                <!-- Contenido de Pesta√±as -->
                <div class="tab-content" id="listTabsContent">
                    
                    <!-- PESTA√ëA 1: ESTUDIANTES -->
                    <div class="tab-pane fade show active" id="estudiantes" role="tabpanel">
                        <h5 class="mb-3"><i class="bi bi-mortarboard me-2"></i>Lista de Estudiantes por Curso</h5>
                        <p class="text-muted">Genera listas de estudiantes activos ordenados alfab√©ticamente</p>

                        <div class="row">
                            <div class="col-md-6">
                                <!-- Selecci√≥n de Cursos -->
                                <div class="mb-3">
                                    <label for="selectCursosEstudiantes" class="form-label">
                                        <i class="bi bi-book me-1"></i>Seleccionar Cursos <span class="text-danger">*</span>
                                    </label>
                                    <select id="selectCursosEstudiantes" class="form-select" multiple size="8">
                                        <option value="" disabled>Cargando cursos...</option>
                                    </select>
                                    <div class="help-text mt-1">
                                        <i class="bi bi-info-circle me-1"></i>Mant√©n presionado Ctrl (Cmd en Mac) para seleccionar m√∫ltiples cursos
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <!-- Opciones de Columnas -->
                                <div class="filter-section">
                                    <div class="filter-title">
                                        <i class="bi bi-sliders me-2"></i>Opciones de Columnas
                                    </div>

                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkNumeracionEst">
                                        <label class="form-check-label" for="checkNumeracionEst">
                                            Con numeraci√≥n (1, 2, 3...)
                                        </label>
                                    </div>

                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkCodigoEst">
                                        <label class="form-check-label" for="checkCodigoEst">
                                            Con c√≥digo de estudiante
                                        </label>
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="checkFirmasEst">
                                        <label class="form-check-label" for="checkFirmasEst">
                                            Con firmas de familias
                                        </label>
                                    </div>

                                    <!-- Contenedor de columnas personalizadas -->
                                    <div id="columnasPersonalizadasEst" style="display: none;">
                                        <hr>
                                        <label class="form-label fw-bold">Columnas Personalizadas</label>
                                        
                                        <div class="mb-3">
                                            <label for="numColumnasEst" class="form-label">
                                                N√∫mero de columnas (m√°ximo 6)
                                            </label>
                                            <input type="number" class="form-control" id="numColumnasEst" 
                                                   min="1" max="6" value="1">
                                        </div>

                                        <div id="encabezadosColumnasEst">
                                            <!-- Se generar√°n din√°micamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-generate" onclick="generarListaEstudiantes()">
                                <i class="bi bi-file-pdf me-2"></i>Generar PDF
                            </button>
                        </div>
                    </div>

                    <!-- PESTA√ëA 2: FAMILIAS -->
                    <div class="tab-pane fade" id="familias" role="tabpanel">
                        <h5 class="mb-3"><i class="bi bi-people me-2"></i>Listas de Familias</h5>
                        <p class="text-muted">Genera listas de familias activas con sus hijos</p>

                        <!-- Selector de tipo de lista -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Tipo de Lista</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoListaFam" 
                                       id="radioFamGeneral" value="general" checked>
                                <label class="form-check-label" for="radioFamGeneral">
                                    <strong>Listado General</strong> - Todas las familias en un solo PDF
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoListaFam" 
                                       id="radioFamCurso" value="curso">
                                <label class="form-check-label" for="radioFamCurso">
                                    <strong>Listado por Cursos</strong> - Un PDF por cada curso seleccionado
                                </label>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <!-- Selecci√≥n de Cursos (solo visible para listado por cursos) -->
                                <div id="selectorCursosFam" style="display: none;">
                                    <div class="mb-3">
                                        <label for="selectCursosFamilias" class="form-label">
                                            <i class="bi bi-book me-1"></i>Seleccionar Cursos <span class="text-danger">*</span>
                                        </label>
                                        <select id="selectCursosFamilias" class="form-select" multiple size="8">
                                            <option value="" disabled>Cargando cursos...</option>
                                        </select>
                                        <div class="help-text mt-1">
                                            <i class="bi bi-info-circle me-1"></i>Mant√©n presionado Ctrl (Cmd en Mac) para seleccionar m√∫ltiples
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <!-- Columnas Personalizadas -->
                                <div class="filter-section">
                                    <div class="filter-title">
                                        <i class="bi bi-sliders me-2"></i>Columnas Personalizadas
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="numColumnasFam" class="form-label">
                                            N√∫mero de columnas adicionales (m√°ximo 6)
                                        </label>
                                        <input type="number" class="form-control" id="numColumnasFam" 
                                               min="1" max="6" value="1">
                                    </div>

                                    <div id="encabezadosColumnasFam">
                                        <!-- Se generar√°n din√°micamente -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-generate" onclick="generarListaFamilias()">
                                <i class="bi bi-file-pdf me-2"></i>Generar PDF
                            </button>
                        </div>
                    </div>

                    <!-- PESTA√ëA 3: TRABAJADORES -->
                    <div class="tab-pane fade" id="trabajadores" role="tabpanel">
                        <h5 class="mb-3"><i class="bi bi-person-badge me-2"></i>Lista de Trabajadores</h5>
                        <p class="text-muted">Genera listas de trabajadores activos con filtros avanzados</p>

                        <div class="row">
                            <!-- Columna Izquierda: Opciones y Filtros -->
                            <div class="col-md-6">
                                <!-- Opciones de Columnas -->
                                <div class="filter-section mb-3">
                                    <div class="filter-title">
                                        <i class="bi bi-sliders me-2"></i>Opciones de Columnas
                                    </div>

                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="checkNumeracionTrab">
                                        <label class="form-check-label" for="checkNumeracionTrab">
                                            Con numeraci√≥n (1, 2, 3...)
                                        </label>
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="checkDocumentoTrab">
                                        <label class="form-check-label" for="checkDocumentoTrab">
                                            Con documento de identidad
                                        </label>
                                    </div>
                                </div>

                                <!-- Filtros -->
                                <div class="filter-section">
                                    <div class="filter-title">
                                        <i class="bi bi-funnel me-2"></i>Filtros (Opcionales)
                                    </div>

                                    <div class="mb-3">
                                        <label for="selectGenero" class="form-label">G√©nero</label>
                                        <select id="selectGenero" class="form-select" multiple size="3">
                                            <option value="">Cargando...</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="selectCentroCosto" class="form-label">Centro de Costos</label>
                                        <select id="selectCentroCosto" class="form-select" multiple size="3">
                                            <option value="">Cargando...</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="selectArea" class="form-label">√Årea</label>
                                        <select id="selectArea" class="form-select" multiple size="3">
                                            <option value="">Seleccione centro de costos primero...</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="selectSubarea" class="form-label">Sub√°rea</label>
                                        <select id="selectSubarea" class="form-select" multiple size="3">
                                            <option value="">Seleccione √°rea primero...</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="selectRoles" class="form-label">Roles</label>
                                        <select id="selectRoles" class="form-select" multiple size="4">
                                            <option value="">Cargando...</option>
                                        </select>
                                    </div>

                                    <div class="help-text">
                                        <i class="bi bi-info-circle me-1"></i>Los filtros se combinan con l√≥gica AND. 
                                        Deja vac√≠o para no filtrar.
                                    </div>
                                </div>
                            </div>

                            <!-- Columna Derecha: Columnas Personalizadas -->
                            <div class="col-md-6">
                                <div class="filter-section">
                                    <div class="filter-title">
                                        <i class="bi bi-sliders me-2"></i>Columnas Personalizadas
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="numColumnasTrab" class="form-label">
                                            N√∫mero de columnas adicionales (m√°ximo 6)
                                        </label>
                                        <input type="number" class="form-control" id="numColumnasTrab" 
                                               min="1" max="6" value="1">
                                    </div>

                                    <div id="encabezadosColumnasTrab">
                                        <!-- Se generar√°n din√°micamente -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-generate" onclick="generarListaTrabajadores()">
                                <i class="bi bi-file-pdf me-2"></i>Generar PDF
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <!-- AQU√ç VA EL JAVASCRIPT DE LA PARTE 2 -->
</body>
</html>
<script>
// ==========================================
// VARIABLES GLOBALES
// ==========================================
let cursosData = [];
let generosData = [];
let centrosCostosData = [];
let areasData = [];
let subareasData = [];
let rolesData = [];
let systemConfig = null;
let currentUser = null;

// ==========================================
// INICIALIZACI√ìN
// ==========================================
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üîê Iniciando validaci√≥n de acceso...');
    
    try {
        const hasAccess = await validatePageAccess('Listas');
        if (!hasAccess) {
            console.log('‚ùå Acceso denegado');
            return;
        }
        
        console.log('‚úÖ Acceso permitido - Inicializando p√°gina');
        await inicializarPagina();
        
    } catch (error) {
        console.error('‚ùå Error en validaci√≥n de acceso:', error);
        showMessage('Error de validaci√≥n de permisos', 'danger');
    }
});

async function inicializarPagina() {
    try {
        mostrarLoading('Cargando configuraci√≥n...');
        
        const session = getStoredSession();
        if (session && session.user) {
            currentUser = session.user;
        }
        
        await cargarConfiguracionSistema();
        configurarEventListeners();
        await cargarDatosIniciales();
        
        ocultarLoading();
        console.log('‚úÖ P√°gina inicializada correctamente');
        
    } catch (error) {
        console.error('‚ùå Error inicializando p√°gina:', error);
        showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
        ocultarLoading();
    }
}

async function cargarConfiguracionSistema() {
    try {
        const config = await supabaseRequest('/system_config?select=*&limit=1');
        if (config && config.length > 0) {
            systemConfig = config[0];
            console.log('‚úÖ Configuraci√≥n del sistema cargada');
        }
    } catch (error) {
        console.error('‚ùå Error cargando configuraci√≥n:', error);
    }
}

function configurarEventListeners() {
    // Estudiantes
    document.getElementById('checkFirmasEst').addEventListener('change', function() {
        const columnasDiv = document.getElementById('columnasPersonalizadasEst');
        if (this.checked) {
            columnasDiv.style.display = 'none';
        } else {
            columnasDiv.style.display = 'block';
            generarCamposColumnasPersonalizadas('Est');
        }
    });
    
    document.getElementById('numColumnasEst').addEventListener('change', function() {
        generarCamposColumnasPersonalizadas('Est');
    });
    
    // Familias
    document.querySelectorAll('input[name="tipoListaFam"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const selectorCursos = document.getElementById('selectorCursosFam');
            selectorCursos.style.display = this.value === 'curso' ? 'block' : 'none';
        });
    });
    
    document.getElementById('numColumnasFam').addEventListener('change', function() {
        generarCamposColumnasPersonalizadas('Fam');
    });
    
    // Trabajadores
    document.getElementById('numColumnasTrab').addEventListener('change', function() {
        generarCamposColumnasPersonalizadas('Trab');
    });
    
    document.getElementById('selectCentroCosto').addEventListener('change', function() {
        cargarAreas();
    });
    
    document.getElementById('selectArea').addEventListener('change', function() {
        cargarSubareas();
    });
    
    console.log('‚úÖ Event listeners configurados');
}

async function cargarDatosIniciales() {
    try {
        console.log('üì° Cargando datos iniciales...');
        
        await cargarCursos();
        await cargarGeneros();
        await cargarCentrosCostos();
        await cargarRoles();
        
        generarCamposColumnasPersonalizadas('Est');
        generarCamposColumnasPersonalizadas('Fam');
        generarCamposColumnasPersonalizadas('Trab');
        
        // Mostrar columnas personalizadas de Estudiantes por defecto
        document.getElementById('columnasPersonalizadasEst').style.display = 'block';
        
        console.log('‚úÖ Datos iniciales cargados');
        
    } catch (error) {
        console.error('‚ùå Error cargando datos iniciales:', error);
        showMessage('Error al cargar datos iniciales: ' + error.message, 'danger');
    }
}

async function cargarCursos() {
    try {
        cursosData = await supabaseRequest('/courses?select=course_id,course_name,course_order&order=course_order.asc');
        
        const selectEst = document.getElementById('selectCursosEstudiantes');
        selectEst.innerHTML = '';
        
        cursosData.forEach(curso => {
            const option = document.createElement('option');
            option.value = curso.course_id;
            option.textContent = curso.course_name;
            selectEst.appendChild(option);
        });
        
        const selectFam = document.getElementById('selectCursosFamilias');
        selectFam.innerHTML = '';
        
        cursosData.forEach(curso => {
            const option = document.createElement('option');
            option.value = curso.course_id;
            option.textContent = curso.course_name;
            selectFam.appendChild(option);
        });
        
        console.log(`‚úÖ ${cursosData.length} cursos cargados`);
        
    } catch (error) {
        console.error('‚ùå Error cargando cursos:', error);
        throw error;
    }
}

async function cargarGeneros() {
    try {
        generosData = await supabaseRequest('/genders?select=gender_id,gender_name&order=gender_name.asc');
        
        const select = document.getElementById('selectGenero');
        select.innerHTML = '';
        
        generosData.forEach(genero => {
            const option = document.createElement('option');
            option.value = genero.gender_id;
            option.textContent = genero.gender_name;
            select.appendChild(option);
        });
        
        console.log(`‚úÖ ${generosData.length} g√©neros cargados`);
        
    } catch (error) {
        console.error('‚ùå Error cargando g√©neros:', error);
    }
}

async function cargarCentrosCostos() {
    try {
        centrosCostosData = await supabaseRequest('/cost_centers?select=cost_center_id,cost_center_name&order=cost_center_name.asc');
        
        const select = document.getElementById('selectCentroCosto');
        select.innerHTML = '<option value="">-- Todos --</option>';
        
        centrosCostosData.forEach(cc => {
            const option = document.createElement('option');
            option.value = cc.cost_center_id;
            option.textContent = cc.cost_center_name;
            select.appendChild(option);
        });
        
        console.log(`‚úÖ ${centrosCostosData.length} centros de costos cargados`);
        
    } catch (error) {
        console.error('‚ùå Error cargando centros de costos:', error);
    }
}

async function cargarAreas() {
    try {
        const centrosSeleccionados = Array.from(document.getElementById('selectCentroCosto').selectedOptions)
            .map(option => option.value)
            .filter(v => v);
        
        const select = document.getElementById('selectArea');
        select.innerHTML = '<option value="">-- Todos --</option>';
        
        if (centrosSeleccionados.length === 0) {
            select.innerHTML = '<option value="">Seleccione centro de costos primero...</option>';
            return;
        }
        
        const filter = centrosSeleccionados.map(id => `cost_center_id.eq.${id}`).join(',');
        areasData = await supabaseRequest(`/areas?select=area_id,area_name,cost_center_id&or=(${filter})&order=area_name.asc`);
        
        areasData.forEach(area => {
            const option = document.createElement('option');
            option.value = area.area_id;
            option.textContent = area.area_name;
            select.appendChild(option);
        });
        
        document.getElementById('selectSubarea').innerHTML = '<option value="">Seleccione √°rea primero...</option>';
        
    } catch (error) {
        console.error('‚ùå Error cargando √°reas:', error);
    }
}

async function cargarSubareas() {
    try {
        const areasSeleccionadas = Array.from(document.getElementById('selectArea').selectedOptions)
            .map(option => option.value)
            .filter(v => v);
        
        const select = document.getElementById('selectSubarea');
        select.innerHTML = '<option value="">-- Todos --</option>';
        
        if (areasSeleccionadas.length === 0) {
            select.innerHTML = '<option value="">Seleccione √°rea primero...</option>';
            return;
        }
        
        const filter = areasSeleccionadas.map(id => `area_id.eq.${id}`).join(',');
        subareasData = await supabaseRequest(`/subareas?select=subarea_id,subarea_name,area_id&or=(${filter})&order=subarea_name.asc`);
        
        subareasData.forEach(subarea => {
            const option = document.createElement('option');
            option.value = subarea.subarea_id;
            option.textContent = subarea.subarea_name;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('‚ùå Error cargando sub√°reas:', error);
    }
}

async function cargarRoles() {
    try {
        rolesData = await supabaseRequest('/job_roles?select=role_id,role_name&order=role_name.asc');
        
        const select = document.getElementById('selectRoles');
        select.innerHTML = '';
        
        rolesData.forEach(rol => {
            const option = document.createElement('option');
            option.value = rol.role_id;
            option.textContent = rol.role_name;
            select.appendChild(option);
        });
        
        console.log(`‚úÖ ${rolesData.length} roles cargados`);
        
    } catch (error) {
        console.error('‚ùå Error cargando roles:', error);
    }
}

function generarCamposColumnasPersonalizadas(tipo) {
    const numColumnas = parseInt(document.getElementById(`numColumnas${tipo}`).value) || 1;
    const container = document.getElementById(`encabezadosColumnas${tipo}`);
    
    container.innerHTML = '';
    
    for (let i = 1; i <= numColumnas; i++) {
        const div = document.createElement('div');
        div.className = 'column-input-group';
        div.innerHTML = `
            <label class="form-label fw-bold">Columna ${i}</label>
            <input type="text" class="form-control" id="colHeader${tipo}${i}" 
                   placeholder="Ej: Firma, Observaciones, Nota...">
        `;
        container.appendChild(div);
    }
}

// ==========================================
// GENERAR LISTA DE ESTUDIANTES
// ==========================================
async function generarListaEstudiantes() {
    try {
        const cursosSeleccionados = Array.from(document.getElementById('selectCursosEstudiantes').selectedOptions)
            .map(option => option.value);
        
        if (cursosSeleccionados.length === 0) {
            showMessage('Debe seleccionar al menos un curso', 'warning');
            return;
        }
        
        const opciones = {
            conNumeracion: document.getElementById('checkNumeracionEst').checked,
            conCodigo: document.getElementById('checkCodigoEst').checked,
            conFirmas: document.getElementById('checkFirmasEst').checked,
            columnasPersonalizadas: []
        };
        
        if (!opciones.conFirmas) {
            const numColumnas = parseInt(document.getElementById('numColumnasEst').value) || 0;
            for (let i = 1; i <= numColumnas; i++) {
                const header = document.getElementById(`colHeaderEst${i}`).value.trim();
                if (header) {
                    opciones.columnasPersonalizadas.push(header);
                }
            }
            
            if (opciones.columnasPersonalizadas.length === 0) {
                showMessage('Debe especificar al menos un encabezado para las columnas personalizadas', 'warning');
                return;
            }
        }
        
        mostrarLoading('Generando PDFs de estudiantes...');
        
        for (const cursoId of cursosSeleccionados) {
            const curso = cursosData.find(c => c.course_id === cursoId);

            const estudiantes = await supabaseRequest(
                `/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2,student_status!inner(status_description)&course_id=eq.${cursoId}&student_status.status_description=eq.Activo&order=student_last_name_1.asc,student_last_name_2.asc,student_first_name.asc`
            );
            
            // Ya vienen filtrados por Activo desde la query
            const estudiantesActivos = estudiantes;
             
            if (estudiantesActivos.length === 0) {
                console.warn(`‚ö†Ô∏è No hay estudiantes activos en ${curso.course_name}`);
                continue;
            }
            
            await generarPDFEstudiantes(curso, estudiantesActivos, opciones);
        }
        
        ocultarLoading();
        showMessage(`${cursosSeleccionados.length} PDF(s) generados exitosamente`, 'success');
        
    } catch (error) {
        console.error('‚ùå Error generando lista de estudiantes:', error);
        ocultarLoading();
        showMessage('Error al generar PDFs: ' + error.message, 'danger');
    }
}

async function generarPDFEstudiantes(curso, estudiantes, opciones) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'letter');
    
    const nombreInstitucion = systemConfig?.organization_name || 'Instituci√≥n Educativa';
    const fechaActual = new Date().toLocaleDateString('es-CO');
    const usuario = currentUser?.user_display_name || 'Usuario';
    
    doc.setFontSize(16);
    doc.setTextColor(19, 128, 226);
    doc.text(nombreInstitucion, doc.internal.pageSize.width / 2, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100);
    doc.text(`Lista de Estudiantes - ${curso.course_name}`, doc.internal.pageSize.width / 2, 28, { align: 'center' });
    
    doc.setFontSize(9);
    doc.text(`Generado por: ${usuario} | Fecha: ${fechaActual}`, doc.internal.pageSize.width / 2, 34, { align: 'center' });
    
    const columnas = [];
    if (opciones.conNumeracion) columnas.push('#');
    if (opciones.conCodigo) columnas.push('C√≥digo');
    columnas.push('Nombre Completo');
    
    if (opciones.conFirmas) {
        columnas.push('Firma Familia');
    } else {
        columnas.push(...opciones.columnasPersonalizadas);
    }
    
    const filas = estudiantes.map((est, idx) => {
        const fila = [];
        if (opciones.conNumeracion) fila.push((idx + 1).toString());
        if (opciones.conCodigo) fila.push(est.student_code || '');
        
        const nombreCompleto = `${est.student_last_name_1} ${est.student_last_name_2 || ''} ${est.student_first_name}`.trim();
        fila.push(nombreCompleto);
        
        const numColumnasVacias = opciones.conFirmas ? 1 : opciones.columnasPersonalizadas.length;
        for (let i = 0; i < numColumnasVacias; i++) {
            fila.push('');
        }
        
        return fila;
    });
    
    doc.autoTable({
        head: [columnas],
        body: filas,
        startY: 40,
        theme: 'grid',
        styles: {
            fontSize: 9,
            cellPadding: 3
        },
        headStyles: {
            fillColor: [19, 128, 226],
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center'
        },
        alternateRowStyles: {
            fillColor: [248, 249, 250]
        }
    });
    
    const finalY = doc.lastAutoTable.finalY || 40;
    doc.setFontSize(10);
    doc.setTextColor(0);
    doc.text(`Total de estudiantes: ${estudiantes.length}`, 14, finalY + 10);
    
    const nombreArchivo = `Lista_Estudiantes_${curso.course_name.replace(/\s+/g, '_')}_${Date.now()}.pdf`;
    doc.save(nombreArchivo);
    
    console.log(`‚úÖ PDF generado: ${nombreArchivo}`);
}

// ==========================================
// GENERAR LISTA DE FAMILIAS
// ==========================================
async function generarListaFamilias() {
    try {
        const tipoLista = document.querySelector('input[name="tipoListaFam"]:checked').value;
        
        const numColumnas = parseInt(document.getElementById('numColumnasFam').value) || 0;
        const columnasPersonalizadas = [];
        
        for (let i = 1; i <= numColumnas; i++) {
            const header = document.getElementById(`colHeaderFam${i}`).value.trim();
            if (header) {
                columnasPersonalizadas.push(header);
            }
        }
        
        if (columnasPersonalizadas.length === 0) {
            showMessage('Debe especificar al menos un encabezado para las columnas personalizadas', 'warning');
            return;
        }
        
        mostrarLoading('Generando PDFs de familias...');
        
        if (tipoLista === 'general') {
            await generarPDFFamiliasGeneral(columnasPersonalizadas);
        } else {
            const cursosSeleccionados = Array.from(document.getElementById('selectCursosFamilias').selectedOptions)
                .map(option => option.value);
            
            if (cursosSeleccionados.length === 0) {
                showMessage('Debe seleccionar al menos un curso', 'warning');
                ocultarLoading();
                return;
            }
            
            for (const cursoId of cursosSeleccionados) {
                const curso = cursosData.find(c => c.course_id === cursoId);
                await generarPDFFamiliasPorCurso(curso, cursoId, columnasPersonalizadas);
            }
        }
        
        ocultarLoading();
        showMessage('PDF(s) generado(s) exitosamente', 'success');
        
    } catch (error) {
        console.error('‚ùå Error generando lista de familias:', error);
        ocultarLoading();
        showMessage('Error al generar PDFs: ' + error.message, 'danger');
    }
}

async function generarPDFFamiliasGeneral(columnasPersonalizadas) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'letter');
    
   const familias = await supabaseRequest(
        '/families?select=family_code,family_name&family_status=eq.active&order=family_name.asc'
    );
    
    // Ya vienen filtradas por active desde la query
    const familiasActivas = familias;
    
    const familiasConHijos = [];
    
    for (const familia of familiasActivas) {
        const hijos = await supabaseRequest(
            `/students?select=student_first_name,student_last_name_1,courses(course_name),student_status!inner(status_description)&family_id=eq.${familia.family_code}&student_status.status_description=eq.Activo&order=student_first_name.asc`
        );
        
        // Ya vienen filtrados por Activo desde la query
        const hijosActivos = hijos;
        
        if (hijosActivos.length > 0) {
            const hijosTexto = hijosActivos.map(h => 
                `${h.student_first_name} ${h.student_last_name_1} (${h.courses?.course_name || 'Sin curso'})`
            ).join('; ');
            
            familiasConHijos.push({
                familia: familia.family_name,
                hijos: hijosTexto
            });
        }
    }
    
    const nombreInstitucion = systemConfig?.organization_name || 'Instituci√≥n Educativa';
    const fechaActual = new Date().toLocaleDateString('es-CO');
    const usuario = currentUser?.user_display_name || 'Usuario';
    
    doc.setFontSize(16);
    doc.setTextColor(19, 128, 226);
    doc.text(nombreInstitucion, doc.internal.pageSize.width / 2, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100);
    doc.text('Lista General de Familias', doc.internal.pageSize.width / 2, 28, { align: 'center' });
    
    doc.setFontSize(9);
    doc.text(`Generado por: ${usuario} | Fecha: ${fechaActual}`, doc.internal.pageSize.width / 2, 34, { align: 'center' });
    
    const columnas = ['Familia', 'Hijos y Cursos', ...columnasPersonalizadas];
    
    const filas = familiasConHijos.map(fam => {
        const fila = [fam.familia, fam.hijos];
        for (let i = 0; i < columnasPersonalizadas.length; i++) {
            fila.push('');
        }
        return fila;
    });
    
    doc.autoTable({
        head: [columnas],
        body: filas,
        startY: 40,
        theme: 'grid',
        styles: {
            fontSize: 8,
            cellPadding: 3
        },
        headStyles: {
            fillColor: [19, 128, 226],
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center'
        },
        columnStyles: {
            0: { cellWidth: 50 },
            1: { cellWidth: 80 }
        },
        alternateRowStyles: {
            fillColor: [248, 249, 250]
        }
    });
    
    const finalY = doc.lastAutoTable.finalY || 40;
    doc.setFontSize(10);
    doc.setTextColor(0);
    doc.text(`Total de familias: ${familiasConHijos.length}`, 14, finalY + 10);
    
    const nombreArchivo = `Lista_Familias_General_${Date.now()}.pdf`;
    doc.save(nombreArchivo);
    
    console.log(`‚úÖ PDF generado: ${nombreArchivo}`);
}

async function generarPDFFamiliasPorCurso(curso, cursoId, columnasPersonalizadas) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'letter');

   // PASO 1: Obtener estudiantes activos del curso
    const estudiantes = await supabaseRequest(
        `/students?select=student_id,family_id,student_first_name,student_last_name_1,student_status!inner(status_description)&course_id=eq.${cursoId}&student_status.status_description=eq.Activo&order=student_first_name.asc`
    );
    
    if (estudiantes.length === 0) {
        throw new Error(`No hay estudiantes activos en el curso ${curso.course_name}`);
    }
    
    // PASO 2: Obtener c√≥digos √∫nicos de familias
    const familyCodesUnicos = [...new Set(estudiantes.map(e => e.family_id))];
    
    // PASO 3: Para cada familia, obtener su nombre
    const familiasMap = new Map();
    
    for (const familyCode of familyCodesUnicos) {
        // Obtener datos de la familia
        const familiaData = await supabaseRequest(
            `/families?select=family_name&family_code=eq.${familyCode}&limit=1`
        );
        
        const nombreFamilia = familiaData[0]?.family_name || `Familia ${familyCode}`;
        familiasMap.set(familyCode, nombreFamilia);
    }
    
    // PASO 4: Agrupar estudiantes por familia
    const familiasConHijosMap = new Map();
    
    estudiantes.forEach(est => {
        const familyCode = est.family_id;
        const nombreFamilia = familiasMap.get(familyCode) || `Familia ${familyCode}`;
        
        if (!familiasConHijosMap.has(familyCode)) {
            familiasConHijosMap.set(familyCode, {
                familia: nombreFamilia,
                hijos: []
            });
        }
        
        familiasConHijosMap.get(familyCode).hijos.push(`${est.student_first_name} ${est.student_last_name_1}`);
    });
    
    const familiasConHijos = Array.from(familiasConHijosMap.values()).map(fam => ({
        familia: fam.familia,
        hijos: fam.hijos.join(', ')
    }));
    
    const nombreInstitucion = systemConfig?.organization_name || 'Instituci√≥n Educativa';
    const fechaActual = new Date().toLocaleDateString('es-CO');
    const usuario = currentUser?.user_display_name || 'Usuario';
    
    doc.setFontSize(16);
    doc.setTextColor(19, 128, 226);
    doc.text(nombreInstitucion, doc.internal.pageSize.width / 2, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100);
    doc.text(`Lista de Familias - ${curso.course_name}`, doc.internal.pageSize.width / 2, 28, { align: 'center' });
    
    doc.setFontSize(9);
    doc.text(`Generado por: ${usuario} | Fecha: ${fechaActual}`, doc.internal.pageSize.width / 2, 34, { align: 'center' });
    
    const columnas = ['Familia', 'Hijos', ...columnasPersonalizadas];
    
    const filas = familiasConHijos.map(fam => {
        const fila = [fam.familia, fam.hijos];
        for (let i = 0; i < columnasPersonalizadas.length; i++) {
            fila.push('');
        }
        return fila;
    });
    
    doc.autoTable({
        head: [columnas],
        body: filas,
        startY: 40,
        theme: 'grid',
        styles: {
            fontSize: 9,
            cellPadding: 3
        },
        headStyles: {
            fillColor: [19, 128, 226],
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center'
        },
        columnStyles: {
            0: { cellWidth: 60 },
            1: { cellWidth: 70 }
        },
        alternateRowStyles: {
            fillColor: [248, 249, 250]
        }
    });
    
    const finalY = doc.lastAutoTable.finalY || 40;
    doc.setFontSize(10);
    doc.setTextColor(0);
    doc.text(`Total de familias: ${familiasConHijos.length}`, 14, finalY + 10);
    
    const nombreArchivo = `Lista_Familias_${curso.course_name.replace(/\s+/g, '_')}_${Date.now()}.pdf`;
    doc.save(nombreArchivo);
    
    console.log(`‚úÖ PDF generado: ${nombreArchivo}`);
}

// ==========================================
// GENERAR LISTA DE TRABAJADORES
// ==========================================
async function generarListaTrabajadores() {
    try {
        const opciones = {
            conNumeracion: document.getElementById('checkNumeracionTrab').checked,
            conDocumento: document.getElementById('checkDocumentoTrab').checked,
            columnasPersonalizadas: []
        };
        
        const numColumnas = parseInt(document.getElementById('numColumnasTrab').value) || 0;
        for (let i = 1; i <= numColumnas; i++) {
            const header = document.getElementById(`colHeaderTrab${i}`).value.trim();
            if (header) {
                opciones.columnasPersonalizadas.push(header);
            }
        }
        
        if (opciones.columnasPersonalizadas.length === 0) {
            showMessage('Debe especificar al menos un encabezado para las columnas personalizadas', 'warning');
            return;
        }
        
        const filtros = {
            generos: Array.from(document.getElementById('selectGenero').selectedOptions)
                .map(o => o.value).filter(v => v),
            centrosCostos: Array.from(document.getElementById('selectCentroCosto').selectedOptions)
                .map(o => o.value).filter(v => v),
            areas: Array.from(document.getElementById('selectArea').selectedOptions)
                .map(o => o.value).filter(v => v),
            subareas: Array.from(document.getElementById('selectSubarea').selectedOptions)
                .map(o => o.value).filter(v => v),
            roles: Array.from(document.getElementById('selectRoles').selectedOptions)
                .map(o => o.value).filter(v => v)
        };
        
        mostrarLoading('Obteniendo trabajadores...');
        
        const trabajadores = await obtenerTrabajadoresFiltrados(filtros);
        
        if (trabajadores.length === 0) {
            showMessage('No se encontraron trabajadores con los filtros especificados', 'warning');
            ocultarLoading();
            return;
        }
        
        await generarPDFTrabajadores(trabajadores, opciones);
        
        ocultarLoading();
        showMessage('PDF generado exitosamente', 'success');
        
    } catch (error) {
        console.error('‚ùå Error generando lista de trabajadores:', error);
        ocultarLoading();
        showMessage('Error al generar PDF: ' + error.message, 'danger');
    }
}

async function obtenerTrabajadoresFiltrados(filtros) {
    try {
        let query = '/workers?select=worker_id,worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2&worker_status=eq.active';
        
        if (filtros.generos.length > 0) {
            const genFilter = filtros.generos.map(id => `gender_id.eq.${id}`).join(',');
            query += `&or=(${genFilter})`;
        }
        
        if (filtros.centrosCostos.length > 0) {
            const ccFilter = filtros.centrosCostos.map(id => `cost_center_id.eq.${id}`).join(',');
            query += `&or=(${ccFilter})`;
        }
        
        if (filtros.areas.length > 0) {
            const areaFilter = filtros.areas.map(id => `area_id.eq.${id}`).join(',');
            query += `&or=(${areaFilter})`;
        }
        
        if (filtros.subareas.length > 0) {
            const subFilter = filtros.subareas.map(id => `subarea_id.eq.${id}`).join(',');
            query += `&or=(${subFilter})`;
        }
        
        let trabajadores = await supabaseRequest(query);
        
        
        if (filtros.roles.length > 0) {
            const trabajadoresConRoles = [];
            
            for (const trabajador of trabajadores) {
                const rolesDelTrabajador = await supabaseRequest(
                    `/worker_job_roles?select=role_id&worker_id=eq.${trabajador.worker_id}`
                );
                
                const rolesIds = rolesDelTrabajador.map(r => r.role_id);
                const tieneRol = filtros.roles.some(rolId => rolesIds.includes(rolId));
                
                if (tieneRol) {
                    trabajadoresConRoles.push(trabajador);
                }
            }
            
            trabajadores = trabajadoresConRoles;
        }
        
        return trabajadores.map(trab => ({
            ...trab,
            nombreCompleto: `${trab.worker_last_name_1} ${trab.worker_last_name_2 || ''} ${trab.worker_first_name}`.trim()
        })).sort((a, b) => a.nombreCompleto.localeCompare(b.nombreCompleto));
        
    } catch (error) {
        console.error('‚ùå Error obteniendo trabajadores:', error);
        throw error;
    }
}

async function generarPDFTrabajadores(trabajadores, opciones) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'letter');
    
    const nombreInstitucion = systemConfig?.organization_name || 'Instituci√≥n Educativa';
    const fechaActual = new Date().toLocaleDateString('es-CO');
    const usuario = currentUser?.user_display_name || 'Usuario';
    
    doc.setFontSize(16);
    doc.setTextColor(19, 128, 226);
    doc.text(nombreInstitucion, doc.internal.pageSize.width / 2, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setTextColor(100);
    doc.text('Lista de Trabajadores', doc.internal.pageSize.width / 2, 28, { align: 'center' });
    
    doc.setFontSize(9);
    doc.text(`Generado por: ${usuario} | Fecha: ${fechaActual}`, doc.internal.pageSize.width / 2, 34, { align: 'center' });
    
    const columnas = [];
    if (opciones.conNumeracion) columnas.push('#');
    if (opciones.conDocumento) columnas.push('Documento');
    columnas.push('Nombre Completo');
    columnas.push(...opciones.columnasPersonalizadas);
    
    const filas = trabajadores.map((trab, idx) => {
        const fila = [];
        if (opciones.conNumeracion) fila.push((idx + 1).toString());
        if (opciones.conDocumento) fila.push(trab.worker_id_doc || '');
        fila.push(trab.nombreCompleto);
        
        for (let i = 0; i < opciones.columnasPersonalizadas.length; i++) {
            fila.push('');
        }
        
        return fila;
    });
    
    doc.autoTable({
        head: [columnas],
        body: filas,
        startY: 40,
        theme: 'grid',
        styles: {
            fontSize: 9,
            cellPadding: 3
        },
        headStyles: {
            fillColor: [19, 128, 226],
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center'
        },
        columnStyles: (() => {
            const styles = {};
            let colIndex = 0;
            
            if (opciones.conNumeracion) {
                styles[colIndex] = { cellWidth: 8 };
                colIndex++;
            }
            
            if (opciones.conDocumento) {
                styles[colIndex] = { cellWidth: 20 };
                colIndex++;
            }
            
            // La columna del nombre SIEMPRE es la siguiente
            styles[colIndex] = { cellWidth: 85 };
            
            return styles;
        })(),
        alternateRowStyles: {
            fillColor: [248, 249, 250]
        }
    });
    
    const finalY = doc.lastAutoTable.finalY || 40;
    doc.setFontSize(10);
    doc.setTextColor(0);
    doc.text(`Total de trabajadores: ${trabajadores.length}`, 14, finalY + 10);
    
    const nombreArchivo = `Lista_Trabajadores_${Date.now()}.pdf`;
    doc.save(nombreArchivo);
    
    console.log(`‚úÖ PDF generado: ${nombreArchivo}`);
}

// ==========================================
// UTILIDADES
// ==========================================
function mostrarLoading(mensaje = 'Cargando...') {
    document.getElementById('loadingMessage').textContent = mensaje;
    document.getElementById('loadingOverlay').classList.add('show');
}

function ocultarLoading() {
    document.getElementById('loadingOverlay').classList.remove('show');
}
</script>
