<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0
    <meta name="page-version" content="25.11.03.13.21">
    <title>Plantillas de Contratos - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Quill Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .section-divider {
            border-top: 2px solid #e9ecef;
            margin: 2rem 0;
            padding-top: 2rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .table-actions {
            white-space: nowrap;
        }
        
        .badge-variables {
            font-size: 0.75rem;
            padding: 0.35rem 0.65rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Quill Editor */
        #editor-container {
            height: 300px;
            background: white;
        }
        
        .ql-editor {
            font-size: 14px;
            line-height: 1.6;
        }
        
        .variable-badge {
            background-color: #e7f3ff;
            color: #0066cc;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.875rem;
        }
        
        .detected-variables {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        
        .pdf-viewer-container {
            width: 100%;
            height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .pdf-viewer-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .generate-btn {
            min-width: 120px;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        /* Estilos para el alert de ayuda */
        .paste-help {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .paste-help kbd {
            padding: 0.2rem 0.4rem;
            font-size: 0.8rem;
            background-color: #e9ecef;
            border: 1px solid #adb5bd;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 mb-0" id="loading-text">Procesando...</p>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Plantillas de Contratos
                </li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3 mb-2">
                    <i class="bi bi-file-earmark-text me-2"></i>
                    Plantillas y Mis Contratos
                </h1>
                <p class="text-muted">Crea plantillas con variables reemplazables y genera contratos personalizados en PDF</p>
            </div>
        </div>

        <!-- Contenedor de Alertas -->
        <div id="alertContainer"></div>

        <!-- M√©tricas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted mb-1 small">Total Plantillas</p>
                                <h3 class="mb-0" id="total-templates">0</h3>
                            </div>
                            <div class="text-primary">
                                <i class="bi bi-file-earmark-text" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted mb-1 small">Mis Plantillas</p>
                                <h3 class="mb-0" id="my-templates">0</h3>
                            </div>
                            <div class="text-success">
                                <i class="bi bi-person-check" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted mb-1 small">Contratos Generados</p>
                                <h3 class="mb-0" id="total-contracts">0</h3>
                            </div>
                            <div class="text-info">
                                <i class="bi bi-file-pdf" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- SECCI√ìN 1: PLANTILLAS -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="section-title">
            <i class="bi bi-file-earmark-text"></i>
            <span>Plantillas de Contratos</span>
        </div>

        <!-- Barra de Acciones - Plantillas -->
        <div class="row mb-3">
            <div class="col-md-6">
                <button class="btn btn-primary" onclick="abrirModalCrearPlantilla()">
                    <i class="bi bi-plus-circle me-1"></i>Nueva Plantilla
                </button>
                <button class="btn btn-outline-secondary" onclick="cargarPlantillas()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                </button>
            </div>
            <div class="col-md-6">
                <div class="input-group" style="max-width: 300px; margin-left: auto;">
                    <span class="input-group-text bg-white">
                        <i class="bi bi-search"></i>
                    </span>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="search-templates" 
                        placeholder="Buscar plantillas..."
                        onkeyup="filtrarPlantillas()"
                    >
                </div>
            </div>
        </div>

        <!-- Tabla de Plantillas -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tabla-plantillas">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 12%;">Categor√≠a</th>
                                <th style="width: 18%;">Plantilla</th>
                                <th style="width: 20%;">Nombre del Contrato</th>
                                <th style="width: 12%;">Fecha Fin</th>
                                <th style="width: 13%;">Generado</th>
                                <th style="width: 25%;" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-plantillas-body">
                            <!-- Datos cargados din√°micamente -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Estado Vac√≠o - Plantillas -->
                <div id="empty-state-templates" class="empty-state d-none">
                    <i class="bi bi-file-earmark-text"></i>
                    <p class="mb-0">No hay plantillas registradas</p>
                    <button class="btn btn-sm btn-primary mt-3" onclick="abrirModalCrearPlantilla()">
                        <i class="bi bi-plus-circle me-1"></i>Crear Primera Plantilla
                    </button>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- SECCI√ìN 2: MIS CONTRATOS GENERADOS -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="section-divider"></div>
        
        <div class="section-title">
            <i class="bi bi-file-pdf"></i>
            <span>Mis Contratos Generados</span>
        </div>

        <!-- Filtros - Contratos -->
        <div class="filter-section">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small">Categor√≠a</label>
                    <select class="form-select" id="filter-category" onchange="filtrarContratos()">
                        <option value="">Todas las categor√≠as</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Plantilla</label>
                    <select class="form-select" id="filter-template" onchange="filtrarContratos()">
                        <option value="">Todas las plantillas</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small">Buscar</label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="search-contracts" 
                        placeholder="Buscar por nombre..."
                        onkeyup="filtrarContratos()"
                    >
                </div>
                <div class="col-md-2">
                    <label class="form-label small">&nbsp;</label>
                    <button class="btn btn-outline-secondary w-100" onclick="cargarMisContratos()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabla de Contratos -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tabla-contratos">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 15%;">Categor√≠a</th>
                                <th style="width: 20%;">Plantilla</th>
                                <th style="width: 25%;">Nombre del Contrato</th>
                                <th style="width: 15%;">Fecha</th>
                                <th style="width: 25%;" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-contratos-body">
                            <!-- Datos cargados din√°micamente -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Estado Vac√≠o - Contratos -->
                <div id="empty-state-contracts" class="empty-state d-none">
                    <i class="bi bi-file-pdf"></i>
                    <p class="mb-0">No has generado ning√∫n contrato todav√≠a</p>
                    <small class="text-muted">Usa el bot√≥n "Generar" en cualquier plantilla para crear tu primer contrato</small>
                </div>
            </div>
        </div>

    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- MODAL: CREAR/EDITAR PLANTILLA -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- MODAL: CREAR/EDITAR PLANTILLA - ACTUALIZADO -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal fade" id="modal-plantilla" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-plantilla-title">
                        <i class="bi bi-plus-circle me-2"></i>Nueva Plantilla
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-plantilla">
                    <input type="hidden" id="template-id">
                    <div class="modal-body">
                        
                        <!-- Nombre de la Plantilla -->
                        <div class="mb-3">
                            <label for="template-name" class="form-label">
                                Nombre de la Plantilla <span class="text-danger">*</span>
                            </label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="template-name" 
                                required
                                maxlength="200"
                                placeholder="Ej: Contrato de trabajo, Prestaci√≥n de servicios..."
                            >
                        </div>
    
                        <!-- Gu√≠a de Uso de Variables - NUEVO -->
                        <div class="alert alert-info" role="alert">
                            <h6 class="alert-heading">
                                <i class="bi bi-info-circle me-2"></i>Gu√≠a de Variables
                            </h6>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Variables de texto corto:</strong>
                                    <ul class="mb-0 small">
                                        <li><code>$$contratante$$</code></li>
                                        <li><code>$$contratista$$</code></li>
                                        <li><code>$$salario$$</code></li>
                                        <li><code>$$cargo$$</code></li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <strong>Variables de texto largo:</strong>
                                    <ul class="mb-0 small">
                                        <li><code>$$objeto_large$$</code> o <code>$$objeto_texto$$</code></li>
                                        <li><code>$$condiciones_large$$</code></li>
                                        <li><code>$$descripcion_texto$$</code></li>
                                        <li>O cualquier variable con: <code>condicion</code>, <code>descripcion</code>, <code>detalle</code></li>
                                    </ul>
                                </div>
                            </div>
                            <hr class="my-2">
                            <small class="text-muted">
                                <strong>Tip:</strong> Las variables que terminan en <code>_large</code> o <code>_texto</code>, o contienen palabras como "condicion", "descripcion" o "detalle" se mostrar√°n como campos de texto largo (textarea) al generar el contrato.
                            </small>
                        </div>
    
                        <!-- Editor de Contenido -->
                        <div class="mb-3">
                            <label class="form-label">
                                Contenido de la Plantilla <span class="text-danger">*</span>
                            </label>
                            
                            <!-- NUEVO: Alert de ayuda -->
                            <div class="alert alert-info paste-help">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Tip para pegar texto:</strong> Si copias desde Word o Google Docs, 
                                usa <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>V</kbd> 
                                <small class="text-muted">(o <kbd>‚åò</kbd>+<kbd>Shift</kbd>+<kbd>V</kbd> en Mac)</small> 
                                para pegar sin formato y evitar problemas.
                            </div>
                            
                            <div class="mb-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="insertarVariable()">
                                    <i class="bi bi-code-square me-1"></i>Insertar Variable
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limpiarFormatoEditor()">
                                    <i class="bi bi-eraser me-1"></i>Limpiar Todo el Formato
                                </button>
                                <small class="text-muted ms-2">
                                    Las variables deben estar en formato <code>$$nombreVariable$$</code>
                                </small>
                            </div>
                            <div id="editor-container"></div>
                        </div>
    
                        <!-- Variables Detectadas -->
                        <div class="detected-variables" id="detected-variables">
                            <strong class="small">Variables detectadas:</strong>
                            <div id="variables-list" class="mt-2">
                                <span class="text-muted small">Ninguna variable detectada</span>
                            </div>
                        </div>
    
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>Guardar Plantilla
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- MODAL: GENERAR CONTRATO -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal fade" id="modal-generar" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-plus me-2"></i>Generar Contrato
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-generar">
                    <input type="hidden" id="gen-template-id">
                    <div class="modal-body">
                        
                        <!-- Nombre de Plantilla (solo lectura) -->
                        <div class="alert alert-info">
                            <strong>Plantilla:</strong> <span id="gen-template-name"></span>
                        </div>

                        <!-- Categor√≠a -->
                        <div class="mb-3">
                            <label for="gen-category" class="form-label">
                                Categor√≠a <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="gen-category" required>
                                <option value="">Seleccione una categor√≠a...</option>
                            </select>
                        </div>

                        <!-- Nombre del Contrato -->
                        <div class="mb-3">
                            <label for="gen-contract-name" class="form-label">
                                Nombre del Contrato <span class="text-danger">*</span>
                            </label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="gen-contract-name" 
                                required
                                maxlength="200"
                                placeholder="Ej: Contrato Juan P√©rez - 2025"
                            >
                        </div>

                        <!-- Fecha de Finalizaci√≥n -->
                        <div class="mb-3">
                            <label for="gen-end-date" class="form-label">
                                Fecha de Finalizaci√≥n del Contrato <span class="text-danger">*</span>
                            </label>
                            <input 
                                type="date" 
                                class="form-control" 
                                id="gen-end-date" 
                                required
                            >
                            <div class="form-text">Fecha en que finaliza la vigencia del contrato</div>
                        </div>

                        <hr>

                        <!-- Campos Din√°micos para Variables -->
                        <h6 class="mb-3">Datos de la Plantilla:</h6>
                        <div id="variables-form">
                            <!-- Los campos se generan din√°micamente seg√∫n las variables -->
                        </div>

                        <!-- Notas Opcionales -->
                        <div class="mb-3">
                            <label for="gen-notes" class="form-label">
                                Notas (opcional)
                            </label>
                            <textarea 
                                class="form-control" 
                                id="gen-notes" 
                                rows="2"
                                maxlength="500"
                                placeholder="Notas adicionales sobre este contrato..."
                            ></textarea>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success generate-btn">
                            <i class="bi bi-file-pdf me-1"></i>Generar PDF
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- MODAL: INSERTAR VARIABLE -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal fade" id="modal-variable" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-code-square me-2"></i>Insertar Variable
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label for="variable-name" class="form-label">
                        Nombre de la variable:
                    </label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="variable-name"
                        placeholder="Ej: contratante, salario..."
                    >
                    <div class="form-text">
                        Se insertar√° como <code>$$nombreVariable$$</code>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmarInsertarVariable()">
                        <i class="bi bi-check-circle me-1"></i>Insertar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- MODAL: VER PDF -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="modal fade" id="modal-pdf" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-pdf me-2"></i><span id="pdf-title">Vista Previa del Contrato</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="pdf-viewer-container" id="pdf-viewer">
                        <!-- PDF se carga aqu√≠ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cerrar
                    </button>
                    <a href="#" id="pdf-download-btn" class="btn btn-primary" download>
                        <i class="bi bi-download me-1"></i>Descargar PDF
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Quill Editor -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <!-- jsPDF y html2canvas para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // CONSTANTES Y VARIABLES GLOBALES
        // ==========================================
        const BUCKET_NAME = 'Contract-pdfs';
        
        let plantillasCache = [];
        let misContratosCache = [];
        let categoriasCache = [];
        let currentUser = null;
        
        // Modales
        let modalPlantilla = null;
        let modalGenerar = null;
        let modalVariable = null;
        let modalPdf = null;
        
        // Editor Quill
        let quillEditor = null;
        
        // Variables de edici√≥n
        let modoEdicionPlantilla = false;
        let plantillaEditando = null;
        let plantillaGenerando = null;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // Validar permisos
                const hasAccess = await validatePageAccess('Gestionar plantillas de contratos');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - inicializando p√°gina');
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });

        // ==========================================
        // INICIALIZAR P√ÅGINA
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading('Iniciando...');
                
                // Obtener usuario actual
                const session = getStoredSession();
                currentUser = session.user;
                
                // Inicializar modales
                modalPlantilla = new bootstrap.Modal(document.getElementById('modal-plantilla'));
                modalGenerar = new bootstrap.Modal(document.getElementById('modal-generar'));
                modalVariable = new bootstrap.Modal(document.getElementById('modal-variable'));
                modalPdf = new bootstrap.Modal(document.getElementById('modal-pdf'));
                
                // Inicializar Quill Editor
                inicializarEditor();
                
                // Configurar eventos
                document.getElementById('form-plantilla').addEventListener('submit', manejarSubmitPlantilla);
                document.getElementById('form-generar').addEventListener('submit', manejarSubmitGenerar);
                
                // Cargar datos
                await cargarDatosIniciales();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // INICIALIZAR QUILL EDITOR
        // ==========================================
        function inicializarEditor() {
            quillEditor = new Quill('#editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'align': [] }],  // ‚Üê NUEVO: Botones de alineaci√≥n
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                },
                placeholder: 'Escribe el contenido de tu plantilla aqu√≠...\nUsa $$nombreVariable$$ para insertar variables.'
            });
            
            // Detectar variables al escribir
            quillEditor.on('text-change', detectarVariables);
            
            // Mejorar el pegado: convertir a texto plano autom√°ticamente
            quillEditor.root.addEventListener('paste', function(e) {
                // Permitir el pegado normal de Quill pero mostrar aviso si tiene mucho formato
                setTimeout(() => {
                    const html = quillEditor.root.innerHTML;
                    // Detectar si tiene formato complejo (spans anidados, estilos inline, etc)
                    if (html.includes('style=') || html.match(/<span[^>]*><span/)) {
                        showMessage('Se detect√≥ formato complejo. Si ves problemas, usa el bot√≥n "Limpiar Todo el Formato"', 'warning');
                    }
                }, 100);
            });
            
            console.log('‚úÖ Editor Quill inicializado');
        }
        
        // ==========================================
        // CARGAR DATOS INICIALES
        // ==========================================
        async function cargarDatosIniciales() {
            try {
                mostrarLoading('Cargando datos...');
                
                // Cargar en paralelo
                await Promise.all([
                    cargarPlantillas(),
                    cargarCategorias(),
                    cargarMisContratos()
                ]);
                
                actualizarMetricas();
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                showMessage('Error al cargar datos iniciales: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // CARGAR PLANTILLAS
        // ==========================================
        async function cargarPlantillas() {
            try {
                console.log('üì° Cargando plantillas...');
                
                const datos = await supabaseRequest('/contract_templates?select=*,users!contract_templates_created_by_fkey(user_display_name)&is_active=eq.true&order=template_name.asc');
                
                plantillasCache = datos || [];
                renderizarPlantillas(plantillasCache);
                
                // Cargar plantillas en filtro de contratos
                cargarPlantillasEnFiltro();
                
                console.log(`‚úÖ ${plantillasCache.length} plantillas cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando plantillas:', error);
                throw error;
            }
        }

        // ==========================================
        // CARGAR CATEGOR√çAS
        // ==========================================
        async function cargarCategorias() {
            try {
                console.log('üì° Cargando categor√≠as...');
                
                const datos = await supabaseRequest('/contract_categories?select=*&is_active=eq.true&order=category_name.asc');
                
                categoriasCache = datos || [];
                
                // Llenar select de categor√≠as en modal generar
                const selectCategory = document.getElementById('gen-category');
                selectCategory.innerHTML = '<option value="">Seleccione una categor√≠a...</option>' +
                    categoriasCache.map(cat => `<option value="${cat.category_id}">${escapeHtml(cat.category_name)}</option>`).join('');
                
                // Llenar filtro de categor√≠as
                const filterCategory = document.getElementById('filter-category');
                filterCategory.innerHTML = '<option value="">Todas las categor√≠as</option>' +
                    categoriasCache.map(cat => `<option value="${cat.category_id}">${escapeHtml(cat.category_name)}</option>`).join('');
                
                console.log(`‚úÖ ${categoriasCache.length} categor√≠as cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando categor√≠as:', error);
                throw error;
            }
        }

        // ==========================================
        // CARGAR MIS CONTRATOS
        // ==========================================
        async function cargarMisContratos() {
            try {
                console.log('üì° Cargando mis contratos...');
                
                const datos = await supabaseRequest('/generated_contracts?select=*,contract_templates(template_name),contract_categories(category_name)&generated_by=eq.' + currentUser.user_id + '&order=generated_at.desc');
                
                misContratosCache = datos || [];
                renderizarContratos(misContratosCache);
                
                console.log(`‚úÖ ${misContratosCache.length} contratos cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando contratos:', error);
                throw error;
            }
        }
      // ==========================================
        // RENDERIZAR PLANTILLAS
        // ==========================================
        function renderizarPlantillas(datos) {
            const tbody = document.getElementById('tabla-plantillas-body');
            const emptyState = document.getElementById('empty-state-templates');
            
            if (!datos || datos.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('d-none');
                return;
            }
            
            emptyState.classList.add('d-none');
            
            tbody.innerHTML = datos.map(template => {
                const variables = template.template_variables || [];
                const esCreador = template.created_by === currentUser.user_id;
                const creadorNombre = template.users?.user_display_name || 'Desconocido';
                
                return `
                    <tr>
                        <td>
                            <strong>${escapeHtml(template.template_name)}</strong>
                        </td>
                        <td>
                            <span class="badge bg-info badge-variables">
                                ${variables.length} ${variables.length === 1 ? 'variable' : 'variables'}
                            </span>
                        </td>
                        <td>
                            <span class="text-muted">
                                ${esCreador ? '‚úì Yo' : escapeHtml(creadorNombre)}
                            </span>
                        </td>
                        <td>
                            <small class="text-muted">${formatDate(template.created_at)}</small>
                        </td>
                        <td class="text-center table-actions">
                            ${esCreador ? `
                                <button 
                                    class="btn btn-sm btn-outline-primary" 
                                    onclick="editarPlantilla('${template.template_id}')"
                                    title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            ` : ''}
                            <button 
                                class="btn btn-sm btn-success" 
                                onclick="abrirModalGenerar('${template.template_id}')"
                                title="Generar contrato">
                                <i class="bi bi-file-earmark-plus"></i> Generar
                            </button>
                            ${esCreador ? `
                                <button 
                                    class="btn btn-sm btn-outline-danger" 
                                    onclick="eliminarPlantilla('${template.template_id}')"
                                    title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ==========================================
        // RENDERIZAR CONTRATOS
        // ==========================================
        function renderizarContratos(datos) {
            const tbody = document.getElementById('tabla-contratos-body');
            const emptyState = document.getElementById('empty-state-contracts');
            
            if (!datos || datos.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('d-none');
                return;
            }
            
            emptyState.classList.add('d-none');
            
            tbody.innerHTML = datos.map(contract => {
                const categoryName = contract.contract_categories?.category_name || '-';
                const templateName = contract.contract_templates?.template_name || '-';
                
                return `
                    <tr>
                        <td>
                            <span class="badge bg-secondary">${escapeHtml(categoryName)}</span>
                        </td>
                        <td>
                            <small class="text-muted">${escapeHtml(templateName)}</small>
                        </td>
                        <td>
                            <strong>${escapeHtml(contract.contract_name)}</strong>
                            ${contract.notes ? `<br><small class="text-muted">${escapeHtml(contract.notes)}</small>` : ''}
                        </td>

                        <td>
                            <small>${contract.contract_end_date ? formatDate(contract.contract_end_date) : '-'}</small>
                            ${contract.contract_end_date && new Date(contract.contract_end_date) < new Date() ? 
                                '<br><span class="badge bg-danger">Vencido</span>' : ''}
                        </td>
                        <td>
                            <small>${formatDate(contract.generated_at)}</small>
                        </td>
                        <td class="text-center table-actions">
                            <button 
                                class="btn btn-sm btn-outline-primary" 
                                onclick="verPDF('${contract.contract_id}')"
                                title="Ver PDF">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button 
                                class="btn btn-sm btn-outline-success" 
                                onclick="descargarPDF('${contract.contract_id}')"
                                title="Descargar">
                                <i class="bi bi-download"></i>
                            </button>
                            <button 
                                class="btn btn-sm btn-outline-danger" 
                                onclick="eliminarContrato('${contract.contract_id}')"
                                title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ==========================================
        // ACTUALIZAR M√âTRICAS
        // ==========================================
        function actualizarMetricas() {
            const totalTemplates = plantillasCache.length;
            const myTemplates = plantillasCache.filter(t => t.created_by === currentUser.user_id).length;
            const totalContracts = misContratosCache.length;
            
            document.getElementById('total-templates').textContent = totalTemplates;
            document.getElementById('my-templates').textContent = myTemplates;
            document.getElementById('total-contracts').textContent = totalContracts;
        }

        // ==========================================
        // ABRIR MODAL CREAR PLANTILLA
        // ==========================================
        function abrirModalCrearPlantilla() {
            modoEdicionPlantilla = false;
            plantillaEditando = null;
            
            document.getElementById('form-plantilla').reset();
            document.getElementById('template-id').value = '';
            document.getElementById('template-name').value = '';
            quillEditor.setText('');
            
            document.getElementById('modal-plantilla-title').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nueva Plantilla';
            
            document.getElementById('variables-list').innerHTML = '<span class="text-muted small">Ninguna variable detectada</span>';
            
            modalPlantilla.show();
        }

        // ==========================================
        // EDITAR PLANTILLA
        // ==========================================
        async function editarPlantilla(templateId) {
            try {
                mostrarLoading('Cargando plantilla...');
                
                modoEdicionPlantilla = true;
                plantillaEditando = plantillasCache.find(t => t.template_id === templateId);
                
                if (!plantillaEditando) {
                    showMessage('Plantilla no encontrada', 'danger');
                    return;
                }
                
                // Verificar que sea el creador
                if (plantillaEditando.created_by !== currentUser.user_id) {
                    showMessage('No tienes permiso para editar esta plantilla', 'warning');
                    return;
                }
                
                // Llenar formulario
                document.getElementById('template-id').value = plantillaEditando.template_id;
                document.getElementById('template-name').value = plantillaEditando.template_name;
                
                // Cargar contenido en Quill
                quillEditor.root.innerHTML = plantillaEditando.template_content;
                
                document.getElementById('modal-plantilla-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Plantilla';
                
                detectarVariables();
                
                modalPlantilla.show();
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error editando:', error);
                showMessage('Error al cargar plantilla: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // ELIMINAR PLANTILLA
        // ==========================================
        async function eliminarPlantilla(templateId) {
            try {
                const plantilla = plantillasCache.find(t => t.template_id === templateId);
                
                if (!plantilla) {
                    showMessage('Plantilla no encontrada', 'danger');
                    return;
                }
                
                // Verificar que sea el creador
                if (plantilla.created_by !== currentUser.user_id) {
                    showMessage('No tienes permiso para eliminar esta plantilla', 'warning');
                    return;
                }
                
                if (!confirm(`¬øEst√° seguro de eliminar la plantilla "${plantilla.template_name}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                    return;
                }
                
                mostrarLoading('Eliminando plantilla...');
                
                // Verificar si hay contratos asociados
                const contratos = await supabaseRequest('/generated_contracts?select=contract_id&template_id=eq.' + templateId + '&limit=1');
                
                if (contratos && contratos.length > 0) {
                    ocultarLoading();
                    showMessage('No se puede eliminar la plantilla porque tiene contratos generados', 'warning');
                    return;
                }
                
                // Soft delete
                await supabaseRequest('/contract_templates?template_id=eq.' + templateId, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: false })
                });
                
                showMessage('Plantilla eliminada exitosamente', 'success');
                await cargarPlantillas();
                actualizarMetricas();
                
            } catch (error) {
                console.error('‚ùå Error eliminando:', error);
                showMessage('Error al eliminar plantilla: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }

        // ==========================================
        // DETECTAR VARIABLES EN EDITOR
        // ==========================================
        function detectarVariables() {
            const content = quillEditor.root.innerHTML;
            const regex = /\$\$(.*?)\$\$/g;
            const matches = [];
            let match;
            
            while ((match = regex.exec(content)) !== null) {
                const varName = match[1].trim();
                if (varName && !matches.includes(varName)) {
                    matches.push(varName);
                }
            }
            
            const variablesList = document.getElementById('variables-list');
            
            if (matches.length === 0) {
                variablesList.innerHTML = '<span class="text-muted small">Ninguna variable detectada</span>';
            } else {
                variablesList.innerHTML = matches.map(v => 
                    `<span class="variable-badge me-2 mb-2 d-inline-block">$$${escapeHtml(v)}$$</span>`
                ).join('');
            }
            
            return matches;
        }

        // ==========================================
        // INSERTAR VARIABLE EN EDITOR
        // ==========================================
        function insertarVariable() {
            document.getElementById('variable-name').value = '';
            modalVariable.show();
        }

        function confirmarInsertarVariable() {
            const varName = document.getElementById('variable-name').value.trim();
            
            if (!varName) {
                showMessage('Ingresa un nombre para la variable', 'warning');
                return;
            }
            
            // Insertar en el cursor actual
            const range = quillEditor.getSelection(true);
            quillEditor.insertText(range.index, `$$${varName}$$`);
            
            modalVariable.hide();
            detectarVariables();
        }

        // ==========================================
        // LIMPIAR FORMATO DEL EDITOR
        // ==========================================
        function limpiarFormatoEditor() {
            if (!confirm('¬øDeseas eliminar todo el formato del texto y conservar solo el contenido?\n\nEsto mantendr√° las variables $$...$$')) {
                return;
            }
            
            // Obtener solo el texto plano
            const textoPlano = quillEditor.getText();
            
            // Limpiar el editor
            quillEditor.setText('');
            
            // Insertar el texto plano (esto mantiene las variables)
            quillEditor.setText(textoPlano);
            
            showMessage('Formato limpiado. Solo se conserv√≥ el texto plano.', 'info');
            detectarVariables();
        }

        
      // ==========================================
        // MANEJAR SUBMIT PLANTILLA
        // ==========================================
        async function manejarSubmitPlantilla(e) {
            e.preventDefault();
            
            try {
                mostrarLoading('Guardando plantilla...');
                
                const templateName = document.getElementById('template-name').value.trim();
                const templateContent = quillEditor.root.innerHTML;
                const templateId = document.getElementById('template-id').value;
                
                // Validar contenido
                if (quillEditor.getText().trim().length === 0) {
                    ocultarLoading();
                    showMessage('El contenido de la plantilla no puede estar vac√≠o', 'warning');
                    return;
                }
                
                // Detectar variables
                const variables = detectarVariables();
                
                // Validar nombre √∫nico
                const nombreExiste = plantillasCache.some(t => 
                    t.template_name.toLowerCase() === templateName.toLowerCase() && 
                    t.template_id !== templateId &&
                    t.is_active
                );
                
                if (nombreExiste) {
                    ocultarLoading();
                    showMessage('Ya existe una plantilla con ese nombre', 'warning');
                    return;
                }
                
                if (modoEdicionPlantilla) {
                    // ACTUALIZAR
                    await supabaseRequest('/contract_templates?template_id=eq.' + templateId, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            template_name: templateName,
                            template_content: templateContent,
                            template_variables: variables,
                            updated_at: new Date().toISOString()
                        })
                    });
                    
                    showMessage('Plantilla actualizada exitosamente', 'success');
                    
                } else {
                    // CREAR
                    await supabaseRequest('/contract_templates', {
                        method: 'POST',
                        body: JSON.stringify({
                            template_name: templateName,
                            template_content: templateContent,
                            template_variables: variables,
                            created_by: currentUser.user_id,
                            is_active: true
                        })
                    });
                    
                    showMessage('Plantilla creada exitosamente', 'success');
                }
                
                modalPlantilla.hide();
                await cargarPlantillas();
                actualizarMetricas();
                
            } catch (error) {
                console.error('‚ùå Error guardando plantilla:', error);
                showMessage('Error al guardar plantilla: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }

        // ==========================================
        // ABRIR MODAL GENERAR CONTRATO - CORREGIDO
        // ==========================================
        async function abrirModalGenerar(templateId) {
            try {
                mostrarLoading('Preparando formulario...');
                
                plantillaGenerando = plantillasCache.find(t => t.template_id === templateId);
                
                if (!plantillaGenerando) {
                    showMessage('Plantilla no encontrada', 'danger');
                    return;
                }
                
                // Configurar datos b√°sicos
                document.getElementById('gen-template-id').value = plantillaGenerando.template_id;
                document.getElementById('gen-template-name').textContent = plantillaGenerando.template_name;
                document.getElementById('gen-contract-name').value = '';
                document.getElementById('gen-notes').value = '';
                document.getElementById('gen-end-date').value = '';
                
                // Generar campos din√°micos para variables
                const variablesForm = document.getElementById('variables-form');
                const variables = plantillaGenerando.template_variables || [];
                
                console.log('üìã Variables detectadas:', variables); // DEBUG
                
                if (variables.length === 0) {
                    variablesForm.innerHTML = '<p class="text-muted">Esta plantilla no tiene variables definidas.</p>';
                } else {
                    variablesForm.innerHTML = variables.map(varName => {
                        // Limpiar el nombre de la variable
                        const varNameLower = varName.toLowerCase();
                        
                        // Detectar si debe ser textarea - CORREGIDO
                        const esTextoLargo = 
                            varNameLower.endsWith('_large') || 
                            varNameLower.endsWith('_largo') ||  // ‚Üê AGREGADO
                            varNameLower.endsWith('_texto') || 
                            varNameLower.includes('condicion') || 
                            varNameLower.includes('obligacion') ||  // ‚Üê AGREGADO
                            varNameLower.includes('descripcion') ||
                            varNameLower.includes('detalle') ||
                            varNameLower.includes('alcance') ||  // ‚Üê AGREGADO
                            varNameLower.includes('objeto');  // ‚Üê AGREGADO
                        
                        console.log(`  - ${varName}: ${esTextoLargo ? 'TEXTAREA' : 'INPUT'}`); // DEBUG
                        
                        // Crear label legible
                        const labelName = varName
                            .replace(/_large|_largo|_texto/gi, '')  // Remover sufijos
                            .replace(/_/g, ' ')  // Reemplazar guiones bajos por espacios
                            .split(' ')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                            .join(' ');
                        
                        if (esTextoLargo) {
                            // Campo TEXTAREA
                            return `
                                <div class="mb-3">
                                    <label for="var-${varName}" class="form-label">
                                        ${labelName} <span class="text-danger">*</span>
                                    </label>
                                    <textarea 
                                        class="form-control" 
                                        id="var-${varName}" 
                                        name="${varName}"
                                        required
                                        rows="5"
                                        placeholder="Ingrese ${labelName}..."
                                    ></textarea>
                                    <div class="form-text">Campo de texto largo</div>
                                </div>
                            `;
                        } else {
                            // Campo INPUT normal
                            return `
                                <div class="mb-3">
                                    <label for="var-${varName}" class="form-label">
                                        ${labelName} <span class="text-danger">*</span>
                                    </label>
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        id="var-${varName}" 
                                        name="${varName}"
                                        required
                                        placeholder="Ingrese ${labelName}..."
                                    >
                                </div>
                            `;
                        }
                    }).join('');
                }
                
                modalGenerar.show();
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error abriendo modal generar:', error);
                showMessage('Error al preparar formulario: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // MANEJAR SUBMIT GENERAR CONTRATO
        // ==========================================
        async function manejarSubmitGenerar(e) {
            e.preventDefault();
            
            try {
                mostrarLoading('Generando PDF...');
                
                const categoryId = document.getElementById('gen-category').value;
                const contractName = document.getElementById('gen-contract-name').value.trim();
                const notes = document.getElementById('gen-notes').value.trim();
                const endDate = document.getElementById('gen-end-date').value;

                if (!endDate) {
                    ocultarLoading();
                    showMessage('La fecha de finalizaci√≥n es obligatoria', 'warning');
                    return;
                }
                
                // Recopilar valores de variables
                const contractData = {};
                const variables = plantillaGenerando.template_variables || [];
                
                variables.forEach(varName => {
                    const input = document.getElementById('var-' + varName);
                    if (input) {
                        contractData[varName] = input.value.trim();
                    }
                });
                
                // Reemplazar variables en contenido
                let contenidoFinal = plantillaGenerando.template_content;
                
                Object.keys(contractData).forEach(varName => {
                    const regex = new RegExp(`\\$\\$${varName}\\$\\$`, 'g');
                    contenidoFinal = contenidoFinal.replace(regex, contractData[varName]);
                });
                
                // Generar PDF
                const pdfBlob = await generarPDF(contenidoFinal, contractName);
                
                // Subir a Supabase Storage
                const pdfUrl = await subirPDFAStorage(pdfBlob, contractName);
                
                // Guardar registro en BD
                await supabaseRequest('/generated_contracts', {
                    method: 'POST',
                    body: JSON.stringify({
                        template_id: plantillaGenerando.template_id,
                        category_id: categoryId,
                        contract_name: contractName,
                        contract_data: contractData,
                        pdf_url: pdfUrl,
                        generated_by: currentUser.user_id,
                        notes: notes || null,
                        contract_end_date: endDate  // ‚Üê AGREGAR ESTA L√çNEA
                    })
                });
                
                showMessage('Contrato generado exitosamente', 'success');
                
                modalGenerar.hide();
                await cargarMisContratos();
                actualizarMetricas();
                
            } catch (error) {
                console.error('‚ùå Error generando contrato:', error);
                showMessage('Error al generar contrato: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }

        // ==========================================
        // GENERAR PDF CON JSPDF
        // ==========================================
        async function generarPDF(htmlContent, title) {
            return new Promise(async (resolve, reject) => {
                try {
                    // Crear contenedor temporal
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = htmlContent;
                    tempDiv.style.width = '210mm'; // A4 width
                    tempDiv.style.padding = '20mm';
                    tempDiv.style.fontFamily = 'Arial, sans-serif';
                    tempDiv.style.fontSize = '12pt';
                    tempDiv.style.lineHeight = '1.6';
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    document.body.appendChild(tempDiv);
                    
                    // Usar html2canvas para convertir a imagen
                    const canvas = await html2canvas(tempDiv, {
                        scale: 2,
                        useCORS: true,
                        logging: false
                    });
                    
                    // Remover div temporal
                    document.body.removeChild(tempDiv);
                    
                    // Crear PDF con jsPDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 297; // A4 height in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    const imgData = canvas.toDataURL('image/png');
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    // Agregar p√°ginas adicionales si es necesario
                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    // Convertir a Blob
                    const pdfBlob = pdf.output('blob');
                    resolve(pdfBlob);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        // ==========================================
        // SUBIR PDF A SUPABASE STORAGE
        // ==========================================
        async function subirPDFAStorage(pdfBlob, contractName) {
            try {
                // Generar nombre √∫nico para el archivo
                const timestamp = Date.now();
                const cleanName = sanitizeFileName(contractName);
                const filePath = `${currentUser.user_id}/${timestamp}-${cleanName}.pdf`;
                
                console.log('üìÅ Ruta del archivo:', filePath);
                console.log('üì¶ Tama√±o del blob:', pdfBlob.size, 'bytes');
                
                // Usar la API de Supabase Storage correctamente
                const { data, error } = await window.supabase.storage
                    .from(BUCKET_NAME)
                    .upload(filePath, pdfBlob, {
                        contentType: 'application/pdf',
                        upsert: false
                    });
                
                if (error) {
                    console.error('‚ùå Error de Supabase Storage:', error);
                    throw new Error(error.message);
                }
                
                // Obtener URL p√∫blica
                const { data: urlData } = window.supabase.storage
                    .from(BUCKET_NAME)
                    .getPublicUrl(filePath);
                
                const publicUrl = urlData.publicUrl;
                
                console.log('‚úÖ PDF subido a Storage:', publicUrl);
                return publicUrl;
                
            } catch (error) {
                console.error('‚ùå Error subiendo PDF:', error);
                throw error;
            }
        }

        // ==========================================
        // VER PDF
        // ==========================================
        async function verPDF(contractId) {
            try {
                const contrato = misContratosCache.find(c => c.contract_id === contractId);
                
                if (!contrato) {
                    showMessage('Contrato no encontrado', 'danger');
                    return;
                }
                
                const pdfViewer = document.getElementById('pdf-viewer');
                const pdfTitle = document.getElementById('pdf-title');
                const downloadBtn = document.getElementById('pdf-download-btn');
                
                pdfTitle.textContent = contrato.contract_name;
                downloadBtn.href = contrato.pdf_url;
                downloadBtn.download = `${contrato.contract_name}.pdf`;
                
                pdfViewer.innerHTML = `<iframe src="${contrato.pdf_url}" width="100%" height="100%"></iframe>`;
                
                modalPdf.show();
                
            } catch (error) {
                console.error('‚ùå Error viendo PDF:', error);
                showMessage('Error al abrir PDF: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // DESCARGAR PDF
        // ==========================================
        async function descargarPDF(contractId) {
            try {
                const contrato = misContratosCache.find(c => c.contract_id === contractId);
                
                if (!contrato) {
                    showMessage('Contrato no encontrado', 'danger');
                    return;
                }
                
                // Crear link temporal y hacer click
                const a = document.createElement('a');
                a.href = contrato.pdf_url;
                a.download = `${contrato.contract_name}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showMessage('Descargando PDF...', 'info');
                
            } catch (error) {
                console.error('‚ùå Error descargando PDF:', error);
                showMessage('Error al descargar PDF: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // ELIMINAR CONTRATO
        // ==========================================
        async function eliminarContrato(contractId) {
            try {
                const contrato = misContratosCache.find(c => c.contract_id === contractId);
                
                if (!contrato) {
                    showMessage('Contrato no encontrado', 'danger');
                    return;
                }
                
                if (!confirm(`¬øEst√° seguro de eliminar el contrato "${contrato.contract_name}"?\n\nEsta acci√≥n eliminar√° tambi√©n el archivo PDF.`)) {
                    return;
                }
                
                mostrarLoading('Eliminando contrato...');
                
                // Eliminar archivo de Storage
                const fileName = contrato.pdf_url.split('/').pop();
                const filePath = `${currentUser.user_id}/${fileName}`;
                
                const deleteUrl = `${SUPABASE_CONFIG.url}/storage/v1/object/${BUCKET_NAME}/${filePath}`;
                
                await fetch(deleteUrl, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                    }
                });
                
                // Eliminar registro de BD
                await supabaseRequest('/generated_contracts?contract_id=eq.' + contractId, {
                    method: 'DELETE'
                });
                
                showMessage('Contrato eliminado exitosamente', 'success');
                await cargarMisContratos();
                actualizarMetricas();
                
            } catch (error) {
                console.error('‚ùå Error eliminando contrato:', error);
                showMessage('Error al eliminar contrato: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }

        // ==========================================
        // FILTROS
        // ==========================================
        function filtrarPlantillas() {
            const searchTerm = document.getElementById('search-templates').value.toLowerCase();
            
            const datosFiltrados = plantillasCache.filter(t => {
                const nombre = t.template_name?.toLowerCase() || '';
                return nombre.includes(searchTerm);
            });
            
            renderizarPlantillas(datosFiltrados);
        }

        function filtrarContratos() {
            const searchTerm = document.getElementById('search-contracts').value.toLowerCase();
            const categoryFilter = document.getElementById('filter-category').value;
            const templateFilter = document.getElementById('filter-template').value;
            
            const datosFiltrados = misContratosCache.filter(c => {
                const nombre = c.contract_name?.toLowerCase() || '';
                const matchSearch = nombre.includes(searchTerm);
                const matchCategory = !categoryFilter || c.category_id === categoryFilter;
                const matchTemplate = !templateFilter || c.template_id === templateFilter;
                
                return matchSearch && matchCategory && matchTemplate;
            });
            
            renderizarContratos(datosFiltrados);
        }

        function cargarPlantillasEnFiltro() {
            const filterTemplate = document.getElementById('filter-template');
            filterTemplate.innerHTML = '<option value="">Todas las plantillas</option>' +
                plantillasCache.map(t => `<option value="${t.template_id}">${escapeHtml(t.template_name)}</option>`).join('');
        }

        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading(texto = 'Procesando...') {
            document.getElementById('loading-text').textContent = texto;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function sanitizeFileName(name) {
            return name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        }

        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.abrirModalCrearPlantilla = abrirModalCrearPlantilla;
        window.editarPlantilla = editarPlantilla;
        window.eliminarPlantilla = eliminarPlantilla;
        window.abrirModalGenerar = abrirModalGenerar;
        window.insertarVariable = insertarVariable;
        window.confirmarInsertarVariable = confirmarInsertarVariable;
        window.verPDF = verPDF;
        window.descargarPDF = descargarPDF;
        window.eliminarContrato = eliminarContrato;
        window.cargarPlantillas = cargarPlantillas;
        window.cargarMisContratos = cargarMisContratos;
        window.filtrarPlantillas = filtrarPlantillas;
        window.filtrarContratos = filtrarContratos;
        window.limpiarFormatoEditor = limpiarFormatoEditor;
        
        console.log('‚úÖ contract-templates.html cargado correctamente');
    </script>
</body>
</html>
