<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA -->
    <meta name="page-version" content="25.01.15.09.48">
    
    <title>Proyectos - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Variables del m√≥dulo */
        :root {
            --module-primary: #6f42c1;
            --module-secondary: #563d7c;
            --module-light: #e2d9f3;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--module-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tarjetas de proyecto */
        .project-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
            height: 100%;
        }
        
        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .project-card .card-header {
            background: transparent;
            border-bottom: 1px solid #eee;
            padding: 1rem 1.25rem;
        }
        
        .project-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .project-title a {
            color: inherit;
            text-decoration: none;
        }
        
        .project-title a:hover {
            color: var(--module-primary);
        }
        
        /* Sem√°foro de salud */
        .health-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .health-critical {
            background-color: #dc3545;
            box-shadow: 0 0 6px rgba(220, 53, 69, 0.5);
        }
        
        .health-warning {
            background-color: #ffc107;
            box-shadow: 0 0 6px rgba(255, 193, 7, 0.5);
        }
        
        .health-healthy {
            background-color: #28a745;
            box-shadow: 0 0 6px rgba(40, 167, 69, 0.5);
        }
        
        /* Badges de estado */
        .badge-estado {
            font-size: 0.75rem;
            padding: 0.35rem 0.65rem;
            border-radius: 1rem;
        }
        
        .badge-activo {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-pausado {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .badge-completado {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .badge-cancelado {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* Badges de rol */
        .badge-rol {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
        }
        
        .badge-lider {
            background-color: var(--module-light);
            color: var(--module-primary);
        }
        
        .badge-colaborador {
            background-color: #e7f3ff;
            color: #0066cc;
        }
        
        .badge-observador {
            background-color: #f0f0f0;
            color: #666;
        }
        
        /* M√©tricas del proyecto */
        .project-metrics {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .metric-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .metric-item i {
            font-size: 1rem;
        }
        
        /* Barra de progreso de hitos */
        .milestones-progress {
            height: 6px;
            border-radius: 3px;
            background-color: #e9ecef;
            overflow: hidden;
        }
        
        .milestones-progress .progress-bar {
            background-color: var(--module-primary);
        }
        
        /* Info del l√≠der */
        .leader-info {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        /* Filtros */
        .filters-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        /* Contador de resultados */
        .results-count {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #dee2e6;
            margin-bottom: 1rem;
        }
        
        /* Fechas */
        .dates-info {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .project-metrics {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando proyectos...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Herramientas Generales</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Proyectos
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                    <div>
                        <h1 class="h3 mb-1">
                            <i class="bi bi-kanban me-2" style="color: var(--module-primary);"></i>
                            Proyectos
                        </h1>
                        <p class="text-muted mb-0">
                            Gesti√≥n de proyectos institucionales donde participas
                        </p>
                    </div>
                    <div id="header-actions">
                        <!-- Bot√≥n Nuevo Proyecto (se muestra seg√∫n permisos) -->
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- FILTROS -->
        <div class="card filters-card">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <!-- B√∫squeda -->
                    <div class="col-12 col-md-4">
                        <label for="filtro-busqueda" class="form-label small text-muted">Buscar proyecto</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="filtro-busqueda" 
                                   placeholder="Nombre del proyecto...">
                        </div>
                    </div>
                    
                    <!-- Estado -->
                    <div class="col-6 col-md-2">
                        <label for="filtro-estado" class="form-label small text-muted">Estado</label>
                        <select class="form-select" id="filtro-estado">
                            <option value="">Todos</option>
                            <option value="Activo" selected>Activos</option>
                            <option value="En Pausa">En Pausa</option>
                            <option value="Completado">Completados</option>
                            <option value="Cancelado">Cancelados</option>
                        </select>
                    </div>
                    
                    <!-- Mi rol -->
                    <div class="col-6 col-md-2">
                        <label for="filtro-rol" class="form-label small text-muted">Mi rol</label>
                        <select class="form-select" id="filtro-rol">
                            <option value="">Todos</option>
                            <option value="L√≠der">L√≠der</option>
                            <option value="Colaborador">Colaborador</option>
                            <option value="Observador">Observador</option>
                        </select>
                    </div>
                    
                    <!-- Salud -->
                    <div class="col-6 col-md-2">
                        <label for="filtro-salud" class="form-label small text-muted">Salud</label>
                        <select class="form-select" id="filtro-salud">
                            <option value="">Todas</option>
                            <option value="critical">üî¥ Cr√≠tico</option>
                            <option value="warning">üü° Atenci√≥n</option>
                            <option value="healthy">üü¢ Saludable</option>
                        </select>
                    </div>
                    
                    <!-- Botones -->
                    <div class="col-6 col-md-2">
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary flex-grow-1" onclick="limpiarFiltros()">
                                <i class="bi bi-x-circle"></i>
                            </button>
                            <button class="btn btn-primary flex-grow-1" onclick="cargarProyectos()">
                                <i class="bi bi-funnel"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTADOR DE RESULTADOS -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="results-count" id="results-count">Cargando proyectos...</span>
            <button class="btn btn-sm btn-outline-secondary" onclick="cargarProyectos()">
                <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
            </button>
        </div>

        <!-- LISTADO DE PROYECTOS -->
        <div class="row g-4" id="projects-container">
            <!-- Se cargan din√°micamente -->
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 text-muted">Cargando proyectos...</p>
            </div>
        </div>

    </div>

    <!-- MODAL CREAR/EDITAR PROYECTO -->
    <div class="modal fade" id="modal-proyecto" tabindex="-1" aria-labelledby="modalProyectoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalProyectoLabel">
                        <i class="bi bi-kanban me-2"></i>
                        <span id="modal-titulo">Nuevo Proyecto</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="form-proyecto">
                    <div class="modal-body">
                        <input type="hidden" id="proyecto-id">
                        
                        <!-- Nombre del proyecto -->
                        <div class="mb-3">
                            <label for="proyecto-nombre" class="form-label">
                                Nombre del Proyecto <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="proyecto-nombre" 
                                   name="project_name" required maxlength="200"
                                   placeholder="Ej: Implementaci√≥n de Sistema de Gesti√≥n Ambiental">
                        </div>
                        
                        <!-- Descripci√≥n -->
                        <div class="mb-3">
                            <label for="proyecto-descripcion" class="form-label">Descripci√≥n</label>
                            <textarea class="form-control" id="proyecto-descripcion" 
                                      name="project_description" rows="2"
                                      placeholder="Descripci√≥n general del proyecto (opcional)"></textarea>
                        </div>
                        
                        <!-- Prop√≥sito -->
                        <div class="mb-3">
                            <label for="proyecto-proposito" class="form-label">
                                Prop√≥sito <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="proyecto-proposito" 
                                      name="project_purpose" rows="2" required
                                      placeholder="¬øPor qu√© existe este proyecto? ¬øQu√© problema resuelve?"></textarea>
                        </div>
                        
                        <!-- Objetivo -->
                        <div class="mb-3">
                            <label for="proyecto-objetivo" class="form-label">
                                Objetivo <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="proyecto-objetivo" 
                                      name="project_objective" rows="2" required
                                      placeholder="¬øQu√© se espera lograr con este proyecto?"></textarea>
                        </div>
                        
                        <!-- Objetivo cuantificable -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="objetivo-cuantificable" onchange="toggleObjetivoCuantificable()">
                                <label class="form-check-label" for="objetivo-cuantificable">
                                    El objetivo es cuantificable (tiene meta num√©rica)
                                </label>
                            </div>
                        </div>
                        
                        <!-- Campos de objetivo cuantificable -->
                        <div id="campos-cuantificables" class="row mb-3" style="display: none;">
                            <div class="col-md-4">
                                <label for="objetivo-meta" class="form-label">Valor Meta</label>
                                <input type="number" class="form-control" id="objetivo-meta" 
                                       name="objective_target_value" step="0.01"
                                       placeholder="Ej: 100">
                            </div>
                            <div class="col-md-4">
                                <label for="objetivo-actual" class="form-label">Valor Actual</label>
                                <input type="number" class="form-control" id="objetivo-actual" 
                                       name="objective_current_value" step="0.01"
                                       placeholder="Ej: 25">
                            </div>
                            <div class="col-md-4">
                                <label for="objetivo-unidad" class="form-label">Unidad de Medida</label>
                                <input type="text" class="form-control" id="objetivo-unidad" 
                                       name="objective_unit" maxlength="50"
                                       placeholder="Ej: %, estudiantes, √°rboles">
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- L√≠der del proyecto -->
                        <div class="mb-3">
                            <label for="proyecto-lider" class="form-label">
                                L√≠der del Proyecto <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="proyecto-lider" name="leader_email" required>
                                <option value="">Seleccionar l√≠der...</option>
                            </select>
                            <div class="form-text">El l√≠der es el responsable principal del proyecto.</div>
                        </div>
                        
                        <!-- Fechas -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="proyecto-fecha-inicio" class="form-label">
                                    Fecha de Inicio <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="proyecto-fecha-inicio" 
                                       name="start_date" required>
                            </div>
                            <div class="col-md-6">
                                <label for="proyecto-fecha-fin" class="form-label">
                                    Fecha Esperada de Finalizaci√≥n <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="proyecto-fecha-fin" 
                                       name="expected_end_date" required>
                            </div>
                        </div>
                        
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" id="btn-guardar-proyecto">
                            <i class="bi bi-check-circle me-1"></i>Guardar Proyecto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let proyectosCache = [];
        let canCreateProject = false;
        let modalProyecto = null;
        let workersCache = [];
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando m√≥dulo de Proyectos...');
            
            try {
                mostrarLoading();
                
                // Validar acceso
                const hasAccess = await validatePageAccess('Proyectos');
                if (!hasAccess) return;
                
                console.log('‚úÖ Acceso permitido');
                
                // Obtener sesi√≥n
                const session = getStoredSession();
                if (!session || !session.user) {
                    showMessage('Sesi√≥n no v√°lida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '../../login.html', 2000);
                    return;
                }
                
                currentUser = session.user;
                console.log('üë§ Usuario:', currentUser.user_mail);
                
                // Verificar permiso para crear proyectos
                canCreateProject = await checkUserPermission(currentUser.user_id, 'Gestionar proyectos');
                configurarBotonNuevoProyecto();
                
                // Inicializar modal
                modalProyecto = new bootstrap.Modal(document.getElementById('modal-proyecto'));
                
                // Cargar workers para el selector de l√≠der
                await cargarWorkers();
                
                // Configurar formulario de proyecto
                configurarFormularioProyecto();
                
                // Configurar eventos de filtros
                configurarEventosFiltros();
                
                // Cargar proyectos
                await cargarProyectos();
                
                ocultarLoading();
                console.log('‚úÖ M√≥dulo de Proyectos inicializado');
                
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al cargar el m√≥dulo: ' + error.message, 'danger');
                ocultarLoading();
            }
        });
        
        // ==========================================
        // CONFIGURACI√ìN INICIAL
        // ==========================================
        function configurarBotonNuevoProyecto() {
            const headerActions = document.getElementById('header-actions');
            
            if (canCreateProject) {
                headerActions.innerHTML = `
                    <button class="btn btn-primary" onclick="abrirModalNuevoProyecto()">
                        <i class="bi bi-plus-circle me-2"></i>Nuevo Proyecto
                    </button>
                `;
            }
        }
        
        function configurarEventosFiltros() {
            // B√∫squeda con debounce
            let debounceTimer;
            document.getElementById('filtro-busqueda').addEventListener('input', function() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => filtrarProyectosLocal(), 300);
            });
            
            // Filtros de select
            ['filtro-estado', 'filtro-rol', 'filtro-salud'].forEach(id => {
                document.getElementById(id).addEventListener('change', filtrarProyectosLocal);
            });
        }
        
        // ==========================================
        // CARGA DE PROYECTOS
        // ==========================================
        async function cargarProyectos() {
            try {
                console.log('üì¶ Cargando proyectos...');
                
                const userEmail = currentUser.user_mail;
                
                // Cargar proyectos donde el usuario es l√≠der
                const projectsAsLeader = await supabaseRequest(
                    `/projects?select=*&leader_email=eq.${encodeURIComponent(userEmail)}&order=created_at.desc`
                );
                
                // Cargar proyectos donde el usuario es participante
                const participations = await supabaseRequest(
                    `/project_participants?select=project_id,participant_role,projects(*)&worker_email=eq.${encodeURIComponent(userEmail)}&participant_status=eq.active`
                );
                
                // Combinar y eliminar duplicados
                const projectsMap = new Map();
                
                // Agregar proyectos como l√≠der
                projectsAsLeader.forEach(p => {
                    projectsMap.set(p.project_id, {
                        ...p,
                        user_role: 'L√≠der'
                    });
                });
                
                // Agregar proyectos como participante
                participations.forEach(part => {
                    if (part.projects && !projectsMap.has(part.project_id)) {
                        projectsMap.set(part.project_id, {
                            ...part.projects,
                            user_role: part.participant_role
                        });
                    }
                });
                
                // Convertir a array
                proyectosCache = Array.from(projectsMap.values());
                
                // Cargar m√©tricas adicionales para cada proyecto
                await cargarMetricasProyectos();
                
                // Renderizar
                filtrarProyectosLocal();
                
                console.log(`‚úÖ ${proyectosCache.length} proyectos cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando proyectos:', error);
                showMessage('Error al cargar proyectos: ' + error.message, 'danger');
                mostrarEstadoVacio('Error al cargar los proyectos');
            }
        }
        
        async function cargarMetricasProyectos() {
            const today = getCurrentDateColombia();
            
            for (const proyecto of proyectosCache) {
                try {
                    // Cargar hitos
                    const hitos = await supabaseRequest(
                        `/project_milestones?select=milestone_id,milestone_status,committed_date&project_id=eq.${proyecto.project_id}`
                    );
                    
                    proyecto.milestones = {
                        total: hitos.length,
                        completed: hitos.filter(h => h.milestone_status === 'Cumplido').length,
                        overdue: hitos.filter(h => 
                            h.milestone_status === 'Pendiente' && 
                            h.committed_date < today
                        ).length,
                        dueSoon: hitos.filter(h => {
                            if (h.milestone_status !== 'Pendiente') return false;
                            const dueDate = new Date(h.committed_date);
                            const todayDate = new Date(today);
                            const diffDays = Math.ceil((dueDate - todayDate) / (1000 * 60 * 60 * 24));
                            return diffDays >= 0 && diffDays <= 7;
                        }).length
                    };
                    
                    // Cargar tareas
                    const tareas = await supabaseRequest(
                        `/tasks?select=task_id,task_status,task_due_date&module_type=eq.projects&reference_id=eq.${proyecto.project_id}`
                    );
                    
                    proyecto.tasks = {
                        total: tareas.length,
                        pending: tareas.filter(t => t.task_status === 'Pendiente' || t.task_status === 'En progreso').length,
                        overdue: tareas.filter(t => 
                            (t.task_status === 'Pendiente' || t.task_status === 'En progreso') && 
                            t.task_due_date && 
                            t.task_due_date < today
                        ).length
                    };
                    
                    // Calcular salud del proyecto
                    proyecto.health = calcularSaludProyecto(proyecto);
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Error cargando m√©tricas de proyecto ${proyecto.project_id}:`, error);
                    proyecto.milestones = { total: 0, completed: 0, overdue: 0, dueSoon: 0 };
                    proyecto.tasks = { total: 0, pending: 0, overdue: 0 };
                    proyecto.health = 'unknown';
                }
            }
        }
        
        // ==========================================
        // C√ÅLCULO DE SALUD DEL PROYECTO
        // ==========================================
        function calcularSaludProyecto(proyecto) {
            // Si el proyecto est√° completado o cancelado, no mostrar sem√°foro
            if (proyecto.project_status === 'Completado' || proyecto.project_status === 'Cancelado') {
                return 'completed';
            }
            
            const milestones = proyecto.milestones || {};
            const tasks = proyecto.tasks || {};
            
            // üî¥ CR√çTICO
            if (milestones.overdue > 0 || tasks.overdue > 3) {
                return 'critical';
            }
            
            // üü° ATENCI√ìN
            if (milestones.dueSoon > 0 || (tasks.overdue >= 1 && tasks.overdue <= 3)) {
                return 'warning';
            }
            
            // üü¢ SALUDABLE
            return 'healthy';
        }
        
        function getHealthClass(health) {
            const classes = {
                'critical': 'health-critical',
                'warning': 'health-warning',
                'healthy': 'health-healthy',
                'completed': 'health-healthy',
                'unknown': ''
            };
            return classes[health] || '';
        }
        
        function getHealthTooltip(health, proyecto) {
            const milestones = proyecto.milestones || {};
            const tasks = proyecto.tasks || {};
            
            switch (health) {
                case 'critical':
                    let reasons = [];
                    if (milestones.overdue > 0) reasons.push(`${milestones.overdue} hito(s) vencido(s)`);
                    if (tasks.overdue > 3) reasons.push(`${tasks.overdue} tareas atrasadas`);
                    return 'Cr√≠tico: ' + reasons.join(', ');
                case 'warning':
                    let warnings = [];
                    if (milestones.dueSoon > 0) warnings.push(`${milestones.dueSoon} hito(s) por vencer`);
                    if (tasks.overdue >= 1) warnings.push(`${tasks.overdue} tarea(s) atrasada(s)`);
                    return 'Atenci√≥n: ' + warnings.join(', ');
                case 'healthy':
                    return 'Proyecto saludable';
                case 'completed':
                    return 'Proyecto finalizado';
                default:
                    return '';
            }
        }
        
        // ==========================================
        // FILTRADO LOCAL
        // ==========================================
        function filtrarProyectosLocal() {
            const busqueda = document.getElementById('filtro-busqueda').value.toLowerCase().trim();
            const estado = document.getElementById('filtro-estado').value;
            const rol = document.getElementById('filtro-rol').value;
            const salud = document.getElementById('filtro-salud').value;
            
            let proyectosFiltrados = proyectosCache.filter(p => {
                // Filtro de b√∫squeda
                if (busqueda && !p.project_name.toLowerCase().includes(busqueda)) {
                    return false;
                }
                
                // Filtro de estado
                if (estado && p.project_status !== estado) {
                    return false;
                }
                
                // Filtro de rol
                if (rol && p.user_role !== rol) {
                    return false;
                }
                
                // Filtro de salud
                if (salud && p.health !== salud) {
                    return false;
                }
                
                return true;
            });
            
            renderizarProyectos(proyectosFiltrados);
        }
        
        function limpiarFiltros() {
            document.getElementById('filtro-busqueda').value = '';
            document.getElementById('filtro-estado').value = '';
            document.getElementById('filtro-rol').value = '';
            document.getElementById('filtro-salud').value = '';
            filtrarProyectosLocal();
        }
        
        // ==========================================
        // RENDERIZADO
        // ==========================================
        function renderizarProyectos(proyectos) {
            const container = document.getElementById('projects-container');
            const countElement = document.getElementById('results-count');
            
            // Actualizar contador
            countElement.textContent = `${proyectos.length} proyecto${proyectos.length !== 1 ? 's' : ''} encontrado${proyectos.length !== 1 ? 's' : ''}`;
            
            // Validar si hay proyectos
            if (proyectos.length === 0) {
                mostrarEstadoVacio('No se encontraron proyectos con los filtros seleccionados');
                return;
            }
            
            // Renderizar tarjetas
            container.innerHTML = proyectos.map(p => crearTarjetaProyecto(p)).join('');
        }
        
        function crearTarjetaProyecto(proyecto) {
            const milestones = proyecto.milestones || { total: 0, completed: 0 };
            const tasks = proyecto.tasks || { pending: 0 };
            const progressPercent = milestones.total > 0 
                ? Math.round((milestones.completed / milestones.total) * 100) 
                : 0;
            
            return `
                <div class="col-12 col-md-6 col-xl-4">
                    <div class="card project-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center gap-2">
                                    ${proyecto.health !== 'completed' && proyecto.health !== 'unknown' ? `
                                        <span class="health-indicator ${getHealthClass(proyecto.health)}" 
                                              title="${getHealthTooltip(proyecto.health, proyecto)}"></span>
                                    ` : ''}
                                    <span class="badge badge-estado ${getBadgeEstadoClass(proyecto.project_status)}">
                                        ${proyecto.project_status}
                                    </span>
                                </div>
                                <span class="badge badge-rol ${getBadgeRolClass(proyecto.user_role)}">
                                    ${proyecto.user_role}
                                </span>
                            </div>
                            <h5 class="project-title">
                                <a href="project-detail.html?id=${proyecto.project_id}">
                                    ${escapeHtml(proyecto.project_name)}
                                </a>
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Prop√≥sito -->
                            <p class="text-muted small mb-3" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                ${escapeHtml(proyecto.project_purpose || 'Sin descripci√≥n')}
                            </p>
                            
                            <!-- L√≠der -->
                            <div class="leader-info mb-3">
                                <i class="bi bi-person-badge me-1"></i>
                                <strong>L√≠der:</strong> ${escapeHtml(proyecto.leader_name)}
                            </div>
                            
                            <!-- Progreso de hitos -->
                            ${milestones.total > 0 ? `
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small text-muted">Hitos</span>
                                        <span class="small fw-semibold">${milestones.completed}/${milestones.total} (${progressPercent}%)</span>
                                    </div>
                                    <div class="milestones-progress">
                                        <div class="progress-bar" style="width: ${progressPercent}%"></div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- M√©tricas -->
                            <div class="project-metrics">
                                <div class="metric-item" title="Tareas pendientes">
                                    <i class="bi bi-check2-square"></i>
                                    <span>${tasks.pending} pendiente${tasks.pending !== 1 ? 's' : ''}</span>
                                </div>
                                ${milestones.overdue > 0 ? `
                                    <div class="metric-item text-danger" title="Hitos vencidos">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        <span>${milestones.overdue} vencido${milestones.overdue !== 1 ? 's' : ''}</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Fechas -->
                            <div class="dates-info mt-3 pt-3 border-top">
                                <div class="d-flex justify-content-between">
                                    <span>
                                        <i class="bi bi-calendar-event me-1"></i>
                                        Inicio: ${formatearFecha(proyecto.start_date)}
                                    </span>
                                    <span>
                                        <i class="bi bi-calendar-check me-1"></i>
                                        Fin: ${formatearFecha(proyecto.expected_end_date)}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-top-0 pt-0">
                            <a href="project-detail.html?id=${proyecto.project_id}" 
                               class="btn btn-sm btn-outline-primary w-100">
                                <i class="bi bi-eye me-1"></i>Ver Detalle
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getBadgeEstadoClass(estado) {
            const classes = {
                'Activo': 'badge-activo',
                'En Pausa': 'badge-pausado',
                'Completado': 'badge-completado',
                'Cancelado': 'badge-cancelado'
            };
            return classes[estado] || 'bg-secondary';
        }
        
        function getBadgeRolClass(rol) {
            const classes = {
                'L√≠der': 'badge-lider',
                'Colaborador': 'badge-colaborador',
                'Observador': 'badge-observador'
            };
            return classes[rol] || 'bg-secondary';
        }
        
        function mostrarEstadoVacio(mensaje) {
            const container = document.getElementById('projects-container');
            container.innerHTML = `
                <div class="col-12">
                    <div class="empty-state">
                        <i class="bi bi-folder2-open"></i>
                        <h5 class="text-muted">Sin proyectos</h5>
                        <p class="text-muted">${mensaje}</p>
                        ${canCreateProject ? `
                            <button class="btn btn-primary mt-2" onclick="abrirModalNuevoProyecto()">
                                <i class="bi bi-plus-circle me-2"></i>Crear Primer Proyecto
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay')?.classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay')?.classList.add('hidden');
        }
        
        function formatearFecha(fecha) {
            if (!fecha) return '-';
            const d = new Date(fecha + 'T00:00:00');
            return d.toLocaleDateString('es-CO', { 
                day: '2-digit', 
                month: 'short',
                year: 'numeric'
            });
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        /**
         * Obtiene la fecha actual en timezone de Colombia (UTC-5)
         */
        function getCurrentDateColombia() {
            const now = new Date();
            const colombiaOffset = -5 * 60;
            const localOffset = now.getTimezoneOffset();
            const colombiaTime = new Date(now.getTime() + (localOffset + colombiaOffset) * 60000);
            
            const year = colombiaTime.getFullYear();
            const month = String(colombiaTime.getMonth() + 1).padStart(2, '0');
            const day = String(colombiaTime.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }
        
        // ==========================================
        // FUNCIONES DEL MODAL DE PROYECTO
        // ==========================================
        
        async function cargarWorkers() {
            try {
                console.log('üë• Cargando workers...');
                
                const workers = await supabaseRequest(
                    `/workers?select=worker_id,email,worker_first_name,worker_last_name_1,worker_last_name_2&worker_status=eq.active&order=worker_last_name_1,worker_last_name_2,worker_first_name`
                );
                
                workersCache = workers;
                
                // Poblar selector de l√≠der
                const selectLider = document.getElementById('proyecto-lider');
                selectLider.innerHTML = '<option value="">Seleccionar l√≠der...</option>';
                
                workers.forEach(w => {
                    const nombreCompleto = formatWorkerName(w);
                    const option = document.createElement('option');
                    option.value = w.email;
                    option.textContent = nombreCompleto;
                    option.dataset.nombre = nombreCompleto;
                    selectLider.appendChild(option);
                });
                
                console.log(`‚úÖ ${workers.length} workers cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando workers:', error);
            }
        }
        
        function configurarFormularioProyecto() {
            const form = document.getElementById('form-proyecto');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                await guardarProyecto();
            });
            
            // Establecer fecha m√≠nima como hoy
            const hoy = getCurrentDateColombia();
            document.getElementById('proyecto-fecha-inicio').min = hoy;
            document.getElementById('proyecto-fecha-fin').min = hoy;
            
            // Validar que fecha fin sea mayor a fecha inicio
            document.getElementById('proyecto-fecha-inicio').addEventListener('change', function() {
                document.getElementById('proyecto-fecha-fin').min = this.value;
            });
        }
        
        function abrirModalNuevoProyecto() {
            limpiarFormularioProyecto();
            document.getElementById('modal-titulo').textContent = 'Nuevo Proyecto';
            document.getElementById('btn-guardar-proyecto').innerHTML = '<i class="bi bi-check-circle me-1"></i>Crear Proyecto';
            
            // Establecer fecha de inicio como hoy por defecto
            document.getElementById('proyecto-fecha-inicio').value = getCurrentDateColombia();
            
            modalProyecto.show();
        }
        
        function abrirModalEditarProyecto(projectId) {
            const proyecto = proyectosCache.find(p => p.project_id === projectId);
            if (!proyecto) {
                showMessage('Proyecto no encontrado', 'danger');
                return;
            }
            
            limpiarFormularioProyecto();
            
            document.getElementById('modal-titulo').textContent = 'Editar Proyecto';
            document.getElementById('btn-guardar-proyecto').innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar Cambios';
            
            // Llenar el formulario
            document.getElementById('proyecto-id').value = proyecto.project_id;
            document.getElementById('proyecto-nombre').value = proyecto.project_name || '';
            document.getElementById('proyecto-descripcion').value = proyecto.project_description || '';
            document.getElementById('proyecto-proposito').value = proyecto.project_purpose || '';
            document.getElementById('proyecto-objetivo').value = proyecto.project_objective || '';
            document.getElementById('proyecto-lider').value = proyecto.leader_email || '';
            document.getElementById('proyecto-fecha-inicio').value = proyecto.start_date || '';
            document.getElementById('proyecto-fecha-fin').value = proyecto.expected_end_date || '';
            
            // Objetivo cuantificable
            const esCuantificable = proyecto.objective_target_value !== null;
            document.getElementById('objetivo-cuantificable').checked = esCuantificable;
            toggleObjetivoCuantificable();
            
            if (esCuantificable) {
                document.getElementById('objetivo-meta').value = proyecto.objective_target_value || '';
                document.getElementById('objetivo-actual').value = proyecto.objective_current_value || '';
                document.getElementById('objetivo-unidad').value = proyecto.objective_unit || '';
            }
            
            modalProyecto.show();
        }
        
        function toggleObjetivoCuantificable() {
            const checkbox = document.getElementById('objetivo-cuantificable');
            const campos = document.getElementById('campos-cuantificables');
            
            if (checkbox.checked) {
                campos.style.display = 'flex';
            } else {
                campos.style.display = 'none';
                // Limpiar valores
                document.getElementById('objetivo-meta').value = '';
                document.getElementById('objetivo-actual').value = '';
                document.getElementById('objetivo-unidad').value = '';
            }
        }
        
        async function guardarProyecto() {
            const btn = document.getElementById('btn-guardar-proyecto');
            const textoOriginal = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';
                
                const projectId = document.getElementById('proyecto-id').value;
                const esEdicion = !!projectId;
                
                // Obtener datos del formulario
                const liderSelect = document.getElementById('proyecto-lider');
                const liderEmail = liderSelect.value;
                const liderNombre = liderSelect.options[liderSelect.selectedIndex].dataset.nombre || '';
                
                const esCuantificable = document.getElementById('objetivo-cuantificable').checked;
                
                const datos = {
                    project_name: document.getElementById('proyecto-nombre').value.trim(),
                    project_description: document.getElementById('proyecto-descripcion').value.trim() || null,
                    project_purpose: document.getElementById('proyecto-proposito').value.trim(),
                    project_objective: document.getElementById('proyecto-objetivo').value.trim(),
                    objective_target_value: esCuantificable ? parseFloat(document.getElementById('objetivo-meta').value) || null : null,
                    objective_current_value: esCuantificable ? parseFloat(document.getElementById('objetivo-actual').value) || null : null,
                    objective_unit: esCuantificable ? document.getElementById('objetivo-unidad').value.trim() || null : null,
                    leader_email: liderEmail,
                    leader_name: liderNombre,
                    start_date: document.getElementById('proyecto-fecha-inicio').value,
                    expected_end_date: document.getElementById('proyecto-fecha-fin').value,
                    updated_at: new Date().toISOString()
                };
                
                // Validaciones
                if (!datos.project_name) {
                    throw new Error('El nombre del proyecto es requerido');
                }
                
                if (!datos.leader_email) {
                    throw new Error('Debe seleccionar un l√≠der para el proyecto');
                }
                
                if (datos.start_date > datos.expected_end_date) {
                    throw new Error('La fecha de fin debe ser posterior a la fecha de inicio');
                }
                
                let resultado;
                
                if (esEdicion) {
                    // Actualizar proyecto existente
                    resultado = await supabaseRequest(
                        `/projects?project_id=eq.${projectId}`,
                        {
                            method: 'PATCH',
                            body: JSON.stringify(datos)
                        }
                    );
                    showMessage('Proyecto actualizado correctamente', 'success');
                } else {
                    // Crear nuevo proyecto
                    datos.project_status = 'Activo';
                    datos.created_by = currentUser.user_id;
                    datos.created_at = new Date().toISOString();
                    
                    resultado = await supabaseRequest(
                        '/projects',
                        {
                            method: 'POST',
                            body: JSON.stringify(datos)
                        }
                    );
                    
                    // Enviar notificaci√≥n al l√≠der si no es el usuario actual
                    if (liderEmail !== currentUser.user_mail) {
                        try {
                            await enviarNotificacionLider(liderEmail, liderNombre, datos.project_name);
                        } catch (notifError) {
                            console.warn('‚ö†Ô∏è No se pudo enviar notificaci√≥n:', notifError);
                        }
                    }
                    
                    showMessage('Proyecto creado correctamente', 'success');
                }
                
                modalProyecto.hide();
                await cargarProyectos();
                
            } catch (error) {
                console.error('‚ùå Error guardando proyecto:', error);
                showMessage('Error: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = textoOriginal;
            }
        }
        
        async function enviarNotificacionLider(email, nombre, nombreProyecto) {
            const subject = `Has sido asignado como l√≠der del proyecto: ${nombreProyecto}`;
            const htmlContent = `
                <h2>Nuevo Proyecto Asignado</h2>
                <p>Hola ${nombre},</p>
                <p>Has sido asignado como <strong>l√≠der</strong> del proyecto <strong>${nombreProyecto}</strong>.</p>
                <p>Como l√≠der, ser√°s responsable de:</p>
                <ul>
                    <li>Gestionar los participantes del proyecto</li>
                    <li>Definir y dar seguimiento a los hitos</li>
                    <li>Coordinar las tareas y actividades</li>
                    <li>Registrar las minutas de reuniones</li>
                </ul>
                <p>Puedes acceder al proyecto desde SchoolNet en el m√≥dulo de Herramientas Generales ‚Üí Proyectos.</p>
                <p>Saludos,<br>SchoolNet</p>
            `;
            
            await sendNotification(email, subject, htmlContent, false);
        }
        
        function limpiarFormularioProyecto() {
            document.getElementById('form-proyecto').reset();
            document.getElementById('proyecto-id').value = '';
            document.getElementById('objetivo-cuantificable').checked = false;
            document.getElementById('campos-cuantificables').style.display = 'none';
        }
        
        console.log('‚úÖ Script de Proyectos cargado');
    </script>
</body>
</html>
