<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentación de Especies - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSIÓN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .doc-link {
            color: #0d6efd;
            text-decoration: none;
        }
        
        .doc-link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Gestión Ambiental</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Documentación de Especies
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE PÁGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-book me-2"></i>
                    Documentación de Especies
                </h1>
                <p class="text-muted">
                    Enlaces educativos sobre especies, aportados por estudiantes y docentes
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- FILTRO POR ESPECIE -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <label for="filtro-especie" class="form-label">Filtrar por Especie</label>
                        <select class="form-select" id="filtro-especie" onchange="filtrarPorEspecie()">
                            <option value="">Todas las especies</option>
                        </select>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-primary" onclick="abrirModalCrear()">
                            <i class="bi bi-plus-circle me-1"></i>Agregar Enlace
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TARJETA PRINCIPAL -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-link-45deg me-2"></i>Enlaces Educativos
                </h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="actualizarDatos()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Especie</th>
                                <th>Título del Enlace</th>
                                <th>URL</th>
                                <th>Contribuyente</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando enlaces...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL CREAR/EDITAR ENLACE -->
    <div class="modal fade" id="modal-enlace" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title">
                        <i class="bi bi-plus-circle me-2"></i>Agregar Enlace Educativo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-enlace">
                    <div class="modal-body">
                        <input type="hidden" id="doc-id" name="doc_id">
                        
                        <div class="mb-3">
                            <label for="species-id" class="form-label">
                                Especie <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="species-id" name="species_id" required>
                                <option value="">Seleccione una especie...</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="doc-title" class="form-label">
                                Título del Enlace <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="doc-title" 
                                   name="doc_title" 
                                   required
                                   placeholder="Ej: Características del cedro en Colombia">
                        </div>
                        
                        <div class="mb-3">
                            <label for="doc-url" class="form-label">
                                URL del Enlace <span class="text-danger">*</span>
                            </label>
                            <input type="url" 
                                   class="form-control" 
                                   id="doc-url" 
                                   name="doc_url" 
                                   required
                                   placeholder="https://ejemplo.com/articulo">
                            <small class="text-muted">Debe ser una URL válida (http:// o https://)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="contributor-name" class="form-label">
                                Nombre del Contribuyente
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="contributor-name" 
                                   name="contributor_name"
                                   placeholder="Nombre del estudiante (opcional)">
                            <small class="text-muted">Opcional - Si fue aportado por un estudiante, registre su nombre aquí</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let enlacesCache = [];
        let especiesActivas = [];
        let modalInstance = null;
        let modoEdicion = false;
        let enlaceEditando = null;
        let currentUser = null;
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Documentación de especies');
                if (!hasAccess) {
                    console.log('❌ Acceso denegado - deteniendo inicialización');
                    return;
                }
                
                console.log('✅ Acceso permitido - continuando con inicialización');
                await inicializarPagina();
                
            } catch (error) {
                console.error('❌ Error en validación de acceso:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCIÓN DE INICIALIZACIÓN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Obtener usuario actual
                const session = getStoredSession();
                if (session && session.user) {
                    currentUser = session.user;
                }
                
                // Inicializar modal
                modalInstance = new bootstrap.Modal(document.getElementById('modal-enlace'));
                
                // Configurar event listener del formulario
                document.getElementById('form-enlace').addEventListener('submit', manejarSubmitFormulario);
                
                // Cargar especies activas
                await cargarEspeciesActivas();
                
                // Cargar enlaces
                await cargarEnlaces();
                
                ocultarLoading();
                console.log('✅ Página inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR ESPECIES ACTIVAS
        // ==========================================
        async function cargarEspeciesActivas() {
            try {
                console.log('📡 Cargando especies activas...');
                
                const datos = await supabaseRequest('/env_tree_species?select=species_id,species_name,scientific_name&species_status=eq.active&order=species_name.asc');
                
                especiesActivas = datos || [];
                
                // Poblar selectores
                const selectores = ['species-id', 'filtro-especie'];
                selectores.forEach(selectorId => {
                    const select = document.getElementById(selectorId);
                    const esFormulario = selectorId === 'species-id';
                    
                    if (!esFormulario) {
                        select.innerHTML = '<option value="">Todas las especies</option>';
                    } else {
                        select.innerHTML = '<option value="">Seleccione una especie...</option>';
                    }
                    
                    especiesActivas.forEach(especie => {
                        const option = document.createElement('option');
                        option.value = especie.species_id;
                        option.textContent = especie.species_name + 
                            (especie.scientific_name ? ` (${especie.scientific_name})` : '');
                        select.appendChild(option);
                    });
                });
                
                console.log(`✅ ${especiesActivas.length} especies activas cargadas`);
                
            } catch (error) {
                console.error('❌ Error cargando especies:', error);
                showMessage('Error al cargar especies: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // CARGAR ENLACES
        // ==========================================
        async function cargarEnlaces() {
            try {
                console.log('📡 Cargando enlaces...');
                
                const datos = await supabaseRequest('/env_species_documentation?select=*,env_tree_species(species_name,scientific_name)&order=created_at.desc');
                
                enlacesCache = datos || [];
                renderizarTabla(enlacesCache);
                
                console.log(`✅ ${enlacesCache.length} enlaces cargados`);
                
            } catch (error) {
                console.error('❌ Error cargando enlaces:', error);
                showMessage('Error al cargar enlaces: ' + error.message, 'danger');
                
                document.getElementById('tabla-body').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="bi bi-exclamation-triangle text-warning"></i>
                            <div class="mt-2">Error al cargar datos</div>
                        </td>
                    </tr>
                `;
            }
        }
        
        // ==========================================
        // RENDERIZAR TABLA
        // ==========================================
        function renderizarTabla(datos) {
            const tbody = document.getElementById('tabla-body');
            
            if (!datos || datos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="bi bi-inbox"></i>
                            <div class="mt-2">No hay enlaces registrados</div>
                            <button class="btn btn-sm btn-primary mt-2" onclick="abrirModalCrear()">
                                <i class="bi bi-plus-circle me-1"></i>Agregar Primer Enlace
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = datos.map(enlace => `
                <tr>
                    <td>
                        <strong>${escapeHtml(enlace.env_tree_species?.species_name || 'Especie eliminada')}</strong>
                        ${enlace.env_tree_species?.scientific_name ? '<br><small class="text-muted"><em>' + escapeHtml(enlace.env_tree_species.scientific_name) + '</em></small>' : ''}
                    </td>
                    <td>${escapeHtml(enlace.doc_title)}</td>
                    <td>
                        <a href="${escapeHtml(enlace.doc_url)}" 
                           target="_blank" 
                           rel="noopener noreferrer" 
                           class="doc-link">
                            <i class="bi bi-box-arrow-up-right me-1"></i>
                            Abrir enlace
                        </a>
                    </td>
                    <td>${enlace.contributor_name ? escapeHtml(enlace.contributor_name) : '<span class="text-muted">-</span>'}</td>
                    <td>${formatDate(enlace.created_at)}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" 
                                    onclick="editarEnlace('${enlace.doc_id}')" 
                                    title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" 
                                    onclick="confirmarEliminar('${enlace.doc_id}', '${escapeHtml(enlace.doc_title)}')" 
                                    title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // ==========================================
        // FILTRAR POR ESPECIE
        // ==========================================
        function filtrarPorEspecie() {
            const speciesId = document.getElementById('filtro-especie').value;
            
            if (!speciesId) {
                renderizarTabla(enlacesCache);
            } else {
                const datosFiltrados = enlacesCache.filter(e => e.species_id === speciesId);
                renderizarTabla(datosFiltrados);
            }
        }
        
        // ==========================================
        // ABRIR MODAL CREAR
        // ==========================================
        function abrirModalCrear() {
            modoEdicion = false;
            enlaceEditando = null;
            
            document.getElementById('modal-title').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Agregar Enlace Educativo';
            document.getElementById('form-enlace').reset();
            document.getElementById('doc-id').value = '';
            
            modalInstance.show();
        }
      // ==========================================
        // EDITAR ENLACE
        // ==========================================
        async function editarEnlace(docId) {
            try {
                mostrarLoading();
                
                const enlace = enlacesCache.find(e => e.doc_id === docId);
                
                if (!enlace) {
                    throw new Error('Enlace no encontrado');
                }
                
                modoEdicion = true;
                enlaceEditando = enlace;
                
                document.getElementById('modal-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Enlace Educativo';
                document.getElementById('doc-id').value = enlace.doc_id;
                document.getElementById('species-id').value = enlace.species_id;
                document.getElementById('doc-title').value = enlace.doc_title;
                document.getElementById('doc-url').value = enlace.doc_url;
                document.getElementById('contributor-name').value = enlace.contributor_name || '';
                
                ocultarLoading();
                modalInstance.show();
                
            } catch (error) {
                console.error('❌ Error cargando enlace:', error);
                showMessage('Error al cargar enlace: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // MANEJAR SUBMIT DEL FORMULARIO
        // ==========================================
        async function manejarSubmitFormulario(e) {
            e.preventDefault();
            
            try {
                mostrarLoading();
                
                const formData = new FormData(e.target);
                const datos = {
                    species_id: formData.get('species_id'),
                    doc_title: formData.get('doc_title').trim(),
                    doc_url: formData.get('doc_url').trim(),
                    contributor_name: formData.get('contributor_name')?.trim() || null
                };
                
                // Validaciones
                if (!datos.species_id) {
                    throw new Error('Debe seleccionar una especie');
                }
                
                if (!datos.doc_title) {
                    throw new Error('El título es obligatorio');
                }
                
                if (!datos.doc_url) {
                    throw new Error('La URL es obligatoria');
                }
                
                // Validar formato de URL
                if (!datos.doc_url.startsWith('http://') && !datos.doc_url.startsWith('https://')) {
                    throw new Error('La URL debe comenzar con http:// o https://');
                }
                
                if (modoEdicion) {
                    // ACTUALIZAR
                    const docId = document.getElementById('doc-id').value;
                    
                    await supabaseRequest('/env_species_documentation?doc_id=eq.' + docId, {
                        method: 'PATCH',
                        body: JSON.stringify(datos)
                    });
                    
                    showMessage('Enlace actualizado exitosamente', 'success');
                    
                } else {
                    // CREAR - Agregar usuario que lo creó
                    datos.added_by = currentUser ? currentUser.user_id : null;
                    
                    await supabaseRequest('/env_species_documentation', {
                        method: 'POST',
                        body: JSON.stringify(datos)
                    });
                    
                    showMessage('Enlace agregado exitosamente', 'success');
                }
                
                modalInstance.hide();
                await cargarEnlaces();
                
            } catch (error) {
                console.error('❌ Error guardando enlace:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CONFIRMAR ELIMINACIÓN
        // ==========================================
        function confirmarEliminar(docId, docTitle) {
            if (confirm(`¿Está seguro de eliminar el enlace "${docTitle}"?\n\nEsta acción no se puede deshacer.`)) {
                eliminarEnlace(docId);
            }
        }
        
        // ==========================================
        // ELIMINAR ENLACE (FÍSICO)
        // ==========================================
        async function eliminarEnlace(docId) {
            try {
                mostrarLoading();
                
                await supabaseRequest('/env_species_documentation?doc_id=eq.' + docId, {
                    method: 'DELETE'
                });
                
                showMessage('Enlace eliminado exitosamente', 'success');
                await cargarEnlaces();
                
            } catch (error) {
                console.error('❌ Error eliminando enlace:', error);
                showMessage('Error al eliminar: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function actualizarDatos() {
            cargarEnlaces();
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.abrirModalCrear = abrirModalCrear;
        window.editarEnlace = editarEnlace;
        window.confirmarEliminar = confirmarEliminar;
        window.filtrarPorEspecie = filtrarPorEspecie;
        window.actualizarDatos = actualizarDatos;
        
        console.log('✅ Documentación de Especies cargado correctamente');
    </script>
</body>
</html>
