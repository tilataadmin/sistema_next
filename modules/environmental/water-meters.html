<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Medidores de Agua - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Badges por tipo de medidor */
        .badge-fuente-captacion,
        .badge-fuente-acueducto {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-proceso-tratamiento {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .badge-salida-ptar {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .badge-area-consumo {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        /* Estado activo/inactivo */
        .badge-active {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-inactive {
            background-color: #e2e3e5;
            color: #6c757d;
        }
        
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Gesti√≥n Ambiental</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gestionar Medidores de Agua
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-speedometer me-2"></i>
                    Gestionar Medidores de Agua
                </h1>
                <p class="text-muted">
                    Cat√°logo de medidores de agua: fuentes, proceso, salida y √°reas de consumo
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- CONTROLES SUPERIORES -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="filtro-tipo" class="form-label">Filtrar por Tipo</label>
                        <select class="form-select" id="filtro-tipo">
                            <option value="">Todos los tipos</option>
                            <option value="fuente_captacion">Fuente - Captaci√≥n</option>
                            <option value="fuente_acueducto">Fuente - Acueducto</option>
                            <option value="proceso_tratamiento">Proceso - Tratamiento</option>
                            <option value="salida_ptar">Salida - PTAR</option>
                            <option value="area_consumo">√Årea - Consumo</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="filtro-frecuencia" class="form-label">Filtrar por Frecuencia</label>
                        <select class="form-select" id="filtro-frecuencia">
                            <option value="">Todas las frecuencias</option>
                            <option value="daily">Diaria</option>
                            <option value="monthly">Mensual</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="buscar" class="form-label">Buscar por Nombre</label>
                        <input type="text" class="form-control" id="buscar" placeholder="Buscar medidor...">
                    </div>
                    
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="abrirModalCrear()">
                            <i class="bi bi-plus-circle me-1"></i>Nuevo Medidor
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA DE MEDIDORES -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list me-2"></i>Medidores Registrados
                </h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="cargarMedidores()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tabla-medidores">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Nombre</th>
                                <th>Tipo</th>
                                <th>Frecuencia</th>
                                <th>Ubicaci√≥n</th>
                                <th style="width: 100px;">Estado</th>
                                <th style="width: 120px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body">
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando medidores...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    <!-- MODAL CREAR/EDITAR MEDIDOR -->
    <div class="modal fade" id="modal-medidor" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">
                        <i class="bi bi-plus-circle me-2"></i>Nuevo Medidor
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="formulario-medidor">
                    <div class="modal-body">
                        
                        <!-- Campo oculto para ID (al editar) -->
                        <input type="hidden" id="meter-id">
                        
                        <!-- Nombre del Medidor -->
                        <div class="mb-3">
                            <label for="meter-name" class="form-label">
                                Nombre del Medidor <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="meter-name" required>
                            <div class="invalid-feedback" id="name-error">
                                Este nombre ya est√° en uso
                            </div>
                        </div>
                        
                        <!-- Descripci√≥n -->
                        <div class="mb-3">
                            <label for="meter-description" class="form-label">
                                Descripci√≥n
                            </label>
                            <textarea class="form-control" id="meter-description" rows="2"></textarea>
                        </div>
                        
                        <!-- Tipo de Medidor -->
                        <div class="mb-3">
                            <label class="form-label">
                                Tipo de Medidor <span class="text-danger">*</span>
                            </label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="meter_type" id="tipo-fuente-captacion" value="fuente_captacion" required>
                                <label class="form-check-label" for="tipo-fuente-captacion">
                                    <span class="badge badge-fuente-captacion">Fuente - Captaci√≥n r√≠o</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="meter_type" id="tipo-fuente-acueducto" value="fuente_acueducto">
                                <label class="form-check-label" for="tipo-fuente-acueducto">
                                    <span class="badge badge-fuente-acueducto">Fuente - Acueducto veredal</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="meter_type" id="tipo-proceso-tratamiento" value="proceso_tratamiento">
                                <label class="form-check-label" for="tipo-proceso-tratamiento">
                                    <span class="badge badge-proceso-tratamiento">Proceso - Tratamiento</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="meter_type" id="tipo-salida-ptar" value="salida_ptar">
                                <label class="form-check-label" for="tipo-salida-ptar">
                                    <span class="badge badge-salida-ptar">Salida - PTAR</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="meter_type" id="tipo-area-consumo" value="area_consumo">
                                <label class="form-check-label" for="tipo-area-consumo">
                                    <span class="badge badge-area-consumo">√Årea - Consumo</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Frecuencia de Medici√≥n -->
                        <div class="mb-3">
                            <label class="form-label">
                                Frecuencia de Medici√≥n <span class="text-danger">*</span>
                            </label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="measurement_frequency" id="frecuencia-diaria" value="daily" required>
                                <label class="form-check-label" for="frecuencia-diaria">
                                    Diaria
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="measurement_frequency" id="frecuencia-mensual" value="monthly">
                                <label class="form-check-label" for="frecuencia-mensual">
                                    Mensual
                                </label>
                            </div>
                        </div>
                        
                        <!-- Descripci√≥n de Ubicaci√≥n -->
                        <div class="mb-3">
                            <label for="location-description" class="form-label">
                                Descripci√≥n de Ubicaci√≥n
                            </label>
                            <textarea class="form-control" id="location-description" rows="2" placeholder="Ej: Punto de captaci√≥n del r√≠o, junto al puente"></textarea>
                        </div>
                        
                        <!-- Coordenadas -->
                        <div class="mb-3">
                            <label class="form-label">
                                Coordenadas GPS (opcional)
                            </label>
                            <div class="row">
                                <div class="col-md-5">
                                    <input type="number" step="any" class="form-control" id="location-latitude" placeholder="Latitud (ej: 4.670)">
                                </div>
                                <div class="col-md-5">
                                    <input type="number" step="any" class="form-control" id="location-longitude" placeholder="Longitud (ej: -73.997)">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="obtenerUbicacion()" title="Obtener mi ubicaci√≥n">
                                        <i class="bi bi-geo-alt-fill"></i>
                                    </button>
                                </div>
                            </div>
                            <small class="text-muted">Haz clic en el bot√≥n para usar tu ubicaci√≥n actual</small>
                        </div>
                        
                        <!-- Estado Activo -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="is-active" checked>
                                <label class="form-check-label" for="is-active">
                                    Medidor activo
                                </label>
                            </div>
                        </div>
                        
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let medidoresCache = [];
        let modalInstance = null;
        let modoEdicion = false;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Gestionar medidores de agua');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Inicializar modal
                modalInstance = new bootstrap.Modal(document.getElementById('modal-medidor'));
                
                // Configurar event listeners
                configurarEventos();
                
                // Cargar datos iniciales
                await cargarMedidores();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CONFIGURACI√ìN DE EVENTOS
        // ==========================================
        function configurarEventos() {
            // Formulario
            document.getElementById('formulario-medidor').addEventListener('submit', manejarSubmitFormulario);
            
            // Filtros
            document.getElementById('filtro-tipo').addEventListener('change', filtrarTabla);
            document.getElementById('filtro-frecuencia').addEventListener('change', filtrarTabla);
            document.getElementById('buscar').addEventListener('input', filtrarTabla);
            
            // Validaci√≥n de nombre en tiempo real
            document.getElementById('meter-name').addEventListener('blur', validarNombreUnico);
            
            console.log('‚úÖ Event listeners configurados');
        }
        
        // ==========================================
        // CARGA DE MEDIDORES
        // ==========================================
        async function cargarMedidores() {
            try {
                console.log('üì° Cargando medidores...');
                
                // Query con orden por tipo y nombre
                const datos = await supabaseRequest('/env_water_meters?select=*&order=meter_type.asc,meter_name.asc');
                
                medidoresCache = datos || [];
                renderizarTabla(medidoresCache);
                
                console.log(`‚úÖ ${medidoresCache.length} medidores cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando medidores:', error);
                showMessage('Error al cargar medidores: ' + error.message, 'danger');
                
                document.getElementById('tabla-body').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-exclamation-triangle text-warning"></i>
                            <div class="mt-2">Error al cargar datos</div>
                        </td>
                    </tr>
                `;
            }
        }
        
        // ==========================================
        // RENDERIZADO DE TABLA
        // ==========================================
        function renderizarTabla(datos) {
            const tbody = document.getElementById('tabla-body');
            
            if (!datos || datos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-inbox"></i>
                            <div class="mt-2">No hay medidores registrados</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = datos.map((medidor, index) => {
                const tipoBadge = obtenerBadgeTipo(medidor.meter_type);
                const frecuenciaTexto = medidor.measurement_frequency === 'daily' ? 'Diaria' : 'Mensual';
                const estadoBadge = medidor.is_active 
                    ? '<span class="badge badge-active">Activo</span>'
                    : '<span class="badge badge-inactive">Inactivo</span>';
                const ubicacion = medidor.location_description || 
                    (medidor.location_latitude ? `${medidor.location_latitude}, ${medidor.location_longitude}` : '-');
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${escapeHtml(medidor.meter_name)}</strong></td>
                        <td>${tipoBadge}</td>
                        <td>${frecuenciaTexto}</td>
                        <td>${escapeHtml(ubicacion)}</td>
                        <td>${estadoBadge}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" 
                                        onclick="editarMedidor('${medidor.meter_id}')" 
                                        title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" 
                                        onclick="eliminarMedidor('${medidor.meter_id}')" 
                                        title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ==========================================
        // OBTENER BADGE POR TIPO
        // ==========================================
        function obtenerBadgeTipo(tipo) {
            const tipos = {
                'fuente_captacion': { texto: 'Fuente - Captaci√≥n', clase: 'badge-fuente-captacion' },
                'fuente_acueducto': { texto: 'Fuente - Acueducto', clase: 'badge-fuente-acueducto' },
                'proceso_tratamiento': { texto: 'Proceso - Tratamiento', clase: 'badge-proceso-tratamiento' },
                'salida_ptar': { texto: 'Salida - PTAR', clase: 'badge-salida-ptar' },
                'area_consumo': { texto: '√Årea - Consumo', clase: 'badge-area-consumo' }
            };
            
            const tipoInfo = tipos[tipo] || { texto: tipo, clase: 'badge-secondary' };
            return `<span class="badge ${tipoInfo.clase}">${tipoInfo.texto}</span>`;
        }
        
        // ==========================================
        // FILTRAR TABLA
        // ==========================================
        function filtrarTabla() {
            const filtroTipo = document.getElementById('filtro-tipo').value;
            const filtroFrecuencia = document.getElementById('filtro-frecuencia').value;
            const busqueda = document.getElementById('buscar').value.toLowerCase();
            
            const datosFiltrados = medidoresCache.filter(medidor => {
                const coincideTipo = !filtroTipo || medidor.meter_type === filtroTipo;
                const coincideFrecuencia = !filtroFrecuencia || medidor.measurement_frequency === filtroFrecuencia;
                const coincideBusqueda = !busqueda || 
                    medidor.meter_name.toLowerCase().includes(busqueda) ||
                    (medidor.meter_description && medidor.meter_description.toLowerCase().includes(busqueda));
                
                return coincideTipo && coincideFrecuencia && coincideBusqueda;
            });
            
            renderizarTabla(datosFiltrados);
        }
        
        // ==========================================
        // ABRIR MODAL PARA CREAR
        // ==========================================
        function abrirModalCrear() {
            modoEdicion = false;
            document.getElementById('modalLabel').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nuevo Medidor';
            document.getElementById('formulario-medidor').reset();
            document.getElementById('meter-id').value = '';
            document.getElementById('is-active').checked = true;
            document.getElementById('meter-name').classList.remove('is-invalid');
            modalInstance.show();
        }
        
        // ==========================================
        // EDITAR MEDIDOR
        // ==========================================
        async function editarMedidor(meterId) {
            try {
                modoEdicion = true;
                document.getElementById('modalLabel').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Medidor';
                
                const medidor = medidoresCache.find(m => m.meter_id === meterId);
                if (!medidor) {
                    showMessage('Medidor no encontrado', 'danger');
                    return;
                }
                
                // Llenar formulario
                document.getElementById('meter-id').value = medidor.meter_id;
                document.getElementById('meter-name').value = medidor.meter_name;
                document.getElementById('meter-description').value = medidor.meter_description || '';
                document.querySelector(`input[name="meter_type"][value="${medidor.meter_type}"]`).checked = true;
                document.querySelector(`input[name="measurement_frequency"][value="${medidor.measurement_frequency}"]`).checked = true;
                document.getElementById('location-description').value = medidor.location_description || '';
                document.getElementById('location-latitude').value = medidor.location_latitude || '';
                document.getElementById('location-longitude').value = medidor.location_longitude || '';
                document.getElementById('is-active').checked = medidor.is_active;
                
                modalInstance.show();
                
            } catch (error) {
                console.error('‚ùå Error editando medidor:', error);
                showMessage('Error al cargar datos del medidor', 'danger');
            }
        }
      // ==========================================
        // VALIDAR NOMBRE √öNICO
        // ==========================================
        async function validarNombreUnico() {
            const nombreInput = document.getElementById('meter-name');
            const nombre = nombreInput.value.trim();
            const meterId = document.getElementById('meter-id').value;
            
            if (!nombre) return true;
            
            try {
                let query = `/env_water_meters?select=meter_id&meter_name=eq.${encodeURIComponent(nombre)}`;
                
                // Si estamos editando, excluir el registro actual
                if (meterId) {
                    query += `&meter_id=neq.${meterId}`;
                }
                
                const datos = await supabaseRequest(query);
                
                if (datos && datos.length > 0) {
                    nombreInput.classList.add('is-invalid');
                    return false;
                } else {
                    nombreInput.classList.remove('is-invalid');
                    return true;
                }
                
            } catch (error) {
                console.error('‚ùå Error validando nombre:', error);
                return true; // En caso de error, permitir continuar
            }
        }
        
        // ==========================================
        // OBTENER UBICACI√ìN GPS
        // ==========================================
        function obtenerUbicacion() {
            if (!navigator.geolocation) {
                showMessage('Tu navegador no soporta geolocalizaci√≥n', 'warning');
                return;
            }
            
            showMessage('Obteniendo ubicaci√≥n...', 'info');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // Validar rango aproximado de Colombia
                    if (lat < -4 || lat > 13 || lon < -80 || lon > -66) {
                        showMessage('Advertencia: Las coordenadas parecen estar fuera de Colombia', 'warning');
                    }
                    
                    document.getElementById('location-latitude').value = lat.toFixed(8);
                    document.getElementById('location-longitude').value = lon.toFixed(8);
                    
                    showMessage('Ubicaci√≥n obtenida correctamente', 'success');
                },
                (error) => {
                    let mensaje = 'Error obteniendo ubicaci√≥n';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            mensaje = 'Permiso de ubicaci√≥n denegado. Act√≠valo en tu navegador.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            mensaje = 'Informaci√≥n de ubicaci√≥n no disponible.';
                            break;
                        case error.TIMEOUT:
                            mensaje = 'Tiempo de espera agotado al obtener ubicaci√≥n.';
                            break;
                    }
                    showMessage(mensaje, 'danger');
                }
            );
        }
        
        // ==========================================
        // MANEJAR SUBMIT DEL FORMULARIO
        // ==========================================
        async function manejarSubmitFormulario(e) {
            e.preventDefault();
            
            // Validar nombre √∫nico
            const nombreValido = await validarNombreUnico();
            if (!nombreValido) {
                showMessage('El nombre del medidor ya est√° en uso', 'danger');
                return;
            }
            
            try {
                mostrarLoading();
                
                const meterId = document.getElementById('meter-id').value;
                const meterType = document.querySelector('input[name="meter_type"]:checked').value;
                const frequency = document.querySelector('input[name="measurement_frequency"]:checked').value;
                
                const datos = {
                    meter_name: document.getElementById('meter-name').value.trim(),
                    meter_description: document.getElementById('meter-description').value.trim() || null,
                    meter_type: meterType,
                    measurement_frequency: frequency,
                    location_description: document.getElementById('location-description').value.trim() || null,
                    location_latitude: document.getElementById('location-latitude').value || null,
                    location_longitude: document.getElementById('location-longitude').value || null,
                    is_active: document.getElementById('is-active').checked
                };
                
                if (modoEdicion && meterId) {
                    // Actualizar
                    await supabaseRequest('/env_water_meters?meter_id=eq.' + meterId, {
                        method: 'PATCH',
                        body: JSON.stringify(datos)
                    });
                    showMessage('Medidor actualizado exitosamente', 'success');
                } else {
                    // Crear
                    await supabaseRequest('/env_water_meters', {
                        method: 'POST',
                        body: JSON.stringify(datos)
                    });
                    showMessage('Medidor creado exitosamente', 'success');
                }
                
                modalInstance.hide();
                await cargarMedidores();
                
            } catch (error) {
                console.error('‚ùå Error guardando medidor:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // ELIMINAR MEDIDOR (CON VALIDACI√ìN INTELIGENTE)
        // ==========================================
        async function eliminarMedidor(meterId) {
            try {
                const medidor = medidoresCache.find(m => m.meter_id === meterId);
                if (!medidor) {
                    showMessage('Medidor no encontrado', 'danger');
                    return;
                }
                
                mostrarLoading();
                
                // Verificar si tiene lecturas asociadas
                let tieneLecturas = false;
                let tipoLectura = '';
                
                // 1. Verificar lecturas mensuales
                const lecturasM = await supabaseRequest('/env_water_readings_monthly?select=reading_id&meter_id=eq.' + meterId + '&limit=1');
                if (lecturasM && lecturasM.length > 0) {
                    tieneLecturas = true;
                    tipoLectura = 'mensuales';
                }
                
                // 2. Verificar lecturas extraordinarias
                if (!tieneLecturas) {
                    const lecturasE = await supabaseRequest('/env_water_readings_extraordinary?select=reading_id&meter_id=eq.' + meterId + '&limit=1');
                    if (lecturasE && lecturasE.length > 0) {
                        tieneLecturas = true;
                        tipoLectura = 'extraordinarias';
                    }
                }
                
                ocultarLoading();
                
                if (tieneLecturas) {
                    // Solo desactivar
                    if (confirm(`Este medidor tiene lecturas ${tipoLectura} asociadas.\n\n¬øDeseas DESACTIVARLO en lugar de eliminarlo?\n\nPodr√°s reactivarlo despu√©s si es necesario.`)) {
                        mostrarLoading();
                        await supabaseRequest('/env_water_meters?meter_id=eq.' + meterId, {
                            method: 'PATCH',
                            body: JSON.stringify({ is_active: false })
                        });
                        showMessage('Medidor desactivado correctamente', 'info');
                        await cargarMedidores();
                        ocultarLoading();
                    }
                } else {
                    // Eliminar f√≠sicamente
                    if (confirm(`¬øEst√°s seguro de ELIMINAR el medidor "${medidor.meter_name}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                        mostrarLoading();
                        await supabaseRequest('/env_water_meters?meter_id=eq.' + meterId, {
                            method: 'DELETE'
                        });
                        showMessage('Medidor eliminado exitosamente', 'success');
                        await cargarMedidores();
                        ocultarLoading();
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error eliminando medidor:', error);
                showMessage('Error al eliminar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.abrirModalCrear = abrirModalCrear;
        window.editarMedidor = editarMedidor;
        window.eliminarMedidor = eliminarMedidor;
        window.cargarMedidores = cargarMedidores;
        window.obtenerUbicacion = obtenerUbicacion;
        
        console.log('üéâ water-meters.html cargado correctamente');
    </script>
</body>
</html>
