<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mediciones Extraordinarias - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Banner de Alarma Activa */
        .alert-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .alert-banner-critical {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .alert-banner-warning {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }
        
        .alert-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .alert-info-item {
            text-align: center;
        }
        
        .alert-info-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }
        
        .alert-info-value {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        /* Formulario de Registro */
        .register-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        /* Tabla de Historial */
        .history-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .history-table thead {
            background: #f8f9fa;
        }
        
        .history-table th {
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            color: #495057;
            padding: 1rem;
            border-bottom: 2px solid #dee2e6;
        }
        
        .history-table td {
            padding: 1rem;
            vertical-align: middle;
        }
        
        .history-table tbody tr {
            transition: background-color 0.2s;
        }
        
        .history-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Badges */
        .badge-critical {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #dc3545;
            padding: 0.35rem 0.65rem;
            border-radius: 0.25rem;
            font-size: 0.85rem;
        }
        
        .badge-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
            padding: 0.35rem 0.65rem;
            border-radius: 0.25rem;
            font-size: 0.85rem;
        }
        
        /* Filtros */
        .filters-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        /* Resumen Estad√≠stico */
        .summary-card {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin-top: 1rem;
        }
        
        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 0.5rem;
        }
        
        .summary-stat {
            text-align: center;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #00695c;
        }
        
        .summary-label {
            font-size: 0.85rem;
            color: #00695c;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .alert-info-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .history-table {
                font-size: 0.875rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Procesando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Gesti√≥n Ambiental</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Mediciones Extraordinarias
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-clipboard-data me-2"></i>
                    Mediciones Extraordinarias
                </h1>
                <p class="text-muted">
                    Registro de mediciones adicionales durante investigaci√≥n de alarmas h√≠dricas
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- BANNER DE ALARMA ACTIVA (si viene por URL) -->
        <div id="alert-banner" class="alert-banner" style="display: none;">
            <div class="d-flex align-items-start justify-content-between">
                <div class="flex-grow-1">
                    <h5 class="mb-2">
                        <i class="bi bi-search me-2"></i>
                        Investigando Alarma
                    </h5>
                    <div class="alert-info-grid">
                        <div class="alert-info-item">
                            <div class="alert-info-label">Fecha</div>
                            <div class="alert-info-value" id="banner-date">--</div>
                        </div>
                        <div class="alert-info-item">
                            <div class="alert-info-label">Tipo</div>
                            <div class="alert-info-value" id="banner-type">--</div>
                        </div>
                        <div class="alert-info-item">
                            <div class="alert-info-label">Diferencia</div>
                            <div class="alert-info-value" id="banner-diff">--</div>
                        </div>
                        <div class="alert-info-item">
                            <div class="alert-info-label">Mediciones</div>
                            <div class="alert-info-value" id="banner-count">0</div>
                        </div>
                    </div>
                </div>
                <div class="d-flex flex-column gap-2">
                    <button class="btn btn-light btn-sm" onclick="verAlarma()" id="btn-ver-alarma">
                        <i class="bi bi-eye me-1"></i>Ver Alarma
                    </button>
                    <button class="btn btn-success btn-sm" onclick="resolverAlarma()" id="btn-resolver-alarma">
                        <i class="bi bi-check-circle me-1"></i>Resolver
                    </button>
                </div>
            </div>
        </div>
        <!-- FORMULARIO DE REGISTRO -->
        <div class="register-card">
            <h5 class="mb-4">
                <i class="bi bi-plus-circle me-2"></i>
                Registrar Nueva Medici√≥n
            </h5>
            
            <form id="form-register">
                <div class="row g-3">
                    
                    <!-- Alarma -->
                    <div class="col-md-6">
                        <label for="select-alert" class="form-label">
                            Alarma en Investigaci√≥n <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="select-alert" required>
                            <option value="">-- Seleccionar alarma --</option>
                        </select>
                        <small class="text-muted">Solo alarmas en estado "Investigando"</small>
                    </div>
                    
                    <!-- Medidor de √Årea -->
                    <div class="col-md-6">
                        <label for="select-meter" class="form-label">
                            Medidor de √Årea <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="select-meter" required>
                            <option value="">-- Seleccionar medidor --</option>
                        </select>
                        <small class="text-muted">Solo medidores de √°reas de consumo</small>
                    </div>
                    
                    <!-- Fecha -->
                    <div class="col-md-4">
                        <label for="input-date" class="form-label">
                            Fecha <span class="text-danger">*</span>
                        </label>
                        <input type="date" 
                               class="form-control" 
                               id="input-date" 
                               required>
                        <small class="text-muted" id="date-validation"></small>
                    </div>
                    
                    <!-- Hora -->
                    <div class="col-md-4">
                        <label for="input-time" class="form-label">
                            Hora <span class="text-danger">*</span>
                        </label>
                        <input type="time" 
                               class="form-control" 
                               id="input-time" 
                               required>
                    </div>
                    
                    <!-- Lectura -->
                    <div class="col-md-4">
                        <label for="input-reading" class="form-label">
                            Lectura <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="number" 
                                   step="0.01" 
                                   min="0"
                                   class="form-control" 
                                   id="input-reading" 
                                   placeholder="0.00"
                                   required>
                            <span class="input-group-text">m¬≥</span>
                        </div>
                    </div>
                    
                    <!-- Observaciones -->
                    <div class="col-12">
                        <label for="input-notes" class="form-label">
                            Observaciones
                        </label>
                        <textarea class="form-control" 
                                  id="input-notes" 
                                  rows="2"
                                  placeholder="Ej: Fuga detectada en tuber√≠a principal del √°rea"></textarea>
                        <small class="text-muted">Describe hallazgos importantes durante la medici√≥n</small>
                    </div>
                    
                    <!-- Bot√≥n Guardar -->
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle me-2"></i>
                            Registrar Medici√≥n
                        </button>
                    </div>
                    
                </div>
            </form>
        </div>

        <!-- FILTROS -->
        <div class="filters-card">
            <h6 class="mb-3">
                <i class="bi bi-funnel me-2"></i>Filtros de Historial
            </h6>
            <div class="row g-3">
                
                <!-- Alarma -->
                <div class="col-md-3">
                    <label for="filter-alert" class="form-label">Alarma</label>
                    <select class="form-select" id="filter-alert">
                        <option value="">Todas</option>
                    </select>
                </div>
                
                <!-- √Årea -->
                <div class="col-md-3">
                    <label for="filter-meter" class="form-label">√Årea</label>
                    <select class="form-select" id="filter-meter">
                        <option value="">Todas</option>
                    </select>
                </div>
                
                <!-- Fecha Inicio -->
                <div class="col-md-2">
                    <label for="filter-date-start" class="form-label">Desde</label>
                    <input type="date" class="form-control" id="filter-date-start">
                </div>
                
                <!-- Fecha Fin -->
                <div class="col-md-2">
                    <label for="filter-date-end" class="form-label">Hasta</label>
                    <input type="date" class="form-control" id="filter-date-end">
                </div>
                
                <!-- Botones -->
                <div class="col-md-2 d-flex align-items-end gap-2">
                    <button class="btn btn-primary flex-fill" onclick="aplicarFiltros()">
                        <i class="bi bi-search me-1"></i>Filtrar
                    </button>
                    <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
                
            </div>
        </div>

        <!-- TABLA DE HISTORIAL -->
        <div class="card history-table">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>Historial de Mediciones Extraordinarias
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 15%;">Fecha/Hora</th>
                                <th style="width: 15%;">Alarma</th>
                                <th style="width: 20%;">√Årea</th>
                                <th style="width: 12%;">Lectura (m¬≥)</th>
                                <th style="width: 25%;">Observaciones</th>
                                <th style="width: 13%;">Registrado Por</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando historial...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- RESUMEN ESTAD√çSTICO -->
        <div class="summary-card">
            <h6 class="mb-2">üìä Resumen</h6>
            <div class="summary-stats">
                <div class="summary-stat">
                    <div class="summary-value" id="summary-total">0</div>
                    <div class="summary-label">Total Mediciones</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-value" id="summary-alerts">0</div>
                    <div class="summary-label">Alarmas con Mediciones</div>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let alertIdFromURL = null;
        let alarmaActual = null;
        let todasLasMediciones = [];
        let medicionesFiltradas = [];
        let alarmasInvestigando = [];
        let medidoresAreas = [];
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Registrar mediciones extraordinarias');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Obtener usuario actual
                const session = getStoredSession();
                if (session && session.user) {
                    currentUser = session.user;
                }
                
                // Verificar si viene alert_id por URL
                const urlParams = new URLSearchParams(window.location.search);
                alertIdFromURL = urlParams.get('alert_id');
                
                // Configurar fecha y hora actuales
                const hoy = new Date();
                document.getElementById('input-date').value = hoy.toISOString().split('T')[0];
                document.getElementById('input-time').value = hoy.toTimeString().slice(0, 5);
                
                // Configurar fechas de filtros (√∫ltimo mes)
                const haceUnMes = new Date();
                haceUnMes.setMonth(haceUnMes.getMonth() - 1);
                document.getElementById('filter-date-start').value = haceUnMes.toISOString().split('T')[0];
                document.getElementById('filter-date-end').value = hoy.toISOString().split('T')[0];
                
                // Cargar datos
                await cargarAlarmasInvestigando();
                await cargarMedidoresAreas();
                await cargarHistorial();
                
                // Si viene alert_id, cargar info del banner
                if (alertIdFromURL) {
                    await cargarBannerAlarma();
                }
                
                // Configurar event listeners
                configurarEventListeners();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
      // ==========================================
        // CARGAR ALARMAS EN INVESTIGACI√ìN
        // ==========================================
        async function cargarAlarmasInvestigando() {
            try {
                console.log('üì° Cargando alarmas en investigaci√≥n...');
                
                const alarmas = await supabaseRequest('/env_water_alerts?select=*&alert_status=eq.investigating&order=alert_date.desc');
                
                alarmasInvestigando = alarmas || [];
                
                console.log(`‚úÖ ${alarmasInvestigando.length} alarmas en investigaci√≥n`);
                
                // Llenar dropdown de registro
                const selectAlert = document.getElementById('select-alert');
                selectAlert.innerHTML = '<option value="">-- Seleccionar alarma --</option>';
                
                alarmasInvestigando.forEach(alarma => {
                    const fecha = new Date(alarma.alert_date).toLocaleDateString('es-CO');
                    const tipo = alarma.alert_type === 'critical' ? 'üî¥' : 'üü°';
                    const diff = alarma.diferencia_porcentaje.toFixed(1);
                    
                    const option = document.createElement('option');
                    option.value = alarma.alert_id;
                    option.textContent = `${fecha} ${tipo} (${diff}%)`;
                    selectAlert.appendChild(option);
                });
                
                // Llenar dropdown de filtros
                const filterAlert = document.getElementById('filter-alert');
                filterAlert.innerHTML = '<option value="">Todas</option>';
                
                alarmasInvestigando.forEach(alarma => {
                    const fecha = new Date(alarma.alert_date).toLocaleDateString('es-CO');
                    const tipo = alarma.alert_type === 'critical' ? 'üî¥' : 'üü°';
                    
                    const option = document.createElement('option');
                    option.value = alarma.alert_id;
                    option.textContent = `${fecha} ${tipo}`;
                    filterAlert.appendChild(option);
                });
                
                // Si viene alert_id por URL, pre-seleccionar
                if (alertIdFromURL) {
                    selectAlert.value = alertIdFromURL;
                    filterAlert.value = alertIdFromURL;
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando alarmas:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR MEDIDORES DE √ÅREAS
        // ==========================================
        async function cargarMedidoresAreas() {
            try {
                console.log('üì° Cargando medidores de √°reas...');
                
                const medidores = await supabaseRequest('/env_water_meters?select=*&meter_type=eq.area_consumo&is_active=eq.true&order=meter_name.asc');
                
                medidoresAreas = medidores || [];
                
                console.log(`‚úÖ ${medidoresAreas.length} medidores de √°reas cargados`);
                
                // Llenar dropdown de registro
                const selectMeter = document.getElementById('select-meter');
                selectMeter.innerHTML = '<option value="">-- Seleccionar medidor --</option>';
                
                medidoresAreas.forEach(medidor => {
                    const option = document.createElement('option');
                    option.value = medidor.meter_id;
                    option.textContent = medidor.meter_name;
                    selectMeter.appendChild(option);
                });
                
                // Llenar dropdown de filtros
                const filterMeter = document.getElementById('filter-meter');
                filterMeter.innerHTML = '<option value="">Todas</option>';
                
                medidoresAreas.forEach(medidor => {
                    const option = document.createElement('option');
                    option.value = medidor.meter_id;
                    option.textContent = medidor.meter_name;
                    filterMeter.appendChild(option);
                });
                
            } catch (error) {
                console.error('‚ùå Error cargando medidores:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR BANNER DE ALARMA
        // ==========================================
        async function cargarBannerAlarma() {
            try {
                const alarma = alarmasInvestigando.find(a => a.alert_id === alertIdFromURL);
                
                if (!alarma) {
                    console.warn('‚ö†Ô∏è Alarma no encontrada o no est√° en investigaci√≥n');
                    return;
                }
                
                alarmaActual = alarma;
                
                // Mostrar banner
                const banner = document.getElementById('alert-banner');
                banner.style.display = 'block';
                
                // Aplicar clase seg√∫n tipo
                if (alarma.alert_type === 'critical') {
                    banner.classList.add('alert-banner-critical');
                } else {
                    banner.classList.add('alert-banner-warning');
                }
                
                // Llenar informaci√≥n
                const fecha = new Date(alarma.alert_date);
                document.getElementById('banner-date').textContent = fecha.toLocaleDateString('es-CO', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                
                document.getElementById('banner-type').textContent = 
                    alarma.alert_type === 'critical' ? 'üî¥ Cr√≠tica' : 'üü° Advertencia';
                
                document.getElementById('banner-diff').textContent = 
                    `${alarma.diferencia_porcentaje >= 0 ? '+' : ''}${alarma.diferencia_porcentaje.toFixed(1)}%`;
                
                document.getElementById('banner-count').textContent = alarma.extraordinary_readings_count || 0;
                
                console.log('‚úÖ Banner de alarma cargado');
                
            } catch (error) {
                console.error('‚ùå Error cargando banner:', error);
            }
        }
        
        // ==========================================
        // CONFIGURAR EVENT LISTENERS
        // ==========================================
        function configurarEventListeners() {
            // Submit del formulario
            document.getElementById('form-register').addEventListener('submit', manejarSubmit);
            
            // Validar fecha en tiempo real
            document.getElementById('input-date').addEventListener('change', validarFecha);
            document.getElementById('select-meter').addEventListener('change', validarDuplicado);
            
            console.log('‚úÖ Event listeners configurados');
        }
        
        // ==========================================
        // VALIDAR FECHA
        // ==========================================
        function validarFecha() {
            const inputDate = document.getElementById('input-date');
            const dateValidation = document.getElementById('date-validation');
            const fechaSeleccionada = new Date(inputDate.value);
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            if (fechaSeleccionada > hoy) {
                dateValidation.innerHTML = '<span class="text-danger">‚ö†Ô∏è No se pueden registrar mediciones futuras</span>';
                inputDate.setCustomValidity('Fecha no v√°lida');
                return false;
            } else {
                dateValidation.innerHTML = '<span class="text-success">‚úì Fecha v√°lida</span>';
                inputDate.setCustomValidity('');
                return true;
            }
        }
        
        // ==========================================
        // VALIDAR DUPLICADO
        // ==========================================
        async function validarDuplicado() {
            const alertId = document.getElementById('select-alert').value;
            const meterId = document.getElementById('select-meter').value;
            const fecha = document.getElementById('input-date').value;
            
            if (!alertId || !meterId || !fecha) return true;
            
            try {
                // Verificar si ya existe medici√≥n del mismo medidor en la misma fecha
                const existente = await supabaseRequest(`/env_water_readings_extraordinary?select=reading_id&meter_id=eq.${meterId}&reading_date=eq.${fecha}&limit=1`);
                
                if (existente && existente.length > 0) {
                    showMessage('Ya existe una medici√≥n de este medidor en esta fecha', 'warning');
                    return false;
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error validando duplicado:', error);
                return true; // Permitir continuar en caso de error
            }
        }
        
        // ==========================================
        // MANEJAR SUBMIT
        // ==========================================
        async function manejarSubmit(e) {
            e.preventDefault();
            
            try {
                // Validar fecha
                if (!validarFecha()) {
                    showMessage('Por favor corrige la fecha antes de continuar', 'danger');
                    return;
                }
                
                // Validar duplicado
                const esDuplicado = await validarDuplicado();
                if (!esDuplicado) {
                    return;
                }
                
                mostrarLoading();
                
                const alertId = document.getElementById('select-alert').value;
                const meterId = document.getElementById('select-meter').value;
                const fecha = document.getElementById('input-date').value;
                const hora = document.getElementById('input-time').value;
                const lectura = parseFloat(document.getElementById('input-reading').value);
                const notas = document.getElementById('input-notes').value.trim() || null;
                
                // Guardar medici√≥n
                await supabaseRequest('/env_water_readings_extraordinary', {
                    method: 'POST',
                    body: JSON.stringify({
                        alert_id: alertId,
                        meter_id: meterId,
                        reading_date: fecha,
                        reading_time: hora,
                        reading_value: lectura,
                        notes: notas,
                        recorded_by: currentUser.user_id
                    })
                });
                
                console.log('‚úÖ Medici√≥n guardada');
                
                // Incrementar contador en la alarma
                await supabaseRequest(`/env_water_alerts?alert_id=eq.${alertId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        extraordinary_readings_count: alarmasInvestigando.find(a => a.alert_id === alertId).extraordinary_readings_count + 1 || 1
                    })
                });
                
                console.log('‚úÖ Contador actualizado');
                
                showMessage('‚úÖ Medici√≥n registrada exitosamente', 'success');
                
                // Limpiar formulario
                document.getElementById('form-register').reset();
                document.getElementById('input-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('input-time').value = new Date().toTimeString().slice(0, 5);
                
                // Si hab√≠a alert_id pre-seleccionado, mantenerlo
                if (alertIdFromURL) {
                    document.getElementById('select-alert').value = alertIdFromURL;
                }
                
                // Recargar datos
                await cargarAlarmasInvestigando();
                await cargarHistorial();
                
                // Actualizar banner si aplica
                if (alertIdFromURL) {
                    await cargarBannerAlarma();
                }
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error guardando medici√≥n:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
      // ==========================================
        // CARGAR HISTORIAL
        // ==========================================
        async function cargarHistorial() {
            try {
                console.log('üì° Cargando historial de mediciones...');
                
                // Obtener rango de fechas de los filtros
                const fechaInicio = document.getElementById('filter-date-start').value;
                const fechaFin = document.getElementById('filter-date-end').value;
                
                let query = '/env_water_readings_extraordinary?select=*,env_water_alerts(alert_date,alert_type,diferencia_porcentaje),env_water_meters(meter_name),users(user_display_name)&order=reading_date.desc,reading_time.desc';
                
                if (fechaInicio && fechaFin) {
                    query += `&reading_date=gte.${fechaInicio}&reading_date=lte.${fechaFin}`;
                }
                
                const mediciones = await supabaseRequest(query);
                
                todasLasMediciones = mediciones || [];
                medicionesFiltradas = [...todasLasMediciones];
                
                console.log(`‚úÖ ${todasLasMediciones.length} mediciones cargadas`);
                
                // Renderizar tabla
                renderizarTabla();
                
                // Actualizar resumen
                actualizarResumen();
                
            } catch (error) {
                console.error('‚ùå Error cargando historial:', error);
                showMessage('Error al cargar historial: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // RENDERIZAR TABLA
        // ==========================================
        function renderizarTabla() {
            const tbody = document.getElementById('history-table-body');
            
            if (medicionesFiltradas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <h6>No hay mediciones extraordinarias</h6>
                                <p class="mb-0">Las mediciones se registran durante la investigaci√≥n de alarmas</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = medicionesFiltradas.map(medicion => {
                // Fecha y hora
                const fecha = new Date(medicion.reading_date);
                const fechaFormateada = fecha.toLocaleDateString('es-CO', { 
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                const horaFormateada = medicion.reading_time.slice(0, 5);
                
                // Alarma
                const alarmaFecha = new Date(medicion.env_water_alerts.alert_date).toLocaleDateString('es-CO', {
                    day: '2-digit',
                    month: 'short'
                });
                const alarmaTipo = medicion.env_water_alerts.alert_type === 'critical' 
                    ? '<span class="badge badge-critical">üî¥ Cr√≠tica</span>'
                    : '<span class="badge badge-warning">üü° Advertencia</span>';
                const alarmaDiff = medicion.env_water_alerts.diferencia_porcentaje.toFixed(1);
                
                // √Årea
                const areaNombre = medicion.env_water_meters.meter_name;
                
                // Lectura
                const lecturaFormateada = formatearNumero(medicion.reading_value);
                
                // Observaciones
                const observaciones = medicion.notes 
                    ? `<small>${escapeHtml(medicion.notes)}</small>`
                    : '<small class="text-muted">Sin observaciones</small>';
                
                // Usuario
                const usuario = medicion.users?.user_display_name || 'Sistema';
                
                return `
                    <tr>
                        <td>
                            <strong>${fechaFormateada}</strong><br>
                            <small class="text-muted">${horaFormateada}</small>
                        </td>
                        <td>
                            ${alarmaTipo}<br>
                            <small class="text-muted">${alarmaFecha} (${alarmaDiff}%)</small>
                        </td>
                        <td>
                            <i class="bi bi-building me-1"></i>${escapeHtml(areaNombre)}
                        </td>
                        <td class="text-end">
                            <strong>${lecturaFormateada}</strong>
                        </td>
                        <td>${observaciones}</td>
                        <td>
                            <small><i class="bi bi-person me-1"></i>${escapeHtml(usuario)}</small>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ==========================================
        // ACTUALIZAR RESUMEN
        // ==========================================
        function actualizarResumen() {
            const totalMediciones = medicionesFiltradas.length;
            
            // Contar alarmas √∫nicas
            const alarmasUnicas = new Set(medicionesFiltradas.map(m => m.alert_id));
            const totalAlarmas = alarmasUnicas.size;
            
            document.getElementById('summary-total').textContent = totalMediciones;
            document.getElementById('summary-alerts').textContent = totalAlarmas;
        }
        
        // ==========================================
        // APLICAR FILTROS
        // ==========================================
        function aplicarFiltros() {
            const alertId = document.getElementById('filter-alert').value;
            const meterId = document.getElementById('filter-meter').value;
            
            medicionesFiltradas = todasLasMediciones.filter(medicion => {
                let cumpleAlarma = true;
                let cumpleMedidor = true;
                
                if (alertId) {
                    cumpleAlarma = medicion.alert_id === alertId;
                }
                
                if (meterId) {
                    cumpleMedidor = medicion.meter_id === meterId;
                }
                
                return cumpleAlarma && cumpleMedidor;
            });
            
            console.log(`üîç Filtros aplicados: ${medicionesFiltradas.length} mediciones`);
            
            renderizarTabla();
            actualizarResumen();
        }
        
        // ==========================================
        // LIMPIAR FILTROS
        // ==========================================
        function limpiarFiltros() {
            document.getElementById('filter-alert').value = '';
            document.getElementById('filter-meter').value = '';
            
            const hoy = new Date();
            const haceUnMes = new Date();
            haceUnMes.setMonth(haceUnMes.getMonth() - 1);
            
            document.getElementById('filter-date-start').value = haceUnMes.toISOString().split('T')[0];
            document.getElementById('filter-date-end').value = hoy.toISOString().split('T')[0];
            
            // Mantener filtro de alarma si viene por URL
            if (alertIdFromURL) {
                document.getElementById('filter-alert').value = alertIdFromURL;
            }
            
            cargarHistorial();
        }
        
        // ==========================================
        // VER ALARMA
        // ==========================================
        function verAlarma() {
            if (!alertIdFromURL) return;
            window.location.href = `water-alerts.html?alert_id=${alertIdFromURL}`;
        }
        
        // ==========================================
        // RESOLVER ALARMA
        // ==========================================
        function resolverAlarma() {
            if (!alertIdFromURL) return;
            
            // Confirmar
            if (!confirm('¬øEst√°s seguro de que deseas marcar esta alarma como resuelta?\n\nSer√°s redirigido a la p√°gina de gesti√≥n de alarmas para agregar las notas de resoluci√≥n.')) {
                return;
            }
            
            // Redirigir a water-alerts con el modal abierto
            window.location.href = `water-alerts.html#resolve-${alertIdFromURL}`;
        }
      // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function formatearNumero(numero) {
            if (numero === null || numero === undefined || isNaN(numero)) return '--';
            return new Intl.NumberFormat('es-CO', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(numero);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.aplicarFiltros = aplicarFiltros;
        window.limpiarFiltros = limpiarFiltros;
        window.verAlarma = verAlarma;
        window.resolverAlarma = resolverAlarma;
        
        console.log('üéâ extraordinary-water-readings.html cargado correctamente');
    </script>
</body>
</html>
