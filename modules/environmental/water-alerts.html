<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Alertas H√≠dricas - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Dashboard Cards */
        .stat-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            height: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin: 0.5rem 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-icon {
            font-size: 2rem;
            opacity: 0.3;
        }
        
        /* Alert Type Badges */
        .badge-warning-type {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }
        
        .badge-critical-type {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #dc3545;
        }
        
        /* Alert Status Badges */
        .badge-pending {
            background-color: #e7f3ff;
            color: #004085;
            border: 1px solid #0d6efd;
        }
        
        .badge-investigating {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }
        
        .badge-resolved {
            background-color: #d1f2eb;
            color: #0c5460;
            border: 1px solid #28a745;
        }
        
        /* Table Styling */
        .alerts-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .alerts-table thead {
            background: #f8f9fa;
        }
        
        .alerts-table th {
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            color: #495057;
            padding: 1rem;
            border-bottom: 2px solid #dee2e6;
        }
        
        .alerts-table td {
            padding: 1rem;
            vertical-align: middle;
        }
        
        .alerts-table tbody tr {
            transition: background-color 0.2s;
        }
        
        .alerts-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Filters Card */
        .filters-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        /* History Timeline */
        .history-timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .history-item {
            position: relative;
            padding-bottom: 1.5rem;
            border-left: 2px solid #dee2e6;
            padding-left: 1.5rem;
        }
        
        .history-item:last-child {
            border-left: none;
            padding-bottom: 0;
        }
        
        .history-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #0d6efd;
            border: 2px solid white;
        }
        
        .history-date {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        
        .history-user {
            font-weight: 600;
            color: #495057;
        }
        
        .history-change {
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }
        
        .history-notes {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            font-style: italic;
        }
        
        /* Modal Styling */
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stat-value {
                font-size: 1.75rem;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .alerts-table {
                font-size: 0.875rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando alertas...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Gesti√≥n Ambiental</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gesti√≥n de Alertas H√≠dricas
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Gesti√≥n de Alertas H√≠dricas
                </h1>
                <p class="text-muted">
                    Seguimiento y resoluci√≥n de alarmas del balance h√≠drico
                </p>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-primary" onclick="exportarPDF()">
                    <i class="bi bi-file-earmark-pdf me-2"></i>Exportar PDF
                </button>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>
        <!-- DASHBOARD DE RESUMEN -->
        <div class="row g-3 mb-4">
            <!-- Total Alarmas -->
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="stat-label">Total Alarmas</div>
                                <div class="stat-value" id="stat-total">0</div>
                            </div>
                            <i class="bi bi-bell stat-icon text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pendientes -->
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="stat-label">Pendientes</div>
                                <div class="stat-value text-info" id="stat-pending">0</div>
                            </div>
                            <i class="bi bi-clock-history stat-icon text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- En Investigaci√≥n -->
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="stat-label">En Investigaci√≥n</div>
                                <div class="stat-value text-warning" id="stat-investigating">0</div>
                            </div>
                            <i class="bi bi-search stat-icon text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Resueltas -->
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="stat-label">Resueltas</div>
                                <div class="stat-value text-success" id="stat-resolved">0</div>
                            </div>
                            <i class="bi bi-check-circle stat-icon text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GR√ÅFICOS -->
        <div class="row g-3 mb-4">
            <!-- Gr√°fico de Barras: Alarmas por Mes -->
            <div class="col-md-8">
                <div class="chart-container">
                    <h6 class="mb-3">
                        <i class="bi bi-bar-chart me-2"></i>
                        Alarmas por Mes (√öltimos 6 Meses)
                    </h6>
                    <canvas id="chart-monthly"></canvas>
                </div>
            </div>
            
            <!-- Gr√°fico Circular: Distribuci√≥n por Estado -->
            <div class="col-md-4">
                <div class="chart-container">
                    <h6 class="mb-3">
                        <i class="bi bi-pie-chart me-2"></i>
                        Por Estado
                    </h6>
                    <canvas id="chart-status"></canvas>
                </div>
            </div>
        </div>

        <!-- FILTROS -->
        <div class="filters-card">
            <h6 class="mb-3">
                <i class="bi bi-funnel me-2"></i>Filtros
            </h6>
            <div class="row g-3">
                <!-- Rango de Fechas -->
                <div class="col-md-3">
                    <label for="filter-date-start" class="form-label">Fecha Inicio</label>
                    <input type="date" class="form-control" id="filter-date-start">
                </div>
                <div class="col-md-3">
                    <label for="filter-date-end" class="form-label">Fecha Fin</label>
                    <input type="date" class="form-control" id="filter-date-end">
                </div>
                
                <!-- Tipo -->
                <div class="col-md-2">
                    <label for="filter-type" class="form-label">Tipo</label>
                    <select class="form-select" id="filter-type">
                        <option value="">Todas</option>
                        <option value="warning">üü° Advertencia</option>
                        <option value="critical">üî¥ Cr√≠tica</option>
                    </select>
                </div>
                
                <!-- Estado -->
                <div class="col-md-2">
                    <label for="filter-status" class="form-label">Estado</label>
                    <select class="form-select" id="filter-status">
                        <option value="">Todas</option>
                        <option value="pending">Pendientes</option>
                        <option value="investigating">En Investigaci√≥n</option>
                        <option value="resolved">Resueltas</option>
                    </select>
                </div>
                
                <!-- Botones -->
                <div class="col-md-2 d-flex align-items-end gap-2">
                    <button class="btn btn-primary flex-fill" onclick="aplicarFiltros()">
                        <i class="bi bi-search me-1"></i>Filtrar
                    </button>
                    <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- TABLA DE ALARMAS -->
        <div class="card alerts-table">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>Listado de Alarmas
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 12%;">Fecha</th>
                                <th style="width: 10%;">Tipo</th>
                                <th style="width: 13%;">Entrada (m¬≥)</th>
                                <th style="width: 13%;">Salida (m¬≥)</th>
                                <th style="width: 12%;">Diferencia</th>
                                <th style="width: 15%;">Estado</th>
                                <th style="width: 10%;">Med. Extra.</th>
                                <th style="width: 15%;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="alerts-table-body">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando alarmas...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL DE GESTI√ìN DE ALARMA -->
    <div class="modal fade" id="modal-alert" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Detalle de Alarma
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    
                    <!-- INFORMACI√ìN GENERAL -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted d-block">Fecha</small>
                                    <strong id="modal-date">--</strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted d-block">Tipo</small>
                                    <span id="modal-type">--</span>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted d-block">Estado Actual</small>
                                    <span id="modal-status">--</span>
                                </div>
                            </div>
                            
                            <hr class="my-3">
                            
                            <h6 class="mb-3">Datos del Balance</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <small class="text-muted d-block">Entrada Total</small>
                                    <strong class="text-success" id="modal-entrada">-- m¬≥</strong>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted d-block">Salida Total</small>
                                    <strong class="text-danger" id="modal-salida">-- m¬≥</strong>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted d-block">Diferencia</small>
                                    <strong id="modal-diferencia">-- m¬≥ (--%)</strong>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-3 mb-0" id="modal-notification-info" style="display: none;">
                                <small>
                                    <i class="bi bi-envelope me-1"></i>
                                    Notificaci√≥n enviada a: <strong id="modal-notified-to">--</strong><br>
                                    Fecha: <span id="modal-notified-at">--</span>
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- GESTI√ìN -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-gear me-2"></i>Gesti√≥n de Alarma
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="form-manage-alert">
                                <input type="hidden" id="modal-alert-id">
                                <input type="hidden" id="modal-current-status">
                                
                                <div class="mb-3">
                                    <label for="modal-new-status" class="form-label">
                                        Cambiar Estado <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="modal-new-status" required>
                                        <option value="">-- Seleccionar --</option>
                                        <option value="pending">‚è≥ Pendiente</option>
                                        <option value="investigating">üîç En Investigaci√≥n</option>
                                        <option value="resolved">‚úÖ Resuelta</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3" id="investigation-notes-group">
                                    <label for="modal-investigation-notes" class="form-label">
                                        üìù Notas de Investigaci√≥n
                                    </label>
                                    <textarea class="form-control" 
                                              id="modal-investigation-notes" 
                                              rows="3"
                                              placeholder="Ej: Se detect√≥ fuga en tuber√≠a del comedor..."></textarea>
                                    <small class="text-muted">Describe qu√© est√°s investigando o qu√© has encontrado</small>
                                </div>
                                
                                <div class="mb-3" id="resolution-notes-group" style="display: none;">
                                    <label for="modal-resolution-notes" class="form-label">
                                        ‚úÖ Notas de Resoluci√≥n
                                    </label>
                                    <textarea class="form-control" 
                                              id="modal-resolution-notes" 
                                              rows="3"
                                              placeholder="Ej: Fuga reparada, sistema normalizado..."></textarea>
                                    <small class="text-muted">Explica c√≥mo se resolvi√≥ el problema</small>
                                </div>
                                
                                <div class="alert alert-warning mb-0">
                                    <small>
                                        <i class="bi bi-info-circle me-1"></i>
                                        Los cambios se registrar√°n en el historial de auditor√≠a
                                    </small>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- HISTORIAL DE CAMBIOS -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-clock-history me-2"></i>Historial de Cambios
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="alert-history-timeline" class="history-timeline">
                                <div class="text-center text-muted py-3">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2 small">Cargando historial...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MEDICIONES EXTRAORDINARIAS -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-clipboard-data me-2"></i>Mediciones Extraordinarias
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Total de mediciones asociadas:</strong>
                                    <span class="badge bg-primary ms-2" id="modal-extraordinary-count">0</span>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" 
                                        onclick="verMedicionesExtraordinarias()"
                                        id="btn-ver-mediciones">
                                    <i class="bi bi-arrow-right-circle me-1"></i>Ver Detalle
                                </button>
                            </div>
                            <small class="text-muted d-block mt-2">
                                Las mediciones extraordinarias son registros adicionales tomados durante la investigaci√≥n de esta alarma
                            </small>
                        </div>
                    </div>
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="guardarCambiosAlarma()">
                        <i class="bi bi-check-circle me-1"></i>Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let todasLasAlarmas = [];
        let alarmasFiltradas = [];
        let modalInstance = null;
        let chartMonthly = null;
        let chartStatus = null;
        let alarmaActual = null;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Gestionar alertas h√≠dricas');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Obtener usuario actual
                const session = getStoredSession();
                if (session && session.user) {
                    currentUser = session.user;
                }
                
                // Inicializar modal
                modalInstance = new bootstrap.Modal(document.getElementById('modal-alert'));
                
                // Configurar fechas por defecto (√∫ltimos 6 meses)
                configurarFechasPorDefecto();
                
                // Cargar alarmas
                await cargarAlarmas();
                
                // Configurar event listeners
                configurarEventListeners();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CONFIGURAR FECHAS POR DEFECTO
        // ==========================================
        function configurarFechasPorDefecto() {
            const hoy = new Date();
            const hace6Meses = new Date();
            hace6Meses.setMonth(hace6Meses.getMonth() - 6);
            
            document.getElementById('filter-date-start').value = hace6Meses.toISOString().split('T')[0];
            document.getElementById('filter-date-end').value = hoy.toISOString().split('T')[0];
        }
        
        // ==========================================
        // CONFIGURAR EVENT LISTENERS
        // ==========================================
        function configurarEventListeners() {
            // Cambio de estado en modal
            document.getElementById('modal-new-status').addEventListener('change', function() {
                const nuevoEstado = this.value;
                
                // Mostrar/ocultar campos seg√∫n estado
                if (nuevoEstado === 'investigating') {
                    document.getElementById('investigation-notes-group').style.display = 'block';
                    document.getElementById('resolution-notes-group').style.display = 'none';
                } else if (nuevoEstado === 'resolved') {
                    document.getElementById('investigation-notes-group').style.display = 'block';
                    document.getElementById('resolution-notes-group').style.display = 'block';
                } else {
                    document.getElementById('investigation-notes-group').style.display = 'none';
                    document.getElementById('resolution-notes-group').style.display = 'none';
                }
            });
            
            console.log('‚úÖ Event listeners configurados');
        }
        
        // ==========================================
        // CARGAR ALARMAS
        // ==========================================
        async function cargarAlarmas() {
            try {
                console.log('üì° Cargando alarmas...');
                
                // Obtener rango de fechas de los filtros
                const fechaInicio = document.getElementById('filter-date-start').value;
                const fechaFin = document.getElementById('filter-date-end').value;
                
                let query = '/env_water_alerts?select=*&order=alert_date.desc';
                
                if (fechaInicio && fechaFin) {
                    query += `&alert_date=gte.${fechaInicio}&alert_date=lte.${fechaFin}`;
                }
                
                const alarmas = await supabaseRequest(query);
                
                todasLasAlarmas = alarmas || [];
                alarmasFiltradas = [...todasLasAlarmas];
                
                console.log(`‚úÖ ${todasLasAlarmas.length} alarmas cargadas`);
                
                // Actualizar dashboard y gr√°ficos
                actualizarDashboard();
                renderizarGraficos();
                
                // Renderizar tabla
                renderizarTabla();
                
            } catch (error) {
                console.error('‚ùå Error cargando alarmas:', error);
                showMessage('Error al cargar alarmas: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // ACTUALIZAR DASHBOARD
        // ==========================================
        function actualizarDashboard() {
            const total = alarmasFiltradas.length;
            const pendientes = alarmasFiltradas.filter(a => a.alert_status === 'pending').length;
            const investigando = alarmasFiltradas.filter(a => a.alert_status === 'investigating').length;
            const resueltas = alarmasFiltradas.filter(a => a.alert_status === 'resolved').length;
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-pending').textContent = pendientes;
            document.getElementById('stat-investigating').textContent = investigando;
            document.getElementById('stat-resolved').textContent = resueltas;
        }
        
        // ==========================================
        // RENDERIZAR GR√ÅFICOS
        // ==========================================
        function renderizarGraficos() {
            renderizarGraficoMensual();
            renderizarGraficoEstados();
        }
        
        // ==========================================
        // GR√ÅFICO MENSUAL (BARRAS)
        // ==========================================
        function renderizarGraficoMensual() {
            // Agrupar alarmas por mes
            const alarmasPorMes = {};
            
            alarmasFiltradas.forEach(alarma => {
                const fecha = new Date(alarma.alert_date);
                const mesKey = fecha.getFullYear() + '-' + String(fecha.getMonth() + 1).padStart(2, '0');
                
                if (!alarmasPorMes[mesKey]) {
                    alarmasPorMes[mesKey] = { warning: 0, critical: 0 };
                }
                
                if (alarma.alert_type === 'warning') {
                    alarmasPorMes[mesKey].warning++;
                } else if (alarma.alert_type === 'critical') {
                    alarmasPorMes[mesKey].critical++;
                }
            });
            
            // Obtener √∫ltimos 6 meses
            const labels = [];
            const dataWarning = [];
            const dataCritical = [];
            
            for (let i = 5; i >= 0; i--) {
                const fecha = new Date();
                fecha.setMonth(fecha.getMonth() - i);
                const mesKey = fecha.getFullYear() + '-' + String(fecha.getMonth() + 1).padStart(2, '0');
                
                const nombreMes = fecha.toLocaleDateString('es-CO', { month: 'short', year: 'numeric' });
                labels.push(nombreMes);
                
                dataWarning.push(alarmasPorMes[mesKey]?.warning || 0);
                dataCritical.push(alarmasPorMes[mesKey]?.critical || 0);
            }
            
            // Destruir gr√°fico anterior si existe
            if (chartMonthly) {
                chartMonthly.destroy();
            }
            
            // Crear nuevo gr√°fico
            const ctx = document.getElementById('chart-monthly').getContext('2d');
            chartMonthly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Advertencia',
                            data: dataWarning,
                            backgroundColor: '#ffc107',
                            borderColor: '#ffc107',
                            borderWidth: 1
                        },
                        {
                            label: 'Cr√≠tica',
                            data: dataCritical,
                            backgroundColor: '#dc3545',
                            borderColor: '#dc3545',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
      // ==========================================
        // GR√ÅFICO DE ESTADOS (CIRCULAR)
        // ==========================================
        function renderizarGraficoEstados() {
            const pendientes = alarmasFiltradas.filter(a => a.alert_status === 'pending').length;
            const investigando = alarmasFiltradas.filter(a => a.alert_status === 'investigating').length;
            const resueltas = alarmasFiltradas.filter(a => a.alert_status === 'resolved').length;
            
            // Destruir gr√°fico anterior si existe
            if (chartStatus) {
                chartStatus.destroy();
            }
            
            // Crear nuevo gr√°fico
            const ctx = document.getElementById('chart-status').getContext('2d');
            chartStatus = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendientes', 'En Investigaci√≥n', 'Resueltas'],
                    datasets: [{
                        data: [pendientes, investigando, resueltas],
                        backgroundColor: ['#0dcaf0', '#ffc107', '#198754'],
                        borderColor: ['#0dcaf0', '#ffc107', '#198754'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // RENDERIZAR TABLA
        // ==========================================
        function renderizarTabla() {
            const tbody = document.getElementById('alerts-table-body');
            
            if (alarmasFiltradas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <h6>No hay alarmas que mostrar</h6>
                                <p class="mb-0">Ajusta los filtros o verifica el rango de fechas</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = alarmasFiltradas.map(alarma => {
                // Formatear tipo
                const tipoBadge = alarma.alert_type === 'critical' 
                    ? '<span class="badge badge-critical-type">üî¥ Cr√≠tica</span>'
                    : '<span class="badge badge-warning-type">üü° Advertencia</span>';
                
                // Formatear estado
                let estadoBadge = '';
                switch (alarma.alert_status) {
                    case 'pending':
                        estadoBadge = '<span class="badge badge-pending">‚è≥ Pendiente</span>';
                        break;
                    case 'investigating':
                        estadoBadge = '<span class="badge badge-investigating">üîç Investigando</span>';
                        break;
                    case 'resolved':
                        estadoBadge = '<span class="badge badge-resolved">‚úÖ Resuelta</span>';
                        break;
                }
                
                // Formatear fecha
                const fecha = new Date(alarma.alert_date);
                const fechaFormateada = fecha.toLocaleDateString('es-CO', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                // Formatear diferencia
                const diferenciaFormateada = formatearNumero(alarma.diferencia);
                const porcentajeFormateado = formatearNumero(alarma.diferencia_porcentaje);
                const diferenciaColor = alarma.diferencia < 0 ? 'text-danger' : 'text-warning';
                
                return `
                    <tr>
                        <td>${fechaFormateada}</td>
                        <td>${tipoBadge}</td>
                        <td class="text-end">${formatearNumero(alarma.entrada_total)}</td>
                        <td class="text-end">${formatearNumero(alarma.salida_total)}</td>
                        <td class="text-end ${diferenciaColor}">
                            <strong>${diferenciaFormateada} m¬≥</strong><br>
                            <small>(${porcentajeFormateado}%)</small>
                        </td>
                        <td>${estadoBadge}</td>
                        <td class="text-center">
                            <span class="badge bg-secondary">${alarma.extraordinary_readings_count || 0}</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" 
                                        onclick="abrirModalAlarma('${alarma.alert_id}')"
                                        title="Ver y gestionar">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ==========================================
        // APLICAR FILTROS
        // ==========================================
        function aplicarFiltros() {
            const tipo = document.getElementById('filter-type').value;
            const estado = document.getElementById('filter-status').value;
            
            alarmasFiltradas = todasLasAlarmas.filter(alarma => {
                let cumpleTipo = true;
                let cumpleEstado = true;
                
                if (tipo) {
                    cumpleTipo = alarma.alert_type === tipo;
                }
                
                if (estado) {
                    cumpleEstado = alarma.alert_status === estado;
                }
                
                return cumpleTipo && cumpleEstado;
            });
            
            console.log(`üîç Filtros aplicados: ${alarmasFiltradas.length} alarmas`);
            
            actualizarDashboard();
            renderizarGraficos();
            renderizarTabla();
        }
        
        // ==========================================
        // LIMPIAR FILTROS
        // ==========================================
        function limpiarFiltros() {
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-status').value = '';
            configurarFechasPorDefecto();
            
            cargarAlarmas();
        }
        
        // ==========================================
        // ABRIR MODAL DE ALARMA
        // ==========================================
        async function abrirModalAlarma(alertId) {
            try {
                mostrarLoading();
                
                // Buscar alarma
                const alarma = todasLasAlarmas.find(a => a.alert_id === alertId);
                if (!alarma) {
                    throw new Error('Alarma no encontrada');
                }
                
                alarmaActual = alarma;
                
                // Llenar informaci√≥n general
                const fecha = new Date(alarma.alert_date);
                document.getElementById('modal-date').textContent = fecha.toLocaleDateString('es-CO', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                document.getElementById('modal-type').innerHTML = alarma.alert_type === 'critical'
                    ? '<span class="badge badge-critical-type">üî¥ Cr√≠tica</span>'
                    : '<span class="badge badge-warning-type">üü° Advertencia</span>';
                
                let estadoBadge = '';
                switch (alarma.alert_status) {
                    case 'pending':
                        estadoBadge = '<span class="badge badge-pending">‚è≥ Pendiente</span>';
                        break;
                    case 'investigating':
                        estadoBadge = '<span class="badge badge-investigating">üîç En Investigaci√≥n</span>';
                        break;
                    case 'resolved':
                        estadoBadge = '<span class="badge badge-resolved">‚úÖ Resuelta</span>';
                        break;
                }
                document.getElementById('modal-status').innerHTML = estadoBadge;
                
                document.getElementById('modal-entrada').textContent = formatearNumero(alarma.entrada_total) + ' m¬≥';
                document.getElementById('modal-salida').textContent = formatearNumero(alarma.salida_total) + ' m¬≥';
                
                const diferenciaColor = alarma.diferencia < 0 ? 'text-danger' : 'text-warning';
                document.getElementById('modal-diferencia').innerHTML = 
                    `<span class="${diferenciaColor}">${formatearNumero(alarma.diferencia)} m¬≥ (${formatearNumero(alarma.diferencia_porcentaje)}%)</span>`;
                
                // Informaci√≥n de notificaci√≥n
                if (alarma.notified_to && alarma.notified_at) {
                    document.getElementById('modal-notification-info').style.display = 'block';
                    document.getElementById('modal-notified-to').textContent = alarma.notified_to;
                    document.getElementById('modal-notified-at').textContent = new Date(alarma.notified_at).toLocaleString('es-CO');
                } else {
                    document.getElementById('modal-notification-info').style.display = 'none';
                }
                
                // Configurar formulario
                document.getElementById('modal-alert-id').value = alarma.alert_id;
                document.getElementById('modal-current-status').value = alarma.alert_status;
                document.getElementById('modal-new-status').value = alarma.alert_status;
                document.getElementById('modal-investigation-notes').value = alarma.investigation_notes || '';
                document.getElementById('modal-resolution-notes').value = alarma.resolution_notes || '';
                
                // Mostrar campos seg√∫n estado actual
                if (alarma.alert_status === 'investigating') {
                    document.getElementById('investigation-notes-group').style.display = 'block';
                    document.getElementById('resolution-notes-group').style.display = 'none';
                } else if (alarma.alert_status === 'resolved') {
                    document.getElementById('investigation-notes-group').style.display = 'block';
                    document.getElementById('resolution-notes-group').style.display = 'block';
                } else {
                    document.getElementById('investigation-notes-group').style.display = 'none';
                    document.getElementById('resolution-notes-group').style.display = 'none';
                }
                
                // Mediciones extraordinarias
                document.getElementById('modal-extraordinary-count').textContent = alarma.extraordinary_readings_count || 0;
                
                // Cargar historial
                await cargarHistorialAlarma(alertId);
                
                ocultarLoading();
                
                // Abrir modal
                modalInstance.show();
                
            } catch (error) {
                console.error('‚ùå Error abriendo modal:', error);
                showMessage('Error al cargar detalles: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR HISTORIAL DE ALARMA
        // ==========================================
        async function cargarHistorialAlarma(alertId) {
            try {
                const historial = await supabaseRequest(`/env_water_alert_history?select=*,users(user_display_name)&alert_id=eq.${alertId}&order=changed_at.desc`);
                
                const timelineContainer = document.getElementById('alert-history-timeline');
                
                if (!historial || historial.length === 0) {
                    timelineContainer.innerHTML = `
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-inbox"></i>
                            <div class="mt-2 small">No hay historial de cambios</div>
                        </div>
                    `;
                    return;
                }
                
                timelineContainer.innerHTML = historial.map(item => {
                    const fecha = new Date(item.changed_at);
                    const fechaFormateada = fecha.toLocaleDateString('es-CO', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const usuario = item.users?.user_display_name || 'Sistema';
                    
                    const estadoAnterior = item.previous_status 
                        ? traducirEstado(item.previous_status) 
                        : 'Creada';
                    const estadoNuevo = traducirEstado(item.new_status);
                    
                    return `
                        <div class="history-item">
                            <div class="history-date">${fechaFormateada}</div>
                            <div class="history-user">${escapeHtml(usuario)}</div>
                            <div class="history-change">
                                Estado: <strong>${estadoAnterior}</strong> ‚Üí <strong>${estadoNuevo}</strong>
                            </div>
                            ${item.change_notes ? `<div class="history-notes">"${escapeHtml(item.change_notes)}"</div>` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('‚ùå Error cargando historial:', error);
                document.getElementById('alert-history-timeline').innerHTML = `
                    <div class="text-center text-danger py-3">
                        <i class="bi bi-exclamation-triangle"></i>
                        <div class="mt-2 small">Error al cargar historial</div>
                    </div>
                `;
            }
        }
      // ==========================================
        // GUARDAR CAMBIOS DE ALARMA
        // ==========================================
        async function guardarCambiosAlarma() {
            try {
                const alertId = document.getElementById('modal-alert-id').value;
                const estadoActual = document.getElementById('modal-current-status').value;
                const nuevoEstado = document.getElementById('modal-new-status').value;
                const notasInvestigacion = document.getElementById('modal-investigation-notes').value.trim();
                const notasResolucion = document.getElementById('modal-resolution-notes').value.trim();
                
                // Validar que se haya seleccionado un estado
                if (!nuevoEstado) {
                    showMessage('Por favor selecciona un estado', 'warning');
                    return;
                }
                
                // Validar que si est√° resolviendo, tenga notas de resoluci√≥n
                if (nuevoEstado === 'resolved' && !notasResolucion) {
                    if (!confirm('No has agregado notas de resoluci√≥n. ¬øDeseas continuar sin ellas?')) {
                        return;
                    }
                }
                
                mostrarLoading();
                
                // Preparar datos de actualizaci√≥n
                const datosActualizacion = {
                    alert_status: nuevoEstado,
                    investigation_notes: notasInvestigacion || null,
                    resolution_notes: notasResolucion || null
                };
                
                // Si se est√° resolviendo, agregar campos adicionales
                if (nuevoEstado === 'resolved') {
                    datosActualizacion.resolved_by = currentUser.user_id;
                    datosActualizacion.resolved_at = new Date().toISOString();
                }
                
                // Actualizar alarma
                await supabaseRequest(`/env_water_alerts?alert_id=eq.${alertId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(datosActualizacion)
                });
                
                console.log('‚úÖ Alarma actualizada');
                
                // Registrar en historial si hubo cambio de estado
                if (estadoActual !== nuevoEstado) {
                    const cambioNotas = notasInvestigacion || notasResolucion || null;
                    
                    await supabaseRequest('/env_water_alert_history', {
                        method: 'POST',
                        body: JSON.stringify({
                            alert_id: alertId,
                            previous_status: estadoActual,
                            new_status: nuevoEstado,
                            changed_by: currentUser.user_id,
                            change_notes: cambioNotas
                        })
                    });
                    
                    console.log('‚úÖ Cambio registrado en historial');
                }
                
                showMessage('Cambios guardados exitosamente', 'success');
                
                // Cerrar modal y recargar
                modalInstance.hide();
                await cargarAlarmas();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error guardando cambios:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // VER MEDICIONES EXTRAORDINARIAS
        // ==========================================
        function verMedicionesExtraordinarias() {
            if (!alarmaActual) return;
            
            // Redirigir a p√°gina de mediciones extraordinarias con filtro de alert_id
            window.location.href = `extraordinary-water-readings.html?alert_id=${alarmaActual.alert_id}`;
        }
        
        // ==========================================
        // EXPORTAR A PDF
        // ==========================================
        async function exportarPDF() {
            try {
                mostrarLoading();
                
                // Preparar datos para el PDF
                const filtroTipo = document.getElementById('filter-type').value;
                const filtroEstado = document.getElementById('filter-status').value;
                const fechaInicio = document.getElementById('filter-date-start').value;
                const fechaFin = document.getElementById('filter-date-end').value;
                
                // Crear contenido HTML para el PDF
                let contenidoHTML = `
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Reporte de Alarmas H√≠dricas</title>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                margin: 20px;
                                font-size: 12px;
                            }
                            .header {
                                text-align: center;
                                margin-bottom: 30px;
                                border-bottom: 2px solid #333;
                                padding-bottom: 15px;
                            }
                            .header h1 {
                                margin: 0;
                                color: #333;
                            }
                            .filters {
                                background: #f5f5f5;
                                padding: 15px;
                                margin-bottom: 20px;
                                border-radius: 5px;
                            }
                            .stats {
                                display: flex;
                                justify-content: space-around;
                                margin-bottom: 20px;
                                padding: 15px;
                                background: #e9ecef;
                                border-radius: 5px;
                            }
                            .stat-box {
                                text-align: center;
                            }
                            .stat-value {
                                font-size: 24px;
                                font-weight: bold;
                                color: #0d6efd;
                            }
                            .stat-label {
                                font-size: 11px;
                                color: #666;
                                text-transform: uppercase;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-top: 20px;
                            }
                            th, td {
                                border: 1px solid #ddd;
                                padding: 8px;
                                text-align: left;
                            }
                            th {
                                background-color: #343a40;
                                color: white;
                                font-weight: bold;
                            }
                            tr:nth-child(even) {
                                background-color: #f9f9f9;
                            }
                            .badge-warning {
                                background: #ffc107;
                                padding: 3px 8px;
                                border-radius: 3px;
                                font-size: 10px;
                            }
                            .badge-critical {
                                background: #dc3545;
                                color: white;
                                padding: 3px 8px;
                                border-radius: 3px;
                                font-size: 10px;
                            }
                            .badge-pending {
                                background: #0dcaf0;
                                padding: 3px 8px;
                                border-radius: 3px;
                                font-size: 10px;
                            }
                            .badge-investigating {
                                background: #ffc107;
                                padding: 3px 8px;
                                border-radius: 3px;
                                font-size: 10px;
                            }
                            .badge-resolved {
                                background: #198754;
                                color: white;
                                padding: 3px 8px;
                                border-radius: 3px;
                                font-size: 10px;
                            }
                            .footer {
                                margin-top: 30px;
                                text-align: center;
                                font-size: 10px;
                                color: #666;
                                border-top: 1px solid #ddd;
                                padding-top: 10px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>üö® Reporte de Alarmas H√≠dricas</h1>
                            <p>SchoolNet - Gesti√≥n Ambiental | Colegio Tilata</p>
                            <p>Generado: ${new Date().toLocaleString('es-CO')}</p>
                        </div>
                        
                        <div class="filters">
                            <strong>Filtros Aplicados:</strong><br>
                            Per√≠odo: ${fechaInicio ? new Date(fechaInicio).toLocaleDateString('es-CO') : 'N/A'} - ${fechaFin ? new Date(fechaFin).toLocaleDateString('es-CO') : 'N/A'}<br>
                            Tipo: ${filtroTipo ? (filtroTipo === 'warning' ? 'Advertencia' : 'Cr√≠tica') : 'Todas'}<br>
                            Estado: ${filtroEstado ? traducirEstado(filtroEstado) : 'Todos'}
                        </div>
                        
                        <div class="stats">
                            <div class="stat-box">
                                <div class="stat-value">${alarmasFiltradas.length}</div>
                                <div class="stat-label">Total</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${alarmasFiltradas.filter(a => a.alert_status === 'pending').length}</div>
                                <div class="stat-label">Pendientes</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${alarmasFiltradas.filter(a => a.alert_status === 'investigating').length}</div>
                                <div class="stat-label">Investigando</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${alarmasFiltradas.filter(a => a.alert_status === 'resolved').length}</div>
                                <div class="stat-label">Resueltas</div>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Entrada (m¬≥)</th>
                                    <th>Salida (m¬≥)</th>
                                    <th>Diferencia</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                alarmasFiltradas.forEach(alarma => {
                    const fecha = new Date(alarma.alert_date).toLocaleDateString('es-CO');
                    const tipo = alarma.alert_type === 'critical' 
                        ? '<span class="badge-critical">Cr√≠tica</span>' 
                        : '<span class="badge-warning">Advertencia</span>';
                    
                    let estado = '';
                    switch (alarma.alert_status) {
                        case 'pending':
                            estado = '<span class="badge-pending">Pendiente</span>';
                            break;
                        case 'investigating':
                            estado = '<span class="badge-investigating">Investigando</span>';
                            break;
                        case 'resolved':
                            estado = '<span class="badge-resolved">Resuelta</span>';
                            break;
                    }
                    
                    contenidoHTML += `
                        <tr>
                            <td>${fecha}</td>
                            <td>${tipo}</td>
                            <td>${formatearNumero(alarma.entrada_total)}</td>
                            <td>${formatearNumero(alarma.salida_total)}</td>
                            <td>${formatearNumero(alarma.diferencia)} (${formatearNumero(alarma.diferencia_porcentaje)}%)</td>
                            <td>${estado}</td>
                        </tr>
                    `;
                });
                
                contenidoHTML += `
                            </tbody>
                        </table>
                        
                        <div class="footer">
                            <p>Este reporte fue generado autom√°ticamente por SchoolNet - Sistema de Gesti√≥n Educativa</p>
                            <p>Colegio Tilata | Gesti√≥n Ambiental - Manejo H√≠drico</p>
                        </div>
                    </body>
                    </html>
                `;
                
                // Abrir ventana de impresi√≥n
                const ventana = window.open('', '_blank');
                ventana.document.write(contenidoHTML);
                ventana.document.close();
                
                // Esperar a que cargue y luego imprimir
                ventana.onload = function() {
                    ventana.print();
                };
                
                ocultarLoading();
                showMessage('PDF generado. Use Ctrl+P o Cmd+P para guardar como PDF', 'info');
                
            } catch (error) {
                console.error('‚ùå Error exportando PDF:', error);
                showMessage('Error al exportar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function formatearNumero(numero) {
            if (numero === null || numero === undefined || isNaN(numero)) return '--';
            return new Intl.NumberFormat('es-CO', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(numero);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function traducirEstado(estado) {
            const traducciones = {
                'pending': '‚è≥ Pendiente',
                'investigating': 'üîç En Investigaci√≥n',
                'resolved': '‚úÖ Resuelta'
            };
            return traducciones[estado] || estado;
        }
      // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.aplicarFiltros = aplicarFiltros;
        window.limpiarFiltros = limpiarFiltros;
        window.abrirModalAlarma = abrirModalAlarma;
        window.guardarCambiosAlarma = guardarCambiosAlarma;
        window.verMedicionesExtraordinarias = verMedicionesExtraordinarias;
        window.exportarPDF = exportarPDF;
        
        console.log('üéâ water-alerts.html cargado correctamente');
    </script>
</body>
</html>
