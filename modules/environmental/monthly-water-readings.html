<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecturas Mensuales de Agua - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tarjetas de contexto */
        .context-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .context-stat {
            text-align: center;
            padding: 1rem;
        }
        
        .context-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .context-stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        /* Tabla de lecturas */
        .readings-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .readings-table thead {
            background: #f8f9fa;
        }
        
        .readings-table th {
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            color: #495057;
            padding: 1rem;
        }
        
        .readings-table td {
            padding: 1rem;
            vertical-align: middle;
        }
        
        .area-name {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .reading-input {
            max-width: 150px;
        }
        
        .consumption-display {
            font-weight: 600;
            color: #0d6efd;
        }
        
        /* Validaci√≥n final */
        .validation-card {
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .validation-normal {
            background: #d1f2eb;
            border-left: 4px solid #28a745;
        }
        
        .validation-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        
        .validation-critical {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        
        .validation-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .validation-stat {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .validation-stat:last-child {
            border-bottom: none;
        }
        
        .validation-label {
            font-weight: 500;
        }
        
        .validation-value {
            font-weight: 600;
        }
        
        /* Estados de lectura */
        .reading-saved {
            background-color: #d1f2eb !important;
        }
        
        .reading-pending {
            background-color: #fff3cd !important;
        }
        
        /* Botones de acci√≥n */
        .btn-action {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }
        
        /* Selector de mes */
        .month-selector {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .context-stat-value {
                font-size: 1.25rem;
            }
            
            .readings-table {
                font-size: 0.875rem;
            }
            
            .readings-table th,
            .readings-table td {
                padding: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando lecturas mensuales...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Gesti√≥n Ambiental</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Lecturas Mensuales de Agua
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-calendar-month me-2"></i>
                    Lecturas Mensuales de Agua
                </h1>
                <p class="text-muted">
                    Registro de consumo mensual por √°reas del colegio
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>
        <!-- SELECTOR DE MES -->
        <div class="month-selector">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <label for="month-selector" class="form-label fw-bold">
                        <i class="bi bi-calendar3 me-2"></i>Seleccionar Mes
                    </label>
                    <input type="month" class="form-control" id="month-selector">
                </div>
                <div class="col-md-4 mt-3 mt-md-0">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-primary w-100" onclick="cargarDatosMes()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Cargar Lecturas
                    </button>
                </div>
                <div class="col-md-4 mt-3 mt-md-0">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-outline-secondary w-100" onclick="limpiarFormulario()">
                        <i class="bi bi-x-circle me-2"></i>Limpiar
                    </button>
                </div>
            </div>
        </div>

        <!-- TARJETA DE CONTEXTO DEL MES -->
        <div id="context-section" class="context-card" style="display: none;">
            <h5 class="text-white mb-3">
                <i class="bi bi-graph-up me-2"></i>Balance H√≠drico del Mes
            </h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="context-stat">
                        <div class="context-stat-value" id="entrada-total-mes">-- m¬≥</div>
                        <div class="context-stat-label">Entrada Total Mes</div>
                        <small class="d-block mt-1" style="opacity: 0.8;">Captaci√≥n + Acueducto</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="context-stat">
                        <div class="context-stat-value" id="salida-total-mes">-- m¬≥</div>
                        <div class="context-stat-label">Salida PTAR Mes</div>
                        <small class="d-block mt-1" style="opacity: 0.8;">Vertimiento total</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="context-stat">
                        <div class="context-stat-value" id="balance-mes">-- %</div>
                        <div class="context-stat-label">Balance Mensual</div>
                        <small class="d-block mt-1" style="opacity: 0.8;" id="balance-status">--</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN DE LECTURAS POR √ÅREA -->
        <div id="readings-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-building me-2"></i>Lecturas por √Årea de Consumo
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover readings-table mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">√Årea</th>
                                    <th style="width: 15%;">Lectura Anterior</th>
                                    <th style="width: 20%;">Lectura Actual</th>
                                    <th style="width: 15%;">Consumo</th>
                                    <th style="width: 10%;">Estado</th>
                                    <th style="width: 15%;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="readings-table-body">
                                <!-- Filas generadas din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TARJETA DE VALIDACI√ìN -->
            <div id="validation-card" class="validation-card" style="display: none;">
                <div class="validation-title">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span id="validation-title-text">Validaci√≥n del Mes</span>
                </div>
                <div class="validation-stat">
                    <span class="validation-label">Total Consumo √Åreas:</span>
                    <span class="validation-value" id="total-areas-consumo">0 m¬≥</span>
                </div>
                <div class="validation-stat">
                    <span class="validation-label">Entrada Total Mes:</span>
                    <span class="validation-value" id="entrada-validation">0 m¬≥</span>
                </div>
                <div class="validation-stat">
                    <span class="validation-label">Diferencia:</span>
                    <span class="validation-value" id="diferencia-validation">0 m¬≥ (0%)</span>
                </div>
                <div class="mt-3 pt-3" style="border-top: 2px solid rgba(0,0,0,0.1);">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle-fill me-2" style="font-size: 1.5rem;" id="validation-icon"></i>
                        <div>
                            <strong id="validation-status-text">Estado del Balance</strong>
                            <p class="mb-0 mt-1" id="validation-message">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MENSAJE INICIAL (cuando no hay mes seleccionado) -->
        <div id="empty-state" class="text-center py-5">
            <i class="bi bi-calendar-x" style="font-size: 4rem; color: #dee2e6;"></i>
            <h5 class="mt-3 text-muted">Selecciona un mes para cargar las lecturas</h5>
            <p class="text-muted">Las lecturas mensuales se registran por √°reas de consumo del colegio</p>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let selectedMonth = null;
        let medidoresAreas = [];
        let lecturasActuales = {};
        let lecturasAnteriores = {}; // üÜï NUEVA VARIABLE
        let balanceMensual = {
            entrada: 0,
            salida: 0
        };
        let systemConfig = null;
        
        // ==========================================
        // INICIALIZACI√ìN - PATR√ìN OBLIGATORIO
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // PASO 1: SIEMPRE validar permisos primero
                const hasAccess = await validatePageAccess('Registrar lecturas mensuales de agua');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                
                // PASO 2: Inicializar p√°gina
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Obtener usuario actual
                const session = getStoredSession();
                if (session && session.user) {
                    currentUser = session.user;
                }
                
                // Cargar configuraci√≥n del sistema
                await cargarConfiguracion();
                
                // Cargar medidores de √°reas
                await cargarMedidoresAreas();
                
                // Configurar selector de mes (mes actual por defecto)
                const today = new Date();
                const currentMonthStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
                document.getElementById('month-selector').value = currentMonthStr;
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR CONFIGURACI√ìN DEL SISTEMA
        // ==========================================
        async function cargarConfiguracion() {
            try {
                console.log('üì° Cargando configuraci√≥n del sistema...');
                
                const config = await supabaseRequest('/system_config?select=water_balance_tolerance_warning,water_balance_tolerance_critical,environmental_responsible_email&limit=1');
                
                if (config && config.length > 0) {
                    systemConfig = config[0];
                    console.log('‚úÖ Configuraci√≥n cargada:', systemConfig);
                } else {
                    throw new Error('No se encontr√≥ configuraci√≥n del sistema');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando configuraci√≥n:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR MEDIDORES DE √ÅREAS
        // ==========================================
        async function cargarMedidoresAreas() {
            try {
                console.log('üì° Cargando medidores de √°reas...');
                
                // Solo medidores de tipo 'area_consumo' con frecuencia mensual activos
                const medidores = await supabaseRequest('/env_water_meters?select=*&meter_type=eq.area_consumo&measurement_frequency=eq.monthly&is_active=eq.true&order=meter_name.asc');
                
                if (!medidores || medidores.length === 0) {
                    showMessage('No se encontraron medidores de √°reas activos', 'warning');
                    return;
                }
                
                medidoresAreas = medidores;
                console.log(`‚úÖ ${medidoresAreas.length} medidores de √°reas cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando medidores:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR DATOS DEL MES SELECCIONADO
        // ==========================================
        async function cargarDatosMes() {
            try {
                const monthInput = document.getElementById('month-selector').value;
                
                if (!monthInput) {
                    showMessage('Por favor selecciona un mes', 'warning');
                    return;
                }
                
                mostrarLoading();
                
                selectedMonth = monthInput;
                console.log('üìÖ Cargando datos para:', selectedMonth);
                
                // PASO 1: Calcular balance mensual desde lecturas diarias
                await calcularBalanceMensual();
                
                // PASO 2: Cargar lecturas mensuales existentes de √°reas
                await cargarLecturasAreas();
                
                // PASO 3: Renderizar tabla
                renderizarTablaLecturas();
                
                // PASO 4: Mostrar secciones
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('context-section').style.display = 'block';
                document.getElementById('readings-section').style.display = 'block';
                
                // PASO 5: Calcular validaci√≥n
                calcularValidacion();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error cargando datos del mes:', error);
                showMessage('Error al cargar datos: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CALCULAR BALANCE MENSUAL (desde lecturas diarias)
        // ==========================================
        async function calcularBalanceMensual() {
            try {
                console.log('üìä Calculando balance mensual...');
                
                // Convertir mes seleccionado a rango de fechas
                const [year, month] = selectedMonth.split('-');
                const startDate = `${year}-${month}-01`;
                const endDate = new Date(year, month, 0).toISOString().split('T')[0]; // √öltimo d√≠a del mes
                
                // Obtener todas las lecturas diarias del mes
                const lecturasDiarias = await supabaseRequest(`/env_water_readings_daily?select=*&reading_date=gte.${startDate}&reading_date=lte.${endDate}&order=reading_date.asc`);
                
                if (!lecturasDiarias || lecturasDiarias.length === 0) {
                    console.warn('‚ö†Ô∏è No hay lecturas diarias para este mes');
                    balanceMensual = { entrada: 0, salida: 0 };
                    actualizarContextoMes();
                    return;
                }
                
                // Sumar consumos diarios
                let totalEntrada = 0;
                let totalSalida = 0;
                
                lecturasDiarias.forEach(lectura => {
                    totalEntrada += (lectura.captacion_daily || 0) + (lectura.acueducto_daily || 0);
                    totalSalida += (lectura.ptar_daily || 0);
                });
                
                balanceMensual = {
                    entrada: totalEntrada,
                    salida: totalSalida
                };
                
                console.log('‚úÖ Balance mensual calculado:', balanceMensual);
                
                // Actualizar tarjeta de contexto
                actualizarContextoMes();
                
            } catch (error) {
                console.error('‚ùå Error calculando balance mensual:', error);
                throw error;
            }
        }
      // ==========================================
        // ACTUALIZAR CONTEXTO DEL MES
        // ==========================================
        function actualizarContextoMes() {
            // Formatear valores
            const entradaFormateada = new Intl.NumberFormat('es-CO').format(balanceMensual.entrada);
            const salidaFormateada = new Intl.NumberFormat('es-CO').format(balanceMensual.salida);
            
            // Calcular balance
            let balancePorcentaje = 0;
            if (balanceMensual.entrada > 0) {
                balancePorcentaje = ((balanceMensual.salida - balanceMensual.entrada) / balanceMensual.entrada * 100);
            }
            
            // Determinar estado del balance
            let estadoTexto = '';
            let estadoIcono = '';
            
            const absBalance = Math.abs(balancePorcentaje);
            
            if (absBalance <= systemConfig.water_balance_tolerance_warning) {
                estadoTexto = 'üü¢ Normal';
                estadoIcono = 'text-success';
            } else if (absBalance <= systemConfig.water_balance_tolerance_critical) {
                estadoTexto = 'üü° Advertencia';
                estadoIcono = 'text-warning';
            } else {
                estadoTexto = 'üî¥ Cr√≠tico';
                estadoIcono = 'text-danger';
            }
            
            // Actualizar DOM
            document.getElementById('entrada-total-mes').textContent = entradaFormateada + ' m¬≥';
            document.getElementById('salida-total-mes').textContent = salidaFormateada + ' m¬≥';
            document.getElementById('balance-mes').textContent = balancePorcentaje.toFixed(1) + '%';
            document.getElementById('balance-status').textContent = estadoTexto;
        }
        
        // ==========================================
        // CARGAR LECTURAS DE √ÅREAS EXISTENTES
        // ==========================================
        async function cargarLecturasAreas() {
            try {
                console.log('üì° Cargando lecturas mensuales de √°reas...');
                
                // Mes actual seleccionado
                const readingMonth = selectedMonth + '-01';
                
                // Calcular mes anterior
                const [year, month] = selectedMonth.split('-');
                const prevMonth = parseInt(month) - 1;
                const prevYear = prevMonth === 0 ? parseInt(year) - 1 : parseInt(year);
                const prevMonthStr = prevMonth === 0 ? '12' : String(prevMonth).padStart(2, '0');
                const prevReadingMonth = `${prevYear}-${prevMonthStr}-01`;
                
                console.log(`üìÖ Mes actual: ${readingMonth}, Mes anterior: ${prevReadingMonth}`);
                
                // Cargar lecturas de AMBOS meses en una sola query
                const lecturas = await supabaseRequest(`/env_water_readings_monthly?select=*&reading_month=in.(${readingMonth},${prevReadingMonth})`);
                
                // Separar lecturas por mes
                lecturasActuales = {};
                lecturasAnteriores = {};
                
                if (lecturas && lecturas.length > 0) {
                    lecturas.forEach(lectura => {
                        if (lectura.reading_month === readingMonth) {
                            lecturasActuales[lectura.meter_id] = lectura;
                        } else if (lectura.reading_month === prevReadingMonth) {
                            lecturasAnteriores[lectura.meter_id] = lectura.reading_value;
                        }
                    });
                    console.log(`‚úÖ ${Object.keys(lecturasActuales).length} lecturas actuales, ${Object.keys(lecturasAnteriores).length} lecturas anteriores`);
                } else {
                    console.log('‚ÑπÔ∏è No hay lecturas para estos meses');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando lecturas de √°reas:', error);
                throw error;
            }
        }

        // ==========================================
        // RENDERIZAR TABLA DE LECTURAS
        // ==========================================
        function renderizarTablaLecturas() {
            const tbody = document.getElementById('readings-table-body');
            
            if (medidoresAreas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="bi bi-inbox text-muted"></i>
                            <div class="mt-2 text-muted">No hay medidores de √°reas configurados</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            medidoresAreas.forEach(medidor => {
                const lecturaActual = lecturasActuales[medidor.meter_id];
                const tieneReading = lecturaActual ? true : false;
                
                // Obtener lectura anterior (mes anterior)
                const lecturaAnterior = obtenerLecturaAnterior(medidor.meter_id);
                
                // Calcular consumo si existe lectura actual
                let consumo = 0;
                if (tieneReading && lecturaAnterior) {
                    consumo = lecturaActual.reading_value - lecturaAnterior;
                }
                
                // Estado de la fila
                const rowClass = tieneReading ? 'reading-saved' : 'reading-pending';
                const estadoBadge = tieneReading 
                    ? '<span class="badge bg-success">Guardado</span>' 
                    : '<span class="badge bg-warning">Pendiente</span>';
                
                html += `
                    <tr class="${rowClass}" data-meter-id="${medidor.meter_id}">
                        <td>
                            <div class="area-name">
                                <i class="bi bi-building me-2"></i>${escapeHtml(medidor.meter_name)}
                            </div>
                            ${medidor.location_description ? `<small class="text-muted">${escapeHtml(medidor.location_description)}</small>` : ''}
                        </td>
                        <td>
                            <strong>${lecturaAnterior ? formatearNumero(lecturaAnterior) + ' m¬≥' : 'N/A'}</strong>
                        </td>
                        <td>
                            <input 
                                type="number" 
                                class="form-control reading-input" 
                                id="input-${medidor.meter_id}"
                                value="${tieneReading ? lecturaActual.reading_value : ''}"
                                placeholder="0"
                                min="0"
                                step="0.01"
                                ${tieneReading ? '' : 'autofocus'}
                            >
                        </td>
                        <td>
                            <div class="consumption-display" id="consumo-${medidor.meter_id}">
                                ${consumo > 0 ? formatearNumero(consumo) + ' m¬≥' : '--'}
                            </div>
                        </td>
                        <td>
                            ${estadoBadge}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                ${tieneReading ? `
                                    <button class="btn btn-outline-primary btn-action" 
                                            onclick="guardarLectura('${medidor.meter_id}')" 
                                            title="Actualizar">
                                        <i class="bi bi-save"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-action" 
                                            onclick="eliminarLectura('${medidor.meter_id}')" 
                                            title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                ` : `
                                    <button class="btn btn-primary btn-action" 
                                            onclick="guardarLectura('${medidor.meter_id}')" 
                                            title="Guardar">
                                        <i class="bi bi-save"></i> Guardar
                                    </button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // Agregar event listeners a inputs para calcular consumo en tiempo real
            medidoresAreas.forEach(medidor => {
                const input = document.getElementById(`input-${medidor.meter_id}`);
                if (input) {
                    input.addEventListener('input', () => calcularConsumoTiempoReal(medidor.meter_id));
                }
            });
        }
        
        // ==========================================
        // OBTENER LECTURA ANTERIOR (mes anterior)
        // ==========================================
        function obtenerLecturaAnterior(meterId) {
            return lecturasAnteriores[meterId] || null;
        }
        
        // ==========================================
        // CALCULAR CONSUMO EN TIEMPO REAL
        // ==========================================
        function calcularConsumoTiempoReal(meterId) {
            const input = document.getElementById(`input-${meterId}`);
            const consumoDisplay = document.getElementById(`consumo-${meterId}`);
            
            if (!input || !consumoDisplay) return;
            
            const lecturaActual = parseFloat(input.value) || 0;
            const lecturaAnterior = obtenerLecturaAnterior(meterId) || 0;
            
            if (lecturaActual > 0 && lecturaAnterior > 0) {
                const consumo = lecturaActual - lecturaAnterior;
                consumoDisplay.textContent = formatearNumero(consumo) + ' m¬≥';
                consumoDisplay.style.color = consumo >= 0 ? '#0d6efd' : '#dc3545';
            } else {
                consumoDisplay.textContent = '--';
            }
            
            // Recalcular validaci√≥n
            calcularValidacion();
        }
        
        // ==========================================
        // GUARDAR LECTURA
        // ==========================================
        async function guardarLectura(meterId) {
            try {
                const input = document.getElementById(`input-${meterId}`);
                const readingValue = parseFloat(input.value);
                
                // Validaciones
                if (isNaN(readingValue) || readingValue < 0) {
                    showMessage('Por favor ingresa un valor v√°lido (mayor o igual a 0)', 'warning');
                    return;
                }
                
                mostrarLoading();
                
                const readingMonth = selectedMonth + '-01';
                const lecturaExistente = lecturasActuales[meterId];
                
                if (lecturaExistente) {
                    // Actualizar lectura existente
                    await supabaseRequest(`/env_water_readings_monthly?reading_id=eq.${lecturaExistente.reading_id}`, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            reading_value: readingValue,
                            recorded_by: currentUser.user_id,
                            updated_at: new Date().toISOString()
                        })
                    });
                    
                    showMessage('Lectura actualizada exitosamente', 'success');
                } else {
                    // Crear nueva lectura
                    const nuevaLectura = await supabaseRequest('/env_water_readings_monthly', {
                        method: 'POST',
                        body: JSON.stringify({
                            meter_id: meterId,
                            reading_month: readingMonth,
                            reading_value: readingValue,
                            recorded_by: currentUser.user_id
                        })
                    });
                    
                    showMessage('Lectura guardada exitosamente', 'success');
                }
                
                // Recargar datos
                await cargarDatosMes();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error guardando lectura:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
      // ==========================================
        // ELIMINAR LECTURA
        // ==========================================
        async function eliminarLectura(meterId) {
            try {
                const lecturaExistente = lecturasActuales[meterId];
                
                if (!lecturaExistente) {
                    showMessage('No hay lectura para eliminar', 'warning');
                    return;
                }
                
                if (!confirm('¬øEst√°s seguro de eliminar esta lectura? Esta acci√≥n no se puede deshacer.')) {
                    return;
                }
                
                mostrarLoading();
                
                await supabaseRequest(`/env_water_readings_monthly?reading_id=eq.${lecturaExistente.reading_id}`, {
                    method: 'DELETE'
                });
                
                showMessage('Lectura eliminada exitosamente', 'success');
                
                // Recargar datos
                await cargarDatosMes();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error eliminando lectura:', error);
                showMessage('Error al eliminar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CALCULAR VALIDACI√ìN
        // ==========================================
        function calcularValidacion() {
            // Calcular suma total de consumos de √°reas
            let totalAreasConsumo = 0;
            let lecturasCompletas = 0;
            
            medidoresAreas.forEach(medidor => {
                const input = document.getElementById(`input-${medidor.meter_id}`);
                const lecturaActual = parseFloat(input?.value) || 0;
                const lecturaAnterior = obtenerLecturaAnterior(medidor.meter_id) || 0;
                
                if (lecturaActual > 0 && lecturaAnterior > 0) {
                    const consumo = lecturaActual - lecturaAnterior;
                    if (consumo > 0) {
                        totalAreasConsumo += consumo;
                        lecturasCompletas++;
                    }
                }
            });
            
            // Solo mostrar validaci√≥n si hay lecturas completas
            if (lecturasCompletas === 0) {
                document.getElementById('validation-card').style.display = 'none';
                return;
            }
            
            // Calcular diferencia con entrada del mes
            const entradaMes = balanceMensual.entrada;
            const diferencia = entradaMes - totalAreasConsumo;
            const diferenciaPorcentaje = entradaMes > 0 ? Math.abs((diferencia / entradaMes) * 100) : 0;
            
            // Determinar estado
            let estadoClase = 'validation-normal';
            let estadoTexto = 'üü¢ NORMAL';
            let mensaje = 'El consumo de las √°reas est√° dentro del rango esperado.';
            let estadoIcono = 'text-success';
            
            if (diferenciaPorcentaje >= systemConfig.water_balance_tolerance_critical) {
                estadoClase = 'validation-critical';
                estadoTexto = 'üî¥ CR√çTICO';
                mensaje = `Diferencia del ${diferenciaPorcentaje.toFixed(1)}% entre entrada y consumo de √°reas. Se recomienda investigaci√≥n inmediata de posibles fugas o medidores no registrados.`;
                estadoIcono = 'text-danger';
                
                // Enviar notificaci√≥n si est√° configurado el email
                if (systemConfig.environmental_responsible_email) {
                    enviarNotificacionCritica(diferencia, diferenciaPorcentaje);
                }
                
            } else if (diferenciaPorcentaje >= systemConfig.water_balance_tolerance_warning) {
                estadoClase = 'validation-warning';
                estadoTexto = 'üü° ADVERTENCIA';
                mensaje = `Diferencia del ${diferenciaPorcentaje.toFixed(1)}% entre entrada y consumo de √°reas. Se recomienda revisar mediciones.`;
                estadoIcono = 'text-warning';
            }
            
            // Actualizar DOM
            const validationCard = document.getElementById('validation-card');
            validationCard.className = 'validation-card ' + estadoClase;
            validationCard.style.display = 'block';
            
            document.getElementById('total-areas-consumo').textContent = formatearNumero(totalAreasConsumo) + ' m¬≥';
            document.getElementById('entrada-validation').textContent = formatearNumero(entradaMes) + ' m¬≥';
            document.getElementById('diferencia-validation').textContent = formatearNumero(diferencia) + ' m¬≥ (' + diferenciaPorcentaje.toFixed(1) + '%)';
            
            document.getElementById('validation-status-text').textContent = estadoTexto;
            document.getElementById('validation-message').textContent = mensaje;
            
            const icon = document.getElementById('validation-icon');
            icon.className = 'bi bi-info-circle-fill me-2 ' + estadoIcono;
            icon.style.fontSize = '1.5rem';
        }
        
        // ==========================================
        // ENVIAR NOTIFICACI√ìN CR√çTICA
        // ==========================================
        async function enviarNotificacionCritica(diferencia, porcentaje) {
            try {
                // Verificar si ya se envi√≥ notificaci√≥n para este mes
                const notificationKey = `water_monthly_notification_${selectedMonth}`;
                if (sessionStorage.getItem(notificationKey)) {
                    console.log('‚ÑπÔ∏è Notificaci√≥n ya enviada para este mes');
                    return;
                }
                
                const responsableEmail = systemConfig.environmental_responsible_email;
                const [year, month] = selectedMonth.split('-');
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const monthName = monthNames[parseInt(month) - 1];
                
                const subject = `SchoolNet - Discrepancia Cr√≠tica en Consumo Mensual de Agua (${monthName} ${year})`;
                
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
                        <div style="background-color: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin-bottom: 20px;">
                            <h2 style="color: #721c24; margin-top: 0; margin-bottom: 10px;">üî¥ Alerta Cr√≠tica - Balance H√≠drico Mensual</h2>
                            <p style="margin: 0; color: #721c24; font-weight: 500;">SchoolNet - Sistema de Gesti√≥n Ambiental</p>
                        </div>
                        
                        <div style="background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <p style="margin-top: 0;">Estimado Responsable Ambiental,</p>
                            <p>Se ha detectado una discrepancia <strong>cr√≠tica</strong> en el balance h√≠drico mensual de <strong>${monthName} ${year}</strong>.</p>
                            
                            <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #dee2e6;">
                                <tr style="background-color: #f8f9fa;">
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Concepto</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Valor</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Entrada Total Mes:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-family: monospace;">${formatearNumero(balanceMensual.entrada)} m¬≥</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Consumo √Åreas:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-family: monospace;">${formatearNumero(balanceMensual.entrada - diferencia)} m¬≥</td>
                                </tr>
                                <tr style="background-color: #f8d7da;">
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Diferencia:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-family: monospace; color: #721c24; font-weight: bold;">${formatearNumero(diferencia)} m¬≥ (${porcentaje.toFixed(1)}%)</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Umbral Cr√≠tico:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-family: monospace;">${systemConfig.water_balance_tolerance_critical}%</td>
                                </tr>
                            </table>
                            
                            <div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 15px; margin: 20px 0;">
                                <p style="margin: 0; color: #856404;"><strong>‚ö†Ô∏è Acci√≥n requerida:</strong> Se recomienda investigaci√≥n inmediata de posibles fugas o medidores no registrados en las √°reas de consumo.</p>
                            </div>
                            
                            <p style="margin-bottom: 0;">Puede revisar los detalles en el sistema SchoolNet - M√≥dulo de Gesti√≥n Ambiental - Lecturas Mensuales de Agua.</p>
                        </div>
                        
                        <hr style="margin: 30px 0; border: none; border-top: 1px solid #dee2e6;">
                        <p style="color: #6c757d; font-size: 12px; margin: 0; text-align: center;">
                            Este correo es generado autom√°ticamente por SchoolNet. Por favor, no responder a este mensaje.<br>
                            Colegio Tilata - Sistema de Gesti√≥n Educativa
                        </p>
                    </div>
                `;
                
                await sendNotification(responsableEmail, subject, htmlContent, true);
                
                // Marcar como enviada
                sessionStorage.setItem(notificationKey, 'sent');
                
                console.log('‚úÖ Notificaci√≥n cr√≠tica enviada a:', responsableEmail);
                
            } catch (error) {
                console.error('‚ùå Error enviando notificaci√≥n:', error);
                // No mostrar error al usuario, es proceso silencioso
            }
        }
        
        // ==========================================
        // LIMPIAR FORMULARIO
        // ==========================================
        function limpiarFormulario() {
            document.getElementById('month-selector').value = '';
            document.getElementById('empty-state').style.display = 'block';
            document.getElementById('context-section').style.display = 'none';
            document.getElementById('readings-section').style.display = 'none';
            
            selectedMonth = null;
            lecturasActuales = {};
            lecturasAnteriores = {}; // üÜï LIMPIAR TAMBI√âN
            balanceMensual = { entrada: 0, salida: 0 };
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function formatearNumero(numero) {
            return new Intl.NumberFormat('es-CO', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(numero);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.cargarDatosMes = cargarDatosMes;
        window.guardarLectura = guardarLectura;
        window.eliminarLectura = eliminarLectura;
        window.limpiarFormulario = limpiarFormulario;
        
        console.log('üéâ monthly-water-readings.html cargado correctamente');
    </script>
</body>
</html>
