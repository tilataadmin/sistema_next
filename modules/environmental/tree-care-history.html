<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Cuidados - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Gestión Ambiental</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Historial de Cuidados
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-clock-history me-2"></i>
                    Historial de Cuidados
                </h1>
                <p class="text-muted">
                    Registro completo de mantenimientos realizados
                </p>
            </div>
        </div>

        <!-- ALERTAS -->
        <div id="alertContainer"></div>

        <!-- FILTROS -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="filtro-arbol" class="form-label">Filtrar por Árbol</label>
                        <select class="form-select" id="filtro-arbol" onchange="aplicarFiltros()">
                            <option value="">Todos los árboles</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filtro-tipo" class="form-label">Tipo de Cuidado</label>
                        <select class="form-select" id="filtro-tipo" onchange="aplicarFiltros()">
                            <option value="">Todos los tipos</option>
                            <option value="poda">Poda</option>
                            <option value="riego">Riego</option>
                            <option value="fertilización">Fertilización</option>
                            <option value="fumigación">Fumigación</option>
                            <option value="inspección">Inspección</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filtro-fecha-desde" class="form-label">Desde</label>
                        <input type="date" class="form-control" id="filtro-fecha-desde" onchange="aplicarFiltros()">
                    </div>
                    <div class="col-md-2">
                        <label for="filtro-fecha-hasta" class="form-label">Hasta</label>
                        <input type="date" class="form-control" id="filtro-fecha-hasta" onchange="aplicarFiltros()">
                    </div>
                    <div class="col-md-2 d-flex align-items-end gap-2">
                        <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                            <i class="bi bi-x-circle me-1"></i>Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA PRINCIPAL -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>Registros de Cuidados
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="actualizarDatos()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                    <a href="register-tree-care.html" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle me-1"></i>Registrar Nuevo
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Fecha</th>
                                <th>Árbol</th>
                                <th>Tipo</th>
                                <th>Descripción</th>
                                <th>Realizado Por</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando historial...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    <!-- MODAL VER/EDITAR CUIDADO -->
    <div class="modal fade" id="modal-cuidado" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title">
                        <i class="bi bi-eye me-2"></i>Detalles del Cuidado
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-cuidado">
                    <div class="modal-body">
                        <input type="hidden" id="care-id" name="care_id">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="tree-id" class="form-label">
                                    Árbol <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="tree-id" name="tree_id" required>
                                    <option value="">Seleccione un árbol...</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="care-date" class="form-label">
                                    Fecha del Cuidado <span class="text-danger">*</span>
                                </label>
                                <input type="date" 
                                       class="form-control" 
                                       id="care-date" 
                                       name="care_date" 
                                       required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="care-type" class="form-label">
                                Tipo de Cuidado <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="care-type" name="care_type" required>
                                <option value="">Seleccione el tipo...</option>
                                <option value="poda">Poda</option>
                                <option value="riego">Riego</option>
                                <option value="fertilización">Fertilización</option>
                                <option value="fumigación">Fumigación</option>
                                <option value="inspección">Inspección</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="care-description" class="form-label">
                                Descripción del Cuidado <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" 
                                      id="care-description" 
                                      name="care_description"
                                      rows="5"
                                      required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="worker-name" class="form-label">
                                Nombre del Trabajador
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="worker-name" 
                                   name="worker_name">
                            <small class="text-muted">Opcional - Solo para personal externo</small>
                        </div>
                        
                        <div class="alert alert-info mb-0" id="info-registro" style="display: none;">
                            <small>
                                <strong>Información del registro:</strong><br>
                                <span id="info-texto"></span>
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cerrar
                        </button>
                        <button type="submit" class="btn btn-primary" id="btn-guardar">
                            <i class="bi bi-check-circle me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let cuidadosCache = [];
        let arbolesActivos = [];
        let modalInstance = null;
        let modoEdicion = false;
        let cuidadoEditando = null;
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Historial de cuidados');
                if (!hasAccess) {
                    console.log('❌ Acceso denegado - deteniendo inicialización');
                    return;
                }
                
                console.log('✅ Acceso permitido - continuando con inicialización');
                await inicializarPagina();
                
            } catch (error) {
                console.error('❌ Error en validación de acceso:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                modalInstance = new bootstrap.Modal(document.getElementById('modal-cuidado'));
                document.getElementById('form-cuidado').addEventListener('submit', manejarSubmitFormulario);
                
                // Establecer fecha máxima en filtros
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('filtro-fecha-hasta').value = today;
                document.getElementById('care-date').max = today;
                
                await cargarArbolesActivos();
                await cargarHistorial();
                
                ocultarLoading();
                console.log('✅ Página inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR ÁRBOLES ACTIVOS
        // ==========================================
        async function cargarArbolesActivos() {
            try {
                const datos = await supabaseRequest('/env_tree_inventory?select=tree_id,tree_number,location_description,env_tree_species(species_name)&tree_status=neq.removed&order=tree_number.asc');
                
                arbolesActivos = datos || [];
                
                const selectores = ['tree-id', 'filtro-arbol'];
                selectores.forEach(selectorId => {
                    const select = document.getElementById(selectorId);
                    const esFormulario = selectorId === 'tree-id';
                    
                    if (!esFormulario) {
                        select.innerHTML = '<option value="">Todos los árboles</option>';
                    } else {
                        select.innerHTML = '<option value="">Seleccione un árbol...</option>';
                    }
                    
                    arbolesActivos.forEach(arbol => {
                        const option = document.createElement('option');
                        option.value = arbol.tree_id;
                        
                        let texto = `#${arbol.tree_number}`;
                        if (arbol.env_tree_species?.species_name) {
                            texto += ` - ${arbol.env_tree_species.species_name}`;
                        }
                        if (arbol.location_description) {
                            texto += ` - ${arbol.location_description}`;
                        }
                        
                        option.textContent = texto;
                        select.appendChild(option);
                    });
                });
                
                console.log(`✅ ${arbolesActivos.length} árboles activos cargados`);
                
            } catch (error) {
                console.error('❌ Error cargando árboles:', error);
            }
        }
        
        // ==========================================
        // CARGAR HISTORIAL
        // ==========================================
        async function cargarHistorial() {
            try {
                console.log('📡 Cargando historial de cuidados...');
                
                const datos = await supabaseRequest('/env_tree_care_log?select=*,env_tree_inventory(tree_number,env_tree_species(species_name))&order=care_date.desc,created_at.desc');
                
                cuidadosCache = datos || [];
                renderizarTabla(cuidadosCache);
                
                console.log(`✅ ${cuidadosCache.length} cuidados cargados`);
                
            } catch (error) {
                console.error('❌ Error cargando historial:', error);
                showMessage('Error al cargar historial: ' + error.message, 'danger');
                
                document.getElementById('tabla-body').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="bi bi-exclamation-triangle text-warning"></i>
                            <div class="mt-2">Error al cargar datos</div>
                        </td>
                    </tr>
                `;
            }
        }
        
        // ==========================================
        // RENDERIZAR TABLA
        // ==========================================
        function renderizarTabla(datos) {
            const tbody = document.getElementById('tabla-body');
            
            if (!datos || datos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="bi bi-inbox"></i>
                            <div class="mt-2">No hay cuidados registrados</div>
                            <a href="register-tree-care.html" class="btn btn-sm btn-primary mt-2">
                                <i class="bi bi-plus-circle me-1"></i>Registrar Primer Cuidado
                            </a>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = datos.map(cuidado => `
                <tr>
                    <td>${formatDate(cuidado.care_date)}</td>
                    <td>
                        <strong>#${cuidado.env_tree_inventory?.tree_number || '-'}</strong><br>
                        <small class="text-muted">${cuidado.env_tree_inventory?.env_tree_species?.species_name || 'Sin especie'}</small>
                    </td>
                    <td><span class="badge bg-success">${getCareTypeLabel(cuidado.care_type)}</span></td>
                    <td>${escapeHtml(cuidado.care_description.substring(0, 80))}${cuidado.care_description.length > 80 ? '...' : ''}</td>
                    <td><small>${cuidado.worker_name || '<span class="text-muted">Sistema</span>'}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" 
                                    onclick="verCuidado('${cuidado.care_id}')" 
                                    title="Ver/Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" 
                                    onclick="confirmarEliminar('${cuidado.care_id}')" 
                                    title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
      // ==========================================
        // VER/EDITAR CUIDADO
        // ==========================================
        async function verCuidado(careId) {
            try {
                mostrarLoading();
                
                const cuidado = cuidadosCache.find(c => c.care_id === careId);
                
                if (!cuidado) {
                    throw new Error('Cuidado no encontrado');
                }
                
                modoEdicion = true;
                cuidadoEditando = cuidado;
                
                document.getElementById('modal-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Cuidado';
                document.getElementById('care-id').value = cuidado.care_id;
                document.getElementById('tree-id').value = cuidado.tree_id;
                document.getElementById('care-date').value = cuidado.care_date;
                document.getElementById('care-type').value = cuidado.care_type;
                document.getElementById('care-description').value = cuidado.care_description;
                document.getElementById('worker-name').value = cuidado.worker_name || '';
                
                // Mostrar info de registro
                const infoTexto = `Registrado el ${formatDate(cuidado.created_at)} ${cuidado.updated_at ? '• Última actualización: ' + formatDate(cuidado.updated_at) : ''}`;
                document.getElementById('info-texto').textContent = infoTexto;
                document.getElementById('info-registro').style.display = 'block';
                
                ocultarLoading();
                modalInstance.show();
                
            } catch (error) {
                console.error('❌ Error cargando cuidado:', error);
                showMessage('Error al cargar cuidado: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // MANEJAR SUBMIT
        // ==========================================
        async function manejarSubmitFormulario(e) {
            e.preventDefault();
            
            try {
                mostrarLoading();
                
                const formData = new FormData(e.target);
                const datos = {
                    tree_id: formData.get('tree_id'),
                    care_date: formData.get('care_date'),
                    care_type: formData.get('care_type'),
                    care_description: formData.get('care_description').trim(),
                    worker_name: formData.get('worker_name')?.trim() || null
                };
                
                // Validaciones
                if (!datos.tree_id) {
                    throw new Error('Debe seleccionar un árbol');
                }
                
                if (!datos.care_type) {
                    throw new Error('Debe seleccionar el tipo de cuidado');
                }
                
                if (!datos.care_description) {
                    throw new Error('La descripción es obligatoria');
                }
                
                // Validar fecha no sea futura
                const today = new Date().toISOString().split('T')[0];
                if (datos.care_date > today) {
                    throw new Error('La fecha del cuidado no puede ser futura');
                }
                
                const careId = document.getElementById('care-id').value;
                
                await supabaseRequest('/env_tree_care_log?care_id=eq.' + careId, {
                    method: 'PATCH',
                    body: JSON.stringify(datos)
                });
                
                showMessage('Cuidado actualizado exitosamente', 'success');
                modalInstance.hide();
                await cargarHistorial();
                
            } catch (error) {
                console.error('❌ Error guardando cuidado:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CONFIRMAR ELIMINACIÓN
        // ==========================================
        function confirmarEliminar(careId) {
            if (confirm('¿Está seguro de eliminar este registro de cuidado?\n\nEsta acción no se puede deshacer.')) {
                eliminarCuidado(careId);
            }
        }
        
        // ==========================================
        // ELIMINAR CUIDADO
        // ==========================================
        async function eliminarCuidado(careId) {
            try {
                mostrarLoading();
                
                await supabaseRequest('/env_tree_care_log?care_id=eq.' + careId, {
                    method: 'DELETE'
                });
                
                showMessage('Cuidado eliminado exitosamente', 'success');
                await cargarHistorial();
                
            } catch (error) {
                console.error('❌ Error eliminando cuidado:', error);
                showMessage('Error al eliminar: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // APLICAR FILTROS
        // ==========================================
        function aplicarFiltros() {
            const treeId = document.getElementById('filtro-arbol').value;
            const tipo = document.getElementById('filtro-tipo').value;
            const fechaDesde = document.getElementById('filtro-fecha-desde').value;
            const fechaHasta = document.getElementById('filtro-fecha-hasta').value;
            
            let datosFiltrados = [...cuidadosCache];
            
            if (treeId) {
                datosFiltrados = datosFiltrados.filter(c => c.tree_id === treeId);
            }
            
            if (tipo) {
                datosFiltrados = datosFiltrados.filter(c => c.care_type === tipo);
            }
            
            if (fechaDesde) {
                datosFiltrados = datosFiltrados.filter(c => c.care_date >= fechaDesde);
            }
            
            if (fechaHasta) {
                datosFiltrados = datosFiltrados.filter(c => c.care_date <= fechaHasta);
            }
            
            renderizarTabla(datosFiltrados);
        }
        
        function limpiarFiltros() {
            document.getElementById('filtro-arbol').value = '';
            document.getElementById('filtro-tipo').value = '';
            document.getElementById('filtro-fecha-desde').value = '';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filtro-fecha-hasta').value = today;
            renderizarTabla(cuidadosCache);
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        function getCareTypeLabel(type) {
            const labels = {
                'poda': 'Poda',
                'riego': 'Riego',
                'fertilización': 'Fertilización',
                'fumigación': 'Fumigación',
                'inspección': 'Inspección',
                'otro': 'Otro'
            };
            return labels[type] || type;
        }
        
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function actualizarDatos() {
            cargarHistorial();
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // GLOBALES
        // ==========================================
        window.verCuidado = verCuidado;
        window.confirmarEliminar = confirmarEliminar;
        window.aplicarFiltros = aplicarFiltros;
        window.limpiarFiltros = limpiarFiltros;
        window.actualizarDatos = actualizarDatos;
        
        console.log('✅ Historial de Cuidados cargado correctamente');
    </script>
</body>
</html>
