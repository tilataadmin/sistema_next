<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Árboles - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #map {
            height: 600px;
            border-radius: 8px;
        }
        
        .tree-item {
            padding: 0.5rem;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .tree-item:hover {
            background-color: #f8f9fa;
        }
        
        .tree-item:last-child {
            border-bottom: none;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 0.5rem;
            border: 2px solid #fff;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando mapa...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Gestión Ambiental</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Mapa de Árboles
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-map me-2"></i>
                    Mapa de Árboles
                </h1>
                <p class="text-muted">
                    Vista geográfica del arbolado del colegio
                </p>
            </div>
        </div>

        <!-- ALERTAS -->
        <div id="alertContainer"></div>

        <!-- FILTROS -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label for="filtro-especie" class="form-label">Filtrar por Especie</label>
                        <select class="form-select" id="filtro-especie" onchange="aplicarFiltros()">
                            <option value="">Todas las especies</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="filtro-estado" class="form-label">Filtrar por Estado</label>
                        <select class="form-select" id="filtro-estado" onchange="aplicarFiltros()">
                            <option value="">Todos los estados</option>
                            <option value="healthy">Sano</option>
                            <option value="sick">Enfermo</option>
                            <option value="at_risk">En Riesgo</option>
                            <option value="dead">Muerto</option>
                            <option value="removed">Removido</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                            <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- COLUMNA PRINCIPAL: MAPA -->
            <div class="col-lg-9 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-geo-alt me-2"></i>Ubicación de Árboles
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="map"></div>
                    </div>
                </div>
                
                <!-- LEYENDA -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h6 class="mb-3">Leyenda</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #28a745;"></div>
                                    <span>Sano</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #ffc107;"></div>
                                    <span>Enfermo</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #fd7e14;"></div>
                                    <span>En Riesgo</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #6c757d;"></div>
                                    <span>Muerto</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #dc3545;"></div>
                                    <span>Removido</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- COLUMNA LATERAL: ÁRBOLES SIN COORDENADAS -->
            <div class="col-lg-3">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>Sin Ubicación GPS
                        </h6>
                    </div>
                    <div class="card-body p-0" style="max-height: 700px; overflow-y: auto;">
                        <div id="sin-coordenadas-container">
                            <div class="text-center py-4">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let arbolesCache = [];
        let especiesActivas = [];
        let map = null;
        let markersLayer = null;
        let campusCoords = { lat: 4.7110, lng: -74.0721 }; // Default Bogotá
        
        // Colores por estado
        const statusColors = {
            'healthy': '#28a745',
            'sick': '#ffc107',
            'at_risk': '#fd7e14',
            'dead': '#6c757d',
            'removed': '#dc3545'
        };
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Mapa de árboles');
                if (!hasAccess) {
                    console.log('❌ Acceso denegado - deteniendo inicialización');
                    return;
                }
                
                console.log('✅ Acceso permitido - continuando con inicialización');
                await inicializarPagina();
                
            } catch (error) {
                console.error('❌ Error en validación de acceso:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                await cargarConfiguracionCampus();
                await cargarEspeciesActivas();
                await cargarArboles();
                inicializarMapa();
                
                ocultarLoading();
                console.log('✅ Página inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR CONFIGURACIÓN DEL CAMPUS
        // ==========================================
        async function cargarConfiguracionCampus() {
            try {
                const config = await supabaseRequest('/system_config?select=campus_latitude,campus_longitude&limit=1');
                
                if (config && config.length > 0 && config[0].campus_latitude && config[0].campus_longitude) {
                    campusCoords = {
                        lat: config[0].campus_latitude,
                        lng: config[0].campus_longitude
                    };
                    console.log('✅ Coordenadas del campus cargadas:', campusCoords);
                } else {
                    console.log('⚠️ No hay coordenadas del campus, usando default Bogotá');
                }
                
            } catch (error) {
                console.log('⚠️ Error cargando coordenadas del campus, usando default');
            }
        }
        
        // ==========================================
        // CARGAR ESPECIES ACTIVAS
        // ==========================================
        async function cargarEspeciesActivas() {
            try {
                const datos = await supabaseRequest('/env_tree_species?select=species_id,species_name&species_status=eq.active&order=species_name.asc');
                
                especiesActivas = datos || [];
                
                const select = document.getElementById('filtro-especie');
                select.innerHTML = '<option value="">Todas las especies</option>';
                
                especiesActivas.forEach(especie => {
                    const option = document.createElement('option');
                    option.value = especie.species_id;
                    option.textContent = especie.species_name;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('❌ Error cargando especies:', error);
            }
        }
        
        // ==========================================
        // CARGAR ÁRBOLES
        // ==========================================
        async function cargarArboles() {
            try {
                console.log('📡 Cargando árboles...');
                
                const datos = await supabaseRequest('/env_tree_inventory?select=*,env_tree_species(species_name)&order=tree_number.asc');
                
                arbolesCache = datos || [];
                console.log(`✅ ${arbolesCache.length} árboles cargados`);
                
            } catch (error) {
                console.error('❌ Error cargando árboles:', error);
                showMessage('Error al cargar árboles: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // INICIALIZAR MAPA
        // ==========================================
        function inicializarMapa() {
            // Calcular centro del mapa
            const arbolesConCoords = arbolesCache.filter(a => a.location_latitude && a.location_longitude);
            
            let center = campusCoords;
            let zoom = 15;
            
            if (arbolesConCoords.length > 0) {
                const avgLat = arbolesConCoords.reduce((sum, a) => sum + a.location_latitude, 0) / arbolesConCoords.length;
                const avgLng = arbolesConCoords.reduce((sum, a) => sum + a.location_longitude, 0) / arbolesConCoords.length;
                center = { lat: avgLat, lng: avgLng };
            }
            
            // Crear mapa
            map = L.map('map').setView([center.lat, center.lng], zoom);
            
            // Agregar capa de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Crear capa de marcadores
            markersLayer = L.layerGroup().addTo(map);
            
            // Agregar marcadores
            agregarMarcadores(arbolesCache);
            
            // Mostrar árboles sin coordenadas
            mostrarArbolesSinCoordenadas(arbolesCache);
        }
      // ==========================================
        // AGREGAR MARCADORES AL MAPA
        // ==========================================
        function agregarMarcadores(arboles) {
            // Limpiar marcadores existentes
            markersLayer.clearLayers();
            
            const arbolesConCoords = arboles.filter(a => a.location_latitude && a.location_longitude);
            
            arbolesConCoords.forEach(arbol => {
                const color = statusColors[arbol.tree_status] || '#6c757d';
                
                // Crear icono personalizado
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [20, 20]
                });
                
                // Crear marcador
                const marker = L.marker([arbol.location_latitude, arbol.location_longitude], { icon: icon });
                
                // Crear popup
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h6><strong>#${arbol.tree_number}</strong></h6>
                        <p class="mb-1"><strong>Especie:</strong> ${arbol.env_tree_species?.species_name || 'Sin especie'}</p>
                        <p class="mb-1"><strong>Estado:</strong> <span style="color: ${color};">${getStatusLabel(arbol.tree_status)}</span></p>
                        ${arbol.location_description ? `<p class="mb-1"><strong>Ubicación:</strong> ${escapeHtml(arbol.location_description)}</p>` : ''}
                        ${arbol.planting_date ? `<p class="mb-1"><strong>Siembra:</strong> ${formatDate(arbol.planting_date)}</p>` : ''}
                        <hr class="my-2">
                        <a href="tree-inventory.html" class="btn btn-sm btn-outline-primary w-100">
                            <i class="bi bi-pencil me-1"></i>Ver Detalles
                        </a>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                marker.addTo(markersLayer);
            });
            
            console.log(`✅ ${arbolesConCoords.length} marcadores agregados al mapa`);
        }
        
        // ==========================================
        // MOSTRAR ÁRBOLES SIN COORDENADAS
        // ==========================================
        function mostrarArbolesSinCoordenadas(arboles) {
            const arbolesSinCoords = arboles.filter(a => !a.location_latitude || !a.location_longitude);
            const container = document.getElementById('sin-coordenadas-container');
            
            if (arbolesSinCoords.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0 small">Todos los árboles tienen ubicación GPS</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = arbolesSinCoords.map(arbol => `
                <div class="tree-item" onclick="window.location.href='tree-inventory.html'">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong class="small">#${arbol.tree_number}</strong><br>
                            <small class="text-muted">${arbol.env_tree_species?.species_name || 'Sin especie'}</small>
                        </div>
                        <span class="badge bg-warning text-dark">Sin GPS</span>
                    </div>
                    ${arbol.location_description ? `<small class="text-muted d-block mt-1">${escapeHtml(arbol.location_description)}</small>` : ''}
                </div>
            `).join('');
            
            console.log(`⚠️ ${arbolesSinCoords.length} árboles sin coordenadas GPS`);
        }
        
        // ==========================================
        // APLICAR FILTROS
        // ==========================================
        function aplicarFiltros() {
            const speciesId = document.getElementById('filtro-especie').value;
            const estado = document.getElementById('filtro-estado').value;
            
            let arbolesFiltrados = [...arbolesCache];
            
            if (speciesId) {
                arbolesFiltrados = arbolesFiltrados.filter(a => a.species_id === speciesId);
            }
            
            if (estado) {
                arbolesFiltrados = arbolesFiltrados.filter(a => a.tree_status === estado);
            }
            
            agregarMarcadores(arbolesFiltrados);
            mostrarArbolesSinCoordenadas(arbolesFiltrados);
        }
        
        function limpiarFiltros() {
            document.getElementById('filtro-especie').value = '';
            document.getElementById('filtro-estado').value = '';
            agregarMarcadores(arbolesCache);
            mostrarArbolesSinCoordenadas(arbolesCache);
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        function getStatusLabel(status) {
            const labels = {
                'healthy': 'Sano',
                'sick': 'Enfermo',
                'at_risk': 'En Riesgo',
                'dead': 'Muerto',
                'removed': 'Removido'
            };
            return labels[status] || status;
        }
        
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // GLOBALES
        // ==========================================
        window.aplicarFiltros = aplicarFiltros;
        window.limpiarFiltros = limpiarFiltros;
        
        console.log('✅ Mapa de Árboles cargado correctamente');
    </script>
</body>
</html>
