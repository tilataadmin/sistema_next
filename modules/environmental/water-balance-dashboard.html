<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Balance H√≠drico - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* KPI Cards */
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
            border-left: 4px solid;
        }
        
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .kpi-card.entrada { border-left-color: #0d6efd; }
        .kpi-card.salida { border-left-color: #dc3545; }
        .kpi-card.balance { border-left-color: #198754; }
        .kpi-card.alarmas { border-left-color: #ffc107; }
        .kpi-card.poblacion { border-left-color: #6f42c1; }
        .kpi-card.percapita { border-left-color: #20c997; }
        .kpi-card.eficiencia { border-left-color: #0dcaf0; }
        
        .kpi-icon {
            font-size: 2rem;
            opacity: 0.15;
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        
        .kpi-label {
            font-size: 0.875rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .kpi-comparison {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .comparison-up { color: #198754; }
        .comparison-down { color: #dc3545; }
        .comparison-neutral { color: #6c757d; }
        
        /* Chart Containers */
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .chart-container-large {
            height: 400px;
        }
        
        /* Filters Card */
        .filters-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            color: white;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }
        
        .filters-card label {
            color: white;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .filters-card .form-select {
            background: rgba(255, 255, 255, 0.9);
        }
        
        /* Area Selector Card */
        .area-selector-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        /* Stats Card */
        .stats-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-item-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        
        .stat-item-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #495057;
        }
        
        /* Table Styling */
        .summary-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .summary-table thead {
            background: #f8f9fa;
        }
        
        .summary-table th {
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            color: #495057;
            padding: 1rem;
            border-bottom: 2px solid #dee2e6;
        }
        
        .summary-table td {
            padding: 1rem;
            vertical-align: middle;
        }
        
        .summary-table tbody tr {
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        .summary-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Status Badges */
        .status-normal { 
            color: #198754; 
            font-size: 1.25rem;
        }
        
        .status-warning { 
            color: #ffc107; 
            font-size: 1.25rem;
        }
        
        .status-critical { 
            color: #dc3545; 
            font-size: 1.25rem;
        }
        
        /* Badge Alarma */
        .badge-alarm {
            padding: 0.35rem 0.65rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .badge-alarm:hover {
            transform: scale(1.1);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .kpi-value {
                font-size: 1.5rem;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .chart-container-large {
                height: 300px;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando dashboard...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Gesti√≥n Ambiental</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Dashboard de Balance H√≠drico
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    Dashboard de Balance H√≠drico
                </h1>
                <p class="text-muted">
                    An√°lisis y visualizaci√≥n del consumo de agua
                </p>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-primary" onclick="exportarPDF()">
                    <i class="bi bi-file-earmark-pdf me-2"></i>Exportar PDF
                </button>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>
        <!-- FILTROS -->
        <div class="filters-card">
            <div class="row align-items-end g-3">
                <div class="col-md-3">
                    <label for="filter-period" class="form-label">
                        <i class="bi bi-calendar-range me-1"></i>Per√≠odo
                    </label>
                    <select class="form-select" id="filter-period">
                        <option value="week">√öltima semana</option>
                        <option value="month" selected>√öltimo mes</option>
                        <option value="3months">√öltimos 3 meses</option>
                        <option value="6months">√öltimos 6 meses</option>
                        <option value="year">A√±o actual</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>
                <div class="col-md-3" id="custom-date-start-group" style="display: none;">
                    <label for="custom-date-start" class="form-label">Fecha Inicio</label>
                    <input type="date" class="form-control" id="custom-date-start">
                </div>
                <div class="col-md-3" id="custom-date-end-group" style="display: none;">
                    <label for="custom-date-end" class="form-label">Fecha Fin</label>
                    <input type="date" class="form-control" id="custom-date-end">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-light w-100" onclick="actualizarDashboard()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Actualizar
                    </button>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 1: KPIs PRINCIPALES -->
        <div class="row g-3 mb-4">
            <!-- Entrada Total -->
            <div class="col-md-6 col-lg-3">
                <div class="kpi-card entrada">
                    <i class="bi bi-droplet-fill kpi-icon text-primary"></i>
                    <div class="kpi-label">üíß Entrada Total</div>
                    <div class="kpi-value text-primary" id="kpi-entrada">-- m¬≥</div>
                    <div class="kpi-comparison" id="kpi-entrada-comp">
                        <span>--</span>
                    </div>
                </div>
            </div>
            
            <!-- Salida Total -->
            <div class="col-md-6 col-lg-3">
                <div class="kpi-card salida">
                    <i class="bi bi-droplet-half kpi-icon text-danger"></i>
                    <div class="kpi-label">üö∞ Salida Total</div>
                    <div class="kpi-value text-danger" id="kpi-salida">-- m¬≥</div>
                    <div class="kpi-comparison" id="kpi-salida-comp">
                        <span>--</span>
                    </div>
                </div>
            </div>
            
            <!-- Balance Promedio -->
            <div class="col-md-6 col-lg-3">
                <div class="kpi-card balance">
                    <i class="bi bi-activity kpi-icon text-success"></i>
                    <div class="kpi-label">‚öñÔ∏è Balance Promedio</div>
                    <div class="kpi-value" id="kpi-balance">--%</div>
                    <div class="kpi-comparison" id="kpi-balance-status">
                        <span>--</span>
                    </div>
                </div>
            </div>
            
            <!-- Alarmas -->
            <div class="col-md-6 col-lg-3">
                <div class="kpi-card alarmas" style="cursor: pointer;" onclick="verAlarmas()">
                    <i class="bi bi-exclamation-triangle-fill kpi-icon text-warning"></i>
                    <div class="kpi-label">üö® Alarmas del Per√≠odo</div>
                    <div class="kpi-value text-warning" id="kpi-alarmas">--</div>
                    <div class="kpi-comparison" id="kpi-alarmas-detail">
                        <span>--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 2: M√âTRICAS PER C√ÅPITA -->
        <h5 class="mb-3">
            <i class="bi bi-people me-2"></i>M√©tricas Per C√°pita
        </h5>
        
        <div class="row g-3 mb-4">
            <!-- Poblaci√≥n Activa -->
            <div class="col-md-4">
                <div class="kpi-card poblacion">
                    <i class="bi bi-people-fill kpi-icon" style="color: #6f42c1;"></i>
                    <div class="kpi-label">üë• Poblaci√≥n Activa</div>
                    <div class="kpi-value" style="color: #6f42c1;" id="kpi-poblacion">--</div>
                    <div class="kpi-comparison">
                        <small>
                            Estudiantes: <strong id="kpi-estudiantes">--</strong> | 
                            Trabajadores: <strong id="kpi-trabajadores">--</strong>
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Consumo Per C√°pita -->
            <div class="col-md-4">
                <div class="kpi-card percapita">
                    <i class="bi bi-droplet kpi-icon" style="color: #20c997;"></i>
                    <div class="kpi-label">üíß Consumo Per C√°pita</div>
                    <div class="kpi-value" style="color: #20c997;" id="kpi-percapita">-- m¬≥/persona</div>
                    <div class="kpi-comparison">
                        <small>Promedio diario del per√≠odo</small>
                    </div>
                </div>
            </div>
            
            <!-- Eficiencia -->
            <div class="col-md-4">
                <div class="kpi-card eficiencia">
                    <i class="bi bi-graph-up kpi-icon" style="color: #0dcaf0;"></i>
                    <div class="kpi-label">üìä Eficiencia</div>
                    <div class="kpi-value" style="color: #0dcaf0;" id="kpi-eficiencia">--%</div>
                    <div class="kpi-comparison" id="kpi-eficiencia-comp">
                        <span>vs. per√≠odo anterior</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°fico: Tendencia Consumo Per C√°pita -->
        <div class="chart-card">
            <div class="chart-title">
                <i class="bi bi-graph-up"></i>
                Tendencia de Consumo Per C√°pita
            </div>
            <div class="chart-container">
                <canvas id="chart-percapita"></canvas>
            </div>
        </div>

        <!-- SECCI√ìN 3: GR√ÅFICOS PRINCIPALES -->
        <h5 class="mb-3">
            <i class="bi bi-bar-chart me-2"></i>An√°lisis General
        </h5>
        
        <div class="row g-3 mb-4">
            <!-- Tendencia Mensual -->
            <div class="col-lg-8">
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="bi bi-graph-up"></i>
                        Tendencia del Per√≠odo: Entrada, Salida y Balance
                    </div>
                    <div class="chart-container chart-container-large">
                        <canvas id="chart-trend"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Distribuci√≥n de Entrada -->
            <div class="col-lg-4">
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="bi bi-pie-chart"></i>
                        Distribuci√≥n de Entrada
                    </div>
                    <div class="chart-container">
                        <canvas id="chart-entrada-dist"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 4: AN√ÅLISIS POR √ÅREA ESPEC√çFICA -->
        <h5 class="mb-3">
            <i class="bi bi-geo-alt me-2"></i>An√°lisis por √Årea Espec√≠fica
        </h5>
        
        <div class="area-selector-card">
            <div class="row align-items-end g-3 mb-3">
                <div class="col-md-8">
                    <label for="select-area" class="form-label">
                        <i class="bi bi-building me-1"></i>Seleccionar √Årea de Consumo
                    </label>
                    <select class="form-select" id="select-area">
                        <option value="">-- Seleccionar √°rea --</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" onclick="cargarTendenciaArea()">
                        <i class="bi bi-search me-2"></i>Analizar
                    </button>
                </div>
            </div>
            
            <div id="area-analysis-container" style="display: none;">
                <div class="chart-container chart-container-large mb-3">
                    <canvas id="chart-area"></canvas>
                </div>
                
                <div class="stats-card">
                    <h6 class="mb-3">üìä Estad√≠sticas del √Årea</h6>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-item-label">Consumo Total</div>
                            <div class="stat-item-value" id="area-stat-total">-- m¬≥</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-item-label">Promedio Diario</div>
                            <div class="stat-item-value" id="area-stat-avg">-- m¬≥</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-item-label">M√°ximo</div>
                            <div class="stat-item-value" id="area-stat-max">-- m¬≥</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-item-label">M√≠nimo</div>
                            <div class="stat-item-value" id="area-stat-min">-- m¬≥</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 5: AN√ÅLISIS DETALLADO -->
        <h5 class="mb-3">
            <i class="bi bi-pie-chart me-2"></i>An√°lisis Detallado
        </h5>
        
        <div class="row g-3 mb-4">
            <!-- Consumo por √Åreas Top 5 -->
            <div class="col-lg-8">
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="bi bi-bar-chart-steps"></i>
                        Consumo por √Åreas (Top 5)
                    </div>
                    <div class="chart-container chart-container-large">
                        <canvas id="chart-areas-top"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Estado de Alarmas -->
            <div class="col-lg-4">
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="bi bi-pie-chart"></i>
                        Estado de Alarmas
                    </div>
                    <div class="chart-container">
                        <canvas id="chart-alarmas-status"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- SECCI√ìN 6: RESUMEN DIARIO -->
        <h5 class="mb-3">
            <i class="bi bi-table me-2"></i>Resumen Diario (√öltimos 7 D√≠as)
        </h5>
        
        <div class="card summary-table">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 15%;">Fecha</th>
                                <th style="width: 15%;" class="text-end">Entrada (m¬≥)</th>
                                <th style="width: 15%;" class="text-end">Salida (m¬≥)</th>
                                <th style="width: 15%;" class="text-end">Balance</th>
                                <th style="width: 10%;" class="text-center">Estado</th>
                                <th style="width: 15%;" class="text-center">Alarma</th>
                                <th style="width: 15%;" class="text-end">Per C√°pita</th>
                            </tr>
                        </thead>
                        <tbody id="summary-table-body">
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando resumen...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Espacio final -->
        <div class="mb-5"></div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let lecturasDelPeriodo = [];
        let alarmasDelPeriodo = [];
        let lecturasAreasDelPeriodo = [];
        let poblacionTotal = 0;
        let totalEstudiantes = 0;
        let totalTrabajadores = 0;
        let toleranciaWarning = 3;
        let toleranciaCritical = 10;
        
        // Referencias a gr√°ficos
        let chartTrend = null;
        let chartEntradaDist = null;
        let chartPerCapita = null;
        let chartArea = null;
        let chartAreasTop = null;
        let chartAlarmasStatus = null;
        
        // Per√≠odo actual
        let periodoInicio = null;
        let periodoFin = null;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Dashboard de balance h√≠drico');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                await inicializarDashboard();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        async function inicializarDashboard() {
            try {
                mostrarLoading();
                
                // Obtener usuario actual
                const session = getStoredSession();
                if (session && session.user) {
                    currentUser = session.user;
                }
                
                // Cargar tolerancias
                await cargarTolerancias();
                
                // Cargar poblaci√≥n activa
                await cargarPoblacionActiva();
                
                // Cargar medidores de √°reas para el selector
                await cargarMedidoresAreas();
                
                // Configurar event listeners
                configurarEventListeners();
                
                // Cargar datos del per√≠odo por defecto (√∫ltimo mes)
                await actualizarDashboard();
                
                ocultarLoading();
                console.log('‚úÖ Dashboard inicializado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando dashboard:', error);
                showMessage('Error al cargar el dashboard: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR TOLERANCIAS
        // ==========================================
        async function cargarTolerancias() {
            try {
                const config = await supabaseRequest('/system_config?select=water_balance_tolerance_warning,water_balance_tolerance_critical&limit=1');
                
                if (config && config.length > 0) {
                    toleranciaWarning = config[0].water_balance_tolerance_warning || 3;
                    toleranciaCritical = config[0].water_balance_tolerance_critical || 10;
                }
                
                console.log(`‚úÖ Tolerancias cargadas: Warning=${toleranciaWarning}%, Critical=${toleranciaCritical}%`);
                
            } catch (error) {
                console.error('‚ùå Error cargando tolerancias:', error);
            }
        }
        
        // ==========================================
        // CARGAR POBLACI√ìN ACTIVA
        // ==========================================
        async function cargarPoblacionActiva() {
            try {
                console.log('üì° Cargando poblaci√≥n activa...');
                
                // Obtener estado "Activo" de estudiantes
                const estadoActivo = await supabaseRequest('/student_status?select=status_id&status_description=eq.Activo&limit=1');
                
                if (!estadoActivo || estadoActivo.length === 0) {
                    console.warn('‚ö†Ô∏è No se encontr√≥ estado "Activo" para estudiantes');
                    totalEstudiantes = 0;
                } else {
                    const estudiantes = await supabaseRequest(`/students?select=student_id&status_id=eq.${estadoActivo[0].status_id}`);
                    totalEstudiantes = estudiantes ? estudiantes.length : 0;
                }
                
                // Obtener trabajadores activos
                const trabajadores = await supabaseRequest('/workers?select=worker_id&worker_status=eq.active');
                totalTrabajadores = trabajadores ? trabajadores.length : 0;
                
                poblacionTotal = totalEstudiantes + totalTrabajadores;
                
                console.log(`‚úÖ Poblaci√≥n activa: ${poblacionTotal} (${totalEstudiantes} estudiantes + ${totalTrabajadores} trabajadores)`);
                
                // Actualizar KPI
                document.getElementById('kpi-poblacion').textContent = formatearNumero(poblacionTotal, 0);
                document.getElementById('kpi-estudiantes').textContent = totalEstudiantes;
                document.getElementById('kpi-trabajadores').textContent = totalTrabajadores;
                
            } catch (error) {
                console.error('‚ùå Error cargando poblaci√≥n:', error);
                poblacionTotal = 1; // Evitar divisi√≥n por cero
            }
        }
        
        // ==========================================
        // CARGAR MEDIDORES DE √ÅREAS
        // ==========================================
        async function cargarMedidoresAreas() {
            try {
                const medidores = await supabaseRequest('/env_water_meters?select=meter_id,meter_name&meter_type=eq.area_consumo&is_active=eq.true&order=meter_name.asc');
                
                const select = document.getElementById('select-area');
                select.innerHTML = '<option value="">-- Seleccionar √°rea --</option>';
                
                if (medidores && medidores.length > 0) {
                    medidores.forEach(medidor => {
                        const option = document.createElement('option');
                        option.value = medidor.meter_id;
                        option.textContent = medidor.meter_name;
                        select.appendChild(option);
                    });
                }
                
                console.log(`‚úÖ ${medidores?.length || 0} medidores de √°reas cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando medidores:', error);
            }
        }
        
        // ==========================================
        // CONFIGURAR EVENT LISTENERS
        // ==========================================
        function configurarEventListeners() {
            // Cambio de per√≠odo
            document.getElementById('filter-period').addEventListener('change', function() {
                const period = this.value;
                
                if (period === 'custom') {
                    document.getElementById('custom-date-start-group').style.display = 'block';
                    document.getElementById('custom-date-end-group').style.display = 'block';
                    
                    // Configurar fechas por defecto
                    const hoy = new Date();
                    const haceUnMes = new Date();
                    haceUnMes.setMonth(haceUnMes.getMonth() - 1);
                    
                    document.getElementById('custom-date-start').value = haceUnMes.toISOString().split('T')[0];
                    document.getElementById('custom-date-end').value = hoy.toISOString().split('T')[0];
                } else {
                    document.getElementById('custom-date-start-group').style.display = 'none';
                    document.getElementById('custom-date-end-group').style.display = 'none';
                }
            });
            
            console.log('‚úÖ Event listeners configurados');
        }
        
        // ==========================================
        // CALCULAR RANGO DE FECHAS
        // ==========================================
        function calcularRangoFechas() {
            const period = document.getElementById('filter-period').value;
            const hoy = new Date();
            let inicio = new Date();
            
            switch (period) {
                case 'week':
                    inicio.setDate(hoy.getDate() - 7);
                    break;
                case 'month':
                    inicio.setMonth(hoy.getMonth() - 1);
                    break;
                case '3months':
                    inicio.setMonth(hoy.getMonth() - 3);
                    break;
                case '6months':
                    inicio.setMonth(hoy.getMonth() - 6);
                    break;
                case 'year':
                    inicio.setMonth(0);
                    inicio.setDate(1);
                    break;
                case 'custom':
                    const startInput = document.getElementById('custom-date-start').value;
                    const endInput = document.getElementById('custom-date-end').value;
                    
                    if (!startInput || !endInput) {
                        showMessage('Por favor selecciona ambas fechas', 'warning');
                        return null;
                    }
                    
                    inicio = new Date(startInput);
                    hoy.setTime(new Date(endInput).getTime());
                    break;
            }
            
            periodoInicio = inicio.toISOString().split('T')[0];
            periodoFin = hoy.toISOString().split('T')[0];
            
            return { inicio: periodoInicio, fin: periodoFin };
        }
      // ==========================================
        // ACTUALIZAR DASHBOARD
        // ==========================================
        async function actualizarDashboard() {
            try {
                mostrarLoading();
                
                // Calcular rango de fechas
                const rango = calcularRangoFechas();
                if (!rango) {
                    ocultarLoading();
                    return;
                }
                
                console.log(`üìä Actualizando dashboard: ${rango.inicio} a ${rango.fin}`);
                
                // Cargar datos del per√≠odo
                await cargarDatosDelPeriodo();
                
                // Calcular y actualizar KPIs
                calcularKPIs();
                
                // Renderizar gr√°ficos
                renderizarGraficos();
                
                // Renderizar tabla de resumen
                renderizarTablaResumen();
                
                ocultarLoading();
                console.log('‚úÖ Dashboard actualizado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error actualizando dashboard:', error);
                showMessage('Error al actualizar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR DATOS DEL PER√çODO
        // ==========================================
        async function cargarDatosDelPeriodo() {
            try {
                // 1. Lecturas diarias
                console.log('üì° Cargando lecturas diarias...');
                const lecturas = await supabaseRequest(`/env_water_readings_daily?select=*&reading_date=gte.${periodoInicio}&reading_date=lte.${periodoFin}&is_baseline=eq.false&order=reading_date.asc`);
                lecturasDelPeriodo = lecturas || [];
                console.log(`‚úÖ ${lecturasDelPeriodo.length} lecturas diarias cargadas`);
                
                // 2. Alarmas del per√≠odo
                console.log('üì° Cargando alarmas...');
                const alarmas = await supabaseRequest(`/env_water_alerts?select=*&alert_date=gte.${periodoInicio}&alert_date=lte.${periodoFin}&order=alert_date.desc`);
                alarmasDelPeriodo = alarmas || [];
                console.log(`‚úÖ ${alarmasDelPeriodo.length} alarmas cargadas`);
                
                // 3. Lecturas mensuales de √°reas (si existen en el per√≠odo)
                console.log('üì° Cargando lecturas de √°reas...');
                
                // Construir filtro de meses del per√≠odo
                const inicioDate = new Date(periodoInicio);
                const finDate = new Date(periodoFin);
                const mesesQuery = [];
                
                let currentDate = new Date(inicioDate);
                while (currentDate <= finDate) {
                    const mesKey = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0') + '-01';
                    mesesQuery.push(mesKey);
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
                
                if (mesesQuery.length > 0) {
                    // Usar operador IN con array de fechas
                    const lecturasAreas = await supabaseRequest(`/env_water_readings_monthly?select=*,env_water_meters(meter_name)&reading_month=in.(${mesesQuery.join(',')})&order=reading_value.desc`);
                    lecturasAreasDelPeriodo = lecturasAreas || [];
                    console.log(`‚úÖ ${lecturasAreasDelPeriodo.length} lecturas de √°reas cargadas`);
                } else {
                    lecturasAreasDelPeriodo = [];
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CALCULAR KPIs
        // ==========================================
        function calcularKPIs() {
            if (lecturasDelPeriodo.length === 0) {
                showMessage('No hay datos disponibles para el per√≠odo seleccionado', 'warning');
                return;
            }
            
            // 1. ENTRADA TOTAL
            const entradaTotal = lecturasDelPeriodo.reduce((sum, l) => sum + (l.total_entrada || 0), 0);
            document.getElementById('kpi-entrada').textContent = formatearNumero(entradaTotal, 0) + ' m¬≥';
            
            // Comparaci√≥n con per√≠odo anterior
            calcularComparacionPeriodo('entrada', entradaTotal);
            
            // 2. SALIDA TOTAL
            const salidaTotal = lecturasDelPeriodo.reduce((sum, l) => sum + (l.total_salida || 0), 0);
            document.getElementById('kpi-salida').textContent = formatearNumero(salidaTotal, 0) + ' m¬≥';
            
            calcularComparacionPeriodo('salida', salidaTotal);
            
            // 3. BALANCE PROMEDIO
            const balances = lecturasDelPeriodo.map(l => l.diferencia_porcentaje || 0);
            const balancePromedio = balances.reduce((sum, b) => sum + b, 0) / balances.length;
            
            document.getElementById('kpi-balance').textContent = formatearNumero(balancePromedio, 1) + '%';
            
            // Estado del balance
            let estadoBalance = 'üü¢ Normal';
            let colorBalance = 'success';
            
            const balanceAbs = Math.abs(balancePromedio);
            if (balanceAbs >= toleranciaCritical) {
                estadoBalance = 'üî¥ Cr√≠tico';
                colorBalance = 'danger';
            } else if (balanceAbs >= toleranciaWarning) {
                estadoBalance = 'üü° Advertencia';
                colorBalance = 'warning';
            }
            
            document.getElementById('kpi-balance').className = `kpi-value text-${colorBalance}`;
            document.getElementById('kpi-balance-status').innerHTML = `<span class="text-${colorBalance}">${estadoBalance}</span>`;
            
            // 4. ALARMAS
            const totalAlarmas = alarmasDelPeriodo.length;
            const alarmasWarning = alarmasDelPeriodo.filter(a => a.alert_type === 'warning').length;
            const alarmasCritical = alarmasDelPeriodo.filter(a => a.alert_type === 'critical').length;
            
            document.getElementById('kpi-alarmas').textContent = totalAlarmas;
            document.getElementById('kpi-alarmas-detail').innerHTML = `<small>${alarmasWarning}üü° ${alarmasCritical}üî¥</small>`;
            
            // 5. CONSUMO PER C√ÅPITA
            if (poblacionTotal > 0 && lecturasDelPeriodo.length > 0) {
                const diasDelPeriodo = lecturasDelPeriodo.length;
                const consumoPerCapita = entradaTotal / diasDelPeriodo / poblacionTotal;
                
                document.getElementById('kpi-percapita').textContent = formatearNumero(consumoPerCapita, 2) + ' m¬≥/persona';
                
                // 6. EFICIENCIA (comparaci√≥n con per√≠odo anterior)
                calcularEficiencia(consumoPerCapita);
            } else {
                document.getElementById('kpi-percapita').textContent = 'N/A';
                document.getElementById('kpi-eficiencia').textContent = 'N/A';
            }
        }
        
        // ==========================================
        // CALCULAR COMPARACI√ìN CON PER√çODO ANTERIOR
        // ==========================================
        async function calcularComparacionPeriodo(tipo, valorActual) {
            try {
                // Calcular per√≠odo anterior (mismo rango de d√≠as)
                const diasDiferencia = Math.floor((new Date(periodoFin) - new Date(periodoInicio)) / (1000 * 60 * 60 * 24)) + 1;
                
                const fechaInicioAnterior = new Date(periodoInicio);
                fechaInicioAnterior.setDate(fechaInicioAnterior.getDate() - diasDiferencia);
                
                const fechaFinAnterior = new Date(periodoInicio);
                fechaFinAnterior.setDate(fechaFinAnterior.getDate() - 1);
                
                const inicioAnterior = fechaInicioAnterior.toISOString().split('T')[0];
                const finAnterior = fechaFinAnterior.toISOString().split('T')[0];
                
                // Obtener lecturas del per√≠odo anterior
                const lecturasAnteriores = await supabaseRequest(`/env_water_readings_daily?select=*&reading_date=gte.${inicioAnterior}&reading_date=lte.${finAnterior}&is_baseline=eq.false`);
                
                if (!lecturasAnteriores || lecturasAnteriores.length === 0) {
                    document.getElementById(`kpi-${tipo}-comp`).innerHTML = '<small class="text-muted">Sin datos anteriores</small>';
                    return;
                }
                
                let valorAnterior = 0;
                if (tipo === 'entrada') {
                    valorAnterior = lecturasAnteriores.reduce((sum, l) => sum + (l.total_entrada || 0), 0);
                } else if (tipo === 'salida') {
                    valorAnterior = lecturasAnteriores.reduce((sum, l) => sum + (l.total_salida || 0), 0);
                }
                
                if (valorAnterior === 0) {
                    document.getElementById(`kpi-${tipo}-comp`).innerHTML = '<small class="text-muted">Sin datos anteriores</small>';
                    return;
                }
                
                const diferencia = valorActual - valorAnterior;
                const porcentaje = (diferencia / valorAnterior) * 100;
                
                let icono = '';
                let clase = 'comparison-neutral';
                
                if (porcentaje > 0) {
                    icono = '‚Üë';
                    clase = 'comparison-up';
                } else if (porcentaje < 0) {
                    icono = '‚Üì';
                    clase = 'comparison-down';
                } else {
                    icono = '‚Üí';
                }
                
                document.getElementById(`kpi-${tipo}-comp`).innerHTML = `
                    <span class="${clase}">
                        ${icono} ${Math.abs(porcentaje).toFixed(1)}% vs. per√≠odo anterior
                    </span>
                `;
                
            } catch (error) {
                console.error('‚ùå Error calculando comparaci√≥n:', error);
                document.getElementById(`kpi-${tipo}-comp`).innerHTML = '<small class="text-muted">Error al calcular</small>';
            }
        }
        
        // ==========================================
        // CALCULAR EFICIENCIA
        // ==========================================
        async function calcularEficiencia(consumoPerCapitaActual) {
            try {
                // Calcular per√≠odo anterior
                const diasDiferencia = Math.floor((new Date(periodoFin) - new Date(periodoInicio)) / (1000 * 60 * 60 * 24)) + 1;
                
                const fechaInicioAnterior = new Date(periodoInicio);
                fechaInicioAnterior.setDate(fechaInicioAnterior.getDate() - diasDiferencia);
                
                const fechaFinAnterior = new Date(periodoInicio);
                fechaFinAnterior.setDate(fechaFinAnterior.getDate() - 1);
                
                const inicioAnterior = fechaInicioAnterior.toISOString().split('T')[0];
                const finAnterior = fechaFinAnterior.toISOString().split('T')[0];
                
                const lecturasAnteriores = await supabaseRequest(`/env_water_readings_daily?select=*&reading_date=gte.${inicioAnterior}&reading_date=lte.${finAnterior}&is_baseline=eq.false`);
                
                if (!lecturasAnteriores || lecturasAnteriores.length === 0) {
                    document.getElementById('kpi-eficiencia').textContent = 'N/A';
                    document.getElementById('kpi-eficiencia-comp').innerHTML = '<small class="text-muted">Sin datos anteriores</small>';
                    return;
                }
                
                const entradaAnterior = lecturasAnteriores.reduce((sum, l) => sum + (l.total_entrada || 0), 0);
                const diasAnterior = lecturasAnteriores.length;
                const consumoPerCapitaAnterior = entradaAnterior / diasAnterior / poblacionTotal;
                
                const diferencia = consumoPerCapitaActual - consumoPerCapitaAnterior;
                const porcentaje = (diferencia / consumoPerCapitaAnterior) * 100;
                
                document.getElementById('kpi-eficiencia').textContent = formatearNumero(porcentaje, 1) + '%';
                
                let icono = '';
                let clase = 'comparison-neutral';
                let estado = 'Sin cambio';
                
                if (porcentaje < 0) {
                    // Consumo menor = mejor eficiencia
                    icono = '‚Üì';
                    clase = 'comparison-down';
                    estado = 'üü¢ Mejorando';
                } else if (porcentaje > 0) {
                    // Consumo mayor = peor eficiencia
                    icono = '‚Üë';
                    clase = 'comparison-up';
                    estado = 'üî¥ Empeorando';
                } else {
                    icono = '‚Üí';
                }
                
                document.getElementById('kpi-eficiencia-comp').innerHTML = `
                    <span class="${clase}">
                        ${icono} ${Math.abs(porcentaje).toFixed(1)}% ${estado}
                    </span>
                `;
                
            } catch (error) {
                console.error('‚ùå Error calculando eficiencia:', error);
                document.getElementById('kpi-eficiencia').textContent = 'N/A';
            }
        }
      // ==========================================
        // RENDERIZAR GR√ÅFICOS
        // ==========================================
        function renderizarGraficos() {
            renderizarGraficoTendencia();
            renderizarGraficoEntradaDistribucion();
            renderizarGraficoPerCapita();
            renderizarGraficoAreasTop();
            renderizarGraficoAlarmasStatus();
        }
        
        // ==========================================
        // GR√ÅFICO: TENDENCIA GENERAL
        // ==========================================
        function renderizarGraficoTendencia() {
            const ctx = document.getElementById('chart-trend').getContext('2d');
            
            // Destruir gr√°fico anterior si existe
            if (chartTrend) {
                chartTrend.destroy();
            }
            
            if (lecturasDelPeriodo.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }
            
            // Preparar datos
            const labels = lecturasDelPeriodo.map(l => {
                const fecha = new Date(l.reading_date);
                return fecha.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
            });
            
            const dataEntrada = lecturasDelPeriodo.map(l => l.total_entrada || 0);
            const dataSalida = lecturasDelPeriodo.map(l => l.total_salida || 0);
            const dataBalance = lecturasDelPeriodo.map(l => l.diferencia_porcentaje || 0);
            
            // Crear gr√°fico
            chartTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Entrada (m¬≥)',
                            data: dataEntrada,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Salida (m¬≥)',
                            data: dataSalida,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Balance (%)',
                            data: dataBalance,
                            borderColor: '#198754',
                            backgroundColor: 'rgba(25, 135, 84, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y1',
                            pointBackgroundColor: function(context) {
                                const value = context.parsed.y;
                                const abs = Math.abs(value);
                                if (abs >= toleranciaCritical) return '#dc3545';
                                if (abs >= toleranciaWarning) return '#ffc107';
                                return '#198754';
                            },
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (context.datasetIndex === 2) {
                                            label += context.parsed.y.toFixed(2) + '%';
                                        } else {
                                            label += formatearNumero(context.parsed.y, 2) + ' m¬≥';
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Volumen (m¬≥)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Balance (%)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // GR√ÅFICO: DISTRIBUCI√ìN DE ENTRADA
        // ==========================================
        function renderizarGraficoEntradaDistribucion() {
            const ctx = document.getElementById('chart-entrada-dist').getContext('2d');
            
            // Destruir gr√°fico anterior si existe
            if (chartEntradaDist) {
                chartEntradaDist.destroy();
            }
            
            if (lecturasDelPeriodo.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }
            
            // Calcular totales
            const totalCaptacion = lecturasDelPeriodo.reduce((sum, l) => sum + (l.captacion_daily || 0), 0);
            const totalAcueducto = lecturasDelPeriodo.reduce((sum, l) => sum + (l.acueducto_daily || 0), 0);
            
            // Crear gr√°fico
            chartEntradaDist = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Captaci√≥n R√≠o', 'Acueducto Veredal'],
                    datasets: [{
                        data: [totalCaptacion, totalAcueducto],
                        backgroundColor: ['#0d6efd', '#0dcaf0'],
                        borderColor: ['#0d6efd', '#0dcaf0'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${formatearNumero(value, 2)} m¬≥ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // GR√ÅFICO: TENDENCIA PER C√ÅPITA
        // ==========================================
        function renderizarGraficoPerCapita() {
            const ctx = document.getElementById('chart-percapita').getContext('2d');
            
            // Destruir gr√°fico anterior si existe
            if (chartPerCapita) {
                chartPerCapita.destroy();
            }
            
            if (lecturasDelPeriodo.length === 0 || poblacionTotal === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }
            
            // Preparar datos
            const labels = lecturasDelPeriodo.map(l => {
                const fecha = new Date(l.reading_date);
                return fecha.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
            });
            
            const dataPerCapita = lecturasDelPeriodo.map(l => {
                const entrada = l.total_entrada || 0;
                return entrada / poblacionTotal;
            });
            
            // Calcular promedio del per√≠odo
            const promedio = dataPerCapita.reduce((sum, v) => sum + v, 0) / dataPerCapita.length;
            const dataPromedio = new Array(dataPerCapita.length).fill(promedio);
            
            // Crear gr√°fico
            chartPerCapita = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Consumo Per C√°pita (m¬≥/persona)',
                            data: dataPerCapita,
                            borderColor: '#20c997',
                            backgroundColor: 'rgba(32, 201, 151, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Promedio del Per√≠odo',
                            data: dataPromedio,
                            borderColor: '#6c757d',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatearNumero(context.parsed.y, 3) + ' m¬≥/persona';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'm¬≥ por persona'
                            }
                        }
                    }
                }
            });
        }
      // ==========================================
        // GR√ÅFICO: TOP 5 √ÅREAS
        // ==========================================
        function renderizarGraficoAreasTop() {
            const ctx = document.getElementById('chart-areas-top').getContext('2d');
            
            // Destruir gr√°fico anterior si existe
            if (chartAreasTop) {
                chartAreasTop.destroy();
            }
            
            if (lecturasAreasDelPeriodo.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '14px Arial';
                ctx.fillStyle = '#6c757d';
                ctx.textAlign = 'center';
                ctx.fillText('No hay lecturas mensuales de √°reas en este per√≠odo', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // Agrupar por medidor y sumar consumos
            const consumoPorArea = {};
            
            lecturasAreasDelPeriodo.forEach(lectura => {
                const meterName = lectura.env_water_meters?.meter_name || 'Desconocido';
                if (!consumoPorArea[meterName]) {
                    consumoPorArea[meterName] = 0;
                }
                consumoPorArea[meterName] += lectura.reading_value || 0;
            });
            
            // Convertir a array y ordenar
            const areasArray = Object.entries(consumoPorArea)
                .map(([nombre, consumo]) => ({ nombre, consumo }))
                .sort((a, b) => b.consumo - a.consumo)
                .slice(0, 5); // Top 5
            
            if (areasArray.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }
            
            const labels = areasArray.map(a => a.nombre);
            const data = areasArray.map(a => a.consumo);
            
            // Crear gr√°fico
            chartAreasTop = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Consumo (m¬≥)',
                        data: data,
                        backgroundColor: [
                            '#0d6efd',
                            '#6610f2',
                            '#6f42c1',
                            '#d63384',
                            '#dc3545'
                        ],
                        borderColor: [
                            '#0d6efd',
                            '#6610f2',
                            '#6f42c1',
                            '#d63384',
                            '#dc3545'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Consumo: ' + formatearNumero(context.parsed.x, 2) + ' m¬≥';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Consumo (m¬≥)'
                            }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // GR√ÅFICO: ESTADO DE ALARMAS
        // ==========================================
        function renderizarGraficoAlarmasStatus() {
            const ctx = document.getElementById('chart-alarmas-status').getContext('2d');
            
            // Destruir gr√°fico anterior si existe
            if (chartAlarmasStatus) {
                chartAlarmasStatus.destroy();
            }
            
            if (alarmasDelPeriodo.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '14px Arial';
                ctx.fillStyle = '#6c757d';
                ctx.textAlign = 'center';
                ctx.fillText('No hay alarmas en este per√≠odo', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // Contar por estado
            const pendientes = alarmasDelPeriodo.filter(a => a.alert_status === 'pending').length;
            const investigando = alarmasDelPeriodo.filter(a => a.alert_status === 'investigating').length;
            const resueltas = alarmasDelPeriodo.filter(a => a.alert_status === 'resolved').length;
            
            // Crear gr√°fico
            chartAlarmasStatus = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendientes', 'En Investigaci√≥n', 'Resueltas'],
                    datasets: [{
                        data: [pendientes, investigando, resueltas],
                        backgroundColor: ['#0dcaf0', '#ffc107', '#198754'],
                        borderColor: ['#0dcaf0', '#ffc107', '#198754'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // RENDERIZAR TABLA DE RESUMEN
        // ==========================================
        function renderizarTablaResumen() {
            const tbody = document.getElementById('summary-table-body');
            
            if (lecturasDelPeriodo.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <h6>No hay datos para el per√≠odo seleccionado</h6>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // √öltimos 7 d√≠as del per√≠odo
            const ultimos7 = lecturasDelPeriodo.slice(-7);
            
            tbody.innerHTML = ultimos7.map(lectura => {
                const fecha = new Date(lectura.reading_date);
                const fechaFormateada = fecha.toLocaleDateString('es-CO', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                
                const entrada = formatearNumero(lectura.total_entrada || 0, 2);
                const salida = formatearNumero(lectura.total_salida || 0, 2);
                const balance = formatearNumero(lectura.diferencia_porcentaje || 0, 2) + '%';
                
                // Estado
                let estadoIcon = 'üü¢';
                let estadoClass = 'status-normal';
                const balanceAbs = Math.abs(lectura.diferencia_porcentaje || 0);
                
                if (balanceAbs >= toleranciaCritical) {
                    estadoIcon = 'üî¥';
                    estadoClass = 'status-critical';
                } else if (balanceAbs >= toleranciaWarning) {
                    estadoIcon = 'üü°';
                    estadoClass = 'status-warning';
                }
                
                // Buscar alarma del d√≠a
                const alarmaDelDia = alarmasDelPeriodo.find(a => a.alert_date === lectura.reading_date);
                let alarmaBadge = '<span class="text-muted">--</span>';
                
                if (alarmaDelDia) {
                    const tipoIcon = alarmaDelDia.alert_type === 'critical' ? 'üî¥' : 'üü°';
                    alarmaBadge = `<span class="badge badge-alarm bg-danger" onclick="verAlarmaEspecifica('${alarmaDelDia.alert_id}')" title="Ver alarma">${tipoIcon} #${alarmaDelDia.alert_id.slice(0, 8)}</span>`;
                }
                
                // Per c√°pita del d√≠a
                const perCapitaDia = poblacionTotal > 0 ? (lectura.total_entrada || 0) / poblacionTotal : 0;
                const perCapitaFormateado = formatearNumero(perCapitaDia, 3);
                
                return `
                    <tr onclick="verDetalleDia('${lectura.reading_date}')">
                        <td><strong>${fechaFormateada}</strong></td>
                        <td class="text-end">${entrada}</td>
                        <td class="text-end">${salida}</td>
                        <td class="text-end">${balance}</td>
                        <td class="text-center"><span class="${estadoClass}">${estadoIcon}</span></td>
                        <td class="text-center">${alarmaBadge}</td>
                        <td class="text-end">${perCapitaFormateado}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // ==========================================
        // CARGAR TENDENCIA DE √ÅREA ESPEC√çFICA
        // ==========================================
        async function cargarTendenciaArea() {
            const meterId = document.getElementById('select-area').value;
            
            if (!meterId) {
                showMessage('Por favor selecciona un √°rea', 'warning');
                return;
            }
            
            try {
                mostrarLoading();
                
                // Obtener nombre del √°rea
                const medidorInfo = await supabaseRequest(`/env_water_meters?select=meter_name&meter_id=eq.${meterId}&limit=1`);
                const areaNombre = medidorInfo && medidorInfo.length > 0 ? medidorInfo[0].meter_name : '√Årea';
                
                // Obtener lecturas mensuales del √°rea en el per√≠odo
                const inicioDate = new Date(periodoInicio);
                const finDate = new Date(periodoFin);
                const mesesQuery = [];
                
                let currentDate = new Date(inicioDate);
                while (currentDate <= finDate) {
                    const mesKey = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0') + '-01';
                    mesesQuery.push(mesKey);
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
                
                const lecturas = await supabaseRequest(`/env_water_readings_monthly?select=*&meter_id=eq.${meterId}&reading_month=in.(${mesesQuery.join(',')})&order=reading_month.asc`);
                
                if (!lecturas || lecturas.length === 0) {
                    showMessage('No hay lecturas mensuales para esta √°rea en el per√≠odo seleccionado', 'warning');
                    ocultarLoading();
                    return;
                }
                
                // Mostrar contenedor de an√°lisis
                document.getElementById('area-analysis-container').style.display = 'block';
                
                // Renderizar gr√°fico
                const ctx = document.getElementById('chart-area').getContext('2d');
                
                if (chartArea) {
                    chartArea.destroy();
                }
                
                const labels = lecturas.map(l => {
                    const fecha = new Date(l.reading_month);
                    return fecha.toLocaleDateString('es-CO', { month: 'short', year: 'numeric' });
                });
                
                const data = lecturas.map(l => l.reading_value || 0);
                const promedio = data.reduce((sum, v) => sum + v, 0) / data.length;
                const dataPromedio = new Array(data.length).fill(promedio);
                
                chartArea = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `Consumo de ${areaNombre}`,
                                data: data,
                                borderColor: '#0d6efd',
                                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Promedio del Per√≠odo',
                                data: dataPromedio,
                                borderColor: '#6c757d',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                tension: 0,
                                fill: false,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: `Tendencia de Consumo: ${areaNombre}`
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatearNumero(context.parsed.y, 2) + ' m¬≥';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Consumo (m¬≥)'
                                }
                            }
                        }
                    }
                });
                
                // Calcular estad√≠sticas
                const total = data.reduce((sum, v) => sum + v, 0);
                const max = Math.max(...data);
                const min = Math.min(...data);
                const maxIndex = data.indexOf(max);
                const minIndex = data.indexOf(min);
                
                document.getElementById('area-stat-total').textContent = formatearNumero(total, 2) + ' m¬≥';
                document.getElementById('area-stat-avg').textContent = formatearNumero(promedio, 2) + ' m¬≥';
                document.getElementById('area-stat-max').textContent = formatearNumero(max, 2) + ' m¬≥ (' + labels[maxIndex] + ')';
                document.getElementById('area-stat-min').textContent = formatearNumero(min, 2) + ' m¬≥ (' + labels[minIndex] + ')';
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error cargando tendencia del √°rea:', error);
                showMessage('Error al cargar datos del √°rea: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
      // ==========================================
        // VER ALARMAS
        // ==========================================
        function verAlarmas() {
            window.location.href = 'water-alerts.html';
        }
        
        // ==========================================
        // VER ALARMA ESPEC√çFICA
        // ==========================================
        function verAlarmaEspecifica(alertId) {
            window.location.href = `water-alerts.html?alert_id=${alertId}`;
        }
        
        // ==========================================
        // VER DETALLE DEL D√çA
        // ==========================================
        function verDetalleDia(fecha) {
            // Redirigir a edit-daily-readings con la fecha espec√≠fica
            window.location.href = `edit-daily-readings.html?date=${fecha}`;
        }
        
        // ==========================================
        // EXPORTAR PDF
        // ==========================================
        async function exportarPDF() {
            try {
                mostrarLoading();
                
                // Obtener per√≠odo seleccionado
                const periodoTexto = document.getElementById('filter-period').selectedOptions[0].text;
                
                // Obtener valores de KPIs
                const entrada = document.getElementById('kpi-entrada').textContent;
                const salida = document.getElementById('kpi-salida').textContent;
                const balance = document.getElementById('kpi-balance').textContent;
                const alarmas = document.getElementById('kpi-alarmas').textContent;
                const poblacion = document.getElementById('kpi-poblacion').textContent;
                const perCapita = document.getElementById('kpi-percapita').textContent;
                const eficiencia = document.getElementById('kpi-eficiencia').textContent;
                
                // Construir HTML del PDF
                let contenidoHTML = `
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Dashboard de Balance H√≠drico</title>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                margin: 20px;
                                font-size: 12px;
                            }
                            .header {
                                text-align: center;
                                margin-bottom: 30px;
                                border-bottom: 3px solid #0d6efd;
                                padding-bottom: 15px;
                            }
                            .header h1 {
                                margin: 0;
                                color: #0d6efd;
                                font-size: 24px;
                            }
                            .periodo {
                                background: #e7f3ff;
                                padding: 15px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                                text-align: center;
                                font-size: 14px;
                                font-weight: bold;
                            }
                            .kpis {
                                display: grid;
                                grid-template-columns: repeat(4, 1fr);
                                gap: 15px;
                                margin-bottom: 30px;
                            }
                            .kpi-box {
                                border: 2px solid #dee2e6;
                                border-radius: 8px;
                                padding: 15px;
                                text-align: center;
                            }
                            .kpi-label {
                                font-size: 10px;
                                color: #6c757d;
                                text-transform: uppercase;
                                margin-bottom: 8px;
                            }
                            .kpi-value {
                                font-size: 20px;
                                font-weight: bold;
                                color: #0d6efd;
                            }
                            .section-title {
                                font-size: 16px;
                                font-weight: bold;
                                color: #495057;
                                margin: 25px 0 15px 0;
                                padding-bottom: 8px;
                                border-bottom: 2px solid #dee2e6;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-top: 15px;
                            }
                            th, td {
                                border: 1px solid #dee2e6;
                                padding: 10px;
                                text-align: left;
                            }
                            th {
                                background-color: #f8f9fa;
                                font-weight: bold;
                                color: #495057;
                            }
                            tr:nth-child(even) {
                                background-color: #f8f9fa;
                            }
                            .footer {
                                margin-top: 40px;
                                text-align: center;
                                font-size: 10px;
                                color: #6c757d;
                                border-top: 1px solid #dee2e6;
                                padding-top: 15px;
                            }
                            .charts-note {
                                background: #fff3cd;
                                padding: 12px;
                                border-radius: 6px;
                                margin: 20px 0;
                                text-align: center;
                                color: #856404;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>üìä Dashboard de Balance H√≠drico</h1>
                            <p>SchoolNet - Gesti√≥n Ambiental | Colegio Tilata</p>
                            <p style="font-size: 11px; color: #6c757d;">Generado: ${new Date().toLocaleString('es-CO')}</p>
                        </div>
                        
                        <div class="periodo">
                            üìÖ Per√≠odo Analizado: ${periodoTexto} (${periodoInicio} a ${periodoFin})
                        </div>
                        
                        <div class="section-title">üìä KPIs Principales</div>
                        <div class="kpis">
                            <div class="kpi-box">
                                <div class="kpi-label">üíß Entrada Total</div>
                                <div class="kpi-value" style="color: #0d6efd;">${entrada}</div>
                            </div>
                            <div class="kpi-box">
                                <div class="kpi-label">üö∞ Salida Total</div>
                                <div class="kpi-value" style="color: #dc3545;">${salida}</div>
                            </div>
                            <div class="kpi-box">
                                <div class="kpi-label">‚öñÔ∏è Balance Promedio</div>
                                <div class="kpi-value" style="color: #198754;">${balance}</div>
                            </div>
                            <div class="kpi-box">
                                <div class="kpi-label">üö® Alarmas</div>
                                <div class="kpi-value" style="color: #ffc107;">${alarmas}</div>
                            </div>
                        </div>
                        
                        <div class="section-title">üë• M√©tricas Per C√°pita</div>
                        <div class="kpis" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="kpi-box">
                                <div class="kpi-label">Poblaci√≥n Activa</div>
                                <div class="kpi-value" style="color: #6f42c1;">${poblacion}</div>
                            </div>
                            <div class="kpi-box">
                                <div class="kpi-label">Consumo Per C√°pita</div>
                                <div class="kpi-value" style="color: #20c997;">${perCapita}</div>
                            </div>
                            <div class="kpi-box">
                                <div class="kpi-label">Eficiencia</div>
                                <div class="kpi-value" style="color: #0dcaf0;">${eficiencia}</div>
                            </div>
                        </div>
                        
                        <div class="charts-note">
                            üìà Los gr√°ficos interactivos est√°n disponibles en la versi√≥n web del dashboard
                        </div>
                        
                        <div class="section-title">üìã Resumen Diario (√öltimos 7 D√≠as)</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th style="text-align: right;">Entrada (m¬≥)</th>
                                    <th style="text-align: right;">Salida (m¬≥)</th>
                                    <th style="text-align: right;">Balance</th>
                                    <th style="text-align: center;">Estado</th>
                                    <th style="text-align: right;">Per C√°pita</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Agregar filas de la tabla
                const ultimos7 = lecturasDelPeriodo.slice(-7);
                ultimos7.forEach(lectura => {
                    const fecha = new Date(lectura.reading_date).toLocaleDateString('es-CO');
                    const entrada = formatearNumero(lectura.total_entrada || 0, 2);
                    const salida = formatearNumero(lectura.total_salida || 0, 2);
                    const balance = formatearNumero(lectura.diferencia_porcentaje || 0, 2) + '%';
                    
                    let estado = 'üü¢ Normal';
                    const balanceAbs = Math.abs(lectura.diferencia_porcentaje || 0);
                    if (balanceAbs >= toleranciaCritical) {
                        estado = 'üî¥ Cr√≠tico';
                    } else if (balanceAbs >= toleranciaWarning) {
                        estado = 'üü° Advertencia';
                    }
                    
                    const perCapitaDia = poblacionTotal > 0 ? (lectura.total_entrada || 0) / poblacionTotal : 0;
                    const perCapita = formatearNumero(perCapitaDia, 3);
                    
                    contenidoHTML += `
                        <tr>
                            <td>${fecha}</td>
                            <td style="text-align: right;">${entrada}</td>
                            <td style="text-align: right;">${salida}</td>
                            <td style="text-align: right;">${balance}</td>
                            <td style="text-align: center;">${estado}</td>
                            <td style="text-align: right;">${perCapita}</td>
                        </tr>
                    `;
                });
                
                contenidoHTML += `
                            </tbody>
                        </table>
                        
                        <div class="section-title">üìä Resumen de Alarmas</div>
                        <p><strong>Total de alarmas:</strong> ${alarmasDelPeriodo.length}</p>
                        <ul>
                            <li>üü° Advertencias: ${alarmasDelPeriodo.filter(a => a.alert_type === 'warning').length}</li>
                            <li>üî¥ Cr√≠ticas: ${alarmasDelPeriodo.filter(a => a.alert_type === 'critical').length}</li>
                        </ul>
                        <p><strong>Por estado:</strong></p>
                        <ul>
                            <li>‚è≥ Pendientes: ${alarmasDelPeriodo.filter(a => a.alert_status === 'pending').length}</li>
                            <li>üîç En Investigaci√≥n: ${alarmasDelPeriodo.filter(a => a.alert_status === 'investigating').length}</li>
                            <li>‚úÖ Resueltas: ${alarmasDelPeriodo.filter(a => a.alert_status === 'resolved').length}</li>
                        </ul>
                        
                        <div class="footer">
                            <p>Este reporte fue generado autom√°ticamente por SchoolNet - Sistema de Gesti√≥n Educativa</p>
                            <p>Colegio Tilata | Gesti√≥n Ambiental - Dashboard de Balance H√≠drico</p>
                            <p>Para m√°s informaci√≥n o an√°lisis detallado, acceda a la plataforma web</p>
                        </div>
                    </body>
                    </html>
                `;
                
                // Abrir ventana de impresi√≥n
                const ventana = window.open('', '_blank');
                ventana.document.write(contenidoHTML);
                ventana.document.close();
                
                // Esperar a que cargue y luego imprimir
                ventana.onload = function() {
                    ventana.print();
                };
                
                ocultarLoading();
                showMessage('PDF generado. Use Ctrl+P o Cmd+P para guardar como PDF', 'info');
                
            } catch (error) {
                console.error('‚ùå Error exportando PDF:', error);
                showMessage('Error al exportar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function formatearNumero(numero, decimales = 2) {
            if (numero === null || numero === undefined || isNaN(numero)) return '--';
            return new Intl.NumberFormat('es-CO', {
                minimumFractionDigits: decimales,
                maximumFractionDigits: decimales
            }).format(numero);
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.actualizarDashboard = actualizarDashboard;
        window.cargarTendenciaArea = cargarTendenciaArea;
        window.verAlarmas = verAlarmas;
        window.verAlarmaEspecifica = verAlarmaEspecifica;
        window.verDetalleDia = verDetalleDia;
        window.exportarPDF = exportarPDF;
        
        console.log('üéâ water-balance-dashboard.html cargado correctamente');
    </script>
</body>
</html>
