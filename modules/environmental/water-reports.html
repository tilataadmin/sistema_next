<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes de Agua - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- SheetJS para Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Chart.js para gr√°ficos en PDF -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Section Headers */
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin: 2rem 0 1.5rem 0;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .section-header h5 {
            margin: 0;
            font-weight: 600;
        }
        
        .section-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        /* Report Cards */
        .report-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s;
            height: 100%;
            border-left: 4px solid;
        }
        
        .report-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .report-card.regulatory { border-left-color: #dc3545; }
        .report-card.analytical { border-left-color: #0d6efd; }
        .report-card.management { border-left-color: #198754; }
        
        .report-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .report-icon.regulatory { color: #dc3545; }
        .report-icon.analytical { color: #0d6efd; }
        .report-icon.management { color: #198754; }
        
        .report-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .report-description {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .report-features {
            font-size: 0.85rem;
            color: #495057;
            margin-bottom: 1rem;
        }
        
        .report-features li {
            margin-bottom: 0.25rem;
        }
        
        /* Modal Styling */
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        /* Hidden canvas for charts in PDF */
        .hidden-chart {
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .report-card {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Generando reporte...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Gesti√≥n Ambiental</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Reportes de Agua
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-file-earmark-bar-graph me-2"></i>
                    Reportes de Agua
                </h1>
                <p class="text-muted">
                    Generaci√≥n de reportes regulatorios, anal√≠ticos y de gesti√≥n
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- SECCI√ìN 1: REPORTES REGULATORIOS -->
        <div class="section-header">
            <h5>
                <i class="bi bi-file-earmark-ruled me-2"></i>
                Reportes Regulatorios
            </h5>
            <p>Reportes oficiales para entidades gubernamentales (CAR)</p>
        </div>

        <div class="row g-3 mb-4">
            <!-- Reporte CAR Mensual -->
            <div class="col-md-6">
                <div class="report-card regulatory">
                    <div class="report-icon regulatory">
                        <i class="bi bi-file-earmark-spreadsheet"></i>
                    </div>
                    <div class="report-title">Reporte CAR Mensual</div>
                    <div class="report-description">
                        Reporte mensual de captaci√≥n y vertimiento para la Corporaci√≥n Aut√≥noma Regional
                    </div>
                    <ul class="report-features">
                        <li>‚úì Tabla diaria de captaci√≥n (R√≠o)</li>
                        <li>‚úì Tabla diaria de vertimiento (PTAR)</li>
                        <li>‚úì Totales y promedios mensuales</li>
                        <li>‚úì Informaci√≥n institucional</li>
                    </ul>
                    <button class="btn btn-danger w-100" onclick="abrirModalCAR('mensual')">
                        <i class="bi bi-file-earmark-text me-2"></i>Generar Reporte
                    </button>
                </div>
            </div>

            <!-- Reporte CAR Anual -->
            <div class="col-md-6">
                <div class="report-card regulatory">
                    <div class="report-icon regulatory">
                        <i class="bi bi-file-earmark-bar-graph"></i>
                    </div>
                    <div class="report-title">Reporte CAR Anual Consolidado</div>
                    <div class="report-description">
                        Consolidado anual de captaci√≥n y vertimiento con an√°lisis mensual
                    </div>
                    <ul class="report-features">
                        <li>‚úì Resumen mensual del a√±o completo</li>
                        <li>‚úì Totales anuales por fuente</li>
                        <li>‚úì An√°lisis de alarmas y acciones</li>
                        <li>‚úì Gr√°ficos de tendencia anual</li>
                    </ul>
                    <button class="btn btn-danger w-100" onclick="abrirModalCAR('anual')">
                        <i class="bi bi-file-earmark-bar-graph me-2"></i>Generar Reporte
                    </button>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 2: REPORTES ANAL√çTICOS -->
        <div class="section-header">
            <h5>
                <i class="bi bi-graph-up me-2"></i>
                Reportes Anal√≠ticos
            </h5>
            <p>An√°lisis detallados de consumo, eficiencia y tendencias</p>
        </div>

        <div class="row g-3 mb-4">
            <!-- Eficiencia H√≠drica -->
            <div class="col-md-6 col-lg-3">
                <div class="report-card analytical">
                    <div class="report-icon analytical">
                        <i class="bi bi-droplet-half"></i>
                    </div>
                    <div class="report-title">Eficiencia H√≠drica</div>
                    <div class="report-description">
                        An√°lisis de consumo per c√°pita y eficiencia
                    </div>
                    <ul class="report-features">
                        <li>‚úì Consumo per c√°pita hist√≥rico</li>
                        <li>‚úì Comparaci√≥n entre per√≠odos</li>
                        <li>‚úì Tendencias y proyecciones</li>
                    </ul>
                    <button class="btn btn-primary w-100" onclick="abrirModalEficiencia()">
                        <i class="bi bi-graph-up me-2"></i>Generar
                    </button>
                </div>
            </div>

            <!-- Historial de Alarmas -->
            <div class="col-md-6 col-lg-3">
                <div class="report-card analytical">
                    <div class="report-icon analytical">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <div class="report-title">Historial de Alarmas</div>
                    <div class="report-description">
                        Reporte completo de alarmas y acciones
                    </div>
                    <ul class="report-features">
                        <li>‚úì Listado de todas las alarmas</li>
                        <li>‚úì Tiempos de resoluci√≥n</li>
                        <li>‚úì Acciones correctivas</li>
                    </ul>
                    <button class="btn btn-primary w-100" onclick="abrirModalAlarmas()">
                        <i class="bi bi-clock-history me-2"></i>Generar
                    </button>
                </div>
            </div>

            <!-- Comparativo de √Åreas -->
            <div class="col-md-6 col-lg-3">
                <div class="report-card analytical">
                    <div class="report-icon analytical">
                        <i class="bi bi-building"></i>
                    </div>
                    <div class="report-title">Comparativo de √Åreas</div>
                    <div class="report-description">
                        Consumo mensual por √°rea de consumo
                    </div>
                    <ul class="report-features">
                        <li>‚úì Consumo por √°rea</li>
                        <li>‚úì Comparaci√≥n temporal</li>
                        <li>‚úì Porcentaje del total</li>
                    </ul>
                    <button class="btn btn-primary w-100" onclick="abrirModalAreas()">
                        <i class="bi bi-bar-chart me-2"></i>Generar
                    </button>
                </div>
            </div>

            <!-- Distribuci√≥n de Fuentes -->
            <div class="col-md-6 col-lg-3">
                <div class="report-card analytical">
                    <div class="report-icon analytical">
                        <i class="bi bi-water"></i>
                    </div>
                    <div class="report-title">Distribuci√≥n de Fuentes</div>
                    <div class="report-description">
                        An√°lisis de fuentes de agua (Captaci√≥n/Acueducto)
                    </div>
                    <ul class="report-features">
                        <li>‚úì Porcentaje por fuente</li>
                        <li>‚úì Tendencia temporal</li>
                        <li>‚úì Gr√°ficos comparativos</li>
                    </ul>
                    <button class="btn btn-primary w-100" onclick="abrirModalFuentes()">
                        <i class="bi bi-pie-chart me-2"></i>Generar
                    </button>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 3: REPORTES DE GESTI√ìN -->
        <div class="section-header">
            <h5>
                <i class="bi bi-briefcase me-2"></i>
                Reportes de Gesti√≥n
            </h5>
            <p>Reportes ejecutivos para toma de decisiones</p>
        </div>

        <div class="row g-3 mb-5">
            <!-- Resumen Ejecutivo -->
            <div class="col-md-6 col-lg-4">
                <div class="report-card management">
                    <div class="report-icon management">
                        <i class="bi bi-file-earmark-richtext"></i>
                    </div>
                    <div class="report-title">Resumen Ejecutivo Mensual</div>
                    <div class="report-description">
                        Reporte de 1-2 p√°ginas para direcci√≥n
                    </div>
                    <ul class="report-features">
                        <li>‚úì KPIs principales</li>
                        <li>‚úì Alarmas y resoluciones</li>
                        <li>‚úì Recomendaciones</li>
                    </ul>
                    <button class="btn btn-success w-100" onclick="abrirModalEjecutivo()">
                        <i class="bi bi-file-pdf me-2"></i>Generar
                    </button>
                </div>
            </div>

            <!-- Poblaci√≥n vs Consumo -->
            <div class="col-md-6 col-lg-4">
                <div class="report-card management">
                    <div class="report-icon management">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="report-title">Poblaci√≥n vs Consumo</div>
                    <div class="report-description">
                        Correlaci√≥n entre poblaci√≥n y consumo
                    </div>
                    <ul class="report-features">
                        <li>‚úì Consumo per c√°pita mensual</li>
                        <li>‚úì Variaci√≥n poblacional</li>
                        <li>‚úì Proyecciones</li>
                    </ul>
                    <button class="btn btn-success w-100" onclick="abrirModalPoblacion()">
                        <i class="bi bi-graph-up me-2"></i>Generar
                    </button>
                </div>
            </div>

            <!-- Mantenimiento Preventivo -->
            <div class="col-md-6 col-lg-4">
                <div class="report-card management">
                    <div class="report-icon management">
                        <i class="bi bi-tools"></i>
                    </div><!-- MODAL: REPORTE CAR MENSUAL/ANUAL -->
    <div class="modal fade" id="modal-car" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-car-title">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                        Reporte CAR
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="car-tipo">
                    
                    <div class="filter-section">
                        <h6 class="mb-3">Configuraci√≥n del Reporte</h6>
                        
                        <!-- Filtro Mensual -->
                        <div id="car-filtro-mensual">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="car-mes" class="form-label">Mes <span class="text-danger">*</span></label>
                                    <select class="form-select" id="car-mes" required>
                                        <option value="">-- Seleccionar mes --</option>
                                        <option value="1">Enero</option>
                                        <option value="2">Febrero</option>
                                        <option value="3">Marzo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Mayo</option>
                                        <option value="6">Junio</option>
                                        <option value="7">Julio</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Septiembre</option>
                                        <option value="10">Octubre</option>
                                        <option value="11">Noviembre</option>
                                        <option value="12">Diciembre</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="car-ano-mensual" class="form-label">A√±o <span class="text-danger">*</span></label>
                                    <select class="form-select" id="car-ano-mensual" required></select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtro Anual -->
                        <div id="car-filtro-anual" style="display: none;">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label for="car-ano-anual" class="form-label">A√±o <span class="text-danger">*</span></label>
                                    <select class="form-select" id="car-ano-anual" required></select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Nota:</strong> Este reporte incluye datos oficiales de captaci√≥n y vertimiento para la CAR.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="generarReporteCAR('excel')">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>Descargar Excel
                    </button>
                    <button type="button" class="btn btn-danger" onclick="generarReporteCAR('pdf')">
                        <i class="bi bi-file-pdf me-2"></i>Descargar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: EFICIENCIA H√çDRICA -->
    <div class="modal fade" id="modal-eficiencia" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-droplet-half me-2"></i>
                        Reporte de Eficiencia H√≠drica
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="filter-section">
                        <h6 class="mb-3">Per√≠odo de An√°lisis</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="eficiencia-fecha-inicio" class="form-label">Fecha Inicio <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="eficiencia-fecha-inicio" required>
                            </div>
                            <div class="col-md-6">
                                <label for="eficiencia-fecha-fin" class="form-label">Fecha Fin <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="eficiencia-fecha-fin" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Incluye an√°lisis de consumo per c√°pita, comparaciones temporales y proyecciones.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="generarReporteEficiencia()">
                        <i class="bi bi-file-pdf me-2"></i>Generar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: HISTORIAL DE ALARMAS -->
    <div class="modal fade" id="modal-alarmas" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Historial de Alarmas
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="filter-section">
                        <h6 class="mb-3">Filtros</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="alarmas-fecha-inicio" class="form-label">Fecha Inicio <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="alarmas-fecha-inicio" required>
                            </div>
                            <div class="col-md-4">
                                <label for="alarmas-fecha-fin" class="form-label">Fecha Fin <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="alarmas-fecha-fin" required>
                            </div>
                            <div class="col-md-4">
                                <label for="alarmas-estado" class="form-label">Estado</label>
                                <select class="form-select" id="alarmas-estado">
                                    <option value="">Todas</option>
                                    <option value="pending">Pendientes</option>
                                    <option value="investigating">En Investigaci√≥n</option>
                                    <option value="resolved">Resueltas</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Incluye listado completo, tiempos de resoluci√≥n y acciones correctivas.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="generarReporteAlarmas('excel')">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>Descargar Excel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="generarReporteAlarmas('pdf')">
                        <i class="bi bi-file-pdf me-2"></i>Descargar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: COMPARATIVO DE √ÅREAS -->
    <div class="modal fade" id="modal-areas" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-building me-2"></i>
                        Comparativo de √Åreas
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="filter-section">
                        <h6 class="mb-3">Per√≠odo de An√°lisis</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="areas-fecha-inicio" class="form-label">Fecha Inicio <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="areas-fecha-inicio" required>
                            </div>
                            <div class="col-md-6">
                                <label for="areas-fecha-fin" class="form-label">Fecha Fin <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="areas-fecha-fin" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Basado en lecturas mensuales de medidores de √°reas de consumo.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="generarReporteAreas('excel')">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>Descargar Excel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="generarReporteAreas('pdf')">
                        <i class="bi bi-file-pdf me-2"></i>Descargar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: DISTRIBUCI√ìN DE FUENTES -->
    <div class="modal fade" id="modal-fuentes" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-water me-2"></i>
                        Distribuci√≥n de Fuentes
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="filter-section">
                        <h6 class="mb-3">Per√≠odo de An√°lisis</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="fuentes-fecha-inicio" class="form-label">Fecha Inicio <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="fuentes-fecha-inicio" required>
                            </div>
                            <div class="col-md-6">
                                <label for="fuentes-fecha-fin" class="form-label">Fecha Fin <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="fuentes-fecha-fin" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        An√°lisis de Captaci√≥n R√≠o vs Acueducto Veredal con gr√°ficos.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="generarReporteFuentes()">
                        <i class="bi bi-file-pdf me-2"></i>Generar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
                  <!-- MODAL: RESUMEN EJECUTIVO MENSUAL -->
    <div class="modal fade" id="modal-ejecutivo" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-richtext me-2"></i>
                        Resumen Ejecutivo Mensual
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="filter-section">
                        <h6 class="mb-3">Configuraci√≥n</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="ejecutivo-mes" class="form-label">Mes <span class="text-danger">*</span></label>
                                <select class="form-select" id="ejecutivo-mes" required>
                                    <option value="">-- Seleccionar mes --</option>
                                    <option value="1">Enero</option>
                                    <option value="2">Febrero</option>
                                    <option value="3">Marzo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Mayo</option>
                                    <option value="6">Junio</option>
                                    <option value="7">Julio</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="ejecutivo-ano" class="form-label">A√±o <span class="text-danger">*</span></label>
                                <select class="form-select" id="ejecutivo-ano" required></select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Reporte de 1-2 p√°ginas con KPIs, alarmas y recomendaciones para direcci√≥n.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="generarReporteEjecutivo()">
                        <i class="bi bi-file-pdf me-2"></i>Generar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: POBLACI√ìN VS CONSUMO -->
    <div class="modal fade" id="modal-poblacion" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-people me-2"></i>
                        Poblaci√≥n vs Consumo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="filter-section">
                        <h6 class="mb-3">Per√≠odo de An√°lisis</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="poblacion-fecha-inicio" class="form-label">Fecha Inicio <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="poblacion-fecha-inicio" required>
                            </div>
                            <div class="col-md-6">
                                <label for="poblacion-fecha-fin" class="form-label">Fecha Fin <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="poblacion-fecha-fin" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        An√°lisis de correlaci√≥n entre poblaci√≥n activa y consumo de agua.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="generarReportePoblacion('excel')">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>Descargar Excel
                    </button>
                    <button type="button" class="btn btn-success" onclick="generarReportePoblacion('pdf')">
                        <i class="bi bi-file-pdf me-2"></i>Descargar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: MANTENIMIENTO PREVENTIVO -->
    <div class="modal fade" id="modal-mantenimiento" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-tools me-2"></i>
                        Mantenimiento Preventivo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="filter-section">
                        <h6 class="mb-3">Per√≠odo de An√°lisis</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="mantenimiento-fecha-inicio" class="form-label">Fecha Inicio <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="mantenimiento-fecha-inicio" required>
                            </div>
                            <div class="col-md-6">
                                <label for="mantenimiento-fecha-fin" class="form-label">Fecha Fin <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="mantenimiento-fecha-fin" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Identifica √°reas con lecturas anormales y prioriza acciones de mantenimiento.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="generarReporteMantenimiento()">
                        <i class="bi bi-file-pdf me-2"></i>Generar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Canvas ocultos para gr√°ficos en PDF -->
    <div class="hidden-chart">
        <canvas id="hidden-chart-1" width="800" height="400"></canvas>
        <canvas id="hidden-chart-2" width="800" height="400"></canvas>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let modalCAR = null;
        let modalEficiencia = null;
        let modalAlarmas = null;
        let modalAreas = null;
        let modalFuentes = null;
        let modalEjecutivo = null;
        let modalPoblacion = null;
        let modalMantenimiento = null;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Reportes de agua');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        async function inicializarPagina() {
            try {
                // Obtener usuario actual
                const session = getStoredSession();
                if (session && session.user) {
                    currentUser = session.user;
                }
                
                // Inicializar modales
                inicializarModales();
                
                // Configurar selectores de a√±os
                configurarSelectoresAnos();
                
                // Configurar fechas por defecto
                configurarFechasPorDefecto();
                
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // INICIALIZAR MODALES
        // ==========================================
        function inicializarModales() {
            modalCAR = new bootstrap.Modal(document.getElementById('modal-car'));
            modalEficiencia = new bootstrap.Modal(document.getElementById('modal-eficiencia'));
            modalAlarmas = new bootstrap.Modal(document.getElementById('modal-alarmas'));
            modalAreas = new bootstrap.Modal(document.getElementById('modal-areas'));
            modalFuentes = new bootstrap.Modal(document.getElementById('modal-fuentes'));
            modalEjecutivo = new bootstrap.Modal(document.getElementById('modal-ejecutivo'));
            modalPoblacion = new bootstrap.Modal(document.getElementById('modal-poblacion'));
            modalMantenimiento = new bootstrap.Modal(document.getElementById('modal-mantenimiento'));
            
            console.log('‚úÖ Modales inicializados');
        }
        
        // ==========================================
        // CONFIGURAR SELECTORES DE A√ëOS
        // ==========================================
        function configurarSelectoresAnos() {
            const anoActual = new Date().getFullYear();
            const anos = [];
            
            // √öltimos 5 a√±os
            for (let i = 0; i < 5; i++) {
                anos.push(anoActual - i);
            }
            
            // Llenar selectores
            const selectores = [
                'car-ano-mensual',
                'car-ano-anual',
                'ejecutivo-ano'
            ];
            
            selectores.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                select.innerHTML = '';
                anos.forEach(ano => {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.textContent = ano;
                    if (ano === anoActual) option.selected = true;
                    select.appendChild(option);
                });
            });
            
            // Configurar mes actual en selectores mensuales
            const mesActual = new Date().getMonth() + 1;
            const selectoresMes = ['car-mes', 'ejecutivo-mes'];
            selectoresMes.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                select.value = mesActual;
            });
        }
        
        // ==========================================
        // CONFIGURAR FECHAS POR DEFECTO
        // ==========================================
        function configurarFechasPorDefecto() {
            const hoy = new Date();
            const haceUnMes = new Date();
            haceUnMes.setMonth(haceUnMes.getMonth() - 1);
            
            const fechaInicio = haceUnMes.toISOString().split('T')[0];
            const fechaFin = hoy.toISOString().split('T')[0];
            
            // Configurar todos los inputs de fecha
            const inputsFechaInicio = [
                'eficiencia-fecha-inicio',
                'alarmas-fecha-inicio',
                'areas-fecha-inicio',
                'fuentes-fecha-inicio',
                'poblacion-fecha-inicio',
                'mantenimiento-fecha-inicio'
            ];
            
            const inputsFechaFin = [
                'eficiencia-fecha-fin',
                'alarmas-fecha-fin',
                'areas-fecha-fin',
                'fuentes-fecha-fin',
                'poblacion-fecha-fin',
                'mantenimiento-fecha-fin'
            ];
            
            inputsFechaInicio.forEach(id => {
                document.getElementById(id).value = fechaInicio;
            });
            
            inputsFechaFin.forEach(id => {
                document.getElementById(id).value = fechaFin;
            });
        }
      // ==========================================
        // ABRIR MODALES
        // ==========================================
        function abrirModalCAR(tipo) {
            document.getElementById('car-tipo').value = tipo;
            
            if (tipo === 'mensual') {
                document.getElementById('modal-car-title').innerHTML = '<i class="bi bi-file-earmark-spreadsheet me-2"></i>Reporte CAR Mensual';
                document.getElementById('car-filtro-mensual').style.display = 'block';
                document.getElementById('car-filtro-anual').style.display = 'none';
            } else {
                document.getElementById('modal-car-title').innerHTML = '<i class="bi bi-file-earmark-bar-graph me-2"></i>Reporte CAR Anual';
                document.getElementById('car-filtro-mensual').style.display = 'none';
                document.getElementById('car-filtro-anual').style.display = 'block';
            }
            
            modalCAR.show();
        }
        
        function abrirModalEficiencia() {
            modalEficiencia.show();
        }
        
        function abrirModalAlarmas() {
            modalAlarmas.show();
        }
        
        function abrirModalAreas() {
            modalAreas.show();
        }
        
        function abrirModalFuentes() {
            modalFuentes.show();
        }
        
        function abrirModalEjecutivo() {
            modalEjecutivo.show();
        }
        
        function abrirModalPoblacion() {
            modalPoblacion.show();
        }
        
        function abrirModalMantenimiento() {
            modalMantenimiento.show();
        }
        
        // ==========================================
        // OBTENER DATOS CAR
        // ==========================================
        async function obtenerDatosCAR(tipo) {
            try {
                let fechaInicio, fechaFin;
                
                if (tipo === 'mensual') {
                    const mes = parseInt(document.getElementById('car-mes').value);
                    const ano = parseInt(document.getElementById('car-ano-mensual').value);
                    
                    if (!mes || !ano) {
                        throw new Error('Por favor selecciona mes y a√±o');
                    }
                    
                    // Primer y √∫ltimo d√≠a del mes
                    fechaInicio = new Date(ano, mes - 1, 1).toISOString().split('T')[0];
                    fechaFin = new Date(ano, mes, 0).toISOString().split('T')[0];
                    
                } else {
                    const ano = parseInt(document.getElementById('car-ano-anual').value);
                    
                    if (!ano) {
                        throw new Error('Por favor selecciona el a√±o');
                    }
                    
                    fechaInicio = `${ano}-01-01`;
                    fechaFin = `${ano}-12-31`;
                }
                
                // Obtener lecturas diarias del per√≠odo
                const lecturas = await supabaseRequest(`/env_water_readings_daily?select=*&reading_date=gte.${fechaInicio}&reading_date=lte.${fechaFin}&is_baseline=eq.false&order=reading_date.asc`);
                
                if (!lecturas || lecturas.length === 0) {
                    throw new Error('No hay datos disponibles para el per√≠odo seleccionado');
                }
                
                return {
                    lecturas,
                    fechaInicio,
                    fechaFin,
                    tipo
                };
                
            } catch (error) {
                throw error;
            }
        }
        
        // ==========================================
        // OBTENER DATOS EFICIENCIA
        // ==========================================
        async function obtenerDatosEficiencia() {
            try {
                const fechaInicio = document.getElementById('eficiencia-fecha-inicio').value;
                const fechaFin = document.getElementById('eficiencia-fecha-fin').value;
                
                if (!fechaInicio || !fechaFin) {
                    throw new Error('Por favor selecciona ambas fechas');
                }
                
                // Lecturas del per√≠odo
                const lecturas = await supabaseRequest(`/env_water_readings_daily?select=*&reading_date=gte.${fechaInicio}&reading_date=lte.${fechaFin}&is_baseline=eq.false&order=reading_date.asc`);
                
                if (!lecturas || lecturas.length === 0) {
                    throw new Error('No hay datos disponibles para el per√≠odo seleccionado');
                }
                
                // Obtener poblaci√≥n activa
                const poblacion = await obtenerPoblacionActiva();
                
                // Calcular per√≠odo anterior para comparaci√≥n
                const diasDiferencia = Math.floor((new Date(fechaFin) - new Date(fechaInicio)) / (1000 * 60 * 60 * 24)) + 1;
                const fechaInicioAnterior = new Date(fechaInicio);
                fechaInicioAnterior.setDate(fechaInicioAnterior.getDate() - diasDiferencia);
                const fechaFinAnterior = new Date(fechaInicio);
                fechaFinAnterior.setDate(fechaFinAnterior.getDate() - 1);
                
                const lecturasAnteriores = await supabaseRequest(`/env_water_readings_daily?select=*&reading_date=gte.${fechaInicioAnterior.toISOString().split('T')[0]}&reading_date=lte.${fechaFinAnterior.toISOString().split('T')[0]}&is_baseline=eq.false`);
                
                return {
                    lecturas,
                    lecturasAnteriores: lecturasAnteriores || [],
                    poblacion,
                    fechaInicio,
                    fechaFin
                };
                
            } catch (error) {
                throw error;
            }
        }
        
        // ==========================================
        // OBTENER DATOS ALARMAS
        // ==========================================
        async function obtenerDatosAlarmas() {
            try {
                const fechaInicio = document.getElementById('alarmas-fecha-inicio').value;
                const fechaFin = document.getElementById('alarmas-fecha-fin').value;
                const estado = document.getElementById('alarmas-estado').value;
                
                if (!fechaInicio || !fechaFin) {
                    throw new Error('Por favor selecciona ambas fechas');
                }
                
                let query = `/env_water_alerts?select=*,env_water_alert_history(*)&alert_date=gte.${fechaInicio}&alert_date=lte.${fechaFin}&order=alert_date.desc`;
                
                if (estado) {
                    query += `&alert_status=eq.${estado}`;
                }
                
                const alarmas = await supabaseRequest(query);
                
                if (!alarmas || alarmas.length === 0) {
                    throw new Error('No hay alarmas para el per√≠odo y filtros seleccionados');
                }
                
                return {
                    alarmas,
                    fechaInicio,
                    fechaFin,
                    estado
                };
                
            } catch (error) {
                throw error;
            }
        }
        
        // ==========================================
        // OBTENER DATOS √ÅREAS
        // ==========================================
        async function obtenerDatosAreas() {
            try {
                const fechaInicio = document.getElementById('areas-fecha-inicio').value;
                const fechaFin = document.getElementById('areas-fecha-fin').value;
                
                if (!fechaInicio || !fechaFin) {
                    throw new Error('Por favor selecciona ambas fechas');
                }
                
                // Construir lista de meses en el rango
                const inicioDate = new Date(fechaInicio);
                const finDate = new Date(fechaFin);
                const mesesQuery = [];
                
                let currentDate = new Date(inicioDate);
                while (currentDate <= finDate) {
                    const mesKey = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0') + '-01';
                    mesesQuery.push(mesKey);
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
                
                if (mesesQuery.length === 0) {
                    throw new Error('Rango de fechas inv√°lido');
                }
                
                const lecturas = await supabaseRequest(`/env_water_readings_monthly?select=*,env_water_meters(meter_name)&reading_month=in.(${mesesQuery.join(',')})&order=reading_month.asc`);
                
                if (!lecturas || lecturas.length === 0) {
                    throw new Error('No hay lecturas mensuales de √°reas para el per√≠odo seleccionado');
                }
                
                return {
                    lecturas,
                    fechaInicio,
                    fechaFin
                };
                
            } catch (error) {
                throw error;
            }
        }
        
        // ==========================================
        // OBTENER DATOS FUENTES
        // ==========================================
        async function obtenerDatosFuentes() {
            try {
                const fechaInicio = document.getElementById('fuentes-fecha-inicio').value;
                const fechaFin = document.getElementById('fuentes-fecha-fin').value;
                
                if (!fechaInicio || !fechaFin) {
                    throw new Error('Por favor selecciona ambas fechas');
                }
                
                const lecturas = await supabaseRequest(`/env_water_readings_daily?select=*&reading_date=gte.${fechaInicio}&reading_date=lte.${fechaFin}&is_baseline=eq.false&order=reading_date.asc`);
                
                if (!lecturas || lecturas.length === 0) {
                    throw new Error('No hay datos disponibles para el per√≠odo seleccionado');
                }
                
                return {
                    lecturas,
                    fechaInicio,
                    fechaFin
                };
                
            } catch (error) {
                throw error;
            }
        }
        
        // ==========================================
        // OBTENER DATOS EJECUTIVO
        // ==========================================
        async function obtenerDatosEjecutivo() {
            try {
                const mes = parseInt(document.getElementById('ejecutivo-mes').value);
                const ano = parseInt(document.getElementById('ejecutivo-ano').value);
                
                if (!mes || !ano) {
                    throw new Error('Por favor selecciona mes y a√±o');
                }
                
                const fechaInicio = new Date(ano, mes - 1, 1).toISOString().split('T')[0];
                const fechaFin = new Date(ano, mes, 0).toISOString().split('T')[0];
                
                // Lecturas del mes
                const lecturas = await supabaseRequest(`/env_water_readings_daily?select=*&reading_date=gte.${fechaInicio}&reading_date=lte.${fechaFin}&is_baseline=eq.false&order=reading_date.asc`);
                
                // Alarmas del mes
                const alarmas = await supabaseRequest(`/env_water_alerts?select=*&alert_date=gte.${fechaInicio}&alert_date=lte.${fechaFin}&order=alert_date.desc`);
                
                // Lecturas mensuales de √°reas
                const mesKey = ano + '-' + String(mes).padStart(2, '0') + '-01';
                const lecturasAreas = await supabaseRequest(`/env_water_readings_monthly?select=*,env_water_meters(meter_name)&reading_month=eq.${mesKey}&order=reading_value.desc&limit=3`);
                
                // Poblaci√≥n
                const poblacion = await obtenerPoblacionActiva();
                
                if (!lecturas || lecturas.length === 0) {
                    throw new Error('No hay datos disponibles para el mes seleccionado');
                }
                
                return {
                    lecturas,
                    alarmas: alarmas || [],
                    lecturasAreas: lecturasAreas || [],
                    poblacion,
                    mes,
                    ano,
                    fechaInicio,
                    fechaFin
                };
                
            } catch (error) {
                throw error;
            }
        }
        
        // ==========================================
        // OBTENER DATOS POBLACI√ìN
        // ==========================================
        async function obtenerDatosPoblacion() {
            try {
                const fechaInicio = document.getElementById('poblacion-fecha-inicio').value;
                const fechaFin = document.getElementById('poblacion-fecha-fin').value;
                
                if (!fechaInicio || !fechaFin) {
                    throw new Error('Por favor selecciona ambas fechas');
                }
                
                const lecturas = await supabaseRequest(`/env_water_readings_daily?select=*&reading_date=gte.${fechaInicio}&reading_date=lte.${fechaFin}&is_baseline=eq.false&order=reading_date.asc`);
                
                const poblacion = await obtenerPoblacionActiva();
                
                if (!lecturas || lecturas.length === 0) {
                    throw new Error('No hay datos disponibles para el per√≠odo seleccionado');
                }
                
                return {
                    lecturas,
                    poblacion,
                    fechaInicio,
                    fechaFin
                };
                
            } catch (error) {
                throw error;
            }
        }
        
        // ==========================================
        // OBTENER DATOS MANTENIMIENTO
        // ==========================================
        async function obtenerDatosMantenimiento() {
            try {
                const fechaInicio = document.getElementById('mantenimiento-fecha-inicio').value;
                const fechaFin = document.getElementById('mantenimiento-fecha-fin').value;
                
                if (!fechaInicio || !fechaFin) {
                    throw new Error('Por favor selecciona ambas fechas');
                }
                
                // Obtener alarmas del per√≠odo
                const alarmas = await supabaseRequest(`/env_water_alerts?select=*&alert_date=gte.${fechaInicio}&alert_date=lte.${fechaFin}&order=alert_date.desc`);
                
                // Obtener mediciones extraordinarias
                const mediciones = await supabaseRequest(`/env_water_readings_extraordinary?select=*,env_water_meters(meter_name),env_water_alerts(alert_date,alert_type)&reading_date=gte.${fechaInicio}&reading_date=lte.${fechaFin}&order=reading_date.desc`);
                
                return {
                    alarmas: alarmas || [],
                    mediciones: mediciones || [],
                    fechaInicio,
                    fechaFin
                };
                
            } catch (error) {
                throw error;
            }
        }
        
        // ==========================================
        // OBTENER POBLACI√ìN ACTIVA
        // ==========================================
        async function obtenerPoblacionActiva() {
            try {
                // Estudiantes activos
                const estadoActivo = await supabaseRequest('/student_status?select=status_id&status_description=eq.Activo&limit=1');
                
                let totalEstudiantes = 0;
                if (estadoActivo && estadoActivo.length > 0) {
                    const estudiantes = await supabaseRequest(`/students?select=student_id&status_id=eq.${estadoActivo[0].status_id}`);
                    totalEstudiantes = estudiantes ? estudiantes.length : 0;
                }
                
                // Trabajadores activos
                const trabajadores = await supabaseRequest('/workers?select=worker_id&worker_status=eq.active');
                const totalTrabajadores = trabajadores ? trabajadores.length : 0;
                
                return {
                    estudiantes: totalEstudiantes,
                    trabajadores: totalTrabajadores,
                    total: totalEstudiantes + totalTrabajadores
                };
                
            } catch (error) {
                console.error('Error obteniendo poblaci√≥n:', error);
                return { estudiantes: 0, trabajadores: 0, total: 1 };
            }
        }
      // ==========================================
        // GENERAR REPORTE CAR
        // ==========================================
        async function generarReporteCAR(formato) {
            try {
                mostrarLoading();
                
                const tipo = document.getElementById('car-tipo').value;
                const datos = await obtenerDatosCAR(tipo);
                
                if (formato === 'excel') {
                    generarCARExcel(datos);
                } else {
                    generarCARPDF(datos);
                }
                
                modalCAR.hide();
                ocultarLoading();
                showMessage('Reporte generado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error generando reporte CAR:', error);
                showMessage('Error: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // GENERAR CAR EXCEL
        // ==========================================
        function generarCARExcel(datos) {
            const { lecturas, fechaInicio, fechaFin, tipo } = datos;
            
            // Crear workbook
            const wb = XLSX.utils.book_new();
            
            if (tipo === 'mensual') {
                // HOJA 1: DATOS DIARIOS
                const datosTabla = [
                    ['REPORTE MENSUAL CAR - CAPTACI√ìN Y VERTIMIENTO'],
                    ['Colegio Tilata'],
                    ['Per√≠odo: ' + new Date(fechaInicio).toLocaleDateString('es-CO', {month: 'long', year: 'numeric'})],
                    [],
                    ['D√≠a', 'Captaci√≥n R√≠o (m¬≥)', 'Vertimiento PTAR (m¬≥)', 'Diferencia (m¬≥)', 'Diferencia (%)']
                ];
                
                lecturas.forEach(lectura => {
                    const dia = new Date(lectura.reading_date).getDate();
                    const captacion = lectura.captacion_daily || 0;
                    const vertimiento = lectura.ptar_daily || 0;
                    const diferencia = vertimiento - captacion;
                    const diferenciaPct = captacion > 0 ? ((diferencia / captacion) * 100).toFixed(2) : 0;
                    
                    datosTabla.push([
                        dia,
                        captacion.toFixed(2),
                        vertimiento.toFixed(2),
                        diferencia.toFixed(2),
                        diferenciaPct
                    ]);
                });
                
                // Totales
                const totalCaptacion = lecturas.reduce((sum, l) => sum + (l.captacion_daily || 0), 0);
                const totalVertimiento = lecturas.reduce((sum, l) => sum + (l.ptar_daily || 0), 0);
                const totalDiferencia = totalVertimiento - totalCaptacion;
                const totalDiferenciaPct = totalCaptacion > 0 ? ((totalDiferencia / totalCaptacion) * 100).toFixed(2) : 0;
                
                datosTabla.push([]);
                datosTabla.push([
                    'TOTAL',
                    totalCaptacion.toFixed(2),
                    totalVertimiento.toFixed(2),
                    totalDiferencia.toFixed(2),
                    totalDiferenciaPct
                ]);
                
                datosTabla.push([
                    'PROMEDIO DIARIO',
                    (totalCaptacion / lecturas.length).toFixed(2),
                    (totalVertimiento / lecturas.length).toFixed(2),
                    (totalDiferencia / lecturas.length).toFixed(2),
                    ''
                ]);
                
                const ws = XLSX.utils.aoa_to_sheet(datosTabla);
                
                // Ajustar anchos de columna
                ws['!cols'] = [
                    { wch: 10 },
                    { wch: 20 },
                    { wch: 22 },
                    { wch: 18 },
                    { wch: 18 }
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Datos Mensuales');
                
            } else {
                // ANUAL: Agrupar por mes
                const datosPorMes = {};
                
                lecturas.forEach(lectura => {
                    const fecha = new Date(lectura.reading_date);
                    const mesKey = fecha.getFullYear() + '-' + String(fecha.getMonth() + 1).padStart(2, '0');
                    
                    if (!datosPorMes[mesKey]) {
                        datosPorMes[mesKey] = {
                            captacion: 0,
                            vertimiento: 0,
                            dias: 0
                        };
                    }
                    
                    datosPorMes[mesKey].captacion += lectura.captacion_daily || 0;
                    datosPorMes[mesKey].vertimiento += lectura.ptar_daily || 0;
                    datosPorMes[mesKey].dias++;
                });
                
                const datosTabla = [
                    ['REPORTE ANUAL CAR - CAPTACI√ìN Y VERTIMIENTO'],
                    ['Colegio Tilata'],
                    ['A√±o: ' + new Date(fechaInicio).getFullYear()],
                    [],
                    ['Mes', 'Captaci√≥n R√≠o (m¬≥)', 'Vertimiento PTAR (m¬≥)', 'Diferencia (m¬≥)', 'Diferencia (%)', 'D√≠as registrados']
                ];
                
                const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                
                let totalAnualCaptacion = 0;
                let totalAnualVertimiento = 0;
                
                Object.keys(datosPorMes).sort().forEach(mesKey => {
                    const [ano, mes] = mesKey.split('-');
                    const mesNum = parseInt(mes);
                    const datos = datosPorMes[mesKey];
                    
                    const diferencia = datos.vertimiento - datos.captacion;
                    const diferenciaPct = datos.captacion > 0 ? ((diferencia / datos.captacion) * 100).toFixed(2) : 0;
                    
                    totalAnualCaptacion += datos.captacion;
                    totalAnualVertimiento += datos.vertimiento;
                    
                    datosTabla.push([
                        mesesNombres[mesNum - 1],
                        datos.captacion.toFixed(2),
                        datos.vertimiento.toFixed(2),
                        diferencia.toFixed(2),
                        diferenciaPct,
                        datos.dias
                    ]);
                });
                
                const totalDiferencia = totalAnualVertimiento - totalAnualCaptacion;
                const totalDiferenciaPct = totalAnualCaptacion > 0 ? ((totalDiferencia / totalAnualCaptacion) * 100).toFixed(2) : 0;
                
                datosTabla.push([]);
                datosTabla.push([
                    'TOTAL ANUAL',
                    totalAnualCaptacion.toFixed(2),
                    totalAnualVertimiento.toFixed(2),
                    totalDiferencia.toFixed(2),
                    totalDiferenciaPct,
                    lecturas.length
                ]);
                
                const ws = XLSX.utils.aoa_to_sheet(datosTabla);
                
                ws['!cols'] = [
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 22 },
                    { wch: 18 },
                    { wch: 18 },
                    { wch: 18 }
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Consolidado Anual');
            }
            
            // Descargar archivo
            const nombreArchivo = tipo === 'mensual' 
                ? `CAR_Mensual_${fechaInicio}.xlsx`
                : `CAR_Anual_${new Date(fechaInicio).getFullYear()}.xlsx`;
            
            XLSX.writeFile(wb, nombreArchivo);
        }
        
        // ==========================================
        // GENERAR REPORTE ALARMAS
        // ==========================================
        async function generarReporteAlarmas(formato) {
            try {
                mostrarLoading();
                
                const datos = await obtenerDatosAlarmas();
                
                if (formato === 'excel') {
                    generarAlarmasExcel(datos);
                } else {
                    generarAlarmasPDF(datos);
                }
                
                modalAlarmas.hide();
                ocultarLoading();
                showMessage('Reporte generado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error generando reporte:', error);
                showMessage('Error: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // GENERAR ALARMAS EXCEL
        // ==========================================
        function generarAlarmasExcel(datos) {
            const { alarmas, fechaInicio, fechaFin } = datos;
            
            const wb = XLSX.utils.book_new();
            
            const datosTabla = [
                ['HISTORIAL DE ALARMAS H√çDRICAS'],
                ['Colegio Tilata'],
                ['Per√≠odo: ' + new Date(fechaInicio).toLocaleDateString('es-CO') + ' a ' + new Date(fechaFin).toLocaleDateString('es-CO')],
                [],
                ['Fecha', 'Tipo', 'Estado', 'Entrada (m¬≥)', 'Salida (m¬≥)', 'Diferencia (%)', 'Mediciones Extra', 'Notas Investigaci√≥n', 'Notas Resoluci√≥n']
            ];
            
            alarmas.forEach(alarma => {
                datosTabla.push([
                    new Date(alarma.alert_date).toLocaleDateString('es-CO'),
                    alarma.alert_type === 'critical' ? 'Cr√≠tica' : 'Advertencia',
                    alarma.alert_status === 'pending' ? 'Pendiente' : alarma.alert_status === 'investigating' ? 'Investigando' : 'Resuelta',
                    (alarma.entrada_total || 0).toFixed(2),
                    (alarma.salida_total || 0).toFixed(2),
                    (alarma.diferencia_porcentaje || 0).toFixed(2),
                    alarma.extraordinary_readings_count || 0,
                    alarma.investigation_notes || '',
                    alarma.resolution_notes || ''
                ]);
            });
            
            // Resumen
            datosTabla.push([]);
            datosTabla.push(['RESUMEN']);
            datosTabla.push(['Total de alarmas:', alarmas.length]);
            datosTabla.push(['Advertencias:', alarmas.filter(a => a.alert_type === 'warning').length]);
            datosTabla.push(['Cr√≠ticas:', alarmas.filter(a => a.alert_type === 'critical').length]);
            datosTabla.push(['Pendientes:', alarmas.filter(a => a.alert_status === 'pending').length]);
            datosTabla.push(['En Investigaci√≥n:', alarmas.filter(a => a.alert_status === 'investigating').length]);
            datosTabla.push(['Resueltas:', alarmas.filter(a => a.alert_status === 'resolved').length]);
            
            const ws = XLSX.utils.aoa_to_sheet(datosTabla);
            
            ws['!cols'] = [
                { wch: 12 },
                { wch: 12 },
                { wch: 15 },
                { wch: 15 },
                { wch: 15 },
                { wch: 15 },
                { wch: 15 },
                { wch: 30 },
                { wch: 30 }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Historial Alarmas');
            
            XLSX.writeFile(wb, `Alarmas_${fechaInicio}_${fechaFin}.xlsx`);
        }
        
        // ==========================================
        // GENERAR REPORTE √ÅREAS
        // ==========================================
        async function generarReporteAreas(formato) {
            try {
                mostrarLoading();
                
                const datos = await obtenerDatosAreas();
                
                if (formato === 'excel') {
                    generarAreasExcel(datos);
                } else {
                    generarAreasPDF(datos);
                }
                
                modalAreas.hide();
                ocultarLoading();
                showMessage('Reporte generado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error generando reporte:', error);
                showMessage('Error: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // GENERAR √ÅREAS EXCEL
        // ==========================================
        function generarAreasExcel(datos) {
            const { lecturas, fechaInicio, fechaFin } = datos;
            
            const wb = XLSX.utils.book_new();
            
            // Agrupar por √°rea
            const consumoPorArea = {};
            
            lecturas.forEach(lectura => {
                const areaNombre = lectura.env_water_meters?.meter_name || 'Desconocido';
                const mes = new Date(lectura.reading_month).toLocaleDateString('es-CO', { month: 'short', year: 'numeric' });
                
                if (!consumoPorArea[areaNombre]) {
                    consumoPorArea[areaNombre] = { meses: {}, total: 0 };
                }
                
                consumoPorArea[areaNombre].meses[mes] = lectura.reading_value || 0;
                consumoPorArea[areaNombre].total += lectura.reading_value || 0;
            });
            
            const datosTabla = [
                ['COMPARATIVO DE CONSUMO POR √ÅREAS'],
                ['Colegio Tilata'],
                ['Per√≠odo: ' + new Date(fechaInicio).toLocaleDateString('es-CO') + ' a ' + new Date(fechaFin).toLocaleDateString('es-CO')],
                [],
                ['√Årea', 'Total (m¬≥)', '% del Total', 'Promedio Mensual (m¬≥)']
            ];
            
            const totalGeneral = Object.values(consumoPorArea).reduce((sum, area) => sum + area.total, 0);
            
            // Ordenar por consumo total
            const areasOrdenadas = Object.entries(consumoPorArea).sort((a, b) => b[1].total - a[1].total);
            
            areasOrdenadas.forEach(([nombre, datos]) => {
                const porcentaje = totalGeneral > 0 ? ((datos.total / totalGeneral) * 100).toFixed(2) : 0;
                const cantidadMeses = Object.keys(datos.meses).length;
                const promedio = cantidadMeses > 0 ? (datos.total / cantidadMeses).toFixed(2) : 0;
                
                datosTabla.push([
                    nombre,
                    datos.total.toFixed(2),
                    porcentaje,
                    promedio
                ]);
            });
            
            datosTabla.push([]);
            datosTabla.push(['TOTAL', totalGeneral.toFixed(2), '100.00', '']);
            
            const ws = XLSX.utils.aoa_to_sheet(datosTabla);
            
            ws['!cols'] = [
                { wch: 30 },
                { wch: 15 },
                { wch: 15 },
                { wch: 20 }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Comparativo √Åreas');
            
            XLSX.writeFile(wb, `Comparativo_Areas_${fechaInicio}_${fechaFin}.xlsx`);
        }
        
        // ==========================================
        // GENERAR REPORTE POBLACI√ìN
        // ==========================================
        async function generarReportePoblacion(formato) {
            try {
                mostrarLoading();
                
                const datos = await obtenerDatosPoblacion();
                
                if (formato === 'excel') {
                    generarPoblacionExcel(datos);
                } else {
                    generarPoblacionPDF(datos);
                }
                
                modalPoblacion.hide();
                ocultarLoading();
                showMessage('Reporte generado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error generando reporte:', error);
                showMessage('Error: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // GENERAR POBLACI√ìN EXCEL
        // ==========================================
        function generarPoblacionExcel(datos) {
            const { lecturas, poblacion, fechaInicio, fechaFin } = datos;
            
            const wb = XLSX.utils.book_new();
            
            const datosTabla = [
                ['AN√ÅLISIS POBLACI√ìN VS CONSUMO'],
                ['Colegio Tilata'],
                ['Per√≠odo: ' + new Date(fechaInicio).toLocaleDateString('es-CO') + ' a ' + new Date(fechaFin).toLocaleDateString('es-CO')],
                [],
                ['POBLACI√ìN ACTIVA'],
                ['Estudiantes:', poblacion.estudiantes],
                ['Trabajadores:', poblacion.trabajadores],
                ['Total:', poblacion.total],
                [],
                ['Fecha', 'Entrada (m¬≥)', 'Per C√°pita (m¬≥/persona)']
            ];
            
            let totalEntrada = 0;
            
            lecturas.forEach(lectura => {
                const entrada = lectura.total_entrada || 0;
                const perCapita = poblacion.total > 0 ? (entrada / poblacion.total).toFixed(3) : 0;
                
                totalEntrada += entrada;
                
                datosTabla.push([
                    new Date(lectura.reading_date).toLocaleDateString('es-CO'),
                    entrada.toFixed(2),
                    perCapita
                ]);
            });
            
            const promedioPerCapita = poblacion.total > 0 && lecturas.length > 0 
                ? ((totalEntrada / lecturas.length) / poblacion.total).toFixed(3)
                : 0;
            
            datosTabla.push([]);
            datosTabla.push(['PROMEDIO DIARIO', (totalEntrada / lecturas.length).toFixed(2), promedioPerCapita]);
            
            const ws = XLSX.utils.aoa_to_sheet(datosTabla);
            
            ws['!cols'] = [
                { wch: 20 },
                { wch: 18 },
                { wch: 25 }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Poblaci√≥n vs Consumo');
            
            XLSX.writeFile(wb, `Poblacion_Consumo_${fechaInicio}_${fechaFin}.xlsx`);
        }
      // ==========================================
        // GENERAR CAR PDF
        // ==========================================
        function generarCARPDF(datos) {
            const { lecturas, fechaInicio, fechaFin, tipo } = datos;
            
            let contenidoHTML = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Reporte CAR ${tipo === 'mensual' ? 'Mensual' : 'Anual'}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 20px;
                            font-size: 11px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 3px solid #dc3545;
                            padding-bottom: 15px;
                        }
                        .header h1 {
                            margin: 0;
                            color: #dc3545;
                            font-size: 22px;
                        }
                        .info-section {
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 15px;
                        }
                        th, td {
                            border: 1px solid #dee2e6;
                            padding: 8px;
                            text-align: center;
                        }
                        th {
                            background-color: #dc3545;
                            color: white;
                            font-weight: bold;
                        }
                        tr:nth-child(even) {
                            background-color: #f8f9fa;
                        }
                        .total-row {
                            background-color: #fff3cd !important;
                            font-weight: bold;
                        }
                        .footer {
                            margin-top: 40px;
                            text-align: center;
                            font-size: 9px;
                            color: #6c757d;
                            border-top: 1px solid #dee2e6;
                            padding-top: 15px;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>REPORTE ${tipo === 'mensual' ? 'MENSUAL' : 'ANUAL'} CAR</h1>
                        <p>CAPTACI√ìN Y VERTIMIENTO DE AGUA</p>
                        <p style="font-size: 10px; color: #6c757d;">Colegio Tilata</p>
                    </div>
                    
                    <div class="info-section">
                        <strong>Per√≠odo:</strong> ${tipo === 'mensual' 
                            ? new Date(fechaInicio).toLocaleDateString('es-CO', {month: 'long', year: 'numeric'})
                            : 'A√±o ' + new Date(fechaInicio).getFullYear()
                        }<br>
                        <strong>Generado:</strong> ${new Date().toLocaleString('es-CO')}<br>
                        <strong>D√≠as registrados:</strong> ${lecturas.length}
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>${tipo === 'mensual' ? 'D√≠a' : 'Mes'}</th>
                                <th>Captaci√≥n R√≠o (m¬≥)</th>
                                <th>Vertimiento PTAR (m¬≥)</th>
                                <th>Diferencia (m¬≥)</th>
                                <th>Diferencia (%)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            if (tipo === 'mensual') {
                let totalCaptacion = 0;
                let totalVertimiento = 0;
                
                lecturas.forEach(lectura => {
                    const dia = new Date(lectura.reading_date).getDate();
                    const captacion = lectura.captacion_daily || 0;
                    const vertimiento = lectura.ptar_daily || 0;
                    const diferencia = vertimiento - captacion;
                    const diferenciaPct = captacion > 0 ? ((diferencia / captacion) * 100).toFixed(2) : 0;
                    
                    totalCaptacion += captacion;
                    totalVertimiento += vertimiento;
                    
                    contenidoHTML += `
                        <tr>
                            <td>${dia}</td>
                            <td>${captacion.toFixed(2)}</td>
                            <td>${vertimiento.toFixed(2)}</td>
                            <td>${diferencia.toFixed(2)}</td>
                            <td>${diferenciaPct}%</td>
                        </tr>
                    `;
                });
                
                const totalDiferencia = totalVertimiento - totalCaptacion;
                const totalDiferenciaPct = totalCaptacion > 0 ? ((totalDiferencia / totalCaptacion) * 100).toFixed(2) : 0;
                
                contenidoHTML += `
                    <tr class="total-row">
                        <td>TOTAL</td>
                        <td>${totalCaptacion.toFixed(2)}</td>
                        <td>${totalVertimiento.toFixed(2)}</td>
                        <td>${totalDiferencia.toFixed(2)}</td>
                        <td>${totalDiferenciaPct}%</td>
                    </tr>
                    <tr class="total-row">
                        <td>PROMEDIO DIARIO</td>
                        <td>${(totalCaptacion / lecturas.length).toFixed(2)}</td>
                        <td>${(totalVertimiento / lecturas.length).toFixed(2)}</td>
                        <td>${(totalDiferencia / lecturas.length).toFixed(2)}</td>
                        <td></td>
                    </tr>
                `;
                
            } else {
                // Agrupar por mes
                const datosPorMes = {};
                
                lecturas.forEach(lectura => {
                    const fecha = new Date(lectura.reading_date);
                    const mesKey = fecha.getFullYear() + '-' + String(fecha.getMonth() + 1).padStart(2, '0');
                    
                    if (!datosPorMes[mesKey]) {
                        datosPorMes[mesKey] = { captacion: 0, vertimiento: 0 };
                    }
                    
                    datosPorMes[mesKey].captacion += lectura.captacion_daily || 0;
                    datosPorMes[mesKey].vertimiento += lectura.ptar_daily || 0;
                });
                
                const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                
                let totalAnualCaptacion = 0;
                let totalAnualVertimiento = 0;
                
                Object.keys(datosPorMes).sort().forEach(mesKey => {
                    const [ano, mes] = mesKey.split('-');
                    const mesNum = parseInt(mes);
                    const datos = datosPorMes[mesKey];
                    
                    const diferencia = datos.vertimiento - datos.captacion;
                    const diferenciaPct = datos.captacion > 0 ? ((diferencia / datos.captacion) * 100).toFixed(2) : 0;
                    
                    totalAnualCaptacion += datos.captacion;
                    totalAnualVertimiento += datos.vertimiento;
                    
                    contenidoHTML += `
                        <tr>
                            <td>${mesesNombres[mesNum - 1]}</td>
                            <td>${datos.captacion.toFixed(2)}</td>
                            <td>${datos.vertimiento.toFixed(2)}</td>
                            <td>${diferencia.toFixed(2)}</td>
                            <td>${diferenciaPct}%</td>
                        </tr>
                    `;
                });
                
                const totalDiferencia = totalAnualVertimiento - totalAnualCaptacion;
                const totalDiferenciaPct = totalAnualCaptacion > 0 ? ((totalDiferencia / totalAnualCaptacion) * 100).toFixed(2) : 0;
                
                contenidoHTML += `
                    <tr class="total-row">
                        <td>TOTAL ANUAL</td>
                        <td>${totalAnualCaptacion.toFixed(2)}</td>
                        <td>${totalAnualVertimiento.toFixed(2)}</td>
                        <td>${totalDiferencia.toFixed(2)}</td>
                        <td>${totalDiferenciaPct}%</td>
                    </tr>
                `;
            }
            
            contenidoHTML += `
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p><strong>COLEGIO TILATA</strong></p>
                        <p>Reporte oficial para Corporaci√≥n Aut√≥noma Regional (CAR)</p>
                        <p>Este documento certifica los vol√∫menes de captaci√≥n y vertimiento del per√≠odo indicado</p>
                    </div>
                </body>
                </html>
            `;
            
            const ventana = window.open('', '_blank');
            ventana.document.write(contenidoHTML);
            ventana.document.close();
            ventana.onload = function() {
                ventana.print();
            };
        }
        
        // ==========================================
        // GENERAR EFICIENCIA PDF
        // ==========================================
        async function generarReporteEficiencia() {
            try {
                mostrarLoading();
                const datos = await obtenerDatosEficiencia();
                generarEficienciaPDF(datos);
                modalEficiencia.hide();
                ocultarLoading();
                showMessage('Reporte generado exitosamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        function generarEficienciaPDF(datos) {
            const { lecturas, lecturasAnteriores, poblacion, fechaInicio, fechaFin } = datos;
            
            // Calcular m√©tricas
            const totalEntrada = lecturas.reduce((sum, l) => sum + (l.total_entrada || 0), 0);
            const promedioDiario = totalEntrada / lecturas.length;
            const consumoPerCapita = poblacion.total > 0 ? promedioDiario / poblacion.total : 0;
            
            let comparacion = 'Sin datos anteriores';
            if (lecturasAnteriores.length > 0) {
                const totalAnterior = lecturasAnteriores.reduce((sum, l) => sum + (l.total_entrada || 0), 0);
                const promedioAnterior = totalAnterior / lecturasAnteriores.length;
                const perCapitaAnterior = poblacion.total > 0 ? promedioAnterior / poblacion.total : 0;
                const diferencia = ((consumoPerCapita - perCapitaAnterior) / perCapitaAnterior * 100).toFixed(2);
                comparacion = diferencia < 0 ? `‚Üì Reducci√≥n del ${Math.abs(diferencia)}%` : `‚Üë Incremento del ${diferencia}%`;
            }
            
            let contenidoHTML = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Reporte de Eficiencia H√≠drica</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 11px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #0d6efd; padding-bottom: 15px; }
                        .header h1 { margin: 0; color: #0d6efd; font-size: 22px; }
                        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
                        .kpi-box { border: 2px solid #0d6efd; border-radius: 8px; padding: 15px; text-align: center; }
                        .kpi-value { font-size: 24px; font-weight: bold; color: #0d6efd; }
                        .kpi-label { font-size: 10px; color: #6c757d; text-transform: uppercase; margin-top: 5px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th, td { border: 1px solid #dee2e6; padding: 8px; text-align: center; }
                        th { background-color: #0d6efd; color: white; }
                        .footer { margin-top: 40px; text-align: center; font-size: 9px; color: #6c757d; border-top: 1px solid #dee2e6; padding-top: 15px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìä REPORTE DE EFICIENCIA H√çDRICA</h1>
                        <p>Colegio Tilata</p>
                        <p style="font-size: 10px;">Per√≠odo: ${new Date(fechaInicio).toLocaleDateString('es-CO')} - ${new Date(fechaFin).toLocaleDateString('es-CO')}</p>
                    </div>
                    
                    <div class="kpi-grid">
                        <div class="kpi-box">
                            <div class="kpi-value">${poblacion.total}</div>
                            <div class="kpi-label">Poblaci√≥n Total</div>
                        </div>
                        <div class="kpi-box">
                            <div class="kpi-value">${consumoPerCapita.toFixed(3)}</div>
                            <div class="kpi-label">m¬≥/persona/d√≠a</div>
                        </div>
                        <div class="kpi-box">
                            <div class="kpi-value">${promedioDiario.toFixed(2)}</div>
                            <div class="kpi-label">Consumo Promedio Diario (m¬≥)</div>
                        </div>
                    </div>
                    
                    <h3>Comparaci√≥n con Per√≠odo Anterior</h3>
                    <p><strong>${comparacion}</strong></p>
                    
                    <h3>Detalle Diario</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Entrada (m¬≥)</th>
                                <th>Per C√°pita (m¬≥/persona)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            lecturas.forEach(lectura => {
                const entrada = lectura.total_entrada || 0;
                const perCapita = poblacion.total > 0 ? (entrada / poblacion.total).toFixed(3) : 0;
                
                contenidoHTML += `
                    <tr>
                        <td>${new Date(lectura.reading_date).toLocaleDateString('es-CO')}</td>
                        <td>${entrada.toFixed(2)}</td>
                        <td>${perCapita}</td>
                    </tr>
                `;
            });
            
            contenidoHTML += `
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>SchoolNet - Gesti√≥n Ambiental | Colegio Tilata</p>
                    </div>
                </body>
                </html>
            `;
            
            const ventana = window.open('', '_blank');
            ventana.document.write(contenidoHTML);
            ventana.document.close();
            ventana.onload = function() { ventana.print(); };
        }
        
        // ==========================================
        // GENERAR ALARMAS PDF
        // ==========================================
        function generarAlarmasPDF(datos) {
            const { alarmas, fechaInicio, fechaFin } = datos;
            
            let contenidoHTML = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Historial de Alarmas</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 10px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #ffc107; padding-bottom: 15px; }
                        .header h1 { margin: 0; color: #ffc107; font-size: 22px; }
                        .summary { background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 9px; }
                        th, td { border: 1px solid #dee2e6; padding: 6px; }
                        th { background-color: #ffc107; color: black; }
                        .footer { margin-top: 40px; text-align: center; font-size: 9px; color: #6c757d; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üö® HISTORIAL DE ALARMAS H√çDRICAS</h1>
                        <p>Colegio Tilata</p>
                        <p>Per√≠odo: ${new Date(fechaInicio).toLocaleDateString('es-CO')} - ${new Date(fechaFin).toLocaleDateString('es-CO')}</p>
                    </div>
                    
                    <div class="summary">
                        <strong>RESUMEN:</strong><br>
                        Total: ${alarmas.length} | 
                        üü° Advertencias: ${alarmas.filter(a => a.alert_type === 'warning').length} | 
                        üî¥ Cr√≠ticas: ${alarmas.filter(a => a.alert_type === 'critical').length} | 
                        Resueltas: ${alarmas.filter(a => a.alert_status === 'resolved').length}
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Estado</th>
                                <th>Entrada</th>
                                <th>Salida</th>
                                <th>Dif. %</th>
                                <th>Med. Extra</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            alarmas.forEach(alarma => {
                contenidoHTML += `
                    <tr>
                        <td>${new Date(alarma.alert_date).toLocaleDateString('es-CO')}</td>
                        <td>${alarma.alert_type === 'critical' ? 'üî¥ Cr√≠tica' : 'üü° Advertencia'}</td>
                        <td>${alarma.alert_status === 'pending' ? 'Pendiente' : alarma.alert_status === 'investigating' ? 'Investigando' : 'Resuelta'}</td>
                        <td>${(alarma.entrada_total || 0).toFixed(2)}</td>
                        <td>${(alarma.salida_total || 0).toFixed(2)}</td>
                        <td>${(alarma.diferencia_porcentaje || 0).toFixed(2)}%</td>
                        <td>${alarma.extraordinary_readings_count || 0}</td>
                    </tr>
                `;
            });
            
            contenidoHTML += `
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>SchoolNet - Gesti√≥n Ambiental | Colegio Tilata</p>
                    </div>
                </body>
                </html>
            `;
            
            const ventana = window.open('', '_blank');
            ventana.document.write(contenidoHTML);
            ventana.document.close();
            ventana.onload = function() { ventana.print(); };
        }
        
        // ==========================================
        // GENERAR √ÅREAS PDF
        // ==========================================
        function generarAreasPDF(datos) {
            const { lecturas, fechaInicio, fechaFin } = datos;
            
            // Agrupar por √°rea
            const consumoPorArea = {};
            
            lecturas.forEach(lectura => {
                const areaNombre = lectura.env_water_meters?.meter_name || 'Desconocido';
                if (!consumoPorArea[areaNombre]) {
                    consumoPorArea[areaNombre] = 0;
                }
                consumoPorArea[areaNombre] += lectura.reading_value || 0;
            });
            
            const totalGeneral = Object.values(consumoPorArea).reduce((sum, val) => sum + val, 0);
            const areasOrdenadas = Object.entries(consumoPorArea).sort((a, b) => b[1] - a[1]);
            
            let contenidoHTML = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Comparativo de √Åreas</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 11px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #0d6efd; padding-bottom: 15px; }
                        .header h1 { margin: 0; color: #0d6efd; font-size: 22px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th, td { border: 1px solid #dee2e6; padding: 8px; }
                        th { background-color: #0d6efd; color: white; }
                        .footer { margin-top: 40px; text-align: center; font-size: 9px; color: #6c757d; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìç COMPARATIVO DE CONSUMO POR √ÅREAS</h1>
                        <p>Colegio Tilata</p>
                        <p>Per√≠odo: ${new Date(fechaInicio).toLocaleDateString('es-CO')} - ${new Date(fechaFin).toLocaleDateString('es-CO')}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>√Årea</th>
                                <th>Consumo Total (m¬≥)</th>
                                <th>% del Total</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            areasOrdenadas.forEach(([nombre, consumo]) => {
                const porcentaje = totalGeneral > 0 ? ((consumo / totalGeneral) * 100).toFixed(2) : 0;
                contenidoHTML += `
                    <tr>
                        <td>${nombre}</td>
                        <td style="text-align: right;">${consumo.toFixed(2)}</td>
                        <td style="text-align: center;">${porcentaje}%</td>
                    </tr>
                `;
            });
            
            contenidoHTML += `
                            <tr style="background-color: #fff3cd; font-weight: bold;">
                                <td>TOTAL</td>
                                <td style="text-align: right;">${totalGeneral.toFixed(2)}</td>
                                <td style="text-align: center;">100%</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>SchoolNet - Gesti√≥n Ambiental | Colegio Tilata</p>
                    </div>
                </body>
                </html>
            `;
            
            const ventana = window.open('', '_blank');
            ventana.document.write(contenidoHTML);
            ventana.document.close();
            ventana.onload = function() { ventana.print(); };
        }
      // ==========================================
        // GENERAR FUENTES PDF
        // ==========================================
        async function generarReporteFuentes() {
            try {
                mostrarLoading();
                const datos = await obtenerDatosFuentes();
                generarFuentesPDF(datos);
                modalFuentes.hide();
                ocultarLoading();
                showMessage('Reporte generado exitosamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        function generarFuentesPDF(datos) {
            const { lecturas, fechaInicio, fechaFin } = datos;
            
            const totalCaptacion = lecturas.reduce((sum, l) => sum + (l.captacion_daily || 0), 0);
            const totalAcueducto = lecturas.reduce((sum, l) => sum + (l.acueducto_daily || 0), 0);
            const totalEntrada = totalCaptacion + totalAcueducto;
            
            const pctCaptacion = totalEntrada > 0 ? ((totalCaptacion / totalEntrada) * 100).toFixed(2) : 0;
            const pctAcueducto = totalEntrada > 0 ? ((totalAcueducto / totalEntrada) * 100).toFixed(2) : 0;
            
            let contenidoHTML = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Distribuci√≥n de Fuentes</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 11px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #0d6efd; padding-bottom: 15px; }
                        .header h1 { margin: 0; color: #0d6efd; font-size: 22px; }
                        .summary-box { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
                        .source-box { border: 2px solid #0d6efd; border-radius: 8px; padding: 20px; text-align: center; }
                        .source-value { font-size: 28px; font-weight: bold; color: #0d6efd; }
                        .source-label { font-size: 12px; color: #6c757d; margin-top: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #dee2e6; padding: 8px; text-align: center; }
                        th { background-color: #0d6efd; color: white; }
                        .footer { margin-top: 40px; text-align: center; font-size: 9px; color: #6c757d; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üåä DISTRIBUCI√ìN DE FUENTES DE AGUA</h1>
                        <p>Colegio Tilata</p>
                        <p>Per√≠odo: ${new Date(fechaInicio).toLocaleDateString('es-CO')} - ${new Date(fechaFin).toLocaleDateString('es-CO')}</p>
                    </div>
                    
                    <div class="summary-box">
                        <div class="source-box">
                            <div class="source-value">${pctCaptacion}%</div>
                            <div class="source-label">CAPTACI√ìN R√çO</div>
                            <div style="margin-top: 10px; font-size: 14px;">${totalCaptacion.toFixed(2)} m¬≥</div>
                        </div>
                        <div class="source-box">
                            <div class="source-value">${pctAcueducto}%</div>
                            <div class="source-label">ACUEDUCTO VEREDAL</div>
                            <div style="margin-top: 10px; font-size: 14px;">${totalAcueducto.toFixed(2)} m¬≥</div>
                        </div>
                    </div>
                    
                    <h3>Detalle Diario</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Captaci√≥n (m¬≥)</th>
                                <th>Acueducto (m¬≥)</th>
                                <th>Total Entrada (m¬≥)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            lecturas.forEach(lectura => {
                const captacion = lectura.captacion_daily || 0;
                const acueducto = lectura.acueducto_daily || 0;
                const total = lectura.total_entrada || 0;
                
                contenidoHTML += `
                    <tr>
                        <td>${new Date(lectura.reading_date).toLocaleDateString('es-CO')}</td>
                        <td>${captacion.toFixed(2)}</td>
                        <td>${acueducto.toFixed(2)}</td>
                        <td>${total.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            contenidoHTML += `
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>SchoolNet - Gesti√≥n Ambiental | Colegio Tilata</p>
                    </div>
                </body>
                </html>
            `;
            
            const ventana = window.open('', '_blank');
            ventana.document.write(contenidoHTML);
            ventana.document.close();
            ventana.onload = function() { ventana.print(); };
        }
        
        // ==========================================
        // GENERAR EJECUTIVO PDF
        // ==========================================
        async function generarReporteEjecutivo() {
            try {
                mostrarLoading();
                const datos = await obtenerDatosEjecutivo();
                generarEjecutivoPDF(datos);
                modalEjecutivo.hide();
                ocultarLoading();
                showMessage('Reporte generado exitosamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        function generarEjecutivoPDF(datos) {
            const { lecturas, alarmas, lecturasAreas, poblacion, mes, ano } = datos;
            
            const mesesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const totalEntrada = lecturas.reduce((sum, l) => sum + (l.total_entrada || 0), 0);
            const totalSalida = lecturas.reduce((sum, l) => sum + (l.total_salida || 0), 0);
            const promedioBalance = lecturas.reduce((sum, l) => sum + (l.diferencia_porcentaje || 0), 0) / lecturas.length;
            const consumoPerCapita = poblacion.total > 0 ? (totalEntrada / lecturas.length / poblacion.total).toFixed(3) : 0;
            
            let contenidoHTML = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Resumen Ejecutivo</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 11px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #198754; padding-bottom: 15px; }
                        .header h1 { margin: 0; color: #198754; font-size: 22px; }
                        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
                        .kpi-box { border: 2px solid #198754; border-radius: 8px; padding: 12px; text-align: center; }
                        .kpi-value { font-size: 20px; font-weight: bold; color: #198754; }
                        .kpi-label { font-size: 9px; color: #6c757d; margin-top: 5px; }
                        .section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
                        .section h3 { margin: 0 0 10px 0; color: #198754; }
                        ul { margin: 5px 0; padding-left: 20px; }
                        .footer { margin-top: 40px; text-align: center; font-size: 9px; color: #6c757d; page-break-before: avoid; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìä RESUMEN EJECUTIVO MENSUAL</h1>
                        <p>Colegio Tilata - Gesti√≥n de Agua</p>
                        <p>${mesesNombres[mes - 1]} ${ano}</p>
                    </div>
                    
                    <div class="kpi-grid">
                        <div class="kpi-box">
                            <div class="kpi-value">${(totalEntrada / 1000).toFixed(1)}k</div>
                            <div class="kpi-label">Entrada Total (m¬≥)</div>
                        </div>
                        <div class="kpi-box">
                            <div class="kpi-value">${(totalSalida / 1000).toFixed(1)}k</div>
                            <div class="kpi-label">Salida Total (m¬≥)</div>
                        </div>
                        <div class="kpi-box">
                            <div class="kpi-value">${promedioBalance.toFixed(1)}%</div>
                            <div class="kpi-label">Balance Promedio</div>
                        </div>
                        <div class="kpi-box">
                            <div class="kpi-value">${alarmas.length}</div>
                            <div class="kpi-label">Alarmas Registradas</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üìä Poblaci√≥n y Eficiencia</h3>
                        <p><strong>Poblaci√≥n Total:</strong> ${poblacion.total} (${poblacion.estudiantes} estudiantes + ${poblacion.trabajadores} trabajadores)</p>
                        <p><strong>Consumo Per C√°pita:</strong> ${consumoPerCapita} m¬≥/persona/d√≠a</p>
                    </div>
                    
                    <div class="section">
                        <h3>üö® Gesti√≥n de Alarmas</h3>
                        <p><strong>Total:</strong> ${alarmas.length} alarmas</p>
                        <ul>
                            <li>üü° Advertencias: ${alarmas.filter(a => a.alert_type === 'warning').length}</li>
                            <li>üî¥ Cr√≠ticas: ${alarmas.filter(a => a.alert_type === 'critical').length}</li>
                            <li>‚úÖ Resueltas: ${alarmas.filter(a => a.alert_status === 'resolved').length}</li>
                            <li>‚è≥ Pendientes: ${alarmas.filter(a => a.alert_status === 'pending').length}</li>
                        </ul>
                    </div>
            `;
            
            if (lecturasAreas.length > 0) {
                contenidoHTML += `
                    <div class="section">
                        <h3>üìç Top 3 √Åreas con Mayor Consumo</h3>
                        <ol>
                `;
                lecturasAreas.forEach(lectura => {
                    contenidoHTML += `<li><strong>${lectura.env_water_meters.meter_name}:</strong> ${lectura.reading_value.toFixed(2)} m¬≥</li>`;
                });
                contenidoHTML += `
                        </ol>
                    </div>
                `;
            }
            
            contenidoHTML += `
                    <div class="section">
                        <h3>üí° Recomendaciones</h3>
                        <ul>
            `;
            
            if (promedioBalance > 5) {
                contenidoHTML += `<li>‚ö†Ô∏è Balance promedio elevado. Revisar sistema de medici√≥n y buscar fugas.</li>`;
            }
            
            if (alarmas.filter(a => a.alert_status === 'pending').length > 0) {
                contenidoHTML += `<li>‚ö†Ô∏è Resolver alarmas pendientes a la brevedad.</li>`;
            }
            
            if (consumoPerCapita > 2) {
                contenidoHTML += `<li>üíß Consumo per c√°pita alto. Implementar campa√±as de uso responsable.</li>`;
            }
            
            if (promedioBalance <= 3 && alarmas.length < 5) {
                contenidoHTML += `<li>‚úÖ Desempe√±o h√≠drico dentro de par√°metros normales.</li>`;
            }
            
            contenidoHTML += `
                        </ul>
                    </div>
                    
                    <div class="footer">
                        <p><strong>Generado:</strong> ${new Date().toLocaleString('es-CO')}</p>
                        <p>SchoolNet - Gesti√≥n Ambiental | Colegio Tilata</p>
                    </div>
                </body>
                </html>
            `;
            
            const ventana = window.open('', '_blank');
            ventana.document.write(contenidoHTML);
            ventana.document.close();
            ventana.onload = function() { ventana.print(); };
        }
        
        // ==========================================
        // GENERAR POBLACI√ìN PDF
        // ==========================================
        function generarPoblacionPDF(datos) {
            const { lecturas, poblacion, fechaInicio, fechaFin } = datos;
            
            let contenidoHTML = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Poblaci√≥n vs Consumo</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 11px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #198754; padding-bottom: 15px; }
                        .header h1 { margin: 0; color: #198754; font-size: 22px; }
                        .info-box { background: #d1e7dd; padding: 15px; border-radius: 8px; margin: 20px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 10px; }
                        th, td { border: 1px solid #dee2e6; padding: 6px; text-align: center; }
                        th { background-color: #198754; color: white; }
                        .footer { margin-top: 40px; text-align: center; font-size: 9px; color: #6c757d; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üë• AN√ÅLISIS POBLACI√ìN VS CONSUMO</h1>
                        <p>Colegio Tilata</p>
                        <p>Per√≠odo: ${new Date(fechaInicio).toLocaleDateString('es-CO')} - ${new Date(fechaFin).toLocaleDateString('es-CO')}</p>
                    </div>
                    
                    <div class="info-box">
                        <strong>POBLACI√ìN ACTIVA</strong><br>
                        Estudiantes: ${poblacion.estudiantes} | Trabajadores: ${poblacion.trabajadores} | <strong>Total: ${poblacion.total}</strong>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Entrada (m¬≥)</th>
                                <th>Per C√°pita (m¬≥/persona)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let totalEntrada = 0;
            
            lecturas.forEach(lectura => {
                const entrada = lectura.total_entrada || 0;
                const perCapita = poblacion.total > 0 ? (entrada / poblacion.total).toFixed(3) : 0;
                totalEntrada += entrada;
                
                contenidoHTML += `
                    <tr>
                        <td>${new Date(lectura.reading_date).toLocaleDateString('es-CO')}</td>
                        <td>${entrada.toFixed(2)}</td>
                        <td>${perCapita}</td>
                    </tr>
                `;
            });
            
            const promedioPerCapita = poblacion.total > 0 && lecturas.length > 0 
                ? ((totalEntrada / lecturas.length) / poblacion.total).toFixed(3)
                : 0;
            
            contenidoHTML += `
                        </tbody>
                    </table>
                    
                    <div class="info-box" style="margin-top: 20px;">
                        <strong>PROMEDIO DIARIO:</strong> ${promedioPerCapita} m¬≥/persona
                    </div>
                    
                    <div class="footer">
                        <p>SchoolNet - Gesti√≥n Ambiental | Colegio Tilata</p>
                    </div>
                </body>
                </html>
            `;
            
            const ventana = window.open('', '_blank');
            ventana.document.write(contenidoHTML);
            ventana.document.close();
            ventana.onload = function() { ventana.print(); };
        }
        
        // ==========================================
        // GENERAR MANTENIMIENTO PDF
        // ==========================================
        async function generarReporteMantenimiento() {
            try {
                mostrarLoading();
                const datos = await obtenerDatosMantenimiento();
                generarMantenimientoPDF(datos);
                modalMantenimiento.hide();
                ocultarLoading();
                showMessage('Reporte generado exitosamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        function generarMantenimientoPDF(datos) {
            const { alarmas, mediciones, fechaInicio, fechaFin } = datos;
            
            // Agrupar mediciones por √°rea
            const medicionesPorArea = {};
            
            mediciones.forEach(med => {
                const area = med.env_water_meters?.meter_name || 'Desconocido';
                if (!medicionesPorArea[area]) {
                    medicionesPorArea[area] = [];
                }
                medicionesPorArea[area].push(med);
            });
            
            let contenidoHTML = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Mantenimiento Preventivo</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 11px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #198754; padding-bottom: 15px; }
                        .header h1 { margin: 0; color: #198754; font-size: 22px; }
                        .section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
                        .section h3 { margin: 0 0 10px 0; color: #198754; }
                        .area-box { border-left: 4px solid #ffc107; padding: 10px; margin: 10px 0; background: white; }
                        ul { margin: 5px 0; padding-left: 20px; }
                        .footer { margin-top: 40px; text-align: center; font-size: 9px; color: #6c757d; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üîß REPORTE DE MANTENIMIENTO PREVENTIVO</h1>
                        <p>Colegio Tilata</p>
                        <p>Per√≠odo: ${new Date(fechaInicio).toLocaleDateString('es-CO')} - ${new Date(fechaFin).toLocaleDateString('es-CO')}</p>
                    </div>
                    
                    <div class="section">
                        <h3>üìä Resumen</h3>
                        <p><strong>Alarmas en el per√≠odo:</strong> ${alarmas.length}</p>
                        <p><strong>Mediciones extraordinarias:</strong> ${mediciones.length}</p>
                        <p><strong>√Åreas con mediciones:</strong> ${Object.keys(medicionesPorArea).length}</p>
                    </div>
            `;
            
            if (Object.keys(medicionesPorArea).length > 0) {
                contenidoHTML += `
                    <div class="section">
                        <h3>üè¢ √Åreas con Mediciones Extraordinarias</h3>
                `;
                
                Object.entries(medicionesPorArea).forEach(([area, meds]) => {
                    contenidoHTML += `
                        <div class="area-box">
                            <strong>${area}</strong> (${meds.length} mediciones)
                            <ul>
                    `;
                    
                    meds.slice(0, 3).forEach(med => {
                        contenidoHTML += `<li>${new Date(med.reading_date).toLocaleDateString('es-CO')}: ${med.reading_value.toFixed(2)} m¬≥ ${med.notes ? '- ' + med.notes : ''}</li>`;
                    });
                    
                    if (meds.length > 3) {
                        contenidoHTML += `<li><em>...y ${meds.length - 3} mediciones m√°s</em></li>`;
                    }
                    
                    contenidoHTML += `
                            </ul>
                        </div>
                    `;
                });
                
                contenidoHTML += `</div>`;
            }
            
            contenidoHTML += `
                    <div class="section">
                        <h3>üí° Recomendaciones</h3>
                        <ul>
            `;
            
            if (alarmas.length > 5) {
                contenidoHTML += `<li>‚ö†Ô∏è Alto n√∫mero de alarmas. Realizar inspecci√≥n general del sistema.</li>`;
            }
            
            if (Object.keys(medicionesPorArea).length > 0) {
                contenidoHTML += `<li>üîç Revisar las √°reas con mediciones extraordinarias para identificar anomal√≠as.</li>`;
            }
            
            const alarmasSinResolver = alarmas.filter(a => a.alert_status !== 'resolved').length;
            if (alarmasSinResolver > 0) {
                contenidoHTML += `<li>‚è∞ ${alarmasSinResolver} alarmas pendientes de resoluci√≥n. Priorizar atenci√≥n.</li>`;
            }
            
            if (alarmas.length === 0 && mediciones.length === 0) {
                contenidoHTML += `<li>‚úÖ No se detectaron anomal√≠as en el per√≠odo analizado.</li>`;
            }
            
            contenidoHTML += `
                        </ul>
                    </div>
                    
                    <div class="footer">
                        <p>SchoolNet - Gesti√≥n Ambiental | Colegio Tilata</p>
                    </div>
                </body>
                </html>
            `;
            
            const ventana = window.open('', '_blank');
            ventana.document.write(contenidoHTML);
            ventana.document.close();
            ventana.onload = function() { ventana.print(); };
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.abrirModalCAR = abrirModalCAR;
        window.abrirModalEficiencia = abrirModalEficiencia;
        window.abrirModalAlarmas = abrirModalAlarmas;
        window.abrirModalAreas = abrirModalAreas;
        window.abrirModalFuentes = abrirModalFuentes;
        window.abrirModalEjecutivo = abrirModalEjecutivo;
        window.abrirModalPoblacion = abrirModalPoblacion;
        window.abrirModalMantenimiento = abrirModalMantenimiento;
        
        window.generarReporteCAR = generarReporteCAR;
        window.generarReporteEficiencia = generarReporteEficiencia;
        window.generarReporteAlarmas = generarReporteAlarmas;
        window.generarReporteAreas = generarReporteAreas;
        window.generarReporteFuentes = generarReporteFuentes;
        window.generarReporteEjecutivo = generarReporteEjecutivo;
        window.generarReportePoblacion = generarReportePoblacion;
        window.generarReporteMantenimiento = generarReporteMantenimiento;
        
        console.log('üéâ water-reports.html cargado correctamente - 9 reportes disponibles');
    </script>
</body>
</html>
                  
                    <div class="report-title">Mantenimiento Preventivo</div>
                    <div class="report-description">
                        Recomendaciones basadas en lecturas anormales
                    </div>
                    <ul class="report-features">
                        <li>‚úì √Åreas con anomal√≠as</li>
                        <li>‚úì Historial de intervenciones</li>
                        <li>‚úì Priorizaci√≥n de acciones</li>
                    </ul>
                    <button class="btn btn-success w-100" onclick="abrirModalMantenimiento()">
                        <i class="bi bi-wrench me-2"></i>Generar
                    </button>
                </div>
            </div>
        </div>

    </div>
    
