<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecturas Diarias de Agua - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tarjeta de balance */
        .balance-card {
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .balance-card.normal {
            border-color: #28a745;
            background-color: #d4edda;
        }
        
        .balance-card.warning {
            border-color: #ffc107;
            background-color: #fff3cd;
        }
        
        .balance-card.critical {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        
        .balance-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        
        .balance-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        
        /* Input con referencia de ayer */
        .input-with-reference {
            position: relative;
        }
        
        .reference-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        /* Modo calibraci√≥n */
        .calibration-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        /* Primera captura */
        .first-capture-banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        /* Hist√≥rico */
        .history-row.normal {
            background-color: #d4edda;
        }
        
        .history-row.warning {
            background-color: #fff3cd;
        }
        
        .history-row.critical {
            background-color: #f8d7da;
        }
        
        /* Sem√°foro de estado */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-indicator.normal {
            background-color: #28a745;
        }
        
        .status-indicator.warning {
            background-color: #ffc107;
        }
        
        .status-indicator.critical {
            background-color: #dc3545;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Procesando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Gesti√≥n Ambiental</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Lecturas Diarias de Agua
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-clipboard-data me-2"></i>
                    Lecturas Diarias de Agua
                </h1>
                <p class="text-muted">
                    Registro diario de captaci√≥n, acueducto, tratamiento y PTAR
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- BANNER DE MODO CALIBRACI√ìN (se muestra din√°micamente) -->
        <div id="calibration-banner" class="calibration-banner" style="display: none;">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle-fill me-3" style="font-size: 2rem;"></i>
                <div>
                    <h5 class="mb-1">‚ö†Ô∏è Modo Calibraci√≥n Activo</h5>
                    <p class="mb-0" id="calibration-message">
                        D√≠a X de 7 - Las alarmas se activar√°n autom√°ticamente despu√©s del per√≠odo de calibraci√≥n
                    </p>
                </div>
            </div>
        </div>

        <!-- BANNER DE PRIMERA CAPTURA (se muestra din√°micamente) -->
        <div id="first-capture-banner" class="first-capture-banner" style="display: none;">
            <div class="d-flex align-items-center">
                <i class="bi bi-star-fill me-3" style="font-size: 2rem;"></i>
                <div>
                    <h5 class="mb-1">üÜï Primera Captura de Lecturas</h5>
                    <p class="mb-0">
                        Hoy registras las lecturas iniciales de los medidores. El consumo diario se calcular√° a partir de ma√±ana.
                    </p>
                </div>
            </div>
        </div>

        <!-- MENSAJE SI YA REGISTR√ì HOY -->
        <div id="already-registered" class="alert alert-info" style="display: none;">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>Ya registraste la lectura de hoy</strong>
                    <p class="mb-0 mt-2">La lectura del d√≠a <span id="today-date"></span> ya fue registrada.</p>
                </div>
                <button class="btn btn-primary" onclick="window.location.reload()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                </button>
            </div>
        </div>
        <!-- FORMULARIO DE CAPTURA -->
        <div id="form-container">
            <form id="formulario-lectura">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-check me-2"></i>
                            Lectura del D√≠a: <span id="current-date"></span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            
                            <!-- Captaci√≥n R√≠o -->
                            <div class="col-md-6">
                                <div class="input-with-reference">
                                    <label for="captacion-reading" class="form-label">
                                        <i class="bi bi-droplet-fill text-success me-1"></i>
                                        Captaci√≥n R√≠o <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" 
                                               step="0.01" 
                                               class="form-control form-control-lg" 
                                               id="captacion-reading" 
                                               required
                                               min="0">
                                        <span class="input-group-text">m¬≥</span>
                                    </div>
                                    <small class="reference-label" id="captacion-reference">
                                        <i class="bi bi-arrow-return-left me-1"></i>Ayer: -- m¬≥
                                    </small>
                                    <small class="text-success fw-bold d-block mt-1" id="captacion-daily" style="display: none !important;">
                                        Consumo hoy: -- m¬≥
                                    </small>
                                    <div class="invalid-feedback" id="captacion-error">
                                        La lectura no puede ser menor que la de ayer
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Acueducto Veredal -->
                            <div class="col-md-6">
                                <div class="input-with-reference">
                                    <label for="acueducto-reading" class="form-label">
                                        <i class="bi bi-droplet-fill text-primary me-1"></i>
                                        Acueducto Veredal <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" 
                                               step="0.01" 
                                               class="form-control form-control-lg" 
                                               id="acueducto-reading" 
                                               required
                                               min="0">
                                        <span class="input-group-text">m¬≥</span>
                                    </div>
                                    <small class="reference-label" id="acueducto-reference">
                                        <i class="bi bi-arrow-return-left me-1"></i>Ayer: -- m¬≥
                                    </small>
                                    <small class="text-success fw-bold d-block mt-1" id="acueducto-daily" style="display: none !important;">
                                        Consumo hoy: -- m¬≥
                                    </small>
                                    <div class="invalid-feedback" id="acueducto-error">
                                        La lectura no puede ser menor que la de ayer
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tratamiento -->
                            <div class="col-md-6">
                                <div class="input-with-reference">
                                    <label for="tratamiento-reading" class="form-label">
                                        <i class="bi bi-droplet-fill text-warning me-1"></i>
                                        Tratamiento <span class="text-muted">(monitoreo)</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" 
                                               step="0.01" 
                                               class="form-control form-control-lg" 
                                               id="tratamiento-reading"
                                               min="0">
                                        <span class="input-group-text">m¬≥</span>
                                    </div>
                                    <small class="reference-label" id="tratamiento-reference">
                                        <i class="bi bi-arrow-return-left me-1"></i>Ayer: -- m¬≥
                                    </small>
                                    <small class="text-success fw-bold d-block mt-1" id="tratamiento-daily" style="display: none !important;">
                                        Consumo hoy: -- m¬≥
                                    </small>
                                    <div class="invalid-feedback" id="tratamiento-error">
                                        La lectura no puede ser menor que la de ayer
                                    </div>
                                </div>
                            </div>
                            
                            <!-- PTAR -->
                            <div class="col-md-6">
                                <div class="input-with-reference">
                                    <label for="ptar-reading" class="form-label">
                                        <i class="bi bi-droplet-fill text-danger me-1"></i>
                                        PTAR (Salida) <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" 
                                               step="0.01" 
                                               class="form-control form-control-lg" 
                                               id="ptar-reading" 
                                               required
                                               min="0">
                                        <span class="input-group-text">m¬≥</span>
                                    </div>
                                    <small class="reference-label" id="ptar-reference">
                                        <i class="bi bi-arrow-return-left me-1"></i>Ayer: -- m¬≥
                                    </small>
                                    <small class="text-success fw-bold d-block mt-1" id="ptar-daily" style="display: none !important;">
                                        Consumo hoy: -- m¬≥
                                    </small>
                                    <div class="invalid-feedback" id="ptar-error">
                                        La lectura no puede ser menor que la de ayer
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notas -->
                            <div class="col-12">
                                <label for="notes" class="form-label">
                                    <i class="bi bi-sticky me-1"></i>
                                    Notas del d√≠a (opcional)
                                </label>
                                <textarea class="form-control" 
                                          id="notes" 
                                          rows="2" 
                                          placeholder="Ej: Llovi√≥ mucho, se detect√≥ fuga en tuber√≠a, etc."></textarea>
                            </div>
                            
                        </div>
                    </div>
                </div>

                <!-- TARJETA DE BALANCE (se calcula en tiempo real) -->
                <div id="balance-card" class="balance-card" style="display: none;">
                    <h5 class="mb-3">
                        <i class="bi bi-graph-up-arrow me-2"></i>
                        Balance H√≠drico Calculado
                    </h5>
                    
                    <div class="row">
                        <!-- Entrada -->
                        <div class="col-md-4">
                            <div class="balance-label">
                                <i class="bi bi-arrow-down-circle text-success me-1"></i>
                                Entrada Total
                            </div>
                            <div class="balance-value text-success" id="balance-entrada">
                                -- m¬≥
                            </div>
                            <small class="text-muted d-block" id="balance-entrada-detalle">
                                Captaci√≥n: -- m¬≥<br>
                                Acueducto: -- m¬≥
                            </small>
                        </div>
                        
                        <!-- Salida -->
                        <div class="col-md-4">
                            <div class="balance-label">
                                <i class="bi bi-arrow-up-circle text-danger me-1"></i>
                                Salida Total
                            </div>
                            <div class="balance-value text-danger" id="balance-salida">
                                -- m¬≥
                            </div>
                            <small class="text-muted d-block" id="balance-salida-detalle">
                                PTAR: -- m¬≥
                            </small>
                        </div>
                        
                        <!-- Diferencia -->
                        <div class="col-md-4">
                            <div class="balance-label">
                                <i class="bi bi-arrows-expand me-1"></i>
                                Diferencia
                            </div>
                            <div class="balance-value" id="balance-diferencia">
                                -- m¬≥
                            </div>
                            <small class="d-block" id="balance-porcentaje">
                                ---%
                            </small>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- Estado del Balance -->
                    <div class="text-center">
                        <h6 id="balance-estado-titulo">
                            <span class="status-indicator" id="balance-indicator"></span>
                            <span id="balance-estado-texto">Calculando...</span>
                        </h6>
                        <p class="mb-0" id="balance-estado-descripcion"></p>
                    </div>
                </div>

                <!-- Bot√≥n Guardar -->
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg px-5">
                        <i class="bi bi-check-circle me-2"></i>
                        Guardar Lectura Diaria
                    </button>
                </div>
            </form>
        </div>
        <!-- HIST√ìRICO DE √öLTIMOS 7 D√çAS -->
        <div class="card mt-5" id="historico-card" style="display: none;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    Hist√≥rico de los √öltimos 7 D√≠as
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th class="text-end">Entrada (m¬≥)</th>
                                <th class="text-end">Salida (m¬≥)</th>
                                <th class="text-end">Diferencia</th>
                                <th class="text-center">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="historico-body">
                            <tr>
                                <td colspan="5" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando hist√≥rico...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let lecturaAnterior = null;
        let esBaselineMode = false;
        let esModoCalibration = false;
        let diaCalibration = 0;
        let toleranciaWarning = 3;
        let toleranciaCritical = 10;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Registrar lecturas diarias de agua');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Mostrar fecha actual
                const hoy = new Date();
                document.getElementById('current-date').textContent = formatearFecha(hoy);
                document.getElementById('today-date').textContent = formatearFecha(hoy);
                
                // Cargar tolerancias desde system_config
                await cargarTolerancias();
                
                // Verificar estado del sistema
                await verificarEstadoSistema();
                
                // Configurar event listeners
                configurarEventos();
                
                // Cargar hist√≥rico
                await cargarHistorico();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR TOLERANCIAS DESDE SYSTEM_CONFIG
        // ==========================================
        async function cargarTolerancias() {
            try {
                const config = await supabaseRequest('/system_config?select=water_balance_tolerance_warning,water_balance_tolerance_critical&limit=1');
                
                if (config && config.length > 0) {
                    toleranciaWarning = config[0].water_balance_tolerance_warning || 3;
                    toleranciaCritical = config[0].water_balance_tolerance_critical || 10;
                }
                
                console.log(`‚úÖ Tolerancias cargadas: Warning=${toleranciaWarning}%, Critical=${toleranciaCritical}%`);
                
            } catch (error) {
                console.error('‚ùå Error cargando tolerancias:', error);
                // Usar valores por defecto
            }
        }
        
        // ==========================================
        // VERIFICAR ESTADO DEL SISTEMA
        // ==========================================
        async function verificarEstadoSistema() {
            try {
                // 1. Verificar si ya hay lectura de hoy
                const hoy = new Date().toISOString().split('T')[0];
                const lecturaHoy = await supabaseRequest('/env_water_readings_daily?select=reading_id&reading_date=eq.' + hoy);
                
                if (lecturaHoy && lecturaHoy.length > 0) {
                    // Ya registr√≥ hoy
                    document.getElementById('already-registered').style.display = 'block';
                    document.getElementById('form-container').style.display = 'none';
                    document.getElementById('historico-card').style.display = 'block';
                    return;
                }
                
                // 2. Verificar si existe baseline
                const baseline = await supabaseRequest('/env_water_readings_daily?select=*&is_baseline=eq.true&order=reading_date.asc&limit=1');
                
                if (!baseline || baseline.length === 0) {
                    // NO existe baseline - Es la primera vez
                    esBaselineMode = true;
                    document.getElementById('first-capture-banner').style.display = 'block';
                    console.log('üìù Modo: Primera Captura (Baseline)');
                    return;
                }
                
                // 3. Existe baseline - Obtener lectura de ayer
                const ayer = new Date();
                ayer.setDate(ayer.getDate() - 1);
                const ayerStr = ayer.toISOString().split('T')[0];
                
                const lecturaAyer = await supabaseRequest('/env_water_readings_daily?select=*&reading_date=eq.' + ayerStr + '&limit=1');
                
                if (lecturaAyer && lecturaAyer.length > 0) {
                    lecturaAnterior = lecturaAyer[0];
                    mostrarLecturasAnteriores();
                } else {
                    // No hay lectura de ayer - buscar la m√°s reciente
                    const ultimaLectura = await supabaseRequest('/env_water_readings_daily?select=*&order=reading_date.desc&limit=1');
                    if (ultimaLectura && ultimaLectura.length > 0) {
                        lecturaAnterior = ultimaLectura[0];
                        const fechaUltima = new Date(ultimaLectura[0].reading_date);
                        showMessage(`No hay lectura de ayer. Usando √∫ltima lectura disponible del ${formatearFecha(fechaUltima)}`, 'warning');
                        mostrarLecturasAnteriores();
                    }
                }
                
                // 4. Verificar modo calibraci√≥n
                const lecturasNormales = await supabaseRequest('/env_water_readings_daily?select=reading_id&is_baseline=eq.false');
                const totalLecturas = lecturasNormales ? lecturasNormales.length : 0;
                diaCalibration = totalLecturas + 1;
                
                if (diaCalibration <= 7) {
                    esModoCalibration = true;
                    const fechaActivacion = new Date();
                    fechaActivacion.setDate(fechaActivacion.getDate() + (8 - diaCalibration));
                    
                    document.getElementById('calibration-banner').style.display = 'block';
                    document.getElementById('calibration-message').innerHTML = `
                        D√≠a ${diaCalibration} de 7 - Las alarmas se activar√°n autom√°ticamente el ${formatearFecha(fechaActivacion)}
                    `;
                    console.log(`‚ö†Ô∏è Modo: Calibraci√≥n (D√≠a ${diaCalibration}/7)`);
                } else {
                    console.log('‚úÖ Modo: Normal (Alarmas activas)');
                }
                
            } catch (error) {
                console.error('‚ùå Error verificando estado del sistema:', error);
                throw error;
            }
        }
        
        // ==========================================
        // MOSTRAR LECTURAS ANTERIORES
        // ==========================================
        function mostrarLecturasAnteriores() {
            if (!lecturaAnterior) return;
            
            document.getElementById('captacion-reference').innerHTML = 
                `<i class="bi bi-arrow-return-left me-1"></i>Ayer: ${formatearNumero(lecturaAnterior.captacion_reading)} m¬≥`;
            
            document.getElementById('acueducto-reference').innerHTML = 
                `<i class="bi bi-arrow-return-left me-1"></i>Ayer: ${formatearNumero(lecturaAnterior.acueducto_reading)} m¬≥`;
            
            if (lecturaAnterior.tratamiento_reading) {
                document.getElementById('tratamiento-reference').innerHTML = 
                    `<i class="bi bi-arrow-return-left me-1"></i>Ayer: ${formatearNumero(lecturaAnterior.tratamiento_reading)} m¬≥`;
            }
            
            document.getElementById('ptar-reference').innerHTML = 
                `<i class="bi bi-arrow-return-left me-1"></i>Ayer: ${formatearNumero(lecturaAnterior.ptar_reading)} m¬≥`;
            
            console.log('‚úÖ Lecturas anteriores mostradas');
        }
        
        // ==========================================
        // CONFIGURACI√ìN DE EVENTOS
        // ==========================================
        function configurarEventos() {
            // Formulario
            document.getElementById('formulario-lectura').addEventListener('submit', manejarSubmitFormulario);
            
            // Calcular balance en tiempo real
            const inputs = ['captacion-reading', 'acueducto-reading', 'tratamiento-reading', 'ptar-reading'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                input.addEventListener('input', calcularBalanceEnTiempoReal);
                input.addEventListener('blur', validarLectura);
            });
            
            console.log('‚úÖ Event listeners configurados');
        }
      // ==========================================
        // VALIDAR LECTURA (NO PUEDE SER MENOR QUE AYER)
        // ==========================================
        function validarLectura(event) {
            if (esBaselineMode || !lecturaAnterior) return true;
            
            const inputId = event.target.id;
            const valorActual = parseFloat(event.target.value);
            
            if (!valorActual || isNaN(valorActual)) return true;
            
            let valorAnterior = 0;
            let errorElementId = '';
            
            switch (inputId) {
                case 'captacion-reading':
                    valorAnterior = lecturaAnterior.captacion_reading;
                    errorElementId = 'captacion-error';
                    break;
                case 'acueducto-reading':
                    valorAnterior = lecturaAnterior.acueducto_reading;
                    errorElementId = 'acueducto-error';
                    break;
                case 'tratamiento-reading':
                    valorAnterior = lecturaAnterior.tratamiento_reading || 0;
                    errorElementId = 'tratamiento-error';
                    break;
                case 'ptar-reading':
                    valorAnterior = lecturaAnterior.ptar_reading;
                    errorElementId = 'ptar-error';
                    break;
            }
            
            if (valorActual < valorAnterior) {
                event.target.classList.add('is-invalid');
                return false;
            } else {
                event.target.classList.remove('is-invalid');
                return true;
            }
        }
        
        // ==========================================
        // CALCULAR BALANCE EN TIEMPO REAL
        // ==========================================
        function calcularBalanceEnTiempoReal() {
            if (esBaselineMode) {
                // En modo baseline no se calcula balance
                document.getElementById('balance-card').style.display = 'none';
                return;
            }
            
            const captacionReading = parseFloat(document.getElementById('captacion-reading').value) || 0;
            const acueductoReading = parseFloat(document.getElementById('acueducto-reading').value) || 0;
            const tratamientoReading = parseFloat(document.getElementById('tratamiento-reading').value) || 0;
            const ptarReading = parseFloat(document.getElementById('ptar-reading').value) || 0;
            
            // Verificar que haya lecturas anteriores
            if (!lecturaAnterior) return;
            
            // Verificar que al menos haya algunos valores
            if (captacionReading === 0 && acueductoReading === 0 && ptarReading === 0) {
                document.getElementById('balance-card').style.display = 'none';
                return;
            }
            
            // Calcular consumos diarios
            const captacionDaily = captacionReading - (lecturaAnterior.captacion_reading || 0);
            const acueductoDaily = acueductoReading - (lecturaAnterior.acueducto_reading || 0);
            const tratamientoDaily = tratamientoReading - (lecturaAnterior.tratamiento_reading || 0);
            const ptarDaily = ptarReading - (lecturaAnterior.ptar_reading || 0);
            
            // Mostrar consumos individuales
            if (captacionReading > 0) {
                const elem = document.getElementById('captacion-daily');
                elem.textContent = `Consumo hoy: ${formatearNumero(captacionDaily)} m¬≥`;
                elem.style.display = 'block';
            }
            
            if (acueductoReading > 0) {
                const elem = document.getElementById('acueducto-daily');
                elem.textContent = `Consumo hoy: ${formatearNumero(acueductoDaily)} m¬≥`;
                elem.style.display = 'block';
            }
            
            if (tratamientoReading > 0) {
                const elem = document.getElementById('tratamiento-daily');
                elem.textContent = `Consumo hoy: ${formatearNumero(tratamientoDaily)} m¬≥`;
                elem.style.display = 'block';
            }
            
            if (ptarReading > 0) {
                const elem = document.getElementById('ptar-daily');
                elem.textContent = `Consumo hoy: ${formatearNumero(ptarDaily)} m¬≥`;
                elem.style.display = 'block';
            }
            
            // Calcular balance
            const entradaTotal = captacionDaily + acueductoDaily;
            const salidaTotal = ptarDaily;
            const diferencia = salidaTotal - entradaTotal;
            
            // Solo mostrar balance si hay datos completos
            if (entradaTotal === 0 || salidaTotal === 0) {
                document.getElementById('balance-card').style.display = 'none';
                return;
            }
            
            const porcentaje = (diferencia / entradaTotal) * 100;
            
            // Mostrar tarjeta de balance
            document.getElementById('balance-card').style.display = 'block';
            
            // Actualizar valores
            document.getElementById('balance-entrada').textContent = formatearNumero(entradaTotal) + ' m¬≥';
            document.getElementById('balance-entrada-detalle').innerHTML = `
                Captaci√≥n: ${formatearNumero(captacionDaily)} m¬≥<br>
                Acueducto: ${formatearNumero(acueductoDaily)} m¬≥
            `;
            
            document.getElementById('balance-salida').textContent = formatearNumero(salidaTotal) + ' m¬≥';
            document.getElementById('balance-salida-detalle').innerHTML = `
                PTAR: ${formatearNumero(ptarDaily)} m¬≥
            `;
            
            document.getElementById('balance-diferencia').textContent = formatearNumero(diferencia) + ' m¬≥';
            document.getElementById('balance-porcentaje').textContent = formatearNumero(porcentaje) + '%';
            
            // Determinar estado (normal, warning, critical)
            let estado = 'normal';
            let estadoTexto = 'Normal';
            let estadoDescripcion = 'El balance h√≠drico est√° dentro de los rangos esperados';
            let cardClass = 'normal';
            
            const porcentajeAbs = Math.abs(porcentaje);
            
            if (porcentajeAbs > toleranciaCritical) {
                estado = 'critical';
                estadoTexto = 'CR√çTICO';
                cardClass = 'critical';
                
                if (diferencia < 0) {
                    estadoDescripcion = `‚ö†Ô∏è La salida es ${formatearNumero(porcentajeAbs)}% MENOR que la entrada. Posible fuga o error de medici√≥n.`;
                } else {
                    estadoDescripcion = `‚ö†Ô∏è La salida es ${formatearNumero(porcentajeAbs)}% MAYOR que la entrada. Verificar medidores.`;
                }
                
                if (esModoCalibration) {
                    estadoDescripcion += `<br><small class="text-muted">Modo calibraci√≥n activo - No se generar√° alarma autom√°tica</small>`;
                }
                
            } else if (porcentajeAbs > toleranciaWarning) {
                estado = 'warning';
                estadoTexto = 'ADVERTENCIA';
                cardClass = 'warning';
                
                if (diferencia < 0) {
                    estadoDescripcion = `‚ö†Ô∏è La salida es ${formatearNumero(porcentajeAbs)}% menor que la entrada. Monitorear de cerca.`;
                } else {
                    estadoDescripcion = `‚ö†Ô∏è La salida es ${formatearNumero(porcentajeAbs)}% mayor que la entrada. Monitorear de cerca.`;
                }
            }
            
            // Actualizar UI del estado
            const balanceCard = document.getElementById('balance-card');
            balanceCard.className = 'balance-card ' + cardClass;
            
            const indicator = document.getElementById('balance-indicator');
            indicator.className = 'status-indicator ' + estado;
            
            document.getElementById('balance-estado-texto').textContent = estadoTexto;
            document.getElementById('balance-estado-descripcion').innerHTML = estadoDescripcion;
        }
        
        // ==========================================
        // MANEJAR SUBMIT DEL FORMULARIO
        // ==========================================
        async function manejarSubmitFormulario(e) {
            e.preventDefault();
            
            try {
                // Validar todas las lecturas
                let todasValidas = true;
                
                if (!esBaselineMode && lecturaAnterior) {
                    const inputs = ['captacion-reading', 'acueducto-reading', 'tratamiento-reading', 'ptar-reading'];
                    
                    for (const inputId of inputs) {
                        const input = document.getElementById(inputId);
                        const event = { target: input };
                        if (!validarLectura(event)) {
                            todasValidas = false;
                        }
                    }
                }
                
                if (!todasValidas) {
                    showMessage('Por favor corrige las lecturas inv√°lidas antes de guardar', 'danger');
                    return;
                }
                
                // Confirmar si hay diferencia extrema (>500%)
                if (!esBaselineMode && lecturaAnterior) {
                    const captacionReading = parseFloat(document.getElementById('captacion-reading').value) || 0;
                    const acueductoReading = parseFloat(document.getElementById('acueducto-reading').value) || 0;
                    const ptarReading = parseFloat(document.getElementById('ptar-reading').value) || 0;
                    
                    const captacionDaily = captacionReading - (lecturaAnterior.captacion_reading || 0);
                    const acueductoDaily = acueductoReading - (lecturaAnterior.acueducto_reading || 0);
                    const ptarDaily = ptarReading - (lecturaAnterior.ptar_reading || 0);
                    
                    const entradaTotal = captacionDaily + acueductoDaily;
                    const salidaTotal = ptarDaily;
                    const diferencia = salidaTotal - entradaTotal;
                    const porcentaje = Math.abs((diferencia / entradaTotal) * 100);
                    
                    if (porcentaje > 500) {
                        if (!confirm(`‚ö†Ô∏è ADVERTENCIA: La diferencia es extremadamente alta (${formatearNumero(porcentaje)}%).\n\n¬øEst√°s SEGURO de que los n√∫meros son correctos?`)) {
                            return;
                        }
                    }
                }
                
                mostrarLoading();
                
                await guardarLectura();
                
                showMessage('‚úÖ Lectura guardada exitosamente', 'success');
                
                // Recargar p√°gina despu√©s de 2 segundos
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error guardando lectura:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
      // ==========================================
        // GUARDAR LECTURA
        // ==========================================
        async function guardarLectura() {
            try {
                const hoy = new Date().toISOString().split('T')[0];
                
                const captacionReading = parseFloat(document.getElementById('captacion-reading').value) || 0;
                const acueductoReading = parseFloat(document.getElementById('acueducto-reading').value) || 0;
                const tratamientoReading = parseFloat(document.getElementById('tratamiento-reading').value) || null;
                const ptarReading = parseFloat(document.getElementById('ptar-reading').value) || 0;
                const notes = document.getElementById('notes').value.trim() || null;
                
                let datos = {
                    reading_date: hoy,
                    captacion_reading: captacionReading,
                    acueducto_reading: acueductoReading,
                    tratamiento_reading: tratamientoReading,
                    ptar_reading: ptarReading,
                    notes: notes
                };
                
                if (esBaselineMode) {
                    // Primera captura - guardar como baseline
                    datos.is_baseline = true;
                    datos.captacion_daily = null;
                    datos.acueducto_daily = null;
                    datos.tratamiento_daily = null;
                    datos.ptar_daily = null;
                    
                } else {
                    // Captura normal - calcular consumos
                    datos.is_baseline = false;
                    datos.captacion_daily = captacionReading - (lecturaAnterior.captacion_reading || 0);
                    datos.acueducto_daily = acueductoReading - (lecturaAnterior.acueducto_reading || 0);
                    datos.tratamiento_daily = tratamientoReading ? (tratamientoReading - (lecturaAnterior.tratamiento_reading || 0)) : null;
                    datos.ptar_daily = ptarReading - (lecturaAnterior.ptar_reading || 0);
                }
                
                // Obtener usuario actual
                const session = getStoredSession();
                if (session && session.user) {
                    datos.recorded_by = session.user.user_id;
                }
                
                // Guardar en base de datos
                const resultado = await supabaseRequest('/env_water_readings_daily', {
                    method: 'POST',
                    body: JSON.stringify(datos)
                });
                
                console.log('‚úÖ Lectura guardada en base de datos');
                
                // Si NO es baseline y NO es modo calibraci√≥n, verificar si debe generar alarma
                if (!esBaselineMode && !esModoCalibration) {
                    await verificarYGenerarAlarma(datos);
                }
                
                return resultado;
                
            } catch (error) {
                console.error('‚ùå Error guardando lectura:', error);
                throw error;
            }
        }
        
        // ==========================================
        // VERIFICAR Y GENERAR ALARMA
        // ==========================================
        async function verificarYGenerarAlarma(datos) {
            try {
                const entradaTotal = datos.captacion_daily + datos.acueducto_daily;
                const salidaTotal = datos.ptar_daily;
                const diferencia = salidaTotal - entradaTotal;
                const porcentaje = (diferencia / entradaTotal) * 100;
                const porcentajeAbs = Math.abs(porcentaje);
                
                let alertType = null;
                
                if (porcentajeAbs > toleranciaCritical) {
                    alertType = 'critical';
                } else if (porcentajeAbs > toleranciaWarning) {
                    alertType = 'warning';
                }
                
                if (alertType) {
                    console.log(`üö® Generando alarma tipo: ${alertType}`);
                    
                    // Obtener email del responsable ambiental
                    const config = await supabaseRequest('/system_config?select=environmental_responsible_email&limit=1');
                    const responsableEmail = config && config.length > 0 ? config[0].environmental_responsible_email : null;
                    
                    // Crear registro de alarma
                    const alarma = {
                        alert_date: datos.reading_date,
                        alert_type: alertType,
                        entrada_total: entradaTotal,
                        salida_total: salidaTotal,
                        diferencia: diferencia,
                        diferencia_porcentaje: porcentaje,
                        alert_status: 'pending',
                        notified_to: responsableEmail
                    };
                    
                    await supabaseRequest('/env_water_alerts', {
                        method: 'POST',
                        body: JSON.stringify(alarma)
                    });
                    
                    console.log('‚úÖ Alarma creada en base de datos');
                    
                    // Enviar notificaci√≥n por email
                    if (responsableEmail) {
                        await enviarNotificacionAlarma(responsableEmail, alarma, datos.reading_date);
                    }
                    
                    // Actualizar registro con fecha de notificaci√≥n
                    const ahora = new Date().toISOString();
                    await supabaseRequest('/env_water_alerts?alert_date=eq.' + datos.reading_date, {
                        method: 'PATCH',
                        body: JSON.stringify({ notified_at: ahora })
                    });
                }
                
            } catch (error) {
                console.error('‚ùå Error verificando/generando alarma:', error);
                // No lanzar error - la lectura ya se guard√≥ correctamente
            }
        }
        
        // ==========================================
        // ENVIAR NOTIFICACI√ìN DE ALARMA POR EMAIL
        // ==========================================
        async function enviarNotificacionAlarma(email, alarma, fecha) {
            try {
                const tipoTexto = alarma.alert_type === 'critical' ? 'CR√çTICA' : 'ADVERTENCIA';
                const colorFondo = alarma.alert_type === 'critical' ? '#f8d7da' : '#fff3cd';
                const colorBorde = alarma.alert_type === 'critical' ? '#dc3545' : '#ffc107';
                
                const subject = `üö® Alarma H√≠drica ${tipoTexto} - ${fecha}`;
                
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <div style="background-color: ${colorFondo}; border-left: 4px solid ${colorBorde}; padding: 20px; margin-bottom: 20px;">
                            <h2 style="margin-top: 0; color: #333;">üö® Alarma de Balance H√≠drico</h2>
                            <p style="font-size: 18px; margin: 0;"><strong>Tipo: ${tipoTexto}</strong></p>
                            <p style="margin: 5px 0 0 0;">Fecha: ${fecha}</p>
                        </div>
                        
                        <div style="background-color: white; padding: 20px; border: 1px solid #dee2e6; border-radius: 5px;">
                            <h3 style="color: #333; margin-top: 0;">Datos del Balance</h3>
                            
                            <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                                <tr style="background-color: #f8f9fa;">
                                    <td style="padding: 10px; border: 1px solid #dee2e6;"><strong>Entrada Total:</strong></td>
                                    <td style="padding: 10px; border: 1px solid #dee2e6;">${formatearNumero(alarma.entrada_total)} m¬≥</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #dee2e6;"><strong>Salida Total (PTAR):</strong></td>
                                    <td style="padding: 10px; border: 1px solid #dee2e6;">${formatearNumero(alarma.salida_total)} m¬≥</td>
                                </tr>
                                <tr style="background-color: ${colorFondo};">
                                    <td style="padding: 10px; border: 1px solid #dee2e6;"><strong>Diferencia:</strong></td>
                                    <td style="padding: 10px; border: 1px solid #dee2e6;"><strong>${formatearNumero(alarma.diferencia)} m¬≥ (${formatearNumero(alarma.diferencia_porcentaje)}%)</strong></td>
                                </tr>
                            </table>
                            
                            <div style="background-color: #e7f3ff; padding: 15px; border-radius: 5px; margin: 15px 0;">
                                <p style="margin: 0;"><strong>‚ö†Ô∏è Acci√≥n requerida:</strong></p>
                                <p style="margin: 5px 0 0 0;">Por favor revisa las lecturas y realiza mediciones extraordinarias de todas las √°reas si es necesario.</p>
                            </div>
                            
                            <p style="margin: 20px 0 0 0;">
                                <a href="${APP_CONFIG.baseUrl}/modules/environmental/water-alerts.html" 
                                   style="display: inline-block; background-color: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px;">
                                    Ver Alarma en el Sistema
                                </a>
                            </p>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; font-size: 12px; color: #6c757d;">
                            <p style="margin: 0;">Este es un mensaje autom√°tico del sistema SchoolNet.</p>
                            <p style="margin: 5px 0 0 0;">Colegio Tilata - Gesti√≥n Ambiental</p>
                        </div>
                    </div>
                `;
                
                await sendNotification(email, subject, htmlContent, false);
                console.log('‚úÖ Email de notificaci√≥n enviado');
                
            } catch (error) {
                console.error('‚ùå Error enviando email de notificaci√≥n:', error);
                // No lanzar error - la alarma ya se cre√≥
            }
        }
        
        // ==========================================
        // CARGAR HIST√ìRICO DE 7 D√çAS
        // ==========================================
        async function cargarHistorico() {
            try {
                const hace7Dias = new Date();
                hace7Dias.setDate(hace7Dias.getDate() - 7);
                const fecha7Dias = hace7Dias.toISOString().split('T')[0];
                
                const lecturas = await supabaseRequest('/env_water_readings_daily?select=*&reading_date=gte.' + fecha7Dias + '&is_baseline=eq.false&order=reading_date.desc');
                
                const tbody = document.getElementById('historico-body');
                
                if (!lecturas || lecturas.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-3">
                                <i class="bi bi-inbox"></i>
                                <div class="mt-2">No hay hist√≥rico disponible</div>
                            </td>
                        </tr>
                    `;
                    document.getElementById('historico-card').style.display = 'block';
                    return;
                }
                
                tbody.innerHTML = lecturas.map(lectura => {
                    const entrada = (lectura.captacion_daily || 0) + (lectura.acueducto_daily || 0);
                    const salida = lectura.ptar_daily || 0;
                    const diferencia = salida - entrada;
                    const porcentaje = entrada > 0 ? (diferencia / entrada) * 100 : 0;
                    const porcentajeAbs = Math.abs(porcentaje);
                    
                    let estado = 'normal';
                    let estadoTexto = 'üü¢ Normal';
                    let rowClass = 'history-row normal';
                    
                    if (porcentajeAbs > toleranciaCritical) {
                        estado = 'critical';
                        estadoTexto = 'üî¥ Cr√≠tico';
                        rowClass = 'history-row critical';
                    } else if (porcentajeAbs > toleranciaWarning) {
                        estado = 'warning';
                        estadoTexto = 'üü° Advertencia';
                        rowClass = 'history-row warning';
                    }
                    
                    return `
                        <tr class="${rowClass}">
                            <td>${formatearFecha(new Date(lectura.reading_date))}</td>
                            <td class="text-end">${formatearNumero(entrada)}</td>
                            <td class="text-end">${formatearNumero(salida)}</td>
                            <td class="text-end">${formatearNumero(porcentaje)}%</td>
                            <td class="text-center">${estadoTexto}</td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('historico-card').style.display = 'block';
                console.log('‚úÖ Hist√≥rico cargado');
                
            } catch (error) {
                console.error('‚ùå Error cargando hist√≥rico:', error);
            }
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function formatearFecha(fecha) {
            const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
            return fecha.toLocaleDateString('es-CO', opciones);
        }
        
        function formatearNumero(numero) {
            if (numero === null || numero === undefined || isNaN(numero)) return '--';
            return new Intl.NumberFormat('es-CO', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(numero);
        }
        
        console.log('üéâ daily-water-readings.html cargado correctamente');
    </script>
</body>
</html>
