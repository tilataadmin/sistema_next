<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.07.14.26">
    <title>Lecturas Diarias de Agua - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tarjeta de balance */
        .balance-card {
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .balance-card.normal {
            border-color: #28a745;
            background-color: #d4edda;
        }
        
        .balance-card.warning {
            border-color: #ffc107;
            background-color: #fff3cd;
        }
        
        .balance-card.critical {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        
        .balance-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        
        .balance-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        
        /* Input con referencia de ayer */
        .input-with-reference {
            position: relative;
        }
        
        .reference-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        /* Modo calibraci√≥n */
        .calibration-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        /* Primera captura */
        .first-capture-banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        /* Hist√≥rico */
        .history-row.normal {
            background-color: #d4edda;
        }
        
        .history-row.warning {
            background-color: #fff3cd;
        }
        
        .history-row.critical {
            background-color: #f8d7da;
        }
        
        /* Sem√°foro de estado */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-indicator.normal {
            background-color: #28a745;
        }
        
        .status-indicator.warning {
            background-color: #ffc107;
        }
        
        .status-indicator.critical {
            background-color: #dc3545;
        }
        
        /* Medidores din√°micos */
        .meter-group {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .meter-group-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #dee2e6;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Procesando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Gesti√≥n Ambiental</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Lecturas Diarias de Agua
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-clipboard-data me-2"></i>
                    Lecturas Diarias de Agua
                </h1>
                <p class="text-muted">
                    Registro diario de medidores activos con frecuencia diaria
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- BANNER DE MODO CALIBRACI√ìN -->
        <div id="calibration-banner" class="calibration-banner" style="display: none;">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle-fill me-3" style="font-size: 2rem;"></i>
                <div>
                    <h5 class="mb-1">‚ö†Ô∏è Modo Calibraci√≥n Activo</h5>
                    <p class="mb-0" id="calibration-message">
                        D√≠a X de 7 - Las alarmas se activar√°n autom√°ticamente despu√©s del per√≠odo de calibraci√≥n
                    </p>
                </div>
            </div>
        </div>

        <!-- BANNER DE PRIMERA CAPTURA -->
        <div id="first-capture-banner" class="first-capture-banner" style="display: none;">
            <div class="d-flex align-items-center">
                <i class="bi bi-star-fill me-3" style="font-size: 2rem;"></i>
                <div>
                    <h5 class="mb-1">üÜï Primera Captura de Lecturas</h5>
                    <p class="mb-0">
                        Hoy registras las lecturas iniciales de los medidores. El consumo diario se calcular√° a partir de ma√±ana.
                    </p>
                </div>
            </div>
        </div>

        <!-- MENSAJE SI YA REGISTR√ì HOY -->
        <div id="already-registered" class="alert alert-info" style="display: none;">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>Ya registraste la lectura de hoy</strong>
                    <p class="mb-0 mt-2">La lectura del d√≠a <span id="today-date"></span> ya fue registrada.</p>
                </div>
                <div>
                    <button class="btn btn-warning me-2" onclick="irAEditar()">
                        <i class="bi bi-pencil me-1"></i>Editar Lecturas Hist√≥ricas
                    </button>
                    <button class="btn btn-primary" onclick="window.location.reload()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                </div>
            </div>
        </div>

        <!-- FORMULARIO DE CAPTURA -->
        <div id="form-container">
            <form id="formulario-lectura">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-check me-2"></i>
                            Lectura del D√≠a: <span id="current-date"></span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="meters-container">
                            <!-- Los medidores se cargar√°n din√°micamente aqu√≠ -->
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando medidores...</span>
                                </div>
                                <div class="mt-2">Cargando medidores activos...</div>
                            </div>
                        </div>
                        
                        <!-- Notas -->
                        <div class="col-12 mt-4">
                            <label for="notes" class="form-label">
                                <i class="bi bi-sticky me-1"></i>
                                Notas del d√≠a (opcional)
                            </label>
                            <textarea class="form-control" 
                                      id="notes" 
                                      rows="2" 
                                      placeholder="Ej: Llovi√≥ mucho, se detect√≥ fuga en tuber√≠a, etc."></textarea>
                        </div>
                    </div>
                </div>

                <!-- TARJETA DE BALANCE -->
                <div id="balance-card" class="balance-card" style="display: none;">
                    <h5 class="mb-3">
                        <i class="bi bi-graph-up-arrow me-2"></i>
                        Balance H√≠drico Calculado
                    </h5>
                    
                    <div class="row">
                        <!-- Entrada -->
                        <div class="col-md-4">
                            <div class="balance-label">
                                <i class="bi bi-arrow-down-circle text-success me-1"></i>
                                Entrada Total
                            </div>
                            <div class="balance-value text-success" id="balance-entrada">
                                -- m¬≥
                            </div>
                            <small class="text-muted d-block" id="balance-entrada-detalle">
                                --
                            </small>
                        </div>
                        
                        <!-- Salida -->
                        <div class="col-md-4">
                            <div class="balance-label">
                                <i class="bi bi-arrow-up-circle text-danger me-1"></i>
                                Salida Total
                            </div>
                            <div class="balance-value text-danger" id="balance-salida">
                                -- m¬≥
                            </div>
                            <small class="text-muted d-block" id="balance-salida-detalle">
                                PTAR: -- m¬≥
                            </small>
                        </div>
                        
                        <!-- Diferencia -->
                        <div class="col-md-4">
                            <div class="balance-label">
                                <i class="bi bi-arrows-expand me-1"></i>
                                Diferencia
                            </div>
                            <div class="balance-value" id="balance-diferencia">
                                -- m¬≥
                            </div>
                            <small class="d-block" id="balance-porcentaje">
                                ---%
                            </small>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- Estado del Balance -->
                    <div class="text-center">
                        <h6 id="balance-estado-titulo">
                            <span class="status-indicator" id="balance-indicator"></span>
                            <span id="balance-estado-texto">Calculando...</span>
                        </h6>
                        <p class="mb-0" id="balance-estado-descripcion"></p>
                    </div>
                </div>

                <!-- Bot√≥n Guardar -->
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg px-5">
                        <i class="bi bi-check-circle me-2"></i>
                        Guardar Lectura Diaria
                    </button>
                </div>
            </form>
        </div>

        <!-- HIST√ìRICO DE √öLTIMOS 7 D√çAS -->
        <div class="card mt-5" id="historico-card" style="display: none;">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    Hist√≥rico de los √öltimos 7 D√≠as
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th class="text-end">Entrada (m¬≥)</th>
                                <th class="text-end">Salida (m¬≥)</th>
                                <th class="text-end">Diferencia</th>
                                <th class="text-center">Estado</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="historico-body">
                            <tr>
                                <td colspan="6" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando hist√≥rico...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let medidoresActivos = [];
        let lecturaAnterior = null;
        let esBaselineMode = false;
        let esModoCalibration = false;
        let diaCalibration = 0;
        let toleranciaWarning = 3;
        let toleranciaCritical = 10;
        
        // Mapeo de tipos de medidores
        const METER_TYPES = {
            'fuente_captacion': {
                label: 'Captaci√≥n R√≠o',
                icon: 'droplet-fill',
                color: 'success',
                includeInBalance: false
            },
            'fuente_acueducto': {
                label: 'Acueducto Veredal',
                icon: 'droplet-fill',
                color: 'primary',
                includeInBalance: true,
                balanceType: 'entrada'
            },
            'proceso_tratamiento': {
                label: 'Tratamiento',
                icon: 'droplet-fill',
                color: 'warning',
                includeInBalance: true,
                balanceType: 'entrada'
            },
            'salida_ptar': {
                label: 'PTAR (Salida)',
                icon: 'droplet-fill',
                color: 'danger',
                includeInBalance: true,
                balanceType: 'salida'
            }
        };
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Registrar lecturas diarias de agua');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Mostrar fecha actual
                const hoy = new Date();
                document.getElementById('current-date').textContent = formatearFecha(hoy);
                document.getElementById('today-date').textContent = formatearFecha(hoy);
                
                // Cargar tolerancias desde system_config
                await cargarTolerancias();
                
                // Cargar medidores activos diarios
                await cargarMedidores();
                
                // Verificar estado del sistema
                await verificarEstadoSistema();
                
                // Cargar hist√≥rico
                await cargarHistorico();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR TOLERANCIAS
        // ==========================================
        async function cargarTolerancias() {
            try {
                const config = await supabaseRequest('/system_config?select=water_balance_tolerance_warning,water_balance_tolerance_critical&limit=1');
                
                if (config && config.length > 0) {
                    toleranciaWarning = config[0].water_balance_tolerance_warning || 3;
                    toleranciaCritical = config[0].water_balance_tolerance_critical || 10;
                }
                
                console.log(`‚úÖ Tolerancias: Warning=${toleranciaWarning}%, Critical=${toleranciaCritical}%`);
                
            } catch (error) {
                console.error('‚ùå Error cargando tolerancias:', error);
            }
        }
        
        // ==========================================
        // CARGAR MEDIDORES ACTIVOS DIARIOS
        // ==========================================
        async function cargarMedidores() {
            try {
                console.log('üì° Cargando medidores activos con frecuencia diaria...');
                
                const datos = await supabaseRequest('/env_water_meters?select=*&is_active=eq.true&measurement_frequency=eq.daily&order=meter_type.asc,meter_name.asc');
                
                if (!datos || datos.length === 0) {
                    document.getElementById('meters-container').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>No hay medidores activos configurados</strong>
                            <p class="mb-0 mt-2">Por favor, configure al menos un medidor activo con frecuencia diaria en la opci√≥n "Gestionar Medidores".</p>
                        </div>
                    `;
                    return;
                }
                
                medidoresActivos = datos;
                renderizarFormularioMedidores();
                
                console.log(`‚úÖ ${medidoresActivos.length} medidores activos cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando medidores:', error);
                throw error;
            }
        }
        
        // ==========================================
        // RENDERIZAR FORMULARIO DE MEDIDORES
        // ==========================================
        function renderizarFormularioMedidores() {
            const container = document.getElementById('meters-container');
            
            // Agrupar por tipo
            const grupos = {};
            medidoresActivos.forEach(medidor => {
                if (!grupos[medidor.meter_type]) {
                    grupos[medidor.meter_type] = [];
                }
                grupos[medidor.meter_type].push(medidor);
            });
            
            let html = '<div class="row g-4">';
            
            // Orden de tipos
            const ordenTipos = ['fuente_captacion', 'fuente_acueducto', 'proceso_tratamiento', 'salida_ptar'];
            
            ordenTipos.forEach(tipo => {
                if (grupos[tipo]) {
                    const tipoInfo = METER_TYPES[tipo];
                    
                    html += `
                        <div class="col-12">
                            <div class="meter-group">
                                <div class="meter-group-title">
                                    <i class="bi bi-${tipoInfo.icon} text-${tipoInfo.color} me-2"></i>
                                    ${tipoInfo.label}
                                </div>
                                <div class="row g-3">
                    `;
                    
                    grupos[tipo].forEach(medidor => {
                        const inputId = `meter-${medidor.meter_id}`;
                        const refId = `ref-${medidor.meter_id}`;
                        const dailyId = `daily-${medidor.meter_id}`;
                        const errorId = `error-${medidor.meter_id}`;
                        
                        html += `
                            <div class="col-md-6">
                                <div class="input-with-reference">
                                    <label for="${inputId}" class="form-label">
                                        ${escapeHtml(medidor.meter_name)} 
                                        ${medidor.meter_type !== 'proceso_tratamiento' ? '<span class="text-danger">*</span>' : '<span class="text-muted">(opcional)</span>'}
                                    </label>
                                    <div class="input-group">
                                        <input type="number" 
                                               step="0.01" 
                                               class="form-control form-control-lg meter-input" 
                                               id="${inputId}" 
                                               data-meter-id="${medidor.meter_id}"
                                               data-meter-type="${medidor.meter_type}"
                                               ${medidor.meter_type !== 'proceso_tratamiento' ? 'required' : ''}
                                               min="0">
                                        <span class="input-group-text">m¬≥</span>
                                    </div>
                                    <small class="reference-label" id="${refId}">
                                        <i class="bi bi-arrow-return-left me-1"></i>Ayer: -- m¬≥
                                    </small>
                                    <small class="text-success fw-bold d-block mt-1" id="${dailyId}" style="display: none !important;">
                                        Consumo hoy: -- m¬≥
                                    </small>
                                    <div class="invalid-feedback" id="${errorId}">
                                        La lectura no puede ser menor que la de ayer
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            
            container.innerHTML = html;
            
            // Configurar event listeners
            document.querySelectorAll('.meter-input').forEach(input => {
                input.addEventListener('input', calcularBalanceEnTiempoReal);
                input.addEventListener('blur', validarLectura);
            });
            
            // Configurar formulario
            document.getElementById('formulario-lectura').addEventListener('submit', manejarSubmitFormulario);
        }
        
        // ==========================================
        // VERIFICAR ESTADO DEL SISTEMA
        // ==========================================
        async function verificarEstadoSistema() {
            try {
                // 1. Verificar si ya hay lectura de hoy
                const hoy = new Date().toISOString().split('T')[0];
                const lecturaHoy = await supabaseRequest('/env_water_readings_daily?select=reading_id&reading_date=eq.' + hoy);
                
                if (lecturaHoy && lecturaHoy.length > 0) {
                    document.getElementById('already-registered').style.display = 'block';
                    document.getElementById('form-container').style.display = 'none';
                    document.getElementById('historico-card').style.display = 'block';
                    return;
                }
                
                // 2. Verificar baseline
                const baseline = await supabaseRequest('/env_water_readings_daily?select=*&is_baseline=eq.true&order=reading_date.asc&limit=1');
                
                if (!baseline || baseline.length === 0) {
                    esBaselineMode = true;
                    document.getElementById('first-capture-banner').style.display = 'block';
                    console.log('üìù Modo: Primera Captura (Baseline)');
                    return;
                }
                
                // 3. Obtener lectura anterior
                const ayer = new Date();
                ayer.setDate(ayer.getDate() - 1);
                const ayerStr = ayer.toISOString().split('T')[0];
                
                const lecturaAyer = await supabaseRequest('/env_water_readings_daily?select=*&reading_date=eq.' + ayerStr + '&limit=1');
                
                if (lecturaAyer && lecturaAyer.length > 0) {
                    lecturaAnterior = lecturaAyer[0];
                    mostrarLecturasAnteriores();
                } else {
                    const ultimaLectura = await supabaseRequest('/env_water_readings_daily?select=*&order=reading_date.desc&limit=1');
                    if (ultimaLectura && ultimaLectura.length > 0) {
                        lecturaAnterior = ultimaLectura[0];
                        const fechaUltima = new Date(ultimaLectura[0].reading_date);
                        showMessage(`No hay lectura de ayer. Usando √∫ltima lectura del ${formatearFecha(fechaUltima)}`, 'warning');
                        mostrarLecturasAnteriores();
                    }
                }
                
                // 4. Verificar modo calibraci√≥n
                const lecturasNormales = await supabaseRequest('/env_water_readings_daily?select=reading_id&is_baseline=eq.false');
                const totalLecturas = lecturasNormales ? lecturasNormales.length : 0;
                diaCalibration = totalLecturas + 1;
                
                if (diaCalibration <= 7) {
                    esModoCalibration = true;
                    const fechaActivacion = new Date();
                    fechaActivacion.setDate(fechaActivacion.getDate() + (8 - diaCalibration));
                    
                    document.getElementById('calibration-banner').style.display = 'block';
                    document.getElementById('calibration-message').innerHTML = `
                        D√≠a ${diaCalibration} de 7 - Las alarmas se activar√°n el ${formatearFecha(fechaActivacion)}
                    `;
                    console.log(`‚ö†Ô∏è Modo: Calibraci√≥n (D√≠a ${diaCalibration}/7)`);
                }
                
            } catch (error) {
                console.error('‚ùå Error verificando estado:', error);
                throw error;
            }
        }
        
        // ==========================================
        // MOSTRAR LECTURAS ANTERIORES
        // ==========================================
        function mostrarLecturasAnteriores() {
            if (!lecturaAnterior || !lecturaAnterior.meter_readings) return;
            
            const readings = lecturaAnterior.meter_readings;
            
            medidoresActivos.forEach(medidor => {
                const reading = readings[medidor.meter_id];
                if (reading) {
                    const refElement = document.getElementById(`ref-${medidor.meter_id}`);
                    if (refElement) {
                        refElement.innerHTML = `<i class="bi bi-arrow-return-left me-1"></i>Ayer: ${formatearNumero(reading)} m¬≥`;
                    }
                }
            });
            
            console.log('‚úÖ Lecturas anteriores mostradas');
        }
        
        // ==========================================
        // VALIDAR LECTURA
        // ==========================================
        function validarLectura(event) {
            if (esBaselineMode || !lecturaAnterior) return true;
            
            const input = event.target;
            const meterId = input.dataset.meterId;
            const valorActual = parseFloat(input.value);
            
            if (!valorActual || isNaN(valorActual)) return true;
            
            const readings = lecturaAnterior.meter_readings || {};
            const valorAnterior = readings[meterId] || 0;
            
            if (valorActual < valorAnterior) {
                input.classList.add('is-invalid');
                return false;
            } else {
                input.classList.remove('is-invalid');
                return true;
            }
        }
        
        // ==========================================
        // CALCULAR BALANCE EN TIEMPO REAL
        // ==========================================
        function calcularBalanceEnTiempoReal() {
            if (esBaselineMode) {
                document.getElementById('balance-card').style.display = 'none';
                return;
            }
            
            if (!lecturaAnterior || !lecturaAnterior.meter_readings) return;
            
            const readings = lecturaAnterior.meter_readings;
            
            let entradaTotal = 0;
            let salidaTotal = 0;
            let entradaDetalle = [];
            let hayDatos = false;
            
            medidoresActivos.forEach(medidor => {
                const input = document.getElementById(`meter-${medidor.meter_id}`);
                if (!input) return;
                
                const valorActual = parseFloat(input.value) || 0;
                if (valorActual === 0) return;
                
                const valorAnterior = readings[medidor.meter_id] || 0;
                const consumoDiario = valorActual - valorAnterior;
                
                // Mostrar consumo individual
                const dailyElement = document.getElementById(`daily-${medidor.meter_id}`);
                if (dailyElement && consumoDiario > 0) {
                    dailyElement.textContent = `Consumo hoy: ${formatearNumero(consumoDiario)} m¬≥`;
                    dailyElement.style.display = 'block';
                }
                
                // Calcular balance seg√∫n tipo
                const tipoInfo = METER_TYPES[medidor.meter_type];
                if (tipoInfo && tipoInfo.includeInBalance) {
                    hayDatos = true;
                    
                    if (tipoInfo.balanceType === 'entrada') {
                        entradaTotal += consumoDiario;
                        entradaDetalle.push(`${medidor.meter_name}: ${formatearNumero(consumoDiario)} m¬≥`);
                    } else if (tipoInfo.balanceType === 'salida') {
                        salidaTotal += consumoDiario;
                    }
                }
            });
            
            if (!hayDatos || entradaTotal === 0 || salidaTotal === 0) {
                document.getElementById('balance-card').style.display = 'none';
                return;
            }
            
            // Calcular diferencia y porcentaje
            const diferencia = salidaTotal - entradaTotal;
            const porcentaje = (diferencia / entradaTotal) * 100;
            const porcentajeAbs = Math.abs(porcentaje);
            
            // Mostrar balance
            document.getElementById('balance-card').style.display = 'block';
            document.getElementById('balance-entrada').textContent = formatearNumero(entradaTotal) + ' m¬≥';
            document.getElementById('balance-entrada-detalle').innerHTML = entradaDetalle.join('<br>');
            document.getElementById('balance-salida').textContent = formatearNumero(salidaTotal) + ' m¬≥';
            document.getElementById('balance-diferencia').textContent = formatearNumero(diferencia) + ' m¬≥';
            document.getElementById('balance-porcentaje').textContent = formatearNumero(porcentaje) + '%';
            
            // Determinar estado
            let estado = 'normal';
            let estadoTexto = 'Normal';
            let estadoDescripcion = 'El balance h√≠drico est√° dentro de los rangos esperados';
            let cardClass = 'normal';
            
            if (porcentajeAbs > toleranciaCritical) {
                estado = 'critical';
                estadoTexto = 'CR√çTICO';
                cardClass = 'critical';
                estadoDescripcion = diferencia < 0 
                    ? `‚ö†Ô∏è La salida es ${formatearNumero(porcentajeAbs)}% MENOR que la entrada.`
                    : `‚ö†Ô∏è La salida es ${formatearNumero(porcentajeAbs)}% MAYOR que la entrada.`;
                
                if (esModoCalibration) {
                    estadoDescripcion += `<br><small class="text-muted">Modo calibraci√≥n - Sin alarma autom√°tica</small>`;
                }
            } else if (porcentajeAbs > toleranciaWarning) {
                estado = 'warning';
                estadoTexto = 'ADVERTENCIA';
                cardClass = 'warning';
                estadoDescripcion = diferencia < 0
                    ? `‚ö†Ô∏è La salida es ${formatearNumero(porcentajeAbs)}% menor que la entrada.`
                    : `‚ö†Ô∏è La salida es ${formatearNumero(porcentajeAbs)}% mayor que la entrada.`;
            }
            
            // Actualizar UI
            const balanceCard = document.getElementById('balance-card');
            balanceCard.className = 'balance-card ' + cardClass;
            
            const indicator = document.getElementById('balance-indicator');
            indicator.className = 'status-indicator ' + estado;
            
            document.getElementById('balance-estado-texto').textContent = estadoTexto;
            document.getElementById('balance-estado-descripcion').innerHTML = estadoDescripcion;
        }
        
        // ==========================================
        // MANEJAR SUBMIT
        // ==========================================
        async function manejarSubmitFormulario(e) {
            e.preventDefault();
            
            try {
                // Validar todas las lecturas
                let todasValidas = true;
                
                if (!esBaselineMode && lecturaAnterior) {
                    document.querySelectorAll('.meter-input').forEach(input => {
                        const event = { target: input };
                        if (!validarLectura(event)) {
                            todasValidas = false;
                        }
                    });
                }
                
                if (!todasValidas) {
                    showMessage('Corrige las lecturas inv√°lidas antes de guardar', 'danger');
                    return;
                }
                
                mostrarLoading();
                await guardarLectura();
                showMessage('‚úÖ Lectura guardada exitosamente', 'success');
                
                setTimeout(() => window.location.reload(), 2000);
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // GUARDAR LECTURA
        // ==========================================
        async function guardarLectura() {
            try {
                const hoy = new Date().toISOString().split('T')[0];
                const notes = document.getElementById('notes').value.trim() || null;
                
                // Construir objeto de lecturas
                const meterReadings = {};
                const dailyConsumption = {};
                
                let entradaTotal = 0;
                let salidaTotal = 0;
                
                medidoresActivos.forEach(medidor => {
                    const input = document.getElementById(`meter-${medidor.meter_id}`);
                    if (!input) return;
                    
                    const valor = parseFloat(input.value) || null;
                    if (valor !== null) {
                        meterReadings[medidor.meter_id] = valor;
                        
                        if (!esBaselineMode && lecturaAnterior && lecturaAnterior.meter_readings) {
                            const valorAnterior = lecturaAnterior.meter_readings[medidor.meter_id] || 0;
                            const consumo = valor - valorAnterior;
                            dailyConsumption[medidor.meter_id] = consumo;
                            
                            const tipoInfo = METER_TYPES[medidor.meter_type];
                            if (tipoInfo && tipoInfo.includeInBalance) {
                                if (tipoInfo.balanceType === 'entrada') {
                                    entradaTotal += consumo;
                                } else if (tipoInfo.balanceType === 'salida') {
                                    salidaTotal += consumo;
                                }
                            }
                        }
                    }
                });
                
                let datos = {
                    reading_date: hoy,
                    meter_readings: meterReadings,
                    notes: notes
                };
                
                if (esBaselineMode) {
                    datos.is_baseline = true;
                    datos.daily_consumption = null;
                } else {
                    datos.is_baseline = false;
                    datos.daily_consumption = dailyConsumption;
                    datos.total_entrada = entradaTotal;
                    datos.total_salida = salidaTotal;
                }
                
                const session = getStoredSession();
                if (session && session.user) {
                    datos.recorded_by = session.user.user_id;
                }
                
                const resultado = await supabaseRequest('/env_water_readings_daily', {
                    method: 'POST',
                    body: JSON.stringify(datos)
                });
                
                console.log('‚úÖ Lectura guardada');
                
                // Verificar alarmas
                if (!esBaselineMode && !esModoCalibration && entradaTotal > 0) {
                    await verificarYGenerarAlarma(hoy, entradaTotal, salidaTotal);
                }
                
                return resultado;
                
            } catch (error) {
                console.error('‚ùå Error guardando:', error);
                throw error;
            }
        }
        
        // ==========================================
        // VERIFICAR Y GENERAR ALARMA
        // ==========================================
        async function verificarYGenerarAlarma(fecha, entrada, salida) {
            try {
                const diferencia = salida - entrada;
                const porcentaje = (diferencia / entrada) * 100;
                const porcentajeAbs = Math.abs(porcentaje);
                
                let alertType = null;
                
                if (porcentajeAbs > toleranciaCritical) {
                    alertType = 'critical';
                } else if (porcentajeAbs > toleranciaWarning) {
                    alertType = 'warning';
                }
                
                if (alertType) {
                    const config = await supabaseRequest('/system_config?select=environmental_responsible_email&limit=1');
                    const responsableEmail = config && config.length > 0 ? config[0].environmental_responsible_email : null;
                    
                    const alarma = {
                        alert_date: fecha,
                        alert_type: alertType,
                        entrada_total: entrada,
                        salida_total: salida,
                        diferencia: diferencia,
                        diferencia_porcentaje: porcentaje,
                        alert_status: 'pending',
                        notified_to: responsableEmail
                    };
                    
                    await supabaseRequest('/env_water_alerts', {
                        method: 'POST',
                        body: JSON.stringify(alarma)
                    });
                    
                    console.log('‚úÖ Alarma creada');
                    
                    if (responsableEmail) {
                        await enviarNotificacionAlarma(responsableEmail, alarma, fecha);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error con alarma:', error);
            }
        }
        
        // ==========================================
        // ENVIAR NOTIFICACI√ìN
        // ==========================================
        async function enviarNotificacionAlarma(email, alarma, fecha) {
            try {
                const tipoTexto = alarma.alert_type === 'critical' ? 'CR√çTICA' : 'ADVERTENCIA';
                const subject = `üö® Alarma H√≠drica ${tipoTexto} - ${fecha}`;
                
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <h2>üö® Alarma de Balance H√≠drico</h2>
                        <p><strong>Tipo:</strong> ${tipoTexto}</p>
                        <p><strong>Fecha:</strong> ${fecha}</p>
                        <hr>
                        <p><strong>Entrada:</strong> ${formatearNumero(alarma.entrada_total)} m¬≥</p>
                        <p><strong>Salida:</strong> ${formatearNumero(alarma.salida_total)} m¬≥</p>
                        <p><strong>Diferencia:</strong> ${formatearNumero(alarma.diferencia)} m¬≥ (${formatearNumero(alarma.diferencia_porcentaje)}%)</p>
                    </div>
                `;
                
                await sendNotification(email, subject, htmlContent, false);
                console.log('‚úÖ Email enviado');
                
            } catch (error) {
                console.error('‚ùå Error enviando email:', error);
            }
        }
        
        // ==========================================
        // CARGAR HIST√ìRICO
        // ==========================================
        async function cargarHistorico() {
            try {
                const hace7Dias = new Date();
                hace7Dias.setDate(hace7Dias.getDate() - 7);
                const fecha7Dias = hace7Dias.toISOString().split('T')[0];
                
                const lecturas = await supabaseRequest('/env_water_readings_daily?select=*&reading_date=gte.' + fecha7Dias + '&is_baseline=eq.false&order=reading_date.desc');
                
                const tbody = document.getElementById('historico-body');
                
                if (!lecturas || lecturas.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-3">
                                <i class="bi bi-inbox"></i>
                                <div class="mt-2">No hay hist√≥rico disponible</div>
                            </td>
                        </tr>
                    `;
                    document.getElementById('historico-card').style.display = 'block';
                    return;
                }
                
                tbody.innerHTML = lecturas.map(lectura => {
                    const entrada = lectura.total_entrada || 0;
                    const salida = lectura.total_salida || 0;
                    const diferencia = salida - entrada;
                    const porcentaje = entrada > 0 ? (diferencia / entrada) * 100 : 0;
                    const porcentajeAbs = Math.abs(porcentaje);
                    
                    let estado = 'normal';
                    let estadoTexto = 'üü¢ Normal';
                    let rowClass = 'history-row normal';
                    
                    if (porcentajeAbs > toleranciaCritical) {
                        estado = 'critical';
                        estadoTexto = 'üî¥ Cr√≠tico';
                        rowClass = 'history-row critical';
                    } else if (porcentajeAbs > toleranciaWarning) {
                        estado = 'warning';
                        estadoTexto = 'üü° Advertencia';
                        rowClass = 'history-row warning';
                    }
                    
                    // Verificar si es editable (√∫ltimos 7 d√≠as)
                    const fechaLectura = new Date(lectura.reading_date);
                    const ahora = new Date();
                    const diferenciaDias = Math.floor((ahora - fechaLectura) / (1000 * 60 * 60 * 24));
                    const esEditable = diferenciaDias <= 7;
                    
                    return `
                        <tr class="${rowClass}">
                            <td>${formatearFecha(fechaLectura)}</td>
                            <td class="text-end">${formatearNumero(entrada)}</td>
                            <td class="text-end">${formatearNumero(salida)}</td>
                            <td class="text-end">${formatearNumero(porcentaje)}%</td>
                            <td class="text-center">${estadoTexto}</td>
                            <td class="text-center">
                                ${esEditable ? `
                                    <button class="btn btn-sm btn-outline-primary" onclick="editarLectura('${lectura.reading_date}')" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                ` : '<span class="text-muted">-</span>'}
                            </td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('historico-card').style.display = 'block';
                
            } catch (error) {
                console.error('‚ùå Error cargando hist√≥rico:', error);
            }
        }
        
        // ==========================================
        // IR A EDITAR
        // ==========================================
        function irAEditar() {
            window.location.href = 'edit-daily-readings.html';
        }
        
        function editarLectura(fecha) {
            window.location.href = `edit-daily-readings.html?date=${fecha}`;
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function formatearFecha(fecha) {
            const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
            return fecha.toLocaleDateString('es-CO', opciones);
        }
        
        function formatearNumero(numero) {
            if (numero === null || numero === undefined || isNaN(numero)) return '--';
            return new Intl.NumberFormat('es-CO', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(numero);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Hacer funciones globales
        window.irAEditar = irAEditar;
        window.editarLectura = editarLectura;
        
        console.log('üéâ daily-water-readings.html cargado correctamente');
    </script>
</body>
</html>
