<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Control - Gesti√≥n de Estudiantes Nuevos - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #0d6efd;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #0d6efd, #198754, #ffc107);
        }
        
        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #0d6efd;
        }
        
        .metric-value {
            font-size: 2.8rem;
            font-weight: 700;
            color: #212529;
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .metric-label {
            color: #6c757d;
            font-weight: 600;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filters-section {
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            align-items: end;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .activities-panel, .students-panel {
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }
        
        .activities-panel {
            max-height: 700px;
            overflow-y: auto;
        }
        
        .students-panel {
            max-height: 700px;
            overflow-y: auto;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #212529;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .activity-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-name {
            font-weight: 600;
            color: #212529;
            flex: 1;
            font-size: 0.95rem;
        }
        
        .activity-stats {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .activity-count {
            color: #6c757d;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .activity-percentage {
            background: linear-gradient(135deg, #0d6efd, #0b5ed7);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 50px;
            text-align: center;
        }
        
        .student-card {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #fff;
        }
        
        .student-card:hover {
            border-color: #0d6efd;
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
            transform: translateY(-2px);
        }
        
        .student-photo {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 3px solid #e9ecef;
            transition: border-color 0.3s ease;
        }
        
        .student-card:hover .student-photo {
            border-color: #0d6efd;
        }
        
        .student-info {
            flex: 1;
        }
        
        .student-name {
            font-weight: 600;
            color: #212529;
            margin-bottom: 4px;
            font-size: 1rem;
        }
        
        .student-details {
            color: #6c757d;
            font-size: 0.875rem;
            line-height: 1.4;
        }
        
        .student-progress {
            text-align: center;
            min-width: 80px;
        }
        
        .progress-circle {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
            margin: 0 auto 8px;
            border: 3px solid;
        }
        
        .progress-complete { 
            background: #d1e7dd; 
            color: #0a3622; 
            border-color: #198754;
        }
        
        .progress-partial { 
            background: #fff3cd; 
            color: #664d03; 
            border-color: #ffc107;
        }
        
        .progress-none { 
            background: #f8d7da; 
            color: #58151c; 
            border-color: #dc3545;
        }
        
        .progress-status {
            font-size: 0.75rem;
            font-weight: 500;
            color: #6c757d;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box .form-control {
            padding-left: 45px;
        }
        
        .search-box .search-icon {
            position: absolute;
            left: 15px;
            top: 38px;
            color: #6c757d;
            pointer-events: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.6;
        }
        
        .empty-state h4 {
            margin-bottom: 10px;
            color: #495057;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            backdrop-filter: blur(2px);
        }
        
        .modal-content-custom {
            background: white;
            border-radius: 12px;
            max-width: 900px;
            max-height: 80vh;
            width: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header-custom {
            padding: 20px 25px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-body-custom {
            padding: 25px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-footer-custom {
            padding: 15px 25px;
            border-top: 1px solid #dee2e6;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }
        
        .student-detail-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #0d6efd;
        }
        
        .student-detail-photo {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #0d6efd;
        }
        
        .activities-status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        .status-section h5 {
            color: #495057;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .activity-status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .status-realizada {
            background: #d1e7dd;
            color: #0a3622;
            border-left: 4px solid #198754;
        }
        
        .status-pendiente {
            background: #f8d7da;
            color: #58151c;
            border-left: 4px solid #dc3545;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .activities-panel {
                max-height: 500px;
            }
        }
        
        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .student-card {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .student-photo {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .modal-content-custom {
                width: 95%;
                max-height: 90vh;
            }
            
            .student-detail-header {
                flex-direction: column;
                text-align: center;
            }
            
            .activities-status-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 576px) {
            .dashboard-container {
                padding: 0 15px;
            }
            
            .metric-card {
                padding: 20px 15px;
            }
            
            .metric-value {
                font-size: 2.2rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <h5>Cargando tablero de control...</h5>
            <p class="text-muted">Obteniendo m√©tricas y estad√≠sticas</p>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Gesti√≥n de Estudiantes Nuevos</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Tablero de Control
                </li>
            </ol>
        </nav>

        <!-- Encabezado de p√°gina -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Tablero de Control
                </h1>
                <p class="text-muted">
                    Monitoreo integral del proceso de inculturaci√≥n de estudiantes nuevos con m√©tricas en tiempo real
                </p>
            </div>
        </div>

        <!-- Mensajes -->
        <div id="alert-container"></div>

        <div class="dashboard-container">
            <!-- M√©tricas Principales -->
            <div id="metrics-section" class="metrics-grid">
                <!-- Se llenan din√°micamente -->
            </div>

            <!-- Secci√≥n de Filtros -->
            <div class="filters-section">
                <h4 class="section-title">
                    <i class="bi bi-funnel"></i>
                    Filtros y B√∫squeda
                </h4>
                <div class="filters-grid">
                    <div class="form-group search-box">
                        <label class="form-label">Buscar Estudiante</label>
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" id="filtro-nombre" class="form-control" placeholder="Nombre del estudiante...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado de Completitud</label>
                        <select id="filtro-completitud" class="form-select">
                            <option value="">Todos los estudiantes</option>
                            <option value="completo">100% Completo</option>
                            <option value="incompleto">Parcialmente completo</option>
                            <option value="sin_actividades">Sin actividades</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Filtrar por Actividad</label>
                        <select id="filtro-actividad" class="form-select">
                            <option value="">Todas las actividades</option>
                        </select>
                    </div>
                    <div class="form-group d-flex gap-2">
                        <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">
                            <i class="bi bi-search me-1"></i>Aplicar
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Limpiar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Contenido Principal -->
            <div class="content-grid">
                <!-- Panel de Actividades -->
                <div class="activities-panel">
                    <h4 class="section-title">
                        <i class="bi bi-clipboard-check"></i>
                        Estad√≠sticas por Actividad
                    </h4>
                    <div id="activities-list">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>

                <!-- Panel de Estudiantes -->
                <div class="students-panel">
                    <h4 class="section-title">
                        <i class="bi bi-people"></i>
                        Estudiantes Nuevos
                    </h4>
                    <div id="students-list">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // === VARIABLES GLOBALES ===
        let appData = {
            metricas: {},
            estadisticasActividades: [],
            estudiantes: [],
            listaActividades: [],
            filtrosActivos: {}
        };

        let searchTimeout = null;

        // === FUNCIONES DE INICIALIZACI√ìN ===
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Validar acceso con permisos
                const hasAccess = await validatePageAccess('Tablero de control');
                if (!hasAccess) return;

                // Inicializar p√°gina
                initializePage('studentsDashboard', 'Gesti√≥n de Estudiantes Nuevos');
                
                // Configurar eventos
                setupEventListeners();
                
                // Cargar datos del dashboard
                await loadDashboardData();
                
            } catch (error) {
                console.error('Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        });

        async function loadDashboardData() {
            showLoading();
            
            try {
                // Cargar todos los datos en paralelo para mejor performance
                const [metricas, estadisticas, estudiantes, actividades] = await Promise.all([
                    obtenerMetricasGenerales(),
                    obtenerEstadisticasActividades(),
                    obtenerEstudiantesDetalle(),
                    obtenerListaActividades()
                ]);
                
                // Almacenar datos
                appData.metricas = metricas;
                appData.estadisticasActividades = estadisticas;
                appData.estudiantes = estudiantes;
                appData.listaActividades = actividades;
                
                // Renderizar dashboard
                renderizarDashboard();
                
                hideLoading();
                
            } catch (error) {
                console.error('Error cargando datos del dashboard:', error);
                hideLoading();
                showMessage('Error al cargar los datos del dashboard: ' + error.message, 'danger');
            }
        }

        // === FUNCIONES DE CONSULTA DE DATOS ===
        async function obtenerMetricasGenerales() {
            try {
                // Consulta compleja para obtener todas las m√©tricas en una sola query
                const metricas = await supabaseRequest(`
                    /rpc/get_dashboard_metrics
                `.trim());
                
                if (!metricas || metricas.length === 0) {
                    // Fallback: calcular m√©tricas manualmente si no existe la funci√≥n
                    return await calcularMetricasManualmente();
                }
                
                return metricas[0];
                
            } catch (error) {
                console.warn('Funci√≥n RPC no disponible, calculando m√©tricas manualmente');
                return await calcularMetricasManualmente();
            }
        }

        async function calcularMetricasManualmente() {
            try {
                // Total estudiantes nuevos
                const totalEstudiantes = await supabaseRequest('/new_students?select=student_id');
                
                // Total actividades disponibles
                const totalActividades = await supabaseRequest('/new_student_activities?select=activity_id&activity_status=eq.active');
                
                // Total registros realizados
                const totalRegistros = await supabaseRequest('/new_student_activity_records?select=student_id');
                
                // Calcular estad√≠sticas de completitud
                const estudiantesConActividades = await supabaseRequest(`
                    /new_students?select=student_id,new_student_activity_records(activity_id)
                `.trim());
                
                const totalActividadesCount = totalActividades.length;
                let estudiantesCompletos = 0;
                let estudiantesSinActividades = 0;
                let sumaCompletitud = 0;
                
                estudiantesConActividades.forEach(estudiante => {
                    const actividadesRealizadas = estudiante.new_student_activity_records.length;
                    const completitud = totalActividadesCount > 0 ? 
                        (actividadesRealizadas / totalActividadesCount) * 100 : 0;
                    
                    sumaCompletitud += completitud;
                    
                    if (completitud === 100) estudiantesCompletos++;
                    if (completitud === 0) estudiantesSinActividades++;
                });
                
                const promedioCompletitud = estudiantesConActividades.length > 0 ? 
                    sumaCompletitud / estudiantesConActividades.length : 0;
                
                return {
                    total_estudiantes: totalEstudiantes.length,
                    total_actividades: totalActividadesCount,
                    total_registros: totalRegistros.length,
                    promedio_completitud: Math.round(promedioCompletitud * 10) / 10,
                    estudiantes_completos: estudiantesCompletos,
                    estudiantes_sin_actividades: estudiantesSinActividades
                };
                
            } catch (error) {
                console.error('Error calculando m√©tricas manualmente:', error);
                return {
                    total_estudiantes: 0,
                    total_actividades: 0,
                    total_registros: 0,
                    promedio_completitud: 0,
                    estudiantes_completos: 0,
                    estudiantes_sin_actividades: 0
                };
            }
        }

        async function obtenerEstadisticasActividades() {
            try {
                // Consulta con subconsulta para calcular estad√≠sticas por actividad
                const estadisticas = await supabaseRequest(`
                    /new_student_activities?select=activity_id,activity_name,activity_order,new_student_activity_records(student_id)&activity_status=eq.active&order=activity_order
                `.trim());
                
                // Obtener total de estudiantes para calcular porcentajes
                const totalEstudiantes = await supabaseRequest('/new_students?select=student_id');
                const totalEstudiantesCount = totalEstudiantes.length;
                
                return estadisticas.map(actividad => {
                    const totalRegistros = actividad.new_student_activity_records.length;
                    const porcentajeCompletitud = totalEstudiantesCount > 0 ? 
                        Math.round((totalRegistros / totalEstudiantesCount) * 1000) / 10 : 0;
                    
                    return {
                        activity_id: actividad.activity_id,
                        activity_name: actividad.activity_name,
                        activity_order: actividad.activity_order,
                        total_registros: totalRegistros,
                        porcentaje_completitud: porcentajeCompletitud
                    };
                });
                
            } catch (error) {
                console.error('Error obteniendo estad√≠sticas de actividades:', error);
                return [];
            }
        }

        async function obtenerEstudiantesDetalle(filtros = {}) {
            try {
                let query = '/new_students?select=student_id,students!inner(student_code,student_first_name,student_last_name_1,student_last_name_2,student_birthday,courses(course_name)),new_student_activity_records(activity_id)';
                
                // Aplicar filtros de b√∫squeda
                const whereConditions = [];
                
                if (filtros.busquedaNombre) {
                    const searchTerm = `%${filtros.busquedaNombre.toLowerCase()}%`;
                    whereConditions.push(`or=(students.student_first_name.ilike.${encodeURIComponent(searchTerm)},students.student_last_name_1.ilike.${encodeURIComponent(searchTerm)},students.student_last_name_2.ilike.${encodeURIComponent(searchTerm)})`);
                }
                
                if (whereConditions.length > 0) {
                    query += '&' + whereConditions.join('&');
                }
                
                const estudiantes = await supabaseRequest(query);
                
                // Obtener total de actividades para calcular completitud
                const totalActividades = await supabaseRequest('/new_student_activities?select=activity_id&activity_status=eq.active');
                const totalActividadesCount = totalActividades.length;
                
                // Procesar datos de estudiantes
                let estudiantesProcesados = estudiantes.map(estudiante => {
                    const student = estudiante.students;
                    const actividadesRealizadas = estudiante.new_student_activity_records.length;
                    const porcentajeCompletitud = totalActividadesCount > 0 ? 
                        Math.round((actividadesRealizadas / totalActividadesCount) * 100) : 0;
                    
                    const birthday = new Date(student.student_birthday);
                    const today = new Date();
                    const edad = Math.floor((today - birthday) / (365.25 * 24 * 60 * 60 * 1000));
                    
                    return {
                        student_id: estudiante.student_id,
                        student_code: student.student_code,
                        student_first_name: student.student_first_name,
                        student_last_name_1: student.student_last_name_1,
                        student_last_name_2: student.student_last_name_2 || '',
                        course_name: student.courses?.course_name || 'Sin curso asignado',
                        edad: edad,
                        actividades_realizadas: actividadesRealizadas,
                        total_actividades: totalActividadesCount,
                        porcentaje_completitud: porcentajeCompletitud
                    };
                });
                
                // Aplicar filtros de completitud
                if (filtros.estadoCompletitud) {
                    switch (filtros.estadoCompletitud) {
                        case 'completo':
                            estudiantesProcesados = estudiantesProcesados.filter(e => e.porcentaje_completitud === 100);
                            break;
                        case 'incompleto':
                            estudiantesProcesados = estudiantesProcesados.filter(e => e.porcentaje_completitud > 0 && e.porcentaje_completitud < 100);
                            break;
                        case 'sin_actividades':
                            estudiantesProcesados = estudiantesProcesados.filter(e => e.porcentaje_completitud === 0);
                            break;
                    }
                }
                
                // Ordenar por apellido y nombre
                estudiantesProcesados.sort((a, b) => {
                    const nameA = `${a.student_last_name_1} ${a.student_first_name}`;
                    const nameB = `${b.student_last_name_1} ${b.student_first_name}`;
                    return nameA.localeCompare(nameB);
                });
                
                return estudiantesProcesados;
                
            } catch (error) {
                console.error('Error obteniendo estudiantes:', error);
                return [];
            }
        }

        async function obtenerListaActividades() {
            try {
                const actividades = await supabaseRequest('/new_student_activities?select=activity_id,activity_name,activity_order&activity_status=eq.active&order=activity_order');
                return actividades || [];
            } catch (error) {
                console.error('Error obteniendo lista de actividades:', error);
                return [];
            }
        }

        // === FUNCIONES DE RENDERIZADO ===
        function renderizarDashboard() {
            renderizarMetricas();
            renderizarActividades();
            renderizarEstudiantes();
            llenarSelectActividades();
        }

        function renderizarMetricas() {
            const metricsSection = document.getElementById('metrics-section');
            
            const metricasConfig = [
                {
                    icon: 'bi-people',
                    value: appData.metricas.total_estudiantes || 0,
                    label: 'Total Estudiantes',
                    color: '#0d6efd'
                },
                {
                    icon: 'bi-clipboard-check',
                    value: appData.metricas.total_actividades || 0,
                    label: 'Total Actividades',
                    color: '#198754'
                },
                {
                    icon: 'bi-check-circle',
                    value: appData.metricas.total_registros || 0,
                    label: 'Actividades Realizadas',
                    color: '#20c997'
                },
                {
                    icon: 'bi-graph-up',
                    value: `${appData.metricas.promedio_completitud || 0}%`,
                    label: 'Promedio Completitud',
                    color: '#ffc107'
                },
                {
                    icon: 'bi-trophy',
                    value: appData.metricas.estudiantes_completos || 0,
                    label: 'Estudiantes 100%',
                    color: '#198754'
                },
                {
                    icon: 'bi-exclamation-triangle',
                    value: appData.metricas.estudiantes_sin_actividades || 0,
                    label: 'Sin Actividades',
                    color: '#dc3545'
                }
            ];

            metricsSection.innerHTML = metricasConfig.map(metrica => `
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="${metrica.icon}"></i>
                    </div>
                    <div class="metric-value" style="color: ${metrica.color}">${metrica.value}</div>
                    <div class="metric-label">${metrica.label}</div>
                </div>
            `).join('');
        }

        function renderizarActividades() {
            const activitiesList = document.getElementById('activities-list');
            
            if (!appData.estadisticasActividades || appData.estadisticasActividades.length === 0) {
                activitiesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="bi bi-clipboard-x"></i>
                        </div>
                        <h4>No hay actividades disponibles</h4>
                        <p>Configure las actividades del proceso de inculturaci√≥n</p>
                    </div>
                `;
                return;
            }

            activitiesList.innerHTML = appData.estadisticasActividades.map(actividad => `
                <div class="activity-item" onclick="mostrarEstudiantesPorActividad('${actividad.activity_id}', '${actividad.activity_name.replace(/'/g, "\\'")}')">
                    <div class="activity-name">${actividad.activity_name}</div>
                    <div class="activity-stats">
                        <span class="activity-count">${actividad.total_registros} estudiantes</span>
                        <span class="activity-percentage" style="background-color: ${obtenerColorPorcentaje(actividad.porcentaje_completitud)}">
                            ${actividad.porcentaje_completitud}%
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function renderizarEstudiantes() {
            const studentsList = document.getElementById('students-list');
            
            if (!appData.estudiantes || appData.estudiantes.length === 0) {
                studentsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="bi bi-person-x"></i>
                        </div>
                        <h4>No se encontraron estudiantes</h4>
                        <p>No hay estudiantes que coincidan con los filtros aplicados</p>
                    </div>
                `;
                return;
            }
        
            studentsList.innerHTML = appData.estudiantes.map(estudiante => {
                const nombreCompleto = `${estudiante.student_first_name} ${estudiante.student_last_name_1} ${estudiante.student_last_name_2}`.trim();
                const claseProgreso = obtenerClaseProgreso(estudiante.porcentaje_completitud);
                const estadoProgreso = obtenerEstadoProgreso(estudiante.porcentaje_completitud);
                
                return `
                    <div class="student-card" onclick="mostrarDetalleEstudiante(${estudiante.student_id})">
                        <img class="student-photo" 
                             src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiNFNUU3RUIiLz4KPHN2ZyB4PSIxNiIgeT0iMTIiIHdpZHRoPSIzMiIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjOUM5RkE2Ij4KPHN0eWxlPi5he2ZpbGw6bm9uZTtzdHJva2U6Y3VycmVudENvbG9yO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2Utd2lkdGg6MS41fTwvc3R5bGU+CjxwYXRoIGNsYXNzPSJhIiBkPSJNMjAgMjF2LTJhNCA0IDAgMCAwLTQtNEg4YTQgNCAwIDAgMC00IDR2MiIvPgo8Y2lyY2xlIGNsYXNzPSJhIiBjeD0iMTIiIGN5PSI3IiByPSI0Ii8+Cjwvc3ZnPgo8L3N2Zz4="
                             alt="${nombreCompleto}"
                             data-student-code="${estudiante.student_code}">
                        <div class="student-info">
                            <div class="student-name">${nombreCompleto}</div>
                            <div class="student-details">
                                ${estudiante.course_name} ‚Ä¢ ${estudiante.edad} a√±os<br>
                                ${estudiante.actividades_realizadas}/${estudiante.total_actividades} actividades completadas
                            </div>
                        </div>
                        <div class="student-progress">
                            <div class="progress-circle ${claseProgreso}">
                                ${estudiante.porcentaje_completitud}%
                            </div>
                            <div class="progress-status">${estadoProgreso}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Cargar fotos despu√©s del renderizado (SIN eventos onload/onerror)
            cargarTodasLasFotos();
        }


        
        function llenarSelectActividades() {
            const select = document.getElementById('filtro-actividad');
            
            // Limpiar opciones existentes excepto la primera
            select.innerHTML = '<option value="">Todas las actividades</option>';
            
            appData.listaActividades.forEach(actividad => {
                const option = document.createElement('option');
                option.value = actividad.activity_id;
                option.textContent = actividad.activity_name;
                select.appendChild(option);
            });
        }

        // === NUEVA FUNCI√ìN PARA CARGAR FOTOS SIN EVENTOS ===
        async function cargarTodasLasFotos() {
            const imagenesEstudiantes = document.querySelectorAll('.student-photo[data-student-code]');
            
            // Cargar fotos de forma as√≠ncrona para mejor rendimiento
            const promesasFotos = Array.from(imagenesEstudiantes).map(async (img) => {
                const studentCode = img.getAttribute('data-student-code');
                if (!studentCode) return;
                
                try {
                    const fotoUrl = await getStudentPhotoUrl(studentCode);
                    if (fotoUrl) {
                        img.src = fotoUrl;
                    }
                    // Si no hay foto, mantiene el placeholder que ya tiene
                } catch (error) {
                    console.log(`No se pudo cargar foto para estudiante ${studentCode}`);
                    // Mantiene el placeholder en caso de error
                }
            });
            
            // No necesitamos esperar a que terminen todas las fotos
            // Se cargan de forma independiente
        }


        
      // === FUNCIONES DE EVENTOS ===
        function setupEventListeners() {
            // B√∫squeda con debounce
            const filtroNombre = document.getElementById('filtro-nombre');
            filtroNombre.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    aplicarFiltros();
                }, 500);
            });

            // Filtros de select
            const filtroCompletitud = document.getElementById('filtro-completitud');
            filtroCompletitud.addEventListener('change', aplicarFiltros);

            // Cerrar modales con Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    cerrarTodosLosModales();
                }
            });

            // Cerrar modales al hacer clic en overlay
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-overlay')) {
                    cerrarTodosLosModales();
                }
            });
        }

        // === FUNCIONES DE FILTROS ===
        async function aplicarFiltros() {
            const filtros = {
                busquedaNombre: document.getElementById('filtro-nombre').value.trim(),
                estadoCompletitud: document.getElementById('filtro-completitud').value,
                actividadId: document.getElementById('filtro-actividad').value
            };

            // Si hay filtro por actividad, mostrar modal espec√≠fico
            if (filtros.actividadId) {
                const actividad = appData.listaActividades.find(a => a.activity_id === filtros.actividadId);
                if (actividad) {
                    mostrarEstudiantesPorActividad(filtros.actividadId, actividad.activity_name);
                }
                document.getElementById('filtro-actividad').selectedIndex = 0;
                return;
            }

            appData.filtrosActivos = filtros;
            showLoading();

            try {
                appData.estudiantes = await obtenerEstudiantesDetalle(filtros);
                renderizarEstudiantes();
            } catch (error) {
                console.error('Error aplicando filtros:', error);
                showMessage('Error al aplicar filtros: ' + error.message, 'warning');
            } finally {
                hideLoading();
            }
        }

        async function limpiarFiltros() {
            document.getElementById('filtro-nombre').value = '';
            document.getElementById('filtro-completitud').selectedIndex = 0;
            document.getElementById('filtro-actividad').selectedIndex = 0;
            
            appData.filtrosActivos = {};
            showLoading();

            try {
                appData.estudiantes = await obtenerEstudiantesDetalle();
                renderizarEstudiantes();
            } catch (error) {
                console.error('Error limpiando filtros:', error);
                showMessage('Error al limpiar filtros: ' + error.message, 'warning');
            } finally {
                hideLoading();
            }
        }

        // === FUNCIONES DE MODALES ===
        / Actualizar la funci√≥n mostrarDetalleEstudiante
        async function mostrarDetalleEstudiante(studentId) {
            showLoading();
        
            try {
                const actividadesEstudiante = await obtenerActividadesEstudiante(studentId);
                const estudiante = appData.estudiantes.find(e => e.student_id === studentId);
                
                if (!estudiante) {
                    throw new Error('Estudiante no encontrado');
                }
        
                const nombreCompleto = `${estudiante.student_first_name} ${estudiante.student_last_name_1} ${estudiante.student_last_name_2}`.trim();
        
                const modalHtml = `
                    <div class="modal-overlay" id="modal-estudiante">
                        <div class="modal-content-custom">
                            <div class="modal-header-custom">
                                <h5>Detalle del Estudiante</h5>
                                <button type="button" class="btn-close" onclick="cerrarModalEstudiante()"></button>
                            </div>
                            <div class="modal-body-custom">
                                <div class="student-detail-header">
                                    <img class="student-detail-photo" 
                                         src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiNFNUU3RUIiLz4KPHN2ZyB4PSIxNiIgeT0iMTIiIHdpZHRoPSIzMiIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjOUM5RkE2Ij4KPHN0eWxlPi5he2ZpbGw6bm9uZTtzdHJva2U6Y3VycmVudENvbG9yO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2Utd2lkdGg6MS41fTwvc3R5bGU+CjxwYXRoIGNsYXNzPSJhIiBkPSJNMjAgMjF2LTJhNCA0IDAgMCAwLTQtNEg4YTQgNCAwIDAgMC00IDR2MiIvPgo8Y2lyY2xlIGNsYXNzPSJhIiBjeD0iMTIiIGN5PSI3IiByPSI0Ii8+Cjwvc3ZnPgo8L3N2Zz4="
                                         alt="${nombreCompleto}"
                                         data-student-code="${estudiante.student_code}">
                                    <div>
                                        <h4>${nombreCompleto}</h4>
                                        <p><strong>Curso:</strong> ${estudiante.course_name}</p>
                                        <p><strong>Edad:</strong> ${estudiante.edad} a√±os</p>
                                        <p><strong>Progreso:</strong> ${estudiante.actividades_realizadas}/${estudiante.total_actividades} actividades (${estudiante.porcentaje_completitud}%)</p>
                                    </div>
                                </div>
                                
                                <h5>Estado de Actividades:</h5>
                                <div class="activities-status-grid">
                                    <div class="status-section">
                                        <h6 class="text-success">‚úÖ Actividades Realizadas</h6>
                                        ${actividadesEstudiante.filter(a => a.estado === 'Realizada').map(actividad => `
                                            <div class="activity-status-item status-realizada">
                                                <span>${actividad.activity_name}</span>
                                                <small>${formatDate(actividad.activity_date)}</small>
                                            </div>
                                        `).join('')}
                                    </div>
                                    
                                    <div class="status-section">
                                        <h6 class="text-danger">‚ùå Actividades Pendientes</h6>
                                        ${actividadesEstudiante.filter(a => a.estado === 'Pendiente').map(actividad => `
                                            <div class="activity-status-item status-pendiente">
                                                <span>${actividad.activity_name}</span>
                                                <small>Pendiente</small>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer-custom">
                                <button type="button" class="btn btn-secondary" onclick="cerrarModalEstudiante()">Cerrar</button>
                            </div>
                        </div>
                    </div>
                `;
        
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Cargar foto del modal despu√©s de insertar el HTML
                setTimeout(async () => {
                    const modalImg = document.querySelector('#modal-estudiante .student-detail-photo[data-student-code]');
                    if (modalImg) {
                        const studentCode = modalImg.getAttribute('data-student-code');
                        try {
                            const fotoUrl = await getStudentPhotoUrl(studentCode);
                            if (fotoUrl) {
                                modalImg.src = fotoUrl;
                            }
                        } catch (error) {
                            console.log(`No se pudo cargar foto en modal para estudiante ${studentCode}`);
                        }
                    }
                }, 100);
        
            } catch (error) {
                console.error('Error mostrando detalle del estudiante:', error);
                showMessage('Error al cargar el detalle del estudiante: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        async function obtenerActividadesEstudiante(studentId) {
            try {
                // Obtener todas las actividades con informaci√≥n de si fueron realizadas
                const todasActividades = await supabaseRequest('/new_student_activities?select=activity_id,activity_name,activity_order&activity_status=eq.active&order=activity_order');
                
                // Obtener actividades realizadas por el estudiante
                const actividadesRealizadas = await supabaseRequest(`/new_student_activity_records?select=activity_id,activity_date,workers!inner(worker_first_name,worker_last_name_1)&student_id=eq.${studentId}`);
                
                return todasActividades.map(actividad => {
                    const realizada = actividadesRealizadas.find(r => r.activity_id === actividad.activity_id);
                    
                    return {
                        activity_id: actividad.activity_id,
                        activity_name: actividad.activity_name,
                        activity_order: actividad.activity_order,
                        activity_date: realizada ? realizada.activity_date : null,
                        responsable: realizada ? `${realizada.workers.worker_first_name} ${realizada.workers.worker_last_name_1}` : null,
                        estado: realizada ? 'Realizada' : 'Pendiente'
                    };
                });

            } catch (error) {
                console.error('Error obteniendo actividades del estudiante:', error);
                return [];
            }
        }

        async function mostrarEstudiantesPorActividad(activityId, nombreActividad) {
            showLoading();

            try {
                // Obtener estudiantes que realizaron la actividad
                const estudiantesRealizadas = await supabaseRequest(`
                    /new_student_activity_records?select=student_id,activity_date,workers!inner(worker_first_name,worker_last_name_1),new_students!inner(students!inner(student_code,student_first_name,student_last_name_1,student_last_name_2,courses(course_name)))&activity_id=eq.${activityId}&order=activity_date.desc
                `.trim());

                // Obtener estudiantes que NO han realizado la actividad
                const todosEstudiantes = await supabaseRequest('/new_students?select=student_id,students!inner(student_code,student_first_name,student_last_name_1,student_last_name_2,courses(course_name))');
                
                const idsRealizadas = estudiantesRealizadas.map(e => e.student_id);
                const estudiantesPendientes = todosEstudiantes.filter(e => !idsRealizadas.includes(e.student_id));

                const modalHtml = `
                    <div class="modal-overlay" id="modal-actividad">
                        <div class="modal-content-custom">
                            <div class="modal-header-custom">
                                <h5>Actividad: ${nombreActividad}</h5>
                                <button type="button" class="btn-close" onclick="cerrarModalActividad()"></button>
                            </div>
                            <div class="modal-body-custom">
                                <div class="mb-4">
                                    <h6 class="text-success mb-3">‚úÖ Estudiantes que han realizado la actividad (${estudiantesRealizadas.length})</h6>
                                    ${estudiantesRealizadas.length > 0 ? estudiantesRealizadas.map(est => {
                                        const student = est.new_students.students;
                                        const nombreCompleto = `${student.student_first_name} ${student.student_last_name_1} ${student.student_last_name_2 || ''}`.trim();
                                        return `
                                            <div class="student-card mb-2">
                                                <img class="student-photo" 
                                                     src="#" 
                                                     alt="${nombreCompleto}"
                                                     onload="cargarFotoEstudiante(this, '${student.student_code}')"
                                                     onerror="mostrarFotoPlaceholder(this)">
                                                <div class="student-info">
                                                    <div class="student-name">${nombreCompleto}</div>
                                                    <div class="student-details">
                                                        ${student.courses?.course_name || 'Sin curso'}<br>
                                                        Realizada: ${formatDate(est.activity_date)}<br>
                                                        Por: ${est.workers.worker_first_name} ${est.workers.worker_last_name_1}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('') : '<p class="text-muted">Ning√∫n estudiante ha realizado esta actividad a√∫n.</p>'}
                                </div>
                                
                                <div>
                                    <h6 class="text-danger mb-3">‚ùå Estudiantes pendientes (${estudiantesPendientes.length})</h6>
                                    ${estudiantesPendientes.length > 0 ? estudiantesPendientes.map(est => {
                                        const student = est.students;
                                        const nombreCompleto = `${student.student_first_name} ${student.student_last_name_1} ${student.student_last_name_2 || ''}`.trim();
                                        return `
                                            <div class="student-card mb-2">
                                                <img class="student-photo" 
                                                     src="#" 
                                                     alt="${nombreCompleto}"
                                                     onload="cargarFotoEstudiante(this, '${student.student_code}')"
                                                     onerror="mostrarFotoPlaceholder(this)">
                                                <div class="student-info">
                                                    <div class="student-name">${nombreCompleto}</div>
                                                    <div class="student-details">${student.courses?.course_name || 'Sin curso'}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('') : '<p class="text-muted">Todos los estudiantes han realizado esta actividad.</p>'}
                                </div>
                            </div>
                            <div class="modal-footer-custom">
                                <button type="button" class="btn btn-secondary" onclick="cerrarModalActividad()">Cerrar</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHtml);

            } catch (error) {
                console.error('Error mostrando estudiantes por actividad:', error);
                showMessage('Error al cargar los estudiantes de la actividad: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        function cerrarModalEstudiante() {
            const modal = document.getElementById('modal-estudiante');
            if (modal) {
                modal.remove();
            }
        }

        function cerrarModalActividad() {
            const modal = document.getElementById('modal-actividad');
            if (modal) {
                modal.remove();
            }
        }

        function cerrarTodosLosModales() {
            cerrarModalEstudiante();
            cerrarModalActividad();
        }

        // === FUNCIONES DE UTILIDAD ===
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showMessage(message, type) {
            const container = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="bi ${getIconForType(type)} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.appendChild(alertDiv);
            
            if (type === 'success') {
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function getIconForType(type) {
            const icons = {
                success: 'bi-check-circle',
                danger: 'bi-exclamation-triangle',
                warning: 'bi-exclamation-triangle',
                info: 'bi-info-circle'
            };
            return icons[type] || 'bi-info-circle';
        }

        function obtenerColorPorcentaje(porcentaje) {
            if (porcentaje >= 80) return '#198754';
            if (porcentaje >= 50) return '#ffc107';
            return '#dc3545';
        }

        function obtenerClaseProgreso(porcentaje) {
            if (porcentaje === 100) return 'progress-complete';
            if (porcentaje > 0) return 'progress-partial';
            return 'progress-none';
        }

        function obtenerEstadoProgreso(porcentaje) {
            if (porcentaje === 100) return 'Completo';
            if (porcentaje > 0) return 'En progreso';
            return 'Sin iniciar';
        }

        // Hacer funciones disponibles globalmente para onclick
            window.aplicarFiltros = aplicarFiltros;
            window.limpiarFiltros = limpiarFiltros;
            window.mostrarDetalleEstudiante = mostrarDetalleEstudiante;
            window.mostrarEstudiantesPorActividad = mostrarEstudiantesPorActividad;
            window.cerrarModalEstudiante = cerrarModalEstudiante;
            window.cerrarModalActividad = cerrarModalActividad;
    </script>
</body>
</html>
