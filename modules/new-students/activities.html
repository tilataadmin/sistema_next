<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Actividades - Estudiantes Nuevos</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .main-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            margin-top: 1.5rem;
        }
        
        .table-section {
            min-width: 0;
        }
        
        .form-section {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            height: fit-content;
            position: sticky;
            top: 1.5rem;
        }
        
        .section-title {
            color: #0d6efd;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #6c757d;
        }
        
        .activities-table {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .activities-table th {
            background-color: #0d6efd;
            color: white;
            font-weight: 600;
        }
        
        .activities-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .order-badge {
            background-color: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
            display: inline-block;
        }
        
        .actions-cell {
            white-space: nowrap;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.875rem;
            margin: 0 2px;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 1rem;
        }
        
        .form-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        
        .form-actions .btn {
            flex: 1;
        }
        
        .editing-indicator {
            background-color: #fff3cd;
            color: #856404;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-weight: 600;
            text-align: center;
            border: 1px solid #ffeaa7;
        }
        
        .activity-name-cell {
            font-weight: 500;
            color: #0d6efd;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .form-section {
                position: static;
                order: -1;
            }
            
            .activities-table {
                font-size: 0.875rem;
            }
            
            .btn-small {
                padding: 4px 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Overlay de carga -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Procesando...</p>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="../new-students/index.html">
                        Gestión de Estudiantes Nuevos
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Actividades
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-list-task me-2"></i>
                    Gestión de Actividades - Estudiantes Nuevos
                </h1>
                <p class="text-muted">
                    Administra las actividades del proceso de inculturación para estudiantes nuevos y sus familias
                </p>
            </div>
        </div>

        <!-- Mensajes -->
        <div id="mensaje-container"></div>

      <!-- Contenedor principal con grid -->
        <div class="main-container">
            <!-- Sección de tabla -->
            <div class="table-section">
                <h2 class="section-title">
                    <i class="bi bi-list-ul me-2"></i>Lista de Actividades
                </h2>
                
                <div class="table-container">
                    <table id="activities-table" class="table table-hover activities-table">
                        <thead>
                            <tr>
                                <th width="80">Orden</th>
                                <th>Nombre de la Actividad</th>
                                <th width="150">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="activities-tbody">
                            <!-- Las filas se cargarán dinámicamente -->
                        </tbody>
                    </table>
                    
                    <!-- Estado vacío -->
                    <div id="empty-state" class="empty-state hidden">
                        <div class="empty-state-icon">
                            <i class="bi bi-clipboard-x"></i>
                        </div>
                        <h3>No hay actividades registradas</h3>
                        <p>Utiliza el formulario de la derecha para crear la primera actividad.</p>
                    </div>
                </div>
            </div>

            <!-- Sección de formulario -->
            <div class="form-section">
                <h2 class="section-title">
                    <i class="bi bi-plus-circle me-2"></i>Gestionar Actividad
                </h2>
                
                <!-- Indicador de edición -->
                <div id="editing-indicator" class="editing-indicator hidden">
                    <i class="bi bi-pencil me-2"></i>Editando actividad
                </div>
                
                <!-- Formulario -->
                <form id="form-actividad" novalidate>
                    <input type="hidden" id="actividad-id" name="activity_id">
                    
                    <!-- Campo de orden -->
                    <div class="mb-3">
                        <label for="orden-actividad" class="form-label">
                            Orden de la actividad <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="orden-actividad" 
                            name="activity_order" 
                            class="form-control"
                            min="1"
                            step="1"
                            placeholder="Ej: 1, 2, 3..."
                            required>
                        <div class="form-text">
                            Cada actividad debe tener un orden único
                        </div>
                        <div class="invalid-feedback">
                            El orden es requerido y debe ser un número positivo
                        </div>
                    </div>

                    <!-- Campo de nombre -->
                    <div class="mb-3">
                        <label for="nombre-actividad" class="form-label">
                            Nombre de la actividad <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="nombre-actividad" 
                            name="activity_name" 
                            class="form-control"
                            placeholder="Ej: Entrevista inicial, Visita guiada..."
                            maxlength="100"
                            required>
                        <div class="form-text">
                            Describe brevemente la actividad (máximo 100 caracteres)
                        </div>
                        <div class="invalid-feedback">
                            El nombre de la actividad es requerido
                        </div>
                    </div>

                    <!-- Campo de descripción (opcional) -->
                    <div class="mb-3">
                        <label for="descripcion-actividad" class="form-label">
                            Descripción (opcional)
                        </label>
                        <textarea 
                            id="descripcion-actividad" 
                            name="activity_description" 
                            class="form-control"
                            rows="3"
                            placeholder="Descripción detallada de la actividad..."
                            maxlength="500"></textarea>
                        <div class="form-text">
                            Información adicional sobre la actividad
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="form-actions">
                        <button type="submit" id="btn-guardar" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>Guardar
                        </button>
                        <button type="button" id="btn-cancelar" class="btn btn-secondary">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

  <script>
        // Variables globales
        let isEditing = false;
        let currentEditingId = null;

        // Validación de permisos al cargar
        document.addEventListener('DOMContentLoaded', async function() {
            // CRÍTICO: Usar clave correcta de sesión
            if (!getStoredSession()) {
                window.location.href = '../../login.html';
                return;
            }

            // Validar acceso a esta página específica
            const hasAccess = await validatePageAccess('Actividades');
            if (!hasAccess) {
                return; // validatePageAccess maneja la redirección
            }

            // Inicializar página
            initializePage('activities', 'Gestión de Estudiantes Nuevos');
            inicializarFormulario();
        });

        /**
         * Inicializa el formulario cargando datos y configurando eventos
         */
        function inicializarFormulario() {
            mostrarLoading();
            
            // Cargar actividades
            cargarActividades();
            
            // Configurar eventos
            configurarEventos();
            
            ocultarLoading();
        }

        /**
         * Configura todos los eventos del formulario
         */
        function configurarEventos() {
            // Evento de envío del formulario
            document.getElementById('form-actividad').addEventListener('submit', function(e) {
                e.preventDefault();
                guardarActividad();
            });
            
            // Botón cancelar
            document.getElementById('btn-cancelar').addEventListener('click', cancelarEdicion);
            
            // Validación en tiempo real del orden
            document.getElementById('orden-actividad').addEventListener('input', function() {
                const valor = parseInt(this.value);
                if (valor < 1) {
                    this.value = 1;
                }
                // Quitar clase de error si había
                this.classList.remove('is-invalid');
            });
            
            // Validación en tiempo real del nombre
            document.getElementById('nombre-actividad').addEventListener('input', function() {
                // Limitar longitud
                if (this.value.length > 100) {
                    this.value = this.value.substring(0, 100);
                }
                // Quitar clase de error si había
                this.classList.remove('is-invalid');
            });
            
            // Validación de descripción
            document.getElementById('descripcion-actividad').addEventListener('input', function() {
                if (this.value.length > 500) {
                    this.value = this.value.substring(0, 500);
                }
            });
        }

        /**
         * Carga todas las actividades desde Supabase
         */
        async function cargarActividades() {
            try {
                mostrarLoading();
                
                // CRÍTICO: URL sin espacios extra para evitar errores CORS
                const actividades = await supabaseRequest('/new_student_activities?select=*&order=activity_order.asc');
                
                mostrarActividades(actividades);
                ocultarLoading();
                
            } catch (error) {
                console.error('Error al cargar actividades:', error);
                mostrarMensaje('danger', 'Error al cargar actividades: ' + error.message);
                mostrarEstadoVacio();
                ocultarLoading();
            }
        }

        /**
         * Muestra las actividades en la tabla
         */
        function mostrarActividades(actividades) {
            const tbody = document.getElementById('activities-tbody');
            const emptyState = document.getElementById('empty-state');
            const table = document.getElementById('activities-table');
            
            if (!actividades || actividades.length === 0) {
                mostrarEstadoVacio();
                return;
            }
            
            // Ocultar estado vacío y mostrar tabla
            emptyState.classList.add('hidden');
            table.style.display = 'table';
            
            // Limpiar tbody
            tbody.innerHTML = '';
            
            actividades.forEach(actividad => {
                const fila = document.createElement('tr');
                fila.dataset.actividadId = actividad.activity_id;
                
                fila.innerHTML = `
                    <td>
                        <span class="order-badge">${actividad.activity_order}</span>
                    </td>
                    <td class="activity-name-cell">
                        <div>
                            <strong>${escapeHtml(actividad.activity_name)}</strong>
                            ${actividad.activity_description ? 
                                `<br><small class="text-muted">${escapeHtml(actividad.activity_description)}</small>` : 
                                ''
                            }
                        </div>
                    </td>
                    <td class="actions-cell">
                        <button 
                            type="button" 
                            class="btn btn-warning btn-small" 
                            onclick="editarActividad('${actividad.activity_id}')"
                            title="Editar actividad">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button 
                            type="button" 
                            class="btn btn-danger btn-small" 
                            onclick="eliminarActividad('${actividad.activity_id}', '${escapeHtml(actividad.activity_name)}')"
                            title="Eliminar actividad">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(fila);
            });
        }

        /**
         * Muestra el estado vacío cuando no hay actividades
         */
        function mostrarEstadoVacio() {
            const tbody = document.getElementById('activities-tbody');
            const emptyState = document.getElementById('empty-state');
            const table = document.getElementById('activities-table');
            
            tbody.innerHTML = '';
            table.style.display = 'none';
            emptyState.classList.remove('hidden');
        }

    /**
         * Guarda una actividad (crear o actualizar)
         */
        async function guardarActividad() {
            const form = document.getElementById('form-actividad');
            const formData = new FormData(form);
            
            // Validar campos obligatorios
            const orden = formData.get('activity_order');
            const nombre = formData.get('activity_name');
            
            // Reset validaciones previas
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            let hasErrors = false;
            
            if (!orden || parseInt(orden) < 1) {
                document.getElementById('orden-actividad').classList.add('is-invalid');
                hasErrors = true;
            }
            
            if (!nombre || nombre.trim().length === 0) {
                document.getElementById('nombre-actividad').classList.add('is-invalid');
                hasErrors = true;
            }
            
            if (hasErrors) {
                mostrarMensaje('danger', 'Por favor corrige los errores en el formulario.');
                return;
            }
            
            // Preparar datos
            const datos = {
                activity_order: parseInt(orden),
                activity_name: nombre.trim(),
                activity_description: formData.get('activity_description')?.trim() || null
            };
            
            try {
                mostrarLoading();
                const btnGuardar = document.getElementById('btn-guardar');
                btnGuardar.disabled = true;
                
                let resultado;
                
                if (isEditing && currentEditingId) {
                    // Actualizar actividad existente
                    resultado = await supabaseRequest('/new_student_activities?activity_id=eq.' + currentEditingId, {
                        method: 'PATCH',
                        body: JSON.stringify(datos)
                    });
                    mostrarMensaje('success', 'Actividad actualizada exitosamente');
                } else {
                    // Crear nueva actividad
                    resultado = await supabaseRequest('/new_student_activities', {
                        method: 'POST',
                        body: JSON.stringify(datos)
                    });
                    mostrarMensaje('success', 'Actividad creada exitosamente');
                }
                
                limpiarFormulario();
                await cargarActividades();
                
            } catch (error) {
                console.error('Error al guardar actividad:', error);
                let errorMsg = 'Error al guardar la actividad.';
                
                if (error.message.includes('duplicate key value violates unique constraint')) {
                    if (error.message.includes('activity_order')) {
                        errorMsg = 'Ya existe una actividad con ese orden. Por favor, elige un orden diferente.';
                    } else if (error.message.includes('activity_name')) {
                        errorMsg = 'Ya existe una actividad con ese nombre.';
                    }
                }
                
                mostrarMensaje('danger', errorMsg);
            } finally {
                document.getElementById('btn-guardar').disabled = false;
                ocultarLoading();
            }
        }

        /**
         * Prepara el formulario para editar una actividad
         */
        async function editarActividad(activityId) {
            try {
                mostrarLoading();
                
                const actividades = await supabaseRequest('/new_student_activities?activity_id=eq.' + activityId);
                
                if (!actividades || actividades.length === 0) {
                    throw new Error('Actividad no encontrada');
                }
                
                const actividad = actividades[0];
                
                // Llenar formulario con datos de la actividad
                document.getElementById('actividad-id').value = actividad.activity_id;
                document.getElementById('orden-actividad').value = actividad.activity_order;
                document.getElementById('nombre-actividad').value = actividad.activity_name;
                document.getElementById('descripcion-actividad').value = actividad.activity_description || '';
                
                // Cambiar estado a edición
                isEditing = true;
                currentEditingId = activityId;
                
                // Actualizar interfaz
                document.getElementById('editing-indicator').classList.remove('hidden');
                document.getElementById('btn-guardar').innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Actualizar';
                
                // Enfocar primer campo
                document.getElementById('orden-actividad').focus();
                
                // Scroll hacia el formulario
                document.querySelector('.form-section').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
                
                ocultarLoading();
                
            } catch (error) {
                console.error('Error al obtener actividad:', error);
                mostrarMensaje('danger', 'Error al cargar datos de la actividad: ' + error.message);
                ocultarLoading();
            }
        }

        /**
         * Elimina una actividad con confirmación
         */
        async function eliminarActividad(activityId, nombreActividad) {
            if (!confirm(`¿Estás seguro de que deseas eliminar la actividad "${nombreActividad}"?\n\nEsta acción no se puede deshacer y solo será posible si no tiene registros asociados.`)) {
                return;
            }
            
            try {
                mostrarLoading();
                
                await supabaseRequest('/new_student_activities?activity_id=eq.' + activityId, {
                    method: 'DELETE'
                });
                
                mostrarMensaje('success', `Actividad "${nombreActividad}" eliminada exitosamente`);
                
                // Si se está editando esta actividad, cancelar edición
                if (isEditing && currentEditingId === activityId) {
                    cancelarEdicion();
                }
                
                await cargarActividades();
                
            } catch (error) {
                console.error('Error al eliminar actividad:', error);
                let errorMsg = 'Error al eliminar la actividad.';
                
                if (error.message.includes('violates foreign key constraint')) {
                    errorMsg = 'No se puede eliminar la actividad porque tiene registros asociados.';
                }
                
                mostrarMensaje('danger', errorMsg);
            } finally {
                ocultarLoading();
            }
        }

        /**
         * Cancela la edición y limpia el formulario
         */
        function cancelarEdicion() {
            limpiarFormulario();
        }

        /**
         * Limpia el formulario y resetea el estado
         */
        function limpiarFormulario() {
            // Limpiar campos del formulario
            document.getElementById('form-actividad').reset();
            document.getElementById('actividad-id').value = '';
            
            // Reset validaciones
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            // Resetear estado de edición
            isEditing = false;
            currentEditingId = null;
            
            // Actualizar interfaz
            document.getElementById('editing-indicator').classList.add('hidden');
            document.getElementById('btn-guardar').innerHTML = '<i class="bi bi-save me-1"></i>Guardar';
            
            // Enfocar primer campo
            document.getElementById('orden-actividad').focus();
        }

        /**
         * Funciones de utilidad
         */
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function mostrarMensaje(tipo, mensaje) {
            const container = document.getElementById('mensaje-container');
            
            // Limpiar mensajes anteriores
            container.innerHTML = '';
            
            const alertClass = tipo === 'danger' ? 'alert-danger' : 
                              tipo === 'success' ? 'alert-success' : 
                              'alert-info';
            
            const iconClass = tipo === 'danger' ? 'bi-exclamation-triangle' : 
                             tipo === 'success' ? 'bi-check-circle' : 
                             'bi-info-circle';
            
            const div = document.createElement('div');
            div.className = `alert ${alertClass} alert-dismissible fade show`;
            div.innerHTML = `
                <i class="bi ${iconClass} me-2"></i>
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            container.appendChild(div);
            
            // Auto-ocultar después de 5 segundos para mensajes de éxito
            if (tipo === 'success') {
                setTimeout(() => {
                    if (div.parentNode) {
                        div.remove();
                    }
                }, 5000);
            }
            
            // Scroll hacia arriba para mostrar el mensaje
            window.scrollTo(0, 0);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
