<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA -->
    <meta name="page-version" content="25.11.09.11.27">
    
    <title>Acciones de Jardines - Admisiones - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos personalizados */
        .action-card {
            border-left: 4px solid var(--system-primary-color, #0d6efd);
            transition: all 0.3s ease;
        }

        .action-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .action-date {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }

        .action-description {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 100px;
            overflow-y: auto;
        }

        .kindergarten-badge {
            background-color: var(--system-primary-color, #0d6efd);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .filter-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .action-meta {
            font-size: 0.85rem;
            color: #6c757d;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Admisiones</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Acciones de Jardines
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="h3">
                    <i class="bi bi-calendar-check me-2"></i>
                    Acciones de Jardines Infantiles
                </h1>
                <p class="text-muted">
                    Registre y gestione las acciones realizadas hacia cada jard√≠n infantil
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <button class="btn btn-primary" onclick="abrirModalNuevaAccion()">
                    <i class="bi bi-plus-circle me-1"></i>Registrar Nueva Acci√≥n
                </button>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- SECCI√ìN DE FILTROS -->
        <div class="filter-section">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="filterKindergarten" class="form-label">
                        <i class="bi bi-building me-1"></i>Filtrar por Jard√≠n
                    </label>
                    <select class="form-select" id="filterKindergarten" onchange="aplicarFiltros()">
                        <option value="">Todos los jardines</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filterDateFrom" class="form-label">
                        <i class="bi bi-calendar me-1"></i>Desde
                    </label>
                    <input type="date" class="form-control" id="filterDateFrom" onchange="aplicarFiltros()">
                </div>
                <div class="col-md-3">
                    <label for="filterDateTo" class="form-label">
                        <i class="bi bi-calendar me-1"></i>Hasta
                    </label>
                    <input type="date" class="form-control" id="filterDateTo" onchange="aplicarFiltros()">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-outline-secondary w-100" onclick="limpiarFiltros()">
                        <i class="bi bi-x-circle me-1"></i>Limpiar
                    </button>
                </div>
            </div>
        </div>

        <!-- LISTADO DE ACCIONES -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>Historial de Acciones
                    <span class="badge bg-secondary ms-2" id="actionCount">0</span>
                </h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="cargarAcciones()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                </button>
            </div>
            <div class="card-body">
                <div id="actionsContainer">
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-3">No hay acciones registradas</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL: NUEVA/EDITAR ACCI√ìN -->
    <div class="modal fade" id="modalAccion" tabindex="-1" aria-labelledby="modalAccionLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAccionLabel">
                        <i class="bi bi-plus-circle me-2"></i>
                        <span id="modalTitle">Registrar Nueva Acci√≥n</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="formAccion" onsubmit="guardarAccion(event)">
                    <div class="modal-body">
                        <input type="hidden" id="actionId">
                        
                        <div class="mb-3">
                            <label for="kindergartenSelect" class="form-label">
                                Jard√≠n Infantil <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="kindergartenSelect" required>
                                <option value="">Seleccione un jard√≠n...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="actionDate" class="form-label">
                                Fecha de la Acci√≥n <span class="text-danger">*</span>
                            </label>
                            <input type="date" class="form-control" id="actionDate" required>
                        </div>

                        <div class="mb-3">
                            <label for="actionDescription" class="form-label">
                                Descripci√≥n de la Acci√≥n <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="actionDescription" rows="5" 
                                      placeholder="Describa detalladamente la acci√≥n realizada hacia el jard√≠n infantil..."
                                      required></textarea>
                            <small class="text-muted">
                                Ejemplo: "Reuni√≥n con la directora para presentar el proyecto educativo de Tilat√°. Se acord√≥ visita de padres interesados para el 15 de marzo."
                            </small>
                        </div>

                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Nota:</strong> Las acciones registradas se utilizar√°n para an√°lisis de correlaci√≥n entre actividades realizadas y n√∫mero de aspirantes recibidos de cada jard√≠n.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>Guardar Acci√≥n
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: CONFIRMAR ELIMINACI√ìN -->
    <div class="modal fade" id="modalConfirmDelete" tabindex="-1" aria-labelledby="modalConfirmDeleteLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalConfirmDeleteLabel">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminaci√≥n
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¬øEst√° seguro de que desea eliminar esta acci√≥n?</p>
                    <p class="text-muted mb-0">Esta operaci√≥n no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmarEliminar()">
                        <i class="bi bi-trash me-1"></i>Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS - ORDEN CR√çTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let allActions = [];
        let allKindergartens = [];
        let actionToDelete = null;
        let modalAccion = null;
        let modalConfirmDelete = null;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üéØ Iniciando p√°gina de Acciones de Jardines...');
            
            try {
                showLoading();
                
                // Cargar colores corporativos
                if (typeof loadAndApplyBrandColors === 'function') {
                    await loadAndApplyBrandColors();
                }
                
                // Validar acceso (permiso debe existir en la BD)
                await validatePageAccess('Gestionar acciones de jardines');
                
                // Obtener sesi√≥n
                const session = getStoredSession();
                if (session && session.user) {
                    currentUser = session.user;
                    console.log('‚úÖ Usuario autenticado:', currentUser.user_full_name);
                }
                
                // Inicializar modales de Bootstrap
                modalAccion = new bootstrap.Modal(document.getElementById('modalAccion'));
                modalConfirmDelete = new bootstrap.Modal(document.getElementById('modalConfirmDelete'));
                
                // Cargar datos
                await cargarJardines();
                await cargarAcciones();
                
                hideLoading();
                console.log('‚úÖ P√°gina lista');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                hideLoading();
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGAR JARDINES
        // ==========================================
        async function cargarJardines() {
            try {
                console.log('üè´ Cargando jardines infantiles...');
                
                const kindergartens = await supabaseRequest(
                    '/aap_kindergartens?active_status=eq.active&select=kindergarten_id,kindergarten_name&order=kindergarten_name.asc'
                );
                
                if (!kindergartens || kindergartens.length === 0) {
                    showMessage('No hay jardines infantiles activos configurados', 'warning');
                    return;
                }
                
                allKindergartens = kindergartens;
                
                // Llenar select del modal
                const modalSelect = document.getElementById('kindergartenSelect');
                modalSelect.innerHTML = '<option value="">Seleccione un jard√≠n...</option>';
                
                // Llenar select de filtros
                const filterSelect = document.getElementById('filterKindergarten');
                filterSelect.innerHTML = '<option value="">Todos los jardines</option>';
                
                kindergartens.forEach(k => {
                    // Modal
                    const optionModal = document.createElement('option');
                    optionModal.value = k.kindergarten_id;
                    optionModal.textContent = k.kindergarten_name;
                    modalSelect.appendChild(optionModal);
                    
                    // Filtro
                    const optionFilter = document.createElement('option');
                    optionFilter.value = k.kindergarten_id;
                    optionFilter.textContent = k.kindergarten_name;
                    filterSelect.appendChild(optionFilter);
                });
                
                console.log(`‚úÖ ${kindergartens.length} jardines cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando jardines:', error);
                showMessage('Error al cargar jardines: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // CARGAR ACCIONES
        // ==========================================
        async function cargarAcciones() {
            try {
                showLoading();
                console.log('üìã Cargando acciones...');
                
                const actions = await supabaseRequest(
                    '/kindergarten_actions?select=*,aap_kindergartens(kindergarten_name),users(user_display_name)&order=action_date.desc,created_at.desc'
                );
                
                allActions = actions || [];
                
                console.log(`‚úÖ ${allActions.length} acciones cargadas`);
                
                renderizarAcciones(allActions);
                
                hideLoading();
                
            } catch (error) {
                console.error('‚ùå Error cargando acciones:', error);
                hideLoading();
                showMessage('Error al cargar acciones: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // RENDERIZAR ACCIONES
        // ==========================================
        function renderizarAcciones(actions) {
            const container = document.getElementById('actionsContainer');
            const countBadge = document.getElementById('actionCount');
            
            countBadge.textContent = actions.length;
            
            if (!actions || actions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-3">No hay acciones registradas</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            actions.forEach(action => {
                const card = document.createElement('div');
                card.className = 'action-card card mb-3';
                
                const formattedDate = new Date(action.action_date).toLocaleDateString('es-CO', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const createdBy = action.users?.user_display_name || 'Usuario desconocido';
                const kindergartenName = action.aap_kindergartens?.kindergarten_name || 'Jard√≠n no especificado';
                
                card.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="kindergarten-badge">${kindergartenName}</span>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editarAccion('${action.action_id}')" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="prepararEliminar('${action.action_id}')" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="action-date mb-2">
                            <i class="bi bi-calendar-event me-1"></i>${formattedDate}
                        </div>
                        
                        <div class="action-description mb-2">
                            ${action.action_description}
                        </div>
                        
                        <div class="action-meta">
                            <i class="bi bi-person me-1"></i>Registrado por: ${createdBy}
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // ==========================================
        // APLICAR FILTROS
        // ==========================================
        function aplicarFiltros() {
            const kindergartenFilter = document.getElementById('filterKindergarten').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            
            let filteredActions = [...allActions];
            
            // Filtrar por jard√≠n
            if (kindergartenFilter) {
                filteredActions = filteredActions.filter(a => a.kindergarten_id === kindergartenFilter);
            }
            
            // Filtrar por fecha desde
            if (dateFrom) {
                filteredActions = filteredActions.filter(a => a.action_date >= dateFrom);
            }
            
            // Filtrar por fecha hasta
            if (dateTo) {
                filteredActions = filteredActions.filter(a => a.action_date <= dateTo);
            }
            
            console.log(`üîç Filtros aplicados: ${filteredActions.length} de ${allActions.length} acciones`);
            
            renderizarAcciones(filteredActions);
        }

        // ==========================================
        // LIMPIAR FILTROS
        // ==========================================
        function limpiarFiltros() {
            document.getElementById('filterKindergarten').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            renderizarAcciones(allActions);
        }

        // ==========================================
        // ABRIR MODAL NUEVA ACCI√ìN
        // ==========================================
        function abrirModalNuevaAccion() {
            document.getElementById('formAccion').reset();
            document.getElementById('actionId').value = '';
            document.getElementById('modalTitle').textContent = 'Registrar Nueva Acci√≥n';
            
            // Establecer fecha de hoy por defecto
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('actionDate').value = today;
            
            modalAccion.show();
        }

        // ==========================================
        // EDITAR ACCI√ìN
        // ==========================================
        async function editarAccion(actionId) {
            try {
                showLoading();
                
                const action = allActions.find(a => a.action_id === actionId);
                
                if (!action) {
                    throw new Error('Acci√≥n no encontrada');
                }
                
                document.getElementById('actionId').value = action.action_id;
                document.getElementById('kindergartenSelect').value = action.kindergarten_id;
                document.getElementById('actionDate').value = action.action_date;
                document.getElementById('actionDescription').value = action.action_description;
                document.getElementById('modalTitle').textContent = 'Editar Acci√≥n';
                
                hideLoading();
                modalAccion.show();
                
            } catch (error) {
                console.error('‚ùå Error cargando acci√≥n:', error);
                hideLoading();
                showMessage('Error al cargar la acci√≥n: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // GUARDAR ACCI√ìN
        // ==========================================
        async function guardarAccion(event) {
            event.preventDefault();
            
            try {
                const actionId = document.getElementById('actionId').value;
                const kindergartenId = document.getElementById('kindergartenSelect').value;
                const actionDate = document.getElementById('actionDate').value;
                const actionDescription = document.getElementById('actionDescription').value.trim();
                
                // Validaciones
                if (!kindergartenId) {
                    showMessage('Debe seleccionar un jard√≠n infantil', 'warning');
                    return;
                }
                
                if (!actionDate) {
                    showMessage('Debe ingresar la fecha de la acci√≥n', 'warning');
                    return;
                }
                
                if (!actionDescription) {
                    showMessage('Debe ingresar la descripci√≥n de la acci√≥n', 'warning');
                    return;
                }
                
                showLoading();
                
                const actionData = {
                    kindergarten_id: kindergartenId,
                    action_date: actionDate,
                    action_description: actionDescription,
                    updated_at: new Date().toISOString()
                };
                
                if (actionId) {
                    // UPDATE
                    console.log('üìù Actualizando acci√≥n...');
                    
                    await supabaseRequest(
                        `/kindergarten_actions?action_id=eq.${actionId}`,
                        {
                            method: 'PATCH',
                            body: JSON.stringify(actionData)
                        }
                    );
                    
                    showMessage('Acci√≥n actualizada exitosamente', 'success');
                    
                } else {
                    // INSERT
                    console.log('‚ûï Creando nueva acci√≥n...');
                    
                    actionData.created_by = currentUser?.user_id;
                    
                    await supabaseRequest(
                        '/kindergarten_actions',
                        {
                            method: 'POST',
                            body: JSON.stringify(actionData)
                        }
                    );
                    
                    showMessage('Acci√≥n registrada exitosamente', 'success');
                }
                
                modalAccion.hide();
                await cargarAcciones();
                hideLoading();
                
            } catch (error) {
                console.error('‚ùå Error guardando acci√≥n:', error);
                hideLoading();
                showMessage('Error al guardar la acci√≥n: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // PREPARAR ELIMINAR
        // ==========================================
        function prepararEliminar(actionId) {
            actionToDelete = actionId;
            modalConfirmDelete.show();
        }

        // ==========================================
        // CONFIRMAR ELIMINAR
        // ==========================================
        async function confirmarEliminar() {
            if (!actionToDelete) return;
            
            try {
                showLoading();
                modalConfirmDelete.hide();
                
                console.log('üóëÔ∏è Eliminando acci√≥n...');
                
                await supabaseRequest(
                    `/kindergarten_actions?action_id=eq.${actionToDelete}`,
                    {
                        method: 'DELETE'
                    }
                );
                
                showMessage('Acci√≥n eliminada exitosamente', 'success');
                
                actionToDelete = null;
                await cargarAcciones();
                hideLoading();
                
            } catch (error) {
                console.error('‚ùå Error eliminando acci√≥n:', error);
                hideLoading();
                showMessage('Error al eliminar la acci√≥n: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // UTILIDADES DE LOADING
        // ==========================================
        function showLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
            }
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }

        // ==========================================
        // FUNCI√ìN DE MENSAJES
        // ==========================================
        function showMessage(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) return;
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alertDiv);
            
            // Auto-remove despu√©s de 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
            
            // Scroll al mensaje
            alertContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

    </script>
</body>
</html>
