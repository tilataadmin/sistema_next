<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nacimiento - Grados - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .grade-card {
            transition: all 0.2s ease;
            border-left: 4px solid #17a2b8;
        }
        
        .grade-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .section-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .badge-preescolar {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .badge-primaria {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-bachillerato {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Admisiones</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Nacimiento - Grados
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-calendar2-date me-2"></i>
                    Nacimiento - Grados
                </h1>
                <p class="text-muted">
                    Gestionar rangos de nacimiento requeridos para cada grado
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- FILTROS -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="filterSection" class="form-label">Filtrar por Secci√≥n</label>
                        <select class="form-select" id="filterSection">
                            <option value="">Todas las secciones</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="filterStatus" class="form-label">Estado</label>
                        <select class="form-select" id="filterStatus">
                            <option value="">Todos</option>
                            <option value="active">Activos</option>
                            <option value="inactive">Inactivos</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                            <i class="bi bi-x-circle me-1"></i>Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- GRID DE GRADOS -->
        <div id="gradesContainer" class="row g-3">
            <div class="col-12 text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <div class="mt-2">Cargando grados...</div>
            </div>
        </div>
    </div>
    <!-- MODAL EDITAR RANGO -->
    <div class="modal fade" id="modalEditRange" tabindex="-1" aria-labelledby="modalEditRangeLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditRangeLabel">
                        <i class="bi bi-pencil-square me-2"></i>Editar Rango de Nacimiento
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="formEditRange">
                    <div class="modal-body">
                        <input type="hidden" id="editGradeId">
                        
                        <!-- Informaci√≥n del Grado -->
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Secci√≥n:</strong> <span id="editGradeSectionName"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Grado:</strong> <span id="editGradeName"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campo de Rango -->
                        <div class="mb-3">
                            <label for="editAgeRange" class="form-label">
                                Rango de Nacimiento <span class="text-danger">*</span>
                            </label>
                            <textarea 
                                class="form-control" 
                                id="editAgeRange" 
                                name="age_range_description" 
                                rows="3"
                                placeholder="Ejemplo: Entre el 1 de enero de 2020 y el 31 de diciembre de 2020"
                                required></textarea>
                            <div class="form-text">
                                Describe claramente el rango de fechas de nacimiento requerido para este grado.
                            </div>
                        </div>
                        
                        <!-- Ejemplos de formato -->
                        <div class="alert alert-info mb-0">
                            <strong><i class="bi bi-lightbulb me-1"></i>Ejemplos de formato:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Entre el 1 de enero de 2020 y el 31 de diciembre de 2020</li>
                                <li>Nacidos entre enero y diciembre de 2019</li>
                                <li>Del 01/01/2018 al 31/12/2018</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPTS - ORDEN CR√çTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let gradesCache = [];
        let sectionsCache = [];
        let modalInstance = null;
        
        // ==========================================
        // INICIALIZACI√ìN - PATR√ìN OBLIGATORIO
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Nacimiento - grados');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                inicializarElementos();
                configurarEventos();
                
                await cargarSecciones();
                await cargarGrados();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // INICIALIZAR ELEMENTOS
        // ==========================================
        function inicializarElementos() {
            modalInstance = new bootstrap.Modal(document.getElementById('modalEditRange'));
            console.log('‚úÖ Elementos DOM inicializados');
        }
        
        // ==========================================
        // CONFIGURAR EVENTOS
        // ==========================================
        function configurarEventos() {
            document.getElementById('formEditRange').addEventListener('submit', manejarSubmitEditar);
            document.getElementById('filterSection').addEventListener('change', aplicarFiltros);
            document.getElementById('filterStatus').addEventListener('change', aplicarFiltros);
            
            console.log('‚úÖ Event listeners configurados');
        }
      // ==========================================
        // CARGAR SECCIONES
        // ==========================================
        async function cargarSecciones() {
            try {
                console.log('üì° Cargando secciones...');
                
                const data = await supabaseRequest('/sections?select=*&section_status=eq.active&order=section_name.asc');
                
                sectionsCache = data || [];
                
                const filterSelect = document.getElementById('filterSection');
                filterSelect.innerHTML = '<option value="">Todas las secciones</option>';
                
                sectionsCache.forEach(section => {
                    const option = document.createElement('option');
                    option.value = section.section_id;
                    option.textContent = section.section_name;
                    filterSelect.appendChild(option);
                });
                
                console.log(`‚úÖ ${sectionsCache.length} secciones cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando secciones:', error);
                showMessage('Error al cargar secciones: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // CARGAR GRADOS
        // ==========================================
        async function cargarGrados() {
            try {
                console.log('üì° Cargando grados...');
                
                const data = await supabaseRequest('/grades?select=grade_id,grade_name,grade_order,grade_status,age_range_description,section_id,sections(section_name)&order=sections(section_name).asc,grade_order.asc');
                
                gradesCache = data || [];
                renderizarGrados(gradesCache);
                
                console.log(`‚úÖ ${gradesCache.length} grados cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando grados:', error);
                showMessage('Error al cargar grados: ' + error.message, 'danger');
                
                document.getElementById('gradesContainer').innerHTML = `
                    <div class="col-12 text-center py-4">
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                        <div class="mt-2">Error al cargar grados</div>
                    </div>
                `;
            }
        }
        
        // ==========================================
        // RENDERIZAR GRADOS
        // ==========================================
        function renderizarGrados(grades) {
            const container = document.getElementById('gradesContainer');
            
            if (!grades || grades.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <div class="mt-2">No hay grados disponibles</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = grades.map(grade => {
                const sectionName = grade.sections?.section_name || 'Sin secci√≥n';
                const badgeClass = getSectionBadgeClass(sectionName);
                const hasRange = grade.age_range_description && grade.age_range_description.trim() !== '';
                const statusIcon = grade.grade_status === 'active' 
                    ? '<i class="bi bi-check-circle-fill text-success" title="Activo"></i>'
                    : '<i class="bi bi-x-circle-fill text-danger" title="Inactivo"></i>';
                
                return `
                    <div class="col-12 col-md-6 col-lg-4" data-section="${grade.section_id}" data-status="${grade.grade_status}">
                        <div class="card grade-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="section-badge ${badgeClass}">${escapeHtml(sectionName)}</span>
                                    ${statusIcon}
                                </div>
                                
                                <h5 class="card-title mb-3">${escapeHtml(grade.grade_name)}</h5>
                                
                                ${hasRange ? `
                                    <div class="alert alert-info mb-3">
                                        <small><strong><i class="bi bi-calendar-check me-1"></i>Rango de Nacimiento:</strong></small>
                                        <div class="mt-1">${escapeHtml(grade.age_range_description)}</div>
                                    </div>
                                ` : `
                                    <div class="alert alert-warning mb-3">
                                        <small><i class="bi bi-exclamation-triangle me-1"></i>Sin rango de nacimiento configurado</small>
                                    </div>
                                `}
                                
                                <button class="btn btn-sm btn-outline-primary w-100" onclick="editarRango('${grade.grade_id}')">
                                    <i class="bi bi-pencil me-1"></i>Editar Rango
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
      // ==========================================
        // OBTENER CLASE DE BADGE SEG√öN SECCI√ìN
        // ==========================================
        function getSectionBadgeClass(sectionName) {
            const name = sectionName.toLowerCase();
            if (name.includes('preescolar')) return 'badge-preescolar';
            if (name.includes('primaria')) return 'badge-primaria';
            if (name.includes('bachillerato')) return 'badge-bachillerato';
            return 'badge-preescolar';
        }
        
        // ==========================================
        // EDITAR RANGO
        // ==========================================
        function editarRango(gradeId) {
            const grade = gradesCache.find(g => g.grade_id === gradeId);
            if (!grade) {
                showMessage('No se encontr√≥ el grado', 'danger');
                return;
            }
            
            document.getElementById('editGradeId').value = grade.grade_id;
            document.getElementById('editGradeSectionName').textContent = grade.sections?.section_name || 'Sin secci√≥n';
            document.getElementById('editGradeName').textContent = grade.grade_name;
            document.getElementById('editAgeRange').value = grade.age_range_description || '';
            
            modalInstance.show();
        }
        
        // ==========================================
        // MANEJAR SUBMIT EDITAR
        // ==========================================
        async function manejarSubmitEditar(e) {
            e.preventDefault();
            
            try {
                mostrarLoading();
                
                const gradeId = document.getElementById('editGradeId').value;
                const ageRange = document.getElementById('editAgeRange').value.trim();
                
                await supabaseRequest('/grades?grade_id=eq.' + gradeId, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        age_range_description: ageRange
                    })
                });
                
                showMessage('Rango de nacimiento actualizado exitosamente', 'success');
                modalInstance.hide();
                await cargarGrados();
                
            } catch (error) {
                console.error('‚ùå Error actualizando rango:', error);
                showMessage('Error al actualizar: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // APLICAR FILTROS
        // ==========================================
        function aplicarFiltros() {
            const sectionFilter = document.getElementById('filterSection').value;
            const statusFilter = document.getElementById('filterStatus').value;
            
            let filteredGrades = [...gradesCache];
            
            if (sectionFilter) {
                filteredGrades = filteredGrades.filter(g => g.section_id === sectionFilter);
            }
            
            if (statusFilter) {
                filteredGrades = filteredGrades.filter(g => g.grade_status === statusFilter);
            }
            
            renderizarGrados(filteredGrades);
        }
        
        // ==========================================
        // LIMPIAR FILTROS
        // ==========================================
        function limpiarFiltros() {
            document.getElementById('filterSection').value = '';
            document.getElementById('filterStatus').value = '';
            renderizarGrados(gradesCache);
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.editarRango = editarRango;
        window.limpiarFiltros = limpiarFiltros;
        
        console.log('üéâ Grade Age Ranges cargado correctamente');
    </script>
</body>
</html>
