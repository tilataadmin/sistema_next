<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Admisi√≥n - Colegio Tilat√°</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Google reCAPTCHA v3 -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LdHQ9krAAAAAE-P00F35jrpqYfNSu_3U975A8--"></script>
    
    <style>
        /* Variables CSS que se actualizar√°n din√°micamente */
        :root {
            --primary-color: #17a2b8;
            --secondary-color: #138496;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        
        .form-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .logo-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .logo-header img {
            max-height: 80px;
            margin-bottom: 1rem;
        }
        
        .logo-header h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .intro-text {
            background: #d1ecf1;
            border-left: 4px solid var(--primary-color);
            padding: 1.25rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }
        
        .intro-text p {
            margin-bottom: 0.75rem;
            color: #0c5460;
        }
        
        .intro-text p:last-child {
            margin-bottom: 0;
        }
        
        .event-info {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            white-space: pre-line;
        }
        
        .event-info strong {
            color: #856404;
        }
        
        .consent-box {
            background: #f8f9fa;
            border: 2px solid var(--primary-color);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 8px;
        }
        
        .consent-box.rejected {
            border-color: #dc3545;
            background: #f8d7da;
        }
        
        .consent-text {
            font-size: 0.95rem;
            color: #495057;
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .consent-options {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
        }
        
        .consent-option {
            flex: 1;
        }
        
        .consent-option input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 0.5rem;
        }
        
        .consent-option label {
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
        }
        
        .consent-warning {
            display: none;
            background: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 4px;
        }
        
        .consent-warning.show {
            display: block;
        }
        
        .section-title {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            margin: 1.5rem 0 1rem 0;
            font-weight: 600;
        }
        
        .field-group {
            margin-bottom: 1.25rem;
        }
        
        .field-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .required {
            color: #dc3545;
        }
        
        .age-range-info {
            background: #d1ecf1;
            border-left: 4px solid var(--primary-color);
            padding: 0.75rem 1rem;
            margin-top: 0.5rem;
            border-radius: 4px;
        }
        
        .age-range-info small {
            color: #0c5460;
            font-weight: 500;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            padding: 0.75rem 2rem;
            font-weight: 600;
            font-size: 1.1rem;
            width: 100%;
            color: white;
        }
        
        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
        }
        
        .btn-submit:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .success-message {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .success-message i {
            font-size: 4rem;
            color: #28a745;
            margin-bottom: 1rem;
        }
        
        .recaptcha-badge {
            text-align: center;
            margin-top: 1rem;
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .conditional-field {
            display: none;
        }
        
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner-border {
            border-color: var(--primary-color);
            border-right-color: transparent;
        }
        
        @media (max-width: 768px) {
            .consent-options {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Spinner de carga -->
    <div id="spinner-overlay" class="spinner-overlay">
        <div class="spinner-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mb-0">Procesando solicitud...</p>
        </div>
    </div>

    <div class="container">
        <div class="form-container">
            <!-- Logo y encabezado -->
            <div class="logo-header">
                <img id="logo-colegio" src="" alt="Logo Colegio Tilat√°" style="display: none;">
                <h1>Formulario de Admisi√≥n</h1>
            </div>
            
            <!-- Textos introductorios din√°micos -->
            <div class="intro-text">
                <p id="intro-title" style="font-weight: 600;"></p>
                <p id="intro-text"></p>
            </div>
            
            <div class="event-info" id="event-info"></div>
            
            <!-- Contenedor de alertas -->
            <div id="alertContainer"></div>
            
            <!-- SECCI√ìN DE CONSENTIMIENTO - OBLIGATORIA -->
            <div class="consent-box" id="consent-box">
                <div class="consent-text">
                    <i class="bi bi-shield-check me-2" style="font-size: 1.2rem;"></i>
                    <strong>Autorizaci√≥n de tratamiento de datos personales</strong>
                    <p class="mt-2 mb-0">
                        Los datos recogidos en este formulario ser√°n usados √∫nica y exclusivamente 
                        para el proceso de admisi√≥n. Puede consultar nuestra pol√≠tica de protecci√≥n 
                        de datos en <a href="https://www.colegiotilata.edu.co" target="_blank">www.colegiotilata.edu.co</a>.
                    </p>
                </div>
                
                <div class="consent-options">
                    <div class="consent-option">
                        <input type="radio" name="data_consent" id="consent-yes" value="true" required>
                        <label for="consent-yes">
                            <i class="bi bi-check-circle text-success me-1"></i>
                            S√≠ acepto
                        </label>
                    </div>
                    <div class="consent-option">
                        <input type="radio" name="data_consent" id="consent-no" value="false">
                        <label for="consent-no">
                            <i class="bi bi-x-circle text-danger me-1"></i>
                            No acepto
                        </label>
                    </div>
                </div>
                
                <div class="consent-warning" id="consent-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Sin su autorizaci√≥n no podemos procesar su solicitud de admisi√≥n.</strong>
                    <p class="mb-0 mt-2">
                        Si tiene dudas sobre nuestra pol√≠tica de datos, puede consultarla en 
                        <a href="https://www.colegiotilata.edu.co" target="_blank">www.colegiotilata.edu.co</a>
                    </p>
                </div>
            </div>
            
            <!-- FORMULARIO -->
            <form id="admissions-form" style="display: block;">
                
                <!-- Secci√≥n 1: Informaci√≥n B√°sica -->
                <div class="section-title">
                    <i class="bi bi-info-circle me-2"></i>Informaci√≥n B√°sica
                </div>
                
                <!-- ¬øTiene otro hijo en Tilat√°? -->
                <div class="field-group">
                    <label>
                        ¬øTiene o tuvo otro/a hijo/a estudiando en Tilat√°? <span class="required">*</span>
                    </label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="has_sibling" id="sibling-yes" value="true" required>
                            <label class="form-check-label" for="sibling-yes">S√≠</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="has_sibling" id="sibling-no" value="false" required>
                            <label class="form-check-label" for="sibling-no">No</label>
                        </div>
                    </div>
                </div>
                
                <!-- Origen de la familia -->
                <div class="field-group">
                    <label>
                        Origen de la familia <span class="required">*</span>
                    </label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="family_origin" id="origin-col" value="Colombiana" required>
                            <label class="form-check-label" for="origin-col">Colombiana</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="family_origin" id="origin-ext" value="Extranjera" required>
                            <label class="form-check-label" for="origin-ext">Extranjera</label>
                        </div>
                    </div>
                </div>
                
                <!-- Secci√≥n a la que desea ingresar -->
                <div class="field-group">
                    <label for="target-section">
                        Secci√≥n a la que desea ingresar <span class="required">*</span>
                    </label>
                    <select class="form-select" id="target-section" name="target_section_id" required>
                        <option value="">Cargando secciones...</option>
                    </select>
                </div>
                <!-- Secci√≥n 2: Datos del Aspirante -->
                <div class="section-title">
                    <i class="bi bi-person me-2"></i>Datos del Aspirante
                </div>
                
                <!-- Nombres -->
                <div class="field-group">
                    <label for="applicant-first-name">
                        Nombres del aspirante <span class="required">*</span>
                    </label>
                    <input type="text" class="form-control" id="applicant-first-name" name="applicant_first_name" required>
                </div>
                
                <!-- Apellidos -->
                <div class="field-group">
                    <label for="applicant-last-name">
                        Apellidos del aspirante <span class="required">*</span>
                    </label>
                    <input type="text" class="form-control" id="applicant-last-name" name="applicant_last_name" required>
                    <small class="text-muted">Por favor incluya todos los apellidos</small>
                </div>
                
                <!-- Fecha de nacimiento -->
                <div class="field-group">
                    <label for="applicant-birthdate">
                        Fecha de nacimiento del aspirante <span class="required">*</span>
                    </label>
                    <input type="date" class="form-control" id="applicant-birthdate" name="applicant_birthdate" required>
                </div>
                
                <!-- Curso actual (condicional - no para Preescolar) -->
                <div class="field-group conditional-field" id="field-current-grade">
                    <label for="current-grade">
                        Curso actual <span class="required">*</span>
                    </label>
                    <select class="form-select" id="current-grade" name="current_grade_id">
                        <option value="">Seleccione el curso actual</option>
                    </select>
                </div>
                
                <!-- Curso al que aspira -->
                <div class="field-group">
                    <label for="target-grade">
                        Curso al que aspira <span class="required">*</span>
                    </label>
                    <select class="form-select" id="target-grade" name="target_grade_id" required>
                        <option value="">Primero seleccione la secci√≥n</option>
                    </select>
                    <div id="age-range-display" class="age-range-info" style="display: none;">
                        <i class="bi bi-calendar-check me-1"></i>
                        <small id="age-range-text"></small>
                    </div>
                </div>
                
                <!-- A√±o de ingreso -->
                <div class="field-group">
                    <label for="target-year">
                        A√±o en el que desea ingresar <span class="required">*</span>
                    </label>
                    <select class="form-select" id="target-year" name="target_academic_year_id" required>
                        <option value="">Cargando a√±os acad√©micos...</option>
                    </select>
                </div>
                
                <!-- Colegio/Jard√≠n actual -->
                <div class="field-group">
                    <label for="current-school">
                        <span id="current-school-label">Jard√≠n infantil/colegio actual</span> <span class="required">*</span>
                    </label>
                    <input type="text" class="form-control" id="current-school" name="current_school" required>
                </div>
                
                <!-- Calendario del colegio actual -->
                <div class="field-group">
                    <label for="current-calendar">
                        Calendario del colegio actual <span class="required">*</span>
                    </label>
                    <select class="form-select" id="current-calendar" name="current_school_calendar" required>
                        <option value="">Seleccione una opci√≥n</option>
                        <option value="Calendario A">Calendario A</option>
                        <option value="Calendario B">Calendario B</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                
                <!-- N√∫mero de grados del colegio actual -->
                <div class="field-group">
                    <label for="current-school-grades">
                        N√∫mero de grados del colegio actual <span class="required">*</span>
                    </label>
                    <select class="form-select" id="current-school-grades" name="current_school_total_grades" required>
                        <option value="">Seleccione una opci√≥n</option>
                        <option value="11 grados">11 grados</option>
                        <option value="12 grados">12 grados</option>
                        <option value="No aplica (Jard√≠n infantil)">No aplica (Jard√≠n infantil)</option>
                    </select>
                </div>
                
                <!-- Motivo del cambio (condicional - solo Primaria y Bachillerato) -->
                <div class="field-group conditional-field" id="field-change-reason">
                    <label for="change-reason">
                        Comparta con nosotros el motivo del cambio <span class="required">*</span>
                    </label>
                    <textarea class="form-control" id="change-reason" name="change_reason" rows="3"></textarea>
                </div>
                <!-- Secci√≥n 3: Datos del Familiar 1 -->
                <div class="section-title">
                    <i class="bi bi-person-heart me-2"></i>Datos del Familiar 1
                </div>
                
                <!-- Relaci√≥n Familiar 1 -->
                <div class="field-group">
                    <label>
                        Relaci√≥n del Familiar 1 con el aspirante <span class="required">*</span>
                    </label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="familiar1_relationship" id="fam1-mama" value="Mam√°" required>
                            <label class="form-check-label" for="fam1-mama">Mam√°</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="familiar1_relationship" id="fam1-papa" value="Pap√°" required>
                            <label class="form-check-label" for="fam1-papa">Pap√°</label>
                        </div>
                    </div>
                </div>
                
                <!-- Nombre Familiar 1 -->
                <div class="field-group">
                    <label for="familiar1-name">
                        Nombre completo del Familiar 1 <span class="required">*</span>
                    </label>
                    <input type="text" class="form-control" id="familiar1-name" name="familiar1_full_name" required>
                    <small class="text-muted">Por favor incluya todos los nombres y todos los apellidos</small>
                </div>
                
                <!-- Celular Familiar 1 -->
                <div class="field-group">
                    <label for="familiar1-phone">
                        Celular Familiar 1 <span class="required">*</span>
                    </label>
                    <input type="tel" class="form-control" id="familiar1-phone" name="familiar1_phone" required>
                </div>
                
                <!-- Correo Familiar 1 -->
                <div class="field-group">
                    <label for="familiar1-email">
                        Correo Familiar 1 <span class="required">*</span>
                    </label>
                    <input type="text" class="form-control" id="familiar1-email" name="familiar1_email" required>
                    <small class="text-muted">Recibir√° confirmaci√≥n de la solicitud en este correo</small>
                </div>
                
                <!-- Secci√≥n 4: Datos del Familiar 2 -->
                <div class="section-title">
                    <i class="bi bi-person-heart me-2"></i>Datos del Familiar 2
                </div>
                
                <!-- Relaci√≥n Familiar 2 -->
                <div class="field-group">
                    <label>
                        Relaci√≥n del Familiar 2 con el aspirante <span class="required">*</span>
                    </label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="familiar2_relationship" id="fam2-mama" value="Mam√°" required>
                            <label class="form-check-label" for="fam2-mama">Mam√°</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="familiar2_relationship" id="fam2-papa" value="Pap√°" required>
                            <label class="form-check-label" for="fam2-papa">Pap√°</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="familiar2_relationship" id="fam2-otro" value="Otro" required>
                            <label class="form-check-label" for="fam2-otro">Otro</label>
                        </div>
                    </div>
                </div>
                
                <!-- Nombre Familiar 2 -->
                <div class="field-group">
                    <label for="familiar2-name">
                        Nombre completo del Familiar 2 <span class="required">*</span>
                    </label>
                    <input type="text" class="form-control" id="familiar2-name" name="familiar2_full_name" required>
                    <small class="text-muted">Por favor incluya todos los nombres y todos los apellidos</small>
                </div>
                
                <!-- Celular Familiar 2 -->
                <div class="field-group">
                    <label for="familiar2-phone">
                        Celular Familiar 2 <span class="required">*</span>
                    </label>
                    <input type="tel" class="form-control" id="familiar2-phone" name="familiar2_phone" required>
                </div>
                
                <!-- Correo Familiar 2 -->
                <div class="field-group">
                    <label for="familiar2-email">
                        Correo Familiar 2 <span class="required">*</span>
                    </label>
                    <input type="text" class="form-control" id="familiar2-email" name="familiar2_email" required>
                </div>
                
                <!-- Secci√≥n 5: Referencias -->
                <div class="section-title">
                    <i class="bi bi-share me-2"></i>Referencias
                </div>
                
                <!-- ¬øEs referido? -->
                <div class="field-group">
                    <label>
                        ¬øEs usted referido? <span class="required">*</span>
                    </label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="is_referred" id="referred-yes" value="true" required>
                            <label class="form-check-label" for="referred-yes">S√≠</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="is_referred" id="referred-no" value="false" required>
                            <label class="form-check-label" for="referred-no">No</label>
                        </div>
                    </div>
                </div>
                
                <!-- Relaci√≥n con el referido (condicional) -->
                <div class="field-group conditional-field" id="field-referral-type">
                    <label for="referral-type">
                        Relaci√≥n con el referido <span class="required">*</span>
                    </label>
                    <select class="form-select" id="referral-type" name="referral_type_id">
                        <option value="">Cargando tipos de referidos...</option>
                    </select>
                </div>
                
                <!-- Medios por los que conoci√≥ el colegio -->
                <div class="field-group">
                    <label>
                        ¬øEn cu√°l de los siguientes medios o eventos nos ha visto presentes? <span class="required">*</span>
                    </label>
                    <small class="text-muted d-block mb-2">Puede seleccionar m√∫ltiples opciones</small>
                    <div id="contact-sources-container">
                        <p class="text-muted">Cargando opciones...</p>
                    </div>
                </div>
                
                <!-- Fecha de inscripci√≥n a charla -->
                <div class="field-group">
                    <label for="info-session">
                        Fecha de inscripci√≥n a la Charla Informativa - Entre Tilate√±os <span class="required">*</span>
                    </label>
                    <select class="form-select" id="info-session" name="info_session_date" required>
                        <option value="">Seleccione una opci√≥n</option>
                    </select>
                </div>
                
                <!-- Bot√≥n enviar -->
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-submit" id="submit-button" disabled>
                        <i class="bi bi-send me-2"></i>Enviar Solicitud de Admisi√≥n
                    </button>
                    <p class="text-muted mt-2 mb-0" id="consent-required-message">
                        <small><i class="bi bi-info-circle me-1"></i>Debe aceptar el tratamiento de datos para continuar</small>
                    </p>
                </div>
                
                <!-- Nota reCAPTCHA -->
                <div class="recaptcha-badge">
                    <i class="bi bi-shield-check"></i> Protegido por reCAPTCHA
                </div>
            </form>
            
            <!-- Mensaje de √©xito (oculto inicialmente) -->
            <div id="success-message" class="success-message">
                <i class="bi bi-check-circle-fill"></i>
                <h3>¬°Solicitud enviada exitosamente!</h3>
                <p>Tu solicitud de admisi√≥n ha sido registrada correctamente.</p>
                <div class="alert alert-info mt-3">
                    <p class="mb-2"><strong>¬øQu√© sigue?</strong></p>
                    <ul class="text-start mb-0">
                        <li>Recibir√°s un correo de confirmaci√≥n</li>
                        <li>Nuestro equipo de admisiones revisar√° tu solicitud</li>
                        <li>Te contactaremos pronto para continuar el proceso</li>
                    </ul>
                </div>
                <button class="btn btn-outline-primary mt-3" onclick="location.reload()">
                    <i class="bi bi-plus-circle me-2"></i>Enviar otra solicitud
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/config.js"></script>
    <script>
        // ==========================================
        // CONFIGURACI√ìN
        // ==========================================
        const RECAPTCHA_SITE_KEY = '6LdHQ9krAAAAAE-P00F35jrpqYfNSu_3U975A8--';
        
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let sectionsCache = [];
        let gradesCache = [];
        let academicYearsCache = [];
        let contactSourcesCache = [];
        let referralTypesCache = [];
        let systemConfig = null;
        let dataConsentGiven = false;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìù Inicializando formulario de admisiones...');
            
            try {
                await cargarConfiguracion();
                await cargarDatosIniciales();
                configurarEventos();
                
                console.log('‚úÖ Formulario inicializado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando formulario:', error);
                showMessage('Error al cargar el formulario. Por favor recarga la p√°gina.', 'danger');
            }
        });
        
        // ==========================================
        // CARGAR CONFIGURACI√ìN Y APLICAR COLORES
        // ==========================================
        async function cargarConfiguracion() {
            try {
                const config = await supabaseRequest('/system_config?select=logo_url,admissions_intro_title,admissions_intro_text,admissions_event_info,primary_color_hex,secondary_color_hex&limit=1');
                
                if (config && config.length > 0) {
                    systemConfig = config[0];
                    
                    // Aplicar colores corporativos
                    if (systemConfig.primary_color_hex) {
                        document.documentElement.style.setProperty('--primary-color', systemConfig.primary_color_hex);
                    }
                    if (systemConfig.secondary_color_hex) {
                        document.documentElement.style.setProperty('--secondary-color', systemConfig.secondary_color_hex);
                    }
                    
                    // Aplicar logo
                    if (systemConfig.logo_url) {
                        const logoImg = document.getElementById('logo-colegio');
                        logoImg.src = systemConfig.logo_url;
                        logoImg.style.display = 'block';
                    }
                    
                    // Aplicar textos
                    document.getElementById('intro-title').textContent = systemConfig.admissions_intro_title || '';
                    document.getElementById('intro-text').textContent = systemConfig.admissions_intro_text || '';
                    document.getElementById('event-info').textContent = systemConfig.admissions_event_info || '';
                }
                
                console.log('‚úÖ Configuraci√≥n y colores corporativos cargados');
                
            } catch (error) {
                console.error('Error cargando configuraci√≥n:', error);
            }
        }
        
        // ==========================================
        // CARGAR DATOS INICIALES
        // ==========================================
        async function cargarDatosIniciales() {
            await Promise.all([
                cargarSecciones(),
                cargarGrados(),
                cargarAnosAcademicos(),
                cargarMediosContacto(),
                cargarTiposReferidos()
            ]);
        }
        
        // ==========================================
        // CARGAR SECCIONES
        // ==========================================
        async function cargarSecciones() {
            try {
                const data = await supabaseRequest('/sections?select=section_id,section_name&section_status=eq.active&order=section_name.asc');
                
                sectionsCache = data || [];
                
                const select = document.getElementById('target-section');
                select.innerHTML = '<option value="">Seleccione una secci√≥n</option>';
                
                sectionsCache.forEach(section => {
                    const option = document.createElement('option');
                    option.value = section.section_id;
                    option.textContent = section.section_name;
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ ${sectionsCache.length} secciones cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando secciones:', error);
            }
        }
        
        // ==========================================
        // CARGAR GRADOS
        // ==========================================
        async function cargarGrados() {
            try {
                const data = await supabaseRequest('/grades?select=grade_id,grade_name,grade_order,section_id,age_range_description,sections(section_name)&grade_status=eq.active&order=grade_order.asc');
                
                gradesCache = data || [];
                
                gradesCache.sort((a, b) => {
                    const orderA = a.grade_order !== null && a.grade_order !== undefined ? Number(a.grade_order) : 999;
                    const orderB = b.grade_order !== null && b.grade_order !== undefined ? Number(b.grade_order) : 999;
                    return orderA - orderB;
                });
                
                console.log(`‚úÖ ${gradesCache.length} grados cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando grados:', error);
            }
        }
        
        // ==========================================
        // CARGAR A√ëOS ACAD√âMICOS
        // ==========================================
        async function cargarAnosAcademicos() {
            try {
                const config = await supabaseRequest('/system_config?select=current_academic_year_id&limit=1');
                const currentYearId = config[0]?.current_academic_year_id;
                
                const data = await supabaseRequest('/academic_years?select=year_id,year_name,year_order&year_status=eq.active&order=year_order.asc');
                
                if (!data || data.length === 0) {
                    throw new Error('No hay a√±os acad√©micos disponibles');
                }
                
                const currentIndex = data.findIndex(y => y.year_id === currentYearId);
                
                if (currentIndex !== -1) {
                    academicYearsCache = data.slice(currentIndex, currentIndex + 2);
                } else {
                    academicYearsCache = data.slice(0, 2);
                }
                
                const select = document.getElementById('target-year');
                select.innerHTML = '<option value="">Seleccione el a√±o</option>';
                
                academicYearsCache.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.year_id;
                    option.textContent = year.year_name;
                    select.appendChild(option);
                });
                
                // Cargar opciones de charla
                cargarOpcionesCharla();
                
                console.log(`‚úÖ ${academicYearsCache.length} a√±os acad√©micos disponibles`);
                
            } catch (error) {
                console.error('‚ùå Error cargando a√±os acad√©micos:', error);
                showMessage('Error cargando a√±os acad√©micos disponibles', 'warning');
            }
        }
        
        // ==========================================
        // CARGAR MEDIOS DE CONTACTO
        // ==========================================
        async function cargarMediosContacto() {
            try {
                const data = await supabaseRequest('/aap_contact_sources?select=source_id,source_name,source_order&is_active=eq.true&order=source_order.asc');
                
                contactSourcesCache = data || [];
                
                const container = document.getElementById('contact-sources-container');
                container.innerHTML = '';
                
                contactSourcesCache.forEach(source => {
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    div.innerHTML = `
                        <input class="form-check-input contact-source-check" type="checkbox" 
                               value="${source.source_id}" id="source-${source.source_id}">
                        <label class="form-check-label" for="source-${source.source_id}">
                            ${escapeHtml(source.source_name)}
                        </label>
                    `;
                    container.appendChild(div);
                });
                
                console.log(`‚úÖ ${contactSourcesCache.length} medios de contacto cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando medios de contacto:', error);
            }
        }
        
        // ==========================================
        // CARGAR TIPOS DE REFERIDOS
        // ==========================================
        async function cargarTiposReferidos() {
            try {
                const data = await supabaseRequest('/aap_referral_types?select=referral_type_id,type_name,type_order&is_active=eq.true&order=type_order.asc');
                
                referralTypesCache = data || [];
                
                const select = document.getElementById('referral-type');
                select.innerHTML = '<option value="">Seleccione una opci√≥n</option>';
                
                referralTypesCache.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.referral_type_id;
                    option.textContent = type.type_name;
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ ${referralTypesCache.length} tipos de referidos cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando tipos de referidos:', error);
            }
        }
        
        // ==========================================
        // CARGAR OPCIONES DE CHARLA
        // ==========================================
        function cargarOpcionesCharla() {
            const select = document.getElementById('info-session');
            
            select.innerHTML = '<option value="">Seleccione una opci√≥n</option>';
            
            academicYearsCache.forEach(year => {
                const option = document.createElement('option');
                option.value = `Ingreso a√±o acad√©mico ${year.year_name}`;
                option.textContent = `Ingreso a√±o acad√©mico ${year.year_name}`;
                select.appendChild(option);
            });
            
            const optionContact = document.createElement('option');
            optionContact.value = 'Nos comunicamos contigo directamente';
            optionContact.textContent = 'Nos comunicamos contigo directamente';
            select.appendChild(optionContact);
        }
        // ==========================================
        // CONFIGURAR EVENTOS
        // ==========================================
        function configurarEventos() {
            // Evento de consentimiento
            document.querySelectorAll('input[name="data_consent"]').forEach(radio => {
                radio.addEventListener('change', manejarCambioConsentimiento);
            });
            
            // Evento de cambio de secci√≥n
            document.getElementById('target-section').addEventListener('change', manejarCambioSeccion);
            
            // Evento de cambio de grado
            document.getElementById('target-grade').addEventListener('change', manejarCambioGrado);
            
            // Evento de cambio de referido
            document.querySelectorAll('input[name="is_referred"]').forEach(radio => {
                radio.addEventListener('change', manejarCambioReferido);
            });
            
            // Evento de env√≠o del formulario
            document.getElementById('admissions-form').addEventListener('submit', manejarEnvioFormulario);
        }
        
        // ==========================================
        // MANEJO DE CAMBIO DE CONSENTIMIENTO
        // ==========================================
        function manejarCambioConsentimiento(e) {
            const consentGiven = e.target.value === 'true';
            const consentBox = document.getElementById('consent-box');
            const consentWarning = document.getElementById('consent-warning');
            const submitButton = document.getElementById('submit-button');
            const consentMessage = document.getElementById('consent-required-message');
            
            if (consentGiven) {
                // Usuario acept√≥
                dataConsentGiven = true;
                consentBox.classList.remove('rejected');
                consentWarning.classList.remove('show');
                submitButton.disabled = false;
                consentMessage.style.display = 'none';
                console.log('‚úÖ Consentimiento de datos aceptado');
            } else {
                // Usuario NO acept√≥
                dataConsentGiven = false;
                consentBox.classList.add('rejected');
                consentWarning.classList.add('show');
                submitButton.disabled = true;
                consentMessage.style.display = 'block';
                console.log('‚ùå Consentimiento de datos rechazado');
            }
        }
        
        // ==========================================
        // MANEJO DE CAMBIO DE SECCI√ìN
        // ==========================================
        function manejarCambioSeccion(e) {
            const sectionId = e.target.value;
            
            if (!sectionId) {
                document.getElementById('target-grade').innerHTML = '<option value="">Primero seleccione la secci√≥n</option>';
                return;
            }
            
            const gradosPorSeccion = gradesCache.filter(g => g.section_id === sectionId);
            
            const selectGrade = document.getElementById('target-grade');
            selectGrade.innerHTML = '<option value="">Seleccione el grado</option>';
            
            gradosPorSeccion.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade.grade_id;
                option.textContent = grade.grade_name;
                option.dataset.ageRange = grade.age_range_description || '';
                selectGrade.appendChild(option);
            });
            
            const selectCurrentGrade = document.getElementById('current-grade');
            selectCurrentGrade.innerHTML = '<option value="">Seleccione el curso actual</option>';
            
            gradosPorSeccion.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade.grade_id;
                option.textContent = grade.grade_name;
                selectCurrentGrade.appendChild(option);
            });
            
            const section = sectionsCache.find(s => s.section_id === sectionId);
            const sectionName = section?.section_name.toLowerCase() || '';
            
            const fieldCurrentGrade = document.getElementById('field-current-grade');
            const fieldChangeReason = document.getElementById('field-change-reason');
            const inputCurrentGrade = document.getElementById('current-grade');
            const inputChangeReason = document.getElementById('change-reason');
            const labelCurrentSchool = document.getElementById('current-school-label');
            
            if (sectionName.includes('preescolar')) {
                // Preescolar: NO mostrar curso actual ni motivo de cambio
                fieldCurrentGrade.style.display = 'none';
                fieldChangeReason.style.display = 'none';
                inputCurrentGrade.removeAttribute('required');
                inputChangeReason.removeAttribute('required');
                labelCurrentSchool.textContent = 'Jard√≠n infantil actual';
            } else {
                // Primaria/Bachillerato: S√ç mostrar ambos campos
                fieldCurrentGrade.style.display = 'block';
                fieldChangeReason.style.display = 'block';
                inputCurrentGrade.setAttribute('required', 'required');
                inputChangeReason.setAttribute('required', 'required');
                labelCurrentSchool.textContent = 'Colegio actual';
            }
        }
        
        // ==========================================
        // MANEJO DE CAMBIO DE GRADO
        // ==========================================
        function manejarCambioGrado(e) {
            const gradeId = e.target.value;
            const ageRangeDisplay = document.getElementById('age-range-display');
            const ageRangeText = document.getElementById('age-range-text');
            
            if (!gradeId) {
                ageRangeDisplay.style.display = 'none';
                return;
            }
            
            const grade = gradesCache.find(g => g.grade_id === gradeId);
            
            if (grade && grade.age_range_description) {
                ageRangeText.textContent = `Rango de nacimiento: ${grade.age_range_description}`;
                ageRangeDisplay.style.display = 'block';
            } else {
                ageRangeDisplay.style.display = 'none';
            }
        }
        
        // ==========================================
        // MANEJO DE CAMBIO DE REFERIDO
        // ==========================================
        function manejarCambioReferido(e) {
            const isReferred = e.target.value === 'true';
            const fieldReferralType = document.getElementById('field-referral-type');
            const selectReferralType = document.getElementById('referral-type');
            
            if (isReferred) {
                fieldReferralType.style.display = 'block';
                selectReferralType.setAttribute('required', 'required');
            } else {
                fieldReferralType.style.display = 'none';
                selectReferralType.removeAttribute('required');
                selectReferralType.value = '';
            }
        }
        
        // ==========================================
        // ENV√çO DEL FORMULARIO
        // ==========================================
        async function manejarEnvioFormulario(e) {
            e.preventDefault();
            
            // Validaci√≥n del consentimiento
            if (!dataConsentGiven) {
                showMessage('Debe aceptar la pol√≠tica de tratamiento de datos para continuar', 'warning');
                document.getElementById('consent-box').scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            // Validar que haya al menos un medio de contacto seleccionado
            const contactSourcesChecked = document.querySelectorAll('.contact-source-check:checked');
            if (contactSourcesChecked.length === 0) {
                showMessage('Por favor selecciona al menos un medio por el cual conociste el colegio', 'warning');
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            try {
                document.getElementById('spinner-overlay').style.display = 'flex';
                submitBtn.disabled = true;
                
                console.log('üîê Obteniendo token reCAPTCHA...');
                const token = await grecaptcha.execute(RECAPTCHA_SITE_KEY, {action: 'submit'});
                console.log('‚úÖ Token reCAPTCHA obtenido');
                
                const formData = new FormData(e.target);
                
                const datos = {
                    data_consent: dataConsentGiven,
                    has_sibling_in_tilata: formData.get('has_sibling') === 'true',
                    family_origin: formData.get('family_origin'),
                    target_section_id: formData.get('target_section_id'),
                    applicant_first_name: formData.get('applicant_first_name'),
                    applicant_last_name: formData.get('applicant_last_name'),
                    applicant_birthdate: formData.get('applicant_birthdate'),
                    current_school: formData.get('current_school'),
                    current_school_calendar: formData.get('current_school_calendar'),
                    current_school_total_grades: formData.get('current_school_total_grades'),
                    current_grade_id: formData.get('current_grade_id') || null,
                    target_grade_id: formData.get('target_grade_id'),
                    target_academic_year_id: formData.get('target_academic_year_id'),
                    change_reason: formData.get('change_reason') || null,
                    familiar1_relationship: formData.get('familiar1_relationship'),
                    familiar1_full_name: formData.get('familiar1_full_name'),
                    familiar1_phone: formData.get('familiar1_phone'),
                    familiar1_email: formData.get('familiar1_email'),
                    familiar2_relationship: formData.get('familiar2_relationship'),
                    familiar2_full_name: formData.get('familiar2_full_name'),
                    familiar2_phone: formData.get('familiar2_phone'),
                    familiar2_email: formData.get('familiar2_email'),
                    is_referred: formData.get('is_referred') === 'true',
                    referral_type_id: formData.get('referral_type_id') || null,
                    info_session_date: formData.get('info_session_date'),
                    application_status: 'pending'
                };
                
                console.log('üì§ Enviando solicitud...');
                
                const resultado = await supabaseRequest('/aap_web_applications', {
                    method: 'POST',
                    body: JSON.stringify(datos)
                });
                
                const applicationId = resultado[0].application_id;
                console.log('‚úÖ Solicitud guardada con ID:', applicationId);
                
                await guardarMediosContacto(applicationId, contactSourcesChecked);
                await enviarNotificaciones(datos, applicationId);
                
                mostrarExito();
                
            } catch (error) {
                console.error('‚ùå Error enviando solicitud:', error);
                showMessage('Error al enviar la solicitud: ' + error.message, 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                document.getElementById('spinner-overlay').style.display = 'none';
            }
        }
        
        // ==========================================
        // GUARDAR MEDIOS DE CONTACTO
        // ==========================================
        async function guardarMediosContacto(applicationId, checkboxes) {
            try {
                const promises = [];
                
                checkboxes.forEach(checkbox => {
                    const sourceId = checkbox.value;
                    promises.push(
                        supabaseRequest('/aap_web_application_sources', {
                            method: 'POST',
                            body: JSON.stringify({
                                application_id: applicationId,
                                source_id: sourceId
                            })
                        })
                    );
                });
                
                await Promise.all(promises);
                console.log('‚úÖ Medios de contacto guardados');
                
            } catch (error) {
                console.error('‚ö†Ô∏è Error guardando medios de contacto:', error);
            }
        }
        
        // ==========================================
        // ENVIAR NOTIFICACIONES
        // ==========================================
        async function enviarNotificaciones(datos, applicationId) {
            try {
                console.log('üìß Enviando notificaciones...');
                
                const config = await supabaseRequest('/system_config?select=admissions_mail&limit=1');
                const admissionsMail = config[0]?.admissions_mail;
                
                if (!admissionsMail) {
                    console.warn('‚ö†Ô∏è No hay email configurado en system_config.admissions_mail');
                }
                
                const section = sectionsCache.find(s => s.section_id === datos.target_section_id);
                const grade = gradesCache.find(g => g.grade_id === datos.target_grade_id);
                const year = academicYearsCache.find(y => y.year_id === datos.target_academic_year_id);
                
                const datosCompletos = {
                    ...datos,
                    section_name: section?.section_name || '',
                    grade_name: grade?.grade_name || '',
                    year_name: year?.year_name || '',
                    application_id: applicationId
                };
                
                const emailContent = generarTemplateEmail(datosCompletos);
                
                await sendNotification(
                    datos.familiar1_email,
                    'Confirmaci√≥n - Solicitud de Admisi√≥n Colegio Tilat√°',
                    emailContent.familia,
                    true
                );
                
                if (datos.familiar2_email !== datos.familiar1_email) {
                    await sendNotification(
                        datos.familiar2_email,
                        'Confirmaci√≥n - Solicitud de Admisi√≥n Colegio Tilat√°',
                        emailContent.familia,
                        true
                    );
                }
                
                if (admissionsMail) {
                    await sendNotification(
                        admissionsMail,
                        `Nueva Solicitud de Admisi√≥n - ${datosCompletos.section_name}`,
                        emailContent.administrador,
                        true
                    );
                }
                
                console.log('‚úÖ Notificaciones enviadas');
                
            } catch (error) {
                console.error('‚ö†Ô∏è Error enviando notificaciones:', error);
            }
        }
        // ==========================================
        // GENERAR TEMPLATES DE EMAIL
        // ==========================================
        function generarTemplateEmail(datos) {
            const fecha = new Date().toLocaleDateString('es-CO', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const templateFamilia = `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                    <div style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
                        <h1 style="color: white; margin: 0;">Solicitud de Admisi√≥n Recibida</h1>
                    </div>
                    <div style="background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 10px 10px;">
                        <h2 style="color: #17a2b8; margin-top: 0;">¬°Gracias por tu inter√©s en el Colegio Tilat√°!</h2>
                        <p>Estimada familia <strong>${escapeHtml(datos.familiar1_full_name)}</strong>,</p>
                        <p>Hemos recibido exitosamente la solicitud de admisi√≥n para <strong>${escapeHtml(datos.applicant_first_name)} ${escapeHtml(datos.applicant_last_name)}</strong>.</p>
                        <div style="background: #d1ecf1; padding: 20px; border-left: 4px solid #17a2b8; margin: 20px 0;">
                            <h3 style="color: #17a2b8; margin: 0 0 10px 0;">Resumen de la Solicitud</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 8px 0; color: #666;"><strong>Aspirante:</strong></td><td style="padding: 8px 0;">${escapeHtml(datos.applicant_first_name)} ${escapeHtml(datos.applicant_last_name)}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666;"><strong>Secci√≥n:</strong></td><td style="padding: 8px 0;">${escapeHtml(datos.section_name)}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666;"><strong>Grado:</strong></td><td style="padding: 8px 0;">${escapeHtml(datos.grade_name)}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666;"><strong>A√±o de ingreso:</strong></td><td style="padding: 8px 0;">${escapeHtml(datos.year_name)}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666;"><strong>Fecha:</strong></td><td style="padding: 8px 0;">${fecha}</td></tr>
                            </table>
                        </div>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0;">
                            <p style="margin: 0; color: #856404;"><strong>Pr√≥ximos pasos:</strong></p>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px; color: #856404;">
                                <li>Nuestro equipo de admisiones revisar√° tu solicitud</li>
                                <li>Te contactaremos pronto para continuar el proceso</li>
                                <li>Recibir√°s informaci√≥n sobre las charlas informativas</li>
                            </ul>
                        </div>
                        <p>Si tienes alguna pregunta, no dudes en contactarnos.</p>
                        <p style="color: #666; font-size: 14px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                            Este es un correo autom√°tico. Por favor no respondas a este mensaje.<br><strong>Colegio Tilat√°</strong> - Proceso de Admisiones
                        </p>
                    </div>
                </div>
            `;
            
            const templateAdministrador = `
                <div style="font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; padding: 20px;">
                    <div style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
                        <h1 style="color: white; margin: 0;">Nueva Solicitud de Admisi√≥n</h1>
                    </div>
                    <div style="background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 10px 10px;">
                        <div style="background: #d1ecf1; padding: 15px; border-left: 4px solid #17a2b8; margin-bottom: 20px;">
                            <p style="margin: 0; color: #0c5460;"><strong>ID de Aplicaci√≥n:</strong> ${datos.application_id}</p>
                        </div>
                        <h3 style="color: #17a2b8;">Datos del Aspirante</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <tr><td style="padding: 10px; border-bottom: 1px solid #e0e0e0; color: #666; width: 35%;"><strong>Nombre:</strong></td><td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">${escapeHtml(datos.applicant_first_name)} ${escapeHtml(datos.applicant_last_name)}</td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #e0e0e0; color: #666;"><strong>Fecha de nacimiento:</strong></td><td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">${datos.applicant_birthdate}</td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #e0e0e0; color: #666;"><strong>Secci√≥n:</strong></td><td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">${escapeHtml(datos.section_name)}</td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #e0e0e0; color: #666;"><strong>Grado objetivo:</strong></td><td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">${escapeHtml(datos.grade_name)}</td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #e0e0e0; color: #666;"><strong>A√±o de ingreso:</strong></td><td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">${escapeHtml(datos.year_name)}</td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #e0e0e0; color: #666;"><strong>Colegio actual:</strong></td><td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">${escapeHtml(datos.current_school)}</td></tr>
                        </table>
                        <h3 style="color: #17a2b8;">Datos de Contacto</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <tr><td style="padding: 10px; border-bottom: 1px solid #e0e0e0; color: #666; width: 35%;"><strong>Familiar 1:</strong></td><td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">${escapeHtml(datos.familiar1_full_name)} (${datos.familiar1_relationship})</td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #e0e0e0; color: #666;"><strong>Tel√©fono 1:</strong></td><td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">${datos.familiar1_phone}</td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #e0e0e0; color: #666;"><strong>Email 1:</strong></td><td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">${datos.familiar1_email}</td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #e0e0e0; color: #666;"><strong>Familiar 2:</strong></td><td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">${escapeHtml(datos.familiar2_full_name)} (${datos.familiar2_relationship})</td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #e0e0e0; color: #666;"><strong>Tel√©fono 2:</strong></td><td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">${datos.familiar2_phone}</td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid #e0e0e0; color: #666;"><strong>Email 2:</strong></td><td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">${datos.familiar2_email}</td></tr>
                        </table>
                        ${datos.change_reason ? `<h3 style="color: #17a2b8;">Motivo del Cambio</h3><div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;"><p style="margin: 0;">${escapeHtml(datos.change_reason)}</p></div>` : ''}
                        <div style="background: #d1f2eb; padding: 15px; border-radius: 5px; margin: 20px 0;">
                            <p style="margin: 0; color: #0c5460;"><strong>Origen:</strong> ${datos.family_origin}</p>
                            <p style="margin: 5px 0 0 0; color: #0c5460;"><strong>Tiene hermanos en Tilat√°:</strong> ${datos.has_sibling_in_tilata ? 'S√≠' : 'No'}</p>
                            <p style="margin: 5px 0 0 0; color: #0c5460;"><strong>Es referido:</strong> ${datos.is_referred ? 'S√≠' : 'No'}</p>
                        </div>
                        <div style="text-align: center; margin-top: 30px;">
                            <p style="color: #666;">Ingresa a SchoolNet para gestionar esta solicitud:</p>
                            <a href="${window.location.origin}/modules/admissions/applicants.html" style="display: inline-block; background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; margin-top: 10px;">Ver Solicitudes de Admisi√≥n</a>
                        </div>
                        <p style="color: #666; font-size: 14px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">Este es un correo autom√°tico generado por SchoolNet.<br><strong>Proceso de Admisiones</strong> - Colegio Tilat√°</p>
                    </div>
                </div>
            `;
            
            return { familia: templateFamilia, administrador: templateAdministrador };
        }
        
        // ==========================================
        // MOSTRAR √âXITO
        // ==========================================
        function mostrarExito() {
            document.getElementById('admissions-form').style.display = 'none';
            document.getElementById('success-message').style.display = 'block';
            document.getElementById('spinner-overlay').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ==========================================
        // FUNCI√ìN DE ESCAPE HTML
        // ==========================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        console.log('‚úÖ Script del formulario de admisiones cargado');
    </script>
</body>
</html>
