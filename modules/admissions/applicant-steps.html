<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pasos por Aspirante - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para timeline de pasos */
        .step-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .step-item {
            position: relative;
            padding-bottom: 2rem;
            border-left: 2px solid #dee2e6;
        }

        .step-item:last-child {
            border-left: 2px solid transparent;
            padding-bottom: 0;
        }

        .step-marker {
            position: absolute;
            left: -1.5rem;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            z-index: 1;
        }

        .step-marker.completed {
            background-color: #198754;
            color: white;
        }

        .step-marker.in-progress {
            background-color: #0dcaf0;
            color: white;
        }

        .step-marker.not-applicable {
            background-color: #6c757d;
            color: white;
        }

        .step-marker.pending {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            color: #6c757d;
        }

        .step-content {
            margin-left: 1.5rem;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .step-content:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            cursor: pointer;
        }

        .badge-result {
            font-size: 0.85rem;
            padding: 0.35rem 0.75rem;
        }

        .applicant-info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .applicant-search {
            position: relative;
        }

        .applicant-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }

        .applicant-dropdown.show {
            display: block;
        }

        .applicant-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .applicant-option:hover {
            background-color: #f8f9fa;
        }

        .applicant-option:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Admisiones</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gestión de Pasos por Aspirante
                </li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Gestión de Pasos por Aspirante
                </h1>
                <p class="text-muted">
                    Seguimiento del proceso de admisión para cada aspirante
                </p>
            </div>
        </div>

        <!-- Contenedor de Alertas -->
        <div id="alertContainer"></div>

        <!-- Sección de Búsqueda y Selección de Aspirante -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-search me-2"></i>Seleccionar Aspirante
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="searchApplicant" class="form-label">Buscar por nombre o apellido</label>
                        <div class="applicant-search">
                            <input type="text" 
                                   class="form-control" 
                                   id="searchApplicant" 
                                   placeholder="Escribe para buscar...">
                            <div id="applicantDropdown" class="applicant-dropdown"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="filterYear" class="form-label">Filtrar por año académico</label>
                        <select class="form-select" id="filterYear">
                            <option value="">Todos los años</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información del Aspirante Seleccionado -->
        <div id="applicantInfoSection" style="display: none;">
            <div class="applicant-info-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-1" id="applicantName"></h4>
                        <div class="d-flex gap-3 flex-wrap">
                            <span><i class="bi bi-calendar3 me-1"></i><span id="applicantAge"></span></span>
                            <span><i class="bi bi-telephone me-1"></i><span id="applicantPhone"></span></span>
                            <span><i class="bi bi-envelope me-1"></i><span id="applicantEmail"></span></span>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <span class="badge bg-light text-dark fs-6" id="applicantState"></span>
                        <div class="mt-2">
                            <small class="opacity-75">Año: <span id="applicantYear"></span></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline de Pasos del Proceso -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check me-2"></i>Pasos del Proceso
                    </h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="actualizarPasos()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                </div>
                <div class="card-body">
                    <div id="stepsContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <div class="mt-2">Cargando pasos del proceso...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje cuando no hay aspirante seleccionado -->
        <div id="noApplicantSelected" class="text-center py-5">
            <i class="bi bi-person-x" style="font-size: 4rem; color: #dee2e6;"></i>
            <h5 class="text-muted mt-3">Selecciona un aspirante para ver sus pasos</h5>
            <p class="text-muted">Usa el buscador de arriba para encontrar un aspirante</p>
        </div>

    </div>
    <!-- Modal para Editar Paso -->
    <div class="modal fade" id="modalEditStep" tabindex="-1" aria-labelledby="modalEditStepLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditStepLabel">
                        <i class="bi bi-pencil-square me-2"></i>Editar Paso del Proceso
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="formEditStep">
                    <div class="modal-body">
                        <!-- Información del paso -->
                        <div class="alert alert-info">
                            <strong id="stepNameDisplay"></strong>
                            <p class="mb-0 mt-1" id="stepDescriptionDisplay"></p>
                        </div>

                        <input type="hidden" id="editApplicantId">
                        <input type="hidden" id="editStepId">

                        <div class="row">
                            <!-- Estado del paso -->
                            <div class="col-md-6 mb-3">
                                <label for="stepStatus" class="form-label">
                                    Estado del Paso <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="stepStatus" required>
                                    <option value="">Seleccione...</option>
                                    <option value="Completado">Completado</option>
                                    <option value="En progreso">En progreso</option>
                                    <option value="No aplica">No aplica</option>
                                </select>
                            </div>

                            <!-- Resultado del paso -->
                            <div class="col-md-6 mb-3">
                                <label for="stepResult" class="form-label">
                                    Resultado
                                </label>
                                <select class="form-select" id="stepResult">
                                    <option value="">Sin resultado aún</option>
                                    <option value="Aprobado">Aprobado</option>
                                    <option value="Rechazado">Rechazado</option>
                                    <option value="Pendiente">Pendiente</option>
                                </select>
                                <small class="text-muted">Solo aplicable cuando el estado es "Completado"</small>
                            </div>
                        </div>

                        <!-- Fecha de completación -->
                        <div class="mb-3">
                            <label for="stepCompletionDate" class="form-label">
                                Fecha de Completación
                            </label>
                            <input type="date" 
                                   class="form-control" 
                                   id="stepCompletionDate"
                                   max="">
                            <small class="text-muted">Dejar vacío si el paso aún no se ha completado</small>
                        </div>

                        <!-- Notas del paso -->
                        <div class="mb-3">
                            <label for="stepNotes" class="form-label">
                                Notas y Observaciones
                            </label>
                            <textarea class="form-control" 
                                      id="stepNotes" 
                                      rows="4"
                                      placeholder="Agrega notas relevantes sobre este paso..."></textarea>
                            <small class="text-muted">
                                Información adicional, comentarios o detalles importantes
                            </small>
                        </div>

                        <!-- Información de auditoría -->
                        <div class="border-top pt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                <span id="auditInfo">Información de registro no disponible</span>
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let applicantsList = [];
        let processSteps = [];
        let currentApplicantId = null;
        let currentApplicantSteps = [];
        let modalEditStepInstance = null;
        let academicYears = [];

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Gestión de pasos por aspirante');
                if (!hasAccess) {
                    console.log('❌ Acceso denegado');
                    return;
                }
                
                console.log('✅ Acceso permitido - inicializando página');
                await inicializarPagina();
                
            } catch (error) {
                console.error('❌ Error en validación:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });

        // ==========================================
        // INICIALIZACIÓN DE PÁGINA
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Inicializar modal
                modalEditStepInstance = new bootstrap.Modal(document.getElementById('modalEditStep'));
                
                // Establecer fecha máxima en el campo de fecha
                document.getElementById('stepCompletionDate').max = new Date().toISOString().split('T')[0];
                
                // Configurar event listeners
                configurarEventListeners();
                
                // Cargar datos iniciales
                await cargarDatosIniciales();
                
                ocultarLoading();
                console.log('✅ Página inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // CONFIGURAR EVENT LISTENERS
        // ==========================================
        function configurarEventListeners() {
            // Búsqueda de aspirantes
            const searchInput = document.getElementById('searchApplicant');
            searchInput.addEventListener('input', filtrarAspirantes);
            searchInput.addEventListener('focus', () => {
                if (searchInput.value.trim()) {
                    filtrarAspirantes();
                }
            });
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.applicant-search')) {
                    document.getElementById('applicantDropdown').classList.remove('show');
                }
            });

            // Filtro por año académico
            document.getElementById('filterYear').addEventListener('change', filtrarAspirantes);

            // Formulario de edición
            document.getElementById('formEditStep').addEventListener('submit', manejarSubmitEditarPaso);

            // Lógica para resultado según estado
            document.getElementById('stepStatus').addEventListener('change', function() {
                const resultField = document.getElementById('stepResult');
                if (this.value === 'Completado') {
                    resultField.disabled = false;
                } else {
                    resultField.value = '';
                    resultField.disabled = true;
                }
            });

            console.log('✅ Event listeners configurados');
        }

         // ==========================================
        // CARGA DE DATOS INICIALES - CORREGIDO
        // ==========================================
        async function cargarDatosIniciales() {
            try {
                console.log('📡 Cargando datos iniciales...');
                
                // Cargar años académicos para filtro
                academicYears = await supabaseRequest('/academic_years?select=*&order=year_order.desc');
                renderizarFiltroAnos(academicYears);
                
                // Cargar todos los aspirantes con información relacionada - INCLUIR year_id
                applicantsList = await supabaseRequest('/aap_applicants?select=applicant_id,applicant_first_name,applicant_last_name,applicant_age,contact_phone,contact_email,academic_year_id,academic_years(year_id,year_name),aap_process_states(state_name)&order=applicant_last_name.asc,applicant_first_name.asc');
                
                // Cargar todos los pasos del proceso
                processSteps = await supabaseRequest('/aap_process_steps?select=*&is_active=eq.true&order=step_order.asc');
                
                console.log(`✅ Datos cargados: ${applicantsList.length} aspirantes, ${processSteps.length} pasos`);
                
            } catch (error) {
                console.error('❌ Error cargando datos:', error);
                showMessage('Error al cargar datos iniciales: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // RENDERIZAR FILTRO DE AÑOS
        // ==========================================
        function renderizarFiltroAnos(years) {
            const select = document.getElementById('filterYear');
            const currentOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            select.appendChild(currentOption);
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year.year_id;
                option.textContent = year.year_name;
                if (year.is_current) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

         // ==========================================
        // FILTRAR Y MOSTRAR ASPIRANTES - CORREGIDO
        // ==========================================
        function filtrarAspirantes() {
            const searchTerm = document.getElementById('searchApplicant').value.toLowerCase().trim();
            const selectedYear = document.getElementById('filterYear').value;
            const dropdown = document.getElementById('applicantDropdown');
            
            if (!searchTerm) {
                dropdown.classList.remove('show');
                return;
            }
            
            // Filtrar aspirantes
            let filtered = applicantsList.filter(applicant => {
                const fullName = `${applicant.applicant_first_name} ${applicant.applicant_last_name}`.toLowerCase();
                const matchesSearch = fullName.includes(searchTerm);
                
                // Comparar con academic_year_id del aspirante
                const matchesYear = !selectedYear || applicant.academic_year_id === selectedYear;
                
                return matchesSearch && matchesYear;
            });
            
            // Mostrar resultados
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="applicant-option text-muted">No se encontraron aspirantes</div>';
            } else {
                dropdown.innerHTML = filtered.map(applicant => `
                    <div class="applicant-option" onclick="seleccionarAspirante('${applicant.applicant_id}')">
                        <strong>${escapeHtml(applicant.applicant_first_name)} ${escapeHtml(applicant.applicant_last_name)}</strong>
                        <br>
                        <small class="text-muted">
                            ${applicant.academic_years?.year_name || 'Sin año'} | 
                            ${applicant.aap_process_states?.state_name || 'Sin estado'}
                        </small>
                    </div>
                `).join('');
            }
            
            dropdown.classList.add('show');
        }

        
      // ==========================================
        // SELECCIONAR ASPIRANTE
        // ==========================================
        async function seleccionarAspirante(applicantId) {
            try {
                mostrarLoading();
                
                currentApplicantId = applicantId;
                
                // Cerrar dropdown
                document.getElementById('applicantDropdown').classList.remove('show');
                
                // Obtener información completa del aspirante
                const applicantData = await supabaseRequest('/aap_applicants?select=*,academic_years(year_name),aap_process_states(state_name)&applicant_id=eq.' + applicantId);
                
                if (!applicantData || applicantData.length === 0) {
                    throw new Error('No se encontró el aspirante');
                }
                
                const applicant = applicantData[0];
                
                // Mostrar información del aspirante
                mostrarInformacionAspirante(applicant);
                
                // Cargar pasos del aspirante
                await cargarPasosAspirante(applicantId);
                
                // Mostrar sección de pasos
                document.getElementById('noApplicantSelected').style.display = 'none';
                document.getElementById('applicantInfoSection').style.display = 'block';
                
                ocultarLoading();
                
            } catch (error) {
                console.error('❌ Error seleccionando aspirante:', error);
                showMessage('Error al cargar información del aspirante: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // MOSTRAR INFORMACIÓN DEL ASPIRANTE
        // ==========================================
        function mostrarInformacionAspirante(applicant) {
            document.getElementById('applicantName').textContent = 
                `${applicant.applicant_first_name} ${applicant.applicant_last_name}`;
            
            document.getElementById('applicantAge').textContent = 
                applicant.applicant_age ? `${applicant.applicant_age} años` : 'Edad no especificada';
            
            document.getElementById('applicantPhone').textContent = 
                applicant.contact_phone || 'No disponible';
            
            document.getElementById('applicantEmail').textContent = 
                applicant.contact_email || 'No disponible';
            
            document.getElementById('applicantState').textContent = 
                applicant.aap_process_states?.state_name || 'Sin estado';
            
            document.getElementById('applicantYear').textContent = 
                applicant.academic_years?.year_name || 'Sin año';
        }

        // ==========================================
        // CARGAR PASOS DEL ASPIRANTE
        // ==========================================
        async function cargarPasosAspirante(applicantId) {
            try {
                console.log('📡 Cargando pasos del aspirante...');
                
                // Cargar pasos existentes del aspirante
                const existingSteps = await supabaseRequest('/aap_applicant_steps?select=*&applicant_id=eq.' + applicantId);
                
                // Crear mapa de pasos existentes
                const stepsMap = {};
                existingSteps.forEach(step => {
                    stepsMap[step.step_id] = step;
                });
                
                // Combinar con todos los pasos del proceso
                currentApplicantSteps = processSteps.map(processStep => {
                    const existingStep = stepsMap[processStep.step_id];
                    
                    return {
                        step_id: processStep.step_id,
                        step_name: processStep.step_name,
                        step_description: processStep.step_description,
                        step_order: processStep.step_order,
                        is_mandatory: processStep.is_mandatory,
                        step_status: existingStep?.step_status || null,
                        step_completion_date: existingStep?.step_completion_date || null,
                        step_notes: existingStep?.step_notes || null,
                        step_result: existingStep?.step_result || null,
                        created_at: existingStep?.created_at || null,
                        updated_at: existingStep?.updated_at || null
                    };
                });
                
                renderizarPasos();
                
                console.log('✅ Pasos del aspirante cargados');
                
            } catch (error) {
                console.error('❌ Error cargando pasos:', error);
                showMessage('Error al cargar pasos del aspirante: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // RENDERIZAR TIMELINE DE PASOS
        // ==========================================
        function renderizarPasos() {
            const container = document.getElementById('stepsContainer');
            
            if (currentApplicantSteps.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">No hay pasos configurados en el proceso</p>
                    </div>
                `;
                return;
            }
            
            const html = `
                <div class="step-timeline">
                    ${currentApplicantSteps.map(step => renderizarPasoItem(step)).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }

        // ==========================================
        // RENDERIZAR ITEM DE PASO
        // ==========================================
        function renderizarPasoItem(step) {
            // Determinar clase y contenido del marcador
            let markerClass = 'pending';
            let markerIcon = step.step_order;
            
            if (step.step_status === 'Completado') {
                markerClass = 'completed';
                markerIcon = '<i class="bi bi-check-lg"></i>';
            } else if (step.step_status === 'En progreso') {
                markerClass = 'in-progress';
                markerIcon = '<i class="bi bi-arrow-repeat"></i>';
            } else if (step.step_status === 'No aplica') {
                markerClass = 'not-applicable';
                markerIcon = '<i class="bi bi-dash-lg"></i>';
            }
            
            // Badge de resultado si existe
            let resultBadge = '';
            if (step.step_result) {
                const resultColors = {
                    'Aprobado': 'success',
                    'Rechazado': 'danger',
                    'Pendiente': 'warning'
                };
                const colorClass = resultColors[step.step_result] || 'secondary';
                resultBadge = `<span class="badge bg-${colorClass} badge-result">${escapeHtml(step.step_result)}</span>`;
            }
            
            // Información de fecha
            let dateInfo = '';
            if (step.step_completion_date) {
                dateInfo = `
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="bi bi-calendar-check me-1"></i>
                            Completado: ${formatDate(step.step_completion_date)}
                        </small>
                    </div>
                `;
            }
            
            // Notas
            let notesInfo = '';
            if (step.step_notes) {
                const shortNotes = step.step_notes.length > 100 
                    ? step.step_notes.substring(0, 100) + '...' 
                    : step.step_notes;
                notesInfo = `
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="bi bi-sticky me-1"></i>
                            ${escapeHtml(shortNotes)}
                        </small>
                    </div>
                `;
            }
            
            // Badge de obligatorio
            const mandatoryBadge = step.is_mandatory 
                ? '<span class="badge bg-secondary ms-2">Obligatorio</span>' 
                : '';
            
            return `
                <div class="step-item">
                    <div class="step-marker ${markerClass}">
                        ${markerIcon}
                    </div>
                    <div class="step-content" onclick="abrirModalEditarPaso('${step.step_id}')">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">
                                    ${escapeHtml(step.step_name)}
                                    ${mandatoryBadge}
                                </h6>
                                <p class="text-muted mb-0 small">${escapeHtml(step.step_description || 'Sin descripción')}</p>
                            </div>
                            <div class="text-end">
                                ${resultBadge}
                                ${step.step_status ? `<div class="mt-1"><small class="text-muted">${escapeHtml(step.step_status)}</small></div>` : ''}
                            </div>
                        </div>
                        ${dateInfo}
                        ${notesInfo}
                    </div>
                </div>
            `;
        }
      // ==========================================
        // ABRIR MODAL PARA EDITAR PASO
        // ==========================================
        function abrirModalEditarPaso(stepId) {
            const step = currentApplicantSteps.find(s => s.step_id === stepId);
            
            if (!step) {
                showMessage('No se encontró el paso seleccionado', 'danger');
                return;
            }
            
            // Llenar información del paso
            document.getElementById('stepNameDisplay').textContent = step.step_name;
            document.getElementById('stepDescriptionDisplay').textContent = 
                step.step_description || 'Sin descripción disponible';
            
            // Campos ocultos
            document.getElementById('editApplicantId').value = currentApplicantId;
            document.getElementById('editStepId').value = stepId;
            
            // Campos del formulario
            document.getElementById('stepStatus').value = step.step_status || '';
            document.getElementById('stepResult').value = step.step_result || '';
            document.getElementById('stepCompletionDate').value = step.step_completion_date || '';
            document.getElementById('stepNotes').value = step.step_notes || '';
            
            // Habilitar/deshabilitar campo de resultado según estado
            const resultField = document.getElementById('stepResult');
            resultField.disabled = step.step_status !== 'Completado';
            
            // Información de auditoría
            let auditText = 'Sin registro previo';
            if (step.created_at) {
                auditText = `Creado: ${formatDate(step.created_at)}`;
                if (step.updated_at && step.updated_at !== step.created_at) {
                    auditText += ` | Actualizado: ${formatDate(step.updated_at)}`;
                }
            }
            document.getElementById('auditInfo').textContent = auditText;
            
            // Mostrar modal
            modalEditStepInstance.show();
        }

        // ==========================================
        // MANEJAR SUBMIT DE EDICIÓN DE PASO
        // ==========================================
        async function manejarSubmitEditarPaso(e) {
            e.preventDefault();
            
            try {
                mostrarLoading();
                
                const applicantId = document.getElementById('editApplicantId').value;
                const stepId = document.getElementById('editStepId').value;
                const stepStatus = document.getElementById('stepStatus').value;
                const stepResult = document.getElementById('stepResult').value;
                const stepCompletionDate = document.getElementById('stepCompletionDate').value;
                const stepNotes = document.getElementById('stepNotes').value.trim();
                
                // Validaciones
                if (!stepStatus) {
                    showMessage('Debes seleccionar un estado para el paso', 'warning');
                    ocultarLoading();
                    return;
                }
                
                // Si está completado, debe tener fecha
                if (stepStatus === 'Completado' && !stepCompletionDate) {
                    showMessage('Debes especificar la fecha de completación', 'warning');
                    ocultarLoading();
                    return;
                }
                
                // Preparar datos
                const stepData = {
                    applicant_id: applicantId,
                    step_id: stepId,
                    step_status: stepStatus,
                    step_completion_date: stepCompletionDate || null,
                    step_notes: stepNotes || null,
                    step_result: (stepStatus === 'Completado' && stepResult) ? stepResult : null
                };
                
                // Verificar si ya existe el registro
                const existingStep = await supabaseRequest('/aap_applicant_steps?select=*&applicant_id=eq.' + applicantId + '&step_id=eq.' + stepId);
                
                if (existingStep && existingStep.length > 0) {
                    // Actualizar registro existente
                    await supabaseRequest('/aap_applicant_steps?applicant_id=eq.' + applicantId + '&step_id=eq.' + stepId, {
                        method: 'PATCH',
                        body: JSON.stringify(stepData)
                    });
                    showMessage('Paso actualizado exitosamente', 'success');
                } else {
                    // Crear nuevo registro
                    await supabaseRequest('/aap_applicant_steps', {
                        method: 'POST',
                        body: JSON.stringify(stepData)
                    });
                    showMessage('Paso registrado exitosamente', 'success');
                }
                
                // Cerrar modal
                modalEditStepInstance.hide();
                
                // Recargar pasos del aspirante
                await cargarPasosAspirante(currentApplicantId);
                
                ocultarLoading();
                
            } catch (error) {
                console.error('❌ Error guardando paso:', error);
                showMessage('Error al guardar el paso: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // ACTUALIZAR PASOS (BOTÓN REFRESCAR)
        // ==========================================
        async function actualizarPasos() {
            if (!currentApplicantId) {
                showMessage('No hay aspirante seleccionado', 'warning');
                return;
            }
            
            try {
                mostrarLoading();
                await cargarPasosAspirante(currentApplicantId);
                showMessage('Pasos actualizados', 'success');
                ocultarLoading();
            } catch (error) {
                console.error('❌ Error actualizando pasos:', error);
                showMessage('Error al actualizar pasos: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
      // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.seleccionarAspirante = seleccionarAspirante;
        window.abrirModalEditarPaso = abrirModalEditarPaso;
        window.actualizarPasos = actualizarPasos;
        
        console.log('🎉 Gestión de Pasos por Aspirante cargado correctamente');
    </script>
</body>
</html>
