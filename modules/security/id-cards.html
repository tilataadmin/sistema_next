<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.01.06.25">
    <title>Gesti√≥n de Carnets - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: #dee2e6;
            color: #495057;
        }
        
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            border-bottom-color: #0d6efd;
            background: transparent;
        }
        
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        
        .badge-rfid {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .rfid-input {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            letter-spacing: 1px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .search-highlight {
            background-color: #fff3cd;
            padding: 0.1rem 0.2rem;
            border-radius: 2px;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div>Procesando...</div>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Seguridad</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gesti√≥n de Carnets
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-credit-card-2-front me-2"></i>
                    Gesti√≥n de Carnets
                </h1>
                <p class="text-muted">
                    Registro de c√≥digos RFID de carnets para trabajadores y estudiantes
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- TABS PRINCIPALES -->
        <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="workers-tab" data-bs-toggle="tab" 
                        data-bs-target="#workers" type="button" role="tab">
                    <i class="bi bi-people me-2"></i>Trabajadores
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="students-tab" data-bs-toggle="tab" 
                        data-bs-target="#students" type="button" role="tab">
                    <i class="bi bi-mortarboard me-2"></i>Estudiantes
                </button>
            </li>
        </ul>

        <!-- CONTENIDO DE TABS -->
        <div class="tab-content" id="mainTabsContent">
            
            <!-- TAB: TRABAJADORES -->
            <div class="tab-pane fade show active" id="workers" role="tabpanel">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-people me-2"></i>Carnets de Trabajadores
                        </h5>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm" 
                                   id="searchWorkers" placeholder="Buscar trabajador..."
                                   style="width: 250px;">
                            <button class="btn btn-sm btn-secondary" onclick="loadWorkers()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Trabajador</th>
                                        <th>Documento</th>
                                        <th>C√≥digo RFID</th>
                                        <th>Estado</th>
                                        <th style="width: 150px;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="workersTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas Trabajadores -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="bi bi-people text-primary" style="font-size: 2rem;"></i>
                                <h4 class="mt-2 mb-1" id="totalWorkers">-</h4>
                                <small class="text-muted">Total Trabajadores</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                                <h4 class="mt-2 mb-1" id="workersWithRFID">-</h4>
                                <small class="text-muted">Con C√≥digo RFID</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="bi bi-x-circle text-warning" style="font-size: 2rem;"></i>
                                <h4 class="mt-2 mb-1" id="workersWithoutRFID">-</h4>
                                <small class="text-muted">Sin C√≥digo RFID</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: ESTUDIANTES -->
            <div class="tab-pane fade" id="students" role="tabpanel">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-mortarboard me-2"></i>Carnets de Estudiantes
                        </h5>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm" 
                                   id="searchStudents" placeholder="Buscar estudiante..."
                                   style="width: 250px;">
                            <button class="btn btn-sm btn-secondary" onclick="loadStudents()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Estudiante</th>
                                        <th>C√≥digo</th>
                                        <th>Documento</th>
                                        <th>C√≥digo RFID</th>
                                        <th>Estado</th>
                                        <th style="width: 150px;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas Estudiantes -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="bi bi-mortarboard text-primary" style="font-size: 2rem;"></i>
                                <h4 class="mt-2 mb-1" id="totalStudents">-</h4>
                                <small class="text-muted">Total Estudiantes</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                                <h4 class="mt-2 mb-1" id="studentsWithRFID">-</h4>
                                <small class="text-muted">Con C√≥digo RFID</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="bi bi-x-circle text-warning" style="font-size: 2rem;"></i>
                                <h4 class="mt-2 mb-1" id="studentsWithoutRFID">-</h4>
                                <small class="text-muted">Sin C√≥digo RFID</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Asignar/Editar C√≥digo RFID -->
    <div class="modal fade" id="rfidModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rfidModalTitle">
                        <i class="bi bi-credit-card me-2"></i>Asignar C√≥digo RFID
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="rfidForm">
                    <div class="modal-body">
                        <input type="hidden" id="entityType"> <!-- 'worker' o 'student' -->
                        <input type="hidden" id="entityId">
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Persona:</strong> <span id="entityName"></span>
                        </div>

                        <div class="mb-3">
                            <label for="rfidCode" class="form-label">
                                C√≥digo RFID del Carnet <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control rfid-input" id="rfidCode" 
                                   name="rfid_code" required maxlength="50"
                                   placeholder="Escanea el carnet o ingresa el c√≥digo manualmente"
                                   autocomplete="off">
                            <small class="text-muted">
                                Puedes usar un scanner RFID o ingresar el c√≥digo manualmente
                            </small>
                        </div>

                        <div class="alert alert-warning" id="duplicateWarning" style="display: none;">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Este c√≥digo ya est√° asignado a otra persona
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" id="saveRFIDBtn">
                            <i class="bi bi-save me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let allWorkers = [];
        let allStudents = [];
        let currentEntityType = null;
        let currentEntityId = null;
        let rfidModal = null;
        let searchTimeoutWorkers = null;
        let searchTimeoutStudents = null;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Gesti√≥n de carnets');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - inicializando p√°gina');
                await initializePage();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });

        async function initializePage() {
            try {
                showLoading();
                
                // Inicializar modal
                rfidModal = new bootstrap.Modal(document.getElementById('rfidModal'));
                
                // Configurar eventos
                setupEventListeners();
                
                // Cargar trabajadores por defecto
                await loadWorkers();
                
                hideLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                hideLoading();
            }
        }

        function setupEventListeners() {
            // B√∫squeda trabajadores con debounce
            document.getElementById('searchWorkers').addEventListener('input', function(e) {
                clearTimeout(searchTimeoutWorkers);
                searchTimeoutWorkers = setTimeout(() => {
                    filterWorkers(e.target.value);
                }, 300);
            });

            // B√∫squeda estudiantes con debounce
            document.getElementById('searchStudents').addEventListener('input', function(e) {
                clearTimeout(searchTimeoutStudents);
                searchTimeoutStudents = setTimeout(() => {
                    filterStudents(e.target.value);
                }, 300);
            });

            // Validaci√≥n en tiempo real del c√≥digo RFID
            document.getElementById('rfidCode').addEventListener('input', debounce(validateRFIDCode, 500));

            // Submit del formulario
            document.getElementById('rfidForm').addEventListener('submit', handleSaveRFID);

            // Cambio de tab - cargar estudiantes al activar
            document.getElementById('students-tab').addEventListener('shown.bs.tab', function() {
                if (allStudents.length === 0) {
                    loadStudents();
                }
            });

            // Fix del s√≠mbolo @ en inputs
            setTimeout(() => {
                const inputs = document.querySelectorAll('input[type="text"]');
                inputs.forEach(input => {
                    input.addEventListener('keydown', e => e.stopPropagation(), true);
                    input.addEventListener('keypress', e => e.stopPropagation(), true);
                    input.addEventListener('keyup', e => e.stopPropagation(), true);
                });
            }, 500);
        }

        // ==========================================
        // CARGA DE DATOS - TRABAJADORES
        // ==========================================
        
        async function loadWorkers() {
            try {
                showLoading();
                
                const workers = await supabaseRequest('/workers?select=worker_id,worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2,worker_rfid_code,worker_status&order=worker_last_name_1.asc,worker_first_name.asc');
                
                allWorkers = workers || [];
                renderWorkers(allWorkers);
                updateWorkersStats();
                
                hideLoading();
                
            } catch (error) {
                console.error('‚ùå Error cargando trabajadores:', error);
                showMessage('Error al cargar trabajadores: ' + error.message, 'danger');
                hideLoading();
            }
        }

        function renderWorkers(workers) {
            const tbody = document.getElementById('workersTableBody');
            
            if (!workers || workers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <div class="mt-2 text-muted">No se encontraron trabajadores</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = workers.map(worker => {
                const fullName = `${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''} ${worker.worker_first_name}`.trim();
                const hasRFID = worker.worker_rfid_code && worker.worker_rfid_code.trim() !== '';
                
                return `
                    <tr>
                        <td><strong>${escapeHtml(fullName)}</strong></td>
                        <td>${escapeHtml(worker.worker_id_doc || '-')}</td>
                        <td>
                            ${hasRFID ? 
                                `<span class="badge bg-success badge-rfid">${escapeHtml(worker.worker_rfid_code)}</span>` : 
                                `<span class="badge bg-secondary">Sin c√≥digo</span>`
                            }
                        </td>
                        <td>
                            <span class="badge ${getStatusClass(worker.worker_status)} status-badge">
                                ${getStatusText(worker.worker_status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm ${hasRFID ? 'btn-outline-warning' : 'btn-outline-primary'}" 
                                    onclick="openRFIDModal('worker', '${worker.worker_id}', '${escapeHtml(fullName)}', '${worker.worker_rfid_code || ''}')"
                                    title="${hasRFID ? 'Editar c√≥digo RFID' : 'Asignar c√≥digo RFID'}">
                                <i class="bi bi-${hasRFID ? 'pencil' : 'plus-circle'}"></i>
                            </button>
                            ${hasRFID ? `
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="removeRFID('worker', '${worker.worker_id}', '${escapeHtml(fullName)}')"
                                        title="Eliminar c√≥digo RFID">
                                    <i class="bi bi-trash"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateWorkersStats() {
            const total = allWorkers.length;
            const withRFID = allWorkers.filter(w => w.worker_rfid_code && w.worker_rfid_code.trim() !== '').length;
            const withoutRFID = total - withRFID;
            
            document.getElementById('totalWorkers').textContent = total;
            document.getElementById('workersWithRFID').textContent = withRFID;
            document.getElementById('workersWithoutRFID').textContent = withoutRFID;
        }

        function filterWorkers(searchTerm) {
            searchTerm = searchTerm.toLowerCase().trim();
            
            if (!searchTerm) {
                renderWorkers(allWorkers);
                return;
            }
            
            const filtered = allWorkers.filter(worker => {
                const fullName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.toLowerCase();
                const doc = (worker.worker_id_doc || '').toLowerCase();
                const rfid = (worker.worker_rfid_code || '').toLowerCase();
                
                return fullName.includes(searchTerm) || doc.includes(searchTerm) || rfid.includes(searchTerm);
            });
            
            renderWorkers(filtered);
        }

        // ==========================================
        // CARGA DE DATOS - ESTUDIANTES
        // ==========================================
        
        async function loadStudents() {
            try {
                showLoading();
                
                const students = await supabaseRequest('/students?select=student_id,student_code,student_id_document,student_first_name,student_last_name_1,student_last_name_2,student_rfid_code,status_id,student_status(status_description)&order=student_last_name_1.asc,student_first_name.asc');
                
                allStudents = students || [];
                renderStudents(allStudents);
                updateStudentsStats();
                
                hideLoading();
                
            } catch (error) {
                console.error('‚ùå Error cargando estudiantes:', error);
                showMessage('Error al cargar estudiantes: ' + error.message, 'danger');
                hideLoading();
            }
        }

        function renderStudents(students) {
            const tbody = document.getElementById('studentsTableBody');
            
            if (!students || students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <div class="mt-2 text-muted">No se encontraron estudiantes</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = students.map(student => {
                const fullName = `${student.student_last_name_1} ${student.student_last_name_2 || ''} ${student.student_first_name}`.trim();
                const hasRFID = student.student_rfid_code && student.student_rfid_code.trim() !== '';
                const statusDesc = student.student_status?.status_description || 'Sin estado';
                
                return `
                    <tr>
                        <td><strong>${escapeHtml(fullName)}</strong></td>
                        <td>${student.student_code}</td>
                        <td>${escapeHtml(student.student_id_document || '-')}</td>
                        <td>
                            ${hasRFID ? 
                                `<span class="badge bg-success badge-rfid">${escapeHtml(student.student_rfid_code)}</span>` : 
                                `<span class="badge bg-secondary">Sin c√≥digo</span>`
                            }
                        </td>
                        <td>
                            <span class="badge bg-info status-badge">${escapeHtml(statusDesc)}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm ${hasRFID ? 'btn-outline-warning' : 'btn-outline-primary'}" 
                                    onclick="openRFIDModal('student', '${student.student_id}', '${escapeHtml(fullName)}', '${student.student_rfid_code || ''}')"
                                    title="${hasRFID ? 'Editar c√≥digo RFID' : 'Asignar c√≥digo RFID'}">
                                <i class="bi bi-${hasRFID ? 'pencil' : 'plus-circle'}"></i>
                            </button>
                            ${hasRFID ? `
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="removeRFID('student', '${student.student_id}', '${escapeHtml(fullName)}')"
                                        title="Eliminar c√≥digo RFID">
                                    <i class="bi bi-trash"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStudentsStats() {
            const total = allStudents.length;
            const withRFID = allStudents.filter(s => s.student_rfid_code && s.student_rfid_code.trim() !== '').length;
            const withoutRFID = total - withRFID;
            
            document.getElementById('totalStudents').textContent = total;
            document.getElementById('studentsWithRFID').textContent = withRFID;
            document.getElementById('studentsWithoutRFID').textContent = withoutRFID;
        }

        function filterStudents(searchTerm) {
            searchTerm = searchTerm.toLowerCase().trim();
            
            if (!searchTerm) {
                renderStudents(allStudents);
                return;
            }
            
            const filtered = allStudents.filter(student => {
                const fullName = `${student.student_first_name} ${student.student_last_name_1} ${student.student_last_name_2 || ''}`.toLowerCase();
                const code = student.student_code.toString();
                const doc = (student.student_id_document || '').toLowerCase();
                const rfid = (student.student_rfid_code || '').toLowerCase();
                
                return fullName.includes(searchTerm) || code.includes(searchTerm) || doc.includes(searchTerm) || rfid.includes(searchTerm);
            });
            
            renderStudents(filtered);
        }

        // ==========================================
        // MODAL Y FORMULARIO
        // ==========================================
        
        function openRFIDModal(entityType, entityId, entityName, currentRFID) {
            currentEntityType = entityType;
            currentEntityId = entityId;
            
            document.getElementById('entityType').value = entityType;
            document.getElementById('entityId').value = entityId;
            document.getElementById('entityName').textContent = entityName;
            document.getElementById('rfidCode').value = currentRFID || '';
            document.getElementById('duplicateWarning').style.display = 'none';
            
            const isEdit = currentRFID && currentRFID.trim() !== '';
            document.getElementById('rfidModalTitle').innerHTML = `
                <i class="bi bi-credit-card me-2"></i>
                ${isEdit ? 'Editar' : 'Asignar'} C√≥digo RFID
            `;
            
            rfidModal.show();
            
            setTimeout(() => {
                document.getElementById('rfidCode').focus();
                document.getElementById('rfidCode').select();
            }, 300);
        }

        async function validateRFIDCode() {
            const rfidCode = document.getElementById('rfidCode').value.trim();
            const warning = document.getElementById('duplicateWarning');
            
            if (!rfidCode) {
                warning.style.display = 'none';
                return true;
            }
            
            try {
                // Buscar en trabajadores
                const workersCheck = await supabaseRequest(`/workers?select=worker_id,worker_first_name,worker_last_name_1&worker_rfid_code=eq.${encodeURIComponent(rfidCode)}`);
                
                // Buscar en estudiantes
                const studentsCheck = await supabaseRequest(`/students?select=student_id,student_first_name,student_last_name_1&student_rfid_code=eq.${encodeURIComponent(rfidCode)}`);
                
                const isDuplicate = (workersCheck && workersCheck.length > 0 && workersCheck[0].worker_id !== currentEntityId) ||
                                   (studentsCheck && studentsCheck.length > 0 && studentsCheck[0].student_id.toString() !== currentEntityId);
                
                warning.style.display = isDuplicate ? 'block' : 'none';
                
                return !isDuplicate;
                
            } catch (error) {
                console.error('Error validando c√≥digo RFID:', error);
                return true; // Permitir continuar si falla la validaci√≥n
            }
        }

        async function handleSaveRFID(e) {
            e.preventDefault();
            
            try {
                const rfidCode = document.getElementById('rfidCode').value.trim();
                
                if (!rfidCode) {
                    showMessage('El c√≥digo RFID es requerido', 'warning');
                    return;
                }
                
                // Validar duplicados
                const isValid = await validateRFIDCode();
                if (!isValid) {
                    showMessage('Este c√≥digo ya est√° asignado a otra persona', 'danger');
                    return;
                }
                
                showLoading();
                
                const entityType = document.getElementById('entityType').value;
                const entityId = document.getElementById('entityId').value;
                
                if (entityType === 'worker') {
                    await supabaseRequest(`/workers?worker_id=eq.${entityId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            worker_rfid_code: rfidCode,
                            updated_at: new Date().toISOString()
                        })
                    });
                    await loadWorkers();
                } else if (entityType === 'student') {
                    await supabaseRequest(`/students?student_id=eq.${entityId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            student_rfid_code: rfidCode,
                            updated_at: new Date().toISOString()
                        })
                    });
                    await loadStudents();
                }
                
                showMessage('C√≥digo RFID guardado exitosamente', 'success');
                rfidModal.hide();
                hideLoading();
                
            } catch (error) {
                console.error('‚ùå Error guardando c√≥digo RFID:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
                hideLoading();
            }
        }

        async function removeRFID(entityType, entityId, entityName) {
            if (!confirm(`¬øEliminar el c√≥digo RFID de ${entityName}?`)) {
                return;
            }
            
            try {
                showLoading();
                
                if (entityType === 'worker') {
                    await supabaseRequest(`/workers?worker_id=eq.${entityId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            worker_rfid_code: null,
                            updated_at: new Date().toISOString()
                        })
                    });
                    await loadWorkers();
                } else if (entityType === 'student') {
                    await supabaseRequest(`/students?student_id=eq.${entityId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            student_rfid_code: null,
                            updated_at: new Date().toISOString()
                        })
                    });
                    await loadStudents();
                }
                
                showMessage('C√≥digo RFID eliminado exitosamente', 'success');
                hideLoading();
                
            } catch (error) {
                console.error('‚ùå Error eliminando c√≥digo RFID:', error);
                showMessage('Error al eliminar: ' + error.message, 'danger');
                hideLoading();
            }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function showMessage(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            
            const icons = {
                success: 'check-circle',
                danger: 'exclamation-triangle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            container.innerHTML = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${icons[type]} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function getStatusClass(status) {
            const classes = {
                'active': 'bg-success',
                'inactive': 'bg-danger',
                'suspended': 'bg-warning'
            };
            return classes[status] || 'bg-secondary';
        }

        function getStatusText(status) {
            const texts = {
                'active': 'Activo',
                'inactive': 'Inactivo',
                'suspended': 'Suspendido'
            };
            return texts[status] || status;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        // Hacer funciones disponibles globalmente
        window.openRFIDModal = openRFIDModal;
        window.removeRFID = removeRFID;
        window.loadWorkers = loadWorkers;
        window.loadStudents = loadStudents;

        console.log('‚úÖ Gesti√≥n de Carnets cargada correctamente');
    </script>
</body>
</html>
