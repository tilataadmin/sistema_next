<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Usuarios - SchoolNet</title>
    
    <!-- Bootstrap Grid + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap-grid.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <!-- Nuestros estilos principales -->
    <link href="../../assets/css/main.css" rel="stylesheet">
    
    <style>
        .user-card {
            background: var(--white-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .user-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            background: var(--primary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: bold;
            margin-right: 1rem;
        }
        
        .user-info h5 {
            margin: 0;
            color: var(--text-dark);
        }
        
        .user-info p {
            margin: 0.25rem 0 0 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-active {
            background-color: var(--success-light);
            color: var(--success-color);
        }
        
        .status-inactive {
            background-color: var(--danger-light);
            color: var(--danger-color);
        }
        
        .status-suspended {
            background-color: var(--warning-light);
            color: var(--warning-color);
        }
        
        .user-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-icon {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background: white;
            color: var(--text-muted);
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .btn-icon:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .search-filters {
            background: var(--light-bg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .role-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .role-tag {
            background: var(--primary-light);
            color: var(--primary-color);
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            border: 1px solid var(--primary-color);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .loading-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        
        .loading-state .spinner-border {
            margin-bottom: 1rem;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: 0;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 1rem;
            justify-content: end;
        }
        
        .form-section {
            margin-bottom: 1.5rem;
        }
        
        .form-section h6 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 0.5rem;
        }
        
        .required {
            color: var(--danger-color);
        }
        
        .password-input-group {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: none;
            color: var(--text-muted);
            cursor: pointer;
        }
        
        .roles-selection {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            background: var(--light-bg);
        }
        
        .role-option {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            margin-bottom: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .role-option:hover {
            background: var(--primary-light);
        }
        
        .role-option input[type="checkbox"] {
            margin-right: 0.75rem;
        }
        
        .role-option label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }
        
        .role-description {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="main-container">
            <nav class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">SchoolNet</h4>
                    <span class="text-muted">Gesti√≥n de Usuarios</span>
                </div>
                <a href="index.html" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Volver al M√≥dulo
                </a>
            </nav>
        </div>
    </div>

    <div class="main-container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <span class="breadcrumb-item">Seguridad</span>
            <span class="breadcrumb-item active">Gesti√≥n de Usuarios</span>
        </nav>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Controles superiores -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h5 class="mb-1">Usuarios del Sistema</h5>
                <p class="text-muted mb-0">Gestiona usuarios, roles y permisos de acceso</p>
            </div>
            <button class="btn btn-primary" onclick="openCreateUserModal()">
                <i class="bi bi-plus-circle me-1"></i>Crear Usuario
            </button>
        </div>

        <!-- Filtros de b√∫squeda -->
        <div class="search-filters">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Buscar usuarios</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="Nombre, email o usuario..." 
                               onkeyup="filterUsers()">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label class="form-label">Estado</label>
                    <select class="form-select" id="statusFilter" onchange="filterUsers()">
                        <option value="">Todos los estados</option>
                        <option value="active">Activos</option>
                        <option value="inactive">Inactivos</option>
                        <option value="suspended">Suspendidos</option>
                    </select>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label class="form-label">Proveedor de autenticaci√≥n</label>
                    <select class="form-select" id="providerFilter" onchange="filterUsers()">
                        <option value="">Todos los proveedores</option>
                        <option value="local">Local</option>
                        <option value="google">Google</option>
                        <option value="microsoft">Microsoft</option>
                        <option value="github">GitHub</option>
                    </select>
                </div>
                
                <div class="col-md-2 mb-3 d-flex align-items-end">
                    <button class="btn btn-outline-primary w-100" onclick="resetFilters()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de usuarios -->
        <div id="usersContainer">
            <div class="loading-state">
                <div class="spinner-border text-primary"></div>
                <p>Cargando usuarios...</p>
            </div>
        </div>

        <!-- Paginaci√≥n -->
        <div id="paginationContainer" class="d-flex justify-content-center mt-4" style="display: none !important;">
            <!-- Paginaci√≥n se genera din√°micamente -->
        </div>
    </div>

    <!-- Modal para crear/editar usuario -->
    <div id="userModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modalTitle">Crear Usuario</h5>
                <button type="button" onclick="closeUserModal()" class="btn-close">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            
            <form id="userForm">
                <div class="modal-body">
                    
                    <!-- Informaci√≥n b√°sica -->
                    <div class="form-section">
                        <h6><i class="bi bi-person me-1"></i>Informaci√≥n B√°sica</h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="userName" class="form-label">Nombre de usuario <span class="required">*</span></label>
                                <input type="text" class="form-control" id="userName" name="userName" required 
                                       placeholder="usuario123">
                                <div class="form-text">Solo letras, n√∫meros y guiones bajos</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="userDisplayName" class="form-label">Nombre para mostrar</label>
                                <input type="text" class="form-control" id="userDisplayName" name="userDisplayName" 
                                       placeholder="Juan P√©rez">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="userEmail" class="form-label">Correo electr√≥nico <span class="required">*</span></label>
                            <input type="email" class="form-control" id="userEmail" name="userEmail" required 
                                   placeholder="usuario@ejemplo.com">
                        </div>
                    </div>

                    <!-- Autenticaci√≥n -->
                    <div class="form-section">
                        <h6><i class="bi bi-shield-lock me-1"></i>Autenticaci√≥n</h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="authProvider" class="form-label">Proveedor de autenticaci√≥n <span class="required">*</span></label>
                                <select class="form-select" id="authProvider" name="authProvider" required onchange="togglePasswordField()">
                                    <option value="">Seleccionar...</option>
                                    <option value="local">Local (Usuario y contrase√±a)</option>
                                    <option value="google">Google</option>
                                    <option value="microsoft">Microsoft</option>
                                    <option value="github">GitHub</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="userStatus" class="form-label">Estado <span class="required">*</span></label>
                                <select class="form-select" id="userStatus" name="userStatus" required>
                                    <option value="active">Activo</option>
                                    <option value="inactive">Inactivo</option>
                                    <option value="suspended">Suspendido</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Campo de contrase√±a (solo para local) -->
                        <div id="passwordSection" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="userPassword" class="form-label">Contrase√±a <span class="required">*</span></label>
                                    <div class="password-input-group">
                                        <input type="password" class="form-control" id="userPassword" name="userPassword" 
                                               minlength="6" placeholder="M√≠nimo 6 caracteres">
                                        <button type="button" class="password-toggle" onclick="togglePassword('userPassword')">
                                            <i class="bi bi-eye" id="userPasswordToggle"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="confirmPassword" class="form-label">Confirmar contrase√±a <span class="required">*</span></label>
                                    <div class="password-input-group">
                                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" 
                                               minlength="6" placeholder="Repetir contrase√±a">
                                        <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                                            <i class="bi bi-eye" id="confirmPasswordToggle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campo para ID externo -->
                        <div id="externalIdSection" style="display: none;">
                            <div class="mb-3">
                                <label for="externalId" class="form-label">ID externo</label>
                                <input type="text" class="form-control" id="externalId" name="externalId" 
                                       placeholder="ID del proveedor externo">
                                <div class="form-text">Se asigna autom√°ticamente durante la autenticaci√≥n externa</div>
                            </div>
                        </div>
                    </div>

                    <!-- Selecci√≥n de roles -->
                    <div class="form-section">
                        <h6><i class="bi bi-people me-1"></i>Roles y Permisos</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Asignar roles</label>
                            <div id="rolesSelection" class="roles-selection">
                                <div class="loading-state">
                                    <div class="spinner-border spinner-border-sm text-primary"></div>
                                    <span>Cargando roles...</span>
                                </div>
                            </div>
                            <div class="form-text">Los permisos se heredan de los roles asignados</div>
                        </div>
                        
                        <!-- Resumen de roles seleccionados -->
                        <div id="selectedRolesSummary" style="display: none;">
                            <label class="form-label">Roles seleccionados:</label>
                            <div id="selectedRolesTags" class="role-tags">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="closeUserModal()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitUserBtn">
                        <i class="bi bi-check-circle me-1"></i>Crear Usuario
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n para eliminar -->
    <div id="deleteModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h5>Confirmar Eliminaci√≥n</h5>
                <button type="button" onclick="closeDeleteModal()" class="btn-close">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                </div>
                <p class="text-center">¬øEst√°s seguro de que deseas eliminar este usuario?</p>
                <p class="text-center text-muted" id="deleteUserInfo">Esta acci√≥n no se puede deshacer.</p>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="closeDeleteModal()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteUser()" id="confirmDeleteBtn">
                    <i class="bi bi-trash me-1"></i>Eliminar Usuario
                </button>
            </div>
        </div>
    </div>

    <!-- Footer del sistema -->
    <div class="system-footer">
        <div class="main-container">
            <p class="mb-0">SchoolNet - Gesti√≥n de Usuarios v1.0</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VALIDACI√ìN DE ACCESO A LA P√ÅGINA
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // Validar acceso antes de continuar
                const hasAccess = await validatePageAccess('security_users_write');
                
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return; // La funci√≥n validatePageAccess ya manej√≥ el bloqueo
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                
                // AQU√ç va la inicializaci√≥n original de users.html
                console.log('üöÄ Gesti√≥n de Usuarios - Cargando...');
                
                if (window.SUPABASE_CONFIG) {
                    initializePage();
                } else {
                    setTimeout(initializePage, 100);
                }
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let availableRoles = [];
        let selectedRoles = [];
        let allUsers = [];
        let filteredUsers = [];
        let currentEditingUser = null;
        let currentDeleteUserId = null;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        
        function initializePage() {
            console.log('üìä Inicializando gesti√≥n de usuarios');
            loadInitialData();
            setupEventListeners();
        }
        
        function setupEventListeners() {
            // Form submission
            document.getElementById('userForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitUserForm();
            });
            
            // Close modals on overlay click
            document.getElementById('userModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeUserModal();
                }
            });
            
            document.getElementById('deleteModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDeleteModal();
                }
            });
            
            // Password confirmation validation
            document.getElementById('confirmPassword').addEventListener('blur', validatePasswordMatch);
            
            // Username validation
            document.getElementById('userName').addEventListener('blur', validateUsername);
        }
        
        // ==========================================
        // CARGAR DATOS INICIALES
        // ==========================================
        
        async function loadInitialData() {
            try {
                console.log('üìä Cargando datos iniciales...');
                
                // Cargar roles y usuarios en paralelo
                const [roles, users] = await Promise.all([
                    loadAvailableRoles(),
                    loadUsers()
                ]);
                
                availableRoles = roles || [];
                allUsers = users || [];
                filteredUsers = [...allUsers];
                
                console.log(`‚úÖ Datos cargados: ${availableRoles.length} roles, ${allUsers.length} usuarios`);
                
                renderUsers();
                
            } catch (error) {
                console.error('‚ùå Error cargando datos iniciales:', error);
                showMessage(`Error cargando datos: ${error.message}`, 'danger');
            }
        }
        
        async function loadAvailableRoles() {
            try {
                const roles = await supabaseRequest('/roles?select=role_id,role_name,role_description,is_super_admin&role_status=eq.active&order=role_name.asc');
                console.log(`‚úÖ ${roles.length} roles cargados`);
                return roles;
            } catch (error) {
                console.error('‚ùå Error cargando roles:', error);
                return [];
            }
        }
        
        async function loadUsers() {
            try {
                const users = await supabaseRequest('/users?select=user_id,user_name,user_display_name,user_mail,auth_provider,external_id,email_verified,user_status,created_at,last_login&order=user_name.asc');
                console.log(`‚úÖ ${users.length} usuarios cargados`);
                return users;
            } catch (error) {
                console.error('‚ùå Error cargando usuarios:', error);
                return [];
            }
        }
        
        // ==========================================
        // RENDERIZADO DE USUARIOS
        // ==========================================
        
        function renderUsers() {
            const container = document.getElementById('usersContainer');
            
            if (filteredUsers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-people"></i>
                        <h6>No hay usuarios para mostrar</h6>
                        <p>No se encontraron usuarios con los filtros aplicados</p>
                        <button class="btn btn-primary" onclick="resetFilters()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Resetear filtros
                        </button>
                    </div>
                `;
                return;
            }
            
            const usersHtml = filteredUsers.map(user => createUserCard(user)).join('');
            container.innerHTML = usersHtml;
        }
        
        function createUserCard(user) {
            const initials = getUserInitials(user);
            const statusClass = `status-${user.user_status || 'inactive'}`;
            const statusText = getStatusText(user.user_status);
            const providerIcon = getProviderIcon(user.auth_provider);
            const lastLogin = user.last_login ? formatDate(user.last_login) : 'Nunca';
            
            return `
                <div class="user-card" data-user-id="${user.user_id}">
                    <div class="d-flex align-items-center">
                        <div class="user-avatar">
                            ${initials}
                        </div>
                        
                        <div class="user-info flex-grow-1">
                            <h5>${user.user_display_name || user.user_name}</h5>
                            <p>
                                <i class="bi bi-envelope me-1"></i>${user.user_mail}
                                ${providerIcon}
                            </p>
                            <p>
                                <i class="bi bi-clock me-1"></i>√öltimo acceso: ${lastLogin}
                            </p>
                            <div id="userRoles_${user.user_id}" class="role-tags">
                                <!-- Se cargan din√°micamente -->
                            </div>
                        </div>
                        
                        <div class="d-flex align-items-center gap-3">
                            <span class="status-badge ${statusClass}">
                                ${statusText}
                            </span>
                            
                            <div class="user-actions">
                                <button class="btn-icon" onclick="editUser('${user.user_id}')" title="Editar usuario">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn-icon" onclick="manageUserRoles('${user.user_id}')" title="Gestionar roles">
                                    <i class="bi bi-people"></i>
                                </button>
                                <button class="btn-icon" onclick="deleteUser('${user.user_id}')" title="Eliminar usuario">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // UTILIDADES DE RENDERIZADO
        // ==========================================
        
        function getUserInitials(user) {
            const name = user.user_display_name || user.user_name || 'U';
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0].charAt(0) + parts[1].charAt(0)).toUpperCase();
            }
            return name.charAt(0).toUpperCase();
        }
        
        function getStatusText(status) {
            const statusMap = {
                'active': 'Activo',
                'inactive': 'Inactivo',
                'suspended': 'Suspendido'
            };
            return statusMap[status] || 'Desconocido';
        }
        
        function getProviderIcon(provider) {
            const providerMap = {
                'local': '<i class="bi bi-key ms-2" title="Local"></i>',
                'google': '<i class="bi bi-google ms-2" title="Google"></i>',
                'microsoft': '<i class="bi bi-microsoft ms-2" title="Microsoft"></i>',
                'github': '<i class="bi bi-github ms-2" title="GitHub"></i>'
            };
            return providerMap[provider] || '';
        }
        
        // ==========================================
        // FILTROS Y B√öSQUEDA
        // ==========================================
        
        function filterUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const providerFilter = document.getElementById('providerFilter').value;
            
            filteredUsers = allUsers.filter(user => {
                const matchesSearch = !searchTerm || 
                    user.user_name.toLowerCase().includes(searchTerm) ||
                    user.user_mail.toLowerCase().includes(searchTerm) ||
                    (user.user_display_name || '').toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || user.user_status === statusFilter;
                const matchesProvider = !providerFilter || user.auth_provider === providerFilter;
                
                return matchesSearch && matchesStatus && matchesProvider;
            });
            
            renderUsers();
        }
        
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterUsers();
        }
        
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('providerFilter').value = '';
            filterUsers();
        }
        
        // ==========================================
        // GESTI√ìN DE MODALES
        // ==========================================
        
        function openCreateUserModal() {
            currentEditingUser = null;
            resetUserForm();
            document.getElementById('modalTitle').textContent = 'Crear Usuario';
            document.getElementById('submitUserBtn').innerHTML = '<i class="bi bi-check-circle me-1"></i>Crear Usuario';
            loadRolesInModal();
            document.getElementById('userModal').style.display = 'flex';
        }
        
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            resetUserForm();
        }
        
        function resetUserForm() {
            document.getElementById('userForm').reset();
            selectedRoles = [];
            document.getElementById('selectedRolesSummary').style.display = 'none';
            document.getElementById('passwordSection').style.display = 'none';
            document.getElementById('externalIdSection').style.display = 'none';
        }
        
        function togglePasswordField() {
            const provider = document.getElementById('authProvider').value;
            const passwordSection = document.getElementById('passwordSection');
            const externalSection = document.getElementById('externalIdSection');
            const passwordInput = document.getElementById('userPassword');
            const confirmInput = document.getElementById('confirmPassword');
            
            if (provider === 'local') {
                passwordSection.style.display = 'block';
                externalSection.style.display = 'none';
                passwordInput.required = true;
                confirmInput.required = true;
            } else if (provider && provider !== 'local') {
                passwordSection.style.display = 'none';
                externalSection.style.display = 'block';
                passwordInput.required = false;
                confirmInput.required = false;
            } else {
                passwordSection.style.display = 'none';
                externalSection.style.display = 'none';
                passwordInput.required = false;
                confirmInput.required = false;
            }
        }
        
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(inputId + 'Toggle');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'bi bi-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'bi bi-eye';
            }
        }
        
        // ==========================================
        // CARGA DE ROLES EN MODAL
        // ==========================================
        
        function loadRolesInModal() {
            const container = document.getElementById('rolesSelection');
            
            if (availableRoles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        <p>No hay roles disponibles</p>
                    </div>
                `;
                return;
            }
            
            const rolesHtml = availableRoles.map(role => `
                <div class="role-option">
                    <input type="checkbox" id="role_${role.role_id}" value="${role.role_id}" 
                           onchange="updateSelectedRoles()">
                    <label for="role_${role.role_id}">
                        <strong>${role.role_name}</strong>
                        ${role.is_super_admin ? '<span class="badge bg-warning">Super Admin</span>' : ''}
                        ${role.role_description ? `<div class="role-description">${role.role_description}</div>` : ''}
                    </label>
                </div>
            `).join('');
            
            container.innerHTML = rolesHtml;
        }
        
        function updateSelectedRoles() {
            const checkboxes = document.querySelectorAll('#rolesSelection input[type="checkbox"]:checked');
            selectedRoles = Array.from(checkboxes).map(cb => cb.value);
            
            const summary = document.getElementById('selectedRolesSummary');
            const tagsContainer = document.getElementById('selectedRolesTags');
            
            if (selectedRoles.length > 0) {
                const roleNames = selectedRoles.map(roleId => {
                    const role = availableRoles.find(r => r.role_id === roleId);
                    return role ? role.role_name : 'Desconocido';
                });
                
                tagsContainer.innerHTML = roleNames.map(name => 
                    `<span class="role-tag">${name}</span>`
                ).join('');
                
                summary.style.display = 'block';
            } else {
                summary.style.display = 'none';
            }
        }
        
        // ==========================================
        // VALIDACIONES
        // ==========================================
        
        function validatePasswordMatch() {
            const password = document.getElementById('userPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const confirmInput = document.getElementById('confirmPassword');
            
            if (confirm && password !== confirm) {
                confirmInput.setCustomValidity('Las contrase√±as no coinciden');
                confirmInput.classList.add('is-invalid');
            } else {
                confirmInput.setCustomValidity('');
                confirmInput.classList.remove('is-invalid');
            }
        }
        
        function validateUsername() {
            const username = document.getElementById('userName').value;
            const usernameInput = document.getElementById('userName');
            
            // Validar formato
            const usernameRegex = /^[a-zA-Z0-9_]+$/;
            if (username && !usernameRegex.test(username)) {
                usernameInput.setCustomValidity('Solo se permiten letras, n√∫meros y guiones bajos');
                usernameInput.classList.add('is-invalid');
                return false;
            }
            
            // Validar unicidad (solo para usuarios nuevos o si cambi√≥ el nombre)
            if (username && (!currentEditingUser || currentEditingUser.user_name !== username)) {
                const exists = allUsers.some(user => 
                    user.user_name.toLowerCase() === username.toLowerCase() && 
                    user.user_id !== (currentEditingUser?.user_id)
                );
                
                if (exists) {
                    usernameInput.setCustomValidity('Este nombre de usuario ya est√° en uso');
                    usernameInput.classList.add('is-invalid');
                    return false;
                }
            }
            
            usernameInput.setCustomValidity('');
            usernameInput.classList.remove('is-invalid');
            return true;
        }
        
        // ==========================================
        // ENV√çO DE FORMULARIO
        // ==========================================
        
        async function submitUserForm() {
            const submitBtn = document.getElementById('submitUserBtn');
            const originalText = submitBtn.innerHTML;
            
            try {
                // Validaciones adicionales
                if (!validateUsername()) {
                    showMessage('Por favor corrige los errores en el formulario', 'danger');
                    return;
                }
                
                if (document.getElementById('authProvider').value === 'local') {
                    validatePasswordMatch();
                    const confirmInput = document.getElementById('confirmPassword');
                    if (!confirmInput.validity.valid) {
                        showMessage('Las contrase√±as no coinciden', 'danger');
                        return;
                    }
                }
                
                // Deshabilitar bot√≥n
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
                
                // Recopilar datos del formulario
                const formData = collectUserFormData();
                
                if (currentEditingUser) {
                    await updateUser(currentEditingUser.user_id, formData);
                } else {
                    await createUser(formData);
                }
                
            } catch (error) {
                console.error('‚ùå Error en env√≠o de formulario:', error);
                showMessage(`Error: ${error.message}`, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
        
        function collectUserFormData() {
            const formData = {
                user_name: document.getElementById('userName').value.trim(),
                user_display_name: document.getElementById('userDisplayName').value.trim() || null,
                user_mail: document.getElementById('userEmail').value.trim(),
                auth_provider: document.getElementById('authProvider').value,
                user_status: document.getElementById('userStatus').value,
                external_id: document.getElementById('externalId').value.trim() || null
            };
            
            // Solo incluir contrase√±a para proveedores locales
            if (formData.auth_provider === 'local') {
                const password = document.getElementById('userPassword').value;
                if (password) {
                    formData.user_password = password;
                }
            }
            
            return formData;
        }
        
        // ==========================================
        // OPERACIONES CRUD
        // ==========================================
        
        async function createUser(userData) {
            try {
                console.log('üë§ Creando usuario:', userData);
                
                // Crear usuario
                const newUser = await supabaseRequest('/users', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });
                
                const userId = Array.isArray(newUser) ? newUser[0].user_id : newUser.user_id;
                
                // Asignar roles si se seleccionaron
                if (selectedRoles.length > 0) {
                    await assignRolesToUser(userId, selectedRoles);
                }
                
                showMessage('Usuario creado exitosamente', 'success');
                closeUserModal();
                await loadInitialData(); // Recargar datos
                
            } catch (error) {
                console.error('‚ùå Error creando usuario:', error);
                throw error;
            }
        }
        
        async function updateUser(userId, userData) {
            try {
                console.log('‚úèÔ∏è Actualizando usuario:', userId, userData);
                
                // Actualizar usuario
                await supabaseRequest(`/users?user_id=eq.${userId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(userData)
                });
                
                // Actualizar roles
                await updateUserRoles(userId, selectedRoles);
                
                showMessage('Usuario actualizado exitosamente', 'success');
                closeUserModal();
                await loadInitialData(); // Recargar datos
                
            } catch (error) {
                console.error('‚ùå Error actualizando usuario:', error);
                throw error;
            }
        }
        
        async function assignRolesToUser(userId, roleIds) {
            try {
                const assignments = roleIds.map(roleId => ({
                    user_id: userId,
                    role_id: roleId,
                    assigned_at: new Date().toISOString()
                }));
                
                await supabaseRequest('/user_roles', {
                    method: 'POST',
                    body: JSON.stringify(assignments)
                });
                
                console.log('‚úÖ Roles asignados al usuario');
            } catch (error) {
                console.error('‚ùå Error asignando roles:', error);
                throw error;
            }
        }
        
        async function updateUserRoles(userId, newRoleIds) {
            try {
                // Eliminar roles existentes
                await supabaseRequest(`/user_roles?user_id=eq.${userId}`, {
                    method: 'DELETE'
                });
                
                // Asignar nuevos roles
                if (newRoleIds.length > 0) {
                    await assignRolesToUser(userId, newRoleIds);
                }
                
                console.log('‚úÖ Roles actualizados para el usuario');
            } catch (error) {
                console.error('‚ùå Error actualizando roles:', error);
                throw error;
            }
        }
        
        // ==========================================
        // EDICI√ìN DE USUARIOS
        // ==========================================
        
        async function editUser(userId) {
            try {
                console.log('‚úèÔ∏è Editando usuario:', userId);
                
                // Cargar datos del usuario
                const userData = await supabaseRequest(`/users?select=*&user_id=eq.${userId}`);
                if (!userData || userData.length === 0) {
                    throw new Error('Usuario no encontrado');
                }
                
                currentEditingUser = userData[0];
                
                // Cargar roles del usuario
                const userRoles = await supabaseRequest(`/user_roles?select=role_id&user_id=eq.${userId}`);
                selectedRoles = userRoles.map(ur => ur.role_id);
                
                // Llenar formulario
                populateUserForm(currentEditingUser);
                
                // Configurar modal para edici√≥n
                document.getElementById('modalTitle').textContent = 'Editar Usuario';
                document.getElementById('submitUserBtn').innerHTML = '<i class="bi bi-check-circle me-1"></i>Actualizar Usuario';
                
                // Cargar roles y mostrar modal
                loadRolesInModal();
                setTimeout(() => {
                    // Marcar roles seleccionados
                    selectedRoles.forEach(roleId => {
                        const checkbox = document.getElementById(`role_${roleId}`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                    updateSelectedRoles();
                }, 100);
                
                document.getElementById('userModal').style.display = 'flex';
                
            } catch (error) {
                console.error('‚ùå Error cargando usuario para edici√≥n:', error);
                showMessage(`Error cargando usuario: ${error.message}`, 'danger');
            }
        }
        
        function populateUserForm(user) {
            document.getElementById('userName').value = user.user_name || '';
            document.getElementById('userDisplayName').value = user.user_display_name || '';
            document.getElementById('userEmail').value = user.user_mail || '';
            document.getElementById('authProvider').value = user.auth_provider || '';
            document.getElementById('userStatus').value = user.user_status || 'active';
            document.getElementById('externalId').value = user.external_id || '';
            
            // Configurar campos seg√∫n proveedor
            togglePasswordField();
        }
        
        // ==========================================
        // ELIMINACI√ìN DE USUARIOS
        // ==========================================
        
        function deleteUser(userId) {
            const user = allUsers.find(u => u.user_id === userId);
            if (!user) {
                showMessage('Usuario no encontrado', 'danger');
                return;
            }
            
            currentDeleteUserId = userId;
            document.getElementById('deleteUserInfo').textContent = 
                `Usuario: ${user.user_display_name || user.user_name} (${user.user_mail})`;
            document.getElementById('deleteModal').style.display = 'flex';
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            currentDeleteUserId = null;
        }
        
        async function confirmDeleteUser() {
            if (!currentDeleteUserId) return;
            
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const originalText = confirmBtn.innerHTML;
            
            try {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Eliminando...';
                
                // Eliminar roles del usuario primero
                await supabaseRequest(`/user_roles?user_id=eq.${currentDeleteUserId}`, {
                    method: 'DELETE'
                });
                
                // Eliminar usuario
                await supabaseRequest(`/users?user_id=eq.${currentDeleteUserId}`, {
                    method: 'DELETE'
                });
                
                showMessage('Usuario eliminado exitosamente', 'success');
                closeDeleteModal();
                await loadInitialData(); // Recargar datos
                
            } catch (error) {
                console.error('‚ùå Error eliminando usuario:', error);
                showMessage(`Error eliminando usuario: ${error.message}`, 'danger');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalText;
            }
        }
        
        // ==========================================
        // GESTI√ìN DE ROLES (enlace a otra p√°gina)
        // ==========================================
        
        function manageUserRoles(userId) {
            // Redirigir a la p√°gina de asignaci√≥n de roles con el usuario preseleccionado
            window.location.href = `user-roles.html?user=${userId}`;
        }
    </script>
</body>
</html>
