<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.01.16.31">
    <title>Gesti√≥n de Usuarios - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <!-- ‚úÖ CORRECTO -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .user-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .user-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #0d6efd;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            margin-right: 1rem;
        }
        
        .user-info h5 {
            margin: 0;
            color: #212529;
        }
        
        .user-info p {
            margin: 0.25rem 0 0 0;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-active {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        
        .status-inactive {
            background-color: #f8d7da;
            color: #842029;
        }
        
        .status-suspended {
            background-color: #fff3cd;
            color: #664d03;
        }
        
        .user-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-icon {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            background: white;
            color: #6c757d;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .btn-icon:hover {
            background: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        
        .btn-icon.text-warning:hover {
            background: #ffc107;
            color: white;
            border-color: #ffc107;
        }
        
        .btn-icon.text-success:hover {
            background: #198754;
            color: white;
            border-color: #198754;
        }
        
        .role-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .role-tag {
            background: #e7f1ff;
            color: #0d6efd;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            border: 1px solid #0d6efd;
        }
        
        .required {
            color: #dc3545;
        }
        
        .password-input-group {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: none;
            color: #6c757d;
            cursor: pointer;
        }
        
        .roles-selection {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
        }
        
        .role-option {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 8px;
            margin-bottom: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .role-option:hover {
            background: #e7f1ff;
        }
        
        .role-option input[type="checkbox"] {
            margin-right: 0.75rem;
        }
        
        .role-option label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }
        
        .role-description {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        .user-card[data-status="inactive"] {
            opacity: 0.7;
            border-left: 4px solid #dc3545;
        }
        
        .user-card[data-status="suspended"] {
            opacity: 0.8;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Seguridad</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gesti√≥n de Usuarios
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-people me-2"></i>
                    Gesti√≥n de Usuarios
                </h1>
                <p class="text-muted">
                    Gestiona usuarios, roles y permisos de acceso
                </p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" onclick="openCreateUserModal()">
                    <i class="bi bi-plus-circle me-1"></i>Crear Usuario
                </button>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- Filtros de b√∫squeda -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Buscar usuarios</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Nombre, email o usuario..." 
                                   onkeyup="filterUsers()">
                            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Estado</label>
                        <select class="form-select" id="statusFilter" onchange="filterUsers()">
                            <option value="">Todos los estados</option>
                            <option value="active">Activos</option>
                            <option value="inactive">Inactivos</option>
                            <option value="suspended">Suspendidos</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Proveedor de autenticaci√≥n</label>
                        <select class="form-select" id="providerFilter" onchange="filterUsers()">
                            <option value="">Todos los proveedores</option>
                            <option value="local">Local</option>
                            <option value="google">Google</option>
                            <option value="microsoft">Microsoft</option>
                            <option value="github">GitHub</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2 mb-3 d-flex align-items-end">
                        <button class="btn btn-outline-primary w-100" onclick="resetFilters()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de usuarios -->
        <div id="usersContainer">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Cargando usuarios...</p>
            </div>
        </div>

    </div>
    <!-- Modal para crear/editar usuario -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Crear Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <form id="userForm">
                    <div class="modal-body">
                        
                        <!-- Informaci√≥n b√°sica -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-person me-1"></i>Informaci√≥n B√°sica
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="userName" class="form-label">Nombre de usuario <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="userName" name="userName" required 
                                           placeholder="usuario123">
                                    <div class="form-text">Solo letras, n√∫meros y guiones bajos</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="userDisplayName" class="form-label">Nombre para mostrar</label>
                                    <input type="text" class="form-control" id="userDisplayName" name="userDisplayName" 
                                           placeholder="Juan P√©rez">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="userEmail" class="form-label">Correo electr√≥nico <span class="required">*</span></label>
                                <input type="text" class="form-control" id="userEmail" name="userEmail" required 
                                   placeholder="usuario@ejemplo.com">
                            </div>
                        </div>

                        <!-- Autenticaci√≥n -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-shield-lock me-1"></i>Autenticaci√≥n
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="authProvider" class="form-label">Proveedor de autenticaci√≥n <span class="required">*</span></label>
                                    <select class="form-select" id="authProvider" name="authProvider" required onchange="togglePasswordField()">
                                        <option value="">Seleccionar...</option>
                                        <option value="local">Local (Usuario y contrase√±a)</option>
                                        <option value="google">Google</option>
                                        <option value="microsoft">Microsoft</option>
                                        <option value="github">GitHub</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="userStatus" class="form-label">Estado <span class="required">*</span></label>
                                    <select class="form-select" id="userStatus" name="userStatus" required>
                                        <option value="active">Activo</option>
                                        <option value="inactive">Inactivo</option>
                                        <option value="suspended">Suspendido</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Campo de contrase√±a (solo para local) -->
                            <div id="passwordSection" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="userPassword" class="form-label">Contrase√±a <span class="required">*</span></label>
                                        <div class="password-input-group">
                                            <input type="password" class="form-control" id="userPassword" name="userPassword" 
                                                   minlength="6" placeholder="M√≠nimo 6 caracteres">
                                            <button type="button" class="password-toggle" onclick="togglePassword('userPassword')">
                                                <i class="bi bi-eye" id="userPasswordToggle"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="confirmPassword" class="form-label">Confirmar contrase√±a <span class="required">*</span></label>
                                        <div class="password-input-group">
                                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" 
                                                   minlength="6" placeholder="Repetir contrase√±a">
                                            <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                                                <i class="bi bi-eye" id="confirmPasswordToggle"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Campo para ID externo -->
                            <div id="externalIdSection" style="display: none;">
                                <div class="mb-3">
                                    <label for="externalId" class="form-label">ID externo</label>
                                    <input type="text" class="form-control" id="externalId" name="externalId" 
                                           placeholder="ID del proveedor externo">
                                    <div class="form-text">Se asigna autom√°ticamente durante la autenticaci√≥n externa</div>
                                </div>
                            </div>
                        </div>

                        <!-- Selecci√≥n de roles -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-people me-1"></i>Roles y Permisos
                            </h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Asignar roles</label>
                                <div id="rolesSelection" class="roles-selection">
                                    <div class="text-center">
                                        <div class="spinner-border spinner-border-sm text-primary"></div>
                                        <span>Cargando roles...</span>
                                    </div>
                                </div>
                                <div class="form-text">Los permisos se heredan de los roles asignados</div>
                            </div>
                            
                            <!-- Resumen de roles seleccionados -->
                            <div id="selectedRolesSummary" style="display: none;">
                                <label class="form-label">Roles seleccionados:</label>
                                <div id="selectedRolesTags" class="role-tags">
                                    <!-- Se llena din√°micamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitUserBtn">
                            <i class="bi bi-check-circle me-1"></i>Crear Usuario
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de cambio de estado -->
    <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statusModalTitle">Cambiar Estado de Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i id="statusModalIcon" class="text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <p class="text-center" id="statusModalMessage">¬øEst√°s seguro de que deseas cambiar el estado de este usuario?</p>
                    <p class="text-center text-muted" id="statusUserInfo">Esta acci√≥n se puede revertir posteriormente.</p>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" id="confirmStatusBtn" onclick="confirmToggleUserStatus()">
                        <i class="bi bi-check-circle me-1"></i>Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- SCRIPTS - ORDEN CR√çTICO -->
    <!-- ‚úÖ CORRECTO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let availableRoles = [];
        let selectedRoles = [];
        let allUsers = [];
        let filteredUsers = [];
        let currentEditingUser = null;
        let currentToggleUserId = null;
        let currentToggleAction = null;
        let modalInstance = null;
        let statusModalInstance = null;
        
        // ==========================================
        // INICIALIZACI√ìN - PATR√ìN OBLIGATORIO
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // PASO 1: SIEMPRE validar permisos primero
                const hasAccess = await validatePageAccess('Gesti√≥n de usuarios');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                
                // PASO 2: Inicializar p√°gina
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                console.log('üë• Gesti√≥n de Usuarios - Inicializando...');
                
                // Inicializar modales
                modalInstance = new bootstrap.Modal(document.getElementById('userModal'));
                statusModalInstance = new bootstrap.Modal(document.getElementById('statusModal'));
                
                // Configurar event listeners
                setupEventListeners();
                
                // Cargar datos iniciales
                await loadInitialData();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CONFIGURACI√ìN DE EVENTOS
        // ==========================================
        
        function setupEventListeners() {
            // Form submission
            document.getElementById('userForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitUserForm();
            });
            
            // Password confirmation validation
            document.getElementById('confirmPassword').addEventListener('blur', validatePasswordMatch);
            
            // Username validation
            document.getElementById('userName').addEventListener('blur', validateUsername);

            document.getElementById('userDisplayName').addEventListener('blur', validateUsername);
            
            console.log('‚úÖ Event listeners configurados');
        }
        
        // ==========================================
        // CARGAR DATOS INICIALES
        // ==========================================
        
        async function loadInitialData() {
            try {
                console.log('üìä Cargando datos iniciales...');
                
                const [roles, users] = await Promise.all([
                    loadAvailableRoles(),
                    loadUsers()
                ]);
                
                availableRoles = roles || [];
                allUsers = users || [];
                filteredUsers = [...allUsers];
                
                console.log(`‚úÖ Datos cargados: ${availableRoles.length} roles, ${allUsers.length} usuarios`);
                
                renderUsers();
                
            } catch (error) {
                console.error('‚ùå Error cargando datos iniciales:', error);
                showMessage('Error cargando datos: ' + error.message, 'danger');
            }
        }
        
        async function loadAvailableRoles() {
            try {
                const roles = await supabaseRequest('/roles?select=role_id,role_name,role_description,is_super_admin&role_status=eq.active&order=role_name.asc');
                console.log(`‚úÖ ${roles.length} roles cargados`);
                return roles;
            } catch (error) {
                console.error('‚ùå Error cargando roles:', error);
                return [];
            }
        }

        async function loadUsers() {
            try {
                const users = await supabaseRequest('/users?select=user_id,user_name,user_display_name,user_mail,auth_provider,external_id,email_verified,user_status,created_at,last_login&order=user_display_name.asc');
                
                // NO reformatear - los nombres ya vienen en el formato correcto desde la BD
                // Formato en BD: "Apellido1 Apellido2 Nombres" 
                
                console.log(`‚úÖ ${users.length} usuarios cargados`);
                return users;
            } catch (error) {
                console.error('‚ùå Error cargando usuarios:', error);
                return [];
            }
        }
        
        // ==========================================
        // RENDERIZADO DE USUARIOS
        // ==========================================
        
        function renderUsers() {
            const container = document.getElementById('usersContainer');
            
            if (filteredUsers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                        <h6 class="mt-3">No hay usuarios para mostrar</h6>
                        <p class="text-muted">No se encontraron usuarios con los filtros aplicados</p>
                        <button class="btn btn-primary" onclick="resetFilters()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Resetear filtros
                        </button>
                    </div>
                `;
                return;
            }
            
            const usersHtml = filteredUsers.map(user => createUserCard(user)).join('');
            container.innerHTML = usersHtml;
        }
        
        function createUserCard(user) {
            const initials = getUserInitials(user);
            const statusClass = `status-${user.user_status || 'inactive'}`;
            const statusText = getStatusText(user.user_status);
            const providerIcon = getProviderIcon(user.auth_provider);
            const lastLogin = user.last_login ? formatDate(user.last_login) : 'Nunca';
            
            const isActive = user.user_status === 'active';
            const toggleIcon = isActive ? 'person-dash' : 'person-check';
            const toggleTitle = isActive ? 'Inactivar usuario' : 'Activar usuario';
            const toggleClass = isActive ? 'text-warning' : 'text-success';
            
            return `
                <div class="user-card" data-user-id="${user.user_id}" data-status="${user.user_status}">
                    <div class="d-flex align-items-center">
                        <div class="user-avatar">
                            ${initials}
                        </div>
                        
                        <div class="user-info flex-grow-1">
                            <h5>${escapeHtml(user.user_display_name || user.user_name)}</h5>
                            <p>
                                <i class="bi bi-envelope me-1"></i>${escapeHtml(user.user_mail)}
                                ${providerIcon}
                            </p>
                            <p>
                                <i class="bi bi-clock me-1"></i>√öltimo acceso: ${lastLogin}
                            </p>
                            <div id="userRoles_${user.user_id}" class="role-tags">
                                <!-- Se cargan din√°micamente -->
                            </div>
                        </div>
                        
                        <div class="d-flex align-items-center gap-3">
                            <span class="status-badge ${statusClass}">
                                ${statusText}
                            </span>
                            
                            <div class="user-actions">
                                <button class="btn-icon" onclick="editUser('${user.user_id}')" title="Editar usuario">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn-icon" onclick="manageUserRoles('${user.user_id}')" title="Gestionar roles">
                                    <i class="bi bi-people"></i>
                                </button>
                                <button class="btn-icon ${toggleClass}" onclick="toggleUserStatus('${user.user_id}')" title="${toggleTitle}">
                                    <i class="bi bi-${toggleIcon}"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // UTILIDADES DE RENDERIZADO
        // ==========================================
        
        function getUserInitials(user) {
            const name = user.user_display_name || user.user_name || 'U';
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0].charAt(0) + parts[1].charAt(0)).toUpperCase();
            }
            return name.charAt(0).toUpperCase();
        }
        
        function getStatusText(status) {
            const statusMap = {
                'active': 'Activo',
                'inactive': 'Inactivo',
                'suspended': 'Suspendido'
            };
            return statusMap[status] || 'Desconocido';
        }
        
        function getProviderIcon(provider) {
            const providerMap = {
                'local': '<i class="bi bi-key ms-2" title="Local"></i>',
                'google': '<i class="bi bi-google ms-2" title="Google"></i>',
                'microsoft': '<i class="bi bi-microsoft ms-2" title="Microsoft"></i>',
                'github': '<i class="bi bi-github ms-2" title="GitHub"></i>'
            };
            return providerMap[provider] || '';
        }
        
        // ==========================================
        // FILTROS Y B√öSQUEDA
        // ==========================================
        
        function filterUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const providerFilter = document.getElementById('providerFilter').value;
            
            filteredUsers = allUsers.filter(user => {
                const matchesSearch = !searchTerm || 
                    user.user_name.toLowerCase().includes(searchTerm) ||
                    user.user_mail.toLowerCase().includes(searchTerm) ||
                    (user.user_display_name || '').toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || user.user_status === statusFilter;
                const matchesProvider = !providerFilter || user.auth_provider === providerFilter;
                
                return matchesSearch && matchesStatus && matchesProvider;
            });
            
            renderUsers();
        }
        
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterUsers();
        }
        
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('providerFilter').value = '';
            filterUsers();
        }
        // ==========================================
        // GESTI√ìN DE MODALES
        // ==========================================
        
        function openCreateUserModal() {
            currentEditingUser = null;
            resetUserForm();
            document.getElementById('modalTitle').textContent = 'Crear Usuario';
            document.getElementById('submitUserBtn').innerHTML = '<i class="bi bi-check-circle me-1"></i>Crear Usuario';
            loadRolesInModal();
            modalInstance.show();
        }
        
        function closeUserModal() {
            modalInstance.hide();
            resetUserForm();
        }
        
        function resetUserForm() {
            document.getElementById('userForm').reset();
            selectedRoles = [];
            document.getElementById('selectedRolesSummary').style.display = 'none';
            document.getElementById('passwordSection').style.display = 'none';
            document.getElementById('externalIdSection').style.display = 'none';
        }
        
        function togglePasswordField() {
            const provider = document.getElementById('authProvider').value;
            const passwordSection = document.getElementById('passwordSection');
            const externalSection = document.getElementById('externalIdSection');
            const passwordInput = document.getElementById('userPassword');
            const confirmInput = document.getElementById('confirmPassword');
            
            if (provider === 'local') {
                passwordSection.style.display = 'block';
                externalSection.style.display = 'none';
                
                // Si estamos CREANDO un usuario, la contrase√±a es obligatoria
                // Si estamos EDITANDO, la contrase√±a es opcional (solo si quiere cambiarla)
                if (currentEditingUser) {
                    passwordInput.required = false;
                    confirmInput.required = false;
                    // Cambiar el texto del label para indicar que es opcional
                    document.querySelector('label[for="userPassword"]').innerHTML = 
                        'Contrase√±a <span class="text-muted">(opcional - dejar en blanco para mantener la actual)</span>';
                } else {
                    passwordInput.required = true;
                    confirmInput.required = true;
                    document.querySelector('label[for="userPassword"]').innerHTML = 
                        'Contrase√±a <span class="required">*</span>';
                }
            } else if (provider && provider !== 'local') {
                passwordSection.style.display = 'none';
                externalSection.style.display = 'block';
                passwordInput.required = false;
                confirmInput.required = false;
            } else {
                passwordSection.style.display = 'none';
                externalSection.style.display = 'none';
                passwordInput.required = false;
                confirmInput.required = false;
            }
        }
        
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(inputId + 'Toggle');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'bi bi-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'bi bi-eye';
            }
        }
        
        // ==========================================
        // CARGA DE ROLES EN MODAL
        // ==========================================
        
        function loadRolesInModal() {
            const container = document.getElementById('rolesSelection');
            
            if (availableRoles.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-3">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        <p class="mb-0">No hay roles disponibles</p>
                    </div>
                `;
                return;
            }
            
            const rolesHtml = availableRoles.map(role => `
                <div class="role-option">
                    <input type="checkbox" id="role_${role.role_id}" value="${role.role_id}" 
                           onchange="updateSelectedRoles()">
                    <label for="role_${role.role_id}">
                        <strong>${escapeHtml(role.role_name)}</strong>
                        ${role.is_super_admin ? '<span class="badge bg-warning">Super Admin</span>' : ''}
                        ${role.role_description ? `<div class="role-description">${escapeHtml(role.role_description)}</div>` : ''}
                    </label>
                </div>
            `).join('');
            
            container.innerHTML = rolesHtml;
        }
        
        function updateSelectedRoles() {
            const checkboxes = document.querySelectorAll('#rolesSelection input[type="checkbox"]:checked');
            selectedRoles = Array.from(checkboxes).map(cb => cb.value);
            
            const summary = document.getElementById('selectedRolesSummary');
            const tagsContainer = document.getElementById('selectedRolesTags');
            
            if (selectedRoles.length > 0) {
                const roleNames = selectedRoles.map(roleId => {
                    const role = availableRoles.find(r => r.role_id === roleId);
                    return role ? role.role_name : 'Desconocido';
                });
                
                tagsContainer.innerHTML = roleNames.map(name => 
                    `<span class="role-tag">${escapeHtml(name)}</span>`
                ).join('');
                
                summary.style.display = 'block';
            } else {
                summary.style.display = 'none';
            }
        }
        
        // ==========================================
        // VALIDACIONES
        // ==========================================
        function validatePasswordMatch() {
            const password = document.getElementById('userPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const confirmInput = document.getElementById('confirmPassword');
            
            // Si no hay contrase√±a ingresada y estamos editando, no validar
            if (!password && currentEditingUser) {
                confirmInput.setCustomValidity('');
                confirmInput.classList.remove('is-invalid');
                return true;
            }
            
            // Si hay contrase√±a pero no coincide la confirmaci√≥n
            if (password && confirm && password !== confirm) {
                confirmInput.setCustomValidity('Las contrase√±as no coinciden');
                confirmInput.classList.add('is-invalid');
                return false;
            } else {
                confirmInput.setCustomValidity('');
                confirmInput.classList.remove('is-invalid');
                return true;
            }
        }

        function validateUsername() {
            const username = document.getElementById('userName').value;
            const displayName = document.getElementById('userDisplayName').value.trim();
            const usernameInput = document.getElementById('userName');
            const displayNameInput = document.getElementById('userDisplayName');
            
            // ‚úÖ VALIDACI√ìN 1: Validar formato del username
            const usernameRegex = /^[a-zA-Z0-9_]+$/;
            if (username && !usernameRegex.test(username)) {
                usernameInput.setCustomValidity('Solo se permiten letras, n√∫meros y guiones bajos');
                usernameInput.classList.add('is-invalid');
                return false;
            }
            
            // ‚úÖ VALIDACI√ìN 2: Verificar que el nombre para mostrar tenga al menos 2 palabras
            if (displayName) {
                const nameParts = displayName.split(/\s+/).filter(part => part.length > 0);
                if (nameParts.length < 2) {
                    displayNameInput.setCustomValidity('Debe ingresar al menos nombre y apellido');
                    displayNameInput.classList.add('is-invalid');
                    showMessage('El nombre para mostrar debe incluir al menos nombre y apellido', 'warning');
                    return false;
                } else {
                    displayNameInput.setCustomValidity('');
                    displayNameInput.classList.remove('is-invalid');
                }
            }
            
            // ‚úÖ VALIDACI√ìN 3: Verificar que el username no est√© duplicado
            if (username && (!currentEditingUser || currentEditingUser.user_name !== username)) {
                const exists = allUsers.some(user => 
                    user.user_name.toLowerCase() === username.toLowerCase() && 
                    user.user_id !== (currentEditingUser?.user_id)
                );
                
                if (exists) {
                    usernameInput.setCustomValidity('Este nombre de usuario ya est√° en uso');
                    usernameInput.classList.add('is-invalid');
                    return false;
                }
            }
            
            usernameInput.setCustomValidity('');
            usernameInput.classList.remove('is-invalid');
            return true;
        }
        

        
        // ==========================================
        // ENV√çO DE FORMULARIO
        // ==========================================
        async function submitUserForm() {
            const submitBtn = document.getElementById('submitUserBtn');
            const originalText = submitBtn.innerHTML;
            
            try {
                // ‚úÖ Validar username y nombre completo
                if (!validateUsername()) {
                    showMessage('Por favor corrige los errores en el formulario', 'danger');
                    return;
                }
                
                // ‚úÖ Validar que user_display_name est√© completo
                const displayName = document.getElementById('userDisplayName').value.trim();
                if (displayName) {
                    const nameParts = displayName.split(/\s+/).filter(part => part.length > 0);
                    if (nameParts.length < 2) {
                        showMessage('El nombre para mostrar debe incluir al menos nombre y apellido', 'warning');
                        return;
                    }
                }
                
                // Validar contrase√±as solo si se ingres√≥ una
                const password = document.getElementById('userPassword').value;
                if (document.getElementById('authProvider').value === 'local') {
                    // Si estamos creando O si hay contrase√±a ingresada, validar
                    if (!currentEditingUser || password) {
                        if (!validatePasswordMatch()) {
                            showMessage('Las contrase√±as no coinciden', 'danger');
                            return;
                        }
                        
                        // Si estamos creando y no hay contrase√±a
                        if (!currentEditingUser && !password) {
                            showMessage('La contrase√±a es obligatoria para nuevos usuarios', 'danger');
                            return;
                        }
                    }
                }
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
                
                const formData = collectUserFormData();
                
                if (currentEditingUser) {
                    await updateUser(currentEditingUser.user_id, formData);
                } else {
                    await createUser(formData);
                }
                
            } catch (error) {
                console.error('‚ùå Error en env√≠o de formulario:', error);
                showMessage('Error: ' + error.message, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
        
        function collectUserFormData() {
            const formData = {
                user_name: document.getElementById('userName').value.trim(),
                user_display_name: document.getElementById('userDisplayName').value.trim() || null,
                user_mail: document.getElementById('userEmail').value.trim(),
                auth_provider: document.getElementById('authProvider').value,
                user_status: document.getElementById('userStatus').value,
                external_id: document.getElementById('externalId').value.trim() || null
            };
            
            // Solo incluir contrase√±a si es local Y si hay valor ingresado
            if (formData.auth_provider === 'local') {
                const password = document.getElementById('userPassword').value;
                if (password && password.trim() !== '') {
                    formData.user_password = password;
                }
                // Si estamos editando y no hay contrase√±a, no incluir el campo
                // Esto evita que se sobrescriba con null o vac√≠o
            }
            
            return formData;
        }
        
        
        // ==========================================
        // OPERACIONES CRUD
        // ==========================================
        
        async function createUser(userData) {
            try {
                console.log('üë§ Creando usuario:', userData);
                
                const newUser = await supabaseRequest('/users', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });
                
                const userId = Array.isArray(newUser) ? newUser[0].user_id : newUser.user_id;
                
                if (selectedRoles.length > 0) {
                    await assignRolesToUser(userId, selectedRoles);
                }
                
                showMessage('Usuario creado exitosamente', 'success');
                closeUserModal();
                await loadInitialData();
                
            } catch (error) {
                console.error('‚ùå Error creando usuario:', error);
                throw error;
            }
        }
        
        async function updateUser(userId, userData) {
            try {
                console.log('‚úèÔ∏è Actualizando usuario:', userId, userData);
                
                await supabaseRequest('/users?user_id=eq.' + userId, {
                    method: 'PATCH',
                    body: JSON.stringify(userData)
                });
                
                await updateUserRoles(userId, selectedRoles);
                
                showMessage('Usuario actualizado exitosamente', 'success');
                closeUserModal();
                await loadInitialData();
                
            } catch (error) {
                console.error('‚ùå Error actualizando usuario:', error);
                throw error;
            }
        }
        
        async function assignRolesToUser(userId, roleIds) {
            try {
                const assignments = roleIds.map(roleId => ({
                    user_id: userId,
                    role_id: roleId,
                    assigned_at: new Date().toISOString()
                }));
                
                await supabaseRequest('/user_roles', {
                    method: 'POST',
                    body: JSON.stringify(assignments)
                });
                
                console.log('‚úÖ Roles asignados al usuario');
            } catch (error) {
                console.error('‚ùå Error asignando roles:', error);
                throw error;
            }
        }
        
        async function updateUserRoles(userId, newRoleIds) {
            try {
                await supabaseRequest('/user_roles?user_id=eq.' + userId, {
                    method: 'DELETE'
                });
                
                if (newRoleIds.length > 0) {
                    await assignRolesToUser(userId, newRoleIds);
                }
                
                console.log('‚úÖ Roles actualizados para el usuario');
            } catch (error) {
                console.error('‚ùå Error actualizando roles:', error);
                throw error;
            }
        }
        
        async function editUser(userId) {
            try {
                console.log('‚úèÔ∏è Editando usuario:', userId);
                
                const userData = await supabaseRequest('/users?select=*&user_id=eq.' + userId);
                if (!userData || userData.length === 0) {
                    throw new Error('Usuario no encontrado');
                }
                
                currentEditingUser = userData[0];
                
                const userRoles = await supabaseRequest('/user_roles?select=role_id&user_id=eq.' + userId);
                selectedRoles = userRoles.map(ur => ur.role_id);
                
                populateUserForm(currentEditingUser);
                
                document.getElementById('modalTitle').textContent = 'Editar Usuario';
                document.getElementById('submitUserBtn').innerHTML = '<i class="bi bi-check-circle me-1"></i>Actualizar Usuario';
                
                loadRolesInModal();
                setTimeout(() => {
                    selectedRoles.forEach(roleId => {
                        const checkbox = document.getElementById('role_' + roleId);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                    updateSelectedRoles();
                }, 100);
                
                modalInstance.show();
                
            } catch (error) {
                console.error('‚ùå Error cargando usuario para edici√≥n:', error);
                showMessage('Error cargando usuario: ' + error.message, 'danger');
            }
        }
        
        function populateUserForm(user) {
            document.getElementById('userName').value = user.user_name || '';
            document.getElementById('userDisplayName').value = user.user_display_name || '';
            document.getElementById('userEmail').value = user.user_mail || '';
            document.getElementById('authProvider').value = user.auth_provider || '';
            document.getElementById('userStatus').value = user.user_status || 'active';
            document.getElementById('externalId').value = user.external_id || '';
            
            togglePasswordField();
        }
        
        // ==========================================
        // CAMBIO DE ESTADO
        // ==========================================
        
        function toggleUserStatus(userId) {
            const user = allUsers.find(u => u.user_id === userId);
            if (!user) {
                showMessage('Usuario no encontrado', 'danger');
                return;
            }
            
            currentToggleUserId = userId;
            
            const isCurrentlyActive = user.user_status === 'active';
            currentToggleAction = isCurrentlyActive ? 'deactivate' : 'activate';
            
            const title = document.getElementById('statusModalTitle');
            const icon = document.getElementById('statusModalIcon');
            const message = document.getElementById('statusModalMessage');
            const userInfo = document.getElementById('statusUserInfo');
            const confirmBtn = document.getElementById('confirmStatusBtn');
            
            if (isCurrentlyActive) {
                title.textContent = 'Inactivar Usuario';
                icon.className = 'bi bi-person-dash text-warning';
                message.textContent = '¬øEst√°s seguro de que deseas inactivar este usuario?';
                userInfo.textContent = 'Usuario: ' + (user.user_display_name || user.user_name) + ' (' + user.user_mail + ') - No podr√° acceder al sistema.';
                confirmBtn.className = 'btn btn-warning';
                confirmBtn.innerHTML = '<i class="bi bi-person-dash me-1"></i>Inactivar Usuario';
            } else {
                title.textContent = 'Activar Usuario';
                icon.className = 'bi bi-person-check text-success';
                message.textContent = '¬øEst√°s seguro de que deseas activar este usuario?';
                userInfo.textContent = 'Usuario: ' + (user.user_display_name || user.user_name) + ' (' + user.user_mail + ') - Podr√° acceder al sistema nuevamente.';
                confirmBtn.className = 'btn btn-success';
                confirmBtn.innerHTML = '<i class="bi bi-person-check me-1"></i>Activar Usuario';
            }
            
            statusModalInstance.show();
        }
        
        function closeStatusModal() {
            statusModalInstance.hide();
            currentToggleUserId = null;
            currentToggleAction = null;
        }
        
        async function confirmToggleUserStatus() {
            if (!currentToggleUserId || !currentToggleAction) return;
            
            const confirmBtn = document.getElementById('confirmStatusBtn');
            const originalText = confirmBtn.innerHTML;
            
            try {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
                
                const newStatus = currentToggleAction === 'activate' ? 'active' : 'inactive';
                
                await supabaseRequest('/users?user_id=eq.' + currentToggleUserId, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        user_status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                });
                
                const actionText = currentToggleAction === 'activate' ? 'activado' : 'inactivado';
                showMessage('Usuario ' + actionText + ' exitosamente', 'success');
                
                closeStatusModal();
                await loadInitialData();
                
            } catch (error) {
                console.error('‚ùå Error cambiando estado del usuario:', error);
                showMessage('Error cambiando estado del usuario: ' + error.message, 'danger');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalText;
            }
        }
        
        function manageUserRoles(userId) {
            window.location.href = 'user-roles.html?user=' + userId;
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function showMessage(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            
            const icons = {
                success: 'check-circle',
                danger: 'exclamation-triangle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${icons[type] || 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            alertContainer.innerHTML = alertHtml;
            
            if (type === 'success') {
                setTimeout(() => {
                    const alert = document.getElementById(alertId);
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==========================================
        // FIX CR√çTICO: Inputs en modales
        // ==========================================
        
        // Aplicar inmediatamente a TODOS los inputs del modal
        const allModalInputs = document.querySelectorAll('#userModal input');
        allModalInputs.forEach(input => {
            ['keydown', 'keypress', 'keyup', 'input'].forEach(eventType => {
                input.addEventListener(eventType, function(e) {
                    e.stopImmediatePropagation();
                    e.stopPropagation();
                }, true);
            });
        });
        
        // Reforzar cuando se abra el modal
        const userModal = document.getElementById('userModal');
        if (userModal) {
            userModal.addEventListener('shown.bs.modal', function() {
                setTimeout(() => {
                    const inputs = this.querySelectorAll('input');
                    inputs.forEach(input => {
                        ['keydown', 'keypress', 'keyup', 'input'].forEach(eventType => {
                            input.addEventListener(eventType, function(e) {
                                e.stopImmediatePropagation();
                                e.stopPropagation();
                            }, true);
                        });
                    });
                    console.log('‚úÖ Fix reforzado aplicado');
                }, 50);
            });
        }
        
        console.log('‚úÖ Fix cr√≠tico aplicado');
        console.log('üéâ Gesti√≥n de Usuarios cargada correctamente');
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        
        window.openCreateUserModal = openCreateUserModal;
        window.closeUserModal = closeUserModal;
        window.editUser = editUser;
        window.toggleUserStatus = toggleUserStatus;
        window.closeStatusModal = closeStatusModal;
        window.confirmToggleUserStatus = confirmToggleUserStatus;
        window.manageUserRoles = manageUserRoles;
        window.filterUsers = filterUsers;
        window.clearSearch = clearSearch;
        window.resetFilters = resetFilters;
        window.togglePasswordField = togglePasswordField;
        window.togglePassword = togglePassword;
        window.updateSelectedRoles = updateSelectedRoles;
        
        console.log('üéâ Gesti√≥n de Usuarios cargada correctamente');
    </script>
</body>
</html>
