<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Global de Formación - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSIÓN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8b5cf6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hero Header */
        .hero-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            margin-bottom: 2rem;
        }

        .hero-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .hero-subtitle {
            opacity: 0.95;
            font-size: 1.1rem;
        }

        /* Filters Card */
        .filters-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        /* Hero Metrics */
        .hero-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 1.5rem;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--metric-color);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            background: var(--metric-bg);
            color: var(--metric-color);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-change {
            font-size: 0.813rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .metric-change.positive {
            color: #10b981;
        }

        .metric-change.negative {
            color: #ef4444;
        }

        /* Metric Colors */
        .metric-card.primary {
            --metric-color: #8b5cf6;
            --metric-bg: #f3e8ff;
        }

        .metric-card.success {
            --metric-color: #10b981;
            --metric-bg: #d1fae5;
        }

        .metric-card.warning {
            --metric-color: #f59e0b;
            --metric-bg: #fef3c7;
        }

        .metric-card.danger {
            --metric-color: #ef4444;
            --metric-bg: #fee2e2;
        }

        /* Chart Cards */
        .chart-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f3f4f6;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-title i {
            color: #8b5cf6;
        }

        /* Canvas Container */
        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-container.tall {
            height: 400px;
        }

        /* Top List */
        .top-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .top-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .top-list-item:last-child {
            border-bottom: none;
        }

        .top-list-rank {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .top-list-info {
            flex-grow: 1;
            margin: 0 1rem;
        }

        .top-list-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.938rem;
        }

        .top-list-subtitle {
            font-size: 0.813rem;
            color: #6b7280;
        }

        .top-list-value {
            font-weight: 700;
            color: #8b5cf6;
            font-size: 1.1rem;
        }

        /* Alert Boxes */
        .alert-box {
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid;
            display: flex;
            align-items: start;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .alert-box.danger {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .alert-box.warning {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .alert-box-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .alert-box.danger .alert-box-icon {
            color: #ef4444;
        }

        .alert-box.warning .alert-box-icon {
            color: #f59e0b;
        }

        .alert-box-content h6 {
            margin: 0 0 0.5rem 0;
            font-weight: 600;
        }

        .alert-box-content p {
            margin: 0;
            font-size: 0.875rem;
        }

        /* Segmentation */
        .segmentation-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .segmentation-item:hover {
            background: #f9fafb;
        }

        .segmentation-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .segmentation-indicator.excellent { background: #10b981; }
        .segmentation-indicator.good { background: #3b82f6; }
        .segmentation-indicator.falling { background: #f59e0b; }
        .segmentation-indicator.critical { background: #ef4444; }

        .segmentation-info {
            flex-grow: 1;
        }

        .segmentation-label {
            font-weight: 500;
            color: #1f2937;
        }

        .segmentation-desc {
            font-size: 0.813rem;
            color: #6b7280;
        }

        .segmentation-value {
            font-weight: 700;
            font-size: 1.25rem;
            color: #1f2937;
        }

        /* Last Updated */
        .last-updated {
            text-align: right;
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 1.75rem;
            }
            
            .metric-value {
                font-size: 2rem;
            }
            
            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando dashboard...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Formación</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Dashboard Global
                </li>
            </ol>
        </nav>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- HERO HEADER -->
        <div class="hero-header">
            <div class="d-flex align-items-center justify-content-between flex-wrap">
                <div>
                    <h1 class="hero-title">
                        <i class="bi bi-graph-up-arrow me-2"></i>
                        Dashboard Global de Formación
                    </h1>
                    <p class="hero-subtitle mb-0">
                        Sistema Integral de Desarrollo del Talento Humano
                    </p>
                </div>
                <div class="text-end">
                    <button class="btn btn-light btn-lg" onclick="actualizarDashboard()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Actualizar
                    </button>
                </div>
            </div>
        </div>

        <!-- ÚLTIMA ACTUALIZACIÓN -->
        <div class="last-updated">
            <i class="bi bi-clock me-1"></i>
            Última actualización: <span id="last-update-time">--</span>
        </div>

        <!-- FILTROS GLOBALES -->
        <div class="card filters-card">
            <div class="card-body">
                <h6 class="mb-3">
                    <i class="bi bi-funnel me-2"></i>
                    Filtros Globales
                </h6>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="filter-date-range" class="form-label">Rango de Fechas</label>
                        <select class="form-select" id="filter-date-range">
                            <option value="all">Todas las fechas</option>
                            <option value="current-month">Mes actual</option>
                            <option value="last-3-months">Últimos 3 meses</option>
                            <option value="last-6-months">Últimos 6 meses</option>
                            <option value="current-year" selected>Año actual</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filter-axis" class="form-label">Eje Formativo</label>
                        <select class="form-select" id="filter-axis">
                            <option value="">Todos los ejes</option>
                            <!-- Se llena dinámicamente -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filter-division" class="form-label">Área Organizacional</label>
                        <select class="form-select" id="filter-division">
                            <option value="">Todas las áreas</option>
                            <!-- Se llena dinámicamente -->
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end gap-2">
                        <button class="btn btn-primary flex-grow-1" onclick="aplicarFiltros()">
                            <i class="bi bi-check-circle me-1"></i>Aplicar
                        </button>
                        <button class="btn btn-outline-secondary" onclick="limpiarFiltros()" title="Limpiar filtros">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- HERO METRICS -->
        <div class="hero-metrics">
            <!-- Métrica 1: Trabajadores Activos -->
            <div class="metric-card primary">
                <div class="metric-icon">
                    <i class="bi bi-people-fill"></i>
                </div>
                <div class="metric-value" id="metric-workers">--</div>
                <div class="metric-label">Trabajadores con Rutas</div>
            </div>

            <!-- Métrica 2: Total Unidades -->
            <div class="metric-card success">
                <div class="metric-icon">
                    <i class="bi bi-book-fill"></i>
                </div>
                <div class="metric-value" id="metric-total-units">--</div>
                <div class="metric-label">Unidades en Rutas</div>
            </div>

            <!-- Métrica 3: Tasa de Completación -->
            <div class="metric-card warning">
                <div class="metric-icon">
                    <i class="bi bi-trophy-fill"></i>
                </div>
                <div class="metric-value" id="metric-completion-rate">--%</div>
                <div class="metric-label">Tasa de Completación</div>
            </div>

            <!-- Métrica 4: Unidades Vencidas -->
            <div class="metric-card danger">
                <div class="metric-icon">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                </div>
                <div class="metric-value" id="metric-overdue">--</div>
                <div class="metric-label">Unidades Vencidas</div>
                <a href="path-queries.html?status=vencido" class="stretched-link"></a>
            </div>
        </div>
        <!-- FILA 1: SERIE TEMPORAL + PROGRESO POR EJE -->
        <div class="row">
            <!-- SERIE TEMPORAL -->
            <div class="col-lg-7 mb-4">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="chart-title">
                            <i class="bi bi-graph-up"></i>
                            Completaciones por Mes
                        </h5>
                        <small class="text-muted">Últimos 6 meses</small>
                    </div>
                    <div class="chart-container">
                        <canvas id="timeline-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- PROGRESO POR EJE -->
            <div class="col-lg-5 mb-4">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="chart-title">
                            <i class="bi bi-diagram-3"></i>
                            Progreso por Eje Formativo
                        </h5>
                    </div>
                    <div class="chart-container">
                        <canvas id="axis-progress-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- FILA 2: EMBUDO DE ESTADOS + TOP MÓDULOS + ALERTAS -->
        <div class="row">
            <!-- EMBUDO DE ESTADOS -->
            <div class="col-lg-4 mb-4">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="chart-title">
                            <i class="bi bi-funnel"></i>
                            Estados de Unidades
                        </h5>
                    </div>
                    <div class="chart-container">
                        <canvas id="status-funnel-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- TOP 5 MÓDULOS -->
            <div class="col-lg-4 mb-4">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="chart-title">
                            <i class="bi bi-star-fill"></i>
                            Top 5 Unidades Más Completadas
                        </h5>
                    </div>
                    <ul class="top-list" id="top-modules-list">
                        <!-- Se llena dinámicamente -->
                    </ul>
                </div>
            </div>

            <!-- ALERTAS CRÍTICAS -->
            <div class="col-lg-4 mb-4">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="chart-title">
                            <i class="bi bi-bell-fill"></i>
                            Alertas Críticas
                        </h5>
                    </div>
                    
                    <!-- Alerta Vencidas -->
                    <div class="alert-box danger">
                        <div class="alert-box-icon">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                        </div>
                        <div class="alert-box-content">
                            <h6>
                                <span id="alert-overdue-count">--</span> Unidades Vencidas
                            </h6>
                            <p>Requieren atención inmediata</p>
                            <a href="path-queries.html?status=vencido" class="btn btn-sm btn-outline-danger mt-2">
                                <i class="bi bi-arrow-right-circle me-1"></i>Ver Detalle
                            </a>
                        </div>
                    </div>

                    <!-- Alerta Críticas (>30 días vencidas) -->
                    <div class="alert-box warning">
                        <div class="alert-box-icon">
                            <i class="bi bi-fire"></i>
                        </div>
                        <div class="alert-box-content">
                            <h6>
                                <span id="alert-critical-count">--</span> Unidades Críticas
                            </h6>
                            <p>Vencidas hace más de 30 días</p>
                            <a href="path-queries.html?status=vencido&days=30" class="btn btn-sm btn-outline-warning mt-2">
                                <i class="bi bi-arrow-right-circle me-1"></i>Ver Detalle
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FILA 3: DISTRIBUCIONES + SEGMENTACIÓN -->
        <div class="row">
            <!-- DISTRIBUCIÓN POR MODALIDAD -->
            <div class="col-lg-4 mb-4">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="chart-title">
                            <i class="bi bi-laptop"></i>
                            Distribución por Modalidad
                        </h5>
                    </div>
                    <div class="chart-container">
                        <canvas id="modality-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- DISTRIBUCIÓN POR TIPO DE ASIGNACIÓN -->
            <div class="col-lg-4 mb-4">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="chart-title">
                            <i class="bi bi-tag"></i>
                            Tipo de Asignación
                        </h5>
                    </div>
                    <div class="chart-container">
                        <canvas id="assignment-type-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SEGMENTACIÓN DE TRABAJADORES -->
            <div class="col-lg-4 mb-4">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="chart-title">
                            <i class="bi bi-people"></i>
                            Segmentación de Trabajadores
                        </h5>
                    </div>
                    <div id="workers-segmentation">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        
    </div>

    <!-- SCRIPTS - ORDEN CRÍTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let rawData = [];
        let filteredData = [];
        let charts = {};
        
        // Configuración de colores
        const COLORS = {
            primary: '#8b5cf6',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            info: '#3b82f6',
            gray: '#6b7280',
            purple: '#a855f7',
            cyan: '#06b6d4',
            pink: '#ec4899'
        };
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Dashboard global de formación');
                if (!hasAccess) {
                    console.log('❌ Acceso denegado');
                    return;
                }
                
                console.log('✅ Acceso permitido - cargando dashboard');
                await inicializarDashboard();
                
            } catch (error) {
                console.error('❌ Error en validación de acceso:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });
        
        // ==========================================
        // INICIALIZACIÓN DEL DASHBOARD
        // ==========================================
        async function inicializarDashboard() {
            try {
                mostrarLoading();
                
                // Cargar datos completos
                await cargarDatosCompletos();
                
                // Cargar opciones de filtros
                cargarOpcionesFiltros();
                
                // Aplicar filtros iniciales (año actual)
                aplicarFiltros();
                
                // Actualizar timestamp
                actualizarTimestamp();
                
                ocultarLoading();
                console.log('✅ Dashboard inicializado correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando dashboard:', error);
                showMessage('Error al cargar el dashboard: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR DATOS COMPLETOS - CORRECTO
        // ==========================================
        async function cargarDatosCompletos() {
            try {
                console.log('📡 Cargando datos del dashboard...');
                
                // Query correcta: workers tiene campos directos de organización
                const data = await supabaseRequest(
                    '/worker_training_paths?select=*,' +
                    'training_modules(module_id,module_code,module_title,axis_id,training_axes(axis_name),training_modalities(modality_name)),' +
                    'workers(worker_id,organizational_areas(area_id,area_name))' +
                    '&path_status=eq.active'
                );
                
                rawData = data || [];
                console.log(`✅ ${rawData.length} registros cargados`);
                
            } catch (error) {
                console.error('❌ Error cargando datos:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR OPCIONES DE FILTROS - CORRECTO
        // ==========================================
        function cargarOpcionesFiltros() {
            // Extraer ejes únicos
            const axes = [...new Set(rawData
                .filter(d => d.training_modules?.training_axes)
                .map(d => JSON.stringify({
                    id: d.training_modules.axis_id,
                    name: d.training_modules.training_axes.axis_name
                }))
            )].map(str => JSON.parse(str));
            
            const axisSelect = document.getElementById('filter-axis');
            axisSelect.innerHTML = '<option value="">Todos los ejes</option>' + 
                axes.map(axis => `<option value="${axis.id}">${escapeHtml(axis.name)}</option>`).join('');
            
            // Extraer áreas organizacionales únicas
            const areas = [...new Set(rawData
                .filter(d => d.workers?.organizational_areas)
                .map(d => JSON.stringify({
                    id: d.workers.organizational_areas.area_id,
                    name: d.workers.organizational_areas.area_name
                }))
            )].map(str => JSON.parse(str));
            
            const areaSelect = document.getElementById('filter-division');
            areaSelect.innerHTML = '<option value="">Todas las áreas</option>' + 
                areas.map(area => `<option value="${area.id}">${escapeHtml(area.name)}</option>`).join('');
        }
        
        // ==========================================
        // APLICAR FILTROS - AJUSTADO
        // ==========================================
        function aplicarFiltros() {
            const dateRange = document.getElementById('filter-date-range').value;
            const axisFilter = document.getElementById('filter-axis').value;
            const areaFilter = document.getElementById('filter-division').value; // Ahora es área
            
            mostrarLoading();
            
            // Filtrar datos
            filteredData = rawData.filter(item => {
                // Filtro de fecha
                if (dateRange !== 'all') {
                    const assignmentDate = new Date(item.assignment_date);
                    const now = new Date();
                    
                    switch(dateRange) {
                        case 'current-month':
                            if (assignmentDate.getMonth() !== now.getMonth() || 
                                assignmentDate.getFullYear() !== now.getFullYear()) {
                                return false;
                            }
                            break;
                        case 'last-3-months':
                            const threeMonthsAgo = new Date(now);
                            threeMonthsAgo.setMonth(now.getMonth() - 3);
                            if (assignmentDate < threeMonthsAgo) return false;
                            break;
                        case 'last-6-months':
                            const sixMonthsAgo = new Date(now);
                            sixMonthsAgo.setMonth(now.getMonth() - 6);
                            if (assignmentDate < sixMonthsAgo) return false;
                            break;
                        case 'current-year':
                            if (assignmentDate.getFullYear() !== now.getFullYear()) {
                                return false;
                            }
                            break;
                    }
                }
                
                // Filtro de eje
                if (axisFilter && item.training_modules?.axis_id !== axisFilter) {
                    return false;
                }
                
                // Filtro de área organizacional
                // Filtro de área organizacional
                if (areaFilter && item.workers?.organizational_areas?.area_id !== areaFilter) {
                    return false;
                }
                
                return true;
            });
            
            console.log(`🔍 Filtros aplicados: ${filteredData.length} registros`);
            
            // Renderizar todo el dashboard
            renderizarDashboard();
            
            ocultarLoading();
        }
        
        // ==========================================
        // LIMPIAR FILTROS
        // ==========================================
        function limpiarFiltros() {
            document.getElementById('filter-date-range').value = 'current-year';
            document.getElementById('filter-axis').value = '';
            document.getElementById('filter-division').value = '';
            aplicarFiltros();
        }
      // ==========================================
        // RENDERIZAR DASHBOARD COMPLETO
        // ==========================================
        function renderizarDashboard() {
            // Destruir charts existentes
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            // 1. Hero Metrics
            renderizarHeroMetrics();
            
            // 2. Serie Temporal
            renderizarSerieTemporal();
            
            // 3. Progreso por Eje
            renderizarProgresoEjes();
            
            // 4. Embudo de Estados
            renderizarEmbudoEstados();
            
            // 5. Top Módulos
            renderizarTopModulos();
            
            // 6. Alertas
            renderizarAlertas();
            
            // 7. Distribución por Modalidad
            renderizarDistribucionModalidad();
            
            // 8. Distribución por Tipo de Asignación
            renderizarDistribucionAsignacion();
            
            // 9. Segmentación de Trabajadores
            renderizarSegmentacionTrabajadores();
            
            console.log('✅ Dashboard renderizado completamente');
        }
        
        // ==========================================
        // 1. HERO METRICS
        // ==========================================
        function renderizarHeroMetrics() {
            // Trabajadores únicos
            const uniqueWorkers = new Set(filteredData.map(d => d.worker_id));
            document.getElementById('metric-workers').textContent = uniqueWorkers.size;
            
            // Total unidades
            const totalUnits = filteredData.length;
            document.getElementById('metric-total-units').textContent = totalUnits.toLocaleString('es-CO');
            
            // Tasa de completación
            const completed = filteredData.filter(d => d.completion_status === 'Completado').length;
            const completionRate = totalUnits > 0 ? Math.round((completed / totalUnits) * 100) : 0;
            document.getElementById('metric-completion-rate').textContent = completionRate + '%';
            
            // Unidades vencidas
            const overdue = filteredData.filter(d => d.completion_status === 'Vencido').length;
            document.getElementById('metric-overdue').textContent = overdue.toLocaleString('es-CO');
        }
        
        // ==========================================
        // 2. SERIE TEMPORAL
        // ==========================================
        function renderizarSerieTemporal() {
            // Obtener completaciones de los últimos 6 meses
            const now = new Date();
            const sixMonthsAgo = new Date(now);
            sixMonthsAgo.setMonth(now.getMonth() - 6);
            
            const completedByMonth = {};
            
            // Inicializar últimos 6 meses
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now);
                date.setMonth(now.getMonth() - i);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const label = date.toLocaleDateString('es-CO', { month: 'short', year: '2-digit' });
                completedByMonth[key] = { label, count: 0 };
            }
            
            // Contar completaciones
            filteredData
                .filter(d => d.completion_status === 'Completado' && d.actual_completion_date)
                .forEach(d => {
                    const date = new Date(d.actual_completion_date);
                    if (date >= sixMonthsAgo) {
                        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        if (completedByMonth[key]) {
                            completedByMonth[key].count++;
                        }
                    }
                });
            
            const labels = Object.values(completedByMonth).map(m => m.label);
            const data = Object.values(completedByMonth).map(m => m.count);
            
            const ctx = document.getElementById('timeline-chart').getContext('2d');
            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Unidades Completadas',
                        data: data,
                        borderColor: COLORS.success,
                        backgroundColor: COLORS.success + '20',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointBackgroundColor: COLORS.success,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} unidad${context.parsed.y !== 1 ? 'es' : ''} completada${context.parsed.y !== 1 ? 's' : ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            },
                            grid: {
                                color: '#f3f4f6'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // 3. PROGRESO POR EJE
        // ==========================================
        function renderizarProgresoEjes() {
            // Agrupar por eje
            const axisData = {};
            
            filteredData.forEach(d => {
                if (d.training_modules?.training_axes) {
                    const axisName = d.training_modules.training_axes.axis_name;
                    if (!axisData[axisName]) {
                        axisData[axisName] = { total: 0, completed: 0 };
                    }
                    axisData[axisName].total++;
                    if (d.completion_status === 'Completado') {
                        axisData[axisName].completed++;
                    }
                }
            });
            
            // Calcular porcentajes y ordenar
            const axisArray = Object.entries(axisData)
                .map(([name, data]) => ({
                    name,
                    rate: data.total > 0 ? (data.completed / data.total) * 100 : 0,
                    total: data.total,
                    completed: data.completed
                }))
                .sort((a, b) => b.rate - a.rate);
            
            if (axisArray.length === 0) {
                document.getElementById('axis-progress-chart').parentElement.innerHTML = 
                    '<p class="text-center text-muted py-5">No hay datos disponibles</p>';
                return;
            }
            
            const labels = axisArray.map(a => a.name);
            const data = axisArray.map(a => a.rate);
            
            const ctx = document.getElementById('axis-progress-chart').getContext('2d');
            charts.axisProgress = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tasa de Completación (%)',
                        data: data,
                        backgroundColor: [
                            COLORS.primary,
                            COLORS.info,
                            COLORS.success,
                            COLORS.warning,
                            COLORS.purple,
                            COLORS.cyan
                        ],
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const axis = axisArray[index];
                                    return [
                                        `Completación: ${Math.round(axis.rate)}%`,
                                        `Completadas: ${axis.completed}`,
                                        `Total: ${axis.total}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: '#f3f4f6'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // 4. EMBUDO DE ESTADOS
        // ==========================================
        function renderizarEmbudoEstados() {
            const statusCount = {
                'Total': filteredData.length,
                'Pendiente': filteredData.filter(d => d.completion_status === 'Pendiente').length,
                'En progreso': filteredData.filter(d => d.completion_status === 'En progreso').length,
                'Completado': filteredData.filter(d => d.completion_status === 'Completado').length,
                'Vencido': filteredData.filter(d => d.completion_status === 'Vencido').length,
                'Eximido': filteredData.filter(d => d.completion_status === 'Eximido').length
            };
            
            const labels = Object.keys(statusCount);
            const data = Object.values(statusCount);
            
            const ctx = document.getElementById('status-funnel-chart').getContext('2d');
            charts.statusFunnel = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Unidades',
                        data: data,
                        backgroundColor: [
                            COLORS.gray,
                            COLORS.warning,
                            COLORS.info,
                            COLORS.success,
                            COLORS.danger,
                            COLORS.purple
                        ],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const total = statusCount['Total'];
                                    const value = context.parsed.y;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${value} unidades (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            },
                            grid: {
                                color: '#f3f4f6'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // 5. TOP MÓDULOS
        // ==========================================
        function renderizarTopModulos() {
            // Contar completaciones por módulo
            const moduleCount = {};
            
            filteredData
                .filter(d => d.completion_status === 'Completado' && d.training_modules)
                .forEach(d => {
                    const moduleId = d.module_id;
                    const module = d.training_modules;
                    
                    if (!moduleCount[moduleId]) {
                        moduleCount[moduleId] = {
                            code: module.module_code || 'S/C',
                            title: module.module_title,
                            count: 0
                        };
                    }
                    moduleCount[moduleId].count++;
                });
            
            // Obtener top 5
            const topModules = Object.values(moduleCount)
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);
            
            const listHtml = topModules.length > 0
                ? topModules.map((module, index) => `
                    <li class="top-list-item">
                        <div class="top-list-rank">${index + 1}</div>
                        <div class="top-list-info">
                            <div class="top-list-title">${escapeHtml(module.title)}</div>
                            <div class="top-list-subtitle">${escapeHtml(module.code)}</div>
                        </div>
                        <div class="top-list-value">${module.count}</div>
                    </li>
                `).join('')
                : '<li class="text-center text-muted py-4">No hay datos disponibles</li>';
            
            document.getElementById('top-modules-list').innerHTML = listHtml;
        }
        
        // ==========================================
        // 6. ALERTAS
        // ==========================================
        function renderizarAlertas() {
            const overdue = filteredData.filter(d => d.completion_status === 'Vencido').length;
            
            // Críticas: vencidas hace más de 30 días
            const now = new Date();
            const critical = filteredData.filter(d => {
                if (d.completion_status !== 'Vencido' || !d.target_completion_date) return false;
                const targetDate = new Date(d.target_completion_date);
                const diffDays = Math.floor((now - targetDate) / (1000 * 60 * 60 * 24));
                return diffDays > 30;
            }).length;
            
            document.getElementById('alert-overdue-count').textContent = overdue;
            document.getElementById('alert-critical-count').textContent = critical;
        }
      // ==========================================
        // 7. DISTRIBUCIÓN POR MODALIDAD
        // ==========================================
        function renderizarDistribucionModalidad() {
            const modalityCount = {};
            
            filteredData.forEach(d => {
                if (d.training_modules?.training_modalities) {
                    const modality = d.training_modules.training_modalities.modality_name;
                    modalityCount[modality] = (modalityCount[modality] || 0) + 1;
                }
            });
            
            if (Object.keys(modalityCount).length === 0) {
                document.getElementById('modality-chart').parentElement.innerHTML = 
                    '<p class="text-center text-muted py-5">No hay datos disponibles</p>';
                return;
            }
            
            const labels = Object.keys(modalityCount);
            const data = Object.values(modalityCount);
            
            const ctx = document.getElementById('modality-chart').getContext('2d');
            charts.modality = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            COLORS.primary,
                            COLORS.info,
                            COLORS.success,
                            COLORS.warning,
                            COLORS.pink,
                            COLORS.cyan
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // 8. DISTRIBUCIÓN POR TIPO DE ASIGNACIÓN
        // ==========================================
        function renderizarDistribucionAsignacion() {
            const assignmentCount = {};
            
            filteredData.forEach(d => {
                const type = d.assignment_type || 'Sin especificar';
                assignmentCount[type] = (assignmentCount[type] || 0) + 1;
            });
            
            if (Object.keys(assignmentCount).length === 0) {
                document.getElementById('assignment-type-chart').parentElement.innerHTML = 
                    '<p class="text-center text-muted py-5">No hay datos disponibles</p>';
                return;
            }
            
            const labels = Object.keys(assignmentCount);
            const data = Object.values(assignmentCount);
            
            const ctx = document.getElementById('assignment-type-chart').getContext('2d');
            charts.assignmentType = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            COLORS.primary,
                            COLORS.warning,
                            COLORS.gray,
                            COLORS.info
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // 9. SEGMENTACIÓN DE TRABAJADORES
        // ==========================================
        function renderizarSegmentacionTrabajadores() {
            // Calcular % de completación por trabajador
            const workerProgress = {};
            
            filteredData.forEach(d => {
                const workerId = d.worker_id;
                if (!workerProgress[workerId]) {
                    workerProgress[workerId] = { total: 0, completed: 0 };
                }
                workerProgress[workerId].total++;
                if (d.completion_status === 'Completado') {
                    workerProgress[workerId].completed++;
                }
            });
            
            // Segmentar por % de completación
            const segmentation = {
                excellent: 0,  // >= 80%
                good: 0,       // 50-79%
                falling: 0,    // 20-49%
                critical: 0    // < 20%
            };
            
            Object.values(workerProgress).forEach(worker => {
                const percentage = (worker.completed / worker.total) * 100;
                if (percentage >= 80) segmentation.excellent++;
                else if (percentage >= 50) segmentation.good++;
                else if (percentage >= 20) segmentation.falling++;
                else segmentation.critical++;
            });
            
            const segmentHtml = `
                <div class="segmentation-item">
                    <div class="segmentation-indicator excellent"></div>
                    <div class="segmentation-info">
                        <div class="segmentation-label">🟢 Excelente</div>
                        <div class="segmentation-desc">≥80% completado</div>
                    </div>
                    <div class="segmentation-value">${segmentation.excellent}</div>
                </div>
                <div class="segmentation-item">
                    <div class="segmentation-indicator good"></div>
                    <div class="segmentation-info">
                        <div class="segmentation-label">🔵 Buen Avance</div>
                        <div class="segmentation-desc">50-79% completado</div>
                    </div>
                    <div class="segmentation-value">${segmentation.good}</div>
                </div>
                <div class="segmentation-item">
                    <div class="segmentation-indicator falling"></div>
                    <div class="segmentation-info">
                        <div class="segmentation-label">🟡 Rezagados</div>
                        <div class="segmentation-desc">20-49% completado</div>
                    </div>
                    <div class="segmentation-value">${segmentation.falling}</div>
                </div>
                <div class="segmentation-item">
                    <div class="segmentation-indicator critical"></div>
                    <div class="segmentation-info">
                        <div class="segmentation-label">🔴 Críticos</div>
                        <div class="segmentation-desc">&lt;20% completado</div>
                    </div>
                    <div class="segmentation-value">${segmentation.critical}</div>
                </div>
            `;
            
            document.getElementById('workers-segmentation').innerHTML = segmentHtml;
        }
        
        // ==========================================
        // ACTUALIZAR DASHBOARD
        // ==========================================
        async function actualizarDashboard() {
            try {
                mostrarLoading();
                
                // Recargar datos
                await cargarDatosCompletos();
                
                // Aplicar filtros actuales
                aplicarFiltros();
                
                // Actualizar timestamp
                actualizarTimestamp();
                
                showMessage('Dashboard actualizado correctamente', 'success');
                ocultarLoading();
                
            } catch (error) {
                console.error('❌ Error actualizando dashboard:', error);
                showMessage('Error al actualizar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // ACTUALIZAR TIMESTAMP
        // ==========================================
        function actualizarTimestamp() {
            const now = new Date();
            const timeString = now.toLocaleString('es-CO', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('last-update-time').textContent = timeString;
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.aplicarFiltros = aplicarFiltros;
        window.limpiarFiltros = limpiarFiltros;
        window.actualizarDashboard = actualizarDashboard;
        
        console.log('🎉 Dashboard global de formación cargado correctamente');
    </script>
</body>
</html>
