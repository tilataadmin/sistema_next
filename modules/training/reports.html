<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes de Formaci√≥n - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- jsPDF y jsPDF-AutoTable para exportaci√≥n PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Filtros Section */
        .filters-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        .filters-card .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            padding: 1rem 1.5rem;
        }
        
        .filter-label {
            font-weight: 500;
            font-size: 0.875rem;
            color: #495057;
            margin-bottom: 0.25rem;
        }
        
        /* Report Type Selector */
        .report-type-selector {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
            margin-bottom: 1rem;
        }
        
        .report-type-selector select {
            font-size: 1.1rem;
            font-weight: 600;
            color: #667eea;
        }
        
        /* Generate Button */
        .btn-generate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 0.75rem 2rem;
            font-weight: 600;
            font-size: 1.1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        /* Preview Section */
        .preview-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            min-height: 400px;
        }
        
        .preview-card .card-header {
            background: white;
            border-bottom: 2px solid #e9ecef;
            padding: 1.25rem 1.5rem;
        }
        
        .preview-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }
        
        .preview-empty i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        /* Report Table */
        .report-table {
            width: 100%;
            font-size: 0.875rem;
        }
        
        .report-table thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .report-table th {
            font-weight: 600;
            color: #495057;
            padding: 0.75rem;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }
        
        .report-table td {
            padding: 0.75rem;
            vertical-align: middle;
        }
        
        .report-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Progress Bars in Tables */
        .table-progress {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            overflow: hidden;
        }
        
        .table-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        /* Status Badges */
        .badge-completado {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        
        .badge-pendiente {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .badge-en-progreso {
            background-color: #cfe2ff;
            color: #084298;
        }
        
        .badge-vencido {
            background-color: #f8d7da;
            color: #842029;
        }
        
        /* Deadline Badges */
        .deadline-urgent {
            background-color: #f8d7da;
            color: #842029;
            font-weight: 600;
        }
        
        .deadline-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .deadline-normal {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        /* Quick Reports Cards */
        .quick-report-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.25rem;
            transition: all 0.2s ease;
            cursor: pointer;
            height: 100%;
        }
        
        .quick-report-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }
        
        .quick-report-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
        }
        
        .quick-report-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .quick-report-desc {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .btn-export {
            padding: 0.5rem 1.25rem;
            border-radius: 6px;
            font-weight: 500;
            border: 2px solid;
            transition: all 0.2s ease;
        }
        
        .btn-export:hover {
            transform: translateY(-1px);
        }
        
        .btn-export-pdf {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        
        .btn-export-pdf:hover {
            background-color: #bb2d3b;
            border-color: #bb2d3b;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .export-buttons {
                flex-direction: column;
            }
            
            .btn-export {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Generando reporte...</p>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Formaci√≥n</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Reportes de Formaci√≥n
                </li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-file-earmark-bar-graph me-2"></i>
                    Reportes de Formaci√≥n
                </h1>
                <p class="text-muted">
                    Genera reportes personalizados de progreso, cumplimiento y an√°lisis de formaci√≥n
                </p>
            </div>
        </div>

        <!-- Contenedor de Alertas -->
        <div id="alertContainer"></div>

        <!-- Secci√≥n de Filtros y Generaci√≥n -->
        <div class="card filters-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-funnel me-2"></i>
                    Configuraci√≥n del Reporte
                </h5>
            </div>
            <div class="card-body">
                <!-- Selector de Tipo de Reporte -->
                <div class="report-type-selector">
                    <label class="filter-label">
                        <i class="bi bi-file-earmark-text me-1"></i>
                        Tipo de Reporte <span class="text-danger">*</span>
                    </label>
                    <select class="form-select form-select-lg" id="report-type">
                        <option value="">Seleccione un tipo de reporte...</option>
                        <option value="completaciones">üìã Reporte de Completaciones</option>
                        <option value="cumplimiento-trabajador">üë§ Cumplimiento por Trabajador</option>
                        <option value="cumplimiento-eje">üìä Cumplimiento por Eje Formativo</option>
                        <option value="certificaciones">üèÜ Reporte de Certificaciones</option>
                        <option value="vencimientos">‚è∞ Reporte de Vencimientos</option>
                        <option value="mas-solicitados">‚≠ê M√≥dulos M√°s Solicitados</option>
                        <option value="comparativo-areas">üìà Comparativo por √Årea Organizacional</option>
                    </select>
                </div>

                <!-- Filtros Avanzados -->
                <div class="row g-3">
                    <!-- Rango de Fechas -->
                    <div class="col-md-3">
                        <label class="filter-label">
                            <i class="bi bi-calendar-range me-1"></i>
                            Fecha Desde
                        </label>
                        <input type="date" class="form-control" id="filter-date-from">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="filter-label">
                            <i class="bi bi-calendar-range me-1"></i>
                            Fecha Hasta
                        </label>
                        <input type="date" class="form-control" id="filter-date-to">
                    </div>

                    <!-- Trabajador -->
                    <div class="col-md-6">
                        <label class="filter-label">
                            <i class="bi bi-person me-1"></i>
                            Trabajador(es)
                        </label>
                        <select class="form-select" id="filter-workers" multiple size="3">
                            <option value="">Todos los trabajadores</option>
                            <!-- Se llena din√°micamente -->
                        </select>
                        <small class="text-muted">Mant√©n Ctrl/Cmd para seleccionar m√∫ltiples</small>
                    </div>

                    <!-- Eje Formativo -->
                    <div class="col-md-4">
                        <label class="filter-label">
                            <i class="bi bi-bookmark me-1"></i>
                            Eje(s) Formativo(s)
                        </label>
                        <select class="form-select" id="filter-axes" multiple size="3">
                            <option value="">Todos los ejes</option>
                            <!-- Se llena din√°micamente -->
                        </select>
                    </div>

                    <!-- Modalidad -->
                    <div class="col-md-4">
                        <label class="filter-label">
                            <i class="bi bi-display me-1"></i>
                            Modalidad(es)
                        </label>
                        <select class="form-select" id="filter-modalities" multiple size="3">
                            <option value="">Todas las modalidades</option>
                            <!-- Se llena din√°micamente -->
                        </select>
                    </div>

                    <!-- Estado -->
                    <div class="col-md-4">
                        <label class="filter-label">
                            <i class="bi bi-check-circle me-1"></i>
                            Estado(s)
                        </label>
                        <select class="form-select" id="filter-status" multiple size="3">
                            <option value="">Todos los estados</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="En progreso">En Progreso</option>
                            <option value="Completado">Completado</option>
                            <option value="Vencido">Vencido</option>
                        </select>
                    </div>

                    <!-- √Årea Organizacional -->
                    <div class="col-md-4">
                        <label class="filter-label">
                            <i class="bi bi-diagram-3 me-1"></i>
                            √Årea Organizacional
                        </label>
                        <select class="form-select" id="filter-areas">
                            <option value="">Todas las √°reas</option>
                            <!-- Se llena din√°micamente -->
                        </select>
                    </div>

                    <!-- Divisi√≥n Organizacional -->
                    <div class="col-md-4">
                        <label class="filter-label">
                            <i class="bi bi-building me-1"></i>
                            Divisi√≥n Organizacional
                        </label>
                        <select class="form-select" id="filter-divisions">
                            <option value="">Todas las divisiones</option>
                            <!-- Se llena din√°micamente -->
                        </select>
                    </div>

                    <!-- Tipo de Asignaci√≥n -->
                    <div class="col-md-4">
                        <label class="filter-label">
                            <i class="bi bi-tag me-1"></i>
                            Tipo de Asignaci√≥n
                        </label>
                        <select class="form-select" id="filter-assignment-type">
                            <option value="">Todos los tipos</option>
                            <option value="Por rol">Por rol</option>
                            <option value="Por inter√©s">Por inter√©s</option>
                            <option value="Administrativo">Administrativo</option>
                        </select>
                    </div>

                    <!-- Certificable -->
                    <div class="col-md-6">
                        <label class="filter-label">
                            <i class="bi bi-award me-1"></i>
                            M√≥dulos Certificables
                        </label>
                        <select class="form-select" id="filter-certifiable">
                            <option value="">Todos</option>
                            <option value="true">Solo certificables</option>
                            <option value="false">Solo no certificables</option>
                        </select>
                    </div>

                    <!-- Bot√≥n de Limpiar Filtros -->
                    <div class="col-md-6 d-flex align-items-end">
                        <button class="btn btn-outline-secondary w-100" onclick="limpiarFiltros()">
                            <i class="bi bi-x-circle me-1"></i>
                            Limpiar Filtros
                        </button>
                    </div>
                </div>

                <!-- Bot√≥n de Generaci√≥n -->
                <div class="text-center mt-4">
                    <button class="btn btn-primary btn-generate" onclick="generarReporte()">
                        <i class="bi bi-play-circle me-2"></i>
                        Generar Reporte
                    </button>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Vista Previa -->
        <div class="card preview-card mt-4" id="preview-section" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0" id="preview-title">
                    <i class="bi bi-file-earmark-bar-graph me-2"></i>
                    Vista Previa del Reporte
                </h5>
                <div class="export-buttons">
                    <button class="btn btn-export btn-export-pdf" onclick="exportarPDF()">
                        <i class="bi bi-file-pdf me-1"></i>
                        Exportar PDF
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="preview-content">
                    <!-- Se llena din√°micamente seg√∫n el tipo de reporte -->
                </div>
            </div>
        </div>

        <!-- Reportes R√°pidos -->
        <div class="row mt-5 mb-4">
            <div class="col-12">
                <h5 class="mb-3">
                    <i class="bi bi-lightning-charge me-2"></i>
                    Reportes R√°pidos
                </h5>
            </div>

            <!-- Quick Report 1 -->
            <div class="col-12 col-md-6 col-lg-4 mb-3">
                <div class="quick-report-card" onclick="generarReporteRapido('mes-actual')">
                    <div class="quick-report-icon bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-calendar-check"></i>
                    </div>
                    <div class="quick-report-title">Completaciones del Mes Actual</div>
                    <div class="quick-report-desc">Todos los m√≥dulos completados en el mes en curso</div>
                </div>
            </div>

            <!-- Quick Report 2 -->
            <div class="col-12 col-md-6 col-lg-4 mb-3">
                <div class="quick-report-card" onclick="generarReporteRapido('vencimientos-proximos')">
                    <div class="quick-report-icon bg-danger bg-opacity-10 text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <div class="quick-report-title">Vencimientos Pr√≥ximos (7 d√≠as)</div>
                    <div class="quick-report-desc">M√≥dulos que vencen en los pr√≥ximos 7 d√≠as</div>
                </div>
            </div>

            <!-- Quick Report 3 -->
            <div class="col-12 col-md-6 col-lg-4 mb-3">
                <div class="quick-report-card" onclick="generarReporteRapido('top-trabajadores')">
                    <div class="quick-report-icon bg-success bg-opacity-10 text-success">
                        <i class="bi bi-trophy"></i>
                    </div>
                    <div class="quick-report-title">Top 10 Trabajadores</div>
                    <div class="quick-report-desc">Trabajadores con mayor % de completaci√≥n</div>
                </div>
            </div>

            <!-- Quick Report 4 -->
            <div class="col-12 col-md-6 col-lg-4 mb-3">
                <div class="quick-report-card" onclick="generarReporteRapido('certificaciones-trimestre')">
                    <div class="quick-report-icon bg-warning bg-opacity-10 text-warning">
                        <i class="bi bi-award"></i>
                    </div>
                    <div class="quick-report-title">Certificaciones del Trimestre</div>
                    <div class="quick-report-desc">M√≥dulos certificables completados en √∫ltimos 3 meses</div>
                </div>
            </div>

            <!-- Quick Report 5 -->
            <div class="col-12 col-md-6 col-lg-4 mb-3">
                <div class="quick-report-card" onclick="generarReporteRapido('sin-completar')">
                    <div class="quick-report-icon bg-secondary bg-opacity-10 text-secondary">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                    <div class="quick-report-title">M√≥dulos Sin Completar</div>
                    <div class="quick-report-desc">Todos los m√≥dulos pendientes y en progreso</div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let reportData = null;
        let currentReportType = null;
        let chartInstances = [];
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Validando acceso a reportes de formaci√≥n...');
            
            try {
                // Validar permisos
                const hasAccess = await validatePageAccess('Reportes de formaci√≥n');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - inicializando reportes');
                await inicializarReportes();
                
            } catch (error) {
                console.error('‚ùå Error validando acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // INICIALIZACI√ìN DE REPORTES
        // ==========================================
        async function inicializarReportes() {
            try {
                mostrarLoading();
                
                // Cargar opciones de filtros en paralelo
                await Promise.all([
                    cargarTrabajadores(),
                    cargarEjes(),
                    cargarModalidades(),
                    cargarAreas(),
                    cargarDivisiones()
                ]);
                
                // Configurar fecha hasta = hoy
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('filter-date-to').value = today;
                
                ocultarLoading();
                console.log('‚úÖ Reportes inicializados correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando reportes:', error);
                showMessage('Error al cargar opciones de filtros: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR TRABAJADORES PARA FILTRO
        // ==========================================
        async function cargarTrabajadores() {
            try {
                const workers = await supabaseRequest('/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2&worker_status=eq.active&order=worker_first_name.asc');
                
                const select = document.getElementById('filter-workers');
                select.innerHTML = '<option value="">Todos los trabajadores</option>';
                
                workers.forEach(worker => {
                    const fullName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
                    const option = document.createElement('option');
                    option.value = worker.worker_id;
                    option.textContent = fullName;
                    select.appendChild(option);
                });
                
                console.log('‚úÖ Trabajadores cargados:', workers.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando trabajadores:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR EJES FORMATIVOS
        // ==========================================
        async function cargarEjes() {
            try {
                const axes = await supabaseRequest('/training_axes?select=axis_id,axis_name&axis_status=eq.active&order=axis_order.asc');
                
                const select = document.getElementById('filter-axes');
                select.innerHTML = '<option value="">Todos los ejes</option>';
                
                axes.forEach(axis => {
                    const option = document.createElement('option');
                    option.value = axis.axis_id;
                    option.textContent = axis.axis_name;
                    select.appendChild(option);
                });
                
                console.log('‚úÖ Ejes cargados:', axes.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando ejes:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR MODALIDADES
        // ==========================================
        async function cargarModalidades() {
            try {
                const modalities = await supabaseRequest('/training_modalities?select=modality_id,modality_name&modality_status=eq.active&order=modality_name.asc');
                
                const select = document.getElementById('filter-modalities');
                select.innerHTML = '<option value="">Todas las modalidades</option>';
                
                modalities.forEach(modality => {
                    const option = document.createElement('option');
                    option.value = modality.modality_id;
                    option.textContent = modality.modality_name;
                    select.appendChild(option);
                });
                
                console.log('‚úÖ Modalidades cargadas:', modalities.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando modalidades:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR √ÅREAS ORGANIZACIONALES
        // ==========================================
        async function cargarAreas() {
            try {
                const areas = await supabaseRequest('/organizational_areas?select=area_id,area_name&area_status=eq.active&order=area_order.asc');
                
                const select = document.getElementById('filter-areas');
                select.innerHTML = '<option value="">Todas las √°reas</option>';
                
                areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.area_id;
                    option.textContent = area.area_name;
                    select.appendChild(option);
                });
                
                console.log('‚úÖ √Åreas cargadas:', areas.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando √°reas:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR DIVISIONES ORGANIZACIONALES
        // ==========================================
        async function cargarDivisiones() {
            try {
                const divisions = await supabaseRequest('/organizational_divisions?select=division_id,division_name&division_status=eq.active&order=division_order.asc');
                
                const select = document.getElementById('filter-divisions');
                select.innerHTML = '<option value="">Todas las divisiones</option>';
                
                divisions.forEach(division => {
                    const option = document.createElement('option');
                    option.value = division.division_id;
                    option.textContent = division.division_name;
                    select.appendChild(option);
                });
                
                console.log('‚úÖ Divisiones cargadas:', divisions.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando divisiones:', error);
                throw error;
            }
        }
        
        // ==========================================
        // LIMPIAR FILTROS
        // ==========================================
        function limpiarFiltros() {
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = new Date().toISOString().split('T')[0];
            document.getElementById('filter-workers').selectedIndex = 0;
            document.getElementById('filter-axes').selectedIndex = 0;
            document.getElementById('filter-modalities').selectedIndex = 0;
            document.getElementById('filter-status').selectedIndex = 0;
            document.getElementById('filter-areas').selectedIndex = 0;
            document.getElementById('filter-divisions').selectedIndex = 0;
            document.getElementById('filter-assignment-type').selectedIndex = 0;
            document.getElementById('filter-certifiable').selectedIndex = 0;
            
            showMessage('Filtros limpiados', 'info');
        }
        
        // ==========================================
        // GENERAR REPORTE PRINCIPAL
        // ==========================================
        async function generarReporte() {
            try {
                // Validar tipo de reporte
                const reportType = document.getElementById('report-type').value;
                if (!reportType) {
                    showMessage('Por favor selecciona un tipo de reporte', 'warning');
                    return;
                }
                
                mostrarLoading();
                currentReportType = reportType;
                
                // Destruir gr√°ficos anteriores
                destruirGraficos();
                
                // Obtener filtros
                const filters = obtenerFiltros();
                
                // Generar seg√∫n tipo
                switch (reportType) {
                    case 'completaciones':
                        await generarReporteCompletaciones(filters);
                        break;
                    case 'cumplimiento-trabajador':
                        await generarReporteCumplimientoTrabajador(filters);
                        break;
                    case 'cumplimiento-eje':
                        await generarReporteCumplimientoEje(filters);
                        break;
                    case 'certificaciones':
                        await generarReporteCertificaciones(filters);
                        break;
                    case 'vencimientos':
                        await generarReporteVencimientos(filters);
                        break;
                    case 'mas-solicitados':
                        await generarReporteMasSolicitados(filters);
                        break;
                    case 'comparativo-areas':
                        await generarReporteComparativoAreas(filters);
                        break;
                    default:
                        throw new Error('Tipo de reporte no v√°lido');
                }
                
                // Mostrar secci√≥n de preview
                document.getElementById('preview-section').style.display = 'block';
                
                // Scroll a preview
                document.getElementById('preview-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                ocultarLoading();
                showMessage('Reporte generado exitosamente', 'success');
                
            } catch (error) {
                console.error('‚ùå Error generando reporte:', error);
                showMessage('Error al generar reporte: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // OBTENER FILTROS APLICADOS
        // ==========================================
        function obtenerFiltros() {
            const filters = {
                dateFrom: document.getElementById('filter-date-from').value,
                dateTo: document.getElementById('filter-date-to').value,
                workers: Array.from(document.getElementById('filter-workers').selectedOptions).map(opt => opt.value).filter(v => v),
                axes: Array.from(document.getElementById('filter-axes').selectedOptions).map(opt => opt.value).filter(v => v),
                modalities: Array.from(document.getElementById('filter-modalities').selectedOptions).map(opt => opt.value).filter(v => v),
                status: Array.from(document.getElementById('filter-status').selectedOptions).map(opt => opt.value).filter(v => v),
                area: document.getElementById('filter-areas').value,
                division: document.getElementById('filter-divisions').value,
                assignmentType: document.getElementById('filter-assignment-type').value,
                certifiable: document.getElementById('filter-certifiable').value
            };
            
            console.log('üìã Filtros aplicados:', filters);
            return filters;
        }
        
        // ==========================================
        // CONSTRUIR QUERY CON FILTROS
        // ==========================================
        function construirQuery(baseQuery, filters, dateField = 'actual_completion_date') {
            let query = baseQuery;
            
            // Filtro de fechas
            if (filters.dateFrom) {
                query += `&${dateField}=gte.${filters.dateFrom}`;
            }
            if (filters.dateTo) {
                query += `&${dateField}=lte.${filters.dateTo}`;
            }
            
            // Filtro de trabajadores
            if (filters.workers.length > 0) {
                query += `&worker_id=in.(${filters.workers.join(',')})`;
            }
            
            // Filtro de estado
            if (filters.status.length > 0) {
                query += `&completion_status=in.(${filters.status.join(',')})`;
            }
            
            // Filtro de tipo de asignaci√≥n
            if (filters.assignmentType) {
                query += `&assignment_type=eq.${filters.assignmentType}`;
            }
            
            return query;
        }
      // ==========================================
        // REPORTE 1: COMPLETACIONES
        // ==========================================
        async function generarReporteCompletaciones(filters) {
            try {
                console.log('üìã Generando reporte de completaciones...');
                
                // Query base con todas las relaciones
                let query = '/worker_training_paths?select=path_id,actual_completion_date,evaluation_score,assignment_type,workers(worker_id,worker_first_name,worker_last_name_1,worker_last_name_2),training_modules(module_code,module_title,training_axes(axis_name),training_modalities(modality_name))&completion_status=eq.Completado';
                
                query = construirQuery(query, filters, 'actual_completion_date');
                
                // Aplicar filtros de m√≥dulos
                if (filters.axes.length > 0) {
                    query += `&training_modules.axis_id=in.(${filters.axes.join(',')})`;
                }
                if (filters.modalities.length > 0) {
                    query += `&training_modules.modality_id=in.(${filters.modalities.join(',')})`;
                }
                if (filters.certifiable) {
                    query += `&training_modules.is_certifiable=eq.${filters.certifiable}`;
                }
                
                query += '&order=actual_completion_date.desc';
                
                const data = await supabaseRequest(query);
                reportData = data;
                
                // Renderizar
                renderReporteCompletaciones(data);
                
                console.log('‚úÖ Reporte de completaciones generado:', data.length, 'registros');
                
            } catch (error) {
                console.error('‚ùå Error generando reporte de completaciones:', error);
                throw error;
            }
        }
        
        function renderReporteCompletaciones(data) {
            const container = document.getElementById('preview-content');
            document.getElementById('preview-title').innerHTML = '<i class="bi bi-clipboard-check me-2"></i>Reporte de Completaciones';
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No se encontraron completaciones con los filtros aplicados.</div>';
                return;
            }
            
            let html = `
                <div class="mb-3">
                    <strong>Total de completaciones:</strong> ${data.length}
                </div>
                <div class="table-responsive">
                    <table class="table table-hover report-table">
                        <thead>
                            <tr>
                                <th>Trabajador</th>
                                <th>M√≥dulo</th>
                                <th>Eje</th>
                                <th>Modalidad</th>
                                <th>Fecha Completado</th>
                                <th>Calificaci√≥n</th>
                                <th>Tipo Asignaci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(path => {
                const worker = path.workers;
                const module = path.training_modules;
                const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
                
                html += `
                    <tr>
                        <td>${workerName}</td>
                        <td>
                            ${module.module_code ? `<span class="badge bg-secondary">${module.module_code}</span> ` : ''}
                            ${module.module_title}
                        </td>
                        <td>${module.training_axes?.axis_name || '-'}</td>
                        <td>${module.training_modalities?.modality_name || '-'}</td>
                        <td>${formatDate(path.actual_completion_date)}</td>
                        <td>
                            ${path.evaluation_score ? `<span class="badge bg-success">${path.evaluation_score}</span>` : '-'}
                        </td>
                        <td>
                            <span class="badge bg-info">${path.assignment_type}</span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // REPORTE 2: CUMPLIMIENTO POR TRABAJADOR
        // ==========================================
        async function generarReporteCumplimientoTrabajador(filters) {
            try {
                console.log('üë§ Generando reporte de cumplimiento por trabajador...');
                
                // Obtener todas las rutas con filtros
                let query = '/worker_training_paths?select=path_id,completion_status,workers(worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,organizational_areas(area_name))&path_status=eq.active';
                
                query = construirQuery(query, filters, 'assignment_date');
                
                const paths = await supabaseRequest(query);
                
                // Agrupar por trabajador
                const workerStats = {};
                
                paths.forEach(path => {
                    const workerId = path.workers.worker_id;
                    
                    if (!workerStats[workerId]) {
                        const worker = path.workers;
                        workerStats[workerId] = {
                            workerName: `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim(),
                            areaName: worker.organizational_areas?.area_name || 'Sin √°rea',
                            totalAsignados: 0,
                            completados: 0,
                            pendientes: 0,
                            vencidos: 0
                        };
                    }
                    
                    workerStats[workerId].totalAsignados++;
                    
                    if (path.completion_status === 'Completado') {
                        workerStats[workerId].completados++;
                    } else if (path.completion_status === 'Vencido') {
                        workerStats[workerId].vencidos++;
                    } else {
                        workerStats[workerId].pendientes++;
                    }
                });
                
                // Calcular porcentajes
                const workerArray = Object.values(workerStats).map(worker => ({
                    ...worker,
                    porcentajeCompletacion: worker.totalAsignados > 0 
                        ? Math.round((worker.completados / worker.totalAsignados) * 100) 
                        : 0
                }));
                
                // Ordenar por porcentaje descendente
                workerArray.sort((a, b) => b.porcentajeCompletacion - a.porcentajeCompletacion);
                
                reportData = workerArray;
                
                // Renderizar
                renderReporteCumplimientoTrabajador(workerArray);
                
                console.log('‚úÖ Reporte de cumplimiento por trabajador generado:', workerArray.length, 'trabajadores');
                
            } catch (error) {
                console.error('‚ùå Error generando reporte de cumplimiento:', error);
                throw error;
            }
        }
        
        function renderReporteCumplimientoTrabajador(data) {
            const container = document.getElementById('preview-content');
            document.getElementById('preview-title').innerHTML = '<i class="bi bi-person-check me-2"></i>Cumplimiento por Trabajador';
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No se encontraron datos con los filtros aplicados.</div>';
                return;
            }
            
            let html = `
                <div class="mb-3">
                    <strong>Total de trabajadores:</strong> ${data.length}
                </div>
                <div class="table-responsive">
                    <table class="table table-hover report-table">
                        <thead>
                            <tr>
                                <th>Trabajador</th>
                                <th>√Årea</th>
                                <th>Total Asignados</th>
                                <th>Completados</th>
                                <th>Pendientes</th>
                                <th>Vencidos</th>
                                <th>% Completaci√≥n</th>
                                <th>Progreso</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(worker => {
                const progressColor = worker.porcentajeCompletacion >= 75 ? 'success' :
                                     worker.porcentajeCompletacion >= 50 ? 'info' :
                                     worker.porcentajeCompletacion >= 25 ? 'warning' : 'danger';
                
                html += `
                    <tr>
                        <td><strong>${worker.workerName}</strong></td>
                        <td>${worker.areaName}</td>
                        <td class="text-center">${worker.totalAsignados}</td>
                        <td class="text-center">
                            <span class="badge bg-success">${worker.completados}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-warning">${worker.pendientes}</span>
                        </td>
                        <td class="text-center">
                            ${worker.vencidos > 0 ? `<span class="badge bg-danger">${worker.vencidos}</span>` : '-'}
                        </td>
                        <td class="text-center">
                            <strong>${worker.porcentajeCompletacion}%</strong>
                        </td>
                        <td>
                            <div class="table-progress">
                                <div class="table-progress-fill bg-${progressColor}" style="width: ${worker.porcentajeCompletacion}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // REPORTE 3: CUMPLIMIENTO POR EJE
        // ==========================================
        async function generarReporteCumplimientoEje(filters) {
            try {
                console.log('üìä Generando reporte de cumplimiento por eje...');
                
                // Obtener rutas con informaci√≥n de ejes
                let query = '/worker_training_paths?select=path_id,completion_status,training_modules(axis_id,training_axes(axis_id,axis_name))&path_status=eq.active';
                
                query = construirQuery(query, filters, 'assignment_date');
                
                if (filters.axes.length > 0) {
                    query += `&training_modules.axis_id=in.(${filters.axes.join(',')})`;
                }
                
                const paths = await supabaseRequest(query);
                
                // Agrupar por eje
                const axisStats = {};
                
                paths.forEach(path => {
                    const axis = path.training_modules?.training_axes;
                    if (!axis) return;
                    
                    if (!axisStats[axis.axis_id]) {
                        axisStats[axis.axis_id] = {
                            axisName: axis.axis_name,
                            totalModulos: 0,
                            completados: 0
                        };
                    }
                    
                    axisStats[axis.axis_id].totalModulos++;
                    
                    if (path.completion_status === 'Completado') {
                        axisStats[axis.axis_id].completados++;
                    }
                });
                
                // Calcular porcentajes
                const axisArray = Object.values(axisStats).map(axis => ({
                    ...axis,
                    porcentaje: axis.totalModulos > 0 
                        ? Math.round((axis.completados / axis.totalModulos) * 100) 
                        : 0
                }));
                
                // Ordenar por porcentaje descendente
                axisArray.sort((a, b) => b.porcentaje - a.porcentaje);
                
                reportData = axisArray;
                
                // Renderizar con gr√°fico
                renderReporteCumplimientoEje(axisArray);
                
                console.log('‚úÖ Reporte de cumplimiento por eje generado:', axisArray.length, 'ejes');
                
            } catch (error) {
                console.error('‚ùå Error generando reporte por eje:', error);
                throw error;
            }
        }
        
        function renderReporteCumplimientoEje(data) {
            const container = document.getElementById('preview-content');
            document.getElementById('preview-title').innerHTML = '<i class="bi bi-bookmark-star me-2"></i>Cumplimiento por Eje Formativo';
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No se encontraron datos con los filtros aplicados.</div>';
                return;
            }
            
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="chart-container">
                            <canvas id="axis-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover report-table">
                        <thead>
                            <tr>
                                <th>Eje Formativo</th>
                                <th>Total M√≥dulos</th>
                                <th>Completados</th>
                                <th>% Completaci√≥n</th>
                                <th>Progreso</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(axis => {
                const progressColor = axis.porcentaje >= 75 ? 'success' :
                                     axis.porcentaje >= 50 ? 'info' :
                                     axis.porcentaje >= 25 ? 'warning' : 'danger';
                
                html += `
                    <tr>
                        <td><strong>${axis.axisName}</strong></td>
                        <td class="text-center">${axis.totalModulos}</td>
                        <td class="text-center">
                            <span class="badge bg-success">${axis.completados}</span>
                        </td>
                        <td class="text-center"><strong>${axis.porcentaje}%</strong></td>
                        <td>
                            <div class="table-progress">
                                <div class="table-progress-fill bg-${progressColor}" style="width: ${axis.porcentaje}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Renderizar gr√°fico
            setTimeout(() => renderAxisChart(data), 100);
        }
        
        function renderAxisChart(data) {
            const ctx = document.getElementById('axis-chart');
            if (!ctx) return;
            
            const chart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: data.map(a => a.axisName),
                    datasets: [{
                        label: '% Completaci√≥n',
                        data: data.map(a => a.porcentaje),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            chartInstances.push(chart);
        }
        
        // ==========================================
        // REPORTE 4: CERTIFICACIONES
        // ==========================================
        async function generarReporteCertificaciones(filters) {
            try {
                console.log('üèÜ Generando reporte de certificaciones...');
                
                let query = '/worker_training_paths?select=path_id,actual_completion_date,evaluation_score,workers(worker_id,worker_first_name,worker_last_name_1,worker_last_name_2),training_modules(module_code,module_title,certification_type,training_axes(axis_name))&completion_status=eq.Completado&training_modules.is_certifiable=eq.true';
                
                query = construirQuery(query, filters, 'actual_completion_date');
                
                if (filters.axes.length > 0) {
                    query += `&training_modules.axis_id=in.(${filters.axes.join(',')})`;
                }
                
                query += '&order=actual_completion_date.desc';
                
                const data = await supabaseRequest(query);
                reportData = data;
                
                renderReporteCertificaciones(data);
                
                console.log('‚úÖ Reporte de certificaciones generado:', data.length, 'registros');
                
            } catch (error) {
                console.error('‚ùå Error generando reporte de certificaciones:', error);
                throw error;
            }
        }
        
        function renderReporteCertificaciones(data) {
            const container = document.getElementById('preview-content');
            document.getElementById('preview-title').innerHTML = '<i class="bi bi-award me-2"></i>Reporte de Certificaciones';
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No se encontraron certificaciones con los filtros aplicados.</div>';
                return;
            }
            
            let html = `
                <div class="mb-3">
                    <strong>Total de certificaciones:</strong> ${data.length}
                </div>
                <div class="table-responsive">
                    <table class="table table-hover report-table">
                        <thead>
                            <tr>
                                <th>Trabajador</th>
                                <th>M√≥dulo Certificable</th>
                                <th>Tipo Certificaci√≥n</th>
                                <th>Eje</th>
                                <th>Fecha Completado</th>
                                <th>Calificaci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(path => {
                const worker = path.workers;
                const module = path.training_modules;
                const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
                
                html += `
                    <tr>
                        <td>${workerName}</td>
                        <td>
                            <i class="bi bi-award-fill text-warning me-1"></i>
                            ${module.module_code ? `<span class="badge bg-secondary">${module.module_code}</span> ` : ''}
                            ${module.module_title}
                        </td>
                        <td>
                            <span class="badge bg-primary">${module.certification_type}</span>
                        </td>
                        <td>${module.training_axes?.axis_name || '-'}</td>
                        <td>${formatDate(path.actual_completion_date)}</td>
                        <td>
                            ${path.evaluation_score ? `<span class="badge bg-success">${path.evaluation_score}</span>` : '-'}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
      // ==========================================
        // REPORTE 5: VENCIMIENTOS
        // ==========================================
        async function generarReporteVencimientos(filters) {
            try {
                console.log('‚è∞ Generando reporte de vencimientos...');
                
                let query = '/worker_training_paths?select=path_id,target_completion_date,completion_status,workers(worker_id,worker_first_name,worker_last_name_1,worker_last_name_2),training_modules(module_code,module_title,priority,training_axes(axis_name))&path_status=eq.active&completion_status=in.(Pendiente,En progreso,Vencido)';
                
                query = construirQuery(query, filters, 'target_completion_date');
                
                if (filters.axes.length > 0) {
                    query += `&training_modules.axis_id=in.(${filters.axes.join(',')})`;
                }
                
                query += '&order=target_completion_date.asc.nullslast';
                
                const data = await supabaseRequest(query);
                
                // Calcular d√≠as restantes
                const today = new Date();
                data.forEach(path => {
                    if (path.target_completion_date) {
                        const deadline = new Date(path.target_completion_date);
                        const diffTime = deadline - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        path.diasRestantes = diffDays;
                        
                        if (diffDays < 0) {
                            path.alertLevel = 'urgent';
                            path.completion_status = 'Vencido';
                        } else if (diffDays <= 7) {
                            path.alertLevel = 'urgent';
                        } else if (diffDays <= 30) {
                            path.alertLevel = 'warning';
                        } else {
                            path.alertLevel = 'normal';
                        }
                    } else {
                        path.diasRestantes = null;
                        path.alertLevel = 'normal';
                    }
                });
                
                reportData = data;
                
                renderReporteVencimientos(data);
                
                console.log('‚úÖ Reporte de vencimientos generado:', data.length, 'registros');
                
            } catch (error) {
                console.error('‚ùå Error generando reporte de vencimientos:', error);
                throw error;
            }
        }
        
        function renderReporteVencimientos(data) {
            const container = document.getElementById('preview-content');
            document.getElementById('preview-title').innerHTML = '<i class="bi bi-alarm me-2"></i>Reporte de Vencimientos';
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No se encontraron m√≥dulos pr√≥ximos a vencer con los filtros aplicados.</div>';
                return;
            }
            
            // Contar por nivel de alerta
            const urgent = data.filter(p => p.alertLevel === 'urgent').length;
            const warning = data.filter(p => p.alertLevel === 'warning').length;
            
            let html = `
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="alert alert-danger mb-0">
                            <strong>üî¥ Urgente:</strong> ${urgent} m√≥dulos
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-warning mb-0">
                            <strong>üü° Pr√≥ximos:</strong> ${warning} m√≥dulos
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-info mb-0">
                            <strong>Total:</strong> ${data.length} m√≥dulos
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover report-table">
                        <thead>
                            <tr>
                                <th>Alerta</th>
                                <th>Trabajador</th>
                                <th>M√≥dulo</th>
                                <th>Eje</th>
                                <th>Fecha L√≠mite</th>
                                <th>D√≠as Restantes</th>
                                <th>Estado</th>
                                <th>Prioridad</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(path => {
                const worker = path.workers;
                const module = path.training_modules;
                const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
                
                const alertIcon = path.alertLevel === 'urgent' ? 'üî¥' : 
                                 path.alertLevel === 'warning' ? 'üü°' : 'üü¢';
                
                const deadlineClass = path.alertLevel === 'urgent' ? 'deadline-urgent' :
                                     path.alertLevel === 'warning' ? 'deadline-warning' : 'deadline-normal';
                
                const diasText = path.diasRestantes === null ? 'Sin fecha' :
                                path.diasRestantes < 0 ? `Vencido hace ${Math.abs(path.diasRestantes)} d√≠as` :
                                path.diasRestantes === 0 ? 'Vence HOY' :
                                `${path.diasRestantes} d√≠as`;
                
                html += `
                    <tr>
                        <td class="text-center">${alertIcon}</td>
                        <td>${workerName}</td>
                        <td>
                            ${module.module_code ? `<span class="badge bg-secondary">${module.module_code}</span> ` : ''}
                            ${module.module_title}
                        </td>
                        <td>${module.training_axes?.axis_name || '-'}</td>
                        <td>${path.target_completion_date ? formatDate(path.target_completion_date) : '-'}</td>
                        <td>
                            <span class="badge ${deadlineClass}">${diasText}</span>
                        </td>
                        <td>
                            <span class="badge badge-${path.completion_status.toLowerCase().replace(' ', '-')}">${path.completion_status}</span>
                        </td>
                        <td>
                            ${module.priority ? `<span class="badge bg-info">${module.priority}</span>` : '-'}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // REPORTE 6: M√ìDULOS M√ÅS SOLICITADOS
        // ==========================================
        async function generarReporteMasSolicitados(filters) {
            try {
                console.log('‚≠ê Generando reporte de m√≥dulos m√°s solicitados...');
                
                // Obtener m√≥dulos solicitados por inter√©s
                let query = '/worker_training_paths?select=path_id,training_modules(module_id,module_code,module_title,training_axes(axis_name),training_modalities(modality_name),training_facilitators:training_module_facilitators(training_facilitators(facilitator_name)))&assignment_type=eq.Por inter√©s&path_status=eq.active';
                
                query = construirQuery(query, filters, 'assignment_date');
                
                if (filters.axes.length > 0) {
                    query += `&training_modules.axis_id=in.(${filters.axes.join(',')})`;
                }
                
                const paths = await supabaseRequest(query);
                
                // Agrupar por m√≥dulo
                const moduleStats = {};
                
                paths.forEach(path => {
                    const module = path.training_modules;
                    if (!module) return;
                    
                    if (!moduleStats[module.module_id]) {
                        moduleStats[module.module_id] = {
                            moduleCode: module.module_code,
                            moduleTitle: module.module_title,
                            axisName: module.training_axes?.axis_name || 'Sin eje',
                            modalityName: module.training_modalities?.modality_name || 'Sin modalidad',
                            facilitators: module.training_facilitators?.map(f => f.training_facilitators?.facilitator_name).filter(Boolean).join(', ') || 'Sin facilitador',
                            solicitudes: 0
                        };
                    }
                    
                    moduleStats[module.module_id].solicitudes++;
                });
                
                // Convertir a array y ordenar
                const moduleArray = Object.values(moduleStats);
                moduleArray.sort((a, b) => b.solicitudes - a.solicitudes);
                
                // Top 20
                const top20 = moduleArray.slice(0, 20);
                
                reportData = top20;
                
                renderReporteMasSolicitados(top20);
                
                console.log('‚úÖ Reporte de m√≥dulos m√°s solicitados generado:', top20.length, 'm√≥dulos');
                
            } catch (error) {
                console.error('‚ùå Error generando reporte de m√°s solicitados:', error);
                throw error;
            }
        }
        
        function renderReporteMasSolicitados(data) {
            const container = document.getElementById('preview-content');
            document.getElementById('preview-title').innerHTML = '<i class="bi bi-star me-2"></i>M√≥dulos M√°s Solicitados por Inter√©s';
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No se encontraron m√≥dulos solicitados por inter√©s con los filtros aplicados.</div>';
                return;
            }
            
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="chart-container">
                            <canvas id="solicitudes-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover report-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>M√≥dulo</th>
                                <th>Eje</th>
                                <th>Modalidad</th>
                                <th>Facilitador(es)</th>
                                <th>Solicitudes</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach((module, index) => {
                html += `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td>
                            ${module.moduleCode ? `<span class="badge bg-secondary">${module.moduleCode}</span> ` : ''}
                            ${module.moduleTitle}
                        </td>
                        <td>${module.axisName}</td>
                        <td>${module.modalityName}</td>
                        <td><small>${module.facilitators}</small></td>
                        <td class="text-center">
                            <span class="badge bg-primary" style="font-size: 1rem;">${module.solicitudes}</span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Renderizar gr√°fico
            setTimeout(() => renderSolicitudesChart(data), 100);
        }
        
        function renderSolicitudesChart(data) {
            const ctx = document.getElementById('solicitudes-chart');
            if (!ctx) return;
            
            // Top 10 para el gr√°fico
            const top10 = data.slice(0, 10);
            
            const chart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: top10.map(m => m.moduleCode || m.moduleTitle.substring(0, 30)),
                    datasets: [{
                        label: 'Solicitudes',
                        data: top10.map(m => m.solicitudes),
                        backgroundColor: 'rgba(255, 193, 7, 0.6)',
                        borderColor: '#ffc107',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Top 10 M√≥dulos M√°s Solicitados'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            chartInstances.push(chart);
        }
        
        // ==========================================
        // REPORTE 7: COMPARATIVO POR √ÅREAS
        // ==========================================
        async function generarReporteComparativoAreas(filters) {
            try {
                console.log('üìà Generando reporte comparativo por √°reas...');
                
                // Obtener trabajadores con sus rutas
                let query = '/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,organizational_areas(area_id,area_name),worker_training_paths(path_id,completion_status,path_status)&worker_status=eq.active';
                
                if (filters.area) {
                    query += `&organizational_area_id=eq.${filters.area}`;
                }
                if (filters.division) {
                    query += `&organizational_division_id=eq.${filters.division}`;
                }
                
                const workers = await supabaseRequest(query);
                
                // Agrupar por √°rea
                const areaStats = {};
                
                workers.forEach(worker => {
                    const area = worker.organizational_areas;
                    if (!area) return;
                    
                    if (!areaStats[area.area_id]) {
                        areaStats[area.area_id] = {
                            areaName: area.area_name,
                            totalTrabajadores: 0,
                            totalAsignados: 0,
                            totalCompletados: 0
                        };
                    }
                    
                    areaStats[area.area_id].totalTrabajadores++;
                    
                    const activePaths = worker.worker_training_paths?.filter(p => p.path_status === 'active') || [];
                    areaStats[area.area_id].totalAsignados += activePaths.length;
                    areaStats[area.area_id].totalCompletados += activePaths.filter(p => p.completion_status === 'Completado').length;
                });
                
                // Calcular promedios
                const areaArray = Object.values(areaStats).map(area => ({
                    ...area,
                    promedioCompletacion: area.totalAsignados > 0 
                        ? Math.round((area.totalCompletados / area.totalAsignados) * 100) 
                        : 0
                }));
                
                // Ordenar por promedio descendente
                areaArray.sort((a, b) => b.promedioCompletacion - a.promedioCompletacion);
                
                // Asignar ranking
                areaArray.forEach((area, index) => {
                    area.ranking = index + 1;
                });
                
                reportData = areaArray;
                
                renderReporteComparativoAreas(areaArray);
                
                console.log('‚úÖ Reporte comparativo por √°reas generado:', areaArray.length, '√°reas');
                
            } catch (error) {
                console.error('‚ùå Error generando reporte comparativo:', error);
                throw error;
            }
        }
        
        function renderReporteComparativoAreas(data) {
            const container = document.getElementById('preview-content');
            document.getElementById('preview-title').innerHTML = '<i class="bi bi-building me-2"></i>Comparativo por √Årea Organizacional';
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No se encontraron datos con los filtros aplicados.</div>';
                return;
            }
            
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="chart-container">
                            <canvas id="areas-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover report-table">
                        <thead>
                            <tr>
                                <th>Ranking</th>
                                <th>√Årea Organizacional</th>
                                <th>Total Trabajadores</th>
                                <th>M√≥dulos Asignados</th>
                                <th>Completados</th>
                                <th>% Promedio</th>
                                <th>Progreso</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(area => {
                const progressColor = area.promedioCompletacion >= 75 ? 'success' :
                                     area.promedioCompletacion >= 50 ? 'info' :
                                     area.promedioCompletacion >= 25 ? 'warning' : 'danger';
                
                const medal = area.ranking === 1 ? 'ü•á' : 
                             area.ranking === 2 ? 'ü•à' :
                             area.ranking === 3 ? 'ü•â' : '';
                
                html += `
                    <tr>
                        <td class="text-center"><strong>${medal} ${area.ranking}</strong></td>
                        <td><strong>${area.areaName}</strong></td>
                        <td class="text-center">${area.totalTrabajadores}</td>
                        <td class="text-center">${area.totalAsignados}</td>
                        <td class="text-center">
                            <span class="badge bg-success">${area.totalCompletados}</span>
                        </td>
                        <td class="text-center"><strong>${area.promedioCompletacion}%</strong></td>
                        <td>
                            <div class="table-progress">
                                <div class="table-progress-fill bg-${progressColor}" style="width: ${area.promedioCompletacion}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Renderizar gr√°fico
            setTimeout(() => renderAreasChart(data), 100);
        }
        
        function renderAreasChart(data) {
            const ctx = document.getElementById('areas-chart');
            if (!ctx) return;
            
            const chart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: data.map(a => a.areaName),
                    datasets: [{
                        label: '% Completaci√≥n Promedio',
                        data: data.map(a => a.promedioCompletacion),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Comparativo de Completaci√≥n por √Årea'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            chartInstances.push(chart);
        }
        
        // ==========================================
        // REPORTES R√ÅPIDOS
        // ==========================================
        async function generarReporteRapido(tipo) {
            try {
                // Limpiar filtros primero
                limpiarFiltros();
                
                const today = new Date();
                const firstDayMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
                const sevenDaysAhead = new Date(today.getTime() + (7 * 24 * 60 * 60 * 1000));
                
                switch (tipo) {
                    case 'mes-actual':
                        document.getElementById('report-type').value = 'completaciones';
                        document.getElementById('filter-date-from').value = firstDayMonth.toISOString().split('T')[0];
                        document.getElementById('filter-date-to').value = today.toISOString().split('T')[0];
                        break;
                        
                    case 'vencimientos-proximos':
                        document.getElementById('report-type').value = 'vencimientos';
                        document.getElementById('filter-date-to').value = sevenDaysAhead.toISOString().split('T')[0];
                        break;
                        
                    case 'top-trabajadores':
                        document.getElementById('report-type').value = 'cumplimiento-trabajador';
                        break;
                        
                    case 'certificaciones-trimestre':
                        document.getElementById('report-type').value = 'certificaciones';
                        document.getElementById('filter-date-from').value = threeMonthsAgo.toISOString().split('T')[0];
                        document.getElementById('filter-date-to').value = today.toISOString().split('T')[0];
                        break;
                        
                    case 'sin-completar':
                        document.getElementById('report-type').value = 'vencimientos';
                        const statusSelect = document.getElementById('filter-status');
                        statusSelect.options[1].selected = true; // Pendiente
                        statusSelect.options[2].selected = true; // En progreso
                        break;
                }
                
                // Generar reporte
                await generarReporte();
                
            } catch (error) {
                console.error('‚ùå Error generando reporte r√°pido:', error);
                showMessage('Error al generar reporte r√°pido: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // EXPORTAR A PDF
        // ==========================================
        async function exportarPDF() {
            try {
                if (!reportData || !currentReportType) {
                    showMessage('No hay datos para exportar. Genera un reporte primero.', 'warning');
                    return;
                }
                
                mostrarLoading();
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                
                // Configurar fuente
                doc.setFont('helvetica');
                
                // Logo y t√≠tulo
                doc.setFontSize(18);
                doc.setTextColor(102, 126, 234);
                doc.text('SchoolNet - Reporte de Formaci√≥n', 15, 15);
                
                // Tipo de reporte
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                const reportTypeText = document.getElementById('report-type').selectedOptions[0].text;
                doc.text(reportTypeText, 15, 25);
                
                // Fecha de generaci√≥n
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`Fecha de generaci√≥n: ${new Date().toLocaleString('es-CO')}`, 15, 32);
                
                // Construir tabla seg√∫n tipo
                let columns, rows;
                
                switch (currentReportType) {
                    case 'completaciones':
                        columns = ['Trabajador', 'M√≥dulo', 'Eje', 'Modalidad', 'Fecha', 'Calificaci√≥n', 'Tipo'];
                        rows = reportData.map(path => [
                            `${path.workers.worker_first_name} ${path.workers.worker_last_name_1}`,
                            `${path.training_modules.module_code || ''} ${path.training_modules.module_title}`.substring(0, 40),
                            path.training_modules.training_axes?.axis_name || '-',
                            path.training_modules.training_modalities?.modality_name || '-',
                            formatDate(path.actual_completion_date),
                            path.evaluation_score || '-',
                            path.assignment_type
                        ]);
                        break;
                        
                    case 'cumplimiento-trabajador':
                        columns = ['Trabajador', '√Årea', 'Asignados', 'Completados', 'Pendientes', 'Vencidos', '%'];
                        rows = reportData.map(worker => [
                            worker.workerName,
                            worker.areaName,
                            worker.totalAsignados,
                            worker.completados,
                            worker.pendientes,
                            worker.vencidos,
                            worker.porcentajeCompletacion + '%'
                        ]);
                        break;
                        
                    case 'cumplimiento-eje':
                        columns = ['Eje Formativo', 'Total M√≥dulos', 'Completados', '% Completaci√≥n'];
                        rows = reportData.map(axis => [
                            axis.axisName,
                            axis.totalModulos,
                            axis.completados,
                            axis.porcentaje + '%'
                        ]);
                        break;
                        
                    case 'certificaciones':
                        columns = ['Trabajador', 'M√≥dulo', 'Tipo Certificaci√≥n', 'Eje', 'Fecha', 'Calificaci√≥n'];
                        rows = reportData.map(path => [
                            `${path.workers.worker_first_name} ${path.workers.worker_last_name_1}`,
                            `${path.training_modules.module_code || ''} ${path.training_modules.module_title}`.substring(0, 35),
                            path.training_modules.certification_type,
                            path.training_modules.training_axes?.axis_name || '-',
                            formatDate(path.actual_completion_date),
                            path.evaluation_score || '-'
                        ]);
                        break;
                        
                    case 'vencimientos':
                        columns = ['Trabajador', 'M√≥dulo', 'Eje', 'Fecha L√≠mite', 'D√≠as', 'Estado'];
                        rows = reportData.map(path => [
                            `${path.workers.worker_first_name} ${path.workers.worker_last_name_1}`,
                            `${path.training_modules.module_code || ''} ${path.training_modules.module_title}`.substring(0, 35),
                            path.training_modules.training_axes?.axis_name || '-',
                            path.target_completion_date ? formatDate(path.target_completion_date) : '-',
                            path.diasRestantes !== null ? path.diasRestantes : '-',
                            path.completion_status
                        ]);
                        break;
                        
                    case 'mas-solicitados':
                        columns = ['#', 'M√≥dulo', 'Eje', 'Modalidad', 'Solicitudes'];
                        rows = reportData.map((module, index) => [
                            index + 1,
                            `${module.moduleCode || ''} ${module.moduleTitle}`.substring(0, 40),
                            module.axisName,
                            module.modalityName,
                            module.solicitudes
                        ]);
                        break;
                        
                    case 'comparativo-areas':
                        columns = ['Ranking', '√Årea', 'Trabajadores', 'Asignados', 'Completados', '%'];
                        rows = reportData.map(area => [
                            area.ranking,
                            area.areaName,
                            area.totalTrabajadores,
                            area.totalAsignados,
                            area.totalCompletados,
                            area.promedioCompletacion + '%'
                        ]);
                        break;
                }
                
                // Generar tabla con autoTable
                doc.autoTable({
                    head: [columns],
                    body: rows,
                    startY: 40,
                    styles: {
                        fontSize: 8,
                        cellPadding: 2
                    },
                    headStyles: {
                        fillColor: [102, 126, 234],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    }
                });
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text(`P√°gina ${i} de ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
                }
                
                // Guardar
                const fileName = `reporte_formacion_${currentReportType}_${new Date().getTime()}.pdf`;
                doc.save(fileName);
                
                ocultarLoading();
                showMessage('Reporte exportado exitosamente a PDF', 'success');
                
            } catch (error) {
                console.error('‚ùå Error exportando PDF:', error);
                showMessage('Error al exportar PDF: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function destruirGraficos() {
            chartInstances.forEach(chart => {
                if (chart) chart.destroy();
            });
            chartInstances = [];
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        // Hacer funciones disponibles globalmente
        window.limpiarFiltros = limpiarFiltros;
        window.generarReporte = generarReporte;
        window.generarReporteRapido = generarReporteRapido;
        window.exportarPDF = exportarPDF;
        
        console.log('üéâ reports.html cargado correctamente');
    </script>
</body>
</html>
