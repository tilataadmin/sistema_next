<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar Rutas de Formaci√≥n - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .option-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            height: 100%;
        }
        
        .option-card:hover {
            border-color: #8b5cf6;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
            transform: translateY(-2px);
        }
        
        .option-card.selected {
            border-color: #8b5cf6;
            background-color: #f8f7ff;
        }
        
        .option-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 1rem;
        }
        
        .progress-container {
            display: none;
            margin-top: 1.5rem;
        }
        
        .progress-container.active {
            display: block;
        }
        
        .progress {
            height: 30px;
            border-radius: 8px;
        }
        
        .progress-bar {
            font-size: 0.9rem;
            font-weight: 600;
            transition: width 0.3s ease;
        }
        
        .result-card {
            border-left: 4px solid #28a745;
            background: #f8fff9;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8b5cf6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-success {
            color: #28a745;
        }
        
        .log-error {
            color: #dc3545;
        }
        
        .log-warning {
            color: #ffc107;
        }
        
        .log-info {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Procesando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Formaci√≥n</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Generar Rutas de Formaci√≥n
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-diagram-3-fill me-2" style="color: #8b5cf6;"></i>
                    Generar Rutas de Formaci√≥n
                </h1>
                <p class="text-muted">
                    Generar o actualizar rutas de formaci√≥n de manera individual o masiva seg√∫n roles asignados
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- SELECCI√ìN DE MODO -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-list-check me-2"></i>Selecciona el Modo de Generaci√≥n
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            
                            <!-- OPCI√ìN 1: Individual -->
                            <div class="col-md-4">
                                <div class="option-card card h-100" onclick="selectMode('individual')">
                                    <div class="card-body text-center">
                                        <div class="option-icon">
                                            <i class="bi bi-person"></i>
                                        </div>
                                        <h5>Trabajador Individual</h5>
                                        <p class="text-muted mb-0">
                                            Generar o actualizar la ruta de un trabajador espec√≠fico
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- OPCI√ìN 2: Por Rol -->
                            <div class="col-md-4">
                                <div class="option-card card h-100" onclick="selectMode('role')">
                                    <div class="card-body text-center">
                                        <div class="option-icon">
                                            <i class="bi bi-people"></i>
                                        </div>
                                        <h5>Por Rol/Cargo</h5>
                                        <p class="text-muted mb-0">
                                            Generar rutas para todos los trabajadores de un rol espec√≠fico
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- OPCI√ìN 3: Todos -->
                            <div class="col-md-4">
                                <div class="option-card card h-100" onclick="selectMode('all')">
                                    <div class="card-body text-center">
                                        <div class="option-icon">
                                            <i class="bi bi-globe"></i>
                                        </div>
                                        <h5>Todos los Trabajadores</h5>
                                        <p class="text-muted mb-0">
                                            Regenerar todas las rutas del sistema (proceso largo)
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL: TRABAJADOR INDIVIDUAL -->
        <div class="row mb-4 d-none" id="panel-individual">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-person me-2"></i>Generar Ruta para Trabajador Individual
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <label for="workerSelect" class="form-label">Seleccionar Trabajador</label>
                                <select class="form-select" id="workerSelect">
                                    <option value="">Cargando trabajadores...</option>
                                </select>
                                <div class="form-text">Solo trabajadores activos con roles asignados</div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-primary w-100" onclick="generateIndividual()">
                                    <i class="bi bi-play-fill me-1"></i>Generar Ruta
                                </button>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n del trabajador seleccionado -->
                        <div id="workerInfo" class="mt-3 d-none">
                            <div class="alert alert-info">
                                <strong>Informaci√≥n del Trabajador:</strong>
                                <div id="workerInfoContent"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL: POR ROL -->
        <div class="row mb-4 d-none" id="panel-role">
            <div class="col-12">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-people me-2"></i>Generar Rutas por Rol/Cargo
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <label for="roleSelect" class="form-label">Seleccionar Rol/Cargo</label>
                                <select class="form-select" id="roleSelect">
                                    <option value="">Cargando roles...</option>
                                </select>
                                <div class="form-text">Se generar√°n rutas para todos los trabajadores activos con este rol</div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-success w-100" onclick="generateByRole()">
                                    <i class="bi bi-play-fill me-1"></i>Generar Rutas
                                </button>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n del rol seleccionado -->
                        <div id="roleInfo" class="mt-3 d-none">
                            <div class="alert alert-info">
                                <strong>Informaci√≥n del Rol:</strong>
                                <div id="roleInfoContent"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL: TODOS -->
        <div class="row mb-4 d-none" id="panel-all">
            <div class="col-12">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-globe me-2"></i>Regenerar Todas las Rutas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>¬°Atenci√≥n!</strong> Este proceso generar√° rutas para TODOS los trabajadores activos del sistema.
                            <ul class="mb-0 mt-2">
                                <li>Puede tomar varios minutos dependiendo de la cantidad de trabajadores</li>
                                <li>Solo agregar√° unidades nuevas, no eliminar√° las existentes</li>
                                <li>Se mostrar√° una barra de progreso durante el proceso</li>
                            </ul>
                        </div>
                        
                        <div class="text-center">
                            <button class="btn btn-danger btn-lg" onclick="generateAll()">
                                <i class="bi bi-play-fill me-2"></i>Iniciar Generaci√≥n Masiva
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENEDOR DE PROGRESO -->
        <div class="progress-container" id="progressContainer">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-hourglass-split me-2"></i>Progreso de Generaci√≥n
                    </h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             id="progressBar" 
                             style="width: 0%">
                            0%
                        </div>
                    </div>
                    <div class="text-center mb-3">
                        <strong id="progressText">Preparando...</strong>
                    </div>
                    <div class="log-container" id="logContainer">
                        <!-- Los logs se agregar√°n din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENEDOR DE RESULTADOS -->
        <div class="d-none" id="resultsContainer">
            <div class="card result-card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>Generaci√≥n Completada
                    </h5>
                </div>
                <div class="card-body">
                    <div id="resultsContent">
                        <!-- Los resultados se mostrar√°n aqu√≠ -->
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-primary" onclick="resetForm()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Generar Nuevas Rutas
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentMode = null;
        let allWorkers = [];
        let allRoles = [];
        let currentUserId = null;
        
        // ==========================================
        // VALIDACI√ìN DE ACCESO Y INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Generar rutas de formaci√≥n');
                
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                
                // Obtener usuario actual
                const session = getStoredSession();
                if (session && session.user) {
                    currentUserId = session.user.user_id;
                }
                
                // Cargar datos iniciales
                await loadInitialData();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // CARGAR DATOS INICIALES
        // ==========================================
        async function loadInitialData() {
            try {
                console.log('üì° Cargando datos iniciales...');
                showLoading(true);
                
                // Cargar trabajadores activos con roles
                const workersData = await supabaseRequest('/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,email,worker_job_roles!inner(job_role_id,assignment_status)&worker_status=eq.active&order=worker_last_name_1.asc,worker_first_name.asc');
                
                // Filtrar solo trabajadores que tengan al menos un rol activo
                allWorkers = workersData.filter(w => 
                    w.worker_job_roles && 
                    w.worker_job_roles.some(r => r.assignment_status === 'active')
                );
                
                // Cargar roles activos
                const rolesData = await supabaseRequest('/job_roles?select=role_id,role_name&role_status=eq.active&order=role_name.asc');
                allRoles = rolesData || [];
                
                // Poblar dropdowns
                populateWorkerSelect();
                populateRoleSelect();
                
                console.log(`‚úÖ Datos cargados: ${allWorkers.length} trabajadores, ${allRoles.length} roles`);
                
                showLoading(false);
                
            } catch (error) {
                console.error('‚ùå Error cargando datos iniciales:', error);
                showMessage('Error al cargar datos: ' + error.message, 'danger');
                showLoading(false);
            }
        }
        
        // ==========================================
        // POBLAR SELECT DE TRABAJADORES
        // ==========================================
        function populateWorkerSelect() {
            const select = document.getElementById('workerSelect');
            
            if (allWorkers.length === 0) {
                select.innerHTML = '<option value="">No hay trabajadores activos con roles asignados</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Seleccionar trabajador...</option>' +
                allWorkers.map(w => {
                    const fullName = `${w.worker_first_name} ${w.worker_last_name_1} ${w.worker_last_name_2 || ''}`.trim();
                    return `<option value="${w.worker_id}" data-worker='${JSON.stringify(w)}'>${fullName} (${w.email})</option>`;
                }).join('');
            
            // Event listener para mostrar info del trabajador
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    const workerData = JSON.parse(selectedOption.getAttribute('data-worker'));
                    showWorkerInfo(workerData);
                } else {
                    document.getElementById('workerInfo').classList.add('d-none');
                }
            });
        }
        
        // ==========================================
        // POBLAR SELECT DE ROLES
        // ==========================================
        function populateRoleSelect() {
            const select = document.getElementById('roleSelect');
            
            if (allRoles.length === 0) {
                select.innerHTML = '<option value="">No hay roles activos</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Seleccionar rol...</option>' +
                allRoles.map(r => 
                    `<option value="${r.role_id}" data-role='${JSON.stringify(r)}'>${escapeHtml(r.role_name)}</option>`
                ).join('');
            
            // Event listener para mostrar info del rol
            select.addEventListener('change', async function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    const roleData = JSON.parse(selectedOption.getAttribute('data-role'));
                    await showRoleInfo(roleData);
                } else {
                    document.getElementById('roleInfo').classList.add('d-none');
                }
            });
        }
        
        // ==========================================
        // MOSTRAR INFORMACI√ìN DEL TRABAJADOR
        // ==========================================
        function showWorkerInfo(worker) {
            const fullName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
            const rolesCount = worker.worker_job_roles ? worker.worker_job_roles.filter(r => r.assignment_status === 'active').length : 0;
            
            const infoContent = `
                <p class="mb-1"><strong>Nombre:</strong> ${escapeHtml(fullName)}</p>
                <p class="mb-1"><strong>Email:</strong> ${escapeHtml(worker.email)}</p>
                <p class="mb-0"><strong>Roles activos:</strong> ${rolesCount}</p>
            `;
            
            document.getElementById('workerInfoContent').innerHTML = infoContent;
            document.getElementById('workerInfo').classList.remove('d-none');
        }
        
        // ==========================================
        // MOSTRAR INFORMACI√ìN DEL ROL
        // ==========================================
        async function showRoleInfo(role) {
            try {
                // Contar trabajadores con este rol
                const workersWithRole = await supabaseRequest('/worker_job_roles?select=worker_id&job_role_id=eq.' + role.role_id + '&assignment_status=eq.active');
                const uniqueWorkers = [...new Set(workersWithRole.map(w => w.worker_id))];
                const workersCount = uniqueWorkers.length;
                
                // Contar unidades asociadas al rol
                const modulesForRole = await supabaseRequest('/training_module_roles?select=module_id&job_role_id=eq.' + role.role_id);
                const modulesCount = modulesForRole ? modulesForRole.length : 0;
                
                const infoContent = `
                    <p class="mb-1"><strong>Rol:</strong> ${escapeHtml(role.role_name)}</p>
                    <p class="mb-1"><strong>Trabajadores activos con este rol:</strong> ${workersCount}</p>
                    <p class="mb-0"><strong>Unidades formativas asociadas:</strong> ${modulesCount}</p>
                `;
                
                document.getElementById('roleInfoContent').innerHTML = infoContent;
                document.getElementById('roleInfo').classList.remove('d-none');
                
            } catch (error) {
                console.error('‚ùå Error obteniendo info del rol:', error);
                document.getElementById('roleInfo').classList.add('d-none');
            }
        }
        
        // ==========================================
        // SELECCI√ìN DE MODO
        // ==========================================
        function selectMode(mode) {
            // Remover selecci√≥n de todas las tarjetas
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Ocultar todos los paneles
            document.getElementById('panel-individual').classList.add('d-none');
            document.getElementById('panel-role').classList.add('d-none');
            document.getElementById('panel-all').classList.add('d-none');
            
            // Ocultar contenedores de progreso y resultados
            document.getElementById('progressContainer').classList.remove('active');
            document.getElementById('resultsContainer').classList.add('d-none');
            
            // Marcar tarjeta seleccionada
            event.currentTarget.classList.add('selected');
            currentMode = mode;
            
            // Mostrar panel correspondiente
            switch(mode) {
                case 'individual':
                    document.getElementById('panel-individual').classList.remove('d-none');
                    break;
                case 'role':
                    document.getElementById('panel-role').classList.remove('d-none');
                    break;
                case 'all':
                    document.getElementById('panel-all').classList.remove('d-none');
                    break;
            }
            
            console.log(`‚úÖ Modo seleccionado: ${mode}`);
        }
        
        // ==========================================
        // FUNCIONES DE LOGGING
        // ==========================================
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
        }
        
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('es-CO');
            
            const iconMap = {
                'success': 'check-circle-fill',
                'error': 'x-circle-fill',
                'warning': 'exclamation-triangle-fill',
                'info': 'info-circle-fill'
            };
            
            const icon = iconMap[type] || 'info-circle-fill';
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<i class="bi bi-${icon} me-2"></i>[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            
            // Auto-scroll al final
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // ==========================================
        // ACTUALIZAR BARRA DE PROGRESO
        // ==========================================
        function updateProgress(current, total, text) {
            const percentage = Math.round((current / total) * 100);
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
            progressText.textContent = text || `Procesando ${current} de ${total}...`;
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.toggle('hidden', !show);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function resetForm() {
            // Limpiar selecciones
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Ocultar paneles
            document.getElementById('panel-individual').classList.add('d-none');
            document.getElementById('panel-role').classList.add('d-none');
            document.getElementById('panel-all').classList.add('d-none');
            
            // Ocultar progreso y resultados
            document.getElementById('progressContainer').classList.remove('active');
            document.getElementById('resultsContainer').classList.add('d-none');
            
            // Resetear selects
            document.getElementById('workerSelect').value = '';
            document.getElementById('roleSelect').value = '';
            
            // Ocultar info
            document.getElementById('workerInfo').classList.add('d-none');
            document.getElementById('roleInfo').classList.add('d-none');
            
            // Limpiar logs
            clearLog();
            
            currentMode = null;
            
            console.log('‚úÖ Formulario reseteado');
        }
      // ==========================================
        // GENERAR RUTA INDIVIDUAL
        // ==========================================
        async function generateIndividual() {
            const workerSelect = document.getElementById('workerSelect');
            const workerId = workerSelect.value;
            
            if (!workerId) {
                showMessage('Por favor selecciona un trabajador', 'warning');
                return;
            }
            
            const workerData = JSON.parse(workerSelect.options[workerSelect.selectedIndex].getAttribute('data-worker'));
            const workerName = `${workerData.worker_first_name} ${workerData.worker_last_name_1} ${workerData.worker_last_name_2 || ''}`.trim();
            
            if (!confirm(`¬øGenerar/actualizar la ruta de formaci√≥n para:\n\n${workerName}?\n\nEsto agregar√° las unidades formativas seg√∫n sus roles asignados.`)) {
                return;
            }
            
            try {
                // Mostrar contenedor de progreso
                document.getElementById('progressContainer').classList.add('active');
                document.getElementById('resultsContainer').classList.add('d-none');
                clearLog();
                
                addLog(`Iniciando generaci√≥n de ruta para: ${workerName}`, 'info');
                updateProgress(0, 100, 'Preparando...');
                
                // Ejecutar generaci√≥n
                const result = await generarRutaParaTrabajador(workerId, workerName);
                
                // Mostrar resultados
                updateProgress(100, 100, 'Completado');
                addLog('‚úÖ Proceso completado exitosamente', 'success');
                
                showResults({
                    mode: 'individual',
                    workerName: workerName,
                    ...result
                });
                
            } catch (error) {
                console.error('‚ùå Error generando ruta individual:', error);
                addLog(`Error: ${error.message}`, 'error');
                showMessage('Error al generar ruta: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // GENERAR RUTAS POR ROL
        // ==========================================
        async function generateByRole() {
            const roleSelect = document.getElementById('roleSelect');
            const roleId = roleSelect.value;
            
            if (!roleId) {
                showMessage('Por favor selecciona un rol', 'warning');
                return;
            }
            
            const roleData = JSON.parse(roleSelect.options[roleSelect.selectedIndex].getAttribute('data-role'));
            const roleName = roleData.role_name;
            
            try {
                // Obtener trabajadores con este rol
                const workersWithRole = await supabaseRequest('/worker_job_roles?select=worker_id,workers!inner(worker_first_name,worker_last_name_1,worker_last_name_2,worker_status)&job_role_id=eq.' + roleId + '&assignment_status=eq.active');
                
                // Filtrar solo trabajadores activos y √∫nicos
                const uniqueWorkers = [];
                const seenIds = new Set();
                
                workersWithRole.forEach(wr => {
                    if (wr.workers.worker_status === 'active' && !seenIds.has(wr.worker_id)) {
                        seenIds.add(wr.worker_id);
                        uniqueWorkers.push({
                            worker_id: wr.worker_id,
                            worker_first_name: wr.workers.worker_first_name,
                            worker_last_name_1: wr.workers.worker_last_name_1,
                            worker_last_name_2: wr.workers.worker_last_name_2
                        });
                    }
                });
                
                if (uniqueWorkers.length === 0) {
                    showMessage('No hay trabajadores activos con este rol', 'warning');
                    return;
                }
                
                if (!confirm(`¬øGenerar/actualizar rutas de formaci√≥n para:\n\nRol: ${roleName}\nTrabajadores: ${uniqueWorkers.length}\n\n¬øContinuar?`)) {
                    return;
                }
                
                // Mostrar contenedor de progreso
                document.getElementById('progressContainer').classList.add('active');
                document.getElementById('resultsContainer').classList.add('d-none');
                clearLog();
                
                addLog(`Iniciando generaci√≥n de rutas para rol: ${roleName}`, 'info');
                addLog(`Total de trabajadores a procesar: ${uniqueWorkers.length}`, 'info');
                updateProgress(0, uniqueWorkers.length, 'Preparando...');
                
                // Procesar cada trabajador
                let processed = 0;
                let successful = 0;
                let errors = 0;
                let totalUnitsAdded = 0;
                let totalUnitsExisting = 0;
                
                for (const worker of uniqueWorkers) {
                    const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
                    
                    try {
                        addLog(`Procesando: ${workerName}...`, 'info');
                        
                        const result = await generarRutaParaTrabajador(worker.worker_id, workerName, true);
                        
                        totalUnitsAdded += result.newUnits;
                        totalUnitsExisting += result.existingUnits;
                        successful++;
                        
                        if (result.newUnits > 0) {
                            addLog(`‚úì ${workerName}: ${result.newUnits} unidad(es) agregada(s)`, 'success');
                        } else {
                            addLog(`‚óã ${workerName}: Ruta ya actualizada`, 'info');
                        }
                        
                    } catch (error) {
                        errors++;
                        addLog(`‚úó ${workerName}: Error - ${error.message}`, 'error');
                        console.error(`Error procesando ${workerName}:`, error);
                    }
                    
                    processed++;
                    updateProgress(processed, uniqueWorkers.length, `Procesando ${processed} de ${uniqueWorkers.length}...`);
                    
                    // Peque√±a pausa para no sobrecargar
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Mostrar resultados
                updateProgress(100, 100, 'Completado');
                addLog('‚úÖ Proceso completado', 'success');
                
                showResults({
                    mode: 'role',
                    roleName: roleName,
                    totalWorkers: uniqueWorkers.length,
                    successful: successful,
                    errors: errors,
                    totalUnitsAdded: totalUnitsAdded,
                    totalUnitsExisting: totalUnitsExisting
                });
                
            } catch (error) {
                console.error('‚ùå Error generando rutas por rol:', error);
                addLog(`Error: ${error.message}`, 'error');
                showMessage('Error al generar rutas: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // FUNCI√ìN CORE: GENERAR RUTA PARA UN TRABAJADOR
        // ==========================================
        async function generarRutaParaTrabajador(workerId, workerName, silent = false) {
            // PASO 1: Obtener roles del trabajador
            const workerRolesData = await supabaseRequest('/worker_job_roles?select=job_role_id&worker_id=eq.' + workerId + '&assignment_status=eq.active');
            
            if (!workerRolesData || workerRolesData.length === 0) {
                throw new Error('El trabajador no tiene roles activos asignados');
            }
            
            const roleIds = workerRolesData.map(wr => wr.job_role_id);
            
            if (!silent) {
                addLog(`Roles encontrados: ${roleIds.length}`, 'info');
                updateProgress(20, 100, 'Buscando unidades formativas...');
            }
            
            // PASO 2: Obtener unidades formativas asociadas a esos roles
            const modulesData = await supabaseRequest('/training_module_roles?select=module_id,is_mandatory&job_role_id=in.(' + roleIds.join(',') + ')');
            
            if (!modulesData || modulesData.length === 0) {
                if (!silent) {
                    addLog('No hay unidades formativas asociadas a los roles', 'warning');
                }
                return {
                    newUnits: 0,
                    existingUnits: 0,
                    totalUnits: 0
                };
            }
            
            if (!silent) {
                addLog(`Unidades formativas encontradas: ${modulesData.length}`, 'info');
                updateProgress(40, 100, 'Procesando unidades...');
            }
            
            // PASO 3: Eliminar duplicados y determinar obligatoriedad
            const uniqueModules = {};
            modulesData.forEach(item => {
                if (!uniqueModules[item.module_id]) {
                    uniqueModules[item.module_id] = item.is_mandatory;
                } else {
                    uniqueModules[item.module_id] = uniqueModules[item.module_id] || item.is_mandatory;
                }
            });
            
            const totalUniqueModules = Object.keys(uniqueModules).length;
            
            if (!silent) {
                addLog(`Unidades √∫nicas (sin duplicados): ${totalUniqueModules}`, 'info');
                updateProgress(60, 100, 'Verificando rutas existentes...');
            }
            
            // PASO 4: Verificar cu√°les ya existen en la ruta del trabajador
            const existingPathsData = await supabaseRequest('/worker_training_paths?select=module_id,assignment_type&worker_id=eq.' + workerId);
            
            // Solo considerar las que son "Por rol" para no tocar las "Por inter√©s"
            const existingModuleIds = existingPathsData
                .filter(p => p.assignment_type === 'Por rol')
                .map(p => p.module_id);
            
            if (!silent) {
                addLog(`Unidades ya en ruta: ${existingModuleIds.length}`, 'info');
                updateProgress(80, 100, 'Insertando nuevas unidades...');
            }
            
            // PASO 5: Preparar inserciones solo de las que NO existen
            const pathsToInsert = [];
            
            for (const [moduleId, isMandatory] of Object.entries(uniqueModules)) {
                if (!existingModuleIds.includes(moduleId)) {
                    pathsToInsert.push({
                        worker_id: workerId,
                        module_id: moduleId,
                        assignment_type: 'Por rol',
                        assigned_by: currentUserId,
                        assignment_date: new Date().toISOString().split('T')[0],
                        completion_status: 'Pendiente',
                        path_status: 'active'
                    });
                }
            }
            
            // PASO 6: Insertar en batch si hay nuevas unidades
            if (pathsToInsert.length > 0) {
                await supabaseRequest('/worker_training_paths', {
                    method: 'POST',
                    body: JSON.stringify(pathsToInsert)
                });
                
                if (!silent) {
                    addLog(`‚úì ${pathsToInsert.length} unidad(es) agregada(s)`, 'success');
                }
            } else {
                if (!silent) {
                    addLog('‚óã Ruta ya actualizada, no hay unidades nuevas', 'info');
                }
            }
            
            if (!silent) {
                updateProgress(100, 100, 'Completado');
            }
            
            return {
                newUnits: pathsToInsert.length,
                existingUnits: existingModuleIds.length,
                totalUnits: totalUniqueModules
            };
        }
      // ==========================================
        // GENERAR TODAS LAS RUTAS
        // ==========================================
        async function generateAll() {
            if (!confirm(
                '‚ö†Ô∏è ADVERTENCIA ‚ö†Ô∏è\n\n' +
                'Esta acci√≥n generar√° rutas para TODOS los trabajadores activos del sistema.\n\n' +
                `Total de trabajadores a procesar: ${allWorkers.length}\n\n` +
                'Este proceso puede tomar varios minutos.\n\n' +
                '¬øEst√°s seguro de continuar?'
            )) {
                return;
            }
            
            // Doble confirmaci√≥n para proceso masivo
            if (!confirm('¬øRealmente deseas continuar con la generaci√≥n masiva?')) {
                return;
            }
            
            try {
                // Mostrar contenedor de progreso
                document.getElementById('progressContainer').classList.add('active');
                document.getElementById('resultsContainer').classList.add('d-none');
                clearLog();
                
                addLog('üöÄ Iniciando generaci√≥n masiva de rutas', 'info');
                addLog(`Total de trabajadores a procesar: ${allWorkers.length}`, 'info');
                updateProgress(0, allWorkers.length, 'Preparando...');
                
                let processed = 0;
                let successful = 0;
                let errors = 0;
                let totalUnitsAdded = 0;
                let totalUnitsExisting = 0;
                let skipped = 0;
                
                // Procesar cada trabajador
                for (const worker of allWorkers) {
                    const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
                    
                    try {
                        addLog(`Procesando ${processed + 1}/${allWorkers.length}: ${workerName}...`, 'info');
                        
                        const result = await generarRutaParaTrabajador(worker.worker_id, workerName, true);
                        
                        if (result.newUnits === 0 && result.existingUnits === 0) {
                            // No tiene unidades asignables
                            skipped++;
                            addLog(`‚óã ${workerName}: Sin unidades asociadas a sus roles`, 'warning');
                        } else if (result.newUnits > 0) {
                            // Se agregaron unidades
                            totalUnitsAdded += result.newUnits;
                            totalUnitsExisting += result.existingUnits;
                            successful++;
                            addLog(`‚úì ${workerName}: ${result.newUnits} unidad(es) agregada(s)`, 'success');
                        } else {
                            // Ya ten√≠a todas las unidades
                            totalUnitsExisting += result.existingUnits;
                            successful++;
                            addLog(`‚óã ${workerName}: Ruta ya actualizada (${result.totalUnits} unidades)`, 'info');
                        }
                        
                    } catch (error) {
                        errors++;
                        addLog(`‚úó ${workerName}: Error - ${error.message}`, 'error');
                        console.error(`Error procesando ${workerName}:`, error);
                    }
                    
                    processed++;
                    updateProgress(processed, allWorkers.length, `Procesando ${processed} de ${allWorkers.length}...`);
                    
                    // Pausa cada 10 trabajadores para no sobrecargar
                    if (processed % 10 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    } else {
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                }
                
                // Mostrar resultados
                updateProgress(100, 100, 'Completado');
                addLog('‚úÖ Proceso masivo completado', 'success');
                addLog(`üìä Resumen: ${successful} exitosos, ${errors} errores, ${skipped} omitidos`, 'info');
                
                showResults({
                    mode: 'all',
                    totalWorkers: allWorkers.length,
                    successful: successful,
                    errors: errors,
                    skipped: skipped,
                    totalUnitsAdded: totalUnitsAdded,
                    totalUnitsExisting: totalUnitsExisting
                });
                
            } catch (error) {
                console.error('‚ùå Error en generaci√≥n masiva:', error);
                addLog(`Error cr√≠tico: ${error.message}`, 'error');
                showMessage('Error en generaci√≥n masiva: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // MOSTRAR RESULTADOS
        // ==========================================
        function showResults(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsContent = document.getElementById('resultsContent');
            
            let html = '';
            
            switch(data.mode) {
                case 'individual':
                    html = `
                        <h5 class="mb-3">
                            <i class="bi bi-person-check me-2"></i>Ruta Generada para Trabajador Individual
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Trabajador:</strong> ${escapeHtml(data.workerName)}</p>
                                <p><strong>Unidades agregadas:</strong> ${data.newUnits}</p>
                                <p><strong>Unidades ya existentes:</strong> ${data.existingUnits}</p>
                                <p><strong>Total en ruta:</strong> ${data.totalUnits}</p>
                            </div>
                            <div class="col-md-6">
                                <div class="alert ${data.newUnits > 0 ? 'alert-success' : 'alert-info'}">
                                    <i class="bi bi-${data.newUnits > 0 ? 'check-circle' : 'info-circle'} me-2"></i>
                                    ${data.newUnits > 0 
                                        ? `Se agregaron ${data.newUnits} nueva(s) unidad(es) formativa(s)` 
                                        : 'La ruta ya estaba actualizada, no se agregaron unidades nuevas'}
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'role':
                    html = `
                        <h5 class="mb-3">
                            <i class="bi bi-people-fill me-2"></i>Rutas Generadas por Rol
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 class="text-primary">${data.totalWorkers}</h3>
                                        <p class="mb-0 text-muted">Trabajadores Procesados</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 class="text-success">${data.successful}</h3>
                                        <p class="mb-0 text-muted">Exitosos</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 class="text-danger">${data.errors}</h3>
                                        <p class="mb-0 text-muted">Errores</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p><strong>Rol procesado:</strong> ${escapeHtml(data.roleName)}</p>
                                <p><strong>Unidades agregadas (total):</strong> ${data.totalUnitsAdded}</p>
                                <p><strong>Unidades ya existentes (total):</strong> ${data.totalUnitsExisting}</p>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Revisa el log arriba para ver el detalle de cada trabajador procesado
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'all':
                    const successRate = ((data.successful / data.totalWorkers) * 100).toFixed(1);
                    html = `
                        <h5 class="mb-3">
                            <i class="bi bi-globe2 me-2"></i>Generaci√≥n Masiva Completada
                        </h5>
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h3>${data.totalWorkers}</h3>
                                        <p class="mb-0">Total Procesados</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3>${data.successful}</h3>
                                        <p class="mb-0">Exitosos</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h3>${data.errors}</h3>
                                        <p class="mb-0">Errores</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-dark">
                                    <div class="card-body text-center">
                                        <h3>${data.skipped}</h3>
                                        <p class="mb-0">Omitidos</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Resumen de Unidades:</h6>
                                <ul>
                                    <li><strong>Unidades agregadas (nuevas):</strong> ${data.totalUnitsAdded}</li>
                                    <li><strong>Unidades ya existentes:</strong> ${data.totalUnitsExisting}</li>
                                    <li><strong>Total unidades en rutas:</strong> ${data.totalUnitsAdded + data.totalUnitsExisting}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-${successRate >= 95 ? 'success' : successRate >= 80 ? 'warning' : 'danger'}">
                                    <h6><i class="bi bi-graph-up me-2"></i>Tasa de √âxito</h6>
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div class="progress-bar ${successRate >= 95 ? 'bg-success' : successRate >= 80 ? 'bg-warning' : 'bg-danger'}" 
                                             style="width: ${successRate}%">
                                            ${successRate}%
                                        </div>
                                    </div>
                                    <small>${data.successful} de ${data.totalWorkers} trabajadores procesados exitosamente</small>
                                </div>
                            </div>
                        </div>
                        ${data.errors > 0 ? `
                            <div class="alert alert-warning mt-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Atenci√≥n:</strong> Hubo ${data.errors} error(es) durante el proceso. 
                                Revisa el log arriba para identificar los trabajadores que fallaron.
                            </div>
                        ` : ''}
                        ${data.skipped > 0 ? `
                            <div class="alert alert-info mt-3">
                                <i class="bi bi-info-circle me-2"></i>
                                Se omitieron ${data.skipped} trabajador(es) porque no tienen unidades formativas asociadas a sus roles.
                            </div>
                        ` : ''}
                    `;
                    break;
            }
            
            resultsContent.innerHTML = html;
            resultsContainer.classList.remove('d-none');
            
            // Scroll hacia los resultados
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.selectMode = selectMode;
        window.generateIndividual = generateIndividual;
        window.generateByRole = generateByRole;
        window.generateAll = generateAll;
        window.resetForm = resetForm;
        
        console.log('üéâ generate-paths.html cargado correctamente');
    </script>
</body>
</html>
