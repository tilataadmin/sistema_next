<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultas de Rutas de Formación - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* Query Selector Card */
        .query-selector-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        .query-selector-card .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            padding: 1rem 1.5rem;
        }
        
        /* Query Type Selector */
        .query-type-selector {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
            margin-bottom: 1rem;
        }
        
        .query-type-selector select {
            font-size: 1.1rem;
            font-weight: 600;
            color: #667eea;
        }
        
        /* Parameters Section */
        .parameters-section {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.25rem;
            background: white;
            margin-bottom: 1rem;
            min-height: 120px;
        }
        
        .param-label {
            font-weight: 500;
            font-size: 0.875rem;
            color: #495057;
            margin-bottom: 0.25rem;
        }
        
        /* Execute Button */
        .btn-execute {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 0.75rem 2.5rem;
            font-weight: 600;
            font-size: 1.1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-execute:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        /* Results Section */
        .results-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .results-card .card-header {
            background: white;
            border-bottom: 2px solid #e9ecef;
            padding: 1.25rem 1.5rem;
        }
        
        /* KPI Cards */
        .kpi-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            line-height: 1;
            margin-bottom: 0.25rem;
        }
        
        .kpi-label {
            font-size: 0.875rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Query Results Table */
        .query-table {
            width: 100%;
            font-size: 0.875rem;
        }
        
        .query-table thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .query-table th {
            font-weight: 600;
            color: #495057;
            padding: 0.75rem;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }
        
        .query-table td {
            padding: 0.75rem;
            vertical-align: middle;
        }
        
        .query-table tbody tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        
        /* Progress Bars */
        .table-progress {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            overflow: hidden;
        }
        
        .table-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        /* Status Badges */
        .badge-completado {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        
        .badge-pendiente {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .badge-en-progreso {
            background-color: #cfe2ff;
            color: #084298;
        }
        
        .badge-vencido {
            background-color: #f8d7da;
            color: #842029;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .btn-action {
            padding: 0.5rem 1.25rem;
            border-radius: 6px;
            font-weight: 500;
            border: 2px solid;
            transition: all 0.2s ease;
        }
        
        .btn-action:hover {
            transform: translateY(-1px);
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Highlight for URL loaded queries */
        .url-loaded-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .btn-action {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Ejecutando consulta...</p>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb" id="breadcrumb-container">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Formación</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Consultas de Rutas
                </li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-search me-2"></i>
                    Consultas de Rutas de Formación
                </h1>
                <p class="text-muted">
                    Realiza consultas detalladas y análisis específicos sobre las rutas de formación
                </p>
            </div>
        </div>

        <!-- Contenedor de Alertas -->
        <div id="alertContainer"></div>
        
        <!-- Banner de carga desde URL -->
        <div id="url-loaded-banner" class="url-loaded-banner" style="display: none;">
            <i class="bi bi-link-45deg"></i>
            <span id="url-loaded-text"></span>
        </div>

        <!-- Selector de Consulta -->
        <div class="card query-selector-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-funnel me-2"></i>
                    Configuración de la Consulta
                </h5>
            </div>
            <div class="card-body">
                <!-- Selector de Tipo -->
                <div class="query-type-selector">
                    <label class="param-label">
                        <i class="bi bi-search me-1"></i>
                        Tipo de Consulta <span class="text-danger">*</span>
                    </label>
                    <select class="form-select form-select-lg" id="query-type" onchange="cambiarTipoConsulta()">
                        <option value="">Seleccione un tipo de consulta...</option>
                        <option value="por-trabajador">👤 Por Trabajador Específico</option>
                        <option value="por-modulo">📚 Por Módulo Específico</option>
                        <option value="por-eje">📊 Por Eje Formativo</option>
                        <option value="por-area">🏢 Por Área Organizacional</option>
                        <option value="por-fechas">📅 Por Rango de Fechas</option>
                        <option value="por-facilitador">🎓 Por Facilitador</option>
                        <option value="por-estado">⚠️ Por Estado</option>
                        <option value="avanzada">🔍 Consulta Avanzada</option>
                    </select>
                </div>

                <!-- Sección de Parámetros Dinámicos -->
                <div class="parameters-section" id="parameters-section">
                    <div class="empty-state">
                        <i class="bi bi-funnel"></i>
                        <p class="mb-0">Selecciona un tipo de consulta para ver los parámetros disponibles</p>
                    </div>
                </div>

                <!-- Botón de Ejecución -->
                <div class="text-center">
                    <button class="btn btn-primary btn-execute" id="btn-execute" onclick="ejecutarConsulta()" disabled>
                        <i class="bi bi-play-circle me-2"></i>
                        Ejecutar Consulta
                    </button>
                </div>
            </div>
        </div>

        <!-- Sección de Resultados -->
        <div class="card results-card mt-4" id="results-section" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                <h5 class="mb-0" id="results-title">
                    <i class="bi bi-table me-2"></i>
                    Resultados de la Consulta
                </h5>
                <div class="action-buttons">
                    <button class="btn btn-action btn-outline-primary" onclick="exportarResultados()">
                        <i class="bi bi-download me-1"></i>
                        Exportar
                    </button>
                    <button class="btn btn-action btn-outline-secondary" onclick="nuevaConsulta()">
                        <i class="bi bi-arrow-repeat me-1"></i>
                        Nueva Consulta
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- KPIs Resumen -->
                <div class="row g-3 mb-4" id="kpis-section">
                    <!-- Se llena dinámicamente -->
                </div>
                
                <!-- Contenido de Resultados -->
                <div id="results-content">
                    <!-- Se llena dinámicamente -->
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let queryResults = null;
        let currentQueryType = null;
        let currentQueryParams = null;
        let chartInstances = [];
        let catalogData = {
            workers: [],
            modules: [],
            axes: [],
            areas: [],
            facilitators: []
        };
        
        // ==========================================
        // CONFIGURACIÓN DE TIPOS DE CONSULTA
        // ==========================================
        const QUERY_TYPES = {
            'por-trabajador': {
                label: 'Por Trabajador Específico',
                icon: 'person',
                description: 'Ver la ruta de formación completa de un trabajador',
                params: [
                    { id: 'worker_id', label: 'Trabajador', type: 'select', source: 'workers', required: true },
                    { id: 'axis_id', label: 'Eje Formativo (opcional)', type: 'select', source: 'axes', required: false },
                    { id: 'status', label: 'Estado (opcional)', type: 'select', source: 'status', required: false }
                ]
            },
            'por-modulo': {
                label: 'Por Módulo Específico',
                icon: 'book',
                description: 'Ver todos los trabajadores asignados a un módulo',
                params: [
                    { id: 'module_id', label: 'Módulo', type: 'select', source: 'modules', required: true },
                    { id: 'status', label: 'Estado (opcional)', type: 'select', source: 'status', required: false },
                    { id: 'assignment_type', label: 'Tipo Asignación (opcional)', type: 'select', source: 'assignment_types', required: false }
                ]
            },
            'por-eje': {
                label: 'Por Eje Formativo',
                icon: 'bookmark',
                description: 'Análisis completo de un eje formativo',
                params: [
                    { id: 'axis_id', label: 'Eje Formativo', type: 'select', source: 'axes', required: true },
                    { id: 'area_id', label: 'Área Organizacional (opcional)', type: 'select', source: 'areas', required: false }
                ]
            },
            'por-area': {
                label: 'Por Área Organizacional',
                icon: 'building',
                description: 'Ver el progreso de todos los trabajadores de un área',
                params: [
                    { id: 'area_id', label: 'Área Organizacional', type: 'select', source: 'areas', required: true },
                    { id: 'axis_id', label: 'Eje Formativo (opcional)', type: 'select', source: 'axes', required: false }
                ]
            },
            'por-fechas': {
                label: 'Por Rango de Fechas',
                icon: 'calendar-range',
                description: 'Análisis temporal de completaciones',
                params: [
                    { id: 'date_from', label: 'Fecha Desde', type: 'date', required: true },
                    { id: 'date_to', label: 'Fecha Hasta', type: 'date', required: true },
                    { id: 'axis_id', label: 'Eje Formativo (opcional)', type: 'select', source: 'axes', required: false },
                    { id: 'area_id', label: 'Área Organizacional (opcional)', type: 'select', source: 'areas', required: false }
                ]
            },
            'por-facilitador': {
                label: 'Por Facilitador',
                icon: 'person-badge',
                description: 'Ver el impacto de un facilitador',
                params: [
                    { id: 'facilitator_id', label: 'Facilitador', type: 'select', source: 'facilitators', required: true },
                    { id: 'is_certifiable', label: 'Solo Certificables', type: 'checkbox', required: false }
                ]
            },
            'por-estado': {
                label: 'Por Estado',
                icon: 'check-circle',
                description: 'Filtrar rutas por estado de completación',
                params: [
                    { id: 'status', label: 'Estado', type: 'select', source: 'status', required: true },
                    { id: 'days', label: 'Días (ventana temporal)', type: 'number', required: false, placeholder: 'Ej: 7, 30, 90' },
                    { id: 'axis_id', label: 'Eje Formativo (opcional)', type: 'select', source: 'axes', required: false }
                ]
            },
            'avanzada': {
                label: 'Consulta Avanzada',
                icon: 'sliders',
                description: 'Combinación libre de múltiples filtros',
                params: [
                    { id: 'worker_id', label: 'Trabajador(es)', type: 'select', source: 'workers', required: false, multiple: true },
                    { id: 'module_id', label: 'Módulo(s)', type: 'select', source: 'modules', required: false, multiple: true },
                    { id: 'axis_id', label: 'Eje(s)', type: 'select', source: 'axes', required: false, multiple: true },
                    { id: 'area_id', label: 'Área(s)', type: 'select', source: 'areas', required: false, multiple: true },
                    { id: 'status', label: 'Estado(s)', type: 'select', source: 'status', required: false, multiple: true },
                    { id: 'assignment_type', label: 'Tipo Asignación', type: 'select', source: 'assignment_types', required: false },
                    { id: 'date_from', label: 'Fecha Desde', type: 'date', required: false },
                    { id: 'date_to', label: 'Fecha Hasta', type: 'date', required: false }
                ]
            }
        };
        
        // Opciones estáticas
        const STATIC_OPTIONS = {
            status: [
                { value: 'Pendiente', label: 'Pendiente' },
                { value: 'En progreso', label: 'En Progreso' },
                { value: 'Completado', label: 'Completado' },
                { value: 'Vencido', label: 'Vencido' }
            ],
            assignment_types: [
                { value: 'Por rol', label: 'Por rol' },
                { value: 'Por interés', label: 'Por interés' },
                { value: 'Administrativo', label: 'Administrativo' }
            ]
        };
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Validando acceso a consultas de rutas...');
            
            try {
                // Validar permisos
                const hasAccess = await validatePageAccess('Consultas de rutas');
                if (!hasAccess) {
                    console.log('❌ Acceso denegado');
                    return;
                }
                
                console.log('✅ Acceso permitido - inicializando consultas');
                await inicializarConsultas();
                
            } catch (error) {
                console.error('❌ Error validando acceso:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });
        
        // ==========================================
        // INICIALIZACIÓN DE CONSULTAS
        // ==========================================
        async function inicializarConsultas() {
            try {
                mostrarLoading();
                
                // Cargar catálogos en paralelo
                await Promise.all([
                    cargarTrabajadores(),
                    cargarModulos(),
                    cargarEjes(),
                    cargarAreas(),
                    cargarFacilitadores()
                ]);
                
                // Detectar parámetros URL
                const urlParams = new URLSearchParams(window.location.search);
                
                if (urlParams.toString()) {
                    console.log('🔗 Parámetros URL detectados:', urlParams.toString());
                    await procesarParametrosURL(urlParams);
                }
                
                ocultarLoading();
                console.log('✅ Consultas inicializadas correctamente');

                // Verificar si hay parámetros en la URL
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('status')) {
                    const status = urlParams.get('status');
                    const days = urlParams.get('days');
                    await cargarConsultaPorEstado(status, days, urlParams);
                }
                
            } catch (error) {
                console.error('❌ Error inicializando consultas:', error);
                showMessage('Error al inicializar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR CATÁLOGOS
        // ==========================================
        async function cargarTrabajadores() {
            try {
                const workers = await supabaseRequest('/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2&worker_status=eq.active&order=worker_first_name.asc');
                
                catalogData.workers = workers.map(w => ({
                    value: w.worker_id,
                    label: `${w.worker_first_name} ${w.worker_last_name_1} ${w.worker_last_name_2 || ''}`.trim()
                }));
                
                console.log('✅ Trabajadores cargados:', catalogData.workers.length);
                
            } catch (error) {
                console.error('❌ Error cargando trabajadores:', error);
                throw error;
            }
        }
        
        async function cargarModulos() {
            try {
                const modules = await supabaseRequest('/training_modules?select=module_id,module_code,module_title&module_status=eq.active&order=module_title.asc');
                
                catalogData.modules = modules.map(m => ({
                    value: m.module_id,
                    label: m.module_code ? `[${m.module_code}] ${m.module_title}` : m.module_title
                }));
                
                console.log('✅ Módulos cargados:', catalogData.modules.length);
                
            } catch (error) {
                console.error('❌ Error cargando módulos:', error);
                throw error;
            }
        }
        
        async function cargarEjes() {
            try {
                const axes = await supabaseRequest('/training_axes?select=axis_id,axis_name&axis_status=eq.active&order=axis_order.asc');
                
                catalogData.axes = axes.map(a => ({
                    value: a.axis_id,
                    label: a.axis_name
                }));
                
                console.log('✅ Ejes cargados:', catalogData.axes.length);
                
            } catch (error) {
                console.error('❌ Error cargando ejes:', error);
                throw error;
            }
        }
        
        async function cargarAreas() {
            try {
                const areas = await supabaseRequest('/organizational_areas?select=area_id,area_name&area_status=eq.active&order=area_order.asc');
                
                catalogData.areas = areas.map(a => ({
                    value: a.area_id,
                    label: a.area_name
                }));
                
                console.log('✅ Áreas cargadas:', catalogData.areas.length);
                
            } catch (error) {
                console.error('❌ Error cargando áreas:', error);
                throw error;
            }
        }
        
        async function cargarFacilitadores() {
            try {
                const facilitators = await supabaseRequest('/training_facilitators?select=facilitator_id,facilitator_name&facilitator_status=eq.active&order=facilitator_name.asc');
                
                catalogData.facilitators = facilitators.map(f => ({
                    value: f.facilitator_id,
                    label: f.facilitator_name
                }));
                
                console.log('✅ Facilitadores cargados:', catalogData.facilitators.length);
                
            } catch (error) {
                console.error('❌ Error cargando facilitadores:', error);
                throw error;
            }
        }
        
        // ==========================================
        // PROCESAR PARÁMETROS URL
        // ==========================================
        async function procesarParametrosURL(urlParams) {
            try {
                console.log('🔍 Procesando parámetros URL...');
                
                // Caso 1: Viene type explícito
                if (urlParams.has('type')) {
                    const type = urlParams.get('type');
                    await cargarConsultaPorTipo(type, urlParams);
                    return;
                }
                
                // Caso 2: Viene status (con o sin days)
                if (urlParams.has('status')) {
                    const status = urlParams.get('status');
                    const days = urlParams.get('days') ? parseInt(urlParams.get('days')) : null;
                    await cargarConsultaPorEstado(status, days, urlParams);
                    return;
                }
                
                // Caso 3: Viene axis_id solo
                if (urlParams.has('axis_id')) {
                    await cargarConsultaPorEje(urlParams.get('axis_id'));
                    return;
                }
                
                // Caso 4: Viene area_id solo
                if (urlParams.has('area_id')) {
                    await cargarConsultaPorArea(urlParams.get('area_id'));
                    return;
                }
                
                // Caso 5: Viene worker_id solo
                if (urlParams.has('worker_id')) {
                    await cargarConsultaPorTrabajador(urlParams.get('worker_id'));
                    return;
                }
                
                console.log('ℹ️ No se detectaron parámetros válidos para autoload');
                
            } catch (error) {
                console.error('❌ Error procesando parámetros URL:', error);
                showMessage('Error al procesar parámetros: ' + error.message, 'warning');
            }
        }
        
        // ==========================================
        // CARGAR CONSULTA POR TIPO
        // ==========================================
        async function cargarConsultaPorTipo(type, urlParams) {
            console.log(`📋 Cargando consulta por tipo: ${type}`);
            
            // Seleccionar tipo en dropdown
            document.getElementById('query-type').value = type;
            cambiarTipoConsulta();
            
            // Llenar parámetros desde URL
            const queryConfig = QUERY_TYPES[type];
            if (!queryConfig) return;
            
            queryConfig.params.forEach(param => {
                if (urlParams.has(param.id)) {
                    const element = document.getElementById(`param-${param.id}`);
                    if (element) {
                        element.value = urlParams.get(param.id);
                    }
                }
            });
            
            // Mostrar banner
            mostrarBannerURLCargada(`Consulta ${queryConfig.label} cargada desde enlace`);
            
            // Ejecutar automáticamente
            await ejecutarConsulta();
        }
        
        // ==========================================
        // CARGAR CONSULTA POR ESTADO
        // ==========================================
        async function cargarConsultaPorEstado(status, days = null, urlParams = null) {
            console.log(`⚠️ Cargando consulta por estado: ${status}, días: ${days}`);
            
            // Seleccionar tipo "por-estado"
            document.getElementById('query-type').value = 'por-estado';
            cambiarTipoConsulta();
            
            // Esperar a que se rendericen los parámetros
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Llenar parámetros
            const statusElement = document.getElementById('param-status');
            if (statusElement) {
                statusElement.value = status;
            }
            
            if (days) {
                const daysElement = document.getElementById('param-days');
                if (daysElement) {
                    daysElement.value = days;
                }
            }
            
            // Si viene axis_id adicional
            if (urlParams && urlParams.has('axis_id')) {
                const axisElement = document.getElementById('param-axis_id');
                if (axisElement) {
                    axisElement.value = urlParams.get('axis_id');
                }
            }
            
            // Mostrar banner
            const bannerText = days 
                ? `Módulos ${status} (${days} días) - Cargado desde dashboard`
                : `Módulos ${status} - Cargado desde dashboard`;
            mostrarBannerURLCargada(bannerText);
            
            // Ejecutar automáticamente
            await ejecutarConsulta();
        }
      // ==========================================
        // CARGAR CONSULTAS RÁPIDAS POR ENTIDAD
        // ==========================================
        async function cargarConsultaPorEje(axisId) {
            console.log(`📊 Cargando consulta por eje: ${axisId}`);
            
            document.getElementById('query-type').value = 'por-eje';
            cambiarTipoConsulta();
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const axisElement = document.getElementById('param-axis_id');
            if (axisElement) {
                axisElement.value = axisId;
            }
            
            mostrarBannerURLCargada('Consulta por Eje Formativo cargada desde enlace');
            await ejecutarConsulta();
        }
        
        async function cargarConsultaPorArea(areaId) {
            console.log(`🏢 Cargando consulta por área: ${areaId}`);
            
            document.getElementById('query-type').value = 'por-area';
            cambiarTipoConsulta();
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const areaElement = document.getElementById('param-area_id');
            if (areaElement) {
                areaElement.value = areaId;
            }
            
            mostrarBannerURLCargada('Consulta por Área Organizacional cargada desde enlace');
            await ejecutarConsulta();
        }
        
        async function cargarConsultaPorTrabajador(workerId) {
            console.log(`👤 Cargando consulta por trabajador: ${workerId}`);
            
            document.getElementById('query-type').value = 'por-trabajador';
            cambiarTipoConsulta();
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const workerElement = document.getElementById('param-worker_id');
            if (workerElement) {
                workerElement.value = workerId;
            }
            
            mostrarBannerURLCargada('Consulta por Trabajador cargada desde enlace');
            await ejecutarConsulta();
        }
        
        // ==========================================
        // MOSTRAR BANNER DE CARGA DESDE URL
        // ==========================================
        function mostrarBannerURLCargada(texto) {
            const banner = document.getElementById('url-loaded-banner');
            const textElement = document.getElementById('url-loaded-text');
            
            textElement.textContent = texto;
            banner.style.display = 'flex';
            
            // Auto-ocultar después de 5 segundos
            setTimeout(() => {
                banner.style.display = 'none';
            }, 5000);
        }
        
        // ==========================================
        // CAMBIAR TIPO DE CONSULTA
        // ==========================================
        function cambiarTipoConsulta() {
            const type = document.getElementById('query-type').value;
            const paramsSection = document.getElementById('parameters-section');
            const btnExecute = document.getElementById('btn-execute');
            
            if (!type) {
                paramsSection.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-funnel"></i>
                        <p class="mb-0">Selecciona un tipo de consulta para ver los parámetros disponibles</p>
                    </div>
                `;
                btnExecute.disabled = true;
                currentQueryType = null;
                return;
            }
            
            currentQueryType = type;
            const queryConfig = QUERY_TYPES[type];
            
            // Renderizar parámetros
            renderizarParametros(queryConfig);
            btnExecute.disabled = false;
            
            console.log(`✅ Tipo de consulta seleccionado: ${queryConfig.label}`);
        }
        
        // ==========================================
        // RENDERIZAR PARÁMETROS DINÁMICOS
        // ==========================================
        function renderizarParametros(queryConfig) {
            const paramsSection = document.getElementById('parameters-section');
            
            let html = `
                <div class="mb-3">
                    <h6 class="text-muted">
                        <i class="bi bi-${queryConfig.icon} me-2"></i>
                        ${queryConfig.description}
                    </h6>
                </div>
                <div class="row g-3">
            `;
            
            queryConfig.params.forEach(param => {
                const colClass = param.type === 'date' ? 'col-md-6' : 'col-md-12';
                const requiredBadge = param.required ? '<span class="text-danger">*</span>' : '<small class="text-muted">(Opcional)</small>';
                
                html += `<div class="${colClass}">`;
                html += `<label class="param-label">${param.label} ${requiredBadge}</label>`;
                
                switch (param.type) {
                    case 'select':
                        html += renderSelectParam(param);
                        break;
                    case 'date':
                        html += renderDateParam(param);
                        break;
                    case 'number':
                        html += renderNumberParam(param);
                        break;
                    case 'checkbox':
                        html += renderCheckboxParam(param);
                        break;
                }
                
                html += `</div>`;
            });
            
            html += `</div>`;
            paramsSection.innerHTML = html;
        }
        
        function renderSelectParam(param) {
            const multiple = param.multiple ? 'multiple size="4"' : '';
            const multipleHint = param.multiple ? '<small class="text-muted d-block">Mantén Ctrl/Cmd para seleccionar múltiples</small>' : '';
            
            let html = `<select class="form-select" id="param-${param.id}" ${multiple}>`;
            
            if (!param.required && !param.multiple) {
                html += `<option value="">Todos</option>`;
            }
            
            // Obtener opciones
            let options = [];
            if (param.source === 'status') {
                options = STATIC_OPTIONS.status;
            } else if (param.source === 'assignment_types') {
                options = STATIC_OPTIONS.assignment_types;
            } else if (catalogData[param.source]) {
                options = catalogData[param.source];
            }
            
            options.forEach(opt => {
                html += `<option value="${opt.value}">${opt.label}</option>`;
            });
            
            html += `</select>${multipleHint}`;
            return html;
        }
        
        function renderDateParam(param) {
            const today = new Date().toISOString().split('T')[0];
            const defaultValue = param.id === 'date_to' ? today : '';
            
            return `<input type="date" class="form-control" id="param-${param.id}" value="${defaultValue}">`;
        }
        
        function renderNumberParam(param) {
            const placeholder = param.placeholder || '';
            return `<input type="number" class="form-control" id="param-${param.id}" placeholder="${placeholder}" min="1">`;
        }
        
        function renderCheckboxParam(param) {
            return `
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="param-${param.id}">
                    <label class="form-check-label" for="param-${param.id}">
                        ${param.label}
                    </label>
                </div>
            `;
        }
        
        // ==========================================
        // EJECUTAR CONSULTA
        // ==========================================
        async function ejecutarConsulta() {
            try {
                if (!currentQueryType) {
                    showMessage('Por favor selecciona un tipo de consulta', 'warning');
                    return;
                }
                
                mostrarLoading();
                
                // Destruir gráficos anteriores
                destruirGraficos();
                
                // Obtener parámetros
                const params = obtenerParametrosConsulta();
                
                // Validar parámetros requeridos
                const queryConfig = QUERY_TYPES[currentQueryType];
                const missingParams = queryConfig.params
                    .filter(p => p.required && !params[p.id])
                    .map(p => p.label);
                
                if (missingParams.length > 0) {
                    showMessage(`Faltan parámetros requeridos: ${missingParams.join(', ')}`, 'warning');
                    ocultarLoading();
                    return;
                }
                
                currentQueryParams = params;
                
                // Ejecutar según tipo
                switch (currentQueryType) {
                    case 'por-trabajador':
                        await ejecutarConsultaPorTrabajador(params);
                        break;
                    case 'por-modulo':
                        await ejecutarConsultaPorModulo(params);
                        break;
                    case 'por-eje':
                        await ejecutarConsultaPorEje(params);
                        break;
                    case 'por-area':
                        await ejecutarConsultaPorArea(params);
                        break;
                    case 'por-fechas':
                        await ejecutarConsultaPorFechas(params);
                        break;
                    case 'por-facilitador':
                        await ejecutarConsultaPorFacilitador(params);
                        break;
                    case 'por-estado':
                        await ejecutarConsultaPorEstado(params);
                        break;
                    case 'avanzada':
                        await ejecutarConsultaAvanzada(params);
                        break;
                }
                
                // Mostrar sección de resultados
                document.getElementById('results-section').style.display = 'block';
                document.getElementById('results-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                ocultarLoading();
                
            } catch (error) {
                console.error('❌ Error ejecutando consulta:', error);
                showMessage('Error al ejecutar consulta: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // OBTENER PARÁMETROS DE CONSULTA
        // ==========================================
        function obtenerParametrosConsulta() {
            const params = {};
            const queryConfig = QUERY_TYPES[currentQueryType];
            
            queryConfig.params.forEach(param => {
                const element = document.getElementById(`param-${param.id}`);
                
                if (!element) return;
                
                if (param.type === 'checkbox') {
                    params[param.id] = element.checked;
                } else if (param.multiple) {
                    params[param.id] = Array.from(element.selectedOptions)
                        .map(opt => opt.value)
                        .filter(v => v);
                } else {
                    params[param.id] = element.value;
                }
            });
            
            console.log('📋 Parámetros obtenidos:', params);
            return params;
        }
        
        // ==========================================
        // CONSULTA 1: POR TRABAJADOR
        // ==========================================
        async function ejecutarConsultaPorTrabajador(params) {
            console.log('👤 Ejecutando consulta por trabajador...');
            
            let query = '/worker_training_paths?select=path_id,assignment_date,target_completion_date,actual_completion_date,completion_status,assignment_type,evaluation_score,training_modules(module_id,module_code,module_title,training_axes(axis_name),training_modalities(modality_name))&path_status=eq.active&worker_id=eq.' + params.worker_id;
            
            if (params.axis_id) {
                query += '&training_modules.axis_id=eq.' + params.axis_id;
            }
            if (params.status) {
                query += '&completion_status=eq.' + params.status;
            }
            
            query += '&order=assignment_date.desc';
            
            const data = await supabaseRequest(query);
            queryResults = data;
            
            // Obtener nombre del trabajador
            const workerData = catalogData.workers.find(w => w.value === params.worker_id);
            const workerName = workerData ? workerData.label : 'Trabajador';
            
            renderResultadosPorTrabajador(data, workerName);
        }
        
        function renderResultadosPorTrabajador(data, workerName) {
            document.getElementById('results-title').innerHTML = `<i class="bi bi-person me-2"></i>Ruta de Formación: ${workerName}`;
            
            if (!data || data.length === 0) {
                document.getElementById('results-content').innerHTML = '<div class="alert alert-info">No se encontraron rutas para este trabajador con los filtros aplicados.</div>';
                return;
            }
            
            // KPIs
            const totalAsignados = data.length;
            const completados = data.filter(p => p.completion_status === 'Completado').length;
            const pendientes = data.filter(p => ['Pendiente', 'En progreso'].includes(p.completion_status)).length;
            const vencidos = data.filter(p => p.completion_status === 'Vencido').length;
            const porcentaje = totalAsignados > 0 ? Math.round((completados / totalAsignados) * 100) : 0;
            
            const kpisHtml = `
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value">${totalAsignados}</div>
                        <div class="kpi-label">Total Asignados</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-success">${completados}</div>
                        <div class="kpi-label">Completados</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-warning">${pendientes}</div>
                        <div class="kpi-label">Pendientes</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-info">${porcentaje}%</div>
                        <div class="kpi-label">% Completación</div>
                    </div>
                </div>
            `;
            
            document.getElementById('kpis-section').innerHTML = kpisHtml;
            
            // Tabla detallada
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover query-table">
                        <thead>
                            <tr>
                                <th>Módulo</th>
                                <th>Eje</th>
                                <th>Modalidad</th>
                                <th>Tipo Asignación</th>
                                <th>Fecha Asignación</th>
                                <th>Fecha Límite</th>
                                <th>Fecha Completado</th>
                                <th>Calificación</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(path => {
                const module = path.training_modules;
                const statusClass = path.completion_status.toLowerCase().replace(' ', '-');
                
                tableHtml += `
                    <tr>
                        <td>
                            ${module.module_code ? `<span class="badge bg-secondary">${module.module_code}</span> ` : ''}
                            ${module.module_title}
                        </td>
                        <td>${module.training_axes?.axis_name || '-'}</td>
                        <td><small>${module.training_modalities?.modality_name || '-'}</small></td>
                        <td><span class="badge bg-info">${path.assignment_type}</span></td>
                        <td>${formatDate(path.assignment_date)}</td>
                        <td>${path.target_completion_date ? formatDate(path.target_completion_date) : '-'}</td>
                        <td>${path.actual_completion_date ? formatDate(path.actual_completion_date) : '-'}</td>
                        <td>
                            ${path.evaluation_score ? `<span class="badge bg-success">${path.evaluation_score}</span>` : '-'}
                        </td>
                        <td>
                            <span class="badge badge-${statusClass}">${path.completion_status}</span>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('results-content').innerHTML = tableHtml;
        }
        
        // ==========================================
        // CONSULTA 2: POR MÓDULO
        // ==========================================
        async function ejecutarConsultaPorModulo(params) {
            console.log('📚 Ejecutando consulta por módulo...');
            
            let query = '/worker_training_paths?select=path_id,assignment_date,target_completion_date,actual_completion_date,completion_status,assignment_type,evaluation_score,workers(worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,organizational_areas(area_name)),training_modules(module_id,module_code,module_title)&path_status=eq.active&module_id=eq.' + params.module_id;
            if (params.status) {
                query += '&completion_status=eq.' + params.status;
            }
            if (params.assignment_type) {
                query += '&assignment_type=eq.' + params.assignment_type;
            }
            
            query += '&order=workers(worker_first_name).asc';
            
            const data = await supabaseRequest(query);
            queryResults = data;
            
            // Obtener nombre del módulo
            const moduleData = catalogData.modules.find(m => m.value === params.module_id);
            const moduleName = moduleData ? moduleData.label : 'Módulo';
            
            renderResultadosPorModulo(data, moduleName);
        }
        
        function renderResultadosPorModulo(data, moduleName) {
            document.getElementById('results-title').innerHTML = `<i class="bi bi-book me-2"></i>Asignaciones del Módulo: ${moduleName}`;
            
            if (!data || data.length === 0) {
                document.getElementById('results-content').innerHTML = '<div class="alert alert-info">No se encontraron asignaciones para este módulo con los filtros aplicados.</div>';
                return;
            }
            
            // KPIs
            const totalAsignaciones = data.length;
            const completados = data.filter(p => p.completion_status === 'Completado').length;
            const pendientes = data.filter(p => ['Pendiente', 'En progreso'].includes(p.completion_status)).length;
            const promedioCalif = data.filter(p => p.evaluation_score).length > 0
                ? (data.filter(p => p.evaluation_score).reduce((sum, p) => sum + parseFloat(p.evaluation_score), 0) / data.filter(p => p.evaluation_score).length).toFixed(1)
                : 'N/A';
            
            const kpisHtml = `
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value">${totalAsignaciones}</div>
                        <div class="kpi-label">Total Asignaciones</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-success">${completados}</div>
                        <div class="kpi-label">Completados</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-warning">${pendientes}</div>
                        <div class="kpi-label">Pendientes</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-primary">${promedioCalif}</div>
                        <div class="kpi-label">Calificación Prom.</div>
                    </div>
                </div>
            `;
            
            document.getElementById('kpis-section').innerHTML = kpisHtml;
            
            // Tabla detallada
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover query-table">
                        <thead>
                            <tr>
                                <th>Trabajador</th>
                                <th>Área</th>
                                <th>Tipo Asignación</th>
                                <th>Fecha Asignación</th>
                                <th>Fecha Límite</th>
                                <th>Fecha Completado</th>
                                <th>Calificación</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(path => {
                const worker = path.workers;
                const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
                const statusClass = path.completion_status.toLowerCase().replace(' ', '-');
                
                tableHtml += `
                    <tr>
                        <td><strong>${workerName}</strong></td>
                        <td>${worker.organizational_areas?.area_name || '-'}</td>
                        <td><span class="badge bg-info">${path.assignment_type}</span></td>
                        <td>${formatDate(path.assignment_date)}</td>
                        <td>${path.target_completion_date ? formatDate(path.target_completion_date) : '-'}</td>
                        <td>${path.actual_completion_date ? formatDate(path.actual_completion_date) : '-'}</td>
                        <td>
                            ${path.evaluation_score ? `<span class="badge bg-success">${path.evaluation_score}</span>` : '-'}
                        </td>
                        <td>
                            <span class="badge badge-${statusClass}">${path.completion_status}</span>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('results-content').innerHTML = tableHtml;
        }
      // ==========================================
        // CONSULTA 3: POR EJE
        // ==========================================
        async function ejecutarConsultaPorEje(params) {
            console.log('📊 Ejecutando consulta por eje...');
            
            let query = '/worker_training_paths?select=path_id,completion_status,workers(worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,organizational_areas(area_name)),training_modules(module_id,module_code,module_title)&path_status=eq.active&training_modules.axis_id=eq.' + params.axis_id;
            
            if (params.area_id) {
                query += '&workers.organizational_area_id=eq.' + params.area_id;
            }
            
            const data = await supabaseRequest(query);
            queryResults = data;
            
            // Obtener nombre del eje
            const axisData = catalogData.axes.find(a => a.value === params.axis_id);
            const axisName = axisData ? axisData.label : 'Eje';
            
            renderResultadosPorEje(data, axisName);
        }
        
        function renderResultadosPorEje(data, axisName) {
            document.getElementById('results-title').innerHTML = `<i class="bi bi-bookmark me-2"></i>Análisis del Eje: ${axisName}`;
            
            if (!data || data.length === 0) {
                document.getElementById('results-content').innerHTML = '<div class="alert alert-info">No se encontraron rutas para este eje con los filtros aplicados.</div>';
                return;
            }
            
            // KPIs
            const totalRutas = data.length;
            const completados = data.filter(p => p.completion_status === 'Completado').length;
            const pendientes = data.filter(p => ['Pendiente', 'En progreso'].includes(p.completion_status)).length;
            const porcentaje = totalRutas > 0 ? Math.round((completados / totalRutas) * 100) : 0;
            
            // Trabajadores únicos
            const trabajadoresUnicos = new Set(data.map(p => p.workers.worker_id)).size;
            
            const kpisHtml = `
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value">${totalRutas}</div>
                        <div class="kpi-label">Total Rutas</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-primary">${trabajadoresUnicos}</div>
                        <div class="kpi-label">Trabajadores</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-success">${completados}</div>
                        <div class="kpi-label">Completados</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-info">${porcentaje}%</div>
                        <div class="kpi-label">% Completación</div>
                    </div>
                </div>
            `;
            
            document.getElementById('kpis-section').innerHTML = kpisHtml;
            
            // Agrupar por módulo
            const modulosMap = {};
            data.forEach(path => {
                const module = path.training_modules;
                if (!module) return;
                if (!modulosMap[module.module_id]) {
                    modulosMap[module.module_id] = {
                        moduleCode: module.module_code,
                        moduleTitle: module.module_title,
                        total: 0,
                        completados: 0
                    };
                }
                modulosMap[module.module_id].total++;
                if (path.completion_status === 'Completado') {
                    modulosMap[module.module_id].completados++;
                }
            });
            
            const modulosArray = Object.values(modulosMap).map(m => ({
                ...m,
                porcentaje: m.total > 0 ? Math.round((m.completados / m.total) * 100) : 0
            }));
            
            modulosArray.sort((a, b) => b.porcentaje - a.porcentaje);
            
            // Tabla de módulos del eje
            let tableHtml = `
                <h6 class="mb-3">Módulos del Eje</h6>
                <div class="table-responsive">
                    <table class="table table-hover query-table">
                        <thead>
                            <tr>
                                <th>Módulo</th>
                                <th>Total Asignaciones</th>
                                <th>Completados</th>
                                <th>% Completación</th>
                                <th>Progreso</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            modulosArray.forEach(module => {
                const progressColor = module.porcentaje >= 75 ? 'success' :
                                     module.porcentaje >= 50 ? 'info' :
                                     module.porcentaje >= 25 ? 'warning' : 'danger';
                
                tableHtml += `
                    <tr>
                        <td>
                            ${module.moduleCode ? `<span class="badge bg-secondary">${module.moduleCode}</span> ` : ''}
                            ${module.moduleTitle}
                        </td>
                        <td class="text-center">${module.total}</td>
                        <td class="text-center">
                            <span class="badge bg-success">${module.completados}</span>
                        </td>
                        <td class="text-center"><strong>${module.porcentaje}%</strong></td>
                        <td>
                            <div class="table-progress">
                                <div class="table-progress-fill bg-${progressColor}" style="width: ${module.porcentaje}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('results-content').innerHTML = tableHtml;
        }
        
        // ==========================================
        // CONSULTA 4: POR ÁREA
        // ==========================================
        async function ejecutarConsultaPorArea(params) {
            console.log('🏢 Ejecutando consulta por área...');
            
            let query = '/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,worker_training_paths(path_id,completion_status,path_status,training_modules(module_code,module_title,training_axes(axis_name)))&worker_status=eq.active&organizational_area_id=eq.' + params.area_id;
            
            const workers = await supabaseRequest(query);
            
            // Filtrar por eje si se especifica
            let filteredData = workers;
            if (params.axis_id) {
                filteredData = workers.filter(w => 
                    w.worker_training_paths.some(p => 
                        p.training_modules?.training_axes?.axis_id === params.axis_id
                    )
                );
            }
            
            queryResults = filteredData;
            
            // Obtener nombre del área
            const areaData = catalogData.areas.find(a => a.value === params.area_id);
            const areaName = areaData ? areaData.label : 'Área';
            
            renderResultadosPorArea(filteredData, areaName);
        }
        
        function renderResultadosPorArea(data, areaName) {
            document.getElementById('results-title').innerHTML = `<i class="bi bi-building me-2"></i>Análisis del Área: ${areaName}`;
            
            if (!data || data.length === 0) {
                document.getElementById('results-content').innerHTML = '<div class="alert alert-info">No se encontraron trabajadores en esta área con los filtros aplicados.</div>';
                return;
            }
            
            // Calcular estadísticas por trabajador
            const workerStats = data.map(worker => {
                const activePaths = worker.worker_training_paths.filter(p => p.path_status === 'active');
                const completados = activePaths.filter(p => p.completion_status === 'Completado').length;
                const total = activePaths.length;
                
                return {
                    workerId: worker.worker_id,
                    workerName: `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim(),
                    totalAsignados: total,
                    completados: completados,
                    porcentaje: total > 0 ? Math.round((completados / total) * 100) : 0
                };
            });
            
            // KPIs
            const totalTrabajadores = data.length;
            const totalAsignaciones = workerStats.reduce((sum, w) => sum + w.totalAsignados, 0);
            const totalCompletados = workerStats.reduce((sum, w) => sum + w.completados, 0);
            const promedioArea = totalAsignaciones > 0 ? Math.round((totalCompletados / totalAsignaciones) * 100) : 0;
            
            const kpisHtml = `
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value">${totalTrabajadores}</div>
                        <div class="kpi-label">Trabajadores</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-primary">${totalAsignaciones}</div>
                        <div class="kpi-label">Total Asignaciones</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-success">${totalCompletados}</div>
                        <div class="kpi-label">Completados</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-info">${promedioArea}%</div>
                        <div class="kpi-label">% Promedio Área</div>
                    </div>
                </div>
            `;
            
            document.getElementById('kpis-section').innerHTML = kpisHtml;
            
            // Ordenar por porcentaje
            workerStats.sort((a, b) => b.porcentaje - a.porcentaje);
            
            // Tabla de trabajadores
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover query-table">
                        <thead>
                            <tr>
                                <th>Trabajador</th>
                                <th>Total Asignados</th>
                                <th>Completados</th>
                                <th>Pendientes</th>
                                <th>% Completación</th>
                                <th>Progreso</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            workerStats.forEach(worker => {
                const progressColor = worker.porcentaje >= 75 ? 'success' :
                                     worker.porcentaje >= 50 ? 'info' :
                                     worker.porcentaje >= 25 ? 'warning' : 'danger';
                
                const pendientes = worker.totalAsignados - worker.completados;
                
                tableHtml += `
                    <tr>
                        <td><strong>${worker.workerName}</strong></td>
                        <td class="text-center">${worker.totalAsignados}</td>
                        <td class="text-center">
                            <span class="badge bg-success">${worker.completados}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-warning">${pendientes}</span>
                        </td>
                        <td class="text-center"><strong>${worker.porcentaje}%</strong></td>
                        <td>
                            <div class="table-progress">
                                <div class="table-progress-fill bg-${progressColor}" style="width: ${worker.porcentaje}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('results-content').innerHTML = tableHtml;
        }
        
        // ==========================================
        // CONSULTA 5: POR FECHAS
        // ==========================================
        async function ejecutarConsultaPorFechas(params) {
            console.log('📅 Ejecutando consulta por fechas...');
            
            let query = '/worker_training_paths?select=path_id,actual_completion_date,completion_status,workers(worker_id,worker_first_name,worker_last_name_1,worker_last_name_2),training_modules(module_id,module_code,module_title,training_axes(axis_id,axis_name))&completion_status=eq.Completado&path_status=eq.active&actual_completion_date=gte.' + params.date_from + '&actual_completion_date=lte.' + params.date_to;
            
            if (params.axis_id) {
                query += '&training_modules.axis_id=eq.' + params.axis_id;
            }
            if (params.area_id) {
                query += '&workers.organizational_area_id=eq.' + params.area_id;
            }
            
            query += '&order=actual_completion_date.asc';
            
            const data = await supabaseRequest(query);
            queryResults = data;
            
            renderResultadosPorFechas(data, params.date_from, params.date_to);
        }
        
        function renderResultadosPorFechas(data, dateFrom, dateTo) {
            document.getElementById('results-title').innerHTML = `<i class="bi bi-calendar-range me-2"></i>Completaciones: ${formatDate(dateFrom)} - ${formatDate(dateTo)}`;
            
            if (!data || data.length === 0) {
                document.getElementById('results-content').innerHTML = '<div class="alert alert-info">No se encontraron completaciones en el rango de fechas especificado.</div>';
                return;
            }
            
            // KPIs
            const totalCompletaciones = data.length;
            const trabajadoresUnicos = new Set(data.map(p => p.workers.worker_id)).size;
            const modulosUnicos = new Set(data.map(p => p.training_modules.module_id)).size;
            const ejesUnicos = new Set(data.map(p => p.training_modules.training_axes?.axis_id).filter(Boolean)).size;
            
            const kpisHtml = `
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value">${totalCompletaciones}</div>
                        <div class="kpi-label">Total Completaciones</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-primary">${trabajadoresUnicos}</div>
                        <div class="kpi-label">Trabajadores</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-success">${modulosUnicos}</div>
                        <div class="kpi-label">Módulos Únicos</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-info">${ejesUnicos}</div>
                        <div class="kpi-label">Ejes Formativos</div>
                    </div>
                </div>
            `;
            
            document.getElementById('kpis-section').innerHTML = kpisHtml;
            
            // Gráfico de línea temporal
            const chartHtml = `
                <div class="mb-4">
                    <h6>Tendencia de Completaciones</h6>
                    <div class="chart-container">
                        <canvas id="temporal-chart"></canvas>
                    </div>
                </div>
            `;
            
            // Tabla detallada
            let tableHtml = chartHtml + `
                <h6 class="mb-3">Detalle de Completaciones</h6>
                <div class="table-responsive">
                    <table class="table table-hover query-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Trabajador</th>
                                <th>Módulo</th>
                                <th>Eje</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(path => {
                const worker = path.workers;
                const module = path.training_modules;
                const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1}`.trim();
                
                tableHtml += `
                    <tr>
                        <td>${formatDate(path.actual_completion_date)}</td>
                        <td>${workerName}</td>
                        <td>
                            ${module.module_code ? `<span class="badge bg-secondary">${module.module_code}</span> ` : ''}
                            ${module.module_title}
                        </td>
                        <td>${module.training_axes?.axis_name || '-'}</td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('results-content').innerHTML = tableHtml;
            
            // Renderizar gráfico
            setTimeout(() => renderTemporalChartQuery(data), 100);
        }
        
        function renderTemporalChartQuery(data) {
            const ctx = document.getElementById('temporal-chart');
            if (!ctx) return;
            
            // Agrupar por fecha
            const dateMap = {};
            data.forEach(path => {
                const date = path.actual_completion_date;
                dateMap[date] = (dateMap[date] || 0) + 1;
            });
            
            const dates = Object.keys(dateMap).sort();
            const counts = dates.map(d => dateMap[d]);
            
            const chart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: dates.map(d => formatDate(d)),
                    datasets: [{
                        label: 'Completaciones',
                        data: counts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            chartInstances.push(chart);
        }
        
        // ==========================================
        // CONSULTA 6: POR FACILITADOR
        // ==========================================
        async function ejecutarConsultaPorFacilitador(params) {
            console.log('🎓 Ejecutando consulta por facilitador...');
            
            // Primero obtener módulos del facilitador
            let moduleQuery = '/training_module_facilitators?select=module_id,training_modules(module_id,module_code,module_title,is_certifiable)&facilitator_id=eq.' + params.facilitator_id;
            
            const moduleFacilitators = await supabaseRequest(moduleQuery);
            const moduleIds = moduleFacilitators.map(mf => mf.training_modules.module_id);
            
            if (moduleIds.length === 0) {
                queryResults = [];
                renderResultadosPorFacilitador([], 'Facilitador', []);
                return;
            }
            
            // Luego obtener rutas de esos módulos
            let pathQuery = '/worker_training_paths?select=path_id,completion_status,evaluation_score,workers(worker_id,worker_first_name,worker_last_name_1),training_modules(module_id,module_code,module_title,is_certifiable)&path_status=eq.active&training_modules.module_id=in.(' + moduleIds.join(',') + ')';
            
            if (params.is_certifiable) {
                pathQuery += '&training_modules.is_certifiable=eq.true';
            }
            
            const data = await supabaseRequest(pathQuery);
            queryResults = data;
            
            // Obtener nombre del facilitador
            const facilitatorData = catalogData.facilitators.find(f => f.value === params.facilitator_id);
            const facilitatorName = facilitatorData ? facilitatorData.label : 'Facilitador';
            
            renderResultadosPorFacilitador(data, facilitatorName, moduleFacilitators.map(mf => mf.training_modules));
        }
        
        function renderResultadosPorFacilitador(data, facilitatorName, modules) {
            document.getElementById('results-title').innerHTML = `<i class="bi bi-person-badge me-2"></i>Impacto del Facilitador: ${facilitatorName}`;
            
            if (modules.length === 0) {
                document.getElementById('results-content').innerHTML = '<div class="alert alert-info">Este facilitador no tiene módulos asignados.</div>';
                return;
            }
            
            if (!data || data.length === 0) {
                document.getElementById('results-content').innerHTML = '<div class="alert alert-info">No se encontraron rutas para los módulos de este facilitador.</div>';
                return;
            }
            
            // KPIs
            const totalAsignaciones = data.length;
            const completados = data.filter(p => p.completion_status === 'Completado').length;
            const trabajadoresImpactados = new Set(data.map(p => p.workers.worker_id)).size;
            const modulosFacilitados = modules.length;
            
            const promedioCalif = data.filter(p => p.evaluation_score).length > 0
                ? (data.filter(p => p.evaluation_score).reduce((sum, p) => sum + parseFloat(p.evaluation_score), 0) / data.filter(p => p.evaluation_score).length).toFixed(1)
                : 'N/A';
            
            const kpisHtml = `
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value">${modulosFacilitados}</div>
                        <div class="kpi-label">Módulos Facilitados</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-primary">${trabajadoresImpactados}</div>
                        <div class="kpi-label">Trabajadores Impactados</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-success">${completados}</div>
                        <div class="kpi-label">Completados</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-warning">${promedioCalif}</div>
                        <div class="kpi-label">Calificación Prom.</div>
                    </div>
                </div>
            `;
            
            document.getElementById('kpis-section').innerHTML = kpisHtml;
            
            // Tabla de módulos
            let tableHtml = `
                <h6 class="mb-3">Módulos Facilitados</h6>
                <div class="table-responsive">
                    <table class="table table-hover query-table">
                        <thead>
                            <tr>
                                <th>Módulo</th>
                                <th>Certificable</th>
                                <th>Total Asignaciones</th>
                                <th>Completados</th>
                                <th>Calificación Prom.</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            modules.forEach(module => {
                const pathsForModule = data.filter(p => p.training_modules.module_id === module.module_id);
                const completadosModule = pathsForModule.filter(p => p.completion_status === 'Completado').length;
                const avgScore = pathsForModule.filter(p => p.evaluation_score).length > 0
                    ? (pathsForModule.filter(p => p.evaluation_score).reduce((sum, p) => sum + parseFloat(p.evaluation_score), 0) / pathsForModule.filter(p => p.evaluation_score).length).toFixed(1)
                    : 'N/A';
                
                tableHtml += `
                    <tr>
                        <td>
                            ${module.module_code ? `<span class="badge bg-secondary">${module.module_code}</span> ` : ''}
                            ${module.module_title}
                        </td>
                        <td>
                            ${module.is_certifiable ? '<span class="badge bg-warning">Sí</span>' : '<span class="badge bg-light text-dark">No</span>'}
                        </td>
                        <td class="text-center">${pathsForModule.length}</td>
                        <td class="text-center">
                            <span class="badge bg-success">${completadosModule}</span>
                        </td>
                        <td class="text-center">
                            ${avgScore !== 'N/A' ? `<span class="badge bg-primary">${avgScore}</span>` : 'N/A'}
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('results-content').innerHTML = tableHtml;
        }
      // ==========================================
        // CONSULTA 7: POR ESTADO
        // ==========================================
        async function ejecutarConsultaPorEstado(params) {
            console.log('⚠️ Ejecutando consulta por estado...');
            
            let query = '/worker_training_paths?select=path_id,assignment_date,target_completion_date,actual_completion_date,completion_status,workers(worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,organizational_areas(area_name)),training_modules(module_id,module_code,module_title,priority,training_axes(axis_name))&path_status=eq.active';
            
            // Filtro de estado con lógica de días
            if (params.status === 'Vencido') {
                query += '&completion_status=eq.Vencido';
                
                if (params.days) {
                    // Vencidos en los últimos X días
                    const dateFrom = new Date();
                    dateFrom.setDate(dateFrom.getDate() - parseInt(params.days));
                    query += '&target_completion_date=gte.' + dateFrom.toISOString().split('T')[0];
                }
            } else if (params.status === 'Pendiente' || params.status === 'En progreso') {
                query += '&completion_status=in.(Pendiente,En progreso)';
                
                if (params.days) {
                    // Que vencen en los próximos X días
                    const dateTo = new Date();
                    dateTo.setDate(dateTo.getDate() + parseInt(params.days));
                    query += '&target_completion_date=lte.' + dateTo.toISOString().split('T')[0];
                    query += '&target_completion_date=gte.' + new Date().toISOString().split('T')[0];
                }
            } else {
                query += '&completion_status=eq.' + params.status;
            }
            
            if (params.axis_id) {
                query += '&training_modules.axis_id=eq.' + params.axis_id;
            }
            
            query += '&order=target_completion_date.asc.nullslast';
            
            const data = await supabaseRequest(query);
            
            // Calcular días restantes/vencidos
            const today = new Date();
            data.forEach(path => {
                if (path.target_completion_date) {
                    const deadline = new Date(path.target_completion_date);
                    const diffTime = deadline - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    path.diasRestantes = diffDays;
                    
                    if (diffDays < 0) {
                        path.alertLevel = 'urgent';
                    } else if (diffDays <= 7) {
                        path.alertLevel = 'urgent';
                    } else if (diffDays <= 30) {
                        path.alertLevel = 'warning';
                    } else {
                        path.alertLevel = 'normal';
                    }
                } else {
                    path.diasRestantes = null;
                    path.alertLevel = 'normal';
                }
            });
            
            queryResults = data;
            
            renderResultadosPorEstado(data, params.status, params.days);
        }
        
        function renderResultadosPorEstado(data, status, days) {
            const titleText = days 
                ? `Módulos ${status} (${days} días)` 
                : `Módulos ${status}`;
            
            document.getElementById('results-title').innerHTML = `<i class="bi bi-check-circle me-2"></i>${titleText}`;
            
            if (!data || data.length === 0) {
                document.getElementById('results-content').innerHTML = '<div class="alert alert-info">No se encontraron módulos con este estado y filtros aplicados.</div>';
                return;
            }
            
            // KPIs
            const totalModulos = data.length;
            const trabajadoresAfectados = new Set(data.map(p => p.workers.worker_id)).size;
            const urgentes = data.filter(p => p.alertLevel === 'urgent').length;
            const conFechaLimite = data.filter(p => p.target_completion_date).length;
            
            const kpisHtml = `
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value">${totalModulos}</div>
                        <div class="kpi-label">Total Módulos</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-primary">${trabajadoresAfectados}</div>
                        <div class="kpi-label">Trabajadores</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-danger">${urgentes}</div>
                        <div class="kpi-label">Urgentes</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-warning">${conFechaLimite}</div>
                        <div class="kpi-label">Con Fecha Límite</div>
                    </div>
                </div>
            `;
            
            document.getElementById('kpis-section').innerHTML = kpisHtml;
            
            // Tabla detallada
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover query-table">
                        <thead>
                            <tr>
                                <th>Alerta</th>
                                <th>Trabajador</th>
                                <th>Área</th>
                                <th>Módulo</th>
                                <th>Eje</th>
                                <th>Fecha Límite</th>
                                <th>Días</th>
                                <th>Prioridad</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(path => {
                const worker = path.workers;
                const module = path.training_modules;
                const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1}`.trim();
                
                const alertIcon = path.alertLevel === 'urgent' ? '🔴' : 
                                 path.alertLevel === 'warning' ? '🟡' : '🟢';
                
                const diasText = path.diasRestantes === null ? 'Sin fecha' :
                                path.diasRestantes < 0 ? `Vencido hace ${Math.abs(path.diasRestantes)} días` :
                                path.diasRestantes === 0 ? 'Vence HOY' :
                                `${path.diasRestantes} días`;
                
                const deadlineClass = path.alertLevel === 'urgent' ? 'deadline-urgent' :
                                     path.alertLevel === 'warning' ? 'deadline-warning' : 'deadline-normal';
                
                tableHtml += `
                    <tr>
                        <td class="text-center">${alertIcon}</td>
                        <td>${workerName}</td>
                        <td><small>${worker.organizational_areas?.area_name || '-'}</small></td>
                        <td>
                            ${module.module_code ? `<span class="badge bg-secondary">${module.module_code}</span> ` : ''}
                            ${module.module_title}
                        </td>
                        <td><small>${module.training_axes?.axis_name || '-'}</small></td>
                        <td>${path.target_completion_date ? formatDate(path.target_completion_date) : '-'}</td>
                        <td>
                            <span class="badge ${deadlineClass}">${diasText}</span>
                        </td>
                        <td>
                            ${module.priority ? `<span class="badge bg-info">${module.priority}</span>` : '-'}
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('results-content').innerHTML = tableHtml;
        }
        
        // ==========================================
        // CONSULTA 8: AVANZADA
        // ==========================================
        async function ejecutarConsultaAvanzada(params) {
            console.log('🔍 Ejecutando consulta avanzada...');
            
            let query = '/worker_training_paths?select=path_id,assignment_date,target_completion_date,actual_completion_date,completion_status,assignment_type,evaluation_score,workers(worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,organizational_areas(area_name)),training_modules(module_id,module_code,module_title,training_axes(axis_name),training_modalities(modality_name))&path_status=eq.active';
            
            // Aplicar filtros
            if (params.worker_id && params.worker_id.length > 0) {
                query += '&worker_id=in.(' + params.worker_id.join(',') + ')';
            }
            if (params.module_id && params.module_id.length > 0) {
                query += '&training_modules.module_id=in.(' + params.module_id.join(',') + ')';
            }
            if (params.axis_id && params.axis_id.length > 0) {
                query += '&training_modules.axis_id=in.(' + params.axis_id.join(',') + ')';
            }
            if (params.area_id && params.area_id.length > 0) {
                query += '&workers.organizational_area_id=in.(' + params.area_id.join(',') + ')';
            }
            if (params.status && params.status.length > 0) {
                query += '&completion_status=in.(' + params.status.join(',') + ')';
            }
            if (params.assignment_type) {
                query += '&assignment_type=eq.' + params.assignment_type;
            }
            if (params.date_from) {
                query += '&assignment_date=gte.' + params.date_from;
            }
            if (params.date_to) {
                query += '&assignment_date=lte.' + params.date_to;
            }
            
            query += '&order=assignment_date.desc';
            
            const data = await supabaseRequest(query);
            queryResults = data;
            
            renderResultadosAvanzada(data);
        }
        
        function renderResultadosAvanzada(data) {
            document.getElementById('results-title').innerHTML = '<i class="bi bi-sliders me-2"></i>Resultados de Consulta Avanzada';
            
            if (!data || data.length === 0) {
                document.getElementById('results-content').innerHTML = '<div class="alert alert-info">No se encontraron resultados con los filtros aplicados.</div>';
                return;
            }
            
            // KPIs
            const totalRutas = data.length;
            const trabajadoresUnicos = new Set(data.map(p => p.workers.worker_id)).size;
            const modulosUnicos = new Set(data.map(p => p.training_modules.module_id)).size;
            const completados = data.filter(p => p.completion_status === 'Completado').length;
            const porcentaje = totalRutas > 0 ? Math.round((completados / totalRutas) * 100) : 0;
            
            const kpisHtml = `
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value">${totalRutas}</div>
                        <div class="kpi-label">Total Rutas</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-primary">${trabajadoresUnicos}</div>
                        <div class="kpi-label">Trabajadores</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-success">${modulosUnicos}</div>
                        <div class="kpi-label">Módulos</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-value text-info">${porcentaje}%</div>
                        <div class="kpi-label">% Completación</div>
                    </div>
                </div>
            `;
            
            document.getElementById('kpis-section').innerHTML = kpisHtml;
            
            // Tabla detallada
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover query-table">
                        <thead>
                            <tr>
                                <th>Trabajador</th>
                                <th>Área</th>
                                <th>Módulo</th>
                                <th>Eje</th>
                                <th>Modalidad</th>
                                <th>Tipo</th>
                                <th>Fecha Asignación</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(path => {
                const worker = path.workers;
                const module = path.training_modules;
                const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1}`.trim();
                const statusClass = path.completion_status.toLowerCase().replace(' ', '-');
                
                tableHtml += `
                    <tr>
                        <td>${workerName}</td>
                        <td><small>${worker.organizational_areas?.area_name || '-'}</small></td>
                        <td>
                            ${module.module_code ? `<span class="badge bg-secondary">${module.module_code}</span> ` : ''}
                            <small>${module.module_title}</small>
                        </td>
                        <td><small>${module.training_axes?.axis_name || '-'}</small></td>
                        <td><small>${module.training_modalities?.modality_name || '-'}</small></td>
                        <td><span class="badge bg-info">${path.assignment_type}</span></td>
                        <td>${formatDate(path.assignment_date)}</td>
                        <td>
                            <span class="badge badge-${statusClass}">${path.completion_status}</span>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('results-content').innerHTML = tableHtml;
        }
        
        // ==========================================
        // NUEVA CONSULTA
        // ==========================================
        function nuevaConsulta() {
            // Limpiar resultados
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('query-type').value = '';
            cambiarTipoConsulta();
            
            // Destruir gráficos
            destruirGraficos();
            
            // Ocultar banner
            document.getElementById('url-loaded-banner').style.display = 'none';
            
            // Scroll al top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            queryResults = null;
            currentQueryType = null;
            currentQueryParams = null;
        }
        
        // ==========================================
        // EXPORTAR RESULTADOS
        // ==========================================
        async function exportarResultados() {
            if (!queryResults || !currentQueryType) {
                showMessage('No hay resultados para exportar. Ejecuta una consulta primero.', 'warning');
                return;
            }
            
            try {
                mostrarLoading();
                
                // Crear CSV simple
                let csv = '';
                let filename = `consulta_${currentQueryType}_${new Date().getTime()}.csv`;
                
                // Determinar estructura según tipo
                switch (currentQueryType) {
                    case 'por-trabajador':
                        csv = exportarCSVPorTrabajador(queryResults);
                        break;
                    case 'por-modulo':
                        csv = exportarCSVPorModulo(queryResults);
                        break;
                    case 'por-eje':
                        csv = exportarCSVPorEje(queryResults);
                        break;
                    case 'por-area':
                        csv = exportarCSVPorArea(queryResults);
                        break;
                    case 'por-fechas':
                        csv = exportarCSVPorFechas(queryResults);
                        break;
                    case 'por-facilitador':
                        csv = exportarCSVPorFacilitador(queryResults);
                        break;
                    case 'por-estado':
                        csv = exportarCSVPorEstado(queryResults);
                        break;
                    case 'avanzada':
                        csv = exportarCSVAvanzada(queryResults);
                        break;
                }
                
                // Descargar
                descargarCSV(csv, filename);
                
                ocultarLoading();
                showMessage('Resultados exportados exitosamente', 'success');
                
            } catch (error) {
                console.error('❌ Error exportando resultados:', error);
                showMessage('Error al exportar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        function exportarCSVPorTrabajador(data) {
            let csv = 'Módulo,Eje,Modalidad,Tipo Asignación,Fecha Asignación,Fecha Límite,Fecha Completado,Calificación,Estado\n';
            
            data.forEach(path => {
                const module = path.training_modules;
                csv += `"${module.module_code || ''} ${module.module_title}",`;
                csv += `"${module.training_axes?.axis_name || '-'}",`;
                csv += `"${module.training_modalities?.modality_name || '-'}",`;
                csv += `"${path.assignment_type}",`;
                csv += `"${formatDate(path.assignment_date)}",`;
                csv += `"${path.target_completion_date ? formatDate(path.target_completion_date) : '-'}",`;
                csv += `"${path.actual_completion_date ? formatDate(path.actual_completion_date) : '-'}",`;
                csv += `"${path.evaluation_score || '-'}",`;
                csv += `"${path.completion_status}"\n`;
            });
            
            return csv;
        }
        
        function exportarCSVPorModulo(data) {
            let csv = 'Trabajador,Área,Tipo Asignación,Fecha Asignación,Fecha Límite,Fecha Completado,Calificación,Estado\n';
            
            data.forEach(path => {
                const worker = path.workers;
                const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
                csv += `"${workerName}",`;
                csv += `"${worker.organizational_areas?.area_name || '-'}",`;
                csv += `"${path.assignment_type}",`;
                csv += `"${formatDate(path.assignment_date)}",`;
                csv += `"${path.target_completion_date ? formatDate(path.target_completion_date) : '-'}",`;
                csv += `"${path.actual_completion_date ? formatDate(path.actual_completion_date) : '-'}",`;
                csv += `"${path.evaluation_score || '-'}",`;
                csv += `"${path.completion_status}"\n`;
            });
            
            return csv;
        }
        
        function exportarCSVPorEje(data) {
            let csv = 'Trabajador,Módulo,Estado\n';
            
            data.forEach(path => {
                const worker = path.workers;
                const module = path.training_modules;
                const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1}`.trim();
                csv += `"${workerName}",`;
                csv += `"${module.module_code || ''} ${module.module_title}",`;
                csv += `"${path.completion_status}"\n`;
            });
            
            return csv;
        }
        
        function exportarCSVPorArea(data) {
            let csv = 'Trabajador,Total Asignados,Completados,Pendientes,% Completación\n';
            
            data.forEach(worker => {
                const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1}`.trim();
                const activePaths = worker.worker_training_paths.filter(p => p.path_status === 'active');
                const completados = activePaths.filter(p => p.completion_status === 'Completado').length;
                const pendientes = activePaths.length - completados;
                const porcentaje = activePaths.length > 0 ? Math.round((completados / activePaths.length) * 100) : 0;
                
                csv += `"${workerName}",`;
                csv += `${activePaths.length},`;
                csv += `${completados},`;
                csv += `${pendientes},`;
                csv += `${porcentaje}%\n`;
            });
            
            return csv;
        }
        
        function exportarCSVPorFechas(data) {
            let csv = 'Fecha,Trabajador,Módulo,Eje\n';
            
            data.forEach(path => {
                const worker = path.workers;
                const module = path.training_modules;
                const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1}`.trim();
                
                csv += `"${formatDate(path.actual_completion_date)}",`;
                csv += `"${workerName}",`;
                csv += `"${module.module_code || ''} ${module.module_title}",`;
                csv += `"${module.training_axes?.axis_name || '-'}"\n`;
            });
            
            return csv;
        }
        
        function exportarCSVPorFacilitador(data) {
            let csv = 'Módulo,Total Asignaciones,Completados,Estado\n';
            
            // Esta función necesitaría más contexto, simplificando
            data.forEach(path => {
                const module = path.training_modules;
                csv += `"${module.module_code || ''} ${module.module_title}",`;
                csv += `1,`;
                csv += `${path.completion_status === 'Completado' ? '1' : '0'},`;
                csv += `"${path.completion_status}"\n`;
            });
            
            return csv;
        }
        
        function exportarCSVPorEstado(data) {
            let csv = 'Trabajador,Área,Módulo,Eje,Fecha Límite,Días,Estado\n';
            
            data.forEach(path => {
                const worker = path.workers;
                const module = path.training_modules;
                const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1}`.trim();
                
                const diasText = path.diasRestantes === null ? 'Sin fecha' :
                                path.diasRestantes < 0 ? `Vencido ${Math.abs(path.diasRestantes)} días` :
                                `${path.diasRestantes} días`;
                
                csv += `"${workerName}",`;
                csv += `"${worker.organizational_areas?.area_name || '-'}",`;
                csv += `"${module.module_code || ''} ${module.module_title}",`;
                csv += `"${module.training_axes?.axis_name || '-'}",`;
                csv += `"${path.target_completion_date ? formatDate(path.target_completion_date) : '-'}",`;
                csv += `"${diasText}",`;
                csv += `"${path.completion_status}"\n`;
            });
            
            return csv;
        }
        
        function exportarCSVAvanzada(data) {
            let csv = 'Trabajador,Área,Módulo,Eje,Modalidad,Tipo,Fecha Asignación,Estado\n';
            
            data.forEach(path => {
                const worker = path.workers;
                const module = path.training_modules;
                const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1}`.trim();
                
                csv += `"${workerName}",`;
                csv += `"${worker.organizational_areas?.area_name || '-'}",`;
                csv += `"${module.module_code || ''} ${module.module_title}",`;
                csv += `"${module.training_axes?.axis_name || '-'}",`;
                csv += `"${module.training_modalities?.modality_name || '-'}",`;
                csv += `"${path.assignment_type}",`;
                csv += `"${formatDate(path.assignment_date)}",`;
                csv += `"${path.completion_status}"\n`;
            });
            
            return csv;
        }
        
        function descargarCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
      // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function destruirGraficos() {
            chartInstances.forEach(chart => {
                if (chart) {
                    try {
                        chart.destroy();
                    } catch (error) {
                        console.warn('Error destruyendo gráfico:', error);
                    }
                }
            });
            chartInstances = [];
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        // ==========================================
        // ACTUALIZAR BREADCRUMB DINÁMICO
        // ==========================================
        function actualizarBreadcrumb(contexto = null) {
            const breadcrumbContainer = document.getElementById('breadcrumb-container');
            
            let html = `
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Formación</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Consultas de Rutas
                </li>
            `;
            
            if (contexto) {
                html += `
                    <li class="breadcrumb-item active" aria-current="page">
                        ${contexto}
                    </li>
                `;
            }
            
            breadcrumbContainer.innerHTML = html;
        }
        
        // ==========================================
        // HELPERS DE VALIDACIÓN
        // ==========================================
        function validarParametrosRequeridos(params, requiredFields) {
            const missing = [];
            
            requiredFields.forEach(field => {
                if (!params[field] || (Array.isArray(params[field]) && params[field].length === 0)) {
                    missing.push(field);
                }
            });
            
            return {
                valid: missing.length === 0,
                missing: missing
            };
        }
        
        function obtenerNombreCompleto(firstName, lastName1, lastName2 = '') {
            return `${firstName} ${lastName1} ${lastName2}`.trim();
        }
        
        function calcularPorcentaje(completados, total) {
            if (total === 0) return 0;
            return Math.round((completados / total) * 100);
        }
        
        function obtenerColorPorcentaje(porcentaje) {
            if (porcentaje >= 75) return 'success';
            if (porcentaje >= 50) return 'info';
            if (porcentaje >= 25) return 'warning';
            return 'danger';
        }
        
        // ==========================================
        // ESCAPAR HTML PARA SEGURIDAD
        // ==========================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // HELPER PARA ESTADOS
        // ==========================================
        function obtenerEstadoBadgeClass(status) {
            const statusLower = status.toLowerCase().replace(' ', '-');
            return `badge-${statusLower}`;
        }
        
        // ==========================================
        // LOGGING DE CONSULTAS (OPCIONAL)
        // ==========================================
        function logConsulta(tipo, params, resultCount) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                queryType: tipo,
                params: params,
                resultCount: resultCount,
                user: getStoredSession()?.user?.user_mail
            };
            
            console.log('📊 Consulta ejecutada:', logEntry);
            
            // Aquí podrías enviar a un endpoint de analytics si lo deseas
            // await supabaseRequest('/query_logs', { method: 'POST', body: JSON.stringify(logEntry) });
        }
        
        // ==========================================
        // GENERAR RESUMEN EJECUTIVO
        // ==========================================
        function generarResumenEjecutivo(data, tipo) {
            const resumen = {
                totalRegistros: data.length,
                fecha: new Date().toLocaleString('es-CO'),
                tipo: tipo
            };
            
            switch (tipo) {
                case 'por-trabajador':
                    resumen.completados = data.filter(p => p.completion_status === 'Completado').length;
                    resumen.porcentaje = calcularPorcentaje(resumen.completados, resumen.totalRegistros);
                    break;
                    
                case 'por-modulo':
                    resumen.trabajadores = new Set(data.map(p => p.workers.worker_id)).size;
                    resumen.completados = data.filter(p => p.completion_status === 'Completado').length;
                    break;
                    
                case 'por-eje':
                    resumen.trabajadores = new Set(data.map(p => p.workers.worker_id)).size;
                    resumen.modulos = new Set(data.map(p => p.training_modules.module_id)).size;
                    break;
                    
                case 'por-area':
                    resumen.trabajadores = data.length;
                    break;
                    
                case 'por-fechas':
                    resumen.trabajadores = new Set(data.map(p => p.workers.worker_id)).size;
                    resumen.modulos = new Set(data.map(p => p.training_modules.module_id)).size;
                    break;
                    
                case 'por-estado':
                    resumen.urgentes = data.filter(p => p.alertLevel === 'urgent').length;
                    resumen.trabajadores = new Set(data.map(p => p.workers.worker_id)).size;
                    break;
            }
            
            return resumen;
        }
        
        // ==========================================
        // COMPARTIR CONSULTA (Generar URL)
        // ==========================================
        function compartirConsulta() {
            if (!currentQueryType || !currentQueryParams) {
                showMessage('Ejecuta una consulta primero para poder compartirla', 'warning');
                return;
            }
            
            // Construir URL con parámetros
            let url = window.location.origin + window.location.pathname;
            url += `?type=${currentQueryType}`;
            
            // Agregar parámetros
            Object.keys(currentQueryParams).forEach(key => {
                const value = currentQueryParams[key];
                if (value && value !== '' && (!Array.isArray(value) || value.length > 0)) {
                    if (Array.isArray(value)) {
                        value.forEach(v => {
                            url += `&${key}=${encodeURIComponent(v)}`;
                        });
                    } else if (typeof value === 'boolean') {
                        if (value) url += `&${key}=true`;
                    } else {
                        url += `&${key}=${encodeURIComponent(value)}`;
                    }
                }
            });
            
            // Copiar al portapapeles
            navigator.clipboard.writeText(url).then(() => {
                showMessage('Link de consulta copiado al portapapeles', 'success');
            }).catch(err => {
                console.error('Error copiando al portapapeles:', err);
                // Fallback: mostrar en alert
                prompt('Copia este enlace:', url);
            });
        }
        
        // ==========================================
        // IMPRIMIR RESULTADOS
        // ==========================================
        function imprimirResultados() {
            if (!queryResults) {
                showMessage('No hay resultados para imprimir', 'warning');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const resultsContent = document.getElementById('results-content').innerHTML;
            const kpisContent = document.getElementById('kpis-section').innerHTML;
            const title = document.getElementById('results-title').textContent;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { padding: 20px; }
                        @media print {
                            .no-print { display: none; }
                        }
                        .kpi-card { 
                            border: 1px solid #ddd; 
                            padding: 15px; 
                            margin-bottom: 10px; 
                            text-align: center; 
                        }
                        .kpi-value { font-size: 2rem; font-weight: bold; }
                        .kpi-label { font-size: 0.875rem; color: #666; }
                    </style>
                </head>
                <body>
                    <h2>${title}</h2>
                    <p><small>Fecha: ${new Date().toLocaleString('es-CO')}</small></p>
                    <hr>
                    <div class="row">${kpisContent}</div>
                    <hr>
                    ${resultsContent}
                    
                </body>
                </html>
            `);
            
            printWindow.document.close();
        }
        
        // ==========================================
        // BOTONES ADICIONALES DE ACCIONES
        // ==========================================
        function agregarBotonesAccion() {
            const actionButtons = document.querySelector('.action-buttons');
            if (!actionButtons || actionButtons.querySelector('#btn-share')) return;
            
            // Botón compartir
            const btnShare = document.createElement('button');
            btnShare.id = 'btn-share';
            btnShare.className = 'btn btn-action btn-outline-secondary';
            btnShare.innerHTML = '<i class="bi bi-share me-1"></i>Compartir';
            btnShare.onclick = compartirConsulta;
            
            // Botón imprimir
            const btnPrint = document.createElement('button');
            btnPrint.id = 'btn-print';
            btnPrint.className = 'btn btn-action btn-outline-secondary';
            btnPrint.innerHTML = '<i class="bi bi-printer me-1"></i>Imprimir';
            btnPrint.onclick = imprimirResultados;
            
            actionButtons.appendChild(btnShare);
            actionButtons.appendChild(btnPrint);
        }
        
        // Agregar botones cuando se muestren resultados
        const originalExecutar = ejecutarConsulta;
        ejecutarConsulta = async function() {
            await originalExecutar();
            setTimeout(agregarBotonesAccion, 200);
        };
        
        // ==========================================
        // ATAJOS DE TECLADO (OPCIONAL)
        // ==========================================
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter: Ejecutar consulta
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const btnExecute = document.getElementById('btn-execute');
                if (!btnExecute.disabled) {
                    ejecutarConsulta();
                }
            }
            
            // Ctrl/Cmd + N: Nueva consulta
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                nuevaConsulta();
            }
            
            // Ctrl/Cmd + E: Exportar
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                if (queryResults) {
                    exportarResultados();
                }
            }
        });
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.cambiarTipoConsulta = cambiarTipoConsulta;
        window.ejecutarConsulta = ejecutarConsulta;
        window.nuevaConsulta = nuevaConsulta;
        window.exportarResultados = exportarResultados;
        window.compartirConsulta = compartirConsulta;
        window.imprimirResultados = imprimirResultados;
        
        console.log('🎉 path-queries.html cargado correctamente');
        console.log('⌨️ Atajos de teclado:');
        console.log('  - Ctrl/Cmd + Enter: Ejecutar consulta');
        console.log('  - Ctrl/Cmd + N: Nueva consulta');
        console.log('  - Ctrl/Cmd + E: Exportar resultados');
    </script>
</body>
</html>
