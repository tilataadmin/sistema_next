<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Referencias de Unidades - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .reference-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background: white;
            transition: all 0.2s ease;
        }
        
        .reference-item:hover {
            background: #f8f9fa;
            border-color: #dee2e6;
        }
        
        .reference-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .reference-order {
            background: #667eea;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .reference-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .reference-icon.documento {
            color: #dc3545;
        }
        
        .reference-icon.video {
            color: #e83e8c;
        }
        
        .reference-icon.articulo {
            color: #fd7e14;
        }
        
        .reference-icon.curso {
            color: #20c997;
        }
        
        .reference-icon.otro {
            color: #6c757d;
        }
        
        .reference-content {
            flex: 1;
        }
        
        .reference-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
            margin-bottom: 6px;
        }
        
        .reference-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        
        .badge-type {
            background: #e9ecef;
            color: #495057;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .badge-mandatory {
            background: #dc3545;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .badge-optional {
            background: #6c757d;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .reference-url {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            word-break: break-all;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .reference-url:hover {
            text-decoration: underline;
        }
        
        .reference-description {
            margin-top: 8px;
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .reference-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        
        .btn-action {
            padding: 4px 10px;
            font-size: 0.85rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .section-title {
            font-weight: 600;
            color: #495057;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .badge-count {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #module-selector {
            max-width: 600px;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Formaci√≥n</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gestionar referencias de unidades
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-bookmarks me-2"></i>
                    Gestionar Referencias de Unidades Formativas
                </h1>
                <p class="text-muted">
                    Administra materiales de apoyo, recursos y referencias bibliogr√°ficas de cada unidad
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- SELECTOR DE UNIDAD FORMATIVA -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <label for="module-selector" class="form-label fw-semibold">
                            <i class="bi bi-mortarboard me-2"></i>
                            Selecciona una Unidad Formativa
                        </label>
                        <select class="form-select form-select-lg" id="module-selector">
                            <option value="">-- Selecciona una unidad formativa --</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div id="main-content" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <div class="section-header">
                        <h5 class="section-title">
                            <i class="bi bi-folder"></i>
                            Referencias y Materiales
                        </h5>
                        <div class="d-flex align-items-center gap-3">
                            <span class="badge-count" id="references-count">0</span>
                            <button class="btn btn-primary btn-sm" onclick="abrirModalAgregar()">
                                <i class="bi bi-plus-circle me-1"></i>Agregar Referencia
                            </button>
                        </div>
                    </div>
                    
                    <div id="references-container">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- MODAL PARA AGREGAR/EDITAR REFERENCIA -->
    <div class="modal fade" id="modal-reference" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title">
                        <i class="bi bi-plus-circle me-2"></i>Agregar Referencia
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="form-reference">
                    <div class="modal-body">
                        
                        <!-- T√≠tulo -->
                        <div class="mb-3">
                            <label for="reference-title" class="form-label">
                                T√≠tulo de la Referencia <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="reference-title" 
                                   name="reference_title"
                                   placeholder="Ej: Gu√≠a de Pr√°cticas Restaurativas"
                                   required>
                        </div>
                        
                        <!-- URL -->
                        <div class="mb-3">
                            <label for="reference-url" class="form-label">
                                URL del Recurso <span class="text-danger">*</span>
                            </label>
                            <input type="url" 
                                   class="form-control" 
                                   id="reference-url" 
                                   name="reference_url"
                                   placeholder="https://..."
                                   required>
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Incluye el enlace completo (https://...)
                            </small>
                        </div>
                        
                        <!-- Tipo -->
                        <div class="mb-3">
                            <label for="reference-type" class="form-label">
                                Tipo de Recurso <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" 
                                    id="reference-type" 
                                    name="reference_type"
                                    required>
                                <option value="">-- Selecciona el tipo --</option>
                                <option value="Documento">üìÑ Documento</option>
                                <option value="Video">üé• Video</option>
                                <option value="Art√≠culo">üì∞ Art√≠culo</option>
                                <option value="Curso externo">üéì Curso externo</option>
                                <option value="Otro">üìå Otro</option>
                            </select>
                        </div>
                        
                        <!-- Descripci√≥n -->
                        <div class="mb-3">
                            <label for="reference-description" class="form-label">
                                Descripci√≥n (opcional)
                            </label>
                            <textarea class="form-control" 
                                      id="reference-description" 
                                      name="reference_description"
                                      rows="3"
                                      placeholder="Breve descripci√≥n del contenido o utilidad de este recurso..."></textarea>
                        </div>
                        
                        <!-- Es Obligatorio -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="reference-mandatory"
                                       name="is_mandatory">
                                <label class="form-check-label" for="reference-mandatory">
                                    <strong>Recurso Obligatorio</strong>
                                    <br>
                                    <small class="text-muted">
                                        Marcar si el trabajador debe revisar este material obligatoriamente
                                    </small>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Campo oculto para ID (al editar) -->
                        <input type="hidden" id="reference-id" name="reference_id">
                        
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" id="btn-submit">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPTS - ORDEN CR√çTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let allModules = [];
        let currentModuleId = null;
        let references = [];
        let modalInstance = null;
        let editingReferenceId = null;
        
        // ==========================================
        // INICIALIZACI√ìN - PATR√ìN OBLIGATORIO
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // PASO 1: SIEMPRE validar permisos primero
                const hasAccess = await validatePageAccess('Gestionar referencias de unidades');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                
                // PASO 2: Inicializar p√°gina
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Inicializar modal
                modalInstance = new bootstrap.Modal(document.getElementById('modal-reference'));
                
                // Cargar datos iniciales
                await cargarModulos();
                
                // Configurar event listeners
                configurarEventos();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CONFIGURACI√ìN DE EVENTOS
        // ==========================================
        function configurarEventos() {
            // Event listener para selector de m√≥dulo
            document.getElementById('module-selector').addEventListener('change', async function(e) {
                const moduleId = e.target.value;
                
                if (moduleId) {
                    currentModuleId = moduleId;
                    await cargarReferencias(moduleId);
                } else {
                    currentModuleId = null;
                    document.getElementById('main-content').style.display = 'none';
                }
            });
            
            // Event listener para formulario
            document.getElementById('form-reference').addEventListener('submit', manejarSubmitFormulario);
            
            console.log('‚úÖ Event listeners configurados');
        }
        
        // ==========================================
        // CARGA DE DATOS INICIALES
        // ==========================================
        async function cargarModulos() {
            try {
                console.log('üì° Cargando m√≥dulos...');
                
                // Cargar m√≥dulos formativos activos
                const modulesData = await supabaseRequest('/training_modules?select=module_id,module_code,module_title&module_status=eq.active&order=module_code.asc');
                allModules = modulesData || [];
                
                // Renderizar dropdown de m√≥dulos
                renderizarSelectorModulos();
                
                console.log(`‚úÖ ${allModules.length} m√≥dulos cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando m√≥dulos:', error);
                showMessage('Error al cargar datos: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // RENDERIZAR SELECTOR DE M√ìDULOS
        // ==========================================
        function renderizarSelectorModulos() {
            const selector = document.getElementById('module-selector');
            
            if (allModules.length === 0) {
                selector.innerHTML = '<option value="">No hay unidades formativas disponibles</option>';
                return;
            }
            
            let optionsHtml = '<option value="">-- Selecciona una unidad formativa --</option>';
            
            allModules.forEach(module => {
                optionsHtml += `
                    <option value="${module.module_id}">
                        ${escapeHtml(module.module_code)} - ${escapeHtml(module.module_title)}
                    </option>
                `;
            });
            
            selector.innerHTML = optionsHtml;
        }
      // ==========================================
        // CARGAR REFERENCIAS DE UN M√ìDULO
        // ==========================================
        async function cargarReferencias(moduleId) {
            try {
                mostrarLoading();
                
                console.log(`üì° Cargando referencias para m√≥dulo: ${moduleId}`);
                
                // Cargar referencias del m√≥dulo ordenadas
                const referencesData = await supabaseRequest('/training_module_references?select=*&module_id=eq.' + moduleId + '&order=reference_order.asc');
                references = referencesData || [];
                
                // Renderizar referencias
                renderizarReferencias();
                
                // Mostrar contenido principal
                document.getElementById('main-content').style.display = 'block';
                
                ocultarLoading();
                console.log(`‚úÖ ${references.length} referencias cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando referencias:', error);
                showMessage('Error al cargar referencias: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // RENDERIZAR REFERENCIAS
        // ==========================================
        function renderizarReferencias() {
            const container = document.getElementById('references-container');
            const countBadge = document.getElementById('references-count');
            
            countBadge.textContent = references.length;
            
            if (references.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-folder2-open"></i>
                        <div>No hay referencias registradas para esta unidad</div>
                        <small class="text-muted">Haz clic en "Agregar Referencia" para comenzar</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            references.forEach((ref, index) => {
                const typeClass = ref.reference_type.toLowerCase().replace(' ', '-');
                const typeIcon = getTypeIcon(ref.reference_type);
                const mandatoryBadge = ref.is_mandatory 
                    ? '<span class="badge-mandatory"><i class="bi bi-exclamation-circle-fill me-1"></i>Obligatorio</span>'
                    : '<span class="badge-optional"><i class="bi bi-circle me-1"></i>Opcional</span>';
                
                // Determinar si puede subir/bajar
                const canMoveUp = index > 0;
                const canMoveDown = index < references.length - 1;
                
                html += `
                    <div class="reference-item">
                        <div class="reference-header">
                            <div class="reference-order">${ref.reference_order}</div>
                            <i class="bi ${typeIcon} reference-icon ${typeClass}"></i>
                            <div class="reference-content">
                                <div class="reference-title">
                                    ${escapeHtml(ref.reference_title)}
                                </div>
                                <div class="reference-meta">
                                    <span class="badge-type">${escapeHtml(ref.reference_type)}</span>
                                    ${mandatoryBadge}
                                </div>
                                <div>
                                    <a href="${escapeHtml(ref.reference_url)}" 
                                       class="reference-url" 
                                       target="_blank" 
                                       rel="noopener noreferrer">
                                        <i class="bi bi-link-45deg"></i>
                                        ${truncateUrl(ref.reference_url)}
                                    </a>
                                </div>
                                ${ref.reference_description ? `
                                    <div class="reference-description">
                                        ${escapeHtml(ref.reference_description)}
                                    </div>
                                ` : ''}
                                <div class="reference-actions">
                                    <button class="btn btn-sm btn-outline-primary btn-action" 
                                            onclick="abrirModalEditar('${ref.reference_id}')"
                                            title="Editar referencia">
                                        <i class="bi bi-pencil me-1"></i>Editar
                                    </button>
                                    ${canMoveUp ? `
                                        <button class="btn btn-sm btn-outline-secondary btn-action" 
                                                onclick="moverReferencia('${ref.reference_id}', 'up')"
                                                title="Mover arriba">
                                            <i class="bi bi-arrow-up"></i>
                                        </button>
                                    ` : ''}
                                    ${canMoveDown ? `
                                        <button class="btn btn-sm btn-outline-secondary btn-action" 
                                                onclick="moverReferencia('${ref.reference_id}', 'down')"
                                                title="Mover abajo">
                                            <i class="bi bi-arrow-down"></i>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-outline-danger btn-action" 
                                            onclick="eliminarReferencia('${ref.reference_id}')"
                                            title="Eliminar referencia">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // FUNCIONES AUXILIARES PARA RENDERIZADO
        // ==========================================
        function getTypeIcon(type) {
            const icons = {
                'Documento': 'bi-file-earmark-pdf',
                'Video': 'bi-play-btn',
                'Art√≠culo': 'bi-newspaper',
                'Curso externo': 'bi-mortarboard',
                'Otro': 'bi-link-45deg'
            };
            return icons[type] || 'bi-link-45deg';
        }
        
        function truncateUrl(url, maxLength = 60) {
            if (!url) return '';
            if (url.length <= maxLength) return url;
            return url.substring(0, maxLength) + '...';
        }
        
        // ==========================================
        // ABRIR MODAL PARA AGREGAR
        // ==========================================
        function abrirModalAgregar() {
            if (!currentModuleId) {
                showMessage('Por favor selecciona una unidad formativa primero', 'warning');
                return;
            }
            
            // Limpiar formulario
            document.getElementById('form-reference').reset();
            document.getElementById('reference-id').value = '';
            editingReferenceId = null;
            
            // Cambiar t√≠tulo del modal
            document.getElementById('modal-title').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Agregar Referencia';
            document.getElementById('btn-submit').innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar';
            
            // Mostrar modal
            modalInstance.show();
        }
        
        // ==========================================
        // ABRIR MODAL PARA EDITAR
        // ==========================================
        function abrirModalEditar(referenceId) {
            const reference = references.find(r => r.reference_id === referenceId);
            if (!reference) {
                showMessage('Referencia no encontrada', 'danger');
                return;
            }
            
            // Llenar formulario con datos existentes
            document.getElementById('reference-id').value = reference.reference_id;
            document.getElementById('reference-title').value = reference.reference_title;
            document.getElementById('reference-url').value = reference.reference_url;
            document.getElementById('reference-type').value = reference.reference_type;
            document.getElementById('reference-description').value = reference.reference_description || '';
            document.getElementById('reference-mandatory').checked = reference.is_mandatory;
            
            editingReferenceId = referenceId;
            
            // Cambiar t√≠tulo del modal
            document.getElementById('modal-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Referencia';
            document.getElementById('btn-submit').innerHTML = '<i class="bi bi-check-circle me-1"></i>Actualizar';
            
            // Mostrar modal
            modalInstance.show();
        }
        
        // ==========================================
        // MANEJAR SUBMIT DEL FORMULARIO
        // ==========================================
        async function manejarSubmitFormulario(e) {
            e.preventDefault();
            
            if (!currentModuleId) {
                showMessage('Error: No hay m√≥dulo seleccionado', 'danger');
                return;
            }
            
            try {
                mostrarLoading();
                
                const formData = new FormData(e.target);
                const data = {
                    module_id: currentModuleId,
                    reference_title: formData.get('reference_title'),
                    reference_url: formData.get('reference_url'),
                    reference_type: formData.get('reference_type'),
                    reference_description: formData.get('reference_description') || null,
                    is_mandatory: document.getElementById('reference-mandatory').checked
                };
                
                if (editingReferenceId) {
                    // EDITAR referencia existente
                    console.log(`‚úèÔ∏è Editando referencia: ${editingReferenceId}`);
                    
                    await supabaseRequest('/training_module_references?reference_id=eq.' + editingReferenceId, {
                        method: 'PATCH',
                        body: JSON.stringify(data)
                    });
                    
                    showMessage('Referencia actualizada exitosamente', 'success');
                    
                } else {
                    // CREAR nueva referencia
                    console.log('‚ûï Creando nueva referencia');
                    
                    // Obtener el pr√≥ximo orden
                    const maxOrder = references.length > 0 
                        ? Math.max(...references.map(r => r.reference_order)) 
                        : 0;
                    
                    data.reference_order = maxOrder + 1;
                    
                    // Obtener usuario actual para created_by
                    const session = getStoredSession();
                    if (session && session.user) {
                        data.created_by = session.user.user_id;
                    }
                    
                    await supabaseRequest('/training_module_references', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    
                    showMessage('Referencia agregada exitosamente', 'success');
                }
                
                // Cerrar modal y recargar
                modalInstance.hide();
                await cargarReferencias(currentModuleId);
                
            } catch (error) {
                console.error('‚ùå Error guardando referencia:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
      // ==========================================
        // MOVER REFERENCIA (ARRIBA/ABAJO)
        // ==========================================
        async function moverReferencia(referenceId, direction) {
            if (!currentModuleId) {
                showMessage('Error: No hay m√≥dulo seleccionado', 'danger');
                return;
            }
            
            try {
                mostrarLoading();
                
                console.log(`üîÑ Moviendo referencia ${referenceId} hacia ${direction}`);
                
                // Encontrar la referencia actual
                const currentIndex = references.findIndex(r => r.reference_id === referenceId);
                if (currentIndex === -1) {
                    throw new Error('Referencia no encontrada');
                }
                
                const currentRef = references[currentIndex];
                let targetRef = null;
                
                // Determinar la referencia con la que intercambiar posici√≥n
                if (direction === 'up' && currentIndex > 0) {
                    targetRef = references[currentIndex - 1];
                } else if (direction === 'down' && currentIndex < references.length - 1) {
                    targetRef = references[currentIndex + 1];
                }
                
                if (!targetRef) {
                    throw new Error('No se puede mover en esa direcci√≥n');
                }
                
                // Intercambiar los valores de reference_order
                const tempOrder = currentRef.reference_order;
                
                // Actualizar referencia actual
                await supabaseRequest('/training_module_references?reference_id=eq.' + currentRef.reference_id, {
                    method: 'PATCH',
                    body: JSON.stringify({ reference_order: targetRef.reference_order })
                });
                
                // Actualizar referencia objetivo
                await supabaseRequest('/training_module_references?reference_id=eq.' + targetRef.reference_id, {
                    method: 'PATCH',
                    body: JSON.stringify({ reference_order: tempOrder })
                });
                
                showMessage('Orden actualizado exitosamente', 'success');
                
                // Recargar referencias
                await cargarReferencias(currentModuleId);
                
            } catch (error) {
                console.error('‚ùå Error moviendo referencia:', error);
                showMessage('Error al mover referencia: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // ELIMINAR REFERENCIA
        // ==========================================
        async function eliminarReferencia(referenceId) {
            if (!currentModuleId) {
                showMessage('Error: No hay m√≥dulo seleccionado', 'danger');
                return;
            }
            
            // Obtener nombre de la referencia para confirmaci√≥n
            const reference = references.find(r => r.reference_id === referenceId);
            const referenceName = reference ? reference.reference_title : 'esta referencia';
            
            if (!confirm(`¬øEst√° seguro de eliminar la referencia "${referenceName}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                mostrarLoading();
                
                console.log(`üóëÔ∏è Eliminando referencia: ${referenceId}`);
                
                // Eliminar referencia de la base de datos
                await supabaseRequest('/training_module_references?reference_id=eq.' + referenceId, {
                    method: 'DELETE'
                });
                
                showMessage('Referencia eliminada exitosamente', 'success');
                
                // Recargar referencias
                await cargarReferencias(currentModuleId);
                
                // Reorganizar √≥rdenes si es necesario
                await reorganizarOrdenes();
                
            } catch (error) {
                console.error('‚ùå Error eliminando referencia:', error);
                showMessage('Error al eliminar referencia: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // REORGANIZAR √ìRDENES (OPCIONAL)
        // ==========================================
        async function reorganizarOrdenes() {
            // Esta funci√≥n reorganiza los n√∫meros de orden para que sean consecutivos (1, 2, 3...)
            // Es opcional pero mantiene la limpieza de los datos
            
            try {
                if (references.length === 0) return;
                
                console.log('üî¢ Reorganizando √≥rdenes...');
                
                // Cargar referencias actuales
                const currentRefs = await supabaseRequest('/training_module_references?select=reference_id,reference_order&module_id=eq.' + currentModuleId + '&order=reference_order.asc');
                
                // Actualizar cada referencia con su nuevo orden consecutivo
                for (let i = 0; i < currentRefs.length; i++) {
                    const newOrder = i + 1;
                    if (currentRefs[i].reference_order !== newOrder) {
                        await supabaseRequest('/training_module_references?reference_id=eq.' + currentRefs[i].reference_id, {
                            method: 'PATCH',
                            body: JSON.stringify({ reference_order: newOrder })
                        });
                    }
                }
                
                console.log('‚úÖ √ìrdenes reorganizados');
                
            } catch (error) {
                console.error('‚ö†Ô∏è Error reorganizando √≥rdenes:', error);
                // No lanzar error, es una operaci√≥n de limpieza opcional
            }
        }
      // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.abrirModalAgregar = abrirModalAgregar;
        window.abrirModalEditar = abrirModalEditar;
        window.moverReferencia = moverReferencia;
        window.eliminarReferencia = eliminarReferencia;
        
        console.log('üéâ module-references.html cargado correctamente');
    </script>
</body>
</html>
