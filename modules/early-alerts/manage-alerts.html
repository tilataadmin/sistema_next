<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti칩n de Alertas - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .alert-status-red { border-left: 4px solid #dc3545; }
        .alert-status-yellow { border-left: 4px solid #ffc107; }
        .alert-status-green { border-left: 4px solid #198754; }
        .alert-closed { opacity: 0.7; background-color: #f8f9fa; }
    </style>
</head>
<body>
    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">
                        Alertas Tempranas
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gesti칩n de Alertas
                </li>
            </ol>
        </nav>

        <!-- Encabezado de p치gina -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Gesti칩n de Alertas Tempranas
                </h1>
                <p class="text-muted">
                    Administra y da seguimiento a las alertas registradas
                </p>
            </div>
            <div class="col-auto">
                <a href="register-alerts.html" class="btn btn-danger">
                    <i class="bi bi-plus-circle me-1"></i>Nueva Alerta
                </a>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Filtros y estad칤sticas -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Filtros de B칰squeda</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="statusFilter" class="form-label">Estado</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">Todos los estados</option>
                                    <option value="red">游댮 Rojo</option>
                                    <option value="yellow">游리 Amarillo</option>
                                    <option value="green">游릭 Verde</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="closedFilter" class="form-label">Cierre</label>
                                <select class="form-select" id="closedFilter">
                                    <option value="">Todas</option>
                                    <option value="false" selected>Abiertas</option>
                                    <option value="true">Cerradas</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="causeFilter" class="form-label">Causa</label>
                                <select class="form-select" id="causeFilter">
                                    <option value="">Todas las causas</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="searchFilter" class="form-label">Buscar</label>
                                <input type="text" class="form-control" id="searchFilter" 
                                       placeholder="Familia, detalles...">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary me-2" onclick="applyFilters()">
                                <i class="bi bi-funnel me-1"></i>Aplicar Filtros
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-1"></i>Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Estad칤sticas</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="h4 text-danger mb-0" id="statsRed">-</div>
                                <small class="text-muted">Rojas</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 text-warning mb-0" id="statsYellow">-</div>
                                <small class="text-muted">Amarillas</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 text-success mb-0" id="statsGreen">-</div>
                                <small class="text-muted">Verdes</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de alertas -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list me-2"></i>
                    Alertas Registradas
                </h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="loadAlerts()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body p-0">
                <div id="alertsList">
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver detalles -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle me-2"></i>
                        Detalles de la Alerta
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalContent">
                    <!-- Contenido din치mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cambiar estado -->
    <div class="modal fade" id="statusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-arrow-repeat me-2"></i>
                        Cambiar Estado de Alerta
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="statusForm">
                        <input type="hidden" id="statusLogId">
                        <div class="mb-3">
                            <label for="newStatus" class="form-label">Nuevo Estado</label>
                            <select class="form-select" id="newStatus" required>
                                <option value="red">游댮 Rojo - Cr칤tico</option>
                                <option value="yellow">游리 Amarillo - Moderado</option>
                                <option value="green">游릭 Verde - Leve</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="statusReason" class="form-label">Motivo del cambio</label>
                            <textarea class="form-control" id="statusReason" rows="3" required
                                      placeholder="Explica por qu칠 cambias el estado de la alerta..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="updateAlertStatus()">
                        <i class="bi bi-save me-1"></i>Guardar Cambio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cerrar alerta -->
    <div class="modal fade" id="closeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle me-2"></i>
                        Cerrar Alerta
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="closeForm">
                        <input type="hidden" id="closeLogId">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Una vez cerrada, la alerta no aparecer치 en la vista de alertas abiertas.
                        </div>
                        <div class="mb-3">
                            <label for="closeReason" class="form-label">Motivo del cierre</label>
                            <textarea class="form-control" id="closeReason" rows="4" required
                                      placeholder="Describe c칩mo se resolvi칩 la situaci칩n..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="closeAlert()">
                        <i class="bi bi-check-circle me-1"></i>Cerrar Alerta
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Config.js -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // Variables globales
        let alerts = [];
        let causes = [];
        let detailsModal, statusModal, closeModal;

        // Inicializaci칩n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Gesti칩n de Alertas - Iniciando...');
            
            validatePageAccess('Gesti칩n de alertas tempranas').then(hasAccess => {
                if (hasAccess) {
                    initializePage();
                }
            });
        });

        async function initializePage() {
            try {
                // Inicializar modales
                detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
                statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
                closeModal = new bootstrap.Modal(document.getElementById('closeModal'));

                // Cargar datos iniciales
                await loadCauses();
                await loadAlerts();

                // Event listeners
                document.getElementById('searchFilter').addEventListener('input', debounce(applyFilters, 300));

                console.log('P치gina inicializada correctamente');
            } catch (error) {
                console.error('Error inicializando p치gina:', error);
                showMessage('Error inicializando la p치gina', 'danger');
            }
        }

        async function loadCauses() {
            try {
                const data = await supabaseRequest('/early_alert_causes?select=*&order=cause_name');
                causes = data || [];
                
                const select = document.getElementById('causeFilter');
                select.innerHTML = '<option value="">Todas las causas</option>';
                
                causes.forEach(cause => {
                    const option = document.createElement('option');
                    option.value = cause.cause_id;
                    option.textContent = cause.cause_name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando causas:', error);
            }
        }

        async function loadAlerts() {
            try {
                console.log('Cargando alertas...');
                
                const query = '/early_alert_logs?select=*,families(family_name),early_alert_causes(cause_name),workers(worker_first_name,worker_last_name_1,worker_last_name_2)&order=created_at.desc';
                const data = await supabaseRequest(query);
                alerts = data || [];
                
                updateStatistics();
                applyFilters();
                
                console.log(`${alerts.length} alertas cargadas`);
            } catch (error) {
                console.error('Error cargando alertas:', error);
                showMessage('Error cargando las alertas', 'danger');
                document.getElementById('alertsList').innerHTML = `
                    <div class="text-center p-4 text-muted">Error cargando datos</div>
                `;
            }
        }

        function updateStatistics() {
            const stats = {
                red: alerts.filter(a => a.alert_status === 'red' && !a.is_closed).length,
                yellow: alerts.filter(a => a.alert_status === 'yellow' && !a.is_closed).length,
                green: alerts.filter(a => a.alert_status === 'green' && !a.is_closed).length
            };

            document.getElementById('statsRed').textContent = stats.red;
            document.getElementById('statsYellow').textContent = stats.yellow;
            document.getElementById('statsGreen').textContent = stats.green;
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const closedFilter = document.getElementById('closedFilter').value;
            const causeFilter = document.getElementById('causeFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            let filteredAlerts = alerts.filter(alert => {
                // Filtro por estado
                if (statusFilter && alert.alert_status !== statusFilter) return false;
                
                // Filtro por cierre
                if (closedFilter !== '') {
                    const isClosed = closedFilter === 'true';
                    if (alert.is_closed !== isClosed) return false;
                }
                
                // Filtro por causa
                if (causeFilter && alert.cause_id !== causeFilter) return false;
                
                // Filtro de b칰squeda
                if (searchFilter) {
                    const searchText = `
                        ${alert.family_code} 
                        ${alert.families?.family_name || ''} 
                        ${alert.log_details || ''}
                        ${alert.early_alert_causes?.cause_name || ''}
                    `.toLowerCase();
                    
                    if (!searchText.includes(searchFilter)) return false;
                }
                
                return true;
            });

            renderAlerts(filteredAlerts);
        }

        function renderAlerts(alertsToRender) {
            const container = document.getElementById('alertsList');
            
            if (alertsToRender.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-4 text-muted">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <div class="mt-2">No se encontraron alertas</div>
                    </div>
                `;
                return;
            }

            const html = alertsToRender.map(alert => {
                const statusColors = {
                    'red': 'danger',
                    'yellow': 'warning', 
                    'green': 'success'
                };

                const statusIcons = {
                    'red': '游댮',
                    'yellow': '游리',
                    'green': '游릭'
                };

                const workerName = alert.workers ? 
                    `${alert.workers.worker_first_name} ${alert.workers.worker_last_name_1} ${alert.workers.worker_last_name_2 || ''}`.trim() : 
                    'Sin asignar';

                return `
                    <div class="card mb-3 alert-status-${alert.alert_status} ${alert.is_closed ? 'alert-closed' : ''}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-${statusColors[alert.alert_status]} me-2">
                                            ${statusIcons[alert.alert_status]} ${alert.alert_status.toUpperCase()}
                                        </span>
                                        ${alert.is_closed ? '<span class="badge bg-secondary">CERRADA</span>' : ''}
                                    </div>
                                    <h6 class="mb-1">
                                        Familia ${alert.family_code} - ${alert.families?.family_name || 'Sin nombre'}
                                    </h6>
                                    <div class="text-muted small mb-2">
                                        <strong>Causa:</strong> ${alert.early_alert_causes?.cause_name || 'Sin causa'} |
                                        <strong>Reportado por:</strong> ${workerName} |
                                        <strong>Fecha:</strong> ${formatDate(alert.created_at)}
                                    </div>
                                    <p class="mb-0 text-truncate" style="max-width: 500px;">
                                        ${alert.log_details || 'Sin detalles'}
                                    </p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewDetails('${alert.log_id}')" title="Ver detalles">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        ${!alert.is_closed ? `
                                            <button class="btn btn-sm btn-outline-warning" onclick="changeStatus('${alert.log_id}')" title="Cambiar estado">
                                                <i class="bi bi-arrow-repeat"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="createTask('${alert.log_id}')" title="Crear tarea">
                                                <i class="bi bi-plus-square"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-success" onclick="confirmCloseAlert('${alert.log_id}')" title="Cerrar alerta">
                                                <i class="bi bi-check-circle"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function viewDetails(logId) {
            const alert = alerts.find(a => a.log_id === logId);
            if (!alert) return;

            const workerName = alert.workers ? 
                `${alert.workers.worker_first_name} ${alert.workers.worker_last_name_1} ${alert.workers.worker_last_name_2 || ''}`.trim() : 
                'Sin asignar';

            const statusIcons = {
                'red': '游댮 Rojo - Cr칤tico',
                'yellow': '游리 Amarillo - Moderado',
                'green': '游릭 Verde - Leve'
            };

            const modalContent = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informaci칩n General</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Familia:</strong></td><td>${alert.family_code} - ${alert.families?.family_name || 'Sin nombre'}</td></tr>
                            <tr><td><strong>Causa:</strong></td><td>${alert.early_alert_causes?.cause_name || 'Sin causa'}</td></tr>
                            <tr><td><strong>Estado:</strong></td><td>${statusIcons[alert.alert_status]}</td></tr>
                            <tr><td><strong>Reportado por:</strong></td><td>${workerName}</td></tr>
                            <tr><td><strong>Fecha de registro:</strong></td><td>${formatDate(alert.created_at)}</td></tr>
                            <tr><td><strong>Estado:</strong></td><td>${alert.is_closed ? 'Cerrada' : 'Abierta'}</td></tr>
                            ${alert.is_closed ? `<tr><td><strong>Fecha de cierre:</strong></td><td>${formatDate(alert.closed_at)}</td></tr>` : ''}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Detalles</h6>
                        <div class="border p-3 rounded">
                            ${alert.log_details || 'Sin detalles'}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            detailsModal.show();
        }

        function changeStatus(logId) {
            const alert = alerts.find(a => a.log_id === logId);
            if (!alert) return;

            document.getElementById('statusLogId').value = logId;
            document.getElementById('newStatus').value = alert.alert_status;
            document.getElementById('statusReason').value = '';

            statusModal.show();
        }

        async function updateAlertStatus() {
            try {
                const logId = document.getElementById('statusLogId').value;
                const newStatus = document.getElementById('newStatus').value;
                const reason = document.getElementById('statusReason').value.trim();

                if (!reason) {
                    showMessage('Debes proporcionar un motivo para el cambio', 'warning');
                    return;
                }

                const updateData = {
                    alert_status: newStatus,
                    updated_at: new Date().toISOString()
                };

                await supabaseRequest(`/early_alert_logs?log_id=eq.${logId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });

                showMessage('Estado de la alerta actualizado exitosamente', 'success');
                statusModal.hide();
                await loadAlerts();

            } catch (error) {
                console.error('Error actualizando estado:', error);
                showMessage('Error actualizando el estado de la alerta', 'danger');
            }
        }

        function confirmCloseAlert(logId) {
            document.getElementById('closeLogId').value = logId;
            document.getElementById('closeReason').value = '';
            closeModal.show();
        }

        async function closeAlert() {
            try {
                const logId = document.getElementById('closeLogId').value;
                const reason = document.getElementById('closeReason').value.trim();

                if (!reason) {
                    showMessage('Debes proporcionar un motivo para el cierre', 'warning');
                    return;
                }

                const updateData = {
                    is_closed: true,
                    closed_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                await supabaseRequest(`/early_alert_logs?log_id=eq.${logId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });

                showMessage('Alerta cerrada exitosamente', 'success');
                closeModal.hide();
                await loadAlerts();

            } catch (error) {
                console.error('Error cerrando alerta:', error);
                showMessage('Error cerrando la alerta', 'danger');
            }
        }

        function createTask(logId) {
            // Redirigir a la p치gina de tareas con el log_id como par치metro
            window.open(`assigned-actions.html?create_task=true&log_id=${logId}`, '_blank');
        }

        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('closedFilter').value = 'false';
            document.getElementById('causeFilter').value = '';
            document.getElementById('searchFilter').value = '';
            applyFilters();
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
