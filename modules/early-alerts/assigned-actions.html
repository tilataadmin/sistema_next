<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestiones Asignadas - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .task-priority-high { border-left: 4px solid #dc3545; }
        .task-priority-normal { border-left: 4px solid #0d6efd; }
        .task-priority-low { border-left: 4px solid #6c757d; }
        .task-completed { opacity: 0.7; background-color: #f8f9fa; }
        .task-overdue { background-color: #fff5f5; border-color: #dc3545; }
    </style>
</head>
<body>
    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">
                        Alertas Tempranas
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gestiones Asignadas
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-person-check me-2"></i>
                    Gestiones Asignadas
                </h1>
                <p class="text-muted">
                    Atiende las gestiones y tareas asignadas a tu usuario
                </p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" onclick="showCreateTaskModal()">
                    <i class="bi bi-plus-circle me-1"></i>Nueva Tarea
                </button>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Resumen de tareas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-danger">
                    <div class="card-body text-center">
                        <div class="h2 text-danger mb-0" id="statsOverdue">-</div>
                        <small class="text-muted">Vencidas</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <div class="h2 text-warning mb-0" id="statsToday">-</div>
                        <small class="text-muted">Vencen Hoy</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <div class="h2 text-primary mb-0" id="statsPending">-</div>
                        <small class="text-muted">Pendientes</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <div class="h2 text-success mb-0" id="statsCompleted">-</div>
                        <small class="text-muted">Completadas</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">Filtros</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="moduleFilter" class="form-label">Módulo</label>
                        <select class="form-select" id="moduleFilter">
                            <option value="">Todos los módulos</option>
                            <option value="early-alerts">Alertas Tempranas</option>
                            <option value="follow-ups">Seguimientos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">Estado</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">Todos los estados</option>
                            <option value="Pendiente" selected>Pendientes</option>
                            <option value="En Progreso">En Progreso</option>
                            <option value="Completada">Completadas</option>
                            <option value="Cancelada">Canceladas</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="taskAssignedTo" class="form-label">Asignar a *</label>
                        <select class="form-select" id="taskAssignedTo" required>
                            <option value="">Selecciona un trabajador...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="priorityFilter" class="form-label">Prioridad</label>
                        <select class="form-select" id="priorityFilter">
                            <option value="">Todas las prioridades</option>
                            <option value="high">Alta</option>
                            <option value="normal">Normal</option>
                            <option value="low">Baja</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="searchFilter" class="form-label">Buscar</label>
                        <input type="text" class="form-control" id="searchFilter" 
                               placeholder="Descripción de tarea...">
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary me-2" onclick="applyFilters()">
                        <i class="bi bi-funnel me-1"></i>Aplicar Filtros
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearFilters()">
                        <i class="bi bi-x-circle me-1"></i>Limpiar
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de tareas -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-task me-2"></i>
                    Mis Tareas
                </h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="loadTasks()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body p-0">
                <div id="tasksList">
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear/editar tarea -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalTitle">
                        <i class="bi bi-plus-circle me-2"></i>
                        Nueva Tarea
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <input type="hidden" id="taskId">
                        <input type="hidden" id="taskReferenceId">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="taskModule" class="form-label">Módulo *</label>
                                <select class="form-select" id="taskModule" required>
                                    <option value="early-alerts">Alertas Tempranas</option>
                                    <option value="follow-ups">Seguimientos</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="taskPriority" class="form-label">Prioridad *</label>
                                <select class="form-select" id="taskPriority" required>
                                    <option value="normal" selected>Normal</option>
                                    <option value="high">Alta</option>
                                    <option value="low">Baja</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="taskDueDate" class="form-label">Fecha límite</label>
                                <input type="date" class="form-control" id="taskDueDate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="taskState" class="form-label">Estado *</label>
                                <select class="form-select" id="taskState" required>
                                    <option value="Pendiente" selected>Pendiente</option>
                                    <option value="En Progreso">En Progreso</option>
                                    <option value="Completada">Completada</option>
                                    <option value="Cancelada">Cancelada</option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="taskAssignedTo" class="form-label">Asignar a *</label>
                                <select class="form-select" id="taskAssignedTo" required>
                                    <option value="">Selecciona un trabajador...</option>
                                </select>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="taskDescription" class="form-label">Descripción de la tarea *</label>
                                <textarea class="form-control" id="taskDescription" rows="3" required
                                          placeholder="Describe la tarea a realizar..."></textarea>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="taskProgress" class="form-label">Progreso/Notas</label>
                                <textarea class="form-control" id="taskProgress" rows="3"
                                          placeholder="Describe el progreso o agrega notas..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">
                        <i class="bi bi-save me-1"></i><span id="saveButtonText">Crear Tarea</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Config.js -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // Variables globales
        let tasks = [];
        let currentUser = null;
        let taskModal;
        let workers = [];

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Gestiones Asignadas - Iniciando...');
            
            validatePageAccess('Atender gestiones asignadas').then(hasAccess => {
                if (hasAccess) {
                    initializePage();
                }
            });
        });

        async function initializePage() {
            try {
                // Obtener usuario actual
                const session = getStoredSession();
                currentUser = session?.user;
        
                if (!currentUser) {
                    showMessage('Error: No se pudo obtener información del usuario', 'danger');
                    return;
                }
        
                // Inicializar modal
                taskModal = new bootstrap.Modal(document.getElementById('taskModal'));

                await loadWorkers();
                
                // Verificar si se debe crear una tarea desde alerta
                checkCreateTaskFromAlert();
        
                // Cargar tareas
                await loadTasks();
        
                // Event listeners
                document.getElementById('searchFilter').addEventListener('input', debounce(applyFilters, 300));
        
                console.log('Página inicializada correctamente');
            } catch (error) {
                console.error('Error inicializando página:', error);
                showMessage('Error inicializando la página', 'danger');
            }
        }

        async function loadWorkers() {
            try {
                const data = await supabaseRequest('/workers?select=worker_id,email,worker_first_name,worker_last_name_1,worker_last_name_2&worker_status=eq.active&order=worker_first_name');
                workers = data || [];
                console.log(`${workers.length} trabajadores cargados para uso posterior`);
            } catch (error) {
                console.error('Error cargando trabajadores:', error);
            }
        }

        
        function checkCreateTaskFromAlert() {
            const urlParams = new URLSearchParams(window.location.search);
            const createTask = urlParams.get('create_task');
            const logId = urlParams.get('log_id');

            if (createTask === 'true' && logId) {
                // Pre-llenar formulario para crear tarea desde alerta
                setTimeout(() => {
                    showCreateTaskModal();
                    document.getElementById('taskModule').value = 'early-alerts';
                    document.getElementById('taskReferenceId').value = logId;
                    document.getElementById('taskDescription').placeholder = 'Tarea derivada de alerta temprana...';
                }, 500);
            }
        }

        async function loadTasks() {
            try {
                console.log('Cargando tareas del usuario...');
                
                // Cargar tareas asignadas al usuario actual
                const query = `/tasks?select=*&assigned_to_mail=eq.${currentUser.user_mail}&order=created_at.desc`;
                const data = await supabaseRequest(query);
                tasks = data || [];
                
                updateTaskStatistics();
                applyFilters();
                
                console.log(`${tasks.length} tareas cargadas`);
            } catch (error) {
                console.error('Error cargando tareas:', error);
                showMessage('Error cargando las tareas', 'danger');
                document.getElementById('tasksList').innerHTML = `
                    <div class="text-center p-4 text-muted">Error cargando datos</div>
                `;
            }
        }

        function updateTaskStatistics() {
            const today = new Date().toISOString().split('T')[0];
            
            const stats = {
                overdue: tasks.filter(t => t.due_date && t.due_date < today && t.task_state !== 'Completada' && t.task_state !== 'Cancelada').length,
                today: tasks.filter(t => t.due_date === today && t.task_state !== 'Completada' && t.task_state !== 'Cancelada').length,
                pending: tasks.filter(t => t.task_state === 'Pendiente' || t.task_state === 'En Progreso').length,
                completed: tasks.filter(t => t.task_state === 'Completada').length
            };

            document.getElementById('statsOverdue').textContent = stats.overdue;
            document.getElementById('statsToday').textContent = stats.today;
            document.getElementById('statsPending').textContent = stats.pending;
            document.getElementById('statsCompleted').textContent = stats.completed;
        }

        function applyFilters() {
            const moduleFilter = document.getElementById('moduleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            let filteredTasks = tasks.filter(task => {
                // Filtro por módulo
                if (moduleFilter && task.module_type !== moduleFilter) return false;
                
                // Filtro por estado
                if (statusFilter && task.task_state !== statusFilter) return false;
                
                // Filtro por prioridad
                if (priorityFilter && task.task_priority !== priorityFilter) return false;
                
                // Filtro de búsqueda
                if (searchFilter) {
                    const searchText = `
                        ${task.task_description || ''} 
                        ${task.task_progress || ''}
                    `.toLowerCase();
                    
                    if (!searchText.includes(searchFilter)) return false;
                }
                
                return true;
            });

            renderTasks(filteredTasks);
        }

        function renderTasks(tasksToRender) {
            const container = document.getElementById('tasksList');
            const today = new Date().toISOString().split('T')[0];
            
            if (tasksToRender.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-4 text-muted">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <div class="mt-2">No se encontraron tareas</div>
                    </div>
                `;
                return;
            }

            const html = tasksToRender.map(task => {
                const priorityColors = {
                    'high': 'danger',
                    'normal': 'primary',
                    'low': 'secondary'
                };

                const statusColors = {
                    'Pendiente': 'warning',
                    'En Progreso': 'info',
                    'Completada': 'success',
                    'Cancelada': 'secondary'
                };

                const isOverdue = task.due_date && task.due_date < today && task.task_state !== 'Completada' && task.task_state !== 'Cancelada';
                const isCompleted = task.task_state === 'Completada';

                return `
                    <div class="card mb-3 task-priority-${task.task_priority || 'normal'} ${isCompleted ? 'task-completed' : ''} ${isOverdue ? 'task-overdue' : ''}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-${priorityColors[task.task_priority || 'normal']} me-2">
                                            ${(task.task_priority || 'normal').toUpperCase()}
                                        </span>
                                        <span class="badge bg-${statusColors[task.task_state || 'Pendiente']} me-2">
                                            ${task.task_state || 'Pendiente'}
                                        </span>
                                        <span class="badge bg-secondary">
                                            ${task.module_type === 'early-alerts' ? 'Alertas' : 'Seguimientos'}
                                        </span>
                                        ${isOverdue ? '<span class="badge bg-danger ms-2">VENCIDA</span>' : ''}
                                    </div>
                                    <h6 class="mb-1">
                                        ${escapeHtml(task.task_description || 'Sin descripción')}
                                    </h6>
                                    <div class="text-muted small mb-2">
                                        <strong>Creada:</strong> ${formatDate(task.created_at)} |
                                        <strong>Vencimiento:</strong> ${task.due_date ? formatDate(task.due_date) : 'Sin fecha límite'}
                                    </div>
                                    ${task.task_progress ? `
                                        <div class="small">
                                            <strong>Progreso:</strong> ${escapeHtml(task.task_progress).substring(0, 100)}${task.task_progress.length > 100 ? '...' : ''}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editTask(${task.task_id})" title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        ${task.task_state !== 'Completada' ? `
                                            <button class="btn btn-sm btn-outline-success" onclick="markAsCompleted(${task.task_id})" title="Marcar como completada">
                                                <i class="bi bi-check-circle"></i>
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteTask(${task.task_id})" title="Eliminar">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function showCreateTaskModal() {
            document.getElementById('taskModalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nueva Tarea';
            document.getElementById('saveButtonText').textContent = 'Crear Tarea';
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = '';
            document.getElementById('taskModule').value = 'early-alerts';
            document.getElementById('taskPriority').value = 'normal';
            document.getElementById('taskState').value = 'Pendiente';
            
            // Poblar el select ANTES de mostrar el modal
            const select = document.getElementById('taskAssignedTo');
            if (select && workers && workers.length > 0) {
                let html = '<option value="">Selecciona un trabajador...</option>';
                workers.forEach(worker => {
                    const name = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
                    const display = worker.email === currentUser.user_mail ? `${name} (Yo)` : name;
                    html += `<option value="${worker.email}">${display}</option>`;
                });
                select.innerHTML = html;
            }
            
            taskModal.show();
        }


        
        function populateWorkersSelect() {
            const select = document.getElementById('taskAssignedTo');
            if (!select || !workers) return;
            
            let optionsHTML = '<option value="">Selecciona un trabajador...</option>';
            
            workers.forEach(worker => {
                const workerName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
                const displayName = worker.email === currentUser.user_mail ? `${workerName} (Yo)` : workerName;
                optionsHTML += `<option value="${worker.email}">${displayName}</option>`;
            });
            
            select.innerHTML = optionsHTML;
            console.log(`Select poblado con ${workers.length} opciones`);
        }
        
        function editTask(taskId) {
            const task = tasks.find(t => t.task_id === taskId);
            if (!task) return;
        
            document.getElementById('taskModalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Tarea';
            document.getElementById('saveButtonText').textContent = 'Guardar Cambios';
            
            // Cargar trabajadores antes de llenar el formulario
            loadWorkers();
            
            // Llenar formulario después de un pequeño delay para que se carguen los trabajadores
            setTimeout(() => {
                document.getElementById('taskId').value = task.task_id;
                document.getElementById('taskModule').value = task.module_type || 'early-alerts';
                document.getElementById('taskPriority').value = task.task_priority || 'normal';
                document.getElementById('taskDueDate').value = task.due_date || '';
                document.getElementById('taskState').value = task.task_state || 'Pendiente';
                document.getElementById('taskDescription').value = task.task_description || '';
                document.getElementById('taskProgress').value = task.task_progress || '';
                document.getElementById('taskReferenceId').value = task.reference_id || '';
                document.getElementById('taskAssignedTo').value = task.assigned_to_mail || '';
            }, 100);
        
            taskModal.show();
        }
        
        async function saveTask() {
            try {
                const taskId = document.getElementById('taskId').value;
                const isEdit = !!taskId;
        
                const taskData = {
                    module_type: document.getElementById('taskModule').value,
                    reference_id: document.getElementById('taskReferenceId').value || null,
                    reference_type: document.getElementById('taskModule').value === 'early-alerts' ? 'alert_log' : 'student',
                    assigned_to_mail: document.getElementById('taskAssignedTo').value,
                    due_date: document.getElementById('taskDueDate').value || null,
                    task_description: document.getElementById('taskDescription').value.trim(),
                    task_progress: document.getElementById('taskProgress').value.trim(),
                    task_state: document.getElementById('taskState').value,
                    task_priority: document.getElementById('taskPriority').value,
                    updated_at: new Date().toISOString()
                };
        
                if (!taskData.assigned_to_mail) {
                    showMessage('Debes seleccionar un trabajador', 'warning');
                    return;
                }
        
                if (!taskData.task_description) {
                    showMessage('La descripción de la tarea es requerida', 'warning');
                    return;
                }
        
                console.log(isEdit ? 'Actualizando tarea:' : 'Creando nueva tarea:', taskData);
        
                if (isEdit) {
                    await supabaseRequest(`/tasks?task_id=eq.${taskId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(taskData)
                    });
                    showMessage('Tarea actualizada exitosamente', 'success');
                } else {
                    await supabaseRequest('/tasks', {
                        method: 'POST',
                        body: JSON.stringify(taskData)
                    });
                    showMessage('Tarea creada exitosamente', 'success');
                }
        
                taskModal.hide();
                await loadTasks();
        
            } catch (error) {
                console.error('Error guardando tarea:', error);
                showMessage('Error guardando la tarea', 'danger');
            }
        }



        
        async function markAsCompleted(taskId) {
            try {
                const updateData = {
                    task_state: 'Completada',
                    close_date: new Date().toISOString().split('T')[0],
                    updated_at: new Date().toISOString()
                };

                await supabaseRequest(`/tasks?task_id=eq.${taskId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });

                showMessage('Tarea marcada como completada', 'success');
                await loadTasks();

            } catch (error) {
                console.error('Error completando tarea:', error);
                showMessage('Error completando la tarea', 'danger');
            }
        }

        function confirmDeleteTask(taskId) {
            const task = tasks.find(t => t.task_id === taskId);
            if (!task) return;

            if (confirm(`¿Estás seguro de eliminar esta tarea?\n\n"${task.task_description}"\n\nEsta acción no se puede deshacer.`)) {
                deleteTask(taskId);
            }
        }

        async function deleteTask(taskId) {
            try {
                await supabaseRequest(`/tasks?task_id=eq.${taskId}`, {
                    method: 'DELETE'
                });

                showMessage('Tarea eliminada exitosamente', 'success');
                await loadTasks();

            } catch (error) {
                console.error('Error eliminando tarea:', error);
                showMessage('Error eliminando la tarea', 'danger');
            }
        }

        function clearFilters() {
            document.getElementById('moduleFilter').value = '';
            document.getElementById('statusFilter').value = 'Pendiente';
            document.getElementById('priorityFilter').value = '';
            document.getElementById('searchFilter').value = '';
            applyFilters();
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
