<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atender gestiones asignadas - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <!-- Loading overlay -->
    <div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex justify-content-center align-items-center" style="z-index: 9999; display: none !important;">
        <div class="text-center text-white">
            <div class="spinner-border mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p>Cargando información...</p>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">
                        Seguimientos
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Atender gestiones asignadas
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-person-check me-2"></i>
                    Atender gestiones asignadas
                </h1>
                <p class="text-muted">
                    Gestiona las tareas que te han sido asignadas en alertas tempranas
                </p>
            </div>
        </div>

        <!-- Mensajes del sistema -->
        <div id="mensaje-sistema" class="d-none"></div>

        <!-- Estadísticas rápidas -->
        <div id="estadisticas-container" class="d-none">
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h4 class="card-title mb-0" id="total-tareas">0</h4>
                            <p class="card-text mb-0">Tareas Asignadas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning text-dark">
                        <div class="card-body text-center">
                            <h4 class="card-title mb-0" id="tareas-proceso">0</h4>
                            <p class="card-text mb-0">En Proceso</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h4 class="card-title mb-0" id="tareas-pendientes">0</h4>
                            <p class="card-text mb-0">Pendientes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de tareas -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-task me-2"></i>Mis tareas asignadas
                </h5>
            </div>
            <div class="card-body">
                <!-- Mensaje cuando no hay tareas -->
                <div id="no-tareas-message" class="text-center py-5 d-none">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h3 class="mt-3">No hay tareas asignadas</h3>
                    <p class="text-muted">Actualmente no tienes tareas pendientes o en proceso.</p>
                </div>

                <!-- Tabla de tareas -->
                <div class="table-responsive d-none" id="tabla-container">
                    <table class="table table-striped table-hover" id="tareas-table">
                        <thead class="table-primary">
                            <tr>
                                <th style="width: 15%;">Familia</th>
                                <th style="width: 30%;">Alerta asociada</th>
                                <th style="width: 12%;">Fecha de la tarea</th>
                                <th style="width: 30%;">Tarea</th>
                                <th style="width: 13%;" class="text-center">Registrar avances</th>
                            </tr>
                        </thead>
                        <tbody id="tareas-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para registrar avances -->
    <div class="modal fade" id="modal-avances" tabindex="-1" aria-labelledby="modalAvancesLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAvancesLabel">Registro de avances</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="form-avances">
                        <input type="hidden" id="tarea-id" value="">
                        
                        <div class="mb-3">
                            <label for="progreso-editor" class="form-label">
                                Progreso de la tarea: <span class="text-danger">*</span>
                            </label>
                            
                            <!-- Toolbar básico -->
                            <div class="editor-toolbar">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('bold')" title="Negrita">
                                    <i class="bi bi-type-bold"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('italic')" title="Cursiva">
                                    <i class="bi bi-type-italic"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('underline')" title="Subrayado">
                                    <i class="bi bi-type-underline"></i>
                                </button>
                                <span class="toolbar-separator">|</span>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('insertUnorderedList')" title="Lista con viñetas">
                                    <i class="bi bi-list-ul"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('insertOrderedList')" title="Lista numerada">
                                    <i class="bi bi-list-ol"></i>
                                </button>
                                <span class="toolbar-separator">|</span>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limpiarFormato()" title="Limpiar formato">
                                    <i class="bi bi-eraser"></i>
                                </button>
                            </div>
                            
                            <!-- Editor de texto enriquecido -->
                            <div 
                                id="progreso-editor" 
                                contenteditable="true" 
                                class="editor-content"
                                data-placeholder="Describe el progreso de la tarea..."
                                onblur="validarProgreso()">
                            </div>
                            
                            <div id="progreso-error" class="text-danger small mt-1" style="display: none;">
                                Este campo es obligatorio
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarAvances()">
                        <i class="bi bi-check-circle me-1"></i>Guardar Avances
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Loading overlay */
        #loading-overlay.show {
            display: flex !important;
        }

        /* Editor de texto enriquecido */
        .editor-toolbar {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-bottom: none;
            border-radius: 0.375rem 0.375rem 0 0;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .toolbar-separator {
            color: #6c757d;
            margin: 0 0.5rem;
            user-select: none;
        }

        .editor-content {
            min-height: 120px;
            max-height: 300px;
            overflow-y: auto;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 0 0 0.375rem 0.375rem;
            background-color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.875rem;
            line-height: 1.6;
            outline: none;
            transition: border-color 0.15s ease-in-out;
        }

        .editor-content:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.125rem rgba(13, 110, 253, 0.25);
        }

        .editor-content:empty:before {
            content: attr(data-placeholder);
            color: #6c757d;
            font-style: italic;
        }

        .editor-content ul, .editor-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .editor-content li {
            margin: 4px 0;
        }

        /* Contenido HTML en celdas */
        .contenido-html {
            max-height: 150px;
            overflow-y: auto;
            padding: 0.25rem;
            font-size: 0.875rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .contenido-html ul, .contenido-html ol {
            margin: 5px 0;
            padding-left: 15px;
        }

        .contenido-html li {
            margin: 2px 0;
        }

        .contenido-html p {
            margin: 5px 0;
        }

        /* Estado de tareas */
        .estado-tarea {
            font-weight: 600;
            color: #0d6efd;
        }

        .badge {
            font-size: 0.75rem;
        }

        /* Optimización para tablas */
        #tareas-table {
            table-layout: fixed;
        }

        #tareas-table td {
            word-wrap: break-word;
            vertical-align: top;
        }

        /* Indicadores de carga en botones */
        .btn.loading {
            position: relative;
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1rem;
            height: 1rem;
            margin-top: -0.5rem;
            margin-left: -0.5rem;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .editor-toolbar {
                gap: 0.125rem;
            }
            
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }

            .contenido-html {
                max-height: 100px;
                font-size: 0.8125rem;
            }
        }
    </style>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Config.js -->
    <script src="../../assets/js/config.js"></script>
    
    <!-- JavaScript específico de la página -->
    <script>
        // Variables globales
        let cacheGlobal = {};
        let tareasData = [];
        let usuarioActual = null;
        const TIMEOUT_OPERACIONES = 15000;

        // Inicialización al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            inicializarFormulario();
        });

        /**
         * Validación de permisos de página
         */
        async function validarAcceso() {
            try {
                const tieneAcceso = await validatePageAccess('Atender gestiones asignadas');
                if (!tieneAcceso) {
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Error validando acceso:', error);
                mostrarMensaje('Error de permisos: ' + error.message, 'error');
                return false;
            }
        }

        /**
         * Función principal de inicialización
         */
        async function inicializarFormulario() {
            try {
                mostrarLoading();
                console.log('🔄 Inicializando gestiones asignadas - Timestamp:', new Date().toISOString());
                
                // Validar permisos primero
                const tieneAcceso = await validarAcceso();
                if (!tieneAcceso) {
                    ocultarLoading();
                    return;
                }

                // Obtener información del usuario actual
                await obtenerUsuarioActual();

                // Cargar tareas del usuario
                await cargarTareasAsignadas();

                ocultarLoading();
                mostrarMensaje('Sistema cargado correctamente', 'success');

            } catch (error) {
                ocultarLoading();
                console.error('Error inicializando:', error);
                mostrarMensaje('Error al cargar el sistema: ' + error.message, 'error');
            }
        }

        /**
         * Obtener información del usuario actual
         */
        async function obtenerUsuarioActual() {
            try {
                const session = getStoredSession();
                if (!session || !session.user) {
                    throw new Error('No hay sesión activa');
                }

                // Obtener información del trabajador usando el email de la sesión
                const trabajadorQuery = `/workers?select=worker_id,email,worker_first_name,worker_last_name_1&email=eq.${session.user.user_mail}&worker_status=eq.active`;
                const trabajadores = await supabaseRequest(trabajadorQuery);

                if (!trabajadores || trabajadores.length === 0) {
                    throw new Error('No se encontró información del trabajador');
                }

                usuarioActual = trabajadores[0];
                cacheGlobal.usuario = usuarioActual;

            } catch (error) {
                console.error('Error obteniendo usuario actual:', error);
                throw new Error('Error al obtener información del usuario: ' + error.message);
            }
        }

        /**
         * Cargar tareas asignadas al usuario actual
         */
        async function cargarTareasAsignadas() {
            try {
                if (!usuarioActual || !usuarioActual.email) {
                    throw new Error('No se ha cargado la información del usuario');
                }

                // Consulta para obtener todas las tareas asignadas al usuario actual
                const tareasQuery = `/tasks?select=task_id,task_description,due_date,task_state,task_progress,reference_id,students(student_id,student_first_name,families(family_name))&assigned_to_mail=eq.${usuarioActual.email}&module_type=eq.follow-ups&reference_type=eq.early_alert&task_state=neq.Cerrada&order=created_at.desc`;
                
                const tareas = await supabaseRequest(tareasQuery);

                // Cargar detalles de alertas para cada tarea
                const tareasConDetalles = await cargarDetallesAlertas(tareas);

                tareasData = tareasConDetalles;
                renderizarTareas(tareasConDetalles);
                mostrarEstadisticas(tareasConDetalles);

            } catch (error) {
                console.error('Error cargando tareas:', error);
                mostrarMensaje('Error al cargar las tareas: ' + error.message, 'error');
            }
        }

        /**
         * Cargar detalles de alertas para las tareas
         */
        async function cargarDetallesAlertas(tareas) {
            try {
                const tareasConDetalles = [];

                for (const tarea of tareas) {
                    // Obtener detalles de la alerta temprana asociada
                    const alertaQuery = `/early_alert_logs?select=log_details,families(family_name)&log_id=eq.${tarea.reference_id}`;
                    const alertas = await supabaseRequest(alertaQuery);

                    const detalleAlerta = alertas.length > 0 ? alertas[0] : null;

                    tareasConDetalles.push({
                        ...tarea,
                        alerta_detalles: detalleAlerta?.log_details || 'Sin detalles de alerta',
                        familia_nombre: detalleAlerta?.families?.family_name || 
                                       tarea.students?.families?.family_name || 
                                       'Familia no identificada'
                    });
                }

                return tareasConDetalles;
            } catch (error) {
                console.error('Error cargando detalles de alertas:', error);
                return tareas.map(tarea => ({
                    ...tarea,
                    alerta_detalles: 'Error al cargar detalles',
                    familia_nombre: tarea.students?.families?.family_name || 'Familia no identificada'
                }));
            }
        }

        /**
         * Renderizar tabla de tareas
         */
        function renderizarTareas(tareas) {
            const tbody = document.getElementById('tareas-tbody');
            const tablaContainer = document.getElementById('tabla-container');
            const noTareasMessage = document.getElementById('no-tareas-message');

            // Limpiar tabla
            tbody.innerHTML = '';

            if (!tareas || tareas.length === 0) {
                tablaContainer.classList.add('d-none');
                noTareasMessage.classList.remove('d-none');
                return;
            }

            noTareasMessage.classList.add('d-none');
            tablaContainer.classList.remove('d-none');

            // Crear filas de tareas
            tareas.forEach(tarea => {
                const fila = crearFilaTarea(tarea);
                tbody.appendChild(fila);
            });
        }

        /**
         * Crear fila de tarea
         */
        function crearFilaTarea(tarea) {
            const tr = document.createElement('tr');
            tr.setAttribute('data-task-id', tarea.task_id);

            const fechaFormateada = formatearFecha(tarea.due_date);
            const estadoBadge = obtenerBadgeEstado(tarea.task_state);

            tr.innerHTML = `
                <td>
                    <strong>${escapeHtml(tarea.familia_nombre)}</strong>
                </td>
                <td>
                    <div class="contenido-html">
                        ${tarea.alerta_detalles || 'Sin detalles'}
                    </div>
                </td>
                <td>
                    <div class="estado-tarea">${fechaFormateada}</div>
                    <div class="mt-1">${estadoBadge}</div>
                </td>
                <td>
                    <div class="contenido-html">
                        ${tarea.task_description || 'Sin descripción'}
                    </div>
                </td>
                <td class="text-center">
                    <button class="btn btn-primary btn-sm" onclick="abrirModalAvances(${tarea.task_id}, '${escapeHtml(tarea.familia_nombre)}', '${escapeHtml(tarea.task_progress || '')}')">
                        <i class="bi bi-pencil-square me-1"></i>Avances
                    </button>
                </td>
            `;

            return tr;
        }

        /**
         * Mostrar estadísticas de tareas
         */
        function mostrarEstadisticas(tareas) {
            const estadisticasContainer = document.getElementById('estadisticas-container');

            if (!tareas || tareas.length === 0) {
                estadisticasContainer.classList.add('d-none');
                return;
            }

            const totalTareas = tareas.length;
            const tareasEnProceso = tareas.filter(t => t.task_state === 'En progreso').length;
            const tareasPendientes = tareas.filter(t => t.task_state === 'Asignada').length;

            document.getElementById('total-tareas').textContent = totalTareas;
            document.getElementById('tareas-proceso').textContent = tareasEnProceso;
            document.getElementById('tareas-pendientes').textContent = tareasPendientes;

            estadisticasContainer.classList.remove('d-none');
        }

        /**
         * Abrir modal para registrar avances
         */
        function abrirModalAvances(taskId, familyName, progresoActual) {
            // Configurar datos del modal
            document.getElementById('tarea-id').value = taskId;
            document.getElementById('modalAvancesLabel').textContent = `Registro de avances - ${familyName}`;

            // Cargar progreso actual si existe
            const editor = document.getElementById('progreso-editor');
            if (progresoActual && progresoActual.trim() !== '' && progresoActual !== 'null') {
                editor.innerHTML = progresoActual;
            } else {
                editor.innerHTML = '';
            }

            // Limpiar errores
            ocultarErrorProgreso();

            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modal-avances'));
            modal.show();

            // Enfocar el editor después de que se muestre el modal
            setTimeout(() => {
                editor.focus();
            }, 200);
        }

        /**
         * Guardar avances de la tarea
         */
        async function guardarAvances() {
            const editor = document.getElementById('progreso-editor');
            const taskId = parseInt(document.getElementById('tarea-id').value);
            const progreso = editor.innerHTML.trim();

            // Validar que el campo no esté vacío
            if (!progreso || progreso === '' || progreso === '<br>' || progreso === '<div><br></div>') {
                mostrarErrorProgreso();
                return;
            }

            const botonGuardar = document.querySelector('#modal-avances .btn-primary');
            botonGuardar.classList.add('loading');
            botonGuardar.disabled = true;

            try {
                // Actualizar progreso en la base de datos
                const updateData = {
                    task_progress: progreso,
                    task_state: 'En progreso'
                };

                await supabaseRequest(`/tasks?task_id=eq.${taskId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });

                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modal-avances'));
                modal.hide();

                // Recargar las tareas para mostrar el progreso actualizado
                await cargarTareasAsignadas();

                mostrarMensaje('Avances guardados exitosamente', 'success');

            } catch (error) {
                console.error('Error guardando avances:', error);
                mostrarMensaje('Error al guardar los avances: ' + error.message, 'error');
            }

            botonGuardar.classList.remove('loading');
            botonGuardar.disabled = false;
        }

        /**
         * Validar progreso
         */
        function validarProgreso() {
            const editor = document.getElementById('progreso-editor');
            const progreso = editor.innerHTML.trim();

            if (!progreso || progreso === '' || progreso === '<br>' || progreso === '<div><br></div>') {
                mostrarErrorProgreso();
                return false;
            } else {
                ocultarErrorProgreso();
                return true;
            }
        }

        /**
         * Mostrar error de progreso
         */
        function mostrarErrorProgreso() {
            const editor = document.getElementById('progreso-editor');
            const errorDiv = document.getElementById('progreso-error');

            editor.style.borderColor = '#dc3545';
            errorDiv.style.display = 'block';
            editor.focus();
        }

        /**
         * Ocultar error de progreso
         */
        function ocultarErrorProgreso() {
            const editor = document.getElementById('progreso-editor');
            const errorDiv = document.getElementById('progreso-error');

            editor.style.borderColor = '';
            errorDiv.style.display = 'none';
        }

        /**
         * Aplicar formato al texto seleccionado
         */
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('progreso-editor').focus();
        }

        /**
         * Limpiar formato del texto seleccionado
         */
        function limpiarFormato() {
            document.execCommand('removeFormat', false, null);
            document.getElementById('progreso-editor').focus();
        }

        /**
         * Funciones auxiliares
         */
        function formatearFecha(fecha) {
            if (!fecha) return '-';
            try {
                const fechaObj = new Date(fecha + 'T00:00:00');
                return fechaObj.toLocaleDateString('es-CO', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    timeZone: 'America/Bogota'
                });
            } catch (error) {
                return fecha;
            }
        }

        function obtenerBadgeEstado(estado) {
            const badges = {
                'Asignada': 'bg-info',
                'En progreso': 'bg-warning text-dark',
                'Cerrada': 'bg-success',
                'Pendiente': 'bg-secondary'
            };

            const badgeClass = badges[estado] || 'bg-secondary';
            return `<span class="badge ${badgeClass}">${estado || 'Pendiente'}</span>`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.add('show');
        }

        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.remove('show');
        }

        function mostrarMensaje(mensaje, tipo = 'info') {
            const div = document.getElementById('mensaje-sistema');
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            };

            div.className = `alert ${alertClass[tipo]} alert-dismissible fade show`;
            div.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            div.classList.remove('d-none');

            setTimeout(() => {
                div.classList.add('d-none');
            }, 5000);
        }

        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modal-avances'));
                if (modal) {
                    modal.hide();
                }
            }
        });
    </script>
</body>
</html>
