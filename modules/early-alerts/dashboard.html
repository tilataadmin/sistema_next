<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Control de Alertas Tempranas - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Variables CSS para alertas tempranas */
        :root {
            --alert-red: #dc3545;
            --alert-yellow: #ffc107;
            --alert-green: #198754;
            --alert-blue: #0d6efd;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--alert-red);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Métricas principales */
        .metric-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            height: 100%;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0;
            font-weight: 500;
        }
        
        .metric-icon {
            font-size: 2rem;
            opacity: 0.8;
        }
        
        /* Gráficos */
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Tabla de top causas */
        .top-causas-table {
            font-size: 0.875rem;
        }
        
        .causa-bar {
            height: 20px;
            border-radius: 10px;
            background: linear-gradient(90deg, var(--alert-red), #ff6b7a);
            transition: all 0.3s ease;
        }
        
        .causa-bar:hover {
            transform: scaleY(1.1);
        }
        
        /* Estados de alerta */
        .estado-red { color: var(--alert-red); }
        .estado-yellow { color: var(--alert-yellow); }
        .estado-green { color: var(--alert-green); }
        
        .bg-red { background-color: var(--alert-red); }
        .bg-yellow { background-color: var(--alert-yellow); }
        .bg-green { background-color: var(--alert-green); }
        
        /* Alertas recientes */
        .alert-item {
            border-left: 4px solid;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0 8px 8px 0;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }
        
        .alert-item:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }
        
        .alert-item.red { border-left-color: var(--alert-red); }
        .alert-item.yellow { border-left-color: var(--alert-yellow); }
        .alert-item.green { border-left-color: var(--alert-green); }
        
        .alert-fecha {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .alert-familia {
            font-weight: 600;
            color: #0d6efd;
            font-size: 0.875rem;
        }
        
        .alert-causa {
            font-size: 0.75rem;
            color: #495057;
        }
        
        /* Filtros */
        .filtros-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .filtros-card .form-select,
        .filtros-card .form-control {
            background: rgba(255,255,255,0.9);
            border: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .metric-value {
                font-size: 2rem;
            }
            
            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando tablero...</p>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Alertas Tempranas</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Tablero de Control
                </li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Tablero de Control - Alertas Tempranas
                </h1>
                <p class="text-muted">
                    Vista ejecutiva y análisis del sistema de alertas tempranas
                </p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Filtros -->
        <div class="card filtros-card mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="filtro-periodo" class="form-label fw-bold">Período:</label>
                        <select id="filtro-periodo" class="form-select">
                            <option value="30">Últimos 30 días</option>
                            <option value="60">Últimos 60 días</option>
                            <option value="90">Últimos 90 días</option>
                            <option value="180">Últimos 6 meses</option>
                            <option value="365">Último año</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filtro-seccion" class="form-label fw-bold">Sección:</label>
                        <select id="filtro-seccion" class="form-select">
                            <option value="todas">Todas las secciones</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filtro-estado" class="form-label fw-bold">Estado:</label>
                        <select id="filtro-estado" class="form-select">
                            <option value="todos">Todos los estados</option>
                            <option value="red">Rojas</option>
                            <option value="yellow">Amarillas</option>
                            <option value="green">Verdes</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-light w-100" onclick="aplicarFiltros()">
                            <i class="bi bi-funnel me-1"></i>Aplicar Filtros
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Métricas principales -->
        <div class="row mb-4">
            <div class="col-6 col-lg-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="metric-value text-danger" id="total-alertas">
                                <span class="text-muted">--</span>
                            </div>
                            <i class="bi bi-exclamation-triangle-fill metric-icon text-danger"></i>
                        </div>
                        <p class="metric-label">Total de Alertas</p>
                    </div>
                </div>
            </div>
            
            <div class="col-6 col-lg-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="metric-value text-danger" id="alertas-rojas">
                                <span class="text-muted">--</span>
                            </div>
                            <i class="bi bi-circle-fill metric-icon text-danger"></i>
                        </div>
                        <p class="metric-label">Alertas Rojas</p>
                    </div>
                </div>
            </div>
            
            <div class="col-6 col-lg-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="metric-value text-warning" id="alertas-amarillas">
                                <span class="text-muted">--</span>
                            </div>
                            <i class="bi bi-circle-fill metric-icon text-warning"></i>
                        </div>
                        <p class="metric-label">Alertas Amarillas</p>
                    </div>
                </div>
            </div>
            
            <div class="col-6 col-lg-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="metric-value text-primary" id="familias-afectadas">
                                <span class="text-muted">--</span>
                            </div>
                            <i class="bi bi-people-fill metric-icon text-primary"></i>
                        </div>
                        <p class="metric-label">Familias Afectadas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos y análisis -->
        <div class="row mb-4">
            <!-- Gráfico de tendencias -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up me-2"></i>Tendencia de Alertas por Estado
                        </h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="actualizarGraficoTendencia()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chart-tendencias"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Top causas -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ol me-2"></i>Principales Causas
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm top-causas-table mb-0">
                                <tbody id="top-causas-body">
                                    <tr>
                                        <td colspan="3" class="text-center py-4 text-muted">
                                            <div class="spinner-border spinner-border-sm me-2"></div>
                                            Cargando causas...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Distribución por sección y alertas recientes -->
        <div class="row mb-4">
            <!-- Distribución por sección -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-pie-chart me-2"></i>Distribución por Sección
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chart-secciones"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Alertas recientes -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history me-2"></i>Alertas Recientes
                        </h5>
                        <small class="text-muted">Últimas 10 alertas</small>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="alertas-recientes">
                            <div class="text-center py-4 text-muted">
                                <div class="spinner-border spinner-border-sm me-2"></div>
                                Cargando alertas recientes...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas adicionales -->
        <div class="row">
            <!-- Resumen por trabajador -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-person-badge me-2"></i>Alertas por Trabajador
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Trabajador</th>
                                        <th class="text-center">Total</th>
                                        <th class="text-center">Rojas</th>
                                        <th class="text-center">Amarillas</th>
                                        <th class="text-center">Verdes</th>
                                    </tr>
                                </thead>
                                <tbody id="trabajadores-stats">
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-muted">
                                            <div class="spinner-border spinner-border-sm me-2"></div>
                                            Cargando estadísticas...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Evolución de estados -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-arrow-up-right-circle me-2"></i>Evolución de Estados
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chart-evolucion"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let userRoles = [];
        let userSectionId = null;
        let chartsInstances = {};
        let cacheData = {};
        let filtrosActuales = {
            periodo: 30,
            seccion: 'todas',
            estado: 'todos'
        };

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando tablero de control de alertas tempranas...');
            
            try {
                mostrarLoading();

                // Validar permisos
                const tieneAcceso = await validatePageAccess('Tablero de control de alertas tempranas');
                if (!tieneAcceso) {
                    ocultarLoading();
                    return;
                }

                // Cargar datos del usuario
                await cargarDatosUsuario();

                // Cargar datos iniciales
                await Promise.all([
                    cargarSecciones(),
                    inicializarCharts()
                ]);

                // Cargar datos del dashboard
                await cargarDatosDashboard();

                ocultarLoading();
                showMessage('Tablero cargado correctamente', 'success');

            } catch (error) {
                ocultarLoading();
                console.error('❌ Error inicializando tablero:', error);
                showMessage('Error al cargar el tablero: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGAR DATOS DEL USUARIO
        // ==========================================
        async function cargarDatosUsuario() {
            try {
                const session = getStoredSession();
                if (!session || !session.user) {
                    throw new Error('No hay sesión activa');
                }

                currentUser = session.user;
                userRoles = await obtenerRolesUsuario(currentUser.user_id);

                // Si es directivo docente, obtener su sección
                if (userRoles.includes('Directivo docente')) {
                    userSectionId = await obtenerSeccionDirectivo(currentUser.user_mail);
                    console.log('📍 Directivo docente - Section ID:', userSectionId);
                }

                console.log('✅ Datos de usuario cargados');
                console.log('🔑 Roles:', userRoles);

            } catch (error) {
                console.error('❌ Error cargando datos de usuario:', error);
                throw error;
            }
        }

        // ==========================================
        // OBTENER ROLES DEL USUARIO
        // ==========================================
        async function obtenerRolesUsuario(userId) {
            try {
                const data = await supabaseRequest(`/user_roles?select=roles(role_name)&user_id=eq.${userId}`);
                return data.map(ur => ur.roles.role_name);
            } catch (error) {
                console.error('❌ Error obteniendo roles:', error);
                return [];
            }
        }

        // ==========================================
        // OBTENER SECCIÓN DEL DIRECTIVO
        // ==========================================
        async function obtenerSeccionDirectivo(email) {
            try {
                const data = await supabaseRequest(`/sections?select=section_id&director_email=eq.${email}&limit=1`);
                return data.length > 0 ? data[0].section_id : null;
            } catch (error) {
                console.error('❌ Error obteniendo sección del directivo:', error);
                return null;
            }
        }

        // ==========================================
        // CARGAR SECCIONES PARA FILTRO
        // ==========================================
        async function cargarSecciones() {
            try {
                if (cacheData.secciones) {
                    renderizarSelectSecciones(cacheData.secciones);
                    return;
                }

                const secciones = await supabaseRequest('/sections?select=section_id,section_name&section_status=eq.active&order=section_name');
                
                // Filtrar sección administrativa
                const seccionesFiltradas = secciones.filter(seccion => seccion.section_name !== 'Administrativo');
                
                cacheData.secciones = seccionesFiltradas;
                renderizarSelectSecciones(seccionesFiltradas);

            } catch (error) {
                console.error('❌ Error cargando secciones:', error);
                showMessage('Error al cargar secciones: ' + error.message, 'warning');
            }
        }

        // ==========================================
        // RENDERIZAR SELECT DE SECCIONES
        // ==========================================
        function renderizarSelectSecciones(secciones) {
            const select = document.getElementById('filtro-seccion');
            
            // Limpiar opciones existentes (excepto "Todas")
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            secciones.forEach(seccion => {
                const option = document.createElement('option');
                option.value = seccion.section_id;
                option.textContent = seccion.section_name;
                select.appendChild(option);
            });

            // Si es directivo docente, pre-seleccionar su sección
            if (userSectionId && userRoles.includes('Directivo docente')) {
                select.value = userSectionId;
                filtrosActuales.seccion = userSectionId;
            }
        }

        // ==========================================
        // INICIALIZAR GRÁFICOS
        // ==========================================
        async function inicializarCharts() {
            try {
                // Gráfico de tendencias
                const ctxTendencias = document.getElementById('chart-tendencias').getContext('2d');
                chartsInstances.tendencias = new Chart(ctxTendencias, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Rojas',
                            data: [],
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Amarillas',
                            data: [],
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Verdes',
                            data: [],
                            borderColor: '#198754',
                            backgroundColor: 'rgba(25, 135, 84, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });

                // Gráfico de distribución por sección
                const ctxSecciones = document.getElementById('chart-secciones').getContext('2d');
                chartsInstances.secciones = new Chart(ctxSecciones, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#dc3545',
                                '#ffc107',
                                '#198754',
                                '#0d6efd',
                                '#6f42c1',
                                '#fd7e14',
                                '#20c997'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // Gráfico de evolución de estados
                const ctxEvolucion = document.getElementById('chart-evolucion').getContext('2d');
                chartsInstances.evolucion = new Chart(ctxEvolucion, {
                    type: 'bar',
                    data: {
                        labels: ['Rojas', 'Amarillas', 'Verdes'],
                        datasets: [{
                            label: 'Abiertas',
                            data: [],
                            backgroundColor: ['#dc3545', '#ffc107', '#198754']
                        }, {
                            label: 'Cerradas',
                            data: [],
                            backgroundColor: ['#dc354580', '#ffc10780', '#19875480']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });

                console.log('✅ Gráficos inicializados');

            } catch (error) {
                console.error('❌ Error inicializando gráficos:', error);
                throw error;
            }
        }

        // ==========================================
        // CARGAR DATOS DEL DASHBOARD - CORREGIDO
        // ==========================================
        async function cargarDatosDashboard() {
            try {
                console.log('📊 Cargando datos del dashboard...');
        
                // Cargar métricas principales y datos en paralelo
                await Promise.all([
                    cargarMetricasPrincipales(),
                    cargarTopCausas(),
                    cargarAlertasRecientes(),
                    cargarEstadisticasTrabajadores(),
                    actualizarGraficoTendencia(),
                    actualizarGraficoSecciones(),
                    actualizarGraficoEvolucion()
                ]);
        
                console.log('✅ Datos del dashboard cargados con datos reales');
        
            } catch (error) {
                console.error('❌ Error cargando datos del dashboard:', error);
                throw error;
            }
        }



        
      // ==========================================
        // CARGAR MÉTRICAS PRINCIPALES
        // ==========================================
        async function cargarMetricasPrincipales() {
            try {
                const fechaLimite = new Date();
                fechaLimite.setDate(fechaLimite.getDate() - filtrosActuales.periodo);
                const fechaLimiteStr = fechaLimite.toISOString();

                let query = `/early_alert_logs?select=log_id,family_code,alert_status,is_closed&created_at=gte.${fechaLimiteStr}`;
                
                // Aplicar filtro de estado si no es "todos"
                if (filtrosActuales.estado !== 'todos') {
                    query += `&alert_status=eq.${filtrosActuales.estado}`;
                }

                const alertas = await supabaseRequest(query);
                let alertasFiltradas = alertas;

                // Filtrar por sección si es necesario
                if (filtrosActuales.seccion !== 'todas') {
                    alertasFiltradas = await filtrarAlertasPorSeccion(alertas, filtrosActuales.seccion);
                }

                // Calcular métricas
                const totalAlertas = alertasFiltradas.length;
                const alertasRojas = alertasFiltradas.filter(a => a.alert_status === 'red').length;
                const alertasAmarillas = alertasFiltradas.filter(a => a.alert_status === 'yellow').length;
                const familiasUnicas = new Set(alertasFiltradas.map(a => a.family_code)).size;

                // Actualizar UI
                document.getElementById('total-alertas').textContent = totalAlertas;
                document.getElementById('alertas-rojas').textContent = alertasRojas;
                document.getElementById('alertas-amarillas').textContent = alertasAmarillas;
                document.getElementById('familias-afectadas').textContent = familiasUnicas;

            } catch (error) {
                console.error('Error cargando métricas principales:', error);
                document.getElementById('total-alertas').innerHTML = '<span class="text-danger">Error</span>';
            }
        }

        // ==========================================
        // FILTRAR ALERTAS POR SECCIÓN
        // ==========================================
        async function filtrarAlertasPorSeccion(alertas, sectionId) {
            try {
                const alertasFiltradas = [];
                
                for (const alerta of alertas) {
                    const querySeccion = `/students?select=courses(grades(section_id))&family_id=eq.${alerta.family_code}&status_id=eq.d89b6287-ee51-435d-aeeb-d0f503af4646`;
                    const estudiantesConSeccion = await supabaseRequest(querySeccion);
                    
                    const perteneceSeccion = estudiantesConSeccion.some(est => 
                        est.courses?.grades?.section_id == sectionId
                    );
                    
                    if (perteneceSeccion) {
                        alertasFiltradas.push(alerta);
                    }
                }
                
                return alertasFiltradas;
            } catch (error) {
                console.error('Error filtrando por sección:', error);
                return alertas;
            }
        }

        // ==========================================
        // CARGAR TOP CAUSAS
        // ==========================================
        async function cargarTopCausas() {
            try {
                const fechaLimite = new Date();
                fechaLimite.setDate(fechaLimite.getDate() - filtrosActuales.periodo);
                const fechaLimiteStr = fechaLimite.toISOString();

                const query = `/early_alert_logs?select=cause_id,early_alert_causes(cause_name)&created_at=gte.${fechaLimiteStr}`;
                const alertas = await supabaseRequest(query);

                // Contar causas
                const contadorCausas = {};
                alertas.forEach(alerta => {
                    const causaName = alerta.early_alert_causes?.cause_name || 'Sin causa';
                    contadorCausas[causaName] = (contadorCausas[causaName] || 0) + 1;
                });

                // Ordenar por cantidad
                const causasOrdenadas = Object.entries(contadorCausas)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);

                // Renderizar tabla
                renderizarTopCausas(causasOrdenadas);

            } catch (error) {
                console.error('Error cargando top causas:', error);
                document.getElementById('top-causas-body').innerHTML = `
                    <tr><td colspan="3" class="text-center text-danger">Error al cargar causas</td></tr>
                `;
            }
        }

        // ==========================================
        // RENDERIZAR TOP CAUSAS
        // ==========================================
        function renderizarTopCausas(causas) {
            const tbody = document.getElementById('top-causas-body');
            
            if (causas.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="3" class="text-center text-muted py-4">No hay datos disponibles</td></tr>
                `;
                return;
            }

            const maxCount = causas[0][1];
            
            tbody.innerHTML = causas.map(([causa, count], index) => {
                const percentage = (count / maxCount) * 100;
                return `
                    <tr>
                        <td class="fw-bold text-primary">${index + 1}</td>
                        <td>
                            <div class="mb-1">${escapeHtml(causa)}</div>
                            <div class="causa-bar" style="width: ${percentage}%; height: 8px;"></div>
                        </td>
                        <td class="text-end fw-bold">${count}</td>
                    </tr>
                `;
            }).join('');
        }

        // ==========================================
        // CARGAR ALERTAS RECIENTES
        // ==========================================
        async function cargarAlertasRecientes() {
            try {
                const query = `/early_alert_logs?select=log_id,family_code,alert_status,created_at,families(family_name),early_alert_causes(cause_name)&order=created_at.desc&limit=10`;
                const alertas = await supabaseRequest(query);

                renderizarAlertasRecientes(alertas);

            } catch (error) {
                console.error('Error cargando alertas recientes:', error);
                document.getElementById('alertas-recientes').innerHTML = `
                    <div class="text-center text-danger">Error al cargar alertas recientes</div>
                `;
            }
        }

        // ==========================================
        // RENDERIZAR ALERTAS RECIENTES
        // ==========================================
        function renderizarAlertasRecientes(alertas) {
            const container = document.getElementById('alertas-recientes');
            
            if (alertas.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">No hay alertas recientes</div>
                `;
                return;
            }

            container.innerHTML = alertas.map(alerta => {
                const fecha = formatearFecha(alerta.created_at);
                const estadoClass = alerta.alert_status || 'red';
                
                return `
                    <div class="alert-item ${estadoClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="alert-familia">${escapeHtml(alerta.families?.family_name || 'Sin nombre')}</div>
                                <div class="alert-causa">${escapeHtml(alerta.early_alert_causes?.cause_name || 'Sin causa')}</div>
                            </div>
                            <div class="alert-fecha">${fecha}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==========================================
        // CARGAR ESTADÍSTICAS POR TRABAJADOR
        // ==========================================
        async function cargarEstadisticasTrabajadores() {
            try {
                const fechaLimite = new Date();
                fechaLimite.setDate(fechaLimite.getDate() - filtrosActuales.periodo);
                const fechaLimiteStr = fechaLimite.toISOString();

                const query = `/early_alert_logs?select=worker_id,alert_status,workers(worker_first_name,worker_last_name_1)&created_at=gte.${fechaLimiteStr}`;
                const alertas = await supabaseRequest(query);

                // Agrupar por trabajador
                const stats = {};
                alertas.forEach(alerta => {
                    const workerId = alerta.worker_id;
                    const workerName = `${alerta.workers?.worker_first_name || ''} ${alerta.workers?.worker_last_name_1 || ''}`.trim();
                    
                    if (!stats[workerId]) {
                        stats[workerId] = {
                            name: workerName,
                            total: 0,
                            red: 0,
                            yellow: 0,
                            green: 0
                        };
                    }
                    
                    stats[workerId].total++;
                    stats[workerId][alerta.alert_status || 'red']++;
                });

                renderizarEstadisticasTrabajadores(Object.values(stats));

            } catch (error) {
                console.error('Error cargando estadísticas de trabajadores:', error);
                document.getElementById('trabajadores-stats').innerHTML = `
                    <tr><td colspan="5" class="text-center text-danger">Error al cargar estadísticas</td></tr>
                `;
            }
        }

        // ==========================================
        // RENDERIZAR ESTADÍSTICAS TRABAJADORES
        // ==========================================
        function renderizarEstadisticasTrabajadores(stats) {
            const tbody = document.getElementById('trabajadores-stats');
            
            if (stats.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="5" class="text-center text-muted py-4">No hay datos disponibles</td></tr>
                `;
                return;
            }

            // Ordenar por total descendente
            stats.sort((a, b) => b.total - a.total);

            tbody.innerHTML = stats.slice(0, 10).map(stat => `
                <tr>
                    <td>${escapeHtml(stat.name)}</td>
                    <td class="text-center fw-bold">${stat.total}</td>
                    <td class="text-center"><span class="badge bg-danger">${stat.red}</span></td>
                    <td class="text-center"><span class="badge bg-warning">${stat.yellow}</span></td>
                    <td class="text-center"><span class="badge bg-success">${stat.green}</span></td>
                </tr>
            `).join('');
        }

        // ==========================================
        // ACTUALIZAR GRÁFICO DE TENDENCIAS - DATOS REALES
        // ==========================================
        async function actualizarGraficoTendencia() {
            try {
                const fechaFin = new Date();
                const fechaInicio = new Date();
                fechaInicio.setDate(fechaFin.getDate() - filtrosActuales.periodo);
        
                // Generar etiquetas por semana
                const labels = [];
                const dataRed = [];
                const dataYellow = [];
                const dataGreen = [];
        
                // Crear intervalos semanales
                for (let d = new Date(fechaInicio); d <= fechaFin; d.setDate(d.getDate() + 7)) {
                    const fechaInicioSemana = new Date(d);
                    const fechaFinSemana = new Date(d);
                    fechaFinSemana.setDate(fechaFinSemana.getDate() + 6);
                    
                    const label = `${fechaInicioSemana.getDate()}/${fechaInicioSemana.getMonth() + 1}`;
                    labels.push(label);
        
                    // Consultar datos reales para cada estado en esta semana
                    const fechaInicioStr = fechaInicioSemana.toISOString();
                    const fechaFinStr = fechaFinSemana.toISOString();
        
                    const [alertasRojas, alertasAmarillas, alertasVerdes] = await Promise.all([
                        supabaseRequest(`/early_alert_logs?select=log_id&alert_status=eq.red&created_at=gte.${fechaInicioStr}&created_at=lte.${fechaFinStr}`),
                        supabaseRequest(`/early_alert_logs?select=log_id&alert_status=eq.yellow&created_at=gte.${fechaInicioStr}&created_at=lte.${fechaFinStr}`),
                        supabaseRequest(`/early_alert_logs?select=log_id&alert_status=eq.green&created_at=gte.${fechaInicioStr}&created_at=lte.${fechaFinStr}`)
                    ]);
        
                    dataRed.push(alertasRojas.length);
                    dataYellow.push(alertasAmarillas.length);
                    dataGreen.push(alertasVerdes.length);
                }
        
                chartsInstances.tendencias.data.labels = labels;
                chartsInstances.tendencias.data.datasets[0].data = dataRed;
                chartsInstances.tendencias.data.datasets[1].data = dataYellow;
                chartsInstances.tendencias.data.datasets[2].data = dataGreen;
                chartsInstances.tendencias.update();
        
            } catch (error) {
                console.error('Error actualizando gráfico de tendencias:', error);
            }
        }
        
        // ==========================================
        // ACTUALIZAR GRÁFICO DE SECCIONES - DATOS REALES
        // ==========================================
        async function actualizarGraficoSecciones() {
            try {
                if (!cacheData.secciones) return;
        
                const fechaLimite = new Date();
                fechaLimite.setDate(fechaLimite.getDate() - filtrosActuales.periodo);
                const fechaLimiteStr = fechaLimite.toISOString();
        
                // Obtener todas las alertas del período
                const todasLasAlertas = await supabaseRequest(`/early_alert_logs?select=family_code&created_at=gte.${fechaLimiteStr}`);
        
                const labels = [];
                const data = [];
        
                for (const seccion of cacheData.secciones) {
                    labels.push(seccion.section_name);
                    
                    // Filtrar alertas de esta sección
                    const alertasSeccion = await filtrarAlertasPorSeccion(todasLasAlertas, seccion.section_id);
                    data.push(alertasSeccion.length);
                }
        
                chartsInstances.secciones.data.labels = labels;
                chartsInstances.secciones.data.datasets[0].data = data;
                chartsInstances.secciones.update();
        
            } catch (error) {
                console.error('Error actualizando gráfico de secciones:', error);
            }
        }

        // ==========================================
        // ACTUALIZAR GRÁFICO DE EVOLUCIÓN - DATOS REALES
        // ==========================================
        async function actualizarGraficoEvolucion() {
            try {
                const fechaLimite = new Date();
                fechaLimite.setDate(fechaLimite.getDate() - filtrosActuales.periodo);
                const fechaLimiteStr = fechaLimite.toISOString();
        
                // Consultar alertas abiertas y cerradas por estado
                const [
                    rojasAbiertas,
                    rojasCerradas,
                    amarillasAbiertas,
                    amarillasCerradas,
                    verdesAbiertas,
                    verdesCerradas
                ] = await Promise.all([
                    supabaseRequest(`/early_alert_logs?select=log_id&alert_status=eq.red&is_closed=eq.false&created_at=gte.${fechaLimiteStr}`),
                    supabaseRequest(`/early_alert_logs?select=log_id&alert_status=eq.red&is_closed=eq.true&created_at=gte.${fechaLimiteStr}`),
                    supabaseRequest(`/early_alert_logs?select=log_id&alert_status=eq.yellow&is_closed=eq.false&created_at=gte.${fechaLimiteStr}`),
                    supabaseRequest(`/early_alert_logs?select=log_id&alert_status=eq.yellow&is_closed=eq.true&created_at=gte.${fechaLimiteStr}`),
                    supabaseRequest(`/early_alert_logs?select=log_id&alert_status=eq.green&is_closed=eq.false&created_at=gte.${fechaLimiteStr}`),
                    supabaseRequest(`/early_alert_logs?select=log_id&alert_status=eq.green&is_closed=eq.true&created_at=gte.${fechaLimiteStr}`)
                ]);
        
                const abiertas = [rojasAbiertas.length, amarillasAbiertas.length, verdesAbiertas.length];
                const cerradas = [rojasCerradas.length, amarillasCerradas.length, verdesCerradas.length];
        
                chartsInstances.evolucion.data.datasets[0].data = abiertas;
                chartsInstances.evolucion.data.datasets[1].data = cerradas;
                chartsInstances.evolucion.update();
        
            } catch (error) {
                console.error('Error actualizando gráfico de evolución:', error);
            }
        }

     
        // ==========================================
        // APLICAR FILTROS
        // ==========================================
        async function aplicarFiltros() {
            try {
                mostrarLoading();

                // Actualizar filtros actuales
                filtrosActuales.periodo = parseInt(document.getElementById('filtro-periodo').value);
                filtrosActuales.seccion = document.getElementById('filtro-seccion').value;
                filtrosActuales.estado = document.getElementById('filtro-estado').value;

                // Recargar todos los datos
                await cargarDatosDashboard();

                ocultarLoading();
                showMessage('Filtros aplicados correctamente', 'success');

            } catch (error) {
                ocultarLoading();
                console.error('Error aplicando filtros:', error);
                showMessage('Error al aplicar filtros: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function formatearFecha(fechaStr) {
            if (!fechaStr) return '-';
            try {
                const fecha = new Date(fechaStr);
                return fecha.toLocaleDateString('es-CO');
            } catch (error) {
                return fechaStr;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Hacer funciones disponibles globalmente
        window.aplicarFiltros = aplicarFiltros;
        window.actualizarGraficoTendencia = actualizarGraficoTendencia;

        console.log('🎉 Tablero de control de alertas tempranas cargado correctamente');
    </script>
</body>
</html>
