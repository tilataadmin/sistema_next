<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Alertas Tempranas - SchoolNet</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
  <!-- Contenedor principal -->
  <div class="container-fluid">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mt-3">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="../../dashboard.html">
            <i class="bi bi-house me-1"></i>Dashboard
          </a>
        </li>
        <li class="breadcrumb-item">
          <a href="../early-alerts/index.html">
            Alertas Tempranas
          </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          Registro de Alertas
        </li>
      </ol>
    </nav>

    <!-- Encabezado de página -->
    <div class="row mb-4">
      <div class="col">
        <h1 class="h3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Registro de Alertas Tempranas
        </h1>
        <p class="text-muted">
          Registra nuevas alertas tempranas para seguimiento y gestión de situaciones que requieren atención especial
        </p>
      </div>
    </div>

    <!-- Mensajes del sistema -->
    <div id="alertContainer"></div>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" 
         style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
      <div class="d-flex justify-content-center align-items-center h-100">
        <div class="text-center text-white">
          <div class="spinner-border mb-3" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p>Procesando información...</p>
        </div>
      </div>
    </div>

    <!-- Barra de progreso inicial -->
    <div id="progress-container" class="mb-4">
      <div class="progress mb-2">
        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
             role="progressbar" style="width: 20%"></div>
      </div>
      <p id="progress-text" class="text-center text-muted">Cargando datos iniciales...</p>
    </div>
    <!-- Formulario principal -->
    <form id="form-registro-alerta" class="d-none">
      
      <!-- Sección 1: Selección de Familia -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-people me-2"></i>
            Información de la Familia
          </h5>
        </div>
        <div class="card-body">
          
          <!-- Selector de familia -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="familia-select" class="form-label">
                Familia <span class="text-danger">*</span>
              </label>
              <select id="familia-select" class="form-select" required>
                <option value="">Seleccione una familia...</option>
              </select>
            </div>
          </div>

          <!-- Información de estudiantes con fotos -->
          <div id="estudiantes-container" class="d-none">
            <h6 class="mb-3">Estudiantes de la Familia</h6>
            <div id="estudiantes-grid" class="row g-3">
              <!-- Plantilla para tarjeta de estudiante:
              <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                  <div class="card-body text-center">
                    <img src="[URL_FOTO]" class="rounded-circle mb-3" width="80" height="80" 
                         style="object-fit: cover;" alt="Foto estudiante"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNGOEY5RkEiLz4KPHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSIyMCIgeT0iMjAiPgo8cGF0aCBkPSJNMTIgMTJDMTQuNzYxNCAxMiAxNyA5Ljc2MTQyIDE3IDdDMTcgNC4yMzg1OCAxNC43NjE0IDIgMTIgMkM5LjIzODU4IDIgNyA0LjIzODU4IDcgN0M3IDkuNzYxNDIgOS4yMzg1OCAxMiAxMiAxMloiIGZpbGw9IiM2QzU1N0QiLz4KPHBhdGggZD0iTTEyIDE0QzguNjg2MjkgMTQgNiAxNi42ODYzIDYgMjBIMThDMTggMTYuNjg2MyAxNS4zMTM3IDE0IDEyIDE0WiIgZmlsbD0iIzZDNTU3RCIvPgo8L3N2Zz4KPC9zdmc+Cg=='">
                    <h6 class="card-title mb-1">[NOMBRE_ESTUDIANTE]</h6>
                    <p class="card-text small text-muted mb-1">[CURSO]</p>
                    <p class="card-text small text-muted">[EDAD]</p>
                  </div>
                </div>
              </div>
              -->
            </div>
          </div>

        </div>
      </div>

      <!-- Sección 2: Detalles de la Alerta -->
      <div id="seccion-alerta" class="card mb-4 d-none">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Detalles de la Alerta
          </h5>
        </div>
        <div class="card-body">
          
          <!-- Causa de la alerta -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="causa-select" class="form-label">
                Tipo de alerta <span class="text-danger">*</span>
              </label>
              <select id="causa-select" class="form-select" required>
                <option value="">Seleccione el tipo de alerta...</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="estado-select" class="form-label">
                Estado inicial <span class="text-danger">*</span>
              </label>
              <select id="estado-select" class="form-select" required>
                <option value="">Seleccione el estado...</option>
                <option value="Rojo">🔴 Rojo - Crítico</option>
                <option value="Amarillo">🟡 Amarillo - Moderado</option>
                <option value="Verde">🟢 Verde - Leve</option>
              </select>
            </div>
          </div>

          <!-- Descripción de la alerta -->
          <div class="mb-3">
            <label for="descripcion-alerta" class="form-label">
              Descripción detallada <span class="text-danger">*</span>
            </label>
            <div class="border rounded">
              <!-- Toolbar del editor -->
              <div class="bg-light border-bottom p-2">
                <div class="btn-group btn-group-sm" role="group">
                  <button type="button" class="btn btn-outline-secondary" onclick="formatText('bold')" title="Negrita">
                    <i class="bi bi-type-bold"></i>
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="formatText('italic')" title="Cursiva">
                    <i class="bi bi-type-italic"></i>
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="formatText('underline')" title="Subrayado">
                    <i class="bi bi-type-underline"></i>
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="formatText('insertUnorderedList')" title="Lista">
                    <i class="bi bi-list-ul"></i>
                  </button>
                </div>
              </div>
              <!-- Área de edición -->
              <div id="descripcion-alerta" 
                   class="p-3" 
                   contenteditable="true" 
                   style="min-height: 120px; outline: none;"
                   data-placeholder="Describa detalladamente la situación que motiva esta alerta temprana..."
                   required>
              </div>
            </div>
            <div class="form-text">
              Incluya todos los detalles relevantes sobre la situación observada
            </div>
          </div>

        </div>
      </div>

      <!-- Botones de acción -->
      <div id="botones-accion" class="text-center mb-4 d-none">
        <button type="submit" class="btn btn-primary btn-lg me-3">
          <i class="bi bi-check-circle me-2"></i>
          Registrar Alerta
        </button>
        <button type="button" class="btn btn-secondary btn-lg" onclick="limpiarFormulario()">
          <i class="bi bi-arrow-clockwise me-2"></i>
          Limpiar Formulario
        </button>
      </div>

    </form>
    <!-- Estilos CSS personalizados -->
    <style>
      /* Estilos para el editor de texto */
      #descripcion-alerta:empty::before {
        content: attr(data-placeholder);
        color: #6c757d;
        font-style: italic;
      }

      #descripcion-alerta:focus {
        background-color: #f8f9fa;
      }

      /* Estilos para las tarjetas de estudiantes */
      .estudiante-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }

      .estudiante-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }

      /* Placeholder para fotos de estudiantes */
      .foto-placeholder {
        width: 80px;
        height: 80px;
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-size: 2rem;
      }

      /* Loading states */
      .loading-state {
        opacity: 0.6;
        pointer-events: none;
      }

      /* Validación de formulario */
      .is-invalid {
        border-color: #dc3545;
      }

      .invalid-feedback {
        display: block;
      }

      /* Animaciones de carga */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>

  </div>

  <!-- JavaScript -->
  <script src="../../assets/js/config.js"></script>
  <script>
    // Variables globales
    let currentSession = null;
    let familiasDatos = [];
    let causasAlertas = [];
    let estudiantesActuales = [];

    // Inicialización al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
      initializePage('registerAlerts', 'Alertas Tempranas');
      inicializarFormulario();
    });

    /**
     * Inicialización principal del formulario
     */
    async function inicializarFormulario() {
      try {
        // Validar permisos
        const tieneAcceso = await validatePageAccess('Registro de alertas');
        if (!tieneAcceso) return;

        // Obtener sesión actual
        currentSession = getStoredSession();
        if (!currentSession || !currentSession.user) {
          showMessage('Sesión no válida. Por favor, inicie sesión nuevamente.', 'danger');
          return;
        }

        // Carga progresiva de datos
        await cargarDatosProgresivo();

      } catch (error) {
        console.error('Error al inicializar formulario:', error);
        showMessage('Error al inicializar el formulario: ' + error.message, 'danger');
        ocultarLoading();
      }
    }

    /**
     * Carga progresiva de datos
     */
    async function cargarDatosProgresivo() {
      try {
        // Paso 1: Cargar familias (40%)
        updateProgress(40, 'Cargando familias...');
        await cargarFamilias();

        // Paso 2: Cargar causas de alertas (70%)
        updateProgress(70, 'Cargando tipos de alertas...');
        await cargarCausasAlertas();

        // Paso 3: Finalizar inicialización (100%)
        updateProgress(100, 'Completado');
        finalizarInicializacion();

      } catch (error) {
        console.error('Error en carga progresiva:', error);
        showMessage('Error al cargar datos: ' + error.message, 'danger');
        document.getElementById('progress-container').classList.add('d-none');
      }
    }

    /**
   * Cargar familias desde la base de datos - CORREGIDO
   */
  async function cargarFamilias() {
    try {
      // Consulta corregida según esquema SQL
      const familias = await supabaseRequest('/families?select=family_code,family_name&order=family_name');
      
      familiasDatos = familias;
      
      const selectFamilia = document.getElementById('familia-select');
      selectFamilia.innerHTML = '<option value="">Seleccione una familia...</option>';
      
      familias.forEach(familia => {
        const option = document.createElement('option');
        option.value = familia.family_code; // family_code, no family_id
        option.textContent = familia.family_name;
        selectFamilia.appendChild(option);
      });
  
      console.log(`Cargadas ${familias.length} familias`);
  
    } catch (error) {
      console.error('Error al cargar familias:', error);
      throw new Error('No se pudieron cargar las familias');
    }
  }



    
    /**
     * Cargar causas de alertas tempranas
     */
    async function cargarCausasAlertas() {
      try {
        const causas = await supabaseRequest('/early_alert_causes?select=cause_id,cause_name&order=cause_name');
        
        causasAlertas = causas;
        
        // Poblar selector de causas
        const selectCausa = document.getElementById('causa-select');
        selectCausa.innerHTML = '<option value="">Seleccione el tipo de alerta...</option>';
        
        causas.forEach(causa => {
          const option = document.createElement('option');
          option.value = causa.cause_id;
          option.textContent = causa.cause_name;
          selectCausa.appendChild(option);
        });

        console.log(`Cargadas ${causas.length} causas de alertas`);

      } catch (error) {
        console.error('Error al cargar causas de alertas:', error);
        throw new Error('No se pudieron cargar los tipos de alertas');
      }
    }

    /**
     * Finalizar inicialización
     */
    function finalizarInicializacion() {
      // Ocultar barra de progreso
      setTimeout(() => {
        document.getElementById('progress-container').classList.add('d-none');
        
        // Mostrar formulario
        document.getElementById('form-registro-alerta').classList.remove('d-none');
        document.getElementById('form-registro-alerta').classList.add('fade-in');
        
        // Configurar event listeners
        configurarEventListeners();
        
        showMessage('Formulario cargado correctamente', 'success');
      }, 500);
    }

    /**
     * Configurar event listeners
     */
    function configurarEventListeners() {
      // Cambio en selector de familia
      document.getElementById('familia-select').addEventListener('change', function() {
        const familyCode = this.value;
        if (familyCode) {
          cargarEstudiantesFamilia(familyCode);
          mostrarSeccionAlerta();
        } else {
          ocultarEstudiantes();
          ocultarSeccionAlerta();
        }
      });

      // Submit del formulario
      document.getElementById('form-registro-alerta').addEventListener('submit', function(e) {
        e.preventDefault();
        guardarAlerta();
      });
    }

    /**
     * Cargar estudiantes de una familia específica - CORREGIDO
     */
    async function cargarEstudiantesFamilia(familyCode) {
      try {
        mostrarLoading();
        
        // Consulta sin relaciones para verificar
        const estudiantes = await supabaseRequest(
          `/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2,student_birthday&family_id=eq.${familyCode}`
        );
        
        console.log(`Estudiantes para familia ${familyCode}:`, estudiantes);
        
        if (estudiantes.length > 0) {
          // Obtener información de cursos por separado
          for (let estudiante of estudiantes) {
            if (estudiante.course_id) {
              try {
                const curso = await supabaseRequest(
                  `/courses?select=course_name,grades(grade_name)&course_id=eq.${estudiante.course_id}`
                );
                estudiante.cursoInfo = curso[0] || null;
              } catch (err) {
                console.warn('Error al obtener curso:', err);
                estudiante.cursoInfo = null;
              }
            }
          }
        }
        
        estudiantesActuales = estudiantes;
        mostrarEstudiantes();
        
      } catch (error) {
        console.error('Error al cargar estudiantes:', error);
        showMessage('Error al cargar estudiantes: ' + error.message, 'warning');
      } finally {
        ocultarLoading();
      }
    }


    
    /**
     * Mostrar estudiantes en tarjetas con fotos
     */
    async function mostrarEstudiantes() {
      const container = document.getElementById('estudiantes-container');
      const grid = document.getElementById('estudiantes-grid');
      
      grid.innerHTML = '';
      
      if (estudiantesActuales.length === 0) {
        grid.innerHTML = '<div class="col-12"><p class="text-muted">No se encontraron estudiantes activos para esta familia.</p></div>';
        container.classList.remove('d-none');
        return;
      }
      
      for (const estudiante of estudiantesActuales) {
        const card = await crearTarjetaEstudiante(estudiante);
        grid.appendChild(card);
      }
      
      container.classList.remove('d-none');
      container.classList.add('fade-in');
    }

    /**
     * Crear tarjeta individual de estudiante con foto
     */
    async function crearTarjetaEstudiante(estudiante) {
      const col = document.createElement('div');
      col.className = 'col-md-6 col-lg-4';
      
      // Calcular edad
      const edad = calcularEdad(estudiante.student_birthday);
      
      // Nombre completo
      const nombreCompleto = [
        estudiante.student_first_name,
        estudiante.student_last_name_1,
        estudiante.student_last_name_2
      ].filter(Boolean).join(' ');
      
      // Curso completo
      const cursoCompleto = estudiante.courses && estudiante.courses.grades 
        ? `${estudiante.courses.grades.grade_name} - ${estudiante.courses.course_name}`
        : 'Sin curso asignado';
      
      // Obtener URL de foto
      const fotoUrl = await getStudentPhotoUrl(estudiante.student_code);
      
      col.innerHTML = `
        <div class="card h-100 estudiante-card">
          <div class="card-body text-center">
            ${fotoUrl ? 
              `<img src="${fotoUrl}" class="rounded-circle mb-3" width="80" height="80" 
                   style="object-fit: cover;" alt="Foto de ${nombreCompleto}"
                   onerror="this.outerHTML='<div class=\\'foto-placeholder mb-3\\'>👤</div>'">` :
              `<div class="foto-placeholder mb-3">👤</div>`
            }
            <h6 class="card-title mb-1">${nombreCompleto}</h6>
            <p class="card-text small text-muted mb-1">${cursoCompleto}</p>
            <p class="card-text small text-muted">${edad}</p>
          </div>
        </div>
      `;
      
      return col;
    }

    /**
     * Calcular edad en formato legible
     */
    function calcularEdad(fechaNacimiento) {
      if (!fechaNacimiento) return 'Edad no disponible';
      
      const hoy = new Date();
      const nacimiento = new Date(fechaNacimiento);
      
      let años = hoy.getFullYear() - nacimiento.getFullYear();
      let meses = hoy.getMonth() - nacimiento.getMonth();
      let días = hoy.getDate() - nacimiento.getDate();
      
      if (días < 0) {
        meses--;
        días += new Date(hoy.getFullYear(), hoy.getMonth(), 0).getDate();
      }
      
      if (meses < 0) {
        años--;
        meses += 12;
      }
      
      const partes = [];
      if (años > 0) partes.push(`${años} año${años !== 1 ? 's' : ''}`);
      if (meses > 0) partes.push(`${meses} mes${meses !== 1 ? 'es' : ''}`);
      if (días > 0) partes.push(`${días} día${días !== 1 ? 's' : ''}`);
      
      return partes.length > 0 ? partes.join(', ') : 'Recién nacido';
    }

    /**
   * Guardar alerta temprana - CORREGIDO
   */
  async function guardarAlerta() {
    try {
      if (!validarFormulario()) return;
      
      mostrarLoading();
      
      // Datos corregidos según esquema SQL
      const datosAlerta = {
        family_code: parseInt(document.getElementById('familia-select').value), // family_code, no family_id
        cause_id: parseInt(document.getElementById('causa-select').value),
        log_status: document.getElementById('estado-select').value,
        log_details: document.getElementById('descripcion-alerta').innerHTML,
        worker_id: currentSession.user.worker_id, // Necesario según esquema
        log_closed: 'NO', // String según esquema, no boolean
        log_created_date: new Date().toISOString().slice(0, 19).replace('T', ' ') // Formato MySQL
      };
      
      const resultado = await supabaseRequest('/early_alert_logs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datosAlerta)
      });
      
      if (resultado && resultado.length > 0) {
        await enviarNotificacionAlerta(resultado[0], datosAlerta);
        showMessage('Alerta registrada exitosamente y notificaciones enviadas', 'success');
        limpiarFormulario();
      } else {
        throw new Error('No se pudo guardar la alerta');
      }
      
    } catch (error) {
      console.error('Error al guardar alerta:', error);
      showMessage('Error al guardar la alerta: ' + error.message, 'danger');
    } finally {
      ocultarLoading();
    }
  }

    
    /**
     * Enviar notificación de nueva alerta
     */
    async function enviarNotificacionAlerta(alertaGuardada, datosOriginales) {
      try {
        // Obtener familia seleccionada
        const familia = familiasDatos.find(f => f.family_code == datosOriginales.family_id);
        const causa = causasAlertas.find(c => c.cause_id == datosOriginales.cause_id);
        
        if (!familia || !causa) return;
        
        // Preparar contenido del correo
        const asunto = 'Nueva Alerta Temprana - Sistema SchoolNet';
        const contenidoHtml = `
          <div style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
            <h2 style="color: #1b365d;">Nueva Alerta Temprana Registrada</h2>
            
            <p><strong>Familia:</strong> ${familia.family_name}</p>
            <p><strong>Tipo de alerta:</strong> ${causa.cause_name}</p>
            <p><strong>Estado:</strong> <span style="color: ${getColorEstado(datosOriginales.log_status)}">${datosOriginales.log_status}</span></p>
            <p><strong>Registrada por:</strong> ${currentSession.user.user_display_name || currentSession.user.user_name}</p>
            
            <div style="background-color: #f8f9fa; padding: 15px; border-left: 4px solid #1380e2; margin: 20px 0;">
              <h4>Descripción:</h4>
              ${datosOriginales.log_details}
            </div>
            
            <p><em>Por favor, gestione esta alerta en el sistema SchoolNet.</em></p>
          </div>
        `;
        
        // Obtener destinatarios (se podría implementar lógica específica)
        const destinatarios = ['direccion@colegiotilata.edu.co']; // Placeholder
        
        // Enviar notificación usando el sistema centralizado
        for (const destinatario of destinatarios) {
          await sendNotification(destinatario, asunto, contenidoHtml, true);
        }
        
      } catch (error) {
        console.error('Error al enviar notificación:', error);
        // No lanzar error para no afectar el guardado principal
      }
    }

    /**
     * Funciones auxiliares
     */
    function getColorEstado(estado) {
      switch(estado) {
        case 'Rojo': return '#dc3545';
        case 'Amarillo': return '#ffc107';
        case 'Verde': return '#198754';
        default: return '#6c757d';
      }
    }

    function validarFormulario() {
      const familia = document.getElementById('familia-select').value;
      const causa = document.getElementById('causa-select').value;
      const estado = document.getElementById('estado-select').value;
      const descripcion = document.getElementById('descripcion-alerta').innerHTML.trim();
      
      if (!familia || !causa || !estado || !descripcion || descripcion === '<br>') {
        showMessage('Por favor complete todos los campos obligatorios', 'warning');
        return false;
      }
      
      return true;
    }

    function limpiarFormulario() {
      document.getElementById('form-registro-alerta').reset();
      document.getElementById('descripcion-alerta').innerHTML = '';
      ocultarEstudiantes();
      ocultarSeccionAlerta();
      estudiantesActuales = [];
    }

    function mostrarSeccionAlerta() {
      document.getElementById('seccion-alerta').classList.remove('d-none');
      document.getElementById('botones-accion').classList.remove('d-none');
    }

    function ocultarSeccionAlerta() {
      document.getElementById('seccion-alerta').classList.add('d-none');
      document.getElementById('botones-accion').classList.add('d-none');
    }

    function ocultarEstudiantes() {
      document.getElementById('estudiantes-container').classList.add('d-none');
    }

    function mostrarLoading() {
      document.getElementById('loading-overlay').classList.remove('d-none');
    }

    function ocultarLoading() {
      document.getElementById('loading-overlay').classList.add('d-none');
    }

    function updateProgress(percent, text) {
      document.getElementById('progress-bar').style.width = percent + '%';
      document.getElementById('progress-text').textContent = text;
    }

    function formatText(command) {
      document.execCommand(command, false, null);
      document.getElementById('descripcion-alerta').focus();
    }
  </script>

  <!-- Bootstrap JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
