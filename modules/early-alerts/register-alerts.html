<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Alertas - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">
                        Alertas Tempranas
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Registrar Alertas
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-plus-circle me-2"></i>
                    Registrar Nueva Alerta Temprana
                </h1>
                <p class="text-muted">
                    Registra una nueva alerta temprana en el sistema
                </p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Formulario de registro -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Información de la Alerta
                </h5>
            </div>
            <div class="card-body">
                <form id="alertForm">
                    <div class="row">
                        <!-- Búsqueda de familia -->
                        <div class="col-md-6 mb-3">
                            <label for="familySearch" class="form-label">Buscar Familia *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="familySearch" 
                                       placeholder="Buscar por código o nombre de familia..." required>
                                <button type="button" class="btn btn-outline-secondary" onclick="searchFamilies()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            <input type="hidden" id="selectedFamilyCode">
                            <div id="familyResults" class="mt-2"></div>
                        </div>

                        <!-- Selección de causa -->
                        <div class="col-md-6 mb-3">
                            <label for="causeSelect" class="form-label">Causa de la Alerta *</label>
                            <select class="form-select" id="causeSelect" required>
                                <option value="">Selecciona una causa...</option>
                            </select>
                        </div>

                        <!-- Estado de la alerta -->
                        <div class="col-md-4 mb-3">
                            <label for="alertStatus" class="form-label">Estado de la Alerta *</label>
                            <select class="form-select" id="alertStatus" required>
                                <option value="red" selected>🔴 Rojo - Crítico</option>
                                <option value="yellow">🟡 Amarillo - Moderado</option>
                                <option value="green">🟢 Verde - Leve</option>
                            </select>
                        </div>

                        <!-- Trabajador responsable (automático) -->
                        <div class="col-md-8 mb-3">
                            <label for="workerInfo" class="form-label">Reportado por</label>
                            <input type="text" class="form-control" id="workerInfo" readonly>
                            <input type="hidden" id="workerId">
                        </div>

                        <!-- Detalles de la alerta -->
                        <div class="col-12 mb-3">
                            <label for="logDetails" class="form-label">Detalles de la Alerta *</label>
                            <textarea class="form-control" id="logDetails" rows="4" required
                                      placeholder="Describe la situación que genera la alerta temprana..."></textarea>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-exclamation-triangle me-1"></i>Registrar Alerta
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Limpiar Formulario
                        </button>
                        <a href="manage-alerts.html" class="btn btn-outline-primary">
                            <i class="bi bi-list me-1"></i>Ver Alertas Registradas
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Alertas recientes del usuario -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    Mis Alertas Recientes
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Familia</th>
                                <th>Causa</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="recentAlertsBody">
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Config.js -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // Variables globales
        let causes = [];
        let currentUser = null;
        let families = [];

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Registro de Alertas - Iniciando...');
            
            validatePageAccess('Registro de alertas').then(hasAccess => {
                if (hasAccess) {
                    initializePage();
                }
            });
        });

        async function initializePage() {
            try {
                // Obtener usuario actual
                const session = getStoredSession();
                currentUser = session?.user;

                if (!currentUser) {
                    showMessage('Error: No se pudo obtener información del usuario', 'danger');
                    return;
                }

                // Cargar información del trabajador
                await loadWorkerInfo();

                // Cargar causas disponibles
                await loadCauses();

                // Cargar familias para búsqueda
                await loadFamilies();

                // Cargar alertas recientes
                await loadRecentAlerts();

                // Event listeners
                document.getElementById('alertForm').addEventListener('submit', handleCreateAlert);
                document.getElementById('familySearch').addEventListener('input', handleFamilySearch);

                console.log('Página inicializada correctamente');
            } catch (error) {
                console.error('Error inicializando página:', error);
                showMessage('Error inicializando la página', 'danger');
            }
        }

        async function loadWorkerInfo() {
            try {
                const workerData = await supabaseRequest(`/workers?select=*&email=eq.${currentUser.user_mail}&limit=1`);
                
                if (workerData && workerData.length > 0) {
                    const worker = workerData[0];
                    document.getElementById('workerId').value = worker.worker_id;
                    document.getElementById('workerInfo').value = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
                } else {
                    showMessage('Advertencia: No se encontró información del trabajador', 'warning');
                }
            } catch (error) {
                console.error('Error cargando información del trabajador:', error);
            }
        }

        async function loadCauses() {
            try {
                const data = await supabaseRequest('/early_alert_causes?select=*&cause_status=eq.active&order=cause_name');
                causes = data || [];
                
                const select = document.getElementById('causeSelect');
                select.innerHTML = '<option value="">Selecciona una causa...</option>';
                
                causes.forEach(cause => {
                    const option = document.createElement('option');
                    option.value = cause.cause_id;
                    option.textContent = cause.cause_name;
                    select.appendChild(option);
                });

                console.log(`${causes.length} causas cargadas`);
            } catch (error) {
                console.error('Error cargando causas:', error);
                showMessage('Error cargando las causas disponibles', 'warning');
            }
        }

        async function loadFamilies() {
            try {
                const data = await supabaseRequest('/families?select=family_code,family_name&order=family_name');
                families = data || [];
                console.log(`${families.length} familias cargadas para búsqueda`);
            } catch (error) {
                console.error('Error cargando familias:', error);
            }
        }

        function handleFamilySearch() {
            const searchTerm = document.getElementById('familySearch').value.toLowerCase();
            const resultsDiv = document.getElementById('familyResults');
            
            if (searchTerm.length < 2) {
                resultsDiv.innerHTML = '';
                document.getElementById('selectedFamilyCode').value = '';
                return;
            }

            const filteredFamilies = families.filter(family => 
                family.family_code.toString().includes(searchTerm) ||
                (family.family_name && family.family_name.toLowerCase().includes(searchTerm))
            ).slice(0, 5);

            if (filteredFamilies.length === 0) {
                resultsDiv.innerHTML = '<small class="text-muted">No se encontraron familias</small>';
                return;
            }

            const html = filteredFamilies.map(family => `
                <div class="card card-body py-2 mb-1" style="cursor: pointer;" onclick="selectFamily(${family.family_code}, '${family.family_name || 'Sin nombre'}')">
                    <small><strong>Código:</strong> ${family.family_code} - <strong>Familia:</strong> ${family.family_name || 'Sin nombre'}</small>
                </div>
            `).join('');

            resultsDiv.innerHTML = html;
        }

        function selectFamily(familyCode, familyName) {
            document.getElementById('selectedFamilyCode').value = familyCode;
            document.getElementById('familySearch').value = `${familyCode} - ${familyName}`;
            document.getElementById('familyResults').innerHTML = '';
        }

        async function searchFamilies() {
            const searchTerm = document.getElementById('familySearch').value;
            if (!searchTerm) {
                showMessage('Ingresa un término de búsqueda', 'warning');
                return;
            }
            handleFamilySearch();
        }

        async function handleCreateAlert(event) {
            event.preventDefault();
            
            try {
                const familyCode = document.getElementById('selectedFamilyCode').value;
                const causeId = document.getElementById('causeSelect').value;
                const workerId = document.getElementById('workerId').value;

                if (!familyCode) {
                    showMessage('Debes seleccionar una familia', 'warning');
                    return;
                }

                if (!workerId) {
                    showMessage('Error: No se pudo identificar el trabajador', 'danger');
                    return;
                }

                const alertData = {
                    family_code: parseInt(familyCode),
                    cause_id: causeId,
                    alert_status: document.getElementById('alertStatus').value,
                    worker_id: workerId,
                    log_details: document.getElementById('logDetails').value.trim(),
                    is_closed: false
                };

                console.log('Registrando nueva alerta:', alertData);

                await supabaseRequest('/early_alert_logs', {
                    method: 'POST',
                    body: JSON.stringify(alertData)
                });

                showMessage('Alerta registrada exitosamente', 'success');
                resetForm();
                await loadRecentAlerts();

            } catch (error) {
                console.error('Error registrando alerta:', error);
                showMessage('Error registrando la alerta', 'danger');
            }
        }

        async function loadRecentAlerts() {
            try {
                const workerId = document.getElementById('workerId').value;
                if (!workerId) return;

                const query = `/early_alert_logs?select=*,families(family_name),early_alert_causes(cause_name)&worker_id=eq.${workerId}&order=created_at.desc&limit=5`;
                const data = await supabaseRequest(query);
                
                renderRecentAlerts(data || []);
            } catch (error) {
                console.error('Error cargando alertas recientes:', error);
                document.getElementById('recentAlertsBody').innerHTML = `
                    <tr><td colspan="5" class="text-center text-muted">Error cargando alertas</td></tr>
                `;
            }
        }

        function renderRecentAlerts(alerts) {
            const tbody = document.getElementById('recentAlertsBody');
            
            if (alerts.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="5" class="text-center text-muted">No hay alertas recientes</td></tr>
                `;
                return;
            }

            const html = alerts.map(alert => {
                const statusIcons = {
                    'red': '🔴',
                    'yellow': '🟡', 
                    'green': '🟢'
                };

                return `
                    <tr>
                        <td>${formatDate(alert.created_at)}</td>
                        <td>${alert.family_code} - ${alert.families?.family_name || 'Sin nombre'}</td>
                        <td>${alert.early_alert_causes?.cause_name || 'Sin causa'}</td>
                        <td>
                            ${statusIcons[alert.alert_status] || ''} 
                            <span class="badge bg-${alert.alert_status === 'red' ? 'danger' : alert.alert_status === 'yellow' ? 'warning' : 'success'}">
                                ${alert.alert_status.toUpperCase()}
                            </span>
                        </td>
                        <td>
                            <a href="manage-alerts.html?log_id=${alert.log_id}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html;
        }

        function resetForm() {
            document.getElementById('alertForm').reset();
            document.getElementById('selectedFamilyCode').value = '';
            document.getElementById('familyResults').innerHTML = '';
            document.getElementById('alertStatus').value = 'red';
        }
    </script>
</body>
</html>
