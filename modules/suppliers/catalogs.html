<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.19.17.00">
    <title>Cat√°logos de Proveedores - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden { display: none; }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #64748b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .badge-count {
            font-size: 0.7rem;
            vertical-align: middle;
        }
        
        .search-box {
            max-width: 350px;
        }
        
        .table th { white-space: nowrap; }
        
        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Proveedores</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Cat√°logos</li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-journal-bookmark me-2" style="color: #64748b;"></i>
                    Cat√°logos de Proveedores
                </h1>
                <p class="text-muted">Departamentos, municipios, entidades bancarias y actividades econ√≥micas CIIU</p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- TABS DE CAT√ÅLOGOS -->
        <ul class="nav nav-tabs mb-4" id="catalogTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-departments" data-bs-toggle="tab" data-bs-target="#panel-departments" type="button" role="tab">
                    <i class="bi bi-geo-alt me-1"></i>Departamentos
                    <span class="badge bg-secondary badge-count ms-1" id="count-departments">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-municipalities" data-bs-toggle="tab" data-bs-target="#panel-municipalities" type="button" role="tab">
                    <i class="bi bi-pin-map me-1"></i>Municipios
                    <span class="badge bg-secondary badge-count ms-1" id="count-municipalities">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-banks" data-bs-toggle="tab" data-bs-target="#panel-banks" type="button" role="tab">
                    <i class="bi bi-bank me-1"></i>Bancos
                    <span class="badge bg-secondary badge-count ms-1" id="count-banks">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-ciiu" data-bs-toggle="tab" data-bs-target="#panel-ciiu" type="button" role="tab">
                    <i class="bi bi-tags me-1"></i>CIIU
                    <span class="badge bg-secondary badge-count ms-1" id="count-ciiu">0</span>
                </button>
            </li>
        </ul>

        <!-- CONTENIDO DE TABS -->
        <div class="tab-content" id="catalogTabContent">

            <!-- ============================================ -->
            <!-- TAB: DEPARTAMENTOS                          -->
            <!-- ============================================ -->
            <div class="tab-pane fade show active" id="panel-departments" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Departamentos de Colombia</h5>
                        <div class="d-flex gap-2">
                            <div class="input-group input-group-sm search-box">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="search-departments" placeholder="Buscar departamento..." oninput="filtrarTabla('departments')">
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="abrirModalDepartamento()">
                                <i class="bi bi-plus-circle me-1"></i>Nuevo
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>C√≥digo DANE</th>
                                        <th>Nombre</th>
                                        <th>Municipios</th>
                                        <th>Estado</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-departments">
                                    <tr><td colspan="5" class="text-center py-4 text-muted">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- TAB: MUNICIPIOS                             -->
            <!-- ============================================ -->
            <div class="tab-pane fade" id="panel-municipalities" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5 class="mb-0"><i class="bi bi-pin-map me-2"></i>Municipios de Colombia</h5>
                        <div class="d-flex gap-2 flex-wrap">
                            <select class="form-select form-select-sm" id="filter-department" style="max-width: 220px;" onchange="cargarMunicipios()">
                                <option value="">Todos los departamentos</option>
                            </select>
                            <div class="input-group input-group-sm search-box">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="search-municipalities" placeholder="Buscar municipio..." oninput="filtrarTabla('municipalities')">
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="abrirModalMunicipio()">
                                <i class="bi bi-plus-circle me-1"></i>Nuevo
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>C√≥digo DANE</th>
                                        <th>Municipio</th>
                                        <th>Departamento</th>
                                        <th>Estado</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-municipalities">
                                    <tr><td colspan="5" class="text-center py-4 text-muted">Seleccione un departamento o espere...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- TAB: BANCOS                                 -->
            <!-- ============================================ -->
            <div class="tab-pane fade" id="panel-banks" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5 class="mb-0"><i class="bi bi-bank me-2"></i>Entidades Bancarias</h5>
                        <div class="d-flex gap-2">
                            <div class="input-group input-group-sm search-box">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="search-banks" placeholder="Buscar banco..." oninput="filtrarTabla('banks')">
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="abrirModalBanco()">
                                <i class="bi bi-plus-circle me-1"></i>Nuevo
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Nombre</th>
                                        <th>Estado</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-banks">
                                    <tr><td colspan="4" class="text-center py-4 text-muted">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- TAB: CIIU                                   -->
            <!-- ============================================ -->
            <div class="tab-pane fade" id="panel-ciiu" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5 class="mb-0"><i class="bi bi-tags me-2"></i>Actividades Econ√≥micas CIIU</h5>
                        <div class="d-flex gap-2 flex-wrap">
                            <select class="form-select form-select-sm" id="filter-ciiu-section" style="max-width: 200px;" onchange="filtrarCIIUPorSeccion()">
                                <option value="">Todas las secciones</option>
                            </select>
                            <div class="input-group input-group-sm search-box">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="search-ciiu" placeholder="Buscar c√≥digo o descripci√≥n..." oninput="filtrarTabla('ciiu')">
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="abrirModalCIIU()">
                                <i class="bi bi-plus-circle me-1"></i>Nuevo
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Descripci√≥n</th>
                                        <th>Secci√≥n</th>
                                        <th>Estado</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-ciiu">
                                    <tr><td colspan="5" class="text-center py-4 text-muted">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer text-muted small">
                        <i class="bi bi-info-circle me-1"></i>
                        El cat√°logo CIIU puede contener miles de registros. Use los filtros para una b√∫squeda eficiente.
                    </div>
                </div>
            </div>

        </div><!-- fin tab-content -->
    </div><!-- fin container -->


    <!-- ============================================ -->
    <!-- MODAL: DEPARTAMENTO                         -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-department" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-department-title">
                        <i class="bi bi-geo-alt me-2"></i>Nuevo Departamento
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-department" onsubmit="guardarDepartamento(event)">
                    <div class="modal-body">
                        <input type="hidden" id="dept-id">
                        <div class="mb-3">
                            <label for="dept-code" class="form-label">C√≥digo DANE <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="dept-code" required maxlength="5" placeholder="Ej: 25">
                        </div>
                        <div class="mb-3">
                            <label for="dept-name" class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="dept-name" required maxlength="100" placeholder="Ej: Cundinamarca">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dept-active" checked>
                            <label class="form-check-label" for="dept-active">Activo</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btn-save-dept">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- ============================================ -->
    <!-- MODAL: MUNICIPIO                            -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-municipality" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-municipality-title">
                        <i class="bi bi-pin-map me-2"></i>Nuevo Municipio
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-municipality" onsubmit="guardarMunicipio(event)">
                    <div class="modal-body">
                        <input type="hidden" id="muni-id">
                        <div class="mb-3">
                            <label for="muni-department" class="form-label">Departamento <span class="text-danger">*</span></label>
                            <select class="form-select" id="muni-department" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="muni-code" class="form-label">C√≥digo DANE <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="muni-code" required maxlength="8" placeholder="Ej: 25754">
                        </div>
                        <div class="mb-3">
                            <label for="muni-name" class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="muni-name" required maxlength="150" placeholder="Ej: Soacha">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="muni-active" checked>
                            <label class="form-check-label" for="muni-active">Activo</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btn-save-muni">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- ============================================ -->
    <!-- MODAL: BANCO                                -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-bank" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-bank-title">
                        <i class="bi bi-bank me-2"></i>Nuevo Banco
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-bank" onsubmit="guardarBanco(event)">
                    <div class="modal-body">
                        <input type="hidden" id="bank-id">
                        <div class="mb-3">
                            <label for="bank-code" class="form-label">C√≥digo</label>
                            <input type="text" class="form-control" id="bank-code" maxlength="10" placeholder="Ej: 007 (opcional)">
                        </div>
                        <div class="mb-3">
                            <label for="bank-name" class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="bank-name" required maxlength="150" placeholder="Ej: Bancolombia S.A.">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="bank-active" checked>
                            <label class="form-check-label" for="bank-active">Activo</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btn-save-bank">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- ============================================ -->
    <!-- MODAL: CIIU                                 -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-ciiu" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-ciiu-title">
                        <i class="bi bi-tags me-2"></i>Nueva Actividad CIIU
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-ciiu" onsubmit="guardarCIIU(event)">
                    <div class="modal-body">
                        <input type="hidden" id="ciiu-id">
                        <div class="mb-3">
                            <label for="ciiu-code" class="form-label">C√≥digo CIIU <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ciiu-code" required maxlength="10" placeholder="Ej: 6201">
                        </div>
                        <div class="mb-3">
                            <label for="ciiu-description" class="form-label">Descripci√≥n <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ciiu-description" required maxlength="500" placeholder="Ej: Actividades de desarrollo de sistemas inform√°ticos">
                        </div>
                        <div class="mb-3">
                            <label for="ciiu-section" class="form-label">Secci√≥n</label>
                            <input type="text" class="form-control" id="ciiu-section" maxlength="5" placeholder="Ej: J (opcional)">
                            <div class="form-text">Letra de la secci√≥n CIIU (A-U)</div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ciiu-active" checked>
                            <label class="form-check-label" for="ciiu-active">Activo</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btn-save-ciiu">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let cacheDepartments = [];
        let cacheMunicipalities = [];
        let cacheBanks = [];
        let cacheCIIU = [];
        
        // Modales
        let modalDept, modalMuni, modalBank, modalCIIU;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando Cat√°logos de Proveedores...');
            
            try {
                const hasAccess = await validatePageAccess('Gestionar cat√°logos de proveedores');
                if (!hasAccess) return;
                
                console.log('‚úÖ Acceso permitido');
                
                const session = getStoredSession();
                if (!session) {
                    showMessage('Sesi√≥n no v√°lida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '/login.html', 2000);
                    return;
                }
                
                // Inicializar modales
                modalDept = new bootstrap.Modal(document.getElementById('modal-department'));
                modalMuni = new bootstrap.Modal(document.getElementById('modal-municipality'));
                modalBank = new bootstrap.Modal(document.getElementById('modal-bank'));
                modalCIIU = new bootstrap.Modal(document.getElementById('modal-ciiu'));
                
                // Cargar datos iniciales
                await cargarDepartamentos();
                await cargarBancos();
                await cargarCIIU();
                
                // Cargar municipios cuando se active el tab
                document.getElementById('tab-municipalities').addEventListener('shown.bs.tab', function() {
                    if (cacheMunicipalities.length === 0) {
                        cargarMunicipios();
                    }
                });
                
                console.log('‚úÖ Cat√°logos inicializados');
                
            } catch (error) {
                console.error('‚ùå Error inicializando cat√°logos:', error);
                showMessage('Error al cargar cat√°logos: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // DEPARTAMENTOS
        // ==========================================
        async function cargarDepartamentos() {
            try {
                const data = await supabaseRequest('/sup_departments?select=*&order=department_name.asc');
                cacheDepartments = data || [];
                
                document.getElementById('count-departments').textContent = cacheDepartments.length;
                renderizarDepartamentos(cacheDepartments);
                
                // Poblar selects de departamento
                poblarSelectDepartamentos();
                
            } catch (error) {
                console.error('‚ùå Error cargando departamentos:', error);
                document.getElementById('tbody-departments').innerHTML = 
                    '<tr><td colspan="5" class="text-center text-danger py-4">Error al cargar departamentos</td></tr>';
            }
        }
        
        function renderizarDepartamentos(datos) {
            const tbody = document.getElementById('tbody-departments');
            
            if (!datos || datos.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="5" class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No hay departamentos registrados</p>
                    </td></tr>`;
                return;
            }
            
            tbody.innerHTML = datos.map(d => `
                <tr>
                    <td><code>${d.department_code || '-'}</code></td>
                    <td>${d.department_name}</td>
                    <td><span class="badge bg-light text-dark" id="muni-count-${d.department_id}">--</span></td>
                    <td>${d.is_active 
                        ? '<span class="badge bg-success">Activo</span>' 
                        : '<span class="badge bg-secondary">Inactivo</span>'}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-primary btn-action me-1" onclick="editarDepartamento('${d.department_id}')" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-${d.is_active ? 'warning' : 'success'} btn-action" onclick="toggleDepartamento('${d.department_id}', ${d.is_active})" title="${d.is_active ? 'Desactivar' : 'Activar'}">
                            <i class="bi bi-${d.is_active ? 'pause-circle' : 'play-circle'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Cargar conteos de municipios en background
            cargarConteosMunicipios(datos);
        }
        
        async function cargarConteosMunicipios(departamentos) {
            for (const dept of departamentos) {
                try {
                    const data = await supabaseRequest(`/sup_municipalities?select=municipality_id&department_id=eq.${dept.department_id}`);
                    const el = document.getElementById(`muni-count-${dept.department_id}`);
                    if (el) el.textContent = data ? data.length : 0;
                } catch (e) {
                    // Silenciar errores individuales
                }
            }
        }
        
        function poblarSelectDepartamentos() {
            const activos = cacheDepartments.filter(d => d.is_active);
            
            // Select del filtro de municipios
            const filterDept = document.getElementById('filter-department');
            filterDept.innerHTML = '<option value="">Todos los departamentos</option>' +
                activos.map(d => `<option value="${d.department_id}">${d.department_name}</option>`).join('');
            
            // Select del modal de municipio
            const muniDept = document.getElementById('muni-department');
            muniDept.innerHTML = '<option value="">Seleccione...</option>' +
                activos.map(d => `<option value="${d.department_id}">${d.department_name}</option>`).join('');
        }
        
        function abrirModalDepartamento() {
            document.getElementById('modal-department-title').innerHTML = '<i class="bi bi-geo-alt me-2"></i>Nuevo Departamento';
            document.getElementById('form-department').reset();
            document.getElementById('dept-id').value = '';
            document.getElementById('dept-active').checked = true;
            modalDept.show();
        }
        
        function editarDepartamento(id) {
            const dept = cacheDepartments.find(d => d.department_id === id);
            if (!dept) return;
            
            document.getElementById('modal-department-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Departamento';
            document.getElementById('dept-id').value = id;
            document.getElementById('dept-code').value = dept.department_code || '';
            document.getElementById('dept-name').value = dept.department_name;
            document.getElementById('dept-active').checked = dept.is_active;
            modalDept.show();
        }
        
        async function guardarDepartamento(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-dept');
            btn.disabled = true;
            
            try {
                const id = document.getElementById('dept-id').value;
                const payload = {
                    department_code: document.getElementById('dept-code').value.trim(),
                    department_name: document.getElementById('dept-name').value.trim(),
                    is_active: document.getElementById('dept-active').checked
                };
                
                if (id) {
                    await supabaseRequest(`/sup_departments?department_id=eq.${id}`, {
                        method: 'PATCH',
                        body: JSON.stringify(payload)
                    });
                    showMessage('Departamento actualizado', 'success');
                } else {
                    await supabaseRequest('/sup_departments', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    showMessage('Departamento creado', 'success');
                }
                
                modalDept.hide();
                await cargarDepartamentos();
                
            } catch (error) {
                console.error('‚ùå Error guardando departamento:', error);
                showMessage('Error: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
            }
        }
        
        async function toggleDepartamento(id, currentState) {
            const action = currentState ? 'desactivar' : 'activar';
            if (!confirm(`¬ø${currentState ? 'Desactivar' : 'Activar'} este departamento?`)) return;
            
            try {
                await supabaseRequest(`/sup_departments?department_id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: !currentState })
                });
                showMessage(`Departamento ${action === 'desactivar' ? 'desactivado' : 'activado'}`, 'success');
                await cargarDepartamentos();
            } catch (error) {
                showMessage('Error: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // MUNICIPIOS
        // ==========================================
        async function cargarMunicipios() {
            try {
                const filtro = document.getElementById('filter-department').value;
                let query = '/sup_municipalities?select=*,sup_departments(department_name)&order=municipality_name.asc';
                
                if (filtro) {
                    query += `&department_id=eq.${filtro}`;
                }
                
                const data = await supabaseRequest(query);
                cacheMunicipalities = data || [];
                
                document.getElementById('count-municipalities').textContent = cacheMunicipalities.length;
                renderizarMunicipios(cacheMunicipalities);
                
            } catch (error) {
                console.error('‚ùå Error cargando municipios:', error);
                document.getElementById('tbody-municipalities').innerHTML = 
                    '<tr><td colspan="5" class="text-center text-danger py-4">Error al cargar municipios</td></tr>';
            }
        }
        
        function renderizarMunicipios(datos) {
            const tbody = document.getElementById('tbody-municipalities');
            
            if (!datos || datos.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="5" class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No hay municipios para mostrar</p>
                    </td></tr>`;
                return;
            }
            
            tbody.innerHTML = datos.map(m => `
                <tr>
                    <td><code>${m.municipality_code || '-'}</code></td>
                    <td>${m.municipality_name}</td>
                    <td><span class="badge bg-light text-dark">${m.sup_departments?.department_name || '-'}</span></td>
                    <td>${m.is_active 
                        ? '<span class="badge bg-success">Activo</span>' 
                        : '<span class="badge bg-secondary">Inactivo</span>'}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-primary btn-action me-1" onclick="editarMunicipio('${m.municipality_id}')" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-${m.is_active ? 'warning' : 'success'} btn-action" onclick="toggleMunicipio('${m.municipality_id}', ${m.is_active})" title="${m.is_active ? 'Desactivar' : 'Activar'}">
                            <i class="bi bi-${m.is_active ? 'pause-circle' : 'play-circle'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function abrirModalMunicipio() {
            document.getElementById('modal-municipality-title').innerHTML = '<i class="bi bi-pin-map me-2"></i>Nuevo Municipio';
            document.getElementById('form-municipality').reset();
            document.getElementById('muni-id').value = '';
            document.getElementById('muni-active').checked = true;
            
            // Pre-seleccionar departamento si hay filtro activo
            const filtroActivo = document.getElementById('filter-department').value;
            if (filtroActivo) {
                document.getElementById('muni-department').value = filtroActivo;
            }
            
            modalMuni.show();
        }
        
        function editarMunicipio(id) {
            const muni = cacheMunicipalities.find(m => m.municipality_id === id);
            if (!muni) return;
            
            document.getElementById('modal-municipality-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Municipio';
            document.getElementById('muni-id').value = id;
            document.getElementById('muni-department').value = muni.department_id;
            document.getElementById('muni-code').value = muni.municipality_code || '';
            document.getElementById('muni-name').value = muni.municipality_name;
            document.getElementById('muni-active').checked = muni.is_active;
            modalMuni.show();
        }
        
        async function guardarMunicipio(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-muni');
            btn.disabled = true;
            
            try {
                const id = document.getElementById('muni-id').value;
                const payload = {
                    department_id: document.getElementById('muni-department').value,
                    municipality_code: document.getElementById('muni-code').value.trim(),
                    municipality_name: document.getElementById('muni-name').value.trim(),
                    is_active: document.getElementById('muni-active').checked
                };
                
                if (id) {
                    await supabaseRequest(`/sup_municipalities?municipality_id=eq.${id}`, {
                        method: 'PATCH',
                        body: JSON.stringify(payload)
                    });
                    showMessage('Municipio actualizado', 'success');
                } else {
                    await supabaseRequest('/sup_municipalities', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    showMessage('Municipio creado', 'success');
                }
                
                modalMuni.hide();
                await cargarMunicipios();
                
            } catch (error) {
                console.error('‚ùå Error guardando municipio:', error);
                showMessage('Error: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
            }
        }
        
        async function toggleMunicipio(id, currentState) {
            if (!confirm(`¬ø${currentState ? 'Desactivar' : 'Activar'} este municipio?`)) return;
            
            try {
                await supabaseRequest(`/sup_municipalities?municipality_id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: !currentState })
                });
                showMessage(`Municipio ${currentState ? 'desactivado' : 'activado'}`, 'success');
                await cargarMunicipios();
            } catch (error) {
                showMessage('Error: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // BANCOS
        // ==========================================
        async function cargarBancos() {
            try {
                const data = await supabaseRequest('/sup_banks?select=*&order=bank_name.asc');
                cacheBanks = data || [];
                
                document.getElementById('count-banks').textContent = cacheBanks.length;
                renderizarBancos(cacheBanks);
                
            } catch (error) {
                console.error('‚ùå Error cargando bancos:', error);
                document.getElementById('tbody-banks').innerHTML = 
                    '<tr><td colspan="4" class="text-center text-danger py-4">Error al cargar bancos</td></tr>';
            }
        }
        
        function renderizarBancos(datos) {
            const tbody = document.getElementById('tbody-banks');
            
            if (!datos || datos.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="4" class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No hay bancos registrados</p>
                    </td></tr>`;
                return;
            }
            
            tbody.innerHTML = datos.map(b => `
                <tr>
                    <td><code>${b.bank_code || '-'}</code></td>
                    <td>${b.bank_name}</td>
                    <td>${b.is_active 
                        ? '<span class="badge bg-success">Activo</span>' 
                        : '<span class="badge bg-secondary">Inactivo</span>'}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-primary btn-action me-1" onclick="editarBanco('${b.bank_id}')" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-${b.is_active ? 'warning' : 'success'} btn-action" onclick="toggleBanco('${b.bank_id}', ${b.is_active})" title="${b.is_active ? 'Desactivar' : 'Activar'}">
                            <i class="bi bi-${b.is_active ? 'pause-circle' : 'play-circle'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function abrirModalBanco() {
            document.getElementById('modal-bank-title').innerHTML = '<i class="bi bi-bank me-2"></i>Nuevo Banco';
            document.getElementById('form-bank').reset();
            document.getElementById('bank-id').value = '';
            document.getElementById('bank-active').checked = true;
            modalBank.show();
        }
        
        function editarBanco(id) {
            const bank = cacheBanks.find(b => b.bank_id === id);
            if (!bank) return;
            
            document.getElementById('modal-bank-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Banco';
            document.getElementById('bank-id').value = id;
            document.getElementById('bank-code').value = bank.bank_code || '';
            document.getElementById('bank-name').value = bank.bank_name;
            document.getElementById('bank-active').checked = bank.is_active;
            modalBank.show();
        }
        
        async function guardarBanco(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-bank');
            btn.disabled = true;
            
            try {
                const id = document.getElementById('bank-id').value;
                const payload = {
                    bank_name: document.getElementById('bank-name').value.trim(),
                    bank_code: document.getElementById('bank-code').value.trim() || null,
                    is_active: document.getElementById('bank-active').checked
                };
                
                if (id) {
                    await supabaseRequest(`/sup_banks?bank_id=eq.${id}`, {
                        method: 'PATCH',
                        body: JSON.stringify(payload)
                    });
                    showMessage('Banco actualizado', 'success');
                } else {
                    await supabaseRequest('/sup_banks', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    showMessage('Banco creado', 'success');
                }
                
                modalBank.hide();
                await cargarBancos();
                
            } catch (error) {
                console.error('‚ùå Error guardando banco:', error);
                showMessage('Error: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
            }
        }
        
        async function toggleBanco(id, currentState) {
            if (!confirm(`¬ø${currentState ? 'Desactivar' : 'Activar'} este banco?`)) return;
            
            try {
                await supabaseRequest(`/sup_banks?bank_id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: !currentState })
                });
                showMessage(`Banco ${currentState ? 'desactivado' : 'activado'}`, 'success');
                await cargarBancos();
            } catch (error) {
                showMessage('Error: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // CIIU
        // ==========================================
        async function cargarCIIU() {
            try {
                const data = await supabaseRequest('/sup_ciiu_activities?select=*&order=ciiu_code.asc&limit=5000');
                cacheCIIU = data || [];
                
                document.getElementById('count-ciiu').textContent = cacheCIIU.length;
                renderizarCIIU(cacheCIIU);
                
                // Poblar select de secciones
                poblarSeccionesCIIU();
                
            } catch (error) {
                console.error('‚ùå Error cargando CIIU:', error);
                document.getElementById('tbody-ciiu').innerHTML = 
                    '<tr><td colspan="5" class="text-center text-danger py-4">Error al cargar actividades CIIU</td></tr>';
            }
        }
        
        function renderizarCIIU(datos) {
            const tbody = document.getElementById('tbody-ciiu');
            
            if (!datos || datos.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="5" class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No hay actividades CIIU registradas</p>
                    </td></tr>`;
                return;
            }
            
            // Limitar renderizado a 200 registros para rendimiento
            const datosVisibles = datos.slice(0, 200);
            const hayMas = datos.length > 200;
            
            tbody.innerHTML = datosVisibles.map(c => `
                <tr>
                    <td><code>${c.ciiu_code}</code></td>
                    <td>${c.ciiu_description}</td>
                    <td>${c.ciiu_section ? `<span class="badge bg-light text-dark">${c.ciiu_section}</span>` : '-'}</td>
                    <td>${c.is_active 
                        ? '<span class="badge bg-success">Activo</span>' 
                        : '<span class="badge bg-secondary">Inactivo</span>'}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-primary btn-action me-1" onclick="editarCIIU('${c.ciiu_id}')" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-${c.is_active ? 'warning' : 'success'} btn-action" onclick="toggleCIIU('${c.ciiu_id}', ${c.is_active})" title="${c.is_active ? 'Desactivar' : 'Activar'}">
                            <i class="bi bi-${c.is_active ? 'pause-circle' : 'play-circle'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            if (hayMas) {
                tbody.innerHTML += `
                    <tr><td colspan="5" class="text-center text-info py-2">
                        <i class="bi bi-info-circle me-1"></i>
                        Mostrando ${datosVisibles.length} de ${datos.length} registros. Use los filtros para encontrar registros espec√≠ficos.
                    </td></tr>`;
            }
        }
        
        function poblarSeccionesCIIU() {
            const secciones = [...new Set(cacheCIIU.map(c => c.ciiu_section).filter(Boolean))].sort();
            const select = document.getElementById('filter-ciiu-section');
            select.innerHTML = '<option value="">Todas las secciones</option>' +
                secciones.map(s => `<option value="${s}">${s}</option>`).join('');
        }
        
        function filtrarCIIUPorSeccion() {
            const seccion = document.getElementById('filter-ciiu-section').value;
            const textoBusqueda = document.getElementById('search-ciiu').value.toLowerCase();
            
            let filtrados = cacheCIIU;
            
            if (seccion) {
                filtrados = filtrados.filter(c => c.ciiu_section === seccion);
            }
            
            if (textoBusqueda) {
                filtrados = filtrados.filter(c => 
                    c.ciiu_code.toLowerCase().includes(textoBusqueda) ||
                    c.ciiu_description.toLowerCase().includes(textoBusqueda)
                );
            }
            
            document.getElementById('count-ciiu').textContent = filtrados.length;
            renderizarCIIU(filtrados);
        }
        
        function abrirModalCIIU() {
            document.getElementById('modal-ciiu-title').innerHTML = '<i class="bi bi-tags me-2"></i>Nueva Actividad CIIU';
            document.getElementById('form-ciiu').reset();
            document.getElementById('ciiu-id').value = '';
            document.getElementById('ciiu-active').checked = true;
            modalCIIU.show();
        }
        
        function editarCIIU(id) {
            const ciiu = cacheCIIU.find(c => c.ciiu_id === id);
            if (!ciiu) return;
            
            document.getElementById('modal-ciiu-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Actividad CIIU';
            document.getElementById('ciiu-id').value = id;
            document.getElementById('ciiu-code').value = ciiu.ciiu_code;
            document.getElementById('ciiu-description').value = ciiu.ciiu_description;
            document.getElementById('ciiu-section').value = ciiu.ciiu_section || '';
            document.getElementById('ciiu-active').checked = ciiu.is_active;
            modalCIIU.show();
        }
        
        async function guardarCIIU(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-ciiu');
            btn.disabled = true;
            
            try {
                const id = document.getElementById('ciiu-id').value;
                const payload = {
                    ciiu_code: document.getElementById('ciiu-code').value.trim(),
                    ciiu_description: document.getElementById('ciiu-description').value.trim(),
                    ciiu_section: document.getElementById('ciiu-section').value.trim() || null,
                    is_active: document.getElementById('ciiu-active').checked
                };
                
                if (id) {
                    await supabaseRequest(`/sup_ciiu_activities?ciiu_id=eq.${id}`, {
                        method: 'PATCH',
                        body: JSON.stringify(payload)
                    });
                    showMessage('Actividad CIIU actualizada', 'success');
                } else {
                    await supabaseRequest('/sup_ciiu_activities', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    showMessage('Actividad CIIU creada', 'success');
                }
                
                modalCIIU.hide();
                await cargarCIIU();
                
            } catch (error) {
                console.error('‚ùå Error guardando CIIU:', error);
                showMessage('Error: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
            }
        }
        
        async function toggleCIIU(id, currentState) {
            if (!confirm(`¬ø${currentState ? 'Desactivar' : 'Activar'} esta actividad CIIU?`)) return;
            
            try {
                await supabaseRequest(`/sup_ciiu_activities?ciiu_id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: !currentState })
                });
                showMessage(`Actividad CIIU ${currentState ? 'desactivada' : 'activada'}`, 'success');
                await cargarCIIU();
            } catch (error) {
                showMessage('Error: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // FILTRO DE B√öSQUEDA GEN√âRICO
        // ==========================================
        function filtrarTabla(tipo) {
            const texto = document.getElementById(`search-${tipo}`).value.toLowerCase();
            
            if (tipo === 'departments') {
                const filtrados = cacheDepartments.filter(d => 
                    d.department_name.toLowerCase().includes(texto) ||
                    (d.department_code || '').toLowerCase().includes(texto)
                );
                renderizarDepartamentos(filtrados);
                
            } else if (tipo === 'municipalities') {
                const filtrados = cacheMunicipalities.filter(m => 
                    m.municipality_name.toLowerCase().includes(texto) ||
                    (m.municipality_code || '').toLowerCase().includes(texto) ||
                    (m.sup_departments?.department_name || '').toLowerCase().includes(texto)
                );
                renderizarMunicipios(filtrados);
                
            } else if (tipo === 'banks') {
                const filtrados = cacheBanks.filter(b => 
                    b.bank_name.toLowerCase().includes(texto) ||
                    (b.bank_code || '').toLowerCase().includes(texto)
                );
                renderizarBancos(filtrados);
                
            } else if (tipo === 'ciiu') {
                filtrarCIIUPorSeccion(); // Reutiliza filtro combinado secci√≥n + texto
            }
        }
        
        console.log('‚úÖ Cat√°logos de Proveedores - SchoolNet cargado');
    </script>
</body>
</html>
