<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.19.23.30">
    <title>Portal de Proveedores - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --primary: #1B365D; --success: #198754; --warning: #ffc107; --danger: #dc3545; }
        body { background: #f0f2f5; min-height: 100vh; padding-top: 0 !important; }

        /* Login screen */
        .login-wrapper { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-card { max-width: 440px; width: 100%; border: none; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .login-header { background: var(--primary); color: white; border-radius: 16px 16px 0 0; padding: 2rem; text-align: center; }
        .otp-inputs { display: flex; gap: 8px; justify-content: center; }
        .otp-inputs input { width: 48px; height: 56px; text-align: center; font-size: 1.5rem; font-weight: 700; border: 2px solid #dee2e6; border-radius: 10px; }
        .otp-inputs input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(27,54,93,0.15); }
        .btn-brand { background: var(--primary); color: white; border: none; border-radius: 8px; padding: 0.6rem 1.5rem; }
        .btn-brand:hover { background: #152a4a; color: white; }
        .btn-brand:disabled { opacity: 0.6; }

        /* Portal navbar */
        .portal-navbar { background: var(--primary); color: white; padding: 0.75rem 0; position: sticky; top: 0; z-index: 1000; }
        .portal-navbar .supplier-name { font-weight: 600; font-size: 1.1rem; }

        /* Status banners */
        .status-banner { border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem; }
        .status-pending { background: #fff8e1; border-left: 5px solid var(--warning); }
        .status-approved { background: #e8f5e9; border-left: 5px solid var(--success); }
        .status-rejected { background: #fce4ec; border-left: 5px solid var(--danger); }
        .status-icon { font-size: 2rem; }

        /* Tabs */
        .nav-pills .nav-link { color: #495057; border-radius: 8px; padding: 0.5rem 1rem; font-size: 0.9rem; }
        .nav-pills .nav-link.active { background: var(--primary); color: white; }
        .tab-content { background: white; border-radius: 0 0 12px 12px; padding: 1.5rem; border: 1px solid #e9ecef; border-top: none; }

        /* Document cards */
        .doc-card { border: 1px solid #e9ecef; border-radius: 10px; padding: 1rem; margin-bottom: 0.75rem; }
        .doc-card.has-file { border-color: var(--success); background: #f8fff8; }
        .doc-card .doc-name { font-weight: 600; font-size: 0.95rem; }
        .doc-card .doc-info { font-size: 0.8rem; color: #6c757d; }
        .file-upload-zone { border: 2px dashed #dee2e6; border-radius: 8px; padding: 1rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .file-upload-zone:hover { border-color: var(--primary); background: #f8f9ff; }

        /* Address generator */
        .addr-gen { background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid #e9ecef; }
        .addr-preview { font-family: monospace; font-size: 1rem; background: white; padding: 0.5rem; border-radius: 4px; border: 1px solid #dee2e6; min-height: 2rem; }
        .addr-complement-badge { display: inline-flex; align-items: center; gap: 4px; background: var(--primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin: 2px; }

        /* Responsive */
        @media (max-width: 768px) {
            .otp-inputs input { width: 40px; height: 48px; font-size: 1.2rem; }
            .nav-pills { flex-wrap: nowrap; overflow-x: auto; }
            .nav-pills .nav-link { white-space: nowrap; font-size: 0.8rem; padding: 0.4rem 0.8rem; }
        }
    </style>
</head>

<body>
    <!-- ============================================ -->
    <!-- PANTALLA DE LOGIN OTP                        -->
    <!-- ============================================ -->
    <div id="view-login" class="login-wrapper">
        <div class="card login-card">
            <div class="login-header">
                <i class="bi bi-building" style="font-size: 2.5rem;"></i>
                <h4 class="mt-2 mb-1">Portal de Proveedores</h4>
                <p class="mb-0 opacity-75" id="institution-name">SchoolNet</p>
            </div>
            <div class="card-body p-4">
                <div id="alertContainerLogin"></div>

                <!-- Paso 1: Ingreso de email -->
                <div id="login-step-email">
                    <p class="text-muted text-center mb-3">Ingrese el correo electrónico con el que se registró como proveedor</p>
                    <div class="mb-3">
                        <label class="form-label">Correo electrónico</label>
                        <input type="email" class="form-control" id="login-email" placeholder="proveedor@empresa.com" autofocus>
                    </div>
                    <button class="btn btn-brand w-100" id="btn-send-otp" onclick="enviarOTP()">
                        <i class="bi bi-envelope me-2"></i>Enviar código de acceso
                    </button>
                </div>

                <!-- Paso 2: Ingreso de código OTP -->
                <div id="login-step-otp" style="display:none;">
                    <p class="text-muted text-center mb-2">Ingrese el código de 6 dígitos que enviamos a:</p>
                    <p class="text-center fw-bold mb-3" id="otp-email-display"></p>
                    <div class="otp-inputs mb-3" id="otp-container">
                        <input type="text" maxlength="1" inputmode="numeric" data-pos="0">
                        <input type="text" maxlength="1" inputmode="numeric" data-pos="1">
                        <input type="text" maxlength="1" inputmode="numeric" data-pos="2">
                        <input type="text" maxlength="1" inputmode="numeric" data-pos="3">
                        <input type="text" maxlength="1" inputmode="numeric" data-pos="4">
                        <input type="text" maxlength="1" inputmode="numeric" data-pos="5">
                    </div>
                    <button class="btn btn-brand w-100 mb-2" id="btn-verify-otp" onclick="verificarOTP()">
                        <i class="bi bi-shield-check me-2"></i>Verificar código
                    </button>
                    <div class="text-center mt-2">
                        <button class="btn btn-link text-muted btn-sm" id="btn-resend" onclick="reenviarOTP()" disabled>
                            Reenviar código (<span id="resend-timer">60</span>s)
                        </button>
                    </div>
                    <div class="text-center mt-1">
                        <button class="btn btn-link text-muted btn-sm" onclick="volverAEmail()">
                            <i class="bi bi-arrow-left me-1"></i>Cambiar correo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- PORTAL DEL PROVEEDOR (oculto hasta login)   -->
    <!-- ============================================ -->
    <div id="view-portal" style="display:none;">

        <!-- Navbar -->
        <nav class="portal-navbar">
            <div class="container-fluid d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-building" style="font-size: 1.3rem;"></i>
                    <span class="supplier-name" id="portal-supplier-name">Proveedor</span>
                </div>
                <button class="btn btn-sm btn-outline-light" onclick="cerrarSesion()">
                    <i class="bi bi-box-arrow-right me-1"></i>Cerrar sesión
                </button>
            </div>
        </nav>

        <div class="container-fluid py-3">
            <div id="alertContainer"></div>

            <!-- Banner de estado -->
            <div id="status-banner"></div>

            <!-- Tabs de navegación -->
            <ul class="nav nav-pills mb-0 bg-white p-2 rounded-top border border-bottom-0" id="portal-tabs">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#tab-identification"><i class="bi bi-person-vcard me-1"></i>Identificación</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-contact"><i class="bi bi-geo-alt me-1"></i>Contacto</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-fiscal"><i class="bi bi-receipt me-1"></i>Fiscal</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-bank"><i class="bi bi-bank me-1"></i>Bancaria</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-docs"><i class="bi bi-paperclip me-1"></i>Documentos</a></li>
            </ul>

            <div class="tab-content" id="portal-tab-content">

                <!-- ============================================ -->
                <!-- TAB: IDENTIFICACIÓN                          -->
                <!-- ============================================ -->
                <div class="tab-pane fade show active" id="tab-identification">
                    <!-- Persona Natural -->
                    <div id="portal-fields-natural" style="display:none;">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Tipo de documento <span class="text-danger">*</span></label>
                                <select class="form-select" id="p-doc-type">
                                    <option value="">Seleccione...</option>
                                    <option value="CC">Cédula de Ciudadanía</option>
                                    <option value="CE">Cédula de Extranjería</option>
                                    <option value="Pasaporte">Pasaporte</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Número de documento <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="p-doc-number" maxlength="20">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Primer nombre <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="p-first-name" maxlength="100">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Segundo nombre</label>
                                <input type="text" class="form-control" id="p-second-name" maxlength="100">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Primer apellido <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="p-last-name-1" maxlength="100">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Segundo apellido</label>
                                <input type="text" class="form-control" id="p-last-name-2" maxlength="100">
                            </div>
                        </div>
                    </div>
                    <!-- Persona Jurídica -->
                    <div id="portal-fields-juridica" style="display:none;">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label">Razón Social <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="p-business-name" maxlength="250">
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">NIT (sin dígito de verificación) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="p-nit" maxlength="15" oninput="calcularDV()">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">DV</label>
                                <input type="text" class="form-control" id="p-nit-dv" readonly style="font-size:1.2rem; text-align:center; font-weight:700;">
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Nombre de contacto <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="p-contact-name" maxlength="200">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================ -->
                <!-- TAB: CONTACTO Y UBICACIÓN                   -->
                <!-- ============================================ -->
                <div class="tab-pane fade" id="tab-contact">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Teléfono <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="p-phone" maxlength="20">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Correo electrónico</label>
                            <input type="email" class="form-control" id="p-email" readonly style="background: #f8f9fa;">
                            <small class="text-muted">El correo no se puede modificar</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Departamento <span class="text-danger">*</span></label>
                            <select class="form-select" id="p-department" onchange="cargarMunicipios()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Municipio <span class="text-danger">*</span></label>
                            <select class="form-select" id="p-municipality" disabled>
                                <option value="">Primero seleccione departamento</option>
                            </select>
                        </div>
                    </div>

                    <!-- Generador de dirección DIAN -->
                    <div class="mt-4">
                        <label class="form-label fw-bold"><i class="bi bi-signpost-2 me-1"></i>Dirección <span class="text-danger">*</span></label>
                        <div class="addr-gen">
                            <div class="row g-2 mb-2">
                                <div class="col-md-3">
                                    <label class="form-label small">Tipo de vía</label>
                                    <select class="form-select form-select-sm" id="addr-via-type" onchange="generarDireccion()">
                                        <option value="">Seleccione...</option>
                                        <option value="CL">Calle</option><option value="CR">Carrera</option>
                                        <option value="DG">Diagonal</option><option value="TV">Transversal</option>
                                        <option value="AC">Avenida Calle</option><option value="AK">Avenida Carrera</option>
                                        <option value="AV">Avenida</option><option value="CIR">Circular</option>
                                        <option value="AUT">Autopista</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Nº Vía</label>
                                    <input type="text" class="form-control form-control-sm" id="addr-via-num" maxlength="10" oninput="generarDireccion()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Letra</label>
                                    <select class="form-select form-select-sm" id="addr-via-letter" onchange="generarDireccion()">
                                        <option value=""></option><option>A</option><option>B</option><option>C</option>
                                        <option>D</option><option>E</option><option>F</option><option>BIS</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Cuadrante</label>
                                    <select class="form-select form-select-sm" id="addr-via-quad" onchange="generarDireccion()">
                                        <option value=""></option><option value="NORTE">Norte</option><option value="SUR">Sur</option>
                                        <option value="ESTE">Este</option><option value="OESTE">Oeste</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-md-2">
                                    <label class="form-label small">Número</label>
                                    <input type="text" class="form-control form-control-sm" id="addr-number" maxlength="10" oninput="generarDireccion()">
                                </div>
                                <div class="col-md-1 d-flex align-items-end pb-1 justify-content-center"><strong class="text-muted">—</strong></div>
                                <div class="col-md-2">
                                    <label class="form-label small">Placa</label>
                                    <input type="text" class="form-control form-control-sm" id="addr-plate" maxlength="10" oninput="generarDireccion()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Letra</label>
                                    <select class="form-select form-select-sm" id="addr-plate-letter" onchange="generarDireccion()">
                                        <option value=""></option><option>A</option><option>B</option><option>C</option>
                                        <option>D</option><option>E</option><option>F</option><option>BIS</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Cuadrante</label>
                                    <select class="form-select form-select-sm" id="addr-plate-quad" onchange="generarDireccion()">
                                        <option value=""></option><option value="SUR">Sur</option><option value="NORTE">Norte</option>
                                        <option value="ESTE">Este</option><option value="OESTE">Oeste</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-md-3">
                                    <label class="form-label small">Complemento</label>
                                    <select class="form-select form-select-sm" id="addr-comp-type">
                                        <option value="">Agregar...</option>
                                        <option value="AP">Apartamento</option><option value="OF">Oficina</option>
                                        <option value="LC">Local</option><option value="P">Piso</option>
                                        <option value="TO">Torre</option><option value="BL">Bloque</option>
                                        <option value="ED">Edificio</option><option value="CA">Casa</option>
                                        <option value="BG">Bodega</option><option value="IN">Interior</option>
                                        <option value="EN">Entrada</option><option value="CON">Conjunto</option>
                                        <option value="CC">Centro Comercial</option><option value="PQ">Parqueadero</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Valor</label>
                                    <input type="text" class="form-control form-control-sm" id="addr-comp-value" maxlength="30">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="agregarComplemento()">
                                        <i class="bi bi-plus"></i> Agregar
                                    </button>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <div id="addr-complements-list" class="d-flex flex-wrap"></div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="form-label small text-muted">Dirección generada:</label>
                                <div class="addr-preview" id="addr-preview">—</div>
                                <input type="hidden" id="p-address-formatted">
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Referencia / Información adicional</label>
                        <input type="text" class="form-control" id="p-address-reference" maxlength="300"
                               placeholder="Barrio, urbanización, punto de referencia, etc.">
                    </div>
                </div>

                <!-- ============================================ -->
                <!-- TAB: INFORMACIÓN FISCAL                      -->
                <!-- ============================================ -->
                <div class="tab-pane fade" id="tab-fiscal">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label">Actividad económica CIIU <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="p-ciiu-search" placeholder="Buscar por código o descripción..." oninput="buscarCIIU()">
                                <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('p-ciiu-search').value='';buscarCIIU();">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                            <select class="form-select mt-1" id="p-ciiu" size="4" style="display:none;"></select>
                            <input type="hidden" id="p-ciiu-selected">
                            <div id="p-ciiu-label" class="small text-success mt-1" style="display:none;"></div>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Productos o servicios <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="p-products-services" rows="2" maxlength="1000"></textarea>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Régimen tributario <span class="text-danger">*</span></label>
                            <div id="p-regimes-container">Cargando...</div>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Condiciones tributarias</label>
                            <small class="text-muted d-block mb-2">Marque todas las que apliquen</small>
                            <div id="p-conditions-container">Cargando...</div>
                        </div>
                    </div>
                </div>

                <!-- ============================================ -->
                <!-- TAB: INFORMACIÓN BANCARIA                    -->
                <!-- ============================================ -->
                <div class="tab-pane fade" id="tab-bank">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label">Entidad bancaria <span class="text-danger">*</span></label>
                            <select class="form-select" id="p-bank">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tipo de cuenta <span class="text-danger">*</span></label>
                            <select class="form-select" id="p-account-type">
                                <option value="">Seleccione...</option>
                                <option value="Ahorros">Ahorros</option>
                                <option value="Corriente">Corriente</option>
                                <option value="Cuenta en el exterior">Cuenta en el exterior</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Número de cuenta <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="p-account-number" maxlength="30">
                        </div>
                    </div>
                </div>

                <!-- ============================================ -->
                <!-- TAB: DOCUMENTOS ADJUNTOS                     -->
                <!-- ============================================ -->
                <div class="tab-pane fade" id="tab-docs">
                    <p class="text-muted">Gestione sus documentos adjuntos. Puede reemplazar documentos existentes o subir nuevos.</p>
                    <div id="p-docs-container">Cargando...</div>
                </div>

            </div><!-- /tab-content -->

            <!-- Barra de acciones -->
            <div class="bg-white border rounded-bottom p-3 mb-4 d-flex justify-content-between align-items-center" id="action-bar" style="display:none !important;">
                <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Los cambios se guardan al presionar el botón</small>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" id="btn-save" onclick="guardarCambios()">
                        <i class="bi bi-check-circle me-1"></i>Guardar cambios
                    </button>
                    <button class="btn btn-warning d-none" id="btn-resubmit" onclick="reenviarSolicitud()">
                        <i class="bi bi-send me-1"></i>Corregir y Reenviar
                    </button>
                </div>
            </div>

        </div><!-- /container-fluid -->
    </div><!-- /view-portal -->

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // CONSTANTES Y VARIABLES GLOBALES
        // ==========================================
        const STORAGE_BUCKET = 'supplier-files';
        const OTP_LENGTH = 6;
        const OTP_EXPIRY_MINUTES = 10;
        const OTP_MAX_ATTEMPTS = 5;
        const OTP_COOLDOWN_SECONDS = 60;
        const SESSION_DURATION_HOURS = 1;
        const SESSION_KEY = 'supplierPortalSession';

        let supabaseClient;
        let currentSupplier = null;
        let catalogData = { departments: [], banks: [], ciiu: [], regimes: [], conditions: [], attachmentTypes: [] };
        let supplierConditions = [];
        let supplierAttachments = [];
        let newFiles = {}; // { attachment_type_id: File }
        let addressComplements = [];
        let resendInterval = null;

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Inicializar Supabase Client para Storage
                supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);

                // Aplicar nombre de institución
                document.getElementById('institution-name').textContent = APP_CONFIG.institution?.name || 'SchoolNet';

                // Configurar inputs OTP
                configurarInputsOTP();

                // Verificar sesión existente
                const session = getPortalSession();
                if (session) {
                    await iniciarPortal(session.supplier_id, session.email);
                }
            } catch (error) {
                console.error('❌ Error en inicialización:', error);
            }
        });

        // ==========================================
        // SESIÓN DEL PORTAL
        // ==========================================
        function getPortalSession() {
            try {
                const data = localStorage.getItem(SESSION_KEY);
                if (!data) return null;
                const session = JSON.parse(data);
                if (new Date() > new Date(session.expires_at)) {
                    localStorage.removeItem(SESSION_KEY);
                    return null;
                }
                return session;
            } catch { return null; }
        }

        function setPortalSession(supplierId, email) {
            const expires = new Date();
            expires.setHours(expires.getHours() + SESSION_DURATION_HOURS);
            localStorage.setItem(SESSION_KEY, JSON.stringify({
                supplier_id: supplierId,
                email: email,
                expires_at: expires.toISOString()
            }));
        }

        function cerrarSesion() {
            localStorage.removeItem(SESSION_KEY);
            window.location.reload();
        }

        // ==========================================
        // FLUJO OTP
        // ==========================================
        function configurarInputsOTP() {
            const inputs = document.querySelectorAll('#otp-container input');
            inputs.forEach((input, i) => {
                input.addEventListener('input', (e) => {
                    const val = e.target.value.replace(/\D/g, '');
                    e.target.value = val;
                    if (val && i < inputs.length - 1) inputs[i + 1].focus();
                    if (i === inputs.length - 1 && val) verificarOTP();
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && i > 0) inputs[i - 1].focus();
                });
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '').slice(0, OTP_LENGTH);
                    text.split('').forEach((ch, idx) => { if (inputs[idx]) inputs[idx].value = ch; });
                    if (text.length === OTP_LENGTH) verificarOTP();
                });
            });
        }

        function getOTPValue() {
            return Array.from(document.querySelectorAll('#otp-container input')).map(i => i.value).join('');
        }

        async function enviarOTP() {
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            if (!email || !email.includes('@')) {
                showMessage('Ingrese un correo electrónico válido', 'warning', 'alertContainerLogin');
                return;
            }

            const btn = document.getElementById('btn-send-otp');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verificando...';

            try {
                // 1. Verificar que el email existe en proveedores
                const suppliers = await supabaseRequest(`/sup_suppliers?select=supplier_id,email&email=eq.${email}`);
                if (!suppliers || suppliers.length === 0) {
                    showMessage('No se encontró un proveedor registrado con ese correo', 'danger', 'alertContainerLogin');
                    return;
                }
                const supplierId = suppliers[0].supplier_id;

                // 2. Rate limiting: max 3 OTPs en últimos 30 min
                const thirtyMinAgo = new Date(Date.now() - 30 * 60 * 1000).toISOString();
                const recentOTPs = await supabaseRequest(
                    `/sup_otp_codes?select=otp_id&supplier_id=eq.${supplierId}&created_at=gte.${thirtyMinAgo}`
                );
                if (recentOTPs && recentOTPs.length >= 3) {
                    showMessage('Ha solicitado demasiados códigos. Espere 30 minutos antes de intentar nuevamente.', 'warning', 'alertContainerLogin');
                    return;
                }

                // 3. Generar código de 6 dígitos
                const code = String(Math.floor(100000 + Math.random() * 900000));
                const expiresAt = new Date(Date.now() + OTP_EXPIRY_MINUTES * 60 * 1000).toISOString();

                // 4. Guardar en BD
                await supabaseRequest('/sup_otp_codes', {
                    method: 'POST',
                    body: JSON.stringify({
                        supplier_id: supplierId,
                        otp_code: code,
                        expires_at: expiresAt,
                        attempts: 0
                    })
                });

                // 5. Enviar por email
                const emailHTML = getOTPEmailTemplate(code);
                await sendNotification(email, 'Código de acceso - Portal de Proveedores', emailHTML);

                // 6. Mostrar pantalla de código
                document.getElementById('login-step-email').style.display = 'none';
                document.getElementById('login-step-otp').style.display = 'block';
                document.getElementById('otp-email-display').textContent = email;
                document.querySelector('#otp-container input').focus();

                iniciarTimerReenvio();
                console.log('✅ OTP enviado a:', email);

            } catch (error) {
                console.error('❌ Error enviando OTP:', error);
                showMessage('Error al enviar el código. Intente nuevamente.', 'danger', 'alertContainerLogin');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-envelope me-2"></i>Enviar código de acceso';
            }
        }

        async function verificarOTP() {
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const code = getOTPValue();
            if (code.length !== OTP_LENGTH) return;

            const btn = document.getElementById('btn-verify-otp');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verificando...';

            try {
                // Buscar proveedor
                const suppliers = await supabaseRequest(`/sup_suppliers?select=supplier_id&email=eq.${email}`);
                if (!suppliers || suppliers.length === 0) throw new Error('Proveedor no encontrado');
                const supplierId = suppliers[0].supplier_id;

                // Buscar OTP válido (no usado, no expirado, más reciente)
                const otps = await supabaseRequest(
                    `/sup_otp_codes?select=*&supplier_id=eq.${supplierId}&is_used=eq.false&expires_at=gte.${new Date().toISOString()}&order=created_at.desc&limit=1`
                );

                if (!otps || otps.length === 0) {
                    showMessage('Código expirado o inválido. Solicite uno nuevo.', 'danger', 'alertContainerLogin');
                    return;
                }

                const otp = otps[0];

                // Verificar intentos
                if (otp.attempts >= OTP_MAX_ATTEMPTS) {
                    // Invalidar el OTP
                    await supabaseRequest(`/sup_otp_codes?otp_id=eq.${otp.otp_id}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ is_used: true })
                    });
                    showMessage('Demasiados intentos fallidos. Solicite un nuevo código.', 'danger', 'alertContainerLogin');
                    return;
                }

                // Verificar código
                if (otp.otp_code !== code) {
                    // Incrementar intentos
                    await supabaseRequest(`/sup_otp_codes?otp_id=eq.${otp.otp_id}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ attempts: otp.attempts + 1 })
                    });
                    const remaining = OTP_MAX_ATTEMPTS - otp.attempts - 1;
                    showMessage(`Código incorrecto. ${remaining} intento(s) restante(s).`, 'warning', 'alertContainerLogin');
                    // Limpiar inputs
                    document.querySelectorAll('#otp-container input').forEach(i => i.value = '');
                    document.querySelector('#otp-container input').focus();
                    return;
                }

                // ¡Código correcto! Marcar como usado
                await supabaseRequest(`/sup_otp_codes?otp_id=eq.${otp.otp_id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_used: true, used_at: new Date().toISOString() })
                });

                // Crear sesión
                setPortalSession(supplierId, email);

                // Ir al portal
                await iniciarPortal(supplierId, email);

            } catch (error) {
                console.error('❌ Error verificando OTP:', error);
                showMessage('Error al verificar el código.', 'danger', 'alertContainerLogin');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-shield-check me-2"></i>Verificar código';
            }
        }

        function volverAEmail() {
            document.getElementById('login-step-otp').style.display = 'none';
            document.getElementById('login-step-email').style.display = 'block';
            document.querySelectorAll('#otp-container input').forEach(i => i.value = '');
            if (resendInterval) clearInterval(resendInterval);
        }

        function iniciarTimerReenvio() {
            let seconds = OTP_COOLDOWN_SECONDS;
            const btn = document.getElementById('btn-resend');
            const timer = document.getElementById('resend-timer');
            btn.disabled = true;

            if (resendInterval) clearInterval(resendInterval);
            resendInterval = setInterval(() => {
                seconds--;
                timer.textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(resendInterval);
                    btn.disabled = false;
                    btn.textContent = 'Reenviar código';
                }
            }, 1000);
        }

        async function reenviarOTP() {
            await enviarOTP();
        }

        function getOTPEmailTemplate(code) {
            return `
            <div style="font-family: Arial, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px;">
                <div style="background: #1B365D; color: white; padding: 25px; text-align: center; border-radius: 12px 12px 0 0;">
                    <h2 style="margin: 0;">Portal de Proveedores</h2>
                    <p style="margin: 5px 0 0; opacity: 0.8;">${APP_CONFIG.institution?.name || 'SchoolNet'}</p>
                </div>
                <div style="background: white; padding: 30px; border: 1px solid #e9ecef; border-top: none; border-radius: 0 0 12px 12px;">
                    <p>Su código de acceso es:</p>
                    <div style="text-align: center; margin: 25px 0;">
                        <span style="font-size: 2.5rem; font-weight: 800; letter-spacing: 10px; color: #1B365D; background: #f0f2f5; padding: 15px 25px; border-radius: 10px; display: inline-block;">${code}</span>
                    </div>
                    <p style="color: #6c757d; font-size: 0.9rem;">Este código es válido por <strong>${OTP_EXPIRY_MINUTES} minutos</strong>. No lo comparta con nadie.</p>
                    <p style="color: #6c757d; font-size: 0.9rem;">Si usted no solicitó este código, ignore este mensaje.</p>
                </div>
                <p style="color: #adb5bd; font-size: 0.75rem; text-align: center; margin-top: 15px;">
                    Este correo fue generado automáticamente. No responda a este mensaje.
                </p>
            </div>`;
        }

        // ==========================================
        // INICIAR PORTAL
        // ==========================================
        async function iniciarPortal(supplierId, email) {
            try {
                // Ocultar login, mostrar portal
                document.getElementById('view-login').style.display = 'none';
                document.getElementById('view-portal').style.display = 'block';

                // Cargar catálogos en paralelo
                const [departments, banks, ciiu, regimes, conditions, attachmentTypes] = await Promise.all([
                    supabaseRequest('/sup_departments?select=department_id,department_name&is_active=eq.true&order=department_name'),
                    supabaseRequest('/sup_banks?select=bank_id,bank_name&is_active=eq.true&order=bank_name'),
                    supabaseRequest('/sup_ciiu_activities?select=ciiu_id,ciiu_code,ciiu_description&is_active=eq.true&order=ciiu_code'),
                    supabaseRequest('/sup_tax_regimes?select=regime_id,regime_name&is_active=eq.true&order=regime_order'),
                    supabaseRequest('/sup_tax_conditions?select=condition_id,condition_name,applies_to&is_active=eq.true&order=condition_order'),
                    supabaseRequest('/sup_attachment_types?select=*&is_active=eq.true&order=type_order')
                ]);
                catalogData = { departments, banks, ciiu, regimes, conditions, attachmentTypes };

                // Poblar selects de catálogos
                poblarSelectDepartamentos();
                poblarSelectBancos();
                renderRegimenes();

                // Cargar datos del proveedor
                const suppliers = await supabaseRequest(
                    `/sup_suppliers?select=*&supplier_id=eq.${supplierId}`
                );
                if (!suppliers || suppliers.length === 0) throw new Error('Proveedor no encontrado');
                currentSupplier = suppliers[0];

                // Cargar condiciones y adjuntos
                supplierConditions = await supabaseRequest(
                    `/sup_supplier_tax_conditions?select=condition_id&supplier_id=eq.${supplierId}`
                );
                supplierAttachments = await supabaseRequest(
                    `/sup_supplier_attachments?select=*,sup_attachment_types(type_name)&supplier_id=eq.${supplierId}`
                );

                // Poblar formulario
                poblarFormulario();

                // Mostrar barra de acciones
                document.getElementById('action-bar').style.display = '';
                document.getElementById('action-bar').style.removeProperty('display');

                console.log('✅ Portal cargado para:', email);

            } catch (error) {
                console.error('❌ Error cargando portal:', error);
                showMessage('Error al cargar sus datos. Intente nuevamente.', 'danger');
            }
        }

        // ==========================================
        // POBLAR FORMULARIO
        // ==========================================
        function poblarFormulario() {
            const s = currentSupplier;

            // Nombre en navbar
            const nombre = s.person_type === 'juridica' ? s.business_name : [s.first_name, s.last_name_1].filter(Boolean).join(' ');
            document.getElementById('portal-supplier-name').textContent = nombre || 'Proveedor';

            // Banner de estado
            renderStatusBanner(s.supplier_status, s.rejection_reason);

            // Mostrar/ocultar campos según tipo persona
            if (s.person_type === 'natural') {
                document.getElementById('portal-fields-natural').style.display = 'block';
                document.getElementById('portal-fields-juridica').style.display = 'none';
                document.getElementById('p-doc-type').value = s.document_type || '';
                document.getElementById('p-doc-number').value = s.document_number || '';
                document.getElementById('p-first-name').value = s.first_name || '';
                document.getElementById('p-second-name').value = s.second_name || '';
                document.getElementById('p-last-name-1').value = s.last_name_1 || '';
                document.getElementById('p-last-name-2').value = s.last_name_2 || '';
            } else {
                document.getElementById('portal-fields-natural').style.display = 'none';
                document.getElementById('portal-fields-juridica').style.display = 'block';
                document.getElementById('p-business-name').value = s.business_name || '';
                document.getElementById('p-nit').value = s.nit || '';
                document.getElementById('p-nit-dv').value = s.nit_verification_digit || '';
                document.getElementById('p-contact-name').value = s.contact_name || '';
            }

            // Contacto
            document.getElementById('p-phone').value = s.phone || '';
            document.getElementById('p-email').value = s.email || '';

            // Departamento y municipio
            if (s.department_id) {
                document.getElementById('p-department').value = s.department_id;
                cargarMunicipios(s.municipality_id);
            }

            // Dirección: mostrar en preview
            document.getElementById('p-address-formatted').value = s.address || '';
            document.getElementById('addr-preview').textContent = s.address || '—';
            document.getElementById('p-address-reference').value = s.address_reference || '';

            // Fiscal
            if (s.ciiu_id) {
                document.getElementById('p-ciiu-selected').value = s.ciiu_id;
                const ciiu = catalogData.ciiu.find(c => c.ciiu_id === s.ciiu_id);
                if (ciiu) {
                    const label = document.getElementById('p-ciiu-label');
                    label.style.display = 'block';
                    label.innerHTML = `<i class="bi bi-check-circle me-1"></i>${ciiu.ciiu_code} - ${ciiu.ciiu_description}`;
                }
            }
            document.getElementById('p-products-services').value = s.products_services || '';

            // Régimen
            if (s.tax_regime_id) {
                const radio = document.querySelector(`input[name="p-regime"][value="${s.tax_regime_id}"]`);
                if (radio) radio.checked = true;
            }

            // Condiciones tributarias
            renderCondiciones(s.person_type);
            supplierConditions.forEach(sc => {
                const cb = document.querySelector(`input[name="p-condition"][value="${sc.condition_id}"]`);
                if (cb) cb.checked = true;
            });

            // Bancaria
            if (s.bank_id) document.getElementById('p-bank').value = s.bank_id;
            if (s.account_type) document.getElementById('p-account-type').value = s.account_type;
            document.getElementById('p-account-number').value = s.account_number || '';

            // Documentos
            renderDocumentos(s.person_type);

            // Botones según estado
            const btnSave = document.getElementById('btn-save');
            const btnResubmit = document.getElementById('btn-resubmit');
            if (s.supplier_status === 'rejected') {
                btnSave.classList.add('d-none');
                btnResubmit.classList.remove('d-none');
            } else {
                btnSave.classList.remove('d-none');
                btnResubmit.classList.add('d-none');
            }
        }

        // ==========================================
        // BANNER DE ESTADO
        // ==========================================
        function renderStatusBanner(status, rejectionReason) {
            const container = document.getElementById('status-banner');
            const configs = {
                pending: {
                    cls: 'status-pending',
                    icon: 'bi-clock-history text-warning',
                    title: 'Registro en revisión',
                    msg: 'Su registro está siendo evaluado. Le notificaremos por correo cuando haya una actualización.'
                },
                approved: {
                    cls: 'status-approved',
                    icon: 'bi-check-circle-fill text-success',
                    title: 'Proveedor aprobado',
                    msg: 'Su registro ha sido aprobado. Puede actualizar sus datos cuando lo requiera.'
                },
                rejected: {
                    cls: 'status-rejected',
                    icon: 'bi-x-circle-fill text-danger',
                    title: 'Registro rechazado',
                    msg: rejectionReason
                        ? `Motivo: ${rejectionReason}. Corrija la información y reenvíe su solicitud.`
                        : 'Su registro fue rechazado. Corrija la información y reenvíe su solicitud.'
                },
                inactive: {
                    cls: 'status-approved',
                    icon: 'bi-pause-circle text-secondary',
                    title: 'Proveedor inactivo',
                    msg: 'Su cuenta se encuentra inactiva. Contacte al administrador para más información.'
                }
            };
            const cfg = configs[status] || configs.pending;
            container.innerHTML = `
                <div class="status-banner ${cfg.cls}">
                    <i class="bi ${cfg.icon} status-icon"></i>
                    <div>
                        <strong>${cfg.title}</strong>
                        <p class="mb-0 mt-1">${cfg.msg}</p>
                    </div>
                </div>`;
        }

        // ==========================================
        // POBLAR CATÁLOGOS
        // ==========================================
        function poblarSelectDepartamentos() {
            const sel = document.getElementById('p-department');
            sel.innerHTML = '<option value="">Seleccione...</option>';
            catalogData.departments.forEach(d => {
                sel.innerHTML += `<option value="${d.department_id}">${d.department_name}</option>`;
            });
        }

        async function cargarMunicipios(preselect = null) {
            const deptId = document.getElementById('p-department').value;
            const sel = document.getElementById('p-municipality');
            if (!deptId) { sel.innerHTML = '<option value="">Primero seleccione departamento</option>'; sel.disabled = true; return; }

            sel.innerHTML = '<option value="">Cargando...</option>';
            try {
                const data = await supabaseRequest(`/sup_municipalities?select=municipality_id,municipality_name&department_id=eq.${deptId}&is_active=eq.true&order=municipality_name`);
                sel.innerHTML = '<option value="">Seleccione...</option>';
                data.forEach(m => { sel.innerHTML += `<option value="${m.municipality_id}">${m.municipality_name}</option>`; });
                sel.disabled = false;
                if (preselect) sel.value = preselect;
            } catch (e) { console.error('Error cargando municipios:', e); }
        }

        function poblarSelectBancos() {
            const sel = document.getElementById('p-bank');
            sel.innerHTML = '<option value="">Seleccione...</option>';
            catalogData.banks.forEach(b => {
                sel.innerHTML += `<option value="${b.bank_id}">${b.bank_name}</option>`;
            });
        }

        function renderRegimenes() {
            const container = document.getElementById('p-regimes-container');
            container.innerHTML = catalogData.regimes.map(r => `
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="p-regime" value="${r.regime_id}" id="regime-${r.regime_id}">
                    <label class="form-check-label" for="regime-${r.regime_id}">${r.regime_name}</label>
                </div>
            `).join('');
        }

        function renderCondiciones(personType) {
            const container = document.getElementById('p-conditions-container');
            const filtered = catalogData.conditions.filter(c => c.applies_to === 'both' || c.applies_to === personType);
            container.innerHTML = filtered.map(c => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="p-condition" value="${c.condition_id}" id="cond-${c.condition_id}">
                    <label class="form-check-label" for="cond-${c.condition_id}">${c.condition_name}</label>
                </div>
            `).join('');
        }

        // ==========================================
        // CIIU SEARCH
        // ==========================================
        function buscarCIIU() {
            const term = document.getElementById('p-ciiu-search').value.trim().toLowerCase();
            const sel = document.getElementById('p-ciiu');
            if (!term || term.length < 2) { sel.style.display = 'none'; return; }

            const results = catalogData.ciiu.filter(c =>
                c.ciiu_code.toLowerCase().includes(term) || c.ciiu_description.toLowerCase().includes(term)
            ).slice(0, 20);

            sel.innerHTML = results.map(c => `<option value="${c.ciiu_id}">${c.ciiu_code} - ${c.ciiu_description}</option>`).join('');
            sel.style.display = results.length ? 'block' : 'none';

            sel.onchange = () => {
                const opt = sel.options[sel.selectedIndex];
                if (opt) {
                    document.getElementById('p-ciiu-selected').value = opt.value;
                    const label = document.getElementById('p-ciiu-label');
                    label.style.display = 'block';
                    label.innerHTML = `<i class="bi bi-check-circle me-1"></i>${opt.text}`;
                    sel.style.display = 'none';
                    document.getElementById('p-ciiu-search').value = '';
                }
            };
        }

        // ==========================================
        // DIRECCIÓN DIAN
        // ==========================================
        function generarDireccion() {
            const via = document.getElementById('addr-via-type').value;
            const num = document.getElementById('addr-via-num').value.trim();
            const letter = document.getElementById('addr-via-letter').value;
            const quad = document.getElementById('addr-via-quad').value;
            const number = document.getElementById('addr-number').value.trim();
            const plate = document.getElementById('addr-plate').value.trim();
            const plateLetter = document.getElementById('addr-plate-letter').value;
            const plateQuad = document.getElementById('addr-plate-quad').value;

            let parts = [];
            if (via) parts.push(via);
            if (num) parts.push(num);
            if (letter) parts.push(letter);
            if (quad) parts.push(quad);
            if (number) parts.push('# ' + number);
            if (plate) parts.push('- ' + plate);
            if (plateLetter) parts.push(plateLetter);
            if (plateQuad) parts.push(plateQuad);

            addressComplements.forEach(c => parts.push(c.code + ' ' + c.value));

            const addr = parts.join(' ') || '—';
            document.getElementById('addr-preview').textContent = addr;
            document.getElementById('p-address-formatted').value = addr === '—' ? '' : addr;
        }

        function agregarComplemento() {
            const type = document.getElementById('addr-comp-type');
            const value = document.getElementById('addr-comp-value').value.trim();
            if (!type.value || !value) return;

            addressComplements.push({ code: type.value, label: type.options[type.selectedIndex].text, value });
            renderComplementos();
            type.value = '';
            document.getElementById('addr-comp-value').value = '';
            generarDireccion();
        }

        function renderComplementos() {
            const list = document.getElementById('addr-complements-list');
            list.innerHTML = addressComplements.map((c, i) => `
                <span class="addr-complement-badge">
                    ${c.label} ${c.value}
                    <i class="bi bi-x" style="cursor:pointer;" onclick="quitarComplemento(${i})"></i>
                </span>
            `).join('');
        }

        function quitarComplemento(idx) {
            addressComplements.splice(idx, 1);
            renderComplementos();
            generarDireccion();
        }

        // ==========================================
        // DV NIT
        // ==========================================
        function calcularDV() {
            const nit = document.getElementById('p-nit').value.replace(/\D/g, '');
            if (!nit) { document.getElementById('p-nit-dv').value = ''; return; }
            const primes = [3, 7, 13, 17, 19, 23, 29, 37, 41, 43, 47, 53, 59, 67, 71];
            const digits = nit.split('').reverse();
            let sum = 0;
            digits.forEach((d, i) => { sum += parseInt(d) * primes[i]; });
            const remainder = sum % 11;
            document.getElementById('p-nit-dv').value = remainder >= 2 ? 11 - remainder : remainder;
        }

        // ==========================================
        // DOCUMENTOS ADJUNTOS
        // ==========================================
        function renderDocumentos(personType) {
            const container = document.getElementById('p-docs-container');
            const types = catalogData.attachmentTypes.filter(t => t.applies_to === 'both' || t.applies_to === personType);

            container.innerHTML = types.map(t => {
                const existing = supplierAttachments.find(a => a.attachment_type_id === t.attachment_type_id);
                const hasFile = !!existing;
                const hasNewFile = !!newFiles[t.attachment_type_id];

                return `
                <div class="doc-card ${hasFile ? 'has-file' : ''}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="doc-name">
                                ${t.is_required ? '<span class="text-danger me-1">*</span>' : ''}${t.type_name}
                            </div>
                            ${hasFile ? `
                                <div class="doc-info mt-1">
                                    <i class="bi bi-check-circle text-success me-1"></i>
                                    ${existing.file_name} (${formatFileSize(existing.file_size)})
                                    <a href="${SUPABASE_CONFIG.url}/storage/v1/object/public/${STORAGE_BUCKET}/${existing.file_path}" target="_blank" class="ms-2">
                                        <i class="bi bi-download"></i> Descargar
                                    </a>
                                </div>
                            ` : '<div class="doc-info mt-1 text-muted">Sin documento</div>'}
                            ${hasNewFile ? `
                                <div class="doc-info mt-1 text-primary">
                                    <i class="bi bi-arrow-repeat me-1"></i>Nuevo archivo: ${newFiles[t.attachment_type_id].name}
                                </div>
                            ` : ''}
                        </div>
                        <div>
                            <input type="file" class="d-none" id="file-${t.attachment_type_id}" 
                                   accept=".${(t.allowed_extensions || 'pdf,jpg,jpeg,png').split(',').join(',.')}"
                                   onchange="seleccionarArchivo('${t.attachment_type_id}', this)">
                            <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('file-${t.attachment_type_id}').click()">
                                <i class="bi bi-${hasFile ? 'arrow-repeat' : 'upload'} me-1"></i>${hasFile ? 'Reemplazar' : 'Subir'}
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function seleccionarArchivo(typeId, input) {
            if (!input.files.length) return;
            const file = input.files[0];
            const type = catalogData.attachmentTypes.find(t => t.attachment_type_id === typeId);
            const maxMB = type?.max_file_size_mb || 5;

            if (file.size > maxMB * 1024 * 1024) {
                showMessage(`El archivo excede el tamaño máximo de ${maxMB} MB`, 'warning');
                input.value = '';
                return;
            }

            newFiles[typeId] = file;
            renderDocumentos(currentSupplier.person_type);
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // ==========================================
        // GUARDAR CAMBIOS
        // ==========================================
        async function guardarCambios(cambiarEstado = false) {
            const btn = cambiarEstado ? document.getElementById('btn-resubmit') : document.getElementById('btn-save');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';

                const s = currentSupplier;

                // Construir payload
                const payload = {
                    phone: document.getElementById('p-phone').value.trim(),
                    department_id: document.getElementById('p-department').value || null,
                    municipality_id: document.getElementById('p-municipality').value || null,
                    address: document.getElementById('p-address-formatted').value || document.getElementById('addr-preview').textContent,
                    address_reference: document.getElementById('p-address-reference').value.trim() || null,
                    ciiu_id: document.getElementById('p-ciiu-selected').value || null,
                    products_services: document.getElementById('p-products-services').value.trim(),
                    tax_regime_id: document.querySelector('input[name="p-regime"]:checked')?.value || null,
                    bank_id: document.getElementById('p-bank').value || null,
                    account_type: document.getElementById('p-account-type').value || null,
                    account_number: document.getElementById('p-account-number').value.trim() || null,
                    updated_at: new Date().toISOString()
                };

                // Campos según tipo persona
                if (s.person_type === 'natural') {
                    payload.document_type = document.getElementById('p-doc-type').value;
                    payload.document_number = document.getElementById('p-doc-number').value.trim();
                    payload.first_name = document.getElementById('p-first-name').value.trim();
                    payload.second_name = document.getElementById('p-second-name').value.trim() || null;
                    payload.last_name_1 = document.getElementById('p-last-name-1').value.trim();
                    payload.last_name_2 = document.getElementById('p-last-name-2').value.trim() || null;
                } else {
                    payload.business_name = document.getElementById('p-business-name').value.trim();
                    payload.nit = document.getElementById('p-nit').value.trim();
                    payload.nit_verification_digit = document.getElementById('p-nit-dv').value;
                    payload.contact_name = document.getElementById('p-contact-name').value.trim();
                }

                // Si es reenvío: cambiar estado a pendiente
                if (cambiarEstado) {
                    payload.supplier_status = 'pending';
                    payload.rejection_reason = null;
                    payload.approved_by = null;
                    payload.approved_at = null;
                    payload.responsible_worker_id = null;
                }

                // Validación mínima
                if (!payload.phone) { showMessage('El teléfono es obligatorio', 'warning'); return; }
                if (!payload.products_services) { showMessage('Productos/servicios es obligatorio', 'warning'); return; }

                // 1. Guardar datos principales
                await supabaseRequest(`/sup_suppliers?supplier_id=eq.${s.supplier_id}`, {
                    method: 'PATCH',
                    body: JSON.stringify(payload)
                });
                console.log('✅ Datos principales actualizados');

                // 2. Actualizar condiciones tributarias
                const selectedConditions = Array.from(document.querySelectorAll('input[name="p-condition"]:checked')).map(cb => cb.value);

                // Eliminar anteriores
                await supabaseRequest(`/sup_supplier_tax_conditions?supplier_id=eq.${s.supplier_id}`, {
                    method: 'DELETE'
                });

                // Insertar nuevas
                if (selectedConditions.length > 0) {
                    const conditionsPayload = selectedConditions.map(cid => ({
                        supplier_id: s.supplier_id,
                        condition_id: cid
                    }));
                    await supabaseRequest('/sup_supplier_tax_conditions', {
                        method: 'POST',
                        body: JSON.stringify(conditionsPayload)
                    });
                }
                console.log('✅ Condiciones tributarias actualizadas');

                // 3. Subir archivos nuevos
                const fileEntries = Object.entries(newFiles);
                for (const [typeId, file] of fileEntries) {
                    try {
                        const timestamp = Date.now();
                        const safeName = file.name
                            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                            .replace(/[^a-zA-Z0-9._-]/g, '_')
                            .replace(/_+/g, '_');
                        const filePath = `suppliers/${s.supplier_id}/${timestamp}_${safeName}`;

                        // Eliminar archivo anterior del mismo tipo (si existe)
                        const existingAtt = supplierAttachments.find(a => a.attachment_type_id === typeId);
                        if (existingAtt) {
                            // Eliminar del storage
                            await supabaseClient.storage.from(STORAGE_BUCKET).remove([existingAtt.file_path]);
                            // Eliminar registro de BD
                            await supabaseRequest(`/sup_supplier_attachments?attachment_id=eq.${existingAtt.attachment_id}`, { method: 'DELETE' });
                        }

                        // Subir nuevo archivo
                        const { error } = await supabaseClient.storage.from(STORAGE_BUCKET).upload(filePath, file, { cacheControl: '3600', upsert: false });
                        if (error) throw error;

                        // Registrar en BD
                        await supabaseRequest('/sup_supplier_attachments', {
                            method: 'POST',
                            body: JSON.stringify({
                                supplier_id: s.supplier_id,
                                attachment_type_id: typeId,
                                file_name: file.name,
                                file_path: filePath,
                                file_size: file.size,
                                file_type: file.type
                            })
                        });
                        console.log('✅ Archivo subido:', file.name);
                    } catch (fileErr) {
                        console.error('⚠️ Error subiendo archivo:', fileErr);
                    }
                }

                // Limpiar archivos nuevos
                newFiles = {};

                // Recargar datos
                const updatedSuppliers = await supabaseRequest(`/sup_suppliers?select=*&supplier_id=eq.${s.supplier_id}`);
                currentSupplier = updatedSuppliers[0];
                supplierConditions = await supabaseRequest(`/sup_supplier_tax_conditions?select=condition_id&supplier_id=eq.${s.supplier_id}`);
                supplierAttachments = await supabaseRequest(`/sup_supplier_attachments?select=*,sup_attachment_types(type_name)&supplier_id=eq.${s.supplier_id}`);

                poblarFormulario();

                const msg = cambiarEstado
                    ? 'Solicitud reenviada exitosamente. Será revisada nuevamente.'
                    : 'Datos actualizados correctamente.';
                showMessage(msg, 'success');

            } catch (error) {
                console.error('❌ Error guardando:', error);
                showMessage('Error al guardar los cambios: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function reenviarSolicitud() {
            if (confirm('¿Desea corregir y reenviar su solicitud? El estado cambiará a "Pendiente" para nueva revisión.')) {
                guardarCambios(true);
            }
        }

        console.log('✅ portal.html cargado');
    </script>
</body>
</html>
