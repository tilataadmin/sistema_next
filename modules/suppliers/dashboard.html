<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.19.23.00">
    <title>Dashboard de Proveedores - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .loading-overlay.hidden { display: none; }
        .loading-content { background: white; padding: 2rem; border-radius: 8px; text-align: center; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* KPI Cards */
        .kpi-card { border-radius: 12px; border: none; transition: transform 0.2s, box-shadow 0.2s; overflow: hidden; }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
        .kpi-value { font-size: 2rem; font-weight: 800; line-height: 1.2; }
        .kpi-label { font-size: 0.85rem; opacity: 0.85; }
        .kpi-icon { font-size: 2.5rem; opacity: 0.2; }

        /* Chart cards */
        .chart-card { border-radius: 12px; border: 1px solid #e9ecef; }
        .chart-card .card-header { background: transparent; border-bottom: 1px solid #f0f0f0; font-weight: 600; }

        /* Recent table */
        .table-recent td { vertical-align: middle; font-size: 0.9rem; }
        .badge-pending { background-color: #ffc107; color: #000; }
        .badge-approved { background-color: #198754; }
        .badge-rejected { background-color: #dc3545; }
        .badge-inactive { background-color: #6c757d; }
        .badge-natural { background-color: #0d6efd; }
        .badge-juridica { background-color: #6f42c1; }

        /* Alert pending */
        .pending-alert { border-left: 4px solid #ffc107; background: #fff8e1; border-radius: 8px; }
    </style>
</head>

<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando dashboard...</p>
        </div>
    </div>

    <div class="container-fluid">
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a></li>
                <li class="breadcrumb-item"><a href="index.html">Proveedores</a></li>
                <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
            </ol>
        </nav>

        <!-- HEADER -->
        <div class="row mb-3">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-speedometer2 me-2"></i>Dashboard de Proveedores
                </h1>
                <p class="text-muted mb-0">Resumen general y estadísticas del módulo</p>
            </div>
            <div class="col-auto d-flex align-items-center">
                <button class="btn btn-outline-secondary btn-sm" onclick="cargarDashboard()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                </button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- ============================================ -->
        <!-- ALERTA DE PENDIENTES                        -->
        <!-- ============================================ -->
        <div class="pending-alert p-3 mb-3 d-none" id="pending-alert">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                    <strong>Hay <span id="alert-pending-count">0</span> proveedor(es) pendientes de revisión</strong>
                </div>
                <a href="manage.html" class="btn btn-warning btn-sm">
                    <i class="bi bi-arrow-right me-1"></i>Ir a gestionar
                </a>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- KPI CARDS                                   -->
        <!-- ============================================ -->
        <div class="row mb-4" id="kpi-row">
            <div class="col-6 col-lg-3 mb-3">
                <div class="card kpi-card shadow-sm" style="background: linear-gradient(135deg, #0d6efd, #0b5ed7);">
                    <div class="card-body text-white d-flex justify-content-between align-items-center py-3">
                        <div>
                            <div class="kpi-value" id="kpi-total">—</div>
                            <div class="kpi-label">Total Registrados</div>
                        </div>
                        <i class="bi bi-people kpi-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3 mb-3">
                <div class="card kpi-card shadow-sm" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                    <div class="card-body text-dark d-flex justify-content-between align-items-center py-3">
                        <div>
                            <div class="kpi-value" id="kpi-pending">—</div>
                            <div class="kpi-label">Pendientes</div>
                        </div>
                        <i class="bi bi-clock-history kpi-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3 mb-3">
                <div class="card kpi-card shadow-sm" style="background: linear-gradient(135deg, #198754, #157347);">
                    <div class="card-body text-white d-flex justify-content-between align-items-center py-3">
                        <div>
                            <div class="kpi-value" id="kpi-approved">—</div>
                            <div class="kpi-label">Aprobados</div>
                        </div>
                        <i class="bi bi-check-circle kpi-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3 mb-3">
                <div class="card kpi-card shadow-sm" style="background: linear-gradient(135deg, #dc3545, #bb2d3b);">
                    <div class="card-body text-white d-flex justify-content-between align-items-center py-3">
                        <div>
                            <div class="kpi-value" id="kpi-rejected">—</div>
                            <div class="kpi-label">Rechazados</div>
                        </div>
                        <i class="bi bi-x-circle kpi-icon"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- GRÁFICOS FILA 1                             -->
        <!-- ============================================ -->
        <div class="row mb-4">
            <!-- Distribución por estado -->
            <div class="col-md-4 mb-3">
                <div class="card chart-card h-100">
                    <div class="card-header">
                        <i class="bi bi-pie-chart me-2"></i>Por Estado
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <canvas id="chart-status" style="max-height: 260px;"></canvas>
                    </div>
                </div>
            </div>
            <!-- Distribución por tipo persona -->
            <div class="col-md-4 mb-3">
                <div class="card chart-card h-100">
                    <div class="card-header">
                        <i class="bi bi-diagram-2 me-2"></i>Por Tipo de Persona
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <canvas id="chart-type" style="max-height: 260px;"></canvas>
                    </div>
                </div>
            </div>
            <!-- Tendencia de registro -->
            <div class="col-md-4 mb-3">
                <div class="card chart-card h-100">
                    <div class="card-header">
                        <i class="bi bi-graph-up me-2"></i>Registros por Mes
                    </div>
                    <div class="card-body">
                        <canvas id="chart-trend" style="max-height: 260px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- GRÁFICOS FILA 2 + TABLA RECIENTES          -->
        <!-- ============================================ -->
        <div class="row mb-4">
            <!-- Top departamentos -->
            <div class="col-md-5 mb-3">
                <div class="card chart-card h-100">
                    <div class="card-header">
                        <i class="bi bi-geo-alt me-2"></i>Top Departamentos
                    </div>
                    <div class="card-body">
                        <canvas id="chart-departments" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            <!-- Últimos registros -->
            <div class="col-md-7 mb-3">
                <div class="card chart-card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-clock me-2"></i>Últimos Registros</span>
                        <a href="manage.html" class="btn btn-outline-primary btn-sm">Ver todos</a>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-recent mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Proveedor</th>
                                        <th>Tipo</th>
                                        <th>Estado</th>
                                        <th>Fecha</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-recent">
                                    <tr><td colspan="4" class="text-center text-muted py-3">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div><!-- /container-fluid -->

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let cacheSuppliers = [];
        let chartInstances = {};

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const hasAccess = await validatePageAccess('Dashboard de proveedores');
                if (!hasAccess) return;

                const session = getStoredSession();
                if (!session) {
                    showMessage('Sesión no válida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '../../index.html', 2000);
                    return;
                }

                await cargarDashboard();
            } catch (error) {
                console.error('❌ Error en inicialización:', error);
                showMessage('Error al inicializar: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGA PRINCIPAL
        // ==========================================
        async function cargarDashboard() {
            try {
                const data = await supabaseRequest(
                    '/sup_suppliers?select=' +
                    'supplier_id,person_type,supplier_status,created_at,' +
                    'business_name,first_name,last_name_1,last_name_2,' +
                    'email,sup_departments(department_name)' +
                    '&order=created_at.desc'
                );

                cacheSuppliers = data || [];
                renderKPIs();
                renderCharts();
                renderRecientes();

                console.log(`✅ Dashboard cargado: ${cacheSuppliers.length} proveedores`);
            } catch (error) {
                console.error('❌ Error cargando dashboard:', error);
                showMessage('Error al cargar datos: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // KPIs
        // ==========================================
        function renderKPIs() {
            const counts = { pending: 0, approved: 0, rejected: 0, inactive: 0 };
            cacheSuppliers.forEach(s => {
                if (counts[s.supplier_status] !== undefined) counts[s.supplier_status]++;
            });

            document.getElementById('kpi-total').textContent = cacheSuppliers.length;
            document.getElementById('kpi-pending').textContent = counts.pending;
            document.getElementById('kpi-approved').textContent = counts.approved;
            document.getElementById('kpi-rejected').textContent = counts.rejected;

            // Alerta de pendientes
            const alertEl = document.getElementById('pending-alert');
            if (counts.pending > 0) {
                document.getElementById('alert-pending-count').textContent = counts.pending;
                alertEl.classList.remove('d-none');
            } else {
                alertEl.classList.add('d-none');
            }
        }

        // ==========================================
        // GRÁFICOS
        // ==========================================
        function renderCharts() {
            renderChartEstado();
            renderChartTipo();
            renderChartTendencia();
            renderChartDepartamentos();
        }

        function destroyChart(key) {
            if (chartInstances[key]) {
                chartInstances[key].destroy();
                chartInstances[key] = null;
            }
        }

        // --- Gráfico: Distribución por estado ---
        function renderChartEstado() {
            destroyChart('status');
            const counts = { pending: 0, approved: 0, rejected: 0, inactive: 0 };
            cacheSuppliers.forEach(s => {
                if (counts[s.supplier_status] !== undefined) counts[s.supplier_status]++;
            });

            const ctx = document.getElementById('chart-status').getContext('2d');
            chartInstances['status'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendientes', 'Aprobados', 'Rechazados', 'Inactivos'],
                    datasets: [{
                        data: [counts.pending, counts.approved, counts.rejected, counts.inactive],
                        backgroundColor: ['#ffc107', '#198754', '#dc3545', '#6c757d'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } }
                    }
                }
            });
        }

        // --- Gráfico: Distribución por tipo persona ---
        function renderChartTipo() {
            destroyChart('type');
            let natural = 0, juridica = 0;
            cacheSuppliers.forEach(s => {
                if (s.person_type === 'natural') natural++;
                else juridica++;
            });

            const ctx = document.getElementById('chart-type').getContext('2d');
            chartInstances['type'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Persona Natural', 'Persona Jurídica'],
                    datasets: [{
                        data: [natural, juridica],
                        backgroundColor: ['#0d6efd', '#6f42c1'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } }
                    }
                }
            });
        }

        // --- Gráfico: Tendencia de registros por mes ---
        function renderChartTendencia() {
            destroyChart('trend');

            // Agrupar por mes (últimos 6 meses)
            const now = new Date();
            const months = [];
            const counts = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleDateString('es-CO', { month: 'short', year: '2-digit' });
                months.push(label);
                const count = cacheSuppliers.filter(s => {
                    if (!s.created_at) return false;
                    const sd = new Date(s.created_at);
                    return sd.getFullYear() === d.getFullYear() && sd.getMonth() === d.getMonth();
                }).length;
                counts.push(count);
            }

            const ctx = document.getElementById('chart-trend').getContext('2d');
            chartInstances['trend'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Registros',
                        data: counts,
                        backgroundColor: 'rgba(13, 110, 253, 0.7)',
                        borderColor: '#0d6efd',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // --- Gráfico: Top departamentos ---
        function renderChartDepartamentos() {
            destroyChart('departments');

            // Contar por departamento
            const deptCounts = {};
            cacheSuppliers.forEach(s => {
                const name = s.sup_departments?.department_name || 'Sin departamento';
                deptCounts[name] = (deptCounts[name] || 0) + 1;
            });

            // Ordenar y tomar top 8
            const sorted = Object.entries(deptCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            const labels = sorted.map(e => e[0]);
            const values = sorted.map(e => e[1]);
            const colors = ['#0d6efd', '#6f42c1', '#198754', '#ffc107', '#dc3545', '#0dcaf0', '#fd7e14', '#6c757d'];

            const ctx = document.getElementById('chart-departments').getContext('2d');
            chartInstances['departments'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Proveedores',
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // ==========================================
        // TABLA DE RECIENTES
        // ==========================================
        function renderRecientes() {
            const tbody = document.getElementById('tbody-recent');
            const recientes = cacheSuppliers.slice(0, 8); // ya vienen ordenados desc

            if (recientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">No hay registros aún</td></tr>';
                return;
            }

            tbody.innerHTML = recientes.map(s => {
                const nombre = getNombreProveedor(s);
                const fecha = s.created_at ? formatDate(s.created_at) : '—';
                return `
                <tr>
                    <td>
                        <strong>${nombre}</strong>
                        <br><small class="text-muted">${s.email || ''}</small>
                    </td>
                    <td>${badgeTipo(s.person_type)}</td>
                    <td>${badgeEstado(s.supplier_status)}</td>
                    <td><small>${fecha}</small></td>
                </tr>`;
            }).join('');
        }

        // ==========================================
        // HELPERS
        // ==========================================
        function getNombreProveedor(s) {
            if (s.person_type === 'juridica') return s.business_name || 'Sin razón social';
            return [s.first_name, s.last_name_1, s.last_name_2].filter(Boolean).join(' ') || 'Sin nombre';
        }

        function badgeEstado(status) {
            const map = {
                pending: '<span class="badge badge-pending">Pendiente</span>',
                approved: '<span class="badge badge-approved">Aprobado</span>',
                rejected: '<span class="badge badge-rejected">Rechazado</span>',
                inactive: '<span class="badge badge-inactive">Inactivo</span>'
            };
            return map[status] || `<span class="badge bg-secondary">${status}</span>`;
        }

        function badgeTipo(type) {
            return type === 'juridica'
                ? '<span class="badge badge-juridica">Jurídica</span>'
                : '<span class="badge badge-natural">Natural</span>';
        }

        console.log('✅ dashboard.html cargado');
    </script>
</body>
</html>
