<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.20.06.50">
    <title>Documentos Legales - SchoolNet</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Quill Editor -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center;
            align-items: center; z-index: 9999;
        }
        .loading-overlay.hidden { display: none; }
        .loading-content { background: white; padding: 2rem; border-radius: 8px; text-align: center; }
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #64748b;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 1rem;
        }
        @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

        /* Cards de documentos */
        .doc-card {
            border-left: 4px solid #64748b;
            transition: box-shadow 0.2s;
        }
        .doc-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .doc-card.inactive { border-left-color: #dee2e6; opacity: 0.7; }

        /* Editor Quill - tama√±o completo */
        #editor-container .ql-editor {
            min-height: 350px;
            max-height: 60vh;
            overflow-y: auto;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        #editor-container .ql-toolbar { border-radius: 0.375rem 0.375rem 0 0; background: #f8f9fa; }
        #editor-container .ql-container { border-radius: 0 0 0.375rem 0.375rem; }

        /* Preview del contenido */
        .content-preview {
            max-height: 150px;
            overflow: hidden;
            position: relative;
            font-size: 0.85rem;
            color: #6c757d;
        }
        .content-preview::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 40px;
            background: linear-gradient(transparent, white);
        }
        .content-preview p { margin-bottom: 0.3rem; }

        /* Timeline de versiones */
        .version-timeline { position: relative; padding-left: 24px; }
        .version-timeline::before {
            content: ''; position: absolute; left: 8px; top: 0; bottom: 0;
            width: 2px; background: #dee2e6;
        }
        .version-item { position: relative; padding-bottom: 1rem; }
        .version-item::before {
            content: ''; position: absolute; left: -20px; top: 4px;
            width: 12px; height: 12px; border-radius: 50%;
            background: #dee2e6; border: 2px solid white;
        }
        .version-item.current::before { background: #198754; }

        /* Vista previa en modal */
        .preview-content { 
            padding: 1.5rem; 
            border: 1px solid #dee2e6; 
            border-radius: 0.375rem;
            max-height: 50vh;
            overflow-y: auto;
            background: #fff;
        }
        .preview-content h1, .preview-content h2, .preview-content h3 { margin-top: 1rem; }
        .preview-content ul, .preview-content ol { padding-left: 1.5rem; }
        .preview-content a { color: #0d6efd; }
    </style>
</head>

<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Proveedores</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Documentos Legales</li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-file-earmark-text me-2" style="color: #64748b;"></i>
                    Documentos Legales
                </h1>
                <p class="text-muted">Documentos normativos que el proveedor debe aceptar antes de registrarse. Cada edici√≥n genera una nueva versi√≥n.</p>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- ============================================ -->
        <!-- VISTA: LISTA DE DOCUMENTOS                  -->
        <!-- ============================================ -->
        <div id="view-list">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="bi bi-collection me-2"></i>Documentos
                    <span class="badge bg-secondary badge-count ms-1" id="count-docs">0</span>
                </h5>
                <button class="btn btn-primary btn-sm" onclick="abrirModalNuevoDocumento()">
                    <i class="bi bi-plus-circle me-1"></i>Nuevo Documento
                </button>
            </div>

            <div id="docs-container">
                <div class="text-center py-5 text-muted">
                    <div class="spinner-border text-secondary" role="status"></div>
                    <p class="mt-2">Cargando documentos...</p>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- VISTA: EDITOR DE DOCUMENTO                  -->
        <!-- ============================================ -->
        <div id="view-editor" style="display: none;">
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="volverALista()">
                        <i class="bi bi-arrow-left me-1"></i>Volver
                    </button>
                    <span class="h5 mb-0" id="editor-doc-name">Documento</span>
                    <span class="badge bg-info ms-2" id="editor-version-badge">Nueva versi√≥n</span>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="previsualizarDocumento()">
                        <i class="bi bi-eye me-1"></i>Previsualizar
                    </button>
                    <button class="btn btn-success btn-sm" onclick="publicarVersion()" id="btn-publish">
                        <i class="bi bi-cloud-upload me-1"></i>Publicar nueva versi√≥n
                    </button>
                </div>
            </div>

            <div class="row">
                <!-- Editor principal -->
                <div class="col-lg-9 mb-4">
                    <div class="card">
                        <div class="card-body p-0">
                            <div id="editor-container"></div>
                        </div>
                    </div>
                </div>

                <!-- Panel lateral: historial -->
                <div class="col-lg-3 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Historial de Versiones</h6>
                        </div>
                        <div class="card-body" id="version-history" style="max-height: 400px; overflow-y: auto;">
                            <p class="text-muted small">Sin versiones previas</p>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Informaci√≥n</h6>
                        </div>
                        <div class="card-body small">
                            <p class="mb-1"><strong>Al publicar:</strong></p>
                            <ul class="mb-0 ps-3">
                                <li>Se crea una nueva versi√≥n</li>
                                <li>Las versiones anteriores se conservan</li>
                                <li>Proveedores que aceptaron una versi√≥n anterior quedar√°n pendientes de re-aceptaci√≥n</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>


    <!-- ============================================ -->
    <!-- MODAL: NUEVO / EDITAR DOCUMENTO (MAESTRO)   -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-document" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-document-title">
                        <i class="bi bi-file-earmark-plus me-2"></i>Nuevo Documento Legal
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-document" onsubmit="guardarDocumento(event)">
                    <div class="modal-body">
                        <input type="hidden" id="doc-id">
                        <div class="mb-3">
                            <label for="doc-name" class="form-label">Nombre del documento <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="doc-name" required maxlength="250"
                                   placeholder="Ej: Pol√≠tica de compras y proveedores">
                        </div>
                        <div class="mb-3">
                            <label for="doc-description" class="form-label">Descripci√≥n breve</label>
                            <textarea class="form-control" id="doc-description" rows="2" maxlength="500"
                                      placeholder="Descripci√≥n interna del prop√≥sito del documento (no visible para el proveedor)"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label for="doc-order" class="form-label">Orden de aparici√≥n</label>
                                <input type="number" class="form-control" id="doc-order" value="1" min="1">
                            </div>
                            <div class="col-6 mb-3 d-flex align-items-end">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="doc-active" checked>
                                    <label class="form-check-label" for="doc-active">Activo</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btn-save-doc">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- ============================================ -->
    <!-- MODAL: PREVISUALIZACI√ìN                     -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-preview" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-eye me-2"></i>Previsualizaci√≥n del documento
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="preview-body" class="preview-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- ============================================ -->
    <!-- MODAL: VER VERSI√ìN ANTERIOR                 -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-version-view" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-version-view-title">
                        <i class="bi bi-clock-history me-2"></i>Versi√≥n
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex gap-3 mb-3 small text-muted">
                        <span><i class="bi bi-calendar me-1"></i><span id="vv-date">--</span></span>
                        <span><i class="bi bi-person me-1"></i><span id="vv-author">--</span></span>
                    </div>
                    <div id="version-view-body" class="preview-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="restaurarVersion()" id="btn-restore">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Cargar en editor
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let cacheDocuments = [];
        let currentDocId = null;
        let currentVersions = [];
        let viewingVersionId = null;
        
        let modalDocument, modalPreview, modalVersionView;
        let quillEditor = null;
        
        // Opciones del editor Quill - completo para documentos extensos
        const QUILL_FULL_OPTIONS = {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    [{ 'indent': '-1' }, { 'indent': '+1' }],
                    [{ 'align': [] }],
                    ['link'],
                    ['blockquote'],
                    ['clean']
                ]
            },
            placeholder: 'Escriba aqu√≠ el contenido del documento legal...'
        };

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando Documentos Legales...');
            
            try {
                const hasAccess = await validatePageAccess('Gestionar documentos legales de proveedores');
                if (!hasAccess) return;
                
                const session = getStoredSession();
                if (!session) {
                    showMessage('Sesi√≥n no v√°lida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '/login.html', 2000);
                    return;
                }
                
                // Inicializar modales
                modalDocument = new bootstrap.Modal(document.getElementById('modal-document'));
                modalPreview = new bootstrap.Modal(document.getElementById('modal-preview'));
                modalVersionView = new bootstrap.Modal(document.getElementById('modal-version-view'));
                
                // Inicializar editor Quill
                quillEditor = new Quill('#editor-container', QUILL_FULL_OPTIONS);
                
                // Cargar documentos
                await cargarDocumentos();
                
                console.log('‚úÖ Documentos Legales inicializado');
                
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al cargar: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGAR Y RENDERIZAR DOCUMENTOS
        // ==========================================
        async function cargarDocumentos() {
            try {
                // Traer documentos con su versi√≥n actual
                const docs = await supabaseRequest(
                    '/sup_legal_documents?select=*,sup_legal_document_versions(version_id,version_number,is_current,published_at,published_by)&order=document_order.asc'
                );
                cacheDocuments = docs || [];
                document.getElementById('count-docs').textContent = cacheDocuments.length;
                renderizarDocumentos();
            } catch (error) {
                console.error('‚ùå Error cargando documentos:', error);
                document.getElementById('docs-container').innerHTML =
                    '<div class="alert alert-danger">Error al cargar documentos</div>';
            }
        }
        
        function renderizarDocumentos() {
            const container = document.getElementById('docs-container');
            
            if (!cacheDocuments || cacheDocuments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-file-earmark-x" style="font-size: 3rem;"></i>
                        <p class="mt-2">No hay documentos legales registrados</p>
                        <button class="btn btn-primary btn-sm" onclick="abrirModalNuevoDocumento()">
                            <i class="bi bi-plus-circle me-1"></i>Crear primer documento
                        </button>
                    </div>`;
                return;
            }
            
            container.innerHTML = cacheDocuments.map(doc => {
                const versions = doc.sup_legal_document_versions || [];
                const currentVersion = versions.find(v => v.is_current);
                const totalVersions = versions.length;
                const publishedDate = currentVersion 
                    ? new Date(currentVersion.published_at).toLocaleDateString('es-CO', { year: 'numeric', month: 'short', day: 'numeric' })
                    : null;
                
                return `
                <div class="card doc-card mb-3 ${doc.is_active ? '' : 'inactive'}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="mb-1">
                                    <i class="bi bi-file-earmark-text me-2 text-muted"></i>
                                    ${doc.document_name}
                                </h6>
                                ${doc.document_description 
                                    ? `<small class="text-muted">${doc.document_description}</small>` 
                                    : ''}
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex gap-2 flex-wrap">
                                    ${currentVersion 
                                        ? `<span class="badge bg-success">v${currentVersion.version_number}</span>`
                                        : '<span class="badge bg-warning text-dark">Sin contenido</span>'}
                                    <span class="badge bg-light text-dark">${totalVersions} versi√≥n${totalVersions !== 1 ? 'es' : ''}</span>
                                    ${doc.is_active 
                                        ? '<span class="badge bg-success">Activo</span>'
                                        : '<span class="badge bg-secondary">Inactivo</span>'}
                                </div>
                                ${publishedDate 
                                    ? `<small class="text-muted d-block mt-1"><i class="bi bi-calendar me-1"></i>${publishedDate}</small>`
                                    : ''}
                            </div>
                            <div class="col-md-3 text-end">
                                <button class="btn btn-primary btn-sm me-1" onclick="abrirEditor('${doc.document_id}')" 
                                        title="Editar contenido">
                                    <i class="bi bi-pencil-square me-1"></i>Editar contenido
                                </button>
                                <button class="btn btn-outline-secondary btn-sm me-1" onclick="editarDocumento('${doc.document_id}')" 
                                        title="Editar datos">
                                    <i class="bi bi-gear"></i>
                                </button>
                                <button class="btn btn-outline-${doc.is_active ? 'warning' : 'success'} btn-sm" 
                                        onclick="toggleDocumento('${doc.document_id}', ${doc.is_active})"
                                        title="${doc.is_active ? 'Desactivar' : 'Activar'}">
                                    <i class="bi bi-${doc.is_active ? 'pause-circle' : 'play-circle'}"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // ==========================================
        // CRUD DOCUMENTO MAESTRO
        // ==========================================
        function abrirModalNuevoDocumento() {
            document.getElementById('modal-document-title').innerHTML = '<i class="bi bi-file-earmark-plus me-2"></i>Nuevo Documento Legal';
            document.getElementById('form-document').reset();
            document.getElementById('doc-id').value = '';
            document.getElementById('doc-active').checked = true;
            document.getElementById('doc-order').value = cacheDocuments.length + 1;
            modalDocument.show();
        }
        
        function editarDocumento(id) {
            const doc = cacheDocuments.find(d => d.document_id === id);
            if (!doc) return;
            document.getElementById('modal-document-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Documento';
            document.getElementById('doc-id').value = id;
            document.getElementById('doc-name').value = doc.document_name;
            document.getElementById('doc-description').value = doc.document_description || '';
            document.getElementById('doc-order').value = doc.document_order;
            document.getElementById('doc-active').checked = doc.is_active;
            modalDocument.show();
        }
        
        async function guardarDocumento(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-doc');
            btn.disabled = true;
            
            try {
                const id = document.getElementById('doc-id').value;
                const session = getStoredSession();
                const payload = {
                    document_name: document.getElementById('doc-name').value.trim(),
                    document_description: document.getElementById('doc-description').value.trim() || null,
                    document_order: parseInt(document.getElementById('doc-order').value) || 1,
                    is_active: document.getElementById('doc-active').checked
                };
                
                if (id) {
                    await supabaseRequest(`/sup_legal_documents?document_id=eq.${id}`, {
                        method: 'PATCH', body: JSON.stringify(payload)
                    });
                    showMessage('Documento actualizado', 'success');
                } else {
                    payload.created_by = session.user.user_id;
                    await supabaseRequest('/sup_legal_documents', {
                        method: 'POST', body: JSON.stringify(payload)
                    });
                    showMessage('Documento creado. Ahora puede editar su contenido.', 'success');
                }
                
                modalDocument.hide();
                await cargarDocumentos();
            } catch (error) {
                showMessage('Error: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
            }
        }
        
        async function toggleDocumento(id, currentState) {
            const action = currentState ? 'desactivar' : 'activar';
            if (!confirm(`¬ø${currentState ? 'Desactivar' : 'Activar'} este documento?\n\n${currentState ? 'No se mostrar√° a los proveedores al registrarse.' : 'Se mostrar√° a los proveedores al registrarse.'}`)) return;
            
            try {
                await supabaseRequest(`/sup_legal_documents?document_id=eq.${id}`, {
                    method: 'PATCH', body: JSON.stringify({ is_active: !currentState })
                });
                showMessage(`Documento ${action === 'desactivar' ? 'desactivado' : 'activado'}`, 'success');
                await cargarDocumentos();
            } catch (error) { showMessage('Error: ' + error.message, 'danger'); }
        }

        // ==========================================
        // EDITOR DE CONTENIDO
        // ==========================================
        async function abrirEditor(docId) {
            currentDocId = docId;
            const doc = cacheDocuments.find(d => d.document_id === docId);
            if (!doc) return;
            
            // Actualizar UI
            document.getElementById('editor-doc-name').textContent = doc.document_name;
            document.getElementById('view-list').style.display = 'none';
            document.getElementById('view-editor').style.display = 'block';
            
            // Cargar versiones
            await cargarVersiones(docId);
            
            // Cargar contenido actual en editor
            const versionActual = currentVersions.find(v => v.is_current);
            if (versionActual) {
                quillEditor.root.innerHTML = versionActual.content;
                document.getElementById('editor-version-badge').textContent = `Editando sobre v${versionActual.version_number}`;
                document.getElementById('editor-version-badge').className = 'badge bg-info ms-2';
            } else {
                quillEditor.setContents([]);
                document.getElementById('editor-version-badge').textContent = 'Primera versi√≥n';
                document.getElementById('editor-version-badge').className = 'badge bg-warning text-dark ms-2';
            }
        }
        
        async function cargarVersiones(docId) {
            try {
                const data = await supabaseRequest(
                    `/sup_legal_document_versions?document_id=eq.${docId}&select=version_id,version_number,content,is_current,published_at,published_by,users:published_by(user_display_name)&order=version_number.desc`
                );
                currentVersions = data || [];
                renderizarHistorial();
            } catch (error) {
                console.error('‚ùå Error cargando versiones:', error);
                // Intentar sin join de users
                try {
                    const data = await supabaseRequest(
                        `/sup_legal_document_versions?document_id=eq.${docId}&select=version_id,version_number,content,is_current,published_at,published_by&order=version_number.desc`
                    );
                    currentVersions = data || [];
                    renderizarHistorial();
                } catch (e) {
                    currentVersions = [];
                    renderizarHistorial();
                }
            }
        }
        
        function renderizarHistorial() {
            const container = document.getElementById('version-history');
            
            if (!currentVersions || currentVersions.length === 0) {
                container.innerHTML = '<p class="text-muted small text-center">Sin versiones previas.<br>Al publicar se crear√° la versi√≥n 1.</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="version-timeline">
                    ${currentVersions.map(v => {
                        const fecha = new Date(v.published_at).toLocaleDateString('es-CO', {
                            year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                        const autor = v.users 
                            ? v.users.user_display_name || ''
                            : '';
                        
                        return `
                        <div class="version-item ${v.is_current ? 'current' : ''}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>v${v.version_number}</strong>
                                    ${v.is_current ? '<span class="badge bg-success ms-1" style="font-size:0.6rem;">Actual</span>' : ''}
                                    <div class="small text-muted">${fecha}</div>
                                    ${autor ? `<div class="small text-muted"><i class="bi bi-person me-1"></i>${autor}</div>` : ''}
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" style="font-size:0.7rem; padding: 2px 6px;" 
                                        onclick="verVersion('${v.version_id}', ${v.version_number})" title="Ver esta versi√≥n">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>`;
                    }).join('')}
                </div>`;
        }
        
        function volverALista() {
            currentDocId = null;
            currentVersions = [];
            document.getElementById('view-editor').style.display = 'none';
            document.getElementById('view-list').style.display = 'block';
            cargarDocumentos(); // Refrescar por si se public√≥ algo
        }

        // ==========================================
        // PUBLICAR NUEVA VERSI√ìN
        // ==========================================
        async function publicarVersion() {
            const content = quillEditor.root.innerHTML;
            
            // Validar que hay contenido
            if (!content || content === '<p><br></p>' || content.trim() === '') {
                showMessage('El documento debe tener contenido para publicar.', 'warning');
                return;
            }
            
            // Calcular nuevo n√∫mero de versi√≥n
            const maxVersion = currentVersions.length > 0 
                ? Math.max(...currentVersions.map(v => v.version_number)) 
                : 0;
            const newVersionNumber = maxVersion + 1;
            
            const confirmMsg = newVersionNumber === 1
                ? '¬øPublicar la primera versi√≥n de este documento?'
                : `¬øPublicar la versi√≥n ${newVersionNumber}?\n\nLos proveedores que aceptaron versiones anteriores quedar√°n pendientes de re-aceptaci√≥n.`;
            
            if (!confirm(confirmMsg)) return;
            
            const btn = document.getElementById('btn-publish');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Publicando...';
            
            try {
                const session = getStoredSession();
                
                // PASO 1: Marcar todas las versiones anteriores como no actuales
                if (currentVersions.length > 0) {
                    await supabaseRequest(
                        `/sup_legal_document_versions?document_id=eq.${currentDocId}&is_current=eq.true`, {
                        method: 'PATCH',
                        body: JSON.stringify({ is_current: false })
                    });
                }
                
                // PASO 2: Crear nueva versi√≥n
                await supabaseRequest('/sup_legal_document_versions', {
                    method: 'POST',
                    body: JSON.stringify({
                        document_id: currentDocId,
                        version_number: newVersionNumber,
                        content: content,
                        is_current: true,
                        published_by: session.user.user_id
                    })
                });
                
                showMessage(`Versi√≥n ${newVersionNumber} publicada exitosamente`, 'success');
                
                // Recargar versiones y actualizar UI
                await cargarVersiones(currentDocId);
                document.getElementById('editor-version-badge').textContent = `Editando sobre v${newVersionNumber}`;
                document.getElementById('editor-version-badge').className = 'badge bg-info ms-2';
                
            } catch (error) {
                console.error('‚ùå Error publicando versi√≥n:', error);
                showMessage('Error al publicar: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-cloud-upload me-1"></i>Publicar nueva versi√≥n';
            }
        }

        // ==========================================
        // VER VERSI√ìN ANTERIOR
        // ==========================================
        async function verVersion(versionId, versionNumber) {
            viewingVersionId = versionId;
            
            try {
                const data = await supabaseRequest(
                    `/sup_legal_document_versions?version_id=eq.${versionId}&select=*,users:published_by(first_name,last_name)`
                );
                
                if (!data || data.length === 0) {
                    showMessage('No se pudo cargar la versi√≥n', 'warning');
                    return;
                }
                
                const version = data[0];
                const fecha = new Date(version.published_at).toLocaleDateString('es-CO', {
                    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                const autor = version.users 
                    ? version.users.user_display_name || 'No registrado'
                    : 'No registrado';
                
                document.getElementById('modal-version-view-title').innerHTML = 
                    `<i class="bi bi-clock-history me-2"></i>Versi√≥n ${version.version_number}${version.is_current ? ' (actual)' : ''}`;
                document.getElementById('vv-date').textContent = fecha;
                document.getElementById('vv-author').textContent = autor;
                document.getElementById('version-view-body').innerHTML = version.content;
                
                // Mostrar/ocultar bot√≥n restaurar
                document.getElementById('btn-restore').style.display = version.is_current ? 'none' : 'inline-block';
                
                modalVersionView.show();
                
            } catch (error) {
                // Si falla con join, intentar sin
                try {
                    const data = await supabaseRequest(
                        `/sup_legal_document_versions?version_id=eq.${versionId}&select=*`
                    );
                    if (data && data.length > 0) {
                        const version = data[0];
                        document.getElementById('modal-version-view-title').innerHTML = 
                            `<i class="bi bi-clock-history me-2"></i>Versi√≥n ${version.version_number}`;
                        document.getElementById('vv-date').textContent = new Date(version.published_at).toLocaleDateString('es-CO');
                        document.getElementById('vv-author').textContent = '--';
                        document.getElementById('version-view-body').innerHTML = version.content;
                        document.getElementById('btn-restore').style.display = version.is_current ? 'none' : 'inline-block';
                        modalVersionView.show();
                    }
                } catch (e) {
                    showMessage('Error al cargar la versi√≥n', 'danger');
                }
            }
        }
        
        function restaurarVersion() {
            if (!viewingVersionId) return;
            
            if (!confirm('¬øCargar el contenido de esta versi√≥n en el editor?\n\nEl contenido actual del editor ser√° reemplazado. No se publicar√° autom√°ticamente.')) return;
            
            const content = document.getElementById('version-view-body').innerHTML;
            quillEditor.root.innerHTML = content;
            
            modalVersionView.hide();
            showMessage('Contenido cargado en el editor. Revise y publique cuando est√© listo.', 'info');
        }

        // ==========================================
        // PREVISUALIZAR
        // ==========================================
        function previsualizarDocumento() {
            const content = quillEditor.root.innerHTML;
            
            if (!content || content === '<p><br></p>' || content.trim() === '') {
                showMessage('No hay contenido para previsualizar.', 'warning');
                return;
            }
            
            document.getElementById('preview-body').innerHTML = content;
            modalPreview.show();
        }
        
        console.log('‚úÖ Documentos Legales - SchoolNet cargado');
    </script>
</body>
</html>
