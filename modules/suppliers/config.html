<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.19.18.00">
    <title>Configuraci√≥n de Proveedores - SchoolNet</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Quill Editor -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center;
            align-items: center; z-index: 9999;
        }
        .loading-overlay.hidden { display: none; }
        .loading-content { background: white; padding: 2rem; border-radius: 8px; text-align: center; }
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #64748b;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 1rem;
        }
        @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
        
        .badge-count { font-size: 0.7rem; vertical-align: middle; }
        .search-box { max-width: 350px; }
        .table th { white-space: nowrap; }
        .btn-action { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        
        /* Quill editor dentro de modales */
        .ql-editor { min-height: 100px; max-height: 200px; overflow-y: auto; }
        .ql-container { font-size: 0.9rem; }
        .ql-toolbar { border-radius: 0.375rem 0.375rem 0 0; }
        .ql-container { border-radius: 0 0 0.375rem 0.375rem; }
        
        /* Descripci√≥n en tabla */
        .desc-preview { max-width: 300px; font-size: 0.85rem; color: #6c757d; }
        .desc-preview p { margin-bottom: 0.2rem; }
        .desc-preview ul, .desc-preview ol { margin-bottom: 0.2rem; padding-left: 1.2rem; }
        
        /* Badge applies_to */
        .badge-natural { background-color: #e0f2fe; color: #0369a1; }
        .badge-juridica { background-color: #fce7f3; color: #be185d; }
        .badge-both { background-color: #ecfccb; color: #4d7c0f; }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Proveedores</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Configuraci√≥n</li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-gear me-2" style="color: #64748b;"></i>
                    Configuraci√≥n del M√≥dulo
                </h1>
                <p class="text-muted">Reg√≠menes tributarios, condiciones tributarias y tipos de documentos adjuntos</p>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- TABS -->
        <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-regimes" data-bs-toggle="tab" data-bs-target="#panel-regimes" type="button" role="tab">
                    <i class="bi bi-receipt me-1"></i>Reg√≠menes
                    <span class="badge bg-secondary badge-count ms-1" id="count-regimes">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-conditions" data-bs-toggle="tab" data-bs-target="#panel-conditions" type="button" role="tab">
                    <i class="bi bi-check2-square me-1"></i>Condiciones Tributarias
                    <span class="badge bg-secondary badge-count ms-1" id="count-conditions">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-attachments" data-bs-toggle="tab" data-bs-target="#panel-attachments" type="button" role="tab">
                    <i class="bi bi-paperclip me-1"></i>Tipos de Adjuntos
                    <span class="badge bg-secondary badge-count ms-1" id="count-attachments">0</span>
                </button>
            </li>
        </ul>

        <div class="tab-content" id="configTabContent">

            <!-- ============================================ -->
            <!-- TAB: REG√çMENES TRIBUTARIOS                  -->
            <!-- ============================================ -->
            <div class="tab-pane fade show active" id="panel-regimes" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Reg√≠menes de Tributaci√≥n</h5>
                        <div class="d-flex gap-2">
                            <div class="input-group input-group-sm search-box">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="search-regimes" placeholder="Buscar..." oninput="filtrarTabla('regimes')">
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="abrirModalRegimen()">
                                <i class="bi bi-plus-circle me-1"></i>Nuevo
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width:60px;">Orden</th>
                                        <th>Nombre</th>
                                        <th>Descripci√≥n</th>
                                        <th>Estado</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-regimes">
                                    <tr><td colspan="5" class="text-center py-4 text-muted">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer text-muted small">
                        <i class="bi bi-info-circle me-1"></i>
                        Selecci√≥n √∫nica: el proveedor elige un solo r√©gimen al registrarse.
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- TAB: CONDICIONES TRIBUTARIAS                -->
            <!-- ============================================ -->
            <div class="tab-pane fade" id="panel-conditions" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5 class="mb-0"><i class="bi bi-check2-square me-2"></i>Condiciones Tributarias</h5>
                        <div class="d-flex gap-2">
                            <div class="input-group input-group-sm search-box">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="search-conditions" placeholder="Buscar..." oninput="filtrarTabla('conditions')">
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="abrirModalCondicion()">
                                <i class="bi bi-plus-circle me-1"></i>Nueva
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width:60px;">Orden</th>
                                        <th>Nombre</th>
                                        <th>Descripci√≥n</th>
                                        <th>Aplica a</th>
                                        <th>Estado</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-conditions">
                                    <tr><td colspan="6" class="text-center py-4 text-muted">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer text-muted small">
                        <i class="bi bi-info-circle me-1"></i>
                        Selecci√≥n m√∫ltiple (checkboxes): el proveedor puede marcar varias condiciones.
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- TAB: TIPOS DE ADJUNTOS                      -->
            <!-- ============================================ -->
            <div class="tab-pane fade" id="panel-attachments" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5 class="mb-0"><i class="bi bi-paperclip me-2"></i>Tipos de Documentos Adjuntos</h5>
                        <div class="d-flex gap-2">
                            <div class="input-group input-group-sm search-box">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="search-attachments" placeholder="Buscar..." oninput="filtrarTabla('attachments')">
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="abrirModalAdjunto()">
                                <i class="bi bi-plus-circle me-1"></i>Nuevo
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width:60px;">Orden</th>
                                        <th>Nombre</th>
                                        <th>Descripci√≥n</th>
                                        <th>Aplica a</th>
                                        <th>Obligatorio</th>
                                        <th>Tama√±o m√°x.</th>
                                        <th>Extensiones</th>
                                        <th>Estado</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-attachments">
                                    <tr><td colspan="9" class="text-center py-4 text-muted">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer text-muted small">
                        <i class="bi bi-info-circle me-1"></i>
                        Define los documentos que el proveedor debe adjuntar al registrarse. Los obligatorios bloquean el env√≠o del formulario.
                    </div>
                </div>
            </div>

        </div>
    </div>


    <!-- ============================================ -->
    <!-- MODAL: R√âGIMEN TRIBUTARIO                   -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-regime" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-regime-title">
                        <i class="bi bi-receipt me-2"></i>Nuevo R√©gimen
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-regime" onsubmit="guardarRegimen(event)">
                    <div class="modal-body">
                        <input type="hidden" id="regime-id">
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="regime-name" class="form-label">Nombre <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="regime-name" required maxlength="150">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="regime-order" class="form-label">Orden</label>
                                <input type="number" class="form-control" id="regime-order" value="1" min="1">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n</label>
                            <div id="editor-regime"></div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="regime-active" checked>
                            <label class="form-check-label" for="regime-active">Activo</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btn-save-regime">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- ============================================ -->
    <!-- MODAL: CONDICI√ìN TRIBUTARIA                 -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-condition" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-condition-title">
                        <i class="bi bi-check2-square me-2"></i>Nueva Condici√≥n
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-condition" onsubmit="guardarCondicion(event)">
                    <div class="modal-body">
                        <input type="hidden" id="condition-id">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="condition-name" class="form-label">Nombre <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="condition-name" required maxlength="200">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="condition-applies" class="form-label">Aplica a <span class="text-danger">*</span></label>
                                <select class="form-select" id="condition-applies" required>
                                    <option value="both">Ambos (Natural y Jur√≠dica)</option>
                                    <option value="natural">Solo Persona Natural</option>
                                    <option value="juridica">Solo Persona Jur√≠dica</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="condition-order" class="form-label">Orden</label>
                                <input type="number" class="form-control" id="condition-order" value="1" min="1">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n</label>
                            <div id="editor-condition"></div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="condition-active" checked>
                            <label class="form-check-label" for="condition-active">Activo</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btn-save-condition">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- ============================================ -->
    <!-- MODAL: TIPO DE ADJUNTO                      -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-attachment" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-attachment-title">
                        <i class="bi bi-paperclip me-2"></i>Nuevo Tipo de Adjunto
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-attachment" onsubmit="guardarAdjunto(event)">
                    <div class="modal-body">
                        <input type="hidden" id="attach-id">
                        <div class="mb-3">
                            <label for="attach-name" class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="attach-name" required maxlength="200"
                                   placeholder="Ej: RUT actualizado (no mayor a 60 d√≠as)">
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="attach-applies" class="form-label">Aplica a <span class="text-danger">*</span></label>
                                <select class="form-select" id="attach-applies" required>
                                    <option value="both">Ambos</option>
                                    <option value="natural">Solo Natural</option>
                                    <option value="juridica">Solo Jur√≠dica</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="attach-size" class="form-label">Tama√±o m√°x. (MB)</label>
                                <input type="number" class="form-control" id="attach-size" value="5" min="1" max="50">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="attach-order" class="form-label">Orden</label>
                                <input type="number" class="form-control" id="attach-order" value="1" min="1">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="attach-extensions" class="form-label">Extensiones permitidas</label>
                            <input type="text" class="form-control" id="attach-extensions" value="pdf,jpg,jpeg,png"
                                   placeholder="pdf,jpg,jpeg,png">
                            <div class="form-text">Separadas por coma, sin punto. Ej: pdf,jpg,jpeg,png,doc,docx</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n</label>
                            <div id="editor-attachment"></div>
                        </div>
                        <div class="d-flex gap-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="attach-required" checked>
                                <label class="form-check-label" for="attach-required">
                                    <strong>Obligatorio</strong> <small class="text-muted">(bloquea el env√≠o si falta)</small>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="attach-active" checked>
                                <label class="form-check-label" for="attach-active">Activo</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btn-save-attachment">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let cacheRegimes = [];
        let cacheConditions = [];
        let cacheAttachments = [];
        
        let modalRegime, modalCondition, modalAttachment;
        let quillRegime, quillCondition, quillAttachment;
        
        // Opciones compartidas del editor Quill
        const QUILL_OPTIONS = {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link'],
                    ['clean']
                ]
            },
            placeholder: 'Descripci√≥n opcional con formato...'
        };
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando Configuraci√≥n de Proveedores...');
            
            try {
                const hasAccess = await validatePageAccess('Configurar m√≥dulo de proveedores');
                if (!hasAccess) return;
                
                console.log('‚úÖ Acceso permitido');
                
                const session = getStoredSession();
                if (!session) {
                    showMessage('Sesi√≥n no v√°lida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '/login.html', 2000);
                    return;
                }
                
                // Inicializar modales
                modalRegime = new bootstrap.Modal(document.getElementById('modal-regime'));
                modalCondition = new bootstrap.Modal(document.getElementById('modal-condition'));
                modalAttachment = new bootstrap.Modal(document.getElementById('modal-attachment'));
                
                // Inicializar editores Quill
                quillRegime = new Quill('#editor-regime', QUILL_OPTIONS);
                quillCondition = new Quill('#editor-condition', QUILL_OPTIONS);
                quillAttachment = new Quill('#editor-attachment', QUILL_OPTIONS);
                
                // Cargar datos iniciales
                await cargarRegimenes();
                
                // Cargar tabs lazy
                document.getElementById('tab-conditions').addEventListener('shown.bs.tab', function() {
                    if (cacheConditions.length === 0) cargarCondiciones();
                });
                document.getElementById('tab-attachments').addEventListener('shown.bs.tab', function() {
                    if (cacheAttachments.length === 0) cargarAdjuntos();
                });
                
                console.log('‚úÖ Configuraci√≥n inicializada');
                
            } catch (error) {
                console.error('‚ùå Error inicializando configuraci√≥n:', error);
                showMessage('Error al cargar: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // UTILIDADES
        // ==========================================
        function badgeAppliesTo(value) {
            const map = {
                'both': '<span class="badge badge-both">Ambos</span>',
                'natural': '<span class="badge badge-natural">P. Natural</span>',
                'juridica': '<span class="badge badge-juridica">P. Jur√≠dica</span>'
            };
            return map[value] || value;
        }
        
        function descPreview(html) {
            if (!html || html === '<p><br></p>') return '<span class="text-muted">‚Äî</span>';
            return `<div class="desc-preview">${html}</div>`;
        }
        
        function getQuillHTML(quillInstance) {
            const html = quillInstance.root.innerHTML;
            // Si est√° vac√≠o, retornar null
            if (html === '<p><br></p>' || html.trim() === '') return null;
            return html;
        }

        // ==========================================
        // REG√çMENES TRIBUTARIOS
        // ==========================================
        async function cargarRegimenes() {
            try {
                const data = await supabaseRequest('/sup_tax_regimes?select=*&order=regime_order.asc');
                cacheRegimes = data || [];
                document.getElementById('count-regimes').textContent = cacheRegimes.length;
                renderizarRegimenes(cacheRegimes);
            } catch (error) {
                console.error('‚ùå Error cargando reg√≠menes:', error);
                document.getElementById('tbody-regimes').innerHTML =
                    '<tr><td colspan="5" class="text-center text-danger py-4">Error al cargar</td></tr>';
            }
        }
        
        function renderizarRegimenes(datos) {
            const tbody = document.getElementById('tbody-regimes');
            if (!datos || datos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size:2rem;"></i>
                    <p class="mt-2 mb-0">No hay reg√≠menes registrados</p></td></tr>`;
                return;
            }
            tbody.innerHTML = datos.map(r => `
                <tr>
                    <td class="text-center"><span class="badge bg-light text-dark">${r.regime_order}</span></td>
                    <td><strong>${r.regime_name}</strong></td>
                    <td>${descPreview(r.regime_description)}</td>
                    <td>${r.is_active
                        ? '<span class="badge bg-success">Activo</span>'
                        : '<span class="badge bg-secondary">Inactivo</span>'}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-primary btn-action me-1" onclick="editarRegimen('${r.regime_id}')" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-${r.is_active ? 'warning' : 'success'} btn-action" onclick="toggleRegimen('${r.regime_id}', ${r.is_active})" title="${r.is_active ? 'Desactivar' : 'Activar'}">
                            <i class="bi bi-${r.is_active ? 'pause-circle' : 'play-circle'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function abrirModalRegimen() {
            document.getElementById('modal-regime-title').innerHTML = '<i class="bi bi-receipt me-2"></i>Nuevo R√©gimen';
            document.getElementById('form-regime').reset();
            document.getElementById('regime-id').value = '';
            document.getElementById('regime-active').checked = true;
            document.getElementById('regime-order').value = cacheRegimes.length + 1;
            quillRegime.setContents([]);
            modalRegime.show();
        }
        
        function editarRegimen(id) {
            const r = cacheRegimes.find(x => x.regime_id === id);
            if (!r) return;
            document.getElementById('modal-regime-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar R√©gimen';
            document.getElementById('regime-id').value = id;
            document.getElementById('regime-name').value = r.regime_name;
            document.getElementById('regime-order').value = r.regime_order;
            document.getElementById('regime-active').checked = r.is_active;
            
            if (r.regime_description) {
                quillRegime.root.innerHTML = r.regime_description;
            } else {
                quillRegime.setContents([]);
            }
            modalRegime.show();
        }
        
        async function guardarRegimen(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-regime');
            btn.disabled = true;
            try {
                const id = document.getElementById('regime-id').value;
                const payload = {
                    regime_name: document.getElementById('regime-name').value.trim(),
                    regime_description: getQuillHTML(quillRegime),
                    regime_order: parseInt(document.getElementById('regime-order').value) || 1,
                    is_active: document.getElementById('regime-active').checked
                };
                
                if (id) {
                    await supabaseRequest(`/sup_tax_regimes?regime_id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(payload) });
                    showMessage('R√©gimen actualizado', 'success');
                } else {
                    await supabaseRequest('/sup_tax_regimes', { method: 'POST', body: JSON.stringify(payload) });
                    showMessage('R√©gimen creado', 'success');
                }
                modalRegime.hide();
                await cargarRegimenes();
            } catch (error) {
                showMessage('Error: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
            }
        }
        
        async function toggleRegimen(id, currentState) {
            if (!confirm(`¬ø${currentState ? 'Desactivar' : 'Activar'} este r√©gimen?`)) return;
            try {
                await supabaseRequest(`/sup_tax_regimes?regime_id=eq.${id}`, {
                    method: 'PATCH', body: JSON.stringify({ is_active: !currentState })
                });
                showMessage(`R√©gimen ${currentState ? 'desactivado' : 'activado'}`, 'success');
                await cargarRegimenes();
            } catch (error) { showMessage('Error: ' + error.message, 'danger'); }
        }

        // ==========================================
        // CONDICIONES TRIBUTARIAS
        // ==========================================
        async function cargarCondiciones() {
            try {
                const data = await supabaseRequest('/sup_tax_conditions?select=*&order=condition_order.asc');
                cacheConditions = data || [];
                document.getElementById('count-conditions').textContent = cacheConditions.length;
                renderizarCondiciones(cacheConditions);
            } catch (error) {
                console.error('‚ùå Error cargando condiciones:', error);
                document.getElementById('tbody-conditions').innerHTML =
                    '<tr><td colspan="6" class="text-center text-danger py-4">Error al cargar</td></tr>';
            }
        }
        
        function renderizarCondiciones(datos) {
            const tbody = document.getElementById('tbody-conditions');
            if (!datos || datos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size:2rem;"></i>
                    <p class="mt-2 mb-0">No hay condiciones registradas</p></td></tr>`;
                return;
            }
            tbody.innerHTML = datos.map(c => `
                <tr>
                    <td class="text-center"><span class="badge bg-light text-dark">${c.condition_order}</span></td>
                    <td><strong>${c.condition_name}</strong></td>
                    <td>${descPreview(c.condition_description)}</td>
                    <td>${badgeAppliesTo(c.applies_to)}</td>
                    <td>${c.is_active
                        ? '<span class="badge bg-success">Activo</span>'
                        : '<span class="badge bg-secondary">Inactivo</span>'}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-primary btn-action me-1" onclick="editarCondicion('${c.condition_id}')" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-${c.is_active ? 'warning' : 'success'} btn-action" onclick="toggleCondicion('${c.condition_id}', ${c.is_active})" title="${c.is_active ? 'Desactivar' : 'Activar'}">
                            <i class="bi bi-${c.is_active ? 'pause-circle' : 'play-circle'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function abrirModalCondicion() {
            document.getElementById('modal-condition-title').innerHTML = '<i class="bi bi-check2-square me-2"></i>Nueva Condici√≥n';
            document.getElementById('form-condition').reset();
            document.getElementById('condition-id').value = '';
            document.getElementById('condition-applies').value = 'both';
            document.getElementById('condition-active').checked = true;
            document.getElementById('condition-order').value = cacheConditions.length + 1;
            quillCondition.setContents([]);
            modalCondition.show();
        }
        
        function editarCondicion(id) {
            const c = cacheConditions.find(x => x.condition_id === id);
            if (!c) return;
            document.getElementById('modal-condition-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Condici√≥n';
            document.getElementById('condition-id').value = id;
            document.getElementById('condition-name').value = c.condition_name;
            document.getElementById('condition-applies').value = c.applies_to;
            document.getElementById('condition-order').value = c.condition_order;
            document.getElementById('condition-active').checked = c.is_active;
            
            if (c.condition_description) {
                quillCondition.root.innerHTML = c.condition_description;
            } else {
                quillCondition.setContents([]);
            }
            modalCondition.show();
        }
        
        async function guardarCondicion(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-condition');
            btn.disabled = true;
            try {
                const id = document.getElementById('condition-id').value;
                const payload = {
                    condition_name: document.getElementById('condition-name').value.trim(),
                    condition_description: getQuillHTML(quillCondition),
                    applies_to: document.getElementById('condition-applies').value,
                    condition_order: parseInt(document.getElementById('condition-order').value) || 1,
                    is_active: document.getElementById('condition-active').checked
                };
                
                if (id) {
                    await supabaseRequest(`/sup_tax_conditions?condition_id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(payload) });
                    showMessage('Condici√≥n actualizada', 'success');
                } else {
                    await supabaseRequest('/sup_tax_conditions', { method: 'POST', body: JSON.stringify(payload) });
                    showMessage('Condici√≥n creada', 'success');
                }
                modalCondition.hide();
                await cargarCondiciones();
            } catch (error) {
                showMessage('Error: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
            }
        }
        
        async function toggleCondicion(id, currentState) {
            if (!confirm(`¬ø${currentState ? 'Desactivar' : 'Activar'} esta condici√≥n?`)) return;
            try {
                await supabaseRequest(`/sup_tax_conditions?condition_id=eq.${id}`, {
                    method: 'PATCH', body: JSON.stringify({ is_active: !currentState })
                });
                showMessage(`Condici√≥n ${currentState ? 'desactivada' : 'activada'}`, 'success');
                await cargarCondiciones();
            } catch (error) { showMessage('Error: ' + error.message, 'danger'); }
        }

        // ==========================================
        // TIPOS DE ADJUNTOS
        // ==========================================
        async function cargarAdjuntos() {
            try {
                const data = await supabaseRequest('/sup_attachment_types?select=*&order=type_order.asc');
                cacheAttachments = data || [];
                document.getElementById('count-attachments').textContent = cacheAttachments.length;
                renderizarAdjuntos(cacheAttachments);
            } catch (error) {
                console.error('‚ùå Error cargando adjuntos:', error);
                document.getElementById('tbody-attachments').innerHTML =
                    '<tr><td colspan="9" class="text-center text-danger py-4">Error al cargar</td></tr>';
            }
        }
        
        function renderizarAdjuntos(datos) {
            const tbody = document.getElementById('tbody-attachments');
            if (!datos || datos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size:2rem;"></i>
                    <p class="mt-2 mb-0">No hay tipos de adjuntos registrados</p></td></tr>`;
                return;
            }
            tbody.innerHTML = datos.map(a => `
                <tr>
                    <td class="text-center"><span class="badge bg-light text-dark">${a.type_order}</span></td>
                    <td><strong>${a.type_name}</strong></td>
                    <td>${descPreview(a.type_description)}</td>
                    <td>${badgeAppliesTo(a.applies_to)}</td>
                    <td class="text-center">${a.is_required
                        ? '<i class="bi bi-check-circle-fill text-success"></i>'
                        : '<i class="bi bi-dash-circle text-muted"></i>'}</td>
                    <td class="text-center">${a.max_file_size_mb} MB</td>
                    <td><code class="small">${a.allowed_extensions || '-'}</code></td>
                    <td>${a.is_active
                        ? '<span class="badge bg-success">Activo</span>'
                        : '<span class="badge bg-secondary">Inactivo</span>'}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-primary btn-action me-1" onclick="editarAdjunto('${a.attachment_type_id}')" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-${a.is_active ? 'warning' : 'success'} btn-action" onclick="toggleAdjunto('${a.attachment_type_id}', ${a.is_active})" title="${a.is_active ? 'Desactivar' : 'Activar'}">
                            <i class="bi bi-${a.is_active ? 'pause-circle' : 'play-circle'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function abrirModalAdjunto() {
            document.getElementById('modal-attachment-title').innerHTML = '<i class="bi bi-paperclip me-2"></i>Nuevo Tipo de Adjunto';
            document.getElementById('form-attachment').reset();
            document.getElementById('attach-id').value = '';
            document.getElementById('attach-applies').value = 'both';
            document.getElementById('attach-required').checked = true;
            document.getElementById('attach-active').checked = true;
            document.getElementById('attach-size').value = 5;
            document.getElementById('attach-extensions').value = 'pdf,jpg,jpeg,png';
            document.getElementById('attach-order').value = cacheAttachments.length + 1;
            quillAttachment.setContents([]);
            modalAttachment.show();
        }
        
        function editarAdjunto(id) {
            const a = cacheAttachments.find(x => x.attachment_type_id === id);
            if (!a) return;
            document.getElementById('modal-attachment-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Tipo de Adjunto';
            document.getElementById('attach-id').value = id;
            document.getElementById('attach-name').value = a.type_name;
            document.getElementById('attach-applies').value = a.applies_to;
            document.getElementById('attach-size').value = a.max_file_size_mb;
            document.getElementById('attach-extensions').value = a.allowed_extensions || '';
            document.getElementById('attach-order').value = a.type_order;
            document.getElementById('attach-required').checked = a.is_required;
            document.getElementById('attach-active').checked = a.is_active;
            
            if (a.type_description) {
                quillAttachment.root.innerHTML = a.type_description;
            } else {
                quillAttachment.setContents([]);
            }
            modalAttachment.show();
        }
        
        async function guardarAdjunto(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-attachment');
            btn.disabled = true;
            try {
                const id = document.getElementById('attach-id').value;
                const payload = {
                    type_name: document.getElementById('attach-name').value.trim(),
                    type_description: getQuillHTML(quillAttachment),
                    applies_to: document.getElementById('attach-applies').value,
                    is_required: document.getElementById('attach-required').checked,
                    max_file_size_mb: parseInt(document.getElementById('attach-size').value) || 5,
                    allowed_extensions: document.getElementById('attach-extensions').value.trim() || 'pdf,jpg,jpeg,png',
                    type_order: parseInt(document.getElementById('attach-order').value) || 1,
                    is_active: document.getElementById('attach-active').checked
                };
                
                if (id) {
                    await supabaseRequest(`/sup_attachment_types?attachment_type_id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(payload) });
                    showMessage('Tipo de adjunto actualizado', 'success');
                } else {
                    await supabaseRequest('/sup_attachment_types', { method: 'POST', body: JSON.stringify(payload) });
                    showMessage('Tipo de adjunto creado', 'success');
                }
                modalAttachment.hide();
                await cargarAdjuntos();
            } catch (error) {
                showMessage('Error: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
            }
        }
        
        async function toggleAdjunto(id, currentState) {
            if (!confirm(`¬ø${currentState ? 'Desactivar' : 'Activar'} este tipo de adjunto?`)) return;
            try {
                await supabaseRequest(`/sup_attachment_types?attachment_type_id=eq.${id}`, {
                    method: 'PATCH', body: JSON.stringify({ is_active: !currentState })
                });
                showMessage(`Tipo de adjunto ${currentState ? 'desactivado' : 'activado'}`, 'success');
                await cargarAdjuntos();
            } catch (error) { showMessage('Error: ' + error.message, 'danger'); }
        }

        // ==========================================
        // FILTRO DE B√öSQUEDA
        // ==========================================
        function filtrarTabla(tipo) {
            const texto = document.getElementById(`search-${tipo}`).value.toLowerCase();
            
            if (tipo === 'regimes') {
                const filtrados = cacheRegimes.filter(r =>
                    r.regime_name.toLowerCase().includes(texto)
                );
                renderizarRegimenes(filtrados);
            } else if (tipo === 'conditions') {
                const filtrados = cacheConditions.filter(c =>
                    c.condition_name.toLowerCase().includes(texto) ||
                    c.applies_to.toLowerCase().includes(texto)
                );
                renderizarCondiciones(filtrados);
            } else if (tipo === 'attachments') {
                const filtrados = cacheAttachments.filter(a =>
                    a.type_name.toLowerCase().includes(texto) ||
                    a.applies_to.toLowerCase().includes(texto)
                );
                renderizarAdjuntos(filtrados);
            }
        }
        
        console.log('‚úÖ Configuraci√≥n de Proveedores - SchoolNet cargado');
    </script>
</body>
</html>
