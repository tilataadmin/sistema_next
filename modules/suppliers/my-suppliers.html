<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.20.10.00">
    <title>Mis Proveedores - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .loading-overlay.hidden { display: none; }
        .loading-content { background: white; padding: 2rem; border-radius: 8px; text-align: center; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Status badges */
        .badge-pending { background-color: #ffc107; color: #000; }
        .badge-approved { background-color: #198754; }
        .badge-rejected { background-color: #dc3545; }
        .badge-inactive { background-color: #6c757d; }
        .badge-natural { background-color: #0d6efd; }
        .badge-juridica { background-color: #6f42c1; }

        /* Search & filters */
        .search-card { border: 2px solid #e9ecef; border-radius: 12px; }
        .search-card .card-body { padding: 1rem 1.25rem; }
        
        /* Table */
        .table-suppliers td { vertical-align: middle; }
        .table-suppliers .supplier-name { font-weight: 600; }
        .table-suppliers .supplier-doc { font-size: 0.85rem; color: #6c757d; }
        
        /* Clickable rows */
        .row-clickable { cursor: pointer; transition: background-color 0.15s; }
        .row-clickable:hover { background-color: #f0f4ff !important; }
        
        /* Detail modal sections */
        .detail-section { border-left: 3px solid #0d6efd; padding-left: 1rem; margin-bottom: 1.5rem; }
        .detail-section h6 { color: #0d6efd; font-weight: 700; margin-bottom: 0.75rem; }
        .detail-field { margin-bottom: 0.5rem; }
        .detail-label { font-size: 0.8rem; color: #6c757d; margin-bottom: 0; }
        .detail-value { font-weight: 500; }
        
        /* Attachment links */
        .attachment-item { display: flex; align-items: center; padding: 0.5rem 0.75rem; background: #f8f9fa; border-radius: 6px; margin-bottom: 0.5rem; }
        .attachment-item i { font-size: 1.2rem; margin-right: 0.5rem; color: #dc3545; }
        .attachment-item a { text-decoration: none; flex: 1; }
        .attachment-item .file-size { font-size: 0.8rem; color: #6c757d; }

        /* Counter badges */
        .counter-badge { font-size: 1.5rem; font-weight: 700; }
        .counter-card { border-radius: 10px; border: none; transition: transform 0.2s; }
        .counter-card:hover { transform: translateY(-2px); }

        /* No-access message */
        .no-access-container { text-align: center; padding: 4rem 2rem; }
        .no-access-container i { font-size: 4rem; color: #6c757d; opacity: 0.5; }
    </style>
</head>

<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <div class="container-fluid">
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a></li>
                <li class="breadcrumb-item"><a href="index.html">Proveedores</a></li>
                <li class="breadcrumb-item active" aria-current="page">Mis Proveedores</li>
            </ol>
        </nav>

        <!-- HEADER -->
        <div class="row mb-3">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-person-lines-fill me-2"></i>Mis Proveedores
                </h1>
                <p class="text-muted mb-0">Proveedores asignados bajo mi responsabilidad</p>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- ============================================ -->
        <!-- CONTENIDO PRINCIPAL (se muestra tras validar) -->
        <!-- ============================================ -->
        <div id="main-content" style="display: none;">

            <!-- CONTADORES R√ÅPIDOS -->
            <div class="row mb-3" id="counters-row">
                <div class="col-6 col-md-3 mb-2">
                    <div class="card counter-card shadow-sm" style="border-left: 4px solid #ffc107;">
                        <div class="card-body py-2 px-3 d-flex align-items-center justify-content-between">
                            <div>
                                <div class="counter-badge text-warning" id="count-pending">0</div>
                                <small class="text-muted">Pendientes</small>
                            </div>
                            <i class="bi bi-clock-history text-warning" style="font-size:1.8rem; opacity:0.5;"></i>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3 mb-2">
                    <div class="card counter-card shadow-sm" style="border-left: 4px solid #198754;">
                        <div class="card-body py-2 px-3 d-flex align-items-center justify-content-between">
                            <div>
                                <div class="counter-badge text-success" id="count-approved">0</div>
                                <small class="text-muted">Aprobados</small>
                            </div>
                            <i class="bi bi-check-circle text-success" style="font-size:1.8rem; opacity:0.5;"></i>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3 mb-2">
                    <div class="card counter-card shadow-sm" style="border-left: 4px solid #dc3545;">
                        <div class="card-body py-2 px-3 d-flex align-items-center justify-content-between">
                            <div>
                                <div class="counter-badge text-danger" id="count-rejected">0</div>
                                <small class="text-muted">Rechazados</small>
                            </div>
                            <i class="bi bi-x-circle text-danger" style="font-size:1.8rem; opacity:0.5;"></i>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3 mb-2">
                    <div class="card counter-card shadow-sm" style="border-left: 4px solid #0d6efd;">
                        <div class="card-body py-2 px-3 d-flex align-items-center justify-content-between">
                            <div>
                                <div class="counter-badge text-primary" id="count-total">0</div>
                                <small class="text-muted">Total</small>
                            </div>
                            <i class="bi bi-people text-primary" style="font-size:1.8rem; opacity:0.5;"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BUSCADORES Y FILTROS -->
            <div class="card search-card mb-3">
                <div class="card-body">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label small mb-1">
                                <i class="bi bi-search me-1"></i>Nombre / Raz√≥n Social
                            </label>
                            <input type="text" class="form-control" id="search-name" 
                                   placeholder="Buscar por nombre o raz√≥n social..."
                                   oninput="filtrarProveedores()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small mb-1">
                                <i class="bi bi-box-seam me-1"></i>Productos / Servicios
                            </label>
                            <input type="text" class="form-control" id="search-services" 
                                   placeholder="Productos o servicios..."
                                   oninput="filtrarProveedores()">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small mb-1">Estado</label>
                            <select class="form-select" id="filter-status" onchange="filtrarProveedores()">
                                <option value="">Todos</option>
                                <option value="pending">Pendientes</option>
                                <option value="approved" selected>Aprobados</option>
                                <option value="rejected">Rechazados</option>
                                <option value="inactive">Inactivos</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small mb-1"><i class="bi bi-sort-down me-1"></i>Ordenar</label>
                            <select class="form-select" id="sort-order" onchange="filtrarProveedores()">
                                <option value="created_desc">M√°s recientes</option>
                                <option value="created_asc">M√°s antiguos</option>
                                <option value="name_asc">Nombre A ‚Üí Z</option>
                                <option value="name_desc">Nombre Z ‚Üí A</option>
                                <option value="status">Por estado</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-outline-secondary w-100" onclick="limpiarFiltros()" title="Limpiar filtros">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TABLA DE PROVEEDORES -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        Mis Proveedores Asignados
                        <span class="badge bg-secondary ms-2" id="count-filtered">0</span>
                    </h5>
                    <button class="btn btn-outline-secondary btn-sm" onclick="cargarMisProveedores()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-suppliers mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Proveedor</th>
                                    <th>Documento</th>
                                    <th class="d-none d-lg-table-cell">Productos / Servicios</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                    <th class="d-none d-md-table-cell">Registro</th>
                                    <th class="text-center">Detalle</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-suppliers">
                                <tr><td colspan="7" class="text-center py-4 text-muted">
                                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>Cargando proveedores...
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div><!-- /main-content -->

        <!-- MENSAJE SI NO TIENE PROVEEDORES O NO ES WORKER -->
        <div id="no-access-content" style="display: none;">
            <div class="no-access-container">
                <i class="bi bi-person-x"></i>
                <h4 class="mt-3 text-muted" id="no-access-title">Sin proveedores asignados</h4>
                <p class="text-muted" id="no-access-message">
                    No tienes proveedores asignados bajo tu responsabilidad en este momento.
                </p>
                <a href="index.html" class="btn btn-outline-primary mt-2">
                    <i class="bi bi-arrow-left me-1"></i>Volver al m√≥dulo
                </a>
            </div>
        </div>

    </div><!-- /container-fluid -->


    <!-- ============================================ -->
    <!-- MODAL: DETALLE DEL PROVEEDOR (solo lectura)  -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-detail" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detail-title">
                        <i class="bi bi-person-badge me-2"></i>Detalle del Proveedor
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detail-body">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-2">Cargando informaci√≥n...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let cacheSuppliers = [];
        let currentSession = null;
        let currentWorkerId = null;
        let modalDetail = null;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de sesi√≥n...');
            
            try {
                // Validar sesi√≥n activa (sin validar permiso espec√≠fico)
                currentSession = getStoredSession();
                if (!currentSession || !currentSession.user) {
                    showMessage('Sesi√≥n no v√°lida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '../../index.html', 2000);
                    return;
                }

                console.log('‚úÖ Sesi√≥n activa:', currentSession.user.user_mail);

                // Inicializar modal
                modalDetail = new bootstrap.Modal(document.getElementById('modal-detail'));

                // Buscar si el usuario es un worker
                const workerFound = await buscarWorkerPorEmail(currentSession.user.user_mail);
                
                if (!workerFound) {
                    console.log('‚ö†Ô∏è No se encontr√≥ worker asociado al email:', currentSession.user.user_mail);
                    mostrarSinAcceso('No eres un trabajador registrado', 
                        'Tu cuenta de usuario no est√° vinculada a un registro de trabajador. Esta p√°gina es exclusiva para trabajadores con proveedores asignados.');
                    return;
                }

                currentWorkerId = workerFound.worker_id;
                console.log('‚úÖ Worker identificado:', currentWorkerId);

                // Cargar proveedores asignados
                await cargarMisProveedores();

            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                showMessage('Error al inicializar: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // BUSCAR WORKER POR EMAIL
        // ==========================================

        async function buscarWorkerPorEmail(email) {
            try {
                const data = await supabaseRequest(
                    `/workers?select=worker_id,worker_first_name,worker_last_name_1&email=eq.${encodeURIComponent(email)}&worker_status=eq.active`
                );
                return (data && data.length > 0) ? data[0] : null;
            } catch (error) {
                console.error('‚ùå Error buscando worker:', error);
                return null;
            }
        }

        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        
        async function cargarMisProveedores() {
            try {
                const data = await supabaseRequest(
                    '/sup_suppliers?select=' +
                    '*,' +
                    'sup_departments(department_name),' +
                    'sup_municipalities(municipality_name),' +
                    'sup_banks(bank_name),' +
                    'sup_ciiu_activities(ciiu_code,ciiu_description),' +
                    'sup_tax_regimes(regime_name),' +
                    'approved_by_user:users!sup_suppliers_approved_by_fkey(user_name)' +
                    '&responsible_worker_id=eq.' + currentWorkerId +
                    '&order=created_at.desc'
                );
                
                cacheSuppliers = data || [];
                
                if (cacheSuppliers.length === 0) {
                    mostrarSinAcceso('Sin proveedores asignados',
                        'No tienes proveedores asignados bajo tu responsabilidad en este momento.');
                    return;
                }

                // Mostrar contenido principal
                document.getElementById('main-content').style.display = '';
                document.getElementById('no-access-content').style.display = 'none';

                actualizarContadores();
                filtrarProveedores();
                
                console.log(`‚úÖ ${cacheSuppliers.length} proveedores cargados para worker ${currentWorkerId}`);
            } catch (error) {
                console.error('‚ùå Error cargando proveedores:', error);
                document.getElementById('tbody-suppliers').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger py-4">Error al cargar proveedores</td></tr>';
            }
        }

        // ==========================================
        // MOSTRAR MENSAJE SIN ACCESO
        // ==========================================

        function mostrarSinAcceso(titulo, mensaje) {
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('no-access-content').style.display = '';
            document.getElementById('no-access-title').textContent = titulo;
            document.getElementById('no-access-message').textContent = mensaje;
        }

        // ==========================================
        // CONTADORES
        // ==========================================
        
        function actualizarContadores() {
            const counts = { pending: 0, approved: 0, rejected: 0, inactive: 0 };
            cacheSuppliers.forEach(s => {
                if (counts[s.supplier_status] !== undefined) counts[s.supplier_status]++;
            });
            
            document.getElementById('count-pending').textContent = counts.pending;
            document.getElementById('count-approved').textContent = counts.approved;
            document.getElementById('count-rejected').textContent = counts.rejected;
            document.getElementById('count-total').textContent = cacheSuppliers.length;
        }

        // ==========================================
        // FILTROS Y B√öSQUEDA
        // ==========================================
        
        function filtrarProveedores() {
            const searchName = document.getElementById('search-name').value.toLowerCase().trim();
            const searchServices = document.getElementById('search-services').value.toLowerCase().trim();
            const filterStatus = document.getElementById('filter-status').value;
            
            const filtered = cacheSuppliers.filter(s => {
                if (filterStatus && s.supplier_status !== filterStatus) return false;
                
                if (searchName) {
                    const nameFields = [
                        s.business_name,
                        s.first_name, s.second_name,
                        s.last_name_1, s.last_name_2,
                        s.contact_name
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    if (!nameFields.includes(searchName)) return false;
                }
                
                if (searchServices) {
                    const services = (s.products_services || '').toLowerCase();
                    if (!services.includes(searchServices)) return false;
                }
                
                return true;
            });
            
            document.getElementById('count-filtered').textContent = filtered.length;
            
            const sortOrder = document.getElementById('sort-order').value;
            filtered.sort((a, b) => {
                switch (sortOrder) {
                    case 'created_asc':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'name_asc':
                        return getNombreProveedor(a).localeCompare(getNombreProveedor(b));
                    case 'name_desc':
                        return getNombreProveedor(b).localeCompare(getNombreProveedor(a));
                    case 'status':
                        const order = { pending: 0, approved: 1, rejected: 2, inactive: 3 };
                        return (order[a.supplier_status] ?? 9) - (order[b.supplier_status] ?? 9);
                    case 'created_desc':
                    default:
                        return new Date(b.created_at) - new Date(a.created_at);
                }
            });
            
            renderizarTabla(filtered);
        }

        function limpiarFiltros() {
            document.getElementById('search-name').value = '';
            document.getElementById('search-services').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('sort-order').value = 'created_desc';
            filtrarProveedores();
        }

        // ==========================================
        // RENDERIZAR TABLA
        // ==========================================
        
        function renderizarTabla(datos) {
            const tbody = document.getElementById('tbody-suppliers');
            
            if (!datos || datos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size:2rem;"></i>
                    <p class="mt-2 mb-0">No se encontraron proveedores con estos filtros</p>
                </td></tr>`;
                return;
            }
            
            tbody.innerHTML = datos.map(s => {
                const nombre = getNombreProveedor(s);
                const documento = getDocumentoProveedor(s);
                const servicios = s.products_services 
                    ? (s.products_services.length > 60 ? s.products_services.substring(0, 60) + '...' : s.products_services)
                    : '<span class="text-muted">‚Äî</span>';
                const fecha = s.created_at ? formatDate(s.created_at) : '‚Äî';
                
                return `
                <tr class="row-clickable" ondblclick="verDetalle('${s.supplier_id}')">
                    <td>
                        <div class="supplier-name">${nombre}</div>
                        ${s.email ? `<div class="supplier-doc">${s.email}</div>` : ''}
                    </td>
                    <td><span class="supplier-doc">${documento}</span></td>
                    <td class="d-none d-lg-table-cell"><small>${servicios}</small></td>
                    <td>${badgeTipo(s.person_type)}</td>
                    <td>${badgeEstado(s.supplier_status)}</td>
                    <td class="d-none d-md-table-cell"><small>${fecha}</small></td>
                    <td class="text-center">
                        <button class="btn btn-outline-primary btn-sm" onclick="verDetalle('${s.supplier_id}')" title="Ver detalle">
                            <i class="bi bi-eye me-1"></i>Ver
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        // ==========================================
        // HELPERS DE PRESENTACI√ìN
        // ==========================================
        
        function getNombreProveedor(s) {
            if (s.person_type === 'juridica') {
                return s.business_name || 'Sin raz√≥n social';
            }
            return [s.first_name, s.second_name, s.last_name_1, s.last_name_2]
                .filter(Boolean).join(' ') || 'Sin nombre';
        }

        function getDocumentoProveedor(s) {
            if (s.person_type === 'juridica') {
                return s.nit ? `NIT ${s.nit}-${s.nit_verification_digit || '?'}` : '‚Äî';
            }
            return s.document_number ? `${s.document_type || ''} ${s.document_number}` : '‚Äî';
        }

        function badgeEstado(status) {
            const map = {
                pending: '<span class="badge badge-pending">Pendiente</span>',
                approved: '<span class="badge badge-approved">Aprobado</span>',
                rejected: '<span class="badge badge-rejected">Rechazado</span>',
                inactive: '<span class="badge badge-inactive">Inactivo</span>'
            };
            return map[status] || `<span class="badge bg-secondary">${status}</span>`;
        }

        function badgeTipo(type) {
            return type === 'juridica' 
                ? '<span class="badge badge-juridica">Jur√≠dica</span>'
                : '<span class="badge badge-natural">Natural</span>';
        }

        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // ==========================================
        // VER DETALLE (solo lectura)
        // ==========================================
        
        async function verDetalle(id) {
            const s = cacheSuppliers.find(x => x.supplier_id === id);
            if (!s) return;
            
            document.getElementById('detail-title').innerHTML = 
                `<i class="bi bi-person-badge me-2"></i>${getNombreProveedor(s)} ${badgeEstado(s.supplier_status)}`;
            
            // Cargar datos relacionados
            let condiciones = [], adjuntos = [], aceptaciones = [];
            try {
                const [condData, adjData, acepData] = await Promise.all([
                    supabaseRequest(`/sup_supplier_tax_conditions?select=sup_tax_conditions(condition_name)&supplier_id=eq.${id}`),
                    supabaseRequest(`/sup_supplier_attachments?select=*,sup_attachment_types(type_name)&supplier_id=eq.${id}&order=uploaded_at.asc`),
                    supabaseRequest(`/sup_supplier_legal_acceptances?select=*,sup_legal_document_versions(version_number,sup_legal_documents(document_name))&supplier_id=eq.${id}&order=accepted_at.asc`)
                ]);
                condiciones = condData || [];
                adjuntos = adjData || [];
                aceptaciones = acepData || [];
            } catch (e) {
                console.error('Error cargando datos relacionados:', e);
            }
            
            const body = document.getElementById('detail-body');
            
            // --- Secci√≥n Identificaci√≥n ---
            let htmlIdent = '';
            if (s.person_type === 'juridica') {
                htmlIdent = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-field"><p class="detail-label">Raz√≥n Social</p><p class="detail-value">${s.business_name || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">NIT</p><p class="detail-value">${s.nit || '‚Äî'}-${s.nit_verification_digit || '?'}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Contacto</p><p class="detail-value">${s.contact_name || '‚Äî'}</p></div>
                        </div>
                    </div>`;
            } else {
                htmlIdent = `
                    <div class="row">
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Tipo Doc.</p><p class="detail-value">${s.document_type || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">N√∫mero</p><p class="detail-value">${s.document_number || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Nombres</p><p class="detail-value">${[s.first_name, s.second_name].filter(Boolean).join(' ') || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Apellidos</p><p class="detail-value">${[s.last_name_1, s.last_name_2].filter(Boolean).join(' ') || '‚Äî'}</p></div>
                        </div>
                    </div>`;
            }
            
            // --- Datos relacionados ---
            const deptoName = s.sup_departments?.department_name || '‚Äî';
            const muniName = s.sup_municipalities?.municipality_name || '‚Äî';
            const ciiuInfo = s.sup_ciiu_activities 
                ? `${s.sup_ciiu_activities.ciiu_code} - ${s.sup_ciiu_activities.ciiu_description}`
                : '‚Äî';
            const regimenName = s.sup_tax_regimes?.regime_name || '‚Äî';
            const condList = condiciones.map(c => c.sup_tax_conditions?.condition_name).filter(Boolean);
            const bankName = s.sup_banks?.bank_name || '‚Äî';
            
            // --- Adjuntos ---
            const storageBaseUrl = getStorageBaseUrl();
            const htmlAdjuntos = adjuntos.length > 0 
                ? adjuntos.map(a => {
                    const url = `${storageBaseUrl}/supplier-files/${a.file_path}`;
                    return `<div class="attachment-item">
                        <i class="bi bi-file-earmark-pdf"></i>
                        <a href="${url}" target="_blank">${a.sup_attachment_types?.type_name || a.file_name}</a>
                        <span class="file-size">${formatFileSize(a.file_size)}</span>
                    </div>`;
                }).join('')
                : '<span class="text-muted">Sin documentos adjuntos</span>';
            
            // --- Aceptaciones ---
            const htmlAcep = aceptaciones.length > 0
                ? aceptaciones.map(a => {
                    const docName = a.sup_legal_document_versions?.sup_legal_documents?.document_name || 'Documento';
                    const ver = a.sup_legal_document_versions?.version_number || '?';
                    const fecha = a.accepted_at ? formatDate(a.accepted_at) : '‚Äî';
                    return `<div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                        <span><i class="bi bi-check-circle-fill text-success me-2"></i>${docName} <small class="text-muted">(v${ver})</small></span>
                        <small class="text-muted">${fecha}</small>
                    </div>`;
                }).join('')
                : '<span class="text-muted">Sin aceptaciones registradas</span>';

            // --- Gesti√≥n ---
            const approvedBy = s.approved_by_user?.user_name || '‚Äî';
            const approvedAt = s.approved_at ? formatDate(s.approved_at) : '‚Äî';

            body.innerHTML = `
                <!-- Identificaci√≥n -->
                <div class="detail-section">
                    <h6><i class="bi bi-person-vcard me-2"></i>Identificaci√≥n ${badgeTipo(s.person_type)}</h6>
                    ${htmlIdent}
                </div>

                <!-- Contacto y Ubicaci√≥n -->
                <div class="detail-section">
                    <h6><i class="bi bi-geo-alt me-2"></i>Contacto y Ubicaci√≥n</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Tel√©fono</p><p class="detail-value">${s.phone || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Email</p><p class="detail-value">${s.email || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Departamento</p><p class="detail-value">${deptoName}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Municipio</p><p class="detail-value">${muniName}</p></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-field"><p class="detail-label">Direcci√≥n</p><p class="detail-value">${s.address || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-field"><p class="detail-label">Referencia</p><p class="detail-value">${s.address_reference || '‚Äî'}</p></div>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n Fiscal -->
                <div class="detail-section">
                    <h6><i class="bi bi-receipt me-2"></i>Informaci√≥n Fiscal</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-field"><p class="detail-label">Actividad CIIU</p><p class="detail-value">${ciiuInfo}</p></div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-field"><p class="detail-label">R√©gimen Tributario</p><p class="detail-value">${regimenName}</p></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-field">
                                <p class="detail-label">Productos / Servicios</p>
                                <p class="detail-value">${s.products_services || '‚Äî'}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-field">
                                <p class="detail-label">Condiciones Tributarias</p>
                                ${condList.length > 0 
                                    ? condList.map(c => `<span class="badge bg-light text-dark border me-1 mb-1">${c}</span>`).join('') 
                                    : '<span class="text-muted">Ninguna</span>'}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n Bancaria -->
                <div class="detail-section">
                    <h6><i class="bi bi-bank me-2"></i>Informaci√≥n Bancaria</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="detail-field"><p class="detail-label">Banco</p><p class="detail-value">${bankName}</p></div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-field"><p class="detail-label">Tipo Cuenta</p><p class="detail-value">${s.account_type || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-field"><p class="detail-label">N√∫mero</p><p class="detail-value">${s.account_number || '‚Äî'}</p></div>
                        </div>
                    </div>
                </div>

                <!-- Documentos Adjuntos -->
                <div class="detail-section">
                    <h6><i class="bi bi-paperclip me-2"></i>Documentos Adjuntos</h6>
                    ${htmlAdjuntos}
                </div>

                <!-- Aceptaciones Legales -->
                <div class="detail-section">
                    <h6><i class="bi bi-shield-check me-2"></i>Aceptaciones Legales</h6>
                    ${htmlAcep}
                </div>

                <!-- Gesti√≥n Interna -->
                ${s.supplier_status !== 'pending' ? `
                <div class="detail-section" style="border-left-color: #6c757d;">
                    <h6 style="color: #6c757d;"><i class="bi bi-gear me-2"></i>Gesti√≥n Interna</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-field"><p class="detail-label">Aprobado/Rechazado por</p><p class="detail-value">${approvedBy}</p></div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-field"><p class="detail-label">Fecha</p><p class="detail-value">${approvedAt}</p></div>
                        </div>
                    </div>
                    ${s.rejection_reason ? `
                    <div class="row">
                        <div class="col-12">
                            <div class="detail-field">
                                <p class="detail-label">Motivo de rechazo</p>
                                <p class="detail-value text-danger">${s.rejection_reason}</p>
                            </div>
                        </div>
                    </div>` : ''}
                </div>` : ''}
            `;

            modalDetail.show();
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        
        function getStorageBaseUrl() {
            const env = detectEnvironment();
            const config = ENVIRONMENT_CONFIGS[env]?.supabase || ENVIRONMENT_CONFIGS.development.supabase;
            return `${config.url}/storage/v1/object/public`;
        }

        console.log('‚úÖ my-suppliers.html cargado');
    </script>
</body>
</html>
