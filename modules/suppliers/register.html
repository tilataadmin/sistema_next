<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.19.20.00">
    <title>Registro de Proveedores - SchoolNet</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- reCaptcha v3 -->
    <script src="https://www.google.com/recaptcha/api.js?render=RECAPTCHA_SITE_KEY" async defer></script>
    
    <style>
        :root {
            --primary: #64748b;
            --primary-dark: #475569;
            --success: #198754;
            --step-inactive: #dee2e6;
        }
        body { background-color: #f8f9fa; }
        
        .register-container { max-width: 860px; margin: 0 auto; padding: 1.5rem; }
        
        /* Header */
        .register-header { text-align: center; padding: 2rem 1rem 1rem; }
        .register-header h1 { font-size: 1.6rem; color: #333; }
        
        /* Stepper */
        .stepper { display: flex; justify-content: center; gap: 0; margin-bottom: 2rem; flex-wrap: wrap; }
        .step-item { display: flex; align-items: center; }
        .step-circle {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem; font-weight: 600;
            background: var(--step-inactive); color: #6c757d;
            transition: all 0.3s;
        }
        .step-item.active .step-circle { background: var(--primary); color: white; }
        .step-item.completed .step-circle { background: var(--success); color: white; }
        .step-label { font-size: 0.7rem; margin-left: 4px; margin-right: 12px; color: #6c757d; }
        .step-item.active .step-label { color: var(--primary); font-weight: 600; }
        .step-item.completed .step-label { color: var(--success); }
        .step-line { width: 20px; height: 2px; background: var(--step-inactive); margin: 0 2px; }
        .step-line.completed { background: var(--success); }
        
        /* Panels */
        .step-panel { display: none; }
        .step-panel.active { display: block; }
        
        /* Legal docs */
        .legal-doc-card { border-left: 4px solid var(--primary); margin-bottom: 1rem; }
        .legal-doc-content {
            max-height: 250px; overflow-y: auto; padding: 1rem;
            border: 1px solid #e9ecef; border-radius: 0.375rem;
            font-size: 0.9rem; background: white;
        }
        
        /* Address generator */
        .addr-gen { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 0.5rem; padding: 1rem; }
        .addr-preview {
            background: white; border: 2px solid var(--primary);
            border-radius: 0.375rem; padding: 0.5rem 1rem;
            font-family: 'Courier New', monospace; font-size: 1rem;
            min-height: 40px; font-weight: 600; color: var(--primary-dark);
        }
        
        /* File upload */
        .file-upload-zone {
            border: 2px dashed #dee2e6; border-radius: 0.5rem;
            padding: 1rem; text-align: center; cursor: pointer;
            transition: border-color 0.2s;
        }
        .file-upload-zone:hover { border-color: var(--primary); }
        .file-upload-zone.has-file { border-color: var(--success); background: #f0fff0; }
        
        /* Complement list */
        .complement-tag {
            display: inline-flex; align-items: center; gap: 4px;
            background: #e2e8f0; padding: 2px 8px; border-radius: 4px;
            font-size: 0.8rem; margin: 2px;
        }
        .complement-tag .remove { cursor: pointer; color: #dc3545; font-weight: bold; }
        
        /* NIT */
        .dv-box {
            width: 45px; background: #e9ecef; font-weight: 700;
            text-align: center; font-size: 1.1rem;
        }
        
        /* Responsive stepper */
        @media (max-width: 768px) {
            .step-label { display: none; }
            .step-line { width: 12px; }
        }
        
        /* Success screen */
        .success-screen { text-align: center; padding: 3rem 1rem; }
        .success-icon { font-size: 4rem; color: var(--success); }
    </style>
</head>

<body>
    <div class="register-container">
        
        <!-- HEADER -->
        <div class="register-header">
            <h1><i class="bi bi-building-add me-2"></i>Registro de Proveedores</h1>
            <p class="text-muted">Complete el formulario para registrarse como proveedor</p>
        </div>

        <div id="alertContainer"></div>

        <!-- STEPPER -->
        <div class="stepper" id="stepper">
            <div class="step-item active" data-step="0"><span class="step-circle">1</span><span class="step-label">Legales</span></div>
            <div class="step-line"></div>
            <div class="step-item" data-step="1"><span class="step-circle">2</span><span class="step-label">Tipo</span></div>
            <div class="step-line"></div>
            <div class="step-item" data-step="2"><span class="step-circle">3</span><span class="step-label">Identificaci√≥n</span></div>
            <div class="step-line"></div>
            <div class="step-item" data-step="3"><span class="step-circle">4</span><span class="step-label">Contacto</span></div>
            <div class="step-line"></div>
            <div class="step-item" data-step="4"><span class="step-circle">5</span><span class="step-label">Fiscal</span></div>
            <div class="step-line"></div>
            <div class="step-item" data-step="5"><span class="step-circle">6</span><span class="step-label">Bancaria</span></div>
            <div class="step-line"></div>
            <div class="step-item" data-step="6"><span class="step-circle">7</span><span class="step-label">Adjuntos</span></div>
        </div>

        <!-- ============================================ -->
        <!-- PASO 0: DOCUMENTOS LEGALES                  -->
        <!-- ============================================ -->
        <div class="step-panel active" id="step-0">
            <div class="card">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-file-earmark-check me-2"></i>Aceptaci√≥n de Documentos Legales</h5></div>
                <div class="card-body">
                    <p class="text-muted">Lea y acepte cada uno de los siguientes documentos para continuar con el registro.</p>
                    <div id="legal-docs-container">
                        <div class="text-center py-4"><div class="spinner-border spinner-border-sm"></div> Cargando documentos...</div>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <button class="btn btn-primary" onclick="validarPaso0()" id="btn-next-0" disabled>
                        Continuar <i class="bi bi-arrow-right ms-1"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- PASO 1: TIPO DE PERSONA                     -->
        <!-- ============================================ -->
        <div class="step-panel" id="step-1">
            <div class="card">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-person-badge me-2"></i>Tipo de Persona</h5></div>
                <div class="card-body">
                    <p class="text-muted mb-4">Seleccione el tipo de persona con el que se registrar√°.</p>
                    <div class="row g-3 justify-content-center">
                        <div class="col-md-5">
                            <div class="card h-100 border-2 person-type-card" onclick="seleccionarTipo('natural')" id="card-natural" style="cursor:pointer;">
                                <div class="card-body text-center py-4">
                                    <i class="bi bi-person" style="font-size: 3rem; color: var(--primary);"></i>
                                    <h5 class="mt-3">Persona Natural</h5>
                                    <small class="text-muted">Persona individual con c√©dula o documento de identidad</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="card h-100 border-2 person-type-card" onclick="seleccionarTipo('juridica')" id="card-juridica" style="cursor:pointer;">
                                <div class="card-body text-center py-4">
                                    <i class="bi bi-building" style="font-size: 3rem; color: var(--primary);"></i>
                                    <h5 class="mt-3">Persona Jur√≠dica</h5>
                                    <small class="text-muted">Empresa, sociedad o entidad con NIT</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="person-type" value="">
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <button class="btn btn-outline-secondary" onclick="irPaso(0)"><i class="bi bi-arrow-left me-1"></i>Atr√°s</button>
                    <button class="btn btn-primary" onclick="validarPaso1()" id="btn-next-1" disabled>Continuar <i class="bi bi-arrow-right ms-1"></i></button>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- PASO 2: IDENTIFICACI√ìN                      -->
        <!-- ============================================ -->
        <div class="step-panel" id="step-2">
            <div class="card">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-card-text me-2"></i>Datos de Identificaci√≥n</h5></div>
                <div class="card-body">
                    
                    <!-- Persona Natural -->
                    <div id="fields-natural" style="display:none;">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Tipo de documento <span class="text-danger">*</span></label>
                                <select class="form-select" id="doc-type" required>
                                    <option value="">Seleccione...</option>
                                    <option value="CC">C√©dula de Ciudadan√≠a</option>
                                    <option value="CE">C√©dula de Extranjer√≠a</option>
                                    <option value="Pasaporte">Pasaporte</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">N√∫mero de documento <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="doc-number" maxlength="20">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Primer nombre <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="first-name" maxlength="100">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Segundo nombre</label>
                                <input type="text" class="form-control" id="second-name" maxlength="100">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Primer apellido <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="last-name-1" maxlength="100">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Segundo apellido</label>
                                <input type="text" class="form-control" id="last-name-2" maxlength="100">
                            </div>
                        </div>
                    </div>

                    <!-- Persona Jur√≠dica -->
                    <div id="fields-juridica" style="display:none;">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label">Raz√≥n Social <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="business-name" maxlength="250">
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">NIT (sin d√≠gito de verificaci√≥n) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="nit" maxlength="15" oninput="calcularDV()">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">DV</label>
                                <input type="text" class="form-control dv-box" id="nit-dv" readonly>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Nombre de contacto <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="contact-name" maxlength="200"
                                       placeholder="Nombre del representante legal o persona de contacto">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <button class="btn btn-outline-secondary" onclick="irPaso(1)"><i class="bi bi-arrow-left me-1"></i>Atr√°s</button>
                    <button class="btn btn-primary" onclick="validarPaso2()">Continuar <i class="bi bi-arrow-right ms-1"></i></button>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- PASO 3: CONTACTO Y UBICACI√ìN                -->
        <!-- ============================================ -->
        <div class="step-panel" id="step-3">
            <div class="card">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Contacto y Ubicaci√≥n</h5></div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tel√©fono <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="phone" maxlength="20" placeholder="Ej: 3001234567">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Correo electr√≥nico <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" maxlength="200">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Departamento <span class="text-danger">*</span></label>
                            <select class="form-select" id="department" onchange="cargarMunicipios()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Municipio <span class="text-danger">*</span></label>
                            <select class="form-select" id="municipality" disabled>
                                <option value="">Primero seleccione departamento</option>
                            </select>
                        </div>
                    </div>

                    <!-- GENERADOR DE DIRECCIONES DIAN -->
                    <div class="mt-4">
                        <label class="form-label fw-bold"><i class="bi bi-signpost-2 me-1"></i>Direcci√≥n <span class="text-danger">*</span></label>
                        <div class="addr-gen">
                            <div class="row g-2 mb-2">
                                <div class="col-md-3">
                                    <label class="form-label small">Tipo de v√≠a</label>
                                    <select class="form-select form-select-sm" id="addr-via-type" onchange="generarDireccion()">
                                        <option value="">Seleccione...</option>
                                        <option value="CL">Calle</option>
                                        <option value="CR">Carrera</option>
                                        <option value="DG">Diagonal</option>
                                        <option value="TV">Transversal</option>
                                        <option value="AC">Avenida Calle</option>
                                        <option value="AK">Avenida Carrera</option>
                                        <option value="AV">Avenida</option>
                                        <option value="CIR">Circular</option>
                                        <option value="AUT">Autopista</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">N¬∫ V√≠a</label>
                                    <input type="text" class="form-control form-control-sm" id="addr-via-num" maxlength="10" oninput="generarDireccion()" placeholder="Ej: 7">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Letra</label>
                                    <select class="form-select form-select-sm" id="addr-via-letter" onchange="generarDireccion()">
                                        <option value=""></option>
                                        <option>A</option><option>B</option><option>C</option><option>D</option>
                                        <option>E</option><option>F</option><option>BIS</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Cuadrante</label>
                                    <select class="form-select form-select-sm" id="addr-via-quad" onchange="generarDireccion()">
                                        <option value=""></option>
                                        <option value="NORTE">Norte</option>
                                        <option value="SUR">Sur</option>
                                        <option value="ESTE">Este</option>
                                        <option value="OESTE">Oeste</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-md-2">
                                    <label class="form-label small">N√∫mero</label>
                                    <input type="text" class="form-control form-control-sm" id="addr-number" maxlength="10" oninput="generarDireccion()" placeholder="Ej: 117">
                                </div>
                                <div class="col-md-1 d-flex align-items-end pb-1 justify-content-center">
                                    <strong class="text-muted">‚Äî</strong>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Placa</label>
                                    <input type="text" class="form-control form-control-sm" id="addr-plate" maxlength="10" oninput="generarDireccion()" placeholder="Ej: 13">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Letra</label>
                                    <select class="form-select form-select-sm" id="addr-plate-letter" onchange="generarDireccion()">
                                        <option value=""></option>
                                        <option>A</option><option>B</option><option>C</option><option>D</option>
                                        <option>E</option><option>F</option><option>BIS</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Cuadrante</label>
                                    <select class="form-select form-select-sm" id="addr-plate-quad" onchange="generarDireccion()">
                                        <option value=""></option>
                                        <option value="SUR">Sur</option>
                                        <option value="NORTE">Norte</option>
                                        <option value="ESTE">Este</option>
                                        <option value="OESTE">Oeste</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Complementos -->
                            <div class="row g-2 mb-2">
                                <div class="col-md-3">
                                    <label class="form-label small">Complemento</label>
                                    <select class="form-select form-select-sm" id="addr-comp-type">
                                        <option value="">Agregar...</option>
                                        <option value="AP">Apartamento</option>
                                        <option value="OF">Oficina</option>
                                        <option value="LC">Local</option>
                                        <option value="P">Piso</option>
                                        <option value="TO">Torre</option>
                                        <option value="BL">Bloque</option>
                                        <option value="ED">Edificio</option>
                                        <option value="CA">Casa</option>
                                        <option value="BG">Bodega</option>
                                        <option value="IN">Interior</option>
                                        <option value="EN">Entrada</option>
                                        <option value="CON">Conjunto</option>
                                        <option value="CC">Centro Comercial</option>
                                        <option value="PQ">Parqueadero</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Valor</label>
                                    <input type="text" class="form-control form-control-sm" id="addr-comp-value" maxlength="30" placeholder="Ej: 301">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="agregarComplemento()">
                                        <i class="bi bi-plus"></i> Agregar
                                    </button>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <div id="addr-complements-list" class="d-flex flex-wrap"></div>
                                </div>
                            </div>

                            <!-- Preview -->
                            <div class="mt-2">
                                <label class="form-label small text-muted">Direcci√≥n generada:</label>
                                <div class="addr-preview" id="addr-preview">‚Äî</div>
                                <input type="hidden" id="address-formatted">
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Referencia / Informaci√≥n adicional</label>
                        <input type="text" class="form-control" id="address-reference" maxlength="300"
                               placeholder="Barrio, urbanizaci√≥n, punto de referencia, etc.">
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <button class="btn btn-outline-secondary" onclick="irPaso(1)"><i class="bi bi-arrow-left me-1"></i>Atr√°s</button>
                    <button class="btn btn-primary" onclick="validarPaso3()">Continuar <i class="bi bi-arrow-right ms-1"></i></button>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- PASO 4: INFORMACI√ìN FISCAL                  -->
        <!-- ============================================ -->
        <div class="step-panel" id="step-4">
            <div class="card">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Informaci√≥n Fiscal</h5></div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label">Actividad econ√≥mica CIIU <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="ciiu-search" placeholder="Buscar por c√≥digo o descripci√≥n..." oninput="buscarCIIU()">
                                <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('ciiu-search').value='';buscarCIIU();">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                            <select class="form-select mt-1" id="ciiu" size="4" style="display:none;">
                            </select>
                            <input type="hidden" id="ciiu-selected">
                            <div id="ciiu-selected-label" class="small text-success mt-1" style="display:none;"></div>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Productos o servicios que ofrece <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="products-services" rows="2" maxlength="1000"
                                      placeholder="Describa brevemente los productos o servicios que ofrece"></textarea>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">R√©gimen tributario <span class="text-danger">*</span></label>
                            <div id="regimes-container">Cargando...</div>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Condiciones tributarias</label>
                            <small class="text-muted d-block mb-2">Marque todas las que apliquen</small>
                            <div id="conditions-container">Cargando...</div>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <button class="btn btn-outline-secondary" onclick="irPaso(3)"><i class="bi bi-arrow-left me-1"></i>Atr√°s</button>
                    <button class="btn btn-primary" onclick="validarPaso4()">Continuar <i class="bi bi-arrow-right ms-1"></i></button>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- PASO 5: INFORMACI√ìN BANCARIA                -->
        <!-- ============================================ -->
        <div class="step-panel" id="step-5">
            <div class="card">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-bank me-2"></i>Informaci√≥n Bancaria</h5></div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label">Entidad bancaria <span class="text-danger">*</span></label>
                            <select class="form-select" id="bank">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tipo de cuenta <span class="text-danger">*</span></label>
                            <select class="form-select" id="account-type">
                                <option value="">Seleccione...</option>
                                <option value="Ahorros">Ahorros</option>
                                <option value="Corriente">Corriente</option>
                                <option value="Cuenta en el exterior">Cuenta en el exterior</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">N√∫mero de cuenta <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="account-number" maxlength="30">
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <button class="btn btn-outline-secondary" onclick="irPaso(4)"><i class="bi bi-arrow-left me-1"></i>Atr√°s</button>
                    <button class="btn btn-primary" onclick="validarPaso5()">Continuar <i class="bi bi-arrow-right ms-1"></i></button>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- PASO 6: DOCUMENTOS ADJUNTOS                 -->
        <!-- ============================================ -->
        <div class="step-panel" id="step-6">
            <div class="card">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-paperclip me-2"></i>Documentos Adjuntos</h5></div>
                <div class="card-body">
                    <p class="text-muted">Adjunte los documentos solicitados. Los marcados con <span class="text-danger">*</span> son obligatorios.</p>
                    <div id="attachments-container">Cargando...</div>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <button class="btn btn-outline-secondary" onclick="irPaso(5)"><i class="bi bi-arrow-left me-1"></i>Atr√°s</button>
                    <button class="btn btn-success" onclick="enviarRegistro()" id="btn-submit">
                        <i class="bi bi-send me-1"></i>Enviar Registro
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- PANTALLA DE √âXITO                           -->
        <!-- ============================================ -->
        <div class="step-panel" id="step-success">
            <div class="card">
                <div class="card-body success-screen">
                    <div class="success-icon"><i class="bi bi-check-circle-fill"></i></div>
                    <h3 class="mt-3">¬°Registro Enviado Exitosamente!</h3>
                    <p class="text-muted mt-2">
                        Su solicitud ha sido recibida y ser√° revisada por nuestro equipo.<br>
                        Recibir√° una notificaci√≥n al correo <strong id="success-email"></strong> cuando su registro sea aprobado.
                    </p>
                    <div class="alert alert-info d-inline-block mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Su solicitud queda en estado <strong>Pendiente de aprobaci√≥n</strong>.
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // CONFIGURACI√ìN
        // ==========================================
        const STORAGE_BUCKET = 'supplier-files';
        let supabaseClient;
        
        let currentStep = 0;
        let selectedPersonType = '';
        let addressComplements = [];
        let uploadedFiles = {}; // { attachment_type_id: { file, name, path, url } }
        
        // Cache de datos
        let cacheLegalDocs = [];
        let cacheLegalVersions = {}; // { doc_id: version }
        let cacheDepartments = [];
        let cacheCIIU = [];
        let cacheRegimes = [];
        let cacheConditions = [];
        let cacheBanks = [];
        let cacheAttachTypes = [];

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìã Iniciando formulario de registro...');
            
            try {
                // Inicializar Supabase client (p√∫blico, sin sesi√≥n)
                supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                
                // Cargar documentos legales (paso 0)
                await cargarDocumentosLegales();
                
                // Pre-cargar cat√°logos en background
                cargarCatalogosBackground();
                
                console.log('‚úÖ Formulario de registro listo');
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                mostrarAlerta('Error al cargar el formulario. Intente recargar la p√°gina.', 'danger');
            }
        });
        
        async function cargarCatalogosBackground() {
            try {
                const [depts, regimes, conditions, banks, attachTypes] = await Promise.all([
                    fetchData('/sup_departments?select=department_id,department_code,department_name&is_active=eq.true&order=department_name.asc'),
                    fetchData('/sup_tax_regimes?select=*&is_active=eq.true&order=regime_order.asc'),
                    fetchData('/sup_tax_conditions?select=*&is_active=eq.true&order=condition_order.asc'),
                    fetchData('/sup_banks?select=*&is_active=eq.true&order=bank_name.asc'),
                    fetchData('/sup_attachment_types?select=*&is_active=eq.true&order=type_order.asc')
                ]);
                
                cacheDepartments = depts || [];
                cacheRegimes = regimes || [];
                cacheConditions = conditions || [];
                cacheBanks = banks || [];
                cacheAttachTypes = attachTypes || [];
                
                // Poblar selects
                poblarDepartamentos();
                poblarBancos();
                
            } catch (error) {
                console.error('Error cargando cat√°logos:', error);
            }
        }

        // ==========================================
        // FETCH HELPER (p√∫blico, sin sesi√≥n)
        // ==========================================
        async function fetchData(path) {
            const response = await fetch(`${SUPABASE_CONFIG.apiUrl}${path}`, {
                headers: {
                    'apikey': SUPABASE_CONFIG.anonKey,
                    'Content-Type': 'application/json'
                }
            });
            if (!response.ok) throw new Error(`Error ${response.status}`);
            return await response.json();
        }
        
        async function insertData(path, body) {
            const response = await fetch(`${SUPABASE_CONFIG.apiUrl}${path}`, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_CONFIG.anonKey,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(body)
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.message || `Error ${response.status}`);
            }
            return await response.json();
        }

        // ==========================================
        // STEPPER NAVIGATION
        // ==========================================
        function irPaso(step) {
            document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            
            document.querySelectorAll('.step-item').forEach((item, i) => {
                item.classList.remove('active', 'completed');
                if (i < step) item.classList.add('completed');
                if (i === step) item.classList.add('active');
            });
            document.querySelectorAll('.step-line').forEach((line, i) => {
                line.classList.toggle('completed', i < step);
            });
            
            currentStep = step;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function mostrarAlerta(msg, tipo) {
            document.getElementById('alertContainer').innerHTML = `
                <div class="alert alert-${tipo} alert-dismissible fade show">
                    ${msg}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`;
        }

        // ==========================================
        // PASO 0: DOCUMENTOS LEGALES
        // ==========================================
        async function cargarDocumentosLegales() {
            try {
                const docs = await fetchData(
                    '/sup_legal_documents?select=document_id,document_name,document_order&is_active=eq.true&order=document_order.asc'
                );
                cacheLegalDocs = docs || [];
                
                if (cacheLegalDocs.length === 0) {
                    document.getElementById('legal-docs-container').innerHTML = 
                        '<div class="alert alert-warning">No hay documentos legales configurados. Contacte al administrador.</div>';
                    return;
                }
                
                // Cargar versiones actuales
                for (const doc of cacheLegalDocs) {
                    const versions = await fetchData(
                        `/sup_legal_document_versions?document_id=eq.${doc.document_id}&is_current=eq.true&select=version_id,content,version_number`
                    );
                    if (versions && versions.length > 0) {
                        cacheLegalVersions[doc.document_id] = versions[0];
                    }
                }
                
                renderizarDocumentosLegales();
                
            } catch (error) {
                console.error('Error cargando docs legales:', error);
                document.getElementById('legal-docs-container').innerHTML = 
                    '<div class="alert alert-danger">Error al cargar documentos legales</div>';
            }
        }
        
        function renderizarDocumentosLegales() {
            const container = document.getElementById('legal-docs-container');
            
            container.innerHTML = cacheLegalDocs.map(doc => {
                const version = cacheLegalVersions[doc.document_id];
                if (!version) return '';
                
                return `
                <div class="card legal-doc-card">
                    <div class="card-body">
                        <h6 class="mb-3"><i class="bi bi-file-earmark-text me-2"></i>${doc.document_name}</h6>
                        <div class="legal-doc-content">${version.content}</div>
                        <div class="form-check mt-3">
                            <input class="form-check-input legal-check" type="checkbox" 
                                   id="legal-${doc.document_id}" data-doc="${doc.document_id}" 
                                   onchange="verificarAceptaciones()">
                            <label class="form-check-label" for="legal-${doc.document_id}">
                                <strong>He le√≠do y acepto</strong> este documento
                            </label>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        function verificarAceptaciones() {
            const checks = document.querySelectorAll('.legal-check');
            const allChecked = checks.length > 0 && Array.from(checks).every(c => c.checked);
            document.getElementById('btn-next-0').disabled = !allChecked;
        }
        
        function validarPaso0() {
            const checks = document.querySelectorAll('.legal-check');
            if (!Array.from(checks).every(c => c.checked)) {
                mostrarAlerta('Debe aceptar todos los documentos legales para continuar.', 'warning');
                return;
            }
            irPaso(1);
        }

        // ==========================================
        // PASO 1: TIPO DE PERSONA
        // ==========================================
        function seleccionarTipo(tipo) {
            selectedPersonType = tipo;
            document.getElementById('person-type').value = tipo;
            
            document.querySelectorAll('.person-type-card').forEach(c => {
                c.classList.remove('border-primary', 'bg-light');
            });
            document.getElementById(`card-${tipo}`).classList.add('border-primary', 'bg-light');
            document.getElementById('btn-next-1').disabled = false;
        }
        
        function validarPaso1() {
            if (!selectedPersonType) {
                mostrarAlerta('Seleccione un tipo de persona.', 'warning');
                return;
            }
            // Mostrar/ocultar campos del paso 2
            document.getElementById('fields-natural').style.display = selectedPersonType === 'natural' ? 'block' : 'none';
            document.getElementById('fields-juridica').style.display = selectedPersonType === 'juridica' ? 'block' : 'none';
            
            // Preparar condiciones y adjuntos filtrados
            renderizarCondiciones();
            renderizarAdjuntos();
            
            irPaso(2);
        }

        // ==========================================
        // PASO 2: IDENTIFICACI√ìN
        // ==========================================
        function calcularDV() {
            const nit = document.getElementById('nit').value.replace(/\D/g, '');
            if (nit.length < 3) { document.getElementById('nit-dv').value = ''; return; }
            
            // Algoritmo DIAN para d√≠gito de verificaci√≥n
            const primos = [3, 7, 13, 17, 19, 23, 29, 37, 41, 43, 47, 53, 59, 67, 71];
            let sum = 0;
            const digits = nit.split('').reverse();
            for (let i = 0; i < digits.length && i < primos.length; i++) {
                sum += parseInt(digits[i]) * primos[i];
            }
            const residuo = sum % 11;
            const dv = residuo > 1 ? 11 - residuo : residuo;
            document.getElementById('nit-dv').value = dv;
        }
        
        function validarPaso2() {
            if (selectedPersonType === 'natural') {
                if (!document.getElementById('doc-type').value) { mostrarAlerta('Seleccione tipo de documento.', 'warning'); return; }
                if (!document.getElementById('doc-number').value.trim()) { mostrarAlerta('Ingrese n√∫mero de documento.', 'warning'); return; }
                if (!document.getElementById('first-name').value.trim()) { mostrarAlerta('Ingrese primer nombre.', 'warning'); return; }
                if (!document.getElementById('last-name-1').value.trim()) { mostrarAlerta('Ingrese primer apellido.', 'warning'); return; }
            } else {
                if (!document.getElementById('business-name').value.trim()) { mostrarAlerta('Ingrese raz√≥n social.', 'warning'); return; }
                if (!document.getElementById('nit').value.trim()) { mostrarAlerta('Ingrese NIT.', 'warning'); return; }
                if (!document.getElementById('contact-name').value.trim()) { mostrarAlerta('Ingrese nombre de contacto.', 'warning'); return; }
            }
            irPaso(3);
        }

        // ==========================================
        // PASO 3: CONTACTO Y UBICACI√ìN
        // ==========================================
        function poblarDepartamentos() {
            const sel = document.getElementById('department');
            sel.innerHTML = '<option value="">Seleccione...</option>' +
                cacheDepartments.map(d => `<option value="${d.department_id}">${d.department_name}</option>`).join('');
        }
        
        async function cargarMunicipios() {
            const deptId = document.getElementById('department').value;
            const sel = document.getElementById('municipality');
            
            if (!deptId) {
                sel.innerHTML = '<option value="">Primero seleccione departamento</option>';
                sel.disabled = true;
                return;
            }
            
            sel.innerHTML = '<option value="">Cargando...</option>';
            sel.disabled = true;
            
            try {
                const data = await fetchData(
                    `/sup_municipalities?department_id=eq.${deptId}&is_active=eq.true&select=municipality_id,municipality_name&order=municipality_name.asc`
                );
                sel.innerHTML = '<option value="">Seleccione...</option>' +
                    (data || []).map(m => `<option value="${m.municipality_id}">${m.municipality_name}</option>`).join('');
                sel.disabled = false;
            } catch (error) {
                sel.innerHTML = '<option value="">Error al cargar</option>';
            }
        }
        
        function poblarBancos() {
            const sel = document.getElementById('bank');
            sel.innerHTML = '<option value="">Seleccione...</option>' +
                cacheBanks.map(b => `<option value="${b.bank_id}">${b.bank_name}</option>`).join('');
        }
        
        // --- Generador de direcciones DIAN ---
        function generarDireccion() {
            const parts = [];
            
            const viaType = document.getElementById('addr-via-type').value;
            const viaNum = document.getElementById('addr-via-num').value.trim();
            const viaLetter = document.getElementById('addr-via-letter').value;
            const viaQuad = document.getElementById('addr-via-quad').value;
            const number = document.getElementById('addr-number').value.trim();
            const plate = document.getElementById('addr-plate').value.trim();
            const plateLetter = document.getElementById('addr-plate-letter').value;
            const plateQuad = document.getElementById('addr-plate-quad').value;
            
            if (viaType) parts.push(viaType);
            if (viaNum) parts.push(viaNum);
            if (viaLetter) parts.push(viaLetter);
            if (viaQuad) parts.push(viaQuad);
            if (number) parts.push(number);
            if (plate) parts.push('-', plate);
            if (plateLetter) parts.push(plateLetter);
            if (plateQuad) parts.push(plateQuad);
            
            // Complementos
            addressComplements.forEach(c => { parts.push(c.code, c.value); });
            
            const formatted = parts.join(' ');
            document.getElementById('addr-preview').textContent = formatted || '‚Äî';
            document.getElementById('address-formatted').value = formatted;
        }
        
        function agregarComplemento() {
            const typeEl = document.getElementById('addr-comp-type');
            const valueEl = document.getElementById('addr-comp-value');
            const code = typeEl.value;
            const val = valueEl.value.trim();
            
            if (!code || !val) return;
            
            const label = typeEl.options[typeEl.selectedIndex].text;
            addressComplements.push({ code, value: val, label });
            
            typeEl.value = '';
            valueEl.value = '';
            
            renderizarComplementos();
            generarDireccion();
        }
        
        function removerComplemento(index) {
            addressComplements.splice(index, 1);
            renderizarComplementos();
            generarDireccion();
        }
        
        function renderizarComplementos() {
            document.getElementById('addr-complements-list').innerHTML = addressComplements.map((c, i) => 
                `<span class="complement-tag">${c.label} ${c.value} <span class="remove" onclick="removerComplemento(${i})">&times;</span></span>`
            ).join('');
        }
        
        function validarPaso3() {
            if (!document.getElementById('phone').value.trim()) { mostrarAlerta('Ingrese tel√©fono.', 'warning'); return; }
            const email = document.getElementById('email').value.trim();
            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { mostrarAlerta('Ingrese un correo electr√≥nico v√°lido.', 'warning'); return; }
            if (!document.getElementById('department').value) { mostrarAlerta('Seleccione departamento.', 'warning'); return; }
            if (!document.getElementById('municipality').value) { mostrarAlerta('Seleccione municipio.', 'warning'); return; }
            if (!document.getElementById('address-formatted').value) { mostrarAlerta('Construya la direcci√≥n usando el generador.', 'warning'); return; }
            
            // Preparar reg√≠menes
            renderizarRegimenes();
            
            irPaso(4);
        }

        // ==========================================
        // PASO 4: INFORMACI√ìN FISCAL
        // ==========================================
        async function buscarCIIU() {
            const texto = document.getElementById('ciiu-search').value.trim().toLowerCase();
            const sel = document.getElementById('ciiu');
            
            if (texto.length < 2) { sel.style.display = 'none'; return; }
            
            // Cargar CIIU si a√∫n no est√° en cache
            if (cacheCIIU.length === 0) {
                try {
                    cacheCIIU = await fetchData('/sup_ciiu_activities?select=ciiu_id,ciiu_code,ciiu_description,ciiu_section&is_active=eq.true&order=ciiu_code.asc');
                } catch (e) { return; }
            }
            
            const filtered = cacheCIIU.filter(c => 
                c.ciiu_code.toLowerCase().includes(texto) || 
                c.ciiu_description.toLowerCase().includes(texto)
            ).slice(0, 30);
            
            if (filtered.length === 0) {
                sel.innerHTML = '<option value="" disabled>Sin resultados</option>';
            } else {
                sel.innerHTML = filtered.map(c => 
                    `<option value="${c.ciiu_id}">${c.ciiu_code} - ${c.ciiu_description}</option>`
                ).join('');
            }
            
            sel.style.display = 'block';
            sel.onchange = function() {
                const opt = this.options[this.selectedIndex];
                document.getElementById('ciiu-selected').value = this.value;
                document.getElementById('ciiu-selected-label').textContent = '‚úì ' + opt.text;
                document.getElementById('ciiu-selected-label').style.display = 'block';
                sel.style.display = 'none';
            };
        }
        
        function renderizarRegimenes() {
            const container = document.getElementById('regimes-container');
            container.innerHTML = cacheRegimes.map(r => `
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="regime" value="${r.regime_id}" id="regime-${r.regime_id}">
                    <label class="form-check-label" for="regime-${r.regime_id}">${r.regime_name}</label>
                    ${r.regime_description ? `<div class="small text-muted ms-4">${r.regime_description}</div>` : ''}
                </div>
            `).join('');
        }
        
        function renderizarCondiciones() {
            const container = document.getElementById('conditions-container');
            const filtered = cacheConditions.filter(c => 
                c.applies_to === 'both' || c.applies_to === selectedPersonType
            );
            
            if (filtered.length === 0) {
                container.innerHTML = '<span class="text-muted">No hay condiciones configuradas</span>';
                return;
            }
            
            container.innerHTML = filtered.map(c => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${c.condition_id}" id="cond-${c.condition_id}">
                    <label class="form-check-label" for="cond-${c.condition_id}">${c.condition_name}</label>
                    ${c.condition_description ? `<div class="small text-muted ms-4">${c.condition_description}</div>` : ''}
                </div>
            `).join('');
        }
        
        function validarPaso4() {
            if (!document.getElementById('ciiu-selected').value) { mostrarAlerta('Seleccione una actividad econ√≥mica CIIU.', 'warning'); return; }
            if (!document.getElementById('products-services').value.trim()) { mostrarAlerta('Describa los productos o servicios que ofrece.', 'warning'); return; }
            const regimeChecked = document.querySelector('input[name="regime"]:checked');
            if (!regimeChecked) { mostrarAlerta('Seleccione un r√©gimen tributario.', 'warning'); return; }
            irPaso(5);
        }

        // ==========================================
        // PASO 5: INFORMACI√ìN BANCARIA
        // ==========================================
        function validarPaso5() {
            if (!document.getElementById('bank').value) { mostrarAlerta('Seleccione entidad bancaria.', 'warning'); return; }
            if (!document.getElementById('account-type').value) { mostrarAlerta('Seleccione tipo de cuenta.', 'warning'); return; }
            if (!document.getElementById('account-number').value.trim()) { mostrarAlerta('Ingrese n√∫mero de cuenta.', 'warning'); return; }
            irPaso(6);
        }

        // ==========================================
        // PASO 6: DOCUMENTOS ADJUNTOS
        // ==========================================
        function renderizarAdjuntos() {
            const container = document.getElementById('attachments-container');
            const filtered = cacheAttachTypes.filter(a => 
                a.applies_to === 'both' || a.applies_to === selectedPersonType
            );
            
            if (filtered.length === 0) {
                container.innerHTML = '<span class="text-muted">No hay tipos de adjuntos configurados</span>';
                return;
            }
            
            container.innerHTML = filtered.map(a => {
                const isReq = a.is_required;
                const exts = a.allowed_extensions || 'pdf,jpg,jpeg,png';
                const maxMB = a.max_file_size_mb || 5;
                const acceptAttr = exts.split(',').map(e => '.' + e.trim()).join(',');
                
                return `
                <div class="mb-3">
                    <label class="form-label">
                        ${a.type_name} ${isReq ? '<span class="text-danger">*</span>' : '<span class="badge bg-light text-muted">Opcional</span>'}
                    </label>
                    ${a.type_description ? `<div class="small text-muted mb-1">${a.type_description}</div>` : ''}
                    <div class="file-upload-zone" id="zone-${a.attachment_type_id}" onclick="document.getElementById('file-${a.attachment_type_id}').click()">
                        <input type="file" id="file-${a.attachment_type_id}" style="display:none;" 
                               accept="${acceptAttr}" data-type-id="${a.attachment_type_id}"
                               data-max-mb="${maxMB}" data-extensions="${exts}" data-required="${isReq}"
                               onchange="handleFileSelect(this, '${a.attachment_type_id}')">
                        <div id="file-label-${a.attachment_type_id}">
                            <i class="bi bi-cloud-upload" style="font-size:1.5rem; color: #adb5bd;"></i>
                            <div class="small text-muted mt-1">Clic para seleccionar archivo</div>
                            <div class="small text-muted">Formatos: ${exts} | M√°x: ${maxMB} MB</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        function handleFileSelect(input, typeId) {
            const file = input.files[0];
            if (!file) return;
            
            const maxMB = parseInt(input.dataset.maxMb) || 5;
            const exts = input.dataset.extensions.split(',').map(e => e.trim().toLowerCase());
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            // Validar extensi√≥n
            if (!exts.includes(fileExt)) {
                mostrarAlerta(`Formato no permitido. Use: ${exts.join(', ')}`, 'warning');
                input.value = '';
                return;
            }
            
            // Validar tama√±o
            if (file.size > maxMB * 1024 * 1024) {
                mostrarAlerta(`El archivo excede el tama√±o m√°ximo de ${maxMB} MB`, 'warning');
                input.value = '';
                return;
            }
            
            // Guardar referencia
            uploadedFiles[typeId] = { file, name: file.name };
            
            // Actualizar UI
            const zone = document.getElementById(`zone-${typeId}`);
            zone.classList.add('has-file');
            document.getElementById(`file-label-${typeId}`).innerHTML = `
                <i class="bi bi-check-circle-fill text-success" style="font-size:1.5rem;"></i>
                <div class="small text-success mt-1 fw-bold">${file.name}</div>
                <div class="small text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</div>`;
        }

        // ==========================================
        // ENVIAR REGISTRO
        // ==========================================
        async function enviarRegistro() {
            const btn = document.getElementById('btn-submit');
            
            // Validar adjuntos obligatorios
            const filtered = cacheAttachTypes.filter(a => a.applies_to === 'both' || a.applies_to === selectedPersonType);
            for (const att of filtered) {
                if (att.is_required && !uploadedFiles[att.attachment_type_id]) {
                    mostrarAlerta(`Debe adjuntar: ${att.type_name}`, 'warning');
                    return;
                }
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Enviando...';
            
            try {
                // 1. Construir payload del proveedor
                const regimeChecked = document.querySelector('input[name="regime"]:checked');
                
                const supplierPayload = {
                    person_type: selectedPersonType,
                    phone: document.getElementById('phone').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    department_id: document.getElementById('department').value,
                    municipality_id: document.getElementById('municipality').value,
                    address: document.getElementById('address-formatted').value,
                    address_reference: document.getElementById('address-reference').value.trim() || null,
                    ciiu_id: document.getElementById('ciiu-selected').value,
                    products_services: document.getElementById('products-services').value.trim(),
                    tax_regime_id: regimeChecked.value,
                    bank_id: document.getElementById('bank').value,
                    account_type: document.getElementById('account-type').value,
                    account_number: document.getElementById('account-number').value.trim(),
                    supplier_status: 'pending'
                };
                
                // Campos condicionales
                if (selectedPersonType === 'natural') {
                    supplierPayload.document_type = document.getElementById('doc-type').value;
                    supplierPayload.document_number = document.getElementById('doc-number').value.trim();
                    supplierPayload.first_name = document.getElementById('first-name').value.trim();
                    supplierPayload.second_name = document.getElementById('second-name').value.trim() || null;
                    supplierPayload.last_name_1 = document.getElementById('last-name-1').value.trim();
                    supplierPayload.last_name_2 = document.getElementById('last-name-2').value.trim() || null;
                } else {
                    supplierPayload.business_name = document.getElementById('business-name').value.trim();
                    supplierPayload.nit = document.getElementById('nit').value.trim();
                    supplierPayload.nit_verification_digit = document.getElementById('nit-dv').value;
                    supplierPayload.contact_name = document.getElementById('contact-name').value.trim();
                }
                
                // 2. Insertar proveedor
                const supplierResult = await insertData('/sup_suppliers', supplierPayload);
                const supplierId = supplierResult[0].supplier_id;
                console.log('‚úÖ Proveedor creado:', supplierId);
                
                // 3. Insertar condiciones tributarias
                const condChecks = document.querySelectorAll('#conditions-container input[type="checkbox"]:checked');
                if (condChecks.length > 0) {
                    const condPayload = Array.from(condChecks).map(c => ({
                        supplier_id: supplierId,
                        condition_id: c.value
                    }));
                    await insertData('/sup_supplier_tax_conditions', condPayload);
                    console.log('‚úÖ Condiciones tributarias registradas');
                }
                
                // 4. Insertar aceptaciones legales
                const legalAcceptances = cacheLegalDocs
                    .filter(doc => cacheLegalVersions[doc.document_id])
                    .map(doc => ({
                        supplier_id: supplierId,
                        version_id: cacheLegalVersions[doc.document_id].version_id
                    }));
                
                if (legalAcceptances.length > 0) {
                    await insertData('/sup_supplier_legal_acceptances', legalAcceptances);
                    console.log('‚úÖ Aceptaciones legales registradas');
                }
                
                // 5. Subir archivos a Storage y registrar en BD
                const fileEntries = Object.entries(uploadedFiles);
                for (const [typeId, fileData] of fileEntries) {
                    try {
                        const timestamp = Date.now();
                        const fileName = `${timestamp}_${fileData.name}`;
                        const filePath = `suppliers/${supplierId}/${fileName}`;
                        
                        const { data, error } = await supabaseClient
                            .storage
                            .from(STORAGE_BUCKET)
                            .upload(filePath, fileData.file, {
                                cacheControl: '3600',
                                upsert: false
                            });
                        
                        if (error) throw error;
                        
                        // Registrar en BD
                        await insertData('/sup_supplier_attachments', {
                            supplier_id: supplierId,
                            attachment_type_id: typeId,
                            file_name: fileData.name,
                            file_path: filePath,
                            file_size: fileData.file.size,
                            file_type: fileData.file.type
                        });
                        
                        console.log('‚úÖ Archivo subido:', fileData.name);
                    } catch (fileError) {
                        console.error('‚ö†Ô∏è Error subiendo archivo:', fileData.name, fileError);
                        // Continuar con los dem√°s archivos
                    }
                }
                
                // 6. Mostrar pantalla de √©xito
                document.getElementById('success-email').textContent = supplierPayload.email;
                document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
                document.getElementById('step-success').classList.add('active');
                document.getElementById('stepper').style.display = 'none';
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                console.log('üéâ Registro completado');
                
            } catch (error) {
                console.error('‚ùå Error en el registro:', error);
                
                if (error.message.includes('duplicate') || error.message.includes('unique')) {
                    mostrarAlerta('Ya existe un proveedor registrado con este correo electr√≥nico.', 'danger');
                } else {
                    mostrarAlerta('Error al enviar el registro: ' + error.message, 'danger');
                }
                
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-send me-1"></i>Enviar Registro';
            }
        }
        
        console.log('‚úÖ Registro de Proveedores - SchoolNet cargado');
    </script>
</body>
</html>
