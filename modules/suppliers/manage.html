<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.19.22.00">
    <title>Gestionar Proveedores - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .loading-overlay.hidden { display: none; }
        .loading-content { background: white; padding: 2rem; border-radius: 8px; text-align: center; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Status badges */
        .badge-pending { background-color: #ffc107; color: #000; }
        .badge-approved { background-color: #198754; }
        .badge-rejected { background-color: #dc3545; }
        .badge-inactive { background-color: #6c757d; }
        .badge-natural { background-color: #0d6efd; }
        .badge-juridica { background-color: #6f42c1; }

        /* Search & filters */
        .search-card { border: 2px solid #e9ecef; border-radius: 12px; }
        .search-card .card-body { padding: 1rem 1.25rem; }
        
        /* Table */
        .table-suppliers td { vertical-align: middle; }
        .table-suppliers .supplier-name { font-weight: 600; }
        .table-suppliers .supplier-doc { font-size: 0.85rem; color: #6c757d; }
        
        /* Clickable rows */
        .row-clickable { cursor: pointer; transition: background-color 0.15s; }
        .row-clickable:hover { background-color: #f0f4ff !important; }
        
        /* Detail modal sections */
        .detail-section { border-left: 3px solid #0d6efd; padding-left: 1rem; margin-bottom: 1.5rem; }
        .detail-section h6 { color: #0d6efd; font-weight: 700; margin-bottom: 0.75rem; }
        .detail-field { margin-bottom: 0.5rem; }
        .detail-label { font-size: 0.8rem; color: #6c757d; margin-bottom: 0; }
        .detail-value { font-weight: 500; }
        
        /* Attachment links */
        .attachment-item { display: flex; align-items: center; padding: 0.5rem 0.75rem; background: #f8f9fa; border-radius: 6px; margin-bottom: 0.5rem; }
        .attachment-item i { font-size: 1.2rem; margin-right: 0.5rem; color: #dc3545; }
        .attachment-item a { text-decoration: none; flex: 1; }
        .attachment-item .file-size { font-size: 0.8rem; color: #6c757d; }

        /* Counter badges */
        .counter-badge { font-size: 1.5rem; font-weight: 700; }
        .counter-card { border-radius: 10px; border: none; transition: transform 0.2s; }
        .counter-card:hover { transform: translateY(-2px); }
    </style>
</head>

<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <div class="container-fluid">
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a></li>
                <li class="breadcrumb-item"><a href="index.html">Proveedores</a></li>
                <li class="breadcrumb-item active" aria-current="page">Gestionar Proveedores</li>
            </ol>
        </nav>

        <!-- HEADER -->
        <div class="row mb-3">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-people-fill me-2"></i>Gestionar Proveedores
                </h1>
                <p class="text-muted mb-0">Revisi√≥n, aprobaci√≥n y administraci√≥n de proveedores registrados</p>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- ============================================ -->
        <!-- CONTADORES R√ÅPIDOS                          -->
        <!-- ============================================ -->
        <div class="row mb-3" id="counters-row">
            <div class="col-6 col-md-3 mb-2">
                <div class="card counter-card shadow-sm" style="border-left: 4px solid #ffc107;">
                    <div class="card-body py-2 px-3 d-flex align-items-center justify-content-between">
                        <div>
                            <div class="counter-badge text-warning" id="count-pending">0</div>
                            <small class="text-muted">Pendientes</small>
                        </div>
                        <i class="bi bi-clock-history text-warning" style="font-size:1.8rem; opacity:0.5;"></i>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-2">
                <div class="card counter-card shadow-sm" style="border-left: 4px solid #198754;">
                    <div class="card-body py-2 px-3 d-flex align-items-center justify-content-between">
                        <div>
                            <div class="counter-badge text-success" id="count-approved">0</div>
                            <small class="text-muted">Aprobados</small>
                        </div>
                        <i class="bi bi-check-circle text-success" style="font-size:1.8rem; opacity:0.5;"></i>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-2">
                <div class="card counter-card shadow-sm" style="border-left: 4px solid #dc3545;">
                    <div class="card-body py-2 px-3 d-flex align-items-center justify-content-between">
                        <div>
                            <div class="counter-badge text-danger" id="count-rejected">0</div>
                            <small class="text-muted">Rechazados</small>
                        </div>
                        <i class="bi bi-x-circle text-danger" style="font-size:1.8rem; opacity:0.5;"></i>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-2">
                <div class="card counter-card shadow-sm" style="border-left: 4px solid #0d6efd;">
                    <div class="card-body py-2 px-3 d-flex align-items-center justify-content-between">
                        <div>
                            <div class="counter-badge text-primary" id="count-total">0</div>
                            <small class="text-muted">Total</small>
                        </div>
                        <i class="bi bi-people text-primary" style="font-size:1.8rem; opacity:0.5;"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- BUSCADORES Y FILTROS                        -->
        <!-- ============================================ -->
        <div class="card search-card mb-3">
            <div class="card-body">
                <div class="row g-2 align-items-end">
                    <!-- Buscador por nombre -->
                    <div class="col-md-3">
                        <label class="form-label small mb-1">
                            <i class="bi bi-search me-1"></i>Nombre / Raz√≥n Social
                        </label>
                        <input type="text" class="form-control" id="search-name" 
                               placeholder="Buscar por nombre o raz√≥n social..."
                               oninput="filtrarProveedores()">
                    </div>
                    <!-- Buscador por productos/servicios -->
                    <div class="col-md-2">
                        <label class="form-label small mb-1">
                            <i class="bi bi-box-seam me-1"></i>Productos / Servicios
                        </label>
                        <input type="text" class="form-control" id="search-services" 
                               placeholder="Productos o servicios..."
                               oninput="filtrarProveedores()">
                    </div>
                    <!-- Filtro estado -->
                    <div class="col-md-2">
                        <label class="form-label small mb-1">Estado</label>
                        <select class="form-select" id="filter-status" onchange="filtrarProveedores()">
                            <option value="">Todos</option>
                            <option value="pending" selected>Pendientes</option>
                            <option value="approved">Aprobados</option>
                            <option value="rejected">Rechazados</option>
                            <option value="inactive">Inactivos</option>
                        </select>
                    </div>
                    <!-- Filtro tipo persona -->
                    <div class="col-md-2">
                        <label class="form-label small mb-1">Tipo</label>
                        <select class="form-select" id="filter-type" onchange="filtrarProveedores()">
                            <option value="">Todos</option>
                            <option value="natural">Natural</option>
                            <option value="juridica">Jur√≠dica</option>
                        </select>
                    </div>
                    <!-- Ordenar por -->
                    <div class="col-md-2">
                        <label class="form-label small mb-1"><i class="bi bi-sort-down me-1"></i>Ordenar</label>
                        <select class="form-select" id="sort-order" onchange="filtrarProveedores()">
                            <option value="created_desc">M√°s recientes</option>
                            <option value="created_asc">M√°s antiguos</option>
                            <option value="name_asc">Nombre A ‚Üí Z</option>
                            <option value="name_desc">Nombre Z ‚Üí A</option>
                            <option value="status">Por estado</option>
                        </select>
                    </div>
                    <!-- Bot√≥n limpiar -->
                    <div class="col-md-1">
                        <button class="btn btn-outline-secondary w-100" onclick="limpiarFiltros()" title="Limpiar filtros">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- TABLA DE PROVEEDORES                        -->
        <!-- ============================================ -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>
                    Proveedores 
                    <span class="badge bg-secondary ms-2" id="count-filtered">0</span>
                </h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="cargarProveedores()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-suppliers mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Proveedor</th>
                                <th>Documento</th>
                                <th class="d-none d-lg-table-cell">Productos / Servicios</th>
                                <th>Tipo</th>
                                <th>Estado</th>
                                <th class="d-none d-md-table-cell">Registro</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-suppliers">
                            <tr><td colspan="7" class="text-center py-4 text-muted">
                                <div class="spinner-border spinner-border-sm text-primary me-2"></div>Cargando proveedores...
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div><!-- /container-fluid -->


    <!-- ============================================ -->
    <!-- MODAL: DETALLE DEL PROVEEDOR                -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-detail" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detail-title">
                        <i class="bi bi-person-badge me-2"></i>Detalle del Proveedor
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detail-body">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-2">Cargando informaci√≥n...</p>
                    </div>
                </div>
                <div class="modal-footer" id="detail-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- ============================================ -->
    <!-- MODAL: APROBAR PROVEEDOR                    -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-approve" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>Aprobar Proveedor</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form onsubmit="confirmarAprobacion(event)">
                    <div class="modal-body">
                        <input type="hidden" id="approve-id">
                        <p>Est√° a punto de aprobar al proveedor: <strong id="approve-name"></strong></p>
                        
                        <div class="mb-3">
                            <label for="approve-worker" class="form-label">
                                Worker responsable <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="approve-worker" required>
                                <option value="">Seleccione un responsable...</option>
                            </select>
                            <div class="form-text">Persona interna que ser√° el contacto para este proveedor</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="approve-notes" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="approve-notes" rows="2" placeholder="Observaciones opcionales..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success" id="btn-confirm-approve">
                            <i class="bi bi-check-circle me-1"></i>Confirmar Aprobaci√≥n
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- ============================================ -->
    <!-- MODAL: RECHAZAR PROVEEDOR                   -->
    <!-- ============================================ -->
    <div class="modal fade" id="modal-reject" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-x-circle me-2"></i>Rechazar Proveedor</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form onsubmit="confirmarRechazo(event)">
                    <div class="modal-body">
                        <input type="hidden" id="reject-id">
                        <p>Est√° a punto de rechazar al proveedor: <strong id="reject-name"></strong></p>
                        
                        <div class="mb-3">
                            <label for="reject-reason" class="form-label">
                                Motivo del rechazo <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="reject-reason" rows="3" required
                                      placeholder="Indique el motivo del rechazo..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger" id="btn-confirm-reject">
                            <i class="bi bi-x-circle me-1"></i>Confirmar Rechazo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let cacheSuppliers = [];
        let cacheWorkers = [];
        let currentSession = null;
        let modalDetail, modalApprove, modalReject;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Administrar proveedores');
                if (!hasAccess) return;
                
                console.log('‚úÖ Acceso permitido');
                currentSession = getStoredSession();
                if (!currentSession) {
                    showMessage('Sesi√≥n no v√°lida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '../../index.html', 2000);
                    return;
                }

                // Inicializar modales
                modalDetail = new bootstrap.Modal(document.getElementById('modal-detail'));
                modalApprove = new bootstrap.Modal(document.getElementById('modal-approve'));
                modalReject = new bootstrap.Modal(document.getElementById('modal-reject'));

                // Cargar datos
                await Promise.all([
                    cargarProveedores(),
                    cargarWorkers()
                ]);

            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                showMessage('Error al inicializar: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        
        async function cargarProveedores() {
            try {
                const data = await supabaseRequest(
                    '/sup_suppliers?select=' +
                    '*,' +
                    'sup_departments(department_name),' +
                    'sup_municipalities(municipality_name),' +
                    'sup_banks(bank_name),' +
                    'sup_ciiu_activities(ciiu_code,ciiu_description),' +
                    'sup_tax_regimes(regime_name),' +
                    'approved_by_user:users!sup_suppliers_approved_by_fkey(user_name),' +
                    'responsible_worker:workers!sup_suppliers_responsible_worker_fkey(worker_id,worker_first_name,worker_last_name_1)' +
                    '&order=created_at.desc'
                );
                
                cacheSuppliers = data || [];
                actualizarContadores();
                filtrarProveedores();
                
                console.log(`‚úÖ ${cacheSuppliers.length} proveedores cargados`);
            } catch (error) {
                console.error('‚ùå Error cargando proveedores:', error);
                document.getElementById('tbody-suppliers').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger py-4">Error al cargar proveedores</td></tr>';
            }
        }

        async function cargarWorkers() {
            try {
                const data = await supabaseRequest(
                    '/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,email' +
                    '&worker_status=eq.active&order=worker_last_name_1.asc'
                );
                cacheWorkers = data || [];
                
                // Poblar select de worker en modal de aprobaci√≥n
                const sel = document.getElementById('approve-worker');
                sel.innerHTML = '<option value="">Seleccione un responsable...</option>' +
                    cacheWorkers.map(w => 
                        `<option value="${w.worker_id}">${w.worker_last_name_1} ${w.worker_last_name_2 || ''} ${w.worker_first_name}</option>`
                    ).join('');
                    
            } catch (error) {
                console.error('‚ùå Error cargando workers:', error);
            }
        }

        // ==========================================
        // CONTADORES
        // ==========================================
        
        function actualizarContadores() {
            const counts = { pending: 0, approved: 0, rejected: 0, inactive: 0 };
            cacheSuppliers.forEach(s => {
                if (counts[s.supplier_status] !== undefined) counts[s.supplier_status]++;
            });
            
            document.getElementById('count-pending').textContent = counts.pending;
            document.getElementById('count-approved').textContent = counts.approved;
            document.getElementById('count-rejected').textContent = counts.rejected;
            document.getElementById('count-total').textContent = cacheSuppliers.length;
        }

        // ==========================================
        // FILTROS Y B√öSQUEDA
        // ==========================================
        
        function filtrarProveedores() {
            const searchName = document.getElementById('search-name').value.toLowerCase().trim();
            const searchServices = document.getElementById('search-services').value.toLowerCase().trim();
            const filterStatus = document.getElementById('filter-status').value;
            const filterType = document.getElementById('filter-type').value;
            
            const filtered = cacheSuppliers.filter(s => {
                // Filtro por estado
                if (filterStatus && s.supplier_status !== filterStatus) return false;
                
                // Filtro por tipo persona
                if (filterType && s.person_type !== filterType) return false;
                
                // B√∫squeda por nombre/raz√≥n social
                if (searchName) {
                    const nameFields = [
                        s.business_name,
                        s.first_name, s.second_name,
                        s.last_name_1, s.last_name_2,
                        s.contact_name
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    if (!nameFields.includes(searchName)) return false;
                }
                
                // B√∫squeda por productos/servicios
                if (searchServices) {
                    const services = (s.products_services || '').toLowerCase();
                    if (!services.includes(searchServices)) return false;
                }
                
                return true;
            });
            
            document.getElementById('count-filtered').textContent = filtered.length;
            
            // Ordenar
            const sortOrder = document.getElementById('sort-order').value;
            filtered.sort((a, b) => {
                switch (sortOrder) {
                    case 'created_asc':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'name_asc':
                        return getNombreProveedor(a).localeCompare(getNombreProveedor(b));
                    case 'name_desc':
                        return getNombreProveedor(b).localeCompare(getNombreProveedor(a));
                    case 'status':
                        const order = { pending: 0, approved: 1, rejected: 2, inactive: 3 };
                        return (order[a.supplier_status] ?? 9) - (order[b.supplier_status] ?? 9);
                    case 'created_desc':
                    default:
                        return new Date(b.created_at) - new Date(a.created_at);
                }
            });
            
            renderizarTabla(filtered);
        }

        function limpiarFiltros() {
            document.getElementById('search-name').value = '';
            document.getElementById('search-services').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-type').value = '';
            document.getElementById('sort-order').value = 'created_desc';
            filtrarProveedores();
        }

        // ==========================================
        // RENDERIZAR TABLA
        // ==========================================
        
        function renderizarTabla(datos) {
            const tbody = document.getElementById('tbody-suppliers');
            
            if (!datos || datos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size:2rem;"></i>
                    <p class="mt-2 mb-0">No se encontraron proveedores</p>
                </td></tr>`;
                return;
            }
            
            tbody.innerHTML = datos.map(s => {
                const nombre = getNombreProveedor(s);
                const documento = getDocumentoProveedor(s);
                const servicios = s.products_services 
                    ? (s.products_services.length > 60 ? s.products_services.substring(0, 60) + '...' : s.products_services)
                    : '<span class="text-muted">‚Äî</span>';
                const fecha = s.created_at ? formatDate(s.created_at) : '‚Äî';
                
                return `
                <tr class="row-clickable" ondblclick="verDetalle('${s.supplier_id}')">
                    <td>
                        <div class="supplier-name">${nombre}</div>
                        ${s.email ? `<div class="supplier-doc">${s.email}</div>` : ''}
                    </td>
                    <td><span class="supplier-doc">${documento}</span></td>
                    <td class="d-none d-lg-table-cell"><small>${servicios}</small></td>
                    <td>${badgeTipo(s.person_type)}</td>
                    <td>${badgeEstado(s.supplier_status)}</td>
                    <td class="d-none d-md-table-cell"><small>${fecha}</small></td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="verDetalle('${s.supplier_id}')" title="Ver detalle">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${s.supplier_status === 'pending' ? `
                            <button class="btn btn-outline-success" onclick="abrirAprobacion('${s.supplier_id}')" title="Aprobar">
                                <i class="bi bi-check-lg"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="abrirRechazo('${s.supplier_id}')" title="Rechazar">
                                <i class="bi bi-x-lg"></i>
                            </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        // ==========================================
        // HELPERS DE PRESENTACI√ìN
        // ==========================================
        
        function getNombreProveedor(s) {
            if (s.person_type === 'juridica') {
                return s.business_name || 'Sin raz√≥n social';
            }
            return [s.first_name, s.second_name, s.last_name_1, s.last_name_2]
                .filter(Boolean).join(' ') || 'Sin nombre';
        }

        function getDocumentoProveedor(s) {
            if (s.person_type === 'juridica') {
                return s.nit ? `NIT ${s.nit}-${s.nit_verification_digit || '?'}` : '‚Äî';
            }
            return s.document_number ? `${s.document_type || ''} ${s.document_number}` : '‚Äî';
        }

        function badgeEstado(status) {
            const map = {
                pending: '<span class="badge badge-pending">Pendiente</span>',
                approved: '<span class="badge badge-approved">Aprobado</span>',
                rejected: '<span class="badge badge-rejected">Rechazado</span>',
                inactive: '<span class="badge badge-inactive">Inactivo</span>'
            };
            return map[status] || `<span class="badge bg-secondary">${status}</span>`;
        }

        function badgeTipo(type) {
            return type === 'juridica' 
                ? '<span class="badge badge-juridica">Jur√≠dica</span>'
                : '<span class="badge badge-natural">Natural</span>';
        }

        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // ==========================================
        // VER DETALLE
        // ==========================================
        
        async function verDetalle(id) {
            const s = cacheSuppliers.find(x => x.supplier_id === id);
            if (!s) return;
            
            document.getElementById('detail-title').innerHTML = 
                `<i class="bi bi-person-badge me-2"></i>${getNombreProveedor(s)} ${badgeEstado(s.supplier_status)}`;
            
            // Cargar datos relacionados en paralelo
            let condiciones = [], adjuntos = [], aceptaciones = [];
            try {
                const [condData, adjData, acepData] = await Promise.all([
                    supabaseRequest(`/sup_supplier_tax_conditions?select=sup_tax_conditions(condition_name)&supplier_id=eq.${id}`),
                    supabaseRequest(`/sup_supplier_attachments?select=*,sup_attachment_types(type_name)&supplier_id=eq.${id}&order=uploaded_at.asc`),
                    supabaseRequest(`/sup_supplier_legal_acceptances?select=*,sup_legal_document_versions(version_number,sup_legal_documents(document_name))&supplier_id=eq.${id}&order=accepted_at.asc`)
                ]);
                condiciones = condData || [];
                adjuntos = adjData || [];
                aceptaciones = acepData || [];
            } catch (e) {
                console.error('Error cargando datos relacionados:', e);
            }
            
            // Construir HTML del detalle
            const body = document.getElementById('detail-body');
            
            // --- Secci√≥n Identificaci√≥n ---
            let htmlIdent = '';
            if (s.person_type === 'juridica') {
                htmlIdent = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-field"><p class="detail-label">Raz√≥n Social</p><p class="detail-value">${s.business_name || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">NIT</p><p class="detail-value">${s.nit || '‚Äî'}-${s.nit_verification_digit || '?'}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Contacto</p><p class="detail-value">${s.contact_name || '‚Äî'}</p></div>
                        </div>
                    </div>`;
            } else {
                htmlIdent = `
                    <div class="row">
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Tipo Doc.</p><p class="detail-value">${s.document_type || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">N√∫mero</p><p class="detail-value">${s.document_number || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Nombres</p><p class="detail-value">${[s.first_name, s.second_name].filter(Boolean).join(' ') || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Apellidos</p><p class="detail-value">${[s.last_name_1, s.last_name_2].filter(Boolean).join(' ') || '‚Äî'}</p></div>
                        </div>
                    </div>`;
            }
            
            // --- Secci√≥n Contacto y Ubicaci√≥n ---
            const deptoName = s.sup_departments?.department_name || '‚Äî';
            const muniName = s.sup_municipalities?.municipality_name || '‚Äî';
            
            // --- Secci√≥n Fiscal ---
            const ciiuInfo = s.sup_ciiu_activities 
                ? `${s.sup_ciiu_activities.ciiu_code} - ${s.sup_ciiu_activities.ciiu_description}`
                : '‚Äî';
            const regimenName = s.sup_tax_regimes?.regime_name || '‚Äî';
            const condList = condiciones.map(c => c.sup_tax_conditions?.condition_name).filter(Boolean);
            
            // --- Secci√≥n Bancaria ---
            const bankName = s.sup_banks?.bank_name || '‚Äî';
            
            // --- Secci√≥n Adjuntos ---
            const storageBaseUrl = getStorageBaseUrl();
            const htmlAdjuntos = adjuntos.length > 0 
                ? adjuntos.map(a => {
                    const url = `${storageBaseUrl}/supplier-files/${a.file_path}`;
                    return `<div class="attachment-item">
                        <i class="bi bi-file-earmark-pdf"></i>
                        <a href="${url}" target="_blank">${a.sup_attachment_types?.type_name || a.file_name}</a>
                        <span class="file-size">${formatFileSize(a.file_size)}</span>
                    </div>`;
                }).join('')
                : '<span class="text-muted">Sin documentos adjuntos</span>';
            
            // --- Secci√≥n Aceptaciones Legales ---
            const htmlAcep = aceptaciones.length > 0
                ? aceptaciones.map(a => {
                    const docName = a.sup_legal_document_versions?.sup_legal_documents?.document_name || 'Documento';
                    const ver = a.sup_legal_document_versions?.version_number || '?';
                    const fecha = a.accepted_at ? formatDate(a.accepted_at) : '‚Äî';
                    return `<div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                        <span><i class="bi bi-check-circle-fill text-success me-2"></i>${docName} <small class="text-muted">(v${ver})</small></span>
                        <small class="text-muted">${fecha}</small>
                    </div>`;
                }).join('')
                : '<span class="text-muted">Sin aceptaciones registradas</span>';
            
            // --- Secci√≥n Gesti√≥n ---
            const workerResp = s.responsible_worker 
                ? `${s.responsible_worker.worker_first_name} ${s.responsible_worker.worker_last_name_1}`
                : '‚Äî';
            const approvedBy = s.approved_by_user?.user_name || '‚Äî';
            const approvedAt = s.approved_at ? formatDate(s.approved_at) : '‚Äî';

            body.innerHTML = `
                <!-- Identificaci√≥n -->
                <div class="detail-section">
                    <h6><i class="bi bi-person-vcard me-2"></i>Identificaci√≥n ${badgeTipo(s.person_type)}</h6>
                    ${htmlIdent}
                </div>

                <!-- Contacto y Ubicaci√≥n -->
                <div class="detail-section">
                    <h6><i class="bi bi-geo-alt me-2"></i>Contacto y Ubicaci√≥n</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Tel√©fono</p><p class="detail-value">${s.phone || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Email</p><p class="detail-value">${s.email || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Departamento</p><p class="detail-value">${deptoName}</p></div>
                        </div>
                        <div class="col-md-3">
                            <div class="detail-field"><p class="detail-label">Municipio</p><p class="detail-value">${muniName}</p></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-field"><p class="detail-label">Direcci√≥n</p><p class="detail-value">${s.address || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-field"><p class="detail-label">Referencia</p><p class="detail-value">${s.address_reference || '‚Äî'}</p></div>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n Fiscal -->
                <div class="detail-section">
                    <h6><i class="bi bi-receipt me-2"></i>Informaci√≥n Fiscal</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-field"><p class="detail-label">Actividad CIIU</p><p class="detail-value">${ciiuInfo}</p></div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-field"><p class="detail-label">R√©gimen Tributario</p><p class="detail-value">${regimenName}</p></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-field">
                                <p class="detail-label">Productos / Servicios</p>
                                <p class="detail-value">${s.products_services || '‚Äî'}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-field">
                                <p class="detail-label">Condiciones Tributarias</p>
                                ${condList.length > 0 
                                    ? condList.map(c => `<span class="badge bg-light text-dark border me-1 mb-1">${c}</span>`).join('') 
                                    : '<span class="text-muted">Ninguna</span>'}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n Bancaria -->
                <div class="detail-section">
                    <h6><i class="bi bi-bank me-2"></i>Informaci√≥n Bancaria</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="detail-field"><p class="detail-label">Banco</p><p class="detail-value">${bankName}</p></div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-field"><p class="detail-label">Tipo Cuenta</p><p class="detail-value">${s.account_type || '‚Äî'}</p></div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-field"><p class="detail-label">N√∫mero</p><p class="detail-value">${s.account_number || '‚Äî'}</p></div>
                        </div>
                    </div>
                </div>

                <!-- Documentos Adjuntos -->
                <div class="detail-section">
                    <h6><i class="bi bi-paperclip me-2"></i>Documentos Adjuntos</h6>
                    ${htmlAdjuntos}
                </div>

                <!-- Aceptaciones Legales -->
                <div class="detail-section">
                    <h6><i class="bi bi-shield-check me-2"></i>Aceptaciones Legales</h6>
                    ${htmlAcep}
                </div>

                <!-- Gesti√≥n Interna -->
                ${s.supplier_status !== 'pending' ? `
                <div class="detail-section" style="border-left-color: #6c757d;">
                    <h6 style="color: #6c757d;"><i class="bi bi-gear me-2"></i>Gesti√≥n Interna</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="detail-field"><p class="detail-label">Worker Responsable</p><p class="detail-value">${workerResp}</p></div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-field"><p class="detail-label">Aprobado/Rechazado por</p><p class="detail-value">${approvedBy}</p></div>
                        </div>
                        <div class="col-md-4">
                            <div class="detail-field"><p class="detail-label">Fecha</p><p class="detail-value">${approvedAt}</p></div>
                        </div>
                    </div>
                    ${s.rejection_reason ? `
                    <div class="row">
                        <div class="col-12">
                            <div class="detail-field">
                                <p class="detail-label">Motivo de rechazo</p>
                                <p class="detail-value text-danger">${s.rejection_reason}</p>
                            </div>
                        </div>
                    </div>` : ''}
                </div>` : ''}
            `;

            // Footer con botones de acci√≥n seg√∫n estado
            const footer = document.getElementById('detail-footer');
            if (s.supplier_status === 'pending') {
                footer.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-danger" onclick="modalDetail.hide(); abrirRechazo('${s.supplier_id}')">
                        <i class="bi bi-x-circle me-1"></i>Rechazar
                    </button>
                    <button type="button" class="btn btn-success" onclick="modalDetail.hide(); abrirAprobacion('${s.supplier_id}')">
                        <i class="bi bi-check-circle me-1"></i>Aprobar
                    </button>`;
            } else {
                footer.innerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>';
            }

            modalDetail.show();
        }

        // ==========================================
        // APROBAR PROVEEDOR
        // ==========================================
        
        function abrirAprobacion(id) {
            const s = cacheSuppliers.find(x => x.supplier_id === id);
            if (!s) return;
            
            document.getElementById('approve-id').value = id;
            document.getElementById('approve-name').textContent = getNombreProveedor(s);
            document.getElementById('approve-worker').value = '';
            document.getElementById('approve-notes').value = '';
            modalApprove.show();
        }

        async function confirmarAprobacion(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-confirm-approve');
            btn.disabled = true;
            
            try {
                const id = document.getElementById('approve-id').value;
                const workerId = document.getElementById('approve-worker').value;
                
                if (!workerId) {
                    showMessage('Seleccione un worker responsable', 'warning');
                    btn.disabled = false;
                    return;
                }
                
                const payload = {
                    supplier_status: 'approved',
                    approved_by: currentSession.user.user_id,
                    approved_at: new Date().toISOString(),
                    responsible_worker_id: workerId
                };
                
                await supabaseRequest(`/sup_suppliers?supplier_id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify(payload)
                });
                
                modalApprove.hide();
                showMessage('Proveedor aprobado exitosamente', 'success');
                await cargarProveedores();
                
            } catch (error) {
                showMessage('Error al aprobar: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
            }
        }

        // ==========================================
        // RECHAZAR PROVEEDOR
        // ==========================================
        
        function abrirRechazo(id) {
            const s = cacheSuppliers.find(x => x.supplier_id === id);
            if (!s) return;
            
            document.getElementById('reject-id').value = id;
            document.getElementById('reject-name').textContent = getNombreProveedor(s);
            document.getElementById('reject-reason').value = '';
            modalReject.show();
        }

        async function confirmarRechazo(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-confirm-reject');
            btn.disabled = true;
            
            try {
                const id = document.getElementById('reject-id').value;
                const reason = document.getElementById('reject-reason').value.trim();
                
                if (!reason) {
                    showMessage('Ingrese el motivo del rechazo', 'warning');
                    btn.disabled = false;
                    return;
                }
                
                const payload = {
                    supplier_status: 'rejected',
                    approved_by: currentSession.user.user_id,
                    approved_at: new Date().toISOString(),
                    rejection_reason: reason
                };
                
                await supabaseRequest(`/sup_suppliers?supplier_id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify(payload)
                });
                
                modalReject.hide();
                showMessage('Proveedor rechazado', 'warning');
                await cargarProveedores();
                
            } catch (error) {
                showMessage('Error al rechazar: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
            }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        
        function getStorageBaseUrl() {
            // Construir URL base de Storage desde la configuraci√≥n de Supabase
            const env = detectEnvironment();
            const config = ENVIRONMENT_CONFIGS[env]?.supabase || ENVIRONMENT_CONFIGS.development.supabase;
            return `${config.url}/storage/v1/object/public`;
        }

        console.log('‚úÖ manage.html cargado');
    </script>
</body>
</html>
