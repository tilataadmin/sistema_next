<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Asuntos Individuales - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- TinyMCE -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .student-search-container {
            position: relative;
        }
        
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .suggestion-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .suggestion-item:hover,
        .suggestion-item.active {
            background-color: #f8f9fa;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .student-photo {
            max-width: 120px;
            max-height: 120px;
            border-radius: 0.375rem;
            border: 2px solid #dee2e6;
            object-fit: cover;
        }
        
        .categories-container {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.75rem;
            background-color: #f8f9fa;
        }
        
        .category-item {
            margin-bottom: 0.5rem;
        }
        
        .category-item:last-child {
            margin-bottom: 0;
        }
        
        .form-section {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid #dee2e6;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            color: #495057;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .required {
            color: #dc3545;
        }
        
        .btn-loading {
            position: relative;
            pointer-events: none;
        }
        
        .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div>Cargando datos...</div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Seguimientos</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Registrar Asuntos Individuales
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-person-exclamation me-2"></i>
                    Registrar Asuntos Individuales
                </h1>
                <p class="text-muted">
                    Registra asuntos relacionados con estudiantes específicos para seguimiento y gestión académica.
                </p>
            </div>
        </div>

        <!-- Mensajes -->
        <div id="alert-container"></div>

        <!-- Formulario principal -->
        <form id="individual-issues-form" novalidate>
            <!-- Sección 1: Selección de Estudiante -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="bi bi-person-search me-2"></i>
                    Estudiante <span class="required">*</span>
                </h5>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="student-search-container">
                            <label for="student-search" class="form-label">Buscar estudiante</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="student-search" 
                                   placeholder="Escriba el nombre del estudiante para buscar..."
                                   autocomplete="off"
                                   required>
                            <div id="suggestions-dropdown" class="suggestions-dropdown" style="display: none;">
                                <!-- Las sugerencias se cargan aquí -->
                            </div>
                            <div class="form-text">
                                Escriba al menos 2 caracteres para comenzar la búsqueda
                            </div>
                            <input type="hidden" id="selected-student-id" name="student_id">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <label class="form-label">Foto del estudiante</label>
                            <div>
                                <img id="student-photo" 
                                     class="student-photo" 
                                     src="" 
                                     alt="Foto del estudiante" 
                                     style="display: none;">
                                <div id="no-photo-message" class="text-muted small" style="display: none;">
                                    <i class="bi bi-person-circle display-4"></i>
                                    <div>Sin foto disponible</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección 2: Descripción del Asunto -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="bi bi-journal-text me-2"></i>
                    Descripción del Asunto <span class="required">*</span>
                </h5>
                
                <div class="mb-3">
                    <label for="issue-description" class="form-label">Descripción detallada</label>
                    <textarea id="issue-description" 
                              name="topic_description" 
                              class="form-control"
                              rows="8"
                              placeholder="Describa detalladamente el asunto relacionado con el estudiante..."
                              required></textarea>
                    <div class="form-text">
                        Proporcione una descripción clara y detallada del asunto para facilitar el seguimiento.
                    </div>
                </div>
            </div>

            <!-- Sección 3: Categorías -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="bi bi-tags me-2"></i>
                    Categorías <span class="required">*</span>
                </h5>
                
                <div class="mb-3">
                    <label class="form-label">Seleccione las categorías que aplican</label>
                    <div id="categories-container" class="categories-container">
                        <!-- Las categorías se cargan aquí dinámicamente -->
                        <div class="text-center text-muted">
                            <i class="bi bi-arrow-clockwise me-2"></i>
                            Cargando categorías...
                        </div>
                    </div>
                    <div class="form-text">
                        Debe seleccionar al menos una categoría para clasificar el asunto.
                    </div>
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="row">
                <div class="col-12">
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" 
                                class="btn btn-outline-secondary" 
                                id="clear-form-btn">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Limpiar Formulario
                        </button>
                        <button type="submit" 
                                class="btn btn-primary" 
                                id="submit-btn">
                            <i class="bi bi-check-circle me-1"></i>
                            Registrar Asunto
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // Variables globales de la aplicación
        let appData = {
            selectedStudent: null,
            searchTimeout: null,
            categories: [],
            isSubmitting: false,
            tinymceEditor: null
        };

        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Validar acceso con permisos
                const hasAccess = await validatePageAccess('Registrar asuntos individuales');
                if (!hasAccess) return;

                // Inicializar página
                initializePage('individualIssues', 'Seguimientos');
                
                // Configurar eventos
                setupEventListeners();
                
                // Cargar datos iniciales
                await loadInitialData();
                
            } catch (error) {
                console.error('Error inicializando página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
            }
        });

        async function loadInitialData() {
            showLoading();
            
            try {
                // Cargar categorías
                await loadCategories();
                
                // Inicializar TinyMCE
                await initializeTinyMCE();
                
                showMessage('Formulario cargado correctamente. Puede comenzar a registrar asuntos.', 'success');
                
                // Focus en campo de búsqueda
                document.getElementById('student-search').focus();
                
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
                showMessage('Error al cargar los datos: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        async function loadCategories() {
            try {
                const categories = await supabaseRequest('/stm_category?select=category_id,category_name&order=category_name');
                
                appData.categories = categories || [];
                renderCategories();
                
            } catch (error) {
                console.error('Error cargando categorías:', error);
                throw new Error('No se pudieron cargar las categorías');
            }
        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            
            if (!appData.categories || appData.categories.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No se encontraron categorías disponibles
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            appData.categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-item';
                categoryDiv.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input" 
                               type="checkbox" 
                               value="${category.category_id}" 
                               id="category_${category.category_id}"
                               name="categories">
                        <label class="form-check-label" for="category_${category.category_id}">
                            ${category.category_name}
                        </label>
                    </div>
                `;
                container.appendChild(categoryDiv);
            });
        }

        async function initializeTinyMCE() {
            return new Promise((resolve, reject) => {
                tinymce.init({
                    selector: '#issue-description',
                    height: 300,
                    menubar: false,
                    plugins: [
                        'lists', 'link', 'charmap', 'preview', 'searchreplace', 'wordcount'
                    ],
                    toolbar: 'undo redo | formatselect | bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent | link | removeformat',
                    content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }',
                    placeholder: 'Escriba aquí la descripción detallada del asunto...',
                    setup: function(editor) {
                        appData.tinymceEditor = editor;
                        editor.on('init', function() {
                            resolve();
                        });
                        editor.on('change', function() {
                            // Trigger change para validación si es necesario
                        });
                    }
                });
            });
        }

        // Event handlers
        function setupEventListeners() {
            // Búsqueda de estudiantes
            const searchInput = document.getElementById('student-search');
            searchInput.addEventListener('input', handleStudentSearch);
            searchInput.addEventListener('keydown', handleSearchKeyboard);
            
            // Formulario
            document.getElementById('individual-issues-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('clear-form-btn').addEventListener('click', handleClearForm);
            
            // Cerrar sugerencias al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.student-search-container')) {
                    hideSuggestions();
                }
            });
            
            // Prevenir pérdida de datos
            window.addEventListener('beforeunload', function(e) {
                if (hasFormData() && !appData.isSubmitting) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        }

        function handleStudentSearch(e) {
            const searchTerm = e.target.value.trim();
            
            // Limpiar selección anterior
            clearStudentSelection();
            
            // Limpiar timeout anterior
            if (appData.searchTimeout) {
                clearTimeout(appData.searchTimeout);
            }
            
            if (searchTerm.length < 2) {
                hideSuggestions();
                return;
            }
            
            // Mostrar loading en sugerencias
            showSuggestionsLoading();
            
            // Buscar con debounce
            appData.searchTimeout = setTimeout(() => {
                searchStudents(searchTerm);
            }, 500);
        }

        async function searchStudents(searchTerm) {
            try {
                const likeParam = `%${searchTerm.toLowerCase()}%`;
                
                // Obtener status activo dinámicamente
                const activeStatusId = await getActiveStudentStatusId();
                
                // Construir query - simplificada para evitar errores
                let query = '/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2';
                
                // Solo agregar filtro de status si se obtuvo correctamente
                if (activeStatusId) {
                    query += `&status_id=eq.${activeStatusId}`;
                }
                
                // Usar OR simple sin encoding problemático
                query += `&or=(student_first_name.ilike.${likeParam},student_last_name_1.ilike.${likeParam},student_last_name_2.ilike.${likeParam})&order=student_first_name,student_last_name_1&limit=15`;
                
                const students = await supabaseRequest(query);
                
                showStudentSuggestions(students || []);
                
            } catch (error) {
                console.error('Error al buscar estudiantes:', error);
                showSuggestionsError('Error al buscar estudiantes');
            }
        }

        async function getActiveStudentStatusId() {
            try {
                // Consulta simplificada - obtener el primer status disponible
                const statuses = await supabaseRequest('/student_status?select=status_id&order=status_id&limit=1');
                
                if (statuses && statuses.length > 0) {
                    return statuses[0].status_id;
                }
                
                return null;
                
            } catch (error) {
                console.error('Error obteniendo status activo:', error);
                // Si falla, buscar sin filtro de status
                return null;
            }
        }

        function showStudentSuggestions(students) {
            const dropdown = document.getElementById('suggestions-dropdown');
            
            if (!students || students.length === 0) {
                dropdown.innerHTML = `
                    <div class="suggestion-item text-muted">
                        <i class="bi bi-search me-2"></i>
                        No se encontraron estudiantes
                    </div>
                `;
                dropdown.style.display = 'block';
                
                setTimeout(() => {
                    hideSuggestions();
                }, 2000);
                return;
            }
            
            dropdown.innerHTML = '';
            
            students.forEach(student => {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'suggestion-item';
                
                const fullName = `${student.student_first_name} ${student.student_last_name_1} ${student.student_last_name_2 || ''}`.trim();
                
                suggestionDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${fullName}</strong>
                            ${student.student_code ? `<small class="text-muted d-block">Código: ${student.student_code}</small>` : ''}
                        </div>
                        <i class="bi bi-arrow-return-left text-muted"></i>
                    </div>
                `;
                
                suggestionDiv.addEventListener('click', () => {
                    selectStudent(student, fullName);
                });
                
                dropdown.appendChild(suggestionDiv);
            });
            
            dropdown.style.display = 'block';
        }

        function showSuggestionsLoading() {
            const dropdown = document.getElementById('suggestions-dropdown');
            dropdown.innerHTML = `
                <div class="suggestion-item">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Buscando...</span>
                        </div>
                        Buscando estudiantes...
                    </div>
                </div>
            `;
            dropdown.style.display = 'block';
        }

        function showSuggestionsError(message) {
            const dropdown = document.getElementById('suggestions-dropdown');
            dropdown.innerHTML = `
                <div class="suggestion-item text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
            dropdown.style.display = 'block';
            
            setTimeout(() => {
                hideSuggestions();
            }, 3000);
        }

        async function selectStudent(student, fullName) {
            try {
                appData.selectedStudent = student;
                
                // Actualizar campo de búsqueda
                document.getElementById('student-search').value = fullName;
                document.getElementById('selected-student-id').value = student.student_id;
                
                // Ocultar sugerencias
                hideSuggestions();
                
                // Cargar foto del estudiante
                await loadStudentPhoto(student.student_code);
                
                // Limpiar mensajes de error
                clearMessages();
                
            } catch (error) {
                console.error('Error al seleccionar estudiante:', error);
                showMessage('Error al cargar datos del estudiante', 'warning');
            }
        }

        async function loadStudentPhoto(studentCode) {
            const photoImg = document.getElementById('student-photo');
            const noPhotoMessage = document.getElementById('no-photo-message');
            
            // Ocultar ambos elementos inicialmente
            photoImg.style.display = 'none';
            noPhotoMessage.style.display = 'none';
            
            if (!studentCode) {
                noPhotoMessage.style.display = 'block';
                return;
            }
            
            try {
                const photoUrl = await getStudentPhotoUrl(studentCode);
                
                if (photoUrl) {
                    photoImg.onload = function() {
                        photoImg.style.display = 'block';
                        noPhotoMessage.style.display = 'none';
                    };
                    
                    photoImg.onerror = function() {
                        photoImg.style.display = 'none';
                        noPhotoMessage.style.display = 'block';
                    };
                    
                    photoImg.src = photoUrl;
                } else {
                    noPhotoMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Error al cargar foto:', error);
                noPhotoMessage.style.display = 'block';
            }
        }

        function handleSearchKeyboard(e) {
            const dropdown = document.getElementById('suggestions-dropdown');
            const suggestions = dropdown.querySelectorAll('.suggestion-item');
            
            if (suggestions.length === 0) return;
            
            let selectedIndex = -1;
            
            // Encontrar elemento seleccionado actual
            suggestions.forEach((item, index) => {
                if (item.classList.contains('active')) {
                    selectedIndex = index;
                }
            });
            
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedIndex >= 0) {
                        suggestions[selectedIndex].click();
                    }
                    return;
                case 'Escape':
                    e.preventDefault();
                    hideSuggestions();
                    return;
                default:
                    return;
            }
            
            // Actualizar selección visual
            suggestions.forEach((item, index) => {
                item.classList.toggle('active', index === selectedIndex);
            });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            // Prevenir doble envío
            if (appData.isSubmitting) {
                showMessage('El formulario ya se está procesando, por favor espere...', 'warning');
                return;
            }
            
            try {
                // Validar formulario
                const validation = validateForm();
                if (!validation.isValid) {
                    showMessage(validation.message, 'danger');
                    if (validation.focusElement) {
                        validation.focusElement.focus();
                    }
                    return;
                }
                
                // Preparar datos
                const formData = prepareFormData();
                
                // Cambiar estado del formulario
                setFormSubmitting(true);
                
                // Enviar datos
                await submitForm(formData);
                
            } catch (error) {
                console.error('Error al enviar formulario:', error);
                showMessage('Error al registrar el asunto: ' + error.message, 'danger');
                setFormSubmitting(false);
            }
        }

        function validateForm() {
            // Validar estudiante seleccionado
            if (!appData.selectedStudent || !appData.selectedStudent.student_id) {
                return {
                    isValid: false,
                    message: 'Por favor, seleccione un estudiante válido de la lista de sugerencias.',
                    focusElement: document.getElementById('student-search')
                };
            }
            
            // Validar descripción
            const description = appData.tinymceEditor ? appData.tinymceEditor.getContent().trim() : '';
            if (!description || description === '<p></p>' || description === '<p><br></p>') {
                return {
                    isValid: false,
                    message: 'La descripción del asunto es obligatoria.',
                    focusElement: null // TinyMCE no tiene focus directo
                };
            }
            
            // Validar longitud mínima de descripción
            const textContent = appData.tinymceEditor ? appData.tinymceEditor.getContent({format: 'text'}).trim() : '';
            if (textContent.length < 10) {
                return {
                    isValid: false,
                    message: 'La descripción debe tener al menos 10 caracteres.',
                    focusElement: null
                };
            }
            
            // Validar categorías seleccionadas
            const selectedCategories = document.querySelectorAll('input[name="categories"]:checked');
            if (selectedCategories.length === 0) {
                return {
                    isValid: false,
                    message: 'Debe seleccionar al menos una categoría.',
                    focusElement: document.querySelector('input[name="categories"]')
                };
            }
            
            return { isValid: true };
        }

        function prepareFormData() {
            // Obtener categorías seleccionadas
            const selectedCategories = [];
            const categoryCheckboxes = document.querySelectorAll('input[name="categories"]:checked');
            categoryCheckboxes.forEach(checkbox => {
                selectedCategories.push(parseInt(checkbox.value));
            });
            
            // Obtener descripción del editor TinyMCE
            const description = appData.tinymceEditor ? appData.tinymceEditor.getContent() : '';
            
            return {
                student_id: appData.selectedStudent.student_id,
                topic_description: description,
                categories: selectedCategories
            };
        }

        async function submitForm(formData) {
            try {
                showMessage('Registrando asunto, por favor espere...', 'info');
                
                // 1. Insertar registro principal
                const topicId = await insertStudentTopic(formData);
                
                // 2. Insertar categorías
                await insertTopicCategories(topicId, formData.categories);
                
                // 3. Enviar notificación por correo
                await sendNotificationEmail(formData.student_id, formData.topic_description);
                
                // 4. Mostrar éxito y limpiar formulario
                showMessage(`Asunto registrado exitosamente (ID: ${topicId}). Se ha enviado notificación por correo.`, 'success');
                clearForm();
                
                setFormSubmitting(false);
                
            } catch (error) {
                console.error('Error al enviar formulario:', error);
                setFormSubmitting(false);
                throw error;
            }
        }

        async function insertStudentTopic(formData) {
            try {
                // Obtener el siguiente ID disponible
                const maxIdResult = await supabaseRequest('/stm_students_topics?select=topic_id&order=topic_id.desc&limit=1');
                const nextTopicId = maxIdResult.length > 0 ? maxIdResult[0].topic_id + 1 : 1;
                
                // Obtener email del usuario actual
                const session = getStoredSession();
                const userEmail = session?.user?.user_mail || '';
                
                // Preparar datos para inserción
                const insertData = {
                    topic_id: nextTopicId,
                    student_id: formData.student_id,
                    topic_date: new Date().toISOString().split('T')[0],
                    topic_description: formData.topic_description,
                    email: userEmail,
                    is_escalable: 'SI',
                    is_open: 'SI'
                };
                
                // Insertar registro
                const result = await supabaseRequest('/stm_students_topics', {
                    method: 'POST',
                    body: JSON.stringify(insertData)
                });
                
                if (!result || result.length === 0) {
                    throw new Error('No se pudo insertar el registro principal');
                }
                
                return nextTopicId;
                
            } catch (error) {
                console.error('Error al insertar registro principal:', error);
                throw new Error('Error al guardar el asunto: ' + error.message);
            }
        }

        async function insertTopicCategories(topicId, categoryIds) {
            try {
                const insertPromises = categoryIds.map(categoryId => {
                    return supabaseRequest('/stm_students_topics_categories', {
                        method: 'POST',
                        body: JSON.stringify({
                            topic_id: topicId,
                            category_id: categoryId
                        })
                    });
                });
                
                const results = await Promise.all(insertPromises);
                
                // Verificar que todas las inserciones fueron exitosas
                const successfulInserts = results.filter(result => result && result.length > 0);
                if (successfulInserts.length !== categoryIds.length) {
                    throw new Error(`Solo se insertaron ${successfulInserts.length} de ${categoryIds.length} categorías`);
                }
                
            } catch (error) {
                console.error('Error al insertar categorías:', error);
                throw new Error('Error al asociar categorías: ' + error.message);
            }
        }

        async function sendNotificationEmail(studentId, topicDescription) {
            try {
                // Obtener datos del estudiante y directores
                const studentData = await getStudentAndDirectorsData(studentId);
                
                if (!studentData) {
                    console.warn('No se pudieron obtener datos del estudiante para notificación');
                    return;
                }
                
                // Preparar contenido del correo
                const emailSubject = 'SchoolNet - Nuevo asunto registrado para estudiante de su curso';
                const emailContent = generateEmailContent(studentData, topicDescription);
                
                // Enviar correo al director de curso
                if (studentData.course_director_email) {
                    await sendNotification(
                        studentData.course_director_email,
                        emailSubject,
                        emailContent,
                        true
                    );
                }
                
                // Enviar copia al director de sección si es diferente
                if (studentData.section_director_email && 
                    studentData.section_director_email !== studentData.course_director_email) {
                    await sendNotification(
                        studentData.section_director_email,
                        emailSubject,
                        emailContent,
                        true
                    );
                }
                
            } catch (error) {
                console.error('Error al enviar notificación:', error);
            }
        }

        async function getStudentAndDirectorsData(studentId) {
            try {
                // Primera consulta: datos básicos del estudiante
                const studentQuery = `/students?select=student_first_name,student_last_name_1,student_last_name_2,course_id&student_id=eq.${studentId}`;
                const studentResult = await supabaseRequest(studentQuery);
                
                if (!studentResult || studentResult.length === 0) {
                    return null;
                }
                
                const student = studentResult[0];
                
                if (!student.course_id) {
                    return {
                        student_first_name: student.student_first_name,
                        student_last_name_1: student.student_last_name_1,
                        student_last_name_2: student.student_last_name_2 || '',
                        course_director_email: null,
                        section_director_email: null
                    };
                }
                
                // Segunda consulta: datos del curso
                const courseQuery = `/courses?select=course_director_email,grade_id&course_id=eq.${student.course_id}`;
                const courseResult = await supabaseRequest(courseQuery);
                
                let courseDirectorEmail = null;
                let sectionDirectorEmail = null;
                
                if (courseResult && courseResult.length > 0) {
                    courseDirectorEmail = courseResult[0].course_director_email;
                    
                    // Tercera consulta: director de sección
                    if (courseResult[0].grade_id) {
                        const gradeQuery = `/grades?select=section_id&grade_id=eq.${courseResult[0].grade_id}`;
                        const gradeResult = await supabaseRequest(gradeQuery);
                        
                        if (gradeResult && gradeResult.length > 0 && gradeResult[0].section_id) {
                            const sectionQuery = `/sections?select=director_email&section_id=eq.${gradeResult[0].section_id}`;
                            const sectionResult = await supabaseRequest(sectionQuery);
                            
                            if (sectionResult && sectionResult.length > 0) {
                                sectionDirectorEmail = sectionResult[0].director_email;
                            }
                        }
                    }
                }
                
                return {
                    student_first_name: student.student_first_name,
                    student_last_name_1: student.student_last_name_1,
                    student_last_name_2: student.student_last_name_2 || '',
                    course_director_email: courseDirectorEmail,
                    section_director_email: sectionDirectorEmail
                };
                
            } catch (error) {
                console.error('Error al obtener datos del estudiante:', error);
                return null;
            }
        }

        function generateEmailContent(studentData, topicDescription) {
            const studentFullName = `${studentData.student_first_name} ${studentData.student_last_name_1} ${studentData.student_last_name_2}`.trim();
            
            return `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
                    <div style="background-color: #0d6efd; color: white; padding: 20px; border-radius: 8px 8px 0 0; text-align: center;">
                        <h2 style="margin: 0; font-size: 24px;">SchoolNet</h2>
                        <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Sistema de Gestión Educativa</p>
                    </div>
                    
                    <div style="background-color: white; padding: 25px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="color: #495057; margin-top: 0; margin-bottom: 20px;">
                            Nuevo Asunto Registrado
                        </h3>
                        
                        <p style="margin-bottom: 15px; color: #6c757d;">
                            Se ha registrado un nuevo asunto relacionado con un estudiante de su curso:
                        </p>
                        
                        <div style="background-color: #e7f3ff; border-left: 4px solid #0d6efd; padding: 15px; margin: 20px 0;">
                            <p style="margin: 0; font-weight: bold; color: #0d6efd; font-size: 16px;">
                                Estudiante: ${studentFullName}
                            </p>
                        </div>
                        
                        <div style="background-color: #f8f9fa; border-radius: 6px; padding: 20px; margin: 20px 0;">
                            <h4 style="color: #495057; margin-top: 0; margin-bottom: 15px; font-size: 16px;">
                                Descripción del Asunto:
                            </h4>
                            <div style="color: #212529; line-height: 1.6;">
                                ${topicDescription}
                            </div>
                        </div>
                        
                        <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0;">
                            <p style="margin: 0; color: #856404; font-size: 14px;">
                                <strong>Recordatorio:</strong> Este asunto requiere su atención y seguimiento. 
                                Puede gestionar este y otros asuntos desde el sistema SchoolNet.
                            </p>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                            <p style="color: #6c757d; font-size: 12px; margin: 0;">
                                Este correo es generado automáticamente por SchoolNet.<br>
                                Por favor, no responder a este mensaje.
                            </p>
                            <p style="color: #6c757d; font-size: 12px; margin: 5px 0 0 0;">
                                <strong>Colegio Tilata</strong> - Sistema de Gestión Educativa
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function handleClearForm() {
            if (hasFormData()) {
                if (confirm('¿Está seguro que desea limpiar el formulario? Se perderán todos los datos ingresados.')) {
                    clearForm();
                }
            } else {
                clearForm();
            }
        }

        function clearForm() {
            // Limpiar búsqueda de estudiantes
            document.getElementById('student-search').value = '';
            clearStudentSelection();
            hideSuggestions();
            
            // Limpiar descripción TinyMCE
            if (appData.tinymceEditor) {
                appData.tinymceEditor.setContent('');
            }
            
            // Limpiar categorías
            const categoryCheckboxes = document.querySelectorAll('input[name="categories"]');
            categoryCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Limpiar mensajes
            clearMessages();
            
            // Focus en búsqueda
            document.getElementById('student-search').focus();
            
            showMessage('Formulario limpiado correctamente', 'info');
        }

        function clearStudentSelection() {
            appData.selectedStudent = null;
            document.getElementById('selected-student-id').value = '';
            document.getElementById('student-photo').style.display = 'none';
            document.getElementById('no-photo-message').style.display = 'none';
        }

        function hideSuggestions() {
            document.getElementById('suggestions-dropdown').style.display = 'none';
        }

        function hasFormData() {
            const searchValue = document.getElementById('student-search').value.trim();
            const descriptionValue = appData.tinymceEditor ? appData.tinymceEditor.getContent().trim() : '';
            const selectedCategories = document.querySelectorAll('input[name="categories"]:checked');
            
            return searchValue || descriptionValue || selectedCategories.length > 0;
        }

        function setFormSubmitting(submitting) {
            appData.isSubmitting = submitting;
            
            const submitBtn = document.getElementById('submit-btn');
            const clearBtn = document.getElementById('clear-form-btn');
            const searchInput = document.getElementById('student-search');
            const categoryCheckboxes = document.querySelectorAll('input[name="categories"]');
            
            // Deshabilitar/habilitar elementos
            submitBtn.disabled = submitting;
            clearBtn.disabled = submitting;
            searchInput.disabled = submitting;
            categoryCheckboxes.forEach(checkbox => {
                checkbox.disabled = submitting;
            });
            
            // Deshabilitar/habilitar TinyMCE
            if (appData.tinymceEditor) {
                appData.tinymceEditor.mode.set(submitting ? 'readonly' : 'design');
            }
            
            // Cambiar apariencia del botón
            if (submitting) {
                submitBtn.innerHTML = `
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    Registrando...
                `;
                submitBtn.classList.add('btn-loading');
            } else {
                submitBtn.innerHTML = `
                    <i class="bi bi-check-circle me-1"></i>
                    Registrar Asunto
                `;
                submitBtn.classList.remove('btn-loading');
            }
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showMessage(message, type) {
            const container = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="bi bi-${type === 'danger' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.appendChild(alertDiv);
            
            // Auto-remove success and info messages
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function clearMessages() {
            const container = document.getElementById('alert-container');
            container.innerHTML = '';
        }

        // Log de inicialización
        console.log('SchoolNet - Registrar Asuntos Individuales inicializado correctamente');
    </script>
</body>
</html>
