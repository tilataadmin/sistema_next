<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Asuntos Individuales - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- TinyMCE -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    
    <style>
        /* Estilos específicos para el formulario */
        .student-search-container {
            position: relative;
        }
        
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .student-photo {
            max-width: 120px;
            max-height: 120px;
            border-radius: 0.375rem;
            border: 2px solid #dee2e6;
            object-fit: cover;
        }
        
        .categories-container {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.75rem;
            background-color: #f8f9fa;
        }
        
        .category-item {
            margin-bottom: 0.5rem;
        }
        
        .category-item:last-child {
            margin-bottom: 0;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            min-width: 200px;
        }
        
        .spinner-border-custom {
            width: 3rem;
            height: 3rem;
        }
        
        /* Protección contra doble clic */
        .btn-loading {
            position: relative;
            pointer-events: none;
        }
        
        .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mejoras visuales */
        .form-section {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid #dee2e6;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            color: #495057;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .required {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-border text-primary spinner-border-custom" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div class="mt-2">Cargando datos...</div>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="../follow-ups/index.html">Seguimientos</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Registrar Asuntos Individuales
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-person-exclamation me-2"></i>
                    Registrar Asuntos Individuales
                </h1>
                <p class="text-muted">
                    Registra asuntos relacionados con estudiantes específicos para seguimiento y gestión académica.
                </p>
            </div>
        </div>

        <!-- Mensajes de sistema -->
        <div id="messageContainer" class="mb-3" style="display: none;">
            <!-- Los mensajes se insertan aquí dinámicamente -->
        </div>

        <!-- Formulario principal -->
        <form id="individualIssuesForm" novalidate>
            <!-- Sección 1: Selección de Estudiante -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="bi bi-person-search me-2"></i>
                    Estudiante <span class="required">*</span>
                </h5>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="student-search-container">
                            <label for="studentSearch" class="form-label">Buscar estudiante</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="studentSearch" 
                                   placeholder="Escriba el nombre del estudiante para buscar..."
                                   autocomplete="off"
                                   required>
                            <div id="suggestionsDropdown" class="suggestions-dropdown" style="display: none;">
                                <!-- Las sugerencias se cargan aquí -->
                            </div>
                            <div class="form-text">
                                Escriba al menos 2 caracteres para comenzar la búsqueda
                            </div>
                            <input type="hidden" id="selectedStudentId" name="student_id">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <label class="form-label">Foto del estudiante</label>
                            <div>
                                <img id="studentPhoto" 
                                     class="student-photo" 
                                     src="" 
                                     alt="Foto del estudiante" 
                                     style="display: none;">
                                <div id="noPhotoMessage" class="text-muted small" style="display: none;">
                                    <i class="bi bi-person-circle display-4"></i>
                                    <div>Sin foto disponible</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección 2: Descripción del Asunto -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="bi bi-journal-text me-2"></i>
                    Descripción del Asunto <span class="required">*</span>
                </h5>
                
                <div class="mb-3">
                    <label for="issueDescription" class="form-label">Descripción detallada</label>
                    <textarea id="issueDescription" 
                              name="topic_description" 
                              class="form-control"
                              rows="8"
                              placeholder="Describa detalladamente el asunto relacionado con el estudiante..."
                              required></textarea>
                    <div class="form-text">
                        Proporcione una descripción clara y detallada del asunto para facilitar el seguimiento.
                    </div>
                </div>
            </div>

            <!-- Sección 3: Categorías -->
            <div class="form-section">
                <h5 class="section-title">
                    <i class="bi bi-tags me-2"></i>
                    Categorías <span class="required">*</span>
                </h5>
                
                <div class="mb-3">
                    <label class="form-label">Seleccione las categorías que aplican</label>
                    <div id="categoriesContainer" class="categories-container">
                        <!-- Las categorías se cargan aquí dinámicamente -->
                        <div class="text-center text-muted">
                            <i class="bi bi-arrow-clockwise me-2"></i>
                            Cargando categorías...
                        </div>
                    </div>
                    <div class="form-text">
                        Debe seleccionar al menos una categoría para clasificar el asunto.
                    </div>
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="row">
                <div class="col-12">
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" 
                                class="btn btn-outline-secondary" 
                                id="clearFormBtn">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Limpiar Formulario
                        </button>
                        <button type="submit" 
                                class="btn btn-primary" 
                                id="submitBtn">
                            <i class="bi bi-check-circle me-1"></i>
                            Registrar Asunto
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Config.js del sistema -->
    <script src="../../assets/js/config.js"></script>
    
    <!-- JavaScript específico de la página -->
    <script>
        // Variables globales
        let selectedStudent = null;
        let searchTimeout = null;
        let categories = [];
        let tinymceEditor = null;
        
        // Configuración inicial
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });
    </script>
</body>
</html>

// ===== JAVASCRIPT PARTE 1: INICIALIZACIÓN Y BÚSQUEDA =====
// Agregar este código al final del HTML, reemplazando el script básico existente

<script>
// ===== VARIABLES GLOBALES =====
let selectedStudent = null;
let searchTimeout = null;
let categories = [];
let tinymceEditor = null;
let isFormSubmitting = false;

// ===== CONFIGURACIÓN INICIAL =====
document.addEventListener('DOMContentLoaded', function() {
    initializePage();
});

// ===== FUNCIÓN DE INICIALIZACIÓN PRINCIPAL =====
async function initializePage() {
    try {
        showLoadingOverlay(true);
        
        // 1. Validar permisos de acceso
        const hasAccess = await validatePageAccess('Registrar asuntos individuales');
        if (!hasAccess) {
            return; // validatePageAccess maneja la redirección
        }
        
        // 2. Inicializar componentes
        await initializeComponents();
        
        // 3. Cargar datos iniciales
        await loadInitialData();
        
        // 4. Configurar event listeners
        setupEventListeners();
        
        showLoadingOverlay(false);
        showMessage('Formulario cargado correctamente. Puede comenzar a registrar asuntos.', 'success');
        
        // Focus en el campo de búsqueda
        document.getElementById('studentSearch').focus();
        
    } catch (error) {
        console.error('Error al inicializar la página:', error);
        showLoadingOverlay(false);
        showMessage('Error al cargar el formulario: ' + error.message, 'danger');
    }
}

// ===== INICIALIZACIÓN DE COMPONENTES =====
async function initializeComponents() {
    // Inicializar TinyMCE
    await initializeTinyMCE();
}

// ===== INICIALIZAR TINYMCE =====
async function initializeTinyMCE() {
    return new Promise((resolve, reject) => {
        tinymce.init({
            selector: '#issueDescription',
            height: 300,
            menubar: false,
            plugins: [
                'lists', 'link', 'charmap', 'preview', 'searchreplace', 'wordcount'
            ],
            toolbar: 'undo redo | formatselect | bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent | link | removeformat',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }',
            placeholder: 'Escriba aquí la descripción detallada del asunto...',
            setup: function(editor) {
                tinymceEditor = editor;
                editor.on('init', function() {
                    resolve();
                });
            }
        });
    });
}

// ===== CARGA DE DATOS INICIALES =====
async function loadInitialData() {
    try {
        // Cargar categorías
        await loadCategories();
        
    } catch (error) {
        throw new Error('Error al cargar datos iniciales: ' + error.message);
    }
}

// ===== CARGAR CATEGORÍAS =====
async function loadCategories() {
    try {
        const data = await supabaseRequest('/stm_category?select=category_id,category_name&order=category_name');
        
        categories = data || [];
        renderCategories();
        
    } catch (error) {
        console.error('Error al cargar categorías:', error);
        throw new Error('No se pudieron cargar las categorías');
    }
}

// ===== RENDERIZAR CATEGORÍAS =====
function renderCategories() {
    const container = document.getElementById('categoriesContainer');
    
    if (!categories || categories.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="bi bi-exclamation-triangle me-2"></i>
                No se encontraron categorías disponibles
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    categories.forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category-item';
        categoryDiv.innerHTML = `
            <div class="form-check">
                <input class="form-check-input" 
                       type="checkbox" 
                       value="${category.category_id}" 
                       id="category_${category.category_id}"
                       name="categories">
                <label class="form-check-label" for="category_${category.category_id}">
                    ${category.category_name}
                </label>
            </div>
        `;
        container.appendChild(categoryDiv);
    });
}

// ===== CONFIGURAR EVENT LISTENERS =====
function setupEventListeners() {
    // Búsqueda de estudiantes
    setupStudentSearch();
    
    // Botones del formulario
    setupFormButtons();
    
    // Cerrar sugerencias al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.student-search-container')) {
            hideSuggestions();
        }
    });
    
    // Prevenir pérdida de datos
    window.addEventListener('beforeunload', function(e) {
        if (hasFormData() && !isFormSubmitting) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
}

// ===== CONFIGURAR BÚSQUEDA DE ESTUDIANTES =====
function setupStudentSearch() {
    const searchInput = document.getElementById('studentSearch');
    
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.trim();
        
        // Limpiar selección anterior
        clearStudentSelection();
        
        // Limpiar timeout anterior
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        if (searchTerm.length < 2) {
            hideSuggestions();
            return;
        }
        
        // Mostrar loading en sugerencias
        showSuggestionsLoading();
        
        // Buscar con debounce
        searchTimeout = setTimeout(() => {
            searchStudents(searchTerm);
        }, 500);
    });
    
    // Navegación con teclado en sugerencias
    searchInput.addEventListener('keydown', function(e) {
        handleSuggestionsKeyboard(e);
    });
}

// ===== BUSCAR ESTUDIANTES =====
async function searchStudents(searchTerm) {
    try {
        const likeParam = `%${searchTerm.toLowerCase()}%`;
        
        const query = `/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2&status_id=eq.${getActiveStatusId()}&or=(student_first_name.ilike.${encodeURIComponent(likeParam)},student_last_name_1.ilike.${encodeURIComponent(likeParam)},student_last_name_2.ilike.${encodeURIComponent(likeParam)})&order=student_first_name,student_last_name_1&limit=15`;
        
        const students = await supabaseRequest(query);
        
        showStudentSuggestions(students || []);
        
    } catch (error) {
        console.error('Error al buscar estudiantes:', error);
        showSuggestionsError('Error al buscar estudiantes');
    }
}

// ===== OBTENER ID DE STATUS ACTIVO =====
function getActiveStatusId() {
    // Basado en el schema, necesitamos obtener el status_id para estudiantes activos
    // Por ahora usamos un valor por defecto, pero idealmente debería consultarse
    return 1; // Asumir que 1 es "activo" basado en el código GAS
}

// ===== MOSTRAR SUGERENCIAS DE ESTUDIANTES =====
function showStudentSuggestions(students) {
    const dropdown = document.getElementById('suggestionsDropdown');
    
    if (!students || students.length === 0) {
        dropdown.innerHTML = `
            <div class="suggestion-item text-muted">
                <i class="bi bi-search me-2"></i>
                No se encontraron estudiantes
            </div>
        `;
        dropdown.style.display = 'block';
        
        setTimeout(() => {
            hideSuggestions();
        }, 2000);
        return;
    }
    
    dropdown.innerHTML = '';
    
    students.forEach(student => {
        const suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'suggestion-item';
        
        const fullName = `${student.student_first_name} ${student.student_last_name_1} ${student.student_last_name_2 || ''}`.trim();
        
        suggestionDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${fullName}</strong>
                    ${student.student_code ? `<small class="text-muted d-block">Código: ${student.student_code}</small>` : ''}
                </div>
                <i class="bi bi-arrow-return-left text-muted"></i>
            </div>
        `;
        
        suggestionDiv.addEventListener('click', () => {
            selectStudent(student, fullName);
        });
        
        dropdown.appendChild(suggestionDiv);
    });
    
    dropdown.style.display = 'block';
}

// ===== MOSTRAR LOADING EN SUGERENCIAS =====
function showSuggestionsLoading() {
    const dropdown = document.getElementById('suggestionsDropdown');
    dropdown.innerHTML = `
        <div class="suggestion-item">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Buscando...</span>
                </div>
                Buscando estudiantes...
            </div>
        </div>
    `;
    dropdown.style.display = 'block';
}

// ===== MOSTRAR ERROR EN SUGERENCIAS =====
function showSuggestionsError(message) {
    const dropdown = document.getElementById('suggestionsDropdown');
    dropdown.innerHTML = `
        <div class="suggestion-item text-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
    dropdown.style.display = 'block';
    
    setTimeout(() => {
        hideSuggestions();
    }, 3000);
}

// ===== SELECCIONAR ESTUDIANTE =====
async function selectStudent(student, fullName) {
    try {
        selectedStudent = student;
        
        // Actualizar campo de búsqueda
        document.getElementById('studentSearch').value = fullName;
        document.getElementById('selectedStudentId').value = student.student_id;
        
        // Ocultar sugerencias
        hideSuggestions();
        
        // Cargar foto del estudiante
        await loadStudentPhoto(student.student_code);
        
        // Limpiar mensajes de error
        clearMessages();
        
    } catch (error) {
        console.error('Error al seleccionar estudiante:', error);
        showMessage('Error al cargar datos del estudiante', 'warning');
    }
}

// ===== CARGAR FOTO DEL ESTUDIANTE =====
async function loadStudentPhoto(studentCode) {
    const photoImg = document.getElementById('studentPhoto');
    const noPhotoMessage = document.getElementById('noPhotoMessage');
    
    // Ocultar ambos elementos inicialmente
    photoImg.style.display = 'none';
    noPhotoMessage.style.display = 'none';
    
    if (!studentCode) {
        noPhotoMessage.style.display = 'block';
        return;
    }
    
    try {
        const photoUrl = await getStudentPhotoUrl(studentCode);
        
        if (photoUrl) {
            photoImg.onload = function() {
                photoImg.style.display = 'block';
                noPhotoMessage.style.display = 'none';
            };
            
            photoImg.onerror = function() {
                photoImg.style.display = 'none';
                noPhotoMessage.style.display = 'block';
            };
            
            photoImg.src = photoUrl;
        } else {
            noPhotoMessage.style.display = 'block';
        }
    } catch (error) {
        console.error('Error al cargar foto:', error);
        noPhotoMessage.style.display = 'block';
    }
}

// ===== LIMPIAR SELECCIÓN DE ESTUDIANTE =====
function clearStudentSelection() {
    selectedStudent = null;
    document.getElementById('selectedStudentId').value = '';
    document.getElementById('studentPhoto').style.display = 'none';
    document.getElementById('noPhotoMessage').style.display = 'none';
}

// ===== OCULTAR SUGERENCIAS =====
function hideSuggestions() {
    document.getElementById('suggestionsDropdown').style.display = 'none';
}

// ===== NAVEGACIÓN CON TECLADO =====
function handleSuggestionsKeyboard(e) {
    const dropdown = document.getElementById('suggestionsDropdown');
    const suggestions = dropdown.querySelectorAll('.suggestion-item');
    
    if (suggestions.length === 0) return;
    
    let selectedIndex = -1;
    
    // Encontrar elemento seleccionado actual
    suggestions.forEach((item, index) => {
        if (item.classList.contains('active')) {
            selectedIndex = index;
        }
    });
    
    switch (e.key) {
        case 'ArrowDown':
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
            break;
        case 'ArrowUp':
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            break;
        case 'Enter':
            e.preventDefault();
            if (selectedIndex >= 0) {
                suggestions[selectedIndex].click();
            }
            return;
        case 'Escape':
            e.preventDefault();
            hideSuggestions();
            return;
        default:
            return;
    }
    
    // Actualizar selección visual
    suggestions.forEach((item, index) => {
        item.classList.toggle('active', index === selectedIndex);
        if (index === selectedIndex) {
            item.style.backgroundColor = '#f8f9fa';
        } else {
            item.style.backgroundColor = '';
        }
    });
}

// ===== CONFIGURAR BOTONES DEL FORMULARIO =====
function setupFormButtons() {
    // Botón limpiar
    document.getElementById('clearFormBtn').addEventListener('click', function() {
        if (hasFormData()) {
            if (confirm('¿Está seguro que desea limpiar el formulario? Se perderán todos los datos ingresados.')) {
                clearForm();
            }
        } else {
            clearForm();
        }
    });
}

// ===== VERIFICAR SI HAY DATOS EN EL FORMULARIO =====
function hasFormData() {
    const searchValue = document.getElementById('studentSearch').value.trim();
    const descriptionValue = tinymceEditor ? tinymceEditor.getContent().trim() : '';
    const selectedCategories = document.querySelectorAll('input[name="categories"]:checked');
    
    return searchValue || descriptionValue || selectedCategories.length > 0;
}

// ===== LIMPIAR FORMULARIO =====
function clearForm() {
    // Limpiar búsqueda de estudiantes
    document.getElementById('studentSearch').value = '';
    clearStudentSelection();
    hideSuggestions();
    
    // Limpiar editor TinyMCE
    if (tinymceEditor) {
        tinymceEditor.setContent('');
    }
    
    // Limpiar categorías
    const categoryCheckboxes = document.querySelectorAll('input[name="categories"]');
    categoryCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Limpiar mensajes
    clearMessages();
    
    // Focus en búsqueda
    document.getElementById('studentSearch').focus();
    
    showMessage('Formulario limpiado correctamente', 'info');
}

// ===== FUNCIONES DE UTILIDAD =====

// Mostrar/ocultar loading overlay
function showLoadingOverlay(show) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = show ? 'flex' : 'none';
}

// Mostrar mensajes
function showMessage(message, type = 'info') {
    const container = document.getElementById('messageContainer');
    const alertClass = `alert-${type === 'danger' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'}`;
    
    container.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="bi bi-${type === 'danger' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    container.style.display = 'block';
    
    // Auto-ocultar mensajes de éxito e info
    if (type === 'success' || type === 'info') {
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000);
    }
}

// Limpiar mensajes
function clearMessages() {
    const container = document.getElementById('messageContainer');
    container.innerHTML = '';
    container.style.display = 'none';
}
</script>
// ===== JAVASCRIPT PARTE 2: VALIDACIÓN Y ENVÍO =====
// Agregar este código después del JavaScript Parte 1

// ===== CONTINUAR CONFIGURACIÓN DE EVENT LISTENERS =====
// Agregar esta función al final de setupEventListeners()
function setupFormButtons() {
    // Botón limpiar (ya implementado en Parte 1)
    document.getElementById('clearFormBtn').addEventListener('click', function() {
        if (hasFormData()) {
            if (confirm('¿Está seguro que desea limpiar el formulario? Se perderán todos los datos ingresados.')) {
                clearForm();
            }
        } else {
            clearForm();
        }
    });
    
    // Botón enviar formulario
    document.getElementById('individualIssuesForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleFormSubmit();
    });
}

// ===== MANEJO DE ENVÍO DEL FORMULARIO =====
async function handleFormSubmit() {
    // Prevenir doble envío
    if (isFormSubmitting) {
        showMessage('El formulario ya se está procesando, por favor espere...', 'warning');
        return;
    }
    
    try {
        // Validar formulario
        const validation = validateForm();
        if (!validation.isValid) {
            showMessage(validation.message, 'danger');
            if (validation.focusElement) {
                validation.focusElement.focus();
            }
            return;
        }
        
        // Preparar datos
        const formData = prepareFormData();
        
        // Cambiar estado del formulario
        setFormSubmitting(true);
        
        // Enviar datos
        await submitForm(formData);
        
    } catch (error) {
        console.error('Error al enviar formulario:', error);
        showMessage('Error al registrar el asunto: ' + error.message, 'danger');
        setFormSubmitting(false);
    }
}

// ===== VALIDACIÓN DEL FORMULARIO =====
function validateForm() {
    // Validar estudiante seleccionado
    if (!selectedStudent || !selectedStudent.student_id) {
        return {
            isValid: false,
            message: 'Por favor, seleccione un estudiante válido de la lista de sugerencias.',
            focusElement: document.getElementById('studentSearch')
        };
    }
    
    // Validar descripción
    const description = tinymceEditor ? tinymceEditor.getContent().trim() : '';
    if (!description || description === '<p></p>' || description === '<p><br></p>') {
        return {
            isValid: false,
            message: 'La descripción del asunto es obligatoria.',
            focusElement: null // TinyMCE no tiene focus directo
        };
    }
    
    // Validar longitud mínima de descripción
    const textContent = tinymceEditor ? tinymceEditor.getContent({format: 'text'}).trim() : '';
    if (textContent.length < 10) {
        return {
            isValid: false,
            message: 'La descripción debe tener al menos 10 caracteres.',
            focusElement: null
        };
    }
    
    // Validar categorías seleccionadas
    const selectedCategories = document.querySelectorAll('input[name="categories"]:checked');
    if (selectedCategories.length === 0) {
        return {
            isValid: false,
            message: 'Debe seleccionar al menos una categoría.',
            focusElement: document.querySelector('input[name="categories"]')
        };
    }
    
    return { isValid: true };
}

// ===== PREPARAR DATOS DEL FORMULARIO =====
function prepareFormData() {
    // Obtener categorías seleccionadas
    const selectedCategories = [];
    const categoryCheckboxes = document.querySelectorAll('input[name="categories"]:checked');
    categoryCheckboxes.forEach(checkbox => {
        selectedCategories.push(parseInt(checkbox.value));
    });
    
    // Obtener descripción del editor
    const description = tinymceEditor.getContent();
    
    return {
        student_id: selectedStudent.student_id,
        topic_description: description,
        categories: selectedCategories
    };
}

// ===== ENVIAR FORMULARIO =====
async function submitForm(formData) {
    try {
        showMessage('Registrando asunto, por favor espere...', 'info');
        
        // 1. Insertar registro principal
        const topicId = await insertStudentTopic(formData);
        
        // 2. Insertar categorías
        await insertTopicCategories(topicId, formData.categories);
        
        // 3. Enviar notificación por correo
        await sendNotificationEmail(formData.student_id, formData.topic_description);
        
        // 4. Mostrar éxito y limpiar formulario
        showMessage(`Asunto registrado exitosamente (ID: ${topicId}). Se ha enviado notificación por correo.`, 'success');
        clearForm();
        
        setFormSubmitting(false);
        
    } catch (error) {
        console.error('Error al enviar formulario:', error);
        setFormSubmitting(false);
        throw error;
    }
}

// ===== INSERTAR REGISTRO PRINCIPAL =====
async function insertStudentTopic(formData) {
    try {
        // Obtener el siguiente ID disponible
        const maxIdResult = await supabaseRequest('/stm_students_topics?select=topic_id&order=topic_id.desc&limit=1');
        const nextTopicId = maxIdResult.length > 0 ? maxIdResult[0].topic_id + 1 : 1;
        
        // Obtener email del usuario actual
        const session = getStoredSession();
        const userEmail = session?.user?.user_mail || '';
        
        // Preparar datos para inserción
        const insertData = {
            topic_id: nextTopicId,
            student_id: formData.student_id,
            topic_date: new Date().toISOString().split('T')[0], // Fecha actual en formato YYYY-MM-DD
            topic_description: formData.topic_description,
            email: userEmail,
            is_escalable: 'SI',
            is_open: 'SI'
        };
        
        // Insertar registro
        const result = await supabaseRequest('/stm_students_topics', {
            method: 'POST',
            body: JSON.stringify(insertData)
        });
        
        if (!result || result.length === 0) {
            throw new Error('No se pudo insertar el registro principal');
        }
        
        return nextTopicId;
        
    } catch (error) {
        console.error('Error al insertar registro principal:', error);
        throw new Error('Error al guardar el asunto: ' + error.message);
    }
}

// ===== INSERTAR CATEGORÍAS DEL TOPIC =====
async function insertTopicCategories(topicId, categoryIds) {
    try {
        const insertPromises = categoryIds.map(categoryId => {
            return supabaseRequest('/stm_students_topics_categories', {
                method: 'POST',
                body: JSON.stringify({
                    topic_id: topicId,
                    category_id: categoryId
                })
            });
        });
        
        const results = await Promise.all(insertPromises);
        
        // Verificar que todas las inserciones fueron exitosas
        const successfulInserts = results.filter(result => result && result.length > 0);
        if (successfulInserts.length !== categoryIds.length) {
            throw new Error(`Solo se insertaron ${successfulInserts.length} de ${categoryIds.length} categorías`);
        }
        
    } catch (error) {
        console.error('Error al insertar categorías:', error);
        throw new Error('Error al asociar categorías: ' + error.message);
    }
}

// ===== ENVIAR NOTIFICACIÓN POR CORREO =====
async function sendNotificationEmail(studentId, topicDescription) {
    try {
        // Obtener datos del estudiante y directores
        const studentData = await getStudentAndDirectorsData(studentId);
        
        if (!studentData) {
            console.warn('No se pudieron obtener datos del estudiante para notificación');
            return;
        }
        
        // Preparar contenido del correo
        const emailSubject = 'SchoolNet - Nuevo asunto registrado para estudiante de su curso';
        const emailContent = generateEmailContent(studentData, topicDescription);
        
        // Enviar correo al director de curso
        if (studentData.course_director_email) {
            await sendNotification(
                studentData.course_director_email,
                emailSubject,
                emailContent,
                true // silent = true
            );
        }
        
        // Enviar copia al director de sección si es diferente
        if (studentData.section_director_email && 
            studentData.section_director_email !== studentData.course_director_email) {
            await sendNotification(
                studentData.section_director_email,
                emailSubject,
                emailContent,
                true // silent = true
            );
        }
        
    } catch (error) {
        console.error('Error al enviar notificación:', error);
        // No lanzar error para no interrumpir el flujo principal
        console.warn('El asunto se registró correctamente pero no se pudo enviar la notificación por correo');
    }
}

// ===== OBTENER DATOS DEL ESTUDIANTE Y DIRECTORES =====
async function getStudentAndDirectorsData(studentId) {
    try {
        const query = `/students?select=student_first_name,student_last_name_1,student_last_name_2,courses(course_director_email,grades(sections(director_email)))&student_id=eq.${studentId}`;
        
        const result = await supabaseRequest(query);
        
        if (!result || result.length === 0) {
            return null;
        }
        
        const student = result[0];
        
        return {
            student_first_name: student.student_first_name,
            student_last_name_1: student.student_last_name_1,
            student_last_name_2: student.student_last_name_2 || '',
            course_director_email: student.courses?.course_director_email,
            section_director_email: student.courses?.grades?.sections?.director_email
        };
        
    } catch (error) {
        console.error('Error al obtener datos del estudiante:', error);
        return null;
    }
}

// ===== GENERAR CONTENIDO DEL CORREO =====
function generateEmailContent(studentData, topicDescription) {
    const studentFullName = `${studentData.student_first_name} ${studentData.student_last_name_1} ${studentData.student_last_name_2}`.trim();
    
    return `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
            <div style="background-color: #0d6efd; color: white; padding: 20px; border-radius: 8px 8px 0 0; text-align: center;">
                <h2 style="margin: 0; font-size: 24px;">SchoolNet</h2>
                <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Sistema de Gestión Educativa</p>
            </div>
            
            <div style="background-color: white; padding: 25px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="color: #495057; margin-top: 0; margin-bottom: 20px;">
                    🔔 Nuevo Asunto Registrado
                </h3>
                
                <p style="margin-bottom: 15px; color: #6c757d;">
                    Se ha registrado un nuevo asunto relacionado con un estudiante de su curso:
                </p>
                
                <div style="background-color: #e7f3ff; border-left: 4px solid #0d6efd; padding: 15px; margin: 20px 0;">
                    <p style="margin: 0; font-weight: bold; color: #0d6efd; font-size: 16px;">
                        📚 Estudiante: ${studentFullName}
                    </p>
                </div>
                
                <div style="background-color: #f8f9fa; border-radius: 6px; padding: 20px; margin: 20px 0;">
                    <h4 style="color: #495057; margin-top: 0; margin-bottom: 15px; font-size: 16px;">
                        📝 Descripción del Asunto:
                    </h4>
                    <div style="color: #212529; line-height: 1.6;">
                        ${topicDescription}
                    </div>
                </div>
                
                <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0;">
                    <p style="margin: 0; color: #856404; font-size: 14px;">
                        <strong>💡 Recordatorio:</strong> Este asunto requiere su atención y seguimiento. 
                        Puede gestionar este y otros asuntos desde el sistema SchoolNet.
                    </p>
                </div>
                
                <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                    <p style="color: #6c757d; font-size: 12px; margin: 0;">
                        Este correo es generado automáticamente por SchoolNet.<br>
                        Por favor, no responder a este mensaje.
                    </p>
                    <p style="color: #6c757d; font-size: 12px; margin: 5px 0 0 0;">
                        <strong>Colegio Tilata</strong> - Sistema de Gestión Educativa
                    </p>
                </div>
            </div>
        </div>
    `;
}

// ===== CONTROLAR ESTADO DE ENVÍO =====
function setFormSubmitting(submitting) {
    isFormSubmitting = submitting;
    
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearFormBtn');
    const searchInput = document.getElementById('studentSearch');
    const categoryCheckboxes = document.querySelectorAll('input[name="categories"]');
    
    // Deshabilitar/habilitar elementos
    submitBtn.disabled = submitting;
    clearBtn.disabled = submitting;
    searchInput.disabled = submitting;
    categoryCheckboxes.forEach(checkbox => {
        checkbox.disabled = submitting;
    });
    
    // Deshabilitar/habilitar TinyMCE
    if (tinymceEditor) {
        tinymceEditor.mode.set(submitting ? 'readonly' : 'design');
    }
    
    // Cambiar apariencia del botón
    if (submitting) {
        submitBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Registrando...
        `;
        submitBtn.classList.add('btn-loading');
    } else {
        submitBtn.innerHTML = `
            <i class="bi bi-check-circle me-1"></i>
            Registrar Asunto
        `;
        submitBtn.classList.remove('btn-loading');
    }
}

// ===== FUNCIÓN PARA DEBUGGING (SOLO EN DESARROLLO) =====
if (window.location.hostname.includes('localhost') || window.location.hostname.includes('vercel')) {
    window.debugIndividualIssues = function() {
        console.log('=== DEBUG INDIVIDUAL ISSUES ===');
        console.log('Selected Student:', selectedStudent);
        console.log('Categories:', categories);
        console.log('Form Data:', hasFormData() ? prepareFormData() : 'No data');
        console.log('TinyMCE Content:', tinymceEditor ? tinymceEditor.getContent() : 'Not initialized');
        console.log('Is Submitting:', isFormSubmitting);
    };
}

      // ===== JAVASCRIPT PARTE 3: FUNCIONES COMPLEMENTARIAS Y FINALIZACIÓN =====
// Agregar este código después del JavaScript Parte 2

// ===== FUNCIONES DE UTILIDAD MEJORADAS =====

// Función mejorada para obtener status activo de estudiantes
async function getActiveStudentStatusId() {
    try {
        // Consultar el status activo desde la tabla student_status
        const statusQuery = '/student_status?select=status_id&status_description=eq.Activo&limit=1';
        const statusResult = await supabaseRequest(statusQuery);
        
        if (statusResult && statusResult.length > 0) {
            return statusResult[0].status_id;
        }
        
        // Fallback: intentar con código 1 si no se encuentra "Activo"
        const fallbackQuery = '/student_status?select=status_id&status_code=eq.1&limit=1';
        const fallbackResult = await supabaseRequest(fallbackQuery);
        
        if (fallbackResult && fallbackResult.length > 0) {
            return fallbackResult[0].status_id;
        }
        
        // Último fallback: usar el primer status disponible
        const anyStatusQuery = '/student_status?select=status_id&limit=1';
        const anyStatusResult = await supabaseRequest(anyStatusQuery);
        
        return anyStatusResult && anyStatusResult.length > 0 ? anyStatusResult[0].status_id : null;
        
    } catch (error) {
        console.error('Error al obtener status activo:', error);
        return null; // Retornar null para manejar en la búsqueda
    }
}

// Función mejorada de búsqueda de estudiantes con status dinámico
async function searchStudents(searchTerm) {
    try {
        // Obtener el status activo dinámicamente
        const activeStatusId = await getActiveStudentStatusId();
        
        const likeParam = `%${searchTerm.toLowerCase()}%`;
        
        // Construir query con o sin filtro de status
        let query = '/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2';
        
        if (activeStatusId) {
            query += `&status_id=eq.${activeStatusId}`;
        }
        
        query += `&or=(student_first_name.ilike.${encodeURIComponent(likeParam)},student_last_name_1.ilike.${encodeURIComponent(likeParam)},student_last_name_2.ilike.${encodeURIComponent(likeParam)})&order=student_first_name,student_last_name_1&limit=15`;
        
        const students = await supabaseRequest(query);
        
        showStudentSuggestions(students || []);
        
    } catch (error) {
        console.error('Error al buscar estudiantes:', error);
        showSuggestionsError('Error al buscar estudiantes');
    }
}

// Función mejorada para obtener datos del estudiante y directores
async function getStudentAndDirectorsData(studentId) {
    try {
        // Primera consulta: datos básicos del estudiante
        const studentQuery = `/students?select=student_first_name,student_last_name_1,student_last_name_2,course_id&student_id=eq.${studentId}`;
        const studentResult = await supabaseRequest(studentQuery);
        
        if (!studentResult || studentResult.length === 0) {
            return null;
        }
        
        const student = studentResult[0];
        
        if (!student.course_id) {
            return {
                student_first_name: student.student_first_name,
                student_last_name_1: student.student_last_name_1,
                student_last_name_2: student.student_last_name_2 || '',
                course_director_email: null,
                section_director_email: null
            };
        }
        
        // Segunda consulta: datos del curso y directores
        const courseQuery = `/courses?select=course_director_email,grades(sections(director_email))&course_id=eq.${student.course_id}`;
        const courseResult = await supabaseRequest(courseQuery);
        
        const courseData = courseResult && courseResult.length > 0 ? courseResult[0] : null;
        
        return {
            student_first_name: student.student_first_name,
            student_last_name_1: student.student_last_name_1,
            student_last_name_2: student.student_last_name_2 || '',
            course_director_email: courseData?.course_director_email || null,
            section_director_email: courseData?.grades?.sections?.director_email || null
        };
        
    } catch (error) {
        console.error('Error al obtener datos del estudiante:', error);
        return null;
    }
}

// ===== FUNCIONES DE ACCESIBILIDAD Y UX =====

// Configurar atajos de teclado
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Ctrl + S para guardar (simular envío)
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            if (!isFormSubmitting && hasFormData()) {
                handleFormSubmit();
            }
        }
        
        // Ctrl + L para limpiar formulario
        if (e.ctrlKey && e.key === 'l') {
            e.preventDefault();
            if (!isFormSubmitting) {
                document.getElementById('clearFormBtn').click();
            }
        }
        
        // Escape para limpiar sugerencias
        if (e.key === 'Escape') {
            hideSuggestions();
            clearMessages();
        }
        
        // F1 para ayuda
        if (e.key === 'F1') {
            e.preventDefault();
            showHelp();
        }
    });
}

// Mostrar ayuda contextual
function showHelp() {
    const helpContent = `
        <div class="modal fade" id="helpModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-question-circle me-2"></i>
                            Ayuda - Registrar Asuntos Individuales
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h6><i class="bi bi-person-search me-2"></i>Búsqueda de Estudiantes</h6>
                        <ul>
                            <li>Escriba al menos 2 caracteres para iniciar la búsqueda</li>
                            <li>Use las flechas ↑↓ para navegar entre sugerencias</li>
                            <li>Presione Enter para seleccionar o haga clic</li>
                            <li>La foto del estudiante se carga automáticamente si está disponible</li>
                        </ul>
                        
                        <h6 class="mt-3"><i class="bi bi-journal-text me-2"></i>Descripción del Asunto</h6>
                        <ul>
                            <li>Use el editor de texto enriquecido para formatear la descripción</li>
                            <li>Proporcione detalles específicos y relevantes</li>
                            <li>Mínimo 10 caracteres requeridos</li>
                        </ul>
                        
                        <h6 class="mt-3"><i class="bi bi-tags me-2"></i>Categorías</h6>
                        <ul>
                            <li>Seleccione todas las categorías que apliquen al asunto</li>
                            <li>Debe seleccionar al menos una categoría</li>
                            <li>Las categorías ayudan en el seguimiento y análisis</li>
                        </ul>
                        
                        <h6 class="mt-3"><i class="bi bi-keyboard me-2"></i>Atajos de Teclado</h6>
                        <ul>
                            <li><kbd>Ctrl + S</kbd> - Registrar asunto</li>
                            <li><kbd>Ctrl + L</kbd> - Limpiar formulario</li>
                            <li><kbd>Escape</kbd> - Cerrar sugerencias/mensajes</li>
                            <li><kbd>F1</kbd> - Mostrar esta ayuda</li>
                        </ul>
                        
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Importante:</strong> Al registrar un asunto, se enviará automáticamente una notificación por correo al director del curso y al director de sección correspondiente.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al DOM si no existe
    let existingModal = document.getElementById('helpModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', helpContent);
    
    // Mostrar modal
    const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
    helpModal.show();
}

// ===== FUNCIONES DE VALIDACIÓN MEJORADAS =====

// Validar email
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// Validar conexión a internet
async function checkConnectivity() {
    try {
        // Intentar una consulta simple a Supabase
        await supabaseRequest('/stm_category?select=category_id&limit=1');
        return true;
    } catch (error) {
        return false;
    }
}

// Mostrar estado de conectividad
async function showConnectivityStatus() {
    const isOnline = await checkConnectivity();
    
    if (!isOnline) {
        showMessage('Sin conexión a internet. Verifique su conexión antes de continuar.', 'warning');
        return false;
    }
    
    return true;
}

// ===== FUNCIONES DE RESPALDO Y RECUPERACIÓN =====

// Guardar borrador en localStorage
function saveDraft() {
    if (!hasFormData()) return;
    
    const draftData = {
        timestamp: Date.now(),
        selectedStudent: selectedStudent,
        description: tinymceEditor ? tinymceEditor.getContent() : '',
        categories: Array.from(document.querySelectorAll('input[name="categories"]:checked')).map(cb => cb.value)
    };
    
    try {
        localStorage.setItem('individualIssuesDraft', JSON.stringify(draftData));
    } catch (error) {
        console.error('Error al guardar borrador:', error);
    }
}

// Cargar borrador desde localStorage
function loadDraft() {
    try {
        const draftData = localStorage.getItem('individualIssuesDraft');
        if (!draftData) return false;
        
        const draft = JSON.parse(draftData);
        
        // Verificar que el borrador no sea muy antiguo (24 horas)
        const maxAge = 24 * 60 * 60 * 1000; // 24 horas en ms
        if (Date.now() - draft.timestamp > maxAge) {
            localStorage.removeItem('individualIssuesDraft');
            return false;
        }
        
        // Confirmar con el usuario
        if (!confirm('Se encontró un borrador guardado. ¿Desea recuperarlo?')) {
            localStorage.removeItem('individualIssuesDraft');
            return false;
        }
        
        // Restaurar datos
        if (draft.selectedStudent) {
            selectedStudent = draft.selectedStudent;
            const fullName = `${selectedStudent.student_first_name} ${selectedStudent.student_last_name_1} ${selectedStudent.student_last_name_2 || ''}`.trim();
            document.getElementById('studentSearch').value = fullName;
            document.getElementById('selectedStudentId').value = selectedStudent.student_id;
            loadStudentPhoto(selectedStudent.student_code);
        }
        
        if (draft.description && tinymceEditor) {
            tinymceEditor.setContent(draft.description);
        }
        
        if (draft.categories && draft.categories.length > 0) {
            draft.categories.forEach(categoryId => {
                const checkbox = document.querySelector(`input[name="categories"][value="${categoryId}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }
        
        showMessage('Borrador recuperado exitosamente.', 'info');
        localStorage.removeItem('individualIssuesDraft');
        return true;
        
    } catch (error) {
        console.error('Error al cargar borrador:', error);
        localStorage.removeItem('individualIssuesDraft');
        return false;
    }
}

// Autoguardar borrador cada 30 segundos
function setupAutoSave() {
    setInterval(() => {
        if (hasFormData() && !isFormSubmitting) {
            saveDraft();
        }
    }, 30000); // 30 segundos
}

// ===== CONFIGURACIÓN FINAL =====

// Actualizar la función de inicialización para incluir nuevas características
async function initializePage() {
    try {
        showLoadingOverlay(true);
        
        // 1. Validar permisos de acceso
        const hasAccess = await validatePageAccess('Registrar asuntos individuales');
        if (!hasAccess) {
            return;
        }
        
        // 2. Verificar conectividad
        const isConnected = await showConnectivityStatus();
        if (!isConnected) {
            showLoadingOverlay(false);
            return;
        }
        
        // 3. Inicializar componentes
        await initializeComponents();
        
        // 4. Cargar datos iniciales
        await loadInitialData();
        
        // 5. Configurar event listeners
        setupEventListeners();
        
        // 6. Configurar funciones adicionales
        setupKeyboardShortcuts();
        setupAutoSave();
        
        // 7. Intentar cargar borrador
        loadDraft();
        
        showLoadingOverlay(false);
        showMessage('Formulario cargado correctamente. Presione F1 para ver la ayuda.', 'success');
        
        // Focus en el campo de búsqueda
        document.getElementById('studentSearch').focus();
        
    } catch (error) {
        console.error('Error al inicializar la página:', error);
        showLoadingOverlay(false);
        showMessage('Error al cargar el formulario: ' + error.message, 'danger');
    }
}

// ===== LIMPIEZA AL SALIR =====
window.addEventListener('beforeunload', function(e) {
    // Guardar borrador si hay datos
    if (hasFormData() && !isFormSubmitting) {
        saveDraft();
    }
    
    // Mostrar advertencia si hay datos no guardados
    if (hasFormData() && !isFormSubmitting) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// ===== FUNCIONES GLOBALES PARA DEBUGGING =====
if (window.location.hostname.includes('localhost') || window.location.hostname.includes('vercel')) {
    // Función de debug mejorada
    window.debugIndividualIssues = function() {
        console.log('=== DEBUG INDIVIDUAL ISSUES ===');
        console.log('Selected Student:', selectedStudent);
        console.log('Categories Available:', categories.length);
        console.log('Categories Selected:', document.querySelectorAll('input[name="categories"]:checked').length);
        console.log('Form Has Data:', hasFormData());
        console.log('Is Submitting:', isFormSubmitting);
        console.log('TinyMCE Ready:', !!tinymceEditor);
        console.log('Draft in Storage:', !!localStorage.getItem('individualIssuesDraft'));
        
        if (hasFormData()) {
            console.log('Form Data:', prepareFormData());
        }
    };
    
    // Función para limpiar storage de desarrollo
    window.clearIndividualIssuesStorage = function() {
        localStorage.removeItem('individualIssuesDraft');
        console.log('Storage limpiado');
    };
    
    // Función para simular desconexión
    window.testConnectivity = function() {
        checkConnectivity().then(result => {
            console.log('Connectivity test:', result ? 'ONLINE' : 'OFFLINE');
        });
    };
}

// ===== MENSAJE DE INICIALIZACIÓN COMPLETA =====
console.log('🎓 SchoolNet - Registrar Asuntos Individuales inicializado correctamente');
console.log('📋 Funcionalidades disponibles:');
console.log('   • Búsqueda inteligente de estudiantes');
console.log('   • Editor de texto enriquecido');
console.log('   • Sistema de notificaciones por correo');
console.log('   • Autoguardado de borradores');
console.log('   • Atajos de teclado (F1 para ayuda)');
console.log('   • Validación robusta de formularios');

// FIN DEL SCRIPT
