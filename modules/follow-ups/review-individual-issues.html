<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revisar Asuntos Individuales - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Estilos específicos para la revisión de asuntos */
        .student-photo {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            transition: transform 0.2s;
        }
        
        .student-photo:hover {
            transform: scale(1.1);
            border-color: #1b365d;
        }
        
        .student-photo.error-loading {
            display: none;
        }
        
        .student-name {
            font-weight: 600;
            color: #1b365d;
        }
        
        .topic-description {
            max-width: 300px;
            max-height: 100px;
            overflow-y: auto;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.4;
            border: 1px solid #e9ecef;
        }
        
        .topic-description:hover {
            background-color: #e9ecef;
        }
        
        .escalable-select {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .escalable-select:focus {
            outline: none;
            border-color: #1380e2;
            box-shadow: 0 0 0 2px rgba(19, 128, 226, 0.1);
        }
        
        .escalable-select[data-loading="true"] {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .escalable-si {
            color: #155724;
            background-color: #d4edda;
        }
        
        .escalable-no {
            color: #721c24;
            background-color: #f8d7da;
        }
        
        .update-status {
            margin-left: 8px;
            font-size: 12px;
            font-weight: 500;
            transition: opacity 0.3s;
        }
        
        .update-status.success {
            color: #28a745;
        }
        
        .update-status.error {
            color: #dc3545;
        }
        
        .update-status.loading {
            color: #6c757d;
        }
        
        /* Estadísticas */
        .stats-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid #dee2e6;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stats-card.total {
            background: linear-gradient(135deg, #1b365d 0%, #2c5aa0 100%);
            color: white;
        }
        
        .stats-card.escalable {
            background: linear-gradient(135deg, #ffc107 0%, #ffcd39 100%);
            color: #212529;
        }
        
        .stats-card.no-escalable {
            background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);
            color: white;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .stats-label {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            opacity: 0.9;
        }
        
        /* Tabla responsiva */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table th {
            background-color: #1b365d;
            color: white;
            font-weight: 600;
            border: none;
            padding: 1rem 0.75rem;
            font-size: 0.9rem;
        }
        
        .table td {
            padding: 1rem 0.75rem;
            vertical-align: middle;
            border-bottom: 1px solid #e9ecef;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Mensaje sin asuntos */
        .no-topics-message {
            text-align: center;
            padding: 3rem 2rem;
            color: #6c757d;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .no-topics-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Loading states */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            text-align: center;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1b365d;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .table-loading {
            text-align: center;
            padding: 2rem;
            color: #1b365d;
            font-weight: 600;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .table-loading.hidden {
            display: none;
        }
      /* Categorías badge */
        .categories-badge {
            background-color: #e7f3ff;
            color: #0066cc;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #b3d9ff;
        }
        
        /* Filtros rápidos */
        .filter-buttons {
            margin-bottom: 1.5rem;
        }
        
        .filter-btn {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .filter-btn.active {
            background-color: #1b365d;
            border-color: #1b365d;
            color: white;
        }
        
        /* Reportante info */
        .reporter-info {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* Fecha styling */
        .topic-date {
            font-size: 0.9rem;
            color: #495057;
            font-weight: 500;
        }
        
        /* Notificaciones temporales */
        .temp-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            min-width: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats-card {
                margin-bottom: 1rem;
            }
            
            .topic-description {
                max-width: 200px;
                font-size: 13px;
            }
            
            .student-photo {
                width: 40px;
                height: 40px;
            }
            
            .table th,
            .table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }
            
            .escalable-select {
                width: 70px;
                font-size: 13px;
            }
            
            .temp-notification {
                left: 10px;
                right: 10px;
                min-width: auto;
            }
        }
        
        @media (max-width: 576px) {
            .container-fluid {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            .topic-description {
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando asuntos individuales...</p>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">
                        <i class="bi bi-clipboard-check me-1"></i>Seguimientos
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Revisar Asuntos Individuales
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-person-check me-2"></i>
                    Revisar Asuntos Individuales
                </h1>
                <p class="text-muted">
                    Revise y gestione los asuntos individuales reportados para los estudiantes de sus cursos
                </p>
            </div>
            <div class="col-auto">
                <button type="button" id="btn-refrescar" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-clockwise me-2"></i>Refrescar
                </button>
            </div>
        </div>

        <!-- Mensajes -->
        <div id="mensaje-container" class="mb-3" style="display: none;"></div>

        <!-- Estadísticas -->
        <div id="stats-container" class="row mb-4" style="display: none;">
            <div class="col-md-3 mb-3">
                <div class="stats-card total" onclick="filtrarAsuntos('todos')" title="Ver todos los asuntos">
                    <span class="stats-number" id="total-topics">0</span>
                    <div class="stats-label">
                        <i class="bi bi-list-ul me-1"></i>Total Asuntos
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card escalable" onclick="filtrarAsuntos('escalables')" title="Filtrar asuntos escalables">
                    <span class="stats-number" id="escalable-topics">0</span>
                    <div class="stats-label">
                        <i class="bi bi-arrow-up-circle me-1"></i>Escalables
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card no-escalable" onclick="filtrarAsuntos('no-escalables')" title="Filtrar asuntos no escalables">
                    <span class="stats-number" id="no-escalable-topics">0</span>
                    <div class="stats-label">
                        <i class="bi bi-check-circle me-1"></i>No Escalables
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #6f42c1 0%, #8a63d2 100%); color: white;" onclick="filtrarAsuntos('recientes')" title="Ordenar por más recientes">
                    <span class="stats-number">
                        <i class="bi bi-clock-history"></i>
                    </span>
                    <div class="stats-label">
                        <i class="bi bi-calendar-event me-1"></i>Recientes
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros rápidos -->
        <div id="filter-container" class="filter-buttons" style="display: none;">
            <button type="button" class="btn btn-outline-secondary filter-btn active" data-filter="todos">
                <i class="bi bi-list me-1"></i>Todos
            </button>
            <button type="button" class="btn btn-outline-warning filter-btn" data-filter="escalables">
                <i class="bi bi-arrow-up-circle me-1"></i>Escalables
            </button>
            <button type="button" class="btn btn-outline-success filter-btn" data-filter="no-escalables">
                <i class="bi bi-check-circle me-1"></i>No Escalables
            </button>
            <button type="button" class="btn btn-outline-info filter-btn" data-filter="recientes">
                <i class="bi bi-clock me-1"></i>Más Recientes
            </button>
        </div>

        <!-- Loading de tabla -->
        <div id="table-loading" class="table-loading hidden">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            Actualizando datos...
        </div>

        <!-- Contenedor de asuntos -->
        <div id="topics-container">
            <!-- El contenido se carga dinámicamente aquí -->
        </div>
    </div>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // === VARIABLES GLOBALES ===
        let datosGlobales = {
            encabezado: {},
            topics: [],
            topicsOriginales: [], // Para filtros
            configUrlPhotos: '',
            usuarioActual: null
        };

        let filtroActual = 'todos';
        let actualizandoEscalable = false;

        // === INICIALIZACIÓN ===
        document.addEventListener('DOMContentLoaded', function() {
            initializePage('reviewIndividualIssues', 'Seguimientos');
            inicializarElementos();
            inicializarEventListeners();
            validarPermisos();
        });

        /**
         * Validar permisos de acceso a la página
         */
        async function validarPermisos() {
            try {
                const tieneAcceso = await validatePageAccess('Revisar asuntos individuales');
                if (tieneAcceso) {
                    cargarDatosIniciales();
                } else {
                    // validatePageAccess ya maneja la redirección/bloqueo
                    return;
                }
            } catch (error) {
                console.error('Error validando permisos:', error);
                mostrarNotificacion('Error al validar permisos de acceso', 'error');
            }
        }

        /**
         * Inicializar referencias a elementos DOM
         */
        function inicializarElementos() {
            // Ya están definidos en el HTML con IDs específicos
        }

        /**
         * Inicializar event listeners
         */
        function inicializarEventListeners() {
            // Botón refrescar
            document.getElementById('btn-refrescar').addEventListener('click', refrescarDatos);

            // Filtros rápidos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filtro = this.dataset.filter;
                    filtrarAsuntos(filtro);
                    actualizarBotonFiltroActivo(this);
                });
            });

            // Atajos de teclado
            document.addEventListener('keydown', manejarAtajosTeclado);
        }

        /**
         * Carga datos iniciales del servidor
         */
        function cargarDatosIniciales() {
            mostrarLoading();
            
            const session = getStoredSession();
            if (!session || !session.user) {
                ocultarLoading();
                mostrarNotificacion('No se pudo identificar al usuario actual', 'error');
                return;
            }

            datosGlobales.usuarioActual = session.user;

            // Timeout de seguridad
            const timeoutId = setTimeout(() => {
                ocultarLoading();
                mostrarNotificacion('La carga está tomando más tiempo del esperado. Intente refrescar.', 'warning');
            }, 20000);

            // Obtener datos del backend
            obtenerDatosAsuntos()
                .then(datos => {
                    clearTimeout(timeoutId);
                    procesarDatosIniciales(datos);
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    ocultarLoading();
                    console.error('Error cargando datos:', error);
                    mostrarNotificacion('Error al cargar datos: ' + error.message, 'error');
                });
        }

        /**
         * Obtener datos de asuntos desde Supabase
         */
        async function obtenerDatosAsuntos() {
            try {
                const session = getStoredSession();
                const userEmail = session.user.user_mail;

                // Consulta adaptada para Supabase
                const query = `/stm_students_topics?select=topic_id,student_id,topic_date,topic_description,email,is_escalable,students(student_code,student_first_name,student_last_name_1,courses(course_director_email)),workers(worker_first_name,worker_last_name_1),stm_students_topics_categories(stm_category(category_name))&students.courses.course_director_email=eq.${userEmail}&is_open=eq.SI&order=topic_date.desc&limit=150`;

                const topics = await supabaseRequest(query);

                // Obtener URL de fotos desde configuración
                const configQuery = '/system_config?select=photos_url&limit=1';
                const configResult = await supabaseRequest(configQuery);
                const photosUrl = configResult.length > 0 ? configResult[0].photos_url : '';

                return {
                    topics: topics,
                    config_url_photos: photosUrl
                };

            } catch (error) {
                console.error('Error en consulta Supabase:', error);
                throw new Error('Error al consultar la base de datos');
            }
        }

        /**
         * Procesar datos iniciales y renderizar
         */
        function procesarDatosIniciales(datos) {
            try {
                // Guardar datos globalmente
                datosGlobales.topics = datos.topics;
                datosGlobales.topicsOriginales = [...datos.topics];
                datosGlobales.configUrlPhotos = datos.config_url_photos;

                // Procesar categorías concatenadas
                datosGlobales.topics.forEach(topic => {
                    const categorias = topic.stm_students_topics_categories
                        .map(cat => cat.stm_category.category_name)
                        .join(', ');
                    topic.category_names = categorias;
                });

                // Renderizar componentes
                renderizarEstadisticas();
                renderizarAsuntos();
                mostrarComponentes();
                
                ocultarLoading();
                mostrarNotificacion('Datos cargados correctamente', 'success');

            } catch (error) {
                console.error('Error procesando datos:', error);
                ocultarLoading();
                mostrarNotificacion('Error al procesar los datos', 'error');
            }
        }

        /**
         * Mostrar componentes de la interfaz
         */
        function mostrarComponentes() {
            document.getElementById('stats-container').style.display = 'flex';
            document.getElementById('filter-container').style.display = 'block';
        }

        /**
         * Renderizar estadísticas
         */
        function renderizarEstadisticas() {
            const topics = datosGlobales.topics;
            const total = topics.length;
            const escalables = topics.filter(t => t.is_escalable === 'SI').length;
            const noEscalables = total - escalables;

            document.getElementById('total-topics').textContent = total;
            document.getElementById('escalable-topics').textContent = escalables;
            document.getElementById('no-escalable-topics').textContent = noEscalables;
        }

        /**
         * Renderizar tabla de asuntos
         */
        function renderizarAsuntos() {
            const container = document.getElementById('topics-container');
            const topics = datosGlobales.topics;

            if (!topics || topics.length === 0) {
                container.innerHTML = `
                    <div class="no-topics-message">
                        <div class="no-topics-icon">
                            <i class="bi bi-inbox"></i>
                        </div>
                        <h4>No hay asuntos para revisar</h4>
                        <p class="mb-0">No se encontraron asuntos individuales para los estudiantes de sus cursos.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 70px;">Foto</th>
                                    <th style="width: 180px;">Estudiante</th>
                                    <th style="width: 110px;">Fecha</th>
                                    <th style="width: 150px;">Categorías</th>
                                    <th>Descripción</th>
                                    <th style="width: 150px;">Reportado por</th>
                                    <th style="width: 120px;">Escalable</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            topics.forEach(topic => {
                html += crearFilaAsunto(topic);
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            adjuntarEventosTabla();
        }

        /**
         * Crear HTML para una fila de asunto
         */
        function crearFilaAsunto(topic) {
            // Construir datos
            const photoUrl = `${datosGlobales.configUrlPhotos}${topic.students.student_code || ''}.jpg`;
            const nombreEstudiante = `${topic.students.student_first_name || ''} ${topic.students.student_last_name_1 || ''}`.trim();
            const nombreReportante = `${topic.workers?.worker_first_name || ''} ${topic.workers?.worker_last_name_1 || ''}`.trim();
            const fechaFormateada = formatearFecha(topic.topic_date);
            const descripcionLimpia = limpiarYTruncarDescripcion(topic.topic_description);
            const escalableActual = topic.is_escalable || 'NO';

            return `
                <tr>
                    <td>
                        <img class="student-photo" 
                             src="${photoUrl}" 
                             alt="Foto de ${escapeHtml(nombreEstudiante)}"
                             onerror="this.classList.add('error-loading')" />
                    </td>
                    <td>
                        <div class="student-name">${escapeHtml(nombreEstudiante)}</div>
                        <small class="text-muted">Código: ${topic.students.student_code || 'N/A'}</small>
                    </td>
                    <td>
                        <div class="topic-date">${fechaFormateada}</div>
                    </td>
                    <td>
                        <span class="categories-badge">${escapeHtml(topic.category_names || 'Sin categoría')}</span>
                    </td>
                    <td>
                        <div class="topic-description" title="${escapeHtml(topic.topic_description || '')}">
                            ${escapeHtml(descripcionLimpia)}
                        </div>
                    </td>
                    <td>
                        <div class="reporter-info">${escapeHtml(nombreReportante || 'Usuario externo')}</div>
                    </td>
                    <td>
                        <select class="escalable-select ${escalableActual === 'SI' ? 'escalable-si' : 'escalable-no'}" 
                                data-topic-id="${topic.topic_id}"
                                data-previous-value="${escalableActual}"
                                aria-label="Estado escalable para ${escapeHtml(nombreEstudiante)}">
                            <option value="SI" ${escalableActual === 'SI' ? 'selected' : ''}>SI</option>
                            <option value="NO" ${escalableActual === 'NO' ? 'selected' : ''}>NO</option>
                        </select>
                        <span class="update-status" id="status-${topic.topic_id}"></span>
                    </td>
                </tr>
            `;
        }
      /**
         * Adjuntar eventos a la tabla
         */
        function adjuntarEventosTabla() {
            const selects = document.querySelectorAll('.escalable-select');
            
            selects.forEach(select => {
                select.addEventListener('change', function() {
                    const topicId = parseInt(this.dataset.topicId);
                    const nuevoValor = this.value;
                    const valorAnterior = this.dataset.previousValue;
                    
                    if (nuevoValor !== valorAnterior) {
                        actualizarEscalable(topicId, nuevoValor, this);
                    }
                });
            });
        }

        /**
         * Actualizar estado escalable
         */
        async function actualizarEscalable(topicId, nuevoValor, selectElement) {
            if (actualizandoEscalable) {
                mostrarNotificacion('Hay una actualización en proceso. Espere un momento.', 'warning');
                return;
            }

            try {
                actualizandoEscalable = true;
                
                // Deshabilitar select y mostrar loading
                selectElement.disabled = true;
                selectElement.dataset.loading = 'true';
                mostrarEstadoActualizacion(topicId, 'Actualizando...', 'loading');
                
                // Actualizar en base de datos
                const updateData = { is_escalable: nuevoValor };
                await supabaseRequest(`/stm_students_topics?topic_id=eq.${topicId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });

                // Actualizar datos locales
                const topic = datosGlobales.topics.find(t => t.topic_id === topicId);
                if (topic) {
                    topic.is_escalable = nuevoValor;
                }
                
                const topicOriginal = datosGlobales.topicsOriginales.find(t => t.topic_id === topicId);
                if (topicOriginal) {
                    topicOriginal.is_escalable = nuevoValor;
                }

                // Actualizar UI
                selectElement.dataset.previousValue = nuevoValor;
                selectElement.className = `escalable-select ${nuevoValor === 'SI' ? 'escalable-si' : 'escalable-no'}`;
                
                // Actualizar estadísticas
                renderizarEstadisticas();
                
                mostrarEstadoActualizacion(topicId, 'Actualizado correctamente', 'success');
                
                setTimeout(() => {
                    limpiarEstadoActualizacion(topicId);
                }, 3000);

            } catch (error) {
                console.error('Error actualizando escalable:', error);
                
                // Rollback del select
                const valorAnterior = selectElement.dataset.previousValue;
                selectElement.value = valorAnterior;
                selectElement.className = `escalable-select ${valorAnterior === 'SI' ? 'escalable-si' : 'escalable-no'}`;
                
                mostrarEstadoActualizacion(topicId, 'Error al actualizar', 'error');
                mostrarNotificacion('Error al actualizar: ' + error.message, 'error');
                
                setTimeout(() => {
                    limpiarEstadoActualizacion(topicId);
                }, 5000);
                
            } finally {
                selectElement.disabled = false;
                selectElement.dataset.loading = 'false';
                actualizandoEscalable = false;
            }
        }

        /**
         * Mostrar estado de actualización
         */
        function mostrarEstadoActualizacion(topicId, mensaje, tipo) {
            const statusElement = document.getElementById(`status-${topicId}`);
            if (statusElement) {
                statusElement.textContent = mensaje;
                statusElement.className = `update-status ${tipo}`;
            }
        }

        /**
         * Limpiar estado de actualización
         */
        function limpiarEstadoActualizacion(topicId) {
            const statusElement = document.getElementById(`status-${topicId}`);
            if (statusElement) {
                statusElement.textContent = '';
                statusElement.className = 'update-status';
            }
        }

        /**
         * Filtrar asuntos por criterio
         */
        function filtrarAsuntos(criterio) {
            filtroActual = criterio;
            let asuntosFiltrados = [...datosGlobales.topicsOriginales];
            
            switch (criterio) {
                case 'escalables':
                    asuntosFiltrados = asuntosFiltrados.filter(t => t.is_escalable === 'SI');
                    break;
                case 'no-escalables':
                    asuntosFiltrados = asuntosFiltrados.filter(t => t.is_escalable === 'NO');
                    break;
                case 'recientes':
                    asuntosFiltrados.sort((a, b) => new Date(b.topic_date) - new Date(a.topic_date));
                    break;
                case 'todos':
                default:
                    // Mostrar todos sin filtro
                    break;
            }
            
            datosGlobales.topics = asuntosFiltrados;
            renderizarAsuntos();
            
            // Mostrar notificación del filtro aplicado
            const mensajes = {
                'todos': 'Mostrando todos los asuntos',
                'escalables': `Mostrando ${asuntosFiltrados.length} asuntos escalables`,
                'no-escalables': `Mostrando ${asuntosFiltrados.length} asuntos no escalables`,
                'recientes': 'Ordenado por fecha (más recientes primero)'
            };
            
            mostrarNotificacion(mensajes[criterio] || 'Filtro aplicado', 'info');
        }

        /**
         * Actualizar botón de filtro activo
         */
        function actualizarBotonFiltroActivo(botonActivo) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            botonActivo.classList.add('active');
        }

        /**
         * Refrescar datos desde el servidor
         */
        function refrescarDatos() {
            mostrarTableLoading();
            
            obtenerDatosAsuntos()
                .then(datos => {
                    // Actualizar datos globales
                    datosGlobales.topicsOriginales = [...datos.topics];
                    datosGlobales.configUrlPhotos = datos.config_url_photos;
                    
                    // Procesar categorías
                    datos.topics.forEach(topic => {
                        const categorias = topic.stm_students_topics_categories
                            .map(cat => cat.stm_category.category_name)
                            .join(', ');
                        topic.category_names = categorias;
                    });
                    
                    // Aplicar filtro actual
                    filtrarAsuntos(filtroActual);
                    
                    // Actualizar estadísticas con datos originales
                    const tempTopics = datosGlobales.topics;
                    datosGlobales.topics = datosGlobales.topicsOriginales;
                    renderizarEstadisticas();
                    datosGlobales.topics = tempTopics;
                    
                    ocultarTableLoading();
                    mostrarNotificacion('Datos actualizados correctamente', 'success');
                })
                .catch(error => {
                    console.error('Error refrescando datos:', error);
                    ocultarTableLoading();
                    mostrarNotificacion('Error al refrescar datos: ' + error.message, 'error');
                });
        }

        /**
         * Manejar atajos de teclado
         */
        function manejarAtajosTeclado(e) {
            // F5 para refrescar
            if (e.key === 'F5') {
                e.preventDefault();
                refrescarDatos();
            }
            
            // Escape para mostrar todos
            if (e.key === 'Escape') {
                filtrarAsuntos('todos');
                actualizarBotonFiltroActivo(document.querySelector('[data-filter="todos"]'));
            }
            
            // Alt + números para filtros rápidos
            if (e.altKey) {
                switch (e.key) {
                    case '1':
                        e.preventDefault();
                        filtrarAsuntos('todos');
                        actualizarBotonFiltroActivo(document.querySelector('[data-filter="todos"]'));
                        break;
                    case '2':
                        e.preventDefault();
                        filtrarAsuntos('escalables');
                        actualizarBotonFiltroActivo(document.querySelector('[data-filter="escalables"]'));
                        break;
                    case '3':
                        e.preventDefault();
                        filtrarAsuntos('no-escalables');
                        actualizarBotonFiltroActivo(document.querySelector('[data-filter="no-escalables"]'));
                        break;
                    case '4':
                        e.preventDefault();
                        filtrarAsuntos('recientes');
                        actualizarBotonFiltroActivo(document.querySelector('[data-filter="recientes"]'));
                        break;
                }
            }
        }

        /**
         * Buscar asuntos por texto
         */
        function buscarAsuntos(textoBusqueda) {
            if (!textoBusqueda.trim()) {
                filtrarAsuntos(filtroActual);
                return;
            }
            
            const textoLower = textoBusqueda.toLowerCase();
            const asuntosFiltrados = datosGlobales.topicsOriginales.filter(topic => {
                const nombreEstudiante = `${topic.students.student_first_name || ''} ${topic.students.student_last_name_1 || ''}`.toLowerCase();
                const descripcion = (topic.topic_description || '').toLowerCase();
                const categorias = (topic.category_names || '').toLowerCase();
                const reportante = `${topic.workers?.worker_first_name || ''} ${topic.workers?.worker_last_name_1 || ''}`.toLowerCase();
                
                return nombreEstudiante.includes(textoLower) ||
                       descripcion.includes(textoLower) ||
                       categorias.includes(textoLower) ||
                       reportante.includes(textoLower);
            });
            
            datosGlobales.topics = asuntosFiltrados;
            renderizarAsuntos();
            mostrarNotificacion(`Encontrados ${asuntosFiltrados.length} asuntos que coinciden con "${textoBusqueda}"`, 'info');
        }
      /**
         * FUNCIONES DE UTILIDAD
         */

        /**
         * Formatear fecha para visualización
         */
        function formatearFecha(fechaStr) {
            if (!fechaStr) return 'N/A';
            
            try {
                const fecha = new Date(fechaStr);
                return fecha.toLocaleDateString('es-CO', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (error) {
                console.error('Error formateando fecha:', error);
                return fechaStr;
            }
        }

        /**
         * Limpiar HTML y truncar descripción
         */
        function limpiarYTruncarDescripcion(descripcion, maxLength = 150) {
            if (!descripcion) return '';
            
            // Remover tags HTML
            const descripcionLimpia = descripcion.replace(/<[^>]*>/g, '').trim();
            
            // Truncar si es muy larga
            if (descripcionLimpia.length <= maxLength) {
                return descripcionLimpia;
            }
            
            return descripcionLimpia.substring(0, maxLength) + '...';
        }

        /**
         * Escapar HTML para prevenir XSS
         */
        function escapeHtml(texto) {
            if (!texto) return '';
            
            const div = document.createElement('div');
            div.textContent = texto;
            return div.innerHTML;
        }

        /**
         * Mostrar loading overlay
         */
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        /**
         * Ocultar loading overlay
         */
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        /**
         * Mostrar loading de tabla
         */
        function mostrarTableLoading() {
            const tableLoading = document.getElementById('table-loading');
            const container = document.getElementById('topics-container');
            
            tableLoading.classList.remove('hidden');
            if (container) {
                container.style.opacity = '0.6';
                container.style.pointerEvents = 'none';
            }
        }

        /**
         * Ocultar loading de tabla
         */
        function ocultarTableLoading() {
            const tableLoading = document.getElementById('table-loading');
            const container = document.getElementById('topics-container');
            
            tableLoading.classList.add('hidden');
            if (container) {
                container.style.opacity = '1';
                container.style.pointerEvents = 'auto';
            }
        }

        /**
         * Mostrar notificación temporal
         */
        function mostrarNotificacion(mensaje, tipo = 'info', duracion = 4000) {
            const iconos = {
                'success': 'bi-check-circle',
                'error': 'bi-exclamation-triangle',
                'warning': 'bi-exclamation-triangle',
                'info': 'bi-info-circle'
            };

            const colores = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            };

            const notificacion = document.createElement('div');
            notificacion.className = `temp-notification alert ${colores[tipo] || 'alert-info'} alert-dismissible fade show`;
            notificacion.innerHTML = `
                <i class="${iconos[tipo] || 'bi-info-circle'} me-2"></i>
                ${escapeHtml(mensaje)}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notificacion);

            // Auto-remover después del tiempo especificado
            if (tipo === 'success' || tipo === 'info') {
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.remove();
                    }
                }, duracion);
            }
        }

        /**
         * Mostrar mensaje en el contenedor principal
         */
        function mostrarMensaje(mensaje, tipo = 'info') {
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger', 
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[tipo] || 'alert-info';
            
            const iconClass = {
                'success': 'bi-check-circle',
                'error': 'bi-exclamation-triangle',
                'warning': 'bi-exclamation-triangle', 
                'info': 'bi-info-circle'
            }[tipo] || 'bi-info-circle';
            
            const mensajeContainer = document.getElementById('mensaje-container');
            mensajeContainer.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="${iconClass} me-2"></i>${escapeHtml(mensaje)}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            mensajeContainer.style.display = 'block';
            
            if (tipo === 'success' || tipo === 'info') {
                setTimeout(() => {
                    mensajeContainer.style.display = 'none';
                }, 5000);
            }
        }

        /**
         * Validar email
         */
        function validarEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        /**
         * Obtener estadísticas de los asuntos
         */
        function obtenerEstadisticas(topics = null) {
            const asuntos = topics || datosGlobales.topics;
            
            return {
                total: asuntos.length,
                escalables: asuntos.filter(t => t.is_escalable === 'SI').length,
                noEscalables: asuntos.filter(t => t.is_escalable === 'NO').length,
                porcentajeEscalables: asuntos.length > 0 ? 
                    Math.round((asuntos.filter(t => t.is_escalable === 'SI').length / asuntos.length) * 100) : 0
            };
        }

        /**
         * Exportar datos a CSV (funcionalidad futura)
         */
        function exportarCSV() {
            try {
                const headers = ['Estudiante', 'Código', 'Fecha', 'Categorías', 'Descripción', 'Reportado por', 'Escalable'];
                const rows = datosGlobales.topics.map(topic => [
                    `${topic.students.student_first_name || ''} ${topic.students.student_last_name_1 || ''}`.trim(),
                    topic.students.student_code || '',
                    formatearFecha(topic.topic_date),
                    topic.category_names || '',
                    limpiarYTruncarDescripcion(topic.topic_description, 500),
                    `${topic.workers?.worker_first_name || ''} ${topic.workers?.worker_last_name_1 || ''}`.trim(),
                    topic.is_escalable || 'NO'
                ]);

                const csvContent = [headers, ...rows]
                    .map(row => row.map(field => `"${field}"`).join(','))
                    .join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `asuntos_individuales_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                mostrarNotificacion('Datos exportados exitosamente', 'success');
                
            } catch (error) {
                console.error('Error exportando CSV:', error);
                mostrarNotificacion('Error al exportar datos', 'error');
            }
        }

        /**
         * Imprimir tabla de asuntos
         */
        function imprimirTabla() {
            const contenidoOriginal = document.body.innerHTML;
            const tabla = document.querySelector('.table-container');
            
            if (!tabla) {
                mostrarNotificacion('No hay datos para imprimir', 'warning');
                return;
            }

            // Crear contenido para impresión
            const contenidoImpresion = `
                <html>
                <head>
                    <title>Asuntos Individuales - ${new Date().toLocaleDateString()}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; font-size: 12px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f5f5f5; font-weight: bold; }
                        .student-photo { display: none; }
                        .topic-description { max-width: none; max-height: none; background: none; border: none; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>Revisar Asuntos Individuales</h2>
                        <p>Fecha de impresión: ${new Date().toLocaleDateString()}</p>
                        <p>Total de asuntos: ${datosGlobales.topics.length}</p>
                    </div>
                    ${tabla.outerHTML}
                </body>
                </html>
            `;

            const ventanaImpresion = window.open('', '_blank');
            ventanaImpresion.document.write(contenidoImpresion);
            ventanaImpresion.document.close();
            ventanaImpresion.print();
        }

        /**
         * Configurar modo debug
         */
        function configurarDebug() {
            if (window.location.hostname === 'localhost' || 
                window.location.search.includes('debug=true')) {
                
                window.debugAsuntos = function() {
                    console.log('=== DEBUG ASUNTOS INDIVIDUALES ===');
                    console.log('Datos globales:', datosGlobales);
                    console.log('Filtro actual:', filtroActual);
                    console.log('Estadísticas:', obtenerEstadisticas());
                    console.log('Usuario actual:', datosGlobales.usuarioActual);
                    console.log('URL fotos:', datosGlobales.configUrlPhotos);
                };
                
                // Atajo Ctrl+Shift+D para debug
                document.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                        e.preventDefault();
                        window.debugAsuntos();
                    }
                });

                console.log('Modo debug activado. Use Ctrl+Shift+D o window.debugAsuntos()');
            }
        }

        /**
         * Manejar errores globales
         */
        function configurarManejadorErrores() {
            window.addEventListener('error', function(e) {
                console.error('Error global:', e.error);
                mostrarNotificacion('Error inesperado. Si persiste, recargue la página.', 'error');
            });

            window.addEventListener('unhandledrejection', function(e) {
                console.error('Promesa rechazada:', e.reason);
                mostrarNotificacion('Error de conexión. Verifique su internet.', 'error');
            });
        }

        /**
         * Configurar tooltips y ayuda
         */
        function configurarAyuda() {
            // Crear tooltips para estadísticas
            const statsCards = document.querySelectorAll('.stats-card');
            statsCards.forEach(card => {
                card.setAttribute('data-bs-toggle', 'tooltip');
                card.setAttribute('data-bs-placement', 'top');
            });

            // Tooltips para filtros
            document.querySelector('[data-filter="todos"]').title = 'Alt+1: Mostrar todos los asuntos';
            document.querySelector('[data-filter="escalables"]').title = 'Alt+2: Filtrar asuntos escalables';
            document.querySelector('[data-filter="no-escalables"]').title = 'Alt+3: Filtrar asuntos no escalables';
            document.querySelector('[data-filter="recientes"]').title = 'Alt+4: Ordenar por fecha';

            // Tooltip para refrescar
            document.getElementById('btn-refrescar').title = 'F5: Refrescar datos del servidor';
        }

        // Inicializar configuraciones adicionales cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            configurarDebug();
            configurarManejadorErrores();
            
            // Configurar ayuda después de un pequeño delay
            setTimeout(configurarAyuda, 1000);
        });

      /**
         * Funciones adicionales y finalización
         */

        /**
         * Obtener resumen de cambios realizados
         */
        function obtenerResumenCambios() {
            // Esta función podría implementarse para trackear cambios
            // durante la sesión del usuario
            return {
                cambiosRealizados: 0,
                ultimoCambio: null,
                tiempoSesion: Date.now() - (window.inicioSesion || Date.now())
            };
        }

        /**
         * Limpiar datos sensibles antes de cerrar
         */
        function limpiarDatosSensibles() {
            // Limpiar cualquier dato sensible que no deba persistir
            if (window.debugAsuntos) {
                delete window.debugAsuntos;
            }
        }

        /**
         * Configurar beforeunload para advertir sobre cambios no guardados
         */
        window.addEventListener('beforeunload', function(e) {
            if (actualizandoEscalable) {
                e.preventDefault();
                e.returnValue = 'Hay una actualización en proceso. ¿Está seguro de salir?';
                return e.returnValue;
            }
            
            limpiarDatosSensibles();
        });

        /**
         * Configurar visibilidad de página para pausar actualizaciones
         */
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Página no visible - pausar actualizaciones automáticas si las hubiera
                console.log('Página oculta - pausando actualizaciones');
            } else {
                // Página visible - reanudar si es necesario
                console.log('Página visible - reanudando');
            }
        });

        /**
         * Función de limpieza al cerrar
         */
        function limpiezaFinal() {
            // Cancelar cualquier timeout pendiente
            // Limpiar event listeners si es necesario
            // Esta función se llamaría en situaciones específicas
            console.log('Realizando limpieza final');
        }

        /**
         * Funciones globales para uso externo
         */
        
        // Hacer disponibles las funciones principales globalmente
        window.revisar_asuntos = {
            refrescar: refrescarDatos,
            filtrar: filtrarAsuntos,
            exportar: exportarCSV,
            imprimir: imprimirTabla,
            buscar: buscarAsuntos,
            estadisticas: obtenerEstadisticas,
            debug: configurarDebug
        };

        // Funciones específicas para debugging y testing
        window.obtenerDatosAsuntos = function() {
            return datosGlobales;
        };

        window.simularCambioEscalable = function(topicId, valor) {
            if (window.location.hostname === 'localhost') {
                const select = document.querySelector(`[data-topic-id="${topicId}"]`);
                if (select) {
                    select.value = valor;
                    select.dispatchEvent(new Event('change'));
                }
            }
        };

        /**
         * Inicialización final y logging
         */
        console.log('🎯 Revisar Asuntos Individuales - SchoolNet inicializado');
        console.log('📊 Funciones disponibles:', Object.keys(window.revisar_asuntos));
        
        // Marcar tiempo de inicio para métricas
        window.inicioSesion = Date.now();
        
        /**
         * Configuración de rendimiento
         */
        
        // Monitoreo básico de rendimiento
        if ('performance' in window) {
            window.addEventListener('load', function() {
                setTimeout(function() {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    if (perfData) {
                        const loadTime = perfData.loadEventEnd - perfData.loadEventStart;
                        console.log(`⚡ Tiempo de carga: ${loadTime}ms`);
                        
                        if (loadTime > 3000) {
                            console.warn('⚠️ Tiempo de carga elevado detectado');
                        }
                    }
                }, 100);
            });
        }

        /**
         * Manejo de reconexión de red
         */
        window.addEventListener('online', function() {
            mostrarNotificacion('Conexión restaurada. Refrescando datos...', 'success');
            setTimeout(refrescarDatos, 1000);
        });

        window.addEventListener('offline', function() {
            mostrarNotificacion('Conexión perdida. Algunas funciones pueden no estar disponibles.', 'warning');
        });

        /**
         * Configuración de accesibilidad adicional
         */
        function mejorarAccesibilidad() {
            // Añadir roles ARIA donde sea necesario
            const tabla = document.querySelector('.table');
            if (tabla) {
                tabla.setAttribute('role', 'table');
                tabla.setAttribute('aria-label', 'Tabla de asuntos individuales para revisar');
            }

            // Mejorar contraste de focus para navegación con teclado
            const style = document.createElement('style');
            style.textContent = `
                .escalable-select:focus {
                    outline: 3px solid #1380e2 !important;
                    outline-offset: 2px !important;
                }
                .filter-btn:focus {
                    outline: 2px solid #1380e2 !important;
                    outline-offset: 2px !important;
                }
            `;
            document.head.appendChild(style);
        }

        // Ejecutar mejoras de accesibilidad después de la carga
        setTimeout(mejorarAccesibilidad, 1500);

        /**
         * Easter egg para desarrolladores
         */
        let konamiCode = [];
        const konamiSequence = [
            'ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown',
            'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight',
            'KeyB', 'KeyA'
        ];

        document.addEventListener('keydown', function(e) {
            konamiCode.push(e.code);
            if (konamiCode.length > konamiSequence.length) {
                konamiCode.shift();
            }
            
            if (konamiCode.length === konamiSequence.length && 
                konamiCode.every((code, index) => code === konamiSequence[index])) {
                
                mostrarNotificacion('🎮 Código Konami activado! Modo desarrollador desbloqueado.', 'success', 8000);
                window.developerMode = true;
                console.log('🎮 Developer mode activated!');
                console.log('💡 Funciones adicionales disponibles en window.revisar_asuntos');
                konamiCode = [];
            }
        });

    </script>
</body>
</html>
