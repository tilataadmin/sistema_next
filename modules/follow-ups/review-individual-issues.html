<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revisar Asuntos Individuales - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Estilos específicos para revisar asuntos individuales */
        .student-photo {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .student-photo:error,
        .student-photo[src=""] {
            display: none;
        }
        
        .update-status {
            margin-left: 10px;
            font-size: 12px;
            color: #198754;
            font-weight: 500;
        }
        
        .update-error {
            margin-left: 10px;
            font-size: 12px;
            color: #dc3545;
            font-weight: 500;
        }
        
        .is-escalable-select {
            width: 80px;
            padding: 4px 6px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .topic-description {
            max-width: 300px;
            max-height: 100px;
            overflow-y: auto;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .no-topics-message {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            font-size: 18px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1380e2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsividad para tabla */
        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
            }
            
            .topic-description {
                max-width: 200px;
            }
            
            .student-photo {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay inicial -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Cargando asuntos...</p>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="../follow-ups/index.html">
                        Seguimientos
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Revisar Asuntos Individuales
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Revisar Asuntos Individuales
                </h1>
                <p class="text-muted">
                    Revisión y clasificación de asuntos individuales de estudiantes
                </p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Área de estadísticas rápidas -->
        <div id="stats-container" style="margin-bottom: 20px; display: none;">
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title" id="total-topics">0</h5>
                            <p class="card-text text-muted">Total Asuntos</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center bg-warning text-white">
                        <div class="card-body">
                            <h5 class="card-title" id="escalable-topics">0</h5>
                            <p class="card-text">Escalables</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title" id="no-escalable-topics">0</h5>
                            <p class="card-text">No Escalables</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <button class="btn btn-outline-primary btn-sm" onclick="refrescarDatos()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refrescar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor principal de asuntos -->
        <div id="topics-container" style="margin-top: 20px;">
            <!-- Los asuntos se cargan dinámicamente aquí -->
        </div>

        <!-- Loading para actualizaciones -->
        <div id="table-loading" style="display: none; text-align: center; padding: 20px; color: #1380e2; font-weight: 600;">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Actualizando datos...
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Config JS -->
    <script src="../../assets/js/config.js"></script>

    <script>
        // === VARIABLES GLOBALES ===
        let datosGlobales = {
            topics: [],
            config_url_photos: ''
        };

        let enviandoActualizacion = false;

        // === FUNCIONES DE UTILIDAD ===
        
        /**
         * Mostrar overlay de carga
         */
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        /**
         * Ocultar overlay de carga
         */
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        /**
         * Mostrar loading de tabla
         */
        function mostrarTableLoading() {
            document.getElementById('table-loading').style.display = 'block';
            const container = document.getElementById('topics-container');
            if (container) {
                container.style.opacity = '0.5';
            }
        }

        /**
         * Ocultar loading de tabla
         */
        function ocultarTableLoading() {
            document.getElementById('table-loading').style.display = 'none';
            const container = document.getElementById('topics-container');
            if (container) {
                container.style.opacity = '1';
            }
        }

        /**
         * Escapar HTML para prevenir inyección
         */
        function escapeHtml(texto) {
            if (!texto) return '';
            const div = document.createElement('div');
            div.textContent = texto;
            return div.innerHTML;
        }

        /**
         * Mostrar mensaje de estado temporal
         */
        function mostrarEstadoTemporal(topicId, mensaje, esError = false) {
            const statusSpan = document.getElementById('status-' + topicId);
            if (statusSpan) {
                statusSpan.textContent = mensaje;
                statusSpan.className = esError ? 'update-error' : 'update-status';
                
                // Limpiar después de unos segundos
                setTimeout(() => {
                    statusSpan.textContent = '';
                    statusSpan.className = 'update-status';
                }, esError ? 5000 : 3000);
            }
        }

        /**
         * Formatear fecha para mostrar
         */
        function formatearFecha(fechaStr) {
            if (!fechaStr) return '';
            try {
                const fecha = new Date(fechaStr);
                return fecha.toLocaleDateString('es-CO', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (e) {
                return fechaStr;
            }
        }

        /**
         * Truncar texto largo
         */
        function truncarTexto(texto, maxLength = 100) {
            if (!texto) return '';
            if (texto.length <= maxLength) return texto;
            return texto.substring(0, maxLength) + '...';
        }

        // === FUNCIONES DE CARGA DE DATOS ===

        /**
         * Cargar datos iniciales
         */
        async function cargarDatosIniciales() {
            mostrarLoading();
            
            try {
                // Cargar URL de fotos desde configuración
                await cargarConfiguracionFotos();
                
                // Cargar asuntos del usuario actual
                await cargarAsuntosUsuario();
                
                // Mostrar aplicación
                ocultarLoading();
                
            } catch (error) {
                console.error('Error al cargar datos iniciales:', error);
                ocultarLoading();
                showMessage('Error al cargar los datos: ' + error.message, 'danger');
            }
        }

        /**
         * Cargar configuración de fotos
         */
        async function cargarConfiguracionFotos() {
            try {
                const configData = await supabaseRequest('/system_config?select=photos_url&limit=1');
                datosGlobales.config_url_photos = configData.length > 0 ? configData[0].photos_url : '';
            } catch (error) {
                console.error('Error cargando configuración de fotos:', error);
                datosGlobales.config_url_photos = '';
            }
        }

        /**
         * Cargar asuntos del usuario actual (director de curso)
         */
        async function cargarAsuntosUsuario() {
            try {
                const session = getStoredSession();
                if (!session || !session.user) {
                    throw new Error('No hay sesión activa');
                }

                const emailUsuario = session.user.user_mail;
                
                // Consulta para obtener asuntos de estudiantes de cursos dirigidos por el usuario
                const query = `
                    /stm_students_topics?select=
                        topic_id,
                        student_id,
                        topic_date,
                        topic_description,
                        email,
                        is_escalable,
                        students!inner(
                            student_code,
                            student_first_name,
                            student_last_name_1,
                            courses!inner(
                                course_director_email,
                                course_name
                            )
                        ),
                        workers(
                            worker_first_name,
                            worker_last_name_1
                        )
                    &students.courses.course_director_email=eq.${emailUsuario}
                    &is_open=eq.SI
                    &order=topic_date.desc
                    &limit=150
                `.replace(/\s+/g, '');

                const asuntos = await supabaseRequest(query);
                
                // Procesar datos para facilitar el uso
                datosGlobales.topics = asuntos.map(asunto => ({
                    topic_id: asunto.topic_id,
                    student_id: asunto.student_id,
                    topic_date: asunto.topic_date,
                    topic_description: asunto.topic_description,
                    topic_email: asunto.email,
                    is_escalable: asunto.is_escalable,
                    student_code: asunto.students.student_code,
                    student_first_name: asunto.students.student_first_name,
                    student_last_name_1: asunto.students.student_last_name_1,
                    course_name: asunto.students.courses.course_name,
                    worker_first_name: asunto.workers?.worker_first_name || '',
                    worker_last_name_1: asunto.workers?.worker_last_name_1 || ''
                }));

                // Renderizar estadísticas y tabla
                renderizarEstadisticas();
                renderizarTablaAsuntos();
                
            } catch (error) {
                console.error('Error cargando asuntos:', error);
                throw new Error('Error al cargar los asuntos: ' + error.message);
            }
        }

        /**
         * Renderizar estadísticas de los asuntos
         */
        function renderizarEstadisticas() {
            const statsContainer = document.getElementById('stats-container');
            
            if (!datosGlobales.topics || datosGlobales.topics.length === 0) {
                statsContainer.style.display = 'none';
                return;
            }
            
            const total = datosGlobales.topics.length;
            const escalables = datosGlobales.topics.filter(t => t.is_escalable === 'SI').length;
            const noEscalables = total - escalables;
            
            document.getElementById('total-topics').textContent = total;
            document.getElementById('escalable-topics').textContent = escalables;
            document.getElementById('no-escalable-topics').textContent = noEscalables;
            
            statsContainer.style.display = 'block';
        }

        /**
         * Refrescar todos los datos
         */
        async function refrescarDatos() {
            try {
                mostrarTableLoading();
                await cargarAsuntosUsuario();
                showMessage('Datos actualizados correctamente', 'success');
            } catch (error) {
                console.error('Error al refrescar datos:', error);
                showMessage('Error al refrescar datos: ' + error.message, 'danger');
            } finally {
                ocultarTableLoading();
            }
        }

        // === INICIALIZACIÓN ===

        /**
         * Inicialización principal cuando el DOM está listo
         */
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Validar acceso
                const hasAccess = await validatePageAccess('Revisar asuntos individuales');
                if (!hasAccess) return;

                // Inicializar página
                initializePage('reviewIndividualIssues', 'Seguimientos');
                
                // Cargar datos iniciales
                await cargarDatosIniciales();
                
                console.log('Página de revisar asuntos inicializada correctamente');
                
            } catch (error) {
                console.error('Error en inicialización:', error);
                ocultarLoading();
                showMessage('Error al inicializar la página: ' + error.message, 'danger');
            }
        });

        // === FUNCIONES DE RENDERIZADO ===

        /**
         * Renderizar tabla de asuntos
         */
        function renderizarTablaAsuntos() {
            const container = document.getElementById('topics-container');
            
            if (!datosGlobales.topics || datosGlobales.topics.length === 0) {
                container.innerHTML = `
                    <div class="no-topics-message">
                        <h3><i class="bi bi-journal-x me-2"></i>No hay asuntos registrados</h3>
                        <p>No se encontraron asuntos individuales para revisar en sus cursos.</p>
                    </div>
                `;
                return;
            }
            
            // Crear tabla con encabezados
            let html = `
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-hover" aria-label="Tabla de asuntos individuales">
                            <thead class="table-primary">
                                <tr>
                                    <th style="width: 80px;">Foto</th>
                                    <th style="width: 200px;">Estudiante</th>
                                    <th style="width: 120px;">Curso</th>
                                    <th style="width: 100px;">Fecha</th>
                                    <th style="width: 300px;">Descripción</th>
                                    <th style="width: 180px;">Reportado por</th>
                                    <th style="width: 120px;">Escalable</th>
                                </tr>
                            </thead>
                            <tbody id="topics-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Usar DocumentFragment para renderizado eficiente del tbody
            const tbody = document.getElementById('topics-tbody');
            const fragment = document.createDocumentFragment();
            
            datosGlobales.topics.forEach(function(topic) {
                const tr = document.createElement('tr');
                tr.innerHTML = crearFilaAsunto(topic);
                fragment.appendChild(tr);
            });
            
            // Agregar todo al tbody de una vez
            tbody.appendChild(fragment);
            
            // Adjuntar eventos a los controles
            adjuntarEventosAsuntos();
        }

        /**
         * Crear HTML para una fila de asunto
         */
        function crearFilaAsunto(topic) {
            // Construir URL de foto
            const photoUrl = datosGlobales.config_url_photos + (topic.student_code || '') + '.jpg';
            
            // Nombre completo del estudiante
            const nombreEstudiante = `${topic.student_first_name || ''} ${topic.student_last_name_1 || ''}`.trim();
            
            // Nombre completo del reportante
            const nombreReportante = `${topic.worker_first_name || ''} ${topic.worker_last_name_1 || ''}`.trim();
            
            // Valor escalable actual
            const escalableActual = topic.is_escalable || 'NO';
            
            // Fecha formateada
            const fechaFormateada = formatearFecha(topic.topic_date);
            
            // Descripción (limpiar HTML y truncar si es necesario)
            const descripcionLimpia = topic.topic_description ? 
                topic.topic_description.replace(/<[^>]*>/g, '').trim() : '';
            
            return `
                <td>
                    <img class="student-photo" 
                         src="${photoUrl}" 
                         alt="Foto de ${escapeHtml(nombreEstudiante)}"
                         onerror="this.style.display='none'" />
                </td>
                <td>
                    <strong>${escapeHtml(nombreEstudiante)}</strong>
                    <br>
                    <small class="text-muted">Código: ${escapeHtml(topic.student_code)}</small>
                </td>
                <td>${escapeHtml(topic.course_name || '')}</td>
                <td>${escapeHtml(fechaFormateada)}</td>
                <td>
                    <div class="topic-description" title="${escapeHtml(descripcionLimpia)}">
                        ${escapeHtml(truncarTexto(descripcionLimpia, 150))}
                    </div>
                </td>
                <td>${escapeHtml(nombreReportante)}</td>
                <td>
                    <select class="is-escalable-select" 
                            data-topic-id="${topic.topic_id}"
                            aria-label="Cambiar estado escalable para ${escapeHtml(nombreEstudiante)}">
                        <option value="SI" ${escalableActual === 'SI' ? 'selected' : ''}>SI</option>
                        <option value="NO" ${escalableActual === 'NO' ? 'selected' : ''}>NO</option>
                    </select>
                    <span class="update-status" id="status-${topic.topic_id}"></span>
                </td>
            `;
        }

        /**
         * Adjuntar eventos a los controles de asuntos
         */
        function adjuntarEventosAsuntos() {
            const selects = document.querySelectorAll('select.is-escalable-select');
            
            selects.forEach(function(select) {
                select.addEventListener('change', function() {
                    const topicId = parseInt(this.getAttribute('data-topic-id'));
                    const nuevoValor = this.value;
                    const valorAnterior = this.getAttribute('data-previous-value') || 
                                          (nuevoValor === 'SI' ? 'NO' : 'SI');
                    
                    // Guardar valor anterior para rollback si es necesario
                    this.setAttribute('data-previous-value', valorAnterior);
                    
                    // Deshabilitar select durante la actualización
                    this.disabled = true;
                    
                    actualizarEscalable(topicId, nuevoValor, this);
                });
                
                // Guardar valor inicial
                select.setAttribute('data-previous-value', select.value);
            });
        }

        // === FUNCIONES DE ACTUALIZACIÓN ===

        /**
         * Actualizar estado escalable de un asunto
         */
        async function actualizarEscalable(topicId, nuevoValor, selectElement) {
            if (enviandoActualizacion) {
                showMessage('Por favor espere, hay una actualización en proceso...', 'warning');
                selectElement.disabled = false;
                return;
            }

            enviandoActualizacion = true;
            
            // Mostrar estado de actualización
            mostrarEstadoTemporal(topicId, 'Actualizando...', false);
            
            try {
                // Realizar actualización en la base de datos
                await supabaseRequest('/stm_students_topics?topic_id=eq.' + topicId, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_escalable: nuevoValor })
                });
                
                // Actualizar el valor en los datos globales
                actualizarDatosGlobales(topicId, nuevoValor);
                
                // Actualizar estadísticas
                renderizarEstadisticas();
                
                // Mostrar éxito
                mostrarEstadoTemporal(topicId, 'Actualizado', false);
                
                // Actualizar valor anterior
                selectElement.setAttribute('data-previous-value', nuevoValor);
                
            } catch (error) {
                console.error('Error al actualizar escalable:', error);
                
                // Mostrar error
                mostrarEstadoTemporal(topicId, 'Error: ' + (error.message || error), true);
                
                // Rollback del select al valor anterior
                const valorAnterior = selectElement.getAttribute('data-previous-value');
                selectElement.value = valorAnterior;
                
                showMessage('Error al actualizar el registro: ' + error.message, 'danger');
                
            } finally {
                // Habilitar select
                selectElement.disabled = false;
                enviandoActualizacion = false;
            }
        }

        /**
         * Actualizar datos en memoria después de cambio exitoso
         */
        function actualizarDatosGlobales(topicId, nuevoValor) {
            const topic = datosGlobales.topics.find(t => parseInt(t.topic_id) === topicId);
            if (topic) {
                topic.is_escalable = nuevoValor;
            }
        }

        /**
         * Filtrar asuntos por criterio
         */
        function filtrarAsuntos(criterio) {
            let asuntosFiltrados = [...datosGlobales.topics];
            
            switch (criterio) {
                case 'escalables':
                    asuntosFiltrados = asuntosFiltrados.filter(t => t.is_escalable === 'SI');
                    break;
                case 'no-escalables':
                    asuntosFiltrados = asuntosFiltrados.filter(t => t.is_escalable === 'NO');
                    break;
                case 'recientes':
                    asuntosFiltrados.sort((a, b) => new Date(b.topic_date) - new Date(a.topic_date));
                    break;
                case 'todos':
                default:
                    // No filtrar, mostrar todos
                    break;
            }
            
            // Temporalmente actualizar los datos para mostrar filtrado
            const datosOriginales = datosGlobales.topics;
            datosGlobales.topics = asuntosFiltrados;
            renderizarTablaAsuntos();
            renderizarEstadisticas();
            
            // Restaurar datos originales
            setTimeout(() => {
                datosGlobales.topics = datosOriginales;
            }, 100);
        }

        // === FUNCIONES AUXILIARES PARA EXPORTAR ===

        /**
         * Exportar datos a CSV (funcionalidad futura)
         */
        function exportarCSV() {
            console.log('Función exportarCSV pendiente de implementar');
            showMessage('Funcionalidad de exportar CSV será implementada próximamente', 'info');
        }

        /**
         * Imprimir tabla (funcionalidad futura)
         */
        function imprimirTabla() {
            console.log('Función imprimirTabla pendiente de implementar');
            showMessage('Funcionalidad de imprimir será implementada próximamente', 'info');
        }

        // === CONFIGURACIÓN Y MANEJO DE EVENTOS ===

        /**
         * Configurar atajos de teclado
         */
        function configurarAtajosTeclado() {
            document.addEventListener('keydown', function(e) {
                // F5 o Ctrl+R para refrescar datos
                if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                    e.preventDefault();
                    refrescarDatos();
                }
                
                // Escape para limpiar filtros (mostrar todos)
                if (e.key === 'Escape') {
                    filtrarAsuntos('todos');
                }
                
                // Números para filtros rápidos
                if (e.altKey) {
                    switch (e.key) {
                        case '1':
                            e.preventDefault();
                            filtrarAsuntos('todos');
                            break;
                        case '2':
                            e.preventDefault();
                            filtrarAsuntos('escalables');
                            break;
                        case '3':
                            e.preventDefault();
                            filtrarAsuntos('no-escalables');
                            break;
                        case '4':
                            e.preventDefault();
                            filtrarAsuntos('recientes');
                            break;
                    }
                }
            });
        }

        /**
         * Configurar manejo de errores globales
         */
        function configurarErroresGlobales() {
            // Errores JavaScript no manejados
            window.addEventListener('error', function(e) {
                console.error('Error global:', e.error);
                
                // Mostrar notificación de error
                showMessage('Error inesperado. Si persiste, recargue la página.', 'danger');
            });

            // Promesas rechazadas no manejadas
            window.addEventListener('unhandledrejection', function(e) {
                console.error('Promesa rechazada:', e.reason);
            });
        }

        /**
         * Configurar tooltips y ayuda
         */
        function configurarAyuda() {
            // Agregar tooltips a las estadísticas
            const statsContainer = document.getElementById('stats-container');
            if (statsContainer) {
                statsContainer.title = 'Estadísticas de asuntos. Presione Alt+1,2,3,4 para filtrar rápidamente';
            }
            
            // Tooltip para tabla
            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.title = 'Tabla de asuntos. Use F5 para refrescar, Escape para mostrar todos';
            }
        }

        /**
         * Configurar accesibilidad mejorada
         */
        function configurarAccesibilidad() {
            // Mejorar navegación con teclado en selects
            const selects = document.querySelectorAll('.is-escalable-select');
            selects.forEach(function(select) {
                select.addEventListener('focus', function() {
                    this.style.outline = '2px solid #1380e2';
                });
                
                select.addEventListener('blur', function() {
                    this.style.outline = '';
                });
            });
        }

        /**
         * Configurar modo debug (solo en desarrollo)
         */
        function configurarDebug() {
            if (window.location.hostname === 'localhost' || 
                window.location.hostname.includes('vercel.app')) {
                
                // Función global de debug
                window.debugAsuntos = function() {
                    console.log('=== DEBUG ASUNTOS ===');
                    console.log('Datos globales:', datosGlobales);
                    console.log('Total asuntos:', datosGlobales.topics.length);
                    console.log('Escalables:', datosGlobales.topics.filter(t => t.is_escalable === 'SI').length);
                    console.log('No escalables:', datosGlobales.topics.filter(t => t.is_escalable === 'NO').length);
                    console.log('URL fotos:', datosGlobales.config_url_photos);
                };
                
                // Atajos de debug
                document.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                        e.preventDefault();
                        window.debugAsuntos();
                    }
                });
            }
        }

        /**
         * Inicialización completa después de cargar datos
         */
        function inicializarFuncionalidadesAvanzadas() {
            try {
                // Configurar manejo de errores primero
                configurarErroresGlobales();
                
                // Configurar funcionalidades
                configurarAtajosTeclado();
                configurarAyuda();
                configurarDebug();
                
                console.log('Funcionalidades avanzadas inicializadas correctamente');
                
                // Configurar accesibilidad después de que se carguen los datos
                setTimeout(() => {
                    configurarAccesibilidad();
                }, 1000);
                
            } catch (error) {
                console.error('Error en inicialización de funcionalidades avanzadas:', error);
            }
        }

        // === FUNCIONES GLOBALES EXPORTADAS ===

        /**
         * Función global para refrescar datos (accesible desde HTML)
         */
        window.refrescarDatos = refrescarDatos;
        window.filtrarAsuntos = filtrarAsuntos;
        window.exportarCSV = exportarCSV;
        window.imprimirTabla = imprimirTabla;

        // === ACTUALIZACIÓN DE LA INICIALIZACIÓN PRINCIPAL ===

        // Actualizar la inicialización principal para incluir funcionalidades avanzadas
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Validar acceso
                const hasAccess = await validatePageAccess('Revisar asuntos individuales');
                if (!hasAccess) return;

                // Inicializar página
                initializePage('reviewIndividualIssues', 'Seguimientos');
                
                // Cargar datos iniciales
                await cargarDatosIniciales();
                
                // Inicializar funcionalidades avanzadas
                inicializarFuncionalidadesAvanzadas();
                
                console.log('Página de revisar asuntos inicializada completamente');
                
            } catch (error) {
                console.error('Error en inicialización:', error);
                ocultarLoading();
                showMessage('Error al inicializar la página: ' + error.message, 'danger');
            }
        });

        // === FUNCIONES DE CONFIGURACIÓN ADICIONAL ===

        /**
         * Configurar filtros adicionales en la interfaz
         */
        function agregarFiltrosInterfaz() {
            const statsContainer = document.getElementById('stats-container');
            if (statsContainer && datosGlobales.topics.length > 0) {
                // Agregar botones de filtro rápido
                const filtrosHTML = `
                    <div class="col-12 mt-3">
                        <div class="btn-group btn-group-sm" role="group" aria-label="Filtros rápidos">
                            <button type="button" class="btn btn-outline-primary" onclick="filtrarAsuntos('todos')">
                                <i class="bi bi-list me-1"></i>Todos
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="filtrarAsuntos('escalables')">
                                <i class="bi bi-arrow-up-circle me-1"></i>Escalables
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="filtrarAsuntos('no-escalables')">
                                <i class="bi bi-check-circle me-1"></i>No Escalables
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="filtrarAsuntos('recientes')">
                                <i class="bi bi-clock me-1"></i>Recientes
                            </button>
                        </div>
                        <small class="text-muted ms-3">
                            <i class="bi bi-keyboard me-1"></i>
                            Atajos: Alt+1,2,3,4 | F5 = Refrescar | Esc = Mostrar todos
                        </small>
                    </div>
                `;
                
                const row = statsContainer.querySelector('.row');
                if (row) {
                    row.insertAdjacentHTML('beforeend', filtrosHTML);
                }
            }
        }

        /**
         * Configuración final después de renderizar por primera vez
         */
        function configuracionFinalRenderizado() {
            // Agregar filtros de interfaz si hay datos
            if (datosGlobales.topics && datosGlobales.topics.length > 0) {
                agregarFiltrosInterfaz();
            }
            
            // Configurar eventos adicionales
            configurarEventosAdicionales();
        }

        /**
         * Configurar eventos adicionales
         */
        function configurarEventosAdicionales() {
            // Evento para tecla Enter en los selects (confirmar cambio)
            document.addEventListener('keydown', function(e) {
                if (e.target.classList.contains('is-escalable-select') && e.key === 'Enter') {
                    e.target.blur(); // Quitar focus para que se active el evento change
                }
            });
        }

        // Actualizar la función de cargar datos iniciales para incluir configuración final
        const cargarDatosInicialesOriginal = cargarDatosIniciales;
        cargarDatosIniciales = async function() {
            await cargarDatosInicialesOriginal();
            configuracionFinalRenderizado();
        };

    </script>
</body>
</html>
