<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimientos por Cursos - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Estilos específicos para seguimientos por cursos */
        .students-table {
            margin-top: 20px;
        }
        
        .student-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #dee2e6;
        }
        
        .student-name {
            font-weight: 600;
            color: #1380e2;
        }
        
        .action-btn {
            padding: 6px 12px;
            margin: 2px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            min-width: 80px;
            text-align: center;
        }
        
        .btn-asuntos {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-tareas {
            background-color: #ffc107;
            color: #1380e2;
        }

        .btn-tareas:hover {
            background-color: #e0a800;
            color: #1380e2;
            opacity: 1;
        }
        
        .btn-documentos {
            background-color: #0dcaf0;
            color: white;
        }
        
        .btn-eae {
            background-color: #d63384;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .table-container {
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Modal grande para asuntos */
        .modal-large {
            max-width: 1400px;
            width: 95%;
        }

        /* Modal mediano para conclusiones y estrategias */
        .modal-medium {
            max-width: 800px;
            width: 90%;
        }

        /* Estilos para editor de texto enriquecido */
        .editor-container {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background-color: white;
        }

        .editor-toolbar {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
        }

        .toolbar-btn {
            background: none;
            border: 1px solid transparent;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            color: #1380e2;
            transition: all 0.3s;
        }

        .toolbar-btn:hover {
            background-color: white;
            border-color: #dee2e6;
        }

        .toolbar-btn:active {
            background-color: #6c757d;
            color: white;
        }

        .toolbar-separator {
            margin: 0 8px;
            color: #6c757d;
        }

        .editor-content {
            min-height: 200px;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            outline: none;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
        }

        .editor-content:empty:before {
            content: attr(placeholder);
            color: #6c757d;
            font-style: italic;
        }

        .editor-content:focus {
            box-shadow: inset 0 0 0 2px rgba(19, 128, 226, 0.1);
        }

        .editor-content p {
            margin: 0 0 8px 0;
        }

        .editor-content ul, .editor-content ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .editor-content li {
            margin: 4px 0;
        }

        .asunto-description {
            max-width: 300px;
            max-height: 80px;
            overflow-y: auto;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
        }

        .btn-action-small {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            white-space: nowrap;
        }

        .btn-conclusion {
            background-color: #ffc107;
            color: #1380e2;
        }

        .btn-conclusion:hover {
            background-color: #e0a800;
            color: #1380e2;
            opacity: 1;
        }

        .btn-estrategia {
            background-color: #0dcaf0;
            color: white;
        }

        .btn-action-small:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .categoria-cell {
            font-weight: 600;
            color: #1380e2;
        }

        .fecha-cell {
            font-size: 12px;
            color: #6c757d;
        }

        /* Estilos mejorados para descripción con texto enriquecido */
        .asunto-description-rich {
            max-width: 450px;
            max-height: 120px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .asunto-description-rich p {
            margin: 0 0 8px 0;
        }

        .asunto-description-rich ul, 
        .asunto-description-rich ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .asunto-description-rich li {
            margin: 4px 0;
        }

        .asunto-description-rich strong, 
        .asunto-description-rich b {
            font-weight: 600;
        }

        .asunto-description-rich em, 
        .asunto-description-rich i {
            font-style: italic;
        }

        .asunto-description-rich u {
            text-decoration: underline;
        }

        /* Actualizar anchos de columnas en la tabla de asuntos SIN CONCLUSIÓN */

        .modal-large table th:nth-child(1) { width: 150px; } /* Categoría */
        .modal-large table th:nth-child(2) { width: 120px; } /* Fecha */
        .modal-large table th:nth-child(3) { width: auto; } 

        
        /* Estilos específicos para documentos */
        .documento-description {
            max-width: 400px;
            max-height: 60px;
            overflow-y: auto;
            padding: 6px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.3;
        }

        .documento-enlace {
            display: inline-block;
            padding: 4px 8px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .documento-enlace:hover {
            background-color: #1380e2;
            transform: translateY(-1px);
        }

        .trabajador-cell {
            font-weight: 500;
            color: #1380e2;
            font-size: 13px;
        }

        /* Spinner de carga */
        .loading-spinner {
            font-size: 10px;
            opacity: 0.7;
            animation: fadeInOut 1.5s infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.9; }
        }
    </style>
</head>
<body>
    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="../follow-ups/index.html">
                        Seguimientos
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Seguimientos por Cursos
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Seguimientos por Cursos
                </h1>
                <p class="text-muted">
                    Gestión integral de seguimientos para estudiantes por curso
                </p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Sección de selección de curso -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="selectCurso" class="form-label">Seleccione el curso:</label>
                        <select id="selectCurso" class="form-select" onchange="cargarEstudiantes()">
                            <option value="">-- Seleccione un curso --</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <div id="mensajePermisos" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje de carga -->
        <div id="mensajeCarga" class="alert alert-info" style="display: none;">
            <i class="bi bi-hourglass-split me-2"></i>Cargando estudiantes...
        </div>

        <!-- Tabla de estudiantes SIN COLUMNA METAS -->
        <div id="tablaContainer" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover students-table">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 80px;">Foto</th>
                                    <th>Nombre</th>
                                    <th style="width: 100px;">E.A.E</th>
                                    <th style="width: 100px;">Asuntos</th>
                                    <th style="width: 100px;">Tareas</th>
                                    <th style="width: 120px;">Documentos</th>
                                </tr>
                            </thead>
                            <tbody id="tablaEstudiantes">
                                <!-- Los estudiantes se cargarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje cuando no hay datos -->
        <div id="noData" class="no-data" style="display: none;">
            <div class="alert alert-warning">
                <i class="bi bi-info-circle me-2"></i>
                No se encontraron estudiantes para el curso seleccionado.
            </div>
        </div>
    </div>

    <!-- Modales incluidos aquí -->
    <!-- Modal de Asuntos ACTUALIZADO - Sin columna Conclusión -->
    <!-- Modal de Asuntos SOLO LECTURA - Sin botones de acción -->
<div class="modal fade" id="modalAsuntos" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tituloModalAsuntos">Asuntos del Estudiante</h5>
                <button type="button" class="btn-close" onclick="cerrarModalAsuntos()"></button>
            </div>
            <div class="modal-body">
                <!-- Mensaje de carga para asuntos -->
                <div id="mensajeCargaAsuntos" class="alert alert-info" style="display: none;">
                    <i class="bi bi-hourglass-split me-2"></i>Cargando asuntos del estudiante...
                </div>

                <!-- Tabla de asuntos SOLO LECTURA - 3 columnas -->
                <div id="tablaAsuntosContainer" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 150px;">Categoría</th>
                                    <th style="width: 120px;">Fecha</th>
                                    <th>Descripción</th>
                                </tr>
                            </thead>
                            <tbody id="tablaAsuntos">
                                <!-- Los asuntos se cargarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Mensaje cuando no hay asuntos -->
                <div id="noDataAsuntos" class="no-data" style="display: none;">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No se encontraron asuntos escalables y abiertos para este estudiante.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalAsuntos()">Cerrar</button>
            </div>
        </div>
    </div>
</div>
    
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Config JS -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // Variables globales
        let estudiantesData = [];
        let studentIdActual = null;
        let topicIdActual = null;
        let eaeTopicIdActual = null;
        let modalTareasInstance = null;
        let modalCrearTareaInstance = null;

        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            await validatePageAccess('Seguimientos por cursos');
            initializePage('courseFollowUps', 'Seguimientos');
            await cargarConfiguracionInicial();
        });

        // Carga configuración inicial
        async function cargarConfiguracionInicial() {
            try {
                showMessage('Cargando configuración...', 'info');
                await cargarCursosPermitidos();
                closeAlert('alert_' + Date.now());
            } catch (error) {
                console.error('Error cargando configuración:', error);
                showMessage('Error al cargar la configuración inicial', 'danger');
            }
        }
        // Carga cursos permitidos según permisos del usuario
        async function cargarCursosPermitidos() {
            try {
                const session = getStoredSession();
                if (!session || !session.user) {
                    showMessage('Sesión no válida', 'danger');
                    return;
                }
        
                // Buscar trabajador por email
                const workerData = await supabaseRequest(`/workers?select=worker_id,email,section_id&email=eq.${session.user.user_mail}`);
                
                if (workerData.length === 0) {
                    mostrarSinPermisos('Usuario no encontrado en el sistema');
                    return;
                }
                
                const worker = workerData[0];
                
                // Verificar si es director de curso
                const cursosDirector = await supabaseRequest(`/courses?select=course_id,course_name&course_director_email=eq.${session.user.user_mail}`);
                
                // Si es director de curso, mostrar sus cursos
                if (cursosDirector.length > 0) {
                    llenarSelectCursos(cursosDirector, `Sus cursos: ${cursosDirector.length} curso(s)`);
                    return;
                }
                
                // Verificar si es director de sección
                const seccionData = await supabaseRequest(`/sections?select=section_id,section_name&director_email=eq.${session.user.user_mail}`);
                
                if (seccionData.length > 0) {
                    // Obtener todos los cursos de la sección
                    const cursosSeccion = await supabaseRequest(`/courses?select=course_id,course_name,course_order,grades!inner(section_id)&grades.section_id=eq.${seccionData[0].section_id}&order=course_order.asc`);
                    llenarSelectCursos(cursosSeccion, `Cursos de la sección: ${seccionData[0].section_name}`);
                    return;
                }
                
                // Si no es director, verificar si es super admin
                const hasPermission = await checkUserPermission(session.user.user_id, 'Seguimientos por cursos');
                
                if (hasPermission) {
                    // Es super admin, puede ver todos los cursos
                    const todosCursos = await supabaseRequest('/courses?select=course_id,course_name,course_order&order=course_order.asc');
                    llenarSelectCursos(todosCursos, 'Todos los cursos (Admin)');
                    return;
                }
                
                // Sin permisos
                mostrarSinPermisos('No tiene cursos a su cargo');
                
            } catch (error) {
                console.error('Error cargando cursos:', error);
                showMessage('Error al cargar los cursos disponibles', 'danger');
            }
        }

        function mostrarSinPermisos(mensaje) {
            const selectCurso = document.getElementById('selectCurso');
            const mensajePermisos = document.getElementById('mensajePermisos');
            
            selectCurso.disabled = true;
            selectCurso.innerHTML = '<option value="">No tiene cursos disponibles</option>';
            
            mensajePermisos.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>${mensaje}
                </div>
            `;
            mensajePermisos.style.display = 'block';
        }
        
        function llenarSelectCursos(cursos, mensaje) {
            const selectCurso = document.getElementById('selectCurso');
            const mensajePermisos = document.getElementById('mensajePermisos');
            
            cursos.forEach(curso => {
                const option = document.createElement('option');
                option.value = curso.course_id;
                option.textContent = curso.course_name;
                selectCurso.appendChild(option);
            });
            
            if (mensaje) {
                mensajePermisos.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>${mensaje}
                    </div>
                `;
                mensajePermisos.style.display = 'block';
            }
        }

        // Obtiene conteos de seguimientos para estudiantes - SIN METAS
        async function obtenerConteosEstudiantes(studentIds) {
            try {
                const conteos = {};
                
                // Inicializar conteos SIN METAS
                studentIds.forEach(id => {
                    conteos[id] = {
                        eae: 0,
                        asuntos: 0,
                        tareas: 0,
                        documentos: 0
                    };
                });
                
                // Conteo de asuntos EAE - CORREGIDO
                const eaeData = await supabaseRequest(`/stm_eae_topics?select=student_id&student_id=in.(${studentIds.join(',')})&is_open=eq.SI`);
                eaeData.forEach(item => {
                    if (conteos[item.student_id]) {
                        conteos[item.student_id].eae++;
                    }
                });
                
                // Conteo de asuntos individuales escalables - CORREGIDO
                const asuntosData = await supabaseRequest(`/stm_students_topics?select=student_id&student_id=in.(${studentIds.join(',')})&is_open=eq.SI&is_escalable=eq.SI`);
                asuntosData.forEach(item => {
                    if (conteos[item.student_id]) {
                        conteos[item.student_id].asuntos++;
                    }
                });
                
                // Conteo de tareas activas - CORREGIDO
                const tareasData = await supabaseRequest(`/tasks?select=student_id&student_id=in.(${studentIds.join(',')})&task_state=in.(Asignada,En proceso)`);
                tareasData.forEach(item => {
                    if (conteos[item.student_id]) {
                        conteos[item.student_id].tareas++;
                    }
                });
                
                // Conteo de documentos - CORREGIDO
                const docsData = await supabaseRequest(`/stm_docs?select=student_id&student_id=in.(${studentIds.join(',')})`);
                docsData.forEach(item => {
                    if (conteos[item.student_id]) {
                        conteos[item.student_id].documentos++;
                    }
                });
                
                return conteos;
                
            } catch (error) {
                console.error('Error obteniendo conteos:', error);
                return {};
            }
        }

        async function cargarEstudiantes() {
            const selectCurso = document.getElementById('selectCurso');
            const courseId = selectCurso.value;
            
            // LIMPIAR cualquier modal abierto
            if (modalTareasInstance) {
                modalTareasInstance.dispose();
                modalTareasInstance = null;
            }
            if (modalCrearTareaInstance) {
                modalCrearTareaInstance.dispose();
                modalCrearTareaInstance = null;
            }
            
            // Eliminar modales del DOM si existen
            ['modalTareas', 'modalCrearTarea', 'modalAsuntos', 'modalEAE', 'modalDocumentos', 'modalVincularDocumento'].forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) modal.remove();
            });
            
            // Limpiar studentIdActual
            studentIdActual = null;
            
            limpiarTabla();
            
            if (!courseId) {
                return;
            }
            
            try {
                const mensajeCarga = document.getElementById('mensajeCarga');
                mensajeCarga.style.display = 'block';
                
                // Obtener estudiantes del curso
                const estudiantes = await supabaseRequest(`/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2&course_id=eq.${courseId}&order=student_first_name,student_last_name_1`);
                
                if (estudiantes.length === 0) {
                    mensajeCarga.style.display = 'none';
                    document.getElementById('noData').style.display = 'block';
                    return;
                }
                
                // Obtener conteos para todos los estudiantes
                const studentIds = estudiantes.map(e => e.student_id);
                const conteos = await obtenerConteosEstudiantes(studentIds);
                
                estudiantesData = estudiantes;
                mostrarEstudiantesConConteos(estudiantes, conteos);
                mensajeCarga.style.display = 'none';
                
            } catch (error) {
                console.error('Error cargando estudiantes:', error);
                document.getElementById('mensajeCarga').style.display = 'none';
                showMessage('Error al cargar los estudiantes del curso', 'danger');
            }
        }

        // Limpia la tabla de estudiantes
        function limpiarTabla() {
            document.getElementById('tablaContainer').style.display = 'none';
            document.getElementById('noData').style.display = 'none';
            document.getElementById('tablaEstudiantes').innerHTML = '';
        }

        // Muestra estudiantes con sus conteos - SIN METAS
        async function mostrarEstudiantesConConteos(estudiantes, conteos) {
            const tablaContainer = document.getElementById('tablaContainer');
            const tablaEstudiantes = document.getElementById('tablaEstudiantes');
            
            const fragment = document.createDocumentFragment();
            
            for (const estudiante of estudiantes) {
                const nombreCompleto = `${estudiante.student_first_name} ${estudiante.student_last_name_1}`;
                const fotoUrl = await getStudentPhotoUrl(estudiante.student_code);
                
                const conteosEstudiante = conteos[estudiante.student_id] || {
                    eae: 0, asuntos: 0, tareas: 0, documentos: 0
                };
                
                const tr = document.createElement('tr');
                
                // Columna foto
                const tdFoto = document.createElement('td');
                if (fotoUrl) {
                    const img = document.createElement('img');
                    img.src = fotoUrl;
                    img.alt = `Foto de ${nombreCompleto}`;
                    img.className = 'student-photo';
                    img.onerror = function() {
                        this.style.display = 'none';
                        this.nextElementSibling.style.display = 'flex';
                    };
                    tdFoto.appendChild(img);
                }
                
                const divPlaceholder = document.createElement('div');
                divPlaceholder.style.cssText = 'display:none; width:50px; height:50px; border-radius:50%; background-color:#f8f9fa; border:2px solid #ddd; align-items:center; justify-content:center; font-size:20px; color:#6c757d;';
                divPlaceholder.innerHTML = '<i class="bi bi-person"></i>';
                tdFoto.appendChild(divPlaceholder);
                tr.appendChild(tdFoto);
                
                // Columna nombre
                const tdNombre = document.createElement('td');
                tdNombre.className = 'student-name';
                tdNombre.textContent = nombreCompleto;
                tr.appendChild(tdNombre);
                
                // Columnas de botones con conteos - SIN METAS
                const botones = [
                    { clase: 'btn-eae', texto: 'E.A.E', conteo: conteosEstudiante.eae, funcion: () => abrirEAE(estudiante.student_id) },
                    { clase: 'btn-asuntos', texto: 'Asuntos', conteo: conteosEstudiante.asuntos, funcion: () => abrirAsuntos(estudiante.student_id) },
                    { clase: 'btn-tareas', texto: 'Tareas', conteo: conteosEstudiante.tareas, funcion: () => abrirTareas(estudiante.student_id) },
                    { clase: 'btn-documentos', texto: 'Documentos', conteo: conteosEstudiante.documentos, funcion: () => abrirDocumentos(estudiante.student_id) }
                ];
                
                botones.forEach(boton => {
                    const td = document.createElement('td');
                    const btn = document.createElement('button');
                    btn.className = `action-btn ${boton.clase}`;
                    btn.textContent = boton.texto + (boton.conteo > 0 ? ` (${boton.conteo})` : '');
                    btn.onclick = boton.funcion;
                    td.appendChild(btn);
                    tr.appendChild(td);
                });
                
                fragment.appendChild(tr);
            }
            
            tablaEstudiantes.appendChild(fragment);
            tablaContainer.style.display = 'block';
        }
        // Funciones para abrir modales
        function abrirAsuntos(studentId) {
            studentIdActual = studentId;
            const estudiante = estudiantesData.find(e => e.student_id === studentId);
            const nombreEstudiante = estudiante ? 
                `${estudiante.student_first_name} ${estudiante.student_last_name_1}` : 
                'Estudiante';
            
            document.getElementById('tituloModalAsuntos').textContent = `Asuntos de ${nombreEstudiante}`;
            
            const modal = new bootstrap.Modal(document.getElementById('modalAsuntos'));
            modal.show();
            
            cargarAsuntosEstudiante(studentId);
        }

        // Funciones del modal de asuntos
        function cerrarModalAsuntos() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalAsuntos'));
            if (modal) modal.hide();
            limpiarTablaAsuntos();
            studentIdActual = null;
        }

        function limpiarTablaAsuntos() {
            document.getElementById('tablaAsuntosContainer').style.display = 'none';
            document.getElementById('noDataAsuntos').style.display = 'none';
            document.getElementById('tablaAsuntos').innerHTML = '';
        }

        // Query corregido SIN topic_conclusion y topic_strategy
        async function cargarAsuntosEstudiante(studentId) {
            try {
                document.getElementById('mensajeCargaAsuntos').style.display = 'block';
                limpiarTablaAsuntos();
                
                // QUERY SIMPLIFICADO: Solo campos que existen en la tabla
                const asuntos = await supabaseRequest(`/stm_students_topics?select=topic_id,student_id,topic_date,topic_description,is_escalable,is_open,stm_students_topics_categories(stm_category(category_name))&student_id=eq.${studentId}&is_open=eq.SI&is_escalable=eq.SI&order=topic_date.desc`);
                
                document.getElementById('mensajeCargaAsuntos').style.display = 'none';
                
                if (asuntos.length === 0) {
                    document.getElementById('noDataAsuntos').style.display = 'block';
                    return;
                }
                
                // Agrupar categorías por topic_id
                const asuntosConCategorias = {};
                asuntos.forEach(asunto => {
                    if (!asuntosConCategorias[asunto.topic_id]) {
                        asuntosConCategorias[asunto.topic_id] = {
                            ...asunto,
                            categorias: []
                        };
                    }
                    if (asunto.stm_students_topics_categories?.stm_category?.category_name) {
                        asuntosConCategorias[asunto.topic_id].categorias.push(
                            asunto.stm_students_topics_categories.stm_category.category_name
                        );
                    }
                });
                
                mostrarAsuntos(Object.values(asuntosConCategorias));
                
            } catch (error) {
                document.getElementById('mensajeCargaAsuntos').style.display = 'none';
                console.error('Error cargando asuntos:', error);
                showMessage('Error al cargar los asuntos del estudiante', 'danger');
            }
        }

        // Función mostrarAsuntos SIN botón de estrategia - Solo lectura
        function mostrarAsuntos(asuntos) {
            const tablaContainer = document.getElementById('tablaAsuntosContainer');
            const tablaAsuntos = document.getElementById('tablaAsuntos');
            
            const fragment = document.createDocumentFragment();
            
            asuntos.forEach(asunto => {
                const tr = document.createElement('tr');
                
                // Columna categorías
                const tdCategoria = document.createElement('td');
                tdCategoria.className = 'categoria-cell';
                tdCategoria.textContent = asunto.categorias.join(', ') || 'Sin categoría';
                tr.appendChild(tdCategoria);
                
                // Columna fecha
                const tdFecha = document.createElement('td');
                tdFecha.className = 'fecha-cell';
                tdFecha.textContent = formatDate(asunto.topic_date);
                tr.appendChild(tdFecha);
                
                // Columna descripción (expandida para ocupar todo el espacio)
                const tdDescripcion = document.createElement('td');
                const divDescripcion = document.createElement('div');
                divDescripcion.className = 'asunto-description-rich';
                divDescripcion.innerHTML = asunto.topic_description || '<em>Sin descripción</em>';
                tdDescripcion.appendChild(divDescripcion);
                tr.appendChild(tdDescripcion);
                
                // NO hay más columnas - eliminadas Conclusión y Estrategia
                
                fragment.appendChild(tr);
            });
            
            tablaAsuntos.appendChild(fragment);
            tablaContainer.style.display = 'block';
        }

        
        
        
        // ELIMINAR completamente todas las funciones relacionadas con conclusión:
       
    
        
     
        // Actualizar función guardarEstrategia SIN referencias a conclusión
        async function guardarEstrategia() {
            const editor = document.getElementById('editorEstrategia');
            const estrategia = editor.innerHTML.trim();
            
            if (!estrategia || estrategia === '<br>' || estrategia === '<div><br></div>') {
                mostrarError('La estrategia no puede estar vacía', 'Estrategia');
                return;
            }
            
            try {
                if (eaeTopicIdActual) {
                    // Es un asunto EAE
                    await supabaseRequest(`/stm_eae_topics?eae_topic_id=eq.${eaeTopicIdActual}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ topic_strategy: estrategia })
                    });
                } else if (topicIdActual) {
                    // Es un asunto regular
                    await supabaseRequest(`/stm_students_topics?topic_id=eq.${topicIdActual}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ topic_strategy: estrategia })
                    });
                } else {
                    throw new Error('No se ha seleccionado un asunto válido');
                }
                
                mostrarExito('Estrategia guardada exitosamente', 'Estrategia');
                
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('modalEstrategia')).hide();
                    if (studentIdActual) {
                        if (eaeTopicIdActual) {
                            cargarAsuntosEAE(studentIdActual);
                        } else {
                            cargarAsuntosEstudiante(studentIdActual);
                        }
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Error guardando estrategia:', error);
                mostrarError('Error al guardar la estrategia', 'Estrategia');
            }
        }

        function mostrarAsuntosEAE(asuntosEAE) {
            const tablaEAE = document.getElementById('tablaEAE');
            const fragment = document.createDocumentFragment();
            
            asuntosEAE.forEach(asuntoEAE => {
                const tr = document.createElement('tr');
                
                // Fecha
                const tdFecha = document.createElement('td');
                tdFecha.className = 'fecha-cell';
                tdFecha.textContent = formatDate(asuntoEAE.topic_date);
                tr.appendChild(tdFecha);
                
                // Apoyo
                const tdApoyo = document.createElement('td');
                const divApoyo = document.createElement('div');
                divApoyo.className = 'asunto-description';
                divApoyo.textContent = asuntoEAE.supports || '';
                tdApoyo.appendChild(divApoyo);
                tr.appendChild(tdApoyo);
                
                // Acciones
                const tdAcciones = document.createElement('td');
                const divAcciones = document.createElement('div');
                divAcciones.className = 'asunto-description';
                divAcciones.textContent = asuntoEAE.actions || '';
                tdAcciones.appendChild(divAcciones);
                tr.appendChild(tdAcciones);
                
                // Recomendaciones
                const tdRecomendaciones = document.createElement('td');
                const divRecomendaciones = document.createElement('div');
                divRecomendaciones.className = 'asunto-description';
                divRecomendaciones.textContent = asuntoEAE.recommendations || '';
                tdRecomendaciones.appendChild(divRecomendaciones);
                tr.appendChild(tdRecomendaciones);
                
                // SOLO Botón estrategia (eliminado botón conclusión)
                const tdBotones = document.createElement('td');
                const btnEstrategia = document.createElement('button');
                btnEstrategia.className = 'btn-action-small btn-estrategia';
                btnEstrategia.textContent = 'Estrategia';
                btnEstrategia.onclick = () => registrarEstrategiaEAE(asuntoEAE.eae_topic_id);
                tdBotones.appendChild(btnEstrategia);
                
                tr.appendChild(tdBotones);
                fragment.appendChild(tr);
            });
            
            tablaEAE.appendChild(fragment);
            document.getElementById('tablaEAEContainer').style.display = 'block';
        }
        
        
        

        
        // Funciones de mensajes para modales
        function mostrarError(mensaje, tipo) {
            const errorDiv = document.getElementById(`mensajeError${tipo}`);
            errorDiv.textContent = mensaje;
            errorDiv.style.display = 'block';
            document.getElementById(`mensajeExito${tipo}`).style.display = 'none';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function mostrarExito(mensaje, tipo) {
            const exitoDiv = document.getElementById(`mensajeExito${tipo}`);
            exitoDiv.textContent = mensaje;
            exitoDiv.style.display = 'block';
            document.getElementById(`mensajeError${tipo}`).style.display = 'none';
            
            setTimeout(() => {
                exitoDiv.style.display = 'none';
            }, 3000);
        }
        // Modal de EAE actualizado - SOLO LECTURA
        function abrirEAE(studentId) {
            studentIdActual = studentId;
            const estudiante = estudiantesData.find(e => e.student_id === studentId);
            const nombreEstudiante = estudiante ? 
                `${estudiante.student_first_name} ${estudiante.student_last_name_1}` : 
                'Estudiante';
            
            const modalHtml = `
                <div class="modal fade" id="modalEAE" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Asuntos EAE de ${nombreEstudiante}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="mensajeCargaEAE" class="alert alert-info" style="display: none;">
                                    <i class="bi bi-hourglass-split me-2"></i>Cargando asuntos EAE...
                                </div>
                                
                                <div id="tablaEAEContainer" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 120px;">Fecha</th>
                                                    <th style="width: 220px;">Apoyo</th>
                                                    <th style="width: 220px;">Acciones</th>
                                                    <th>Recomendaciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tablaEAE">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div id="noDataEAE" class="no-data" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        No se encontraron asuntos EAE abiertos para este estudiante.
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (!document.getElementById('modalEAE')) {
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalEAE'));
            modal.show();
            
            cargarAsuntosEAE(studentId);
        }

        
        async function cargarAsuntosEAE(studentId) {
            try {
                document.getElementById('mensajeCargaEAE').style.display = 'block';
                
                const asuntosEAE = await supabaseRequest(`/stm_eae_topics?select=eae_topic_id,student_id,topic_date,topic_description,supports,actions,recommendations,followup,topic_conclusion,topic_strategy,is_open&student_id=eq.${studentId}&is_open=eq.SI&order=topic_date.desc`);
                
                document.getElementById('mensajeCargaEAE').style.display = 'none';
                
                if (asuntosEAE.length === 0) {
                    document.getElementById('noDataEAE').style.display = 'block';
                    return;
                }
                
                mostrarAsuntosEAE(asuntosEAE);
                
            } catch (error) {
                document.getElementById('mensajeCargaEAE').style.display = 'none';
                console.error('Error cargando asuntos EAE:', error);
                showMessage('Error al cargar los asuntos EAE', 'danger');
            }
        }


        // Función mostrarAsuntosEAE actualizada - SOLO LECTURA
        function mostrarAsuntosEAE(asuntosEAE) {
            const tablaEAE = document.getElementById('tablaEAE');
            const fragment = document.createDocumentFragment();
            
            asuntosEAE.forEach(asuntoEAE => {
                const tr = document.createElement('tr');
                
                // Fecha
                const tdFecha = document.createElement('td');
                tdFecha.className = 'fecha-cell';
                tdFecha.textContent = formatDate(asuntoEAE.topic_date);
                tr.appendChild(tdFecha);
                
                // Apoyo
                const tdApoyo = document.createElement('td');
                const divApoyo = document.createElement('div');
                divApoyo.className = 'asunto-description';
                divApoyo.textContent = asuntoEAE.supports || '';
                tdApoyo.appendChild(divApoyo);
                tr.appendChild(tdApoyo);
                
                // Acciones
                const tdAcciones = document.createElement('td');
                const divAcciones = document.createElement('div');
                divAcciones.className = 'asunto-description';
                divAcciones.textContent = asuntoEAE.actions || '';
                tdAcciones.appendChild(divAcciones);
                tr.appendChild(tdAcciones);
                
                // Recomendaciones
                const tdRecomendaciones = document.createElement('td');
                const divRecomendaciones = document.createElement('div');
                divRecomendaciones.className = 'asunto-description';
                divRecomendaciones.textContent = asuntoEAE.recommendations || '';
                tdRecomendaciones.appendChild(divRecomendaciones);
                tr.appendChild(tdRecomendaciones);
                
                // NO hay columna de botones - SOLO LECTURA
                
                fragment.appendChild(tr);
            });
            
            tablaEAE.appendChild(fragment);
            document.getElementById('tablaEAEContainer').style.display = 'block';
        }
        
            

        
        

        // Placeholder para otras funciones de modales
      // ==========================================
        // CORRECCIÓN 2: Función abrirTareas completamente reescrita
        // ==========================================
        function abrirTareas(studentId) {
            // Actualizar ID del estudiante actual
            studentIdActual = studentId;
            
            // Obtener información del estudiante
            const estudiante = estudiantesData.find(e => e.student_id === studentId);
            const nombreEstudiante = estudiante ? 
                `${estudiante.student_first_name} ${estudiante.student_last_name_1}` : 
                'Estudiante';
            
            // LIMPIAR modal existente si lo hay
            const modalExistente = document.getElementById('modalTareas');
            if (modalExistente) {
                // Cerrar instancia anterior si existe
                if (modalTareasInstance) {
                    modalTareasInstance.dispose();
                    modalTareasInstance = null;
                }
                // Eliminar modal del DOM
                modalExistente.remove();
            }
            
            // Crear nuevo modal con HTML limpio
            const modalHtml = `
                <div class="modal fade" id="modalTareas" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Tareas de ${nombreEstudiante}</h5>
                                <button type="button" class="btn-close" onclick="cerrarModalTareas()"></button>
                            </div>
                            <div class="modal-body">
                                <div id="mensajeCargaTareas" class="alert alert-info" style="display: none;">
                                    <i class="bi bi-hourglass-split me-2"></i>Cargando tareas...
                                </div>
                                
                                <div id="tablaTareasContainer" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 200px;">Asignada a</th>
                                                    <th style="width: 120px;">Fecha límite</th>
                                                    <th>Descripción</th>
                                                    <th>Progreso</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tablaTareas">
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="text-center mt-3">
                                        <button type="button" class="btn btn-primary" onclick="abrirModalCrearTarea()">
                                            <i class="bi bi-plus-circle me-1"></i>Crear tarea
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="noDataTareas" class="no-data" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        No se encontraron tareas asignadas o en proceso para este estudiante.
                                    </div>
                                    <div class="text-center mt-3">
                                        <button type="button" class="btn btn-primary" onclick="abrirModalCrearTarea()">
                                            <i class="bi bi-plus-circle me-1"></i>Crear tarea
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="cerrarModalTareas()">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Insertar nuevo modal en el DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Crear nueva instancia del modal
            modalTareasInstance = new bootstrap.Modal(document.getElementById('modalTareas'));
            
            // Mostrar modal
            modalTareasInstance.show();
            
            // Cargar tareas del estudiante
            cargarTareasEstudiante(studentId);
        }
        
        // Modal de Documentos - FUNCIONALIDAD COMPLETA RESTAURADA
        function abrirDocumentos(studentId) {
            studentIdActual = studentId;
            const estudiante = estudiantesData.find(e => e.student_id === studentId);
            const nombreEstudiante = estudiante ? 
                `${estudiante.student_first_name} ${estudiante.student_last_name_1}` : 
                'Estudiante';
            
            const modalHtml = `
                <div class="modal fade" id="modalDocumentos" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Documentos de ${nombreEstudiante}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="mensajeCargaDocumentos" class="alert alert-info" style="display: none;">
                                    <i class="bi bi-hourglass-split me-2"></i>Cargando documentos...
                                </div>
                                
                                <div id="tablaDocumentosContainer" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 200px;">Suministrado por</th>
                                                    <th>Descripción</th>
                                                    <th style="width: 120px;">Enlace</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tablaDocumentos">
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="text-center mt-3">
                                        <button type="button" class="btn btn-primary" onclick="abrirModalVincularDocumento()">
                                            <i class="bi bi-plus-circle me-1"></i>Vincular documento
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="noDataDocumentos" class="no-data" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        No se encontraron documentos vinculados para este estudiante.
                                    </div>
                                    <div class="text-center mt-3">
                                        <button type="button" class="btn btn-primary" onclick="abrirModalVincularDocumento()">
                                            <i class="bi bi-plus-circle me-1"></i>Vincular documento
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (!document.getElementById('modalDocumentos')) {
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalDocumentos'));
            modal.show();
            
            cargarDocumentosEstudiante(studentId);
        }

        // ==========================================
        // CORRECCIÓN 3: Función para cerrar modal
        // ==========================================
        function cerrarModalTareas() {
            if (modalTareasInstance) {
                modalTareasInstance.hide();
                modalTareasInstance.dispose();
                modalTareasInstance = null;
            }
            
            const modalElement = document.getElementById('modalTareas');
            if (modalElement) {
                modalElement.remove();
            }
            
            // Limpiar studentIdActual
            studentIdActual = null;
        }


        
        async function cargarDocumentosEstudiante(studentId) {
            try {
                document.getElementById('mensajeCargaDocumentos').style.display = 'block';
                
                const documentos = await supabaseRequest(`/stm_docs?select=doc_id,student_id,doc_url,doc_description,worker_name,private&student_id=eq.${studentId}&order=doc_id.desc`);
                
                document.getElementById('mensajeCargaDocumentos').style.display = 'none';
                
                if (documentos.length === 0) {
                    document.getElementById('noDataDocumentos').style.display = 'block';
                    return;
                }
                
                mostrarDocumentos(documentos);
                
            } catch (error) {
                document.getElementById('mensajeCargaDocumentos').style.display = 'none';
                console.error('Error cargando documentos:', error);
                showMessage('Error al cargar los documentos', 'danger');
            }
        }

        function mostrarDocumentos(documentos) {
            const tablaDocumentos = document.getElementById('tablaDocumentos');
            const fragment = document.createDocumentFragment();
            
            documentos.forEach(documento => {
                const tr = document.createElement('tr');
                
                // Trabajador
                const tdTrabajador = document.createElement('td');
                tdTrabajador.className = 'trabajador-cell';
                tdTrabajador.textContent = documento.worker_name || 'No especificado';
                tr.appendChild(tdTrabajador);
                
                // Descripción
                const tdDescripcion = document.createElement('td');
                const divDescripcion = document.createElement('div');
                divDescripcion.className = 'documento-description';
                
                let descripcionCompleta = documento.doc_description || '';
                if (documento.private === 'SI') {
                    descripcionCompleta += '\n\nDocumento privado EAE';
                }
                divDescripcion.innerHTML = descripcionCompleta.replace(/\n/g, '<br>');
                tdDescripcion.appendChild(divDescripcion);
                tr.appendChild(tdDescripcion);
                
                // Enlace
                const tdEnlace = document.createElement('td');
                tdEnlace.style.textAlign = 'center';
                
                if (documento.doc_url) {
                    const a = document.createElement('a');
                    a.href = documento.doc_url;
                    a.target = '_blank';
                    a.className = 'documento-enlace';
                    a.textContent = 'Ver documento';
                    tdEnlace.appendChild(a);
                } else {
                    const span = document.createElement('span');
                    span.style.cssText = 'color: #6c757d; font-size: 11px;';
                    span.textContent = 'Sin enlace';
                    tdEnlace.appendChild(span);
                }
                
                tr.appendChild(tdEnlace);
                fragment.appendChild(tr);
            });
            
            tablaDocumentos.appendChild(fragment);
            document.getElementById('tablaDocumentosContainer').style.display = 'block';
        }

    // Modal Vincular Documento
        function abrirModalVincularDocumento() {
            const modalHtml = `
                <div class="modal fade" id="modalVincularDocumento" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Vincular Nuevo Documento</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="mensajeErrorVincularDocumento" class="alert alert-danger" style="display: none;"></div>
                                <div id="mensajeExitoVincularDocumento" class="alert alert-success" style="display: none;"></div>
                                
                                <div class="mb-3">
                                    <label for="editorDescripcionDocumento" class="form-label">Descripción del documento: <span class="text-danger">*</span></label>
                                    <div class="editor-container">
                                        <div class="editor-toolbar">
                                            <button type="button" class="toolbar-btn" onclick="formatTextDocumento('bold')" title="Negrita">
                                                <strong>B</strong>
                                            </button>
                                            <button type="button" class="toolbar-btn" onclick="formatTextDocumento('italic')" title="Cursiva">
                                                <em>I</em>
                                            </button>
                                            <button type="button" class="toolbar-btn" onclick="formatTextDocumento('underline')" title="Subrayado">
                                                <u>U</u>
                                            </button>
                                            <span class="toolbar-separator">|</span>
                                            <button type="button" class="toolbar-btn" onclick="formatTextDocumento('insertUnorderedList')" title="Lista">
                                                • Lista
                                            </button>
                                        </div>
                                        <div id="editorDescripcionDocumento" 
                                             contenteditable="true" 
                                             class="editor-content"
                                             placeholder="Describa el documento...">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="inputUrlDocumento" class="form-label">URL del documento: <span class="text-danger">*</span></label>
                                    <input type="url" id="inputUrlDocumento" class="form-control" placeholder="https://docs.google.com/...">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" onclick="guardarNuevoDocumento()">Guardar</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (!document.getElementById('modalVincularDocumento')) {
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalVincularDocumento'));
            modal.show();
        }


        function formatTextDocumento(command) {
            document.execCommand(command, false, null);
            document.getElementById('editorDescripcionDocumento').focus();
        }

        async function guardarNuevoDocumento() {
            const docDescription = document.getElementById('editorDescripcionDocumento').innerHTML.trim();
            const docUrl = document.getElementById('inputUrlDocumento').value.trim();
            
            if (!docDescription || docDescription === '<br>' || docDescription === '<div><br></div>') {
                mostrarErrorDocumento('La descripción del documento no puede estar vacía', 'VincularDocumento');
                return;
            }
            
            if (!docUrl) {
                mostrarErrorDocumento('La URL del documento no puede estar vacía', 'VincularDocumento');
                return;
            }
            
            try {
                new URL(docUrl);
            } catch (e) {
                mostrarErrorDocumento('La URL del documento no es válida', 'VincularDocumento');
                return;
            }
            
            try {
                // Obtener información del usuario actual
                const session = getStoredSession();
                let workerName = 'Usuario del sistema';
                
                if (session?.user?.user_display_name) {
                    workerName = session.user.user_display_name;
                } else if (session?.user?.user_name) {
                    workerName = session.user.user_name;
                }
                
                await supabaseRequest('/stm_docs', {
                    method: 'POST',
                    body: JSON.stringify({
                        student_id: studentIdActual,
                        doc_url: docUrl,
                        doc_description: docDescription,
                        worker_name: workerName
                    })
                });
                
                mostrarExitoDocumento('Documento vinculado exitosamente', 'VincularDocumento');
                
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('modalVincularDocumento')).hide();
                    cargarDocumentosEstudiante(studentIdActual);
                }, 2000);
                
            } catch (error) {
                console.error('Error vinculando documento:', error);
                mostrarErrorDocumento('Error al vincular el documento', 'VincularDocumento');
            }
        }

        // Funciones de mensajes para modales de documentos
        function mostrarErrorDocumento(mensaje, tipo) {
            const errorDiv = document.getElementById(`mensajeError${tipo}`);
            if (errorDiv) {
                errorDiv.textContent = mensaje;
                errorDiv.style.display = 'block';
                const exitoDiv = document.getElementById(`mensajeExito${tipo}`);
                if (exitoDiv) exitoDiv.style.display = 'none';
                
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }

        function mostrarExitoDocumento(mensaje, tipo) {
            const exitoDiv = document.getElementById(`mensajeExito${tipo}`);
            if (exitoDiv) {
                exitoDiv.textContent = mensaje;
                exitoDiv.style.display = 'block';
                const errorDiv = document.getElementById(`mensajeError${tipo}`);
                if (errorDiv) errorDiv.style.display = 'none';
                
                setTimeout(() => {
                    exitoDiv.style.display = 'none';
                }, 3000);
            }
        }
        

        
        // Función de utilidad para escapar HTML (conservada)
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // ==========================================
        // CORRECCIÓN 4: Función cargarTareasEstudiante mejorada
        // ==========================================
        async function cargarTareasEstudiante(studentId) {
            try {
                // Mostrar mensaje de carga
                document.getElementById('mensajeCargaTareas').style.display = 'block';
                document.getElementById('tablaTareasContainer').style.display = 'none';
                document.getElementById('noDataTareas').style.display = 'none';
                
                // LIMPIAR tabla antes de cargar
                document.getElementById('tablaTareas').innerHTML = '';
                
                // Query SIN relación de foreign key - usar solo assigned_to_name
                const tareas = await supabaseRequest(`/tasks?select=task_id,student_id,assigned_to_mail,assigned_to_name,due_date,task_description,task_progress,task_state&student_id=eq.${studentId}&task_state=in.(Asignada,En proceso)&order=due_date.asc`);
                
                // Ocultar mensaje de carga
                document.getElementById('mensajeCargaTareas').style.display = 'none';
                
                // Verificar si hay tareas
                if (tareas.length === 0) {
                    document.getElementById('noDataTareas').style.display = 'block';
                    return;
                }
                
                // Mostrar tareas
                mostrarTareas(tareas);
                
            } catch (error) {
                document.getElementById('mensajeCargaTareas').style.display = 'none';
                console.error('Error cargando tareas:', error);
                showMessage('Error al cargar las tareas', 'danger');
            }
        }

        
        // ==========================================
        // CORRECCIÓN 5: Función mostrarTareas sin duplicados
        // ==========================================
        function mostrarTareas(tareas) {
            const tablaTareas = document.getElementById('tablaTareas');
            
            // LIMPIAR tabla completamente primero
            tablaTareas.innerHTML = '';
            
            const fragment = document.createDocumentFragment();
            
            tareas.forEach(tarea => {
                // Usar SOLO assigned_to_name, sin intentar acceder a workers
                const nombreTrabajador = tarea.assigned_to_name || 'No especificado';
                
                const tr = document.createElement('tr');
                
                // Trabajador
                const tdTrabajador = document.createElement('td');
                tdTrabajador.className = 'trabajador-cell';
                tdTrabajador.textContent = nombreTrabajador;
                tr.appendChild(tdTrabajador);
                
                // Fecha
                const tdFecha = document.createElement('td');
                tdFecha.className = 'fecha-cell';
                tdFecha.textContent = formatDate(tarea.due_date);
                tr.appendChild(tdFecha);
                
                // Descripción
                const tdDescripcion = document.createElement('td');
                const divDescripcion = document.createElement('div');
                divDescripcion.className = 'asunto-description';
                divDescripcion.innerHTML = tarea.task_description || '';
                tdDescripcion.appendChild(divDescripcion);
                tr.appendChild(tdDescripcion);
                
                // Progreso
                const tdProgreso = document.createElement('td');
                const divProgreso = document.createElement('div');
                divProgreso.className = 'asunto-description';
                divProgreso.textContent = tarea.task_progress || 'Sin progreso registrado';
                tdProgreso.appendChild(divProgreso);
                tr.appendChild(tdProgreso);
                
                fragment.appendChild(tr);
            });
            
            tablaTareas.appendChild(fragment);
            document.getElementById('tablaTareasContainer').style.display = 'block';
        }

        // Modal Crear Tarea
        // ==========================================
        // CORRECCIÓN 7: Función abrirModalCrearTarea reescrita
        // ==========================================
        function abrirModalCrearTarea() {
            // LIMPIAR modal existente si lo hay
            const modalExistente = document.getElementById('modalCrearTarea');
            if (modalExistente) {
                if (modalCrearTareaInstance) {
                    modalCrearTareaInstance.dispose();
                    modalCrearTareaInstance = null;
                }
                modalExistente.remove();
            }
            
            const modalHtml = `
                <div class="modal fade" id="modalCrearTarea" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Crear Nueva Tarea</h5>
                                <button type="button" class="btn-close" onclick="cerrarModalCrearTarea()"></button>
                            </div>
                            <div class="modal-body">
                                <div id="mensajeErrorCrearTarea" class="alert alert-danger" style="display: none;"></div>
                                <div id="mensajeExitoCrearTarea" class="alert alert-success" style="display: none;"></div>
                                
                                <div class="mb-3">
                                    <label for="selectAsignadoA" class="form-label">Asignada a: <span class="text-danger">*</span></label>
                                    <select id="selectAsignadoA" class="form-select">
                                        <option value="">-- Seleccione un trabajador --</option>
                                    </select>
                                </div>
        
                                <div class="mb-3">
                                    <label for="editorDescripcionTarea" class="form-label">Descripción: <span class="text-danger">*</span></label>
                                    <div class="editor-container">
                                        <div class="editor-toolbar">
                                            <button type="button" class="toolbar-btn" onclick="formatTextTarea('bold')" title="Negrita">
                                                <strong>B</strong>
                                            </button>
                                            <button type="button" class="toolbar-btn" onclick="formatTextTarea('italic')" title="Cursiva">
                                                <em>I</em>
                                            </button>
                                            <button type="button" class="toolbar-btn" onclick="formatTextTarea('underline')" title="Subrayado">
                                                <u>U</u>
                                            </button>
                                            <span class="toolbar-separator">|</span>
                                            <button type="button" class="toolbar-btn" onclick="formatTextTarea('insertUnorderedList')" title="Lista">
                                                • Lista
                                            </button>
                                        </div>
                                        <div id="editorDescripcionTarea" 
                                             contenteditable="true" 
                                             class="editor-content"
                                             placeholder="Describa la tarea a realizar...">
                                        </div>
                                    </div>
                                </div>
        
                                <div class="mb-3">
                                    <label for="inputFechaLimite" class="form-label">Fecha límite: <span class="text-danger">*</span></label>
                                    <input type="date" id="inputFechaLimite" class="form-control">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" onclick="guardarNuevaTarea()">Guardar</button>
                                <button type="button" class="btn btn-secondary" onclick="cerrarModalCrearTarea()">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            modalCrearTareaInstance = new bootstrap.Modal(document.getElementById('modalCrearTarea'));
            modalCrearTareaInstance.show();
            
            cargarListaTrabajadores();
        }

        // ==========================================
        // CORRECCIÓN 8: Función para cerrar modal crear tarea
        // ==========================================
        function cerrarModalCrearTarea() {
            if (modalCrearTareaInstance) {
                modalCrearTareaInstance.hide();
                modalCrearTareaInstance.dispose();
                modalCrearTareaInstance = null;
            }
            
            const modalElement = document.getElementById('modalCrearTarea');
            if (modalElement) {
                modalElement.remove();
            }
        }
        
        function formatTextTarea(command) {
            document.execCommand(command, false, null);
            document.getElementById('editorDescripcionTarea').focus();
        }

        // ==========================================
        // CORRECCIÓN 11: Función cargarListaTrabajadores mejorada
        // ==========================================
        async function cargarListaTrabajadores() {
            try {
                const trabajadores = await supabaseRequest('/workers?select=worker_id,email,worker_first_name,worker_last_name_1&worker_status=eq.active&order=worker_first_name,worker_last_name_1');
                
                const select = document.getElementById('selectAsignadoA');
                
                // Limpiar opciones existentes excepto la primera
                select.innerHTML = '<option value="">-- Seleccione un trabajador --</option>';
                
                trabajadores.forEach(trabajador => {
                    const option = document.createElement('option');
                    option.value = trabajador.email;
                    option.textContent = `${trabajador.worker_first_name} ${trabajador.worker_last_name_1}`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error cargando trabajadores:', error);
                mostrarErrorTarea('Error al cargar lista de trabajadores', 'CrearTarea');
            }
        }

        // ==========================================
        // CORRECCIÓN 9: Función guardarNuevaTarea sin duplicados
        // ==========================================
        async function guardarNuevaTarea() {
            const assignedToMail = document.getElementById('selectAsignadoA').value;
            const description = document.getElementById('editorDescripcionTarea').innerHTML.trim();
            const dueDate = document.getElementById('inputFechaLimite').value;
            
            // Validaciones
            if (!assignedToMail) {
                mostrarErrorTarea('Debe seleccionar a quién asignar la tarea', 'CrearTarea');
                return;
            }
            
            if (!description || description === '<br>' || description === '<div><br></div>') {
                mostrarErrorTarea('La descripción de la tarea no puede estar vacía', 'CrearTarea');
                return;
            }
            
            if (!dueDate) {
                mostrarErrorTarea('Debe especificar una fecha límite', 'CrearTarea');
                return;
            }
            
            // Verificar que studentIdActual existe
            if (!studentIdActual) {
                mostrarErrorTarea('Error: No se ha identificado el estudiante', 'CrearTarea');
                return;
            }
            
            try {
                // Deshabilitar botón para evitar doble clic
                const btnGuardar = event.target;
                btnGuardar.disabled = true;
                btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
                
                // Obtener nombre del trabajador
                const trabajadorData = await supabaseRequest(`/workers?select=worker_first_name,worker_last_name_1&email=eq.${assignedToMail}&limit=1`);
                const assignedToName = trabajadorData.length > 0 ? 
                    `${trabajadorData[0].worker_first_name} ${trabajadorData[0].worker_last_name_1}` : 
                    'Trabajador';
                
                // Crear tarea - UNA SOLA VEZ
                const nuevaTarea = await supabaseRequest('/tasks', {
                    method: 'POST',
                    body: JSON.stringify({
                        student_id: studentIdActual,
                        assigned_to_mail: assignedToMail,
                        assigned_to_name: assignedToName,
                        due_date: dueDate,
                        task_description: description,
                        task_state: 'Asignada',
                        module_type: 'follow-ups'
                    })
                });
                
                console.log('Tarea creada:', nuevaTarea);
                
                // Enviar notificación (solo si el sistema está configurado)
                try {
                    const estudiante = estudiantesData.find(e => e.student_id === studentIdActual);
                    const studentName = estudiante ? 
                        `${estudiante.student_first_name} ${estudiante.student_last_name_1}` : 
                        'el estudiante';
                    
                    const asunto = `Te han asignado una nueva tarea asociada a ${studentName}`;
                    const contenido = `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                            <h3 style="color: #0d6efd;">Nueva Tarea Asignada</h3>
                            <p>Se te ha asignado la siguiente tarea relacionada con <strong>${studentName}</strong>:</p>
                            <div style="background-color: #f8f9fa; padding: 15px; border-left: 4px solid #0d6efd; margin: 20px 0;">
                                ${description}
                            </div>
                            <p><strong>Fecha límite:</strong> ${formatDate(dueDate)}</p>
                            <p style="font-size: 12px; color: #6c757d;">
                                Este es un correo generado automáticamente por SchoolNet. Por favor no responder.
                            </p>
                        </div>
                    `;
                    
                    await sendNotification(assignedToMail, asunto, contenido, true);
                } catch (emailError) {
                    console.log('Notificación no enviada (no crítico):', emailError);
                }
                
                mostrarExitoTarea('Tarea creada exitosamente', 'CrearTarea');
                
                // Esperar 1.5 segundos antes de cerrar
                setTimeout(() => {
                    cerrarModalCrearTarea();
                    // Recargar tareas del estudiante actual
                    if (studentIdActual) {
                        cargarTareasEstudiante(studentIdActual);
                    }
                }, 1500);
                
            } catch (error) {
                console.error('Error creando tarea:', error);
                mostrarErrorTarea('Error al crear la tarea: ' + error.message, 'CrearTarea');
                
                // Re-habilitar botón en caso de error
                const btnGuardar = event.target;
                if (btnGuardar) {
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = 'Guardar';
                }
            }
        }

        
        // Funciones de mensajes para modales de tareas
        function mostrarErrorTarea(mensaje, tipo) {
            const errorDiv = document.getElementById(`mensajeError${tipo}`);
            if (errorDiv) {
                errorDiv.textContent = mensaje;
                errorDiv.style.display = 'block';
                const exitoDiv = document.getElementById(`mensajeExito${tipo}`);
                if (exitoDiv) exitoDiv.style.display = 'none';
                
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }

        function mostrarExitoTarea(mensaje, tipo) {
            const exitoDiv = document.getElementById(`mensajeExito${tipo}`);
            if (exitoDiv) {
                exitoDiv.textContent = mensaje;
                exitoDiv.style.display = 'block';
                const errorDiv = document.getElementById(`mensajeError${tipo}`);
                if (errorDiv) errorDiv.style.display = 'none';
                
                setTimeout(() => {
                    exitoDiv.style.display = 'none';
                }, 3000);
            }
        }

        // ==========================================
        // CORRECCIÓN 12: Event listener para limpiar al cerrar modales
        // ==========================================
        
        document.addEventListener('hidden.bs.modal', function (event) {
            // Verificar qué modal se cerró y limpiar apropiadamente
            if (event.target.id === 'modalTareas') {
                if (modalTareasInstance) {
                    modalTareasInstance.dispose();
                    modalTareasInstance = null;
                }
                const modalElement = document.getElementById('modalTareas');
                if (modalElement) {
                    modalElement.remove();
                }
            }
            
            if (event.target.id === 'modalCrearTarea') {
                if (modalCrearTareaInstance) {
                    modalCrearTareaInstance.dispose();
                    modalCrearTareaInstance = null;
                }
                const modalElement = document.getElementById('modalCrearTarea');
                if (modalElement) {
                    modalElement.remove();
                }
            }
        });

        
    </script>
</body>
</html>
