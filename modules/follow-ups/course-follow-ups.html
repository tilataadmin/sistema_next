<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimientos por Cursos - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Estilos específicos para seguimientos por cursos */
        .students-table {
            margin-top: 20px;
        }
        
        .student-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #dee2e6;
        }
        
        .student-name {
            font-weight: 600;
            color: #1380e2;
        }
        
        .action-btn {
            padding: 6px 12px;
            margin: 2px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            min-width: 80px;
            text-align: center;
        }
        
        .btn-asuntos {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-tareas {
            background-color: #ffc107;
            color: #1380e2;
        }

        .btn-tareas:hover {
            background-color: #e0a800;
            color: #1380e2;
            opacity: 1;
        }
        
        .btn-documentos {
            background-color: #0dcaf0;
            color: white;
        }
        
        .btn-eae {
            background-color: #d63384;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .table-container {
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Modal grande para asuntos */
        .modal-large {
            max-width: 1400px;
            width: 95%;
        }

        /* Modal mediano para conclusiones y estrategias */
        .modal-medium {
            max-width: 800px;
            width: 90%;
        }

        /* Estilos para editor de texto enriquecido */
        .editor-container {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background-color: white;
        }

        .editor-toolbar {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
        }

        .toolbar-btn {
            background: none;
            border: 1px solid transparent;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            color: #1380e2;
            transition: all 0.3s;
        }

        .toolbar-btn:hover {
            background-color: white;
            border-color: #dee2e6;
        }

        .toolbar-btn:active {
            background-color: #6c757d;
            color: white;
        }

        .toolbar-separator {
            margin: 0 8px;
            color: #6c757d;
        }

        .editor-content {
            min-height: 200px;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            outline: none;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
        }

        .editor-content:empty:before {
            content: attr(placeholder);
            color: #6c757d;
            font-style: italic;
        }

        .editor-content:focus {
            box-shadow: inset 0 0 0 2px rgba(19, 128, 226, 0.1);
        }

        .editor-content p {
            margin: 0 0 8px 0;
        }

        .editor-content ul, .editor-content ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .editor-content li {
            margin: 4px 0;
        }

        .asunto-description {
            max-width: 300px;
            max-height: 80px;
            overflow-y: auto;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
        }

        .btn-action-small {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            white-space: nowrap;
        }

        .btn-conclusion {
            background-color: #ffc107;
            color: #1380e2;
        }

        .btn-conclusion:hover {
            background-color: #e0a800;
            color: #1380e2;
            opacity: 1;
        }

        .btn-estrategia {
            background-color: #0dcaf0;
            color: white;
        }

        .btn-action-small:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .categoria-cell {
            font-weight: 600;
            color: #1380e2;
        }

        .fecha-cell {
            font-size: 12px;
            color: #6c757d;
        }

        /* Estilos mejorados para descripción con texto enriquecido */
        .asunto-description-rich {
            max-width: 450px;
            max-height: 120px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .asunto-description-rich p {
            margin: 0 0 8px 0;
        }

        .asunto-description-rich ul, 
        .asunto-description-rich ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .asunto-description-rich li {
            margin: 4px 0;
        }

        .asunto-description-rich strong, 
        .asunto-description-rich b {
            font-weight: 600;
        }

        .asunto-description-rich em, 
        .asunto-description-rich i {
            font-style: italic;
        }

        .asunto-description-rich u {
            text-decoration: underline;
        }

        /* Ajustar anchos de columnas en la tabla de asuntos */
        .modal-large table th:nth-child(1) { width: 120px; }
        .modal-large table th:nth-child(2) { width: 100px; }
        .modal-large table th:nth-child(3) { width: 450px; }
        .modal-large table th:nth-child(4) { width: 120px; }
        .modal-large table th:nth-child(5) { width: 120px; }

        /* Estilos específicos para documentos */
        .documento-description {
            max-width: 400px;
            max-height: 60px;
            overflow-y: auto;
            padding: 6px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.3;
        }

        .documento-enlace {
            display: inline-block;
            padding: 4px 8px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .documento-enlace:hover {
            background-color: #1380e2;
            transform: translateY(-1px);
        }

        .trabajador-cell {
            font-weight: 500;
            color: #1380e2;
            font-size: 13px;
        }

        /* Spinner de carga */
        .loading-spinner {
            font-size: 10px;
            opacity: 0.7;
            animation: fadeInOut 1.5s infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.9; }
        }
    </style>
</head>
<body>
    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="../follow-ups/index.html">
                        Seguimientos
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Seguimientos por Cursos
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Seguimientos por Cursos
                </h1>
                <p class="text-muted">
                    Gestión integral de seguimientos para estudiantes por curso
                </p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Sección de selección de curso -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="selectCurso" class="form-label">Seleccione el curso:</label>
                        <select id="selectCurso" class="form-select" onchange="cargarEstudiantes()">
                            <option value="">-- Seleccione un curso --</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <div id="mensajePermisos" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje de carga -->
        <div id="mensajeCarga" class="alert alert-info" style="display: none;">
            <i class="bi bi-hourglass-split me-2"></i>Cargando estudiantes...
        </div>

        <!-- Tabla de estudiantes SIN COLUMNA METAS -->
        <div id="tablaContainer" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover students-table">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 80px;">Foto</th>
                                    <th>Nombre</th>
                                    <th style="width: 100px;">E.A.E</th>
                                    <th style="width: 100px;">Asuntos</th>
                                    <th style="width: 100px;">Tareas</th>
                                    <th style="width: 120px;">Documentos</th>
                                </tr>
                            </thead>
                            <tbody id="tablaEstudiantes">
                                <!-- Los estudiantes se cargarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje cuando no hay datos -->
        <div id="noData" class="no-data" style="display: none;">
            <div class="alert alert-warning">
                <i class="bi bi-info-circle me-2"></i>
                No se encontraron estudiantes para el curso seleccionado.
            </div>
        </div>
    </div>
    // Obtiene conteos de seguimientos para estudiantes - SIN METAS
        async function obtenerConteosEstudiantes(studentIds) {
            try {
                const conteos = {};
                
                // Inicializar conteos SIN METAS
                studentIds.forEach(id => {
                    conteos[id] = {
                        eae: 0,
                        asuntos: 0,
                        tareas: 0,
                        documentos: 0
                    };
                });
                
                // Conteo de asuntos EAE - CORREGIDO
                const eaeData = await supabaseRequest(`/stm_eae_topics?select=student_id&student_id=in.(${studentIds.join(',')})&is_open=eq.SI`);
                eaeData.forEach(item => {
                    if (conteos[item.student_id]) {
                        conteos[item.student_id].eae++;
                    }
                });
                
                // Conteo de asuntos individuales escalables - CORREGIDO
                const asuntosData = await supabaseRequest(`/stm_students_topics?select=student_id&student_id=in.(${studentIds.join(',')})&is_open=eq.SI&is_escalable=eq.SI`);
                asuntosData.forEach(item => {
                    if (conteos[item.student_id]) {
                        conteos[item.student_id].asuntos++;
                    }
                });
                
                // Conteo de tareas activas - CORREGIDO
                const tareasData = await supabaseRequest(`/tasks?select=student_id&student_id=in.(${studentIds.join(',')})&task_state=in.(Asignada,En proceso)`);
                tareasData.forEach(item => {
                    if (conteos[item.student_id]) {
                        conteos[item.student_id].tareas++;
                    }
                });
                
                // Conteo de documentos - CORREGIDO
                const docsData = await supabaseRequest(`/stm_docs?select=student_id&student_id=in.(${studentIds.join(',')})`);
                docsData.forEach(item => {
                    if (conteos[item.student_id]) {
                        conteos[item.student_id].documentos++;
                    }
                });
                
                return conteos;
                
            } catch (error) {
                console.error('Error obteniendo conteos:', error);
                return {};
            }
        }

        // Muestra estudiantes con sus conteos - SIN METAS
        async function mostrarEstudiantesConConteos(estudiantes, conteos) {
            const tablaContainer = document.getElementById('tablaContainer');
            const tablaEstudiantes = document.getElementById('tablaEstudiantes');
            
            const fragment = document.createDocumentFragment();
            
            for (const estudiante of estudiantes) {
                const nombreCompleto = `${estudiante.student_first_name} ${estudiante.student_last_name_1}`;
                const fotoUrl = await getStudentPhotoUrl(estudiante.student_code);
                
                const conteosEstudiante = conteos[estudiante.student_id] || {
                    eae: 0, asuntos: 0, tareas: 0, documentos: 0
                };
                
                const tr = document.createElement('tr');
                
                // Columna foto
                const tdFoto = document.createElement('td');
                if (fotoUrl) {
                    const img = document.createElement('img');
                    img.src = fotoUrl;
                    img.alt = `Foto de ${nombreCompleto}`;
                    img.className = 'student-photo';
                    img.onerror = function() {
                        this.style.display = 'none';
                        this.nextElementSibling.style.display = 'flex';
                    };
                    tdFoto.appendChild(img);
                }
                
                const divPlaceholder = document.createElement('div');
                divPlaceholder.style.cssText = 'display:none; width:50px; height:50px; border-radius:50%; background-color:#f8f9fa; border:2px solid #ddd; align-items:center; justify-content:center; font-size:20px; color:#6c757d;';
                divPlaceholder.innerHTML = '<i class="bi bi-person"></i>';
                tdFoto.appendChild(divPlaceholder);
                tr.appendChild(tdFoto);
                
                // Columna nombre
                const tdNombre = document.createElement('td');
                tdNombre.className = 'student-name';
                tdNombre.textContent = nombreCompleto;
                tr.appendChild(tdNombre);
                
                // Columnas de botones con conteos - SIN METAS
                const botones = [
                    { clase: 'btn-eae', texto: 'E.A.E', conteo: conteosEstudiante.eae, funcion: () => abrirEAE(estudiante.student_id) },
                    { clase: 'btn-asuntos', texto: 'Asuntos', conteo: conteosEstudiante.asuntos, funcion: () => abrirAsuntos(estudiante.student_id) },
                    { clase: 'btn-tareas', texto: 'Tareas', conteo: conteosEstudiante.tareas, funcion: () => abrirTareas(estudiante.student_id) },
                    { clase: 'btn-documentos', texto: 'Documentos', conteo: conteosEstudiante.documentos, funcion: () => abrirDocumentos(estudiante.student_id) }
                ];
                
                botones.forEach(boton => {
                    const td = document.createElement('td');
                    const btn = document.createElement('button');
                    btn.className = `action-btn ${boton.clase}`;
                    btn.textContent = boton.texto + (boton.conteo > 0 ? ` (${boton.conteo})` : '');
                    btn.onclick = boton.funcion;
                    td.appendChild(btn);
                    tr.appendChild(td);
                });
                
                fragment.appendChild(tr);
            }
            
            tablaEstudiantes.appendChild(fragment);
            tablaContainer.style.display = 'block';
        }

        async function cargarEstudiantes() {
            const selectCurso = document.getElementById('selectCurso');
            const courseId = selectCurso.value;
            
            limpiarTabla();
            
            if (!courseId) {
                return;
            }
            
            try {
                const mensajeCarga = document.getElementById('mensajeCarga');
                mensajeCarga.style.display = 'block';
                
                // Obtener estudiantes del curso - CORREGIDO
                const estudiantes = await supabaseRequest(`/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2&course_id=eq.${courseId}&order=student_first_name,student_last_name_1`);
                
                if (estudiantes.length === 0) {
                    mensajeCarga.style.display = 'none';
                    document.getElementById('noData').style.display = 'block';
                    return;
                }
                
                // Obtener conteos para todos los estudiantes
                const studentIds = estudiantes.map(e => e.student_id);
                const conteos = await obtenerConteosEstudiantes(studentIds);
                
                estudiantesData = estudiantes;
                mostrarEstudiantesConConteos(estudiantes, conteos);
                mensajeCarga.style.display = 'none';
                
            } catch (error) {
                console.error('Error cargando estudiantes:', error);
                document.getElementById('mensajeCarga').style.display = 'none';
                showMessage('Error al cargar los estudiantes del curso', 'danger');
            }
        }

        // Placeholder para otras funciones de modales - SIN abrirMetas
        function abrirEAE(studentId) {
            console.log('Abrir EAE para estudiante:', studentId);
            // Implementar modal EAE
        }

        function abrirTareas(studentId) {
            console.log('Abrir tareas para estudiante:', studentId);
            // Implementar modal tareas
        }

        function abrirDocumentos(studentId) {
            console.log('Abrir documentos para estudiante:', studentId);
            // Implementar modal documentos
        }
    // Modal de Tareas (SIN referencias a metas)
        function abrirTareas(studentId) {
            studentIdActual = studentId;
            const estudiante = estudiantesData.find(e => e.student_id === studentId);
            const nombreEstudiante = estudiante ? 
                `${estudiante.student_first_name} ${estudiante.student_last_name_1}` : 
                'Estudiante';
            
            const modalHtml = `
                <div class="modal fade" id="modalTareas" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Tareas de ${nombreEstudiante}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="mensajeCargaTareas" class="alert alert-info" style="display: none;">
                                    <i class="bi bi-hourglass-split me-2"></i>Cargando tareas...
                                </div>
                                
                                <div id="tablaTareasContainer" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 200px;">Asignada a</th>
                                                    <th style="width: 120px;">Fecha límite</th>
                                                    <th>Descripción</th>
                                                    <th>Progreso</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tablaTareas">
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="text-center mt-3">
                                        <button type="button" class="btn btn-primary" onclick="abrirModalCrearTarea()">
                                            <i class="bi bi-plus-circle me-1"></i>Crear tarea
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="noDataTareas" class="no-data" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        No se encontraron tareas asignadas o en proceso para este estudiante.
                                    </div>
                                    <div class="text-center mt-3">
                                        <button type="button" class="btn btn-primary" onclick="abrirModalCrearTarea()">
                                            <i class="bi bi-plus-circle me-1"></i>Crear tarea
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (!document.getElementById('modalTareas')) {
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalTareas'));
            modal.show();
            
            cargarTareasEstudiante(studentId);
        }

        async function cargarTareasEstudiante(studentId) {
            try {
                document.getElementById('mensajeCargaTareas').style.display = 'block';
                
                const tareas = await supabaseRequest(`/tasks?select=task_id,student_id,assigned_to_mail,assigned_to_name,due_date,task_description,task_progress,task_state,workers!inner(worker_first_name,worker_last_name_1)&student_id=eq.${studentId}&task_state=in.(Asignada,En proceso)&order=due_date.asc`);
                
                document.getElementById('mensajeCargaTareas').style.display = 'none';
                
                if (tareas.length === 0) {
                    document.getElementById('noDataTareas').style.display = 'block';
                    return;
                }
                
                mostrarTareas(tareas);
                
            } catch (error) {
                document.getElementById('mensajeCargaTareas').style.display = 'none';
                console.error('Error cargando tareas:', error);
                showMessage('Error al cargar las tareas', 'danger');
            }
        }

        function mostrarTareas(tareas) {
            const tablaTareas = document.getElementById('tablaTareas');
            const fragment = document.createDocumentFragment();
            
            tareas.forEach(tarea => {
                const nombreTrabajador = tarea.workers?.worker_first_name && tarea.workers?.worker_last_name_1 ? 
                    `${tarea.workers.worker_first_name} ${tarea.workers.worker_last_name_1}` : 
                    tarea.assigned_to_name || 'No especificado';
                
                const tr = document.createElement('tr');
                
                // Trabajador
                const tdTrabajador = document.createElement('td');
                tdTrabajador.className = 'trabajador-cell';
                tdTrabajador.textContent = nombreTrabajador;
                tr.appendChild(tdTrabajador);
                
                // Fecha
                const tdFecha = document.createElement('td');
                tdFecha.className = 'fecha-cell';
                tdFecha.textContent = formatDate(tarea.due_date);
                tr.appendChild(tdFecha);
                
                // Descripción
                const tdDescripcion = document.createElement('td');
                const divDescripcion = document.createElement('div');
                divDescripcion.className = 'asunto-description';
                divDescripcion.innerHTML = tarea.task_description || '';
                tdDescripcion.appendChild(divDescripcion);
                tr.appendChild(tdDescripcion);
                
                // Progreso
                const tdProgreso = document.createElement('td');
                const divProgreso = document.createElement('div');
                divProgreso.className = 'asunto-description';
                divProgreso.textContent = tarea.task_progress || 'Sin progreso registrado';
                tdProgreso.appendChild(divProgreso);
                tr.appendChild(tdProgreso);
                
                fragment.appendChild(tr);
            });
            
            tablaTareas.appendChild(fragment);
            document.getElementById('tablaTareasContainer').style.display = 'block';
        }

        // Modal Crear Tarea (sin referencias a metas)
        function abrirModalCrearTarea() {
            const modalHtml = `
                <div class="modal fade" id="modalCrearTarea" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Crear Nueva Tarea</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="mensajeErrorCrearTarea" class="alert alert-danger" style="display: none;"></div>
                                <div id="mensajeExitoCrearTarea" class="alert alert-success" style="display: none;"></div>
                                
                                <div class="mb-3">
                                    <label for="selectAsignadoA" class="form-label">Asignada a: <span class="text-danger">*</span></label>
                                    <select id="selectAsignadoA" class="form-select">
                                        <option value="">-- Seleccione un trabajador --</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="editorDescripcionTarea" class="form-label">Descripción: <span class="text-danger">*</span></label>
                                    <div class="editor-container">
                                        <div class="editor-toolbar">
                                            <button type="button" class="toolbar-btn" onclick="formatTextTarea('bold')" title="Negrita">
                                                <strong>B</strong>
                                            </button>
                                            <button type="button" class="toolbar-btn" onclick="formatTextTarea('italic')" title="Cursiva">
                                                <em>I</em>
                                            </button>
                                            <button type="button" class="toolbar-btn" onclick="formatTextTarea('underline')" title="Subrayado">
                                                <u>U</u>
                                            </button>
                                            <span class="toolbar-separator">|</span>
                                            <button type="button" class="toolbar-btn" onclick="formatTextTarea('insertUnorderedList')" title="Lista">
                                                • Lista
                                            </button>
                                        </div>
                                        <div id="editorDescripcionTarea" 
                                             contenteditable="true" 
                                             class="editor-content"
                                             placeholder="Describa la tarea a realizar...">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="inputFechaLimite" class="form-label">Fecha límite: <span class="text-danger">*</span></label>
                                    <input type="date" id="inputFechaLimite" class="form-control">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" onclick="guardarNuevaTarea()">Guardar</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (!document.getElementById('modalCrearTarea')) {
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalCrearTarea'));
            modal.show();
            
            cargarListaTrabajadores();
        }

        function formatTextTarea(command) {
            document.execCommand(command, false, null);
            document.getElementById('editorDescripcionTarea').focus();
        }

        async function cargarListaTrabajadores() {
            try {
                const trabajadores = await supabaseRequest('/workers?select=worker_id,email,worker_first_name,worker_last_name_1&worker_status=eq.active&order=worker_first_name,worker_last_name_1');
                
                const select = document.getElementById('selectAsignadoA');
                
                trabajadores.forEach(trabajador => {
                    const option = document.createElement('option');
                    option.value = trabajador.email;
                    option.textContent = `${trabajador.worker_first_name} ${trabajador.worker_last_name_1}`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error cargando trabajadores:', error);
                mostrarError('Error al cargar lista de trabajadores', 'CrearTarea');
            }
        }

        async function guardarNuevaTarea() {
            const assignedToMail = document.getElementById('selectAsignadoA').value;
            const description = document.getElementById('editorDescripcionTarea').innerHTML.trim();
            const dueDate = document.getElementById('inputFechaLimite').value;
            
            if (!assignedToMail) {
                mostrarError('Debe seleccionar a quién asignar la tarea', 'CrearTarea');
                return;
            }
            
            if (!description || description === '<br>' || description === '<div><br></div>') {
                mostrarError('La descripción de la tarea no puede estar vacía', 'CrearTarea');
                return;
            }
            
            if (!dueDate) {
                mostrarError('Debe especificar una fecha límite', 'CrearTarea');
                return;
            }
            
            try {
                // Obtener nombre del trabajador
                const trabajadorData = await supabaseRequest(`/workers?select=worker_first_name,worker_last_name_1&email=eq.${assignedToMail}&limit=1`);
                const assignedToName = trabajadorData.length > 0 ? 
                    `${trabajadorData[0].worker_first_name} ${trabajadorData[0].worker_last_name_1}` : 
                    'Trabajador';
                
                // Crear tarea
                await supabaseRequest('/tasks', {
                    method: 'POST',
                    body: JSON.stringify({
                        student_id: studentIdActual,
                        assigned_to_mail: assignedToMail,
                        assigned_to_name: assignedToName,
                        due_date: dueDate,
                        task_description: description,
                        task_state: 'Asignada'
                    })
                });
                
                // Enviar notificación (opcional - depende de si el sistema de notificaciones está configurado)
                const estudiante = estudiantesData.find(e => e.student_id === studentIdActual);
                const studentName = estudiante ? 
                    `${estudiante.student_first_name} ${estudiante.student_last_name_1}` : 
                    'el estudiante';
                
                const asunto = `Te han asignado una nueva tarea asociada a ${studentName}`;
                const contenido = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <h3 style="color: #0d6efd;">Nueva Tarea Asignada</h3>
                        <p>Se te ha asignado la siguiente tarea relacionada con <strong>${studentName}</strong>:</p>
                        <div style="background-color: #f8f9fa; padding: 15px; border-left: 4px solid #0d6efd; margin: 20px 0;">
                            ${description}
                        </div>
                        <p><strong>Fecha límite:</strong> ${formatDate(dueDate)}</p>
                        <p style="font-size: 12px; color: #6c757d;">
                            Este es un correo generado automáticamente por SchoolNet. Por favor no responder.
                        </p>
                    </div>
                `;
                
                try {
                    await sendNotification(assignedToMail, asunto, contenido, true);
                } catch (emailError) {
                    console.log('Error enviando notificación (no crítico):', emailError);
                }
                
                mostrarExito('Tarea creada exitosamente', 'CrearTarea');
                
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('modalCrearTarea')).hide();
                    cargarTareasEstudiante(studentIdActual);
                }, 2000);
                
            } catch (error) {
                console.error('Error creando tarea:', error);
                mostrarError('Error al crear la tarea', 'CrearTarea');
            }
        }
    // Modal de Documentos (sin cambios - ya no referenciaba metas)
        function abrirDocumentos(studentId) {
            studentIdActual = studentId;
            const estudiante = estudiantesData.find(e => e.student_id === studentId);
            const nombreEstudiante = estudiante ? 
                `${estudiante.student_first_name} ${estudiante.student_last_name_1}` : 
                'Estudiante';
            
            const modalHtml = `
                <div class="modal fade" id="modalDocumentos" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Documentos de ${nombreEstudiante}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="mensajeCargaDocumentos" class="alert alert-info" style="display: none;">
                                    <i class="bi bi-hourglass-split me-2"></i>Cargando documentos...
                                </div>
                                
                                <div id="tablaDocumentosContainer" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 200px;">Suministrado por</th>
                                                    <th>Descripción</th>
                                                    <th style="width: 120px;">Enlace</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tablaDocumentos">
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="text-center mt-3">
                                        <button type="button" class="btn btn-primary" onclick="abrirModalVincularDocumento()">
                                            <i class="bi bi-plus-circle me-1"></i>Vincular documento
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="noDataDocumentos" class="no-data" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        No se encontraron documentos vinculados para este estudiante.
                                    </div>
                                    <div class="text-center mt-3">
                                        <button type="button" class="btn btn-primary" onclick="abrirModalVincularDocumento()">
                                            <i class="bi bi-plus-circle me-1"></i>Vincular documento
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (!document.getElementById('modalDocumentos')) {
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalDocumentos'));
            modal.show();
            
            cargarDocumentosEstudiante(studentId);
        }

        async function cargarDocumentosEstudiante(studentId) {
            try {
                document.getElementById('mensajeCargaDocumentos').style.display = 'block';
                
                const documentos = await supabaseRequest(`/stm_docs?select=doc_id,student_id,doc_url,doc_description,worker_name,private&student_id=eq.${studentId}&order=doc_id.desc`);
                
                document.getElementById('mensajeCargaDocumentos').style.display = 'none';
                
                if (documentos.length === 0) {
                    document.getElementById('noDataDocumentos').style.display = 'block';
                    return;
                }
                
                mostrarDocumentos(documentos);
                
            } catch (error) {
                document.getElementById('mensajeCargaDocumentos').style.display = 'none';
                console.error('Error cargando documentos:', error);
                showMessage('Error al cargar los documentos', 'danger');
            }
        }

        function mostrarDocumentos(documentos) {
            const tablaDocumentos = document.getElementById('tablaDocumentos');
            const fragment = document.createDocumentFragment();
            
            documentos.forEach(documento => {
                const tr = document.createElement('tr');
                
                // Trabajador
                const tdTrabajador = document.createElement('td');
                tdTrabajador.className = 'trabajador-cell';
                tdTrabajador.textContent = documento.worker_name || 'No especificado';
                tr.appendChild(tdTrabajador);
                
                // Descripción
                const tdDescripcion = document.createElement('td');
                const divDescripcion = document.createElement('div');
                divDescripcion.className = 'documento-description';
                
                let descripcionCompleta = documento.doc_description || '';
                if (documento.private === 'SI') {
                    descripcionCompleta += '\n\nDocumento privado EAE';
                }
                divDescripcion.innerHTML = descripcionCompleta.replace(/\n/g, '<br>');
                tdDescripcion.appendChild(divDescripcion);
                tr.appendChild(tdDescripcion);
                
                // Enlace
                const tdEnlace = document.createElement('td');
                tdEnlace.style.textAlign = 'center';
                
                if (documento.doc_url) {
                    const a = document.createElement('a');
                    a.href = documento.doc_url;
                    a.target = '_blank';
                    a.className = 'documento-enlace';
                    a.textContent = 'Ver documento';
                    tdEnlace.appendChild(a);
                } else {
                    const span = document.createElement('span');
                    span.style.cssText = 'color: #6c757d; font-size: 11px;';
                    span.textContent = 'Sin enlace';
                    tdEnlace.appendChild(span);
                }
                
                tr.appendChild(tdEnlace);
                fragment.appendChild(tr);
            });
            
            tablaDocumentos.appendChild(fragment);
            document.getElementById('tablaDocumentosContainer').style.display = 'block';
        }

        // Modal Vincular Documento
        function abrirModalVincularDocumento() {
            const modalHtml = `
                <div class="modal fade" id="modalVincularDocumento" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Vincular Nuevo Documento</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="mensajeErrorVincularDocumento" class="alert alert-danger" style="display: none;"></div>
                                <div id="mensajeExitoVincularDocumento" class="alert alert-success" style="display: none;"></div>
                                
                                <div class="mb-3">
                                    <label for="editorDescripcionDocumento" class="form-label">Descripción del documento: <span class="text-danger">*</span></label>
                                    <div class="editor-container">
                                        <div class="editor-toolbar">
                                            <button type="button" class="toolbar-btn" onclick="formatTextDocumento('bold')" title="Negrita">
                                                <strong>B</strong>
                                            </button>
                                            <button type="button" class="toolbar-btn" onclick="formatTextDocumento('italic')" title="Cursiva">
                                                <em>I</em>
                                            </button>
                                            <button type="button" class="toolbar-btn" onclick="formatTextDocumento('underline')" title="Subrayado">
                                                <u>U</u>
                                            </button>
                                            <span class="toolbar-separator">|</span>
                                            <button type="button" class="toolbar-btn" onclick="formatTextDocumento('insertUnorderedList')" title="Lista">
                                                • Lista
                                            </button>
                                        </div>
                                        <div id="editorDescripcionDocumento" 
                                             contenteditable="true" 
                                             class="editor-content"
                                             placeholder="Describa el documento...">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="inputUrlDocumento" class="form-label">URL del documento: <span class="text-danger">*</span></label>
                                    <input type="url" id="inputUrlDocumento" class="form-control" placeholder="https://docs.google.com/...">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" onclick="guardarNuevoDocumento()">Guardar</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (!document.getElementById('modalVincularDocumento')) {
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalVincularDocumento'));
            modal.show();
        }

        function formatTextDocumento(command) {
            document.execCommand(command, false, null);
            document.getElementById('editorDescripcionDocumento').focus();
        }

        async function guardarNuevoDocumento() {
            const docDescription = document.getElementById('editorDescripcionDocumento').innerHTML.trim();
            const docUrl = document.getElementById('inputUrlDocumento').value.trim();
            
            if (!docDescription || docDescription === '<br>' || docDescription === '<div><br></div>') {
                mostrarError('La descripción del documento no puede estar vacía', 'VincularDocumento');
                return;
            }
            
            if (!docUrl) {
                mostrarError('La URL del documento no puede estar vacía', 'VincularDocumento');
                return;
            }
            
            try {
                new URL(docUrl);
            } catch (e) {
                mostrarError('La URL del documento no es válida', 'VincularDocumento');
                return;
            }
            
            try {
                // Obtener información del usuario actual
                const session = getStoredSession();
                let workerName = 'Usuario del sistema';
                
                if (session?.user?.user_display_name) {
                    workerName = session.user.user_display_name;
                } else if (session?.user?.user_name) {
                    workerName = session.user.user_name;
                }
                
                await supabaseRequest('/stm_docs', {
                    method: 'POST',
                    body: JSON.stringify({
                        student_id: studentIdActual,
                        doc_url: docUrl,
                        doc_description: docDescription,
                        worker_name: workerName
                    })
                });
                
                mostrarExito('Documento vinculado exitosamente', 'VincularDocumento');
                
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('modalVincularDocumento')).hide();
                    cargarDocumentosEstudiante(studentIdActual);
                }, 2000);
                
            } catch (error) {
                console.error('Error vinculando documento:', error);
                mostrarError('Error al vincular el documento', 'VincularDocumento');
            }
        }

        // Funciones para guardar conclusión y estrategia (actualizada para manejar EAE)
        async function guardarConclusion() {
            const editor = document.getElementById('editorConclusion');
            const conclusion = editor.innerHTML.trim();
            
            if (!conclusion || conclusion === '<br>' || conclusion === '<div><br></div>') {
                mostrarError('La conclusión no puede estar vacía', 'Conclusion');
                return;
            }
            
            try {
                if (eaeTopicIdActual) {
                    // Es un asunto EAE
                    await supabaseRequest(`/stm_eae_topics?eae_topic_id=eq.${eaeTopicIdActual}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ topic_conclusion: conclusion })
                    });
                } else if (topicIdActual) {
                    // Es un asunto regular
                    await supabaseRequest(`/stm_students_topics?topic_id=eq.${topicIdActual}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ topic_conclusion: conclusion })
                    });
                } else {
                    throw new Error('No se ha seleccionado un asunto válido');
                }
                
                mostrarExito('Conclusión guardada exitosamente', 'Conclusion');
                
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('modalConclusion')).hide();
                    if (studentIdActual) {
                        if (eaeTopicIdActual) {
                            cargarAsuntosEAE(studentIdActual);
                        } else {
                            cargarAsuntosEstudiante(studentIdActual);
                        }
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Error guardando conclusión:', error);
                mostrarError('Error al guardar la conclusión', 'Conclusion');
            }
        }

        async function guardarEstrategia() {
            const editor = document.getElementById('editorEstrategia');
            const estrategia = editor.innerHTML.trim();
            
            if (!estrategia || estrategia === '<br>' || estrategia === '<div><br></div>') {
                mostrarError('La estrategia no puede estar vacía', 'Estrategia');
                return;
            }
            
            try {
                if (eaeTopicIdActual) {
                    // Es un asunto EAE
                    await supabaseRequest(`/stm_eae_topics?eae_topic_id=eq.${eaeTopicIdActual}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ topic_strategy: estrategia })
                    });
                } else if (topicIdActual) {
                    // Es un asunto regular
                    await supabaseRequest(`/stm_students_topics?topic_id=eq.${topicIdActual}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ topic_strategy: estrategia })
                    });
                } else {
                    throw new Error('No se ha seleccionado un asunto válido');
                }
                
                mostrarExito('Estrategia guardada exitosamente', 'Estrategia');
                
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('modalEstrategia')).hide();
                    if (studentIdActual) {
                        if (eaeTopicIdActual) {
                            cargarAsuntosEAE(studentIdActual);
                        } else {
                            cargarAsuntosEstudiante(studentIdActual);
                        }
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Error guardando estrategia:', error);
                mostrarError('Error al guardar la estrategia', 'Estrategia');
            }
        }

        // Función de utilidad para escapar HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

    </script>
</body>
</html>
