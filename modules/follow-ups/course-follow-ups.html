<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimientos por Cursos - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Estilos específicos para seguimientos por cursos */
        .students-table {
            margin-top: 20px;
        }
        
        .student-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #dee2e6;
        }
        
        .student-name {
            font-weight: 600;
            color: #1380e2;
        }
        
        .action-btn {
            padding: 6px 12px;
            margin: 2px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            min-width: 80px;
            text-align: center;
        }
        
        .btn-asuntos {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-tareas {
            background-color: #ffc107;
            color: #1380e2;
        }

        .btn-tareas:hover {
            background-color: #e0a800;
            color: #1380e2;
            opacity: 1;
        }
        
        .btn-documentos {
            background-color: #0dcaf0;
            color: white;
        }
        
        .btn-eae {
            background-color: #d63384;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .table-container {
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Modal grande para asuntos */
        .modal-large {
            max-width: 1400px;
            width: 95%;
        }

        /* Modal mediano para conclusiones y estrategias */
        .modal-medium {
            max-width: 800px;
            width: 90%;
        }

        /* Estilos para editor de texto enriquecido */
        .editor-container {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background-color: white;
        }

        .editor-toolbar {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
        }

        .toolbar-btn {
            background: none;
            border: 1px solid transparent;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            color: #1380e2;
            transition: all 0.3s;
        }

        .toolbar-btn:hover {
            background-color: white;
            border-color: #dee2e6;
        }

        .toolbar-btn:active {
            background-color: #6c757d;
            color: white;
        }

        .toolbar-separator {
            margin: 0 8px;
            color: #6c757d;
        }

        .editor-content {
            min-height: 200px;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            outline: none;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
        }

        .editor-content:empty:before {
            content: attr(placeholder);
            color: #6c757d;
            font-style: italic;
        }

        .editor-content:focus {
            box-shadow: inset 0 0 0 2px rgba(19, 128, 226, 0.1);
        }

        .editor-content p {
            margin: 0 0 8px 0;
        }

        .editor-content ul, .editor-content ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .editor-content li {
            margin: 4px 0;
        }

        .asunto-description {
            max-width: 300px;
            max-height: 80px;
            overflow-y: auto;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
        }

        .btn-action-small {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            white-space: nowrap;
        }

        .btn-conclusion {
            background-color: #ffc107;
            color: #1380e2;
        }

        .btn-conclusion:hover {
            background-color: #e0a800;
            color: #1380e2;
            opacity: 1;
        }

        .btn-estrategia {
            background-color: #0dcaf0;
            color: white;
        }

        .btn-action-small:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .categoria-cell {
            font-weight: 600;
            color: #1380e2;
        }

        .fecha-cell {
            font-size: 12px;
            color: #6c757d;
        }

        /* Estilos mejorados para descripción con texto enriquecido */
        .asunto-description-rich {
            max-width: 450px;
            max-height: 120px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .asunto-description-rich p {
            margin: 0 0 8px 0;
        }

        .asunto-description-rich ul, 
        .asunto-description-rich ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .asunto-description-rich li {
            margin: 4px 0;
        }

        .asunto-description-rich strong, 
        .asunto-description-rich b {
            font-weight: 600;
        }

        .asunto-description-rich em, 
        .asunto-description-rich i {
            font-style: italic;
        }

        .asunto-description-rich u {
            text-decoration: underline;
        }

        /* Actualizar anchos de columnas en la tabla de asuntos SIN CONCLUSIÓN */

        .modal-large table th:nth-child(1) { width: 150px; } /* Categoría */
        .modal-large table th:nth-child(2) { width: 120px; } /* Fecha */
        .modal-large table th:nth-child(3) { width: auto; } 

        
        /* Estilos específicos para documentos */
        .documento-description {
            max-width: 400px;
            max-height: 60px;
            overflow-y: auto;
            padding: 6px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.3;
        }

        .documento-enlace {
            display: inline-block;
            padding: 4px 8px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .documento-enlace:hover {
            background-color: #1380e2;
            transform: translateY(-1px);
        }

        .trabajador-cell {
            font-weight: 500;
            color: #1380e2;
            font-size: 13px;
        }

        /* Spinner de carga */
        .loading-spinner {
            font-size: 10px;
            opacity: 0.7;
            animation: fadeInOut 1.5s infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.9; }
        }
    </style>
</head>
<body>
    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="../follow-ups/index.html">
                        Seguimientos
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Seguimientos por Cursos
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Seguimientos por Cursos
                </h1>
                <p class="text-muted">
                    Gestión integral de seguimientos para estudiantes por curso
                </p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Sección de selección de curso -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="selectCurso" class="form-label">Seleccione el curso:</label>
                        <select id="selectCurso" class="form-select" onchange="cargarEstudiantes()">
                            <option value="">-- Seleccione un curso --</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <div id="mensajePermisos" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje de carga -->
        <div id="mensajeCarga" class="alert alert-info" style="display: none;">
            <i class="bi bi-hourglass-split me-2"></i>Cargando estudiantes...
        </div>

        <!-- Tabla de estudiantes SIN COLUMNA METAS -->
        <div id="tablaContainer" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover students-table">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 80px;">Foto</th>
                                    <th>Nombre</th>
                                    <th style="width: 100px;">E.A.E</th>
                                    <th style="width: 100px;">Asuntos</th>
                                    <th style="width: 100px;">Tareas</th>
                                    <th style="width: 120px;">Documentos</th>
                                </tr>
                            </thead>
                            <tbody id="tablaEstudiantes">
                                <!-- Los estudiantes se cargarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje cuando no hay datos -->
        <div id="noData" class="no-data" style="display: none;">
            <div class="alert alert-warning">
                <i class="bi bi-info-circle me-2"></i>
                No se encontraron estudiantes para el curso seleccionado.
            </div>
        </div>
    </div>

    <!-- Modales incluidos aquí -->
    <!-- Modal de Asuntos ACTUALIZADO - Sin columna Conclusión -->
    <!-- Modal de Asuntos SOLO LECTURA - Sin botones de acción -->
<div class="modal fade" id="modalAsuntos" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tituloModalAsuntos">Asuntos del Estudiante</h5>
                <button type="button" class="btn-close" onclick="cerrarModalAsuntos()"></button>
            </div>
            <div class="modal-body">
                <!-- Mensaje de carga para asuntos -->
                <div id="mensajeCargaAsuntos" class="alert alert-info" style="display: none;">
                    <i class="bi bi-hourglass-split me-2"></i>Cargando asuntos del estudiante...
                </div>

                <!-- Tabla de asuntos SOLO LECTURA - 3 columnas -->
                <div id="tablaAsuntosContainer" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 150px;">Categoría</th>
                                    <th style="width: 120px;">Fecha</th>
                                    <th>Descripción</th>
                                </tr>
                            </thead>
                            <tbody id="tablaAsuntos">
                                <!-- Los asuntos se cargarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Mensaje cuando no hay asuntos -->
                <div id="noDataAsuntos" class="no-data" style="display: none;">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No se encontraron asuntos escalables y abiertos para este estudiante.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalAsuntos()">Cerrar</button>
            </div>
        </div>
    </div>
</div>
    
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Config JS -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // Variables globales
        let estudiantesData = [];
        let studentIdActual = null;
        let topicIdActual = null;
        let eaeTopicIdActual = null;

        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            await validatePageAccess('Seguimientos por cursos');
            initializePage('courseFollowUps', 'Seguimientos');
            await cargarConfiguracionInicial();
        });

        // Carga configuración inicial
        async function cargarConfiguracionInicial() {
            try {
                showMessage('Cargando configuración...', 'info');
                await cargarCursosPermitidos();
                closeAlert('alert_' + Date.now());
            } catch (error) {
                console.error('Error cargando configuración:', error);
                showMessage('Error al cargar la configuración inicial', 'danger');
            }
        }
        // Carga cursos permitidos según permisos del usuario
        async function cargarCursosPermitidos() {
            try {
                const session = getStoredSession();
                if (!session || !session.user) {
                    showMessage('Sesión no válida', 'danger');
                    return;
                }
        
                // Buscar trabajador por email
                const workerData = await supabaseRequest(`/workers?select=worker_id,email,section_id&email=eq.${session.user.user_mail}`);
                
                if (workerData.length === 0) {
                    mostrarSinPermisos('Usuario no encontrado en el sistema');
                    return;
                }
                
                const worker = workerData[0];
                
                // Verificar si es director de curso
                const cursosDirector = await supabaseRequest(`/courses?select=course_id,course_name&course_director_email=eq.${session.user.user_mail}`);
                
                // Si es director de curso, mostrar sus cursos
                if (cursosDirector.length > 0) {
                    llenarSelectCursos(cursosDirector, `Sus cursos: ${cursosDirector.length} curso(s)`);
                    return;
                }
                
                // Verificar si es director de sección
                const seccionData = await supabaseRequest(`/sections?select=section_id,section_name&director_email=eq.${session.user.user_mail}`);
                
                if (seccionData.length > 0) {
                    // Obtener todos los cursos de la sección
                    const cursosSeccion = await supabaseRequest(`/courses?select=course_id,course_name,course_order,grades!inner(section_id)&grades.section_id=eq.${seccionData[0].section_id}&order=course_order.asc`);
                    llenarSelectCursos(cursosSeccion, `Cursos de la sección: ${seccionData[0].section_name}`);
                    return;
                }
                
                // Si no es director, verificar si es super admin
                const hasPermission = await checkUserPermission(session.user.user_id, 'Seguimientos por cursos');
                
                if (hasPermission) {
                    // Es super admin, puede ver todos los cursos
                    const todosCursos = await supabaseRequest('/courses?select=course_id,course_name,course_order&order=course_order.asc');
                    llenarSelectCursos(todosCursos, 'Todos los cursos (Admin)');
                    return;
                }
                
                // Sin permisos
                mostrarSinPermisos('No tiene cursos a su cargo');
                
            } catch (error) {
                console.error('Error cargando cursos:', error);
                showMessage('Error al cargar los cursos disponibles', 'danger');
            }
        }

        function mostrarSinPermisos(mensaje) {
            const selectCurso = document.getElementById('selectCurso');
            const mensajePermisos = document.getElementById('mensajePermisos');
            
            selectCurso.disabled = true;
            selectCurso.innerHTML = '<option value="">No tiene cursos disponibles</option>';
            
            mensajePermisos.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>${mensaje}
                </div>
            `;
            mensajePermisos.style.display = 'block';
        }
        
        function llenarSelectCursos(cursos, mensaje) {
            const selectCurso = document.getElementById('selectCurso');
            const mensajePermisos = document.getElementById('mensajePermisos');
            
            cursos.forEach(curso => {
                const option = document.createElement('option');
                option.value = curso.course_id;
                option.textContent = curso.course_name;
                selectCurso.appendChild(option);
            });
            
            if (mensaje) {
                mensajePermisos.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>${mensaje}
                    </div>
                `;
                mensajePermisos.style.display = 'block';
            }
        }

        // Obtiene conteos de seguimientos para estudiantes - SIN METAS
        async function obtenerConteosEstudiantes(studentIds) {
            try {
                const conteos = {};
                
                // Inicializar conteos SIN METAS
                studentIds.forEach(id => {
                    conteos[id] = {
                        eae: 0,
                        asuntos: 0,
                        tareas: 0,
                        documentos: 0
                    };
                });
                
                // Conteo de asuntos EAE - CORREGIDO
                const eaeData = await supabaseRequest(`/stm_eae_topics?select=student_id&student_id=in.(${studentIds.join(',')})&is_open=eq.SI`);
                eaeData.forEach(item => {
                    if (conteos[item.student_id]) {
                        conteos[item.student_id].eae++;
                    }
                });
                
                // Conteo de asuntos individuales escalables - CORREGIDO
                const asuntosData = await supabaseRequest(`/stm_students_topics?select=student_id&student_id=in.(${studentIds.join(',')})&is_open=eq.SI&is_escalable=eq.SI`);
                asuntosData.forEach(item => {
                    if (conteos[item.student_id]) {
                        conteos[item.student_id].asuntos++;
                    }
                });
                
                // Conteo de tareas activas - CORREGIDO
                const tareasData = await supabaseRequest(`/tasks?select=student_id&student_id=in.(${studentIds.join(',')})&task_state=in.(Asignada,En proceso)`);
                tareasData.forEach(item => {
                    if (conteos[item.student_id]) {
                        conteos[item.student_id].tareas++;
                    }
                });
                
                // Conteo de documentos - CORREGIDO
                const docsData = await supabaseRequest(`/stm_docs?select=student_id&student_id=in.(${studentIds.join(',')})`);
                docsData.forEach(item => {
                    if (conteos[item.student_id]) {
                        conteos[item.student_id].documentos++;
                    }
                });
                
                return conteos;
                
            } catch (error) {
                console.error('Error obteniendo conteos:', error);
                return {};
            }
        }

        async function cargarEstudiantes() {
            const selectCurso = document.getElementById('selectCurso');
            const courseId = selectCurso.value;
            
            limpiarTabla();
            
            if (!courseId) {
                return;
            }
            
            try {
                const mensajeCarga = document.getElementById('mensajeCarga');
                mensajeCarga.style.display = 'block';
                
                // Obtener estudiantes del curso - CORREGIDO
                const estudiantes = await supabaseRequest(`/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2&course_id=eq.${courseId}&order=student_first_name,student_last_name_1`);
                
                if (estudiantes.length === 0) {
                    mensajeCarga.style.display = 'none';
                    document.getElementById('noData').style.display = 'block';
                    return;
                }
                
                // Obtener conteos para todos los estudiantes
                const studentIds = estudiantes.map(e => e.student_id);
                const conteos = await obtenerConteosEstudiantes(studentIds);
                
                estudiantesData = estudiantes;
                mostrarEstudiantesConConteos(estudiantes, conteos);
                mensajeCarga.style.display = 'none';
                
            } catch (error) {
                console.error('Error cargando estudiantes:', error);
                document.getElementById('mensajeCarga').style.display = 'none';
                showMessage('Error al cargar los estudiantes del curso', 'danger');
            }
        }

        // Limpia la tabla de estudiantes
        function limpiarTabla() {
            document.getElementById('tablaContainer').style.display = 'none';
            document.getElementById('noData').style.display = 'none';
            document.getElementById('tablaEstudiantes').innerHTML = '';
        }

        // Muestra estudiantes con sus conteos - SIN METAS
        async function mostrarEstudiantesConConteos(estudiantes, conteos) {
            const tablaContainer = document.getElementById('tablaContainer');
            const tablaEstudiantes = document.getElementById('tablaEstudiantes');
            
            const fragment = document.createDocumentFragment();
            
            for (const estudiante of estudiantes) {
                const nombreCompleto = `${estudiante.student_first_name} ${estudiante.student_last_name_1}`;
                const fotoUrl = await getStudentPhotoUrl(estudiante.student_code);
                
                const conteosEstudiante = conteos[estudiante.student_id] || {
                    eae: 0, asuntos: 0, tareas: 0, documentos: 0
                };
                
                const tr = document.createElement('tr');
                
                // Columna foto
                const tdFoto = document.createElement('td');
                if (fotoUrl) {
                    const img = document.createElement('img');
                    img.src = fotoUrl;
                    img.alt = `Foto de ${nombreCompleto}`;
                    img.className = 'student-photo';
                    img.onerror = function() {
                        this.style.display = 'none';
                        this.nextElementSibling.style.display = 'flex';
                    };
                    tdFoto.appendChild(img);
                }
                
                const divPlaceholder = document.createElement('div');
                divPlaceholder.style.cssText = 'display:none; width:50px; height:50px; border-radius:50%; background-color:#f8f9fa; border:2px solid #ddd; align-items:center; justify-content:center; font-size:20px; color:#6c757d;';
                divPlaceholder.innerHTML = '<i class="bi bi-person"></i>';
                tdFoto.appendChild(divPlaceholder);
                tr.appendChild(tdFoto);
                
                // Columna nombre
                const tdNombre = document.createElement('td');
                tdNombre.className = 'student-name';
                tdNombre.textContent = nombreCompleto;
                tr.appendChild(tdNombre);
                
                // Columnas de botones con conteos - SIN METAS
                const botones = [
                    { clase: 'btn-eae', texto: 'E.A.E', conteo: conteosEstudiante.eae, funcion: () => abrirEAE(estudiante.student_id) },
                    { clase: 'btn-asuntos', texto: 'Asuntos', conteo: conteosEstudiante.asuntos, funcion: () => abrirAsuntos(estudiante.student_id) },
                    { clase: 'btn-tareas', texto: 'Tareas', conteo: conteosEstudiante.tareas, funcion: () => abrirTareas(estudiante.student_id) },
                    { clase: 'btn-documentos', texto: 'Documentos', conteo: conteosEstudiante.documentos, funcion: () => abrirDocumentos(estudiante.student_id) }
                ];
                
                botones.forEach(boton => {
                    const td = document.createElement('td');
                    const btn = document.createElement('button');
                    btn.className = `action-btn ${boton.clase}`;
                    btn.textContent = boton.texto + (boton.conteo > 0 ? ` (${boton.conteo})` : '');
                    btn.onclick = boton.funcion;
                    td.appendChild(btn);
                    tr.appendChild(td);
                });
                
                fragment.appendChild(tr);
            }
            
            tablaEstudiantes.appendChild(fragment);
            tablaContainer.style.display = 'block';
        }
        // Funciones para abrir modales
        function abrirAsuntos(studentId) {
            studentIdActual = studentId;
            const estudiante = estudiantesData.find(e => e.student_id === studentId);
            const nombreEstudiante = estudiante ? 
                `${estudiante.student_first_name} ${estudiante.student_last_name_1}` : 
                'Estudiante';
            
            document.getElementById('tituloModalAsuntos').textContent = `Asuntos de ${nombreEstudiante}`;
            
            const modal = new bootstrap.Modal(document.getElementById('modalAsuntos'));
            modal.show();
            
            cargarAsuntosEstudiante(studentId);
        }

        // Funciones del modal de asuntos
        function cerrarModalAsuntos() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalAsuntos'));
            if (modal) modal.hide();
            limpiarTablaAsuntos();
            studentIdActual = null;
        }

        function limpiarTablaAsuntos() {
            document.getElementById('tablaAsuntosContainer').style.display = 'none';
            document.getElementById('noDataAsuntos').style.display = 'none';
            document.getElementById('tablaAsuntos').innerHTML = '';
        }

        // Query corregido SIN topic_conclusion y topic_strategy
        async function cargarAsuntosEstudiante(studentId) {
            try {
                document.getElementById('mensajeCargaAsuntos').style.display = 'block';
                limpiarTablaAsuntos();
                
                // QUERY SIMPLIFICADO: Solo campos que existen en la tabla
                const asuntos = await supabaseRequest(`/stm_students_topics?select=topic_id,student_id,topic_date,topic_description,is_escalable,is_open,stm_students_topics_categories(stm_category(category_name))&student_id=eq.${studentId}&is_open=eq.SI&is_escalable=eq.SI&order=topic_date.desc`);
                
                document.getElementById('mensajeCargaAsuntos').style.display = 'none';
                
                if (asuntos.length === 0) {
                    document.getElementById('noDataAsuntos').style.display = 'block';
                    return;
                }
                
                // Agrupar categorías por topic_id
                const asuntosConCategorias = {};
                asuntos.forEach(asunto => {
                    if (!asuntosConCategorias[asunto.topic_id]) {
                        asuntosConCategorias[asunto.topic_id] = {
                            ...asunto,
                            categorias: []
                        };
                    }
                    if (asunto.stm_students_topics_categories?.stm_category?.category_name) {
                        asuntosConCategorias[asunto.topic_id].categorias.push(
                            asunto.stm_students_topics_categories.stm_category.category_name
                        );
                    }
                });
                
                mostrarAsuntos(Object.values(asuntosConCategorias));
                
            } catch (error) {
                document.getElementById('mensajeCargaAsuntos').style.display = 'none';
                console.error('Error cargando asuntos:', error);
                showMessage('Error al cargar los asuntos del estudiante', 'danger');
            }
        }

        // Función mostrarAsuntos SIN botón de estrategia - Solo lectura
        function mostrarAsuntos(asuntos) {
            const tablaContainer = document.getElementById('tablaAsuntosContainer');
            const tablaAsuntos = document.getElementById('tablaAsuntos');
            
            const fragment = document.createDocumentFragment();
            
            asuntos.forEach(asunto => {
                const tr = document.createElement('tr');
                
                // Columna categorías
                const tdCategoria = document.createElement('td');
                tdCategoria.className = 'categoria-cell';
                tdCategoria.textContent = asunto.categorias.join(', ') || 'Sin categoría';
                tr.appendChild(tdCategoria);
                
                // Columna fecha
                const tdFecha = document.createElement('td');
                tdFecha.className = 'fecha-cell';
                tdFecha.textContent = formatDate(asunto.topic_date);
                tr.appendChild(tdFecha);
                
                // Columna descripción (expandida para ocupar todo el espacio)
                const tdDescripcion = document.createElement('td');
                const divDescripcion = document.createElement('div');
                divDescripcion.className = 'asunto-description-rich';
                divDescripcion.innerHTML = asunto.topic_description || '<em>Sin descripción</em>';
                tdDescripcion.appendChild(divDescripcion);
                tr.appendChild(tdDescripcion);
                
                // NO hay más columnas - eliminadas Conclusión y Estrategia
                
                fragment.appendChild(tr);
            });
            
            tablaAsuntos.appendChild(fragment);
            tablaContainer.style.display = 'block';
        }

        
        
        
        // ELIMINAR completamente todas las funciones relacionadas con conclusión:
       
    
        
     
        // Actualizar función guardarEstrategia SIN referencias a conclusión
        async function guardarEstrategia() {
            const editor = document.getElementById('editorEstrategia');
            const estrategia = editor.innerHTML.trim();
            
            if (!estrategia || estrategia === '<br>' || estrategia === '<div><br></div>') {
                mostrarError('La estrategia no puede estar vacía', 'Estrategia');
                return;
            }
            
            try {
                if (eaeTopicIdActual) {
                    // Es un asunto EAE
                    await supabaseRequest(`/stm_eae_topics?eae_topic_id=eq.${eaeTopicIdActual}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ topic_strategy: estrategia })
                    });
                } else if (topicIdActual) {
                    // Es un asunto regular
                    await supabaseRequest(`/stm_students_topics?topic_id=eq.${topicIdActual}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ topic_strategy: estrategia })
                    });
                } else {
                    throw new Error('No se ha seleccionado un asunto válido');
                }
                
                mostrarExito('Estrategia guardada exitosamente', 'Estrategia');
                
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('modalEstrategia')).hide();
                    if (studentIdActual) {
                        if (eaeTopicIdActual) {
                            cargarAsuntosEAE(studentIdActual);
                        } else {
                            cargarAsuntosEstudiante(studentIdActual);
                        }
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Error guardando estrategia:', error);
                mostrarError('Error al guardar la estrategia', 'Estrategia');
            }
        }

        function mostrarAsuntosEAE(asuntosEAE) {
            const tablaEAE = document.getElementById('tablaEAE');
            const fragment = document.createDocumentFragment();
            
            asuntosEAE.forEach(asuntoEAE => {
                const tr = document.createElement('tr');
                
                // Fecha
                const tdFecha = document.createElement('td');
                tdFecha.className = 'fecha-cell';
                tdFecha.textContent = formatDate(asuntoEAE.topic_date);
                tr.appendChild(tdFecha);
                
                // Apoyo
                const tdApoyo = document.createElement('td');
                const divApoyo = document.createElement('div');
                divApoyo.className = 'asunto-description';
                divApoyo.textContent = asuntoEAE.supports || '';
                tdApoyo.appendChild(divApoyo);
                tr.appendChild(tdApoyo);
                
                // Acciones
                const tdAcciones = document.createElement('td');
                const divAcciones = document.createElement('div');
                divAcciones.className = 'asunto-description';
                divAcciones.textContent = asuntoEAE.actions || '';
                tdAcciones.appendChild(divAcciones);
                tr.appendChild(tdAcciones);
                
                // Recomendaciones
                const tdRecomendaciones = document.createElement('td');
                const divRecomendaciones = document.createElement('div');
                divRecomendaciones.className = 'asunto-description';
                divRecomendaciones.textContent = asuntoEAE.recommendations || '';
                tdRecomendaciones.appendChild(divRecomendaciones);
                tr.appendChild(tdRecomendaciones);
                
                // SOLO Botón estrategia (eliminado botón conclusión)
                const tdBotones = document.createElement('td');
                const btnEstrategia = document.createElement('button');
                btnEstrategia.className = 'btn-action-small btn-estrategia';
                btnEstrategia.textContent = 'Estrategia';
                btnEstrategia.onclick = () => registrarEstrategiaEAE(asuntoEAE.eae_topic_id);
                tdBotones.appendChild(btnEstrategia);
                
                tr.appendChild(tdBotones);
                fragment.appendChild(tr);
            });
            
            tablaEAE.appendChild(fragment);
            document.getElementById('tablaEAEContainer').style.display = 'block';
        }
        
        
        

        
        // Funciones de mensajes para modales
        function mostrarError(mensaje, tipo) {
            const errorDiv = document.getElementById(`mensajeError${tipo}`);
            errorDiv.textContent = mensaje;
            errorDiv.style.display = 'block';
            document.getElementById(`mensajeExito${tipo}`).style.display = 'none';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function mostrarExito(mensaje, tipo) {
            const exitoDiv = document.getElementById(`mensajeExito${tipo}`);
            exitoDiv.textContent = mensaje;
            exitoDiv.style.display = 'block';
            document.getElementById(`mensajeError${tipo}`).style.display = 'none';
            
            setTimeout(() => {
                exitoDiv.style.display = 'none';
            }, 3000);
        }
        // Modal de EAE actualizado - SOLO LECTURA
        function abrirEAE(studentId) {
            studentIdActual = studentId;
            const estudiante = estudiantesData.find(e => e.student_id === studentId);
            const nombreEstudiante = estudiante ? 
                `${estudiante.student_first_name} ${estudiante.student_last_name_1}` : 
                'Estudiante';
            
            const modalHtml = `
                <div class="modal fade" id="modalEAE" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Asuntos EAE de ${nombreEstudiante}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="mensajeCargaEAE" class="alert alert-info" style="display: none;">
                                    <i class="bi bi-hourglass-split me-2"></i>Cargando asuntos EAE...
                                </div>
                                
                                <div id="tablaEAEContainer" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 120px;">Fecha</th>
                                                    <th style="width: 220px;">Apoyo</th>
                                                    <th style="width: 220px;">Acciones</th>
                                                    <th>Recomendaciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tablaEAE">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div id="noDataEAE" class="no-data" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        No se encontraron asuntos EAE abiertos para este estudiante.
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (!document.getElementById('modalEAE')) {
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalEAE'));
            modal.show();
            
            cargarAsuntosEAE(studentId);
        }

        
        async function cargarAsuntosEAE(studentId) {
            try {
                document.getElementById('mensajeCargaEAE').style.display = 'block';
                
                const asuntosEAE = await supabaseRequest(`/stm_eae_topics?select=eae_topic_id,student_id,topic_date,topic_description,supports,actions,recommendations,followup,topic_conclusion,topic_strategy,is_open&student_id=eq.${studentId}&is_open=eq.SI&order=topic_date.desc`);
                
                document.getElementById('mensajeCargaEAE').style.display = 'none';
                
                if (asuntosEAE.length === 0) {
                    document.getElementById('noDataEAE').style.display = 'block';
                    return;
                }
                
                mostrarAsuntosEAE(asuntosEAE);
                
            } catch (error) {
                document.getElementById('mensajeCargaEAE').style.display = 'none';
                console.error('Error cargando asuntos EAE:', error);
                showMessage('Error al cargar los asuntos EAE', 'danger');
            }
        }


        // Función mostrarAsuntosEAE actualizada - SOLO LECTURA
        function mostrarAsuntosEAE(asuntosEAE) {
            const tablaEAE = document.getElementById('tablaEAE');
            const fragment = document.createDocumentFragment();
            
            asuntosEAE.forEach(asuntoEAE => {
                const tr = document.createElement('tr');
                
                // Fecha
                const tdFecha = document.createElement('td');
                tdFecha.className = 'fecha-cell';
                tdFecha.textContent = formatDate(asuntoEAE.topic_date);
                tr.appendChild(tdFecha);
                
                // Apoyo
                const tdApoyo = document.createElement('td');
                const divApoyo = document.createElement('div');
                divApoyo.className = 'asunto-description';
                divApoyo.textContent = asuntoEAE.supports || '';
                tdApoyo.appendChild(divApoyo);
                tr.appendChild(tdApoyo);
                
                // Acciones
                const tdAcciones = document.createElement('td');
                const divAcciones = document.createElement('div');
                divAcciones.className = 'asunto-description';
                divAcciones.textContent = asuntoEAE.actions || '';
                tdAcciones.appendChild(divAcciones);
                tr.appendChild(tdAcciones);
                
                // Recomendaciones
                const tdRecomendaciones = document.createElement('td');
                const divRecomendaciones = document.createElement('div');
                divRecomendaciones.className = 'asunto-description';
                divRecomendaciones.textContent = asuntoEAE.recommendations || '';
                tdRecomendaciones.appendChild(divRecomendaciones);
                tr.appendChild(tdRecomendaciones);
                
                // NO hay columna de botones - SOLO LECTURA
                
                fragment.appendChild(tr);
            });
            
            tablaEAE.appendChild(fragment);
            document.getElementById('tablaEAEContainer').style.display = 'block';
        }
        
            

        
        

        // Placeholder para otras funciones de modales
      function abrirTareas(studentId) {
            console.log('Abrir tareas para estudiante:', studentId);
            // Modal de tareas - por implementar
            showMessage('Funcionalidad de tareas por implementar', 'info');
        }
        
        function abrirDocumentos(studentId) {
            console.log('Abrir documentos para estudiante:', studentId);
            // Modal de documentos - por implementar  
            showMessage('Funcionalidad de documentos por implementar', 'info');
        }
         

        
        // Función de utilidad para escapar HTML (conservada)
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

    </script>
</body>
</html>
