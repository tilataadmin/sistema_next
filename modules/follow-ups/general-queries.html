<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultas - Sistema de Seguimiento Estudiantil - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Estilos espec√≠ficos para el m√≥dulo de consultas */
        .consulta-section {
            background-color: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #6f42c1;
        }
        
        .consulta-section h3 {
            color: #0d6efd;
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .consulta-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }
        
        .tab-button {
            padding: 12px 20px;
            border: none;
            background-color: transparent;
            color: #6c757d;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .tab-button.active {
            color: #6f42c1;
            border-bottom-color: #6f42c1;
            background-color: rgba(111, 66, 193, 0.05);
        }
        
        .tab-button:hover {
            color: #6f42c1;
            background-color: rgba(111, 66, 193, 0.03);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .filtros-container {
            background-color: #f8f9fa;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 24px;
            border: 1px solid #dee2e6;
        }
        
        .filtros-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            align-items: end;
        }
        
        .estudiante-card {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .estudiante-card:hover {
            border-color: #6f42c1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .estudiante-card.selected {
            border-color: #6f42c1;
            background-color: rgba(111, 66, 193, 0.05);
        }
        
        .estudiante-foto {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #dee2e6;
        }
        
        .estudiante-info h4 {
            margin: 0;
            color: #0d6efd;
            font-size: 16px;
        }
        
        .estudiante-info p {
            margin: 2px 0 0 0;
            color: #6c757d;
            font-size: 14px;
        }
        
        .resultado-item {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 8px;
        }
        
        .resultado-item h4 {
            margin: 0 0 4px 0;
            color: #0d6efd;
        }
        
        .resultado-meta {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .categoria-tag {
            display: inline-block;
            background-color: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }
        
        .estado-meta {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .estado-meta.rojo {
            background-color: #dc3545;
            color: white;
        }
        
        .estado-meta.amarillo {
            background-color: #ffc107;
            color: #000;
        }
        
        .estado-meta.verde {
            background-color: #198754;
            color: white;
        }
        
        .estadistica-card {
            background-color: white;
            border-radius: 6px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #6f42c1;
        }
        
        .estadistica-numero {
            font-size: 36px;
            font-weight: 700;
            color: #6f42c1;
            display: block;
        }
        
        .estadistica-label {
            color: #6c757d;
            font-size: 14px;
            margin-top: 4px;
        }
        
        .historia-timeline {
            position: relative;
            padding-left: 40px;
        }
        
        .historia-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #dee2e6;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 24px;
            background-color: white;
            border-radius: 6px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #6f42c1;
            border: 3px solid white;
        }
        
        .timeline-date {
            color: #6f42c1;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .grid-estadisticas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 6px;
            height: 20px;
            margin-bottom: 4px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .sin-datos {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .sin-datos i {
            font-size: 48px;
            display: block;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .consulta-tabs {
                flex-direction: column;
            }
            
            .tab-button {
                min-width: auto;
                text-align: left;
            }
            
            .filtros-row {
                grid-template-columns: 1fr;
            }
            
            .historia-timeline {
                padding-left: 24px;
            }
            
            .timeline-item::before {
                left: -18px;
            }
        }
    </style>
</head>
<body>
    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="../follow-ups/index.html">
                        Seguimientos
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Consultas
                </li>
            </ol>
        </nav>

        <!-- Encabezado de p√°gina -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-search me-2"></i>
                    Consultas - Sistema de Seguimiento Estudiantil
                </h1>
                <p class="text-muted">
                    Sistema completo de consultas y estad√≠sticas del seguimiento estudiantil
                </p>
            </div>
        </div>

        <!-- Mensajes del sistema -->
        <div id="alertContainer"></div>

        <!-- Tabs de navegaci√≥n -->
        <div class="consulta-tabs">
            <button class="tab-button active" data-tab="historia">
                <i class="bi bi-person me-1"></i>Historia Estudiante
            </button>
            <button class="tab-button" data-tab="promocion">
                <i class="bi bi-mortarboard me-1"></i>Asuntos Promoci√≥n
            </button>
            <button class="tab-button" data-tab="categorias">
                <i class="bi bi-bar-chart me-1"></i>Estad√≠sticas
            </button>
            <button class="tab-button" data-tab="tareas">
                <i class="bi bi-check-square me-1"></i>An√°lisis Tareas
            </button>
            <button class="tab-button" data-tab="metas">
                <i class="bi bi-target me-1"></i>Estado Metas
            </button>
            <button class="tab-button" data-tab="reportes">
                <i class="bi bi-file-text me-1"></i>Reportes
            </button>
            <button class="tab-button" data-tab="busqueda">
                <i class="bi bi-search me-1"></i>B√∫squeda Avanzada
            </button>
        </div>

        <div id="tab-historia" class="tab-content active">
            <div class="consulta-section">
                <h3>
                    <i class="bi bi-person"></i>
                    Historia Completa del Estudiante
                </h3>
                
                <!-- Filtros -->
                <div class="filtros-container">
                    <div class="filtros-row">
                        <div class="form-group">
                            <label for="buscar-estudiante" class="form-label">Buscar Estudiante:</label>
                            <input type="text" id="buscar-estudiante" class="form-control" placeholder="Nombre, apellido o c√≥digo..." />
                        </div>
                        <div class="form-group">
                            <label for="fecha-inicio-historia" class="form-label">Fecha Inicio:</label>
                            <input type="date" id="fecha-inicio-historia" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="fecha-fin-historia" class="form-label">Fecha Fin:</label>
                            <input type="date" id="fecha-fin-historia" class="form-control" />
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="buscarEstudiantesHandler()">
                                <i class="bi bi-search me-1"></i>Buscar
                            </button>
                        </div>
                    </div>
                </div>
        
                <!-- Resultados de b√∫squeda de estudiantes -->
                <div id="estudiantes-container" style="display: none;">
                    <h4>Seleccionar Estudiante:</h4>
                    <div id="estudiantes-lista"></div>
                </div>
        
                <!-- Historia del estudiante seleccionado -->
                <div id="historia-container" style="display: none;">
                    <div id="estudiante-seleccionado"></div>
                    <div id="historia-content"></div>
                </div>
            </div>
        </div>

        
        <!-- TAB: Asuntos por Promoci√≥n -->
        <div id="tab-promocion" class="tab-content">
            <div class="consulta-section">
                <h3>
                    <i class="bi bi-mortarboard"></i>
                    Asuntos por Promoci√≥n
                </h3>
                <div class="filtros-container">
                <!-- Tipo de consulta -->
                <div class="filtros-row mb-3">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label"><strong>Tipo de Consulta:</strong></label>
                        <div style="display: flex; gap: 20px; align-items: center; padding: 10px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="tipo-consulta-promo" value="promocion" checked style="margin-right: 8px;">
                                <span>Por Promoci√≥n (hist√≥rico completo)</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="tipo-consulta-promo" value="curso" style="margin-right: 8px;">
                                <span>Por Curso (a√±o acad√©mico actual)</span>
                            </label>
                        </div>
                    </div>
                </div>
            
                <!-- Filtros principales -->
                <div class="filtros-row">
                    <!-- Selector de Promoci√≥n (visible por defecto) -->
                    <div class="form-group" id="group-promocion">
                        <label for="select-promocion" class="form-label">Promoci√≥n:</label>
                        <select id="select-promocion" class="form-select">
                            <option value="">Seleccionar promoci√≥n...</option>
                        </select>
                    </div>
            
                    <!-- Selector de Curso (oculto por defecto) -->
                    <div class="form-group" id="group-curso" style="display: none;">
                        <label for="select-curso-promo" class="form-label">Curso:</label>
                        <select id="select-curso-promo" class="form-select">
                            <option value="">Cargando cursos...</option>
                        </select>
                    </div>
                    
                    <!-- Selector de A√±o Acad√©mico (oculto por defecto) -->
                    <div class="form-group" id="group-year" style="display: none;">
                        <label for="select-year-promo" class="form-label">A√±o Acad√©mico:</label>
                        <select id="select-year-promo" class="form-select">
                            <option value="">Seleccionar a√±o...</option>
                        </select>
                    </div>
            
                    <div class="form-group">
                        <label for="fecha-inicio-promocion" class="form-label">Fecha Inicio:</label>
                        <input type="date" id="fecha-inicio-promocion" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="fecha-fin-promocion" class="form-label">Fecha Fin:</label>
                        <input type="date" id="fecha-fin-promocion" class="form-control" />
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="consultarAsuntosPromocion()">
                            <i class="bi bi-file-text me-1"></i>Consultar
                        </button>
                    </div>
                </div>
            </div>
                
                <div id="promocion-resultados"></div>
            </div>
        </div>

        <!-- TAB: Estad√≠sticas por Categor√≠a -->
        <div id="tab-categorias" class="tab-content">
            <div class="consulta-section">
                <h3>
                    <i class="bi bi-bar-chart"></i>
                    Estad√≠sticas por Categor√≠a
                </h3>
                
                <div class="filtros-container">
                    <div class="filtros-row">
                        <div class="form-group">
                            <label for="fecha-inicio-stats" class="form-label">Fecha Inicio:</label>
                            <input type="date" id="fecha-inicio-stats" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="fecha-fin-stats" class="form-label">Fecha Fin:</label>
                            <input type="date" id="fecha-fin-stats" class="form-control" />
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="consultarEstadisticasCategorias()">
                                <i class="bi bi-bar-chart me-1"></i>Generar Estad√≠sticas
                            </button>
                        </div>
                    </div>
                </div>

                <div id="estadisticas-container"></div>
            </div>
        </div>

        <!-- TAB: An√°lisis de Tareas -->
        <div id="tab-tareas" class="tab-content">
            <div class="consulta-section">
                <h3>
                    <i class="bi bi-check-square"></i>
                    An√°lisis de Tareas
                </h3>
                
                <div class="filtros-container">
                    <div class="filtros-row">
                        <div class="form-group">
                            <label for="select-usuario" class="form-label">Usuario Asignado:</label>
                            <select id="select-usuario" class="form-select">
                                <option value="">Todos los usuarios</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fecha-inicio-tareas" class="form-label">Fecha Inicio:</label>
                            <input type="date" id="fecha-inicio-tareas" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="fecha-fin-tareas" class="form-label">Fecha Fin:</label>
                            <input type="date" id="fecha-fin-tareas" class="form-control" />
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="consultarAnalisisTareas()">
                                <i class="bi bi-check-square me-1"></i>Analizar
                            </button>
                        </div>
                    </div>
                </div>

                <div id="tareas-resultados"></div>
            </div>
        </div>
        <!-- TAB: Estado de Metas -->
        <div id="tab-metas" class="tab-content">
            <div class="consulta-section">
                <h3>
                    <i class="bi bi-target"></i>
                    Estado de Metas (Sem√°foro)
                </h3>
                
                <div class="filtros-container">
                    <div class="filtros-row">
                        <div class="form-group">
                            <label for="select-estado-meta" class="form-label">Estado:</label>
                            <select id="select-estado-meta" class="form-select">
                                <option value="todos">Todos los estados</option>
                                <option value="1">üî¥ Rojas</option>
                                <option value="2">üü° Amarillas</option>
                                <option value="3">üü¢ Verdes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fecha-inicio-metas" class="form-label">Fecha Inicio:</label>
                            <input type="date" id="fecha-inicio-metas" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="fecha-fin-metas" class="form-label">Fecha Fin:</label>
                            <input type="date" id="fecha-fin-metas" class="form-control" />
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="consultarEstadoMetas()">
                                <i class="bi bi-target me-1"></i>Consultar
                            </button>
                        </div>
                    </div>
                </div>

                <div id="metas-resultados"></div>
            </div>
        </div>

        <!-- TAB: Reportes Consolidados -->
        <div id="tab-reportes" class="tab-content">
            <div class="consulta-section">
                <h3>
                    <i class="bi bi-file-text"></i>
                    Reportes Consolidados
                </h3>
                
                <div class="filtros-container">
                    <div class="filtros-row">
                        <div class="form-group">
                            <label for="tipo-reporte" class="form-label">Tipo de Reporte:</label>
                            <select id="tipo-reporte" class="form-select">
                                <option value="general">üìä General Completo</option>
                                <option value="asuntos">üìù Solo Asuntos</option>
                                <option value="tareas">‚úÖ Solo Tareas</option>
                                <option value="metas">üéØ Solo Metas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fecha-inicio-reportes" class="form-label">Fecha Inicio:</label>
                            <input type="date" id="fecha-inicio-reportes" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="fecha-fin-reportes" class="form-label">Fecha Fin:</label>
                            <input type="date" id="fecha-fin-reportes" class="form-control" />
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="generarReporteConsolidado()">
                                <i class="bi bi-file-text me-1"></i>Generar
                            </button>
                        </div>
                    </div>
                </div>

                <div id="reportes-resultados"></div>
            </div>
        </div>

        <!-- TAB: B√∫squeda Avanzada -->
        <div id="tab-busqueda" class="tab-content">
            <div class="consulta-section">
                <h3>
                    <i class="bi bi-search"></i>
                    B√∫squeda Avanzada
                </h3>
                
                <div class="filtros-container">
                    <div class="filtros-row">
                        <div class="form-group">
                            <label for="texto-busqueda" class="form-label">Buscar en Descripciones:</label>
                            <input type="text" id="texto-busqueda" class="form-control" placeholder="Texto a buscar en asuntos..." />
                        </div>
                        <div class="form-group">
                            <label for="fecha-inicio-busqueda" class="form-label">Fecha Inicio:</label>
                            <input type="date" id="fecha-inicio-busqueda" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label for="fecha-fin-busqueda" class="form-label">Fecha Fin:</label>
                            <input type="date" id="fecha-fin-busqueda" class="form-control" />
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="buscarTextoAvanzado()">
                                <i class="bi bi-search me-1"></i>Buscar
                            </button>
                        </div>
                    </div>
                </div>

                <div id="busqueda-resultados"></div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles -->
    <div class="modal fade" id="modalDetalles" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitulo">Detalles</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalContenido">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Config.js -->
    <script src="../../assets/js/config.js"></script>
    <script>
        /**
         * JavaScript para Consultas - Sistema de Seguimiento Estudiantil
         * Migrado desde GAS a SchoolNet con Supabase
         */

        // Variables globales
        let estudiantesEncontrados = [];
        let estudianteSeleccionado = null;
        let configUrlPhotos = '';
        let coloresSemaforo = {
            red: '#dc3545',
            yellow: '#ffc107',
            green: '#198754'
        };

        /**
         * Inicializaci√≥n de la p√°gina
         */
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Validar permisos de acceso
                const tieneAcceso = await validatePageAccess('Consultas');
                if (!tieneAcceso) {
                    return;
                }

                // Cargar configuraci√≥n inicial
                await cargarConfiguracionInicial();
                
                // Configurar event listeners
                configurarEventListeners();

                // Configurar fechas por defecto
                configurarFechasPorDefecto();
                
            } catch (error) {
                console.error('Error en inicializaci√≥n:', error);
                showMessage('Error al inicializar la p√°gina: ' + error.message, 'danger');
            }
        });

        /**
         * Carga la configuraci√≥n inicial de la p√°gina
         */
        async function cargarConfiguracionInicial() {
            try {
                showMessage('Cargando configuraci√≥n...', 'info');

                // Cargar configuraci√≥n del sistema
                const configData = await supabaseRequest('/system_config?select=photos_url,red_threshold,yellow_threshold,green_threshold&limit=1');
                
                if (configData.length > 0) {
                    configUrlPhotos = configData[0].photos_url || '';
                    
                    // Configurar colores del sem√°foro si est√°n disponibles
                    if (configData[0].red_threshold) coloresSemaforo.red = configData[0].red_threshold;
                    if (configData[0].yellow_threshold) coloresSemaforo.yellow = configData[0].yellow_threshold;
                    if (configData[0].green_threshold) coloresSemaforo.green = configData[0].green_threshold;
                }

                // Cargar datos iniciales para selects
                await Promise.all([
                    cargarPromociones(),
                    cargarCursosActivos(),
                    cargarA√±osAcademicos(),
                    cargarUsuariosConTareas()
                ]);
                
                showMessage('Configuraci√≥n cargada correctamente', 'success');
                
            } catch (error) {
                console.error('Error cargando configuraci√≥n:', error);
                showMessage('Error al cargar la configuraci√≥n: ' + error.message, 'danger');
            }
        }

        /**
         * Carga las promociones disponibles
         */
        async function cargarPromociones() {
            try {
                const promociones = await supabaseRequest('/grades?select=promotion_code&promotion_code=not.is.null&promotion_code=neq.&order=promotion_code');
                
                const select = document.getElementById('select-promocion');
                select.innerHTML = '<option value="">Seleccionar promoci√≥n...</option>';
                
                // Obtener promociones √∫nicas
                const promocionesUnicas = [...new Set(promociones.map(p => p.promotion_code))];
                
                promocionesUnicas.forEach(prom => {
                    const option = document.createElement('option');
                    option.value = prom;
                    option.textContent = prom;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error cargando promociones:', error);
            }
        }

        /**
         * Carga los cursos activos ordenados por course_order
         */
        async function cargarCursosActivos() {
            try {
                const cursos = await supabaseRequest('/courses?select=course_id,course_name,course_order,grade_id,grades(promotion_code)&order=course_order');
                
                const select = document.getElementById('select-curso-promo');
                select.innerHTML = '<option value="">Seleccionar curso...</option>';
                
                cursos.forEach(curso => {
                    const option = document.createElement('option');
                    option.value = curso.course_id;
                    option.textContent = curso.course_name;
                    option.dataset.gradeId = curso.grade_id;
                    option.dataset.promotionCode = curso.grades?.promotion_code || '';
                    select.appendChild(option);
                });
                
                select.disabled = false;
                
            } catch (error) {
                console.error('Error cargando cursos:', error);
                const select = document.getElementById('select-curso-promo');
                select.innerHTML = '<option value="">Error al cargar cursos</option>';
            }
        }

        /**
         * Carga los a√±os acad√©micos en el select
         */
        async function cargarA√±osAcademicos() {
            try {
                const years = await supabaseRequest('/academic_years?select=year_id,year_name,year_order&order=year_order.desc');
                
                const select = document.getElementById('select-year-promo');
                select.innerHTML = '<option value="">Seleccionar a√±o acad√©mico...</option>';
                
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.year_id;
                    option.textContent = year.year_name;
                    select.appendChild(option);
                });
                
                select.disabled = false;
                
            } catch (error) {
                console.error('Error cargando a√±os acad√©micos:', error);
                const select = document.getElementById('select-year-promo');
                select.innerHTML = '<option value="">Error al cargar a√±os</option>';
            }
        }



        
        /**
         * Carga los usuarios que tienen tareas asignadas
         */
        async function cargarUsuariosConTareas() {
            try {
                const usuarios = await supabaseRequest('/tasks?select=assigned_to_mail,assigned_to_name&assigned_to_mail=not.is.null&assigned_to_mail=neq.&order=assigned_to_name');
                
                const select = document.getElementById('select-usuario');
                select.innerHTML = '<option value="">Todos los usuarios</option>';
                
                // Obtener usuarios √∫nicos
                const usuariosUnicos = [];
                const emailsVistos = new Set();
                
                usuarios.forEach(usuario => {
                    if (!emailsVistos.has(usuario.assigned_to_mail)) {
                        emailsVistos.add(usuario.assigned_to_mail);
                        usuariosUnicos.push(usuario);
                    }
                });
                
                usuariosUnicos.forEach(usuario => {
                    const option = document.createElement('option');
                    option.value = usuario.assigned_to_mail;
                    option.textContent = usuario.assigned_to_name || usuario.assigned_to_mail;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error cargando usuarios:', error);
            }
        }

        /**
         * Configura los event listeners
         */
        function configurarEventListeners() {
            // Tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    cambiarTab(tabId);
                });
            });

            // B√∫squeda de estudiantes con debounce
            const inputBusqueda = document.getElementById('buscar-estudiante');
            if (inputBusqueda) {
                let timeoutId = null;
                
                inputBusqueda.addEventListener('input', function() {
                    const valor = this.value.trim();
                    
                    // Limpiar timeout anterior
                    if (timeoutId) {
                        clearTimeout(timeoutId);
                    }
                    
                    // Si hay menos de 2 caracteres, ocultar resultados inmediatamente
                    if (valor.length < 2) {
                        document.getElementById('estudiantes-container').style.display = 'none';
                        return;
                    }
                    
                    // Configurar nuevo timeout de 600ms
                    timeoutId = setTimeout(() => {
                        buscarEstudiantesHandler();
                    }, 600);
                });
                
                // Limpiar b√∫squeda al presionar Escape
                inputBusqueda.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        this.value = '';
                        document.getElementById('estudiantes-container').style.display = 'none';
                        estudianteSeleccionado = null;
                        document.getElementById('historia-container').style.display = 'none';
                        document.getElementById('estudiante-seleccionado').innerHTML = '';
                    }
                });
            }

            // Cerrar modal con ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalles'));
                    if (modal) {
                        modal.hide();
                    }
                }
            });
            // Listener para cambio de tipo de consulta de promoci√≥n
            document.querySelectorAll('input[name="tipo-consulta-promo"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const tipoConsulta = this.value;
                    const groupPromocion = document.getElementById('group-promocion');
                    const groupCurso = document.getElementById('group-curso');
                    const groupYear = document.getElementById('group-year');
                    
                    if (tipoConsulta === 'promocion') {
                        groupPromocion.style.display = 'block';
                        groupCurso.style.display = 'none';
                        groupYear.style.display = 'none';
                    } else {
                        groupPromocion.style.display = 'none';
                        groupCurso.style.display = 'block';
                        groupYear.style.display = 'block';
                    }
                });
            });
        }

        /**
         * Configura fechas por defecto
         */
        function configurarFechasPorDefecto() {
            const hoy = new Date();
            const tresSemanasAtras = new Date(hoy);
            tresSemanasAtras.setDate(hoy.getDate() - 21);
            
            const fechaHoyStr = hoy.toISOString().split('T')[0];
            const fechaAtrasStr = tresSemanasAtras.toISOString().split('T')[0];
            
            // Configurar fechas por defecto en algunos campos
            const fechasFinales = [
                'fecha-fin-historia', 'fecha-fin-promocion', 'fecha-fin-stats',
                'fecha-fin-tareas', 'fecha-fin-metas', 'fecha-fin-reportes', 'fecha-fin-busqueda'
            ];
            
            fechasFinales.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = fechaHoyStr;
                }
            });
        }

        /**
         * Cambia entre tabs
         */
        function cambiarTab(tabId) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover clase active de todos los botones
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar tab seleccionado
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            // Activar bot√≥n correspondiente
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        }

        /**
         * Construye URL de foto de estudiante
         */
        function construirUrlFoto(studentCode) {
            if (!configUrlPhotos || !studentCode) {
                return '';
            }
            return configUrlPhotos + studentCode + '.jpg';
        }

        /**
         * Funci√≥n auxiliar para escapar HTML
         */
        function escapeHtml(texto) {
            if (!texto) return '';
            const div = document.createElement('div');
            div.textContent = texto;
            return div.innerHTML;
        }

        /**
         * Funci√≥n auxiliar para formatear fechas
         */
        function formatearFecha(fecha) {
            if (!fecha) return 'No disponible';
            
            try {
                const fechaObj = new Date(fecha + 'T00:00:00');
                return fechaObj.toLocaleDateString('es-CO', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (error) {
                return fecha;
            }
        }

        /**
         * Funci√≥n auxiliar para obtener informaci√≥n del estado de meta
         */
        function obtenerInfoEstadoMeta(status) {
            switch (parseInt(status)) {
                case 1:
                    return { clase: 'rojo', icono: 'üî¥', nombre: 'Rojo' };
                case 2:
                    return { clase: 'amarillo', icono: 'üü°', nombre: 'Amarillo' };
                case 3:
                    return { clase: 'verde', icono: 'üü¢', nombre: 'Verde' };
                default:
                    return { clase: '', icono: '‚ö™', nombre: 'Sin Estado' };
            }
        }

      /**
         * Maneja la b√∫squeda de estudiantes
         */
        async function buscarEstudiantesHandler() {
            const filtro = document.getElementById('buscar-estudiante').value.trim();
            
            if (filtro.length < 2) {
                document.getElementById('estudiantes-container').style.display = 'none';
                return;
            }

            try {
                // Mostrar indicador de carga sutil
                const container = document.getElementById('estudiantes-container');
                const lista = document.getElementById('estudiantes-lista');
                
                container.style.display = 'block';
                lista.innerHTML = '<div class="loading-skeleton" style="height: 60px;"></div>';

                // Buscar estudiantes activos
                const estudiantes = await buscarEstudiantes(filtro);
                
                if (estudiantes.success) {
                    estudiantesEncontrados = estudiantes.data;
                    mostrarEstudiantesEncontrados();
                } else {
                    lista.innerHTML = `<p class="sin-datos">Error: ${estudiantes.message}</p>`;
                }
                
            } catch (error) {
                console.error('Error en b√∫squeda:', error);
                const lista = document.getElementById('estudiantes-lista');
                lista.innerHTML = '<p class="sin-datos">Error de conexi√≥n. Intenta nuevamente.</p>';
            }
        }

        /**
         * Busca estudiantes en la base de datos
         */
        async function buscarEstudiantes(filtro) {
            try {
                if (!filtro || filtro.trim() === '') {
                    return { success: true, data: [] };
                }
        
                const filtroLike = `%${filtro.trim()}%`;
                
                // Primero obtener el UUID del status "activo" (asumiendo que el c√≥digo 1 es activo)
                const statusActivo = await supabaseRequest('/student_status?select=status_id&status_code=eq.1&limit=1');
                
                if (statusActivo.length === 0) {
                    console.warn('No se encontr√≥ status activo para estudiantes');
                    return { success: true, data: [] };
                }
                
                const statusActivoId = statusActivo[0].status_id;
                
                // Verificar si el filtro es num√©rico para buscar por c√≥digo
                const esNumerico = /^\d+$/.test(filtro.trim());
                
                let query;
                if (esNumerico) {
                    // Si es num√©rico, buscar por c√≥digo exacto y tambi√©n por nombres
                    query = `/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2,course_id,courses!inner(course_name,grades!inner(grade_name,promotion_code))&status_id=eq.${statusActivoId}&or=(student_first_name.ilike.${encodeURIComponent(filtroLike)},student_last_name_1.ilike.${encodeURIComponent(filtroLike)},student_last_name_2.ilike.${encodeURIComponent(filtroLike)},student_code.eq.${filtro.trim()})&order=student_last_name_1,student_last_name_2,student_first_name&limit=50`;
                } else {
                    // Si no es num√©rico, solo buscar por nombres
                    query = `/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2,course_id,courses!inner(course_name,grades!inner(grade_name,promotion_code))&status_id=eq.${statusActivoId}&or=(student_first_name.ilike.${encodeURIComponent(filtroLike)},student_last_name_1.ilike.${encodeURIComponent(filtroLike)},student_last_name_2.ilike.${encodeURIComponent(filtroLike)})&order=student_last_name_1,student_last_name_2,student_first_name&limit=50`;
                }
        
                const estudiantes = await supabaseRequest(query);
        
                // Procesar resultados para tener estructura plana
                const estudiantesFormateados = estudiantes.map(estudiante => {
                    return {
                        student_id: estudiante.student_id,
                        student_code: estudiante.student_code,
                        student_first_name: estudiante.student_first_name,
                        student_last_name_1: estudiante.student_last_name_1,
                        student_last_name_2: estudiante.student_last_name_2,
                        course_name: estudiante.courses?.course_name || 'Sin curso',
                        grade_name: estudiante.courses?.grades?.grade_name || 'Sin grado',
                        promotion_code: estudiante.courses?.grades?.promotion_code || null
                    };
                });
        
                return {
                    success: true,
                    data: estudiantesFormateados
                };
                
            } catch (error) {
                console.error('Error buscando estudiantes:', error);
                return {
                    success: false,
                    message: 'Error al buscar estudiantes: ' + error.message
                };
            }
        }

        
        /**
         * Muestra los estudiantes encontrados
         */
        function mostrarEstudiantesEncontrados() {
            const container = document.getElementById('estudiantes-container');
            const lista = document.getElementById('estudiantes-lista');
            
            if (estudiantesEncontrados.length === 0) {
                lista.innerHTML = '<p class="sin-datos">No se encontraron estudiantes con ese criterio.</p>';
            } else {
                lista.innerHTML = '';
                
                estudiantesEncontrados.forEach(estudiante => {
                    const card = document.createElement('div');
                    card.className = 'estudiante-card';
                    card.onclick = () => seleccionarEstudiante(estudiante);
                    
                    const fotoUrl = construirUrlFoto(estudiante.student_code);
                    
                    card.innerHTML = `
                        <img class="estudiante-foto" src="${fotoUrl}" alt="Foto" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display:none; width:50px; height:50px; border-radius:50%; background-color:#f8f9fa; border:2px solid #ddd; align-items:center; justify-content:center; font-size:20px; color:#6c757d;">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <div class="estudiante-info">
                            <h4>${escapeHtml(estudiante.student_first_name)} ${escapeHtml(estudiante.student_last_name_1)} ${escapeHtml(estudiante.student_last_name_2 || '')}</h4>
                            <p>C√≥digo: ${escapeHtml(estudiante.student_code)} | ${escapeHtml(estudiante.course_name)} - ${escapeHtml(estudiante.grade_name)}</p>
                        </div>
                    `;
                    
                    lista.appendChild(card);
                });
            }
            
            container.style.display = 'block';
        }

        /**
         * Selecciona un estudiante para ver su historia
         */
        function seleccionarEstudiante(estudiante) {
            estudianteSeleccionado = estudiante;
            
            // Ocultar la lista de estudiantes encontrados
            document.getElementById('estudiantes-container').style.display = 'none';
            
            // Actualizar el campo de b√∫squeda con el nombre seleccionado
            const inputBusqueda = document.getElementById('buscar-estudiante');
            inputBusqueda.value = `${estudiante.student_first_name} ${estudiante.student_last_name_1} ${estudiante.student_last_name_2 || ''}`.trim();
            
            // Mostrar informaci√≥n del estudiante seleccionado
            mostrarInformacionEstudiante();
            
            // Cargar historia autom√°ticamente
            cargarHistoriaEstudiante();
        }

        /**
         * Muestra la informaci√≥n del estudiante seleccionado
         */
        function mostrarInformacionEstudiante() {
            const container = document.getElementById('estudiante-seleccionado');
            if (!estudianteSeleccionado) return;
            
            const fotoUrl = construirUrlFoto(estudianteSeleccionado.student_code);
            
            container.innerHTML = `
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-3">
                            <img class="estudiante-foto" src="${fotoUrl}" alt="Foto estudiante" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div style="display:none; width:50px; height:50px; border-radius:50%; background-color:#f8f9fa; border:2px solid #ddd; align-items:center; justify-content:center; font-size:20px; color:#6c757d;">
                                <i class="bi bi-person-circle"></i>
                            </div>
                            <div>
                                <h3 class="mb-1">${escapeHtml(estudianteSeleccionado.student_first_name)} ${escapeHtml(estudianteSeleccionado.student_last_name_1)} ${escapeHtml(estudianteSeleccionado.student_last_name_2 || '')}</h3>
                                <p class="mb-1 text-muted">C√≥digo: ${escapeHtml(estudianteSeleccionado.student_code)} | ${escapeHtml(estudianteSeleccionado.course_name)} - ${escapeHtml(estudianteSeleccionado.grade_name)}</p>
                                ${estudianteSeleccionado.promotion_code ? `<p class="mb-0 text-primary fw-bold">Promoci√≥n: ${escapeHtml(estudianteSeleccionado.promotion_code)}</p>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Carga la historia completa del estudiante
         */
        async function cargarHistoriaEstudiante() {
            if (!estudianteSeleccionado) return;
            
            try {
                const fechaInicio = document.getElementById('fecha-inicio-historia').value;
                const fechaFin = document.getElementById('fecha-fin-historia').value;
                
                showMessage('Cargando historia del estudiante...', 'info');
                
                const historia = await obtenerHistoriaEstudiante(estudianteSeleccionado.student_id, fechaInicio, fechaFin);
                
                if (historia.success) {
                    mostrarHistoriaCompleta(historia.data);
                    document.getElementById('historia-container').style.display = 'block';
                    showMessage('Historia cargada correctamente', 'success');
                } else {
                    showMessage('Error al cargar historia: ' + historia.message, 'danger');
                }
                
            } catch (error) {
                console.error('Error al cargar historia:', error);
                showMessage('Error al cargar historia: ' + error.message, 'danger');
            }
        }

        /**
         * Obtiene la historia completa del estudiante
         */
        async function obtenerHistoriaEstudiante(studentId, fechaInicio, fechaFin) {
            try {
                // Obtener datos b√°sicos del estudiante (ya los tenemos)
                const estudiante = estudianteSeleccionado;
                
                // Obtener asuntos del estudiante
                const asuntos = await obtenerAsuntosEstudiante(studentId, fechaInicio, fechaFin);
                
                // Obtener tareas del estudiante
                const tareas = await obtenerTareasEstudiante(studentId, fechaInicio, fechaFin);
                
                // Obtener documentos del estudiante
                const documentos = await obtenerDocumentosEstudiante(studentId);
                
                // Obtener asuntos de promoci√≥n si tiene promoci√≥n
                let asuntosPromocion = [];
                if (estudiante.promotion_code) {
                    const asuntosPromResult = await obtenerAsuntosPromocion(estudiante.promotion_code, fechaInicio, fechaFin);
                    asuntosPromocion = asuntosPromResult.success ? asuntosPromResult.data : [];
                }
                
                return {
                    success: true,
                    data: {
                        estudiante: estudiante,
                        asuntos: asuntos.success ? asuntos.data : [],
                        tareas: tareas.success ? tareas.data : [],
                        documentos: documentos.success ? documentos.data : [],
                        asuntosPromocion: asuntosPromocion
                    }
                };
                
            } catch (error) {
                console.error('Error obteniendo historia:', error);
                return {
                    success: false,
                    message: 'Error al obtener historia del estudiante: ' + error.message
                };
            }
        }

        
        /**
         * Obtiene asuntos del estudiante
         */
        async function obtenerAsuntosEstudiante(studentId, fechaInicio, fechaFin) {
            try {
                let query = `/stm_students_topics?select=topic_id,student_id,topic_date,topic_description,topic_strategy,is_escalable,is_open,email,stm_students_topics_categories!inner(stm_category!inner(category_name))&student_id=eq.${studentId}`;
                
                if (fechaInicio && fechaFin) {
                    query += `&topic_date=gte.${fechaInicio}&topic_date=lte.${fechaFin}`;
                }
                
                query += '&order=topic_date.desc';
                
                const asuntos = await supabaseRequest(query);
                
                // Obtener emails √∫nicos
                const emailsUnicos = [...new Set(asuntos.map(a => a.email).filter(e => e))];
                
                // Obtener workers por email
                let workersMap = {};
                if (emailsUnicos.length > 0) {
                    const workers = await supabaseRequest(`/workers?select=email,worker_first_name,worker_last_name_1&email=in.(${emailsUnicos.map(e => `"${e}"`).join(',')})`);
                    workers.forEach(w => {
                        workersMap[w.email] = {
                            worker_first_name: w.worker_first_name,
                            worker_last_name_1: w.worker_last_name_1
                        };
                    });
                }
                
                // Procesar asuntos agrupando categor√≠as
                const asuntosConCategorias = asuntos.map(asunto => {
                    const categorias = asunto.stm_students_topics_categories?.map(cat => cat.stm_category?.category_name).filter(Boolean).join(', ') || '';
                    const worker = workersMap[asunto.email] || {};
                    
                    return {
                        topic_id: asunto.topic_id,
                        student_id: asunto.student_id,
                        topic_date: asunto.topic_date,
                        topic_description: asunto.topic_description,
                        topic_strategy: asunto.topic_strategy,
                        is_escalable: asunto.is_escalable,
                        is_open: asunto.is_open,
                        email: asunto.email,
                        worker_first_name: worker.worker_first_name || 'No especificado',
                        worker_last_name_1: worker.worker_last_name_1 || '',
                        categorias: categorias
                    };
                });
                
                return {
                    success: true,
                    data: asuntosConCategorias
                };
                
            } catch (error) {
                console.error('Error obteniendo asuntos:', error);
                return {
                    success: false,
                    message: 'Error al obtener asuntos del estudiante: ' + error.message
                };
            }
        }
        

        
     
        /**
         * Obtiene tareas del estudiante
         */
        async function obtenerTareasEstudiante(studentId, fechaInicio, fechaFin) {
            try {
                let query = `/tasks?select=task_id,assigned_to_mail,assigned_to_name,due_date,task_description,task_progress,close_date,task_state&student_id=eq.${studentId}`;
                
                if (fechaInicio && fechaFin) {
                    query += `&due_date=gte.${fechaInicio}&due_date=lte.${fechaFin}`;
                }
                
                query += '&order=due_date.desc';
                
                const tareas = await supabaseRequest(query);
                
                return {
                    success: true,
                    data: tareas
                };
                
            } catch (error) {
                console.error('Error obteniendo tareas:', error);
                return {
                    success: false,
                    message: 'Error al obtener tareas del estudiante: ' + error.message
                };
            }
        }

        /**
         * Obtiene documentos del estudiante
         */
        async function obtenerDocumentosEstudiante(studentId) {
            try {
                const documentos = await supabaseRequest(`/stm_docs?select=doc_id,doc_url,doc_description,worker_name,private&student_id=eq.${studentId}&order=doc_id.desc`);
                
                return {
                    success: true,
                    data: documentos
                };
                
            } catch (error) {
                console.error('Error obteniendo documentos:', error);
                return {
                    success: false,
                    message: 'Error al obtener documentos del estudiante: ' + error.message
                };
            }
        }

        /**
         * Obtiene asuntos de promoci√≥n
         */
        async function obtenerAsuntosPromocion(promocion, fechaInicio, fechaFin) {
            try {
                if (!promocion) {
                    return { success: true, data: [] };
                }
                
                let query = `/stm_prom_topics?select=prom_topic_id,topic_date,topic_description,topic_strategy,topic_type,is_escalable,is_open,email,stm_prom_topics_categories!inner(stm_category!inner(category_name))&prom_name=eq.${encodeURIComponent(promocion)}`;
                
                if (fechaInicio && fechaFin) {
                    query += `&topic_date=gte.${fechaInicio}&topic_date=lte.${fechaFin}`;
                }
                
                query += '&order=topic_date.desc';
                
                const asuntos = await supabaseRequest(query);
                
                // Obtener emails √∫nicos
                const emailsUnicos = [...new Set(asuntos.map(a => a.email).filter(e => e))];
                
                // Obtener workers por email
                let workersMap = {};
                if (emailsUnicos.length > 0) {
                    const workers = await supabaseRequest(`/workers?select=email,worker_first_name,worker_last_name_1&email=in.(${emailsUnicos.map(e => `"${e}"`).join(',')})`);
                    workers.forEach(w => {
                        workersMap[w.email] = {
                            worker_first_name: w.worker_first_name,
                            worker_last_name_1: w.worker_last_name_1
                        };
                    });
                }
                
                // Procesar asuntos de promoci√≥n agrupando categor√≠as
                const asuntosConCategorias = asuntos.map(asunto => {
                    const categorias = asunto.stm_prom_topics_categories?.map(cat => cat.stm_category?.category_name).filter(Boolean).join(', ') || '';
                    const worker = workersMap[asunto.email] || {};
                    
                    return {
                        prom_topic_id: asunto.prom_topic_id,
                        topic_date: asunto.topic_date,
                        topic_description: asunto.topic_description,
                        topic_strategy: asunto.topic_strategy,
                        topic_type: asunto.topic_type,
                        is_escalable: asunto.is_escalable,
                        is_open: asunto.is_open,
                        worker_first_name: worker.worker_first_name || 'No especificado',
                        worker_last_name_1: worker.worker_last_name_1 || '',
                        categorias: categorias
                    };
                });
                
                return {
                    success: true,
                    data: asuntosConCategorias
                };
                
            } catch (error) {
                console.error('Error obteniendo asuntos de promoci√≥n:', error);
                return {
                    success: false,
                    message: 'Error al obtener asuntos de promoci√≥n: ' + error.message
                };
            }
        }

        /**
 * Obtiene asuntos por curso del a√±o acad√©mico actual
 */
async function obtenerAsuntosPorCurso(cursoId, yearId, fechaInicio, fechaFin) {
    try {
        if (!cursoId) {
            return { success: true, data: [] };
        }
        
        // Obtener fechas del a√±o acad√©mico actual si no se especifican
        let queryFechaInicio = fechaInicio;
        let queryFechaFin = fechaFin;
        
        if (!queryFechaInicio || !queryFechaFin) {
            // Obtener a√±o acad√©mico activo
            const yearData = await supabaseRequest('/system_config?select=academic_year_id,academic_years(year_start,year_end)&limit=1');
            if (yearData.length > 0 && yearData[0].academic_years) {
                queryFechaInicio = queryFechaInicio || yearData[0].academic_years.year_start;
                queryFechaFin = queryFechaFin || yearData[0].academic_years.year_end;
            }
        }
            let query = `/stm_prom_topics?select=prom_topic_id,topic_date,topic_description,topic_strategy,topic_type,is_escalable,is_open,email,course_id,academic_year_id,courses(course_name),stm_prom_topics_categories!inner(stm_category!inner(category_name))&course_id=eq.${cursoId}`;
            // Agregar filtro por a√±o acad√©mico si se especific√≥
            if (yearId) {
                query += `&academic_year_id=eq.${yearId}`;
            }         
            
        
        if (queryFechaInicio && queryFechaFin) {
            query += `&topic_date=gte.${queryFechaInicio}&topic_date=lte.${queryFechaFin}`;
        }
        
        query += '&order=topic_date.desc';
        
        const asuntos = await supabaseRequest(query);
        
        // Obtener emails √∫nicos
        const emailsUnicos = [...new Set(asuntos.map(a => a.email).filter(e => e))];
        
        // Obtener workers por email
        let workersMap = {};
        if (emailsUnicos.length > 0) {
            const workers = await supabaseRequest(`/workers?select=email,worker_first_name,worker_last_name_1&email=in.(${emailsUnicos.map(e => `"${e}"`).join(',')})`);
            workers.forEach(w => {
                workersMap[w.email] = {
                    worker_first_name: w.worker_first_name,
                    worker_last_name_1: w.worker_last_name_1
                };
            });
        }
        
        // Procesar asuntos agrupando categor√≠as
        const asuntosConCategorias = asuntos.map(asunto => {
            const categorias = asunto.stm_prom_topics_categories?.map(cat => cat.stm_category?.category_name).filter(Boolean).join(', ') || '';
            const worker = workersMap[asunto.email] || {};
            
            return {
                prom_topic_id: asunto.prom_topic_id,
                topic_date: asunto.topic_date,
                topic_description: asunto.topic_description,
                topic_strategy: asunto.topic_strategy,
                topic_type: asunto.topic_type,
                is_escalable: asunto.is_escalable,
                is_open: asunto.is_open,
                worker_first_name: worker.worker_first_name || 'No especificado',
                worker_last_name_1: worker.worker_last_name_1 || '',
                categorias: categorias
            };
        });
        
        return {
            success: true,
            data: asuntosConCategorias
        };
        
    } catch (error) {
        console.error('Error obteniendo asuntos por curso:', error);
        return {
            success: false,
            message: 'Error al obtener asuntos por curso: ' + error.message
        };
    }
}
        
        /**
         * Muestra la historia completa del estudiante
         */
        function mostrarHistoriaCompleta(data) {
            const container = document.getElementById('historia-content');
            
            container.innerHTML = `
                <div class="grid-estadisticas">
                    <div class="estadistica-card">
                        <span class="estadistica-numero">${data.asuntos.length}</span>
                        <div class="estadistica-label">Asuntos Registrados</div>
                    </div>
                    <div class="estadistica-card">
                        <span class="estadistica-numero">${data.tareas.length}</span>
                        <div class="estadistica-label">Tareas Asignadas</div>
                    </div>
                    <div class="estadistica-card">
                        <span class="estadistica-numero">${data.documentos.length}</span>
                        <div class="estadistica-label">Documentos Vinculados</div>
                    </div>
                    <div class="estadistica-card">
                        <span class="estadistica-numero">${data.asuntosPromocion.length}</span>
                        <div class="estadistica-label">Asuntos de Promoci√≥n</div>
                    </div>
                </div>
        
                <div class="historia-timeline">
                    ${generarTimelineHistoria(data)}
                </div>
            `;
        }

        /**
         * Genera el timeline de la historia
         */
        function generarTimelineHistoria(data) {
            const eventos = [];
            
            // Agregar asuntos
            data.asuntos.forEach(asunto => {
                eventos.push({
                    fecha: asunto.topic_date,
                    tipo: 'asunto',
                    data: asunto
                });
            });
            
            // Agregar tareas
            data.tareas.forEach(tarea => {
                eventos.push({
                    fecha: tarea.due_date,
                    tipo: 'tarea',
                    data: tarea
                });
            });
            
            // Ordenar por fecha (m√°s reciente primero)
            eventos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            if (eventos.length === 0) {
                return '<div class="sin-datos"><i class="bi bi-clipboard display-1 text-muted"></i><p>No hay eventos registrados para este estudiante en el per√≠odo seleccionado.</p></div>';
            }
            
            return eventos.map(evento => {
                switch (evento.tipo) {
                    case 'asunto':
                        return generarItemAsunto(evento.data);
                    case 'tarea':
                        return generarItemTarea(evento.data);
                    default:
                        return '';
                }
            }).join('');
        }


        /**
         * Genera item de asunto para el timeline
         */
        function generarItemAsunto(asunto) {
            const categorias = asunto.categorias ? 
                asunto.categorias.split(', ').map(cat => `<span class="categoria-tag">${escapeHtml(cat)}</span>`).join('') : '';
            
            return `
                <div class="timeline-item">
                    <div class="timeline-date"><i class="bi bi-file-text me-1"></i>${formatearFecha(asunto.topic_date)}</div>
                    <h4>Asunto Registrado</h4>
                    <div><strong>Descripci√≥n:</strong> 
                        <div class="mt-2 p-2 bg-light rounded">${asunto.topic_description || 'Sin descripci√≥n'}</div>
                    </div>
                    ${asunto.topic_strategy ? `<div class="mt-3"><strong>Estrategia:</strong> <div class="mt-2 p-2 bg-light rounded">${asunto.topic_strategy}</div></div>` : ''}
                    ${categorias ? `<div class="mt-2">${categorias}</div>` : ''}
                    <p class="mt-2 small text-muted">
                        <strong>Registrado por:</strong> ${escapeHtml(asunto.worker_first_name || 'No especificado')} ${escapeHtml(asunto.worker_last_name_1 || '')}
                        | <strong>Estado:</strong> ${asunto.is_open === 'SI' ? '<i class="bi bi-unlock text-success"></i> Abierto' : '<i class="bi bi-lock text-secondary"></i> Cerrado'}
                        ${asunto.is_escalable === 'SI' ? ' | <i class="bi bi-exclamation-triangle text-warning"></i> Escalable' : ''}
                    </p>
                </div>
            `;
        }

        
        /**
         * Genera item de tarea para el timeline
         */
        function generarItemTarea(tarea) {
            const estadoColor = tarea.task_state === 'Completada' ? 'text-success' : 
                               tarea.task_state === 'En proceso' ? 'text-warning' : 
                               'text-danger';
            
            return `
                <div class="timeline-item">
                    <div class="timeline-date"><i class="bi bi-check-square me-1"></i>${formatearFecha(tarea.due_date)} (Vencimiento)</div>
                    <h4>Tarea Asignada</h4>
                    <p><strong>Descripci√≥n:</strong> ${escapeHtml(tarea.task_description || 'Sin descripci√≥n')}</p>
                    ${tarea.task_progress ? `<p><strong>Progreso:</strong> ${escapeHtml(tarea.task_progress)}</p>` : ''}
                    <p class="mt-2 small text-muted">
                        <strong>Asignada a:</strong> ${escapeHtml(tarea.assigned_to_name || tarea.assigned_to_mail)}
                        | <strong>Estado:</strong> <span class="${estadoColor} fw-bold">${escapeHtml(tarea.task_state || 'Pendiente')}</span>
                        ${tarea.close_date ? `| <strong>Cerrada:</strong> ${formatearFecha(tarea.close_date)}` : ''}
                    </p>
                </div>
            `;
        }

      /**
         * Consulta asuntos por promoci√≥n
         */
        async function consultarAsuntosPromocion() {
            // Detectar tipo de consulta
            const tipoConsulta = document.querySelector('input[name="tipo-consulta-promo"]:checked').value;
            const fechaInicio = document.getElementById('fecha-inicio-promocion').value;
            const fechaFin = document.getElementById('fecha-fin-promocion').value;
            
            let promocion = null;
            let cursoId = null;
            let cursoNombre = null;
            let yearId = null;
            
            if (tipoConsulta === 'promocion') {
                promocion = document.getElementById('select-promocion').value;
                if (!promocion) {
                    showMessage('Por favor selecciona una promoci√≥n', 'warning');
                    return;
                }
            } else {
                cursoId = document.getElementById('select-curso-promo').value;
                
                if (!cursoId) {
                    showMessage('Por favor selecciona un curso', 'warning');
                    return;
                }
                
                const selectCurso = document.getElementById('select-curso-promo');
                const selectedOption = selectCurso.options[selectCurso.selectedIndex];
                cursoNombre = selectedOption.textContent;
                promocion = selectedOption.dataset.promotionCode;
            }

            // Si es consulta por curso, obtener el yearId
            if (tipoConsulta === 'curso') {
                yearId = document.getElementById('select-year-promo').value;
                
                if (!yearId) {
                    showMessage('Por favor selecciona un a√±o acad√©mico', 'warning');
                    return;
                }
            }
            
            try {
                showMessage('Consultando asuntos...', 'info');
                
                let asuntos;
                if (tipoConsulta === 'promocion') {
                    asuntos = await obtenerAsuntosPromocion(promocion, fechaInicio, fechaFin);
                } else {
                    asuntos = await obtenerAsuntosPorCurso(cursoId, yearId, fechaInicio, fechaFin);
                }
                
                if (asuntos.success) {
                    mostrarAsuntosPromocion(asuntos.data, tipoConsulta === 'promocion' ? `Promoci√≥n ${promocion}` : cursoNombre);
                    showMessage('Consulta completada', 'success');
                } else {
                    showMessage('Error: ' + asuntos.message, 'danger');
                }
                
            } catch (error) {
                console.error('Error al consultar:', error);
                showMessage('Error al consultar asuntos: ' + error.message, 'danger');
            }
        }

        /**
         * Muestra los asuntos de promoci√≥n
         */
        function mostrarAsuntosPromocion(asuntos, promocion) {
            const container = document.getElementById('promocion-resultados');
            
            if (asuntos.length === 0) {
                container.innerHTML = `
                    <div class="sin-datos">
                        <i class="bi bi-mortarboard display-1 text-muted"></i>
                        <p>No se encontraron asuntos para la promoci√≥n ${escapeHtml(promocion)} en el per√≠odo seleccionado.</p>
                    </div>
                `;
                return;
            }
            
            const resumen = {
                total: asuntos.length,
                escalables: asuntos.filter(a => a.is_escalable === 'SI').length,
                abiertos: asuntos.filter(a => a.is_open === 'SI').length,
                positivos: asuntos.filter(a => a.topic_type === 'Positivo').length,
                formativos: asuntos.filter(a => a.topic_type === 'Formativo').length
            };
            
            container.innerHTML = `
                <h4>Asuntos de la Promoci√≥n: ${escapeHtml(promocion)}</h4>
                
                <div class="grid-estadisticas">
                    <div class="estadistica-card">
                        <span class="estadistica-numero">${resumen.total}</span>
                        <div class="estadistica-label">Total Asuntos</div>
                    </div>
                    <div class="estadistica-card">
                        <span class="estadistica-numero" style="color: #198754;">${resumen.positivos}</span>
                        <div class="estadistica-label">Positivos</div>
                    </div>
                    <div class="estadistica-card">
                        <span class="estadistica-numero" style="color: #0dcaf0;">${resumen.formativos}</span>
                        <div class="estadistica-label">Formativos</div>
                    </div>
                    <div class="estadistica-card">
                        <span class="estadistica-numero" style="color: #ffc107;">${resumen.escalables}</span>
                        <div class="estadistica-label">Escalables</div>
                    </div>
                </div>
                
                <div class="mt-4">
                    ${asuntos.map(asunto => `
                        <div class="resultado-item">
                            <div class="resultado-meta">
                                <i class="bi bi-calendar me-1"></i>${formatearFecha(asunto.topic_date)} | 
                                <i class="bi bi-person me-1"></i>${escapeHtml(asunto.worker_first_name || 'No especificado')} ${escapeHtml(asunto.worker_last_name_1 || '')} |
                                ${asunto.topic_type ? `<span class="badge bg-info">${escapeHtml(asunto.topic_type)}</span>` : ''}
                                ${asunto.is_escalable === 'SI' ? ' | <i class="bi bi-exclamation-triangle text-warning"></i> Escalable' : ''}
                                ${asunto.is_open === 'SI' ? ' | <i class="bi bi-unlock text-success"></i> Abierto' : ' | <i class="bi bi-lock text-secondary"></i> Cerrado'}
                            </div>
                            <h4>Asunto de Promoci√≥n</h4>
                            <div><strong>Descripci√≥n:</strong> 
                                <div class="mt-2 p-2 bg-light rounded">${asunto.topic_description || 'Sin descripci√≥n'}</div>
                            </div>
                            ${asunto.topic_strategy ? `<div class="mt-3"><strong>Estrategia:</strong> <div class="mt-2 p-2 bg-light rounded">${asunto.topic_strategy}</div></div>` : ''}
                            ${asunto.categorias ? `<div class="mt-2">${asunto.categorias.split(', ').map(cat => `<span class="categoria-tag">${escapeHtml(cat)}</span>`).join('')}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        
        /**
         * Consulta estad√≠sticas por categor√≠as
         */
        async function consultarEstadisticasCategorias() {
            const fechaInicio = document.getElementById('fecha-inicio-stats').value;
            const fechaFin = document.getElementById('fecha-fin-stats').value;
            
            try {
                showMessage('Generando estad√≠sticas...', 'info');
                
                const estadisticas = await obtenerEstadisticasCategorias(fechaInicio, fechaFin);
                
                if (estadisticas.success) {
                    mostrarEstadisticasCategorias(estadisticas.data);
                    showMessage('Estad√≠sticas generadas correctamente', 'success');
                } else {
                    showMessage('Error: ' + estadisticas.message, 'danger');
                }
                
            } catch (error) {
                console.error('Error al consultar estad√≠sticas:', error);
                showMessage('Error al generar estad√≠sticas: ' + error.message, 'danger');
            }
        }

        /**
         * Obtiene estad√≠sticas por categor√≠as
         */
        async function obtenerEstadisticasCategorias(fechaInicio, fechaFin) {
            try {
                // Obtener todas las categor√≠as
                const categorias = await supabaseRequest('/stm_category?select=category_id,category_name&order=category_name');
                
                const estadisticasEstudiantes = [];
                const estadisticasPromociones = [];
                
                // Para cada categor√≠a, obtener estad√≠sticas
                for (const categoria of categorias) {
                    // Estad√≠sticas de estudiantes
                    let queryEstudiantes = `/stm_students_topics_categories?select=stm_students_topics!inner(student_id,is_escalable,is_open,topic_date)&category_id=eq.${categoria.category_id}`;
                    
                    if (fechaInicio && fechaFin) {
                        queryEstudiantes += `&stm_students_topics.topic_date=gte.${fechaInicio}&stm_students_topics.topic_date=lte.${fechaFin}`;
                    }
                    
                    const asuntosEstudiantes = await supabaseRequest(queryEstudiantes);
                    
                    const estudiantesUnicos = new Set();
                    let escalables = 0;
                    let abiertos = 0;
                    
                    asuntosEstudiantes.forEach(item => {
                        const asunto = item.stm_students_topics;
                        estudiantesUnicos.add(asunto.student_id);
                        if (asunto.is_escalable === 'SI') escalables++;
                        if (asunto.is_open === 'SI') abiertos++;
                    });
                    
                    estadisticasEstudiantes.push({
                        category_name: categoria.category_name,
                        total_asuntos: asuntosEstudiantes.length,
                        estudiantes_afectados: estudiantesUnicos.size,
                        asuntos_escalables: escalables,
                        asuntos_abiertos: abiertos
                    });
                    
                    // Estad√≠sticas de promociones
                    let queryPromociones = `/stm_prom_topics_categories?select=stm_prom_topics!inner(prom_topic_id,prom_name,topic_date)&category_id=eq.${categoria.category_id}`;
                    
                    if (fechaInicio && fechaFin) {
                        queryPromociones += `&stm_prom_topics.topic_date=gte.${fechaInicio}&stm_prom_topics.topic_date=lte.${fechaFin}`;
                    }
                    
                    const asuntosPromociones = await supabaseRequest(queryPromociones);
                    
                    const promocionesUnicas = new Set();
                    asuntosPromociones.forEach(item => {
                        const asunto = item.stm_prom_topics;
                        if (asunto.prom_name) promocionesUnicas.add(asunto.prom_name);
                    });
                    
                    estadisticasPromociones.push({
                        category_name: categoria.category_name,
                        total_asuntos_prom: asuntosPromociones.length,
                        promociones_afectadas: promocionesUnicas.size
                    });
                }
                
                return {
                    success: true,
                    data: {
                        estudiantes: estadisticasEstudiantes,
                        promociones: estadisticasPromociones
                    }
                };
                
            } catch (error) {
                console.error('Error obteniendo estad√≠sticas:', error);
                return {
                    success: false,
                    message: 'Error al obtener estad√≠sticas por categor√≠as: ' + error.message
                };
            }
        }

        /**
         * Muestra las estad√≠sticas por categor√≠as
         */
        function mostrarEstadisticasCategorias(data) {
            const container = document.getElementById('estadisticas-container');
            
            if (!data.estudiantes || data.estudiantes.length === 0) {
                container.innerHTML = `
                    <div class="sin-datos">
                        <i class="bi bi-bar-chart display-1 text-muted"></i>
                        <p>No se encontraron datos estad√≠sticos para el per√≠odo seleccionado.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="mb-4">
                    <h4><i class="bi bi-bar-chart me-2"></i>Estad√≠sticas de Asuntos por Categor√≠a - Estudiantes</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Categor√≠a</th>
                                    <th>Total Asuntos</th>
                                    <th>Estudiantes Afectados</th>
                                    <th>Escalables</th>
                                    <th>Abiertos</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.estudiantes.map(cat => `
                                    <tr>
                                        <td><strong>${escapeHtml(cat.category_name)}</strong></td>
                                        <td>${cat.total_asuntos || 0}</td>
                                        <td>${cat.estudiantes_afectados || 0}</td>
                                        <td>${cat.asuntos_escalables || 0}</td>
                                        <td>${cat.asuntos_abiertos || 0}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                ${data.promociones && data.promociones.some(p => p.total_asuntos_prom > 0) ? `
                    <div class="mb-4">
                        <h4><i class="bi bi-mortarboard me-2"></i>Estad√≠sticas de Asuntos por Categor√≠a - Promociones</h4>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Categor√≠a</th>
                                        <th>Total Asuntos</th>
                                        <th>Promociones Afectadas</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.promociones.filter(p => p.total_asuntos_prom > 0).map(cat => `
                                        <tr>
                                            <td><strong>${escapeHtml(cat.category_name)}</strong></td>
                                            <td>${cat.total_asuntos_prom || 0}</td>
                                            <td>${cat.promociones_afectadas || 0}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
            `;
        }
      /**
         * Consulta an√°lisis de tareas
         */
        async function consultarAnalisisTareas() {
            const asignadoA = document.getElementById('select-usuario').value;
            const fechaInicio = document.getElementById('fecha-inicio-tareas').value;
            const fechaFin = document.getElementById('fecha-fin-tareas').value;
            
            try {
                showMessage('Analizando tareas...', 'info');
                
                const analisis = await obtenerAnalisisTareas(fechaInicio, fechaFin, asignadoA);
                
                if (analisis.success) {
                    mostrarAnalisisTareas(analisis.data);
                    showMessage('An√°lisis completado', 'success');
                } else {
                    showMessage('Error: ' + analisis.message, 'danger');
                }
                
            } catch (error) {
                console.error('Error al analizar tareas:', error);
                showMessage('Error al analizar tareas: ' + error.message, 'danger');
            }
        }

        /**
         * Obtiene an√°lisis de tareas
         */
        async function obtenerAnalisisTareas(fechaInicio, fechaFin, asignadoA) {
            try {
                let query = '/tasks?select=assigned_to_mail,assigned_to_name,task_state,due_date,close_date';
                let conditions = [];
                
                if (fechaInicio && fechaFin) {
                    conditions.push(`due_date=gte.${fechaInicio}`);
                    conditions.push(`due_date=lte.${fechaFin}`);
                }
                
                if (asignadoA && asignadoA.trim() !== '') {
                    conditions.push(`assigned_to_mail=eq.${encodeURIComponent(asignadoA.trim())}`);
                }
                
                if (conditions.length > 0) {
                    query += '&' + conditions.join('&');
                }
                
                const tareas = await supabaseRequest(query);
                
                // Procesar datos para an√°lisis por usuario
                const analisisPorUsuario = {};
                const hoy = new Date();
                
                tareas.forEach(tarea => {
                    const email = tarea.assigned_to_mail;
                    const nombre = tarea.assigned_to_name || email;
                    
                    if (!analisisPorUsuario[email]) {
                        analisisPorUsuario[email] = {
                            assigned_to_mail: email,
                            assigned_to_name: nombre,
                            total_tareas: 0,
                            tareas_completadas: 0,
                            tareas_pendientes: 0,
                            tareas_en_progreso: 0,
                            tareas_vencidas: 0,
                            dias_retraso: []
                        };
                    }
                    
                    const analisis = analisisPorUsuario[email];
                    analisis.total_tareas++;
                    
                    switch (tarea.task_state) {
                        case 'Completada':
                            analisis.tareas_completadas++;
                            // Calcular d√≠as de retraso si aplica
                            if (tarea.close_date && tarea.due_date) {
                                const fechaVencimiento = new Date(tarea.due_date);
                                const fechaCierre = new Date(tarea.close_date);
                                const diasRetraso = Math.ceil((fechaCierre - fechaVencimiento) / (1000 * 60 * 60 * 24));
                                analisis.dias_retraso.push(diasRetraso);
                            }
                            break;
                        case 'En proceso':
                        case 'En Progreso':
                            analisis.tareas_en_progreso++;
                            break;
                        default:
                            analisis.tareas_pendientes++;
                    }
                    
                    // Verificar si est√° vencida
                    if (tarea.due_date && tarea.task_state !== 'Completada') {
                        const fechaVencimiento = new Date(tarea.due_date);
                        if (fechaVencimiento < hoy) {
                            analisis.tareas_vencidas++;
                        }
                    }
                });
                
                // Calcular promedio de d√≠as de retraso
                const resultados = Object.values(analisisPorUsuario).map(analisis => {
                    const promedio = analisis.dias_retraso.length > 0 ? 
                        analisis.dias_retraso.reduce((a, b) => a + b, 0) / analisis.dias_retraso.length : 0;
                    
                    return {
                        ...analisis,
                        promedio_dias_retraso: promedio
                    };
                });
                
                // Ordenar por total de tareas
                resultados.sort((a, b) => b.total_tareas - a.total_tareas);
                
                return {
                    success: true,
                    data: resultados
                };
                
            } catch (error) {
                console.error('Error obteniendo an√°lisis de tareas:', error);
                return {
                    success: false,
                    message: 'Error al obtener an√°lisis de tareas: ' + error.message
                };
            }
        }

        /**
         * Muestra el an√°lisis de tareas
         */
        function mostrarAnalisisTareas(datos) {
            const container = document.getElementById('tareas-resultados');
            
            if (!datos || datos.length === 0) {
                container.innerHTML = `
                    <div class="sin-datos">
                        <i class="bi bi-check-square display-1 text-muted"></i>
                        <p>No se encontraron tareas para el per√≠odo y criterios seleccionados.</p>
                    </div>
                `;
                return;
            }
            
            // Calcular totales
            const totales = datos.reduce((acc, usuario) => {
                acc.totalTareas += parseInt(usuario.total_tareas) || 0;
                acc.completadas += parseInt(usuario.tareas_completadas) || 0;
                acc.pendientes += parseInt(usuario.tareas_pendientes) || 0;
                acc.enProgreso += parseInt(usuario.tareas_en_progreso) || 0;
                acc.vencidas += parseInt(usuario.tareas_vencidas) || 0;
                return acc;
            }, { totalTareas: 0, completadas: 0, pendientes: 0, enProgreso: 0, vencidas: 0 });
            
            container.innerHTML = `
                <h4><i class="bi bi-check-square me-2"></i>An√°lisis de Rendimiento de Tareas</h4>
                
                <div class="grid-estadisticas">
                    <div class="estadistica-card">
                        <span class="estadistica-numero">${totales.totalTareas}</span>
                        <div class="estadistica-label">Total Tareas</div>
                    </div>
                    <div class="estadistica-card">
                        <span class="estadistica-numero" style="color: #198754;">${totales.completadas}</span>
                        <div class="estadistica-label">Completadas</div>
                    </div>
                    <div class="estadistica-card">
                        <span class="estadistica-numero" style="color: #ffc107;">${totales.enProgreso}</span>
                        <div class="estadistica-label">En Progreso</div>
                    </div>
                    <div class="estadistica-card">
                        <span class="estadistica-numero" style="color: #dc3545;">${totales.vencidas}</span>
                        <div class="estadistica-label">Vencidas</div>
                    </div>
                </div>
                
                <div class="table-responsive mt-4">
                    <table class="table table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Usuario</th>
                                <th>Total</th>
                                <th>Completadas</th>
                                <th>En Progreso</th>
                                <th>Pendientes</th>
                                <th>Vencidas</th>
                                <th>% Completadas</th>
                                <th>Promedio D√≠as Retraso</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${datos.map(usuario => {
                                const totalTareas = parseInt(usuario.total_tareas) || 0;
                                const completadas = parseInt(usuario.tareas_completadas) || 0;
                                const porcentajeCompletadas = totalTareas > 0 ? Math.round((completadas / totalTareas) * 100) : 0;
                                const promedioRetraso = parseFloat(usuario.promedio_dias_retraso) || 0;
                                
                                return `
                                    <tr>
                                        <td><strong>${escapeHtml(usuario.assigned_to_name || usuario.assigned_to_mail)}</strong></td>
                                        <td>${totalTareas}</td>
                                        <td><span class="text-success">${completadas}</span></td>
                                        <td><span class="text-warning">${usuario.tareas_en_progreso || 0}</span></td>
                                        <td>${usuario.tareas_pendientes || 0}</td>
                                        <td><span class="text-danger">${usuario.tareas_vencidas || 0}</span></td>
                                        <td>
                                            <span class="${porcentajeCompletadas >= 80 ? 'text-success' : porcentajeCompletadas >= 60 ? 'text-warning' : 'text-danger'}">
                                                ${porcentajeCompletadas}%
                                            </span>
                                        </td>
                                        <td>
                                            <span class="${promedioRetraso <= 0 ? 'text-success' : promedioRetraso <= 3 ? 'text-warning' : 'text-danger'}">
                                                ${promedioRetraso.toFixed(1)} d√≠as
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        /**
         * Consulta estado de metas
         */
        async function consultarEstadoMetas() {
            showMessage('La funcionalidad de metas no est√° disponible en este momento', 'info');
            
            const container = document.getElementById('metas-resultados');
            container.innerHTML = `
                <div class="sin-datos">
                    <i class="bi bi-target display-1 text-muted"></i>
                    <p>La funcionalidad de seguimiento de metas est√° temporalmente deshabilitada.</p>
                </div>
            `;
        }

        /**
         * Obtiene estado de metas
         */
        async function obtenerEstadoMetas(fechaInicio, fechaFin, estado) {
            return {
                success: true,
                data: {
                    metas: [],
                    estadisticas: {
                        total: 0,
                        rojas: 0,
                        amarillas: 0,
                        verdes: 0,
                        sin_estado: 0
                    }
                }
            };
        }

        /**
         * Muestra el estado de metas
         */
        function mostrarEstadoMetas(data) {
            const container = document.getElementById('metas-resultados');
            
            container.innerHTML = `
                <div class="sin-datos">
                    <i class="bi bi-target display-1 text-muted"></i>
                    <p>La funcionalidad de seguimiento de metas est√° temporalmente deshabilitada.</p>
                </div>
            `;
        }

       
        
        
        /**
         * Genera reporte consolidado
         */
        async function generarReporteConsolidado() {
            const tipoReporte = document.getElementById('tipo-reporte').value;
            const fechaInicio = document.getElementById('fecha-inicio-reportes').value;
            const fechaFin = document.getElementById('fecha-fin-reportes').value;
            
            try {
                showMessage('Generando reporte consolidado...', 'info');
                
                const reporte = await obtenerReporteConsolidado(fechaInicio, fechaFin, tipoReporte);
                
                if (reporte.success) {
                    mostrarReporteConsolidado(reporte.data, tipoReporte);
                    showMessage('Reporte generado correctamente', 'success');
                } else {
                    showMessage('Error: ' + reporte.message, 'danger');
                }
                
            } catch (error) {
                console.error('Error al generar reporte:', error);
                showMessage('Error al generar reporte: ' + error.message, 'danger');
            }
        }

        /**
         * Obtiene reporte consolidado
         */
        async function obtenerReporteConsolidado(fechaInicio, fechaFin, tipoReporte) {
            try {
                const reporteData = {};
                
                if (tipoReporte === 'general' || tipoReporte === 'asuntos') {
                    // Resumen de asuntos
                    let queryAsuntos = '/stm_students_topics?select=student_id,is_escalable,is_open';
                    
                    if (fechaInicio && fechaFin) {
                        queryAsuntos += `&topic_date=gte.${fechaInicio}&topic_date=lte.${fechaFin}`;
                    }
                    
                    const asuntos = await supabaseRequest(queryAsuntos);
                    
                    const estudiantesUnicos = new Set();
                    let escalables = 0;
                    let abiertos = 0;
                    
                    asuntos.forEach(asunto => {
                        estudiantesUnicos.add(asunto.student_id);
                        if (asunto.is_escalable === 'SI') escalables++;
                        if (asunto.is_open === 'SI') abiertos++;
                    });
                    
                    reporteData.asuntos = {
                        total_asuntos: asuntos.length,
                        estudiantes_con_asuntos: estudiantesUnicos.size,
                        asuntos_escalables: escalables,
                        asuntos_abiertos: abiertos
                    };
                }
                
                if (tipoReporte === 'general' || tipoReporte === 'tareas') {
                    // Resumen de tareas
                    let queryTareas = '/tasks?select=task_state,due_date,assigned_to_mail';
                    
                    if (fechaInicio && fechaFin) {
                        queryTareas += `&due_date=gte.${fechaInicio}&due_date=lte.${fechaFin}`;
                    }
                    
                    const tareas = await supabaseRequest(queryTareas);
                    
                    const hoy = new Date();
                    let completadas = 0;
                    let pendientes = 0;
                    let enProgreso = 0;
                    let vencidas = 0;
                    const usuariosUnicos = new Set();
                    
                    tareas.forEach(tarea => {
                        if (tarea.assigned_to_mail) usuariosUnicos.add(tarea.assigned_to_mail);
                        
                        switch (tarea.task_state) {
                            case 'Completada':
                                completadas++;
                                break;
                            case 'En proceso':
                            case 'En Progreso':
                                enProgreso++;
                                break;
                            default:
                                pendientes++;
                        }
                        
                        if (tarea.due_date && tarea.task_state !== 'Completada') {
                            const fechaVencimiento = new Date(tarea.due_date);
                            if (fechaVencimiento < hoy) {
                                vencidas++;
                            }
                        }
                    });
                    
                    reporteData.tareas = {
                        total_tareas: tareas.length,
                        tareas_completadas: completadas,
                        tareas_pendientes: pendientes,
                        tareas_en_progreso: enProgreso,
                        tareas_vencidas: vencidas,
                        usuarios_con_tareas: usuariosUnicos.size
                    };
                }
                if (tipoReporte === 'general' || tipoReporte === 'metas') {
                    // Metas deshabilitadas
                    reporteData.metas = {
                        total_metas: 0,
                        metas_rojas: 0,
                        metas_amarillas: 0,
                        metas_verdes: 0,
                        estudiantes_con_metas: 0
                    };
                }
                
                
                return {
                    success: true,
                    data: reporteData
                };
                
            } catch (error) {
                console.error('Error obteniendo reporte consolidado:', error);
                return {
                    success: false,
                    message: 'Error al generar reporte consolidado: ' + error.message
                };
            }
        }

        /**
         * Muestra el reporte consolidado
         */
        function mostrarReporteConsolidado(data, tipoReporte) {
            const container = document.getElementById('reportes-resultados');
            const nombreTipo = {
                'general': 'General Completo',
                'asuntos': 'Solo Asuntos',
                'tareas': 'Solo Tareas',
                'metas': 'Solo Metas'
            };
            
            let contenido = `<h4><i class="bi bi-file-text me-2"></i>Reporte Consolidado: ${nombreTipo[tipoReporte]}</h4>`;
            
            if (data.asuntos) {
                contenido += `
                    <div class="consulta-section">
                        <h5><i class="bi bi-file-text me-2"></i>Resumen de Asuntos</h5>
                        <div class="grid-estadisticas">
                            <div class="estadistica-card">
                                <span class="estadistica-numero">${data.asuntos.total_asuntos || 0}</span>
                                <div class="estadistica-label">Total Asuntos</div>
                            </div>
                            <div class="estadistica-card">
                                <span class="estadistica-numero">${data.asuntos.estudiantes_con_asuntos || 0}</span>
                                <div class="estadistica-label">Estudiantes Afectados</div>
                            </div>
                            <div class="estadistica-card">
                                <span class="estadistica-numero" style="color: #ffc107;">${data.asuntos.asuntos_escalables || 0}</span>
                                <div class="estadistica-label">Escalables</div>
                            </div>
                            <div class="estadistica-card">
                                <span class="estadistica-numero" style="color: #198754;">${data.asuntos.asuntos_abiertos || 0}</span>
                                <div class="estadistica-label">Abiertos</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (data.tareas) {
                const totalTareas = parseInt(data.tareas.total_tareas) || 0;
                const completadas = parseInt(data.tareas.tareas_completadas) || 0;
                const porcentajeCompletadas = totalTareas > 0 ? Math.round((completadas / totalTareas) * 100) : 0;
                
                contenido += `
                    <div class="consulta-section">
                        <h5><i class="bi bi-check-square me-2"></i>Resumen de Tareas</h5>
                        <div class="grid-estadisticas">
                            <div class="estadistica-card">
                                <span class="estadistica-numero">${data.tareas.total_tareas || 0}</span>
                                <div class="estadistica-label">Total Tareas</div>
                            </div>
                            <div class="estadistica-card">
                                <span class="estadistica-numero" style="color: #198754;">${data.tareas.tareas_completadas || 0}</span>
                                <div class="estadistica-label">Completadas</div>
                            </div>
                            <div class="estadistica-card">
                                <span class="estadistica-numero" style="color: #ffc107;">${data.tareas.tareas_en_progreso || 0}</span>
                                <div class="estadistica-label">En Progreso</div>
                            </div>
                            <div class="estadistica-card">
                                <span class="estadistica-numero" style="color: #dc3545;">${data.tareas.tareas_vencidas || 0}</span>
                                <div class="estadistica-label">Vencidas</div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <span style="font-size: 24px; font-weight: 600; color: ${porcentajeCompletadas >= 80 ? '#198754' : porcentajeCompletadas >= 60 ? '#ffc107' : '#dc3545'};">
                                ${porcentajeCompletadas}% de Cumplimiento
                            </span>
                        </div>
                    </div>
                `;
            }
            
            if (data.metas) {
                const totalMetas = parseInt(data.metas.total_metas) || 0;
                const verdes = parseInt(data.metas.metas_verdes) || 0;
                const porcentajeExito = totalMetas > 0 ? Math.round((verdes / totalMetas) * 100) : 0;
                
                contenido += `
                    <div class="consulta-section">
                        <h5><i class="bi bi-target me-2"></i>Resumen de Metas</h5>
                        <div class="grid-estadisticas">
                            <div class="estadistica-card">
                                <span class="estadistica-numero">${data.metas.total_metas || 0}</span>
                                <div class="estadistica-label">Total Metas</div>
                            </div>
                            <div class="estadistica-card" style="border-left-color: ${coloresSemaforo.red};">
                                <span class="estadistica-numero" style="color: ${coloresSemaforo.red};">${data.metas.metas_rojas || 0}</span>
                                <div class="estadistica-label">üî¥ Rojas</div>
                            </div>
                            <div class="estadistica-card" style="border-left-color: ${coloresSemaforo.yellow};">
                                <span class="estadistica-numero" style="color: ${coloresSemaforo.yellow};">${data.metas.metas_amarillas || 0}</span>
                                <div class="estadistica-label">üü° Amarillas</div>
                            </div>
                            <div class="estadistica-card" style="border-left-color: ${coloresSemaforo.green};">
                                <span class="estadistica-numero" style="color: ${coloresSemaforo.green};">${data.metas.metas_verdes || 0}</span>
                                <div class="estadistica-label">üü¢ Verdes</div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <span style="font-size: 24px; font-weight: 600; color: ${porcentajeExito >= 70 ? '#198754' : porcentajeExito >= 50 ? '#ffc107' : '#dc3545'};">
                                ${porcentajeExito}% de √âxito (Metas Verdes)
                            </span>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = contenido;
        }

        /**
         * B√∫squeda avanzada por texto
         */
        async function buscarTextoAvanzado() {
            const texto = document.getElementById('texto-busqueda').value.trim();
            const fechaInicio = document.getElementById('fecha-inicio-busqueda').value;
            const fechaFin = document.getElementById('fecha-fin-busqueda').value;
            
            if (!texto || texto.length < 3) {
                showMessage('Por favor ingresa al menos 3 caracteres para buscar', 'warning');
                return;
            }
            
            try {
                showMessage('Buscando...', 'info');
                
                const resultados = await buscarAsuntosPorTexto(texto, fechaInicio, fechaFin);
                
                if (resultados.success) {
                    mostrarResultadosBusquedaAvanzada(resultados.data, texto);
                    showMessage('B√∫squeda completada', 'success');
                } else {
                    showMessage('Error: ' + resultados.message, 'danger');
                }
                
            } catch (error) {
                console.error('Error en b√∫squeda avanzada:', error);
                showMessage('Error en b√∫squeda avanzada: ' + error.message, 'danger');
            }
        }

        /**
         * Busca asuntos por texto
         */
        async function buscarAsuntosPorTexto(textoFiltro, fechaInicio, fechaFin) {
            try {
                const filtroLike = `%${textoFiltro}%`;
                
                let query = `/stm_students_topics?select=topic_id,student_id,topic_date,topic_description,topic_strategy,topic_type,is_escalable,is_open,email,students!inner(student_code,student_first_name,student_last_name_1,student_last_name_2,courses!inner(course_name)),stm_students_topics_categories!inner(stm_category!inner(category_name))&or=(topic_description.ilike.${encodeURIComponent(filtroLike)},topic_strategy.ilike.${encodeURIComponent(filtroLike)})`;
                
                if (fechaInicio && fechaFin) {
                    query += `&topic_date=gte.${fechaInicio}&topic_date=lte.${fechaFin}`;
                }
                
                query += '&order=topic_date.desc&limit=100';
                
                const asuntos = await supabaseRequest(query);
                
                // Obtener emails √∫nicos
                const emailsUnicos = [...new Set(asuntos.map(a => a.email).filter(e => e))];
                
                // Obtener workers por email
                let workersMap = {};
                if (emailsUnicos.length > 0) {
                    const workers = await supabaseRequest(`/workers?select=email,worker_first_name,worker_last_name_1&email=in.(${emailsUnicos.map(e => `"${e}"`).join(',')})`);
                    workers.forEach(w => {
                        workersMap[w.email] = {
                            worker_first_name: w.worker_first_name,
                            worker_last_name_1: w.worker_last_name_1
                        };
                    });
                }
                
                // Procesar asuntos para estructura plana con categor√≠as agrupadas
                const asuntosFormateados = asuntos.map(asunto => {
                    const categorias = asunto.stm_students_topics_categories?.map(cat => cat.stm_category?.category_name).filter(Boolean).join(', ') || '';
                    const worker = workersMap[asunto.email] || {};
                    
                    return {
                        topic_id: asunto.topic_id,
                        student_id: asunto.student_id,
                        topic_date: asunto.topic_date,
                        topic_description: asunto.topic_description,
                        topic_strategy: asunto.topic_strategy,
                        topic_type: asunto.topic_type,
                        is_escalable: asunto.is_escalable,
                        is_open: asunto.is_open,
                        student_code: asunto.students?.student_code,
                        student_first_name: asunto.students?.student_first_name,
                        student_last_name_1: asunto.students?.student_last_name_1,
                        student_last_name_2: asunto.students?.student_last_name_2,
                        course_name: asunto.students?.courses?.course_name,
                        worker_first_name: worker.worker_first_name || 'No especificado',
                        worker_last_name_1: worker.worker_last_name_1 || '',
                        categorias: categorias
                    };
                });
                
                return {
                    success: true,
                    data: asuntosFormateados
                };
                
            } catch (error) {
                console.error('Error buscando por texto:', error);
                return {
                    success: false,
                    message: 'Error al buscar asuntos por texto: ' + error.message
                };
            }
        }

     
        /**
         * Muestra resultados de b√∫squeda avanzada
         */
        function mostrarResultadosBusquedaAvanzada(asuntos, textoBuscado) {
            const container = document.getElementById('busqueda-resultados');
            
            if (asuntos.length === 0) {
                container.innerHTML = `
                    <div class="sin-datos">
                        <i class="bi bi-search display-1 text-muted"></i>
                        <p>No se encontraron resultados para "${escapeHtml(textoBuscado)}" en el per√≠odo seleccionado.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <h4><i class="bi bi-search me-2"></i>Resultados de B√∫squeda: "${escapeHtml(textoBuscado)}"</h4>
                <p class="text-muted mb-4">
                    Se encontraron ${asuntos.length} asunto(s) que contienen el texto buscado.
                </p>
                
                <div>
                    ${asuntos.map(asunto => {
                        const fotoUrl = construirUrlFoto(asunto.student_code);
                        
                        return `
                            <div class="resultado-item">
                                <div class="resultado-meta">
                                    <i class="bi bi-calendar me-1"></i>${formatearFecha(asunto.topic_date)} | 
                                    <i class="bi bi-person me-1"></i>${escapeHtml(asunto.student_first_name)} ${escapeHtml(asunto.student_last_name_1)} ${escapeHtml(asunto.student_last_name_2 || '')} (${escapeHtml(asunto.student_code)}) |
                                    <i class="bi bi-mortarboard me-1"></i>${escapeHtml(asunto.course_name || 'Sin curso')} |
                                    <i class="bi bi-person-workspace me-1"></i>${escapeHtml(asunto.worker_first_name || 'No especificado')} ${escapeHtml(asunto.worker_last_name_1 || '')}
                                    ${asunto.is_escalable === 'SI' ? ' | <i class="bi bi-exclamation-triangle text-warning"></i> Escalable' : ''}
                                    ${asunto.is_open === 'SI' ? ' | <i class="bi bi-unlock text-success"></i> Abierto' : ' | <i class="bi bi-lock text-secondary"></i> Cerrado'}
                                </div>
                                <div class="d-flex align-items-start gap-3">
                                    <img class="estudiante-foto flex-shrink-0" src="${fotoUrl}" alt="Foto"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div style="display:none; width:50px; height:50px; border-radius:50%; background-color:#f8f9fa; border:2px solid #ddd; align-items:center; justify-content:center; font-size:20px; color:#6c757d;">
                                        <i class="bi bi-person-circle"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h4 class="mb-2">Asunto Encontrado</h4>
                                        <div><strong>Descripci√≥n:</strong> 
                                            <div class="mt-2 p-2 bg-light rounded">${resaltarTextoEnHTML(asunto.topic_description || 'Sin descripci√≥n', textoBuscado)}</div>
                                        </div>
                                        ${asunto.topic_strategy ? `<div class="mt-3"><strong>Estrategia:</strong> <div class="mt-2 p-2 bg-light rounded">${resaltarTextoEnHTML(asunto.topic_strategy, textoBuscado)}</div></div>` : ''}
                                        ${asunto.categorias ? `<div class="mt-2">${asunto.categorias.split(', ').map(cat => `<span class="categoria-tag">${escapeHtml(cat)}</span>`).join('')}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        
        /**
         * Resalta texto en HTML
         */
        function resaltarTextoEnHTML(textoHTML, busqueda) {
            if (!textoHTML || !busqueda) return textoHTML;
            
            const regex = new RegExp(`(${busqueda.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return textoHTML.replace(regex, '<mark style="background-color: yellow; padding: 2px 4px; border-radius: 3px;">$1</mark>');
        }
      /**
         * Valida rangos de fechas
         */
        function validarRangoFechas(fechaInicio, fechaFin) {
            if (!fechaInicio && !fechaFin) return true;
            
            if (fechaInicio && fechaFin) {
                const inicio = new Date(fechaInicio);
                const fin = new Date(fechaFin);
                
                if (inicio > fin) {
                    showMessage('La fecha de inicio no puede ser posterior a la fecha de fin', 'warning');
                    return false;
                }
                
                const diferenciaDias = Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24));
                if (diferenciaDias > 365) {
                    showMessage('El rango de fechas no puede ser mayor a un a√±o', 'warning');
                    return false;
                }
            }
            
            return true;
        }

        /**
         * Obtiene estad√≠sticas generales del sistema
         */
        async function obtenerEstadisticasGenerales() {
            try {
                // Contar totales generales en paralelo
                const [asuntosEstudiantes, asuntosPromocion, tareas, metas, documentos, estudiantesActivos] = await Promise.all([
                    supabaseRequest('/stm_students_topics?select=topic_id&limit=1', { headers: { 'Prefer': 'count=exact' } }),
                    supabaseRequest('/stm_prom_topics?select=prom_topic_id&limit=1', { headers: { 'Prefer': 'count=exact' } }),
                    supabaseRequest('/tasks?select=task_id&limit=1', { headers: { 'Prefer': 'count=exact' } }),
                    supabaseRequest('/stm_student_goals?select=goal_id&limit=1', { headers: { 'Prefer': 'count=exact' } }),
                    supabaseRequest('/stm_docs?select=doc_id&limit=1', { headers: { 'Prefer': 'count=exact' } }),
                    supabaseRequest('/students?select=student_id&status_id=eq.1&limit=1', { headers: { 'Prefer': 'count=exact' } })
                ]);

                // Estudiantes √∫nicos con asuntos
                const estudiantesConAsuntos = await supabaseRequest('/stm_students_topics?select=student_id');
                const estudiantesUnicos = new Set(estudiantesConAsuntos.map(a => a.student_id));

                return {
                    success: true,
                    data: {
                        total_asuntos_estudiantes: parseInt(asuntosEstudiantes[0]?.count || 0),
                        total_asuntos_promocion: parseInt(asuntosPromocion[0]?.count || 0),
                        total_tareas: parseInt(tareas[0]?.count || 0),
                        total_metas: parseInt(metas[0]?.count || 0),
                        total_documentos: parseInt(documentos[0]?.count || 0),
                        estudiantes_con_asuntos: estudiantesUnicos.size,
                        estudiantes_activos: parseInt(estudiantesActivos[0]?.count || 0)
                    }
                };
                
            } catch (error) {
                console.error('Error obteniendo estad√≠sticas generales:', error);
                return {
                    success: false,
                    message: 'Error al obtener estad√≠sticas generales: ' + error.message
                };
            }
        }

        /**
         * Muestra modal con detalles
         */
        function mostrarModal(titulo, contenido) {
            document.getElementById('modalTitulo').textContent = titulo;
            document.getElementById('modalContenido').innerHTML = contenido;
            
            const modal = new bootstrap.Modal(document.getElementById('modalDetalles'));
            modal.show();
        }

        /**
         * Exporta datos a CSV
         */
        function exportarCSV(datos, nombreArchivo) {
            if (!datos || datos.length === 0) {
                showMessage('No hay datos para exportar', 'warning');
                return;
            }

            try {
                // Obtener headers de las llaves del primer objeto
                const headers = Object.keys(datos[0]);
                
                // Crear contenido CSV
                let csvContent = headers.join(',') + '\n';
                
                datos.forEach(fila => {
                    const valores = headers.map(header => {
                        let valor = fila[header] || '';
                        // Escapar comillas y envolver en comillas si contiene comas
                        if (typeof valor === 'string') {
                            valor = valor.replace(/"/g, '""');
                            if (valor.includes(',') || valor.includes('\n') || valor.includes('"')) {
                                valor = `"${valor}"`;
                            }
                        }
                        return valor;
                    });
                    csvContent += valores.join(',') + '\n';
                });

                // Crear y descargar archivo
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `${nombreArchivo}_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage('Archivo CSV descargado correctamente', 'success');
                
            } catch (error) {
                console.error('Error exportando CSV:', error);
                showMessage('Error al exportar CSV: ' + error.message, 'danger');
            }
        }

        /**
         * Imprime contenido de un contenedor
         */
        function imprimirContenido(contenedorId, titulo = 'Reporte') {
            try {
                const contenido = document.getElementById(contenedorId);
                if (!contenido) {
                    showMessage('No hay contenido para imprimir', 'warning');
                    return;
                }

                const ventanaImpresion = window.open('', '_blank');
                ventanaImpresion.document.write(`
                    <html>
                        <head>
                            <title>${titulo}</title>
                            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                            <style>
                                @media print {
                                    .btn, .nav-tabs, .pagination { display: none !important; }
                                    .table { page-break-inside: avoid; }
                                    h1, h2, h3, h4, h5, h6 { page-break-after: avoid; }
                                }
                                .resultado-item { margin-bottom: 20px; page-break-inside: avoid; }
                                .timeline-item { page-break-inside: avoid; }
                            </style>
                        </head>
                        <body>
                            <div class="container-fluid">
                                <h1 class="text-center mb-4">${titulo}</h1>
                                <p class="text-center text-muted mb-4">Generado el ${new Date().toLocaleDateString('es-CO')}</p>
                                ${contenido.innerHTML}
                            </div>
                        </body>
                    </html>
                `);
                
                ventanaImpresion.document.close();
                ventanaImpresion.focus();
                ventanaImpresion.print();
                
            } catch (error) {
                console.error('Error imprimiendo:', error);
                showMessage('Error al imprimir: ' + error.message, 'danger');
            }
        }

        /**
         * Copia texto al portapapeles
         */
        async function copiarAlPortapapeles(texto) {
            try {
                await navigator.clipboard.writeText(texto);
                showMessage('Texto copiado al portapapeles', 'success');
            } catch (error) {
                console.error('Error copiando al portapapeles:', error);
                showMessage('Error al copiar al portapapeles', 'danger');
            }
        }

        /**
         * Formatea n√∫meros con separadores de miles
         */
        function formatearNumero(numero) {
            if (typeof numero !== 'number') {
                numero = parseFloat(numero) || 0;
            }
            return numero.toLocaleString('es-CO');
        }

        /**
         * Obtiene color para porcentajes
         */
        function obtenerColorPorcentaje(porcentaje, invertido = false) {
            if (invertido) {
                // Para casos donde menor es mejor (ej: tareas vencidas)
                if (porcentaje <= 10) return '#198754'; // Verde
                if (porcentaje <= 25) return '#ffc107'; // Amarillo
                return '#dc3545'; // Rojo
            } else {
                // Para casos donde mayor es mejor (ej: tareas completadas)
                if (porcentaje >= 80) return '#198754'; // Verde
                if (porcentaje >= 60) return '#ffc107'; // Amarillo
                return '#dc3545'; // Rojo
            }
        }

        /**
         * Genera ID √∫nico
         */
        function generarIdUnico() {
            return 'id_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        /**
         * Debounce function para optimizar b√∫squedas
         */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        /**
         * Verifica si una fecha est√° en rango
         */
        function fechaEnRango(fecha, fechaInicio, fechaFin) {
            if (!fecha) return false;
            if (!fechaInicio && !fechaFin) return true;
            
            const fechaObj = new Date(fecha);
            
            if (fechaInicio && fechaFin) {
                const inicio = new Date(fechaInicio);
                const fin = new Date(fechaFin);
                return fechaObj >= inicio && fechaObj <= fin;
            }
            
            if (fechaInicio) {
                const inicio = new Date(fechaInicio);
                return fechaObj >= inicio;
            }
            
            if (fechaFin) {
                const fin = new Date(fechaFin);
                return fechaObj <= fin;
            }
            
            return true;
        }

        /**
         * Manejo global de errores
         */
        window.addEventListener('error', function(e) {
            console.error('Error global capturado:', e.error);
            showMessage('Ha ocurrido un error inesperado. Por favor, recarga la p√°gina.', 'danger');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Promise rechazada:', e.reason);
            showMessage('Error de comunicaci√≥n. Por favor, verifica tu conexi√≥n.', 'danger');
        });

        /**
         * Funciones de localStorage para preferencias del usuario
         */
        function guardarPreferencia(clave, valor) {
            try {
                localStorage.setItem(`consultas_${clave}`, JSON.stringify(valor));
            } catch (error) {
                console.warn('No se pudo guardar preferencia:', error);
            }
        }

        function obtenerPreferencia(clave, valorPorDefecto = null) {
            try {
                const valor = localStorage.getItem(`consultas_${clave}`);
                return valor ? JSON.parse(valor) : valorPorDefecto;
            } catch (error) {
                console.warn('No se pudo obtener preferencia:', error);
                return valorPorDefecto;
            }
        }

        /**
         * Restaura preferencias del usuario
         */
        function restaurarPreferencias() {
            try {
                // Restaurar tab activo
                const tabActivo = obtenerPreferencia('tab_activo', 'historia');
                if (tabActivo && document.querySelector(`[data-tab="${tabActivo}"]`)) {
                    cambiarTab(tabActivo);
                }
                
                // Restaurar filtros de fechas si el usuario los hab√≠a configurado
                const fechasGuardadas = obtenerPreferencia('fechas_defecto');
                if (fechasGuardadas) {
                    if (fechasGuardadas.usarRangoPersonalizado) {
                        // Aplicar fechas personalizadas guardadas
                        document.getElementById('fecha-inicio-historia').value = fechasGuardadas.inicio || '';
                        document.getElementById('fecha-fin-historia').value = fechasGuardadas.fin || '';
                    }
                }
                
            } catch (error) {
                console.warn('Error restaurando preferencias:', error);
            }
        }

        /**
         * Guarda preferencias cuando el usuario cambia configuraciones
         */
        function guardarPreferenciasActuales() {
            try {
                // Guardar tab activo
                const tabActivo = document.querySelector('.tab-button.active')?.getAttribute('data-tab');
                if (tabActivo) {
                    guardarPreferencia('tab_activo', tabActivo);
                }
                
            } catch (error) {
                console.warn('Error guardando preferencias:', error);
            }
        }

        // Guardar preferencias al cambiar tabs
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('tab-button')) {
                setTimeout(guardarPreferenciasActuales, 100);
            }
        });

        // Restaurar preferencias al cargar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(restaurarPreferencias, 1000);
        });
      /**
         * Funci√≥n de limpieza al cerrar la p√°gina
         */
        window.addEventListener('beforeunload', function() {
            guardarPreferenciasActuales();
        });

        /**
         * Inicializaci√≥n completa del sistema de consultas
         */
        async function inicializarSistemaCompleto() {
            try {
                // Validar que todas las funciones cr√≠ticas est√©n disponibles
                if (typeof validatePageAccess !== 'function') {
                    throw new Error('Sistema de validaci√≥n de permisos no disponible');
                }
                
                if (typeof supabaseRequest !== 'function') {
                    throw new Error('Sistema de conexi√≥n a base de datos no disponible');
                }
                
                if (typeof showMessage !== 'function') {
                    throw new Error('Sistema de mensajes no disponible');
                }
                
                console.log('‚úÖ Sistema de consultas inicializado correctamente');
                console.log('üìä M√≥dulos disponibles: Historia, Promoci√≥n, Estad√≠sticas, Tareas, Metas, Reportes, B√∫squeda');
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n del sistema:', error);
                showMessage('Error cr√≠tico en la inicializaci√≥n: ' + error.message, 'danger');
                return false;
            }
        }

        /**
         * Funci√≥n de diagn√≥stico del sistema
         */
        async function diagnosticarSistema() {
            const diagnostico = {
                conexionDB: false,
                permisos: false,
                configuracion: false,
                funcionalidades: false
            };
            
            try {
                // Probar conexi√≥n a base de datos
                await supabaseRequest('/students?select=student_id&limit=1');
                diagnostico.conexionDB = true;
                
                // Probar sistema de permisos
                const session = getStoredSession();
                if (session && session.user) {
                    diagnostico.permisos = true;
                }
                
                // Probar configuraci√≥n
                const config = await supabaseRequest('/system_config?select=config_id&limit=1');
                if (config.length > 0) {
                    diagnostico.configuracion = true;
                }
                
                // Probar funcionalidades b√°sicas
                if (document.getElementById('buscar-estudiante') && 
                    document.getElementById('select-promocion') &&
                    document.getElementById('select-usuario')) {
                    diagnostico.funcionalidades = true;
                }
                
                console.log('üîç Diagn√≥stico del sistema:', diagnostico);
                
                const todoBien = Object.values(diagnostico).every(estado => estado === true);
                if (todoBien) {
                    console.log('‚úÖ Todos los sistemas funcionando correctamente');
                } else {
                    console.warn('‚ö†Ô∏è Algunos sistemas presentan problemas:', diagnostico);
                }
                
                return diagnostico;
                
            } catch (error) {
                console.error('‚ùå Error en diagn√≥stico:', error);
                return diagnostico;
            }
        }

        /**
         * Event listeners finales y configuraci√≥n de monitoreo
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Ejecutar diagn√≥stico despu√©s de la inicializaci√≥n
            setTimeout(async () => {
                const sistemaOK = await inicializarSistemaCompleto();
                if (sistemaOK) {
                    await diagnosticarSistema();
                }
            }, 2000);
            
            // Configurar monitoreo de performance
            if ('performance' in window) {
                window.addEventListener('load', function() {
                    setTimeout(() => {
                        const tiempoCarga = performance.timing.loadEventEnd - performance.timing.navigationStart;
                        console.log(`üìà Tiempo de carga de la p√°gina: ${tiempoCarga}ms`);
                        
                        if (tiempoCarga > 5000) {
                            console.warn('‚ö†Ô∏è P√°gina carg√≥ lentamente, considera optimizaciones');
                        }
                    }, 100);
                });
            }
        });

        /**
         * Funciones de accesibilidad
         */
        function configurarAccesibilidad() {
            // Agregar soporte para navegaci√≥n con teclado en tabs
            document.querySelectorAll('.tab-button').forEach((tab, index) => {
                tab.setAttribute('tabindex', '0');
                tab.setAttribute('role', 'tab');
                
                tab.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                    
                    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                        e.preventDefault();
                        const tabs = document.querySelectorAll('.tab-button');
                        let newIndex = index + (e.key === 'ArrowRight' ? 1 : -1);
                        
                        if (newIndex >= tabs.length) newIndex = 0;
                        if (newIndex < 0) newIndex = tabs.length - 1;
                        
                        tabs[newIndex].focus();
                        tabs[newIndex].click();
                    }
                });
            });
            
            // Mejorar contraste en elementos focuseados
            const style = document.createElement('style');
            style.textContent = `
                .tab-button:focus,
                .btn:focus,
                .form-control:focus,
                .form-select:focus {
                    outline: 2px solid #0d6efd !important;
                    outline-offset: 2px !important;
                }
                
                .estudiante-card:focus {
                    outline: 2px solid #0d6efd !important;
                    outline-offset: 2px !important;
                }
            `;
            document.head.appendChild(style);
        }

        // Configurar accesibilidad despu√©s de cargar
        document.addEventListener('DOMContentLoaded', configurarAccesibilidad);

        /**
         * Funci√≥n final de validaci√≥n de integridad
         */
        function validarIntegridadSistema() {
            const funcionesCriticas = [
                'buscarEstudiantesHandler',
                'consultarAsuntosPromocion', 
                'consultarEstadisticasCategorias',
                'consultarAnalisisTareas',
                'consultarEstadoMetas',
                'generarReporteConsolidado',
                'buscarTextoAvanzado'
            ];
            
            const faltantes = funcionesCriticas.filter(nombre => typeof window[nombre] !== 'function');
            
            if (faltantes.length > 0) {
                console.error('‚ùå Funciones cr√≠ticas faltantes:', faltantes);
                showMessage('Error: Sistema incompleto. Contacta al administrador.', 'danger');
                return false;
            }
            
            console.log('‚úÖ Todas las funciones cr√≠ticas est√°n disponibles');
            return true;
        }

        // Validar integridad al final de la carga
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(validarIntegridadSistema, 1500);
        });

        /**
         * Mensaje de copyright y versi√≥n
         */
        console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                     SCHOOLNET - CONSULTAS                   ‚ïë
‚ïë                  Sistema de Seguimiento Estudiantil         ‚ïë
‚ïë                                                              ‚ïë
‚ïë  Versi√≥n: 1.0.0                                             ‚ïë
‚ïë  Migrado desde GAS: Septiembre 2025                         ‚ïë
‚ïë  Desarrollado para: Colegio Tilata                          ‚ïë
‚ïë                                                              ‚ïë
‚ïë  Caracter√≠sticas:                                            ‚ïë
‚ïë  ‚Ä¢ 7 m√≥dulos de consulta integrados                         ‚ïë
‚ïë  ‚Ä¢ B√∫squeda avanzada por texto                              ‚ïë
‚ïë  ‚Ä¢ Reportes consolidados                                     ‚ïë
‚ïë  ‚Ä¢ Timeline de historia estudiantil                         ‚ïë
‚ïë  ‚Ä¢ An√°lisis estad√≠stico por categor√≠as                      ‚ïë
‚ïë  ‚Ä¢ Sistema de permisos integrado                            ‚ïë
‚ïë                                                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        `);
      /**
         * Inicializaci√≥n autom√°tica del sistema cuando el DOM est√© listo
         */
        (function() {
            console.log('üöÄ Iniciando sistema de consultas SchoolNet...');
            
            // Verificar dependencias cr√≠ticas
            const dependenciasCriticas = [
                { nombre: 'Bootstrap', check: () => typeof bootstrap !== 'undefined' },
                { nombre: 'Config.js', check: () => typeof validatePageAccess === 'function' },
                { nombre: 'Supabase', check: () => typeof supabaseRequest === 'function' }
            ];
            
            let dependenciasFaltantes = [];
            
            dependenciasCriticas.forEach(dep => {
                try {
                    if (!dep.check()) {
                        dependenciasFaltantes.push(dep.nombre);
                    }
                } catch (error) {
                    dependenciasFaltantes.push(dep.nombre);
                }
            });
            
            if (dependenciasFaltantes.length > 0) {
                console.error('‚ùå Dependencias faltantes:', dependenciasFaltantes);
                document.addEventListener('DOMContentLoaded', function() {
                    showMessage(`Error cr√≠tico: Dependencias faltantes: ${dependenciasFaltantes.join(', ')}`, 'danger');
                });
            } else {
                console.log('‚úÖ Todas las dependencias est√°n disponibles');
            }
        })();

        /**
         * Limpieza final y exportaci√≥n de funciones globales necesarias
         */
        
        // Funciones principales exportadas para uso global
        window.ConsultasSeguimiento = {
            buscarEstudiantes: buscarEstudiantesHandler,
            consultarPromocion: consultarAsuntosPromocion,
            generarEstadisticas: consultarEstadisticasCategorias,
            analizarTareas: consultarAnalisisTareas,
            consultarMetas: consultarEstadoMetas,
            generarReporte: generarReporteConsolidado,
            busquedaAvanzada: buscarTextoAvanzado,
            exportarCSV: exportarCSV,
            imprimir: imprimirContenido,
            diagnosticar: diagnosticarSistema
        };
        
        console.log('üì¶ API p√∫blica del m√≥dulo de consultas disponible en window.ConsultasSeguimiento');
        
    </script>
</body>
</html>
