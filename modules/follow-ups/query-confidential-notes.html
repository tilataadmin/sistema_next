<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultar Notas Confidenciales - Seguimientos - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .student-card { cursor: pointer; transition: all 0.2s; }
        .student-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .note-content { max-height: 100px; overflow-y: auto; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a></li>
                <li class="breadcrumb-item"><a href="index.html">Seguimientos</a></li>
                <li class="breadcrumb-item active">Consultar Notas Confidenciales</li>
            </ol>
        </nav>

        <div class="row mb-4">
            <div class="col">
                <h1 class="h3"><i class="bi bi-file-lock me-2"></i>Consultar Notas Confidenciales</h1>
                <p class="text-muted">BÃºsqueda y consulta de notas confidenciales</p>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Estudiante</label>
                        <input type="text" id="searchStudent" class="form-control" placeholder="Buscar por nombre...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Desde</label>
                        <input type="date" id="dateFrom" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Hasta</label>
                        <input type="date" id="dateTo" class="form-control">
                    </div>
                    <div class="col-12">
                        <button class="btn btn-danger" onclick="buscarNotas()"><i class="bi bi-search me-1"></i>Buscar</button>
                        <button class="btn btn-outline-secondary" onclick="limpiar()"><i class="bi bi-x-circle me-1"></i>Limpiar</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultados"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        let userEmail = null;
        let canViewAll = false;

        document.addEventListener('DOMContentLoaded', async function() {
            const hasAccess = await validatePageAccess('Consultar notas confidenciales');
            if (!hasAccess) return;
            initializePage('queryConfidentialNotes', 'Seguimientos');
            
            const session = getStoredSession();
            if (session?.user?.user_mail) {
                userEmail = session.user.user_mail;
                await verificarPermisos(session.user.user_id);
            }
        });

        async function verificarPermisos(userId) {
            try {
                const roles = await supabaseRequest(`/user_roles?select=roles(role_name,is_super_admin)&user_id=eq.${userId}`);
                
                const rolesUsuario = roles.map(r => r.roles.role_name);
                const esSuperAdmin = roles.some(r => r.roles.is_super_admin === true);
                
                canViewAll = esSuperAdmin || 
                            rolesUsuario.includes('Estrategas') || 
                            rolesUsuario.includes('Directivos docentes') || 
                            rolesUsuario.includes('EAE');
                
                console.log('Puede ver todas las notas:', canViewAll);
            } catch (error) {
                console.error('Error verificando permisos:', error);
            }
        }

        async function buscarNotas() {
            const search = document.getElementById('searchStudent').value.trim();
            const from = document.getElementById('dateFrom').value;
            const to = document.getElementById('dateTo').value;

            let query = '/stm_confidential_notes?select=confidential_note_id,confidential_note,created_at,students!inner(student_id,student_first_name,student_last_name_1,student_last_name_2)&order=created_at.desc';
            
            // FILTRO POR ROL
            if (!canViewAll && userEmail) {
                query += `&email=eq.${userEmail}`;
            }
            
            if (search) query += `&students.student_first_name.ilike.%${search}%`;
            if (from) query += `&created_at=gte.${from}`;
            if (to) query += `&created_at=lte.${to}`;

            try {
                const data = await supabaseRequest(query);
                mostrarResultados(data);
            } catch (error) {
                showMessage('Error al buscar: ' + error.message, 'danger');
            }
        }

        function mostrarResultados(data) {
            const container = document.getElementById('resultados');
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No se encontraron resultados</div>';
                return;
            }

            let html = '<div class="row g-3">';
            data.forEach(nota => {
                const nombre = `${nota.students.student_first_name} ${nota.students.student_last_name_1}`;
                html += `
                    <div class="col-md-6">
                        <div class="card student-card border-danger">
                            <div class="card-body">
                                <h6><i class="bi bi-person me-2"></i>${nombre}</h6>
                                <small class="text-muted">${formatDate(nota.created_at)}</small>
                                <div class="note-content mt-2 p-2 bg-light rounded">${nota.confidential_note}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function limpiar() {
            document.getElementById('searchStudent').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('resultados').innerHTML = '';
        }
    </script>
</body>
</html>
