<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Asuntos Grupales - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Estilos espec√≠ficos para el formulario de asuntos grupales */
        .rich-text-container {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background-color: white;
            overflow: hidden;
        }

        .rich-text-toolbar {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 8px;
            display: flex;
            gap: 4px;
            align-items: center;
            flex-wrap: wrap;
        }

        .rich-text-toolbar button {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            min-width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .rich-text-toolbar button:hover {
            background-color: #e9ecef;
            border-color: #1380e2;
        }

        .rich-text-toolbar button.active {
            background-color: #1380e2;
            color: white;
            border-color: #1380e2;
        }

        .toolbar-separator {
            color: #dee2e6;
            margin: 0 4px;
            font-weight: normal;
        }

        .rich-text-editor {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #212529;
            background-color: white;
            outline: none;
            word-wrap: break-word;
        }

        .rich-text-editor:empty:before {
            content: attr(data-placeholder);
            color: #6c757d;
            font-style: italic;
            pointer-events: none;
        }

        .rich-text-editor:focus {
            background-color: #fafbfc;
        }

        .rich-text-editor.has-content {
            border-left: 3px solid #198754;
        }

        .rich-text-editor.required-empty {
            border-left: 3px solid #dc3545;
        }

        /* Estilos para categor√≠as m√∫ltiples */
        .categorias-container {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            background-color: white;
            max-height: 250px;
            overflow-y: auto;
        }

        .categoria-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .categoria-item:hover {
            background-color: #f8f9fa;
        }

        .categoria-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.1);
        }

        .categoria-item label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
            flex: 1;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1380e2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Cargando...</p>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="../follow-ups/index.html">
                        Seguimientos
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Registrar Asuntos Grupales
                </li>
            </ol>
        </nav>

        <!-- Encabezado de p√°gina -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-people-fill me-2"></i>
                    Registrar Asuntos Grupales
                </h1>
                <p class="text-muted">
                    Formulario para registrar asuntos que afectan a grupos de estudiantes
                </p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Formulario principal -->
        <div class="card">
            <div class="card-body">
                <form id="form-asuntos-grupales">
                    <!-- Campo 1: Selector de Curso -->
                    <div class="form-group mb-3">
                        <label for="curso-select" class="form-label">
                            Curso <span class="text-danger">*</span>
                        </label>
                        <select 
                            id="curso-select" 
                            class="form-select"
                            required
                            disabled
                        >
                            <option value="">Cargando cursos...</option>
                        </select>
                        <div class="form-text">Seleccione el curso relacionado con el asunto grupal</div>
                    </div>

                    <!-- Campo 2: Categor√≠as m√∫ltiples -->
                    <div class="form-group mb-3">
                        <label class="form-label">
                            Categor√≠as <span class="text-danger">*</span>
                        </label>
                        <div id="categorias-container" class="categorias-container">
                            <div id="categorias-loading" class="text-center text-muted">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                Cargando categor√≠as...
                            </div>
                            <div id="categorias-checkboxes" style="display: none;">
                                <!-- Las categor√≠as se cargar√°n aqu√≠ din√°micamente -->
                            </div>
                        </div>
                        <div class="form-text">Seleccione una o m√°s categor√≠as que apliquen al asunto</div>
                    </div>

                    <!-- Campo 3: Descripci√≥n con editor enriquecido -->
                    <div class="form-group mb-4">
                        <label for="descripcion-editor" class="form-label">
                            Descripci√≥n del asunto <span class="text-danger">*</span>
                        </label>
                        <div class="rich-text-container">
                            <div class="rich-text-toolbar" data-target="descripcion-editor">
                                <button type="button" data-command="bold" title="Negrita"><b>B</b></button>
                                <button type="button" data-command="italic" title="Cursiva"><i>I</i></button>
                                <button type="button" data-command="underline" title="Subrayado"><u>U</u></button>
                                <span class="toolbar-separator">|</span>
                                <button type="button" data-command="insertUnorderedList" title="Lista con vi√±etas">‚Ä¢ Lista</button>
                                <button type="button" data-command="insertOrderedList" title="Lista numerada">1. Lista</button>
                                <span class="toolbar-separator">|</span>
                                <button type="button" data-command="removeFormat" title="Quitar formato">üßπ</button>
                            </div>
                            <div 
                                id="descripcion-editor" 
                                class="rich-text-editor" 
                                contenteditable="true" 
                                data-placeholder="Describe detalladamente el asunto que afecta al grupo..."
                                required
                            ></div>
                        </div>
                        <div class="form-text">Proporcione una descripci√≥n clara y detallada del asunto grupal</div>
                    </div>

                    <!-- Botones del formulario -->
                    <div class="d-flex justify-content-center gap-3">
                        <button type="submit" class="btn btn-success" disabled>
                            <i class="bi bi-check-circle me-1"></i>Guardar Asunto
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Limpiar
                        </button>
                        <button type="button" class="btn btn-info" onclick="abrirModalAsuntos()">
                            <i class="bi bi-journal-text me-1"></i>Ver mis asuntos
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

  <!-- Modal para ver asuntos reportados -->
    <div id="modal-asuntos" class="modal fade" tabindex="-1" style="display: none;">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-journal-text me-2"></i>Mis Asuntos Grupales Reportados
                    </h5>
                    <button type="button" class="btn-close" onclick="cerrarModalAsuntos()"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading del modal -->
                    <div id="modal-loading" style="display: none; text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p>Cargando asuntos...</p>
                    </div>
                    
                    <!-- Contenido de asuntos -->
                    <div id="contenido-asuntos" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-hover" id="tabla-asuntos">
                                <thead class="table-primary">
                                    <tr>
                                        <th style="width: 100px;">Fecha</th>
                                        <th style="width: 120px;">Promoci√≥n</th>
                                        <th style="width: 200px;">Categor√≠as</th>
                                        <th>Descripci√≥n</th>
                                        <th style="width: 80px;">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-asuntos-body">
                                    <!-- Contenido din√°mico -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Mensaje cuando no hay asuntos -->
                    <div id="sin-asuntos" style="display: none; text-align: center; padding: 40px; color: #6c757d;">
                        <i class="bi bi-journal-x" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h5>No hay asuntos reportados</h5>
                        <p>A√∫n no has registrado ning√∫n asunto grupal.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalAsuntos()">
                        <i class="bi bi-x-circle me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // Variables globales
        let todosCursos = [];
        let todasCategorias = [];
        let enviandoFormulario = false;
        let cursoSeleccionado = null;
        let categoriasSeleccionadas = [];

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Validar acceso
                const hasAccess = await validatePageAccess('Registrar asuntos grupales');
                if (!hasAccess) return;

                initializePage('groupIssues', 'Seguimientos');
                
                await Promise.all([
                    cargarDatosCompletos()
                ]);
                
                configurarEventos();
                configurarEditoresTexto();
                
            } catch (error) {
                console.error('Error inicializando:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        });

        // Cargar todos los datos necesarios
        async function cargarDatosCompletos() {
            try {
                showLoading();
                
                // Cargar cursos
                const cursos = await supabaseRequest('/courses?select=course_id,course_name,course_order,grades!inner(grade_id,grade_name,grade_order,sections!inner(section_id,section_name,director_mail))&order=course_order');
                todosCursos = cursos || [];
                
                // Cargar categor√≠as
                const categorias = await supabaseRequest('/stm_category?select=category_id,category_name&order=category_name');
                todasCategorias = categorias || [];
                
                // Cargar selectores
                cargarSelectCursos();
                cargarCategoriasCheckboxes();
                
                hideLoading();
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                hideLoading();
                showMessage('Error al cargar los datos: ' + error.message, 'danger');
            }
        }

        // Cargar select de cursos
        function cargarSelectCursos() {
            const select = document.getElementById('curso-select');
            const fragment = document.createDocumentFragment();
            
            // Opci√≥n por defecto
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Seleccione un curso...';
            fragment.appendChild(defaultOption);
            
            // Agrupar por grado
            const cursosPorGrado = {};
            todosCursos.forEach(curso => {
                const gradeName = curso.grades.grade_name;
                if (!cursosPorGrado[gradeName]) {
                    cursosPorGrado[gradeName] = [];
                }
                cursosPorGrado[gradeName].push(curso);
            });
            
            // Crear opciones agrupadas
            Object.keys(cursosPorGrado).sort().forEach(gradeName => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = gradeName;
                
                cursosPorGrado[gradeName].forEach(curso => {
                    const option = document.createElement('option');
                    option.value = curso.course_id;
                    option.textContent = curso.course_name;
                    option.dataset.gradeId = curso.grades.grade_id;
                    option.dataset.gradeName = curso.grades.grade_name;
                    option.dataset.sectionId = curso.grades.sections.section_id;
                    option.dataset.directorMail = curso.grades.sections.director_mail || '';
                    optgroup.appendChild(option);
                });
                
                fragment.appendChild(optgroup);
            });
            
            select.innerHTML = '';
            select.appendChild(fragment);
            select.disabled = false;
        }
      // Cargar categor√≠as como checkboxes
        function cargarCategoriasCheckboxes() {
            const container = document.getElementById('categorias-checkboxes');
            const loadingDiv = document.getElementById('categorias-loading');
            const fragment = document.createDocumentFragment();
            
            todasCategorias.forEach(categoria => {
                const div = document.createElement('div');
                div.className = 'categoria-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `categoria-${categoria.category_id}`;
                checkbox.value = categoria.category_id;
                checkbox.addEventListener('change', function() {
                    actualizarCategoriasSeleccionadas();
                    validarFormularioCompleto();
                });
                
                const label = document.createElement('label');
                label.htmlFor = `categoria-${categoria.category_id}`;
                label.textContent = categoria.category_name;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                fragment.appendChild(div);
            });
            
            container.innerHTML = '';
            container.appendChild(fragment);
            
            // Mostrar checkboxes y ocultar loading
            loadingDiv.style.display = 'none';
            container.style.display = 'block';
        }

        // Actualizar array de categor√≠as seleccionadas
        function actualizarCategoriasSeleccionadas() {
            const checkboxes = document.querySelectorAll('#categorias-checkboxes input[type="checkbox"]:checked');
            categoriasSeleccionadas = Array.from(checkboxes).map(cb => parseInt(cb.value));
        }

        // Configurar eventos
        function configurarEventos() {
            const cursoSelect = document.getElementById('curso-select');
            const form = document.getElementById('form-asuntos-grupales');
            
            cursoSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                cursoSeleccionado = selectedOption.value ? {
                    courseId: parseInt(selectedOption.value),
                    gradeName: selectedOption.dataset.gradeName,
                    directorMail: selectedOption.dataset.directorMail
                } : null;
                validarFormularioCompleto();
            });
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                guardarAsuntoGrupal();
            });
        }

        // Configurar editores de texto enriquecido
        function configurarEditoresTexto() {
            const editor = document.getElementById('descripcion-editor');
            const toolbar = document.querySelector('[data-target="descripcion-editor"]');
            
            if (!editor || !toolbar) return;
            
            configurarToolbar(toolbar, editor);
            
            editor.addEventListener('input', function() {
                actualizarEstadoEditor(this);
                validarFormularioCompleto();
            });
            
            editor.addEventListener('focus', function() {
                this.parentElement.classList.add('focused');
            });
            
            editor.addEventListener('blur', function() {
                this.parentElement.classList.remove('focused');
                actualizarEstadoEditor(this);
            });
            
            editor.addEventListener('paste', function(e) {
                e.preventDefault();
                const texto = (e.clipboardData || window.clipboardData).getData('text/plain');
                document.execCommand('insertText', false, texto);
            });
            
            actualizarEstadoEditor(editor);
        }

        // Configurar toolbar de editor
        function configurarToolbar(toolbar, editor) {
            const botones = toolbar.querySelectorAll('button[data-command]');
            
            botones.forEach(boton => {
                boton.addEventListener('click', function(e) {
                    e.preventDefault();
                    const comando = this.dataset.command;
                    
                    editor.focus();
                    document.execCommand(comando, false, null);
                    actualizarEstadoBotones(toolbar);
                    
                    setTimeout(() => {
                        actualizarEstadoEditor(editor);
                        validarFormularioCompleto();
                    }, 10);
                });
            });
            
            editor.addEventListener('selectionchange', () => actualizarEstadoBotones(toolbar));
            editor.addEventListener('keyup', () => actualizarEstadoBotones(toolbar));
            editor.addEventListener('mouseup', () => actualizarEstadoBotones(toolbar));
        }

        // Actualizar estado de botones del toolbar
        function actualizarEstadoBotones(toolbar) {
            const botones = toolbar.querySelectorAll('button[data-command]');
            
            botones.forEach(boton => {
                const comando = boton.dataset.command;
                
                try {
                    if (document.queryCommandState(comando)) {
                        boton.classList.add('active');
                    } else {
                        boton.classList.remove('active');
                    }
                } catch (e) {
                    boton.classList.remove('active');
                }
            });
        }

        // Actualizar estado visual del editor
        function actualizarEstadoEditor(editor) {
            const contenido = editor.innerHTML.trim();
            const soloEspacios = editor.textContent.trim() === '';
            
            editor.classList.remove('has-content', 'required-empty');
            
            if (soloEspacios || contenido === '') {
                editor.classList.add('required-empty');
            } else {
                editor.classList.add('has-content');
            }
        }

        // Validar formulario completo
        function validarFormularioCompleto() {
            const cursoValido = cursoSeleccionado !== null;
            const categoriasValidas = categoriasSeleccionadas.length > 0;
            const descripcionValida = validarEditor('descripcion-editor');
            
            const formularioValido = cursoValido && categoriasValidas && descripcionValida;
            
            const botonGuardar = document.querySelector('button[type="submit"]');
            botonGuardar.disabled = !formularioValido;
            
            return formularioValido;
        }

        // Validar editor espec√≠fico
        function validarEditor(editorId) {
            const editor = document.getElementById(editorId);
            if (!editor) return false;
            
            const contenido = editor.textContent.trim();
            return contenido.length > 0;
        }

        // Obtener contenido de editor
        function obtenerContenidoEditor(editorId) {
            const editor = document.getElementById(editorId);
            if (!editor) return '';
            
            return editor.innerHTML.trim();
        }

        // Funciones de loading
        function showLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.remove('hidden');
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.add('hidden');
        }

      // Guardar asunto grupal
        async function guardarAsuntoGrupal() {
            if (enviandoFormulario) {
                showMessage('Por favor espere, el asunto se est√° guardando...', 'warning');
                return;
            }
            
            if (!validarFormularioCompleto()) {
                showMessage('Por favor, complete todos los campos obligatorios', 'warning');
                return;
            }
            
            enviandoFormulario = true;
            showLoading();
            
            const botonGuardar = document.querySelector('button[type="submit"]');
            botonGuardar.disabled = true;
            botonGuardar.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Guardando...';
            
            try {
                const session = getStoredSession();
                const workerData = await supabaseRequest(`/workers?select=worker_id&email=eq.${session.user.user_mail}&limit=1`);
                
                if (workerData.length === 0) {
                    throw new Error('No se pudo identificar al usuario actual');
                }
                
                const workerId = workerData[0].worker_id;
                
                // Obtener prom del grado
                const promData = await supabaseRequest(`/grades?select=promotion_code&grade_id=eq.${cursoSeleccionado.courseId}&limit=1`);
                const promName = promData.length > 0 ? promData[0].promotion_code : cursoSeleccionado.gradeName;
                
                // Preparar datos para inserci√≥n
                const fechaActual = new Date().toISOString().split('T')[0];
                
                const insertData = {
                    prom_name: promName,
                    topic_date: fechaActual,
                    topic_description: obtenerContenidoEditor('descripcion-editor'),
                    email: session.user.user_mail,
                    is_escalable: 'SI',
                    is_open: 'SI'
                };
                
                // Insertar en stm_prom_topics
                const topicResult = await supabaseRequest('/stm_prom_topics', {
                    method: 'POST',
                    body: JSON.stringify(insertData)
                });
                
                const topicId = topicResult[0].prom_topic_id;
                
                // Insertar categor√≠as
                const categoriaPromises = categoriasSeleccionadas.map(categoryId => 
                    supabaseRequest('/stm_prom_topics_categories', {
                        method: 'POST',
                        body: JSON.stringify({
                            prom_topic_id: topicId,
                            category_id: categoryId
                        })
                    })
                );
                
                await Promise.all(categoriaPromises);
                
                // Enviar notificaci√≥n al director si existe
                if (cursoSeleccionado.directorMail) {
                    await enviarNotificacionDirector(topicId);
                }
                
                showMessage('Asunto grupal registrado exitosamente', 'success');
                limpiarFormulario();
                
            } catch (error) {
                console.error('Error al guardar:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
            } finally {
                enviandoFormulario = false;
                hideLoading();
                restaurarBotonGuardar();
            }
        }

        // Enviar notificaci√≥n al director
        async function enviarNotificacionDirector(topicId) {
            try {
                const asunto = `Se ha generado un asunto relacionado con ${cursoSeleccionado.gradeName}`;
                const descripcion = obtenerContenidoEditor('descripcion-editor');
                
                const cuerpoHtml = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <h3 style="color: #1380e2;">Nuevo Asunto Grupal Registrado</h3>
                        <p>Se ha registrado el siguiente asunto grupal:</p>
                        
                        <div style="background-color: #f8f9fa; padding: 15px; border-left: 4px solid #1380e2; margin: 20px 0;">
                            <p><strong>Promoci√≥n:</strong> ${cursoSeleccionado.gradeName}</p>
                            <p><strong>Descripci√≥n:</strong><br/>
                            ${descripcion}</p>
                        </div>
                        
                        <p>Recuerda tenerlo en cuenta en los seguimientos.</p>
                        
                        <p style="font-size: 12px; color: #6c757d;">
                            <em>Este es un correo enviado de forma autom√°tica por SchoolNet. Por favor no responder.</em>
                        </p>
                    </div>
                `;
                
                await sendNotification(cursoSeleccionado.directorMail, asunto, cuerpoHtml, true);
                
            } catch (error) {
                console.error('Error enviando notificaci√≥n (no cr√≠tico):', error);
            }
        }

        // Restaurar bot√≥n guardar
        function restaurarBotonGuardar() {
            const botonGuardar = document.querySelector('button[type="submit"]');
            botonGuardar.innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar Asunto';
            botonGuardar.disabled = !validarFormularioCompleto();
        }

        // Limpiar formulario
        function limpiarFormulario() {
            if (confirm('¬øEst√° seguro de que desea limpiar todos los campos?')) {
                document.getElementById('curso-select').value = '';
                cursoSeleccionado = null;
                
                // Limpiar categor√≠as
                const checkboxes = document.querySelectorAll('#categorias-checkboxes input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
                categoriasSeleccionadas = [];
                
                // Limpiar editor
                const editor = document.getElementById('descripcion-editor');
                editor.innerHTML = '';
                actualizarEstadoEditor(editor);
                
                validarFormularioCompleto();
                
                document.getElementById('curso-select').focus();
            }
        }

        // Abrir modal de asuntos
        async function abrirModalAsuntos() {
            const modal = document.getElementById('modal-asuntos');
            modal.style.display = 'block';
            
            document.getElementById('modal-loading').style.display = 'block';
            document.getElementById('contenido-asuntos').style.display = 'none';
            document.getElementById('sin-asuntos').style.display = 'none';
            
            try {
                await cargarAsuntosUsuario();
            } catch (error) {
                console.error('Error cargando asuntos:', error);
                showMessage('Error al cargar asuntos: ' + error.message, 'danger');
                cerrarModalAsuntos();
            }
        }

        // Cerrar modal de asuntos
        function cerrarModalAsuntos() {
            document.getElementById('modal-asuntos').style.display = 'none';
        }

        // Cargar asuntos del usuario
        async function cargarAsuntosUsuario() {
            try {
                const session = getStoredSession();
                const asuntos = await supabaseRequest(`/stm_prom_topics?select=prom_topic_id,topic_description,topic_date,is_open,prom_name,stm_prom_topics_categories!inner(stm_category!inner(category_name))&email=eq.${session.user.user_mail}&order=topic_date.desc,prom_topic_id.desc`);
                
                document.getElementById('modal-loading').style.display = 'none';
                
                if (asuntos && asuntos.length > 0) {
                    renderizarTablaAsuntos(asuntos);
                    document.getElementById('contenido-asuntos').style.display = 'block';
                } else {
                    document.getElementById('sin-asuntos').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        // Renderizar tabla de asuntos
        function renderizarTablaAsuntos(asuntos) {
            const tbody = document.getElementById('tabla-asuntos-body');
            const fragment = document.createDocumentFragment();
            
            asuntos.forEach(asunto => {
                const categorias = asunto.stm_prom_topics_categories
                    .map(cat => cat.stm_category.category_name)
                    .join(', ');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(asunto.topic_date)}</td>
                    <td>${escapeHtml(asunto.prom_name || 'N/A')}</td>
                    <td><small>${escapeHtml(categorias)}</small></td>
                    <td>
                        ${asunto.is_open === 'SI' ? 
                            `<textarea class="form-control" style="min-height: 80px;" onblur="actualizarDescripcion(${asunto.prom_topic_id}, this.value)">${escapeHtml(asunto.topic_description || '')}</textarea>` :
                            `<div class="text-muted fst-italic">${escapeHtml(asunto.topic_description || '')}<br><small>Este asunto est√° cerrado</small></div>`
                        }
                    </td>
                    <td>
                        <span class="badge ${asunto.is_open === 'SI' ? 'bg-success' : 'bg-secondary'}">
                            ${asunto.is_open === 'SI' ? 'Abierto' : 'Cerrado'}
                        </span>
                    </td>
                `;
                fragment.appendChild(tr);
            });
            
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        // Actualizar descripci√≥n de asunto
        async function actualizarDescripcion(promTopicId, nuevaDescripcion) {
            if (!nuevaDescripcion.trim()) {
                showMessage('La descripci√≥n no puede estar vac√≠a', 'warning');
                return;
            }
            
            try {
                await supabaseRequest(`/stm_prom_topics?prom_topic_id=eq.${promTopicId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ topic_description: nuevaDescripcion.trim() })
                });
                
                showMessage('Descripci√≥n actualizada exitosamente', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error al actualizar: ' + error.message, 'danger');
            }
        }

        // Funci√≥n auxiliar para escapar HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Funciones globales
        window.limpiarFormulario = limpiarFormulario;
        window.abrirModalAsuntos = abrirModalAsuntos;
        window.cerrarModalAsuntos = cerrarModalAsuntos;
        window.actualizarDescripcion = actualizarDescripcion;
    </script>
</body>
</html>
