<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignar usuarios a cursos - Seguimientos - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .section-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .role-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .role-checkbox:hover {
            background-color: #f8f9fa;
            border-color: #0d6efd;
        }
        
        .role-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .role-checkbox label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
            flex: 1;
        }
        
        .worker-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
        }
        
        .worker-item:hover {
            background-color: #f8f9fa;
        }
        
        .worker-item:last-child {
            border-bottom: none;
        }
        
        .worker-checkbox {
            width: auto;
            margin: 0;
        }
        
        .worker-info {
            flex: 1;
        }
        
        .worker-name {
            font-weight: 600;
            color: #1b365d;
            margin-bottom: 3px;
        }
        
        .worker-email {
            font-size: 14px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .worker-assigned {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .worker-assigned .worker-name {
            color: #155724;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box .bi-search {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .search-box input {
            padding-left: 35px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 4px solid #4caf50;
            padding: 15px;
            border-radius: 8px;
        }
        
        .btn-group-custom {
            gap: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .roles-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group-custom {
                flex-direction: column;
            }
            
            .btn-group-custom .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div>Cargando datos...</div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Seguimientos</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Asignar usuarios a cursos
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-person-plus-fill me-2"></i>
                    Asignar usuarios a cursos
                </h1>
                <p class="text-muted">
                    Asigna trabajadores responsables a cursos específicos para el seguimiento de estudiantes
                </p>
            </div>
        </div>

        <!-- Mensajes -->
        <div id="alert-container"></div>

        <!-- Mensaje para usuarios no autorizados -->
        <div id="access-denied-alert" class="alert alert-warning d-none">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Acceso Restringido</strong><br>
            <span id="access-denied-message">Solo los directores de sección pueden usar esta funcionalidad.</span>
        </div>

        <!-- Formulario principal -->
        <div id="main-form" class="d-none">
            <!-- Información de la sección -->
            <div class="section-info">
                <h5 class="mb-2">
                    <i class="bi bi-building me-2"></i>
                    Sección a cargo
                </h5>
                <div id="section-name" class="fw-bold fs-5">-</div>
            </div>

            <!-- Selección de curso -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-journals me-2"></i>
                        Seleccionar curso
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="course-select" class="form-label">Curso:</label>
                            <select id="course-select" class="form-select">
                                <option value="">-- Seleccione un curso --</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtro por roles -->
            <div id="roles-section" class="card mb-4 d-none">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>
                        Filtrar trabajadores por roles
                    </h6>
                </div>
                <div class="card-body">
                    <div id="roles-container" class="roles-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <!-- Los roles se cargarán aquí -->
                    </div>
                    <div class="btn-group-custom d-flex mt-3">
                        <button type="button" id="select-all-roles" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-check-all me-1"></i>Seleccionar todos
                        </button>
                        <button type="button" id="clear-roles" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-x-lg me-1"></i>Limpiar selección
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista de trabajadores -->
            <div id="workers-section" class="card mb-4 d-none">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-people me-2"></i>
                        Trabajadores disponibles
                    </h6>
                    <div class="search-box" style="width: 300px;">
                        <i class="bi bi-search"></i>
                        <input type="text" id="worker-search" class="form-control form-control-sm" 
                               placeholder="Buscar trabajadores...">
                    </div>
                </div>
                <div class="card-body">
                    <div id="workers-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; background-color: #fff;">
                        <div id="workers-list">
                            <!-- Los trabajadores se cargarán aquí -->
                        </div>
                    </div>

                    <div class="btn-group-custom d-flex mt-3">
                        <button type="button" id="select-all-workers" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-check-all me-1"></i>Seleccionar todos
                        </button>
                        <button type="button" id="clear-workers" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-x-lg me-1"></i>Limpiar selección
                        </button>
                        <button type="button" id="save-assignments" class="btn btn-primary">
                            <i class="bi bi-floppy me-1"></i>Guardar asignaciones
                        </button>
                    </div>

                    <!-- Resumen de selección -->
                    <div class="summary-card mt-3">
                        <strong>Resumen:</strong> 
                        <span id="selection-summary">0 trabajadores seleccionados</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // Variables globales
        let appData = {
            isDirector: false,
            sectionInfo: null,
            availableCourses: [],
            availableRoles: [],
            availableWorkers: [],
            assignedWorkers: [],
            selectedCourse: null,
            selectedRoles: [],
            selectedWorkers: []
        };

        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Validar acceso con permisos
                const hasAccess = await validatePageAccess('Asignar usuarios a cursos');
                if (!hasAccess) return;

                // Inicializar página
                initializePage('userCourseAssignments', 'Seguimientos');
                
                // Configurar eventos
                setupEventListeners();
                
                // Cargar datos iniciales
                await loadInitialData();
                
            } catch (error) {
                console.error('Error inicializando página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
            }
        });

        async function loadInitialData() {
            showLoading();
            
            try {
                // Validar si es director de sección
                await validateDirectorSection();
                
                if (appData.isDirector) {
                    // Cargar datos en paralelo
                    await Promise.all([
                        loadSectionCourses(),
                        loadAllRoles()
                    ]);
                    
                    // Mostrar formulario
                    document.getElementById('main-form').classList.remove('d-none');
                }
                
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
                showMessage('Error al cargar los datos: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        async function validateDirectorSection() {
            try {
                const session = getStoredSession();
                if (!session?.user?.user_mail) {
                    throw new Error('No se pudo identificar el usuario actual');
                }

                const userEmail = session.user.user_mail;
                
                // Consultar si es director de sección
                const sections = await supabaseRequest(`/sections?select=section_id,section_name,director_email&director_email=eq.${userEmail}&section_status=eq.active`);
                
                if (!sections || sections.length === 0) {
                    appData.isDirector = false;
                    document.getElementById('access-denied-alert').classList.remove('d-none');
                    return;
                }

                appData.isDirector = true;
                appData.sectionInfo = sections[0];
                document.getElementById('section-name').textContent = sections[0].section_name;
                
            } catch (error) {
                console.error('Error validando director:', error);
                appData.isDirector = false;
                document.getElementById('access-denied-message').textContent = 'Error al validar permisos: ' + error.message;
                document.getElementById('access-denied-alert').classList.remove('d-none');
            }
        }

        async function loadSectionCourses() {
            try {
                const sectionId = appData.sectionInfo.section_id;
                
                // Consulta corregida sin order en relaciones anidadas
                const courses = await supabaseRequest(`/courses?select=course_id,course_name,course_order,grades!inner(grade_name,grade_order,section_id)&grades.section_id=eq.${sectionId}&course_status=eq.active`);
                
                // Ordenar en JavaScript después de recibir los datos
                const sortedCourses = (courses || []).sort((a, b) => {
                    // Primero por grade_order, luego por course_order
                    if (a.grades.grade_order !== b.grades.grade_order) {
                        return a.grades.grade_order - b.grades.grade_order;
                    }
                    return (a.course_order || '').localeCompare(b.course_order || '');
                });
                
                appData.availableCourses = sortedCourses;
                renderCourseSelect();
                
            } catch (error) {
                console.error('Error cargando cursos:', error);
                showMessage('Error al cargar cursos de la sección', 'danger');
            }
        }

        async function loadAllRoles() {
            try {
                // IDs específicos de los roles que queremos mostrar
                const rolesPermitidos = [
                    '229ae13e-1a20-49bb-af81-69a700f3c95a',  // Profesor
                    'd5e835fb-2585-43c4-bfa3-5c0aed70e69e',  // Profesora asistente
                    '791e3300-52c0-44d6-8bab-dff6d68b8fa8'   // EAE
                ];
                
                // Crear la lista de IDs para la consulta
                const idsString = rolesPermitidos.join(',');
                
                // Consultar solo los roles específicos
                const roles = await supabaseRequest(`/job_roles?select=role_id,role_name&role_status=eq.active&role_id=in.(${idsString})&order=role_name`);
                
                appData.availableRoles = roles || [];
                renderRoles();
                
            } catch (error) {
                console.error('Error cargando roles:', error);
                showMessage('Error al cargar roles de trabajo', 'danger');
            }
        }

        
        function renderCourseSelect() {
            const select = document.getElementById('course-select');
            select.innerHTML = '<option value="">-- Seleccione un curso --</option>';
            
            appData.availableCourses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.course_id;
                option.textContent = `${course.grades.grade_name} - ${course.course_name}`;
                select.appendChild(option);
            });
        }

        function renderRoles() {
            const container = document.getElementById('roles-container');
            container.innerHTML = '';
            
            appData.availableRoles.forEach(role => {
                const roleDiv = document.createElement('div');
                roleDiv.className = 'role-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `role_${role.role_id}`;
                checkbox.value = role.role_id;
                checkbox.addEventListener('change', handleRoleChange);
                
                const label = document.createElement('label');
                label.htmlFor = `role_${role.role_id}`;
                label.textContent = role.role_name;
                
                roleDiv.appendChild(checkbox);
                roleDiv.appendChild(label);
                container.appendChild(roleDiv);
            });
        }

        // Función corregida para cargar trabajadores asignados
        async function loadAssignedWorkers(courseId) {
            try {
                // Consulta corregida SIN assignment_status
                const assigned = await supabaseRequest(`/worker_courses?select=worker_id,workers!inner(worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,email)&course_id=eq.${courseId}`);
                
                appData.assignedWorkers = assigned ? assigned.map(a => a.workers) : [];
                
            } catch (error) {
                console.error('Error cargando trabajadores asignados:', error);
                appData.assignedWorkers = [];
            }
        }

        async function loadWorkersByRoles() {
            if (appData.selectedRoles.length === 0) {
                document.getElementById('workers-section').classList.add('d-none');
                return;
            }
            
            showLoading();
            
            try {
                // Consultar trabajadores con roles seleccionados
                const roleIds = appData.selectedRoles.join(',');
                const workers = await supabaseRequest(`/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,email,worker_job_roles!inner(job_role_id)&worker_status=eq.active&worker_job_roles.job_role_id=in.(${roleIds})&worker_job_roles.assignment_status=eq.active&order=worker_last_name_1,worker_last_name_2,worker_first_name`);
                
                // Eliminar duplicados
                const uniqueWorkers = [];
                const seenIds = new Set();
                
                (workers || []).forEach(worker => {
                    if (!seenIds.has(worker.worker_id)) {
                        seenIds.add(worker.worker_id);
                        uniqueWorkers.push(worker);
                    }
                });
                
                appData.availableWorkers = uniqueWorkers;
                renderWorkers();
                document.getElementById('workers-section').classList.remove('d-none');
                
                // Limpiar búsqueda
                document.getElementById('worker-search').value = '';
                
            } catch (error) {
                console.error('Error cargando trabajadores:', error);
                showMessage('Error al cargar trabajadores', 'danger');
                appData.availableWorkers = [];
                document.getElementById('workers-section').classList.add('d-none');
            } finally {
                hideLoading();
            }
        }

        function renderWorkers() {
            const container = document.getElementById('workers-list');
            container.innerHTML = '';
            
            if (appData.availableWorkers.length === 0) {
                container.innerHTML = '<div class="text-center p-4 text-muted">No hay trabajadores disponibles con los roles seleccionados</div>';
                updateSelectionSummary();
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            appData.availableWorkers.forEach(worker => {
                const workerDiv = document.createElement('div');
                workerDiv.className = 'worker-item';
                
                // Verificar si ya está asignado
                const isAssigned = appData.assignedWorkers.some(assigned => assigned.worker_id === worker.worker_id);
                
                if (isAssigned) {
                    workerDiv.classList.add('worker-assigned');
                }
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'worker-checkbox';
                checkbox.id = `worker_${worker.worker_id}`;
                checkbox.value = worker.worker_id;
                checkbox.checked = isAssigned;
                checkbox.addEventListener('change', handleWorkerChange);
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'worker-info';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'worker-name';
                nameDiv.textContent = `${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''} ${worker.worker_first_name}`.trim();
                
                const emailDiv = document.createElement('div');
                emailDiv.className = 'worker-email';
                emailDiv.textContent = worker.email;
                
                infoDiv.appendChild(nameDiv);
                infoDiv.appendChild(emailDiv);
                
                workerDiv.appendChild(checkbox);
                workerDiv.appendChild(infoDiv);
                
                fragment.appendChild(workerDiv);
            });
            
            container.appendChild(fragment);
            updateSelectedWorkers();
            updateSelectionSummary();
        }

        // Event handlers
        function setupEventListeners() {
            document.getElementById('course-select').addEventListener('change', handleCourseChange);
            document.getElementById('select-all-roles').addEventListener('click', selectAllRoles);
            document.getElementById('clear-roles').addEventListener('click', clearRoles);
            document.getElementById('select-all-workers').addEventListener('click', selectAllWorkers);
            document.getElementById('clear-workers').addEventListener('click', clearWorkers);
            document.getElementById('save-assignments').addEventListener('click', saveAssignments);
            document.getElementById('worker-search').addEventListener('input', handleWorkerSearch);
        }

        async function handleCourseChange() {
            const select = document.getElementById('course-select');
            const courseId = select.value;
            
            if (!courseId) {
                document.getElementById('roles-section').classList.add('d-none');
                document.getElementById('workers-section').classList.add('d-none');
                appData.selectedCourse = null;
                return;
            }
            
            appData.selectedCourse = courseId;
            
            // Mostrar sección de roles
            document.getElementById('roles-section').classList.remove('d-none');
            
            // Cargar trabajadores asignados
            await loadAssignedWorkers(courseId);
        }

        function handleRoleChange() {
            // Actualizar roles seleccionados
            appData.selectedRoles = [];
            const checkboxes = document.querySelectorAll('#roles-container input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                appData.selectedRoles.push(checkbox.value);
            });
            
            if (appData.selectedRoles.length > 0) {
                loadWorkersByRoles();
            } else {
                document.getElementById('workers-section').classList.add('d-none');
                appData.availableWorkers = [];
            }
        }

        function handleWorkerChange() {
            updateSelectedWorkers();
            updateSelectionSummary();
        }

        function handleWorkerSearch() {
            const searchTerm = this.value.toLowerCase();
            const workerItems = document.querySelectorAll('.worker-item');
            
            workerItems.forEach(item => {
                const name = item.querySelector('.worker-name').textContent.toLowerCase();
                const email = item.querySelector('.worker-email').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || email.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function selectAllRoles() {
            const checkboxes = document.querySelectorAll('#roles-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
            handleRoleChange();
        }

        function clearRoles() {
            const checkboxes = document.querySelectorAll('#roles-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            handleRoleChange();
        }

        function selectAllWorkers() {
            const checkboxes = document.querySelectorAll('.worker-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = true);
            updateSelectedWorkers();
            updateSelectionSummary();
        }

        function clearWorkers() {
            const checkboxes = document.querySelectorAll('.worker-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            updateSelectedWorkers();
            updateSelectionSummary();
        }

        function updateSelectedWorkers() {
            appData.selectedWorkers = [];
            const checkboxes = document.querySelectorAll('.worker-checkbox:checked');
            checkboxes.forEach(checkbox => {
                appData.selectedWorkers.push(checkbox.value);
            });
        }

        function updateSelectionSummary() {
            const summaryElement = document.getElementById('selection-summary');
            const count = appData.selectedWorkers.length;
            
            if (count === 0) {
                summaryElement.textContent = 'Ningún trabajador seleccionado';
            } else if (count === 1) {
                summaryElement.textContent = '1 trabajador seleccionado';
            } else {
                summaryElement.textContent = `${count} trabajadores seleccionados`;
            }
        }

        // Función corregida para guardar asignaciones
        async function saveAssignments() {
            if (!appData.selectedCourse) {
                showMessage('Por favor selecciona un curso primero', 'warning');
                return;
            }
            
            // Confirmar acción
            const courseInfo = appData.availableCourses.find(c => c.course_id === appData.selectedCourse);
            const courseName = courseInfo ? `${courseInfo.grades.grade_name} - ${courseInfo.course_name}` : 'el curso seleccionado';
            const selectedCount = appData.selectedWorkers.length;
            
            let message;
            if (selectedCount === 0) {
                message = `¿Estás seguro de quitar TODOS los trabajadores asignados a ${courseName}?`;
            } else {
                message = `¿Estás seguro de asignar ${selectedCount} trabajador(es) a ${courseName}?\n\nEsto reemplazará las asignaciones actuales.`;
            }
            
            if (!confirm(message)) return;
            
            showLoading();
            
            try {
                // Eliminar asignaciones actuales
                await supabaseRequest(`/worker_courses?course_id=eq.${appData.selectedCourse}`, {
                    method: 'DELETE'
                });
                
                // Crear nuevas asignaciones (solo con worker_id y course_id)
                if (appData.selectedWorkers.length > 0) {
                    const assignments = appData.selectedWorkers.map(workerId => ({
                        worker_id: workerId,
                        course_id: appData.selectedCourse
                        // Removidas: assigned_by, assignment_status
                    }));
                    
                    await supabaseRequest('/worker_courses', {
                        method: 'POST',
                        body: JSON.stringify(assignments)
                    });
                }
                
                showMessage(`Asignaciones de ${courseName} actualizadas exitosamente. ${selectedCount} trabajadores asignados.`, 'success');
                
                // Recargar trabajadores asignados
                await loadAssignedWorkers(appData.selectedCourse);
                
                // Re-renderizar si hay trabajadores cargados
                if (appData.availableWorkers.length > 0) {
                    renderWorkers();
                }
                
            } catch (error) {
                console.error('Error guardando asignaciones:', error);
                showMessage('Error al guardar asignaciones: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }
        
        // Utility functions
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showMessage(message, type) {
            const container = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.appendChild(alertDiv);
            
            // Auto-remove success messages
            if (type === 'success') {
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
