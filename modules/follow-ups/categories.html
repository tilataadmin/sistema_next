<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar categorías - Seguimientos - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .btn-action {
            padding: 4px 8px;
            font-size: 12px;
            margin: 0 2px;
        }
        
        .table-responsive {
            min-height: 200px;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        button:disabled {
            opacity: 0.6 !important;
            cursor: not-allowed !important;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div>Cargando gestión de categorías...</div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Seguimientos</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gestionar categorías
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-tags me-2"></i>
                    Gestionar categorías
                </h1>
                <p class="text-muted">
                    Administra las categorías utilizadas para clasificar asuntos y seguimientos del módulo STM
                </p>
            </div>
        </div>

        <!-- Mensajes -->
        <div id="alert-container"></div>

        <!-- Formulario de categorías -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-plus-circle me-2"></i>
                    Nueva categoría
                </h5>
            </div>
            <div class="card-body">
                <form id="categoria-form" autocomplete="off" novalidate>
                    <input type="hidden" id="category_id" name="category_id" value="0">
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group mb-3">
                                <label for="category_name" class="form-label">
                                    Nombre de la categoría <span class="text-danger">*</span>
                                </label>
                                <input type="text" 
                                       id="category_name" 
                                       name="category_name" 
                                       class="form-control" 
                                       maxlength="100" 
                                       placeholder="Ingrese el nombre de la categoría..."
                                       required>
                                <div class="form-text">
                                    Máximo 100 caracteres. Este nombre se usará para clasificar asuntos y seguimientos.
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-group mb-3 w-100">
                                <div class="d-grid gap-2 d-md-flex">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-floppy me-1"></i>Guardar
                                    </button>
                                    <button type="button" id="btn-limpiar" class="btn btn-outline-secondary">
                                        <i class="bi bi-x-circle me-1"></i>Limpiar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Lista de categorías existentes -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>
                    Categorías existentes
                </h5>
                <button type="button" id="btn-refresh" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                </button>
            </div>
            <div class="card-body">
                <!-- Loading para tabla -->
                <div id="table-loading" class="d-none">
                    <div class="d-flex align-items-center justify-content-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <span>Actualizando categorías...</span>
                    </div>
                </div>

                <!-- Tabla de categorías -->
                <div id="table-container">
                    <div class="table-responsive">
                        <table class="table table-hover" id="categorias-table">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 80px;">ID</th>
                                    <th>Nombre de la categoría</th>
                                    <th style="width: 140px;" class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="categorias-tbody">
                                <!-- Las filas se cargan dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Estado vacío -->
                <div id="empty-state" class="empty-state d-none">
                    <i class="bi bi-tags text-muted"></i>
                    <h6>No hay categorías registradas</h6>
                    <p class="mb-0">Cree la primera categoría usando el formulario superior.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

  <script>
        // === VARIABLES GLOBALES ===
        let appData = {
            categorias: [],
            categoriaEditando: null,
            enviandoFormulario: false
        };

        // === FUNCIONES DE INICIALIZACIÓN ===
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Validar acceso con permisos
                const hasAccess = await validatePageAccess('Gestionar categorías');
                if (!hasAccess) return;

                // Inicializar página
                initializePage('categories', 'Seguimientos');
                
                // Configurar eventos
                setupEventListeners();
                
                // Cargar datos iniciales
                await loadInitialData();
                
            } catch (error) {
                console.error('Error inicializando página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
            }
        });

        async function loadInitialData() {
            showLoading();
            
            try {
                // Cargar categorías
                await loadCategorias();
                
                // Ocultar loading
                hideLoading();
                
                // Focus en campo nombre
                document.getElementById('category_name').focus();
                
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
                hideLoading();
                showMessage('Error al cargar los datos: ' + error.message, 'danger');
            }
        }

        async function loadCategorias() {
            showTableLoading();
            
            try {
                const categorias = await supabaseRequest('/stm_category?select=category_id,category_name&order=category_name');
                
                appData.categorias = categorias || [];
                renderCategorias(appData.categorias);
                
            } catch (error) {
                console.error('Error cargando categorías:', error);
                showMessage('Error al cargar categorías: ' + error.message, 'danger');
                appData.categorias = [];
                renderCategorias([]);
            } finally {
                hideTableLoading();
            }
        }

        function setupEventListeners() {
            // Envío de formulario
            const form = document.getElementById('categoria-form');
            form.addEventListener('submit', handleFormSubmit);
            
            // Botón limpiar
            document.getElementById('btn-limpiar').addEventListener('click', limpiarFormulario);
            
            // Botón actualizar
            document.getElementById('btn-refresh').addEventListener('click', function() {
                loadCategorias();
            });
            
            // Validación en tiempo real
            const categoryNameInput = document.getElementById('category_name');
            categoryNameInput.addEventListener('input', function() {
                this.classList.remove('is-invalid');
                // Limpiar mensajes de error si hay texto válido
                if (this.value.trim().length >= 2) {
                    clearMessages();
                }
            });
        }

        // === FUNCIONES DE UI ===
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showTableLoading() {
            document.getElementById('table-loading').classList.remove('d-none');
            document.getElementById('table-container').style.opacity = '0.5';
        }

        function hideTableLoading() {
            document.getElementById('table-loading').classList.add('d-none');
            document.getElementById('table-container').style.opacity = '1';
        }

        function showMessage(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="bi ${getIconForType(type)} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Limpiar mensajes anteriores
            container.innerHTML = '';
            container.appendChild(alertDiv);
            
            // Auto-remove success messages
            if (type === 'success') {
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function clearMessages() {
            const container = document.getElementById('alert-container');
            container.innerHTML = '';
        }

        function getIconForType(type) {
            const icons = {
                success: 'bi-check-circle',
                danger: 'bi-exclamation-triangle',
                warning: 'bi-exclamation-triangle',
                info: 'bi-info-circle'
            };
            return icons[type] || 'bi-info-circle';
        }

        function limpiarFormulario() {
            document.getElementById('category_id').value = '0';
            document.getElementById('category_name').value = '';
            document.getElementById('category_name').classList.remove('is-invalid');
            
            appData.categoriaEditando = null;
            clearMessages();
            
            // Cambiar texto del botón si estaba editando
            const submitBtn = document.querySelector('#categoria-form button[type="submit"]');
            submitBtn.innerHTML = '<i class="bi bi-floppy me-1"></i>Guardar';
            
            // Focus en campo nombre
            document.getElementById('category_name').focus();
        }

        function renderCategorias(categorias) {
            const tbody = document.getElementById('categorias-tbody');
            const emptyState = document.getElementById('empty-state');
            const tableContainer = document.getElementById('table-container');
            
            // Limpiar tabla
            tbody.innerHTML = '';
            
            if (!categorias || categorias.length === 0) {
                tableContainer.classList.add('d-none');
                emptyState.classList.remove('d-none');
                return;
            }
            
            // Mostrar tabla y ocultar estado vacío
            tableContainer.classList.remove('d-none');
            emptyState.classList.add('d-none');
            
            // Renderizar filas
            const fragment = document.createDocumentFragment();
            
            categorias.forEach(categoria => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-bold text-muted">${categoria.category_id}</td>
                    <td>${escapeHtml(categoria.category_name)}</td>
                    <td class="text-center">
                        <button type="button" 
                                class="btn btn-warning btn-action" 
                                onclick="editarCategoria(${categoria.category_id}, '${escapeHtml(categoria.category_name)}')"
                                title="Editar categoría">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-danger btn-action" 
                                onclick="confirmarEliminar(${categoria.category_id}, '${escapeHtml(categoria.category_name)}')"
                                title="Eliminar categoría">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                fragment.appendChild(tr);
            });
            
            tbody.appendChild(fragment);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function deshabilitarFormulario(deshabilitar) {
            const elementos = [
                document.getElementById('category_name'),
                document.querySelector('#categoria-form button[type="submit"]'),
                document.getElementById('btn-limpiar'),
                document.getElementById('btn-refresh')
            ];
            
            elementos.forEach(elemento => {
                if (elemento) {
                    elemento.disabled = deshabilitar;
                }
            });
            
            // Cambiar texto del botón submit
            const submitBtn = document.querySelector('#categoria-form button[type="submit"]');
            if (submitBtn) {
                if (deshabilitar) {
                    submitBtn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Guardando...';
                } else {
                    const isEditing = appData.categoriaEditando !== null;
                    submitBtn.innerHTML = isEditing ? 
                        '<i class="bi bi-floppy me-1"></i>Actualizar' : 
                        '<i class="bi bi-floppy me-1"></i>Guardar';
                }
            }
        }
    </script>

  // === FUNCIONES CRUD ===
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            // Protección anti-duplicados
            if (appData.enviandoFormulario) {
                showMessage('Por favor espere, la operación se está procesando...', 'warning');
                return;
            }
            
            // Validar formulario
            const validacion = validarFormulario();
            if (!validacion.valido) {
                showMessage(validacion.mensaje, 'danger');
                if (validacion.campo) {
                    validacion.campo.focus();
                    validacion.campo.classList.add('is-invalid');
                }
                return;
            }
            
            // Marcar como enviando
            appData.enviandoFormulario = true;
            deshabilitarFormulario(true);
            
            // Timeout de seguridad
            const timeoutId = setTimeout(() => {
                if (appData.enviandoFormulario) {
                    console.warn('Timeout de seguridad activado');
                    appData.enviandoFormulario = false;
                    deshabilitarFormulario(false);
                    showMessage('La operación está tomando más tiempo del esperado. Puede intentar nuevamente.', 'warning');
                }
            }, 30000);
            
            try {
                const categoryId = parseInt(document.getElementById('category_id').value) || 0;
                const categoryName = document.getElementById('category_name').value.trim();
                
                if (categoryId === 0) {
                    // Crear nueva categoría
                    await crearCategoria(categoryName);
                } else {
                    // Actualizar categoría existente
                    await actualizarCategoria(categoryId, categoryName);
                }
                
            } catch (error) {
                console.error('Error en operación CRUD:', error);
                showMessage('Error al procesar la solicitud: ' + error.message, 'danger');
            } finally {
                clearTimeout(timeoutId);
                appData.enviandoFormulario = false;
                deshabilitarFormulario(false);
            }
        }

        async function crearCategoria(categoryName) {
            try {
                const nuevaCategoria = {
                    category_name: categoryName
                };
                
                const resultado = await supabaseRequest('/stm_category', {
                    method: 'POST',
                    body: JSON.stringify(nuevaCategoria)
                });
                
                if (!resultado || resultado.length === 0) {
                    throw new Error('No se pudo crear la categoría');
                }
                
                showMessage('Categoría creada correctamente', 'success');
                
                // Limpiar formulario y recargar lista
                limpiarFormulario();
                await loadCategorias();
                
            } catch (error) {
                // Verificar si es error de duplicado
                if (error.message.includes('duplicate') || error.message.includes('unique')) {
                    throw new Error('Ya existe una categoría con ese nombre');
                }
                throw error;
            }
        }

        async function actualizarCategoria(categoryId, categoryName) {
            try {
                const datosActualizacion = {
                    category_name: categoryName
                };
                
                const resultado = await supabaseRequest('/stm_category?category_id=eq.' + categoryId, {
                    method: 'PATCH',
                    body: JSON.stringify(datosActualizacion)
                });
                
                if (!resultado || resultado.length === 0) {
                    throw new Error('No se encontró la categoría para actualizar');
                }
                
                showMessage('Categoría actualizada correctamente', 'success');
                
                // Limpiar formulario y recargar lista
                limpiarFormulario();
                await loadCategorias();
                
            } catch (error) {
                // Verificar si es error de duplicado
                if (error.message.includes('duplicate') || error.message.includes('unique')) {
                    throw new Error('Ya existe otra categoría con ese nombre');
                }
                throw error;
            }
        }

        async function eliminarCategoria(categoryId) {
            try {
                const resultado = await supabaseRequest('/stm_category?category_id=eq.' + categoryId, {
                    method: 'DELETE'
                });
                
                showMessage('Categoría eliminada correctamente', 'success');
                
                // Recargar lista
                await loadCategorias();
                
            } catch (error) {
                // Verificar si es error de restricción de clave foránea
                if (error.message.includes('foreign key') || error.message.includes('constraint')) {
                    throw new Error('No se puede eliminar la categoría porque está siendo utilizada en otros registros');
                }
                throw error;
            }
        }

        function validarFormulario() {
            const categoryName = document.getElementById('category_name').value.trim();
            
            // Validar que no esté vacío
            if (!categoryName) {
                return {
                    valido: false,
                    mensaje: 'El nombre de la categoría es obligatorio',
                    campo: document.getElementById('category_name')
                };
            }
            
            // Validar longitud mínima
            if (categoryName.length < 2) {
                return {
                    valido: false,
                    mensaje: 'El nombre de la categoría debe tener al menos 2 caracteres',
                    campo: document.getElementById('category_name')
                };
            }
            
            // Validar longitud máxima
            if (categoryName.length > 100) {
                return {
                    valido: false,
                    mensaje: 'El nombre de la categoría no puede superar los 100 caracteres',
                    campo: document.getElementById('category_name')
                };
            }
            
            // Validar caracteres especiales básicos (opcional)
            const patronValido = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ0-9\s\-_.,()]+$/;
            if (!patronValido.test(categoryName)) {
                return {
                    valido: false,
                    mensaje: 'El nombre de la categoría contiene caracteres no permitidos',
                    campo: document.getElementById('category_name')
                };
            }
            
            return { valido: true };
        }

        // === FUNCIONES DE EDICIÓN ===
        function editarCategoria(categoryId, categoryName) {
            // Limpiar mensajes previos
            clearMessages();
            
            // Cargar datos en el formulario
            document.getElementById('category_id').value = categoryId;
            document.getElementById('category_name').value = categoryName;
            
            // Marcar como editando
            appData.categoriaEditando = {
                category_id: categoryId,
                category_name: categoryName
            };
            
            // Cambiar texto del botón
            const submitBtn = document.querySelector('#categoria-form button[type="submit"]');
            submitBtn.innerHTML = '<i class="bi bi-floppy me-1"></i>Actualizar';
            
            // Scroll al formulario y focus
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('category_name').focus();
            document.getElementById('category_name').select(); // Seleccionar todo el texto
        }

        function confirmarEliminar(categoryId, categoryName) {
            // Limpiar mensajes previos
            clearMessages();
            
            const mensaje = `¿Está seguro que desea eliminar la categoría "${categoryName}"?\n\nEsta acción no se puede deshacer y puede fallar si la categoría está siendo utilizada en otros registros.`;
            
            if (confirm(mensaje)) {
                eliminarCategoriaConfirmado(categoryId, categoryName);
            }
        }

        async function eliminarCategoriaConfirmado(categoryId, categoryName) {
            // Mostrar mensaje de procesamiento
            showMessage('Eliminando categoría...', 'info');
            
            // Deshabilitar botones durante la operación
            const botonesAccion = document.querySelectorAll('.btn-action');
            botonesAccion.forEach(btn => btn.disabled = true);
            
            try {
                await eliminarCategoria(categoryId);
            } catch (error) {
                console.error('Error eliminando categoría:', error);
                showMessage('Error al eliminar categoría: ' + error.message, 'danger');
            } finally {
                // Rehabilitar botones
                const botonesAccion = document.querySelectorAll('.btn-action');
                botonesAccion.forEach(btn => btn.disabled = false);
            }
        }

        // === FUNCIONES GLOBALES (para onclick en HTML) ===
        window.editarCategoria = editarCategoria;
        window.confirmarEliminar = confirmarEliminar;

        // === FUNCIONES DE UTILIDAD ADICIONALES ===
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl + Enter para enviar formulario
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    const submitBtn = document.querySelector('#categoria-form button[type="submit"]');
                    if (submitBtn && !submitBtn.disabled) {
                        submitBtn.click();
                    }
                }
                
                // Escape para limpiar formulario
                if (e.key === 'Escape') {
                    e.preventDefault();
                    limpiarFormulario();
                }
                
                // Ctrl + R para actualizar lista
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    loadCategorias();
                }
            });
        }
// === FUNCIONES DE BÚSQUEDA Y FILTRADO ===
        function setupSearchFunctionality() {
            // Crear campo de búsqueda si se necesita en el futuro
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.className = 'form-control form-control-sm';
            searchInput.placeholder = 'Buscar categorías...';
            searchInput.style.display = 'none'; // Oculto por ahora
            
            // Función de filtrado en tiempo real
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                filterCategorias(searchTerm);
            });
        }

        function filterCategorias(searchTerm) {
            const filas = document.querySelectorAll('#categorias-tbody tr');
            let visibleCount = 0;
            
            filas.forEach(fila => {
                const nombreCategoria = fila.cells[1].textContent.toLowerCase();
                const isVisible = nombreCategoria.includes(searchTerm);
                
                fila.style.display = isVisible ? '' : 'none';
                if (isVisible) visibleCount++;
            });
            
            // Mostrar mensaje si no hay resultados
            if (visibleCount === 0 && filas.length > 0) {
                showNoResultsMessage();
            } else {
                hideNoResultsMessage();
            }
        }

        function showNoResultsMessage() {
            let noResultsRow = document.getElementById('no-results-row');
            if (!noResultsRow) {
                noResultsRow = document.createElement('tr');
                noResultsRow.id = 'no-results-row';
                noResultsRow.innerHTML = `
                    <td colspan="3" class="text-center py-4 text-muted">
                        <i class="bi bi-search me-2"></i>
                        No se encontraron categorías que coincidan con la búsqueda
                    </td>
                `;
                document.getElementById('categorias-tbody').appendChild(noResultsRow);
            }
            noResultsRow.style.display = '';
        }

        function hideNoResultsMessage() {
            const noResultsRow = document.getElementById('no-results-row');
            if (noResultsRow) {
                noResultsRow.style.display = 'none';
            }
        }

        // === FUNCIONES DE ESTADÍSTICAS ===
        function updateCategoryStats() {
            const totalCategorias = appData.categorias.length;
            const statsContainer = document.querySelector('.card-header h5');
            
            if (statsContainer && totalCategorias > 0) {
                statsContainer.innerHTML = `
                    <i class="bi bi-list-ul me-2"></i>
                    Categorías existentes 
                    <span class="badge bg-primary ms-2">${totalCategorias}</span>
                `;
            }
        }

        // === FUNCIONES DE VALIDACIÓN AVANZADA ===
        function validarCategoriaExistente(categoryName, excludeId = null) {
            if (!appData.categorias || appData.categorias.length === 0) {
                return false;
            }
            
            return appData.categorias.some(categoria => 
                categoria.category_name.toLowerCase().trim() === categoryName.toLowerCase().trim() &&
                categoria.category_id !== excludeId
            );
        }

        // === FUNCIONES DE BACKUP Y EXPORTACIÓN ===
        function exportarCategorias() {
            if (!appData.categorias || appData.categorias.length === 0) {
                showMessage('No hay categorías para exportar', 'warning');
                return;
            }
            
            try {
                const dataStr = JSON.stringify(appData.categorias, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `categorias_stm_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showMessage('Categorías exportadas correctamente', 'success');
            } catch (error) {
                console.error('Error exportando categorías:', error);
                showMessage('Error al exportar categorías: ' + error.message, 'danger');
            }
        }

        // === FUNCIONES DE DEBUGGING (solo en desarrollo) ===
        if (window.location.hostname === 'localhost' || window.location.hostname.includes('vercel.app')) {
            window.debugCategorias = function() {
                console.log('=== DEBUG CATEGORÍAS ===');
                console.log('App Data:', appData);
                console.log('Total categorías:', appData.categorias.length);
                console.log('Categoría editando:', appData.categoriaEditando);
                console.log('Enviando formulario:', appData.enviandoFormulario);
                console.log('========================');
            };
            
            window.testCRUD = async function() {
                console.log('Iniciando test CRUD...');
                try {
                    // Test crear
                    await crearCategoria('Test Category ' + Date.now());
                    console.log('✅ Crear: OK');
                    
                    // Recargar para test de edición
                    await loadCategorias();
                    
                    if (appData.categorias.length > 0) {
                        const testCategory = appData.categorias[0];
                        await actualizarCategoria(testCategory.category_id, testCategory.category_name + ' - Editado');
                        console.log('✅ Editar: OK');
                    }
                    
                    console.log('Test CRUD completado');
                } catch (error) {
                    console.error('❌ Error en test CRUD:', error);
                }
            };
        }

        // === FUNCIONES DE INICIALIZACIÓN FINAL ===
        function initializeAdvancedFeatures() {
            // Configurar tooltips si es necesario
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Configurar funcionalidad de búsqueda
            setupSearchFunctionality();
            
            // Actualizar estadísticas iniciales
            setTimeout(updateCategoryStats, 500);
        }

        // === MANEJO DE ERRORES GLOBALES ===
        window.addEventListener('error', function(e) {
            console.error('Error global en categorías:', e.error);
            if (!document.getElementById('alert-container').innerHTML) {
                showMessage('Error inesperado en la aplicación. Si el problema persiste, recargue la página.', 'danger');
            }
        });

        // Prevenir pérdida de datos
        window.addEventListener('beforeunload', function(e) {
            const categoryName = document.getElementById('category_name').value.trim();
            if (categoryName && !appData.enviandoFormulario) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // === INICIALIZACIÓN FINAL ===
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeAdvancedFeatures();
                console.log('Gestión de categorías STM inicializada correctamente');
            }, 200);
        });

        // Hacer funciones disponibles globalmente si es necesario
        window.loadCategorias = loadCategorias;
        window.exportarCategorias = exportarCategorias;
    </script>
</body>
</html>
        // Inicializar atajos de teclado después de cargar el DOM
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(setupKeyboardShortcuts, 100);
        });

              
