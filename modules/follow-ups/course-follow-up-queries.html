<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultas a Seguimientos por Cursos - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Estilos específicos para consultas a seguimientos por cursos */
        .students-table {
            margin-top: 20px;
        }
        
        .student-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #dee2e6;
        }
        
        .student-name {
            font-weight: 600;
            color: #0d6efd;
        }
        
        .action-btn {
            padding: 6px 12px;
            margin: 2px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            min-width: 80px;
            text-align: center;
        }
        
        .btn-asuntos {
            background-color: #6f42c1;
            color: white;
        }
        
        .btn-tareas {
            background-color: #ffc107;
            color: #000;
        }

        .btn-tareas:hover {
            background-color: #e0a800;
            color: #000;
        }
        
        .btn-metas {
            background-color: #198754;
            color: white;
        }
        
        .btn-documentos {
            background-color: #0dcaf0;
            color: white;
        }
        
        .btn-eae {
            background-color: #dc3545;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .table-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* Estilos para modales */
        .modal-large {
            max-width: 1400px;
            width: 95%;
        }

        .modal-medium {
            max-width: 800px;
            width: 90%;
        }

        .asunto-description-rich {
            max-width: 300px;
            max-height: 120px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .asunto-description-rich p {
            margin: 0 0 8px 0;
        }

        .asunto-description-rich ul, 
        .asunto-description-rich ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .asunto-description-rich li {
            margin: 4px 0;
        }

        .conclusion-content,
        .estrategia-content {
            max-width: 250px;
            max-height: 120px;
            overflow-y: auto;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
            word-wrap: break-word;
            border: 1px solid #e9ecef;
        }

        .conclusion-content p,
        .estrategia-content p {
            margin: 0 0 6px 0;
        }

        .conclusion-content:empty:before {
            content: "Sin conclusión registrada";
            color: #6c757d;
            font-style: italic;
        }

        .estrategia-content:empty:before {
            content: "Sin estrategia registrada";
            color: #6c757d;
            font-style: italic;
        }

        .categoria-cell {
            font-weight: 600;
            color: #0d6efd;
        }

        .fecha-cell {
            font-size: 12px;
            color: #6c757d;
        }

        .documento-description {
            max-width: 400px;
            max-height: 60px;
            overflow-y: auto;
            padding: 6px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.3;
        }

        .documento-enlace {
            display: inline-block;
            padding: 4px 8px;
            background-color: #6f42c1;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .documento-enlace:hover {
            background-color: #0d6efd;
            transform: translateY(-1px);
        }

        .trabajador-cell {
            font-weight: 500;
            color: #0d6efd;
            font-size: 13px;
        }

        .asunto-description {
            max-width: 350px;
            max-height: 80px;
            overflow-y: auto;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Contenedor principal -->
    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="../follow-ups/index.html">
                        Seguimientos
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Consultas a seguimientos por cursos
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-search me-2"></i>
                    Consultas a Seguimientos por Cursos
                </h1>
                <p class="text-muted">
                    Consulta y visualización de seguimientos a estudiantes organizados por cursos
                </p>
            </div>
        </div>

        <!-- Mensajes del sistema -->
        <div id="alertContainer"></div>

        <!-- Sección de selección de curso -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="selectCurso" class="form-label">Seleccione el curso:</label>
                        <select id="selectCurso" class="form-select" onchange="cargarEstudiantes()">
                            <option value="">-- Seleccione un curso --</option>
                        </select>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <div id="cursoInfo" class="text-muted small" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje de permisos -->
        <div id="mensajePermisos" style="display: none;"></div>

        <!-- Mensaje de carga -->
        <div id="mensajeCarga" class="alert alert-info" style="display: none;">
            <div class="d-flex align-items-center">
                <div class="loading-spinner me-2"></div>
                <span>Cargando estudiantes...</span>
            </div>
        </div>

        <!-- Tabla de estudiantes -->
        <div id="tablaContainer" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>
                        Estudiantes del curso
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-container">
                        <table class="table table-hover mb-0 students-table">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 80px;">Foto</th>
                                    <th>Nombre</th>
                                    <th style="width: 100px;">E.A.E</th>
                                    <th style="width: 100px;">Asuntos</th>
                                    <th style="width: 100px;">Tareas</th>
                                    <th style="width: 100px;">Metas</th>
                                    <th style="width: 120px;">Documentos</th>
                                </tr>
                            </thead>
                            <tbody id="tablaEstudiantes">
                                <!-- Los estudiantes se cargarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje cuando no hay datos -->
        <div id="noData" class="card" style="display: none;">
            <div class="card-body">
                <div class="no-data">
                    <i class="bi bi-info-circle display-1 text-muted"></i>
                    <p class="mt-3">No se encontraron estudiantes para el curso seleccionado.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de E.A.E -->
    <div class="modal fade" id="modalEAE" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tituloModalEAE">
                        <i class="bi bi-heart me-2"></i>
                        Asuntos EAE del Estudiante
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensaje de carga para EAE -->
                    <div id="mensajeCargaEAE" class="alert alert-info" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="loading-spinner me-2"></div>
                            <span>Cargando asuntos EAE del estudiante...</span>
                        </div>
                    </div>

                    <!-- Tabla de asuntos EAE -->
                    <div id="tablaEAEContainer" style="display: none;">
                        <div class="table-container">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 80px;">Fecha</th>
                                        <th style="width: 150px;">Apoyo</th>
                                        <th style="width: 150px;">Acciones</th>
                                        <th style="width: 150px;">Recomendaciones</th>
                                        <th style="width: 200px;">Conclusión</th>
                                        <th style="width: 200px;">Estrategia</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaEAE">
                                    <!-- Los asuntos EAE se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mensaje cuando no hay asuntos EAE -->
                    <div id="noDataEAE" class="no-data" style="display: none;">
                        <i class="bi bi-info-circle display-4 text-muted"></i>
                        <p class="mt-3">No se encontraron asuntos EAE abiertos para este estudiante.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Asuntos -->
    <div class="modal fade" id="modalAsuntos" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tituloModalAsuntos">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Asuntos del Estudiante
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensaje de carga para asuntos -->
                    <div id="mensajeCargaAsuntos" class="alert alert-info" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="loading-spinner me-2"></div>
                            <span>Cargando asuntos del estudiante...</span>
                        </div>
                    </div>

                    <!-- Tabla de asuntos -->
                    <div id="tablaAsuntosContainer" style="display: none;">
                        <div class="table-container">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 100px;">Categoría</th>
                                        <th style="width: 80px;">Fecha</th>
                                        <th style="width: 300px;">Descripción</th>
                                        <th style="width: 250px;">Conclusión</th>
                                        <th style="width: 250px;">Estrategia</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaAsuntos">
                                    <!-- Los asuntos se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mensaje cuando no hay asuntos -->
                    <div id="noDataAsuntos" class="no-data" style="display: none;">
                        <i class="bi bi-info-circle display-4 text-muted"></i>
                        <p class="mt-3">No se encontraron asuntos escalables y abiertos para este estudiante.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal de Tareas -->
    <div class="modal fade" id="modalTareas" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tituloModalTareas">
                        <i class="bi bi-check-square me-2"></i>
                        Tareas del Estudiante
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensaje de carga para tareas -->
                    <div id="mensajeCargaTareas" class="alert alert-info" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="loading-spinner me-2"></div>
                            <span>Cargando tareas del estudiante...</span>
                        </div>
                    </div>

                    <!-- Tabla de tareas -->
                    <div id="tablaTareasContainer" style="display: none;">
                        <div class="table-container">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 200px;">Asignada a</th>
                                        <th style="width: 120px;">Fecha límite</th>
                                        <th>Descripción</th>
                                        <th>Progreso</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaTareas">
                                    <!-- Las tareas se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mensaje cuando no hay tareas -->
                    <div id="noDataTareas" class="no-data" style="display: none;">
                        <i class="bi bi-info-circle display-4 text-muted"></i>
                        <p class="mt-3">No se encontraron tareas asignadas o en proceso para este estudiante.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Metas -->
    <div class="modal fade" id="modalMetas" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tituloModalMetas">
                        <i class="bi bi-target me-2"></i>
                        Metas del Estudiante
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensaje de carga para metas -->
                    <div id="mensajeCargaMetas" class="alert alert-info" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="loading-spinner me-2"></div>
                            <span>Cargando metas del estudiante...</span>
                        </div>
                    </div>

                    <!-- Tabla de metas -->
                    <div id="tablaMetasContainer" style="display: none;">
                        <div class="table-container">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 300px;">Descripción de la meta</th>
                                        <th style="width: 200px;">Progresos</th>
                                        <th style="width: 120px;">Fecha de creación</th>
                                        <th style="width: 80px;">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaMetas">
                                    <!-- Las metas se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mensaje cuando no hay metas -->
                    <div id="noDataMetas" class="no-data" style="display: none;">
                        <i class="bi bi-info-circle display-4 text-muted"></i>
                        <p class="mt-3">No se encontraron metas activas para este estudiante.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Documentos -->
    <div class="modal fade" id="modalDocumentos" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tituloModalDocumentos">
                        <i class="bi bi-file-earmark me-2"></i>
                        Documentos del Estudiante
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensaje de carga para documentos -->
                    <div id="mensajeCargaDocumentos" class="alert alert-info" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="loading-spinner me-2"></div>
                            <span>Cargando documentos del estudiante...</span>
                        </div>
                    </div>

                    <!-- Tabla de documentos -->
                    <div id="tablaDocumentosContainer" style="display: none;">
                        <div class="table-container">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 200px;">Suministrado por</th>
                                        <th>Descripción</th>
                                        <th style="width: 120px;">Enlace</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaDocumentos">
                                    <!-- Los documentos se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mensaje cuando no hay documentos -->
                    <div id="noDataDocumentos" class="no-data" style="display: none;">
                        <i class="bi bi-info-circle display-4 text-muted"></i>
                        <p class="mt-3">No se encontraron documentos vinculados para este estudiante.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Config.js -->
    <script src="../../assets/js/config.js"></script>
    <script>
        /**
         * JavaScript para Consultas a Seguimientos por Cursos
         * Sistema de consulta (solo lectura) migrado desde GAS
         */

        // Variables globales
        let estudiantesData = [];
        let studentIdActual = null;
        let iconosConfig = null;

        /**
         * Inicialización de la página
         */
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Validar permisos de acceso
                const tieneAcceso = await validatePageAccess('Consultas a seguimientos por cursos');
                if (!tieneAcceso) {
                    return;
                }

                // Cargar configuración inicial
                await cargarConfiguracionInicial();
                
            } catch (error) {
                console.error('Error en inicialización:', error);
                showMessage('Error al inicializar la página: ' + error.message, 'danger');
            }
        });

        /**
         * Carga la configuración inicial y los cursos permitidos
         */
        async function cargarConfiguracionInicial() {
            try {
                showMessage('Cargando configuración...', 'info');

                // Obtener cursos permitidos según permisos del usuario
                const cursosPermitidos = await obtenerCursosPermitidos();
                
                configurarSelectCursos(cursosPermitidos);
                
                // Cargar configuración de iconos para semáforo de metas
                await cargarConfiguracionIconos();
                
                showMessage('Configuración cargada correctamente', 'success');
                
            } catch (error) {
                console.error('Error cargando configuración:', error);
                showMessage('Error al cargar la configuración: ' + error.message, 'danger');
            }
        }

        /**
         * Obtiene los cursos permitidos según permisos del usuario
         */
        async function obtenerCursosPermitidos() {
            try {
                // Obtener información del usuario actual
                const session = getStoredSession();
                if (!session || !session.user) {
                    throw new Error('No hay sesión activa');
                }

                const userEmail = session.user.user_mail;
                
                // Obtener información del trabajador
                const workerData = await supabaseRequest('/workers?select=worker_id,email,organizational_division_id,organizational_cost_center_id&email=eq.' + encodeURIComponent(userEmail));
                
                if (workerData.length === 0) {
                    throw new Error('Usuario no encontrado en el sistema');
                }

                const worker = workerData[0];
                
                // Verificar si es directivo (división 1)
                if (worker.organizational_division_id) {
                    const divisionData = await supabaseRequest('/organizational_divisions?select=division_id,division_name&division_id=eq.' + worker.organizational_division_id);
                    
                    if (divisionData.length > 0 && divisionData[0].division_name === 'Directivo') {
                        // Es directivo - verificar si es director de sección
                        const seccionData = await supabaseRequest('/sections?select=section_id,section_name&director_email=eq.' + encodeURIComponent(userEmail));
                        
                        if (seccionData.length > 0) {
                            // Es director de sección - solo cursos de su sección
                            const cursos = await supabaseRequest('/courses?select=course_id,course_name,course_order,grades!inner(section_id)&grades.section_id=eq.' + seccionData[0].section_id + '&order=course_order');
                            
                            return {
                                cursos: cursos,
                                tienePermisos: true,
                                mensaje: `Cursos de la sección: ${seccionData[0].section_name}`
                            };
                        } else {
                            // Es directivo pero no director de sección - todos los cursos
                            const cursos = await supabaseRequest('/courses?select=course_id,course_name,course_order&order=course_order');
                            
                            return {
                                cursos: cursos,
                                tienePermisos: true,
                                mensaje: 'Todos los cursos (Usuario Directivo)'
                            };
                        }
                    }
                }
                
                // No es directivo - verificar asignación en worker_courses
                const cursosAsignados = await supabaseRequest('/worker_courses?select=courses!inner(course_id,course_name,course_order)&worker_id=eq.' + worker.worker_id + '&order=courses(course_order)');
                
                if (cursosAsignados.length > 0) {
                    const cursos = cursosAsignados.map(wc => wc.courses);
                    return {
                        cursos: cursos,
                        tienePermisos: true,
                        mensaje: ''
                    };
                } else {
                    return {
                        cursos: [],
                        tienePermisos: false,
                        mensaje: 'No tiene cursos asignados'
                    };
                }
                
            } catch (error) {
                console.error('Error obteniendo cursos permitidos:', error);
                return {
                    cursos: [],
                    tienePermisos: false,
                    mensaje: 'Error al verificar permisos: ' + error.message
                };
            }
        }

        /**
         * Configura el select de cursos según permisos
         */
        function configurarSelectCursos(cursosPermitidos) {
            const selectCurso = document.getElementById('selectCurso');
            const mensajePermisos = document.getElementById('mensajePermisos');
            
            if (cursosPermitidos.tienePermisos && cursosPermitidos.cursos.length > 0) {
                // Usuario tiene cursos disponibles
                cursosPermitidos.cursos.forEach(curso => {
                    const option = document.createElement('option');
                    option.value = curso.course_id;
                    option.textContent = curso.course_name;
                    selectCurso.appendChild(option);
                });
                
                // Mostrar mensaje informativo solo si tiene contenido relevante
                if (cursosPermitidos.mensaje && 
                    cursosPermitidos.mensaje.trim() !== '' &&
                    cursosPermitidos.mensaje !== 'Todos los cursos (Usuario Directivo)') {
                    
                    mensajePermisos.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            ${cursosPermitidos.mensaje}
                        </div>
                    `;
                    mensajePermisos.style.display = 'block';
                }
                
            } else {
                // Usuario no tiene cursos disponibles
                selectCurso.disabled = true;
                selectCurso.innerHTML = '<option value="">No tiene cursos disponibles</option>';
                
                mensajePermisos.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        ${cursosPermitidos.mensaje || 'No tiene cursos a su cargo'}
                    </div>
                `;
                mensajePermisos.style.display = 'block';
            }
        }

        /**
         * Carga los estudiantes del curso seleccionado con sus conteos
         */
        async function cargarEstudiantes() {
            const selectCurso = document.getElementById('selectCurso');
            const courseId = selectCurso.value;
            
            // Limpiar tabla anterior
            limpiarTabla();
            
            if (!courseId) {
                return;
            }
            
            try {
                // Mostrar mensaje de carga
                const mensajeCarga = document.getElementById('mensajeCarga');
                mensajeCarga.style.display = 'block';
                
                // Obtener estudiantes del curso con conteos
                const result = await obtenerEstudiantesConConteos(courseId);
                
                mensajeCarga.style.display = 'none';
                
                if (result.success) {
                    estudiantesData = result.estudiantes;
                    mostrarEstudiantesConConteos(result.estudiantes, result.conteos);
                } else {
                    showMessage('Error al cargar estudiantes: ' + result.error, 'danger');
                }
                
            } catch (error) {
                document.getElementById('mensajeCarga').style.display = 'none';
                console.error('Error cargando estudiantes:', error);
                showMessage('Error de conexión al cargar estudiantes: ' + error.message, 'danger');
            }
        }

        /**
         * Obtiene estudiantes del curso con sus conteos en una sola operación
         */
        async function obtenerEstudiantesConConteos(courseId) {
            try {
                if (!courseId) {
                    return {
                        success: false,
                        error: 'ID de curso no válido'
                    };
                }
                
                // Obtener estudiantes del curso (status_id 1 = activo)
                const estudiantes = await supabaseRequest(`/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2&course_id=eq.${courseId}&status_id=eq.1&order=student_first_name,student_last_name_1&limit=150`);
                
                if (estudiantes.length === 0) {
                    return {
                        success: true,
                        estudiantes: [],
                        conteos: {}
                    };
                }
                
                // Obtener conteos para todos los estudiantes
                const studentIds = estudiantes.map(e => e.student_id);
                const conteos = await obtenerConteosEstudiantes(studentIds);
                
                return {
                    success: true,
                    estudiantes: estudiantes,
                    conteos: conteos
                };
                
            } catch (error) {
                console.error('Error obteniendo estudiantes con conteos:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

      /**
         * Obtiene conteos de seguimientos para una lista de estudiantes
         */
        async function obtenerConteosEstudiantes(studentIds) {
            try {
                const conteosPorEstudiante = {};
                
                // Inicializar conteos para todos los estudiantes
                studentIds.forEach(studentId => {
                    conteosPorEstudiante[studentId] = {
                        eae: 0,
                        asuntos: 0,
                        tareas: 0,
                        metas: 0,
                        documentos: 0
                    };
                });

                // Conteo de asuntos EAE (is_open = 'SI')
                const eaeConteos = await supabaseRequest(`/stm_eae_topics?select=student_id&student_id=in.(${studentIds.join(',')})&is_open=eq.SI`);
                eaeConteos.forEach(item => {
                    if (conteosPorEstudiante[item.student_id]) {
                        conteosPorEstudiante[item.student_id].eae++;
                    }
                });

                // Conteo de asuntos escalables (is_open = 'SI' AND is_escalable = 'SI')
                const asuntosConteos = await supabaseRequest(`/stm_students_topics?select=student_id&student_id=in.(${studentIds.join(',')})&is_open=eq.SI&is_escalable=eq.SI`);
                asuntosConteos.forEach(item => {
                    if (conteosPorEstudiante[item.student_id]) {
                        conteosPorEstudiante[item.student_id].asuntos++;
                    }
                });

                // Conteo de tareas (task_state = 'Asignada' OR 'En proceso')
                const tareasConteos = await supabaseRequest(`/tasks?select=student_id&student_id=in.(${studentIds.join(',')})&task_state=in.(Asignada,En proceso)`);
                tareasConteos.forEach(item => {
                    if (conteosPorEstudiante[item.student_id]) {
                        conteosPorEstudiante[item.student_id].tareas++;
                    }
                });

                // Conteo de metas (goal_status != 3)
                const metasConteos = await supabaseRequest(`/stm_student_goals?select=student_id&student_id=in.(${studentIds.join(',')})&goal_status=neq.3`);
                metasConteos.forEach(item => {
                    if (conteosPorEstudiante[item.student_id]) {
                        conteosPorEstudiante[item.student_id].metas++;
                    }
                });

                // Conteo de documentos
                const documentosConteos = await supabaseRequest(`/stm_docs?select=student_id&student_id=in.(${studentIds.join(',')})`);
                documentosConteos.forEach(item => {
                    if (conteosPorEstudiante[item.student_id]) {
                        conteosPorEstudiante[item.student_id].documentos++;
                    }
                });

                return conteosPorEstudiante;
                
            } catch (error) {
                console.error('Error obteniendo conteos:', error);
                return {};
            }
        }

        /**
         * Limpia la tabla de estudiantes
         */
        function limpiarTabla() {
            const tablaContainer = document.getElementById('tablaContainer');
            const noDataDiv = document.getElementById('noData');
            const tablaEstudiantes = document.getElementById('tablaEstudiantes');
            
            tablaContainer.style.display = 'none';
            noDataDiv.style.display = 'none';
            tablaEstudiantes.innerHTML = '';
        }

        /**
         * Muestra estudiantes en la tabla con sus conteos
         */
        async function mostrarEstudiantesConConteos(estudiantes, conteos) {
            const tablaContainer = document.getElementById('tablaContainer');
            const noDataDiv = document.getElementById('noData');
            const tablaEstudiantes = document.getElementById('tablaEstudiantes');
            
            if (estudiantes.length === 0) {
                noDataDiv.style.display = 'block';
                return;
            }
            
            // Usar DocumentFragment para renderizado eficiente
            const fragment = document.createDocumentFragment();
            
            for (const estudiante of estudiantes) {
                const nombreCompleto = estudiante.student_first_name + ' ' + estudiante.student_last_name_1;
                
                // Obtener URL de foto usando sistema centralizado
                const fotoUrl = await getStudentPhotoUrl(estudiante.student_code);
                
                // Obtener conteos para este estudiante
                const conteosEstudiante = conteos[estudiante.student_id] || {
                    eae: 0,
                    asuntos: 0,
                    tareas: 0,
                    metas: 0,
                    documentos: 0
                };
                
                const tr = document.createElement('tr');
                
                // Columna foto
                const tdFoto = document.createElement('td');
                const img = document.createElement('img');
                img.className = 'student-photo';
                img.alt = 'Foto de ' + nombreCompleto;
                
                const divPlaceholder = document.createElement('div');
                divPlaceholder.style.cssText = 'display:none; width:50px; height:50px; border-radius:50%; background-color:#f8f9fa; border:2px solid #ddd; align-items:center; justify-content:center; font-size:20px; color:#6c757d;';
                divPlaceholder.innerHTML = '<i class="bi bi-person-circle"></i>';
                
                if (fotoUrl) {
                    img.src = fotoUrl;
                    img.onerror = function() {
                        this.style.display = 'none';
                        divPlaceholder.style.display = 'flex';
                    };
                } else {
                    img.style.display = 'none';
                    divPlaceholder.style.display = 'flex';
                }
                
                tdFoto.appendChild(img);
                tdFoto.appendChild(divPlaceholder);
                tr.appendChild(tdFoto);
                
                // Columna nombre
                const tdNombre = document.createElement('td');
                tdNombre.className = 'student-name';
                tdNombre.textContent = nombreCompleto;
                tr.appendChild(tdNombre);
                
                // Columna EAE
                const tdEAE = document.createElement('td');
                const btnEAE = document.createElement('button');
                btnEAE.className = 'action-btn btn-eae';
                btnEAE.textContent = 'E.A.E' + (conteosEstudiante.eae > 0 ? ' (' + conteosEstudiante.eae + ')' : '');
                btnEAE.onclick = () => abrirEAE(estudiante.student_id, nombreCompleto);
                tdEAE.appendChild(btnEAE);
                tr.appendChild(tdEAE);
                
                // Columna Asuntos
                const tdAsuntos = document.createElement('td');
                const btnAsuntos = document.createElement('button');
                btnAsuntos.className = 'action-btn btn-asuntos';
                btnAsuntos.textContent = 'Asuntos' + (conteosEstudiante.asuntos > 0 ? ' (' + conteosEstudiante.asuntos + ')' : '');
                btnAsuntos.onclick = () => abrirAsuntos(estudiante.student_id, nombreCompleto);
                tdAsuntos.appendChild(btnAsuntos);
                tr.appendChild(tdAsuntos);
                
                // Columna Tareas
                const tdTareas = document.createElement('td');
                const btnTareas = document.createElement('button');
                btnTareas.className = 'action-btn btn-tareas';
                btnTareas.textContent = 'Tareas' + (conteosEstudiante.tareas > 0 ? ' (' + conteosEstudiante.tareas + ')' : '');
                btnTareas.onclick = () => abrirTareas(estudiante.student_id, nombreCompleto);
                tdTareas.appendChild(btnTareas);
                tr.appendChild(tdTareas);
                
                // Columna Metas
                const tdMetas = document.createElement('td');
                const btnMetas = document.createElement('button');
                btnMetas.className = 'action-btn btn-metas';
                btnMetas.textContent = 'Metas' + (conteosEstudiante.metas > 0 ? ' (' + conteosEstudiante.metas + ')' : '');
                btnMetas.onclick = () => abrirMetas(estudiante.student_id, nombreCompleto);
                tdMetas.appendChild(btnMetas);
                tr.appendChild(tdMetas);
                
                // Columna Documentos
                const tdDocumentos = document.createElement('td');
                const btnDocumentos = document.createElement('button');
                btnDocumentos.className = 'action-btn btn-documentos';
                btnDocumentos.textContent = 'Documentos' + (conteosEstudiante.documentos > 0 ? ' (' + conteosEstudiante.documentos + ')' : '');
                btnDocumentos.onclick = () => abrirDocumentos(estudiante.student_id, nombreCompleto);
                tdDocumentos.appendChild(btnDocumentos);
                tr.appendChild(tdDocumentos);
                
                fragment.appendChild(tr);
            }
            
            // Actualizar DOM una sola vez
            tablaEstudiantes.innerHTML = '';
            tablaEstudiantes.appendChild(fragment);
            tablaContainer.style.display = 'block';
        }

        /**
         * Carga configuración de iconos para semáforo de metas
         */
        async function cargarConfiguracionIconos() {
            try {
                const configData = await supabaseRequest('/system_config?select=red_threshold,yellow_threshold,green_threshold&limit=1');
                
                if (configData.length > 0) {
                    iconosConfig = configData[0];
                } else {
                    iconosConfig = {};
                }
                
            } catch (error) {
                console.error('Error cargando configuración de iconos:', error);
                iconosConfig = {};
            }
        }

      /**
         * Funciones para abrir modales
         */
        function abrirEAE(studentId, nombreEstudiante) {
            studentIdActual = studentId;
            
            // Configurar título del modal
            const tituloModal = document.getElementById('tituloModalEAE');
            tituloModal.innerHTML = `<i class="bi bi-heart me-2"></i>Asuntos EAE de ${nombreEstudiante}`;
            
            // Mostrar modal y cargar datos
            const modal = new bootstrap.Modal(document.getElementById('modalEAE'));
            modal.show();
            
            cargarAsuntosEAE(studentId);
        }

        function abrirAsuntos(studentId, nombreEstudiante) {
            studentIdActual = studentId;
            
            // Configurar título del modal
            const tituloModal = document.getElementById('tituloModalAsuntos');
            tituloModal.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>Asuntos de ${nombreEstudiante}`;
            
            // Mostrar modal y cargar datos
            const modal = new bootstrap.Modal(document.getElementById('modalAsuntos'));
            modal.show();
            
            cargarAsuntosEstudiante(studentId);
        }

        function abrirTareas(studentId, nombreEstudiante) {
            studentIdActual = studentId;
            
            // Configurar título del modal
            const tituloModal = document.getElementById('tituloModalTareas');
            tituloModal.innerHTML = `<i class="bi bi-check-square me-2"></i>Tareas de ${nombreEstudiante}`;
            
            // Mostrar modal y cargar datos
            const modal = new bootstrap.Modal(document.getElementById('modalTareas'));
            modal.show();
            
            cargarTareasEstudiante(studentId);
        }

        function abrirMetas(studentId, nombreEstudiante) {
            studentIdActual = studentId;
            
            // Configurar título del modal
            const tituloModal = document.getElementById('tituloModalMetas');
            tituloModal.innerHTML = `<i class="bi bi-target me-2"></i>Metas de ${nombreEstudiante}`;
            
            // Mostrar modal y cargar datos
            const modal = new bootstrap.Modal(document.getElementById('modalMetas'));
            modal.show();
            
            cargarMetasEstudiante(studentId);
        }

        function abrirDocumentos(studentId, nombreEstudiante) {
            studentIdActual = studentId;
            
            // Configurar título del modal
            const tituloModal = document.getElementById('tituloModalDocumentos');
            tituloModal.innerHTML = `<i class="bi bi-file-earmark me-2"></i>Documentos de ${nombreEstudiante}`;
            
            // Mostrar modal y cargar datos
            const modal = new bootstrap.Modal(document.getElementById('modalDocumentos'));
            modal.show();
            
            cargarDocumentosEstudiante(studentId);
        }

        /**
         * Funciones específicas del modal de E.A.E
         */
        async function cargarAsuntosEAE(studentId) {
            try {
                // Mostrar mensaje de carga
                const mensajeCarga = document.getElementById('mensajeCargaEAE');
                mensajeCarga.style.display = 'block';
                
                // Limpiar tabla anterior
                limpiarTablaEAE();
                
                // Obtener asuntos EAE del estudiante
                const asuntosEAE = await supabaseRequest(`/stm_eae_topics?select=eae_topic_id,student_id,worker_id,topic_date,topic_description,supports,actions,recommendations,followup,topic_conclusion,topic_strategy,is_open,workers!inner(worker_first_name,worker_last_name_1)&student_id=eq.${studentId}&is_open=eq.SI&order=topic_date.desc&limit=50`);
                
                mensajeCarga.style.display = 'none';
                
                // Procesar asuntos EAE incluyendo nombre del reportador
                const asuntosEAEConReportador = asuntosEAE.map(asunto => {
                    const nombreReportador = asunto.workers && asunto.workers.worker_first_name && asunto.workers.worker_last_name_1
                        ? `${asunto.workers.worker_first_name} ${asunto.workers.worker_last_name_1}`
                        : 'No identificado';
                        
                    return {
                        ...asunto,
                        reportadoPor: nombreReportador
                    };
                });
                
                mostrarAsuntosEAE(asuntosEAEConReportador);
                
            } catch (error) {
                document.getElementById('mensajeCargaEAE').style.display = 'none';
                console.error('Error cargando asuntos EAE:', error);
                showMessage('Error al cargar asuntos EAE: ' + error.message, 'danger');
            }
        }

        function limpiarTablaEAE() {
            const tablaContainer = document.getElementById('tablaEAEContainer');
            const noDataDiv = document.getElementById('noDataEAE');
            const tablaEAE = document.getElementById('tablaEAE');
            
            tablaContainer.style.display = 'none';
            noDataDiv.style.display = 'none';
            tablaEAE.innerHTML = '';
        }

        function mostrarAsuntosEAE(asuntosEAE) {
            const tablaContainer = document.getElementById('tablaEAEContainer');
            const noDataDiv = document.getElementById('noDataEAE');
            const tablaEAE = document.getElementById('tablaEAE');
            
            if (asuntosEAE.length === 0) {
                noDataDiv.style.display = 'block';
                return;
            }
            
            // Usar DocumentFragment para renderizado eficiente
            const fragment = document.createDocumentFragment();
            
            asuntosEAE.forEach(asuntoEAE => {
                const tr = document.createElement('tr');
                
                // Columna fecha
                const tdFecha = document.createElement('td');
                tdFecha.className = 'fecha-cell';
                tdFecha.textContent = new Date(asuntoEAE.topic_date).toLocaleDateString('es-ES');
                tr.appendChild(tdFecha);
                
                // Columna apoyo (incluye reportador)
                const tdApoyo = document.createElement('td');
                const divApoyo = document.createElement('div');
                divApoyo.className = 'asunto-description';
                divApoyo.innerHTML = `
                    <div style="font-weight: 600; color: #6c757d; font-size: 13px; margin-bottom: 5px;">
                        Reportado por: ${asuntoEAE.reportadoPor}
                    </div>
                    <div>${asuntoEAE.supports || ''}</div>
                `;
                tdApoyo.appendChild(divApoyo);
                tr.appendChild(tdApoyo);
                
                // Columna acciones
                const tdAcciones = document.createElement('td');
                const divAcciones = document.createElement('div');
                divAcciones.className = 'asunto-description';
                divAcciones.innerHTML = asuntoEAE.actions || '';
                tdAcciones.appendChild(divAcciones);
                tr.appendChild(tdAcciones);
                
                // Columna recomendaciones
                const tdRecomendaciones = document.createElement('td');
                const divRecomendaciones = document.createElement('div');
                divRecomendaciones.className = 'asunto-description';
                divRecomendaciones.innerHTML = asuntoEAE.recommendations || '';
                tdRecomendaciones.appendChild(divRecomendaciones);
                tr.appendChild(tdRecomendaciones);
                
                // Columna conclusión EAE
                const tdConclusion = document.createElement('td');
                const divConclusion = document.createElement('div');
                divConclusion.className = 'conclusion-content';
                divConclusion.innerHTML = asuntoEAE.topic_conclusion || '';
                tdConclusion.appendChild(divConclusion);
                tr.appendChild(tdConclusion);
                
                // Columna estrategia EAE
                const tdEstrategia = document.createElement('td');
                const divEstrategia = document.createElement('div');
                divEstrategia.className = 'estrategia-content';
                divEstrategia.innerHTML = asuntoEAE.topic_strategy || '';
                tdEstrategia.appendChild(divEstrategia);
                tr.appendChild(tdEstrategia);
                
                fragment.appendChild(tr);
            });
            
            tablaEAE.innerHTML = '';
            tablaEAE.appendChild(fragment);
            tablaContainer.style.display = 'block';
        }

        /**
         * Funciones específicas del modal de Asuntos
         */
        async function cargarAsuntosEstudiante(studentId) {
            try {
                // Mostrar mensaje de carga
                const mensajeCarga = document.getElementById('mensajeCargaAsuntos');
                mensajeCarga.style.display = 'block';
                
                // Limpiar tabla anterior
                limpiarTablaAsuntos();
                
                // Obtener asuntos del estudiante con categorías
                const asuntos = await supabaseRequest(`/stm_students_topics?select=topic_id,student_id,topic_date,topic_description,topic_conclusion,topic_strategy,is_escalable,is_open,email,workers!inner(worker_first_name,worker_last_name_1),stm_students_topics_categories!inner(stm_category!inner(category_name))&student_id=eq.${studentId}&is_open=eq.SI&is_escalable=eq.SI&order=topic_date.desc&limit=100`);
                
                mensajeCarga.style.display = 'none';
                
                // Procesar asuntos agrupando categorías y añadiendo reportador
                const asuntosConReportador = asuntos.map(asunto => {
                    const nombreReportador = asunto.workers && asunto.workers.worker_first_name && asunto.workers.worker_last_name_1
                        ? `${asunto.workers.worker_first_name} ${asunto.workers.worker_last_name_1}`
                        : 'No identificado';
                    
                    const categorias = asunto.stm_students_topics_categories?.map(cat => cat.stm_category?.category_name).filter(Boolean).join(', ') || 'Sin categoría';
                    
                    return {
                        ...asunto,
                        reportadoPor: nombreReportador,
                        category_names: categorias
                    };
                });
                
                mostrarAsuntos(asuntosConReportador);
                
            } catch (error) {
                document.getElementById('mensajeCargaAsuntos').style.display = 'none';
                console.error('Error cargando asuntos:', error);
                showMessage('Error al cargar asuntos: ' + error.message, 'danger');
            }
        }

        function limpiarTablaAsuntos() {
            const tablaContainer = document.getElementById('tablaAsuntosContainer');
            const noDataDiv = document.getElementById('noDataAsuntos');
            const tablaAsuntos = document.getElementById('tablaAsuntos');
            
            tablaContainer.style.display = 'none';
            noDataDiv.style.display = 'none';
            tablaAsuntos.innerHTML = '';
        }

        function mostrarAsuntos(asuntos) {
            const tablaContainer = document.getElementById('tablaAsuntosContainer');
            const noDataDiv = document.getElementById('noDataAsuntos');
            const tablaAsuntos = document.getElementById('tablaAsuntos');
            
            if (asuntos.length === 0) {
                noDataDiv.style.display = 'block';
                return;
            }
            
            // Usar DocumentFragment para renderizado eficiente
            const fragment = document.createDocumentFragment();
            
            asuntos.forEach(asunto => {
                const tr = document.createElement('tr');
                
                // Columna categorías
                const tdCategoria = document.createElement('td');
                tdCategoria.className = 'categoria-cell';
                tdCategoria.textContent = asunto.category_names || 'Sin categoría';
                tr.appendChild(tdCategoria);        
                
                // Columna fecha
                const tdFecha = document.createElement('td');
                tdFecha.className = 'fecha-cell';
                tdFecha.textContent = new Date(asunto.topic_date).toLocaleDateString('es-ES');
                tr.appendChild(tdFecha);
                
                // Columna descripción (incluye reportador)
                const tdDescripcion = document.createElement('td');
                const divDescripcion = document.createElement('div');
                divDescripcion.className = 'asunto-description-rich';
                divDescripcion.innerHTML = `
                    <div style="font-weight: 600; color: #6c757d; font-size: 13px; margin-bottom: 5px;">
                        Reportado por: ${asunto.reportadoPor}
                    </div>
                    <div>${asunto.topic_description || '<em>Sin descripción</em>'}</div>
                `;
                tdDescripcion.appendChild(divDescripcion);
                tr.appendChild(tdDescripcion);
                
                // Columna conclusión
                const tdConclusion = document.createElement('td');
                const divConclusion = document.createElement('div');
                divConclusion.className = 'conclusion-content';
                divConclusion.innerHTML = asunto.topic_conclusion || '';
                tdConclusion.appendChild(divConclusion);
                tr.appendChild(tdConclusion);
                
                // Columna estrategia
                const tdEstrategia = document.createElement('td');
                const divEstrategia = document.createElement('div');
                divEstrategia.className = 'estrategia-content';
                divEstrategia.innerHTML = asunto.topic_strategy || '';
                tdEstrategia.appendChild(divEstrategia);
                tr.appendChild(tdEstrategia);
                
                fragment.appendChild(tr);
            });
            
            tablaAsuntos.innerHTML = '';
            tablaAsuntos.appendChild(fragment);
            tablaContainer.style.display = 'block';
        }

      /**
         * Funciones específicas del modal de Tareas
         */
        async function cargarTareasEstudiante(studentId) {
            try {
                // Mostrar mensaje de carga
                const mensajeCarga = document.getElementById('mensajeCargaTareas');
                mensajeCarga.style.display = 'block';
                
                // Limpiar tabla anterior
                limpiarTablaTareas();
                
                // Obtener tareas del estudiante
                const tareas = await supabaseRequest(`/tasks?select=task_id,student_id,assigned_to_mail,assigned_to_name,due_date,task_description,task_progress,task_state,workers!inner(worker_first_name,worker_last_name_1)&student_id=eq.${studentId}&task_state=in.(Asignada,En proceso)&order=due_date.asc&limit=50`);
                
                mensajeCarga.style.display = 'none';
                
                mostrarTareas(tareas);
                
            } catch (error) {
                document.getElementById('mensajeCargaTareas').style.display = 'none';
                console.error('Error cargando tareas:', error);
                showMessage('Error al cargar tareas: ' + error.message, 'danger');
            }
        }

        function limpiarTablaTareas() {
            const tablaContainer = document.getElementById('tablaTareasContainer');
            const noDataDiv = document.getElementById('noDataTareas');
            const tablaTareas = document.getElementById('tablaTareas');
            
            tablaContainer.style.display = 'none';
            noDataDiv.style.display = 'none';
            tablaTareas.innerHTML = '';
        }

        function mostrarTareas(tareas) {
            const tablaContainer = document.getElementById('tablaTareasContainer');
            const noDataDiv = document.getElementById('noDataTareas');
            const tablaTareas = document.getElementById('tablaTareas');
            
            if (tareas.length === 0) {
                noDataDiv.style.display = 'block';
                return;
            }
            
            // Usar DocumentFragment para renderizado eficiente
            const fragment = document.createDocumentFragment();
            
            tareas.forEach(tarea => {
                const nombreTrabajador = tarea.workers && tarea.workers.worker_first_name && tarea.workers.worker_last_name_1 
                    ? `${tarea.workers.worker_first_name} ${tarea.workers.worker_last_name_1}` 
                    : tarea.assigned_to_name || 'No especificado';
                    
                const tr = document.createElement('tr');
                
                // Columna trabajador
                const tdTrabajador = document.createElement('td');
                tdTrabajador.textContent = nombreTrabajador;
                tr.appendChild(tdTrabajador);
                
                // Columna fecha
                const tdFecha = document.createElement('td');
                tdFecha.textContent = new Date(tarea.due_date).toLocaleDateString('es-ES');
                tr.appendChild(tdFecha);
                
                // Columna descripción
                const tdDescripcion = document.createElement('td');
                const divDescripcion = document.createElement('div');
                divDescripcion.className = 'asunto-description';
                divDescripcion.innerHTML = tarea.task_description || '';
                tdDescripcion.appendChild(divDescripcion);
                tr.appendChild(tdDescripcion);
                
                // Columna progreso
                const tdProgreso = document.createElement('td');
                const divProgreso = document.createElement('div');
                divProgreso.className = 'asunto-description';
                divProgreso.innerHTML = tarea.task_progress || 'Sin progreso registrado';
                tdProgreso.appendChild(divProgreso);
                tr.appendChild(tdProgreso);
                
                fragment.appendChild(tr);
            });
            
            tablaTareas.innerHTML = '';
            tablaTareas.appendChild(fragment);
            tablaContainer.style.display = 'block';
        }

        /**
         * Funciones específicas del modal de Metas
         */
        async function cargarMetasEstudiante(studentId) {
            try {
                // Mostrar mensaje de carga
                const mensajeCarga = document.getElementById('mensajeCargaMetas');
                mensajeCarga.style.display = 'block';
                
                // Limpiar tabla anterior
                limpiarTablaMetas();
                
                // Obtener metas del estudiante
                const metas = await supabaseRequest(`/stm_student_goals?select=goal_id,student_id,goal_description,progress_notes,goal_creation_date,goal_status&student_id=eq.${studentId}&goal_status=neq.3&order=goal_creation_date.desc&limit=50`);
                
                mensajeCarga.style.display = 'none';
                
                mostrarMetas(metas);
                
            } catch (error) {
                document.getElementById('mensajeCargaMetas').style.display = 'none';
                console.error('Error cargando metas:', error);
                showMessage('Error al cargar metas: ' + error.message, 'danger');
            }
        }

        function limpiarTablaMetas() {
            const tablaContainer = document.getElementById('tablaMetasContainer');
            const noDataDiv = document.getElementById('noDataMetas');
            const tablaMetas = document.getElementById('tablaMetas');
            
            tablaContainer.style.display = 'none';
            noDataDiv.style.display = 'none';
            tablaMetas.innerHTML = '';
        }

        function mostrarMetas(metas) {
            const tablaContainer = document.getElementById('tablaMetasContainer');
            const noDataDiv = document.getElementById('noDataMetas');
            const tablaMetas = document.getElementById('tablaMetas');
            
            if (metas.length === 0) {
                noDataDiv.style.display = 'block';
                return;
            }
            
            // Usar DocumentFragment para renderizado eficiente
            const fragment = document.createDocumentFragment();
            
            metas.forEach(meta => {
                const tr = document.createElement('tr');
                
                // Columna descripción
                const tdDescripcion = document.createElement('td');
                const divDescripcion = document.createElement('div');
                divDescripcion.className = 'asunto-description';
                divDescripcion.innerHTML = meta.goal_description || '';
                tdDescripcion.appendChild(divDescripcion);
                tr.appendChild(tdDescripcion);
                
                // Columna progreso
                const tdProgreso = document.createElement('td');
                const divProgreso = document.createElement('div');
                divProgreso.className = 'asunto-description';
                divProgreso.innerHTML = meta.progress_notes || 'Sin progresos registrados';
                tdProgreso.appendChild(divProgreso);
                tr.appendChild(tdProgreso);
                
                // Columna fecha
                const tdFecha = document.createElement('td');
                tdFecha.className = 'fecha-cell';
                tdFecha.textContent = new Date(meta.goal_creation_date).toLocaleDateString('es-ES');
                tr.appendChild(tdFecha);
                
                // Columna estado con ícono
                const tdEstado = document.createElement('td');
                tdEstado.style.textAlign = 'center';
                
                // Determinar ícono según estado (1=Inicio, 2=Proceso, 3=Completado)
                let iconoHtml = '';
                if (meta.goal_status === 1) {
                    iconoHtml = '<i class="bi bi-circle text-danger" title="Inicio"></i>';
                } else if (meta.goal_status === 2) {
                    iconoHtml = '<i class="bi bi-circle-half text-warning" title="En proceso"></i>';
                } else if (meta.goal_status === 3) {
                    iconoHtml = '<i class="bi bi-check-circle text-success" title="Completado"></i>';
                } else {
                    iconoHtml = '<i class="bi bi-question-circle text-muted" title="Estado desconocido"></i>';
                }
                
                tdEstado.innerHTML = iconoHtml;
                tr.appendChild(tdEstado);
                
                fragment.appendChild(tr);
            });
            
            tablaMetas.innerHTML = '';
            tablaMetas.appendChild(fragment);
            tablaContainer.style.display = 'block';
        }

        /**
         * Funciones específicas del modal de Documentos
         */
        async function cargarDocumentosEstudiante(studentId) {
            try {
                // Mostrar mensaje de carga
                const mensajeCarga = document.getElementById('mensajeCargaDocumentos');
                mensajeCarga.style.display = 'block';
                
                // Limpiar tabla anterior
                limpiarTablaDocumentos();
                
                // Obtener documentos del estudiante
                const documentos = await supabaseRequest(`/stm_docs?select=doc_id,student_id,doc_url,doc_description,worker_name,private&student_id=eq.${studentId}&order=doc_id.desc&limit=100`);
                
                mensajeCarga.style.display = 'none';
                
                mostrarDocumentos(documentos);
                
            } catch (error) {
                document.getElementById('mensajeCargaDocumentos').style.display = 'none';
                console.error('Error cargando documentos:', error);
                showMessage('Error al cargar documentos: ' + error.message, 'danger');
            }
        }

        function limpiarTablaDocumentos() {
            const tablaContainer = document.getElementById('tablaDocumentosContainer');
            const noDataDiv = document.getElementById('noDataDocumentos');
            const tablaDocumentos = document.getElementById('tablaDocumentos');
            
            tablaContainer.style.display = 'none';
            noDataDiv.style.display = 'none';
            tablaDocumentos.innerHTML = '';
        }

        function mostrarDocumentos(documentos) {
            const tablaContainer = document.getElementById('tablaDocumentosContainer');
            const noDataDiv = document.getElementById('noDataDocumentos');
            const tablaDocumentos = document.getElementById('tablaDocumentos');
            
            if (documentos.length === 0) {
                noDataDiv.style.display = 'block';
                return;
            }
            
            // Usar DocumentFragment para renderizado eficiente
            const fragment = document.createDocumentFragment();
            
            documentos.forEach(documento => {
                const tr = document.createElement('tr');
                
                // Columna trabajador
                const tdTrabajador = document.createElement('td');
                tdTrabajador.className = 'trabajador-cell';
                tdTrabajador.textContent = documento.worker_name || 'No especificado';
                tr.appendChild(tdTrabajador);
                
                // Columna descripción
                const tdDescripcion = document.createElement('td');
                const divDescripcion = document.createElement('div');
                divDescripcion.className = 'documento-description';
                
                let descripcionCompleta = documento.doc_description || '';
                if (documento.private === 'SI') {
                    descripcionCompleta += '\n\nDocumento privado EAE';
                }
                divDescripcion.innerHTML = descripcionCompleta.replace(/\n/g, '<br>');
                tdDescripcion.appendChild(divDescripcion);
                tr.appendChild(tdDescripcion);
                
                // Columna enlace
                const tdEnlace = document.createElement('td');
                tdEnlace.style.textAlign = 'center';
                
                if (documento.doc_url) {
                    const a = document.createElement('a');
                    a.href = documento.doc_url;
                    a.target = '_blank';
                    a.className = 'documento-enlace';
                    a.textContent = 'Ver documento';
                    tdEnlace.appendChild(a);
                } else {
                    const span = document.createElement('span');
                    span.style.cssText = 'color: #6c757d; font-size: 11px;';
                    span.textContent = 'Sin enlace';
                    tdEnlace.appendChild(span);
                }
                
                tr.appendChild(tdEnlace);
                fragment.appendChild(tr);
            });
            
            tablaDocumentos.innerHTML = '';
            tablaDocumentos.appendChild(fragment);
            tablaContainer.style.display = 'block';
        }

      /**
         * Función auxiliar para formatear fechas
         */
        function formatearFecha(fecha) {
            if (!fecha) return '';
            return new Date(fecha).toLocaleDateString('es-ES');
        }

        /**
         * Función auxiliar para escapar HTML
         */
        function escaparHtml(texto) {
            if (!texto) return '';
            const div = document.createElement('div');
            div.textContent = texto;
            return div.innerHTML;
        }

        /**
         * Inicializar página con validación de permisos
         */
        function initializePage() {
            // Aplicar branding automático si es necesario
            applyBrandingAutomatically();
            
            // Actualizar título de página
            updatePageTitle('courseFollowUpQueries', 'Seguimientos');
        }

        // Llamar a initializePage cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }

    </script>
</body>
</html>
