<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.07.11.13">
    <title>Extracurriculares - SchoolNet</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .loading-overlay.hidden { display: none; }
        .loading-content { background: white; padding: 2rem; border-radius: 8px; text-align: center; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #0d9488; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn-teal { background-color: #0d9488; border-color: #0d9488; color: #fff; }
        .btn-teal:hover { background-color: #0f766e; border-color: #0f766e; color: #fff; }
        .badge-active { background-color: #d1fae5; color: #065f46; }
        .badge-inactive { background-color: #fee2e2; color: #991b1b; }
        .badge-day { background-color: #dbeafe; color: #1e40af; font-size: 0.75rem; margin-right: 0.25rem; }

        .table th { font-size: 0.85rem; white-space: nowrap; }
        .table td { vertical-align: middle; font-size: 0.9rem; }
        .catalog-table th, .catalog-table td { font-size: 0.85rem; padding: 0.5rem 0.75rem; }
        .empty-state { text-align: center; padding: 2rem 1rem; color: #6c757d; }
        .empty-state i { font-size: 2.5rem; margin-bottom: 0.75rem; display: block; }
        .count-badge { background-color: #0d9488; color: white; font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 1rem; }
        .summary-total { font-weight: 700; color: #0d9488; }

        .vehicle-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; }
        .vehicle-card.completed { border-left: 4px solid #059669; }
        .vehicle-card.not-completed { border-left: 4px solid #dc2626; }
        .vehicle-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .vehicle-label { font-weight: 600; font-size: 0.95rem; }
        .vehicle-detail { font-size: 0.8rem; color: #6b7280; }

        .day-check { width: 18px; height: 18px; cursor: pointer; }
    </style>
</head>

<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando extracurriculares...</p>
        </div>
    </div>

    <div class="container-fluid">

        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a></li>
                <li class="breadcrumb-item"><a href="index.html">Servicios y Eventos</a></li>
                <li class="breadcrumb-item active" aria-current="page">Extracurriculares</li>
            </ol>
        </nav>

        <!-- HEADER -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-bus-front me-2" style="color: #0d9488;"></i>
                    Transporte Extracurriculares
                </h1>
                <p class="text-muted">Ciclos semestrales, configuración de vehículos, registro diario y liquidación.</p>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- ============================================================ -->
        <!-- CICLOS — ACORDEÓN -->
        <!-- ============================================================ -->
        <div class="accordion mb-4" id="accordionCiclos">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-ciclos">
                        <i class="bi bi-calendar-range me-2"></i>Ciclos Semestrales
                        <span class="ms-2 count-badge" id="count-ciclos">0</span>
                    </button>
                </h2>
                <div id="collapse-ciclos" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-end mb-2">
                            <button class="btn btn-teal btn-sm" onclick="abrirModalCiclo()">
                                <i class="bi bi-plus-circle me-1"></i>Nuevo Ciclo
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm catalog-table mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Ciclo</th>
                                        <th>Año Académico</th>
                                        <th>Inicio</th>
                                        <th>Fin</th>
                                        <th>Días programados</th>
                                        <th>Estado</th>
                                        <th class="text-end">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-ciclos"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- VEHÍCULOS / CONFIGURACIONES -->
        <!-- ============================================================ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="mb-0"><i class="bi bi-truck me-2"></i>Configuración de Vehículos</h5>
                <div class="d-flex gap-2 align-items-center">
                    <select class="form-select form-select-sm" id="filtro-ciclo-vehiculos" style="width:auto;" onchange="cargarVehiculos()">
                        <option value="">Seleccionar ciclo...</option>
                    </select>
                    <button class="btn btn-teal btn-sm" onclick="abrirModalVehiculo()" id="btn-nuevo-vehiculo" disabled>
                        <i class="bi bi-plus-circle me-1"></i>Nueva Configuración
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Día</th>
                                <th>Vigente desde</th>
                                <th class="text-center">Capacidad</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-end">Tarifa congelada</th>
                                <th>Estado</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-vehiculos"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- REGISTRO DIARIO -->
        <!-- ============================================================ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="mb-0"><i class="bi bi-calendar-check me-2"></i>Registro Diario</h5>
                <div class="d-flex align-items-center gap-2">
                    <label class="form-label mb-0 fw-semibold" style="font-size:0.85rem;">Fecha:</label>
                    <input type="date" class="form-control form-control-sm" id="fecha-registro" style="width:auto;" onchange="cargarRegistroDiario()">
                </div>
            </div>
            <div class="card-body">
                <div id="registro-diario-container">
                    <div class="empty-state"><i class="bi bi-calendar3"></i>Seleccione una fecha para registrar</div>
                </div>
                <div class="text-end mt-3 d-none" id="btn-guardar-registro-container">
                    <button class="btn btn-teal" onclick="guardarRegistroDiario()">
                        <i class="bi bi-check-lg me-1"></i>Guardar Registro del Día
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- RESUMEN MENSUAL -->
        <!-- ============================================================ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Resumen Mensual</h5>
                <div class="d-flex align-items-center gap-2">
                    <select class="form-select form-select-sm" id="resumen-mes" style="width:auto;" onchange="cargarResumenMensual()">
                        <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                        <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                        <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                        <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                    </select>
                    <select class="form-select form-select-sm" id="resumen-anio" style="width:auto;" onchange="cargarResumenMensual()"></select>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Configuración</th>
                                <th class="text-center">Recorridos realizados</th>
                                <th class="text-center">Total pasajeros</th>
                                <th class="text-end">Tarifa</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-resumen"></tbody>
                        <tfoot>
                            <tr class="table-light">
                                <td colspan="4" class="text-end fw-bold">Total del mes:</td>
                                <td class="text-end summary-total" id="total-mes">$0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

    </div><!-- /container -->

    <!-- ================================================================= -->
    <!-- MODAL CICLO -->
    <!-- ================================================================= -->
    <div class="modal fade" id="modal-ciclo" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-ciclo-title"><i class="bi bi-calendar-range me-2"></i>Nuevo Ciclo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-ciclo" onsubmit="guardarCiclo(event)">
                    <div class="modal-body">
                        <input type="hidden" id="ciclo-id">
                        <div class="mb-3">
                            <label class="form-label">Año académico <span class="text-danger">*</span></label>
                            <select class="form-select" id="ciclo-anio-academico" required>
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nombre del ciclo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ciclo-nombre" required placeholder="Ej: Primer semestre 2025-2026">
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Fecha inicio <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="ciclo-inicio" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Fecha fin <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="ciclo-fin" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Días programados <span class="text-danger">*</span></label>
                            <div class="d-flex flex-wrap gap-3">
                                <div class="form-check"><input class="form-check-input day-check" type="checkbox" value="1" id="day-1"><label class="form-check-label" for="day-1">Lunes</label></div>
                                <div class="form-check"><input class="form-check-input day-check" type="checkbox" value="2" id="day-2"><label class="form-check-label" for="day-2">Martes</label></div>
                                <div class="form-check"><input class="form-check-input day-check" type="checkbox" value="3" id="day-3"><label class="form-check-label" for="day-3">Miércoles</label></div>
                                <div class="form-check"><input class="form-check-input day-check" type="checkbox" value="4" id="day-4"><label class="form-check-label" for="day-4">Jueves</label></div>
                                <div class="form-check"><input class="form-check-input day-check" type="checkbox" value="5" id="day-5"><label class="form-check-label" for="day-5">Viernes</label></div>
                                <div class="form-check"><input class="form-check-input day-check" type="checkbox" value="6" id="day-6"><label class="form-check-label" for="day-6">Sábado</label></div>
                                <div class="form-check"><input class="form-check-input day-check" type="checkbox" value="7" id="day-7"><label class="form-check-label" for="day-7">Domingo</label></div>
                            </div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="ciclo-activo" checked>
                            <label class="form-check-label" for="ciclo-activo">Activo</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-teal">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ================================================================= -->
    <!-- MODAL VEHÍCULO -->
    <!-- ================================================================= -->
    <div class="modal fade" id="modal-vehiculo" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-vehiculo-title"><i class="bi bi-truck me-2"></i>Nueva Configuración</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-vehiculo" onsubmit="guardarVehiculo(event)">
                    <div class="modal-body">
                        <input type="hidden" id="vehiculo-id">
                        <div class="mb-3">
                            <label class="form-label">Día de la semana <span class="text-danger">*</span></label>
                            <select class="form-select" id="vehiculo-dia" required>
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vigente desde <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="vehiculo-vigencia" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Capacidad del vehículo <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="vehiculo-capacidad" min="1" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Cantidad de vehículos <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="vehiculo-cantidad" min="1" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tarifa por recorrido <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="text" class="form-control" id="vehiculo-tarifa" required placeholder="0" oninput="formatearInputMoneda(this)">
                            </div>
                            <small class="text-muted">Se congela al crear. Consulte el tarifario de extracurriculares.</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="vehiculo-activo" checked>
                            <label class="form-check-label" for="vehiculo-activo">Activa</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-teal">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let cacheCiclos = [];
        let cacheCycleDays = {};       // { cycle_id: [1,3,5] }
        let cacheVehiculos = [];
        let cacheAniosAcademicos = [];
        let cacheRegistrosDia = [];
        let modalCiclo, modalVehiculo;

        const DIAS_SEMANA = { 1: 'Lunes', 2: 'Martes', 3: 'Miércoles', 4: 'Jueves', 5: 'Viernes', 6: 'Sábado', 7: 'Domingo' };
        const fmtCOP = v => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v);
        const badgeEstado = a => a ? '<span class="badge badge-active">Activo</span>' : '<span class="badge badge-inactive">Inactivo</span>';
        const emptyRow = (cols, msg) => `<tr><td colspan="${cols}" class="empty-state"><i class="bi bi-inbox"></i>${msg || 'No hay registros'}</td></tr>`;
        const fmtFecha = d => d ? new Date(d + 'T12:00:00').toLocaleDateString('es-CO') : '—';

        function getCurrentDateColombia() {
            const now = new Date();
            const colombiaOffset = -5 * 60;
            const localOffset = now.getTimezoneOffset();
            const colombiaTime = new Date(now.getTime() + (localOffset + colombiaOffset) * 60000);
            return `${colombiaTime.getFullYear()}-${String(colombiaTime.getMonth()+1).padStart(2,'0')}-${String(colombiaTime.getDate()).padStart(2,'0')}`;
        }

        function formatearInputMoneda(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor === '') { input.value = ''; return; }
            input.value = parseInt(valor).toLocaleString('es-CO');
        }

        function obtenerValorNumerico(inputId) {
            const raw = document.getElementById(inputId).value.replace(/\D/g, '');
            return raw ? parseFloat(raw) : 0;
        }

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const hasAccess = await validatePageAccess('Extracurriculares');
                if (!hasAccess) return;

                const session = getStoredSession();
                if (!session || !session.user) {
                    showMessage('Sesión no válida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '../../login.html', 1500);
                    return;
                }
                currentUser = session.user;
                await inicializarPagina();
            } catch (error) {
                console.error('❌ Error:', error);
                showMessage('Error de validación: ' + error.message, 'danger');
            }
        });

        async function inicializarPagina() {
            try {
                mostrarLoading();
                modalCiclo = new bootstrap.Modal(document.getElementById('modal-ciclo'));
                modalVehiculo = new bootstrap.Modal(document.getElementById('modal-vehiculo'));

                document.getElementById('fecha-registro').value = getCurrentDateColombia();

                const ahora = new Date();
                document.getElementById('resumen-mes').value = ahora.getMonth();
                const selectAnio = document.getElementById('resumen-anio');
                const anioActual = ahora.getFullYear();
                for (let y = anioActual; y >= anioActual - 2; y--) {
                    selectAnio.innerHTML += `<option value="${y}">${y}</option>`;
                }
                selectAnio.value = anioActual;

                await cargarAniosAcademicos();
                await cargarCiclos();
                await cargarRegistroDiario();
                await cargarResumenMensual();

                ocultarLoading();
            } catch (error) {
                console.error('❌ Error inicializando:', error);
                showMessage('Error al cargar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // AÑOS ACADÉMICOS
        // ==========================================
        async function cargarAniosAcademicos() {
            try {
                const data = await supabaseRequest('/academic_years?select=year_id,year_name,is_current&order=start_year.desc,start_month.desc');
                cacheAniosAcademicos = data || [];
            } catch (e) { console.error('❌ Error años académicos:', e); }
        }

        // ==========================================
        // CICLOS
        // ==========================================
        async function cargarCiclos() {
            try {
                const data = await supabaseRequest('/svc_extracurricular_cycles?select=*,academic_years(year_name)&order=start_date.desc');
                cacheCiclos = data || [];

                // Cargar días por ciclo
                const days = await supabaseRequest('/svc_extracurricular_cycle_days?select=*');
                cacheCycleDays = {};
                (days || []).forEach(d => {
                    if (!cacheCycleDays[d.cycle_id]) cacheCycleDays[d.cycle_id] = [];
                    cacheCycleDays[d.cycle_id].push(d.day_of_week);
                });

                renderCiclos();
                poblarSelectCiclos();
                document.getElementById('count-ciclos').textContent = cacheCiclos.length;
            } catch (e) { console.error('❌ Error ciclos:', e); }
        }

        function renderCiclos() {
            const tbody = document.getElementById('tbody-ciclos');
            if (cacheCiclos.length === 0) { tbody.innerHTML = emptyRow(7, 'No hay ciclos configurados'); return; }
            tbody.innerHTML = cacheCiclos.map(c => {
                const dias = (cacheCycleDays[c.cycle_id] || []).sort().map(d => `<span class="badge badge-day">${DIAS_SEMANA[d]}</span>`).join('');
                return `
                    <tr>
                        <td><strong>${c.cycle_name}</strong></td>
                        <td>${c.academic_years?.year_name || '—'}</td>
                        <td>${fmtFecha(c.start_date)}</td>
                        <td>${fmtFecha(c.end_date)}</td>
                        <td>${dias || '<span class="text-muted">Sin días</span>'}</td>
                        <td>${badgeEstado(c.is_active)}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary" onclick="editarCiclo('${c.cycle_id}')"><i class="bi bi-pencil"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function poblarSelectCiclos() {
            const select = document.getElementById('filtro-ciclo-vehiculos');
            const activos = cacheCiclos.filter(c => c.is_active);
            select.innerHTML = '<option value="">Seleccionar ciclo...</option>' +
                activos.map(c => `<option value="${c.cycle_id}">${c.cycle_name}</option>`).join('');

            // Si solo hay un ciclo activo, seleccionarlo
            if (activos.length === 1) {
                select.value = activos[0].cycle_id;
                cargarVehiculos();
            }
        }

        function abrirModalCiclo() {
            document.getElementById('form-ciclo').reset();
            document.getElementById('ciclo-id').value = '';
            document.getElementById('ciclo-activo').checked = true;
            document.querySelectorAll('.day-check').forEach(cb => cb.checked = false);

            const selectAnio = document.getElementById('ciclo-anio-academico');
            selectAnio.innerHTML = '<option value="">Seleccionar...</option>' +
                cacheAniosAcademicos.map(a => `<option value="${a.year_id}" ${a.is_current ? 'selected' : ''}>${a.year_name}</option>`).join('');

            document.getElementById('modal-ciclo-title').innerHTML = '<i class="bi bi-calendar-range me-2"></i>Nuevo Ciclo';
            modalCiclo.show();
        }

        function editarCiclo(id) {
            const c = cacheCiclos.find(x => x.cycle_id === id);
            if (!c) return;

            const selectAnio = document.getElementById('ciclo-anio-academico');
            selectAnio.innerHTML = '<option value="">Seleccionar...</option>' +
                cacheAniosAcademicos.map(a => `<option value="${a.year_id}">${a.year_name}</option>`).join('');

            document.getElementById('ciclo-id').value = c.cycle_id;
            document.getElementById('ciclo-anio-academico').value = c.academic_year_id;
            document.getElementById('ciclo-nombre').value = c.cycle_name;
            document.getElementById('ciclo-inicio').value = c.start_date;
            document.getElementById('ciclo-fin').value = c.end_date;
            document.getElementById('ciclo-activo').checked = c.is_active;

            // Marcar días
            document.querySelectorAll('.day-check').forEach(cb => cb.checked = false);
            (cacheCycleDays[c.cycle_id] || []).forEach(d => {
                const cb = document.getElementById(`day-${d}`);
                if (cb) cb.checked = true;
            });

            document.getElementById('modal-ciclo-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Ciclo';
            modalCiclo.show();
        }

        async function guardarCiclo(e) {
            e.preventDefault();
            const id = document.getElementById('ciclo-id').value;
            const diasSeleccionados = [];
            document.querySelectorAll('.day-check:checked').forEach(cb => diasSeleccionados.push(parseInt(cb.value)));

            if (diasSeleccionados.length === 0) {
                showMessage('Seleccione al menos un día de la semana', 'warning');
                return;
            }

            const payload = {
                academic_year_id: document.getElementById('ciclo-anio-academico').value,
                cycle_name: document.getElementById('ciclo-nombre').value.trim(),
                start_date: document.getElementById('ciclo-inicio').value,
                end_date: document.getElementById('ciclo-fin').value,
                is_active: document.getElementById('ciclo-activo').checked
            };

            try {
                let cycleId = id;

                if (id) {
                    await supabaseRequest(`/svc_extracurricular_cycles?cycle_id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(payload) });
                } else {
                    const result = await supabaseRequest('/svc_extracurricular_cycles', {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        headers: { 'Prefer': 'return=representation' }
                    });
                    cycleId = Array.isArray(result) ? result[0].cycle_id : result.cycle_id;
                }

                // Actualizar días: borrar existentes y reinsertar
                await supabaseRequest(`/svc_extracurricular_cycle_days?cycle_id=eq.${cycleId}`, { method: 'DELETE' });
                if (diasSeleccionados.length > 0) {
                    const daysPayload = diasSeleccionados.map(d => ({ cycle_id: cycleId, day_of_week: d }));
                    await supabaseRequest('/svc_extracurricular_cycle_days', { method: 'POST', body: JSON.stringify(daysPayload) });
                }

                modalCiclo.hide();
                showMessage('Ciclo guardado correctamente', 'success');
                await cargarCiclos();
            } catch (err) { showMessage('Error al guardar ciclo: ' + err.message, 'danger'); }
        }

        // ==========================================
        // VEHÍCULOS / CONFIGURACIONES
        // ==========================================
        async function cargarVehiculos() {
            const cycleId = document.getElementById('filtro-ciclo-vehiculos').value;
            const btnNuevo = document.getElementById('btn-nuevo-vehiculo');
            const tbody = document.getElementById('tbody-vehiculos');

            if (!cycleId) {
                btnNuevo.disabled = true;
                tbody.innerHTML = emptyRow(7, 'Seleccione un ciclo para ver sus configuraciones');
                return;
            }

            btnNuevo.disabled = false;

            try {
                const data = await supabaseRequest(`/svc_extracurricular_vehicle_configs?select=*&cycle_id=eq.${cycleId}&order=day_of_week.asc,effective_from.desc`);
                cacheVehiculos = data || [];
                renderVehiculos();
            } catch (e) { console.error('❌ Error vehículos:', e); }
        }

        function renderVehiculos() {
            const tbody = document.getElementById('tbody-vehiculos');
            if (cacheVehiculos.length === 0) { tbody.innerHTML = emptyRow(7, 'No hay configuraciones para este ciclo'); return; }
            tbody.innerHTML = cacheVehiculos.map(v => `
                <tr>
                    <td><span class="badge badge-day">${DIAS_SEMANA[v.day_of_week] || v.day_of_week}</span></td>
                    <td>${fmtFecha(v.effective_from)}</td>
                    <td class="text-center">${v.vehicle_capacity} pas.</td>
                    <td class="text-center">${v.vehicle_count}</td>
                    <td class="text-end">${fmtCOP(v.frozen_rate_value)}</td>
                    <td>${badgeEstado(v.is_active)}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="editarVehiculo('${v.config_id}')"><i class="bi bi-pencil"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function abrirModalVehiculo() {
            const cycleId = document.getElementById('filtro-ciclo-vehiculos').value;
            if (!cycleId) return;

            document.getElementById('form-vehiculo').reset();
            document.getElementById('vehiculo-id').value = '';
            document.getElementById('vehiculo-activo').checked = true;
            document.getElementById('vehiculo-vigencia').value = getCurrentDateColombia();

            // Poblar días del ciclo seleccionado
            const dias = cacheCycleDays[cycleId] || [];
            const selectDia = document.getElementById('vehiculo-dia');
            selectDia.innerHTML = '<option value="">Seleccionar...</option>' +
                dias.sort().map(d => `<option value="${d}">${DIAS_SEMANA[d]}</option>`).join('');

            document.getElementById('modal-vehiculo-title').innerHTML = '<i class="bi bi-truck me-2"></i>Nueva Configuración';
            modalVehiculo.show();
        }

        function editarVehiculo(id) {
            const v = cacheVehiculos.find(x => x.config_id === id);
            if (!v) return;

            const cycleId = document.getElementById('filtro-ciclo-vehiculos').value;
            const dias = cacheCycleDays[cycleId] || [];
            const selectDia = document.getElementById('vehiculo-dia');
            selectDia.innerHTML = '<option value="">Seleccionar...</option>' +
                dias.sort().map(d => `<option value="${d}">${DIAS_SEMANA[d]}</option>`).join('');

            document.getElementById('vehiculo-id').value = v.config_id;
            document.getElementById('vehiculo-dia').value = v.day_of_week;
            document.getElementById('vehiculo-vigencia').value = v.effective_from;
            document.getElementById('vehiculo-capacidad').value = v.vehicle_capacity;
            document.getElementById('vehiculo-cantidad').value = v.vehicle_count;
            document.getElementById('vehiculo-tarifa').value = parseInt(v.frozen_rate_value).toLocaleString('es-CO');
            document.getElementById('vehiculo-activo').checked = v.is_active;

            document.getElementById('modal-vehiculo-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Configuración';
            modalVehiculo.show();
        }

        async function guardarVehiculo(e) {
            e.preventDefault();
            const id = document.getElementById('vehiculo-id').value;
            const cycleId = document.getElementById('filtro-ciclo-vehiculos').value;

            const payload = {
                cycle_id: cycleId,
                day_of_week: parseInt(document.getElementById('vehiculo-dia').value),
                effective_from: document.getElementById('vehiculo-vigencia').value,
                vehicle_capacity: parseInt(document.getElementById('vehiculo-capacidad').value),
                vehicle_count: parseInt(document.getElementById('vehiculo-cantidad').value),
                frozen_rate_value: obtenerValorNumerico('vehiculo-tarifa'),
                is_active: document.getElementById('vehiculo-activo').checked
            };

            try {
                if (id) {
                    await supabaseRequest(`/svc_extracurricular_vehicle_configs?config_id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(payload) });
                } else {
                    await supabaseRequest('/svc_extracurricular_vehicle_configs', { method: 'POST', body: JSON.stringify(payload) });
                }
                modalVehiculo.hide();
                showMessage('Configuración guardada', 'success');
                await cargarVehiculos();
            } catch (err) { showMessage('Error: ' + err.message, 'danger'); }
        }

        // ==========================================
        // REGISTRO DIARIO
        // ==========================================
        async function cargarRegistroDiario() {
            const fecha = document.getElementById('fecha-registro').value;
            if (!fecha) return;

            const container = document.getElementById('registro-diario-container');
            const btnContainer = document.getElementById('btn-guardar-registro-container');

            // Determinar día de la semana (1=Lun ... 7=Dom)
            const dateObj = new Date(fecha + 'T12:00:00');
            const jsDay = dateObj.getDay(); // 0=Dom, 1=Lun...
            const dayOfWeek = jsDay === 0 ? 7 : jsDay;

            // Buscar ciclo activo que cubra esta fecha
            const cicloActivo = cacheCiclos.find(c =>
                c.is_active && fecha >= c.start_date && fecha <= c.end_date
            );

            if (!cicloActivo) {
                container.innerHTML = '<div class="empty-state"><i class="bi bi-info-circle"></i>No hay ciclo activo que cubra esta fecha</div>';
                btnContainer.classList.add('d-none');
                return;
            }

            // Verificar si este día está programado en el ciclo
            const diasCiclo = cacheCycleDays[cicloActivo.cycle_id] || [];
            if (!diasCiclo.includes(dayOfWeek)) {
                const fechaDisplay = dateObj.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                container.innerHTML = `<div class="empty-state"><i class="bi bi-calendar-x"></i>${DIAS_SEMANA[dayOfWeek]} no es día programado en "${cicloActivo.cycle_name}"<br><small class="text-muted">${fechaDisplay}</small></div>`;
                btnContainer.classList.add('d-none');
                return;
            }

            // Buscar configuración de vehículos vigente para este día
            try {
                const configs = await supabaseRequest(`/svc_extracurricular_vehicle_configs?select=*&cycle_id=eq.${cicloActivo.cycle_id}&day_of_week=eq.${dayOfWeek}&is_active=eq.true&effective_from=lte.${fecha}&order=effective_from.desc`);

                if (!configs || configs.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="bi bi-truck"></i>No hay vehículos configurados para este día</div>';
                    btnContainer.classList.add('d-none');
                    return;
                }

                // Tomar la configuración más reciente (primera por order desc)
                const configVigente = configs[0];

                // Cargar registros existentes
                const registros = await supabaseRequest(`/svc_extracurricular_daily_records?select=*&config_id=eq.${configVigente.config_id}&record_date=eq.${fecha}&order=vehicle_number.asc`);
                cacheRegistrosDia = registros || [];

                renderRegistroDiario(configVigente, fecha, dateObj);
                btnContainer.classList.remove('d-none');
            } catch (e) {
                console.error('❌ Error registro diario:', e);
                container.innerHTML = '<div class="empty-state text-danger"><i class="bi bi-exclamation-triangle"></i>Error al cargar registro</div>';
            }
        }

        function renderRegistroDiario(config, fecha, dateObj) {
            const container = document.getElementById('registro-diario-container');
            const fechaDisplay = dateObj.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            let html = `
                <p class="text-muted mb-1" style="font-size:0.9rem;">
                    <i class="bi bi-calendar3 me-1"></i>${fechaDisplay}
                </p>
                <p class="mb-3" style="font-size:0.85rem;">
                    <span class="badge badge-day">${DIAS_SEMANA[config.day_of_week]}</span>
                    ${config.vehicle_count} vehículo(s) de ${config.vehicle_capacity} pasajeros — Tarifa: ${fmtCOP(config.frozen_rate_value)}
                </p>
            `;

            for (let i = 1; i <= config.vehicle_count; i++) {
                const reg = cacheRegistrosDia.find(r => r.vehicle_number === i);
                const completado = reg ? reg.was_completed : true;
                const pasajeros = reg ? (reg.passenger_count || '') : '';
                const motivo = reg ? (reg.cancellation_reason || '') : '';
                const cardClass = reg ? (completado ? 'completed' : 'not-completed') : '';

                html += `
                    <div class="vehicle-card ${cardClass}" id="vc-${i}">
                        <div class="vehicle-header">
                            <span class="vehicle-label">Vehículo ${i} <span class="vehicle-detail">(${config.vehicle_capacity} pas.)</span></span>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" role="switch"
                                    id="vc-toggle-${i}"
                                    data-vehicle-number="${i}"
                                    data-config-id="${config.config_id}"
                                    data-frozen-rate="${config.frozen_rate_value}"
                                    data-record-id="${reg ? reg.record_id : ''}"
                                    ${completado ? 'checked' : ''}
                                    onchange="toggleVehiculo(${i})">
                                <label class="form-check-label" for="vc-toggle-${i}" id="vc-label-${i}">${completado ? '✅ Realizado' : '❌ No realizado'}</label>
                            </div>
                        </div>
                        <div id="vc-fields-${i}">
                            ${completado ?
                                `<div class="mt-2">
                                    <label class="form-label" style="font-size:0.85rem;">Número de pasajeros</label>
                                    <input type="number" class="form-control form-control-sm" id="vc-pasajeros-${i}" min="0" value="${pasajeros}" style="width:120px;">
                                </div>` :
                                `<div class="mt-2">
                                    <label class="form-label" style="font-size:0.85rem;">Motivo de cancelación <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control form-control-sm" id="vc-motivo-${i}" value="${motivo}" placeholder="Ej: Lluvia torrencial">
                                </div>`
                            }
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function toggleVehiculo(num) {
            const toggle = document.getElementById(`vc-toggle-${num}`);
            const label = document.getElementById(`vc-label-${num}`);
            const fields = document.getElementById(`vc-fields-${num}`);
            const card = document.getElementById(`vc-${num}`);
            const checked = toggle.checked;

            label.textContent = checked ? '✅ Realizado' : '❌ No realizado';
            card.className = `vehicle-card ${checked ? 'completed' : 'not-completed'}`;

            if (checked) {
                fields.innerHTML = `
                    <div class="mt-2">
                        <label class="form-label" style="font-size:0.85rem;">Número de pasajeros</label>
                        <input type="number" class="form-control form-control-sm" id="vc-pasajeros-${num}" min="0" style="width:120px;">
                    </div>`;
            } else {
                fields.innerHTML = `
                    <div class="mt-2">
                        <label class="form-label" style="font-size:0.85rem;">Motivo de cancelación <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-sm" id="vc-motivo-${num}" placeholder="Ej: Lluvia torrencial">
                    </div>`;
            }
        }

        async function guardarRegistroDiario() {
            const fecha = document.getElementById('fecha-registro').value;
            if (!fecha) return;

            const toggles = document.querySelectorAll('[data-vehicle-number]');
            if (toggles.length === 0) return;

            try {
                mostrarLoading();

                for (const toggle of toggles) {
                    const num = parseInt(toggle.dataset.vehicleNumber);
                    const configId = toggle.dataset.configId;
                    const frozenRate = parseFloat(toggle.dataset.frozenRate);
                    const recordId = toggle.dataset.recordId;
                    const wasCompleted = toggle.checked;

                    let passengerCount = null;
                    let cancellationReason = null;

                    if (wasCompleted) {
                        const pInput = document.getElementById(`vc-pasajeros-${num}`);
                        passengerCount = pInput && pInput.value ? parseInt(pInput.value) : 0;
                    } else {
                        const mInput = document.getElementById(`vc-motivo-${num}`);
                        cancellationReason = mInput ? mInput.value.trim() : '';
                        if (!cancellationReason) {
                            showMessage(`Vehículo ${num}: indique el motivo de cancelación`, 'warning');
                            ocultarLoading();
                            return;
                        }
                    }

                    const payload = {
                        was_completed: wasCompleted,
                        passenger_count: passengerCount,
                        cancellation_reason: cancellationReason,
                        recorded_by: currentUser.user_id,
                        updated_at: new Date().toISOString()
                    };

                    if (recordId) {
                        await supabaseRequest(`/svc_extracurricular_daily_records?record_id=eq.${recordId}`, { method: 'PATCH', body: JSON.stringify(payload) });
                    } else {
                        payload.config_id = configId;
                        payload.record_date = fecha;
                        payload.vehicle_number = num;
                        payload.frozen_rate_value = frozenRate;
                        await supabaseRequest('/svc_extracurricular_daily_records', { method: 'POST', body: JSON.stringify(payload) });
                    }
                }

                showMessage('Registro del día guardado correctamente', 'success');
                await cargarRegistroDiario();
                await cargarResumenMensual();
                ocultarLoading();
            } catch (err) {
                showMessage('Error al guardar: ' + err.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // RESUMEN MENSUAL
        // ==========================================
        async function cargarResumenMensual() {
            const mes = parseInt(document.getElementById('resumen-mes').value);
            const anio = parseInt(document.getElementById('resumen-anio').value);
            const primerDia = `${anio}-${String(mes+1).padStart(2,'0')}-01`;
            const ultimoDia = new Date(anio, mes+1, 0);
            const ultimoDiaStr = `${anio}-${String(mes+1).padStart(2,'0')}-${String(ultimoDia.getDate()).padStart(2,'0')}`;

            try {
                const data = await supabaseRequest(`/svc_extracurricular_daily_records?select=*,svc_extracurricular_vehicle_configs(day_of_week,vehicle_capacity,svc_extracurricular_cycles(cycle_name))&record_date=gte.${primerDia}&record_date=lte.${ultimoDiaStr}&order=record_date.asc`);
                renderResumenMensual(data || []);
            } catch (e) { console.error('❌ Error resumen:', e); }
        }

        function renderResumenMensual(registros) {
            const tbody = document.getElementById('tbody-resumen');

            if (registros.length === 0) {
                tbody.innerHTML = emptyRow(5, 'No hay registros para este mes');
                document.getElementById('total-mes').textContent = fmtCOP(0);
                return;
            }

            // Agrupar por config_id
            const grupos = {};
            registros.forEach(r => {
                if (!grupos[r.config_id]) {
                    const cfg = r.svc_extracurricular_vehicle_configs;
                    const cicloNombre = cfg?.svc_extracurricular_cycles?.cycle_name || '';
                    const dia = DIAS_SEMANA[cfg?.day_of_week] || '';
                    const cap = cfg?.vehicle_capacity || '?';
                    grupos[r.config_id] = {
                        label: `${cicloNombre} — ${dia} (${cap} pas.)`,
                        realizados: 0,
                        pasajeros: 0,
                        subtotal: 0,
                        tarifa: 0
                    };
                }
                if (r.was_completed) {
                    grupos[r.config_id].realizados++;
                    grupos[r.config_id].pasajeros += (r.passenger_count || 0);
                    grupos[r.config_id].subtotal += parseFloat(r.frozen_rate_value) || 0;
                    grupos[r.config_id].tarifa = parseFloat(r.frozen_rate_value) || 0;
                }
            });

            let totalMes = 0;
            tbody.innerHTML = Object.values(grupos).map(g => {
                totalMes += g.subtotal;
                return `
                    <tr>
                        <td><strong>${g.label}</strong></td>
                        <td class="text-center">${g.realizados}</td>
                        <td class="text-center">${g.pasajeros}</td>
                        <td class="text-end">${fmtCOP(g.tarifa)}</td>
                        <td class="text-end fw-semibold">${fmtCOP(g.subtotal)}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('total-mes').textContent = fmtCOP(totalMes);
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function mostrarLoading() { document.getElementById('loading-overlay')?.classList.remove('hidden'); }
        function ocultarLoading() { document.getElementById('loading-overlay')?.classList.add('hidden'); }
    </script>
</body>
</html>
