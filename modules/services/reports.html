<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.27.14.40">
    <title>Reportes de Servicios - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Configuracion global -->
    <script src="/assets/js/config.js"></script>
    
    <!-- Librerias de exportacion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --service-primary: #1B365D;
            --service-accent: #667eea;
        }
        
        .nav-tabs .nav-link.active {
            font-weight: 600;
            border-bottom: 3px solid var(--service-primary);
            color: var(--service-primary);
        }
        
        .summary-card {
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .summary-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.5rem;
        }
        
        .table-report th {
            background-color: #f8f9fa;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }
        
        .table-report td {
            vertical-align: middle;
            font-size: 0.9rem;
        }
        
        .row-total {
            background-color: #e9ecef !important;
            font-weight: 700;
        }
        
        .export-buttons .btn {
            min-width: 120px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html">Inicio</a></li>
                <li class="breadcrumb-item"><a href="index.html">Servicios</a></li>
                <li class="breadcrumb-item active" aria-current="page">Reportes</li>
            </ol>
        </nav>
        
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="mb-1"><i class="bi bi-file-earmark-bar-graph me-2"></i>Reportes de Servicios</h3>
                <p class="text-muted mb-0">Consolidados, soportes de pago y reportes operativos</p>
            </div>
        </div>
        
        <!-- Tabs de navegacion -->
        <ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-consolidado" data-bs-toggle="tab" data-bs-target="#panel-consolidado" type="button">
                    <i class="bi bi-bar-chart me-1"></i>Consolidado Transporte
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-detalle" data-bs-toggle="tab" data-bs-target="#panel-detalle" type="button">
                    <i class="bi bi-list-columns me-1"></i>Detalle Transporte
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-eventos" data-bs-toggle="tab" data-bs-target="#panel-eventos" type="button">
                    <i class="bi bi-calendar-event me-1"></i>Eventos Internos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-solicitudes" data-bs-toggle="tab" data-bs-target="#panel-solicitudes" type="button">
                    <i class="bi bi-clipboard-check me-1"></i>Solicitudes
                </button>
            </li>
        </ul>
        
        <!-- Contenido de tabs -->
        <div class="tab-content" id="reportTabContent">
            
            <!-- ==================== TAB 1: CONSOLIDADO TRANSPORTE ==================== -->
            <div class="tab-pane fade show active" id="panel-consolidado">
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="row align-items-end g-3">
                            <div class="col-md-3">
                                <label class="form-label">Mes</label>
                                <select class="form-select" id="consolidadoMes"></select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Ano</label>
                                <input type="number" class="form-control" id="consolidadoAno" min="2024" max="2030">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100" onclick="generarConsolidado()">
                                    <i class="bi bi-search me-1"></i>Generar
                                </button>
                            </div>
                            <div class="col-md-3 export-buttons d-flex gap-2">
                                <button class="btn btn-success btn-sm" onclick="exportarConsolidadoExcel()" id="btnExportConsExcel" disabled>
                                    <i class="bi bi-file-earmark-excel me-1"></i>Excel
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="exportarConsolidadoPDF()" id="btnExportConsPDF" disabled>
                                    <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Resumen nivel 1 -->
                        <div class="row g-3 mb-4" id="consolidadoResumen" style="display:none;">
                            <div class="col-md-3">
                                <div class="summary-card bg-primary bg-opacity-10 border border-primary">
                                    <div class="summary-value text-primary" id="consTotal">$0</div>
                                    <div class="summary-label text-primary">Total Transporte</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="summary-card bg-info bg-opacity-10 border border-info">
                                    <div class="summary-value text-info" id="consRecorridos">0</div>
                                    <div class="summary-label text-info">Recorridos</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="summary-card bg-success bg-opacity-10 border border-success">
                                    <div class="summary-value text-success" id="consRealizados">0</div>
                                    <div class="summary-label text-success">Realizados</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="summary-card bg-warning bg-opacity-10 border border-warning">
                                    <div class="summary-value text-warning" id="consCancelados">0</div>
                                    <div class="summary-label text-warning">Cancelados</div>
                                </div>
                            </div>
                        </div>
                        <!-- Tabla nivel 2 -->
                        <div id="consolidadoTabla">
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-bar-chart" style="font-size:3rem;"></i>
                                <p class="mt-2">Seleccione mes y ano, luego presione Generar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== TAB 2: DETALLE TRANSPORTE ==================== -->
            <div class="tab-pane fade" id="panel-detalle">
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="row align-items-end g-3">
                            <div class="col-md-2">
                                <label class="form-label">Desde</label>
                                <input type="date" class="form-control" id="detalleDesde">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Hasta</label>
                                <input type="date" class="form-control" id="detalleHasta">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tipo</label>
                                <select class="form-select" id="detalleTipo">
                                    <option value="">Todos los tipos</option>
                                    <option value="pedagogical">Salidas pedagogicas</option>
                                    <option value="sports">Salidas deportivas</option>
                                    <option value="rep">Salidas de representación</option>
                                    <option value="extracurricular">Extracurriculares</option>
                                    <option value="staff">Transporte de personal</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="generarDetalle()">
                                    <i class="bi bi-search me-1"></i>Generar
                                </button>
                            </div>
                            <div class="col-md-3 export-buttons d-flex gap-2">
                                <button class="btn btn-success btn-sm" onclick="exportarDetalleExcel()" id="btnExportDetExcel" disabled>
                                    <i class="bi bi-file-earmark-excel me-1"></i>Excel
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="exportarDetallePDF()" id="btnExportDetPDF" disabled>
                                    <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="detalleTabla">
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-list-columns" style="font-size:3rem;"></i>
                                <p class="mt-2">Seleccione rango de fechas y presione Generar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== TAB 3: EVENTOS INTERNOS ==================== -->
            <div class="tab-pane fade" id="panel-eventos">
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="row align-items-end g-3">
                            <div class="col-md-2">
                                <label class="form-label">Desde</label>
                                <input type="date" class="form-control" id="eventosDesde">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Hasta</label>
                                <input type="date" class="form-control" id="eventosHasta">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Estado</label>
                                <select class="form-select" id="eventosEstado">
                                    <option value="">Todos</option>
                                    <option value="scheduled">Programados</option>
                                    <option value="completed">Realizados</option>
                                    <option value="suspended">Suspendidos</option>
                                    <option value="cancelled">Cancelados</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="generarEventos()">
                                    <i class="bi bi-search me-1"></i>Generar
                                </button>
                            </div>
                            <div class="col-md-3 export-buttons d-flex gap-2">
                                <button class="btn btn-success btn-sm" onclick="exportarEventosExcel()" id="btnExportEvtExcel" disabled>
                                    <i class="bi bi-file-earmark-excel me-1"></i>Excel
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="exportarEventosPDF()" id="btnExportEvtPDF" disabled>
                                    <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="eventosTabla">
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-calendar-event" style="font-size:3rem;"></i>
                                <p class="mt-2">Seleccione rango de fechas y presione Generar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== TAB 4: SOLICITUDES ==================== -->
            <div class="tab-pane fade" id="panel-solicitudes">
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="row align-items-end g-3">
                            <div class="col-md-2">
                                <label class="form-label">Desde</label>
                                <input type="date" class="form-control" id="solicitudesDesde">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Hasta</label>
                                <input type="date" class="form-control" id="solicitudesHasta">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Tipo</label>
                                <select class="form-select" id="solicitudesTipo">
                                    <option value="">Todos</option>
                                    <option value="pedagogical_trip">Pedagogicas</option>
                                    <option value="sports_trip">Deportivas</option>
                                    <option value="rep_trip">Representación</option>
                                    <option value="internal_event">Eventos</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Estado</label>
                                <select class="form-select" id="solicitudesEstado">
                                    <option value="">Todos</option>
                                    <option value="pending">Pendientes</option>
                                    <option value="approved">Aprobadas</option>
                                    <option value="rejected">Rechazadas</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <button class="btn btn-primary w-100" onclick="generarSolicitudes()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            <div class="col-md-3 export-buttons d-flex gap-2">
                                <button class="btn btn-success btn-sm" onclick="exportarSolicitudesExcel()" id="btnExportSolExcel" disabled>
                                    <i class="bi bi-file-earmark-excel me-1"></i>Excel
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="exportarSolicitudesPDF()" id="btnExportSolPDF" disabled>
                                    <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="solicitudesTabla">
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-clipboard-check" style="font-size:3rem;"></i>
                                <p class="mt-2">Seleccione filtros y presione Generar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ==================== VARIABLES GLOBALES ====================
        let currentUser = null;
        let datosConsolidado = null;
        let datosDetalle = [];
        let datosEventos = [];
        let datosSolicitudes = [];
        
        const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        
        // ==================== INICIALIZACION ====================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                if (typeof validatePageAccess !== 'function') return;
                const tieneAcceso = await validatePageAccess('Reportes de servicios');
                if (!tieneAcceso) return;
                
                if (typeof loadAndApplyBrandColors === 'function') await loadAndApplyBrandColors();
                
                const session = getStoredSession();
                if (session && session.user) currentUser = session.user;
                
                inicializarFiltros();
                console.log('Modulo de reportes cargado');
                
            } catch (error) {
                console.error('Error inicializando:', error);
            }
        });
        
        function inicializarFiltros() {
            const selMes = document.getElementById('consolidadoMes');
            MESES.forEach((m, i) => {
                selMes.innerHTML += `<option value="${i}" ${i === new Date().getMonth() ? 'selected' : ''}>${m}</option>`;
            });
            document.getElementById('consolidadoAno').value = new Date().getFullYear();
            
            const hoy = new Date().toISOString().split('T')[0];
            const primerDiaMes = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            
            document.getElementById('detalleDesde').value = primerDiaMes;
            document.getElementById('detalleHasta').value = hoy;
            document.getElementById('eventosDesde').value = primerDiaMes;
            document.getElementById('eventosHasta').value = hoy;
            document.getElementById('solicitudesDesde').value = primerDiaMes;
            document.getElementById('solicitudesHasta').value = hoy;
        }
        
        // ==================== TAB 1: CONSOLIDADO TRANSPORTE ====================
        async function generarConsolidado() {
            const mes = parseInt(document.getElementById('consolidadoMes').value);
            const ano = parseInt(document.getElementById('consolidadoAno').value);
            const desde = `${ano}-${String(mes+1).padStart(2,'0')}-01`;
            const ultimoDia = new Date(ano, mes+1, 0).getDate();
            const hasta = `${ano}-${String(mes+1).padStart(2,'0')}-${String(ultimoDia).padStart(2,'0')}`;
            
            document.getElementById('consolidadoTabla').innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
            
            try {
                // Pedagogicas (no canceladas)
                const pedagogicas = await supabaseRequest(`/svc_pedagogical_trips?select=trip_id,trip_date,total_transport_value,trip_status&trip_date=gte.${desde}&trip_date=lte.${hasta}&trip_status=neq.cancelled`);
                
                // Deportivas (no canceladas)
                const deportivas = await supabaseRequest(`/svc_sports_trips?select=trip_id,trip_date,total_transport_value,trip_status&trip_date=gte.${desde}&trip_date=lte.${hasta}&trip_status=neq.cancelled`);
onst depTotal = (deportivas||[]).reduce((s,t) => s + (parseFloat(t.total_transport_value)||0), 0);
                // Representación (no canceladas)
                const representacion = await supabaseRequest(`/svc_rep_trips?select=trip_id,trip_date,total_transport_value,trip_status&trip_date=gte.${desde}&trip_date=lte.${hasta}&trip_status=neq.cancelled`);
                
                // Extracurriculares
                const extracurriculares = await supabaseRequest(`/svc_extracurricular_daily_records?select=record_id,record_date,was_completed,frozen_rate_value&record_date=gte.${desde}&record_date=lte.${hasta}`);
                
                // Personal
                const personal = await supabaseRequest(`/svc_staff_transport_daily_records?select=record_id,record_date,was_completed,frozen_trip_value&record_date=gte.${desde}&record_date=lte.${hasta}`);
                
                // Calcular
                const pedTotal = (pedagogicas||[]).reduce((s,t) => s + (parseFloat(t.total_transport_value)||0), 0);
                const pedCount = (pedagogicas||[]).length;
                
                const depTotal = (deportivas||[]).reduce((s,t) => s + (parseFloat(t.total_transport_value)||0), 0);
                const depCount = (deportivas||[]).length;

                const repTotal = (representacion||[]).reduce((s,t) => s + (parseFloat(t.total_transport_value)||0), 0);
                const repCount = (representacion||[]).length;
                
                const extRealizados = (extracurriculares||[]).filter(r => r.was_completed);
                const extTotal = extRealizados.reduce((s,r) => s + (parseFloat(r.frozen_rate_value)||0), 0);
                const extCount = (extracurriculares||[]).length;
                const extCancelados = extCount - extRealizados.length;
                
                const perRealizados = (personal||[]).filter(r => r.was_completed);
                const perTotal = perRealizados.reduce((s,r) => s + (parseFloat(r.frozen_trip_value)||0), 0);
                const perCount = (personal||[]).length;
                const perCancelados = perCount - perRealizados.length;
                
               const granTotal = pedTotal + depTotal + repTotal + extTotal + perTotal;
                const totalRecorridos = pedCount + depCount + repCount + extCount + perCount;
                const totalRealizados = pedCount + depCount + repCount + extRealizados.length + perRealizados.length;
                const totalCancelados = extCancelados + perCancelados;
                
                datosConsolidado = {
                    mes: MESES[mes], ano,
                    filas: [
                        { tipo: 'Salidas Pedagogicas', recorridos: pedCount, realizados: pedCount, cancelados: 0, valor: pedTotal },
                        { tipo: 'Salidas Deportivas', recorridos: depCount, realizados: depCount, cancelados: 0, valor: depTotal },
                        { tipo: 'Salidas de Representación', recorridos: repCount, realizados: repCount, cancelados: 0, valor: repTotal },
                        { tipo: 'Extracurriculares', recorridos: extCount, realizados: extRealizados.length, cancelados: extCancelados, valor: extTotal },
                        { tipo: 'Transporte de Personal', recorridos: perCount, realizados: perRealizados.length, cancelados: perCancelados, valor: perTotal }
                    ],
                    totales: { recorridos: totalRecorridos, realizados: totalRealizados, cancelados: totalCancelados, valor: granTotal }
                };
                
                // Resumen
                document.getElementById('consolidadoResumen').style.display = 'flex';
                document.getElementById('consTotal').textContent = formatCurrency(granTotal);
                document.getElementById('consRecorridos').textContent = totalRecorridos;
                document.getElementById('consRealizados').textContent = totalRealizados;
                document.getElementById('consCancelados').textContent = totalCancelados;
                
                // Tabla
                document.getElementById('consolidadoTabla').innerHTML = `
                    <table class="table table-bordered table-report">
                        <thead>
                            <tr>
                                <th>Tipo de Transporte</th>
                                <th class="text-center">Recorridos</th>
                                <th class="text-center">Realizados</th>
                                <th class="text-center">Cancelados</th>
                                <th class="text-end">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${datosConsolidado.filas.map(f => `
                                <tr>
                                    <td>${f.tipo}</td>
                                    <td class="text-center">${f.recorridos}</td>
                                    <td class="text-center">${f.realizados}</td>
                                    <td class="text-center">${f.cancelados}</td>
                                    <td class="text-end">${formatCurrency(f.valor)}</td>
                                </tr>
                            `).join('')}
                            <tr class="row-total">
                                <td>TOTAL</td>
                                <td class="text-center">${datosConsolidado.totales.recorridos}</td>
                                <td class="text-center">${datosConsolidado.totales.realizados}</td>
                                <td class="text-center">${datosConsolidado.totales.cancelados}</td>
                                <td class="text-end">${formatCurrency(datosConsolidado.totales.valor)}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
                
                document.getElementById('btnExportConsExcel').disabled = false;
                document.getElementById('btnExportConsPDF').disabled = false;
                
            } catch (error) {
                console.error('Error generando consolidado:', error);
                document.getElementById('consolidadoTabla').innerHTML = '<div class="alert alert-danger">Error al generar el reporte</div>';
            }
        }
        
        // ==================== TAB 2: DETALLE TRANSPORTE ====================
        async function generarDetalle() {
            const desde = document.getElementById('detalleDesde').value;
            const hasta = document.getElementById('detalleHasta').value;
            const tipo = document.getElementById('detalleTipo').value;
            
            if (!desde || !hasta) { alert('Seleccione rango de fechas'); return; }
            
            document.getElementById('detalleTabla').innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
            
            try {
                datosDetalle = [];
                
                // Pedagogicas
                if (!tipo || tipo === 'pedagogical') {
                    const ped = await supabaseRequest(`/svc_pedagogical_trips?select=trip_id,trip_date,total_transport_value,trip_status,planned_students,num_adults,frozen_vehicle_capacity,frozen_vehicle_count,transport_modality,destination:svc_transport_destinations(destination_name)&trip_date=gte.${desde}&trip_date=lte.${hasta}&trip_status=neq.cancelled&order=trip_date.asc`);
                    (ped||[]).forEach(t => {
                        datosDetalle.push({
                            fecha: t.trip_date,
                            tipo: 'Salida Pedagogica',
                            detalle: t.destination?.destination_name || 'N/A',
                            modalidad: t.transport_modality === 'round_trip' ? 'Ida y vuelta' : t.transport_modality === 'outbound' ? 'Ida' : 'Regreso',
                            vehiculos: t.frozen_vehicle_count || 1,
                            capacidad: t.frozen_vehicle_capacity || 0,
                            pasajeros: (t.planned_students||0) + (t.num_adults||0),
                            valor: parseFloat(t.total_transport_value) || 0,
                            estado: t.trip_status
                        });
                    });
                }
                
                // Deportivas
                if (!tipo || tipo === 'sports') {
                    const dep = await supabaseRequest(`/svc_sports_trips?select=trip_id,trip_date,total_transport_value,trip_status,planned_students,num_adults,frozen_vehicle_capacity,frozen_vehicle_count,transport_modality,specific_destination,destination:svc_transport_destinations(destination_name)&trip_date=gte.${desde}&trip_date=lte.${hasta}&trip_status=neq.cancelled&order=trip_date.asc`);
                    (dep||[]).forEach(t => {
                        datosDetalle.push({
                            fecha: t.trip_date,
                            tipo: 'Salida Deportiva',
                            detalle: t.specific_destination || t.destination?.destination_name || 'N/A',
                            modalidad: t.transport_modality === 'round_trip' ? 'Ida y vuelta' : t.transport_modality === 'outbound' ? 'Ida' : 'Regreso',
                            vehiculos: t.frozen_vehicle_count || 1,
                            capacidad: t.frozen_vehicle_capacity || 0,
                            pasajeros: (t.planned_students||0) + (t.num_adults||0),
                            valor: parseFloat(t.total_transport_value) || 0,
                            estado: t.trip_status
                        });
                    });
                }

                // Representación
                if (!tipo || tipo === 'rep') {
                    const rep = await supabaseRequest(`/svc_rep_trips?select=trip_id,trip_date,total_transport_value,trip_status,planned_students,num_adults,frozen_vehicle_capacity,frozen_vehicle_count,transport_modality,specific_destination,destination:svc_transport_destinations(destination_name)&trip_date=gte.${desde}&trip_date=lte.${hasta}&trip_status=neq.cancelled&order=trip_date.asc`);
                    (rep||[]).forEach(t => {
                        datosDetalle.push({
                            fecha: t.trip_date,
                            tipo: 'Salida Representación',
                            detalle: t.specific_destination || t.destination?.destination_name || 'N/A',
                            modalidad: t.transport_modality === 'round_trip' ? 'Ida y vuelta' : t.transport_modality === 'outbound' ? 'Ida' : 'Regreso',
                            vehiculos: t.frozen_vehicle_count || 1,
                            capacidad: t.frozen_vehicle_capacity || 0,
                            pasajeros: (t.planned_students||0) + (t.num_adults||0),
                            valor: parseFloat(t.total_transport_value) || 0,
                            estado: t.trip_status
                        });
                    });
                }
                
                // Extracurriculares
                if (!tipo || tipo === 'extracurricular') {
                    const ext = await supabaseRequest(`/svc_extracurricular_daily_records?select=record_id,record_date,was_completed,passenger_count,frozen_rate_value,cancellation_reason,config:svc_extracurricular_vehicle_configs(vehicle_capacity,vehicle_count)&record_date=gte.${desde}&record_date=lte.${hasta}&order=record_date.asc`);
                    (ext||[]).forEach(r => {
                        const config = Array.isArray(r.config) ? r.config[0] : r.config;
                        datosDetalle.push({
                            fecha: r.record_date,
                            tipo: 'Extracurricular',
                            detalle: r.was_completed ? 'Realizado' : `Cancelado: ${r.cancellation_reason || 'Sin motivo'}`,
                            modalidad: '-',
                            vehiculos: config?.vehicle_count || 1,
                            capacidad: config?.vehicle_capacity || 0,
                            pasajeros: r.passenger_count || 0,
                            valor: r.was_completed ? (parseFloat(r.frozen_rate_value)||0) : 0,
                            estado: r.was_completed ? 'completed' : 'cancelled'
                        });
                    });
                }
                
                // Personal
                if (!tipo || tipo === 'staff') {
                    const per = await supabaseRequest(`/svc_staff_transport_daily_records?select=record_id,record_date,was_completed,frozen_trip_value,ruta:svc_staff_transport_routes(route_name,vehicle_capacity)&record_date=gte.${desde}&record_date=lte.${hasta}&order=record_date.asc`);
                    (per||[]).forEach(r => {
                        const ruta = Array.isArray(r.ruta) ? r.ruta[0] : r.ruta;
                        datosDetalle.push({
                            fecha: r.record_date,
                            tipo: 'Transporte Personal',
                            detalle: ruta?.route_name || 'N/A',
                            modalidad: '-',
                            vehiculos: 1,
                            capacidad: ruta?.vehicle_capacity || 0,
                            pasajeros: '-',
                            valor: r.was_completed ? (parseFloat(r.frozen_trip_value)||0) : 0,
                            estado: r.was_completed ? 'completed' : 'cancelled'
                        });
                    });
                }
                
                // Ordenar por fecha
                datosDetalle.sort((a,b) => a.fecha.localeCompare(b.fecha));
                
                const totalValor = datosDetalle.reduce((s,d) => s + d.valor, 0);
                
                if (datosDetalle.length === 0) {
                    document.getElementById('detalleTabla').innerHTML = '<div class="alert alert-info">No se encontraron recorridos en el rango seleccionado</div>';
                    return;
                }
                
                document.getElementById('detalleTabla').innerHTML = `
                    <p class="text-muted mb-2">${datosDetalle.length} recorridos encontrados</p>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm table-report">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Detalle</th>
                                    <th>Modalidad</th>
                                    <th class="text-center">Veh.</th>
                                    <th class="text-center">Cap.</th>
                                    <th class="text-center">Pax</th>
                                    <th class="text-end">Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${datosDetalle.map(d => `
                                    <tr${d.estado==='cancelled'?' class="table-warning"':''}>
                                        <td>${formatDateShort(d.fecha)}</td>
                                        <td><small>${d.tipo}</small></td>
                                        <td>${d.detalle}</td>
                                        <td><small>${d.modalidad}</small></td>
                                        <td class="text-center">${d.vehiculos}</td>
                                        <td class="text-center">${d.capacidad}</td>
                                        <td class="text-center">${d.pasajeros}</td>
                                        <td class="text-end">${formatCurrency(d.valor)}</td>
                                    </tr>
                                `).join('')}
                                <tr class="row-total">
                                    <td colspan="7">TOTAL</td>
                                    <td class="text-end">${formatCurrency(totalValor)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('btnExportDetExcel').disabled = false;
                document.getElementById('btnExportDetPDF').disabled = false;
                
            } catch (error) {
                console.error('Error generando detalle:', error);
                document.getElementById('detalleTabla').innerHTML = '<div class="alert alert-danger">Error al generar el reporte</div>';
            }
        }
        
        // ==================== TAB 3: EVENTOS INTERNOS ====================
        async function generarEventos() {
            const desde = document.getElementById('eventosDesde').value;
            const hasta = document.getElementById('eventosHasta').value;
            const estado = document.getElementById('eventosEstado').value;
            
            if (!desde || !hasta) { alert('Seleccione rango de fechas'); return; }
            
            document.getElementById('eventosTabla').innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
            
            try {
                let query = `/svc_internal_events?select=*,catering:svc_internal_event_catering(total_value),servicios:svc_internal_event_services(service_type,cost_value)&event_date=gte.${desde}&event_date=lte.${hasta}&order=event_date.asc`;
                if (estado) query += `&event_status=eq.${estado}`;
                
                const eventos = await supabaseRequest(query);
                
                datosEventos = (eventos||[]).map(e => {
                    const costoCatering = (e.catering||[]).reduce((s,c) => s + (parseFloat(c.total_value)||0), 0);
                    const costoServicios = (e.servicios||[]).reduce((s,sv) => s + (parseFloat(sv.cost_value)||0), 0);
                    const serviciosPendientes = (e.servicios||[]).filter(sv => sv.cost_value === null || sv.cost_value === undefined).length;
                    
                    return {
                        fecha: e.event_date,
                        nombre: e.event_name,
                        ubicacion: e.event_location || 'N/A',
                        estudiantes: e.num_students || 0,
                        adultos: e.num_adults || 0,
                        estado: e.event_status,
                        costoCatering,
                        costoServicios,
                        costoTotal: costoCatering + costoServicios,
                        serviciosPendientes
                    };
                });
                
                if (datosEventos.length === 0) {
                    document.getElementById('eventosTabla').innerHTML = '<div class="alert alert-info">No se encontraron eventos en el rango seleccionado</div>';
                    return;
                }
                
                const totalCatering = datosEventos.reduce((s,e) => s + e.costoCatering, 0);
                const totalServicios = datosEventos.reduce((s,e) => s + e.costoServicios, 0);
                const granTotal = totalCatering + totalServicios;
                
                document.getElementById('eventosTabla').innerHTML = `
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="summary-card bg-info bg-opacity-10 border border-info">
                                <div class="summary-value text-info">${datosEventos.length}</div>
                                <div class="summary-label text-info">Eventos</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="summary-card bg-success bg-opacity-10 border border-success">
                                <div class="summary-value text-success" style="font-size:1.4rem;">${formatCurrency(totalCatering)}</div>
                                <div class="summary-label text-success">Refrigerios</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="summary-card bg-primary bg-opacity-10 border border-primary">
                                <div class="summary-value text-primary" style="font-size:1.4rem;">${formatCurrency(granTotal)}</div>
                                <div class="summary-label text-primary">Costo Total</div>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm table-report">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Evento</th>
                                    <th>Ubicacion</th>
                                    <th class="text-center">Participantes</th>
                                    <th>Estado</th>
                                    <th class="text-end">Refrigerios</th>
                                    <th class="text-end">Servicios</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${datosEventos.map(e => `
                                    <tr>
                                        <td>${formatDateShort(e.fecha)}</td>
                                        <td>${e.nombre}</td>
                                        <td><small>${e.ubicacion}</small></td>
                                        <td class="text-center">${e.estudiantes + e.adultos}</td>
                                        <td>${getBadgeEstado(e.estado)}</td>
                                        <td class="text-end">${formatCurrency(e.costoCatering)}</td>
                                        <td class="text-end">${e.serviciosPendientes > 0 ? '<small class="text-warning">Pendientes</small>' : formatCurrency(e.costoServicios)}</td>
                                        <td class="text-end">${formatCurrency(e.costoTotal)}</td>
                                    </tr>
                                `).join('')}
                                <tr class="row-total">
                                    <td colspan="5">TOTAL</td>
                                    <td class="text-end">${formatCurrency(totalCatering)}</td>
                                    <td class="text-end">${formatCurrency(totalServicios)}</td>
                                    <td class="text-end">${formatCurrency(granTotal)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('btnExportEvtExcel').disabled = false;
                document.getElementById('btnExportEvtPDF').disabled = false;
                
            } catch (error) {
                console.error('Error generando eventos:', error);
                document.getElementById('eventosTabla').innerHTML = '<div class="alert alert-danger">Error al generar el reporte</div>';
            }
        }
        
        // ==================== TAB 4: SOLICITUDES ====================
        async function generarSolicitudes() {
            const desde = document.getElementById('solicitudesDesde').value;
            const hasta = document.getElementById('solicitudesHasta').value;
            const tipo = document.getElementById('solicitudesTipo').value;
            const estado = document.getElementById('solicitudesEstado').value;
            
            if (!desde || !hasta) { alert('Seleccione rango de fechas'); return; }
            
            document.getElementById('solicitudesTabla').innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
            
            try {
                let query = `/svc_service_requests?select=*,solicitante:workers!svc_service_requests_requested_by_fkey(worker_first_name,worker_last_name_1),aprobador:workers!svc_service_requests_approver_fkey(worker_first_name,worker_last_name_1)&requested_at=gte.${desde}T00:00:00&requested_at=lte.${hasta}T23:59:59&order=requested_at.desc`;
                if (tipo) query += `&service_type=eq.${tipo}`;
                if (estado) query += `&request_status=eq.${estado}`;
                
                const solicitudes = await supabaseRequest(query);
                
                const TIPO_LABELS = {
                    'pedagogical_trip': 'Salida Pedagogica',
                    'sports_trip': 'Salida Deportiva',
                    'rep_trip': 'Salida de Representación',
                    'internal_event': 'Evento Interno'
                };
                
                const ESTADO_LABELS = {
                    'pending': 'Pendiente',
                    'approved': 'Aprobada',
                    'rejected': 'Rechazada'
                };
                
                datosSolicitudes = (solicitudes||[]).map(s => ({
                    fecha: s.requested_at,
                    tipo: TIPO_LABELS[s.service_type] || s.service_type,
                    tipoRaw: s.service_type,
                    solicitante: s.solicitante ? `${s.solicitante.worker_first_name} ${s.solicitante.worker_last_name_1}` : 'N/A',
                    aprobador: s.aprobador ? `${s.aprobador.worker_first_name} ${s.aprobador.worker_last_name_1}` : 'N/A',
                    estado: s.request_status,
                    estadoLabel: ESTADO_LABELS[s.request_status] || s.request_status,
                    resuelta: s.resolved_at ? formatDateTimeFull(s.resolved_at) : '-',
                    motivo: s.rejection_reason || '-'
                }));
                
                if (datosSolicitudes.length === 0) {
                    document.getElementById('solicitudesTabla').innerHTML = '<div class="alert alert-info">No se encontraron solicitudes en el rango seleccionado</div>';
                    return;
                }
                
                const pendientes = datosSolicitudes.filter(s => s.estado === 'pending').length;
                const aprobadas = datosSolicitudes.filter(s => s.estado === 'approved').length;
                const rechazadas = datosSolicitudes.filter(s => s.estado === 'rejected').length;
                
                document.getElementById('solicitudesTabla').innerHTML = `
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="summary-card bg-secondary bg-opacity-10 border">
                                <div class="summary-value">${datosSolicitudes.length}</div>
                                <div class="summary-label">Total</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card bg-warning bg-opacity-10 border border-warning">
                                <div class="summary-value text-warning">${pendientes}</div>
                                <div class="summary-label text-warning">Pendientes</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card bg-success bg-opacity-10 border border-success">
                                <div class="summary-value text-success">${aprobadas}</div>
                                <div class="summary-label text-success">Aprobadas</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-card bg-danger bg-opacity-10 border border-danger">
                                <div class="summary-value text-danger">${rechazadas}</div>
                                <div class="summary-label text-danger">Rechazadas</div>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm table-report">
                            <thead>
                                <tr>
                                    <th>Fecha Solicitud</th>
                                    <th>Tipo</th>
                                    <th>Solicitante</th>
                                    <th>Aprobador</th>
                                    <th>Estado</th>
                                    <th>Fecha Resolucion</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${datosSolicitudes.map(s => `
                                    <tr>
                                        <td>${formatDateTimeFull(s.fecha)}</td>
                                        <td><small>${s.tipo}</small></td>
                                        <td>${s.solicitante}</td>
                                        <td>${s.aprobador}</td>
                                        <td>${getBadgeEstadoSolicitud(s.estado)}</td>
                                        <td><small>${s.resuelta}</small></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('btnExportSolExcel').disabled = false;
                document.getElementById('btnExportSolPDF').disabled = false;
                
            } catch (error) {
                console.error('Error generando solicitudes:', error);
                document.getElementById('solicitudesTabla').innerHTML = '<div class="alert alert-danger">Error al generar el reporte</div>';
            }
        }
        
        // ==================== EXPORTAR EXCEL ====================
        function exportarConsolidadoExcel() {
            if (!datosConsolidado) return;
            const ws_data = [
                [`Consolidado de Transporte - ${datosConsolidado.mes} ${datosConsolidado.ano}`],
                [],
                ['Tipo de Transporte', 'Recorridos', 'Realizados', 'Cancelados', 'Valor'],
                ...datosConsolidado.filas.map(f => [f.tipo, f.recorridos, f.realizados, f.cancelados, f.valor]),
                ['TOTAL', datosConsolidado.totales.recorridos, datosConsolidado.totales.realizados, datosConsolidado.totales.cancelados, datosConsolidado.totales.valor]
            ];
            exportToExcel(ws_data, `Consolidado_Transporte_${datosConsolidado.mes}_${datosConsolidado.ano}`);
        }
        
        function exportarDetalleExcel() {
            if (!datosDetalle.length) return;
            const ws_data = [
                ['Detalle de Transporte'],
                [],
                ['Fecha', 'Tipo', 'Detalle', 'Modalidad', 'Vehiculos', 'Capacidad', 'Pasajeros', 'Valor'],
                ...datosDetalle.map(d => [d.fecha, d.tipo, d.detalle, d.modalidad, d.vehiculos, d.capacidad, d.pasajeros, d.valor]),
                ['TOTAL', '', '', '', '', '', '', datosDetalle.reduce((s,d) => s+d.valor, 0)]
            ];
            exportToExcel(ws_data, 'Detalle_Transporte');
        }
        
        function exportarEventosExcel() {
            if (!datosEventos.length) return;
            const ESTADOS = { 'scheduled':'Programado', 'completed':'Realizado', 'suspended':'Suspendido', 'cancelled':'Cancelado' };
            const ws_data = [
                ['Reporte de Eventos Internos'],
                [],
                ['Fecha', 'Evento', 'Ubicacion', 'Estudiantes', 'Adultos', 'Estado', 'Refrigerios', 'Servicios', 'Total'],
                ...datosEventos.map(e => [e.fecha, e.nombre, e.ubicacion, e.estudiantes, e.adultos, ESTADOS[e.estado]||e.estado, e.costoCatering, e.costoServicios, e.costoTotal]),
                ['TOTAL', '', '', '', '', '', datosEventos.reduce((s,e)=>s+e.costoCatering,0), datosEventos.reduce((s,e)=>s+e.costoServicios,0), datosEventos.reduce((s,e)=>s+e.costoTotal,0)]
            ];
            exportToExcel(ws_data, 'Eventos_Internos');
        }
        
        function exportarSolicitudesExcel() {
            if (!datosSolicitudes.length) return;
            const ws_data = [
                ['Reporte de Solicitudes'],
                [],
                ['Fecha Solicitud', 'Tipo', 'Solicitante', 'Aprobador', 'Estado', 'Fecha Resolucion', 'Motivo Rechazo'],
                ...datosSolicitudes.map(s => [formatDateTimeFull(s.fecha), s.tipo, s.solicitante, s.aprobador, s.estadoLabel, s.resuelta, s.motivo])
            ];
            exportToExcel(ws_data, 'Solicitudes');
        }
        
        function exportToExcel(data, filename) {
            try {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // Ajustar anchos de columna
                const maxWidths = data.reduce((widths, row) => {
                    row.forEach((cell, i) => {
                        const len = String(cell || '').length;
                        widths[i] = Math.max(widths[i] || 0, len);
                    });
                    return widths;
                }, {});
                ws['!cols'] = Object.values(maxWidths).map(w => ({ wch: Math.min(w + 2, 40) }));
                
                XLSX.utils.book_append_sheet(wb, ws, 'Reporte');
                XLSX.writeFile(wb, `${filename}.xlsx`);
            } catch (error) {
                console.error('Error exportando Excel:', error);
                alert('Error al exportar a Excel. Verifique que la libreria XLSX este cargada.');
            }
        }
        
        // ==================== EXPORTAR PDF ====================
        function exportarConsolidadoPDF() {
            if (!datosConsolidado) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text(`Consolidado de Transporte`, 14, 20);
            doc.setFontSize(12);
            doc.text(`${datosConsolidado.mes} ${datosConsolidado.ano}`, 14, 28);
            
            doc.autoTable({
                startY: 35,
                head: [['Tipo de Transporte', 'Recorridos', 'Realizados', 'Cancelados', 'Valor']],
                body: [
                    ...datosConsolidado.filas.map(f => [f.tipo, f.recorridos, f.realizados, f.cancelados, formatCurrency(f.valor)]),
                    [{ content: 'TOTAL', styles: { fontStyle: 'bold' } }, 
                     { content: datosConsolidado.totales.recorridos, styles: { fontStyle: 'bold' } },
                     { content: datosConsolidado.totales.realizados, styles: { fontStyle: 'bold' } },
                     { content: datosConsolidado.totales.cancelados, styles: { fontStyle: 'bold' } },
                     { content: formatCurrency(datosConsolidado.totales.valor), styles: { fontStyle: 'bold' } }]
                ],
                styles: { fontSize: 9 },
                headStyles: { fillColor: [27, 54, 93] }
            });
            
            doc.setFontSize(8);
            doc.text(`Generado: ${new Date().toLocaleString('es-CO')} - SchoolNet`, 14, doc.internal.pageSize.height - 10);
            doc.save(`Consolidado_Transporte_${datosConsolidado.mes}_${datosConsolidado.ano}.pdf`);
        }
        
        function exportarDetallePDF() {
            if (!datosDetalle.length) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            doc.setFontSize(16);
            doc.text('Detalle de Transporte', 14, 20);
            
            doc.autoTable({
                startY: 28,
                head: [['Fecha', 'Tipo', 'Detalle', 'Modalidad', 'Veh.', 'Cap.', 'Pax', 'Valor']],
                body: datosDetalle.map(d => [formatDateShort(d.fecha), d.tipo, d.detalle, d.modalidad, d.vehiculos, d.capacidad, d.pasajeros, formatCurrency(d.valor)]),
                foot: [['TOTAL', '', '', '', '', '', '', formatCurrency(datosDetalle.reduce((s,d)=>s+d.valor,0))]],
                styles: { fontSize: 8 },
                headStyles: { fillColor: [27, 54, 93] },
                footStyles: { fillColor: [233, 236, 239], textColor: [0,0,0], fontStyle: 'bold' }
            });
            
            doc.setFontSize(8);
            doc.text(`Generado: ${new Date().toLocaleString('es-CO')} - SchoolNet`, 14, doc.internal.pageSize.height - 10);
            doc.save('Detalle_Transporte.pdf');
        }
        
        function exportarEventosPDF() {
            if (!datosEventos.length) return;
            const ESTADOS = { 'scheduled':'Programado', 'completed':'Realizado', 'suspended':'Suspendido', 'cancelled':'Cancelado' };
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            doc.setFontSize(16);
            doc.text('Reporte de Eventos Internos', 14, 20);
            
            doc.autoTable({
                startY: 28,
                head: [['Fecha', 'Evento', 'Ubicacion', 'Participantes', 'Estado', 'Refrigerios', 'Servicios', 'Total']],
                body: datosEventos.map(e => [formatDateShort(e.fecha), e.nombre, e.ubicacion, e.estudiantes+e.adultos, ESTADOS[e.estado]||e.estado, formatCurrency(e.costoCatering), formatCurrency(e.costoServicios), formatCurrency(e.costoTotal)]),
                foot: [['TOTAL', '', '', '', '', formatCurrency(datosEventos.reduce((s,e)=>s+e.costoCatering,0)), formatCurrency(datosEventos.reduce((s,e)=>s+e.costoServicios,0)), formatCurrency(datosEventos.reduce((s,e)=>s+e.costoTotal,0))]],
                styles: { fontSize: 8 },
                headStyles: { fillColor: [27, 54, 93] },
                footStyles: { fillColor: [233, 236, 239], textColor: [0,0,0], fontStyle: 'bold' }
            });
            
            doc.setFontSize(8);
            doc.text(`Generado: ${new Date().toLocaleString('es-CO')} - SchoolNet`, 14, doc.internal.pageSize.height - 10);
            doc.save('Eventos_Internos.pdf');
        }
        
        function exportarSolicitudesPDF() {
            if (!datosSolicitudes.length) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            doc.setFontSize(16);
            doc.text('Reporte de Solicitudes', 14, 20);
            
            doc.autoTable({
                startY: 28,
                head: [['Fecha', 'Tipo', 'Solicitante', 'Aprobador', 'Estado', 'Resolucion']],
                body: datosSolicitudes.map(s => [formatDateTimeFull(s.fecha), s.tipo, s.solicitante, s.aprobador, s.estadoLabel, s.resuelta]),
                styles: { fontSize: 8 },
                headStyles: { fillColor: [27, 54, 93] }
            });
            
            doc.setFontSize(8);
            doc.text(`Generado: ${new Date().toLocaleString('es-CO')} - SchoolNet`, 14, doc.internal.pageSize.height - 10);
            doc.save('Solicitudes.pdf');
        }
        
        // ==================== FUNCIONES AUXILIARES ====================
        function formatCurrency(value) {
            if (!value && value !== 0) return '$0';
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value);
        }
        
        function formatDateShort(dateString) {
            if (!dateString) return 'N/A';
            const d = new Date(dateString + 'T00:00:00');
            return d.toLocaleDateString('es-CO', { day: '2-digit', month: 'short', year: 'numeric' });
        }
        
        function formatDateTimeFull(dateString) {
            if (!dateString) return 'N/A';
            const d = new Date(dateString);
            return d.toLocaleDateString('es-CO', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        function getBadgeEstado(estado) {
            const map = {
                'scheduled': '<span class="badge bg-primary">Programado</span>',
                'completed': '<span class="badge bg-success">Realizado</span>',
                'suspended': '<span class="badge bg-warning">Suspendido</span>',
                'cancelled': '<span class="badge bg-danger">Cancelado</span>'
            };
            return map[estado] || `<span class="badge bg-secondary">${estado}</span>`;
        }
        
        function getBadgeEstadoSolicitud(estado) {
            const map = {
                'pending': '<span class="badge bg-warning">Pendiente</span>',
                'approved': '<span class="badge bg-success">Aprobada</span>',
                'rejected': '<span class="badge bg-danger">Rechazada</span>'
            };
            return map[estado] || `<span class="badge bg-secondary">${estado}</span>`;
        }
    </script>
</body>
</html>
