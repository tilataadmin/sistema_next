<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.26.08.05">
    <title>Aprobaciones de Servicios - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Configuraci√≥n global -->
    <script src="/assets/js/config.js"></script>
    
    <style>
        :root {
            --service-primary: #1B365D;
            --service-accent: #667eea;
        }
        
        .request-card {
            border-left: 4px solid #ffc107;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .request-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .request-card.approved {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        
        .request-card.rejected {
            border-left-color: #dc3545;
            background-color: #fff8f8;
        }
        
        .request-card.pending {
            border-left-color: #ffc107;
            background-color: #fffbf0;
        }
        
        .stats-card {
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.2s;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .stats-label {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.5rem;
        }
        
        .cost-breakdown {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .cost-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--service-primary);
        }
    </style>
</head>
<body>
  <!-- Contenedor principal -->
    <div class="container-fluid py-4">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html">Inicio</a></li>
                <li class="breadcrumb-item"><a href="index.html">Servicios</a></li>
                <li class="breadcrumb-item active" aria-current="page">Aprobaciones</li>
            </ol>
        </nav>
        
        <!-- Header -->
        <div class="mb-4">
            <h3 class="mb-1">
                <i class="bi bi-clipboard-check me-2"></i>Aprobaciones de Servicios
            </h3>
            <p class="text-muted mb-0">Bandeja de solicitudes asignadas a m√≠</p>
        </div>
        
        <!-- Estad√≠sticas -->
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="stats-card bg-warning bg-opacity-10 border border-warning">
                    <div class="stats-number text-warning" id="statsPendientes">0</div>
                    <div class="stats-label text-warning">Pendientes</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card bg-success bg-opacity-10 border border-success">
                    <div class="stats-number text-success" id="statsAprobadas">0</div>
                    <div class="stats-label text-success">Aprobadas</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card bg-danger bg-opacity-10 border border-danger">
                    <div class="stats-number text-danger" id="statsRechazadas">0</div>
                    <div class="stats-label text-danger">Rechazadas</div>
                </div>
            </div>
        </div>
      <!-- Panel de Filtros -->
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center cursor-pointer" 
                 data-bs-toggle="collapse" data-bs-target="#filtrosCollapse">
                <span><i class="bi bi-funnel me-2"></i>Filtros de b√∫squeda</span>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="collapse show" id="filtrosCollapse">
                <div class="card-body">
                    <form id="formFiltros">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Tipo de servicio</label>
                                <select class="form-select" id="filtroTipo">
                                    <option value="">Todos los tipos</option>
                                    <option value="pedagogical_trip">Salidas pedag√≥gicas</option>
                                    <option value="sports_trip">Salidas deportivas</option>
                                    <option value="internal_event">Eventos internos</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Estado</label>
                                <select class="form-select" id="filtroEstado">
                                    <option value="pending">Solo pendientes</option>
                                    <option value="">Todos los estados</option>
                                    <option value="approved">Solo aprobadas</option>
                                    <option value="rejected">Solo rechazadas</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Fecha (desde)</label>
                                <input type="date" class="form-control" id="filtroFechaDesde">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Fecha (hasta)</label>
                                <input type="date" class="form-control" id="filtroFechaHasta">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Solicitante</label>
                                <select class="form-select" id="filtroSolicitante">
                                    <option value="">Todos los solicitantes</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="button" class="btn btn-primary me-2" onclick="aplicarFiltros()">
                                    <i class="bi bi-search me-2"></i>Filtrar
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                                    <i class="bi bi-x-circle me-2"></i>Limpiar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Contador de resultados -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <span class="badge bg-secondary" id="contadorResultados">
                    <i class="bi bi-list-ul me-1"></i>0 solicitudes encontradas
                </span>
            </div>
        </div>
      <!-- Lista de Solicitudes -->
        <div id="listaSolicitudes">
            <!-- Se carga din√°micamente -->
        </div>
        
        <!-- Mensaje cuando no hay solicitudes -->
        <div id="mensajeVacio" style="display: none;">
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
                <h5 class="text-muted mt-3">No hay solicitudes para mostrar</h5>
                <p class="text-muted">Cambia los filtros para ver otras solicitudes</p>
            </div>
        </div>
        
    </div>
    
    <!-- ==================== MODAL: VER DETALLE ==================== -->
    <div class="modal fade" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-eye me-2"></i>Detalle de Solicitud
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="detalleContent">
                        <!-- Se carga din√°micamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== MODAL: RECHAZAR ==================== -->
    <div class="modal fade" id="modalRechazar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-x-circle me-2"></i>Rechazar Solicitud
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formRechazar">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Esta acci√≥n es irreversible.</strong> El solicitante ser√° notificado.
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Motivo del rechazo <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="motivoRechazo" rows="4" required
                                      placeholder="Explique claramente la raz√≥n del rechazo..."></textarea>
                        </div>
                        <input type="hidden" id="rechazarRequestId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarRechazo()">
                        <i class="bi bi-x-circle me-2"></i>Rechazar Solicitud
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
      // ==================== VARIABLES GLOBALES ====================
        let currentUser = null;
        let solicitudesData = [];
        let daysBeforeImminent = 2; // D√≠as antes del evento para habilitar aprobaci√≥n (se carga desde svc_module_config)
        let filtrosActivos = {
            tipo: '',
            estado: 'pending'
        };
        
        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando m√≥dulo de Aprobaciones...');
            
            try {
                // Verificar que config.js se haya cargado
                if (typeof validatePageAccess !== 'function') {
                    console.error('‚ùå Error: config.js no se carg√≥ correctamente');
                    alert('Error al cargar el m√≥dulo. Verifique que config.js est√© en la ruta correcta.');
                    return;
                }
                
                // Validar acceso
                const tieneAcceso = await validatePageAccess('Aprobaciones de servicios');
                if (!tieneAcceso) return;
                
                // Cargar colores corporativos
                if (typeof loadAndApplyBrandColors === 'function') {
                    await loadAndApplyBrandColors();
                }
                
                // Obtener usuario actual
                if (typeof getStoredSession === 'function') {
                    const session = getStoredSession();
                    if (session && session.user) {
                        currentUser = session.user;
                        console.log('üë§ Usuario actual:', currentUser.user_display_name || currentUser.user_name);
                        
                        // OBTENER WORKER_ID DEL USUARIO (relaci√≥n por email)
                        const userEmail = currentUser.user_mail || currentUser.email;
                        const workerData = await supabaseRequest(`/workers?select=worker_id&email=eq.${userEmail}&limit=1`);
                        if (!workerData || workerData.length === 0) {
                            throw new Error('Este usuario no est√° vinculado a un trabajador en la tabla workers');
                        }
                        currentUser.worker_id = workerData[0].worker_id;
                        console.log('üë∑ Worker ID:', currentUser.worker_id);
                        
                    } else {
                        throw new Error('No se pudo obtener la sesi√≥n del usuario');
                    }
                } else {
                    throw new Error('getStoredSession no est√° disponible');
                }
                
                // Cargar configuraci√≥n del m√≥dulo
                await loadModuleConfig();
                
                // Cargar solicitudes
                await cargarSolicitudes();
                
                console.log('‚úÖ M√≥dulo cargado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando m√≥dulo:', error);
                showMessage('Error al cargar el m√≥dulo: ' + error.message, 'danger');
            }
        });

        // ==================== CARGAR CONFIGURACI√ìN DEL M√ìDULO ====================
        async function loadModuleConfig() {
            try {
                const configs = await supabaseRequest('/svc_module_config?select=config_key,config_value&config_key=eq.days_before_imminent');
                if (configs && configs.length > 0) {
                    daysBeforeImminent = parseInt(configs[0].config_value) || 2;
                }
                console.log(`‚úÖ D√≠as de inminencia para aprobar: ${daysBeforeImminent}`);
            } catch (error) {
                console.error('Error cargando configuraci√≥n del m√≥dulo:', error);
                console.warn('‚ö†Ô∏è Usando valor por defecto:', daysBeforeImminent);
            }
        }

        
      // ==================== CARGAR SOLICITUDES ====================
        async function cargarSolicitudes() {
            try {
                showLoading('listaSolicitudes');
                
                let todasLasSolicitudes = [];
                
                // Determinar qu√© tipos cargar seg√∫n filtro
                const tiposACargar = [];
                if (!filtrosActivos.tipo || filtrosActivos.tipo === 'pedagogical_trip') {
                    tiposACargar.push('pedagogical_trip');
                }
                if (!filtrosActivos.tipo || filtrosActivos.tipo === 'sports_trip') {
                    tiposACargar.push('sports_trip');
                }
                if (!filtrosActivos.tipo || filtrosActivos.tipo === 'internal_event') {
                    tiposACargar.push('internal_event');
                }
                
                // Cargar salidas pedag√≥gicas
                if (tiposACargar.includes('pedagogical_trip')) {
                    let queryTrips = `/svc_service_requests?select=*,trip:svc_pedagogical_trips!request_id(*,grades:svc_pedagogical_trip_grades(grade:grades(grade_name)),destination:svc_transport_destinations(destination_name)),solicitante:workers!svc_service_requests_requested_by_fkey(worker_first_name,worker_last_name_1,worker_last_name_2)&service_type=eq.pedagogical_trip&approver_id=eq.${currentUser.worker_id}`;
                    
                    if (filtrosActivos.estado) {
                        queryTrips += `&request_status=eq.${filtrosActivos.estado}`;
                    }
                    queryTrips += '&order=created_at.desc';
                    
                    const trips = await supabaseRequest(queryTrips);
                    if (trips && trips.length > 0) {
                        trips.forEach(s => s._tipo = 'pedagogical_trip');
                        todasLasSolicitudes = todasLasSolicitudes.concat(trips);
                    }
                }

                // Cargar salidas deportivas
                if (tiposACargar.includes('sports_trip')) {
                    let querySports = `/svc_service_requests?select=*,trip:svc_sports_trips!request_id(*,team:svc_sports_teams(discipline:svc_sports_disciplines(discipline_name),category:svc_sports_categories(category_name),gender),destination:svc_transport_destinations(destination_name)),solicitante:workers!svc_service_requests_requested_by_fkey(worker_first_name,worker_last_name_1,worker_last_name_2)&service_type=eq.sports_trip&approver_id=eq.${currentUser.worker_id}`;
                
                    if (filtrosActivos.estado) {
                        querySports += `&request_status=eq.${filtrosActivos.estado}`;
                    }
                    querySports += '&order=created_at.desc';
                
                    const sportsTrips = await supabaseRequest(querySports);
                    if (sportsTrips && sportsTrips.length > 0) {
                        sportsTrips.forEach(s => s._tipo = 'sports_trip');
                        todasLasSolicitudes = todasLasSolicitudes.concat(sportsTrips);
                    }
                }
                                
                // Cargar eventos internos
                if (tiposACargar.includes('internal_event')) {
                    let queryEvents = `/svc_service_requests?select=*,evento:svc_internal_events!request_id(*),solicitante:workers!svc_service_requests_requested_by_fkey(worker_first_name,worker_last_name_1,worker_last_name_2)&service_type=eq.internal_event&approver_id=eq.${currentUser.worker_id}`;
                    
                    if (filtrosActivos.estado) {
                        queryEvents += `&request_status=eq.${filtrosActivos.estado}`;
                    }
                    queryEvents += '&order=created_at.desc';
                    
                    const events = await supabaseRequest(queryEvents);
                    if (events && events.length > 0) {
                        events.forEach(s => s._tipo = 'internal_event');
                        todasLasSolicitudes = todasLasSolicitudes.concat(events);
                    }
                }
                
                // Ordenar todas por fecha de creaci√≥n (m√°s recientes primero)
                todasLasSolicitudes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                solicitudesData = todasLasSolicitudes;
                
                // Filtrar por fecha (client-side)
                if (filtrosActivos.fechaDesde) {
                    solicitudesData = solicitudesData.filter(s => {
                        let fecha;
                        if (s._tipo === 'internal_event') {
                            fecha = Array.isArray(s.evento) ? s.evento[0]?.event_date : s.evento?.event_date;
                        } else {
                            fecha = Array.isArray(s.trip) ? s.trip[0]?.trip_date : s.trip?.trip_date;
                        }
                        return fecha >= filtrosActivos.fechaDesde;
                    });
                }
                if (filtrosActivos.fechaHasta) {
                    solicitudesData = solicitudesData.filter(s => {
                        let fecha;
                        if (s._tipo === 'internal_event') {
                            fecha = Array.isArray(s.evento) ? s.evento[0]?.event_date : s.evento?.event_date;
                        } else {
                            fecha = Array.isArray(s.trip) ? s.trip[0]?.trip_date : s.trip?.trip_date;
                        }
                        return fecha <= filtrosActivos.fechaHasta;
                    });
                }
                
                // Filtrar por solicitante
                if (filtrosActivos.solicitante) {
                    solicitudesData = solicitudesData.filter(s => s.requested_by === filtrosActivos.solicitante);
                }
                
                // Cargar lista de solicitantes √∫nicos para el filtro
                const solicitantesUnicos = [...new Set(todasLasSolicitudes.map(s => s.requested_by))];
                await cargarFiltroSolicitantes(solicitantesUnicos);
                
                // Renderizar
                renderizarSolicitudes();
                actualizarEstadisticas();
                actualizarContador();
                
            } catch (error) {
                console.error('Error cargando solicitudes:', error);
                showMessage('Error al cargar las solicitudes', 'danger');
                document.getElementById('listaSolicitudes').innerHTML = 
                    '<div class="alert alert-danger">Error al cargar datos</div>';
            }
        }
        
        // ==================== CARGAR FILTRO SOLICITANTES ====================
        async function cargarFiltroSolicitantes(solicitantesIds) {
            const select = document.getElementById('filtroSolicitante');
            
            if (!solicitantesIds || solicitantesIds.length === 0) {
                select.innerHTML = '<option value="">Todos los solicitantes</option>';
                return;
            }
            
            try {
                // Obtener nombres de los solicitantes
                const workers = await supabaseRequest(`/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2&worker_id=in.(${solicitantesIds.join(',')})`);

                select.innerHTML = '<option value="">Todos los solicitantes</option>' +
                    workers.map(w => 
                        `<option value="${w.worker_id}">${w.worker_first_name} ${w.worker_last_name_1}</option>`
                    ).join('');
            } catch (error) {
                console.error('Error cargando solicitantes:', error);
            }
        }
      // ==================== RENDERIZAR SOLICITUDES ====================
        function renderizarSolicitudes() {
            const container = document.getElementById('listaSolicitudes');
            const mensajeVacio = document.getElementById('mensajeVacio');
            
            if (solicitudesData.length === 0) {
                container.innerHTML = '';
                mensajeVacio.style.display = 'block';
                return;
            }
            
            mensajeVacio.style.display = 'none';
            
            const html = solicitudesData.map(solicitud => {
                if (solicitud._tipo === 'internal_event') {
                    return renderTarjetaEvento(solicitud);
                } else if (solicitud._tipo === 'sports_trip') {
                    return renderTarjetaDeportiva(solicitud);
                } else {
                    return renderTarjetaTrip(solicitud);
                }
            }).join('');
            
            container.innerHTML = html;

            // Cargar estado de costos para eventos internos pendientes
            solicitudesData.forEach(s => {
                if (s._tipo === 'internal_event' && s.request_status === 'pending') {
                    cargarEstadoCostos(s);
                }
            });
        }
        
        function renderTarjetaTrip(solicitud) {
            const trip = Array.isArray(solicitud.trip) ? solicitud.trip[0] : solicitud.trip;
            if (!trip) return '';
            
            const grados = trip.grades?.map(g => g.grade?.grade_name).filter(Boolean).join(', ') || 'N/A';
            const destino = trip.destination?.destination_name || 'N/A';
            const solicitante = solicitud.solicitante ? `${solicitud.solicitante.worker_first_name} ${solicitud.solicitante.worker_last_name_1}` : 'Desconocido';
            const fechaSolicitud = formatDate(solicitud.requested_at);
            const fechaSalida = formatDateLong(trip.trip_date);
            const totalParticipantes = (trip.planned_students || 0) + (trip.num_adults || 0);
            
            const costoTransporte = trip.total_transport_value || 0;
            const costoRefrigerios = trip.total_catering_value || 0;
            const costoEntradas = trip.total_entrance_value || 0;
            const costoTotal = costoTransporte + costoRefrigerios + costoEntradas;
            
            const estadoClass = solicitud.request_status === 'approved' ? 'approved' : 
                               solicitud.request_status === 'rejected' ? 'rejected' : 'pending';
            const badgeEstado = getBadgeEstadoSolicitud(solicitud.request_status);
            
            let botonesAccion = '';
            if (solicitud.request_status === 'pending') {
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                const fechaTripDate = new Date(trip.trip_date + 'T00:00:00');
                const diasRestantes = Math.ceil((fechaTripDate - hoy) / (1000 * 60 * 60 * 24));
            
                if (diasRestantes < 0) {
                    botonesAccion = `
                        <span class="badge bg-secondary text-wrap me-2 py-2 px-3" style="max-width: 280px; line-height: 1.4;">
                            <i class="bi bi-calendar-x me-1"></i>
                            Salida ya pas√≥ ‚Äî no se puede aprobar
                        </span>
                    `;
                } else {
                    botonesAccion = `
                        <button class="btn btn-success me-2" onclick="aprobarSolicitud('${solicitud.request_id}')">
                            <i class="bi bi-check-circle me-1"></i>Aprobar
                        </button>
                        <button class="btn btn-danger me-2" onclick="mostrarModalRechazar('${solicitud.request_id}')">
                            <i class="bi bi-x-circle me-1"></i>Rechazar
                        </button>
                    `;
                }
            }
            
            return `
                <div class="card request-card ${estadoClass} mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <span class="badge bg-info mb-2">Salida Pedagogica</span>
                                        <h5 class="card-title mb-1">
                                            <i class="bi bi-backpack3 me-2"></i>${destino}
                                        </h5>
                                        <p class="text-muted mb-0">
                                            <small>
                                                <i class="bi bi-calendar3 me-1"></i>${fechaSalida}
                                                <span class="mx-2">|</span>
                                                <i class="bi bi-people me-1"></i>${grados}
                                            </small>
                                        </p>
                                    </div>
                                    <div>${badgeEstado}</div>
                                </div>
                                <div class="row g-2 mb-3">
                                    <div class="col-md-6">
                                        <small class="text-muted">Participantes:</small><br>
                                        <strong>${trip.planned_students || 0} estudiantes + ${trip.num_adults || 0} adultos = ${totalParticipantes} total</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">Solicitado por:</small><br>
                                        <strong>${solicitante}</strong>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">Descripcion:</small><br>
                                    <span>${trip.trip_description || 'Sin descripcion'}</span>
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>Solicitado el ${fechaSolicitud}
                                </small>
                            </div>
                            <div class="col-md-4">
                                <div class="cost-breakdown">
                                    <h6 class="mb-3"><i class="bi bi-calculator me-2"></i>Costos</h6>
                                    <div class="cost-item">
                                        <span>Transporte:</span>
                                        <span>${formatCurrency(costoTransporte)}</span>
                                    </div>
                                    <div class="cost-item">
                                        <span>Refrigerios:</span>
                                        <span>${costoRefrigerios ? formatCurrency(costoRefrigerios) : 'No incluye'}</span>
                                    </div>
                                    <div class="cost-item">
                                        <span>Entradas:</span>
                                        <span>${costoEntradas ? formatCurrency(costoEntradas) : 'No incluye'}</span>
                                    </div>
                                    <div class="cost-item">
                                        <span>TOTAL:</span>
                                        <span>${formatCurrency(costoTotal)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${solicitud.request_status === 'rejected' && solicitud.rejection_reason ? `
                            <div class="alert alert-danger mb-0 mt-3">
                                <strong>Motivo del rechazo:</strong><br>
                                ${solicitud.rejection_reason}
                            </div>
                        ` : ''}
                        <div class="mt-3 d-flex justify-content-end gap-2">
                            <button class="btn btn-outline-info" onclick="verDetalleSolicitud('${solicitud.request_id}')">
                                <i class="bi bi-eye me-1"></i>Ver detalle completo
                            </button>
                            ${botonesAccion}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderTarjetaEvento(solicitud) {
            const evento = Array.isArray(solicitud.evento) ? solicitud.evento[0] : solicitud.evento;
            if (!evento) return '';
            
            const solicitante = solicitud.solicitante ? `${solicitud.solicitante.worker_first_name} ${solicitud.solicitante.worker_last_name_1}` : 'Desconocido';
            const fechaSolicitud = formatDate(solicitud.requested_at);
            const fechaEvento = formatDateLong(evento.event_date);
            const totalParticipantes = (evento.num_students || 0) + (evento.num_adults || 0);
            
            const estadoClass = solicitud.request_status === 'approved' ? 'approved' : 
                               solicitud.request_status === 'rejected' ? 'rejected' : 'pending';
            const badgeEstado = getBadgeEstadoSolicitud(solicitud.request_status);
            
            let botonesAccion = '';
            if (solicitud.request_status === 'pending') {
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                const fechaEventoDate = new Date(evento.event_date + 'T00:00:00');
                const diasRestantes = Math.ceil((fechaEventoDate - hoy) / (1000 * 60 * 60 * 24));
            
                if (diasRestantes < 0) {
                    // Fecha ya pas√≥ ‚Äî no se puede aprobar ni rechazar
                    botonesAccion += `
                        <span class="badge bg-secondary text-wrap me-2 py-2 px-3" style="max-width: 280px; line-height: 1.4;">
                            <i class="bi bi-calendar-x me-1"></i>
                            Evento ya pas√≥ ‚Äî no se puede aprobar
                        </span>
                    `;
                } else if (diasRestantes > daysBeforeImminent) {
                    // A√∫n no se abre la ventana de aprobaci√≥n
                    const fechaHabilitacion = new Date(fechaEventoDate);
                    fechaHabilitacion.setDate(fechaHabilitacion.getDate() - daysBeforeImminent);
                    botonesAccion += `
                        <span class="badge bg-info text-wrap me-2 py-2 px-3" style="max-width: 280px; line-height: 1.4;">
                            <i class="bi bi-clock-history me-1"></i>
                            Aprobaci√≥n disponible a partir del ${formatDateLong(fechaHabilitacion.toISOString().split('T')[0])}
                            <br><small>(faltan ${diasRestantes} d√≠as para el evento)</small>
                        </span>
                    `;
                    // Rechazar s√≠ est√° disponible aunque no se pueda aprobar a√∫n
                    botonesAccion += `
                        <button class="btn btn-danger me-2" onclick="mostrarModalRechazar('${solicitud.request_id}')">
                            <i class="bi bi-x-circle me-1"></i>Rechazar
                        </button>
                    `;
                } else {
                    // Dentro de la ventana de aprobaci√≥n
                    botonesAccion += `
                        <button class="btn btn-success me-2" onclick="aprobarSolicitud('${solicitud.request_id}')">
                            <i class="bi bi-check-circle me-1"></i>Aprobar
                        </button>
                        <button class="btn btn-danger me-2" onclick="mostrarModalRechazar('${solicitud.request_id}')">
                            <i class="bi bi-x-circle me-1"></i>Rechazar
                        </button>
                    `;
                }
            }
            
            return `
                <div class="card request-card ${estadoClass} mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <span class="badge bg-primary mb-2">Evento Interno</span>
                                        <h5 class="card-title mb-1">
                                            <i class="bi bi-calendar-event me-2"></i>${evento.event_name}
                                        </h5>
                                        <p class="text-muted mb-0">
                                            <small>
                                                <i class="bi bi-calendar3 me-1"></i>${fechaEvento}
                                                <span class="mx-2">|</span>
                                                <i class="bi bi-clock me-1"></i>${evento.start_time?.substring(0,5)} - ${evento.end_time?.substring(0,5)}
                                            </small>
                                        </p>
                                    </div>
                                    <div>${badgeEstado}</div>
                                </div>
                                <div class="row g-2 mb-3">
                                    <div class="col-md-4">
                                        <small class="text-muted">Participantes:</small><br>
                                        <strong>${evento.num_students || 0} estudiantes + ${evento.num_adults || 0} adultos = ${totalParticipantes} total</strong>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">Ubicacion:</small><br>
                                        <strong>${evento.event_location || 'N/A'}</strong>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">Solicitado por:</small><br>
                                        <strong>${solicitante}</strong>
                                    </div>
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>Solicitado el ${fechaSolicitud}
                                </small>
                            </div>
                            <div class="col-md-4">
                                <div class="cost-breakdown">
                                    <h6 class="mb-3"><i class="bi bi-calculator me-2"></i>Costos</h6>
                                    <div class="cost-item">
                                        <span>Costos detallados:</span>
                                        <span class="text-muted"><em>Ver detalle</em></span>
                                    </div>
                                    <div class="cost-item">
                                        <span>ESTADO:</span>
                                        <span>${getBadgeEstadoEvento(evento.event_status)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${solicitud.request_status === 'rejected' && solicitud.rejection_reason ? `
                            <div class="alert alert-danger mb-0 mt-3">
                                <strong>Motivo del rechazo:</strong><br>
                                ${solicitud.rejection_reason}
                            </div>
                        ` : ''}
                        <div class="mt-3 d-flex justify-content-end gap-2">
                            <button class="btn btn-outline-info" onclick="verDetalleSolicitud('${solicitud.request_id}')">
                                <i class="bi bi-eye me-1"></i>Ver detalle completo
                            </button>
                            ${botonesAccion}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTarjetaDeportiva(solicitud) {
            const trip = Array.isArray(solicitud.trip) ? solicitud.trip[0] : solicitud.trip;
            if (!trip) return '';
        
            const team = trip.team;
            const disciplina = team?.discipline?.discipline_name || 'N/A';
            const categoria = team?.category?.category_name || 'N/A';
            const generoLabels = { male: 'Masculino', female: 'Femenino', mixed: 'Mixto' };
            const genero = generoLabels[team?.gender] || '';
            const destino = trip.destination?.destination_name || 'N/A';
            const solicitante = solicitud.solicitante ? `${solicitud.solicitante.worker_first_name} ${solicitud.solicitante.worker_last_name_1}` : 'Desconocido';
            const fechaSolicitud = formatDate(solicitud.requested_at);
            const fechaSalida = formatDateLong(trip.trip_date);
            const totalParticipantes = (trip.planned_students || 0) + (trip.num_adults || 0);
            const modalidadLabels = { outbound: 'Solo ida', 'return': 'Solo regreso', round_trip: 'Ida y regreso' };
            const modalidad = modalidadLabels[trip.transport_modality] || trip.transport_modality;
        
            const costoTransporte = trip.total_transport_value || 0;
            const costoRefrigerios = trip.total_catering_value || 0;
            const costoTotal = costoTransporte + costoRefrigerios;
        
            const estadoClass = solicitud.request_status === 'approved' ? 'approved' :
                               solicitud.request_status === 'rejected' ? 'rejected' : 'pending';
            const badgeEstado = getBadgeEstadoSolicitud(solicitud.request_status);
        
            let botonesAccion = '';
            if (solicitud.request_status === 'pending') {
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                const fechaTripDate = new Date(trip.trip_date + 'T00:00:00');
                const diasRestantes = Math.ceil((fechaTripDate - hoy) / (1000 * 60 * 60 * 24));
        
                if (diasRestantes < 0) {
                    botonesAccion = `
                        <span class="badge bg-secondary text-wrap me-2 py-2 px-3" style="max-width: 280px; line-height: 1.4;">
                            <i class="bi bi-calendar-x me-1"></i>
                            Salida ya pas√≥ ‚Äî no se puede aprobar
                        </span>
                    `;
                } else {
                    botonesAccion = `
                        <button class="btn btn-success me-2" onclick="aprobarSolicitud('${solicitud.request_id}')">
                            <i class="bi bi-check-circle me-1"></i>Aprobar
                        </button>
                        <button class="btn btn-danger me-2" onclick="mostrarModalRechazar('${solicitud.request_id}')">
                            <i class="bi bi-x-circle me-1"></i>Rechazar
                        </button>
                    `;
                }
            }
        
            return `
                <div class="card request-card ${estadoClass} mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <span class="badge bg-success mb-2">Salida Deportiva</span>
                                        <h5 class="card-title mb-1">
                                            <i class="bi bi-trophy me-2"></i>${trip.trip_name}
                                        </h5>
                                        <p class="text-muted mb-0">
                                            <small>
                                                <i class="bi bi-calendar3 me-1"></i>${fechaSalida}
                                                <span class="mx-2">|</span>
                                                <i class="bi bi-dribbble me-1"></i>${disciplina} - ${categoria} (${genero})
                                            </small>
                                        </p>
                                    </div>
                                    <div>${badgeEstado}</div>
                                </div>
                                <div class="row g-2 mb-3">
                                    <div class="col-md-4">
                                        <small class="text-muted">Participantes:</small><br>
                                        <strong>${trip.planned_students || 0} estudiantes + ${trip.num_adults || 0} adultos = ${totalParticipantes} total</strong>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">Destino:</small><br>
                                        <strong>${destino}${trip.specific_destination ? ' ‚Äî ' + trip.specific_destination : ''}</strong>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">Solicitado por:</small><br>
                                        <strong>${solicitante}</strong>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">Transporte:</small>
                                    <span>${modalidad} | Salida: ${trip.departure_time?.substring(0,5) || 'N/A'} - Regreso: ${trip.return_time?.substring(0,5) || 'N/A'}</span>
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>Solicitado el ${fechaSolicitud}
                                </small>
                            </div>
                            <div class="col-md-4">
                                <div class="cost-breakdown">
                                    <h6 class="mb-3"><i class="bi bi-calculator me-2"></i>Costos</h6>
                                    <div class="cost-item">
                                        <span>Transporte:</span>
                                        <span>${formatCurrency(costoTransporte)}</span>
                                    </div>
                                    <div class="cost-item">
                                        <span>Refrigerios:</span>
                                        <span>${costoRefrigerios ? formatCurrency(costoRefrigerios) : 'No incluye'}</span>
                                    </div>
                                    <div class="cost-item">
                                        <span>TOTAL:</span>
                                        <span>${formatCurrency(costoTotal)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${solicitud.request_status === 'rejected' && solicitud.rejection_reason ? `
                            <div class="alert alert-danger mb-0 mt-3">
                                <strong>Motivo del rechazo:</strong><br>
                                ${solicitud.rejection_reason}
                            </div>
                        ` : ''}
                        <div class="mt-3 d-flex justify-content-end gap-2">
                            <button class="btn btn-outline-info" onclick="verDetalleSolicitud('${solicitud.request_id}')">
                                <i class="bi bi-eye me-1"></i>Ver detalle completo
                            </button>
                            ${botonesAccion}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getBadgeEstadoEvento(estado) {
            const estados = {
                'scheduled': '<span class="badge bg-primary">Programado</span>',
                'completed': '<span class="badge bg-success">Completado</span>',
                'suspended': '<span class="badge bg-warning">Suspendido</span>',
                'cancelled': '<span class="badge bg-danger">Cancelado</span>'
            };
            return estados[estado] || '<span class="badge bg-secondary">Desconocido</span>';
        }

        // ==================== CARGAR ESTADO DE COSTOS ====================
        async function cargarEstadoCostos(solicitud) {
            const evento = Array.isArray(solicitud.evento) ? solicitud.evento[0] : solicitud.evento;
            if (!evento) return;
        
            const container = document.getElementById(`costStatus_${solicitud.request_id}`);
            if (!container) return;
        
            try {
                const services = await supabaseRequest(`/svc_internal_event_services?event_id=eq.${evento.event_id}&select=service_type,cost_value`);
        
                if (!services || services.length === 0) {
                    container.innerHTML = '<small class="text-muted">Sin servicios de apoyo</small>';
                    return;
                }
        
                const total = services.length;
                const registrados = services.filter(s => s.cost_value !== null && s.cost_value !== undefined).length;
                const pendientes = total - registrados;
        
                let badgeClass, iconClass, texto;
                if (pendientes === 0) {
                    badgeClass = 'bg-success bg-opacity-10 text-success border border-success';
                    iconClass = 'bi-check-circle-fill';
                    texto = `${registrados}/${total} costos registrados`;
                } else {
                    badgeClass = 'bg-warning bg-opacity-10 text-warning border border-warning';
                    iconClass = 'bi-exclamation-triangle-fill';
                    texto = `${registrados}/${total} costos registrados (${pendientes} pendiente${pendientes > 1 ? 's' : ''})`;
                }
        
                container.innerHTML = `
                    <div class="rounded px-2 py-1 ${badgeClass}">
                        <small><i class="bi ${iconClass} me-1"></i>${texto}</small>
                    </div>
                `;
            } catch (error) {
                console.error('Error cargando estado de costos:', error);
                container.innerHTML = '';
            }
        }

        
      // ==================== APROBAR SOLICITUD ====================
        async function aprobarSolicitud(requestId) {
            // Validar restricciones de fecha
            const solicitud = solicitudesData.find(s => s.request_id === requestId);
            if (solicitud) {
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
            
                if (solicitud._tipo === 'internal_event') {
                    const evento = Array.isArray(solicitud.evento) ? solicitud.evento[0] : solicitud.evento;
                    if (evento) {
                        const fechaEvento = new Date(evento.event_date + 'T00:00:00');
                        const diasRestantes = Math.ceil((fechaEvento - hoy) / (1000 * 60 * 60 * 24));
            
                        if (diasRestantes < 0) {
                            showMessage('No se puede aprobar: la fecha del evento ya pas√≥.', 'warning');
                            return;
                        }
                        if (diasRestantes > daysBeforeImminent) {
                            showMessage(`No es posible aprobar a√∫n. Faltan ${diasRestantes} d√≠as para el evento. La aprobaci√≥n se habilitar√° cuando falten ${daysBeforeImminent} d√≠as o menos.`, 'warning');
                            return;
                        }
                    }
                } else if (solicitud._tipo === 'pedagogical_trip' || solicitud._tipo === 'sports_trip') {
                    const trip = Array.isArray(solicitud.trip) ? solicitud.trip[0] : solicitud.trip;
                    if (trip) {
                        const fechaTrip = new Date(trip.trip_date + 'T00:00:00');
                        const diasRestantes = Math.ceil((fechaTrip - hoy) / (1000 * 60 * 60 * 24));
            
                        if (diasRestantes < 0) {
                            showMessage('No se puede aprobar: la fecha de la salida ya pas√≥.', 'warning');
                            return;
                        }
                    }
                }
            }
        
            // Confirmaci√≥n
            if (!confirm('¬øEst√° seguro de aprobar esta solicitud?')) return;
            
            try {
                showLoading('listaSolicitudes');
                
                // Actualizar estado en base de datos
                await supabaseRequest(`/svc_service_requests?request_id=eq.${requestId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        request_status: 'approved',
                        resolved_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                });
                
                // Obtener datos completos de la solicitud para notificaci√≥n
                const solicitud = solicitudesData.find(s => s.request_id === requestId);
                
                if (solicitud) {
                    await enviarNotificacionAprobacion(solicitud, true);
                }
                
                showMessage('‚úÖ Solicitud aprobada correctamente', 'success');
                
                // Recargar solicitudes
                await cargarSolicitudes();
                
            } catch (error) {
                console.error('‚ùå Error aprobando solicitud:', error);
                showMessage('Error al aprobar la solicitud', 'danger');
                await cargarSolicitudes(); // Recargar de todos modos
            }
        }
        
        // ==================== MOSTRAR MODAL RECHAZAR ====================
        function mostrarModalRechazar(requestId) {
            document.getElementById('rechazarRequestId').value = requestId;
            document.getElementById('motivoRechazo').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('modalRechazar'));
            modal.show();
        }
        
        // ==================== CONFIRMAR RECHAZO ====================
        async function confirmarRechazo() {
            const requestId = document.getElementById('rechazarRequestId').value;
            const motivo = document.getElementById('motivoRechazo').value.trim();
            
            if (!motivo) {
                showMessage('Debe especificar un motivo de rechazo', 'warning');
                return;
            }
            
            try {
                showLoading('listaSolicitudes');
                
                // Actualizar estado en base de datos
                await supabaseRequest(`/svc_service_requests?request_id=eq.${requestId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        request_status: 'rejected',
                        rejection_reason: motivo,
                        resolved_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                });
                
                // Obtener datos completos de la solicitud para notificaci√≥n
                const solicitud = solicitudesData.find(s => s.request_id === requestId);
                
                if (solicitud) {
                    await enviarNotificacionAprobacion(solicitud, false, motivo);
                }
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalRechazar'));
                if (modal) modal.hide();
                
                showMessage('Solicitud rechazada. El solicitante ha sido notificado.', 'info');
                
                // Recargar solicitudes
                await cargarSolicitudes();
                
            } catch (error) {
                console.error('‚ùå Error rechazando solicitud:', error);
                showMessage('Error al rechazar la solicitud', 'danger');
                await cargarSolicitudes(); // Recargar de todos modos
            }
        }
      // ==================== ENVIAR NOTIFICACIONES ====================
        async function enviarNotificacionAprobacion(solicitud, esAprobada, motivoRechazo = null) {
            try {
                console.log('Enviando notificaciones...', esAprobada ? 'APROBADA' : 'RECHAZADA');
                
                // Obtener email del solicitante
                const solicitante = await supabaseRequest(`/workers?select=email,worker_first_name,worker_last_name_1&worker_id=eq.${solicitud.requested_by}`);
                const emailSolicitante = solicitante?.[0]?.email;
                const nombreSolicitante = solicitante?.[0] ? `${solicitante[0].worker_first_name} ${solicitante[0].worker_last_name_1}` : 'Usuario';
                
                if (!emailSolicitante) {
                    console.warn('No se encontro email del solicitante');
                }
                
                // Obtener email de coordinaci√≥n
                const configEmail = await supabaseRequest(`/svc_module_config?select=config_value&config_key=eq.email_coordination`);
                const emailCoordinacion = configEmail?.[0]?.config_value;
                
                const aprobador = currentUser.user_display_name || currentUser.user_name;
                
                if (solicitud._tipo === 'internal_event') {
                    await notificarEvento(solicitud, esAprobada, motivoRechazo, emailSolicitante, nombreSolicitante, emailCoordinacion, aprobador);
                } else if (solicitud._tipo === 'sports_trip') {
                    await notificarSportsTrip(solicitud, esAprobada, motivoRechazo, emailSolicitante, nombreSolicitante, emailCoordinacion, aprobador);
                } else {
                    await notificarTrip(solicitud, esAprobada, motivoRechazo, emailSolicitante, nombreSolicitante, emailCoordinacion, aprobador);
                }
                
                return true;
                
            } catch (error) {
                console.error('Error enviando notificaciones:', error);
                return false;
            }
        }
        
        async function notificarTrip(solicitud, esAprobada, motivoRechazo, emailSolicitante, nombreSolicitante, emailCoordinacion, aprobador) {
            const trip = Array.isArray(solicitud.trip) ? solicitud.trip[0] : solicitud.trip;
            if (!trip) return;
            
            const destino = trip.destination?.destination_name || 'Destino no especificado';
            const grados = trip.grades?.map(g => g.grade?.grade_name).filter(Boolean).join(', ') || 'N/A';
            const fechaSalida = formatDateLong(trip.trip_date);
            
            const estadoTexto = esAprobada ? 'APROBADA' : 'RECHAZADA';
            const colorHeader = esAprobada ? '#28a745' : '#dc3545';
            const colorAlerta = esAprobada ? '#d4edda' : '#f8d7da';
            const colorTextoAlerta = esAprobada ? '#155724' : '#721c24';
            const asunto = `Solicitud ${estadoTexto}: Salida Pedagogica - ${destino}`;
            
            let htmlContent = `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;">
                    <div style="background-color: ${colorHeader}; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                        <h1 style="margin: 0; font-size: 24px;">Solicitud ${estadoTexto}</h1>
                    </div>
                    <div style="background-color: white; padding: 30px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <p style="font-size: 16px; color: #333;">Hola <strong>${nombreSolicitante}</strong>,</p>
                        <div style="background-color: ${colorAlerta}; border-left: 4px solid ${colorHeader}; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                            <p style="margin: 0; color: ${colorTextoAlerta}; font-size: 16px; font-weight: bold;">
                                Tu solicitud de salida pedagogica ha sido ${estadoTexto}
                            </p>
                        </div>
                        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                            <h3 style="color: #1b365d; margin-top: 0; font-size: 18px;">Detalles de la Salida</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Destino:</td><td style="padding: 8px 0;">${destino}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Fecha:</td><td style="padding: 8px 0;">${fechaSalida}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Grados:</td><td style="padding: 8px 0;">${grados}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">${esAprobada ? 'Aprobado' : 'Rechazado'} por:</td><td style="padding: 8px 0;">${aprobador}</td></tr>
                            </table>
                        </div>
                        ${!esAprobada && motivoRechazo ? `
                        <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <p style="margin: 0 0 10px 0; color: #856404; font-weight: bold;">Motivo del rechazo:</p>
                            <p style="margin: 0; color: #856404;">${motivoRechazo}</p>
                        </div>` : ''}
                        <p style="font-size: 12px; color: #999; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center;">
                            Este es un mensaje automatico del sistema SchoolNet.<br>Por favor, no responder a este correo.
                        </p>
                    </div>
                </div>
            `;
            
            if (emailSolicitante) {
                await sendNotification(emailSolicitante, asunto, htmlContent, true);
                console.log('Notificacion enviada al solicitante:', emailSolicitante);
            }
            if (emailCoordinacion) {
                await sendNotification(emailCoordinacion, asunto, htmlContent, true);
                console.log('Notificacion enviada a coordinacion:', emailCoordinacion);
            }
        }
        
        async function notificarEvento(solicitud, esAprobada, motivoRechazo, emailSolicitante, nombreSolicitante, emailCoordinacion, aprobador) {
            const evento = Array.isArray(solicitud.evento) ? solicitud.evento[0] : solicitud.evento;
            if (!evento) return;
            
            const fechaEvento = formatDateLong(evento.event_date);
            const estadoTexto = esAprobada ? 'APROBADA' : 'RECHAZADA';
            const colorHeader = esAprobada ? '#28a745' : '#dc3545';
            const colorAlerta = esAprobada ? '#d4edda' : '#f8d7da';
            const colorTextoAlerta = esAprobada ? '#155724' : '#721c24';
            const asunto = `Solicitud ${estadoTexto}: Evento Interno - ${evento.event_name}`;
            
            let htmlContent = `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;">
                    <div style="background-color: ${colorHeader}; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                        <h1 style="margin: 0; font-size: 24px;">Solicitud ${estadoTexto}</h1>
                    </div>
                    <div style="background-color: white; padding: 30px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <p style="font-size: 16px; color: #333;">Hola <strong>${nombreSolicitante}</strong>,</p>
                        <div style="background-color: ${colorAlerta}; border-left: 4px solid ${colorHeader}; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                            <p style="margin: 0; color: ${colorTextoAlerta}; font-size: 16px; font-weight: bold;">
                                Tu solicitud de evento interno ha sido ${estadoTexto}
                            </p>
                        </div>
                        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                            <h3 style="color: #1b365d; margin-top: 0; font-size: 18px;">Detalles del Evento</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Evento:</td><td style="padding: 8px 0;">${evento.event_name}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Fecha:</td><td style="padding: 8px 0;">${fechaEvento}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Horario:</td><td style="padding: 8px 0;">${evento.start_time?.substring(0,5)} - ${evento.end_time?.substring(0,5)}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Ubicacion:</td><td style="padding: 8px 0;">${evento.event_location || 'N/A'}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">${esAprobada ? 'Aprobado' : 'Rechazado'} por:</td><td style="padding: 8px 0;">${aprobador}</td></tr>
                            </table>
                        </div>
                        ${!esAprobada && motivoRechazo ? `
                        <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <p style="margin: 0 0 10px 0; color: #856404; font-weight: bold;">Motivo del rechazo:</p>
                            <p style="margin: 0; color: #856404;">${motivoRechazo}</p>
                        </div>` : ''}
                        <p style="font-size: 12px; color: #999; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center;">
                            Este es un mensaje automatico del sistema SchoolNet.<br>Por favor, no responder a este correo.
                        </p>
                    </div>
                </div>
            `;
            
            // 1. Notificar al solicitante
            if (emailSolicitante) {
                await sendNotification(emailSolicitante, asunto, htmlContent, true);
                console.log('Notificacion enviada al solicitante:', emailSolicitante);
            }
            
            // 2. Notificar a coordinaci√≥n
            if (emailCoordinacion) {
                await sendNotification(emailCoordinacion, asunto, htmlContent, true);
                console.log('Notificacion enviada a coordinacion:', emailCoordinacion);
            }
            
            // 3. Si es RECHAZADA, notificar a todas las √°reas de apoyo implicadas
            if (!esAprobada) {
                try {
                    const services = await supabaseRequest(`/svc_internal_event_services?event_id=eq.${evento.event_id}&select=service_type,notified_email`);
                    
                    if (services && services.length > 0) {
                        for (const svc of services) {
                            if (svc.notified_email) {
                                await sendNotification(svc.notified_email, asunto, htmlContent, true);
                                console.log(`Notificacion de rechazo enviada a ${svc.service_type}: ${svc.notified_email}`);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error notificando a areas de apoyo:', error);
                }
            }
        }

        async function notificarSportsTrip(solicitud, esAprobada, motivoRechazo, emailSolicitante, nombreSolicitante, emailCoordinacion, aprobador) {
            const trip = Array.isArray(solicitud.trip) ? solicitud.trip[0] : solicitud.trip;
            if (!trip) return;
        
            const disciplina = trip.team?.discipline?.discipline_name || '';
            const categoria = trip.team?.category?.category_name || '';
            const destino = trip.destination?.destination_name || 'Destino no especificado';
            const fechaSalida = formatDateLong(trip.trip_date);
        
            const estadoTexto = esAprobada ? 'APROBADA' : 'RECHAZADA';
            const colorHeader = esAprobada ? '#28a745' : '#dc3545';
            const colorAlerta = esAprobada ? '#d4edda' : '#f8d7da';
            const colorTextoAlerta = esAprobada ? '#155724' : '#721c24';
            const asunto = `Solicitud ${estadoTexto}: Salida Deportiva - ${trip.trip_name}`;
        
            let htmlContent = `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;">
                    <div style="background-color: ${colorHeader}; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                        <h1 style="margin: 0; font-size: 24px;">Solicitud ${estadoTexto}</h1>
                    </div>
                    <div style="background-color: white; padding: 30px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <p style="font-size: 16px; color: #333;">Hola <strong>${nombreSolicitante}</strong>,</p>
                        <div style="background-color: ${colorAlerta}; border-left: 4px solid ${colorHeader}; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                            <p style="margin: 0; color: ${colorTextoAlerta}; font-size: 16px; font-weight: bold;">
                                Tu solicitud de salida deportiva ha sido ${estadoTexto}
                            </p>
                        </div>
                        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                            <h3 style="color: #1b365d; margin-top: 0; font-size: 18px;">Detalles de la Salida</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Salida:</td><td style="padding: 8px 0;">${trip.trip_name}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Equipo:</td><td style="padding: 8px 0;">${disciplina} - ${categoria}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Fecha:</td><td style="padding: 8px 0;">${fechaSalida}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Destino:</td><td style="padding: 8px 0;">${destino}</td></tr>
                                <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">${esAprobada ? 'Aprobado' : 'Rechazado'} por:</td><td style="padding: 8px 0;">${aprobador}</td></tr>
                            </table>
                        </div>
                        ${!esAprobada && motivoRechazo ? `
                        <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <p style="margin: 0 0 10px 0; color: #856404; font-weight: bold;">Motivo del rechazo:</p>
                            <p style="margin: 0; color: #856404;">${motivoRechazo}</p>
                        </div>` : ''}
                        <p style="font-size: 12px; color: #999; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center;">
                            Este es un mensaje automatico del sistema SchoolNet.<br>Por favor, no responder a este correo.
                        </p>
                    </div>
                </div>
            `;
        
            if (emailSolicitante) {
                await sendNotification(emailSolicitante, asunto, htmlContent, true);
                console.log('Notificacion enviada al solicitante:', emailSolicitante);
            }
            if (emailCoordinacion) {
                await sendNotification(emailCoordinacion, asunto, htmlContent, true);
                console.log('Notificacion enviada a coordinacion:', emailCoordinacion);
            }
        }

        
      // ==================== VER DETALLE SOLICITUD ====================
        async function verDetalleSolicitud(requestId) {
            try {
                const solicitud = solicitudesData.find(s => s.request_id === requestId);
                if (!solicitud) {
                    showMessage('No se encontro la solicitud', 'danger');
                    return;
                }
                
                let detalleHTML = '';
                
                if (solicitud._tipo === 'internal_event') {
                    detalleHTML = await renderDetalleEvento(solicitud);
                } else if (solicitud._tipo === 'sports_trip') {
                    detalleHTML = await renderDetalleDeportiva(solicitud);
                } else {
                    detalleHTML = renderDetalleTrip(solicitud);
                }
                
                document.getElementById('detalleContent').innerHTML = detalleHTML;
                
                const modalEl = document.getElementById('modalDetalle');
                const existingModal = bootstrap.Modal.getInstance(modalEl);
                if (existingModal) {
                    existingModal.show();
                } else {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                }
                
            } catch (error) {
                console.error('Error al ver detalle:', error);
                showMessage('Error al cargar los detalles', 'danger');
            }
        }
        
        function renderDetalleTrip(solicitud) {
            const trip = Array.isArray(solicitud.trip) ? solicitud.trip[0] : solicitud.trip;
            if (!trip) return '<p>No hay datos de la salida</p>';
            
            const grados = trip.grades?.map(g => g.grade?.grade_name).filter(Boolean).join(', ') || 'N/A';
            const destino = trip.destination?.destination_name || 'N/A';
            const solicitante = solicitud.solicitante ? `${solicitud.solicitante.worker_first_name} ${solicitud.solicitante.worker_last_name_1}` : 'Desconocido';
            
            return `
                <div class="row g-3">
                    <div class="col-12">
                        <span class="badge bg-info mb-2">Salida Pedagogica</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Fecha de salida:</strong><br>
                        ${formatDateLong(trip.trip_date)}
                    </div>
                    <div class="col-md-6">
                        <strong>Estado de solicitud:</strong><br>
                        ${getBadgeEstadoSolicitud(solicitud.request_status)}
                    </div>
                    <div class="col-md-6">
                        <strong>Grados:</strong><br>
                        ${grados}
                    </div>
                    <div class="col-md-6">
                        <strong>Destino:</strong><br>
                        ${destino}
                    </div>
                    <div class="col-md-6">
                        <strong>Hora salida:</strong><br>
                        ${trip.departure_time || 'N/A'}
                    </div>
                    <div class="col-md-6">
                        <strong>Hora regreso:</strong><br>
                        ${trip.return_time || 'N/A'}
                    </div>
                    <div class="col-12">
                        <strong>Descripcion:</strong><br>
                        ${trip.trip_description || 'N/A'}
                    </div>
                    ${trip.inquiry_unit ? `
                    <div class="col-12">
                        <strong>Unidad de indagacion:</strong><br>
                        ${trip.inquiry_unit}
                    </div>` : ''}
                    ${trip.observations ? `
                    <div class="col-12">
                        <strong>Observaciones:</strong><br>
                        ${trip.observations}
                    </div>` : ''}
                    <div class="col-md-4">
                        <strong>Estudiantes:</strong><br>
                        ${trip.planned_students || 0}
                    </div>
                    <div class="col-md-4">
                        <strong>Adultos:</strong><br>
                        ${trip.num_adults || 0}
                    </div>
                    <div class="col-md-4">
                        <strong>Total participantes:</strong><br>
                        ${(trip.planned_students || 0) + (trip.num_adults || 0)}
                    </div>
                    ${trip.accompanying_adults ? `
                    <div class="col-12">
                        <strong>Adultos acompanantes:</strong><br>
                        ${trip.accompanying_adults}
                    </div>` : ''}
                    <div class="col-12 mt-4">
                        <h6 class="border-bottom pb-2">Costos</h6>
                    </div>
                    <div class="col-md-4">
                        <strong>Transporte:</strong><br>
                        ${formatCurrency(trip.total_transport_value || 0)}
                    </div>
                    <div class="col-md-4">
                        <strong>Refrigerios:</strong><br>
                        ${trip.total_catering_value ? formatCurrency(trip.total_catering_value) : 'No incluye'}
                    </div>
                    <div class="col-md-4">
                        <strong>Entradas:</strong><br>
                        ${trip.total_entrance_value ? formatCurrency(trip.total_entrance_value) : 'No incluye'}
                    </div>
                    <div class="col-12">
                        <strong class="fs-5">Costo Total:</strong>
                        <span class="fs-4 text-primary fw-bold">${formatCurrency((trip.total_transport_value || 0) + (trip.total_catering_value || 0) + (trip.total_entrance_value || 0))}</span>
                    </div>
                    <div class="col-12 mt-4">
                        <h6 class="border-bottom pb-2">Informacion de Solicitud</h6>
                    </div>
                    <div class="col-md-6">
                        <strong>Solicitado por:</strong><br>
                        ${solicitante}
                    </div>
                    <div class="col-md-6">
                        <strong>Fecha de solicitud:</strong><br>
                        ${formatDate(solicitud.requested_at)}
                    </div>
                    ${solicitud.request_status === 'rejected' && solicitud.rejection_reason ? `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <strong>Motivo del rechazo:</strong><br>
                            ${solicitud.rejection_reason}
                        </div>
                    </div>` : ''}
                </div>
            `;
        }

        async function renderDetalleDeportiva(solicitud) {
            const trip = Array.isArray(solicitud.trip) ? solicitud.trip[0] : solicitud.trip;
            if (!trip) return '<p>No hay datos de la salida deportiva</p>';
        
            const team = trip.team;
            const disciplina = team?.discipline?.discipline_name || 'N/A';
            const categoria = team?.category?.category_name || 'N/A';
            const generoLabels = { male: 'Masculino', female: 'Femenino', mixed: 'Mixto' };
            const genero = generoLabels[team?.gender] || 'N/A';
            const destino = trip.destination?.destination_name || 'N/A';
            const solicitante = solicitud.solicitante ? `${solicitud.solicitante.worker_first_name} ${solicitud.solicitante.worker_last_name_1}` : 'Desconocido';
            const modalidadLabels = { outbound: 'Solo ida', 'return': 'Solo regreso', round_trip: 'Ida y regreso' };
            const modalidad = modalidadLabels[trip.transport_modality] || trip.transport_modality;
            const costoTransporte = trip.total_transport_value || 0;
            const costoRefrigerios = trip.total_catering_value || 0;
            const costoTotal = costoTransporte + costoRefrigerios;
        
            // Cargar nodos de transporte
            let nodesHTML = '';
            try {
                const nodes = await supabaseRequest(`/svc_trip_transport_nodes?select=node_role,node_order,svc_transport_nodes(node_name)&service_type=eq.sports_trip&trip_id=eq.${trip.trip_id}&order=node_role,node_order`);
                if (nodes && nodes.length > 0) {
                    const depNodes = nodes.filter(n => n.node_role === 'departure').map(n => n.svc_transport_nodes?.node_name).filter(Boolean);
                    const arrNodes = nodes.filter(n => n.node_role === 'arrival').map(n => n.svc_transport_nodes?.node_name).filter(Boolean);
                    if (depNodes.length > 0 || arrNodes.length > 0) {
                        nodesHTML = `
                            <div class="col-12">
                                <strong>Nodos de transporte:</strong><br>
                                ${depNodes.length > 0 ? '<em>Salida:</em> ' + depNodes.join(', ') + '<br>' : ''}
                                ${arrNodes.length > 0 ? '<em>Llegada:</em> ' + arrNodes.join(', ') : ''}
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.error('Error cargando nodos:', e);
            }
        
            // Cargar adultos acompa√±antes
            let adultosHTML = '';
            try {
                const adults = await supabaseRequest(`/svc_sports_trip_adults?select=workers(worker_first_name,worker_last_name_1,worker_last_name_2)&trip_id=eq.${trip.trip_id}`);
                if (adults && adults.length > 0) {
                    const nombres = adults.map(a => {
                        const w = a.workers;
                        return w ? `${w.worker_first_name} ${w.worker_last_name_1}${w.worker_last_name_2 ? ' ' + w.worker_last_name_2 : ''}` : '';
                    }).filter(Boolean).join(', ');
                    if (nombres) {
                        adultosHTML = `
                            <div class="col-12">
                                <strong>Adultos acompa√±antes:</strong><br>
                                ${nombres}
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.error('Error cargando adultos:', e);
            }
        
            // Refrigerios
            let cateringHTML = '';
            if (trip.catering_menu_id) {
                let menuName = 'N/A';
                try {
                    const menus = await supabaseRequest(`/svc_catering_menus?select=menu_name&menu_id=eq.${trip.catering_menu_id}`);
                    if (menus && menus.length > 0) menuName = menus[0].menu_name;
                } catch (e) { console.error(e); }
        
                cateringHTML = `
                    <div class="col-12 mt-3"><h6 class="border-bottom pb-2">Refrigerios</h6></div>
                    <div class="col-md-4">
                        <strong>Men√∫:</strong><br>${menuName}
                    </div>
                    <div class="col-md-4">
                        <strong>Cantidad:</strong><br>${trip.catering_quantity || 0} porciones
                    </div>
                    <div class="col-md-4">
                        <strong>Valor:</strong><br>${formatCurrency(costoRefrigerios)}
                    </div>
                `;
            }
        
            return `
                <div class="row g-3">
                    <div class="col-12">
                        <span class="badge bg-success mb-2">Salida Deportiva</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Nombre:</strong><br>${trip.trip_name}
                    </div>
                    <div class="col-md-6">
                        <strong>Estado de solicitud:</strong><br>${getBadgeEstadoSolicitud(solicitud.request_status)}
                    </div>
                    <div class="col-md-4">
                        <strong>Fecha:</strong><br>${formatDateLong(trip.trip_date)}
                    </div>
                    <div class="col-md-4">
                        <strong>Hora evento:</strong><br>${trip.event_time?.substring(0,5) || 'No especificada'}
                    </div>
                    <div class="col-md-4">
                        <strong>G√©nero:</strong><br>${genero}
                    </div>
                    <div class="col-md-6">
                        <strong>Disciplina:</strong><br>${disciplina}
                    </div>
                    <div class="col-md-6">
                        <strong>Categor√≠a:</strong><br>${categoria}
                    </div>
                    <div class="col-md-6">
                        <strong>Hora salida:</strong><br>${trip.departure_time?.substring(0,5) || 'N/A'}
                    </div>
                    <div class="col-md-6">
                        <strong>Hora regreso:</strong><br>${trip.return_time?.substring(0,5) || 'N/A'}
                    </div>
                    <div class="col-md-4">
                        <strong>Estudiantes:</strong><br>${trip.planned_students || 0}
                    </div>
                    <div class="col-md-4">
                        <strong>Adultos:</strong><br>${trip.num_adults || 0}
                    </div>
                    <div class="col-md-4">
                        <strong>Total participantes:</strong><br>${(trip.planned_students || 0) + (trip.num_adults || 0)}
                    </div>
                    ${adultosHTML}
                    <div class="col-12 mt-3"><h6 class="border-bottom pb-2">Transporte</h6></div>
                    <div class="col-md-4">
                        <strong>Destino tarifario:</strong><br>${destino}
                    </div>
                    <div class="col-md-4">
                        <strong>Destino espec√≠fico:</strong><br>${trip.specific_destination || 'N/A'}
                    </div>
                    <div class="col-md-4">
                        <strong>Modalidad:</strong><br>${modalidad}
                    </div>
                    <div class="col-md-4">
                        <strong>Veh√≠culos:</strong><br>${trip.frozen_vehicle_count || 0} √ó ${trip.frozen_vehicle_capacity || 0} pax
                    </div>
                    <div class="col-md-4">
                        <strong>Valor transporte:</strong><br>${formatCurrency(costoTransporte)}
                    </div>
                    ${nodesHTML}
                    ${cateringHTML}
                    <div class="col-12 mt-4"><h6 class="border-bottom pb-2">Costo Total</h6></div>
                    <div class="col-md-4">
                        <strong>Transporte:</strong><br>${formatCurrency(costoTransporte)}
                    </div>
                    <div class="col-md-4">
                        <strong>Refrigerios:</strong><br>${costoRefrigerios ? formatCurrency(costoRefrigerios) : 'No incluye'}
                    </div>
                    <div class="col-md-4">
                        <strong class="fs-5">TOTAL:</strong>
                        <span class="fs-4 text-primary fw-bold">${formatCurrency(costoTotal)}</span>
                    </div>
                    <div class="col-12 mt-4"><h6 class="border-bottom pb-2">Informaci√≥n de Solicitud</h6></div>
                    <div class="col-md-6">
                        <strong>Solicitado por:</strong><br>${solicitante}
                    </div>
                    <div class="col-md-6">
                        <strong>Fecha de solicitud:</strong><br>${formatDate(solicitud.requested_at)}
                    </div>
                    ${solicitud.request_status === 'rejected' && solicitud.rejection_reason ? `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <strong>Motivo del rechazo:</strong><br>
                            ${solicitud.rejection_reason}
                        </div>
                    </div>` : ''}
                </div>
            `;
        }
        
        async function renderDetalleEvento(solicitud) {
            const evento = Array.isArray(solicitud.evento) ? solicitud.evento[0] : solicitud.evento;
            if (!evento) return '<p>No hay datos del evento</p>';
            
            const solicitante = solicitud.solicitante ? `${solicitud.solicitante.worker_first_name} ${solicitud.solicitante.worker_last_name_1}` : 'Desconocido';
            
            // Cargar datos adicionales del evento
            let cateringHTML = '';
            let staffHTML = '';
            let servicesHTML = '';
            let costoTotal = 0;
            
            try {
                // Refrigerios
                const catering = await supabaseRequest(`/svc_internal_event_catering?event_id=eq.${evento.event_id}&select=*,menu:svc_catering_menus(menu_name)`);
                if (catering && catering.length > 0) {
                    cateringHTML = '<div class="col-12 mt-3"><h6 class="border-bottom pb-2">Refrigerios</h6></div>';
                    catering.forEach(item => {
                        const grupo = item.target_group === 'students' ? 'Estudiantes' : 'Adultos';
                        costoTotal += item.total_value || 0;
                        cateringHTML += `
                            <div class="col-md-6">
                                <strong>${grupo}:</strong><br>
                                ${item.menu?.menu_name || 'N/A'} x ${item.quantity} = ${formatCurrency(item.total_value)}
                            </div>
                        `;
                    });
                }
                
                // Personal de apoyo
                const staff = await supabaseRequest(`/svc_internal_event_support_staff?event_id=eq.${evento.event_id}&select=*`);
                if (staff && staff.length > 0) {
                    const staffLabels = {
                        'cleaning': 'Aseo', 'cafeteria': 'Cafeteria',
                        'maintenance': 'Mantenimiento', 'technology': 'Tecnologia'
                    };
                    staffHTML = '<div class="col-12 mt-3"><h6 class="border-bottom pb-2">Personal de Apoyo</h6></div>';
                    staff.forEach(item => {
                        staffHTML += `
                            <div class="col-md-3">
                                <strong>${staffLabels[item.area] || item.area}:</strong><br>
                                ${item.staff_count} persona(s)
                            </div>
                        `;
                    });
                }
                
                // Servicios de apoyo
                const services = await supabaseRequest(`/svc_internal_event_services?event_id=eq.${evento.event_id}&select=*`);
                if (services && services.length > 0) {
                    const serviceLabels = {
                        'staffing': 'Personal de Apoyo (Staffing)', 'communications': 'Comunicaciones',
                        'technology': 'Recursos Tecnologicos', 'site_organization': 'Organizacion del Sitio',
                        'resources': 'Recursos (Papeleria, Materiales)'
                    };
                    servicesHTML = '<div class="col-12 mt-3"><h6 class="border-bottom pb-2">Servicios de Apoyo</h6></div>';
                    services.forEach(svc => {
                        const costoRegistrado = svc.cost_value ? formatCurrency(svc.cost_value) : '<em class="text-muted">Pendiente de registro</em>';
                        if (svc.cost_value) costoTotal += svc.cost_value;
                        servicesHTML += `
                            <div class="col-12 mb-2">
                                <strong>${serviceLabels[svc.service_type] || svc.service_type}:</strong><br>
                                <span>${svc.description || 'Sin descripcion'}</span><br>
                                <small class="text-muted">Costo: ${costoRegistrado}</small>
                            </div>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error cargando detalles del evento:', error);
            }
            
            return `
                <div class="row g-3">
                    <div class="col-12">
                        <span class="badge bg-primary mb-2">Evento Interno</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Nombre del evento:</strong><br>
                        ${evento.event_name}
                    </div>
                    <div class="col-md-6">
                        <strong>Estado de solicitud:</strong><br>
                        ${getBadgeEstadoSolicitud(solicitud.request_status)}
                    </div>
                    <div class="col-md-6">
                        <strong>Fecha:</strong><br>
                        ${formatDateLong(evento.event_date)}
                    </div>
                    <div class="col-md-6">
                        <strong>Horario:</strong><br>
                        ${evento.start_time?.substring(0,5)} - ${evento.end_time?.substring(0,5)}
                    </div>
                    <div class="col-md-6">
                        <strong>Ubicacion:</strong><br>
                        ${evento.event_location || 'N/A'}
                    </div>
                    <div class="col-md-6">
                        <strong>Estado del evento:</strong><br>
                        ${getBadgeEstadoEvento(evento.event_status)}
                    </div>
                    <div class="col-md-4">
                        <strong>Estudiantes:</strong><br>
                        ${evento.num_students || 0}
                    </div>
                    <div class="col-md-4">
                        <strong>Adultos:</strong><br>
                        ${evento.num_adults || 0}
                    </div>
                    <div class="col-md-4">
                        <strong>Total participantes:</strong><br>
                        ${(evento.num_students || 0) + (evento.num_adults || 0)}
                    </div>
                    ${cateringHTML}
                    ${staffHTML}
                    ${servicesHTML}
                    <div class="col-12 mt-4">
                        <h6 class="border-bottom pb-2">Costo Estimado</h6>
                    </div>
                    <div class="col-12">
                        <strong class="fs-5">Total:</strong>
                        <span class="fs-4 text-primary fw-bold">${formatCurrency(costoTotal)}</span>
                        ${servicesHTML ? '<br><small class="text-muted"><em>* Algunos costos de servicios de apoyo pueden estar pendientes de registro</em></small>' : ''}
                    </div>
                    <div class="col-12 mt-4">
                        <h6 class="border-bottom pb-2">Informacion de Solicitud</h6>
                    </div>
                    <div class="col-md-6">
                        <strong>Solicitado por:</strong><br>
                        ${solicitante}
                    </div>
                    <div class="col-md-6">
                        <strong>Fecha de solicitud:</strong><br>
                        ${formatDate(solicitud.requested_at)}
                    </div>
                    ${solicitud.request_status === 'rejected' && solicitud.rejection_reason ? `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <strong>Motivo del rechazo:</strong><br>
                            ${solicitud.rejection_reason}
                        </div>
                    </div>` : ''}
                </div>
            `;
        }
        
        // ==================== FILTROS ====================
        function aplicarFiltros() {
            filtrosActivos = {
                tipo: document.getElementById('filtroTipo').value,
                estado: document.getElementById('filtroEstado').value,
                fechaDesde: document.getElementById('filtroFechaDesde').value,
                fechaHasta: document.getElementById('filtroFechaHasta').value,
                solicitante: document.getElementById('filtroSolicitante').value
            };
            
            cargarSolicitudes();
        }
        
        function limpiarFiltros() {
            document.getElementById('formFiltros').reset();
            document.getElementById('filtroTipo').value = '';
            document.getElementById('filtroEstado').value = 'pending';
            filtrosActivos = {
                tipo: '',
                estado: 'pending'
            };
            
            cargarSolicitudes();
        }
        
        // ==================== ESTAD√çSTICAS ====================
        function actualizarEstadisticas() {
            // Contar por estado (de todas las solicitudes del aprobador, no solo filtradas)
            const pendientes = solicitudesData.filter(s => s.request_status === 'pending').length;
            const aprobadas = solicitudesData.filter(s => s.request_status === 'approved').length;
            const rechazadas = solicitudesData.filter(s => s.request_status === 'rejected').length;
            
            document.getElementById('statsPendientes').textContent = pendientes;
            document.getElementById('statsAprobadas').textContent = aprobadas;
            document.getElementById('statsRechazadas').textContent = rechazadas;
        }
        
        function actualizarContador() {
            const total = solicitudesData.length;
            document.getElementById('contadorResultados').innerHTML = 
                `<i class="bi bi-list-ul me-1"></i>${total} solicitud${total !== 1 ? 'es' : ''} encontrada${total !== 1 ? 's' : ''}`;
        }
      // ==================== FUNCIONES AUXILIARES ====================
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatDateLong(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('es-CO', { 
                weekday: 'long',
                year: 'numeric', 
                month: 'long', 
                day: 'numeric'
            });
        }
        
        function formatCurrency(value) {
            if (!value && value !== 0) return 'N/A';
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(value);
        }
        
        function getBadgeEstadoSolicitud(estado) {
            const estados = {
                'pending': '<span class="badge bg-warning">Pendiente</span>',
                'approved': '<span class="badge bg-success">Aprobada</span>',
                'rejected': '<span class="badge bg-danger">Rechazada</span>'
            };
            return estados[estado] || '<span class="badge bg-secondary">Desconocido</span>';
        }
        
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>';
            }
        }
        
        function showMessage(message, type = 'info') {
            // Usar toasts de Bootstrap o SweetAlert si est√° disponible
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: type === 'danger' ? 'error' : type,
                    title: message,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
            } else if (typeof showToast === 'function') {
                showToast(message, type);
            } else {
                console.log(`[${type.toUpperCase()}] ${message}`);
                if (type === 'danger' || type === 'error') {
                    alert('Error: ' + message);
                } else if (type === 'warning') {
                    alert('Advertencia: ' + message);
                }
            }
        }
    </script>
</body>
</html>
  
