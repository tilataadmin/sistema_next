<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.08.07.45">
    <title>Aprobaciones de Servicios - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Configuraci√≥n global -->
    <script src="/assets/js/config.js"></script>
    
    <style>
        :root {
            --service-primary: #1B365D;
            --service-accent: #667eea;
        }
        
        .request-card {
            border-left: 4px solid #ffc107;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .request-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .request-card.approved {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        
        .request-card.rejected {
            border-left-color: #dc3545;
            background-color: #fff8f8;
        }
        
        .request-card.pending {
            border-left-color: #ffc107;
            background-color: #fffbf0;
        }
        
        .stats-card {
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.2s;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .stats-label {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.5rem;
        }
        
        .cost-breakdown {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .cost-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--service-primary);
        }
    </style>
</head>
<body>
  <!-- Contenedor principal -->
    <div class="container-fluid py-4">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html">Inicio</a></li>
                <li class="breadcrumb-item"><a href="index.html">Servicios</a></li>
                <li class="breadcrumb-item active" aria-current="page">Aprobaciones</li>
            </ol>
        </nav>
        
        <!-- Header -->
        <div class="mb-4">
            <h3 class="mb-1">
                <i class="bi bi-clipboard-check me-2"></i>Aprobaciones de Servicios
            </h3>
            <p class="text-muted mb-0">Bandeja de solicitudes asignadas a m√≠</p>
        </div>
        
        <!-- Estad√≠sticas -->
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="stats-card bg-warning bg-opacity-10 border border-warning">
                    <div class="stats-number text-warning" id="statsPendientes">0</div>
                    <div class="stats-label text-warning">Pendientes</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card bg-success bg-opacity-10 border border-success">
                    <div class="stats-number text-success" id="statsAprobadas">0</div>
                    <div class="stats-label text-success">Aprobadas</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card bg-danger bg-opacity-10 border border-danger">
                    <div class="stats-number text-danger" id="statsRechazadas">0</div>
                    <div class="stats-label text-danger">Rechazadas</div>
                </div>
            </div>
        </div>
      <!-- Panel de Filtros -->
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center cursor-pointer" 
                 data-bs-toggle="collapse" data-bs-target="#filtrosCollapse">
                <span><i class="bi bi-funnel me-2"></i>Filtros de b√∫squeda</span>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="collapse show" id="filtrosCollapse">
                <div class="card-body">
                    <form id="formFiltros">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Estado</label>
                                <select class="form-select" id="filtroEstado">
                                    <option value="pending">Solo pendientes</option>
                                    <option value="">Todos los estados</option>
                                    <option value="approved">Solo aprobadas</option>
                                    <option value="rejected">Solo rechazadas</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Fecha de salida (desde)</label>
                                <input type="date" class="form-control" id="filtroFechaDesde">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Fecha de salida (hasta)</label>
                                <input type="date" class="form-control" id="filtroFechaHasta">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Solicitante</label>
                                <select class="form-select" id="filtroSolicitante">
                                    <option value="">Todos los solicitantes</option>
                                    <!-- Se carga din√°micamente -->
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="button" class="btn btn-primary me-2" onclick="aplicarFiltros()">
                                    <i class="bi bi-search me-2"></i>Filtrar
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                                    <i class="bi bi-x-circle me-2"></i>Limpiar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Contador de resultados -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <span class="badge bg-secondary" id="contadorResultados">
                    <i class="bi bi-list-ul me-1"></i>0 solicitudes encontradas
                </span>
            </div>
        </div>
      <!-- Lista de Solicitudes -->
        <div id="listaSolicitudes">
            <!-- Se carga din√°micamente -->
        </div>
        
        <!-- Mensaje cuando no hay solicitudes -->
        <div id="mensajeVacio" style="display: none;">
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
                <h5 class="text-muted mt-3">No hay solicitudes para mostrar</h5>
                <p class="text-muted">Cambia los filtros para ver otras solicitudes</p>
            </div>
        </div>
        
    </div>
    
    <!-- ==================== MODAL: VER DETALLE ==================== -->
    <div class="modal fade" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-eye me-2"></i>Detalle de Solicitud
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="detalleContent">
                        <!-- Se carga din√°micamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== MODAL: RECHAZAR ==================== -->
    <div class="modal fade" id="modalRechazar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-x-circle me-2"></i>Rechazar Solicitud
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formRechazar">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Esta acci√≥n es irreversible.</strong> El solicitante ser√° notificado.
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Motivo del rechazo <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="motivoRechazo" rows="4" required
                                      placeholder="Explique claramente la raz√≥n del rechazo..."></textarea>
                        </div>
                        <input type="hidden" id="rechazarRequestId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarRechazo()">
                        <i class="bi bi-x-circle me-2"></i>Rechazar Solicitud
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
      // ==================== VARIABLES GLOBALES ====================
        let currentUser = null;
        let solicitudesData = [];
        let filtrosActivos = {
            estado: 'pending' // Por defecto mostrar pendientes
        };
        
        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando m√≥dulo de Aprobaciones...');
            
            try {
                // Verificar que config.js se haya cargado
                if (typeof validatePageAccess !== 'function') {
                    console.error('‚ùå Error: config.js no se carg√≥ correctamente');
                    alert('Error al cargar el m√≥dulo. Verifique que config.js est√© en la ruta correcta.');
                    return;
                }
                
                // Validar acceso
                const tieneAcceso = await validatePageAccess('Aprobaciones de servicios');
                if (!tieneAcceso) return;
                
                // Cargar colores corporativos
                if (typeof loadAndApplyBrandColors === 'function') {
                    await loadAndApplyBrandColors();
                }
                
                // Obtener usuario actual
                if (typeof getStoredSession === 'function') {
                    const session = getStoredSession();
                    if (session && session.user) {
                        currentUser = session.user;
                        console.log('üë§ Usuario actual:', currentUser.user_display_name || currentUser.user_name);
                        
                        // OBTENER WORKER_ID DEL USUARIO
                        const workerData = await supabaseRequest(`/workers?select=worker_id&user_id=eq.${currentUser.user_id}&limit=1`);
                        if (!workerData || workerData.length === 0) {
                            throw new Error('Este usuario no est√° vinculado a un trabajador en la tabla workers');
                        }
                        currentUser.worker_id = workerData[0].worker_id;
                        console.log('üë∑ Worker ID:', currentUser.worker_id);
                        
                    } else {
                        throw new Error('No se pudo obtener la sesi√≥n del usuario');
                    }
                } else {
                    throw new Error('getStoredSession no est√° disponible');
                }
                
                // Cargar solicitudes
                await cargarSolicitudes();
                
                console.log('‚úÖ M√≥dulo cargado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando m√≥dulo:', error);
                showMessage('Error al cargar el m√≥dulo: ' + error.message, 'danger');
            }
        });
      // ==================== CARGAR SOLICITUDES ====================
        async function cargarSolicitudes() {
            try {
                showLoading('listaSolicitudes');
                
                // Construir query: Solo solicitudes donde el usuario actual es el aprobador
                let query = `/svc_service_requests?select=*,trip:svc_pedagogical_trips(*,grades:svc_pedagogical_trip_grades(grade:grades(grade_name)),destination:svc_transport_destinations(destination_name)),solicitante:workers!svc_service_requests_requested_by_fkey(worker_first_name,worker_last_name_1,worker_last_name_2)&service_type=eq.pedagogical_trip&approver_id=eq.${currentUser.worker_id}`;
                
                // Aplicar filtros
                if (filtrosActivos.estado) {
                    query += `&request_status=eq.${filtrosActivos.estado}`;
                }
                
                // Ordenar por fecha de creaci√≥n (m√°s recientes primero)
                query += '&order=created_at.desc';
                
                const solicitudes = await supabaseRequest(query);
                solicitudesData = solicitudes || [];
                
                // Filtrar por fecha de salida (client-side porque es campo anidado)
                if (filtrosActivos.fechaDesde) {
                    solicitudesData = solicitudesData.filter(s => 
                        s.trip?.trip_date >= filtrosActivos.fechaDesde
                    );
                }
                if (filtrosActivos.fechaHasta) {
                    solicitudesData = solicitudesData.filter(s => 
                        s.trip?.trip_date <= filtrosActivos.fechaHasta
                    );
                }
                
                // Filtrar por solicitante
                if (filtrosActivos.solicitante) {
                    solicitudesData = solicitudesData.filter(s => 
                        s.requested_by === filtrosActivos.solicitante
                    );
                }
                
                // Cargar lista de solicitantes √∫nicos para el filtro
                const solicitantesUnicos = [...new Set(solicitudes.map(s => s.requested_by))];
                await cargarFiltroSolicitantes(solicitantesUnicos);
                
                // Renderizar
                renderizarSolicitudes();
                actualizarEstadisticas();
                actualizarContador();
                
            } catch (error) {
                console.error('‚ùå Error cargando solicitudes:', error);
                showMessage('Error al cargar las solicitudes', 'danger');
                document.getElementById('listaSolicitudes').innerHTML = 
                    '<div class="alert alert-danger">Error al cargar datos</div>';
            }
        }
        
        // ==================== CARGAR FILTRO SOLICITANTES ====================
        async function cargarFiltroSolicitantes(solicitantesIds) {
            const select = document.getElementById('filtroSolicitante');
            
            if (!solicitantesIds || solicitantesIds.length === 0) {
                select.innerHTML = '<option value="">Todos los solicitantes</option>';
                return;
            }
            
            try {
                // Obtener nombres de los solicitantes
                const workers = await supabaseRequest(`/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2&worker_id=in.(${solicitantesIds.join(',')})`);

                select.innerHTML = '<option value="">Todos los solicitantes</option>' +
                    workers.map(w => 
                        `<option value="${w.worker_id}">${w.worker_first_name} ${w.worker_last_name_1}</option>`
                    ).join('');
            } catch (error) {
                console.error('Error cargando solicitantes:', error);
            }
        }
      // ==================== RENDERIZAR SOLICITUDES ====================
        function renderizarSolicitudes() {
            const container = document.getElementById('listaSolicitudes');
            const mensajeVacio = document.getElementById('mensajeVacio');
            
            if (solicitudesData.length === 0) {
                container.innerHTML = '';
                mensajeVacio.style.display = 'block';
                return;
            }
            
            mensajeVacio.style.display = 'none';
            
            const html = solicitudesData.map(solicitud => {
                const trip = solicitud.trip;
                if (!trip) return ''; // Skip si no hay datos de la salida
                
                const grados = trip.grades?.map(g => g.grade?.grade_name).filter(Boolean).join(', ') || 'N/A';
                const destino = trip.destination?.destination_name || 'N/A';
                const solicitante = solicitud.solicitante ? `${solicitud.solicitante.worker_first_name} ${solicitud.solicitante.worker_last_name_1}` : 'Desconocido';
                const fechaSolicitud = formatDate(solicitud.requested_at);
                const fechaSalida = formatDateLong(trip.trip_date);
                
                const totalParticipantes = (trip.planned_students || 0) + (trip.num_adults || 0);
                
                const costoTransporte = trip.total_transport_value || 0;
                const costoRefrigerios = trip.total_catering_value || 0;
                const costoEntradas = trip.total_entrance_value || 0;
                const costoTotal = costoTransporte + costoRefrigerios + costoEntradas;
                
                const estadoClass = solicitud.request_status === 'approved' ? 'approved' : 
                                   solicitud.request_status === 'rejected' ? 'rejected' : 'pending';
                
                const badgeEstado = getBadgeEstadoSolicitud(solicitud.request_status);
                
                // Botones seg√∫n estado
                let botonesAccion = '';
                if (solicitud.request_status === 'pending') {
                    botonesAccion = `
                        <button class="btn btn-success me-2" onclick="aprobarSolicitud('${solicitud.request_id}')">
                            <i class="bi bi-check-circle me-1"></i>Aprobar
                        </button>
                        <button class="btn btn-danger me-2" onclick="mostrarModalRechazar('${solicitud.request_id}')">
                            <i class="bi bi-x-circle me-1"></i>Rechazar
                        </button>
                    `;
                }
                
                return `
                    <div class="card request-card ${estadoClass} mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h5 class="card-title mb-1">
                                                <i class="bi bi-backpack3 me-2"></i>${destino}
                                            </h5>
                                            <p class="text-muted mb-0">
                                                <small>
                                                    <i class="bi bi-calendar3 me-1"></i>${fechaSalida}
                                                    <span class="mx-2">‚Ä¢</span>
                                                    <i class="bi bi-people me-1"></i>${grados}
                                                </small>
                                            </p>
                                        </div>
                                        <div>
                                            ${badgeEstado}
                                        </div>
                                    </div>
                                    
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-6">
                                            <small class="text-muted">Participantes:</small><br>
                                            <strong>${trip.planned_students || 0} estudiantes + ${trip.num_adults || 0} adultos = ${totalParticipantes} total</strong>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted">Solicitado por:</small><br>
                                            <strong>${solicitante}</strong>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <small class="text-muted">Descripci√≥n:</small><br>
                                        <span>${trip.trip_description || 'Sin descripci√≥n'}</span>
                                    </div>
                                    
                                    <small class="text-muted">
                                        <i class="bi bi-clock me-1"></i>Solicitado el ${fechaSolicitud}
                                    </small>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="cost-breakdown">
                                        <h6 class="mb-3">
                                            <i class="bi bi-calculator me-2"></i>Costos
                                        </h6>
                                        <div class="cost-item">
                                            <span>Transporte:</span>
                                            <span>${formatCurrency(costoTransporte)}</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Refrigerios:</span>
                                            <span>${costoRefrigerios > 0 ? formatCurrency(costoRefrigerios) : 'No incluye'}</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Entradas:</span>
                                            <span>${costoEntradas > 0 ? formatCurrency(costoEntradas) : 'No incluye'}</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>TOTAL:</span>
                                            <span class="text-primary">${formatCurrency(costoTotal)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${solicitud.request_status === 'rejected' && solicitud.rejection_reason ? `
                                <div class="alert alert-danger mb-0 mt-3">
                                    <strong>Motivo del rechazo:</strong><br>
                                    ${solicitud.rejection_reason}
                                </div>
                            ` : ''}
                            
                            <div class="mt-3 d-flex justify-content-end gap-2">
                                <button class="btn btn-outline-info" onclick="verDetalleSolicitud('${solicitud.request_id}')">
                                    <i class="bi bi-eye me-1"></i>Ver detalle completo
                                </button>
                                ${botonesAccion}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
      // ==================== APROBAR SOLICITUD ====================
        async function aprobarSolicitud(requestId) {
            // Confirmaci√≥n
            if (!confirm('¬øEst√° seguro de aprobar esta solicitud?')) return;
            
            try {
                showLoading('listaSolicitudes');
                
                // Actualizar estado en base de datos
                await supabaseRequest(`/svc_service_requests?request_id=eq.${requestId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        request_status: 'approved',
                        resolved_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                });
                
                // Obtener datos completos de la solicitud para notificaci√≥n
                const solicitud = solicitudesData.find(s => s.request_id === requestId);
                
                if (solicitud) {
                    await enviarNotificacionAprobacion(solicitud, true);
                }
                
                showMessage('‚úÖ Solicitud aprobada correctamente', 'success');
                
                // Recargar solicitudes
                await cargarSolicitudes();
                
            } catch (error) {
                console.error('‚ùå Error aprobando solicitud:', error);
                showMessage('Error al aprobar la solicitud', 'danger');
                await cargarSolicitudes(); // Recargar de todos modos
            }
        }
        
        // ==================== MOSTRAR MODAL RECHAZAR ====================
        function mostrarModalRechazar(requestId) {
            document.getElementById('rechazarRequestId').value = requestId;
            document.getElementById('motivoRechazo').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('modalRechazar'));
            modal.show();
        }
        
        // ==================== CONFIRMAR RECHAZO ====================
        async function confirmarRechazo() {
            const requestId = document.getElementById('rechazarRequestId').value;
            const motivo = document.getElementById('motivoRechazo').value.trim();
            
            if (!motivo) {
                showMessage('Debe especificar un motivo de rechazo', 'warning');
                return;
            }
            
            try {
                showLoading('listaSolicitudes');
                
                // Actualizar estado en base de datos
                await supabaseRequest(`/svc_service_requests?request_id=eq.${requestId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        request_status: 'rejected',
                        rejection_reason: motivo,
                        resolved_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                });
                
                // Obtener datos completos de la solicitud para notificaci√≥n
                const solicitud = solicitudesData.find(s => s.request_id === requestId);
                
                if (solicitud) {
                    await enviarNotificacionAprobacion(solicitud, false, motivo);
                }
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalRechazar'));
                if (modal) modal.hide();
                
                showMessage('Solicitud rechazada. El solicitante ha sido notificado.', 'info');
                
                // Recargar solicitudes
                await cargarSolicitudes();
                
            } catch (error) {
                console.error('‚ùå Error rechazando solicitud:', error);
                showMessage('Error al rechazar la solicitud', 'danger');
                await cargarSolicitudes(); // Recargar de todos modos
            }
        }
      // ==================== ENVIAR NOTIFICACIONES ====================
        async function enviarNotificacionAprobacion(solicitud, esAprobada, motivoRechazo = null) {
            try {
                console.log('üìß Enviando notificaciones...', esAprobada ? 'APROBADA' : 'RECHAZADA');
                
                const trip = solicitud.trip;
                if (!trip) {
                    console.warn('‚ö†Ô∏è No hay datos de la salida para notificar');
                    return;
                }
                
                // Obtener email del solicitante
                const solicitante = await supabaseRequest(`/workers?select=email,worker_first_name,worker_last_name_1,worker_last_name_2&worker_id=eq.${solicitud.requested_by}`);
                const emailSolicitante = solicitante?.[0]?.email;
                const nombreSolicitante = solicitante?.[0] ? `${solicitante[0].worker_first_name} ${solicitante[0].worker_last_name_1}` : 'Usuario';

                
                if (!emailSolicitante) {
                    console.warn('‚ö†Ô∏è No se encontr√≥ email del solicitante');
                }
                
                // Obtener email de coordinaci√≥n de servicios desde configuraci√≥n
                const configEmail = await supabaseRequest(`/svc_module_config?select=config_value&config_key=eq.email_services_coordination`);
                const emailCoordinacion = configEmail?.[0]?.config_value;
                
                if (!emailCoordinacion) {
                    console.warn('‚ö†Ô∏è No se encontr√≥ email de coordinaci√≥n de servicios');
                }
                
                // Datos de la salida
                const destino = trip.destination?.destination_name || 'Destino no especificado';
                const grados = trip.grades?.map(g => g.grade?.grade_name).filter(Boolean).join(', ') || 'N/A';
                const fechaSalida = formatDateLong(trip.trip_date);
                const aprobador = currentUser.user_display_name || currentUser.user_name;
                
                // Construir asunto y contenido seg√∫n estado
                let asunto, htmlContent;
                
                if (esAprobada) {
                    // SOLICITUD APROBADA
                    asunto = `Solicitud Aprobada: Salida Pedagogica - ${destino}`;
                    
                    htmlContent = `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;">
                            <div style="background-color: #28a745; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                                <h1 style="margin: 0; font-size: 24px;">Solicitud Aprobada</h1>
                            </div>
                            
                            <div style="background-color: white; padding: 30px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <p style="font-size: 16px; color: #333; margin-bottom: 20px;">
                                    Hola <strong>${nombreSolicitante}</strong>,
                                </p>
                                
                                <div style="background-color: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                                    <p style="margin: 0; color: #155724; font-size: 16px; font-weight: bold;">
                                        Tu solicitud de salida pedagogica ha sido APROBADA
                                    </p>
                                </div>
                                
                                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                                    <h3 style="color: #1b365d; margin-top: 0; margin-bottom: 15px; font-size: 18px;">Detalles de la Salida</h3>
                                    
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr>
                                            <td style="padding: 8px 0; color: #666; font-weight: bold;">Destino:</td>
                                            <td style="padding: 8px 0; color: #333;">${destino}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px 0; color: #666; font-weight: bold;">Fecha:</td>
                                            <td style="padding: 8px 0; color: #333;">${fechaSalida}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px 0; color: #666; font-weight: bold;">Grados:</td>
                                            <td style="padding: 8px 0; color: #333;">${grados}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px 0; color: #666; font-weight: bold;">Aprobado por:</td>
                                            <td style="padding: 8px 0; color: #333;">${aprobador}</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div style="background-color: #cfe2ff; border-left: 4px solid #0d6efd; padding: 15px; border-radius: 4px; margin-top: 20px;">
                                    <p style="margin: 0; color: #084298; font-size: 14px;">
                                        <strong>Proximos pasos:</strong><br>
                                        Puedes continuar con la gestion de la salida en el modulo de <strong>Salidas Pedagogicas</strong> en SchoolNet.
                                    </p>
                                </div>
                                
                                <p style="font-size: 12px; color: #999; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center;">
                                    Este es un mensaje automatico del sistema SchoolNet.<br>
                                    Por favor, no responder a este correo.
                                </p>
                            </div>
                        </div>
                    `;
                    
                } else {
                    // SOLICITUD RECHAZADA
                    asunto = `Solicitud Rechazada: Salida Pedagogica - ${destino}`;
                    
                    htmlContent = `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;">
                            <div style="background-color: #dc3545; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                                <h1 style="margin: 0; font-size: 24px;">Solicitud Rechazada</h1>
                            </div>
                            
                            <div style="background-color: white; padding: 30px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <p style="font-size: 16px; color: #333; margin-bottom: 20px;">
                                    Hola <strong>${nombreSolicitante}</strong>,
                                </p>
                                
                                <div style="background-color: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                                    <p style="margin: 0; color: #721c24; font-size: 16px; font-weight: bold;">
                                        Tu solicitud de salida pedagogica ha sido RECHAZADA
                                    </p>
                                </div>
                                
                                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                                    <h3 style="color: #1b365d; margin-top: 0; margin-bottom: 15px; font-size: 18px;">Detalles de la Salida</h3>
                                    
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr>
                                            <td style="padding: 8px 0; color: #666; font-weight: bold;">Destino:</td>
                                            <td style="padding: 8px 0; color: #333;">${destino}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px 0; color: #666; font-weight: bold;">Fecha:</td>
                                            <td style="padding: 8px 0; color: #333;">${fechaSalida}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px 0; color: #666; font-weight: bold;">Grados:</td>
                                            <td style="padding: 8px 0; color: #333;">${grados}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px 0; color: #666; font-weight: bold;">Rechazado por:</td>
                                            <td style="padding: 8px 0; color: #333;">${aprobador}</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                                    <p style="margin: 0 0 10px 0; color: #856404; font-weight: bold;">Motivo del rechazo:</p>
                                    <p style="margin: 0; color: #856404;">${motivoRechazo || 'No especificado'}</p>
                                </div>
                                
                                <div style="background-color: #cfe2ff; border-left: 4px solid #0d6efd; padding: 15px; border-radius: 4px;">
                                    <p style="margin: 0; color: #084298; font-size: 14px;">
                                        <strong>Que puedes hacer?</strong><br>
                                        Si tienes dudas sobre el motivo del rechazo, puedes contactar al aprobador o crear una nueva solicitud con los ajustes necesarios.
                                    </p>
                                </div>
                                
                                <p style="font-size: 12px; color: #999; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center;">
                                    Este es un mensaje automatico del sistema SchoolNet.<br>
                                    Por favor, no responder a este correo.
                                </p>
                            </div>
                        </div>
                    `;
                }
                
                // Enviar a solicitante
                if (emailSolicitante) {
                    await sendNotification(emailSolicitante, asunto, htmlContent, true);
                    console.log('‚úÖ Notificaci√≥n enviada al solicitante:', emailSolicitante);
                }
                
                // Enviar a coordinaci√≥n de servicios
                if (emailCoordinacion) {
                    await sendNotification(emailCoordinacion, asunto, htmlContent, true);
                    console.log('‚úÖ Notificaci√≥n enviada a coordinaci√≥n:', emailCoordinacion);
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error enviando notificaciones:', error);
                return false;
            }
        }
      // ==================== VER DETALLE SOLICITUD ====================
        async function verDetalleSolicitud(requestId) {
            try {
                const solicitud = solicitudesData.find(s => s.request_id === requestId);
                
                if (!solicitud || !solicitud.trip) {
                    showMessage('No se encontr√≥ la solicitud', 'danger');
                    return;
                }
                
                const trip = solicitud.trip;
                const grados = trip.grades?.map(g => g.grade?.grade_name).filter(Boolean).join(', ') || 'N/A';
                const destino = trip.destination?.destination_name || 'N/A';
                const solicitante = solicitud.solicitante ? `${solicitud.solicitante.worker_first_name} ${solicitud.solicitante.worker_last_name_1}` : 'Desconocido';
                
                const detalleHTML = `
                    <div class="row g-3">
                        <div class="col-md-6">
                            <strong>Fecha de salida:</strong><br>
                            ${formatDateLong(trip.trip_date)}
                        </div>
                        <div class="col-md-6">
                            <strong>Estado de solicitud:</strong><br>
                            ${getBadgeEstadoSolicitud(solicitud.request_status)}
                        </div>
                        <div class="col-md-6">
                            <strong>Grados:</strong><br>
                            ${grados}
                        </div>
                        <div class="col-md-6">
                            <strong>Destino:</strong><br>
                            ${destino}
                        </div>
                        <div class="col-md-6">
                            <strong>Hora salida:</strong><br>
                            ${trip.departure_time || 'N/A'}
                        </div>
                        <div class="col-md-6">
                            <strong>Hora regreso:</strong><br>
                            ${trip.return_time || 'N/A'}
                        </div>
                        <div class="col-12">
                            <strong>Descripcion:</strong><br>
                            ${trip.trip_description || 'N/A'}
                        </div>
                        ${trip.inquiry_unit ? `
                        <div class="col-12">
                            <strong>Unidad de indagacion:</strong><br>
                            ${trip.inquiry_unit}
                        </div>
                        ` : ''}
                        ${trip.observations ? `
                        <div class="col-12">
                            <strong>Observaciones:</strong><br>
                            ${trip.observations}
                        </div>
                        ` : ''}
                        <div class="col-md-4">
                            <strong>Estudiantes:</strong><br>
                            ${trip.planned_students || 0}
                        </div>
                        <div class="col-md-4">
                            <strong>Adultos:</strong><br>
                            ${trip.num_adults || 0}
                        </div>
                        <div class="col-md-4">
                            <strong>Total participantes:</strong><br>
                            ${(trip.planned_students || 0) + (trip.num_adults || 0)}
                        </div>
                        ${trip.accompanying_adults ? `
                        <div class="col-12">
                            <strong>Adultos acompanantes:</strong><br>
                            ${trip.accompanying_adults}
                        </div>
                        ` : ''}
                        
                        <div class="col-12 mt-4">
                            <h6 class="border-bottom pb-2">Costos</h6>
                        </div>
                        <div class="col-md-4">
                            <strong>Transporte:</strong><br>
                            ${formatCurrency(trip.total_transport_value || 0)}
                        </div>
                        <div class="col-md-4">
                            <strong>Refrigerios:</strong><br>
                            ${trip.total_catering_value ? formatCurrency(trip.total_catering_value) : 'No incluye'}
                        </div>
                        <div class="col-md-4">
                            <strong>Entradas:</strong><br>
                            ${trip.total_entrance_value ? formatCurrency(trip.total_entrance_value) : 'No incluye'}
                        </div>
                        <div class="col-12">
                            <strong class="fs-5">Costo Total:</strong>
                            <span class="fs-4 text-primary fw-bold">${formatCurrency((trip.total_transport_value || 0) + (trip.total_catering_value || 0) + (trip.total_entrance_value || 0))}</span>
                        </div>
                        
                        <div class="col-12 mt-4">
                            <h6 class="border-bottom pb-2">Informacion de Solicitud</h6>
                        </div>
                        <div class="col-md-6">
                            <strong>Solicitado por:</strong><br>
                            ${solicitante}
                        </div>
                        <div class="col-md-6">
                            <strong>Fecha de solicitud:</strong><br>
                            ${formatDate(solicitud.requested_at)}
                        </div>
                        
                        ${solicitud.request_status === 'rejected' && solicitud.rejection_reason ? `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                <strong>Motivo del rechazo:</strong><br>
                                ${solicitud.rejection_reason}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('detalleContent').innerHTML = detalleHTML;
                const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
                modal.show();
                
            } catch (error) {
                console.error('Error al ver detalle:', error);
                showMessage('Error al cargar los detalles', 'danger');
            }
        }
        
        // ==================== FILTROS ====================
        function aplicarFiltros() {
            filtrosActivos = {
                estado: document.getElementById('filtroEstado').value,
                fechaDesde: document.getElementById('filtroFechaDesde').value,
                fechaHasta: document.getElementById('filtroFechaHasta').value,
                solicitante: document.getElementById('filtroSolicitante').value
            };
            
            cargarSolicitudes();
        }
        
        function limpiarFiltros() {
            document.getElementById('formFiltros').reset();
            document.getElementById('filtroEstado').value = 'pending'; // Volver al default
            filtrosActivos = {
                estado: 'pending'
            };
            
            cargarSolicitudes();
        }
        
        // ==================== ESTAD√çSTICAS ====================
        function actualizarEstadisticas() {
            // Contar por estado (de todas las solicitudes del aprobador, no solo filtradas)
            const pendientes = solicitudesData.filter(s => s.request_status === 'pending').length;
            const aprobadas = solicitudesData.filter(s => s.request_status === 'approved').length;
            const rechazadas = solicitudesData.filter(s => s.request_status === 'rejected').length;
            
            document.getElementById('statsPendientes').textContent = pendientes;
            document.getElementById('statsAprobadas').textContent = aprobadas;
            document.getElementById('statsRechazadas').textContent = rechazadas;
        }
        
        function actualizarContador() {
            const total = solicitudesData.length;
            document.getElementById('contadorResultados').innerHTML = 
                `<i class="bi bi-list-ul me-1"></i>${total} solicitud${total !== 1 ? 'es' : ''} encontrada${total !== 1 ? 's' : ''}`;
        }
      // ==================== FUNCIONES AUXILIARES ====================
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatDateLong(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('es-CO', { 
                weekday: 'long',
                year: 'numeric', 
                month: 'long', 
                day: 'numeric'
            });
        }
        
        function formatCurrency(value) {
            if (!value && value !== 0) return 'N/A';
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(value);
        }
        
        function getBadgeEstadoSolicitud(estado) {
            const estados = {
                'pending': '<span class="badge bg-warning">Pendiente</span>',
                'approved': '<span class="badge bg-success">Aprobada</span>',
                'rejected': '<span class="badge bg-danger">Rechazada</span>'
            };
            return estados[estado] || '<span class="badge bg-secondary">Desconocido</span>';
        }
        
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>';
            }
        }
        
        function showMessage(message, type = 'info') {
            // Usar toasts de Bootstrap o SweetAlert si est√° disponible
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: type === 'danger' ? 'error' : type,
                    title: message,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
            } else if (typeof showToast === 'function') {
                showToast(message, type);
            } else {
                console.log(`[${type.toUpperCase()}] ${message}`);
                if (type === 'danger' || type === 'error') {
                    alert('Error: ' + message);
                } else if (type === 'warning') {
                    alert('Advertencia: ' + message);
                }
            }
        }
    </script>
</body>
</html>
  
