<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.07.22.00">
    <title>Equipos Deportivos - SchoolNet</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .loading-overlay.hidden { display: none; }
        .loading-content { background: white; padding: 2rem; border-radius: 8px; text-align: center; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #0d9488; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn-teal { background-color: #0d9488; border-color: #0d9488; color: #fff; }
        .btn-teal:hover { background-color: #0f766e; border-color: #0f766e; color: #fff; }
        .btn-outline-teal { color: #0d9488; border-color: #0d9488; }
        .btn-outline-teal:hover { background-color: #0d9488; color: #fff; }

        .badge-active { background-color: #d1fae5; color: #065f46; }
        .badge-inactive { background-color: #fee2e2; color: #991b1b; }
        .badge-male { background-color: #dbeafe; color: #1e40af; }
        .badge-female { background-color: #fce7f3; color: #9d174d; }
        .badge-mixed { background-color: #e0e7ff; color: #3730a3; }

        .table th { font-size: 0.85rem; white-space: nowrap; }
        .table td { vertical-align: middle; font-size: 0.9rem; }
        .empty-state { text-align: center; padding: 3rem 1rem; color: #6c757d; }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; display: block; }

        .catalog-table th, .catalog-table td { font-size: 0.85rem; padding: 0.5rem 0.75rem; }

        /* Panel de integrantes */
        .members-panel { background: #f8f9fa; border-radius: 8px; padding: 1.25rem; margin-top: 1rem; }
        .member-row { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef; }
        .member-row:last-child { border-bottom: none; }
        .member-info { display: flex; align-items: center; gap: 0.75rem; }

        /* Buscador de estudiantes */
        .search-results { max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; background: white; }
        .search-result-item { padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .search-result-item:hover { background-color: #ccfbf1; }
        .search-result-item:last-child { border-bottom: none; }

        .team-row { cursor: pointer; }
        .team-row:hover { background-color: #f0fdfa !important; }
        .team-row.selected { background-color: #ccfbf1 !important; }

        .count-badge { background-color: #0d9488; color: white; font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 1rem; }
    </style>
</head>

<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando equipos deportivos...</p>
        </div>
    </div>

    <div class="container-fluid">

        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a></li>
                <li class="breadcrumb-item"><a href="index.html">Servicios y Eventos</a></li>
                <li class="breadcrumb-item active" aria-current="page">Equipos Deportivos</li>
            </ol>
        </nav>

        <!-- HEADER -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-trophy me-2" style="color: #0d9488;"></i>
                    Equipos Deportivos
                </h1>
                <p class="text-muted">Disciplinas, categorías, equipos e integrantes.</p>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- ============================================================ -->
        <!-- CATÁLOGOS COLAPSABLES -->
        <!-- ============================================================ -->
        <div class="accordion mb-4" id="accordionCatalogos">

            <!-- DISCIPLINAS -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-disciplinas">
                        <i class="bi bi-dribbble me-2"></i>Disciplinas Deportivas
                        <span class="ms-2 count-badge" id="count-disciplinas">0</span>
                    </button>
                </h2>
                <div id="collapse-disciplinas" class="accordion-collapse collapse" data-bs-parent="#accordionCatalogos">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-end mb-2">
                            <button class="btn btn-teal btn-sm" onclick="abrirModalDisciplina()">
                                <i class="bi bi-plus-circle me-1"></i>Nueva Disciplina
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm catalog-table mb-0">
                                <thead class="table-light">
                                    <tr><th>Nombre</th><th>Estado</th><th class="text-end">Acciones</th></tr>
                                </thead>
                                <tbody id="tbody-disciplinas"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CATEGORÍAS -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-categorias">
                        <i class="bi bi-tags me-2"></i>Categorías
                        <span class="ms-2 count-badge" id="count-categorias">0</span>
                    </button>
                </h2>
                <div id="collapse-categorias" class="accordion-collapse collapse" data-bs-parent="#accordionCatalogos">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-end mb-2">
                            <button class="btn btn-teal btn-sm" onclick="abrirModalCategoria()">
                                <i class="bi bi-plus-circle me-1"></i>Nueva Categoría
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm catalog-table mb-0">
                                <thead class="table-light">
                                    <tr><th class="text-center">Orden</th><th>Nombre</th><th>Estado</th><th class="text-end">Acciones</th></tr>
                                </thead>
                                <tbody id="tbody-categorias"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- EQUIPOS — SECCIÓN PRINCIPAL -->
        <!-- ============================================================ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="mb-0"><i class="bi bi-people me-2"></i>Equipos</h5>
                <div class="d-flex gap-2 flex-wrap">
                    <select class="form-select form-select-sm" id="filtro-disciplina" style="width: auto;" onchange="renderEquipos()">
                        <option value="">Todas las disciplinas</option>
                    </select>
                    <select class="form-select form-select-sm" id="filtro-categoria" style="width: auto;" onchange="renderEquipos()">
                        <option value="">Todas las categorías</option>
                    </select>
                    <button class="btn btn-teal btn-sm" onclick="abrirModalEquipo()">
                        <i class="bi bi-plus-circle me-1"></i>Nuevo Equipo
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Disciplina</th>
                                <th>Categoría</th>
                                <th>Género</th>
                                <th>Entrenador</th>
                                <th class="text-center">Integrantes</th>
                                <th>Estado</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-equipos"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- PANEL DE INTEGRANTES (se muestra al seleccionar equipo) -->
        <!-- ============================================================ -->
        <div class="card mb-4 d-none" id="panel-integrantes">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-person-lines-fill me-2"></i>
                    Integrantes — <span id="titulo-equipo-seleccionado"></span>
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="cerrarPanelIntegrantes()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="card-body">
                <!-- Buscador para agregar -->
                <div class="row mb-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label fw-semibold">Agregar estudiante</label>
                        <input type="text" class="form-control" id="buscar-estudiante" placeholder="Escribir nombre del estudiante..." oninput="buscarEstudiantes()">
                        <div id="resultados-busqueda" class="search-results d-none mt-1"></div>
                    </div>
                </div>

                <!-- Lista de integrantes actuales -->
                <h6 class="text-secondary mb-2">Integrantes actuales <span class="count-badge" id="count-integrantes">0</span></h6>
                <div id="lista-integrantes">
                    <div class="text-muted text-center py-3">Selecciona un equipo para ver sus integrantes</div>
                </div>
            </div>
        </div>

    </div><!-- /container -->

    <!-- ================================================================= -->
    <!-- MODAL DISCIPLINA -->
    <!-- ================================================================= -->
    <div class="modal fade" id="modal-disciplina" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-disciplina-title"><i class="bi bi-dribbble me-2"></i>Nueva Disciplina</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-disciplina" onsubmit="guardarDisciplina(event)">
                    <div class="modal-body">
                        <input type="hidden" id="disciplina-id">
                        <div class="mb-3">
                            <label class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="disciplina-nombre" required>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="disciplina-activo" checked>
                            <label class="form-check-label" for="disciplina-activo">Activa</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-teal btn-sm">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ================================================================= -->
    <!-- MODAL CATEGORÍA -->
    <!-- ================================================================= -->
    <div class="modal fade" id="modal-categoria" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-categoria-title"><i class="bi bi-tags me-2"></i>Nueva Categoría</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-categoria" onsubmit="guardarCategoria(event)">
                    <div class="modal-body">
                        <input type="hidden" id="categoria-id">
                        <div class="mb-3">
                            <label class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="categoria-nombre" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Orden</label>
                            <input type="number" class="form-control" id="categoria-orden" min="1">
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="categoria-activo" checked>
                            <label class="form-check-label" for="categoria-activo">Activa</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-teal btn-sm">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ================================================================= -->
    <!-- MODAL EQUIPO -->
    <!-- ================================================================= -->
    <div class="modal fade" id="modal-equipo" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-equipo-title"><i class="bi bi-people me-2"></i>Nuevo Equipo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-equipo" onsubmit="guardarEquipo(event)">
                    <div class="modal-body">
                        <input type="hidden" id="equipo-id">
                        <div class="mb-3">
                            <label class="form-label">Disciplina <span class="text-danger">*</span></label>
                            <select class="form-select" id="equipo-disciplina" required>
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Categoría <span class="text-danger">*</span></label>
                            <select class="form-select" id="equipo-categoria" required>
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Género <span class="text-danger">*</span></label>
                            <select class="form-select" id="equipo-genero" required>
                                <option value="">Seleccionar...</option>
                                <option value="male">Masculino</option>
                                <option value="female">Femenino</option>
                                <option value="mixed">Mixto</option>
                            </select>
                        </div>
                        <hr>
                        <h6 class="text-secondary">Entrenador externo (opcional)</h6>
                        <div class="mb-3">
                            <label class="form-label">Nombre del entrenador</label>
                            <input type="text" class="form-control" id="equipo-coach-nombre">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contacto</label>
                            <input type="text" class="form-control" id="equipo-coach-contacto" placeholder="Teléfono o correo">
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="equipo-activo" checked>
                            <label class="form-check-label" for="equipo-activo">Activo</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-teal">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let cacheDisciplinas = [];
        let cacheCategorias = [];
        let cacheEquipos = [];
        let cacheIntegrantes = [];
        let equipoSeleccionado = null;
        let timeoutBusqueda = null;

        let modalDisciplina, modalCategoria, modalEquipo;

        const GENERO_LABELS = { male: 'Masculino', female: 'Femenino', mixed: 'Mixto' };
        const GENERO_BADGE = { male: 'badge-male', female: 'badge-female', mixed: 'badge-mixed' };
        const badgeEstado = a => a ? '<span class="badge badge-active">Activo</span>' : '<span class="badge badge-inactive">Inactivo</span>';
        const emptyRow = (cols, msg) => `<tr><td colspan="${cols}" class="empty-state"><i class="bi bi-inbox"></i>${msg || 'No hay registros'}</td></tr>`;

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const hasAccess = await validatePageAccess('Equipos deportivos');
                if (!hasAccess) return;

                const session = getStoredSession();
                if (!session || !session.user) {
                    showMessage('Sesión no válida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '../../login.html', 1500);
                    return;
                }
                currentUser = session.user;

                await inicializarPagina();
            } catch (error) {
                console.error('❌ Error:', error);
                showMessage('Error de validación: ' + error.message, 'danger');
            }
        });

        async function inicializarPagina() {
            try {
                mostrarLoading();

                modalDisciplina = new bootstrap.Modal(document.getElementById('modal-disciplina'));
                modalCategoria = new bootstrap.Modal(document.getElementById('modal-categoria'));
                modalEquipo = new bootstrap.Modal(document.getElementById('modal-equipo'));

                await Promise.all([
                    cargarDisciplinas(),
                    cargarCategorias()
                ]);

                await cargarEquipos();

                ocultarLoading();
                console.log('✅ Equipos deportivos cargados');
            } catch (error) {
                console.error('❌ Error inicializando:', error);
                showMessage('Error al cargar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // DISCIPLINAS
        // ==========================================
        async function cargarDisciplinas() {
            try {
                const data = await supabaseRequest('/svc_sports_disciplines?select=*&order=discipline_name.asc');
                cacheDisciplinas = data || [];
                renderDisciplinas();
                poblarFiltroDisciplinas();
                document.getElementById('count-disciplinas').textContent = cacheDisciplinas.length;
            } catch (e) { console.error('❌ Error disciplinas:', e); }
        }

        function renderDisciplinas() {
            const tbody = document.getElementById('tbody-disciplinas');
            if (cacheDisciplinas.length === 0) { tbody.innerHTML = emptyRow(3, 'No hay disciplinas'); return; }
            tbody.innerHTML = cacheDisciplinas.map(d => `
                <tr>
                    <td><strong>${d.discipline_name}</strong></td>
                    <td>${badgeEstado(d.is_active)}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="editarDisciplina('${d.discipline_id}')"><i class="bi bi-pencil"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function abrirModalDisciplina() {
            document.getElementById('form-disciplina').reset();
            document.getElementById('disciplina-id').value = '';
            document.getElementById('disciplina-activo').checked = true;
            document.getElementById('modal-disciplina-title').innerHTML = '<i class="bi bi-dribbble me-2"></i>Nueva Disciplina';
            modalDisciplina.show();
        }

        function editarDisciplina(id) {
            const d = cacheDisciplinas.find(x => x.discipline_id === id);
            if (!d) return;
            document.getElementById('disciplina-id').value = d.discipline_id;
            document.getElementById('disciplina-nombre').value = d.discipline_name;
            document.getElementById('disciplina-activo').checked = d.is_active;
            document.getElementById('modal-disciplina-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Disciplina';
            modalDisciplina.show();
        }

        async function guardarDisciplina(e) {
            e.preventDefault();
            const id = document.getElementById('disciplina-id').value;
            const payload = {
                discipline_name: document.getElementById('disciplina-nombre').value.trim(),
                is_active: document.getElementById('disciplina-activo').checked
            };
            try {
                if (id) {
                    await supabaseRequest(`/svc_sports_disciplines?discipline_id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(payload) });
                } else {
                    await supabaseRequest('/svc_sports_disciplines', { method: 'POST', body: JSON.stringify(payload) });
                }
                modalDisciplina.hide();
                showMessage('Disciplina guardada', 'success');
                await cargarDisciplinas();
            } catch (err) { showMessage('Error: ' + err.message, 'danger'); }
        }

        // ==========================================
        // CATEGORÍAS
        // ==========================================
        async function cargarCategorias() {
            try {
                const data = await supabaseRequest('/svc_sports_categories?select=*&order=category_order.asc.nullslast,category_name.asc');
                cacheCategorias = data || [];
                renderCategorias();
                poblarFiltroCategoria();
                document.getElementById('count-categorias').textContent = cacheCategorias.length;
            } catch (e) { console.error('❌ Error categorías:', e); }
        }

        function renderCategorias() {
            const tbody = document.getElementById('tbody-categorias');
            if (cacheCategorias.length === 0) { tbody.innerHTML = emptyRow(4, 'No hay categorías'); return; }
            tbody.innerHTML = cacheCategorias.map(c => `
                <tr>
                    <td class="text-center">${c.category_order || '—'}</td>
                    <td><strong>${c.category_name}</strong></td>
                    <td>${badgeEstado(c.is_active)}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="editarCategoria('${c.category_id}')"><i class="bi bi-pencil"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function abrirModalCategoria() {
            document.getElementById('form-categoria').reset();
            document.getElementById('categoria-id').value = '';
            document.getElementById('categoria-activo').checked = true;
            document.getElementById('modal-categoria-title').innerHTML = '<i class="bi bi-tags me-2"></i>Nueva Categoría';
            modalCategoria.show();
        }

        function editarCategoria(id) {
            const c = cacheCategorias.find(x => x.category_id === id);
            if (!c) return;
            document.getElementById('categoria-id').value = c.category_id;
            document.getElementById('categoria-nombre').value = c.category_name;
            document.getElementById('categoria-orden').value = c.category_order || '';
            document.getElementById('categoria-activo').checked = c.is_active;
            document.getElementById('modal-categoria-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Categoría';
            modalCategoria.show();
        }

        async function guardarCategoria(e) {
            e.preventDefault();
            const id = document.getElementById('categoria-id').value;
            const ordenVal = document.getElementById('categoria-orden').value;
            const payload = {
                category_name: document.getElementById('categoria-nombre').value.trim(),
                category_order: ordenVal ? parseInt(ordenVal) : null,
                is_active: document.getElementById('categoria-activo').checked
            };
            try {
                if (id) {
                    await supabaseRequest(`/svc_sports_categories?category_id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(payload) });
                } else {
                    await supabaseRequest('/svc_sports_categories', { method: 'POST', body: JSON.stringify(payload) });
                }
                modalCategoria.hide();
                showMessage('Categoría guardada', 'success');
                await cargarCategorias();
            } catch (err) { showMessage('Error: ' + err.message, 'danger'); }
        }

        // ==========================================
        // EQUIPOS
        // ==========================================
        async function cargarEquipos() {
            try {
                const data = await supabaseRequest('/svc_sports_teams?select=*,svc_sports_disciplines(discipline_name),svc_sports_categories(category_name,category_order)&order=svc_sports_disciplines(discipline_name).asc,svc_sports_categories(category_order).asc');
                cacheEquipos = data || [];

                // Cargar conteo de integrantes por equipo
                const members = await supabaseRequest('/svc_sports_team_members?select=team_id,is_active');
                const memberCounts = {};
                (members || []).forEach(m => {
                    if (m.is_active) {
                        memberCounts[m.team_id] = (memberCounts[m.team_id] || 0) + 1;
                    }
                });
                cacheEquipos.forEach(eq => {
                    eq._memberCount = memberCounts[eq.team_id] || 0;
                });

                renderEquipos();
            } catch (e) { console.error('❌ Error equipos:', e); }
        }

        function renderEquipos() {
            const tbody = document.getElementById('tbody-equipos');
            const filtroDis = document.getElementById('filtro-disciplina').value;
            const filtroCat = document.getElementById('filtro-categoria').value;

            let filtered = cacheEquipos;
            if (filtroDis) filtered = filtered.filter(e => e.discipline_id === filtroDis);
            if (filtroCat) filtered = filtered.filter(e => e.category_id === filtroCat);

            if (filtered.length === 0) { tbody.innerHTML = emptyRow(7, 'No hay equipos con los filtros seleccionados'); return; }

            tbody.innerHTML = filtered.map(eq => {
                const disName = eq.svc_sports_disciplines?.discipline_name || '—';
                const catName = eq.svc_sports_categories?.category_name || '—';
                const genLabel = GENERO_LABELS[eq.gender] || eq.gender;
                const genBadge = GENERO_BADGE[eq.gender] || '';
                const coach = eq.coach_name ? `${eq.coach_name}${eq.coach_contact ? ' <small class="text-muted">(' + eq.coach_contact + ')</small>' : ''}` : '<span class="text-muted">—</span>';
                const selected = equipoSeleccionado === eq.team_id ? 'selected' : '';

                return `
                    <tr class="team-row ${selected}" onclick="seleccionarEquipo('${eq.team_id}')">
                        <td>${disName}</td>
                        <td>${catName}</td>
                        <td><span class="badge ${genBadge}">${genLabel}</span></td>
                        <td>${coach}</td>
                        <td class="text-center"><span class="count-badge">${eq._memberCount}</span></td>
                        <td>${badgeEstado(eq.is_active)}</td>
                        <td class="text-end" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-outline-primary" onclick="editarEquipo('${eq.team_id}')"><i class="bi bi-pencil"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function poblarFiltroDisciplinas() {
            const select = document.getElementById('filtro-disciplina');
            const selectModal = document.getElementById('equipo-disciplina');
            const activas = cacheDisciplinas.filter(d => d.is_active);
            const opts = activas.map(d => `<option value="${d.discipline_id}">${d.discipline_name}</option>`).join('');

            select.innerHTML = '<option value="">Todas las disciplinas</option>' + opts;
            selectModal.innerHTML = '<option value="">Seleccionar...</option>' + opts;
        }

        function poblarFiltroCategoria() {
            const select = document.getElementById('filtro-categoria');
            const selectModal = document.getElementById('equipo-categoria');
            const activas = cacheCategorias.filter(c => c.is_active);
            const opts = activas.map(c => `<option value="${c.category_id}">${c.category_name}</option>`).join('');

            select.innerHTML = '<option value="">Todas las categorías</option>' + opts;
            selectModal.innerHTML = '<option value="">Seleccionar...</option>' + opts;
        }

        function abrirModalEquipo() {
            document.getElementById('form-equipo').reset();
            document.getElementById('equipo-id').value = '';
            document.getElementById('equipo-activo').checked = true;
            document.getElementById('modal-equipo-title').innerHTML = '<i class="bi bi-people me-2"></i>Nuevo Equipo';
            modalEquipo.show();
        }

        function editarEquipo(id) {
            const eq = cacheEquipos.find(x => x.team_id === id);
            if (!eq) return;
            document.getElementById('equipo-id').value = eq.team_id;
            document.getElementById('equipo-disciplina').value = eq.discipline_id;
            document.getElementById('equipo-categoria').value = eq.category_id;
            document.getElementById('equipo-genero').value = eq.gender;
            document.getElementById('equipo-coach-nombre').value = eq.coach_name || '';
            document.getElementById('equipo-coach-contacto').value = eq.coach_contact || '';
            document.getElementById('equipo-activo').checked = eq.is_active;
            document.getElementById('modal-equipo-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Equipo';
            modalEquipo.show();
        }

        async function guardarEquipo(e) {
            e.preventDefault();
            const id = document.getElementById('equipo-id').value;
            const payload = {
                discipline_id: document.getElementById('equipo-disciplina').value,
                category_id: document.getElementById('equipo-categoria').value,
                gender: document.getElementById('equipo-genero').value,
                coach_name: document.getElementById('equipo-coach-nombre').value.trim() || null,
                coach_contact: document.getElementById('equipo-coach-contacto').value.trim() || null,
                is_active: document.getElementById('equipo-activo').checked
            };
            try {
                if (id) {
                    await supabaseRequest(`/svc_sports_teams?team_id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(payload) });
                } else {
                    await supabaseRequest('/svc_sports_teams', { method: 'POST', body: JSON.stringify(payload) });
                }
                modalEquipo.hide();
                showMessage('Equipo guardado', 'success');
                await cargarEquipos();
            } catch (err) { showMessage('Error: ' + err.message, 'danger'); }
        }

        // ==========================================
        // INTEGRANTES
        // ==========================================
        async function seleccionarEquipo(teamId) {
            equipoSeleccionado = teamId;

            // Actualizar highlight en la tabla
            document.querySelectorAll('.team-row').forEach(r => r.classList.remove('selected'));
            event.currentTarget?.classList.add('selected');

            // Título del panel
            const eq = cacheEquipos.find(x => x.team_id === teamId);
            if (eq) {
                const dis = eq.svc_sports_disciplines?.discipline_name || '';
                const cat = eq.svc_sports_categories?.category_name || '';
                const gen = GENERO_LABELS[eq.gender] || '';
                document.getElementById('titulo-equipo-seleccionado').textContent = `${dis} — ${cat} (${gen})`;
            }

            // Mostrar panel
            document.getElementById('panel-integrantes').classList.remove('d-none');

            // Limpiar buscador
            document.getElementById('buscar-estudiante').value = '';
            document.getElementById('resultados-busqueda').classList.add('d-none');

            // Cargar integrantes
            await cargarIntegrantes(teamId);
        }

        function cerrarPanelIntegrantes() {
            equipoSeleccionado = null;
            document.getElementById('panel-integrantes').classList.add('d-none');
            document.querySelectorAll('.team-row').forEach(r => r.classList.remove('selected'));
        }

        async function cargarIntegrantes(teamId) {
            try {
                const data = await supabaseRequest(`/svc_sports_team_members?select=*,students(student_id,student_first_name,student_last_name_1,student_last_name_2,courses(course_name,grades(grade_name)))&team_id=eq.${teamId}&order=students(student_last_name_1).asc`);
                cacheIntegrantes = data || [];
                renderIntegrantes();
            } catch (e) {
                console.error('❌ Error integrantes:', e);
            }
        }

        function renderIntegrantes() {
            const container = document.getElementById('lista-integrantes');
            const activos = cacheIntegrantes.filter(m => m.is_active);
            const inactivos = cacheIntegrantes.filter(m => !m.is_active);

            document.getElementById('count-integrantes').textContent = activos.length;

            if (cacheIntegrantes.length === 0) {
                container.innerHTML = '<div class="text-muted text-center py-3"><i class="bi bi-people" style="font-size:2rem;"></i><p class="mt-2">No hay integrantes en este equipo</p></div>';
                return;
            }

            let html = '';

            activos.forEach(m => {
                const st = m.students;
                const nombre = st ? `${st.student_last_name_1} ${st.student_last_name_2 || ''} ${st.student_first_name}`.trim() : `ID: ${m.student_id}`;
                const curso = st?.courses?.course_name || '';
                const grado = st?.courses?.grades?.grade_name || '';
                const ubicacion = grado ? `${grado} — ${curso}` : curso;

                html += `
                    <div class="member-row">
                        <div class="member-info">
                            <i class="bi bi-person-fill text-muted"></i>
                            <div>
                                <div class="fw-semibold" style="font-size:0.9rem;">${nombre}</div>
                                <small class="text-muted">${ubicacion}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="desactivarIntegrante(${m.student_id})" title="Retirar del equipo">
                            <i class="bi bi-person-dash"></i>
                        </button>
                    </div>
                `;
            });

            if (inactivos.length > 0) {
                html += `<div class="mt-3 mb-2"><small class="text-muted fw-semibold">Retirados (${inactivos.length})</small></div>`;
                inactivos.forEach(m => {
                    const st = m.students;
                    const nombre = st ? `${st.student_last_name_1} ${st.student_last_name_2 || ''} ${st.student_first_name}`.trim() : `ID: ${m.student_id}`;
                    html += `
                        <div class="member-row" style="opacity:0.5;">
                            <div class="member-info">
                                <i class="bi bi-person text-muted"></i>
                                <div><div style="font-size:0.9rem;">${nombre}</div></div>
                            </div>
                            <button class="btn btn-sm btn-outline-success" onclick="reactivarIntegrante(${m.student_id})" title="Reactivar">
                                <i class="bi bi-person-plus"></i>
                            </button>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        // ==========================================
        // BÚSQUEDA DE ESTUDIANTES
        // ==========================================
        function buscarEstudiantes() {
            clearTimeout(timeoutBusqueda);
            const texto = document.getElementById('buscar-estudiante').value.trim();
            const container = document.getElementById('resultados-busqueda');

            if (texto.length < 3) {
                container.classList.add('d-none');
                return;
            }

            timeoutBusqueda = setTimeout(async () => {
                try {
                    // Buscar por nombre, apellido1 o apellido2 — estudiantes activos
                    const termino = texto.replace(/'/g, "''");
                    const data = await supabaseRequest(`/students?select=student_id,student_first_name,student_last_name_1,student_last_name_2,courses(course_name,grades(grade_name)),student_status!inner(status_description)&student_status.status_description=eq.Activo&or=(student_first_name.ilike.*${termino}*,student_last_name_1.ilike.*${termino}*,student_last_name_2.ilike.*${termino}*)&limit=15`);

                    if (!data || data.length === 0) {
                        container.innerHTML = '<div class="p-3 text-muted text-center">No se encontraron estudiantes</div>';
                        container.classList.remove('d-none');
                        return;
                    }

                    // Excluir los que ya son integrantes activos
                    const idsActuales = cacheIntegrantes.filter(m => m.is_active).map(m => m.student_id);
                    const disponibles = data.filter(s => !idsActuales.includes(s.student_id));

                    if (disponibles.length === 0) {
                        container.innerHTML = '<div class="p-3 text-muted text-center">Todos los resultados ya están en el equipo</div>';
                        container.classList.remove('d-none');
                        return;
                    }

                    container.innerHTML = disponibles.map(s => {
                        const nombre = `${s.student_last_name_1} ${s.student_last_name_2 || ''} ${s.student_first_name}`.trim();
                        const curso = s.courses?.course_name || '';
                        const grado = s.courses?.grades?.grade_name || '';
                        const ubicacion = grado ? `${grado} — ${curso}` : curso;
                        return `
                            <div class="search-result-item" onclick="agregarIntegrante(${s.student_id})">
                                <div>
                                    <div class="fw-semibold">${nombre}</div>
                                    <small class="text-muted">${ubicacion}</small>
                                </div>
                                <i class="bi bi-plus-circle text-success"></i>
                            </div>
                        `;
                    }).join('');

                    container.classList.remove('d-none');
                } catch (e) {
                    console.error('❌ Error buscando estudiantes:', e);
                }
            }, 400);
        }

        async function agregarIntegrante(studentId) {
            if (!equipoSeleccionado) return;

            try {
                // Verificar si ya existe (inactivo) para reactivar
                const existente = cacheIntegrantes.find(m => m.student_id === studentId);
                if (existente && !existente.is_active) {
                    await supabaseRequest(`/svc_sports_team_members?team_id=eq.${equipoSeleccionado}&student_id=eq.${studentId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ is_active: true })
                    });
                } else {
                    await supabaseRequest('/svc_sports_team_members', {
                        method: 'POST',
                        body: JSON.stringify({
                            team_id: equipoSeleccionado,
                            student_id: studentId,
                            is_active: true
                        })
                    });
                }

                showMessage('Integrante agregado', 'success');
                document.getElementById('buscar-estudiante').value = '';
                document.getElementById('resultados-busqueda').classList.add('d-none');
                await cargarIntegrantes(equipoSeleccionado);
                await cargarEquipos(); // Actualizar conteo
            } catch (err) {
                showMessage('Error al agregar: ' + err.message, 'danger');
            }
        }

        async function desactivarIntegrante(studentId) {
            if (!equipoSeleccionado) return;
            if (!confirm('¿Retirar este estudiante del equipo?')) return;

            try {
                await supabaseRequest(`/svc_sports_team_members?team_id=eq.${equipoSeleccionado}&student_id=eq.${studentId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: false })
                });
                showMessage('Integrante retirado', 'success');
                await cargarIntegrantes(equipoSeleccionado);
                await cargarEquipos();
            } catch (err) { showMessage('Error: ' + err.message, 'danger'); }
        }

        async function reactivarIntegrante(studentId) {
            if (!equipoSeleccionado) return;

            try {
                await supabaseRequest(`/svc_sports_team_members?team_id=eq.${equipoSeleccionado}&student_id=eq.${studentId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: true })
                });
                showMessage('Integrante reactivado', 'success');
                await cargarIntegrantes(equipoSeleccionado);
                await cargarEquipos();
            } catch (err) { showMessage('Error: ' + err.message, 'danger'); }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function mostrarLoading() { document.getElementById('loading-overlay')?.classList.remove('hidden'); }
        function ocultarLoading() { document.getElementById('loading-overlay')?.classList.add('hidden'); }

        // Cerrar resultados de búsqueda al hacer clic fuera
        document.addEventListener('click', function(e) {
            const buscar = document.getElementById('buscar-estudiante');
            const resultados = document.getElementById('resultados-busqueda');
            if (buscar && resultados && !buscar.contains(e.target) && !resultados.contains(e.target)) {
                resultados.classList.add('d-none');
            }
        });

        console.log('✅ Equipos deportivos cargados');
    </script>
</body>
</html>
