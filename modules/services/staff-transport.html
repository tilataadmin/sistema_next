<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.07.10.45">
    <title>Transporte de Personal - SchoolNet</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .loading-overlay.hidden { display: none; }
        .loading-content { background: white; padding: 2rem; border-radius: 8px; text-align: center; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #0d9488; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn-teal { background-color: #0d9488; border-color: #0d9488; color: #fff; }
        .btn-teal:hover { background-color: #0f766e; border-color: #0f766e; color: #fff; }
        .badge-active { background-color: #d1fae5; color: #065f46; }
        .badge-inactive { background-color: #fee2e2; color: #991b1b; }

        .table th { font-size: 0.85rem; white-space: nowrap; }
        .table td { vertical-align: middle; font-size: 0.9rem; }
        .catalog-table th, .catalog-table td { font-size: 0.85rem; padding: 0.5rem 0.75rem; }
        .empty-state { text-align: center; padding: 3rem 1rem; color: #6c757d; }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; display: block; }
        .count-badge { background-color: #0d9488; color: white; font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 1rem; }

        /* Registro diario */
        .record-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .record-card:hover { background-color: #f0fdfa; }
        .record-route-info { flex: 1; }
        .record-route-name { font-weight: 600; font-size: 0.95rem; }
        .record-route-detail { font-size: 0.8rem; color: #6b7280; }
        .record-toggle { display: flex; align-items: center; gap: 0.75rem; }

        /* Resumen mensual */
        .summary-table th { background-color: #f0fdfa; font-size: 0.8rem; }
        .summary-table td { font-size: 0.85rem; }
        .summary-total { font-weight: 700; color: #0d9488; }
        .day-completed { color: #059669; font-weight: 600; }
        .day-not-completed { color: #dc2626; }
        .day-no-record { color: #d1d5db; }
    </style>
</head>

<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando transporte de personal...</p>
        </div>
    </div>

    <div class="container-fluid">

        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a></li>
                <li class="breadcrumb-item"><a href="index.html">Servicios y Eventos</a></li>
                <li class="breadcrumb-item active" aria-current="page">Transporte de Personal</li>
            </ol>
        </nav>

        <!-- HEADER -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-bus-front me-2" style="color: #0d9488;"></i>
                    Transporte de Personal
                </h1>
                <p class="text-muted">Rutas de transporte, registro diario y resumen mensual para liquidación.</p>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- ============================================================ -->
        <!-- RUTAS — ACORDEÓN COLAPSABLE -->
        <!-- ============================================================ -->
        <div class="accordion mb-4" id="accordionRutas">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-rutas">
                        <i class="bi bi-signpost-2 me-2"></i>Rutas de Transporte
                        <span class="ms-2 count-badge" id="count-rutas">0</span>
                    </button>
                </h2>
                <div id="collapse-rutas" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-end mb-2">
                            <button class="btn btn-teal btn-sm" onclick="abrirModalRuta()">
                                <i class="bi bi-plus-circle me-1"></i>Nueva Ruta
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm catalog-table mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nombre</th>
                                        <th class="text-center">Capacidad</th>
                                        <th class="text-end">Valor por viaje</th>
                                        <th>Vigente desde</th>
                                        <th>Estado</th>
                                        <th class="text-end">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-rutas"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- REGISTRO DIARIO -->
        <!-- ============================================================ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="mb-0"><i class="bi bi-calendar-check me-2"></i>Registro Diario</h5>
                <div class="d-flex align-items-center gap-2">
                    <label class="form-label mb-0 fw-semibold" style="font-size:0.85rem;">Fecha:</label>
                    <input type="date" class="form-control form-control-sm" id="fecha-registro" style="width:auto;" onchange="cargarRegistroDiario()">
                </div>
            </div>
            <div class="card-body">
                <div id="registro-diario-container">
                    <div class="text-center text-muted py-3">Seleccione una fecha para registrar</div>
                </div>
                <div class="text-end mt-3 d-none" id="btn-guardar-registro-container">
                    <button class="btn btn-teal" onclick="guardarRegistroDiario()">
                        <i class="bi bi-check-lg me-1"></i>Guardar Registro del Día
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- RESUMEN MENSUAL -->
        <!-- ============================================================ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Resumen Mensual</h5>
                <div class="d-flex align-items-center gap-2">
                    <select class="form-select form-select-sm" id="resumen-mes" style="width:auto;" onchange="cargarResumenMensual()">
                        <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                        <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                        <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                        <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                    </select>
                    <select class="form-select form-select-sm" id="resumen-anio" style="width:auto;" onchange="cargarResumenMensual()"></select>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table summary-table mb-0">
                        <thead>
                            <tr>
                                <th>Ruta</th>
                                <th class="text-center">Recorridos realizados</th>
                                <th class="text-end">Valor por viaje</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-resumen"></tbody>
                        <tfoot>
                            <tr class="table-light">
                                <td colspan="3" class="text-end fw-bold">Total del mes:</td>
                                <td class="text-end summary-total" id="total-mes">$0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

    </div><!-- /container -->

    <!-- ================================================================= -->
    <!-- MODAL RUTA -->
    <!-- ================================================================= -->
    <div class="modal fade" id="modal-ruta" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-ruta-title"><i class="bi bi-signpost-2 me-2"></i>Nueva Ruta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-ruta" onsubmit="guardarRuta(event)">
                    <div class="modal-body">
                        <input type="hidden" id="ruta-id">
                        <div class="mb-3">
                            <label class="form-label">Nombre de la ruta <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ruta-nombre" required placeholder="Ej: Ruta Oriente">
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Capacidad del vehículo <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="ruta-capacidad" min="1" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Valor por viaje <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" class="form-control" id="ruta-valor" required placeholder="0" oninput="formatearInputMoneda(this)" onfocus="formatearInputMoneda(this)">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Vigente desde <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="ruta-vigencia" required>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="ruta-activo" checked>
                            <label class="form-check-label" for="ruta-activo">Activa</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-teal">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let cacheRutas = [];
        let cacheRegistrosDia = [];     // registros del día seleccionado
        let cacheRegistrosMes = [];     // registros del mes para resumen
        let modalRuta;

        const fmtCOP = v => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v);
        const badgeEstado = a => a ? '<span class="badge badge-active">Activo</span>' : '<span class="badge badge-inactive">Inactivo</span>';
        const emptyRow = (cols, msg) => `<tr><td colspan="${cols}" class="empty-state"><i class="bi bi-inbox"></i>${msg || 'No hay registros'}</td></tr>`;

        function getCurrentDateColombia() {
            const now = new Date();
            const colombiaOffset = -5 * 60;
            const localOffset = now.getTimezoneOffset();
            const colombiaTime = new Date(now.getTime() + (localOffset + colombiaOffset) * 60000);
            const y = colombiaTime.getFullYear();
            const m = String(colombiaTime.getMonth() + 1).padStart(2, '0');
            const d = String(colombiaTime.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const hasAccess = await validatePageAccess('Transporte de personal');
                if (!hasAccess) return;

                const session = getStoredSession();
                if (!session || !session.user) {
                    showMessage('Sesión no válida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '../../login.html', 1500);
                    return;
                }
                currentUser = session.user;

                await inicializarPagina();
            } catch (error) {
                console.error('❌ Error:', error);
                showMessage('Error de validación: ' + error.message, 'danger');
            }
        });

        async function inicializarPagina() {
            try {
                mostrarLoading();

                modalRuta = new bootstrap.Modal(document.getElementById('modal-ruta'));

                // Fecha por defecto: hoy Colombia
                const hoy = getCurrentDateColombia();
                document.getElementById('fecha-registro').value = hoy;

                // Selectores de resumen: mes y año actuales
                const ahora = new Date();
                document.getElementById('resumen-mes').value = ahora.getMonth();
                const selectAnio = document.getElementById('resumen-anio');
                const anioActual = ahora.getFullYear();
                for (let y = anioActual; y >= anioActual - 2; y--) {
                    selectAnio.innerHTML += `<option value="${y}">${y}</option>`;
                }
                selectAnio.value = anioActual;

                await cargarRutas();
                await cargarRegistroDiario();
                await cargarResumenMensual();

                ocultarLoading();

                // Formatear input de moneda con separador de miles
                function formatearInputMoneda(input) {
                    let valor = input.value.replace(/\D/g, '');
                    if (valor === '') { input.value = ''; return; }
                    input.value = parseInt(valor).toLocaleString('es-CO');
                }
        
                function obtenerValorNumerico(inputId) {
                    const raw = document.getElementById(inputId).value.replace(/\D/g, '');
                    return raw ? parseFloat(raw) : 0;
                }

                
                console.log('✅ Transporte de personal cargado');
            } catch (error) {
                console.error('❌ Error inicializando:', error);
                showMessage('Error al cargar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // RUTAS
        // ==========================================
        async function cargarRutas() {
            try {
                const data = await supabaseRequest('/svc_staff_transport_routes?select=*&order=route_name.asc');
                cacheRutas = data || [];
                renderRutas();
                document.getElementById('count-rutas').textContent = cacheRutas.length;
            } catch (e) { console.error('❌ Error rutas:', e); }
        }

        function renderRutas() {
            const tbody = document.getElementById('tbody-rutas');
            if (cacheRutas.length === 0) { tbody.innerHTML = emptyRow(6, 'No hay rutas configuradas'); return; }
            tbody.innerHTML = cacheRutas.map(r => {
                const vigencia = r.effective_from ? new Date(r.effective_from + 'T12:00:00').toLocaleDateString('es-CO') : '—';
                return `
                    <tr>
                        <td><strong>${r.route_name}</strong></td>
                        <td class="text-center">${r.vehicle_capacity} pas.</td>
                        <td class="text-end">${fmtCOP(r.trip_value)}</td>
                        <td>${vigencia}</td>
                        <td>${badgeEstado(r.is_active)}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary" onclick="editarRuta('${r.route_id}')"><i class="bi bi-pencil"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function abrirModalRuta() {
            document.getElementById('form-ruta').reset();
            document.getElementById('ruta-id').value = '';
            document.getElementById('ruta-activo').checked = true;
            document.getElementById('ruta-vigencia').value = getCurrentDateColombia();
            document.getElementById('modal-ruta-title').innerHTML = '<i class="bi bi-signpost-2 me-2"></i>Nueva Ruta';
            modalRuta.show();
        }

        function editarRuta(id) {
            const r = cacheRutas.find(x => x.route_id === id);
            if (!r) return;
            document.getElementById('ruta-id').value = r.route_id;
            document.getElementById('ruta-nombre').value = r.route_name;
            document.getElementById('ruta-capacidad').value = r.vehicle_capacity;
            document.getElementById('ruta-valor').value = parseInt(r.trip_value).toLocaleString('es-CO');
            document.getElementById('ruta-vigencia').value = r.effective_from || '';
            document.getElementById('ruta-activo').checked = r.is_active;
            document.getElementById('modal-ruta-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Ruta';
            modalRuta.show();
        }

        async function guardarRuta(e) {
            e.preventDefault();
            const id = document.getElementById('ruta-id').value;
            const payload = {
                route_name: document.getElementById('ruta-nombre').value.trim(),
                vehicle_capacity: parseInt(document.getElementById('ruta-capacidad').value),
                trip_value: obtenerValorNumerico('ruta-valor'),
                effective_from: document.getElementById('ruta-vigencia').value,
                is_active: document.getElementById('ruta-activo').checked
            };
            try {
                if (id) {
                    await supabaseRequest(`/svc_staff_transport_routes?route_id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(payload) });
                } else {
                    await supabaseRequest('/svc_staff_transport_routes', { method: 'POST', body: JSON.stringify(payload) });
                }
                modalRuta.hide();
                showMessage('Ruta guardada correctamente', 'success');
                await cargarRutas();
                await cargarRegistroDiario();
            } catch (err) { showMessage('Error al guardar ruta: ' + err.message, 'danger'); }
        }

        // ==========================================
        // REGISTRO DIARIO
        // ==========================================
        async function cargarRegistroDiario() {
            const fecha = document.getElementById('fecha-registro').value;
            if (!fecha) return;

            const container = document.getElementById('registro-diario-container');
            const btnContainer = document.getElementById('btn-guardar-registro-container');

            const rutasActivas = cacheRutas.filter(r => r.is_active);
            if (rutasActivas.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-info-circle me-1"></i>No hay rutas activas. Configure rutas primero.</div>';
                btnContainer.classList.add('d-none');
                return;
            }

            try {
                // Cargar registros existentes para esa fecha
                const data = await supabaseRequest(`/svc_staff_transport_daily_records?select=*&record_date=eq.${fecha}`);
                cacheRegistrosDia = data || [];

                renderRegistroDiario(rutasActivas, fecha);
                btnContainer.classList.remove('d-none');
            } catch (e) {
                console.error('❌ Error cargando registro diario:', e);
                container.innerHTML = '<div class="text-center text-danger py-3">Error al cargar registros</div>';
            }
        }

        function renderRegistroDiario(rutasActivas, fecha) {
            const container = document.getElementById('registro-diario-container');
            const fechaDisplay = new Date(fecha + 'T12:00:00').toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            let html = `<p class="text-muted mb-3" style="font-size:0.9rem;"><i class="bi bi-calendar3 me-1"></i>${fechaDisplay}</p>`;

            rutasActivas.forEach(ruta => {
                const registro = cacheRegistrosDia.find(r => r.route_id === ruta.route_id);
                const completado = registro ? registro.was_completed : false;
                const tieneRegistro = !!registro;

                html += `
                    <div class="record-card" id="record-${ruta.route_id}">
                        <div class="record-route-info">
                            <div class="record-route-name">${ruta.route_name}</div>
                            <div class="record-route-detail">${ruta.vehicle_capacity} pasajeros — ${fmtCOP(ruta.trip_value)}</div>
                        </div>
                        <div class="record-toggle">
                            <span class="text-muted" style="font-size:0.8rem;" id="label-${ruta.route_id}">${completado ? '✅ Realizado' : '❌ No realizado'}</span>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" role="switch"
                                    id="toggle-${ruta.route_id}"
                                    data-route-id="${ruta.route_id}"
                                    data-trip-value="${ruta.trip_value}"
                                    data-record-id="${registro ? registro.record_id : ''}"
                                    ${completado ? 'checked' : ''}
                                    onchange="actualizarLabelToggle('${ruta.route_id}')">
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function actualizarLabelToggle(routeId) {
            const toggle = document.getElementById(`toggle-${routeId}`);
            const label = document.getElementById(`label-${routeId}`);
            label.textContent = toggle.checked ? '✅ Realizado' : '❌ No realizado';
        }

        async function guardarRegistroDiario() {
            const fecha = document.getElementById('fecha-registro').value;
            if (!fecha) return;

            const toggles = document.querySelectorAll('[data-route-id]');
            let guardados = 0;
            let errores = 0;

            try {
                mostrarLoading();

                for (const toggle of toggles) {
                    const routeId = toggle.dataset.routeId;
                    const tripValue = parseFloat(toggle.dataset.tripValue);
                    const recordId = toggle.dataset.recordId;
                    const wasCompleted = toggle.checked;

                    if (recordId) {
                        // Actualizar registro existente
                        await supabaseRequest(`/svc_staff_transport_daily_records?record_id=eq.${recordId}`, {
                            method: 'PATCH',
                            body: JSON.stringify({
                                was_completed: wasCompleted,
                                recorded_by: currentUser.user_id,
                                updated_at: new Date().toISOString()
                            })
                        });
                        guardados++;
                    } else {
                        // Crear nuevo registro
                        await supabaseRequest('/svc_staff_transport_daily_records', {
                            method: 'POST',
                            body: JSON.stringify({
                                route_id: routeId,
                                record_date: fecha,
                                was_completed: wasCompleted,
                                frozen_trip_value: tripValue,
                                recorded_by: currentUser.user_id
                            })
                        });
                        guardados++;
                    }
                }

                showMessage(`Registro del día guardado (${guardados} ruta${guardados !== 1 ? 's' : ''})`, 'success');
                await cargarRegistroDiario();
                await cargarResumenMensual();
                ocultarLoading();
            } catch (err) {
                showMessage('Error al guardar: ' + err.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // RESUMEN MENSUAL
        // ==========================================
        async function cargarResumenMensual() {
            const mes = parseInt(document.getElementById('resumen-mes').value);
            const anio = parseInt(document.getElementById('resumen-anio').value);

            const primerDia = `${anio}-${String(mes + 1).padStart(2, '0')}-01`;
            const ultimoDia = new Date(anio, mes + 1, 0);
            const ultimoDiaStr = `${anio}-${String(mes + 1).padStart(2, '0')}-${String(ultimoDia.getDate()).padStart(2, '0')}`;

            try {
                const data = await supabaseRequest(`/svc_staff_transport_daily_records?select=*,svc_staff_transport_routes(route_name)&record_date=gte.${primerDia}&record_date=lte.${ultimoDiaStr}&order=record_date.asc`);
                cacheRegistrosMes = data || [];
                renderResumenMensual();
            } catch (e) {
                console.error('❌ Error resumen mensual:', e);
            }
        }

        function renderResumenMensual() {
            const tbody = document.getElementById('tbody-resumen');

            if (cacheRutas.length === 0) {
                tbody.innerHTML = emptyRow(4, 'No hay rutas configuradas');
                document.getElementById('total-mes').textContent = fmtCOP(0);
                return;
            }

            // Agrupar por ruta
            const resumenPorRuta = {};
            cacheRutas.forEach(r => {
                resumenPorRuta[r.route_id] = {
                    route_name: r.route_name,
                    trip_value: r.trip_value,
                    completados: 0,
                    subtotal: 0
                };
            });

            cacheRegistrosMes.forEach(reg => {
                if (reg.was_completed && resumenPorRuta[reg.route_id]) {
                    resumenPorRuta[reg.route_id].completados++;
                    resumenPorRuta[reg.route_id].subtotal += parseFloat(reg.frozen_trip_value) || 0;
                }
            });

            let totalMes = 0;
            const rutas = Object.values(resumenPorRuta).filter(r => r.completados > 0 || cacheRutas.find(cr => cr.route_name === r.route_name)?.is_active);

            if (rutas.length === 0) {
                tbody.innerHTML = emptyRow(4, 'No hay datos para este mes');
                document.getElementById('total-mes').textContent = fmtCOP(0);
                return;
            }

            tbody.innerHTML = Object.entries(resumenPorRuta).map(([routeId, info]) => {
                totalMes += info.subtotal;
                return `
                    <tr>
                        <td><strong>${info.route_name}</strong></td>
                        <td class="text-center">${info.completados}</td>
                        <td class="text-end">${fmtCOP(info.trip_value)}</td>
                        <td class="text-end fw-semibold">${fmtCOP(info.subtotal)}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('total-mes').textContent = fmtCOP(totalMes);
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function mostrarLoading() { document.getElementById('loading-overlay')?.classList.remove('hidden'); }
        function ocultarLoading() { document.getElementById('loading-overlay')?.classList.add('hidden'); }

        console.log('✅ Transporte de personal cargado');
    </script>
</body>
</html>
