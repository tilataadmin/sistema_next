<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.27.09.50">
    
    <title>Eventos Internos - SchoolNet</title>
    
    <!-- Bootstrap 5.3.0 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Flatpickr para fechas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        :root {
            /* Los colores corporativos se cargar√°n desde system_config */
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .wizard-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .wizard-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }
        
        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #dee2e6;
            z-index: 0;
        }
        
        .wizard-step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 2px solid #dee2e6;
            color: #6c757d;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        
        .wizard-step.active .step-circle {
            background: var(--system-primary-color, #0d6efd);
            border-color: var(--system-primary-color, #0d6efd);
            color: white;
        }
        
        .wizard-step.completed .step-circle {
            background: #198754;
            border-color: #198754;
            color: white;
        }
        
        .step-label {
            display: block;
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .wizard-step.active .step-label {
            color: var(--system-primary-color, #0d6efd);
            font-weight: 600;
        }
        
        .wizard-content {
            min-height: 400px;
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .wizard-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }
        
        .btn-primary {
            background-color: var(--system-primary-color, #0d6efd);
            border-color: var(--system-primary-color, #0d6efd);
        }
        
        .btn-primary:hover {
            filter: brightness(0.9);
        }
        
        .cost-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .cost-line {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .cost-line:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--system-primary-color, #0d6efd);
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #dee2e6;
        }
        
        .service-checkbox {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .service-checkbox:hover {
            background: #f8f9fa;
        }
        
        .service-checkbox.active {
            border-color: var(--system-primary-color, #0d6efd);
            background: #f0f7ff;
        }
        
        .badge-status {
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .table-actions {
            white-space: nowrap;
        }
        
        .event-detail-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .event-detail-section h6 {
            color: var(--system-primary-color, #0d6efd);
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">
                        <i class="bi bi-bus-front me-1"></i>Servicios
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Eventos Internos
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3 mb-2">
                    <i class="bi bi-calendar-event me-2"></i>Eventos Internos
                </h1>
                <p class="text-muted">
                    Gesti√≥n de eventos institucionales con servicios de apoyo
                </p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" id="btnNewEvent">
                    <i class="bi bi-plus-circle me-1"></i>Nuevo Evento
                </button>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- WIZARD CONTAINER (inicialmente oculto) -->
        <div id="wizardContainer" class="wizard-container hidden">
            <!-- Wizard Header -->
            <div class="wizard-header">
                <h4 id="wizardTitle">Nuevo Evento Interno</h4>
            </div>

            <!-- Wizard Steps -->
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1">
                    <div class="step-circle">1</div>
                    <span class="step-label">Informaci√≥n B√°sica</span>
                </div>
                <div class="wizard-step" data-step="2">
                    <div class="step-circle">2</div>
                    <span class="step-label">Refrigerios</span>
                </div>
                <div class="wizard-step" data-step="3">
                    <div class="step-circle">3</div>
                    <span class="step-label">Servicios de Apoyo</span>
                </div>
                <div class="wizard-step" data-step="4">
                    <div class="step-circle">4</div>
                    <span class="step-label">Solicitud de Aprobaci√≥n</span>
                </div>
            </div>

            <!-- Wizard Content -->
            <div class="wizard-content">
                <!-- PASO 1: Informaci√≥n B√°sica -->
                <div class="step-content active" id="step1">
                    <h5 class="mb-4">Informaci√≥n B√°sica del Evento</h5>
                    <form id="formStep1">
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="eventName" class="form-label">Nombre del Evento <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="eventName" required 
                                       placeholder="Ej: D√≠a de la Familia 2026">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="eventDate" class="form-label">Fecha del Evento <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="eventDate" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="startTime" class="form-label">Hora de Inicio <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" id="startTime" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="endTime" class="form-label">Hora de Finalizaci√≥n <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" id="endTime" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="eventLocation" class="form-label">Sitio/Ubicaci√≥n <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="eventLocation" rows="2" required
                                      placeholder="Ej: Cancha m√∫ltiple cubierta"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="numStudents" class="form-label">N√∫mero de Estudiantes <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="numStudents" min="0" value="0" required>
                                <small class="text-muted">Cantidad estimada de estudiantes participantes</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="numAdults" class="form-label">N√∫mero de Adultos <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="numAdults" min="0" value="0" required>
                                <small class="text-muted">Cantidad estimada de adultos participantes</small>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- PASO 2: Refrigerios -->
                <div class="step-content" id="step2">
                    <h5 class="mb-4">Refrigerios y Alimentaci√≥n</h5>
                    
                    <!-- Refrigerios Estudiantes -->
                    <div class="service-checkbox" id="cateringStudentsBox">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cateringStudentsCheck">
                            <label class="form-check-label fw-bold" for="cateringStudentsCheck">
                                <i class="bi bi-cup-straw"></i> Refrigerios para Estudiantes
                            </label>
                        </div>
                        
                        <div id="cateringStudentsFields" class="mt-3 hidden">
                            <div id="cateringStudentsLines"></div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btnAddMenuStudents">
                                <i class="bi bi-plus-circle"></i> Agregar refrigerio
                            </button>
                            <div class="text-end mt-3 fw-bold" id="cateringStudentsSubtotal" style="display:none;">
                                Subtotal Estudiantes: <span id="subtotalStudentsValue">$0</span>
                            </div>
                        </div>
                    </div>
                
                    <!-- Refrigerios Adultos -->
                    <div class="service-checkbox" id="cateringAdultsBox">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cateringAdultsCheck">
                            <label class="form-check-label fw-bold" for="cateringAdultsCheck">
                                <i class="bi bi-cup-hot"></i> Refrigerios para Adultos
                            </label>
                        </div>
                        
                        <div id="cateringAdultsFields" class="mt-3 hidden">
                            <div id="cateringAdultsLines"></div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btnAddMenuAdults">
                                <i class="bi bi-plus-circle"></i> Agregar refrigerio
                            </button>
                            <div class="text-end mt-3 fw-bold" id="cateringAdultsSubtotal" style="display:none;">
                                Subtotal Adultos: <span id="subtotalAdultsValue">$0</span>
                            </div>
                        </div>
                    </div>
                
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Nota:</strong> Los refrigerios son opcionales. Puede agregar varios tipos de refrigerio 
                        por grupo. Las cantidades se toman autom√°ticamente del n√∫mero de participantes indicado en el paso anterior.
                    </div>
                </div>


                <!-- PASO 3: Servicios de Apoyo -->
                <div class="step-content" id="step3">
                    <h5 class="mb-4">Servicios de Apoyo</h5>
                    <p class="text-muted mb-4">
                        Seleccione los servicios de apoyo requeridos y describa las necesidades espec√≠ficas (opcional)
                    </p>
                
                    <!-- Servicio: Staffing -->
                    <div class="service-checkbox" id="serviceStaffingBox">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="serviceStaffingCheck">
                            <label class="form-check-label fw-bold" for="serviceStaffingCheck">
                                <i class="bi bi-people"></i> Personal de Apoyo General (Staffing)
                            </label>
                        </div>
                        <div id="serviceStaffingFields" class="hidden">
                            <textarea class="form-control" id="serviceStaffingDesc" rows="4" 
                                      placeholder="Describa detalladamente el personal que requiere, registrando cargo, n√∫mero de personas y justificaci√≥n.&#10;Ej: 1 enfermera para prestar atenci√≥n a los ni√±os asistentes, 2 t√©cnicos de computador, uno a cargo del sonido y otro a cargo de la proyecci√≥n."></textarea>
                        </div>
                    </div>
                
                    <!-- Servicio: Comunicaciones -->
                    <div class="service-checkbox" id="serviceCommunicationsBox">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="serviceCommunicationsCheck">
                            <label class="form-check-label fw-bold" for="serviceCommunicationsCheck">
                                <i class="bi bi-megaphone"></i> Comunicaciones
                            </label>
                        </div>
                        <div id="serviceCommunicationsFields" class="hidden">
                            <textarea class="form-control" id="serviceCommunicationsDesc" rows="4" 
                                      placeholder="Describa detalladamente los servicios requeridos.&#10;Ej: Dise√±o gr√°fico de afiches del evento (1 modelo y 10 copias). Comunicaci√≥n previa a las familias a trav√©s de Tilat√° te cuenta. Cubrimiento fotogr√°fico del evento."></textarea>
                        </div>
                    </div>
                
                    <!-- Servicio: Tecnolog√≠a -->
                    <div class="service-checkbox" id="serviceTechnologyBox">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="serviceTechnologyCheck">
                            <label class="form-check-label fw-bold" for="serviceTechnologyCheck">
                                <i class="bi bi-pc-display"></i> Recursos Tecnol√≥gicos
                            </label>
                        </div>
                        <div id="serviceTechnologyFields" class="hidden">
                            <textarea class="form-control" id="serviceTechnologyDesc" rows="4" 
                                      placeholder="Describa los recursos necesarios y su ubicaci√≥n.&#10;Ej: Video proyector con tel√≥n tipo blackout en el costado oriental del sal√≥n. Tres micr√≥fonos inal√°mbricos."></textarea>
                        </div>
                    </div>
                
                    <!-- Servicio: Organizaci√≥n del Sitio -->
                    <div class="service-checkbox" id="serviceSiteOrgBox">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="serviceSiteOrgCheck">
                            <label class="form-check-label fw-bold" for="serviceSiteOrgCheck">
                                <i class="bi bi-building"></i> Organizaci√≥n del Sitio
                            </label>
                        </div>
                        <div id="serviceSiteOrgFields" class="hidden">
                            <textarea class="form-control" id="serviceSiteOrgDesc" rows="4" 
                                      placeholder="Describa los muebles que se usar√°n con claridad del n√∫mero y ubicaci√≥n.&#10;Ej: 6 mesas cuadradas, cada mesa con 6 sillas, separadas entre s√≠ en el √°rea de medio coliseo."></textarea>
                        </div>
                    </div>
                
                    <!-- Servicio: Recursos -->
                    <div class="service-checkbox" id="serviceResourcesBox">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="serviceResourcesCheck">
                            <label class="form-check-label fw-bold" for="serviceResourcesCheck">
                                <i class="bi bi-box-seam"></i> Recursos (Papeler√≠a, Materiales)
                            </label>
                        </div>
                        <div id="serviceResourcesFields" class="hidden">
                            <textarea class="form-control" id="serviceResourcesDesc" rows="4" 
                                      placeholder="Describa el material necesario de forma detallada y con cantidades.&#10;Ej: 10 folios para tablero, 6 cartulinas blancas, 12 marcadores de los siguientes colores: rojo, verde, azul y negro."></textarea>
                        </div>
                    </div>
                
                    <!-- Servicio: Enfermer√≠a -->
                    <div class="service-checkbox" id="serviceNursingBox">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="serviceNursingCheck">
                            <label class="form-check-label fw-bold" for="serviceNursingCheck">
                                <i class="bi bi-heart-pulse"></i> Enfermer√≠a
                            </label>
                        </div>
                        <div id="serviceNursingFields" class="hidden">
                            <textarea class="form-control" id="serviceNursingDesc" rows="4" 
                                      placeholder="Describa el apoyo de enfermer√≠a requerido durante el evento.&#10;Ej: Presencia de enfermera durante todo el evento para atenci√≥n de primeros auxilios. Se esperan ni√±os menores de 5 a√±os, tener disponible botiqu√≠n pedi√°trico."></textarea>
                        </div>
                    </div>
                
                    <!-- Servicio: Transporte -->
                    <div class="service-checkbox" id="serviceTransportBox">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="serviceTransportCheck">
                            <label class="form-check-label fw-bold" for="serviceTransportCheck">
                                <i class="bi bi-bus-front"></i> Transporte
                            </label>
                        </div>
                        <div id="serviceTransportFields" class="hidden">
                            <textarea class="form-control" id="serviceTransportDesc" rows="4" 
                                      placeholder="La mayor√≠a de eventos internos no requieren transporte, pero de requerirlo descr√≠balo con claridad.&#10;Ej: Veh√≠culo para recoger a dos conferencistas en el Hotel Las Am√©ricas a las 6:25 AM. Preguntar por Pedro P√©rez. O: Veh√≠culos para 50 pasajeros, recogida a las 6:40 en Unicentro y Cachivaches."></textarea>
                        </div>
                    </div>
                
                    <!-- Servicio: Decoraci√≥n / Menaje -->
                    <div class="service-checkbox" id="serviceDecorationBox">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="serviceDecorationCheck">
                            <label class="form-check-label fw-bold" for="serviceDecorationCheck">
                                <i class="bi bi-flower1"></i> Decoraci√≥n / Menaje
                            </label>
                        </div>
                        <div id="serviceDecorationFields" class="hidden">
                            <textarea class="form-control" id="serviceDecorationDesc" rows="4" 
                                      placeholder="Describa con claridad los elementos de decoraci√≥n requeridos.&#10;Ej: Florero para dos docenas de flores entre claveles rojos y rosas blancas, para ubicar en el centro de la mesa principal."></textarea>
                        </div>
                    </div>
                
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Nota:</strong> Los servicios de apoyo son opcionales. Los costos de estos servicios 
                        ser√°n registrados posteriormente por cada √°rea responsable.
                    </div>
                </div>
                
                <!-- PASO 4: Solicitud de Aprobaci√≥n -->
                <div class="step-content" id="step4">
                    <h5 class="mb-4">Resumen y Solicitud de Aprobaci√≥n</h5>

                    <!-- Informaci√≥n B√°sica -->
                    <div class="event-detail-section">
                        <h6><i class="bi bi-info-circle"></i> Informaci√≥n B√°sica</h6>
                        <div class="row">
                            <div class="col-md-8">
                                <p class="mb-1"><strong>Nombre del Evento:</strong> <span id="summaryEventName"></span></p>
                                <p class="mb-1"><strong>Ubicaci√≥n:</strong> <span id="summaryLocation"></span></p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1"><strong>Fecha:</strong> <span id="summaryDate"></span></p>
                                <p class="mb-1"><strong>Horario:</strong> <span id="summaryTime"></span></p>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <p class="mb-0"><strong>Estudiantes:</strong> <span id="summaryStudents"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-0"><strong>Adultos:</strong> <span id="summaryAdults"></span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Refrigerios -->
                    <div class="event-detail-section hidden" id="summaryCateringSection">
                        <h6><i class="bi bi-cup-straw"></i> Refrigerios</h6>
                        <div id="summaryCateringContent"></div>
                    </div>

                    <!-- Servicios de Apoyo -->
                    <div class="event-detail-section hidden" id="summaryServicesSection">
                        <h6><i class="bi bi-gear"></i> Servicios de Apoyo</h6>
                        <div id="summaryServicesContent"></div>
                    </div>

                    <!-- Resumen de Costos -->
                    <div class="cost-summary">
                        <h6 class="mb-3"><i class="bi bi-calculator"></i> Resumen de Costos Estimados</h6>
                        <div id="costSummaryLines"></div>
                    </div>

                    <!-- Selecci√≥n de Aprobador -->
                    <div class="mt-4">
                        <h6 class="mb-3"><i class="bi bi-person-check"></i> Solicitud de Aprobaci√≥n</h6>
                        <div class="row">
                            <div class="col-md-8">
                                <label for="approverSelect" class="form-label">Seleccione el Aprobador <span class="text-danger">*</span></label>
                                <select class="form-select" id="approverSelect" required>
                                    <option value="">Cargando aprobadores...</option>
                                </select>
                                <small class="text-muted">
                                    Persona que revisar√° y aprobar√° este evento
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-4">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>Importante:</strong> Una vez enviado, el evento quedar√° en estado "Programado" 
                        y se enviar√° una notificaci√≥n al aprobador seleccionado. Tambi√©n se notificar√° 
                        autom√°ticamente a coordinaci√≥n de servicios, recepci√≥n y porter√≠a.
                    </div>
                </div>

            </div>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <button type="button" class="btn btn-secondary" id="btnPrevious">
                    <i class="bi bi-arrow-left"></i> Anterior
                </button>
                <div>
                    <button type="button" class="btn btn-outline-secondary me-2" id="btnCancel">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="btnNext">
                        Siguiente <i class="bi bi-arrow-right"></i>
                    </button>
                    <button type="button" class="btn btn-success hidden" id="btnSubmit">
                        <i class="bi bi-check-circle"></i> Guardar Evento
                    </button>
                </div>
            </div>
        </div>

        <!-- TABLA DE EVENTOS -->
        <div id="eventsTableContainer">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Lista de Eventos Internos</h5>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="filterStatus" class="form-label">Estado</label>
                            <select class="form-select" id="filterStatus">
                                <option value="">Todos los estados</option>
                                <option value="scheduled">Programado</option>
                                <option value="completed">Completado</option>
                                <option value="suspended">Suspendido</option>
                                <option value="cancelled">Cancelado</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="filterDateFrom" class="form-label">Fecha Desde</label>
                            <input type="text" class="form-control" id="filterDateFrom" placeholder="Seleccione fecha">
                        </div>
                        <div class="col-md-4">
                            <label for="filterDateTo" class="form-label">Fecha Hasta</label>
                            <input type="text" class="form-control" id="filterDateTo" placeholder="Seleccione fecha">
                        </div>
                    </div>

                    <!-- Tabla -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="eventsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nombre del Evento</th>
                                    <th>Fecha</th>
                                    <th>Horario</th>
                                    <th class="text-center">Estudiantes</th>
                                    <th class="text-center">Adultos</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="eventsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="bi bi-hourglass-split"></i> Cargando eventos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Ver Detalle -->
    <div class="modal fade" id="viewEventModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-eye"></i> Detalle del Evento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="viewEventBody">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Cambiar Estado -->
    <div class="modal fade" id="changeStatusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-arrow-repeat"></i> Cambiar Estado del Evento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="changeStatusEventId">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">Nuevo Estado <span class="text-danger">*</span></label>
                        <select class="form-select" id="newStatus" required>
                            <option value="">Seleccione...</option>
                            <option value="completed">Completado</option>
                            <option value="suspended">Suspendido</option>
                            <option value="cancelled">Cancelado</option>
                        </select>
                    </div>
                    <div class="mb-3 hidden" id="statusReasonContainer">
                        <label for="statusReason" class="form-label">Raz√≥n <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="statusReason" rows="3" 
                                  placeholder="Indique el motivo del cambio de estado..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnConfirmStatusChange">
                        <i class="bi bi-check-circle"></i> Confirmar Cambio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUserId = null;
        let currentWorkerId = null;
        let currentStep = 1;
        let editingEventId = null;
        
        // Datos del wizard
        let wizardData = {
            // Paso 1: Informaci√≥n B√°sica
            eventName: '',
            eventDate: '',
            startTime: '',
            endTime: '',
            eventLocation: '',
            numStudents: 0,
            numAdults: 0,
            
            // Paso 2: Refrigerios (m√∫ltiples men√∫s por grupo)
            cateringStudents: {
                enabled: false,
                items: [] // Cada item: { menuId, menuName, quantity, unitPrice, total }
            },
            cateringAdults: {
                enabled: false,
                items: []
            },
            
            // Paso 3: Servicios de Apoyo
            services: {
                staffing: { enabled: false, description: '' },
                communications: { enabled: false, description: '' },
                technology: { enabled: false, description: '' },
                site_organization: { enabled: false, description: '' },
                resources: { enabled: false, description: '' },
                nursing: { enabled: false, description: '' },
                transport: { enabled: false, description: '' },
                decoration: { enabled: false, description: '' }
            },
            
            // Paso 4: Aprobaci√≥n
            approverId: null
        };
        
        // Cat√°logo de men√∫s
        let menusData = [];
        
        // Aprobadores disponibles
        let approvers = [];
        // Configuraci√≥n del m√≥dulo
        let minAdvanceDays = 7; // Valor por defecto
        let serviceEmails = {}; // Correos de notificaci√≥n desde BD

        // ==========================================
        // INICIALIZACI√ìN - PATR√ìN OBLIGATORIO
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // PASO 1: SIEMPRE validar permisos primero
                const hasAccess = await validatePageAccess('Eventos internos');
                if (!hasAccess) return;
                
                console.log('‚úÖ Acceso permitido');
                
                // PASO 2: Obtener user_id y worker_id del usuario actual
                const session = getStoredSession();
                if (!session) {
                    showMessage('Sesi√≥n no v√°lida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '../../index.html', 2000);
                    return;
                }
                
                try {
                    // Obtener el user_id y email del usuario actual
                    const userData = await supabaseRequest('/users?select=user_id,user_mail&limit=1');
                    if (!userData || userData.length === 0) {
                        throw new Error('No se pudo obtener informaci√≥n del usuario');
                    }
                    
                    currentUserId = userData[0].user_id;
                    const userEmail = userData[0].user_mail;
                    console.log('‚úÖ User ID actual:', currentUserId);
                    
                    // Obtener el worker_id usando el email
                    const workerData = await supabaseRequest(`/workers?email=eq.${userEmail}&select=worker_id`);
                    
                    if (!workerData || workerData.length === 0) {
                        showMessage('No se encontr√≥ informaci√≥n de trabajador para este usuario. Contacte al administrador.', 'danger');
                        return;
                    }
                    
                    currentWorkerId = workerData[0].worker_id;
                    console.log('‚úÖ Worker ID actual:', currentWorkerId);
                    
                } catch (error) {
                    console.error('Error obteniendo IDs de usuario:', error);
                    showMessage('Error obteniendo informaci√≥n del usuario: ' + error.message, 'danger');
                    return;
                }
                
                // PASO 3: Inicializar p√°gina
                initializePage('Eventos Internos', 'services');
                
                // PASO 4: Inicializar componentes
                await loadModuleConfig(); // ‚Üê AGREGAR PRIMERO
                initializeFlatpickr();
                await loadMenusCatalog();
                await loadApprovers();
                
                // PASO 5: Cargar eventos
                await loadEvents();
                
                // PASO 6: Event listeners
                setupEventListeners();
                
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                showMessage('Error al inicializar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // INICIALIZACI√ìN DE COMPONENTES
        // ==========================================
        
        function initializeFlatpickr() {
            // Calcular fecha m√≠nima seg√∫n configuraci√≥n
            const today = new Date();
            const minDate = new Date(today);
            minDate.setDate(today.getDate() + minAdvanceDays);
            
            // Fecha del evento
            flatpickr('#eventDate', {
                locale: 'es',
                dateFormat: 'Y-m-d',
                minDate: minDate, // ‚Üê Usar fecha calculada
                altInput: true,
                altFormat: 'F j, Y',
                onChange: function(selectedDates, dateStr) {
                    wizardData.eventDate = dateStr;
                },
                onReady: function(selectedDates, dateStr, instance) {
                    // Mensaje informativo
                    const input = instance.altInput;
                    input.placeholder = `M√≠nimo ${minAdvanceDays} d√≠as de antelaci√≥n`;
                }
            });
            
            // Filtros de fecha (sin restricci√≥n)
            flatpickr('#filterDateFrom', {
                locale: 'es',
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: 'F j, Y',
                onChange: function() {
                    loadEvents();
                }
            });
            
            flatpickr('#filterDateTo', {
                locale: 'es',
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: 'F j, Y',
                onChange: function() {
                    loadEvents();
                }
            });
        }

        // ==========================================
        // CARGA DE DATOS
        // ==========================================

        async function loadModuleConfig() {
            try {
                // Cargar TODAS las configuraciones del m√≥dulo de una vez
                const configs = await supabaseRequest('/svc_module_config?select=config_key,config_value');
                
                if (configs && configs.length > 0) {
                    configs.forEach(config => {
                        // D√≠as m√≠nimos de antelaci√≥n
                        if (config.config_key === 'min_days_advance') {
                            minAdvanceDays = parseInt(config.config_value) || 7;
                        }
                        
                        // Correos de notificaci√≥n
                        if (config.config_key.startsWith('email_')) {
                            const emailKey = config.config_key.replace('email_', '');
                            serviceEmails[emailKey] = config.config_value;
                        }
                    });
                    
                    console.log(`‚úÖ D√≠as m√≠nimos de antelaci√≥n: ${minAdvanceDays} (desde BD)`);
                    console.log(`‚úÖ ${Object.keys(serviceEmails).length} correos de notificaci√≥n cargados`);
                } else {
                    console.warn('‚ö†Ô∏è No se encontr√≥ configuraci√≥n del m√≥dulo, usando valores por defecto');
                }
            } catch (error) {
                console.error('Error cargando configuraci√≥n del m√≥dulo:', error);
                console.warn('‚ö†Ô∏è Usando valores por defecto');
            }
        }
        
        async function loadMenusCatalog() {
            try {
                const data = await supabaseRequest('/svc_catering_menus?is_active=eq.true&select=*&order=menu_name');
                
                menusData = data || [];
                console.log(`‚úÖ ${menusData.length} men√∫s cargados`);
                
                // Los men√∫s se cargan din√°micamente al agregar l√≠neas de refrigerio
                // (ya no hay selects fijos en el HTML)
                
            } catch (error) {
                console.error('Error cargando men√∫s:', error);
                showMessage('Error al cargar el cat√°logo de men√∫s', 'warning');
            }
        }

        async function loadApprovers() {
            try {
                // Usar la funci√≥n RPC creada
                const data = await supabaseRequest('/rpc/get_workers_with_permission', {
                    method: 'POST',
                    body: JSON.stringify({ permission_name: 'Resoluci√≥n de solicitudes' })
                });
                
                approvers = data || [];
                console.log(`‚úÖ ${approvers.length} aprobadores cargados`);
                
                // Poblar select
                const select = document.getElementById('approverSelect');
                if (approvers.length === 0) {
                    select.innerHTML = '<option value="">No hay aprobadores disponibles</option>';
                } else {
                    const optionsHTML = approvers
                    .sort((a, b) => (a.worker_last_name_1 || '').localeCompare(b.worker_last_name_1 || ''))
                    .map(approver => 
                        `<option value="${approver.worker_id}" data-email="${approver.email || ''}">
                            ${approver.worker_last_name_1} ${approver.worker_first_name}
                        </option>`
                    ).join('');
                    select.innerHTML = '<option value="">Seleccione un aprobador...</option>' + optionsHTML;
                }
                
            } catch (error) {
                console.error('Error cargando aprobadores:', error);
                
                // Intentar carga alternativa
                try {
                    const workers = await supabaseRequest('/workers?worker_status=eq.active&select=worker_id,worker_first_name,worker_last_name_1,email&order=worker_first_name');
                    
                    if (workers) {
                        approvers = workers;
                        const select = document.getElementById('approverSelect');
                        const optionsHTML = workers
                        .sort((a, b) => (a.worker_last_name_1 || '').localeCompare(b.worker_last_name_1 || ''))
                        .map(w => 
                            `<option value="${w.worker_id}" data-email="${w.email || ''}">${w.worker_last_name_1} ${w.worker_first_name}</option>`
                        ).join('');
                        select.innerHTML = '<option value="">Seleccione un aprobador...</option>' + optionsHTML;
                        console.log('‚úÖ Aprobadores cargados (modo alternativo)');
                    }
                } catch (altError) {
                    console.error('Error en carga alternativa:', altError);
                    showMessage('Error al cargar la lista de aprobadores', 'warning');
                }
            }
        }

        async function loadEvents() {
            try {
                const tbody = document.getElementById('eventsTableBody');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center"><i class="bi bi-hourglass-split"></i> Cargando...</td></tr>';
                
                let query = '/svc_internal_events?select=*,created_by_user:users!svc_internal_events_created_by_fkey(user_name)&order=event_date.desc';
                
                // Filtros
                const filterStatus = document.getElementById('filterStatus').value;
                if (filterStatus) {
                    query += `&event_status=eq.${filterStatus}`;
                }
                
                const filterDateFrom = document.getElementById('filterDateFrom').value;
                if (filterDateFrom) {
                    query += `&event_date=gte.${filterDateFrom}`;
                }
                
                const filterDateTo = document.getElementById('filterDateTo').value;
                if (filterDateTo) {
                    query += `&event_date=lte.${filterDateTo}`;
                }
                
                const data = await supabaseRequest(query);
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay eventos registrados</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(event => renderEventRow(event)).join('');
                console.log(`‚úÖ ${data.length} eventos cargados`);
                
            } catch (error) {
                console.error('Error cargando eventos:', error);
                showMessage('Error al cargar los eventos', 'danger');
            }
        }
        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        
        function setupEventListeners() {
            // Bot√≥n nuevo evento
            document.getElementById('btnNewEvent').addEventListener('click', function() {
                resetWizard();
                showWizard();
            });
            
            // Navegaci√≥n del wizard
            document.getElementById('btnNext').addEventListener('click', nextStep);
            document.getElementById('btnPrevious').addEventListener('click', previousStep);
            document.getElementById('btnCancel').addEventListener('click', cancelWizard);
            document.getElementById('btnSubmit').addEventListener('click', saveEvent);
            
            // Paso 1: Actualizar cantidades
            document.getElementById('numStudents').addEventListener('input', updateParticipantCounts);
            document.getElementById('numAdults').addEventListener('input', updateParticipantCounts);
            
            // Paso 2: Refrigerios (m√∫ltiples men√∫s)
            document.getElementById('cateringStudentsCheck').addEventListener('change', toggleCateringStudents);
            document.getElementById('cateringAdultsCheck').addEventListener('change', toggleCateringAdults);
            document.getElementById('btnAddMenuStudents').addEventListener('click', function() {
                addCateringLine('students');
            });
            document.getElementById('btnAddMenuAdults').addEventListener('click', function() {
                addCateringLine('adults');
            });
            
            // Paso 3: Servicios de Apoyo
            document.getElementById('serviceStaffingCheck').addEventListener('change', function() {
                toggleServiceField('staffing');
            });
            document.getElementById('serviceCommunicationsCheck').addEventListener('change', function() {
                toggleServiceField('communications');
            });
            document.getElementById('serviceTechnologyCheck').addEventListener('change', function() {
                toggleServiceField('technology');
            });
            document.getElementById('serviceSiteOrgCheck').addEventListener('change', function() {
                toggleServiceField('site_organization');
            });
            document.getElementById('serviceResourcesCheck').addEventListener('change', function() {
                toggleServiceField('resources');
            });
            document.getElementById('serviceNursingCheck').addEventListener('change', function() {
                toggleServiceField('nursing');
            });
            document.getElementById('serviceTransportCheck').addEventListener('change', function() {
                toggleServiceField('transport');
            });
            document.getElementById('serviceDecorationCheck').addEventListener('change', function() {
                toggleServiceField('decoration');
            });
            
            // Filtros de tabla
            document.getElementById('filterStatus').addEventListener('change', loadEvents);
            
            // Modal cambiar estado
            document.getElementById('newStatus').addEventListener('change', function() {
                const statusReasonContainer = document.getElementById('statusReasonContainer');
                const value = this.value;
                if (value === 'suspended' || value === 'cancelled') {
                    statusReasonContainer.classList.remove('hidden');
                    document.getElementById('statusReason').required = true;
                } else {
                    statusReasonContainer.classList.add('hidden');
                    document.getElementById('statusReason').required = false;
                }
            });
            
            document.getElementById('btnConfirmStatusChange').addEventListener('click', confirmStatusChange);
        }

        // ==========================================
        // NAVEGACI√ìN DEL WIZARD
        // ==========================================
        
        function nextStep() {
            // Validar paso actual antes de avanzar
            if (!validateCurrentStep()) {
                return;
            }
            
            // Guardar datos del paso actual
            saveCurrentStepData();
            
            // Avanzar al siguiente paso
            if (currentStep < 4) {
                currentStep++;
                updateWizardUI();
                
                // Si es el paso 4, generar resumen
                if (currentStep === 4) {
                    generateSummary();
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateWizardUI();
            }
        }

        function updateWizardUI() {
            // Actualizar pasos visuales
            document.querySelectorAll('.wizard-step').forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNumber === currentStep) {
                    step.classList.add('active');
                } else if (stepNumber < currentStep) {
                    step.classList.add('completed');
                }
            });
            
            // Mostrar/ocultar contenido de pasos
            document.querySelectorAll('.step-content').forEach((content, index) => {
                const stepNumber = index + 1;
                if (stepNumber === currentStep) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // Controlar botones de navegaci√≥n
            const btnPrevious = document.getElementById('btnPrevious');
            const btnNext = document.getElementById('btnNext');
            const btnSubmit = document.getElementById('btnSubmit');
            
            btnPrevious.classList.toggle('hidden', currentStep === 1);
            
            if (currentStep === 4) {
                btnNext.classList.add('hidden');
                btnSubmit.classList.remove('hidden');
            } else {
                btnNext.classList.remove('hidden');
                btnSubmit.classList.add('hidden');
            }
            
            // Scroll al inicio del contenido
            document.querySelector('.wizard-content').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    return validateStep1();
                case 2:
                    return validateStep2();
                case 3:
                    return validateStep3();
                case 4:
                    return validateStep4();
                default:
                    return true;
            }
        }

        function validateStep1() {
            const eventName = document.getElementById('eventName').value.trim();
            const eventDate = document.getElementById('eventDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const eventLocation = document.getElementById('eventLocation').value.trim();
            const numStudents = parseInt(document.getElementById('numStudents').value) || 0;
            const numAdults = parseInt(document.getElementById('numAdults').value) || 0;
            
            if (!eventName) {
                showMessage('Por favor ingrese el nombre del evento', 'warning');
                document.getElementById('eventName').focus();
                return false;
            }
            
            if (!eventDate) {
                showMessage('Por favor seleccione la fecha del evento', 'warning');
                document.getElementById('eventDate').focus();
                return false;
            }

            // Validar d√≠as m√≠nimos de antelaci√≥n
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selectedDate = new Date(eventDate + 'T00:00:00');
            const diffTime = selectedDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < minAdvanceDays) {
                showMessage(`La fecha del evento debe ser al menos ${minAdvanceDays} d√≠as en el futuro`, 'warning');
                document.getElementById('eventDate').focus();
                return false;
            }
            
            if (!startTime) {
                showMessage('Por favor ingrese la hora de inicio', 'warning');
                document.getElementById('startTime').focus();
                return false;
            }
            
            if (!endTime) {
                showMessage('Por favor ingrese la hora de finalizaci√≥n', 'warning');
                document.getElementById('endTime').focus();
                return false;
            }
            
            if (startTime >= endTime) {
                showMessage('La hora de finalizaci√≥n debe ser posterior a la hora de inicio', 'warning');
                document.getElementById('endTime').focus();
                return false;
            }
            
            if (!eventLocation) {
                showMessage('Por favor ingrese la ubicaci√≥n del evento', 'warning');
                document.getElementById('eventLocation').focus();
                return false;
            }
            
            if (numStudents === 0 && numAdults === 0) {
                showMessage('Debe indicar al menos un participante (estudiantes o adultos)', 'warning');
                document.getElementById('numStudents').focus();
                return false;
            }
            
            return true;
        }

        function validateStep2() {
            // Refrigerios estudiantes
            if (document.getElementById('cateringStudentsCheck').checked) {
                const lines = document.querySelectorAll('#cateringStudentsLines .catering-line');
                let hasValidMenu = false;
                
                for (const line of lines) {
                    const select = line.querySelector('.catering-menu-select');
                    if (select.value) {
                        hasValidMenu = true;
                    }
                }
                
                if (!hasValidMenu) {
                    showMessage('Por favor seleccione al menos un men√∫ para estudiantes', 'warning');
                    return false;
                }
            }
            
            // Refrigerios adultos
            if (document.getElementById('cateringAdultsCheck').checked) {
                const lines = document.querySelectorAll('#cateringAdultsLines .catering-line');
                let hasValidMenu = false;
                
                for (const line of lines) {
                    const select = line.querySelector('.catering-menu-select');
                    if (select.value) {
                        hasValidMenu = true;
                    }
                }
                
                if (!hasValidMenu) {
                    showMessage('Por favor seleccione al menos un men√∫ para adultos', 'warning');
                    return false;
                }
            }
            
            return true;
        }

        function validateStep3() {
            // Validar que si se marca el checkbox, tenga descripci√≥n
            const serviceTypes = ['staffing', 'communications', 'technology', 'site_organization', 'resources', 'nursing', 'transport', 'decoration'];
            
            for (const type of serviceTypes) {
                const checkbox = document.getElementById(`service${getServiceCheckboxId(type)}Check`);
                const textarea = document.getElementById(`service${getServiceCheckboxId(type)}Desc`);
                
                if (checkbox.checked) {
                    const description = textarea.value.trim();
                    if (!description) {
                        showMessage(`Por favor describa las necesidades del servicio de ${getServiceLabel(type)}`, 'warning');
                        textarea.focus();
                        return false;
                    }
                }
            }
            
            return true;
        }

        function validateStep4() {
            const approverId = document.getElementById('approverSelect').value;
            
            if (!approverId) {
                showMessage('Por favor seleccione un aprobador', 'warning');
                document.getElementById('approverSelect').focus();
                return false;
            }
            
            return true;
        }
        // ==========================================
        // GUARDADO DE DATOS DEL WIZARD
        // ==========================================
        
        function saveCurrentStepData() {
            switch (currentStep) {
                case 1:
                    saveStep1Data();
                    break;
                case 2:
                    saveStep2Data();
                    break;
                case 3:
                    saveStep3Data();
                    break;
                case 4:
                    saveStep4Data();
                    break;
            }
        }

        function saveStep1Data() {
            wizardData.eventName = document.getElementById('eventName').value.trim();
            wizardData.eventDate = document.getElementById('eventDate').value;
            wizardData.startTime = document.getElementById('startTime').value;
            wizardData.endTime = document.getElementById('endTime').value;
            wizardData.eventLocation = document.getElementById('eventLocation').value.trim();
            wizardData.numStudents = parseInt(document.getElementById('numStudents').value) || 0;
            wizardData.numAdults = parseInt(document.getElementById('numAdults').value) || 0;
        }

        function saveStep2Data() {
            // Refrigerios estudiantes
            wizardData.cateringStudents.enabled = document.getElementById('cateringStudentsCheck').checked;
            wizardData.cateringStudents.items = [];
            
            if (wizardData.cateringStudents.enabled) {
                const lines = document.querySelectorAll('#cateringStudentsLines .catering-line');
                lines.forEach(line => {
                    const select = line.querySelector('.catering-menu-select');
                    if (select.value) {
                        const selectedOption = select.options[select.selectedIndex];
                        const quantity = parseInt(line.querySelector('.catering-qty').value) || 0;
                        const unitPrice = parseFloat(selectedOption.dataset.price) || 0;
                        
                        wizardData.cateringStudents.items.push({
                            menuId: select.value,
                            menuName: selectedOption.text.split(' - ')[0].trim(),
                            quantity: quantity,
                            unitPrice: unitPrice,
                            total: quantity * unitPrice
                        });
                    }
                });
            }
            
            // Refrigerios adultos
            wizardData.cateringAdults.enabled = document.getElementById('cateringAdultsCheck').checked;
            wizardData.cateringAdults.items = [];
            
            if (wizardData.cateringAdults.enabled) {
                const lines = document.querySelectorAll('#cateringAdultsLines .catering-line');
                lines.forEach(line => {
                    const select = line.querySelector('.catering-menu-select');
                    if (select.value) {
                        const selectedOption = select.options[select.selectedIndex];
                        const quantity = parseInt(line.querySelector('.catering-qty').value) || 0;
                        const unitPrice = parseFloat(selectedOption.dataset.price) || 0;
                        
                        wizardData.cateringAdults.items.push({
                            menuId: select.value,
                            menuName: selectedOption.text.split(' - ')[0].trim(),
                            quantity: quantity,
                            unitPrice: unitPrice,
                            total: quantity * unitPrice
                        });
                    }
                });
            }
        }

        function saveStep3Data() {
            const serviceTypes = ['staffing', 'communications', 'technology', 'site_organization', 'resources', 'nursing', 'transport', 'decoration'];
            
            serviceTypes.forEach(type => {
                const checkbox = document.getElementById(`service${getServiceCheckboxId(type)}Check`);
                const textarea = document.getElementById(`service${getServiceCheckboxId(type)}Desc`);
                
                wizardData.services[type].enabled = checkbox.checked;
                wizardData.services[type].description = checkbox.checked ? textarea.value.trim() : '';
            });
        }

        function saveStep4Data() {
            wizardData.approverId = document.getElementById('approverSelect').value;
        }

        // ==========================================
        // FUNCIONES DE ACTUALIZACI√ìN EN TIEMPO REAL
        // ==========================================
        
        function updateParticipantCounts() {
            // Actualizar cantidades en todas las l√≠neas de refrigerios
            if (document.getElementById('cateringStudentsCheck').checked) {
                updateCateringQuantities('students');
            }
            if (document.getElementById('cateringAdultsCheck').checked) {
                updateCateringQuantities('adults');
            }
        }

        // ==========================================
        // REFRIGERIOS: M√öLTIPLES MEN√öS POR GRUPO
        // ==========================================
        
        function toggleCateringStudents() {
            const isChecked = document.getElementById('cateringStudentsCheck').checked;
            const fieldsContainer = document.getElementById('cateringStudentsFields');
            const box = document.getElementById('cateringStudentsBox');
            
            if (isChecked) {
                fieldsContainer.classList.remove('hidden');
                box.classList.add('active');
                // Agregar primera l√≠nea autom√°ticamente si no hay ninguna
                if (document.getElementById('cateringStudentsLines').children.length === 0) {
                    addCateringLine('students');
                }
            } else {
                fieldsContainer.classList.add('hidden');
                box.classList.remove('active');
                document.getElementById('cateringStudentsLines').innerHTML = '';
                document.getElementById('cateringStudentsSubtotal').style.display = 'none';
            }
        }
        
        function toggleCateringAdults() {
            const isChecked = document.getElementById('cateringAdultsCheck').checked;
            const fieldsContainer = document.getElementById('cateringAdultsFields');
            const box = document.getElementById('cateringAdultsBox');
            
            if (isChecked) {
                fieldsContainer.classList.remove('hidden');
                box.classList.add('active');
                if (document.getElementById('cateringAdultsLines').children.length === 0) {
                    addCateringLine('adults');
                }
            } else {
                fieldsContainer.classList.add('hidden');
                box.classList.remove('active');
                document.getElementById('cateringAdultsLines').innerHTML = '';
                document.getElementById('cateringAdultsSubtotal').style.display = 'none';
            }
        }
        
        function addCateringLine(group) {
            const container = document.getElementById(`catering${capitalize(group)}Lines`);
            const lineIndex = container.children.length;
            const quantity = group === 'students' ? 
                (parseInt(document.getElementById('numStudents').value) || 0) :
                (parseInt(document.getElementById('numAdults').value) || 0);
            
            // Generar opciones de men√∫, excluyendo los ya seleccionados en este grupo
            const selectedMenuIds = getSelectedMenuIds(group);
            const optionsHTML = menusData
                .filter(menu => !selectedMenuIds.includes(menu.menu_id))
                .map(menu => 
                    `<option value="${menu.menu_id}" data-price="${menu.unit_price}">
                        ${menu.menu_name} - $${formatCurrency(menu.unit_price)}
                    </option>`
                ).join('');
            
            if (optionsHTML === '') {
                showMessage('Ya se han agregado todos los men√∫s disponibles para este grupo', 'info');
                return;
            }
            
            const lineHTML = `
                <div class="row align-items-end mb-2 catering-line" data-group="${group}" data-index="${lineIndex}">
                    <div class="col-md-5 mb-1">
                        <label class="form-label mb-1 small">Men√∫</label>
                        <select class="form-select form-select-sm catering-menu-select" 
                                data-group="${group}" data-index="${lineIndex}" 
                                onchange="calculateCateringLine(this)">
                            <option value="">Seleccione un men√∫...</option>
                            ${optionsHTML}
                        </select>
                    </div>
                    <div class="col-md-2 mb-1">
                        <label class="form-label mb-1 small">Cantidad</label>
                        <input type="number" class="form-control form-control-sm catering-qty" value="${quantity}" readonly>
                    </div>
                    <div class="col-md-2 mb-1">
                        <label class="form-label mb-1 small">Precio Unit.</label>
                        <input type="text" class="form-control form-control-sm catering-price" readonly>
                    </div>
                    <div class="col-md-2 mb-1">
                        <label class="form-label mb-1 small">Total</label>
                        <input type="text" class="form-control form-control-sm fw-bold catering-total" readonly>
                    </div>
                    <div class="col-md-1 mb-1">
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                onclick="removeCateringLine(this, '${group}')" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', lineHTML);
        }
        
        function removeCateringLine(button, group) {
            const line = button.closest('.catering-line');
            line.remove();
            updateCateringSubtotal(group);
            
            // Si no quedan l√≠neas y el checkbox sigue marcado, agregar una nueva
            const container = document.getElementById(`catering${capitalize(group)}Lines`);
            if (container.children.length === 0) {
                addCateringLine(group);
            }
        }
        
        function calculateCateringLine(selectElement) {
            const line = selectElement.closest('.catering-line');
            const group = selectElement.dataset.group;
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            
            const priceInput = line.querySelector('.catering-price');
            const totalInput = line.querySelector('.catering-total');
            const qtyInput = line.querySelector('.catering-qty');
            
            if (selectElement.value && selectedOption) {
                const unitPrice = parseFloat(selectedOption.dataset.price) || 0;
                const quantity = parseInt(qtyInput.value) || 0;
                const total = unitPrice * quantity;
                
                priceInput.value = `$${formatCurrency(unitPrice)}`;
                totalInput.value = `$${formatCurrency(total)}`;
            } else {
                priceInput.value = '';
                totalInput.value = '';
            }
            
            updateCateringSubtotal(group);
        }
        
        function updateCateringSubtotal(group) {
            const container = document.getElementById(`catering${capitalize(group)}Lines`);
            const lines = container.querySelectorAll('.catering-line');
            let subtotal = 0;
            
            lines.forEach(line => {
                const select = line.querySelector('.catering-menu-select');
                const qtyInput = line.querySelector('.catering-qty');
                const selectedOption = select.options[select.selectedIndex];
                
                if (select.value && selectedOption) {
                    const unitPrice = parseFloat(selectedOption.dataset.price) || 0;
                    const quantity = parseInt(qtyInput.value) || 0;
                    subtotal += unitPrice * quantity;
                }
            });
            
            const subtotalDiv = document.getElementById(`catering${capitalize(group)}Subtotal`);
            const subtotalValue = document.getElementById(`subtotal${capitalize(group)}Value`);
            
            if (subtotal > 0) {
                subtotalDiv.style.display = 'block';
                subtotalValue.textContent = `$${formatCurrency(subtotal)}`;
            } else {
                subtotalDiv.style.display = 'none';
            }
        }
        
        function getSelectedMenuIds(group) {
            const container = document.getElementById(`catering${capitalize(group)}Lines`);
            const selects = container.querySelectorAll('.catering-menu-select');
            const ids = [];
            
            selects.forEach(select => {
                if (select.value) {
                    ids.push(select.value);
                }
            });
            
            return ids;
        }
        
        function updateCateringQuantities(group) {
            const container = document.getElementById(`catering${capitalize(group)}Lines`);
            const quantity = group === 'students' ? 
                (parseInt(document.getElementById('numStudents').value) || 0) :
                (parseInt(document.getElementById('numAdults').value) || 0);
            
            const lines = container.querySelectorAll('.catering-line');
            lines.forEach(line => {
                const qtyInput = line.querySelector('.catering-qty');
                qtyInput.value = quantity;
                
                // Recalcular total de la l√≠nea
                const select = line.querySelector('.catering-menu-select');
                calculateCateringLine(select);
            });
        }

        
        function toggleServiceField(type) {
            const checkboxId = getServiceCheckboxId(type);
            const checkbox = document.getElementById(`service${checkboxId}Check`);
            const fieldsContainer = document.getElementById(`service${checkboxId}Fields`);
            const box = document.getElementById(`service${checkboxId}Box`);
            
            if (checkbox.checked) {
                fieldsContainer.classList.remove('hidden');
                box.classList.add('active');
                document.getElementById(`service${checkboxId}Desc`).focus();
            } else {
                fieldsContainer.classList.add('hidden');
                box.classList.remove('active');
                document.getElementById(`service${checkboxId}Desc`).value = '';
            }
        }
        // ==========================================
        // GENERACI√ìN DEL RESUMEN (PASO 5)
        // ==========================================
        
        function generateSummary() {
            // Guardar datos actuales
            saveStep1Data();
            saveStep2Data();
            saveStep3Data();
            
            // Informaci√≥n B√°sica
            document.getElementById('summaryEventName').textContent = wizardData.eventName;
            document.getElementById('summaryLocation').textContent = wizardData.eventLocation;
            document.getElementById('summaryDate').textContent = formatDateDisplay(wizardData.eventDate);
            document.getElementById('summaryTime').textContent = `${wizardData.startTime} - ${wizardData.endTime}`;
            document.getElementById('summaryStudents').textContent = wizardData.numStudents;
            document.getElementById('summaryAdults').textContent = wizardData.numAdults;

            // Refrigerios
            const cateringSection = document.getElementById('summaryCateringSection');
            const cateringContent = document.getElementById('summaryCateringContent');
            
            const hasCatering = (wizardData.cateringStudents.enabled && wizardData.cateringStudents.items.length > 0) || 
                                (wizardData.cateringAdults.enabled && wizardData.cateringAdults.items.length > 0);
            
            if (hasCatering) {
                cateringSection.classList.remove('hidden');
                let cateringHTML = '';
                
                if (wizardData.cateringStudents.enabled && wizardData.cateringStudents.items.length > 0) {
                    cateringHTML += '<p class="mb-1"><strong>Estudiantes:</strong></p><ul class="mb-2">';
                    wizardData.cateringStudents.items.forEach(item => {
                        cateringHTML += `<li>${item.menuName} x ${item.quantity} = 
                            <span class="text-primary fw-bold">$${formatCurrency(item.total)}</span></li>`;
                    });
                    cateringHTML += '</ul>';
                }
                
                if (wizardData.cateringAdults.enabled && wizardData.cateringAdults.items.length > 0) {
                    cateringHTML += '<p class="mb-1"><strong>Adultos:</strong></p><ul class="mb-2">';
                    wizardData.cateringAdults.items.forEach(item => {
                        cateringHTML += `<li>${item.menuName} x ${item.quantity} = 
                            <span class="text-primary fw-bold">$${formatCurrency(item.total)}</span></li>`;
                    });
                    cateringHTML += '</ul>';
                }
                
                cateringContent.innerHTML = cateringHTML;
            } else {
                cateringSection.classList.add('hidden');
            }
            
            // Servicios de Apoyo
            const servicesSection = document.getElementById('summaryServicesSection');
            const servicesContent = document.getElementById('summaryServicesContent');
            
            const hasServices = Object.values(wizardData.services).some(s => s.enabled);
            
            if (hasServices) {
                servicesSection.classList.remove('hidden');
                let servicesHTML = '';
                
                Object.keys(wizardData.services).forEach(type => {
                    if (wizardData.services[type].enabled) {
                        servicesHTML += `
                            <div class="mb-3">
                                <strong class="text-primary">${getServiceLabel(type)}:</strong>
                                <p class="mb-0 ms-3">${wizardData.services[type].description}</p>
                            </div>
                        `;
                    }
                });
                
                servicesContent.innerHTML = servicesHTML;
            } else {
                servicesSection.classList.add('hidden');
            }
            
            // Resumen de Costos
            generateCostSummary();
        }

        function generateCostSummary() {
            let totalCost = 0;
            let linesHTML = '';
            
            // Refrigerios estudiantes
            if (wizardData.cateringStudents.enabled && wizardData.cateringStudents.items.length > 0) {
                const cost = wizardData.cateringStudents.items.reduce((sum, item) => sum + item.total, 0);
                totalCost += cost;
                linesHTML += `
                    <div class="cost-line">
                        <span>Refrigerios Estudiantes (${wizardData.cateringStudents.items.length} men√∫${wizardData.cateringStudents.items.length > 1 ? 's' : ''})</span>
                        <span class="fw-bold">$${formatCurrency(cost)}</span>
                    </div>
                `;
            }
            
            // Refrigerios adultos
            if (wizardData.cateringAdults.enabled && wizardData.cateringAdults.items.length > 0) {
                const cost = wizardData.cateringAdults.items.reduce((sum, item) => sum + item.total, 0);
                totalCost += cost;
                linesHTML += `
                    <div class="cost-line">
                        <span>Refrigerios Adultos (${wizardData.cateringAdults.items.length} men√∫${wizardData.cateringAdults.items.length > 1 ? 's' : ''})</span>
                        <span class="fw-bold">$${formatCurrency(cost)}</span>
                    </div>
                `;
            }
            
            // Nota sobre servicios de apoyo
            const hasServices = Object.values(wizardData.services).some(s => s.enabled);
            if (hasServices) {
                linesHTML += `
                    <div class="cost-line">
                        <span><em>Costos de servicios de apoyo (a registrar por cada √°rea)</em></span>
                        <span class="text-muted">Pendiente</span>
                    </div>
                `;
            }
            
            // Total
            linesHTML += `
                <div class="cost-line">
                    <span>TOTAL ESTIMADO</span>
                    <span>$${formatCurrency(totalCost)}</span>
                </div>
            `;
            
            document.getElementById('costSummaryLines').innerHTML = linesHTML;
        }

        // ==========================================
        // GUARDADO DEL EVENTO
        // ==========================================
        
        async function saveEvent() {
            try {
                // Validar paso 5
                if (!validateStep4()) {
                    return;
                }
                
                saveStep4Data();
                
                // Deshabilitar bot√≥n para evitar doble clic
                const btnSubmit = document.getElementById('btnSubmit');
                btnSubmit.disabled = true;
                btnSubmit.innerHTML = '<i class="bi bi-hourglass-split"></i> Guardando...';
                
                console.log('üìù Guardando evento...', wizardData);
                
                // 1. Crear la solicitud de aprobaci√≥n
                const requestData = await supabaseRequest('/svc_service_requests', {
                    method: 'POST',
                    body: JSON.stringify({
                        service_type: 'internal_event',
                        requested_by: currentWorkerId,
                        approver_id: wizardData.approverId,
                        request_status: 'pending'
                    })
                });
                
                const requestId = requestData[0].request_id;
                console.log('‚úÖ Solicitud creada:', requestId);
                
                // 2. Crear el evento principal
                const eventData = await supabaseRequest('/svc_internal_events', {
                    method: 'POST',
                    body: JSON.stringify({
                        request_id: requestId,
                        event_name: wizardData.eventName,
                        event_date: wizardData.eventDate,
                        start_time: wizardData.startTime,
                        end_time: wizardData.endTime,
                        event_location: wizardData.eventLocation,
                        num_students: wizardData.numStudents,
                        num_adults: wizardData.numAdults,
                        event_status: 'scheduled',
                        created_by: currentUserId
                    })
                });
                
                const eventId = eventData[0].event_id;
                console.log('‚úÖ Evento creado:', eventId);
                
                // 3. Insertar refrigerios (m√∫ltiples por grupo)
                const cateringInserts = [];
                
                if (wizardData.cateringStudents.enabled) {
                    wizardData.cateringStudents.items.forEach(item => {
                        cateringInserts.push({
                            event_id: eventId,
                            target_group: 'students',
                            menu_id: item.menuId,
                            quantity: item.quantity,
                            frozen_unit_price: item.unitPrice,
                            total_value: item.total
                        });
                    });
                }
                
                if (wizardData.cateringAdults.enabled) {
                    wizardData.cateringAdults.items.forEach(item => {
                        cateringInserts.push({
                            event_id: eventId,
                            target_group: 'adults',
                            menu_id: item.menuId,
                            quantity: item.quantity,
                            frozen_unit_price: item.unitPrice,
                            total_value: item.total
                        });
                    });
                }
                
                if (cateringInserts.length > 0) {
                    await supabaseRequest('/svc_internal_event_catering', {
                        method: 'POST',
                        body: JSON.stringify(cateringInserts)
                    });
                    console.log('‚úÖ Refrigerios insertados');
                }
                
                // 4. Insertar servicios de apoyo
                const serviceInserts = [];
                
                Object.keys(wizardData.services).forEach(serviceType => {
                    if (wizardData.services[serviceType].enabled) {
                        serviceInserts.push({
                            event_id: eventId,
                            service_type: serviceType,
                            description: wizardData.services[serviceType].description,
                            notified_email: getServiceNotificationEmail(serviceType)
                        });
                    }
                });
                
                if (serviceInserts.length > 0) {
                    await supabaseRequest('/svc_internal_event_services', {
                        method: 'POST',
                        body: JSON.stringify(serviceInserts)
                    });
                    console.log('‚úÖ Servicios de apoyo insertados');
                }
                
                // 5. Enviar notificaciones
                const notifResult = await sendEventNotifications(wizardData);
                if (notifResult.failed > 0) {
                    console.warn(`‚ö†Ô∏è ${notifResult.failed} notificaci√≥n(es) no pudieron enviarse`);
                }
                
                // √âxito
                showMessage('Evento creado exitosamente. Se ha enviado la solicitud de aprobaci√≥n.', 'success');
                
                // Recargar tabla y ocultar wizard
                await loadEvents();
                hideWizard();
                resetWizard();
                
            } catch (error) {
                console.error('‚ùå Error guardando evento:', error);
                showMessage('Error al guardar el evento: ' + error.message, 'danger');
                
                // Rehabilitar bot√≥n
                const btnSubmit = document.getElementById('btnSubmit');
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = '<i class="bi bi-check-circle"></i> Guardar Evento';
            }
        }
        // ==========================================
        // RENDERIZADO DE LA TABLA
        // ==========================================
        
        function renderEventRow(event) {
            const statusBadge = getStatusBadge(event.event_status);
            const actions = renderActions(event);
            
            return `
                <tr>
                    <td>${event.event_name}</td>
                    <td>${formatDateDisplay(event.event_date)}</td>
                    <td>${event.start_time.substring(0, 5)} - ${event.end_time.substring(0, 5)}</td>
                    <td class="text-center">${event.num_students}</td>
                    <td class="text-center">${event.num_adults}</td>
                    <td class="text-center">${statusBadge}</td>
                    <td class="text-center table-actions">${actions}</td>
                </tr>
            `;
        }

        function getStatusBadge(status) {
            const badges = {
                'scheduled': '<span class="badge badge-status bg-primary">Programado</span>',
                'completed': '<span class="badge badge-status bg-success">Completado</span>',
                'suspended': '<span class="badge badge-status bg-warning">Suspendido</span>',
                'cancelled': '<span class="badge badge-status bg-danger">Cancelado</span>'
            };
            return badges[status] || '<span class="badge badge-status bg-secondary">Desconocido</span>';
        }

        function renderActions(event) {
            let actions = `
                <button class="btn btn-sm btn-info" onclick="viewEvent('${event.event_id}')" title="Ver detalle">
                    <i class="bi bi-eye"></i>
                </button>
            `;
            
            if (event.event_status === 'scheduled') {
                actions += `
                    <button class="btn btn-sm btn-warning ms-1" onclick="changeEventStatus('${event.event_id}')" title="Cambiar estado">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                `;
            }
            
            return actions;
        }

        // ==========================================
        // VER DETALLE DEL EVENTO
        // ==========================================
        
        async function viewEvent(eventId) {
            try {
                // Cargar evento con relaciones
                const event = await supabaseRequest(`/svc_internal_events?event_id=eq.${eventId}&select=*,created_by_user:users!svc_internal_events_created_by_fkey(user_name),request:svc_service_requests(*,approver:workers!svc_service_requests_approver_fkey(worker_first_name,worker_last_name_1))`);
                
                // Cargar refrigerios
                const catering = await supabaseRequest(`/svc_internal_event_catering?event_id=eq.${eventId}&select=*,menu:svc_catering_menus(menu_name)`);
                
                // Cargar servicios de apoyo
                const services = await supabaseRequest(`/svc_internal_event_services?event_id=eq.${eventId}&select=*`);
                
                // Renderizar detalle
                renderEventDetail(event[0], catering, services);
                
                // Mostrar modal
                const modalEl = document.getElementById('viewEventModal');
                const existingModal = bootstrap.Modal.getInstance(modalEl);
                if (existingModal) {
                    existingModal.show();
                } else {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                }
                
            } catch (error) {
                console.error('Error cargando detalle del evento:', error);
                showMessage('Error al cargar el detalle del evento', 'danger');
            }
        }

        function renderEventDetail(event, catering, services) {
            const modalBody = document.getElementById('viewEventBody');
            
            let html = `
                <div class="event-detail-section">
                    <h6><i class="bi bi-info-circle"></i> Informaci√≥n B√°sica</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Nombre:</strong> ${event.event_name}</p>
                            <p><strong>Fecha:</strong> ${formatDateDisplay(event.event_date)}</p>
                            <p><strong>Horario:</strong> ${event.start_time.substring(0, 5)} - ${event.end_time.substring(0, 5)}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Ubicaci√≥n:</strong> ${event.event_location}</p>
                            <p><strong>Estudiantes:</strong> ${event.num_students}</p>
                            <p><strong>Adultos:</strong> ${event.num_adults}</p>
                        </div>
                    </div>
                    <p><strong>Estado:</strong> ${getStatusBadge(event.event_status)}</p>
                    ${event.status_reason ? `<p><strong>Raz√≥n:</strong> ${event.status_reason}</p>` : ''}
                    <p><strong>Creado por:</strong> ${event.created_by_user?.user_name || 'N/A'}</p>
                </div>
            `;
            
            // Aprobaci√≥n
            if (event.request) {
                const statusBadges = {
                    'pending': '<span class="badge bg-warning">Pendiente</span>',
                    'approved': '<span class="badge bg-success">Aprobado</span>',
                    'rejected': '<span class="badge bg-danger">Rechazado</span>'
                };
                
                html += `
                    <div class="event-detail-section">
                        <h6><i class="bi bi-person-check"></i> Estado de Aprobaci√≥n</h6>
                        <p><strong>Estado:</strong> ${statusBadges[event.request.request_status] || 'N/A'}</p>
                        <p><strong>Aprobador:</strong> ${event.request.approver ? 
                            `${event.request.approver.worker_first_name} ${event.request.approver.worker_last_name_1}` : 'N/A'}</p>
                        ${event.request.rejection_reason ? `<p><strong>Raz√≥n de rechazo:</strong> ${event.request.rejection_reason}</p>` : ''}
                    </div>
                `;
            }
            
           // Refrigerios
            let totalCatering = 0;
            if (catering && catering.length > 0) {
                html += `
                    <div class="event-detail-section">
                        <h6><i class="bi bi-cup-straw"></i> Refrigerios</h6>
                `;
                
                // Agrupar por target_group
                const cateringByGroup = { students: [], adults: [] };
                
                catering.forEach(item => {
                    if (cateringByGroup[item.target_group]) {
                        cateringByGroup[item.target_group].push(item);
                    }
                    totalCatering += parseFloat(item.total_value) || 0;
                });
            
                if (cateringByGroup.students.length > 0) {
                    const subtotalStudents = cateringByGroup.students.reduce((sum, i) => sum + (parseFloat(i.total_value) || 0), 0);
                    html += '<p class="mb-1"><strong>Estudiantes:</strong></p><ul>';
                    cateringByGroup.students.forEach(item => {
                        html += `<li>${item.menu.menu_name} x ${item.quantity} = 
                            <span class="text-primary fw-bold">$${formatCurrency(item.total_value)}</span></li>`;
                    });
                    html += '</ul>';
                    html += `<p class="text-end mb-2"><small>Subtotal estudiantes: <strong>$${formatCurrency(subtotalStudents)}</strong></small></p>`;
                }
            
                if (cateringByGroup.adults.length > 0) {
                    const subtotalAdults = cateringByGroup.adults.reduce((sum, i) => sum + (parseFloat(i.total_value) || 0), 0);
                    html += '<p class="mb-1"><strong>Adultos:</strong></p><ul>';
                    cateringByGroup.adults.forEach(item => {
                        html += `<li>${item.menu.menu_name} x ${item.quantity} = 
                            <span class="text-primary fw-bold">$${formatCurrency(item.total_value)}</span></li>`;
                    });
                    html += '</ul>';
                    html += `<p class="text-end mb-2"><small>Subtotal adultos: <strong>$${formatCurrency(subtotalAdults)}</strong></small></p>`;
                }
            
                html += `
                    <div class="text-end mt-2 pt-2" style="border-top: 2px solid #dee2e6;">
                        <strong>Total Refrigerios: <span class="text-primary">$${formatCurrency(totalCatering)}</span></strong>
                    </div>
                `;
                
                html += `</div>`;
            }
            
            // Servicios de apoyo
            let totalServices = 0;
            let pendingServicesCost = false;
            
            if (services && services.length > 0) {
                html += `
                    <div class="event-detail-section">
                        <h6><i class="bi bi-gear"></i> Servicios de Apoyo</h6>
                `;
                
                services.forEach(service => {
                    if (service.cost_value) {
                        totalServices += parseFloat(service.cost_value) || 0;
                    } else {
                        pendingServicesCost = true;
                    }
                    html += `
                        <div class="mb-3">
                            <strong class="text-primary">${getServiceLabel(service.service_type)}:</strong>
                            <p class="mb-1 ms-3">${service.description}</p>
                            ${service.cost_value ? 
                                `<p class="mb-0 ms-3"><strong>Costo registrado:</strong> $${formatCurrency(service.cost_value)}</p>` : 
                                '<p class="mb-0 ms-3 text-muted"><em>Costo pendiente de registro</em></p>'}
                        </div>
                    `;
                });
                
                if (totalServices > 0 || pendingServicesCost) {
                    html += `
                        <div class="text-end mt-2 pt-2" style="border-top: 2px solid #dee2e6;">
                            <strong>Total Servicios de Apoyo: <span class="text-primary">$${formatCurrency(totalServices)}</span></strong>
                            ${pendingServicesCost ? '<br><small class="text-muted"><em>* Algunos costos a√∫n pendientes de registro</em></small>' : ''}
                        </div>
                    `;
                }
                
                html += `</div>`;
            }

            // Resumen total del evento
            const grandTotal = totalCatering + totalServices;
            const hasPendingCosts = pendingServicesCost;
            
            html += `
                <div class="event-detail-section" style="background: #e8f4f8; border-left: 4px solid var(--system-primary-color, #0d6efd);">
                    <h6><i class="bi bi-calculator"></i> Costo Total del Evento</h6>
                    <table style="width: 100%;">
                        ${totalCatering > 0 ? `
                        <tr>
                            <td style="padding: 6px 0;">Refrigerios</td>
                            <td style="padding: 6px 0; text-align: right; font-weight: 600;">$${formatCurrency(totalCatering)}</td>
                        </tr>` : ''}
                        ${totalServices > 0 ? `
                        <tr>
                            <td style="padding: 6px 0;">Servicios de Apoyo</td>
                            <td style="padding: 6px 0; text-align: right; font-weight: 600;">$${formatCurrency(totalServices)}</td>
                        </tr>` : ''}
                        <tr style="border-top: 2px solid #0d6efd;">
                            <td style="padding: 10px 0; font-size: 1.15rem; font-weight: 700;">TOTAL EVENTO</td>
                            <td style="padding: 10px 0; text-align: right; font-size: 1.15rem; font-weight: 700; color: var(--system-primary-color, #0d6efd);">$${formatCurrency(grandTotal)}</td>
                        </tr>
                    </table>
                    ${hasPendingCosts ? '<p class="mb-0 mt-2 text-muted"><small><em>* Este total es parcial. Hay costos de servicios pendientes de registro.</em></small></p>' : ''}
                </div>
            `;
            
            modalBody.innerHTML = html;
        }

        // ==========================================
        // CAMBIAR ESTADO DEL EVENTO
        // ==========================================
        
        function changeEventStatus(eventId) {
            document.getElementById('changeStatusEventId').value = eventId;
            document.getElementById('newStatus').value = '';
            document.getElementById('statusReason').value = '';
            document.getElementById('statusReasonContainer').classList.add('hidden');
            
            const modal = new bootstrap.Modal(document.getElementById('changeStatusModal'));
            modal.show();
        }

        async function confirmStatusChange() {
            try {
                const eventId = document.getElementById('changeStatusEventId').value;
                const newStatus = document.getElementById('newStatus').value;
                const statusReason = document.getElementById('statusReason').value.trim();
                
                if (!newStatus) {
                    showMessage('Por favor seleccione un estado', 'warning');
                    return;
                }
                
                if ((newStatus === 'suspended' || newStatus === 'cancelled') && !statusReason) {
                    showMessage('Por favor indique la raz√≥n del cambio de estado', 'warning');
                    return;
                }
                
                // Actualizar evento
                const updateData = {
                    event_status: newStatus,
                    updated_at: new Date().toISOString()
                };
                
                if (statusReason) {
                    updateData.status_reason = statusReason;
                }
                
                await supabaseRequest(`/svc_internal_events?event_id=eq.${eventId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });
                
                showMessage('Estado del evento actualizado correctamente', 'success');
                
                // Cerrar modal y recargar tabla
                bootstrap.Modal.getInstance(document.getElementById('changeStatusModal')).hide();
                await loadEvents();
                
            } catch (error) {
                console.error('Error cambiando estado:', error);
                showMessage('Error al cambiar el estado del evento', 'danger');
            }
        }

        // ==========================================
        // NOTIFICACIONES DE EVENTOS
        // ==========================================
        
        function generateEventEmailHTML(data, recipientContext) {
            let contextHeader = '';
            
            if (recipientContext === 'approver') {
                contextHeader = `
                    <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px;">
                        <h2 style="color: #856404; margin-top: 0; margin-bottom: 5px;">Solicitud de Aprobaci√≥n</h2>
                        <p style="margin: 0; color: #856404;">Se requiere su aprobaci√≥n para el siguiente evento interno.</p>
                    </div>`;
            } else if (recipientContext === 'coordination') {
                contextHeader = `
                    <div style="background-color: #cff4fc; border-left: 4px solid #0dcaf0; padding: 15px; margin-bottom: 20px;">
                        <h2 style="color: #055160; margin-top: 0; margin-bottom: 5px;">Nuevo Evento Programado</h2>
                        <p style="margin: 0; color: #055160;">Se ha programado un nuevo evento interno. A continuaci√≥n el detalle.</p>
                    </div>`;
            } else if (recipientContext === 'service_area') {
                contextHeader = `
                    <div style="background-color: #d1e7dd; border-left: 4px solid #198754; padding: 15px; margin-bottom: 20px;">
                        <h2 style="color: #0f5132; margin-top: 0; margin-bottom: 5px;">Servicio de Apoyo Solicitado</h2>
                        <p style="margin: 0; color: #0f5132;">Se ha solicitado su apoyo para el siguiente evento interno.</p>
                    </div>`;
            }
        
            // Informaci√≥n b√°sica
            let html = `
            <div style="font-family: Arial, sans-serif; max-width: 650px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
                ${contextHeader}
                <div style="background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3 style="color: #1b365d; margin-top: 0;">Informaci√≥n del Evento</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold; width: 35%;">Nombre</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;">${data.eventName}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Fecha</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;">${formatDateDisplay(data.eventDate)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Horario</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;">${data.startTime} - ${data.endTime}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Ubicaci√≥n</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;">${data.eventLocation}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Estudiantes</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;">${data.numStudents}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6; background: #f8f9fa; font-weight: bold;">Adultos</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;">${data.numAdults}</td>
                        </tr>
                    </table>`;
        
            // Refrigerios
            const hasCatering = (data.cateringStudents.enabled && data.cateringStudents.items.length > 0) || 
                    (data.cateringAdults.enabled && data.cateringAdults.items.length > 0);
            if (hasCatering) {
                html += `<h3 style="color: #1b365d;">Refrigerios</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                        <tr style="background: #1b365d; color: white;">
                            <th style="padding: 8px; border: 1px solid #dee2e6;">Grupo</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6;">Men√∫</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">Cantidad</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">Total</th>
                        </tr>`;
                
                if (data.cateringStudents.enabled) {
                    data.cateringStudents.items.forEach(item => {
                        html += `<tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6;">Estudiantes</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;">${item.menuName}</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${item.quantity}</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${formatCurrency(item.total)}</td>
                        </tr>`;
                    });
                }
                if (data.cateringAdults.enabled) {
                    data.cateringAdults.items.forEach(item => {
                        html += `<tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6;">Adultos</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6;">${item.menuName}</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${item.quantity}</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${formatCurrency(item.total)}</td>
                        </tr>`;
                    });
                }
                html += `</table>`;
            }
        
            // Servicios de apoyo
            const hasServices = Object.values(data.services).some(s => s.enabled);
            if (hasServices) {
                html += `<h3 style="color: #1b365d;">Servicios de Apoyo Solicitados</h3>`;
                Object.keys(data.services).forEach(type => {
                    if (data.services[type].enabled) {
                        html += `<p style="margin-bottom: 10px;"><strong>${getServiceLabel(type)}:</strong><br>${data.services[type].description}</p>`;
                    }
                });
            }
        
            // Costo estimado
            let totalCost = 0;
            if (data.cateringStudents.enabled) {
                totalCost += data.cateringStudents.items.reduce((sum, item) => sum + item.total, 0);
            }
            if (data.cateringAdults.enabled) {
                totalCost += data.cateringAdults.items.reduce((sum, item) => sum + item.total, 0);
            }
        
            html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <h3 style="color: #1b365d; margin-top: 0;">Costo Estimado</h3>
                        <p style="font-size: 1.2em; font-weight: bold; color: #1b365d; margin: 0;">$${formatCurrency(totalCost)}</p>
                        ${hasServices ? '<p style="color: #6c757d; font-size: 0.85em; margin: 5px 0 0 0;"><em>* Costos de servicios de apoyo pendientes de registro por cada √°rea.</em></p>' : ''}
                    </div>
                </div>
                <p style="text-align: center; color: #6c757d; font-size: 0.8em; margin-top: 15px;">
                    Este es un mensaje autom√°tico del sistema SchoolNet.<br>
                    Por favor, no responder a este mensaje.<br>
                    Colegio Tilata - Sistema de Gesti√≥n Educativa
                </p>
            </div>`;
        
            return html;
        }

        async function sendEventNotifications(data) {
            console.log('üìß Iniciando env√≠o de notificaciones...');
            let sent = 0;
            let failed = 0;
        
            // 1. Notificaci√≥n al aprobador
            try {
                const approverSelect = document.getElementById('approverSelect');
                const selectedOption = approverSelect.options[approverSelect.selectedIndex];
                const approverEmail = selectedOption.dataset.email;
                const approverName = selectedOption.text.trim();
        
                if (approverEmail) {
                    const subject = `SchoolNet - Solicitud de aprobaci√≥n: ${data.eventName}`;
                    const html = generateEventEmailHTML(data, 'approver');
                    const result = await sendNotification(approverEmail, subject, html);
                    if (result) {
                        console.log(`‚úÖ Notificaci√≥n enviada al aprobador: ${approverName} (${approverEmail})`);
                        sent++;
                    } else {
                        console.warn(`‚ö†Ô∏è No se pudo notificar al aprobador: ${approverEmail}`);
                        failed++;
                    }
                } else {
                    console.warn('‚ö†Ô∏è El aprobador no tiene email registrado');
                    failed++;
                }
            } catch (error) {
                console.error('Error notificando al aprobador:', error);
                failed++;
            }
        
            // 2. Notificaciones fijas: coordinaci√≥n, recepci√≥n, porter√≠a
            const fixedRecipients = [
                { key: 'coordination', label: 'Coordinaci√≥n de servicios' },
                { key: 'reception', label: 'Recepci√≥n' },
                { key: 'security', label: 'Porter√≠a' },
                { key: 'chef', label: 'Chef' },
                { key: 'supervisor', label: 'Supervisora' }
            ];
        
            for (const recipient of fixedRecipients) {
                try {
                    const email = serviceEmails[recipient.key];
                    if (email) {
                        const subject = `SchoolNet - Evento programado: ${data.eventName}`;
                        const html = generateEventEmailHTML(data, 'coordination');
                        const result = await sendNotification(email, subject, html);
                        if (result) {
                            console.log(`‚úÖ Notificaci√≥n enviada a ${recipient.label}: ${email}`);
                            sent++;
                        } else {
                            console.warn(`‚ö†Ô∏è No se pudo notificar a ${recipient.label}: ${email}`);
                            failed++;
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è No hay email configurado para ${recipient.label}`);
                    }
                } catch (error) {
                    console.error(`Error notificando a ${recipient.label}:`, error);
                    failed++;
                }
            }
        
            // 3. Notificaciones a √°reas de servicios de apoyo solicitados
            const serviceEmailMap = {
                'staffing': 'hr',
                'communications': 'communications',
                'technology': 'technology',
                'site_organization': 'site_organization',
                'resources': 'resources',
                'nursing': 'nursing',
                'transport': 'transport',
                'decoration': 'decoration'
            };
        
            for (const [serviceType, emailKey] of Object.entries(serviceEmailMap)) {
                if (data.services[serviceType].enabled) {
                    try {
                        const email = serviceEmails[emailKey];
                        if (email) {
                            const subject = `SchoolNet - Apoyo solicitado para evento: ${data.eventName}`;
                            const html = generateEventEmailHTML(data, 'service_area');
                            const result = await sendNotification(email, subject, html);
                            if (result) {
                                console.log(`‚úÖ Notificaci√≥n enviada a ${getServiceLabel(serviceType)}: ${email}`);
                                sent++;
                            } else {
                                console.warn(`‚ö†Ô∏è No se pudo notificar a ${getServiceLabel(serviceType)}: ${email}`);
                                failed++;
                            }
                        } else {
                            console.warn(`‚ö†Ô∏è No hay email configurado para ${getServiceLabel(serviceType)}`);
                        }
                    } catch (error) {
                        console.error(`Error notificando a ${getServiceLabel(serviceType)}:`, error);
                        failed++;
                    }
                }
            }
        
            console.log(`üìß Notificaciones completadas: ${sent} enviadas, ${failed} fallidas`);
            return { sent, failed };
        }

        
        // ==========================================
        // CONTROL DEL WIZARD
        // ==========================================
        
        function showWizard() {
            document.getElementById('wizardContainer').classList.remove('hidden');
            document.getElementById('eventsTableContainer').classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function hideWizard() {
            document.getElementById('wizardContainer').classList.add('hidden');
            document.getElementById('eventsTableContainer').classList.remove('hidden');
        }

        function resetWizard() {
            currentStep = 1;
            editingEventId = null;
            
            // Resetear wizardData
            wizardData = {
                eventName: '',
                eventDate: '',
                startTime: '',
                endTime: '',
                eventLocation: '',
                numStudents: 0,
                numAdults: 0,
                cateringStudents: { enabled: false, items: [] },
                cateringAdults: { enabled: false, items: [] },
                services: {
                    staffing: { enabled: false, description: '' },
                    communications: { enabled: false, description: '' },
                    technology: { enabled: false, description: '' },
                    site_organization: { enabled: false, description: '' },
                    resources: { enabled: false, description: '' },
                    nursing: { enabled: false, description: '' },
                    transport: { enabled: false, description: '' },
                    decoration: { enabled: false, description: '' }
                },
                approverId: null
            };
            
            // Limpiar formulario paso 1
            document.getElementById('formStep1').reset();
            document.getElementById('eventDate').value = '';
            
            // Resetear paso 2
            document.getElementById('cateringStudentsCheck').checked = false;
            document.getElementById('cateringAdultsCheck').checked = false;
            toggleCateringStudents();
            toggleCateringAdults();
            
            // Resetear paso 3
            ['staffing', 'communications', 'technology', 'site_organization', 'resources', 'nursing', 'transport', 'decoration'].forEach(type => {
                const checkboxId = getServiceCheckboxId(type);
                document.getElementById(`service${checkboxId}Check`).checked = false;
                toggleServiceField(type);
            });
            
            // Resetear paso 4
            document.getElementById('approverSelect').value = '';
            
            // Resetear UI del wizard
            updateWizardUI();
            
            // T√≠tulo
            document.getElementById('wizardTitle').textContent = 'Nuevo Evento Interno';
        }

        function cancelWizard() {
            if (confirm('¬øEst√° seguro de cancelar? Se perder√°n todos los datos ingresados.')) {
                hideWizard();
                resetWizard();
            }
        }

        // ==========================================
        // FUNCIONES DE FORMATO Y HELPERS
        // ==========================================
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatDateDisplay(dateString) {
            if (!dateString) return 'N/A';
            
            const date = new Date(dateString + 'T00:00:00');
            
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function getServiceLabel(type) {
            const labels = {
                'staffing': 'Personal de Apoyo (Staffing)',
                'communications': 'Comunicaciones',
                'technology': 'Recursos Tecnol√≥gicos',
                'site_organization': 'Organizaci√≥n del Sitio',
                'resources': 'Recursos (Papeler√≠a, Materiales)',
                'nursing': 'Enfermer√≠a',
                'transport': 'Transporte',
                'decoration': 'Decoraci√≥n / Menaje'
            };
            return labels[type] || type;
        }

        function getServiceCheckboxId(type) {
            const ids = {
                'staffing': 'Staffing',
                'communications': 'Communications',
                'technology': 'Technology',
                'site_organization': 'SiteOrg',
                'resources': 'Resources',
                'nursing': 'Nursing',
                'transport': 'Transport',
                'decoration': 'Decoration'
            };
            return ids[type] || type;
        }

        function getServiceNotificationEmail(serviceType) {
            // Mapear tipo de servicio a clave de email en svc_module_config
            const emailKeyMap = {
                'staffing': 'hr',  // email_hr
                'communications': 'communications',  // email_communications
                'technology': 'technology',  // email_technology
                'site_organization': 'site_organization',  // email_site_organization
                'resources': 'resources',  // email_resources
                'nursing': 'nursing',  // email_nursing
                'transport': 'transport',  // email_transport
                'decoration': 'decoration'  // email_decoration
            };
            
            const emailKey = emailKeyMap[serviceType];
            
            // Retornar desde la configuraci√≥n cargada o usar coordinaci√≥n como fallback
            return serviceEmails[emailKey] || serviceEmails['coordination'] || 'serviciosgenerales@colegiotilata.edu.co';
        }

        // ==========================================
        // FUNCIONES GLOBALES (para onclick en HTML)
        // ==========================================
        
       window.viewEvent = viewEvent;
        window.changeEventStatus = changeEventStatus;
        window.calculateCateringLine = calculateCateringLine;
        window.removeCateringLine = removeCateringLine;

        // ==========================================
        // MANEJO DE ERRORES GLOBAL
        // ==========================================
        
        window.addEventListener('error', function(event) {
            console.error('Error global capturado:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Promise rechazada no manejada:', event.reason);
        });

        // ==========================================
        // LOG DE VERSI√ìN
        // ==========================================
        
        console.log('%c SchoolNet - Eventos Internos ', 'background: #0d6efd; color: white; padding: 5px 10px; border-radius: 3px;');
        console.log('%c Versi√≥n: 26.02.08.16.00 ', 'color: #6c757d;');
        console.log('%c M√≥dulo: Servicios ', 'color: #6c757d;');
        console.log('%c Ambiente: ' + CURRENT_ENVIRONMENT.toUpperCase(), 'color: #6c757d;');
        
        console.log('‚úÖ internal-events.html cargado correctamente');
    </script>
</body>
</html>
