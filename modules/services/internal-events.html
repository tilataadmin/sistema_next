<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.08.09.10">
    
    <title>Eventos Internos - SchoolNet</title>
    
    <!-- Bootstrap 5.3.0 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Flatpickr para fechas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        :root {
            /* Los colores corporativos se cargar√°n desde system_config */
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .wizard-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .wizard-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }
        
        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #dee2e6;
            z-index: 0;
        }
        
        .wizard-step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 2px solid #dee2e6;
            color: #6c757d;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        
        .wizard-step.active .step-circle {
            background: var(--system-primary-color, #0d6efd);
            border-color: var(--system-primary-color, #0d6efd);
            color: white;
        }
        
        .wizard-step.completed .step-circle {
            background: #198754;
            border-color: #198754;
            color: white;
        }
        
        .step-label {
            display: block;
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .wizard-step.active .step-label {
            color: var(--system-primary-color, #0d6efd);
            font-weight: 600;
        }
        
        .wizard-content {
            min-height: 400px;
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .wizard-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }
        
        .btn-primary {
            background-color: var(--system-primary-color, #0d6efd);
            border-color: var(--system-primary-color, #0d6efd);
        }
        
        .btn-primary:hover {
            filter: brightness(0.9);
        }
        
        .cost-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .cost-line {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .cost-line:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--system-primary-color, #0d6efd);
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #dee2e6;
        }
        
        .service-checkbox {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .service-checkbox:hover {
            background: #f8f9fa;
        }
        
        .service-checkbox.active {
            border-color: var(--system-primary-color, #0d6efd);
            background: #f0f7ff;
        }
        
        .badge-status {
            padding: 6px 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .table-actions {
            white-space: nowrap;
        }
        
        .event-detail-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .event-detail-section h6 {
            color: var(--system-primary-color, #0d6efd);
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">
                        <i class="bi bi-bus-front me-1"></i>Servicios
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Eventos Internos
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3 mb-2">
                    <i class="bi bi-calendar-event me-2"></i>Eventos Internos
                </h1>
                <p class="text-muted">
                    Gesti√≥n de eventos institucionales con servicios de apoyo
                </p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" id="btnNewEvent">
                    <i class="bi bi-plus-circle me-1"></i>Nuevo Evento
                </button>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- WIZARD CONTAINER (inicialmente oculto) -->
        <div id="wizardContainer" class="wizard-container hidden">
            <!-- Wizard Header -->
            <div class="wizard-header">
                <h4 id="wizardTitle">Nuevo Evento Interno</h4>
            </div>

            <!-- Wizard Steps -->
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1">
                    <div class="step-circle">1</div>
                    <span class="step-label">Informaci√≥n B√°sica</span>
                </div>
                <div class="wizard-step" data-step="2">
                    <div class="step-circle">2</div>
                    <span class="step-label">Refrigerios</span>
                </div>
                <div class="wizard-step" data-step="3">
                    <div class="step-circle">3</div>
                    <span class="step-label">Personal de Apoyo</span>
                </div>
                <div class="wizard-step" data-step="4">
                    <div class="step-circle">4</div>
                    <span class="step-label">Servicios de Apoyo</span>
                </div>
                <div class="wizard-step" data-step="5">
                    <div class="step-circle">5</div>
                    <span class="step-label">Solicitud de Aprobaci√≥n</span>
                </div>
            </div>

            <!-- Wizard Content -->
            <div class="wizard-content">
                <!-- PASO 1: Informaci√≥n B√°sica -->
                <div class="step-content active" id="step1">
                    <h5 class="mb-4">Informaci√≥n B√°sica del Evento</h5>
                    <form id="formStep1">
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="eventName" class="form-label">Nombre del Evento <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="eventName" required 
                                       placeholder="Ej: D√≠a de la Familia 2026">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="eventDate" class="form-label">Fecha del Evento <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="eventDate" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="startTime" class="form-label">Hora de Inicio <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" id="startTime" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="endTime" class="form-label">Hora de Finalizaci√≥n <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" id="endTime" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="eventLocation" class="form-label">Sitio/Ubicaci√≥n <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="eventLocation" rows="2" required
                                      placeholder="Ej: Cancha m√∫ltiple cubierta"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="numStudents" class="form-label">N√∫mero de Estudiantes <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="numStudents" min="0" value="0" required>
                                <small class="text-muted">Cantidad estimada de estudiantes participantes</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="numAdults" class="form-label">N√∫mero de Adultos <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="numAdults" min="0" value="0" required>
                                <small class="text-muted">Cantidad estimada de adultos participantes</small>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- PASO 2: Refrigerios -->
                <div class="step-content" id="step2">
                    <h5 class="mb-4">Refrigerios y Alimentaci√≥n</h5>
                    
                    <!-- Refrigerios Estudiantes -->
                    <div class="service-checkbox" id="cateringStudentsBox">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cateringStudentsCheck">
                            <label class="form-check-label fw-bold" for="cateringStudentsCheck">
                                <i class="bi bi-cup-straw"></i> Refrigerios para Estudiantes
                            </label>
                        </div>
                        
                        <div id="cateringStudentsFields" class="mt-3 hidden">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="menuStudents" class="form-label">Men√∫ Seleccionado <span class="text-danger">*</span></label>
                                    <select class="form-select" id="menuStudents">
                                        <option value="">Seleccione un men√∫...</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="qtyStudents" class="form-label">Cantidad</label>
                                    <input type="number" class="form-control" id="qtyStudents" readonly>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="priceStudents" class="form-label">Precio Unit.</label>
                                    <input type="text" class="form-control" id="priceStudents" readonly>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="totalStudents" class="form-label">Total</label>
                                    <input type="text" class="form-control fw-bold" id="totalStudents" readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Refrigerios Adultos -->
                    <div class="service-checkbox" id="cateringAdultsBox">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cateringAdultsCheck">
                            <label class="form-check-label fw-bold" for="cateringAdultsCheck">
                                <i class="bi bi-cup-hot"></i> Refrigerios para Adultos
                            </label>
                        </div>
                        
                        <div id="cateringAdultsFields" class="mt-3 hidden">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="menuAdults" class="form-label">Men√∫ Seleccionado <span class="text-danger">*</span></label>
                                    <select class="form-select" id="menuAdults">
                                        <option value="">Seleccione un men√∫...</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="qtyAdults" class="form-label">Cantidad</label>
                                    <input type="number" class="form-control" id="qtyAdults" readonly>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="priceAdults" class="form-label">Precio Unit.</label>
                                    <input type="text" class="form-control" id="priceAdults" readonly>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="totalAdults" class="form-label">Total</label>
                                    <input type="text" class="form-control fw-bold" id="totalAdults" readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Nota:</strong> Los refrigerios son opcionales. Las cantidades se toman autom√°ticamente 
                        del n√∫mero de participantes indicado en el paso anterior.
                    </div>
                </div>
                <!-- PASO 3: Personal de Apoyo -->
                <div class="step-content" id="step3">
                    <h5 class="mb-4">Personal de Apoyo</h5>
                    <p class="text-muted mb-4">
                        Indique el personal de apoyo adicional requerido para el evento (opcional)
                    </p>

                    <!-- Personal de Aseo -->
                    <div class="service-checkbox" id="staffCleaningBox">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="staffCleaningCheck">
                                    <label class="form-check-label fw-bold" for="staffCleaningCheck">
                                        <i class="bi bi-droplet"></i> Personal de Aseo
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control" id="staffCleaningCount" 
                                       min="1" placeholder="Cantidad" disabled>
                            </div>
                        </div>
                    </div>

                    <!-- Personal de Cafeter√≠a -->
                    <div class="service-checkbox" id="staffCafeteriaBox">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="staffCafeteriaCheck">
                                    <label class="form-check-label fw-bold" for="staffCafeteriaCheck">
                                        <i class="bi bi-cup-straw"></i> Personal de Cafeter√≠a
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control" id="staffCafeteriaCount" 
                                       min="1" placeholder="Cantidad" disabled>
                            </div>
                        </div>
                    </div>

                    <!-- Personal de Mantenimiento -->
                    <div class="service-checkbox" id="staffMaintenanceBox">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="staffMaintenanceCheck">
                                    <label class="form-check-label fw-bold" for="staffMaintenanceCheck">
                                        <i class="bi bi-tools"></i> Personal de Mantenimiento
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control" id="staffMaintenanceCount" 
                                       min="1" placeholder="Cantidad" disabled>
                            </div>
                        </div>
                    </div>

                    <!-- Personal de Tecnolog√≠a -->
                    <div class="service-checkbox" id="staffTechnologyBox">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="staffTechnologyCheck">
                                    <label class="form-check-label fw-bold" for="staffTechnologyCheck">
                                        <i class="bi bi-laptop"></i> Personal de Tecnolog√≠a
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control" id="staffTechnologyCount" 
                                       min="1" placeholder="Cantidad" disabled>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Nota:</strong> El personal de apoyo es opcional. Solo seleccione las √°reas que 
                        requieran personal adicional para el evento.
                    </div>
                </div>

                <!-- PASO 4: Servicios de Apoyo -->
                <div class="step-content" id="step4">
                    <h5 class="mb-4">Servicios de Apoyo</h5>
                    <p class="text-muted mb-4">
                        Seleccione los servicios de apoyo requeridos y describa las necesidades espec√≠ficas (opcional)
                    </p>

                    <!-- Servicio: Staffing -->
                    <div class="service-checkbox" id="serviceStaffingBox">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="serviceStaffingCheck">
                            <label class="form-check-label fw-bold" for="serviceStaffingCheck">
                                <i class="bi bi-people"></i> Personal de Apoyo General (Staffing)
                            </label>
                        </div>
                        <div id="serviceStaffingFields" class="hidden">
                            <textarea class="form-control" id="serviceStaffingDesc" rows="3" 
                                      placeholder="Describa el personal de apoyo requerido..."></textarea>
                        </div>
                    </div>

                    <!-- Servicio: Comunicaciones -->
                    <div class="service-checkbox" id="serviceCommunicationsBox">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="serviceCommunicationsCheck">
                            <label class="form-check-label fw-bold" for="serviceCommunicationsCheck">
                                <i class="bi bi-megaphone"></i> Comunicaciones
                            </label>
                        </div>
                        <div id="serviceCommunicationsFields" class="hidden">
                            <textarea class="form-control" id="serviceCommunicationsDesc" rows="3" 
                                      placeholder="Describa las necesidades de comunicaci√≥n (circulares, anuncios, etc.)..."></textarea>
                        </div>
                    </div>

                    <!-- Servicio: Tecnolog√≠a -->
                    <div class="service-checkbox" id="serviceTechnologyBox">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="serviceTechnologyCheck">
                            <label class="form-check-label fw-bold" for="serviceTechnologyCheck">
                                <i class="bi bi-pc-display"></i> Recursos Tecnol√≥gicos
                            </label>
                        </div>
                        <div id="serviceTechnologyFields" class="hidden">
                            <textarea class="form-control" id="serviceTechnologyDesc" rows="3" 
                                      placeholder="Describa los recursos tecnol√≥gicos necesarios (proyector, sonido, etc.)..."></textarea>
                        </div>
                    </div>

                    <!-- Servicio: Organizaci√≥n del Sitio -->
                    <div class="service-checkbox" id="serviceSiteOrgBox">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="serviceSiteOrgCheck">
                            <label class="form-check-label fw-bold" for="serviceSiteOrgCheck">
                                <i class="bi bi-building"></i> Organizaci√≥n del Sitio
                            </label>
                        </div>
                        <div id="serviceSiteOrgFields" class="hidden">
                            <textarea class="form-control" id="serviceSiteOrgDesc" rows="3" 
                                      placeholder="Describa necesidades de organizaci√≥n del espacio (sillas, mesas, decoraci√≥n, etc.)..."></textarea>
                        </div>
                    </div>

                    <!-- Servicio: Recursos -->
                    <div class="service-checkbox" id="serviceResourcesBox">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="serviceResourcesCheck">
                            <label class="form-check-label fw-bold" for="serviceResourcesCheck">
                                <i class="bi bi-box-seam"></i> Recursos (Papeler√≠a, Materiales)
                            </label>
                        </div>
                        <div id="serviceResourcesFields" class="hidden">
                            <textarea class="form-control" id="serviceResourcesDesc" rows="3" 
                                      placeholder="Describa los recursos necesarios (papeler√≠a, marcadores, cuadernillos, etc.)..."></textarea>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Nota:</strong> Los servicios de apoyo son opcionales. Los costos de estos servicios 
                        ser√°n registrados posteriormente por cada √°rea responsable.
                    </div>
                </div>
                <!-- PASO 5: Solicitud de Aprobaci√≥n -->
                <div class="step-content" id="step5">
                    <h5 class="mb-4">Resumen y Solicitud de Aprobaci√≥n</h5>

                    <!-- Informaci√≥n B√°sica -->
                    <div class="event-detail-section">
                        <h6><i class="bi bi-info-circle"></i> Informaci√≥n B√°sica</h6>
                        <div class="row">
                            <div class="col-md-8">
                                <p class="mb-1"><strong>Nombre del Evento:</strong> <span id="summaryEventName"></span></p>
                                <p class="mb-1"><strong>Ubicaci√≥n:</strong> <span id="summaryLocation"></span></p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1"><strong>Fecha:</strong> <span id="summaryDate"></span></p>
                                <p class="mb-1"><strong>Horario:</strong> <span id="summaryTime"></span></p>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <p class="mb-0"><strong>Estudiantes:</strong> <span id="summaryStudents"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-0"><strong>Adultos:</strong> <span id="summaryAdults"></span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Refrigerios -->
                    <div class="event-detail-section hidden" id="summaryCateringSection">
                        <h6><i class="bi bi-cup-straw"></i> Refrigerios</h6>
                        <div id="summaryCateringContent"></div>
                    </div>

                    <!-- Personal de Apoyo -->
                    <div class="event-detail-section hidden" id="summarySupportStaffSection">
                        <h6><i class="bi bi-people"></i> Personal de Apoyo</h6>
                        <div id="summarySupportStaffContent"></div>
                    </div>

                    <!-- Servicios de Apoyo -->
                    <div class="event-detail-section hidden" id="summaryServicesSection">
                        <h6><i class="bi bi-gear"></i> Servicios de Apoyo</h6>
                        <div id="summaryServicesContent"></div>
                    </div>

                    <!-- Resumen de Costos -->
                    <div class="cost-summary">
                        <h6 class="mb-3"><i class="bi bi-calculator"></i> Resumen de Costos Estimados</h6>
                        <div id="costSummaryLines"></div>
                    </div>

                    <!-- Selecci√≥n de Aprobador -->
                    <div class="mt-4">
                        <h6 class="mb-3"><i class="bi bi-person-check"></i> Solicitud de Aprobaci√≥n</h6>
                        <div class="row">
                            <div class="col-md-8">
                                <label for="approverSelect" class="form-label">Seleccione el Aprobador <span class="text-danger">*</span></label>
                                <select class="form-select" id="approverSelect" required>
                                    <option value="">Cargando aprobadores...</option>
                                </select>
                                <small class="text-muted">
                                    Persona que revisar√° y aprobar√° este evento
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-4">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>Importante:</strong> Una vez enviado, el evento quedar√° en estado "Programado" 
                        y se enviar√° una notificaci√≥n al aprobador seleccionado. Tambi√©n se notificar√° 
                        autom√°ticamente a coordinaci√≥n de servicios, recepci√≥n y porter√≠a.
                    </div>
                </div>

            </div>

            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <button type="button" class="btn btn-secondary" id="btnPrevious">
                    <i class="bi bi-arrow-left"></i> Anterior
                </button>
                <div>
                    <button type="button" class="btn btn-outline-secondary me-2" id="btnCancel">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="btnNext">
                        Siguiente <i class="bi bi-arrow-right"></i>
                    </button>
                    <button type="button" class="btn btn-success hidden" id="btnSubmit">
                        <i class="bi bi-check-circle"></i> Guardar Evento
                    </button>
                </div>
            </div>
        </div>

        <!-- TABLA DE EVENTOS -->
        <div id="eventsTableContainer">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Lista de Eventos Internos</h5>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="filterStatus" class="form-label">Estado</label>
                            <select class="form-select" id="filterStatus">
                                <option value="">Todos los estados</option>
                                <option value="scheduled">Programado</option>
                                <option value="completed">Completado</option>
                                <option value="suspended">Suspendido</option>
                                <option value="cancelled">Cancelado</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="filterDateFrom" class="form-label">Fecha Desde</label>
                            <input type="text" class="form-control" id="filterDateFrom" placeholder="Seleccione fecha">
                        </div>
                        <div class="col-md-4">
                            <label for="filterDateTo" class="form-label">Fecha Hasta</label>
                            <input type="text" class="form-control" id="filterDateTo" placeholder="Seleccione fecha">
                        </div>
                    </div>

                    <!-- Tabla -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="eventsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nombre del Evento</th>
                                    <th>Fecha</th>
                                    <th>Horario</th>
                                    <th class="text-center">Estudiantes</th>
                                    <th class="text-center">Adultos</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="eventsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="bi bi-hourglass-split"></i> Cargando eventos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Ver Detalle -->
    <div class="modal fade" id="viewEventModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-eye"></i> Detalle del Evento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="viewEventBody">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Cambiar Estado -->
    <div class="modal fade" id="changeStatusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-arrow-repeat"></i> Cambiar Estado del Evento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="changeStatusEventId">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">Nuevo Estado <span class="text-danger">*</span></label>
                        <select class="form-select" id="newStatus" required>
                            <option value="">Seleccione...</option>
                            <option value="completed">Completado</option>
                            <option value="suspended">Suspendido</option>
                            <option value="cancelled">Cancelado</option>
                        </select>
                    </div>
                    <div class="mb-3 hidden" id="statusReasonContainer">
                        <label for="statusReason" class="form-label">Raz√≥n <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="statusReason" rows="3" 
                                  placeholder="Indique el motivo del cambio de estado..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnConfirmStatusChange">
                        <i class="bi bi-check-circle"></i> Confirmar Cambio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let currentUserId = null;
        let currentStep = 1;
        let editingEventId = null;
        
        // Datos del wizard
        let wizardData = {
            // Paso 1: Informaci√≥n B√°sica
            eventName: '',
            eventDate: '',
            startTime: '',
            endTime: '',
            eventLocation: '',
            numStudents: 0,
            numAdults: 0,
            
            // Paso 2: Refrigerios
            cateringStudents: {
                enabled: false,
                menuId: null,
                menuName: '',
                quantity: 0,
                unitPrice: 0,
                total: 0
            },
            cateringAdults: {
                enabled: false,
                menuId: null,
                menuName: '',
                quantity: 0,
                unitPrice: 0,
                total: 0
            },
            
            // Paso 3: Personal de Apoyo
            supportStaff: {
                cleaning: { enabled: false, count: 0 },
                cafeteria: { enabled: false, count: 0 },
                maintenance: { enabled: false, count: 0 },
                technology: { enabled: false, count: 0 }
            },
            
            // Paso 4: Servicios de Apoyo
            services: {
                staffing: { enabled: false, description: '' },
                communications: { enabled: false, description: '' },
                technology: { enabled: false, description: '' },
                site_organization: { enabled: false, description: '' },
                resources: { enabled: false, description: '' }
            },
            
            // Paso 5: Aprobaci√≥n
            approverId: null
        };
        
        // Cat√°logo de men√∫s
        let menusData = [];
        
        // Aprobadores disponibles
        let approvers = [];

        // ==========================================
        // INICIALIZACI√ìN - PATR√ìN OBLIGATORIO
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // PASO 1: SIEMPRE validar permisos primero
                const hasAccess = await validatePageAccess('Eventos internos');
                if (!hasAccess) return;
                
                console.log('‚úÖ Acceso permitido');
                
                // PASO 2: Obtener sesi√≥n
                const session = getStoredSession();
                if (!session) {
                    showMessage('Sesi√≥n no v√°lida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '../../index.html', 2000);
                    return;
                }
                
                currentUserId = session.user_id;
                console.log('‚úÖ Usuario actual:', currentUserId);
                
                // PASO 3: Inicializar p√°gina
                initializePage('Eventos Internos', 'services');
                
                // PASO 4: Inicializar componentes
                initializeFlatpickr();
                await loadMenusCatalog();
                await loadApprovers();
                
                // PASO 5: Cargar eventos
                await loadEvents();
                
                // PASO 6: Event listeners
                setupEventListeners();
                
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                showMessage('Error al inicializar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // INICIALIZACI√ìN DE COMPONENTES
        // ==========================================
        
        function initializeFlatpickr() {
            // Fecha del evento
            flatpickr('#eventDate', {
                locale: 'es',
                dateFormat: 'Y-m-d',
                minDate: 'today',
                altInput: true,
                altFormat: 'F j, Y',
                onChange: function(selectedDates, dateStr) {
                    wizardData.eventDate = dateStr;
                }
            });
            
            // Filtros de fecha
            flatpickr('#filterDateFrom', {
                locale: 'es',
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: 'F j, Y',
                onChange: function() {
                    loadEvents();
                }
            });
            
            flatpickr('#filterDateTo', {
                locale: 'es',
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: 'F j, Y',
                onChange: function() {
                    loadEvents();
                }
            });
        }

        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        
        async function loadMenusCatalog() {
            try {
                const data = await supabaseRequest('/svc_catering_menus?is_active=eq.true&select=*&order=menu_name');
                
                menusData = data || [];
                console.log(`‚úÖ ${menusData.length} men√∫s cargados`);
                
                // Poblar selects
                const optionsHTML = menusData.map(menu => 
                    `<option value="${menu.menu_id}" data-price="${menu.unit_price}">
                        ${menu.menu_name} - $${formatCurrency(menu.unit_price)}
                    </option>`
                ).join('');
                
                document.getElementById('menuStudents').innerHTML = 
                    '<option value="">Seleccione un men√∫...</option>' + optionsHTML;
                document.getElementById('menuAdults').innerHTML = 
                    '<option value="">Seleccione un men√∫...</option>' + optionsHTML;
                
            } catch (error) {
                console.error('Error cargando men√∫s:', error);
                showMessage('Error al cargar el cat√°logo de men√∫s', 'warning');
            }
        }

        async function loadApprovers() {
            try {
                // Usar la funci√≥n RPC creada
                const data = await supabaseRequest('/rpc/get_workers_with_permission', {
                    method: 'POST',
                    body: JSON.stringify({ permission_name: 'Resoluci√≥n de solicitudes' })
                });
                
                approvers = data || [];
                console.log(`‚úÖ ${approvers.length} aprobadores cargados`);
                
                // Poblar select
                const select = document.getElementById('approverSelect');
                if (approvers.length === 0) {
                    select.innerHTML = '<option value="">No hay aprobadores disponibles</option>';
                } else {
                    const optionsHTML = approvers.map(approver => 
                        `<option value="${approver.worker_id}">
                            ${approver.worker_first_name} ${approver.worker_last_name_1}
                        </option>`
                    ).join('');
                    select.innerHTML = '<option value="">Seleccione un aprobador...</option>' + optionsHTML;
                }
                
            } catch (error) {
                console.error('Error cargando aprobadores:', error);
                
                // Intentar carga alternativa
                try {
                    const workers = await supabaseRequest('/workers?worker_status=eq.active&select=worker_id,worker_first_name,worker_last_name_1&order=worker_first_name');
                    
                    if (workers) {
                        approvers = workers;
                        const select = document.getElementById('approverSelect');
                        const optionsHTML = workers.map(w => 
                            `<option value="${w.worker_id}">${w.worker_first_name} ${w.worker_last_name_1}</option>`
                        ).join('');
                        select.innerHTML = '<option value="">Seleccione un aprobador...</option>' + optionsHTML;
                        console.log('‚úÖ Aprobadores cargados (modo alternativo)');
                    }
                } catch (altError) {
                    console.error('Error en carga alternativa:', altError);
                    showMessage('Error al cargar la lista de aprobadores', 'warning');
                }
            }
        }

        async function loadEvents() {
            try {
                const tbody = document.getElementById('eventsTableBody');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center"><i class="bi bi-hourglass-split"></i> Cargando...</td></tr>';
                
                let query = '/svc_internal_events?select=*,created_by_user:users!svc_internal_events_created_by_fkey(user_name)&order=event_date.desc';
                
                // Filtros
                const filterStatus = document.getElementById('filterStatus').value;
                if (filterStatus) {
                    query += `&event_status=eq.${filterStatus}`;
                }
                
                const filterDateFrom = document.getElementById('filterDateFrom').value;
                if (filterDateFrom) {
                    query += `&event_date=gte.${filterDateFrom}`;
                }
                
                const filterDateTo = document.getElementById('filterDateTo').value;
                if (filterDateTo) {
                    query += `&event_date=lte.${filterDateTo}`;
                }
                
                const data = await supabaseRequest(query);
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay eventos registrados</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(event => renderEventRow(event)).join('');
                console.log(`‚úÖ ${data.length} eventos cargados`);
                
            } catch (error) {
                console.error('Error cargando eventos:', error);
                showMessage('Error al cargar los eventos', 'danger');
            }
        }
        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        
        function setupEventListeners() {
            // Bot√≥n nuevo evento
            document.getElementById('btnNewEvent').addEventListener('click', function() {
                resetWizard();
                showWizard();
            });
            
            // Navegaci√≥n del wizard
            document.getElementById('btnNext').addEventListener('click', nextStep);
            document.getElementById('btnPrevious').addEventListener('click', previousStep);
            document.getElementById('btnCancel').addEventListener('click', cancelWizard);
            document.getElementById('btnSubmit').addEventListener('click', saveEvent);
            
            // Paso 1: Actualizar cantidades
            document.getElementById('numStudents').addEventListener('input', updateParticipantCounts);
            document.getElementById('numAdults').addEventListener('input', updateParticipantCounts);
            
            // Paso 2: Refrigerios
            document.getElementById('cateringStudentsCheck').addEventListener('change', toggleCateringStudents);
            document.getElementById('cateringAdultsCheck').addEventListener('change', toggleCateringAdults);
            document.getElementById('menuStudents').addEventListener('change', calculateCateringStudents);
            document.getElementById('menuAdults').addEventListener('change', calculateCateringAdults);
            
            // Paso 3: Personal de Apoyo
            document.getElementById('staffCleaningCheck').addEventListener('change', function() {
                toggleStaffField('cleaning');
            });
            document.getElementById('staffCafeteriaCheck').addEventListener('change', function() {
                toggleStaffField('cafeteria');
            });
            document.getElementById('staffMaintenanceCheck').addEventListener('change', function() {
                toggleStaffField('maintenance');
            });
            document.getElementById('staffTechnologyCheck').addEventListener('change', function() {
                toggleStaffField('technology');
            });
            
            // Paso 4: Servicios de Apoyo
            document.getElementById('serviceStaffingCheck').addEventListener('change', function() {
                toggleServiceField('staffing');
            });
            document.getElementById('serviceCommunicationsCheck').addEventListener('change', function() {
                toggleServiceField('communications');
            });
            document.getElementById('serviceTechnologyCheck').addEventListener('change', function() {
                toggleServiceField('technology');
            });
            document.getElementById('serviceSiteOrgCheck').addEventListener('change', function() {
                toggleServiceField('site_organization');
            });
            document.getElementById('serviceResourcesCheck').addEventListener('change', function() {
                toggleServiceField('resources');
            });
            
            // Filtros de tabla
            document.getElementById('filterStatus').addEventListener('change', loadEvents);
            
            // Modal cambiar estado
            document.getElementById('newStatus').addEventListener('change', function() {
                const statusReasonContainer = document.getElementById('statusReasonContainer');
                const value = this.value;
                if (value === 'suspended' || value === 'cancelled') {
                    statusReasonContainer.classList.remove('hidden');
                    document.getElementById('statusReason').required = true;
                } else {
                    statusReasonContainer.classList.add('hidden');
                    document.getElementById('statusReason').required = false;
                }
            });
            
            document.getElementById('btnConfirmStatusChange').addEventListener('click', confirmStatusChange);
        }

        // ==========================================
        // NAVEGACI√ìN DEL WIZARD
        // ==========================================
        
        function nextStep() {
            // Validar paso actual antes de avanzar
            if (!validateCurrentStep()) {
                return;
            }
            
            // Guardar datos del paso actual
            saveCurrentStepData();
            
            // Avanzar al siguiente paso
            if (currentStep < 5) {
                currentStep++;
                updateWizardUI();
                
                // Si es el paso 5, generar resumen
                if (currentStep === 5) {
                    generateSummary();
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateWizardUI();
            }
        }

        function updateWizardUI() {
            // Actualizar pasos visuales
            document.querySelectorAll('.wizard-step').forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNumber === currentStep) {
                    step.classList.add('active');
                } else if (stepNumber < currentStep) {
                    step.classList.add('completed');
                }
            });
            
            // Mostrar/ocultar contenido de pasos
            document.querySelectorAll('.step-content').forEach((content, index) => {
                const stepNumber = index + 1;
                if (stepNumber === currentStep) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // Controlar botones de navegaci√≥n
            const btnPrevious = document.getElementById('btnPrevious');
            const btnNext = document.getElementById('btnNext');
            const btnSubmit = document.getElementById('btnSubmit');
            
            btnPrevious.classList.toggle('hidden', currentStep === 1);
            
            if (currentStep === 5) {
                btnNext.classList.add('hidden');
                btnSubmit.classList.remove('hidden');
            } else {
                btnNext.classList.remove('hidden');
                btnSubmit.classList.add('hidden');
            }
            
            // Scroll al inicio del contenido
            document.querySelector('.wizard-content').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    return validateStep1();
                case 2:
                    return validateStep2();
                case 3:
                    return validateStep3();
                case 4:
                    return validateStep4();
                case 5:
                    return validateStep5();
                default:
                    return true;
            }
        }

        function validateStep1() {
            const eventName = document.getElementById('eventName').value.trim();
            const eventDate = document.getElementById('eventDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const eventLocation = document.getElementById('eventLocation').value.trim();
            const numStudents = parseInt(document.getElementById('numStudents').value) || 0;
            const numAdults = parseInt(document.getElementById('numAdults').value) || 0;
            
            if (!eventName) {
                showMessage('Por favor ingrese el nombre del evento', 'warning');
                document.getElementById('eventName').focus();
                return false;
            }
            
            if (!eventDate) {
                showMessage('Por favor seleccione la fecha del evento', 'warning');
                document.getElementById('eventDate').focus();
                return false;
            }
            
            if (!startTime) {
                showMessage('Por favor ingrese la hora de inicio', 'warning');
                document.getElementById('startTime').focus();
                return false;
            }
            
            if (!endTime) {
                showMessage('Por favor ingrese la hora de finalizaci√≥n', 'warning');
                document.getElementById('endTime').focus();
                return false;
            }
            
            if (startTime >= endTime) {
                showMessage('La hora de finalizaci√≥n debe ser posterior a la hora de inicio', 'warning');
                document.getElementById('endTime').focus();
                return false;
            }
            
            if (!eventLocation) {
                showMessage('Por favor ingrese la ubicaci√≥n del evento', 'warning');
                document.getElementById('eventLocation').focus();
                return false;
            }
            
            if (numStudents === 0 && numAdults === 0) {
                showMessage('Debe indicar al menos un participante (estudiantes o adultos)', 'warning');
                document.getElementById('numStudents').focus();
                return false;
            }
            
            return true;
        }

        function validateStep2() {
            // Refrigerios estudiantes
            if (document.getElementById('cateringStudentsCheck').checked) {
                const menuStudents = document.getElementById('menuStudents').value;
                if (!menuStudents) {
                    showMessage('Por favor seleccione un men√∫ para estudiantes', 'warning');
                    document.getElementById('menuStudents').focus();
                    return false;
                }
            }
            
            // Refrigerios adultos
            if (document.getElementById('cateringAdultsCheck').checked) {
                const menuAdults = document.getElementById('menuAdults').value;
                if (!menuAdults) {
                    showMessage('Por favor seleccione un men√∫ para adultos', 'warning');
                    document.getElementById('menuAdults').focus();
                    return false;
                }
            }
            
            return true;
        }

        function validateStep3() {
            // Validar que si se marca el checkbox, tenga cantidad
            const staffTypes = ['cleaning', 'cafeteria', 'maintenance', 'technology'];
            
            for (const type of staffTypes) {
                const checkbox = document.getElementById(`staff${capitalize(type)}Check`);
                const input = document.getElementById(`staff${capitalize(type)}Count`);
                
                if (checkbox.checked) {
                    const count = parseInt(input.value) || 0;
                    if (count < 1) {
                        showMessage(`Por favor indique la cantidad de personal de ${getStaffLabel(type)}`, 'warning');
                        input.focus();
                        return false;
                    }
                }
            }
            
            return true;
        }

        function validateStep4() {
            // Validar que si se marca el checkbox, tenga descripci√≥n
            const serviceTypes = ['staffing', 'communications', 'technology', 'site_organization', 'resources'];
            
            for (const type of serviceTypes) {
                const checkbox = document.getElementById(`service${getServiceCheckboxId(type)}Check`);
                const textarea = document.getElementById(`service${getServiceCheckboxId(type)}Desc`);
                
                if (checkbox.checked) {
                    const description = textarea.value.trim();
                    if (!description) {
                        showMessage(`Por favor describa las necesidades del servicio de ${getServiceLabel(type)}`, 'warning');
                        textarea.focus();
                        return false;
                    }
                }
            }
            
            return true;
        }

        function validateStep5() {
            const approverId = document.getElementById('approverSelect').value;
            
            if (!approverId) {
                showMessage('Por favor seleccione un aprobador', 'warning');
                document.getElementById('approverSelect').focus();
                return false;
            }
            
            return true;
        }
        // ==========================================
        // GUARDADO DE DATOS DEL WIZARD
        // ==========================================
        
        function saveCurrentStepData() {
            switch (currentStep) {
                case 1:
                    saveStep1Data();
                    break;
                case 2:
                    saveStep2Data();
                    break;
                case 3:
                    saveStep3Data();
                    break;
                case 4:
                    saveStep4Data();
                    break;
                case 5:
                    saveStep5Data();
                    break;
            }
        }

        function saveStep1Data() {
            wizardData.eventName = document.getElementById('eventName').value.trim();
            wizardData.eventDate = document.getElementById('eventDate').value;
            wizardData.startTime = document.getElementById('startTime').value;
            wizardData.endTime = document.getElementById('endTime').value;
            wizardData.eventLocation = document.getElementById('eventLocation').value.trim();
            wizardData.numStudents = parseInt(document.getElementById('numStudents').value) || 0;
            wizardData.numAdults = parseInt(document.getElementById('numAdults').value) || 0;
        }

        function saveStep2Data() {
            // Refrigerios estudiantes
            const cateringStudentsEnabled = document.getElementById('cateringStudentsCheck').checked;
            wizardData.cateringStudents.enabled = cateringStudentsEnabled;
            
            if (cateringStudentsEnabled) {
                const menuSelect = document.getElementById('menuStudents');
                const selectedOption = menuSelect.options[menuSelect.selectedIndex];
                
                wizardData.cateringStudents.menuId = menuSelect.value;
                wizardData.cateringStudents.menuName = selectedOption.text.split(' - ')[0];
                wizardData.cateringStudents.quantity = wizardData.numStudents;
                wizardData.cateringStudents.unitPrice = parseFloat(selectedOption.dataset.price) || 0;
                wizardData.cateringStudents.total = wizardData.cateringStudents.quantity * wizardData.cateringStudents.unitPrice;
            }
            
            // Refrigerios adultos
            const cateringAdultsEnabled = document.getElementById('cateringAdultsCheck').checked;
            wizardData.cateringAdults.enabled = cateringAdultsEnabled;
            
            if (cateringAdultsEnabled) {
                const menuSelect = document.getElementById('menuAdults');
                const selectedOption = menuSelect.options[menuSelect.selectedIndex];
                
                wizardData.cateringAdults.menuId = menuSelect.value;
                wizardData.cateringAdults.menuName = selectedOption.text.split(' - ')[0];
                wizardData.cateringAdults.quantity = wizardData.numAdults;
                wizardData.cateringAdults.unitPrice = parseFloat(selectedOption.dataset.price) || 0;
                wizardData.cateringAdults.total = wizardData.cateringAdults.quantity * wizardData.cateringAdults.unitPrice;
            }
        }

        function saveStep3Data() {
            const staffTypes = ['cleaning', 'cafeteria', 'maintenance', 'technology'];
            
            staffTypes.forEach(type => {
                const checkbox = document.getElementById(`staff${capitalize(type)}Check`);
                const input = document.getElementById(`staff${capitalize(type)}Count`);
                
                wizardData.supportStaff[type].enabled = checkbox.checked;
                wizardData.supportStaff[type].count = checkbox.checked ? (parseInt(input.value) || 0) : 0;
            });
        }

        function saveStep4Data() {
            const serviceTypes = ['staffing', 'communications', 'technology', 'site_organization', 'resources'];
            
            serviceTypes.forEach(type => {
                const checkbox = document.getElementById(`service${getServiceCheckboxId(type)}Check`);
                const textarea = document.getElementById(`service${getServiceCheckboxId(type)}Desc`);
                
                wizardData.services[type].enabled = checkbox.checked;
                wizardData.services[type].description = checkbox.checked ? textarea.value.trim() : '';
            });
        }

        function saveStep5Data() {
            wizardData.approverId = document.getElementById('approverSelect').value;
        }

        // ==========================================
        // FUNCIONES DE ACTUALIZACI√ìN EN TIEMPO REAL
        // ==========================================
        
        function updateParticipantCounts() {
            const numStudents = parseInt(document.getElementById('numStudents').value) || 0;
            const numAdults = parseInt(document.getElementById('numAdults').value) || 0;
            
            // Actualizar cantidades en paso 2
            document.getElementById('qtyStudents').value = numStudents;
            document.getElementById('qtyAdults').value = numAdults;
            
            // Recalcular totales si ya hay men√∫s seleccionados
            calculateCateringStudents();
            calculateCateringAdults();
        }

        function toggleCateringStudents() {
            const isChecked = document.getElementById('cateringStudentsCheck').checked;
            const fieldsContainer = document.getElementById('cateringStudentsFields');
            const box = document.getElementById('cateringStudentsBox');
            
            if (isChecked) {
                fieldsContainer.classList.remove('hidden');
                box.classList.add('active');
                document.getElementById('qtyStudents').value = wizardData.numStudents;
            } else {
                fieldsContainer.classList.add('hidden');
                box.classList.remove('active');
                document.getElementById('menuStudents').value = '';
                document.getElementById('priceStudents').value = '';
                document.getElementById('totalStudents').value = '';
            }
        }

        function toggleCateringAdults() {
            const isChecked = document.getElementById('cateringAdultsCheck').checked;
            const fieldsContainer = document.getElementById('cateringAdultsFields');
            const box = document.getElementById('cateringAdultsBox');
            
            if (isChecked) {
                fieldsContainer.classList.remove('hidden');
                box.classList.add('active');
                document.getElementById('qtyAdults').value = wizardData.numAdults;
            } else {
                fieldsContainer.classList.add('hidden');
                box.classList.remove('active');
                document.getElementById('menuAdults').value = '';
                document.getElementById('priceAdults').value = '';
                document.getElementById('totalAdults').value = '';
            }
        }

        function calculateCateringStudents() {
            const menuSelect = document.getElementById('menuStudents');
            const selectedOption = menuSelect.options[menuSelect.selectedIndex];
            
            if (menuSelect.value && selectedOption) {
                const unitPrice = parseFloat(selectedOption.dataset.price) || 0;
                const quantity = parseInt(document.getElementById('qtyStudents').value) || 0;
                const total = unitPrice * quantity;
                
                document.getElementById('priceStudents').value = `$${formatCurrency(unitPrice)}`;
                document.getElementById('totalStudents').value = `$${formatCurrency(total)}`;
            } else {
                document.getElementById('priceStudents').value = '';
                document.getElementById('totalStudents').value = '';
            }
        }

        function calculateCateringAdults() {
            const menuSelect = document.getElementById('menuAdults');
            const selectedOption = menuSelect.options[menuSelect.selectedIndex];
            
            if (menuSelect.value && selectedOption) {
                const unitPrice = parseFloat(selectedOption.dataset.price) || 0;
                const quantity = parseInt(document.getElementById('qtyAdults').value) || 0;
                const total = unitPrice * quantity;
                
                document.getElementById('priceAdults').value = `$${formatCurrency(unitPrice)}`;
                document.getElementById('totalAdults').value = `$${formatCurrency(total)}`;
            } else {
                document.getElementById('priceAdults').value = '';
                document.getElementById('totalAdults').value = '';
            }
        }

        function toggleStaffField(type) {
            const checkbox = document.getElementById(`staff${capitalize(type)}Check`);
            const input = document.getElementById(`staff${capitalize(type)}Count`);
            const box = document.getElementById(`staff${capitalize(type)}Box`);
            
            if (checkbox.checked) {
                input.disabled = false;
                input.focus();
                box.classList.add('active');
            } else {
                input.disabled = true;
                input.value = '';
                box.classList.remove('active');
            }
        }

        function toggleServiceField(type) {
            const checkboxId = getServiceCheckboxId(type);
            const checkbox = document.getElementById(`service${checkboxId}Check`);
            const fieldsContainer = document.getElementById(`service${checkboxId}Fields`);
            const box = document.getElementById(`service${checkboxId}Box`);
            
            if (checkbox.checked) {
                fieldsContainer.classList.remove('hidden');
                box.classList.add('active');
                document.getElementById(`service${checkboxId}Desc`).focus();
            } else {
                fieldsContainer.classList.add('hidden');
                box.classList.remove('active');
                document.getElementById(`service${checkboxId}Desc`).value = '';
            }
        }
        // ==========================================
        // GENERACI√ìN DEL RESUMEN (PASO 5)
        // ==========================================
        
        function generateSummary() {
            // Guardar datos actuales
            saveStep1Data();
            saveStep2Data();
            saveStep3Data();
            saveStep4Data();
            
            // Informaci√≥n B√°sica
            document.getElementById('summaryEventName').textContent = wizardData.eventName;
            document.getElementById('summaryLocation').textContent = wizardData.eventLocation;
            document.getElementById('summaryDate').textContent = formatDateDisplay(wizardData.eventDate);
            document.getElementById('summaryTime').textContent = `${wizardData.startTime} - ${wizardData.endTime}`;
            document.getElementById('summaryStudents').textContent = wizardData.numStudents;
            document.getElementById('summaryAdults').textContent = wizardData.numAdults;
            
            // Refrigerios
            const cateringSection = document.getElementById('summaryCateringSection');
            const cateringContent = document.getElementById('summaryCateringContent');
            
            const hasCatering = wizardData.cateringStudents.enabled || wizardData.cateringAdults.enabled;
            
            if (hasCatering) {
                cateringSection.classList.remove('hidden');
                let cateringHTML = '';
                
                if (wizardData.cateringStudents.enabled) {
                    cateringHTML += `
                        <p class="mb-2">
                            <strong>Estudiantes:</strong> ${wizardData.cateringStudents.menuName} 
                            x ${wizardData.cateringStudents.quantity} = 
                            <span class="text-primary fw-bold">$${formatCurrency(wizardData.cateringStudents.total)}</span>
                        </p>
                    `;
                }
                
                if (wizardData.cateringAdults.enabled) {
                    cateringHTML += `
                        <p class="mb-0">
                            <strong>Adultos:</strong> ${wizardData.cateringAdults.menuName} 
                            x ${wizardData.cateringAdults.quantity} = 
                            <span class="text-primary fw-bold">$${formatCurrency(wizardData.cateringAdults.total)}</span>
                        </p>
                    `;
                }
                
                cateringContent.innerHTML = cateringHTML;
            } else {
                cateringSection.classList.add('hidden');
            }
            
            // Personal de Apoyo
            const supportStaffSection = document.getElementById('summarySupportStaffSection');
            const supportStaffContent = document.getElementById('summarySupportStaffContent');
            
            const hasSupportStaff = Object.values(wizardData.supportStaff).some(s => s.enabled);
            
            if (hasSupportStaff) {
                supportStaffSection.classList.remove('hidden');
                let staffHTML = '<ul class="mb-0">';
                
                Object.keys(wizardData.supportStaff).forEach(type => {
                    if (wizardData.supportStaff[type].enabled) {
                        staffHTML += `<li>${getStaffLabel(type)}: ${wizardData.supportStaff[type].count} persona(s)</li>`;
                    }
                });
                
                staffHTML += '</ul>';
                supportStaffContent.innerHTML = staffHTML;
            } else {
                supportStaffSection.classList.add('hidden');
            }
            
            // Servicios de Apoyo
            const servicesSection = document.getElementById('summaryServicesSection');
            const servicesContent = document.getElementById('summaryServicesContent');
            
            const hasServices = Object.values(wizardData.services).some(s => s.enabled);
            
            if (hasServices) {
                servicesSection.classList.remove('hidden');
                let servicesHTML = '';
                
                Object.keys(wizardData.services).forEach(type => {
                    if (wizardData.services[type].enabled) {
                        servicesHTML += `
                            <div class="mb-3">
                                <strong class="text-primary">${getServiceLabel(type)}:</strong>
                                <p class="mb-0 ms-3">${wizardData.services[type].description}</p>
                            </div>
                        `;
                    }
                });
                
                servicesContent.innerHTML = servicesHTML;
            } else {
                servicesSection.classList.add('hidden');
            }
            
            // Resumen de Costos
            generateCostSummary();
        }

        function generateCostSummary() {
            let totalCost = 0;
            let linesHTML = '';
            
            // Refrigerios estudiantes
            if (wizardData.cateringStudents.enabled) {
                const cost = wizardData.cateringStudents.total;
                totalCost += cost;
                linesHTML += `
                    <div class="cost-line">
                        <span>Refrigerios Estudiantes</span>
                        <span class="fw-bold">$${formatCurrency(cost)}</span>
                    </div>
                `;
            }
            
            // Refrigerios adultos
            if (wizardData.cateringAdults.enabled) {
                const cost = wizardData.cateringAdults.total;
                totalCost += cost;
                linesHTML += `
                    <div class="cost-line">
                        <span>Refrigerios Adultos</span>
                        <span class="fw-bold">$${formatCurrency(cost)}</span>
                    </div>
                `;
            }
            
            // Nota sobre servicios de apoyo
            const hasServices = Object.values(wizardData.services).some(s => s.enabled);
            if (hasServices) {
                linesHTML += `
                    <div class="cost-line">
                        <span><em>Costos de servicios de apoyo (a registrar por cada √°rea)</em></span>
                        <span class="text-muted">Pendiente</span>
                    </div>
                `;
            }
            
            // Total
            linesHTML += `
                <div class="cost-line">
                    <span>TOTAL ESTIMADO</span>
                    <span>$${formatCurrency(totalCost)}</span>
                </div>
            `;
            
            document.getElementById('costSummaryLines').innerHTML = linesHTML;
        }

        // ==========================================
        // GUARDADO DEL EVENTO
        // ==========================================
        
        async function saveEvent() {
            try {
                // Validar paso 5
                if (!validateStep5()) {
                    return;
                }
                
                saveStep5Data();
                
                // Deshabilitar bot√≥n para evitar doble clic
                const btnSubmit = document.getElementById('btnSubmit');
                btnSubmit.disabled = true;
                btnSubmit.innerHTML = '<i class="bi bi-hourglass-split"></i> Guardando...';
                
                console.log('üìù Guardando evento...', wizardData);
                
                // 1. Crear la solicitud de aprobaci√≥n
                const requestData = await supabaseRequest('/svc_service_requests', {
                    method: 'POST',
                    body: JSON.stringify({
                        service_type: 'internal_event',
                        requested_by: currentUserId,
                        approver_id: wizardData.approverId,
                        request_status: 'pending'
                    })
                });
                
                const requestId = requestData[0].request_id;
                console.log('‚úÖ Solicitud creada:', requestId);
                
                // 2. Crear el evento principal
                const eventData = await supabaseRequest('/svc_internal_events', {
                    method: 'POST',
                    body: JSON.stringify({
                        request_id: requestId,
                        event_name: wizardData.eventName,
                        event_date: wizardData.eventDate,
                        start_time: wizardData.startTime,
                        end_time: wizardData.endTime,
                        event_location: wizardData.eventLocation,
                        num_students: wizardData.numStudents,
                        num_adults: wizardData.numAdults,
                        event_status: 'scheduled',
                        created_by: currentUserId
                    })
                });
                
                const eventId = eventData[0].event_id;
                console.log('‚úÖ Evento creado:', eventId);
                
                // 3. Insertar refrigerios
                const cateringInserts = [];
                
                if (wizardData.cateringStudents.enabled) {
                    cateringInserts.push({
                        event_id: eventId,
                        target_group: 'students',
                        menu_id: wizardData.cateringStudents.menuId,
                        quantity: wizardData.cateringStudents.quantity,
                        frozen_unit_price: wizardData.cateringStudents.unitPrice,
                        total_value: wizardData.cateringStudents.total
                    });
                }
                
                if (wizardData.cateringAdults.enabled) {
                    cateringInserts.push({
                        event_id: eventId,
                        target_group: 'adults',
                        menu_id: wizardData.cateringAdults.menuId,
                        quantity: wizardData.cateringAdults.quantity,
                        frozen_unit_price: wizardData.cateringAdults.unitPrice,
                        total_value: wizardData.cateringAdults.total
                    });
                }
                
                if (cateringInserts.length > 0) {
                    await supabaseRequest('/svc_internal_event_catering', {
                        method: 'POST',
                        body: JSON.stringify(cateringInserts)
                    });
                    console.log('‚úÖ Refrigerios insertados');
                }
                
                // 4. Insertar personal de apoyo
                const staffInserts = [];
                
                Object.keys(wizardData.supportStaff).forEach(area => {
                    if (wizardData.supportStaff[area].enabled) {
                        staffInserts.push({
                            event_id: eventId,
                            area: area,
                            staff_count: wizardData.supportStaff[area].count
                        });
                    }
                });
                
                if (staffInserts.length > 0) {
                    await supabaseRequest('/svc_internal_event_support_staff', {
                        method: 'POST',
                        body: JSON.stringify(staffInserts)
                    });
                    console.log('‚úÖ Personal de apoyo insertado');
                }
                
                // 5. Insertar servicios de apoyo
                const serviceInserts = [];
                
                Object.keys(wizardData.services).forEach(serviceType => {
                    if (wizardData.services[serviceType].enabled) {
                        serviceInserts.push({
                            event_id: eventId,
                            service_type: serviceType,
                            description: wizardData.services[serviceType].description,
                            notified_email: getServiceNotificationEmail(serviceType)
                        });
                    }
                });
                
                if (serviceInserts.length > 0) {
                    await supabaseRequest('/svc_internal_event_services', {
                        method: 'POST',
                        body: JSON.stringify(serviceInserts)
                    });
                    console.log('‚úÖ Servicios de apoyo insertados');
                }
                
                // 6. TODO: Enviar notificaciones
                console.log('üìß Notificaciones pendientes de implementar');
                
                // √âxito
                showMessage('Evento creado exitosamente. Se ha enviado la solicitud de aprobaci√≥n.', 'success');
                
                // Recargar tabla y ocultar wizard
                await loadEvents();
                hideWizard();
                resetWizard();
                
            } catch (error) {
                console.error('‚ùå Error guardando evento:', error);
                showMessage('Error al guardar el evento: ' + error.message, 'danger');
                
                // Rehabilitar bot√≥n
                const btnSubmit = document.getElementById('btnSubmit');
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = '<i class="bi bi-check-circle"></i> Guardar Evento';
            }
        }
        // ==========================================
        // RENDERIZADO DE LA TABLA
        // ==========================================
        
        function renderEventRow(event) {
            const statusBadge = getStatusBadge(event.event_status);
            const actions = renderActions(event);
            
            return `
                <tr>
                    <td>${event.event_name}</td>
                    <td>${formatDateDisplay(event.event_date)}</td>
                    <td>${event.start_time.substring(0, 5)} - ${event.end_time.substring(0, 5)}</td>
                    <td class="text-center">${event.num_students}</td>
                    <td class="text-center">${event.num_adults}</td>
                    <td class="text-center">${statusBadge}</td>
                    <td class="text-center table-actions">${actions}</td>
                </tr>
            `;
        }

        function getStatusBadge(status) {
            const badges = {
                'scheduled': '<span class="badge badge-status bg-primary">Programado</span>',
                'completed': '<span class="badge badge-status bg-success">Completado</span>',
                'suspended': '<span class="badge badge-status bg-warning">Suspendido</span>',
                'cancelled': '<span class="badge badge-status bg-danger">Cancelado</span>'
            };
            return badges[status] || '<span class="badge badge-status bg-secondary">Desconocido</span>';
        }

        function renderActions(event) {
            let actions = `
                <button class="btn btn-sm btn-info" onclick="viewEvent('${event.event_id}')" title="Ver detalle">
                    <i class="bi bi-eye"></i>
                </button>
            `;
            
            if (event.event_status === 'scheduled') {
                actions += `
                    <button class="btn btn-sm btn-warning ms-1" onclick="changeEventStatus('${event.event_id}')" title="Cambiar estado">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                `;
            }
            
            return actions;
        }

        // ==========================================
        // VER DETALLE DEL EVENTO
        // ==========================================
        
        async function viewEvent(eventId) {
            try {
                // Cargar evento con relaciones
                const event = await supabaseRequest(`/svc_internal_events?event_id=eq.${eventId}&select=*,created_by_user:users!svc_internal_events_created_by_fkey(user_name),request:svc_service_requests(*,approver:workers!svc_service_requests_approver_fkey(worker_first_name,worker_last_name_1))`);
                
                // Cargar refrigerios
                const catering = await supabaseRequest(`/svc_internal_event_catering?event_id=eq.${eventId}&select=*,menu:svc_catering_menus(menu_name)`);
                
                // Cargar personal de apoyo
                const staff = await supabaseRequest(`/svc_internal_event_support_staff?event_id=eq.${eventId}&select=*`);
                
                // Cargar servicios de apoyo
                const services = await supabaseRequest(`/svc_internal_event_services?event_id=eq.${eventId}&select=*`);
                
                // Renderizar detalle
                renderEventDetail(event[0], catering, staff, services);
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('viewEventModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error cargando detalle del evento:', error);
                showMessage('Error al cargar el detalle del evento', 'danger');
            }
        }

        function renderEventDetail(event, catering, staff, services) {
            const modalBody = document.getElementById('viewEventBody');
            
            let html = `
                <div class="event-detail-section">
                    <h6><i class="bi bi-info-circle"></i> Informaci√≥n B√°sica</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Nombre:</strong> ${event.event_name}</p>
                            <p><strong>Fecha:</strong> ${formatDateDisplay(event.event_date)}</p>
                            <p><strong>Horario:</strong> ${event.start_time.substring(0, 5)} - ${event.end_time.substring(0, 5)}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Ubicaci√≥n:</strong> ${event.event_location}</p>
                            <p><strong>Estudiantes:</strong> ${event.num_students}</p>
                            <p><strong>Adultos:</strong> ${event.num_adults}</p>
                        </div>
                    </div>
                    <p><strong>Estado:</strong> ${getStatusBadge(event.event_status)}</p>
                    ${event.status_reason ? `<p><strong>Raz√≥n:</strong> ${event.status_reason}</p>` : ''}
                    <p><strong>Creado por:</strong> ${event.created_by_user?.user_name || 'N/A'}</p>
                </div>
            `;
            
            // Aprobaci√≥n
            if (event.request) {
                const statusBadges = {
                    'pending': '<span class="badge bg-warning">Pendiente</span>',
                    'approved': '<span class="badge bg-success">Aprobado</span>',
                    'rejected': '<span class="badge bg-danger">Rechazado</span>'
                };
                
                html += `
                    <div class="event-detail-section">
                        <h6><i class="bi bi-person-check"></i> Estado de Aprobaci√≥n</h6>
                        <p><strong>Estado:</strong> ${statusBadges[event.request.request_status] || 'N/A'}</p>
                        <p><strong>Aprobador:</strong> ${event.request.approver ? 
                            `${event.request.approver.worker_first_name} ${event.request.approver.worker_last_name_1}` : 'N/A'}</p>
                        ${event.request.rejection_reason ? `<p><strong>Raz√≥n de rechazo:</strong> ${event.request.rejection_reason}</p>` : ''}
                    </div>
                `;
            }
            
            // Refrigerios
            if (catering && catering.length > 0) {
                html += `
                    <div class="event-detail-section">
                        <h6><i class="bi bi-cup-straw"></i> Refrigerios</h6>
                `;
                
                catering.forEach(item => {
                    const groupLabel = item.target_group === 'students' ? 'Estudiantes' : 'Adultos';
                    html += `
                        <p><strong>${groupLabel}:</strong> ${item.menu.menu_name} x ${item.quantity} = 
                        <span class="text-primary fw-bold">$${formatCurrency(item.total_value)}</span></p>
                    `;
                });
                
                html += `</div>`;
            }
            
            // Personal de apoyo
            if (staff && staff.length > 0) {
                html += `
                    <div class="event-detail-section">
                        <h6><i class="bi bi-people"></i> Personal de Apoyo</h6>
                        <ul>
                `;
                
                staff.forEach(item => {
                    html += `<li>${getStaffLabel(item.area)}: ${item.staff_count} persona(s)</li>`;
                });
                
                html += `</ul></div>`;
            }
            
            // Servicios de apoyo
            if (services && services.length > 0) {
                html += `
                    <div class="event-detail-section">
                        <h6><i class="bi bi-gear"></i> Servicios de Apoyo</h6>
                `;
                
                services.forEach(service => {
                    html += `
                        <div class="mb-3">
                            <strong class="text-primary">${getServiceLabel(service.service_type)}:</strong>
                            <p class="mb-1 ms-3">${service.description}</p>
                            ${service.cost_value ? 
                                `<p class="mb-0 ms-3"><strong>Costo registrado:</strong> $${formatCurrency(service.cost_value)}</p>` : 
                                '<p class="mb-0 ms-3 text-muted"><em>Costo pendiente de registro</em></p>'}
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            modalBody.innerHTML = html;
        }

        // ==========================================
        // CAMBIAR ESTADO DEL EVENTO
        // ==========================================
        
        function changeEventStatus(eventId) {
            document.getElementById('changeStatusEventId').value = eventId;
            document.getElementById('newStatus').value = '';
            document.getElementById('statusReason').value = '';
            document.getElementById('statusReasonContainer').classList.add('hidden');
            
            const modal = new bootstrap.Modal(document.getElementById('changeStatusModal'));
            modal.show();
        }

        async function confirmStatusChange() {
            try {
                const eventId = document.getElementById('changeStatusEventId').value;
                const newStatus = document.getElementById('newStatus').value;
                const statusReason = document.getElementById('statusReason').value.trim();
                
                if (!newStatus) {
                    showMessage('Por favor seleccione un estado', 'warning');
                    return;
                }
                
                if ((newStatus === 'suspended' || newStatus === 'cancelled') && !statusReason) {
                    showMessage('Por favor indique la raz√≥n del cambio de estado', 'warning');
                    return;
                }
                
                // Actualizar evento
                const updateData = {
                    event_status: newStatus,
                    updated_at: new Date().toISOString()
                };
                
                if (statusReason) {
                    updateData.status_reason = statusReason;
                }
                
                await supabaseRequest(`/svc_internal_events?event_id=eq.${eventId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });
                
                showMessage('Estado del evento actualizado correctamente', 'success');
                
                // Cerrar modal y recargar tabla
                bootstrap.Modal.getInstance(document.getElementById('changeStatusModal')).hide();
                await loadEvents();
                
            } catch (error) {
                console.error('Error cambiando estado:', error);
                showMessage('Error al cambiar el estado del evento', 'danger');
            }
        }
        // ==========================================
        // CONTROL DEL WIZARD
        // ==========================================
        
        function showWizard() {
            document.getElementById('wizardContainer').classList.remove('hidden');
            document.getElementById('eventsTableContainer').classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function hideWizard() {
            document.getElementById('wizardContainer').classList.add('hidden');
            document.getElementById('eventsTableContainer').classList.remove('hidden');
        }

        function resetWizard() {
            currentStep = 1;
            editingEventId = null;
            
            // Resetear wizardData
            wizardData = {
                eventName: '',
                eventDate: '',
                startTime: '',
                endTime: '',
                eventLocation: '',
                numStudents: 0,
                numAdults: 0,
                cateringStudents: { enabled: false, menuId: null, menuName: '', quantity: 0, unitPrice: 0, total: 0 },
                cateringAdults: { enabled: false, menuId: null, menuName: '', quantity: 0, unitPrice: 0, total: 0 },
                supportStaff: {
                    cleaning: { enabled: false, count: 0 },
                    cafeteria: { enabled: false, count: 0 },
                    maintenance: { enabled: false, count: 0 },
                    technology: { enabled: false, count: 0 }
                },
                services: {
                    staffing: { enabled: false, description: '' },
                    communications: { enabled: false, description: '' },
                    technology: { enabled: false, description: '' },
                    site_organization: { enabled: false, description: '' },
                    resources: { enabled: false, description: '' }
                },
                approverId: null
            };
            
            // Limpiar formulario paso 1
            document.getElementById('formStep1').reset();
            document.getElementById('eventDate').value = '';
            
            // Resetear paso 2
            document.getElementById('cateringStudentsCheck').checked = false;
            document.getElementById('cateringAdultsCheck').checked = false;
            toggleCateringStudents();
            toggleCateringAdults();
            
            // Resetear paso 3
            ['cleaning', 'cafeteria', 'maintenance', 'technology'].forEach(type => {
                document.getElementById(`staff${capitalize(type)}Check`).checked = false;
                toggleStaffField(type);
            });
            
            // Resetear paso 4
            ['staffing', 'communications', 'technology', 'site_organization', 'resources'].forEach(type => {
                const checkboxId = getServiceCheckboxId(type);
                document.getElementById(`service${checkboxId}Check`).checked = false;
                toggleServiceField(type);
            });
            
            // Resetear paso 5
            document.getElementById('approverSelect').value = '';
            
            // Resetear UI del wizard
            updateWizardUI();
            
            // T√≠tulo
            document.getElementById('wizardTitle').textContent = 'Nuevo Evento Interno';
        }

        function cancelWizard() {
            if (confirm('¬øEst√° seguro de cancelar? Se perder√°n todos los datos ingresados.')) {
                hideWizard();
                resetWizard();
            }
        }

        // ==========================================
        // FUNCIONES DE FORMATO Y HELPERS
        // ==========================================
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatDateDisplay(dateString) {
            if (!dateString) return 'N/A';
            
            const date = new Date(dateString + 'T00:00:00');
            
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function getStaffLabel(type) {
            const labels = {
                'cleaning': 'Aseo',
                'cafeteria': 'Cafeter√≠a',
                'maintenance': 'Mantenimiento',
                'technology': 'Tecnolog√≠a'
            };
            return labels[type] || type;
        }

        function getServiceLabel(type) {
            const labels = {
                'staffing': 'Personal de Apoyo (Staffing)',
                'communications': 'Comunicaciones',
                'technology': 'Recursos Tecnol√≥gicos',
                'site_organization': 'Organizaci√≥n del Sitio',
                'resources': 'Recursos (Papeler√≠a, Materiales)'
            };
            return labels[type] || type;
        }

        function getServiceCheckboxId(type) {
            const ids = {
                'staffing': 'Staffing',
                'communications': 'Communications',
                'technology': 'Technology',
                'site_organization': 'SiteOrg',
                'resources': 'Resources'
            };
            return ids[type] || type;
        }

        function getServiceNotificationEmail(serviceType) {
            // Estos correos deber√≠an cargarse desde svc_module_config
            // Por ahora retornamos valores por defecto
            const emails = {
                'staffing': 'coordinacion.servicios@colegiotilata.edu.co',
                'communications': 'comunicaciones@colegiotilata.edu.co',
                'technology': 'tecnologia@colegiotilata.edu.co',
                'site_organization': 'coordinacion.servicios@colegiotilata.edu.co',
                'resources': 'recursos@colegiotilata.edu.co'
            };
            return emails[serviceType] || 'coordinacion.servicios@colegiotilata.edu.co';
        }

        // ==========================================
        // FUNCIONES GLOBALES (para onclick en HTML)
        // ==========================================
        
        window.viewEvent = viewEvent;
        window.changeEventStatus = changeEventStatus;

        // ==========================================
        // MANEJO DE ERRORES GLOBAL
        // ==========================================
        
        window.addEventListener('error', function(event) {
            console.error('Error global capturado:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Promise rechazada no manejada:', event.reason);
        });

        // ==========================================
        // LOG DE VERSI√ìN
        // ==========================================
        
        console.log('%c SchoolNet - Eventos Internos ', 'background: #0d6efd; color: white; padding: 5px 10px; border-radius: 3px;');
        console.log('%c Versi√≥n: 26.02.08.16.00 ', 'color: #6c757d;');
        console.log('%c M√≥dulo: Servicios ', 'color: #6c757d;');
        console.log('%c Ambiente: ' + CURRENT_ENVIRONMENT.toUpperCase(), 'color: #6c757d;');
        
        console.log('‚úÖ internal-events.html cargado correctamente');
    </script>
</body>
</html>
