<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.27.09.30">
    <title>Salidas Pedag√≥gicas - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Flatpickr para fechas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <!-- Configuraci√≥n global -->
    <script src="/assets/js/config.js"></script>
    
    <style>
        :root {
            --service-primary: #1B365D;
            --service-accent: #667eea;
            --service-warning: #ffc107;
        }
        
        /* ==================== WIZARD STYLES ==================== */
        .wizard-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .wizard-progress {
            margin-bottom: 2rem;
        }
        
        .wizard-progress .progress {
            height: 8px;
            border-radius: 10px;
        }
        
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .wizard-step {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 0 10px;
        }
        
        .wizard-step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-weight: 600;
            transition: all 0.3s;
            border: 3px solid transparent;
        }
        
        .wizard-step.active .wizard-step-circle {
            background: var(--service-primary);
            color: white;
            border-color: var(--service-primary);
            transform: scale(1.1);
        }
        
        .wizard-step.completed .wizard-step-circle {
            background: #28a745;
            color: white;
        }
        
        .wizard-step-title {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .wizard-step.active .wizard-step-title {
            color: var(--service-primary);
            font-weight: 600;
        }
        
        .wizard-content {
            display: none;
        }
        
        .wizard-content.active {
            display: block;
            animation: fadeInUp 0.3s;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ==================== TABLE STYLES ==================== */
        .table-actions {
            display: flex;
            gap: 0.25rem;
            justify-content: center;
        }
        
        .table-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .badge-status {
            padding: 0.5rem 0.75rem;
            font-weight: 500;
            font-size: 0.8rem;
        }
        
        /* ==================== COST SUMMARY ==================== */
        .cost-summary-card {
            background: linear-gradient(135deg, var(--service-primary) 0%, var(--service-accent) 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .cost-item:last-child {
            border-bottom: none;
            font-size: 1.25rem;
            font-weight: 700;
            padding-top: 1rem;
        }
        
        /* ==================== FILTER PANEL ==================== */
        .filter-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        /* ==================== BANDERAZO ATTENDANCE ==================== */
        .banderazo-course-group {
            margin-bottom: 0.5rem;
        }
        
        .banderazo-course-header {
            background: #e9ecef;
            padding: 0.5rem 1rem;
            font-weight: 600;
            color: var(--service-primary);
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .banderazo-student {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.15s;
        }
        
        .banderazo-student:hover {
            background: #f8f9fa;
        }
        
        .banderazo-student.absent {
            background: #fff3cd;
            opacity: 0.7;
        }
        
        .banderazo-student .form-check-label {
            cursor: pointer;
            user-select: none;
        }
        
        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .wizard-step-title {
                font-size: 0.7rem;
            }
            
            .wizard-step-circle {
                width: 35px;
                height: 35px;
                font-size: 0.875rem;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
        }
        
        /* ==================== UTILITIES ==================== */
        .cursor-pointer {
            cursor: pointer;
        }
        
        .text-muted-light {
            color: #adb5bd;
        }
    </style>
</head>
<body>
    <!-- Contenedor principal -->
    <div class="container-fluid py-4">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html">Inicio</a></li>
                <li class="breadcrumb-item"><a href="index.html">Servicios</a></li>
                <li class="breadcrumb-item active" aria-current="page">Salidas pedag√≥gicas</li>
            </ol>
        </nav>
        
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="mb-1">
                    <i class="bi bi-backpack3 me-2"></i>Salidas Pedag√≥gicas
                </h3>
                <p class="text-muted mb-0">Gesti√≥n completa de salidas educativas</p>
            </div>
            <button class="btn btn-primary" onclick="abrirWizardNuevaSalida()">
                <i class="bi bi-plus-circle me-2"></i>Nueva Salida
            </button>
        </div>
        
        <!-- Panel de Filtros -->
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center cursor-pointer" 
                 data-bs-toggle="collapse" data-bs-target="#filtrosCollapse">
                <span><i class="bi bi-funnel me-2"></i>Filtros de b√∫squeda</span>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="collapse show" id="filtrosCollapse">
                <div class="card-body">
                    <form id="formFiltros">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Fecha inicio</label>
                                <input type="text" class="form-control" id="filtroFechaInicio" placeholder="Seleccione fecha">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Fecha fin</label>
                                <input type="text" class="form-control" id="filtroFechaFin" placeholder="Seleccione fecha">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Estado</label>
                                <select class="form-select" id="filtroEstado">
                                    <option value="">Todos los estados</option>
                                    <option value="scheduled">Programaci√≥n</option>
                                    <option value="imminent">Inminente</option>
                                    <option value="in_progress">En proceso</option>
                                    <option value="completed">Realizada</option>
                                    <option value="suspended">Suspendida</option>
                                    <option value="cancelled">Cancelada</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Grado</label>
                                <select class="form-select" id="filtroGrado" multiple>
                                    <!-- Se carga din√°micamente -->
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="button" class="btn btn-primary me-2" onclick="aplicarFiltros()">
                                    <i class="bi bi-search me-2"></i>Filtrar
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                                    <i class="bi bi-x-circle me-2"></i>Limpiar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Contador de resultados -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <span class="badge bg-secondary" id="contadorResultados">
                    <i class="bi bi-list-ul me-1"></i>0 salidas encontradas
                </span>
            </div>
        </div>
        
        <!-- Tabla de Salidas -->
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="tablaSalidas">
                        <thead class="table-dark">
                            <tr>
                                <th>Fecha</th>
                                <th>Grados</th>
                                <th>Destino</th>
                                <th>Estado</th>
                                <th class="text-center">Aprobaci√≥n</th>
                                <th class="text-center">Estudiantes</th>
                                <th class="text-center">Adultos</th>
                                <th class="text-end">Costo Total</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaSalidasBody">
                            <!-- Se carga din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Paginaci√≥n -->
        <nav aria-label="Paginaci√≥n" class="mt-3">
            <ul class="pagination justify-content-center" id="paginacion">
                <!-- Se genera din√°micamente -->
            </ul>
        </nav>
    </div>
    
    <!-- ==================== MODAL: WIZARD NUEVA SALIDA ==================== -->
    <div class="modal fade" id="modalWizardSalida" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle me-2"></i>Nueva Salida Pedag√≥gica
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="wizard-container">
                        <!-- Progress Bar -->
                        <div class="wizard-progress">
                            <div class="progress">
                                <div class="progress-bar" id="wizardProgressBar" style="width: 20%"></div>
                            </div>
                        </div>
                        
                        <!-- Wizard Steps -->
                        <div class="wizard-steps">
                            <div class="wizard-step active" data-step="1">
                                <div class="wizard-step-circle">1</div>
                                <div class="wizard-step-title">Informaci√≥n General</div>
                            </div>
                            <div class="wizard-step" data-step="2">
                                <div class="wizard-step-circle">2</div>
                                <div class="wizard-step-title">Descripci√≥n</div>
                            </div>
                            <div class="wizard-step" data-step="3">
                                <div class="wizard-step-circle">3</div>
                                <div class="wizard-step-title">Participantes</div>
                            </div>
                            <div class="wizard-step" data-step="4">
                                <div class="wizard-step-circle">4</div>
                                <div class="wizard-step-title">Servicios</div>
                            </div>
                            <div class="wizard-step" data-step="5">
                                <div class="wizard-step-circle">5</div>
                                <div class="wizard-step-title">Aprobaci√≥n</div>
                            </div>
                        </div>
                        
                        <!-- Wizard Content -->
                        <form id="formWizardSalida">
                            <!-- STEP 1: Informaci√≥n General -->
                            <div class="wizard-content active" data-step="1">
                                <h5 class="mb-3">Informaci√≥n General</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Grados participantes <span class="text-danger">*</span></label>
                                        <select class="form-select" id="wizardGrados" multiple required>
                                            <!-- Se carga din√°micamente -->
                                        </select>
                                        <small class="text-muted">Mant√©n presionado Ctrl para seleccionar m√∫ltiples</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Destino <span class="text-danger">*</span></label>
                                        <select class="form-select" id="wizardDestino" required>
                                            <option value="">Seleccione un destino</option>
                                            <!-- Se carga din√°micamente -->
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Fecha de salida <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="wizardFecha" required
                                               placeholder="Seleccione fecha">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Hora de salida <span class="text-danger">*</span></label>
                                        <input type="time" class="form-control" id="wizardHoraSalida" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Hora de regreso <span class="text-danger">*</span></label>
                                        <input type="time" class="form-control" id="wizardHoraRegreso" required>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">Modalidad de transporte <span class="text-danger">*</span></label>
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="wizardModalidad" id="modalidadIda" value="outbound" required>
                                            <label class="btn btn-outline-primary" for="modalidadIda">
                                                <i class="bi bi-arrow-right me-1"></i>Solo ida
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="wizardModalidad" id="modalidadRegreso" value="return">
                                            <label class="btn btn-outline-primary" for="modalidadRegreso">
                                                <i class="bi bi-arrow-left me-1"></i>Solo regreso
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="wizardModalidad" id="modalidadIdaVuelta" value="round_trip" checked>
                                            <label class="btn btn-outline-primary" for="modalidadIdaVuelta">
                                                <i class="bi bi-arrow-left-right me-1"></i>Ida y vuelta
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Nodos de transporte -->
                                    <div class="col-md-6" id="nodosSeccionSalida" style="display:none;">
                                        <label class="form-label">Nodos de salida</label>
                                        <div class="input-group mb-2">
                                            <select class="form-select" id="wizardNodoSalidaSelect">
                                                <option value="">Agregar nodo de salida...</option>
                                            </select>
                                            <button class="btn btn-outline-primary" type="button" onclick="agregarNodo('departure')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                        <div id="nodosSalidaList" class="d-flex flex-wrap gap-1"></div>
                                    </div>
                                    <div class="col-md-6" id="nodosSeccionLlegada" style="display:none;">
                                        <label class="form-label">Nodos de llegada</label>
                                        <div class="input-group mb-2">
                                            <select class="form-select" id="wizardNodoLlegadaSelect">
                                                <option value="">Agregar nodo de llegada...</option>
                                            </select>
                                            <button class="btn btn-outline-primary" type="button" onclick="agregarNodo('arrival')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                        <div id="nodosLlegadaList" class="d-flex flex-wrap gap-1"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- STEP 2: Descripci√≥n -->
                            <div class="wizard-content" data-step="2">
                                <h5 class="mb-3">Descripci√≥n de la Salida</h5>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label">T√≠tulo de la salida <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="wizardTitulo" required
                                               placeholder="Ej: Visita al Museo Nacional, Recorrido ecol√≥gico...">
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">Descripci√≥n <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="wizardDescripcion" rows="4" required 
                                                  placeholder="Describa el objetivo y actividades de la salida"></textarea>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">Unidad de indagaci√≥n</label>
                                        <textarea class="form-control" id="wizardUnidadIndagacion" rows="3" 
                                                  placeholder="¬øA qu√© unidad de indagaci√≥n est√° vinculada esta salida?"></textarea>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">Observaciones</label>
                                        <textarea class="form-control" id="wizardObservaciones" rows="3" 
                                                  placeholder="Informaci√≥n adicional relevante"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- STEP 3: Participantes -->
                            <div class="wizard-content" data-step="3">
                                <h5 class="mb-3">Participantes</h5>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>Estudiantes:</strong> Se calculan autom√°ticamente seg√∫n los grados seleccionados.
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">N√∫mero de estudiantes</label>
                                        <input type="number" class="form-control" id="wizardNumEstudiantes" readonly 
                                               style="background-color: #e9ecef;">
                                        <small class="text-muted" id="wizardDesglosePorGrado">
                                            <!-- Se actualiza din√°micamente -->
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Adultos acompa√±antes</label>
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="wizardAdultoSearch" 
                                                   placeholder="Buscar por nombre..." oninput="filtrarWorkersPedagogicas()">
                                            <button class="btn btn-outline-primary" type="button" onclick="agregarAdultoPedagogicas()">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                        <select class="form-select form-select-sm" id="wizardAdultosWorkersSelect" size="4" style="display:none;">
                                        </select>
                                        <div id="wizardAdultosBadges" class="d-flex flex-wrap gap-1 mt-1"></div>
                                        <div class="mt-1">
                                            <span class="badge bg-info" id="wizardAdultosCount">0 adultos seleccionados</span>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="alert alert-success">
                                            <strong>Total de participantes:</strong> <span id="wizardTotalParticipantes">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- STEP 4: Servicios Opcionales -->
                            <div class="wizard-content" data-step="4">
                                <h5 class="mb-3">Servicios Opcionales</h5>
                                
                                <!-- Refrigerios -->
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="wizardIncluirRefrigerios">
                                            <label class="form-check-label fw-bold" for="wizardIncluirRefrigerios">
                                                <i class="bi bi-cup-straw me-2"></i>Incluir Refrigerios
                                            </label>
                                        </div>
                                        <div id="wizardRefrigeriosFields" style="display: none;">
                                            <div class="row g-3">
                                                <div class="col-md-8">
                                                    <label class="form-label">Men√∫</label>
                                                    <select class="form-select" id="wizardMenuRefrigerio">
                                                        <option value="">Seleccione un men√∫</option>
                                                        <!-- Se carga din√°micamente -->
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Cantidad</label>
                                                    <input type="number" class="form-control" id="wizardCantidadRefrigerios" min="1" placeholder="Se auto-llena con total de participantes">
                                                    <small class="text-muted">Auto-llenado. Puedes modificarlo si necesitas.</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Entradas -->
                                <div class="card">
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="wizardIncluirEntradas">
                                            <label class="form-check-label fw-bold" for="wizardIncluirEntradas">
                                                <i class="bi bi-ticket-perforated me-2"></i>Incluir Entradas
                                            </label>
                                        </div>
                                        <div id="wizardEntradasFields" style="display: none;">
                                            <div class="row g-3">
                                                <div class="col-md-12">
                                                    <label class="form-label">Valor unitario de la entrada</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control" id="wizardValorEntrada" min="0" step="1000">
                                                    </div>
                                                    <small class="text-muted">Este valor aplica para todos los participantes</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- STEP 5: Aprobaci√≥n y Resumen -->
                            <div class="wizard-content" data-step="5">
                                <h5 class="mb-3">Aprobaci√≥n y Resumen</h5>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Aprobador <span class="text-danger">*</span></label>
                                        <select class="form-select" id="wizardAprobador" required>
                                            <option value="">Seleccione un aprobador</option>
                                            <!-- Se carga din√°micamente -->
                                        </select>
                                        <small class="text-muted">Solo usuarios con permiso de "Resoluci√≥n de solicitudes"</small>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">Comentarios/Justificaci√≥n</label>
                                        <textarea class="form-control" id="wizardComentarios" rows="3" 
                                                  placeholder="Informaci√≥n adicional para el aprobador"></textarea>
                                    </div>
                                    
                                    <!-- Resumen de Costos -->
                                    <div class="col-md-12">
                                        <div class="cost-summary-card">
                                            <h5 class="mb-3">
                                                <i class="bi bi-calculator me-2"></i>Resumen de Costos
                                            </h5>
                                            <div class="cost-item">
                                                <span>Transporte:</span>
                                                <span id="wizardCostoTransporte">$0</span>
                                            </div>
                                            <div id="detalleVehiculosContainer" style="display: none; margin-left: 20px; font-size: 0.85em; color: #666;">
                                                <!-- Aqu√≠ se mostrar√° el detalle de veh√≠culos -->
                                            </div>
                                            <div class="cost-item">
                                                <span>Refrigerios:</span>
                                                <span id="wizardCostoRefrigerios">$0</span>
                                            </div>
                                            <div class="cost-item">
                                                <span>Entradas:</span>
                                                <span id="wizardCostoEntradas">$0</span>
                                            </div>
                                            <div class="cost-item">
                                                <span>TOTAL:</span>
                                                <span id="wizardCostoTotal">$0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" id="btnWizardAnterior" onclick="wizardAnterior()">
                        <i class="bi bi-chevron-left me-1"></i>Anterior
                    </button>
                    <button type="button" class="btn btn-primary" id="btnWizardSiguiente" onclick="wizardSiguiente()">
                        Siguiente<i class="bi bi-chevron-right ms-1"></i>
                    </button>
                    <button type="button" class="btn btn-success" id="btnWizardGuardar" style="display: none;" onclick="guardarNuevaSalida()">
                        <i class="bi bi-check-circle me-1"></i>Guardar y Solicitar Aprobaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== MODAL: BANDERAZO CON ASISTENCIA ==================== -->
    <div class="modal fade" id="modalBanderazo" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-flag-fill me-2"></i>Banderazo de Salida
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Info de la salida -->
                    <div class="alert alert-info mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong id="banderazoDestino">Destino</strong><br>
                                <small id="banderazoInfo" class="text-muted"></small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success fs-6" id="banderazoContador">0 / 0</span>
                                <br><small class="text-muted">Asistentes</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- B√∫squeda r√°pida -->
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="banderazoBuscar" 
                                   placeholder="Buscar estudiante por nombre...">
                        </div>
                    </div>
                    
                    <!-- Acciones masivas -->
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-sm btn-outline-success" onclick="banderazoMarcarTodos(true)">
                            <i class="bi bi-check-all me-1"></i>Marcar todos
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="banderazoMarcarTodos(false)">
                            <i class="bi bi-x-lg me-1"></i>Desmarcar todos
                        </button>
                    </div>
                    
                    <!-- Lista de estudiantes -->
                    <div id="banderazoListaEstudiantes" 
                         style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px;">
                        <!-- Se carga din√°micamente -->
                    </div>
                    
                    <!-- Aviso -->
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Al confirmar, el estado cambiar√° a <strong>"En proceso"</strong> y se registrar√° la asistencia definitiva.
                    </div>
                    
                    <input type="hidden" id="banderazoTripId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="btnConfirmarBanderazo" onclick="confirmarBanderazo()">
                        <i class="bi bi-flag-fill me-2"></i>Confirmar Banderazo
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== MODAL: SUSPENDER/CANCELAR ==================== -->
    <div class="modal fade" id="modalSuspender" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-x-circle me-2"></i>Suspender Salida
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formSuspender">
                        <div class="mb-3">
                            <label class="form-label">Raz√≥n de suspensi√≥n <span class="text-danger">*</span></label>
                            <select class="form-select mb-2" id="suspenderRazonSelect">
                                <option value="">Seleccione una raz√≥n</option>
                                <option value="clima">Condiciones clim√°ticas adversas</option>
                                <option value="orden_publico">Situaci√≥n de orden p√∫blico</option>
                                <option value="transporte">Problema con el transporte</option>
                                <option value="destino">Problema en el destino</option>
                                <option value="otro">Otro</option>
                            </select>
                            <textarea class="form-control" id="suspenderRazonDetalle" rows="3" 
                                      placeholder="Detalles adicionales..." required></textarea>
                        </div>
                        <input type="hidden" id="suspenderTripId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarSuspension()">
                        <i class="bi bi-x-circle me-2"></i>Suspender Salida
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== MODAL: VER DETALLE ==================== -->
    <div class="modal fade" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-eye me-2"></i>Detalle de Salida Pedag√≥gica
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="detalleContent">
                        <!-- Se carga din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    
    <!-- jsPDF para generaci√≥n de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // ==================== VARIABLES GLOBALES ====================
        let currentUser = null;
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentWizardStep = 1;
        let filtrosActivos = {};
        
        // Instancias Flatpickr
        let fpWizardFecha = null;
        let fpFiltroInicio = null;
        let fpFiltroFin = null;
        let datosGlobales = {
            grados: [],
            destinos: [],
            menus: [],
            aprobadores: [],
            workers: [],
            nodos: [],
            salidas: [],
            detalleTransporte: null,
            diasMinimosAntelacion: 7,
            emailSecretariaPreescolarPrimaria: '',
            emailSecretariaBachillerato: '',
            emailChef: '',
            emailSupervisor: '',
            esAdminSalidas: false
        };
        
        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando m√≥dulo de Salidas Pedag√≥gicas...');
            
            try {
                // Verificar que config.js se haya cargado
                if (typeof validatePageAccess !== 'function') {
                    console.error('‚ùå Error: config.js no se carg√≥ correctamente');
                    alert('Error al cargar el m√≥dulo: validatePageAccess is not defined. Verifique que config.js est√© en la ruta correcta.');
                    return;
                }
                
                if (typeof supabaseRequest !== 'function') {
                    console.error('‚ùå Error: supabaseRequest no est√° definida');
                    alert('Error al cargar el m√≥dulo: supabaseRequest is not defined. Verifique que config.js est√© en la ruta correcta.');
                    return;
                }
                
                // Validar acceso
                const tieneAcceso = await validatePageAccess('Salidas pedag√≥gicas');
                if (!tieneAcceso) return;
                
                // Cargar colores corporativos
                if (typeof loadAndApplyBrandColors === 'function') {
                    await loadAndApplyBrandColors();
                }
                
                // Obtener usuario actual
                if (typeof getStoredSession === 'function') {
                    const session = getStoredSession();
                    if (session && session.user) {
                        currentUser = session.user;
                    }
                } else {
                    console.warn('‚ö†Ô∏è getStoredSession no est√° disponible');
                }
                
                // Cargar datos iniciales
                await cargarDatosIniciales();
                
                // Inicializar selectores de fecha Flatpickr
                initializeFlatpickr();
                
                try {
                    const transResult = await supabaseRequest('/rpc/transition_trip_statuses', {
                        method: 'POST',
                        body: JSON.stringify({})
                    });
                    if (transResult && transResult.success) {
                        const t = transResult.transitions;
                        if (t.to_imminent > 0 || t.to_completed > 0) {
                            console.log(`üîÑ Transiciones: ${t.to_imminent} ‚Üí Inminente, ${t.to_completed} ‚Üí Realizada, ${t.attendance_records_loaded} estudiantes cargados`);
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è No se pudieron ejecutar transiciones autom√°ticas:', error);
                }
                
                // Cargar salidas
                await cargarSalidas();

                
                // Configurar event listeners
                configurarEventListeners();
                
                console.log('‚úÖ M√≥dulo cargado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando m√≥dulo:', error);
                alert('Error al cargar el m√≥dulo: ' + error.message);
            }
        });
        
        // ==================== CARGAR DATOS INICIALES ====================
        async function cargarDatosIniciales() {
            try {
                console.log('üì• Cargando datos iniciales...');
                
                // Cargar grados
                const grados = await supabaseRequest('/grades?select=grade_id,grade_name,section_id,sections(section_name)&grade_status=eq.active&order=grade_order');
                datosGlobales.grados = grados || [];
                
                // Cargar destinos
                const destinos = await supabaseRequest('/svc_transport_destinations?select=destination_id,destination_name,destination_address&is_active=eq.true&order=destination_name');
                datosGlobales.destinos = destinos || [];
                
                // Cargar men√∫s de refrigerios
                const menus = await supabaseRequest('/svc_catering_menus?select=menu_id,menu_name,unit_price&is_active=eq.true&order=menu_name');
                datosGlobales.menus = menus || [];
                
                // Cargar workers activos (para adultos acompa√±antes)
                const workers = await supabaseRequest('/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2&worker_status=eq.active&order=worker_last_name_1,worker_first_name');
                datosGlobales.workers = workers || [];
                
                // Cargar nodos de transporte
                const nodos = await supabaseRequest('/svc_transport_nodes?select=node_id,node_name,node_description,node_order&is_active=eq.true&order=node_order,node_name');
                datosGlobales.nodos = nodos || [];
                
                // Verificar si el usuario es Administrador de salidas pedag√≥gicas
                try {
                    datosGlobales.esAdminSalidas = await checkUserPermission(
                        currentUser.user_id, 
                        'Administrador de salidas pedag√≥gicas'
                    );
                    console.log('üîë Es admin de salidas:', datosGlobales.esAdminSalidas);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error verificando permiso admin salidas:', error);
                    datosGlobales.esAdminSalidas = false;
                }
                
                // Cargar aprobadores (workers con permiso "Resoluci√≥n de solicitudes")
                // Usa funci√≥n RPC get_workers_with_permission
                try {
                    const aprobadores = await supabaseRequest('/rpc/get_workers_with_permission', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            permission_name: 'Resoluci√≥n de solicitudes' 
                        })
                    });
                    datosGlobales.aprobadores = aprobadores || [];
                    console.log('‚úÖ Aprobadores cargados:', aprobadores.length);
                } catch (error) {
                    console.error('‚ùå Error cargando aprobadores:', error);
                    // Fallback: cargar todos los workers activos
                    console.warn('‚ö†Ô∏è Fallback: Cargando todos los workers activos');
                    const todosWorkers = await supabaseRequest('/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,email&worker_status=eq.active&order=worker_first_name');
                    datosGlobales.aprobadores = todosWorkers || [];
                }
                
                // Cargar par√°metros del m√≥dulo (d√≠as m√≠nimos de antelaci√≥n)
                try {
                    const configDias = await supabaseRequest('/svc_module_config?select=config_value&config_key=eq.min_days_advance');
                    if (configDias && configDias.length > 0) {
                        datosGlobales.diasMinimosAntelacion = parseInt(configDias[0].config_value) || 7;
                    } else {
                        datosGlobales.diasMinimosAntelacion = 7; // Default
                    }
                    console.log('‚úÖ D√≠as m√≠nimos de antelaci√≥n:', datosGlobales.diasMinimosAntelacion);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error cargando configuraci√≥n de d√≠as m√≠nimos, usando default 7:', error);
                    datosGlobales.diasMinimosAntelacion = 7;
                }

                // Cargar correos de secretar√≠as
                try {
                    const configSecretarias = await supabaseRequest(
                        '/svc_module_config?select=config_key,config_value&config_key=in.(email_secretary_preschool_primary,email_secretary_high_school,email_chef,email_supervisor)'
                    );
                    if (configSecretarias) {
                        configSecretarias.forEach(c => {
                        if (c.config_key === 'email_secretary_preschool_primary') {
                            datosGlobales.emailSecretariaPreescolarPrimaria = c.config_value || '';
                        }
                        if (c.config_key === 'email_secretary_high_school') {
                            datosGlobales.emailSecretariaBachillerato = c.config_value || '';
                        }
                        if (c.config_key === 'email_chef') {
                            datosGlobales.emailChef = c.config_value || '';
                        }
                        if (c.config_key === 'email_supervisor') {
                            datosGlobales.emailSupervisor = c.config_value || '';
                        }
                    });
                    }
                    console.log('‚úÖ Correos de secretar√≠as cargados');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error cargando correos de secretar√≠as:', error);
                }
                
                // Llenar selects
                llenarSelectGrados();
                llenarSelectDestinos();
                llenarSelectMenus();
                llenarSelectAprobadores();
                llenarSelectWorkers();
                llenarSelectNodos();
                
                console.log('‚úÖ Datos iniciales cargados');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos iniciales:', error);
                throw error;
            }
        }
        
        // ==================== LLENAR SELECTS ====================
        function llenarSelectGrados() {
            const selects = ['filtroGrado', 'wizardGrados'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = datosGlobales.grados.map(g => 
                        `<option value="${g.grade_id}">${g.grade_name}</option>`
                    ).join('');
                }
            });
        }
        
        function llenarSelectDestinos() {
            const select = document.getElementById('wizardDestino');
            if (select) {
                select.innerHTML = '<option value="">Seleccione un destino</option>' +
                    datosGlobales.destinos.map(d => 
                        `<option value="${d.destination_id}">${d.destination_name}</option>`
                    ).join('');
            }
        }
        
        function llenarSelectMenus() {
            const select = document.getElementById('wizardMenuRefrigerio');
            if (select) {
                select.innerHTML = '<option value="">Seleccione un men√∫</option>' +
                    datosGlobales.menus.map(m => 
                        `<option value="${m.menu_id}" data-price="${m.unit_price}">${m.menu_name} - $${formatNumber(m.unit_price)}</option>`
                    ).join('');
            }
        }
        
        function llenarSelectAprobadores() {
            const select = document.getElementById('wizardAprobador');
            if (select) {
                select.innerHTML = '<option value="">Seleccione un aprobador</option>' +
                    datosGlobales.aprobadores.map(a => {
                        const nombreCompleto = `${a.worker_last_name_1}${a.worker_last_name_2 ? ' ' + a.worker_last_name_2 : ''}, ${a.worker_first_name}`;
                        return `<option value="${a.worker_id}">${nombreCompleto}</option>`;
                    }).join('');
            }
        }
        
        let selectedAdultosPedagogicas = [];

        function llenarSelectWorkers() {
            filtrarWorkersPedagogicas();
        }
        
        function filtrarWorkersPedagogicas() {
            const busqueda = (document.getElementById('wizardAdultoSearch').value || '').toLowerCase().trim();
            const sel = document.getElementById('wizardAdultosWorkersSelect');
            
            const disponibles = datosGlobales.workers.filter(w => {
                if (selectedAdultosPedagogicas.includes(w.worker_id)) return false;
                if (!busqueda) return true;
                const nombre = `${w.worker_first_name} ${w.worker_last_name_1} ${w.worker_last_name_2 || ''}`.toLowerCase();
                return nombre.includes(busqueda);
            });
            
            sel.innerHTML = disponibles.map(w => {
                const name = `${w.worker_last_name_1}${w.worker_last_name_2 ? ' ' + w.worker_last_name_2 : ''}, ${w.worker_first_name}`;
                return `<option value="${w.worker_id}">${name}</option>`;
            }).join('');
            
            sel.style.display = busqueda && disponibles.length > 0 ? '' : 'none';
        }
        
        function agregarAdultoPedagogicas() {
            const sel = document.getElementById('wizardAdultosWorkersSelect');
            const workerId = sel.value;
            if (!workerId) return;
            
            if (!selectedAdultosPedagogicas.includes(workerId)) {
                selectedAdultosPedagogicas.push(workerId);
                renderBadgesAdultosPedagogicas();
                actualizarTotalParticipantes();
                calcularCostosWizard();
            }
            
            document.getElementById('wizardAdultoSearch').value = '';
            filtrarWorkersPedagogicas();
        }
        
        function removerAdultoPedagogicas(workerId) {
            selectedAdultosPedagogicas = selectedAdultosPedagogicas.filter(id => id !== workerId);
            renderBadgesAdultosPedagogicas();
            filtrarWorkersPedagogicas();
            actualizarTotalParticipantes();
            calcularCostosWizard();
        }
        
        function renderBadgesAdultosPedagogicas() {
            const container = document.getElementById('wizardAdultosBadges');
            container.innerHTML = selectedAdultosPedagogicas.map(wId => {
                const w = datosGlobales.workers.find(cw => cw.worker_id === wId);
                const name = w ? `${w.worker_first_name} ${w.worker_last_name_1}` : 'N/A';
                return `<span class="badge bg-primary p-2">
                    <i class="bi bi-person-fill me-1"></i>${name}
                    <i class="bi bi-x-circle ms-1" style="cursor:pointer" onclick="removerAdultoPedagogicas('${wId}')"></i>
                </span>`;
            }).join('');
            
            const count = selectedAdultosPedagogicas.length;
            document.getElementById('wizardAdultosCount').textContent = 
                `${count} adulto${count !== 1 ? 's' : ''} seleccionado${count !== 1 ? 's' : ''}`;
        }
        
        function llenarSelectNodos() {
            const optionsHtml = datosGlobales.nodos.map(n => 
                `<option value="${n.node_id}">${n.node_name}</option>`
            ).join('');
            
            const selSalida = document.getElementById('wizardNodoSalidaSelect');
            const selLlegada = document.getElementById('wizardNodoLlegadaSelect');
            if (selSalida) selSalida.innerHTML = '<option value="">Agregar nodo de salida...</option>' + optionsHtml;
            if (selLlegada) selLlegada.innerHTML = '<option value="">Agregar nodo de llegada...</option>' + optionsHtml;
        }
        
        // ==================== GESTI√ìN DE NODOS ====================
        let selectedNodosSalida = [];
        let selectedNodosLlegada = [];
        
        function actualizarVisibilidadNodos() {
            const modalidad = document.querySelector('input[name="wizardModalidad"]:checked')?.value || 'round_trip';
            const showSalida = modalidad === 'outbound' || modalidad === 'round_trip';
            const showLlegada = modalidad === 'return' || modalidad === 'round_trip';
            
            document.getElementById('nodosSeccionSalida').style.display = showSalida ? '' : 'none';
            document.getElementById('nodosSeccionLlegada').style.display = showLlegada ? '' : 'none';
            
            if (!showSalida) { selectedNodosSalida = []; renderNodos('departure'); }
            if (!showLlegada) { selectedNodosLlegada = []; renderNodos('arrival'); }
        }
        
        function agregarNodo(role) {
            const selectId = role === 'departure' ? 'wizardNodoSalidaSelect' : 'wizardNodoLlegadaSelect';
            const sel = document.getElementById(selectId);
            const nodeId = sel.value;
            if (!nodeId) return;
            
            const nodeArr = role === 'departure' ? selectedNodosSalida : selectedNodosLlegada;
            if (nodeArr.find(n => n.node_id === nodeId)) { sel.value = ''; return; }
            
            const nodo = datosGlobales.nodos.find(n => n.node_id === nodeId);
            if (nodo) {
                nodeArr.push(nodo);
                renderNodos(role);
            }
            sel.value = '';
        }
        
        function eliminarNodo(role, nodeId) {
            if (role === 'departure') {
                selectedNodosSalida = selectedNodosSalida.filter(n => n.node_id !== nodeId);
            } else {
                selectedNodosLlegada = selectedNodosLlegada.filter(n => n.node_id !== nodeId);
            }
            renderNodos(role);
        }
        
        function renderNodos(role) {
            const nodos = role === 'departure' ? selectedNodosSalida : selectedNodosLlegada;
            const containerId = role === 'departure' ? 'nodosSalidaList' : 'nodosLlegadaList';
            const cssClass = role === 'departure' ? 'bg-primary' : 'bg-success';
            
            document.getElementById(containerId).innerHTML = nodos.map(n => `
                <span class="badge ${cssClass} p-2 me-1 mb-1">
                    <i class="bi bi-geo-alt-fill me-1"></i>${n.node_name}
                    <i class="bi bi-x-circle ms-1" style="cursor:pointer" onclick="eliminarNodo('${role}','${n.node_id}')"></i>
                </span>
            `).join('');
        }
        
        function actualizarContadorAdultos() {
            renderBadgesAdultosPedagogicas();
            actualizarTotalParticipantes();
            calcularCostosWizard();
        }
        
        // ==================== INICIALIZACI√ìN FLATPICKR ====================
        function initializeFlatpickr() {
            // Calcular fecha m√≠nima seg√∫n configuraci√≥n
            const today = new Date();
            const minDate = new Date(today);
            minDate.setDate(today.getDate() + (datosGlobales.diasMinimosAntelacion || 7));
            
            // Fecha del wizard (con restricci√≥n de d√≠as m√≠nimos)
            fpWizardFecha = flatpickr('#wizardFecha', {
                locale: 'es',
                dateFormat: 'Y-m-d',
                minDate: minDate,
                altInput: true,
                altFormat: 'j \\de F \\de Y',
                disableMobile: true,
                onReady: function(selectedDates, dateStr, instance) {
                    instance.altInput.placeholder = `M√≠nimo ${datosGlobales.diasMinimosAntelacion || 7} d√≠as de antelaci√≥n`;
                }
            });
            
            // Filtros de fecha (sin restricci√≥n)
            fpFiltroInicio = flatpickr('#filtroFechaInicio', {
                locale: 'es',
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: 'j \\de F \\de Y',
                disableMobile: true
            });
            
            fpFiltroFin = flatpickr('#filtroFechaFin', {
                locale: 'es',
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: 'j \\de F \\de Y',
                disableMobile: true
            });
            
            console.log('‚úÖ Flatpickr inicializado (m√≠nimo ' + (datosGlobales.diasMinimosAntelacion || 7) + ' d√≠as de antelaci√≥n)');
        }
        
        // ==================== EVENT LISTENERS ====================
        function configurarEventListeners() {
            // Toggle refrigerios
            document.getElementById('wizardIncluirRefrigerios').addEventListener('change', function() {
                const mostrar = this.checked;
                document.getElementById('wizardRefrigeriosFields').style.display = mostrar ? 'block' : 'none';
                
                // Auto-llenar cantidad con total de participantes al activar
                if (mostrar) {
                    const totalParticipantes = parseInt(document.getElementById('wizardTotalParticipantes').textContent) || 0;
                    if (totalParticipantes > 0) {
                        document.getElementById('wizardCantidadRefrigerios').value = totalParticipantes;
                    }
                }
                
                calcularCostosWizard();
            });
            
            // Toggle entradas
            document.getElementById('wizardIncluirEntradas').addEventListener('change', function() {
                document.getElementById('wizardEntradasFields').style.display = this.checked ? 'block' : 'none';
                calcularCostosWizard();
            });
            
            // Actualizar c√°lculos al cambiar grados
            document.getElementById('wizardGrados').addEventListener('change', async function() {
                await calcularEstudiantes();
                calcularCostosWizard();
            });
            
            // Actualizar c√°lculos al cambiar destino
            document.getElementById('wizardDestino').addEventListener('change', function() {
                calcularCostosWizard();
            });
            
            // Actualizar nodos al cambiar modalidad
            document.querySelectorAll('input[name="wizardModalidad"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    actualizarVisibilidadNodos();
                    calcularCostosWizard();
                });
            });
            
            // Actualizar c√°lculos al cambiar servicios
            ['wizardMenuRefrigerio', 'wizardCantidadRefrigerios', 'wizardValorEntrada'].forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    calcularCostosWizard();
                });
            });
        }
        
        // ==================== CARGAR SALIDAS ====================
        async function cargarSalidas() {
            try {
                showLoading('tablaSalidasBody');
                
                // Construir query con filtros
                let query = '/svc_pedagogical_trips?select=*,svc_pedagogical_trip_grades(grades(grade_id,grade_name)),destination:svc_transport_destinations(destination_name),request:svc_service_requests(request_id,request_status)';
                
                // Filtrar por creador si NO es admin
                if (!datosGlobales.esAdminSalidas && currentUser) {
                    query += `&created_by=eq.${currentUser.user_id}`;
                }
                
                // Aplicar filtros
                if (filtrosActivos.fechaInicio) {
                    query += `&trip_date=gte.${filtrosActivos.fechaInicio}`;
                }
                if (filtrosActivos.fechaFin) {
                    query += `&trip_date=lte.${filtrosActivos.fechaFin}`;
                }
                if (filtrosActivos.estado) {
                    query += `&trip_status=eq.${filtrosActivos.estado}`;
                }
                
                query += '&order=trip_date.desc';
                
                const salidas = await supabaseRequest(query);
                datosGlobales.salidas = salidas || [];
                
                // Filtrar por grados si es necesario (filtro client-side porque es relaci√≥n N:M)
                if (filtrosActivos.grados && filtrosActivos.grados.length > 0) {
                    datosGlobales.salidas = datosGlobales.salidas.filter(salida => {
                        const gradosSalida = salida.svc_pedagogical_trip_grades?.map(g => g.grades?.grade_id).filter(Boolean) || [];
                        return filtrosActivos.grados.some(g => gradosSalida.includes(g));
                    });
                }
                
                renderizarTablaSalidas();
                actualizarContador();
                
            } catch (error) {
                console.error('‚ùå Error cargando salidas:', error);
                showMessage('Error al cargar las salidas', 'danger');
                document.getElementById('tablaSalidasBody').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar datos</td></tr>';
            }
        }
        
        // ==================== RENDERIZAR TABLA ====================
        function renderizarTablaSalidas() {
            const tbody = document.getElementById('tablaSalidasBody');
            
            if (datosGlobales.salidas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No se encontraron salidas pedag√≥gicas</td></tr>';
                return;
            }
            
            const inicio = (currentPage - 1) * itemsPerPage;
            const fin = inicio + itemsPerPage;
            const salidasPagina = datosGlobales.salidas.slice(inicio, fin);
            
            tbody.innerHTML = salidasPagina.map(salida => {
                const grados = salida.svc_pedagogical_trip_grades?.map(g => g.grades?.grade_name).filter(Boolean).join(', ') || 'N/A';
                const destino = salida.destination?.destination_name || 'N/A';
                const estadoAprobacion = salida.request?.request_status || 'pending';
                const badgeEstado = getBadgeEstado(salida.trip_status);
                const badgeAprobacion = getBadgeEstadoSolicitud(estadoAprobacion);
                const acciones = getAccionesSalida(salida, estadoAprobacion);
                
                return `
                    <tr>
                        <td>${formatDate(salida.trip_date)}</td>
                        <td>${grados}</td>
                        <td>${destino}</td>
                        <td>${badgeEstado}</td>
                        <td class="text-center">${badgeAprobacion}</td>
                        <td class="text-center">${salida.actual_students || salida.planned_students}</td>
                        <td class="text-center">${salida.num_adults}</td>
                        <td class="text-end fw-bold">$${formatNumber(salida.total_transport_value + (salida.total_catering_value || 0) + (salida.total_entrance_value || 0))}</td>
                        <td class="text-center">${acciones}</td>
                    </tr>
                `;
            }).join('');
            
            renderizarPaginacion();
        }
        
        // ==================== BADGES DE ESTADO ====================
        function getBadgeEstado(status) {
            const estados = {
                'scheduled': { texto: 'Programaci√≥n', clase: 'bg-primary' },
                'imminent': { texto: 'Inminente', clase: 'bg-warning text-dark' },
                'in_progress': { texto: 'En proceso', clase: 'bg-success' },
                'completed': { texto: 'Realizada', clase: 'bg-secondary' },
                'suspended': { texto: 'Suspendida', clase: 'bg-danger' },
                'cancelled': { texto: 'Cancelada', clase: 'bg-dark' }
            };
            
            const estado = estados[status] || { texto: status, clase: 'bg-secondary' };
            return `<span class="badge ${estado.clase} badge-status">${estado.texto}</span>`;
        }
        
        // ==================== ACCIONES SEG√öN ESTADO ====================
        function getAccionesSalida(salida, estadoAprobacion) {
            const acciones = [];
            const estaAprobada = estadoAprobacion === 'approved';
            const esCreador = salida.created_by === currentUser?.user_id;
            const esAdmin = datosGlobales.esAdminSalidas;
            
            // Ver detalle (siempre disponible)
            acciones.push(`<button class="btn btn-sm btn-info" onclick="verDetalleSalida('${salida.trip_id}')" title="Ver detalle">
                <i class="bi bi-eye"></i>
            </button>`);
            
            if (salida.trip_status === 'scheduled' && esCreador && !esAdmin) {
                // Editar - SOLO creador y si NO est√° aprobada
                if (!estaAprobada) {
                    acciones.push(`<button class="btn btn-sm btn-warning" onclick="editarSalida('${salida.trip_id}')" title="Editar">
                        <i class="bi bi-pencil"></i>
                    </button>`);
                }
                
                // Eliminar - SOLO creador y si NO est√° aprobada
                if (!estaAprobada) {
                    acciones.push(`<button class="btn btn-sm btn-danger" onclick="eliminarSalida('${salida.trip_id}')" title="Eliminar">
                        <i class="bi bi-trash"></i>
                    </button>`);
                }
            }
            
            if (salida.trip_status === 'imminent') {
                // Banderazo - creador O admin
                if (esCreador || esAdmin) {
                    acciones.push(`<button class="btn btn-sm btn-success" onclick="mostrarModalBanderazo('${salida.trip_id}')" title="Banderazo (asistencia + salida)">
                        <i class="bi bi-flag-fill"></i>
                    </button>`);
                }
                // Suspender - SOLO creador (NO admin) y si NO est√° aprobada
                if (esCreador && !esAdmin && !estaAprobada) {
                    acciones.push(`<button class="btn btn-sm btn-danger" onclick="mostrarModalSuspender('${salida.trip_id}')" title="Suspender">
                        <i class="bi bi-x-circle"></i>
                    </button>`);
                }
            }
            
            if (salida.trip_status === 'in_progress') {
                // Descargar PDF de la salida
                acciones.push(`<button class="btn btn-sm btn-outline-dark" onclick="generarPDFSalida('${salida.trip_id}')" title="Descargar PDF">
                    <i class="bi bi-file-earmark-pdf"></i>
                </button>`);
                // Suspender - SOLO creador (NO admin) y si NO est√° aprobada
                if (esCreador && !esAdmin && !estaAprobada) {
                    acciones.push(`<button class="btn btn-sm btn-danger" onclick="mostrarModalSuspender('${salida.trip_id}')" title="Suspender">
                        <i class="bi bi-x-circle"></i>
                    </button>`);
                }
            }
            
            if (salida.trip_status === 'completed') {
                // Descargar PDF de la salida
                acciones.push(`<button class="btn btn-sm btn-outline-dark" onclick="generarPDFSalida('${salida.trip_id}')" title="Descargar PDF">
                    <i class="bi bi-file-earmark-pdf"></i>
                </button>`);
            }
            
            return `<div class="table-actions">${acciones.join('')}</div>`;
        }
        
        // ==================== PAGINACI√ìN ====================
        function renderizarPaginacion() {
            const totalPaginas = Math.ceil(datosGlobales.salidas.length / itemsPerPage);
            const paginacion = document.getElementById('paginacion');
            
            if (totalPaginas <= 1) {
                paginacion.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Anterior
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="cambiarPagina(${currentPage - 1}); return false;">Anterior</a>
            </li>`;
            
            // P√°ginas
            for (let i = 1; i <= totalPaginas; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="cambiarPagina(${i}); return false;">${i}</a>
                </li>`;
            }
            
            // Siguiente
            html += `<li class="page-item ${currentPage === totalPaginas ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="cambiarPagina(${currentPage + 1}); return false;">Siguiente</a>
            </li>`;
            
            paginacion.innerHTML = html;
        }
        
        function cambiarPagina(pagina) {
            const totalPaginas = Math.ceil(datosGlobales.salidas.length / itemsPerPage);
            if (pagina < 1 || pagina > totalPaginas) return;
            
            currentPage = pagina;
            renderizarTablaSalidas();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ==================== FILTROS ====================
        function aplicarFiltros() {
            filtrosActivos = {
                fechaInicio: document.getElementById('filtroFechaInicio').value,
                fechaFin: document.getElementById('filtroFechaFin').value,
                estado: document.getElementById('filtroEstado').value,
                grados: Array.from(document.getElementById('filtroGrado').selectedOptions).map(o => o.value)
            };
            
            currentPage = 1;
            cargarSalidas();
        }
        
        function limpiarFiltros() {
            document.getElementById('formFiltros').reset();
            if (fpFiltroInicio) fpFiltroInicio.clear();
            if (fpFiltroFin) fpFiltroFin.clear();
            filtrosActivos = {};
            currentPage = 1;
            cargarSalidas();
        }
        
        function actualizarContador() {
            document.getElementById('contadorResultados').innerHTML = 
                `<i class="bi bi-list-ul me-1"></i>${datosGlobales.salidas.length} salida${datosGlobales.salidas.length !== 1 ? 's' : ''} encontrada${datosGlobales.salidas.length !== 1 ? 's' : ''}`;
        }
        
        // ==================== WIZARD ====================
        function abrirWizardNuevaSalida() {
            // Resetear formulario
            document.getElementById('formWizardSalida').reset();
            
            // Limpiar Flatpickr del wizard
            if (fpWizardFecha) fpWizardFecha.clear();

            document.getElementById('formWizardSalida').removeAttribute('data-editing-trip-id');
            document.querySelector('#modalWizardSalida .modal-title').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nueva Salida Pedag√≥gica';
            document.getElementById('btnWizardGuardar').innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar y Solicitar Aprobaci√≥n';

            
            currentWizardStep = 1;
            
            // Resetear wizard UI
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            document.querySelectorAll('.wizard-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector('.wizard-step[data-step="1"]').classList.add('active');
            document.querySelector('.wizard-content[data-step="1"]').classList.add('active');
            
            actualizarBotonesWizard();
            actualizarProgressBar();
            
            // Ocultar campos opcionales
            document.getElementById('wizardRefrigeriosFields').style.display = 'none';
            document.getElementById('wizardEntradasFields').style.display = 'none';
            
            // Resetear nodos
            selectedNodosSalida = [];
            selectedNodosLlegada = [];
            renderNodos('departure');
            renderNodos('arrival');
            actualizarVisibilidadNodos();
            
            // Resetear selector de adultos
            selectedAdultosPedagogicas = [];
            document.getElementById('wizardAdultoSearch').value = '';
            renderBadgesAdultosPedagogicas();
            filtrarWorkersPedagogicas();
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalWizardSalida'));
            modal.show();
        }
        
        function wizardSiguiente() {
            // Validar step actual
            const stepActual = document.querySelector(`.wizard-content[data-step="${currentWizardStep}"]`);
            const camposRequeridos = stepActual.querySelectorAll('[required]');
            let valido = true;
            
            camposRequeridos.forEach(campo => {
                if (!campo.value || (campo.type === 'radio' && !document.querySelector(`input[name="${campo.name}"]:checked`))) {
                    campo.classList.add('is-invalid');
                    valido = false;
                } else {
                    campo.classList.remove('is-invalid');
                }
            });
            
            if (!valido) {
                showMessage('Por favor complete todos los campos requeridos', 'warning');
                return;
            }
            
            // VALIDACI√ìN ESPECIAL PARA PASO 1: Verificar que se seleccion√≥ una fecha
            if (currentWizardStep === 1) {
                const fechaValor = document.getElementById('wizardFecha').value;
                if (!fechaValor) {
                    showMessage('Por favor seleccione la fecha de la salida', 'warning');
                    return;
                }
            }
            
            // Marcar como completado
            document.querySelector(`.wizard-step[data-step="${currentWizardStep}"]`).classList.add('completed');
            
            // Avanzar
            currentWizardStep++;
            actualizarWizardUI();
        }
        
        function wizardAnterior() {
            if (currentWizardStep > 1) {
                currentWizardStep--;
                actualizarWizardUI();
            }
        }
        
        function actualizarWizardUI() {
            // Actualizar steps
            document.querySelectorAll('.wizard-step').forEach(step => {
                const stepNum = parseInt(step.getAttribute('data-step'));
                step.classList.remove('active');
                if (stepNum === currentWizardStep) {
                    step.classList.add('active');
                }
            });
            
            // Actualizar contenido
            document.querySelectorAll('.wizard-content').forEach(content => {
                const stepNum = parseInt(content.getAttribute('data-step'));
                content.classList.remove('active');
                if (stepNum === currentWizardStep) {
                    content.classList.add('active');
                }
            });
            
            // Si llegamos al √∫ltimo paso, cargar resumen y calcular costos
            if (currentWizardStep === 5) {
                calcularCostosWizard();
            }
            
            actualizarBotonesWizard();
            actualizarProgressBar();
        }
        
        function actualizarBotonesWizard() {
            const btnAnterior = document.getElementById('btnWizardAnterior');
            const btnSiguiente = document.getElementById('btnWizardSiguiente');
            const btnGuardar = document.getElementById('btnWizardGuardar');
            
            btnAnterior.style.display = currentWizardStep === 1 ? 'none' : 'inline-block';
            btnSiguiente.style.display = currentWizardStep === 5 ? 'none' : 'inline-block';
            btnGuardar.style.display = currentWizardStep === 5 ? 'inline-block' : 'none';
        }
        
        function actualizarProgressBar() {
            const progreso = (currentWizardStep / 5) * 100;
            document.getElementById('wizardProgressBar').style.width = progreso + '%';
        }
        
        // ==================== CALCULAR ESTUDIANTES ====================
        async function calcularEstudiantes() {
            const gradosSeleccionados = Array.from(document.getElementById('wizardGrados').selectedOptions).map(o => o.value);
            
            if (gradosSeleccionados.length === 0) {
                document.getElementById('wizardNumEstudiantes').value = 0;
                document.getElementById('wizardDesglosePorGrado').textContent = '';
                actualizarTotalParticipantes();
                return;
            }
            
            try {
                // Obtener cursos de los grados seleccionados
                const cursosQuery = `/courses?select=course_id,grade_id,grade:grades(grade_name)&grade_id=in.(${gradosSeleccionados.join(',')})&course_status=eq.active`;
                const cursos = await supabaseRequest(cursosQuery);
                
                if (!cursos || cursos.length === 0) {
                    document.getElementById('wizardNumEstudiantes').value = 0;
                    document.getElementById('wizardDesglosePorGrado').textContent = 'No hay cursos activos para los grados seleccionados';
                    actualizarTotalParticipantes();
                    return;
                }
                
                // Obtener estudiantes activos de esos cursos (asumiendo status_code 1 = activo)
                const cursosIds = cursos.map(c => c.course_id);
                const estudiantesQuery = `/students?select=student_id,course_id,status:student_status(status_code),course:courses(grade:grades(grade_name))&course_id=in.(${cursosIds.join(',')})`;
                const estudiantesBruto = await supabaseRequest(estudiantesQuery);
                
                // Filtrar solo los activos (status_code = 1)
                const estudiantes = estudiantesBruto.filter(e => e.status?.status_code === 1);
                
                // Contar por grado
                const conteosPorGrado = {};
                estudiantes.forEach(est => {
                    const gradoNombre = est.course.grade.grade_name;
                    conteosPorGrado[gradoNombre] = (conteosPorGrado[gradoNombre] || 0) + 1;
                });
                
                // Actualizar UI
                const total = estudiantes.length;
                document.getElementById('wizardNumEstudiantes').value = total;
                
                const desglose = Object.entries(conteosPorGrado)
                    .map(([grado, cantidad]) => `${grado}: ${cantidad}`)
                    .join(', ');
                document.getElementById('wizardDesglosePorGrado').textContent = 
                    total > 0 ? `Desglose: ${desglose}` : 'No hay estudiantes activos en los grados seleccionados';
                
                actualizarTotalParticipantes();
                
            } catch (error) {
                console.error('Error calculando estudiantes:', error);
                showMessage('Error al calcular estudiantes', 'danger');
            }
        }
        
        function actualizarTotalParticipantes() {
            const estudiantes = parseInt(document.getElementById('wizardNumEstudiantes').value) || 0;
            const adultos = selectedAdultosPedagogicas.length;
            const total = estudiantes + adultos;
            
            document.getElementById('wizardTotalParticipantes').textContent = total;
            
            // Auto-llenar cantidad de refrigerios con el total de participantes
            const cantidadRefrigeriosInput = document.getElementById('wizardCantidadRefrigerios');
            if (cantidadRefrigeriosInput && total > 0) {
                cantidadRefrigeriosInput.value = total;
            }
        }
        
        // ==================== CALCULAR COSTOS WIZARD ====================
        async function calcularCostosWizard() {
            try {
                const totalParticipantes = parseInt(document.getElementById('wizardTotalParticipantes').textContent) || 0;
                const destinoId = document.getElementById('wizardDestino').value;
                
                let costoTransporte = 0;
                let costoRefrigerios = 0;
                let costoEntradas = 0;
                
                // TRANSPORTE - Usar funci√≥n RPC del backend para optimizaci√≥n
                if (destinoId && totalParticipantes > 0) {
                    console.log('üöå Calculando transporte:', {
                        destinoId,
                        totalParticipantes
                    });
                    
                    try {
                        // Llamar a funci√≥n RPC que optimiza el c√°lculo
                        const resultado = await supabaseRequest('/rpc/calculate_transport_cost', {
                            method: 'POST',
                            body: JSON.stringify({
                                destination_id_param: destinoId,
                                total_participants: totalParticipantes
                            })
                        });
                        
                        console.log('üìä Resultado del c√°lculo:', resultado);
                        
                        if (resultado && !resultado.error) {
                            costoTransporte = parseFloat(resultado.total_cost);
                            
                            // Guardar detalle para mostrar en UI y para guardar luego
                            datosGlobales.detalleTransporte = {
                                costoTotal: resultado.total_cost,
                                numeroVehiculos: resultado.vehicle_count,
                                tarifaCongelada: resultado.frozen_rate,
                                capacidadCongelada: resultado.frozen_capacity,
                                vehiculos: resultado.breakdown || []
                            };
                            
                            console.log('‚úÖ Costo transporte calculado:', {
                                costo: costoTransporte,
                                vehiculos: resultado.vehicle_count
                            });
                        } else {
                            console.error('‚ùå Error en c√°lculo de transporte:', resultado.message);
                            showMessage(resultado.message || 'Error al calcular costo de transporte', 'warning');
                            datosGlobales.detalleTransporte = null;
                        }
                    } catch (error) {
                        console.error('‚ùå Error llamando a calculate_transport_cost:', error);
                        showMessage('Error al calcular costo de transporte', 'danger');
                        datosGlobales.detalleTransporte = null;
                    }
                } else {
                    console.log('‚ÑπÔ∏è Transporte no calculado:', {
                        destinoId: destinoId || 'NO SELECCIONADO',
                        totalParticipantes
                    });
                    datosGlobales.detalleTransporte = null;
                }
                
                // REFRIGERIOS
                if (document.getElementById('wizardIncluirRefrigerios').checked) {
                    const menuSelect = document.getElementById('wizardMenuRefrigerio');
                    const cantidad = parseInt(document.getElementById('wizardCantidadRefrigerios').value) || 0;
                    
                    if (menuSelect.value && cantidad > 0) {
                        const precioUnitario = parseFloat(menuSelect.selectedOptions[0].getAttribute('data-price'));
                        costoRefrigerios = precioUnitario * cantidad;
                    }
                }
                
                // ENTRADAS
                if (document.getElementById('wizardIncluirEntradas').checked) {
                    const valorEntrada = parseFloat(document.getElementById('wizardValorEntrada').value) || 0;
                    if (valorEntrada > 0 && totalParticipantes > 0) {
                        costoEntradas = valorEntrada * totalParticipantes;
                    }
                }
                
                const costoTotal = costoTransporte + costoRefrigerios + costoEntradas;
                
                // Actualizar UI
                document.getElementById('wizardCostoTransporte').textContent = '$' + formatNumber(costoTransporte);
                
                // Mostrar detalle de veh√≠culos si hay informaci√≥n
                const detalleContainer = document.getElementById('detalleVehiculosContainer');
                if (datosGlobales.detalleTransporte && datosGlobales.detalleTransporte.vehiculos && datosGlobales.detalleTransporte.vehiculos.length > 0) {
                    const detalle = datosGlobales.detalleTransporte;
                    let detalleHTML = `<div style="margin-top: 5px; padding: 5px; background: #f8f9fa; border-radius: 4px;">`;
                    detalleHTML += `<i class="bi bi-bus-front me-1"></i><strong>${detalle.numeroVehiculos} veh√≠culo${detalle.numeroVehiculos > 1 ? 's' : ''} requerido${detalle.numeroVehiculos > 1 ? 's' : ''}:</strong><br>`;
                    detalle.vehiculos.forEach((v) => {
                        detalleHTML += `<span style="display: block; margin-left: 15px; font-size: 0.9em;">‚Ä¢ Veh√≠culo ${v.vehicle_number}: ${v.passengers} pasajeros (cap. ${v.capacity_range}) = $${formatNumber(v.rate_value)}</span>`;
                    });
                    detalleHTML += `</div>`;
                    detalleContainer.innerHTML = detalleHTML;
                    detalleContainer.style.display = 'block';
                } else {
                    detalleContainer.style.display = 'none';
                }
                
                document.getElementById('wizardCostoRefrigerios').textContent = '$' + formatNumber(costoRefrigerios);
                document.getElementById('wizardCostoEntradas').textContent = '$' + formatNumber(costoEntradas);
                document.getElementById('wizardCostoTotal').textContent = '$' + formatNumber(costoTotal);
                
            } catch (error) {
                console.error('Error calculando costos:', error);
            }
        }
        
        // ==================== NOTIFICACIONES ====================
        
        /**
         * Env√≠a notificaci√≥n por email al aprobador de una salida pedag√≥gica
         */
        async function enviarNotificacionAprobador(tripId, requestId, aprobadorId, datosSalida) {
            try {
                console.log('üìß Enviando notificaci√≥n al aprobador...');
                
                // Obtener datos del aprobador
                const aprobador = datosGlobales.aprobadores.find(a => a.worker_id === aprobadorId);
                if (!aprobador || !aprobador.email) {
                    console.warn('‚ö†Ô∏è No se encontr√≥ email del aprobador');
                    return false;
                }
                
                // Obtener datos del solicitante
                const solicitante = `${currentUser.user_display_name || currentUser.user_name}`;
                
                // Obtener nombre del destino
                const destino = datosGlobales.destinos.find(d => d.destination_id === datosSalida.p_destino_id);
                const nombreDestino = destino ? destino.destination_name : 'Destino no especificado';
                
                // Obtener nombres de grados
                const nombresGrados = datosSalida.p_grados.map(gId => {
                    const grado = datosGlobales.grados.find(g => g.grade_id === gId);
                    return grado ? grado.grade_name : gId;
                }).join(', ');
                
                // Formatear fecha
                const fechaFormateada = new Date(datosSalida.p_fecha + 'T00:00:00').toLocaleDateString('es-CO', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Construir HTML del email
                const asunto = `Nueva Solicitud: Salida Pedag√≥gica - ${datosSalida.p_descripcion || nombreDestino}`;
                
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;">
                        <div style="background-color: #1b365d; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                            <h1 style="margin: 0; font-size: 24px;">Nueva Solicitud de Salida Pedag√≥gica</h1>
                        </div>
                        
                        <div style="background-color: white; padding: 30px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <p style="font-size: 16px; color: #333; margin-bottom: 20px;">
                                Estimado/a <strong>${aprobador.worker_first_name} ${aprobador.worker_last_name_1}</strong>,
                            </p>
                            
                            <p style="font-size: 14px; color: #666; margin-bottom: 25px;">
                                Se ha creado una nueva solicitud de salida pedag√≥gica que requiere su aprobaci√≥n:
                            </p>
                            
                            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 25px;">
                                <h3 style="color: #1b365d; margin-top: 0; margin-bottom: 15px; font-size: 18px;">Detalles de la Salida</h3>
                                
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Destino:</td>
                                        <td style="padding: 8px 0; color: #333;">${nombreDestino}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Fecha:</td>
                                        <td style="padding: 8px 0; color: #333;">${fechaFormateada}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Horario:</td>
                                        <td style="padding: 8px 0; color: #333;">${datosSalida.p_hora_salida} - ${datosSalida.p_hora_regreso}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Grados:</td>
                                        <td style="padding: 8px 0; color: #333;">${nombresGrados}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Estudiantes:</td>
                                        <td style="padding: 8px 0; color: #333;">${datosSalida.p_num_estudiantes} estudiantes</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Adultos:</td>
                                        <td style="padding: 8px 0; color: #333;">${(datosSalida.p_adultos_ids || []).length} adultos acompa√±antes</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Solicitado por:</td>
                                        <td style="padding: 8px 0; color: #333;">${solicitante}</td>
                                    </tr>
                                </table>
                                
                                ${datosSalida.p_descripcion ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                                    <p style="color: #666; font-weight: bold; margin-bottom: 5px;">Descripci√≥n:</p>
                                    <p style="color: #333; margin: 0;">${datosSalida.p_descripcion}</p>
                                </div>
                                ` : ''}
                                
                                ${datosSalida.p_unidad_indagacion ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                                    <p style="color: #666; font-weight: bold; margin-bottom: 5px;">Unidad de Indagaci√≥n:</p>
                                    <p style="color: #333; margin: 0;">${datosSalida.p_unidad_indagacion}</p>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div style="text-align: center; margin-top: 30px; padding: 20px; background-color: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                                <p style="margin: 0; color: #856404; font-size: 14px;">
                                    <strong>Para revisar y aprobar esta solicitud:</strong><br>
                                    Ingrese a <strong>SchoolNet</strong> y vaya al m√≥dulo de <strong>Salidas Pedag√≥gicas</strong>
                                </p>
                            </div>
                            
                            <p style="font-size: 12px; color: #999; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center;">
                                Este es un mensaje autom√°tico del sistema SchoolNet.<br>
                                Por favor, no responder a este correo.
                            </p>
                        </div>
                    </div>
                `;
                
                // Enviar notificaci√≥n usando la funci√≥n global de config.js
                const resultado = await sendNotification(aprobador.email, asunto, htmlContent, true);
                
                if (resultado) {
                    console.log('‚úÖ Notificaci√≥n enviada al aprobador:', aprobador.email);
                } else {
                    console.warn('‚ö†Ô∏è No se pudo enviar la notificaci√≥n al aprobador');
                }
                
                return resultado;
                
            } catch (error) {
                console.error('‚ùå Error enviando notificaci√≥n:', error);
                return false;
            }
        }

        /**
         * Env√≠a notificaci√≥n a la(s) secretar√≠a(s) correspondiente(s) seg√∫n los grados de la salida
         */
        async function enviarNotificacionSecretarias(datosSalida) {
            try {
                console.log('üìß Evaluando notificaci√≥n a secretar√≠as...');
        
                // Secciones que corresponden a cada secretar√≠a
                const seccionesBachillerato = ['Escuela media', 'Escuela alta'];
                const seccionesPreescolarPrimaria = ['Preescolar', 'Primaria'];
        
                // Determinar secciones involucradas seg√∫n los grados seleccionados
                const seccionesInvolucradas = new Set();
                datosSalida.p_grados.forEach(gradeId => {
                    const grado = datosGlobales.grados.find(g => g.grade_id === gradeId);
                    if (grado && grado.sections) {
                        seccionesInvolucradas.add(grado.sections.section_name);
                    }
                });
        
                console.log('üìã Secciones involucradas:', [...seccionesInvolucradas]);
        
                // Determinar a qui√©n notificar
                const notificarBachillerato = [...seccionesInvolucradas].some(s => seccionesBachillerato.includes(s));
                const notificarPreescolarPrimaria = [...seccionesInvolucradas].some(s => seccionesPreescolarPrimaria.includes(s));
        
                // Obtener nombre del destino y grados para el email
                const destino = datosGlobales.destinos.find(d => d.destination_id === datosSalida.p_destino_id);
                const nombreDestino = destino ? destino.destination_name : 'Destino no especificado';
                const nombresGrados = datosSalida.p_grados.map(gId => {
                    const grado = datosGlobales.grados.find(g => g.grade_id === gId);
                    return grado ? grado.grade_name : gId;
                }).join(', ');
        
                const fechaFormateada = new Date(datosSalida.p_fecha + 'T00:00:00').toLocaleDateString('es-CO', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
        
                const solicitante = currentUser.user_display_name || currentUser.user_name;
        
                // Template del email
                const buildHTML = (secretaria) => `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;">
                        <div style="background-color: #1b365d; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                            <h1 style="margin: 0; font-size: 22px;">Notificaci√≥n de Salida Pedag√≥gica</h1>
                        </div>
                        <div style="background-color: white; padding: 30px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <p style="font-size: 16px; color: #333;">
                                Estimada <strong>${secretaria}</strong>,
                            </p>
                            <p style="font-size: 14px; color: #666;">
                                Se ha registrado una nueva salida pedag√≥gica que involucra grados de su secci√≥n:
                            </p>
                            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 6px; margin: 20px 0;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Destino:</td>
                                        <td style="padding: 8px 0; color: #333;">${nombreDestino}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Fecha:</td>
                                        <td style="padding: 8px 0; color: #333;">${fechaFormateada}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Horario:</td>
                                        <td style="padding: 8px 0; color: #333;">${datosSalida.p_hora_salida} - ${datosSalida.p_hora_regreso}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Grados:</td>
                                        <td style="padding: 8px 0; color: #333;">${nombresGrados}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Estudiantes:</td>
                                        <td style="padding: 8px 0; color: #333;">${datosSalida.p_num_estudiantes}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Solicitado por:</td>
                                        <td style="padding: 8px 0; color: #333;">${solicitante}</td>
                                    </tr>
                                </table>
                            </div>
                            <p style="font-size: 12px; color: #999; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center;">
                                Este es un mensaje autom√°tico del sistema SchoolNet.<br>
                                Por favor, no responder a este correo.
                            </p>
                        </div>
                    </div>
                `;
        
                const asunto = `Salida Pedag√≥gica programada ‚Äî ${datosSalida.p_descripcion || nombreDestino} ‚Äî ${fechaFormateada}`;
        
                // Enviar notificaciones
                if (notificarPreescolarPrimaria && datosGlobales.emailSecretariaPreescolarPrimaria) {
                    await sendNotification(
                        datosGlobales.emailSecretariaPreescolarPrimaria,
                        asunto,
                        buildHTML('Secretar√≠a de Preescolar y Primaria'),
                        true
                    );
                    console.log('‚úÖ Notificaci√≥n enviada a Secretar√≠a Preescolar y Primaria');
                }
        
                if (notificarBachillerato && datosGlobales.emailSecretariaBachillerato) {
                    await sendNotification(
                        datosGlobales.emailSecretariaBachillerato,
                        asunto,
                        buildHTML('Secretar√≠a de Bachillerato'),
                        true
                    );
                    console.log('‚úÖ Notificaci√≥n enviada a Secretar√≠a Bachillerato');
                }
        
                if (!notificarBachillerato && !notificarPreescolarPrimaria) {
                    console.warn('‚ö†Ô∏è No se determin√≥ secretar√≠a para los grados seleccionados');
                }
        
            } catch (error) {
                console.error('‚ùå Error enviando notificaci√≥n a secretar√≠as:', error);
            }
        }

        /**
         * Env√≠a notificaci√≥n a destinatarios fijos (chef, supervisora) para toda salida pedag√≥gica
         */
        async function enviarNotificacionFijos(datosSalida) {
            try {
                console.log('üìß Enviando notificaciones a destinatarios fijos...');
        
                const destino = datosGlobales.destinos.find(d => d.destination_id === datosSalida.p_destino_id);
                const nombreDestino = destino ? destino.destination_name : 'Destino no especificado';
                const nombresGrados = datosSalida.p_grados.map(gId => {
                    const grado = datosGlobales.grados.find(g => g.grade_id === gId);
                    return grado ? grado.grade_name : gId;
                }).join(', ');
                const fechaFormateada = new Date(datosSalida.p_fecha + 'T00:00:00').toLocaleDateString('es-CO', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                const solicitante = currentUser.user_display_name || currentUser.user_name;
        
                const asunto = `Salida Pedag√≥gica programada ‚Äî ${datosSalida.p_descripcion || nombreDestino} ‚Äî ${fechaFormateada}`;
                
                const buildHTML = (destinatario) => `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;">
                        <div style="background-color: #1b365d; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                            <h1 style="margin: 0; font-size: 22px;">Notificaci√≥n de Salida Pedag√≥gica</h1>
                        </div>
                        <div style="background-color: white; padding: 30px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <p style="font-size: 16px; color: #333;">
                                Estimada <strong>${destinatario}</strong>,
                            </p>
                            <p style="font-size: 14px; color: #666;">
                                Se ha registrado una nueva salida pedag√≥gica:
                            </p>
                            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 6px; margin: 20px 0;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Destino:</td><td style="padding: 8px 0; color: #333;">${nombreDestino}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Fecha:</td><td style="padding: 8px 0; color: #333;">${fechaFormateada}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Horario:</td><td style="padding: 8px 0; color: #333;">${datosSalida.p_hora_salida} - ${datosSalida.p_hora_regreso}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Grados:</td><td style="padding: 8px 0; color: #333;">${nombresGrados}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Estudiantes:</td><td style="padding: 8px 0; color: #333;">${datosSalida.p_num_estudiantes}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Adultos:</td><td style="padding: 8px 0; color: #333;">${(datosSalida.p_adultos_ids || []).length}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Solicitado por:</td><td style="padding: 8px 0; color: #333;">${solicitante}</td></tr>
                                </table>
                            </div>
                            <p style="font-size: 12px; color: #999; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center;">
                                Este es un mensaje autom√°tico del sistema SchoolNet.<br>
                                Por favor, no responder a este correo.
                            </p>
                        </div>
                    </div>
                `;
        
                const destinatarios = [
                    { email: datosGlobales.emailChef, label: 'Chef' },
                    { email: datosGlobales.emailSupervisor, label: 'Supervisora' }
                ];
        
                for (const dest of destinatarios) {
                    if (dest.email) {
                        await sendNotification(dest.email, asunto, buildHTML(dest.label), true);
                        console.log(`‚úÖ Notificaci√≥n enviada a ${dest.label}: ${dest.email}`);
                    } else {
                        console.warn(`‚ö†Ô∏è No hay email configurado para ${dest.label}`);
                    }
                }
        
            } catch (error) {
                console.error('‚ùå Error enviando notificaciones fijas:', error);
            }
        }
        
        // ==================== GUARDAR NUEVA SALIDA ====================
        async function guardarNuevaSalida() {
            try {
                showLoading('btnWizardGuardar');
                
                // Detectar si estamos editando o creando
                const formulario = document.getElementById('formWizardSalida');
                const tripIdEdicion = formulario.getAttribute('data-editing-trip-id');
                const esEdicion = !!tripIdEdicion;
                
                console.log(esEdicion ? 'üìù Modo: EDICI√ìN' : '‚ú® Modo: CREAR NUEVA');
                
                // Validar campos requeridos
                const gradosSeleccionados = Array.from(document.getElementById('wizardGrados').selectedOptions).map(o => o.value);
                const destinoId = document.getElementById('wizardDestino').value;
                const fecha = document.getElementById('wizardFecha').value;
                const horaSalida = document.getElementById('wizardHoraSalida').value;
                const horaRegreso = document.getElementById('wizardHoraRegreso').value;
                const modalidadElement = document.querySelector('input[name="wizardModalidad"]:checked');
                const aprobadorId = document.getElementById('wizardAprobador').value;
                
                if (gradosSeleccionados.length === 0 || !destinoId || !fecha || !horaSalida || !horaRegreso || !modalidadElement || !aprobadorId) {
                    showMessage('Por favor complete todos los campos requeridos', 'warning');
                    return;
                }
                
                // Obtener datos de refrigerios
                const incluirRefrigerios = document.getElementById('wizardIncluirRefrigerios').checked;
                let menuId = null;
                let cantidadRefrigerios = null;
                let precioUnitarioRefrigerio = null;
                let costoRefrigerios = 0;
                
                if (incluirRefrigerios) {
                    const menuSelect = document.getElementById('wizardMenuRefrigerio');
                    menuId = menuSelect.value;
                    cantidadRefrigerios = parseInt(document.getElementById('wizardCantidadRefrigerios').value) || 0;
                    precioUnitarioRefrigerio = menuSelect.selectedOptions[0] ? parseFloat(menuSelect.selectedOptions[0].getAttribute('data-price')) : 0;
                    costoRefrigerios = precioUnitarioRefrigerio * cantidadRefrigerios;
                }
                
                // Obtener datos de entradas
                const incluirEntradas = document.getElementById('wizardIncluirEntradas').checked;
                let valorEntrada = null;
                let costoEntradas = 0;
                
                if (incluirEntradas) {
                    valorEntrada = parseFloat(document.getElementById('wizardValorEntrada').value) || 0;
                    const totalParticipantes = parseInt(document.getElementById('wizardTotalParticipantes').textContent) || 0;
                    costoEntradas = valorEntrada * totalParticipantes;
                }
                
                // Obtener datos de transporte del c√°lculo previo
                const detalleTransporte = datosGlobales.detalleTransporte || {};
                const costoTransporte = detalleTransporte.costoTotal || 0;
                const tarifaCongelada = detalleTransporte.tarifaCongelada || 0;
                const capacidadCongelada = detalleTransporte.capacidadCongelada || 0;
                const numVehiculos = detalleTransporte.numeroVehiculos || 0;
                
                // Preparar datos para enviar
                const adultosIds = [...selectedAdultosPedagogicas];
                const nodosSalidaIds = selectedNodosSalida.map(n => n.node_id);
                const nodosLlegadaIds = selectedNodosLlegada.map(n => n.node_id);
                
                let resultado;
                
                if (esEdicion) {
                    // MODO EDICI√ìN: params del update RPC
                    const datosUpdate = {
                        p_trip_id: tripIdEdicion,
                        p_titulo: document.getElementById('wizardTitulo').value || '',
                        p_grade_ids: gradosSeleccionados,
                        p_trip_date: fecha,
                        p_departure_time: horaSalida,
                        p_return_time: horaRegreso,
                        p_destination_id: destinoId,
                        p_trip_description: document.getElementById('wizardDescripcion').value || '',
                        p_inquiry_unit: document.getElementById('wizardUnidadIndagacion').value || '',
                        p_observations: document.getElementById('wizardObservaciones').value || '',
                        p_adultos_ids: adultosIds,
                        p_planned_students: parseInt(document.getElementById('wizardNumEstudiantes').value) || 0,
                        p_modalidad: modalidadElement.value,
                        p_include_catering: incluirRefrigerios,
                        p_catering_menu_id: menuId,
                        p_catering_quantity: cantidadRefrigerios,
                        p_frozen_catering_unit_price: precioUnitarioRefrigerio,
                        p_total_catering_value: costoRefrigerios,
                        p_include_entrance: incluirEntradas,
                        p_entrance_unit_value: valorEntrada,
                        p_total_entrance_value: costoEntradas,
                        p_total_transport_value: costoTransporte,
                        p_frozen_vehicle_capacity: capacidadCongelada,
                        p_frozen_transport_rate: tarifaCongelada,
                        p_frozen_vehicle_count: numVehiculos,
                        p_approver_id: aprobadorId,
                        p_nodos_salida: nodosSalidaIds.length > 0 ? nodosSalidaIds : null,
                        p_nodos_llegada: nodosLlegadaIds.length > 0 ? nodosLlegadaIds : null
                    };
                    
                    console.log('üì§ Actualizando salida:', datosUpdate);
                    resultado = await supabaseRequest('/rpc/update_pedagogical_trip', {
                        method: 'POST',
                        body: JSON.stringify(datosUpdate)
                    });
                    
                    console.log('üì• Respuesta del backend:', resultado);
                    
                    if (resultado && resultado.success) {
                        showMessage('‚úÖ ' + resultado.message, 'success');
                    } else {
                        throw new Error(resultado?.error || 'No se recibi√≥ respuesta del servidor');
                    }
                    
                } else {
                    // MODO CREAR: params del create RPC
                    const datosCreate = {
                        p_fecha: fecha,
                        p_hora_salida: horaSalida,
                        p_hora_regreso: horaRegreso,
                        p_destino_id: destinoId,
                        p_titulo: document.getElementById('wizardTitulo').value || '',
                        p_descripcion: document.getElementById('wizardDescripcion').value || '',
                        p_unidad_indagacion: document.getElementById('wizardUnidadIndagacion').value || '',
                        p_observaciones: document.getElementById('wizardObservaciones').value || '',
                        p_grados: gradosSeleccionados,
                        p_num_estudiantes: parseInt(document.getElementById('wizardNumEstudiantes').value) || 0,
                        p_adultos_ids: adultosIds,
                        p_modalidad: modalidadElement.value,
                        p_costo_transporte: costoTransporte,
                        p_tarifa_congelada: tarifaCongelada,
                        p_capacidad_congelada: capacidadCongelada,
                        p_num_vehiculos: numVehiculos,
                        p_incluir_refrigerios: incluirRefrigerios,
                        p_incluir_entradas: incluirEntradas,
                        p_aprobador_id: aprobadorId,
                        p_user_id: currentUser.user_id,
                        p_menu_id: menuId,
                        p_cantidad_refrigerios: cantidadRefrigerios,
                        p_precio_unitario_refrigerio: precioUnitarioRefrigerio,
                        p_costo_refrigerios: costoRefrigerios,
                        p_valor_entrada: valorEntrada,
                        p_costo_entradas: costoEntradas,
                        p_comentarios: document.getElementById('wizardComentarios').value || null,
                        p_nodos_salida: nodosSalidaIds.length > 0 ? nodosSalidaIds : null,
                        p_nodos_llegada: nodosLlegadaIds.length > 0 ? nodosLlegadaIds : null
                    };
                    
                    // MODO CREAR: Nueva salida
                    console.log('üì§ Creando nueva salida:', datosCreate);
                    resultado = await supabaseRequest('/rpc/create_pedagogical_trip', {
                        method: 'POST',
                        body: JSON.stringify(datosCreate)
                    });
                    
                    console.log('üì• Respuesta del backend:', resultado);
                    
                    if (resultado && resultado.success) {
                        showMessage('‚úÖ ' + resultado.message, 'success');
                        
                        // Enviar notificaci√≥n al aprobador solo en creaci√≥n
                        await enviarNotificacionAprobador(resultado.trip_id, resultado.request_id, aprobadorId, datosCreate);
                        // Enviar notificaci√≥n a secretar√≠a(s) seg√∫n secciones de los grados
                        await enviarNotificacionSecretarias(datosCreate);
                        // Enviar notificaci√≥n a chef y supervisora
                        await enviarNotificacionFijos(datosCreate);
                    } else {
                        throw new Error(resultado?.error || 'No se recibi√≥ respuesta del servidor');
                    }
                }
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalWizardSalida'));
                if (modal) modal.hide();
                
                // Limpiar formulario
                formulario.reset();
                formulario.removeAttribute('data-editing-trip-id');
                
                // Recargar tabla
                await cargarSalidas();
                
            } catch (error) {
                console.error('‚ùå Error guardando salida:', error);
                showMessage('Error al guardar la salida: ' + error.message, 'danger');
            } finally {
                hideLoading('btnWizardGuardar');
            }
        }
       
        
        // ==================== BANDERAZO INTEGRADO ====================

        /**
         * Abre el modal de banderazo con la lista de estudiantes pre-cargada
         */
        async function mostrarModalBanderazo(tripId) {
            try {
                document.getElementById('banderazoTripId').value = tripId;
                
                // Obtener datos de la salida
                const salida = await supabaseRequest(
                    `/svc_pedagogical_trips?select=trip_date,departure_time,return_time,` +
                    `destination:svc_transport_destinations(destination_name),` +
                    `svc_pedagogical_trip_grades(grades(grade_name))` +
                    `&trip_id=eq.${tripId}`
                );
                
                if (!salida || salida.length === 0) {
                    showMessage('No se encontr√≥ la salida', 'danger');
                    return;
                }
                
                const datos = salida[0];
                const grados = datos.svc_pedagogical_trip_grades?.map(g => g.grades?.grade_name).filter(Boolean).join(', ') || '';
                
                // Actualizar header del modal
                document.getElementById('banderazoDestino').textContent = datos.destination?.destination_name || 'Salida Pedag√≥gica';
                document.getElementById('banderazoInfo').textContent = 
                    `${formatDate(datos.trip_date)} ‚Ä¢ ${datos.departure_time} - ${datos.return_time} ‚Ä¢ ${grados}`;
                
                // Cargar estudiantes de la tabla de asistencia (pre-cargados por transition_trip_statuses)
                const estudiantes = await supabaseRequest(
                    `/svc_pedagogical_trip_attendance?select=student_id,is_attending,` +
                    `students(student_first_name,student_last_name_1,student_last_name_2,` +
                    `course:courses(course_name,grade:grades(grade_name)))` +
                    `&trip_id=eq.${tripId}&students.order=student_last_name_1`
                );
                
                if (!estudiantes || estudiantes.length === 0) {
                    showMessage('No hay estudiantes pre-cargados para esta salida. Verifique que la transici√≥n a estado Inminente se haya ejecutado correctamente.', 'warning');
                    return;
                }
                
                // Renderizar lista
                renderizarBanderazoEstudiantes(estudiantes);
                actualizarContadorBanderazo();
                
                // Configurar b√∫squeda
                document.getElementById('banderazoBuscar').value = '';
                document.getElementById('banderazoBuscar').oninput = function() {
                    filtrarBanderazoEstudiantes(this.value);
                };
                
                // Abrir modal
                const modal = new bootstrap.Modal(document.getElementById('modalBanderazo'));
                modal.show();
                
            } catch (error) {
                console.error('‚ùå Error abriendo banderazo:', error);
                showMessage('Error al cargar datos del banderazo: ' + error.message, 'danger');
            }
        }
        
        /**
         * Renderiza la lista de estudiantes agrupados por curso
         */
        function renderizarBanderazoEstudiantes(estudiantes) {
            const container = document.getElementById('banderazoListaEstudiantes');
            
            // Agrupar por curso
            const porCurso = {};
            estudiantes.forEach(est => {
                const cursoNombre = est.students?.course?.course_name || 'Sin curso';
                const gradoNombre = est.students?.course?.grade?.grade_name || '';
                const key = gradoNombre ? `${gradoNombre} - ${cursoNombre}` : cursoNombre;
                
                if (!porCurso[key]) porCurso[key] = [];
                porCurso[key].push(est);
            });
            
            // Ordenar estudiantes dentro de cada curso por apellido
            Object.values(porCurso).forEach(lista => {
                lista.sort((a, b) => {
                    const apellidoA = a.students?.student_last_name_1 || '';
                    const apellidoB = b.students?.student_last_name_1 || '';
                    return apellidoA.localeCompare(apellidoB);
                });
            });
            
            let html = '';
            Object.keys(porCurso).sort().forEach(curso => {
                const estudiantesCurso = porCurso[curso];
                const countCurso = estudiantesCurso.length;
                
                html += `<div class="banderazo-course-group">`;
                html += `<div class="banderazo-course-header">
                    <i class="bi bi-mortarboard me-1"></i>${curso} 
                    <span class="badge bg-primary ms-1">${countCurso}</span>
                </div>`;
                
                estudiantesCurso.forEach(est => {
                    const nombre = `${est.students?.student_last_name_1 || ''}${est.students?.student_last_name_2 ? ' ' + est.students.student_last_name_2 : ''}, ${est.students?.student_first_name || ''}`;
                    const checked = est.is_attending ? 'checked' : '';
                    const absentClass = est.is_attending ? '' : 'absent';
                    
                    html += `
                        <div class="banderazo-student ${absentClass}" data-student-id="${est.student_id}">
                            <div class="form-check">
                                <input class="form-check-input banderazo-check" type="checkbox" 
                                       id="band_${est.student_id}" value="${est.student_id}"
                                       ${checked}
                                       onchange="toggleBanderazoEstudiante(this)">
                                <label class="form-check-label" for="band_${est.student_id}">
                                    ${nombre}
                                </label>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }
        
        /**
         * Toggle visual al marcar/desmarcar un estudiante
         */
        function toggleBanderazoEstudiante(checkbox) {
            const studentDiv = checkbox.closest('.banderazo-student');
            if (checkbox.checked) {
                studentDiv.classList.remove('absent');
            } else {
                studentDiv.classList.add('absent');
            }
            actualizarContadorBanderazo();
        }
        
        /**
         * Marcar o desmarcar todos los estudiantes
         */
        function banderazoMarcarTodos(marcar) {
            const checkboxes = document.querySelectorAll('.banderazo-check');
            checkboxes.forEach(cb => {
                const studentDiv = cb.closest('.banderazo-student');
                if (studentDiv.style.display !== 'none') {
                    cb.checked = marcar;
                    if (marcar) {
                        studentDiv.classList.remove('absent');
                    } else {
                        studentDiv.classList.add('absent');
                    }
                }
            });
            actualizarContadorBanderazo();
        }
        
        /**
         * Actualiza el contador de asistentes / total
         */
        function actualizarContadorBanderazo() {
            const total = document.querySelectorAll('.banderazo-check').length;
            const asistentes = document.querySelectorAll('.banderazo-check:checked').length;
            
            const contador = document.getElementById('banderazoContador');
            contador.textContent = `${asistentes} / ${total}`;
            
            if (asistentes === total) {
                contador.className = 'badge bg-success fs-6';
            } else if (asistentes === 0) {
                contador.className = 'badge bg-danger fs-6';
            } else {
                contador.className = 'badge bg-warning text-dark fs-6';
            }
        }
        
        /**
         * Filtrar estudiantes por nombre en el banderazo
         */
        function filtrarBanderazoEstudiantes(texto) {
            const busqueda = texto.toLowerCase().trim();
            const items = document.querySelectorAll('.banderazo-student');
            const groups = document.querySelectorAll('.banderazo-course-group');
            
            items.forEach(item => {
                const label = item.querySelector('.form-check-label').textContent.toLowerCase();
                item.style.display = label.includes(busqueda) ? '' : 'none';
            });
            
            groups.forEach(group => {
                const visibles = group.querySelectorAll('.banderazo-student:not([style*="display: none"])');
                const header = group.querySelector('.banderazo-course-header');
                if (header) {
                    header.style.display = visibles.length > 0 ? '' : 'none';
                }
            });
        }
        
        /**
         * Confirmar banderazo: registrar asistencia y cambiar estado
         */
        async function confirmarBanderazo() {
            const tripId = document.getElementById('banderazoTripId').value;
            
            const todosCheckboxes = document.querySelectorAll('.banderazo-check');
            const ausentes = [];
            
            todosCheckboxes.forEach(cb => {
                if (!cb.checked) {
                    ausentes.push(parseInt(cb.value));
                }
            });
            
            const totalEstudiantes = todosCheckboxes.length;
            const asistentes = totalEstudiantes - ausentes.length;
            
            if (ausentes.length > 0) {
                const confirmar = confirm(
                    `Se registrar√°n ${asistentes} estudiantes asistentes y ${ausentes.length} ausente${ausentes.length > 1 ? 's' : ''}.\n\n` +
                    `¬øConfirmar banderazo de salida?`
                );
                if (!confirmar) return;
            } else {
                const confirmar = confirm(
                    `Todos los ${totalEstudiantes} estudiantes est√°n presentes.\n\n` +
                    `¬øConfirmar banderazo de salida?`
                );
                if (!confirmar) return;
            }
            
            try {
                const btnConfirmar = document.getElementById('btnConfirmarBanderazo');
                btnConfirmar.disabled = true;
                btnConfirmar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
                
                const resultado = await supabaseRequest('/rpc/execute_trip_banderazo', {
                    method: 'POST',
                    body: JSON.stringify({
                        p_trip_id: tripId,
                        p_absent_student_ids: ausentes
                    })
                });
                
                if (resultado && resultado.success) {
                    const data = resultado.data;
                    showMessage(
                        `‚úÖ ¬°Banderazo registrado! ${data.actual_students} asistentes, ${data.absent_students} ausentes.`,
                        'success'
                    );
                    
                    bootstrap.Modal.getInstance(document.getElementById('modalBanderazo')).hide();
                    await cargarSalidas();
                } else {
                    throw new Error(resultado?.error || 'Error desconocido');
                }
                
            } catch (error) {
                console.error('‚ùå Error en banderazo:', error);
                showMessage('Error al registrar banderazo: ' + error.message, 'danger');
            } finally {
                const btnConfirmar = document.getElementById('btnConfirmarBanderazo');
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = '<i class="bi bi-flag-fill me-2"></i>Confirmar Banderazo';
            }
        }
        
        // ==================== SUSPENDER ====================
        function mostrarModalSuspender(tripId) {
            document.getElementById('suspenderTripId').value = tripId;
            document.getElementById('formSuspender').reset();
            const modal = new bootstrap.Modal(document.getElementById('modalSuspender'));
            modal.show();
        }
        
        async function confirmarSuspension() {
            const tripId = document.getElementById('suspenderTripId').value;
            const razonSelect = document.getElementById('suspenderRazonSelect').value;
            const razonDetalle = document.getElementById('suspenderRazonDetalle').value;
            
            if (!razonDetalle) {
                showMessage('Debe especificar los detalles de la suspensi√≥n', 'warning');
                return;
            }
            
            const razonCompleta = razonSelect ? 
                `${razonSelect}: ${razonDetalle}` : razonDetalle;
            
            try {
                await supabaseRequest('/rpc/suspend_trip', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        trip_id_param: tripId,
                        reason: razonCompleta
                    })
                });
                
                showMessage('Salida suspendida correctamente', 'info');
                bootstrap.Modal.getInstance(document.getElementById('modalSuspender')).hide();
                await cargarSalidas();
                
            } catch (error) {
                console.error('Error suspendiendo salida:', error);
                showMessage('Error al suspender la salida', 'danger');
            }
        }
        
        // ==================== GENERACI√ìN DE PDF ====================
        
        /**
         * Carga una imagen desde URL y la convierte a base64
         */
        function cargarImagenBase64(url) {
            return new Promise((resolve) => {
                if (!url) { resolve(null); return; }
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas.toDataURL('image/png'));
                    } catch (e) {
                        console.warn('‚ö†Ô∏è No se pudo convertir imagen a base64:', e);
                        resolve(null);
                    }
                };
                img.onerror = () => { resolve(null); };
                img.src = url;
            });
        }
        
        /**
         * Calcula la edad a partir de una fecha de nacimiento
         */
        function calcularEdad(birthday) {
            if (!birthday) return '';
            const birth = new Date(birthday + 'T00:00:00');
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }
        
        /**
         * Formatea hora de HH:MM:SS a h:mm am/pm
         */
        function formatearHora12(timeStr) {
            if (!timeStr) return '';
            const [h, m] = timeStr.split(':');
            let hour = parseInt(h);
            const ampm = hour >= 12 ? 'pm' : 'am';
            if (hour > 12) hour -= 12;
            if (hour === 0) hour = 12;
            return `${hour}:${m} ${ampm}`;
        }
        
        /**
         * Genera y descarga el PDF oficial de la salida pedag√≥gica
         */
        async function generarPDFSalida(tripId) {
            try {
                showMessage('<i class="bi bi-hourglass-split me-1"></i>Generando PDF, por favor espere...', 'info');
                
                // ‚îÄ‚îÄ 1. OBTENER TODOS LOS DATOS ‚îÄ‚îÄ
                const [tripArr, nodos, asistencia, adultos, configArr] = await Promise.all([
                    // Datos de la salida + destino + grados + solicitud + profesor responsable + aprobador
                    supabaseRequest(
                        `/svc_pedagogical_trips?select=*,` +
                        `destination:svc_transport_destinations(destination_name),` +
                        `svc_pedagogical_trip_grades(grades(grade_name)),` +
                        `request:svc_service_requests(` +
                            `requested_by,approver_id,` +
                            `requester:workers!svc_service_requests_requested_by_fkey(worker_first_name,worker_last_name_1,worker_last_name_2,worker_phone,worker_id_doc,worker_birthday,` +
                                `document_type:document_types(document_type_abbr),eps:eps_entities(eps_name)),` +
                            `approver:workers!svc_service_requests_approver_fkey(worker_first_name,worker_last_name_1,worker_last_name_2)` +
                        `)` +
                        `&trip_id=eq.${tripId}`
                    ),
                    // Nodos de transporte
                    supabaseRequest(
                        `/svc_trip_transport_nodes?select=node_role,node_order,svc_transport_nodes(node_name)` +
                        `&service_type=eq.pedagogical_trip&trip_id=eq.${tripId}&order=node_role,node_order`
                    ),
                    // Estudiantes asistentes
                    supabaseRequest(
                        `/svc_pedagogical_trip_attendance?select=student_id,` +
                        `students(student_first_name,student_last_name_1,student_last_name_2,student_id_document,student_birthday,` +
                            `document_type:document_types(document_type_abbr),eps:eps_entities(eps_name),` +
                            `course:courses(course_name,grade:grades(grade_name)))` +
                        `&trip_id=eq.${tripId}&is_attending=eq.true`
                    ),
                    // Adultos acompa√±antes
                    supabaseRequest(
                        `/svc_pedagogical_trip_adults?select=worker_id,` +
                        `workers(worker_first_name,worker_last_name_1,worker_last_name_2,worker_id_doc,worker_phone,` +
                            `document_type:document_types(document_type_abbr),eps:eps_entities(eps_name))` +
                        `&trip_id=eq.${tripId}`
                    ),
                    // Configuraci√≥n del sistema
                    supabaseRequest(
                        `/system_config?select=organization_name,logo_url,principal_name,principal_signature_url,` +
                        `academic_year:academic_years!system_config_current_academic_year_fkey(year_name)`
                    )
                ]);
                
                if (!tripArr || tripArr.length === 0) {
                    showMessage('No se encontr√≥ la salida pedag√≥gica', 'danger');
                    return;
                }
                
                const trip = tripArr[0];
                const config = configArr && configArr.length > 0 ? configArr[0] : {};
                const request = trip.request;
                const requester = request?.requester;
                const approver = request?.approver;
                
                // Procesar nodos
                const nodosSalida = (nodos || []).filter(n => n.node_role === 'departure').map(n => n.svc_transport_nodes?.node_name).filter(Boolean);
                const nodosLlegada = (nodos || []).filter(n => n.node_role === 'arrival').map(n => n.svc_transport_nodes?.node_name).filter(Boolean);
                
                // Procesar fecha
                const meses = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO',
                               'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
                const fechaObj = new Date(trip.trip_date + 'T00:00:00');
                const dia = fechaObj.getDate();
                const mes = meses[fechaObj.getMonth()];
                const anio = fechaObj.getFullYear();
                
                // Procesar estudiantes (ordenar por apellido)
                const estudiantes = (asistencia || [])
                    .filter(a => a.students)
                    .sort((a, b) => {
                        const apA = a.students.student_last_name_1 || '';
                        const apB = b.students.student_last_name_1 || '';
                        return apA.localeCompare(apB);
                    });
                
                // Procesar adultos (ordenar por apellido)
                const profesores = (adultos || [])
                    .filter(a => a.workers)
                    .sort((a, b) => {
                        const apA = a.workers.worker_last_name_1 || '';
                        const apB = b.workers.worker_last_name_1 || '';
                        return apA.localeCompare(apB);
                    });
                
                // Cargar im√°genes
                const [logoBase64, firmaBase64] = await Promise.all([
                    cargarImagenBase64(config.logo_url),
                    cargarImagenBase64(config.principal_signature_url)
                ]);
                
                // A√±o acad√©mico
                const yearName = config.academic_year?.year_name || `${anio}-${anio + 1}`;
                
                // ‚îÄ‚îÄ 2. CREAR PDF ‚îÄ‚îÄ
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'letter'); // 216 x 279 mm
                const pageWidth = 216;
                const margin = 15;
                const contentWidth = pageWidth - margin * 2;
                let y = 15; // posici√≥n vertical actual
                
                // Colores
                const azulOscuro = [27, 54, 93];
                const grisClaro = [240, 240, 240];
                const negro = [0, 0, 0];
                
                // ‚îÄ‚îÄ ENCABEZADO ‚îÄ‚îÄ
                // Logo
                if (logoBase64) {
                    try {
                        doc.addImage(logoBase64, 'PNG', margin, y, 30, 30);
                    } catch (e) {
                        console.warn('‚ö†Ô∏è No se pudo agregar logo al PDF');
                    }
                }
                
                // T√≠tulo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(...azulOscuro);
                doc.text(`SALIDAS PEDAG√ìGICAS ${yearName}`, pageWidth / 2, y + 12, { align: 'center' });
                
                y += 35;
                
                // ‚îÄ‚îÄ L√çNEA: INSTITUCI√ìN / MUNICIPIO ‚îÄ‚îÄ
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.3);
                
                // Tabla de informaci√≥n superior
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...negro);
                
                // Fila: Instituci√≥n | Municipio
                doc.rect(margin, y, contentWidth, 7);
                doc.rect(margin, y, contentWidth * 0.6, 7);
                doc.text('INSTITUCI√ìN: COLEGIO TILAT√Å - NIT. 800.164.741-5', margin + 2, y + 5);
                doc.text('MUNICIPIO: LA CALERA', margin + contentWidth * 0.6 + 2, y + 5);
                y += 7;
                
                // Fila: Destino | Fecha
                doc.rect(margin, y, contentWidth, 7);
                doc.rect(margin, y, contentWidth * 0.5, 7);
                doc.setFont('helvetica', 'normal');
                doc.text('DESTINO:', margin + 2, y + 5);
                doc.setFont('helvetica', 'bold');
                doc.text(trip.destination?.destination_name || '', margin + 22, y + 5);
                
                doc.setFont('helvetica', 'normal');
                doc.text('FECHA:', margin + contentWidth * 0.5 + 2, y + 5);
                doc.setFont('helvetica', 'bold');
                doc.text(`${dia}`, margin + contentWidth * 0.5 + 18, y + 5);
                doc.text(`${mes}`, margin + contentWidth * 0.5 + 30, y + 5);
                doc.text(`${anio}`, margin + contentWidth * 0.5 + 60, y + 5);
                y += 7;
                
                // Fila: Hora salida + nodos
                doc.rect(margin, y, contentWidth, 7);
                doc.setFont('helvetica', 'bold');
                const horaSalidaTexto = `SALIENDO DE TILAT√Å A LAS: ${formatearHora12(trip.departure_time)}` +
                    (nodosSalida.length > 0 ? ` ‚Äî Paradas: ${nodosSalida.join(', ')}` : '');
                doc.text(horaSalidaTexto, margin + 2, y + 5);
                y += 7;
                
                // Fila: Hora regreso + nodos
                doc.rect(margin, y, contentWidth, 7);
                const horaRegresoTexto = `HORA FINALIZACI√ìN EVENTO: ${formatearHora12(trip.return_time)}` +
                    (nodosLlegada.length > 0 ? ` ‚Äî Paradas: ${nodosLlegada.join(', ')}` : '');
                doc.text(horaRegresoTexto, margin + 2, y + 5);
                y += 10;
                
                // ‚îÄ‚îÄ CONTACTOS (hardcoded) ‚îÄ‚îÄ
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.setTextColor(80, 80, 80);
                doc.text('CONTACTO EN TILAT√Å ANTE EVENTUALIDAD M√âDICA: 3176592097 - 6013849880 Ext. 137 - 121', pageWidth / 2, y, { align: 'center' });
                y += 4;
                doc.text('CONTACTO FUERA DE TILAT√Å ANTE EVENTUALIDAD M√âDICA AXA COLPATRIA # 247', pageWidth / 2, y, { align: 'center' });
                y += 6;
                
                // ‚îÄ‚îÄ PROFESOR RESPONSABLE ‚îÄ‚îÄ
                doc.setFontSize(8);
                doc.setTextColor(...negro);
                doc.setFont('helvetica', 'bold');
                const nombreProfesor = requester ? 
                    `${requester.worker_first_name} ${requester.worker_last_name_1}${requester.worker_last_name_2 ? ' ' + requester.worker_last_name_2 : ''}` : 'N/A';
                const celularProfesor = requester?.worker_phone || '';
                
                doc.text(`PROFESOR RESPONSABLE DE LA SALIDA: ${nombreProfesor}`, margin, y);
                doc.text(`CELULAR: ${celularProfesor}`, pageWidth - margin, y, { align: 'right' });
                y += 6;
                
                // ‚îÄ‚îÄ TABLA DE ESTUDIANTES ‚îÄ‚îÄ
                const studentHeaders = [['No.', 'ESTUDIANTE', 'TIPO DE\nDOCUMENTO', 'DOCUMENTO DE\nIDENTIDAD', 'EDAD', 'EPS', 'GRADO']];
                
                const studentRows = estudiantes.map((est, idx) => {
                    const s = est.students;
                    const nombre = `${s.student_last_name_1 || ''}${s.student_last_name_2 ? ' ' + s.student_last_name_2 : ''}, ${s.student_first_name || ''}`;
                    const tipoDoc = s.document_type?.document_type_abbr || '';
                    const numDoc = s.student_id_document || '';
                    const edad = calcularEdad(s.student_birthday);
                    const eps = s.eps?.eps_name || '';
                    const grado = s.course?.course_name || '';
                    return [idx + 1, nombre, tipoDoc, numDoc, edad, eps, grado];
                });
                
                doc.autoTable({
                    startY: y,
                    head: studentHeaders,
                    body: studentRows,
                    theme: 'grid',
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 7,
                        cellPadding: 1.5,
                        lineColor: [180, 180, 180],
                        lineWidth: 0.2,
                        textColor: negro
                    },
                    headStyles: {
                        fillColor: grisClaro,
                        textColor: negro,
                        fontStyle: 'bold',
                        halign: 'center',
                        fontSize: 7
                    },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 10 },
                        1: { cellWidth: 55 },
                        2: { halign: 'center', cellWidth: 18 },
                        3: { halign: 'center', cellWidth: 28 },
                        4: { halign: 'center', cellWidth: 12 },
                        5: { cellWidth: 30 },
                        6: { cellWidth: 33 }
                    }
                });
                
                y = doc.lastAutoTable.finalY + 8;
                
                // ‚îÄ‚îÄ T√çTULO PROFESORES ACOMPA√ëANTES ‚îÄ‚îÄ
                // Verificar si hay espacio suficiente en la p√°gina actual
                if (y + 40 > 270) {
                    doc.addPage();
                    y = 15;
                }
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.setTextColor(...negro);
                doc.text('PROFESORES ACOMPA√ëANTES', pageWidth / 2, y, { align: 'center' });
                y += 5;
                
                // ‚îÄ‚îÄ TABLA DE PROFESORES ‚îÄ‚îÄ
                const profHeaders = [['No.', 'PROFESOR', 'TIPO DE\nDOCUMENTO', 'DOCUMENTO DE\nIDENTIDAD', 'CELULAR', 'EPS']];

                const profRows = profesores.map((prof, idx) => {
                    const w = prof.workers;
                    const nombre = `${w.worker_first_name || ''} ${w.worker_last_name_1 || ''}${w.worker_last_name_2 ? ' ' + w.worker_last_name_2 : ''}`;
                    const tipoDoc = w.document_type?.document_type_abbr || 'c.c.';
                    const numDoc = w.worker_id_doc || '';
                    const celular = w.worker_phone || '';
                    const eps = w.eps?.eps_name || '';
                    return [idx + 1, nombre, tipoDoc, numDoc, celular, eps];
                });
                
                doc.autoTable({
                    startY: y,
                    head: profHeaders,
                    body: profRows,
                    theme: 'grid',
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 7,
                        cellPadding: 1.5,
                        lineColor: [180, 180, 180],
                        lineWidth: 0.2,
                        textColor: negro
                    },
                    headStyles: {
                        fillColor: grisClaro,
                        textColor: negro,
                        fontStyle: 'bold',
                        halign: 'center',
                        fontSize: 7
                    },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 10 },
                        1: { cellWidth: 50 },
                        2: { halign: 'center', cellWidth: 22 },
                        3: { halign: 'center', cellWidth: 35 },
                        4: { halign: 'center', cellWidth: 25 },
                        5: { cellWidth: 44 }
                    }
                });
                
                y = doc.lastAutoTable.finalY + 15;
                
                // ‚îÄ‚îÄ FIRMA DEL RECTOR ‚îÄ‚îÄ
                if (y + 45 > 270) {
                    doc.addPage();
                    y = 15;
                }
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.text('Aprob√≥:', margin, y);
                y += 5;
                
                // Firma (imagen)
                if (firmaBase64) {
                    try {
                        doc.addImage(firmaBase64, 'PNG', margin, y, 40, 20);
                    } catch (e) {
                        console.warn('‚ö†Ô∏è No se pudo agregar firma al PDF');
                    }
                }
                y += 22;
                
                // Nombre del rector
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                const nombreRector = (config.principal_name || 'RECTOR').toUpperCase();
                doc.text(nombreRector, margin, y);
                y += 4;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.text('RECTOR', margin, y);
                
                // Logo Rector√≠a (al centro)
                if (logoBase64) {
                    try {
                        doc.addImage(logoBase64, 'PNG', pageWidth / 2 - 10, y - 22, 20, 20);
                    } catch (e) { /* silenciar */ }
                }
                
                // ‚îÄ‚îÄ PIE DE P√ÅGINA EN TODAS LAS P√ÅGINAS ‚îÄ‚îÄ
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(6);
                    doc.setTextColor(150, 150, 150);
                    doc.text(
                        `Documento generado por SchoolNet ‚Äî Colegio Tilat√° ‚Äî P√°gina ${i} de ${totalPages}`,
                        pageWidth / 2, 275, { align: 'center' }
                    );
                }
                
                // ‚îÄ‚îÄ 3. DESCARGAR ‚îÄ‚îÄ
                const destino = (trip.destination?.destination_name || 'salida').replace(/\s+/g, '_');
                const fechaArchivo = trip.trip_date;
                doc.save(`Salida_Pedagogica_${destino}_${fechaArchivo}.pdf`);
                
                showMessage('‚úÖ PDF descargado correctamente', 'success');
                
            } catch (error) {
                console.error('‚ùå Error generando PDF:', error);
                showMessage('Error al generar el PDF: ' + error.message, 'danger');
            }
        }
        
        // ==================== UTILIDADES ====================
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function formatNumber(num) {
            return new Intl.NumberFormat('es-CO').format(num);
        }
        
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element.tagName === 'TBODY') {
                element.innerHTML = '<tr><td colspan="8" class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary me-2"></div>Cargando...</td></tr>';
            } else {
                element.disabled = true;
                element.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
            }
        }
        
        function hideLoading(elementId, originalContent) {
            const element = document.getElementById(elementId);
            element.disabled = false;
            element.innerHTML = originalContent;
        }
        
        function showMessage(message, type = 'info') {
            // Usar toasts de Bootstrap o SweetAlert si est√° disponible
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: type === 'danger' ? 'error' : type,
                    title: message,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
            } else if (typeof showToast === 'function') {
                // Usar funci√≥n de config.js si est√° disponible
                showToast(message, type);
            } else {
                // Fallback a console y alert
                console.log(`[${type.toUpperCase()}] ${message}`);
                if (type === 'danger' || type === 'error') {
                    alert(`‚ùå Error: ${message}`);
                } else if (type === 'warning') {
                    alert(`‚ö†Ô∏è Advertencia: ${message}`);
                } else if (type === 'success') {
                    console.log('‚úÖ ' + message);
                }
            }
        }

        // ==================== FUNCIONES AUXILIARES DE FORMATO ====================

        function formatearFecha(fecha) {
            if (!fecha) return 'N/A';
            const date = new Date(fecha + 'T00:00:00');
            const opciones = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            return date.toLocaleDateString('es-CO', opciones);
        }
        
        function formatearMoneda(valor) {
            if (!valor && valor !== 0) return 'N/A';
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(valor);
        }
        
        function getBadgeEstado(estado) {
            const estados = {
                'scheduled': '<span class="badge bg-primary">Programaci√≥n</span>',
                'imminent': '<span class="badge bg-warning">Inminente</span>',
                'in_progress': '<span class="badge bg-success">En proceso</span>',
                'completed': '<span class="badge bg-secondary">Realizada</span>',
                'suspended': '<span class="badge bg-danger">Suspendida</span>'
            };
            return estados[estado] || '<span class="badge bg-light text-dark">Desconocido</span>';
        }
        
        function getBadgeEstadoSolicitud(estado) {
            const estados = {
                'pending': '<span class="badge bg-warning">Pendiente</span>',
                'approved': '<span class="badge bg-success">Aprobada</span>',
                'rejected': '<span class="badge bg-danger">Rechazada</span>'
            };
            return estados[estado] || '<span class="badge bg-light text-dark">N/A</span>';
        }
        
        // ==================== VER DETALLE DE SALIDA ====================
        async function verDetalleSalida(tripId) {
            try {
                console.log('üìã Ver detalle:', tripId);
                
                // Cargar datos de la salida + adultos + nodos
                const [salida, tripAdults, tripNodes] = await Promise.all([
                    supabaseRequest(`/svc_pedagogical_trips?select=*,svc_pedagogical_trip_grades(grades(grade_id,grade_name)),destination:svc_transport_destinations(destination_name,destination_address),menu:svc_catering_menus(menu_name,unit_price),request:svc_service_requests(request_status,approver_id,workers!svc_service_requests_approver_fkey(worker_first_name,worker_last_name_1))&trip_id=eq.${tripId}`),
                    supabaseRequest(`/svc_pedagogical_trip_adults?select=worker_id,workers(worker_first_name,worker_last_name_1,worker_last_name_2)&trip_id=eq.${tripId}`),
                    supabaseRequest(`/svc_trip_transport_nodes?select=node_id,node_role,svc_transport_nodes(node_name)&service_type=eq.pedagogical_trip&trip_id=eq.${tripId}&order=node_role,node_order`)
                ]);
                
                if (!salida || salida.length === 0) {
                    showMessage('No se encontr√≥ la salida', 'danger');
                    return;
                }
                
                const datos = salida[0];
                
                // Cargar lista de estudiantes (solo si el estado es Inminente, En proceso o Realizada)
                let estudiantesHTML = '';
                if (['imminent', 'in_progress', 'completed'].includes(datos.trip_status)) {
                    try {
                        const estudiantes = await supabaseRequest(`/rpc/get_pedagogical_trip_students?trip_id_param=${tripId}`);
                        
                        if (estudiantes && estudiantes.length > 0) {
                            // Separar asistentes y desvinculados
                            const asistentes = estudiantes.filter(e => e.is_attending);
                            const desvinculados = estudiantes.filter(e => !e.is_attending);
                            
                            estudiantesHTML = `
                                <div class="mt-4">
                                    <h6 class="border-bottom pb-2">
                                        <i class="bi bi-people-fill me-2"></i>Estudiantes
                                        <span class="badge bg-success ms-2">${asistentes.length} asistentes</span>
                                        ${desvinculados.length > 0 ? `<span class="badge bg-warning ms-1">${desvinculados.length} desvinculados</span>` : ''}
                                    </h6>
                                    
                                    ${asistentes.length > 0 ? `
                                        <div class="mb-3">
                                            <strong class="text-success">
                                                <i class="bi bi-check-circle-fill me-1"></i>Asistentes (${asistentes.length})
                                            </strong>
                                            <div class="mt-2" style="max-height: 300px; overflow-y: auto;">
                                                ${agruparEstudiantesPorCurso(asistentes, true)}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${desvinculados.length > 0 ? `
                                        <div class="mb-3">
                                            <strong class="text-warning">
                                                <i class="bi bi-exclamation-triangle-fill me-1"></i>Desvinculados (${desvinculados.length})
                                            </strong>
                                            <div class="mt-2" style="max-height: 200px; overflow-y: auto;">
                                                ${agruparEstudiantesPorCurso(desvinculados, false)}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è No se pudieron cargar los estudiantes:', error);
                        // No mostrar error al usuario, solo omitir la secci√≥n
                    }
                }
                
                // Construir HTML del detalle
                const grados = datos.svc_pedagogical_trip_grades?.map(g => g.grades.grade_name).join(', ') || 'N/A';
                const destino = datos.destination?.destination_name || 'N/A';
                const direccion = datos.destination?.destination_address || '';
                const menu = datos.menu?.menu_name || 'No incluye';
                const aprobador = datos.request?.workers ? 
                    `${datos.request.workers.worker_first_name} ${datos.request.workers.worker_last_name_1}` : 
                    'N/A';
                const estadoSolicitud = datos.request?.request_status || 'N/A';
                
                // Adultos acompa√±antes
                const adultWorkerNames = (tripAdults || []).map(a => {
                    const w = a.workers;
                    return w ? `${w.worker_first_name} ${w.worker_last_name_1}${w.worker_last_name_2 ? ' ' + w.worker_last_name_2 : ''}` : '-';
                });
                
                // Nodos de transporte
                const depNodes = (tripNodes || []).filter(n => n.node_role === 'departure').map(n => n.svc_transport_nodes?.node_name || '-');
                const arrNodes = (tripNodes || []).filter(n => n.node_role === 'arrival').map(n => n.svc_transport_nodes?.node_name || '-');
                
                // Calcular costo total correctamente
                const costoTotal = (datos.total_transport_value || 0) + (datos.total_catering_value || 0) + (datos.total_entrance_value || 0);
                
                const detalleHTML = `
                    <div class="row g-3">
                        ${datos.trip_title ? `
                        <div class="col-12">
                            <strong>T√≠tulo:</strong><br>
                            <span class="fs-5">${datos.trip_title}</span>
                        </div>
                        ` : ''}
                        <div class="col-md-6">
                            <strong>Fecha:</strong><br>
                            ${formatearFecha(datos.trip_date)}
                        </div>
                        <div class="col-md-6">
                            <strong>Estado:</strong><br>
                            ${getBadgeEstado(datos.trip_status)}
                        </div>
                        <div class="col-md-6">
                            <strong>Grados:</strong><br>
                            ${grados}
                        </div>
                        <div class="col-md-6">
                            <strong>Destino:</strong><br>
                            ${destino}
                            ${direccion ? `<br><small class="text-muted">${direccion}</small>` : ''}
                        </div>
                        <div class="col-md-6">
                            <strong>Hora salida:</strong><br>
                            ${datos.departure_time || 'N/A'}
                        </div>
                        <div class="col-md-6">
                            <strong>Hora regreso:</strong><br>
                            ${datos.return_time || 'N/A'}
                        </div>
                        ${depNodes.length > 0 ? `
                        <div class="col-md-6">
                            <strong>Nodos de salida:</strong><br>
                            ${depNodes.join(', ')}
                        </div>` : ''}
                        ${arrNodes.length > 0 ? `
                        <div class="col-md-6">
                            <strong>Nodos de llegada:</strong><br>
                            ${arrNodes.join(', ')}
                        </div>` : ''}
                        <div class="col-12">
                            <strong>Descripci√≥n:</strong><br>
                            ${datos.trip_description || 'N/A'}
                        </div>
                        ${datos.inquiry_unit ? `
                        <div class="col-12">
                            <strong>Unidad de indagaci√≥n:</strong><br>
                            ${datos.inquiry_unit}
                        </div>
                        ` : ''}
                        ${datos.observations ? `
                        <div class="col-12">
                            <strong>Observaciones:</strong><br>
                            ${datos.observations}
                        </div>
                        ` : ''}
                        <div class="col-md-4">
                            <strong>Estudiantes planeados:</strong><br>
                            ${datos.planned_students || 0}
                        </div>
                        <div class="col-md-4">
                            <strong>Estudiantes reales:</strong><br>
                            ${datos.actual_students || datos.planned_students || 0}
                        </div>
                        <div class="col-md-4">
                            <strong>Adultos:</strong><br>
                            ${datos.num_adults || 0}
                        </div>
                        ${adultWorkerNames.length > 0 ? `
                        <div class="col-12">
                            <strong>Adultos acompa√±antes:</strong><br>
                            ${adultWorkerNames.join(', ')}
                        </div>
                        ` : ''}
                        
                        <div class="col-12 mt-4">
                            <h6 class="border-bottom pb-2"><i class="bi bi-currency-dollar me-2"></i>Costos</h6>
                        </div>
                        <div class="col-md-4">
                            <strong>Transporte:</strong><br>
                            ${formatearMoneda(datos.total_transport_value || 0)}
                        </div>
                        <div class="col-md-4">
                            <strong>Refrigerios:</strong><br>
                            ${datos.catering_menu_id ? formatearMoneda(datos.total_catering_value || 0) : 'No incluye'}
                            ${datos.catering_menu_id ? `<br><small class="text-muted">${menu}</small>` : ''}
                        </div>
                        <div class="col-md-4">
                            <strong>Entradas:</strong><br>
                            ${datos.entrance_unit_value ? formatearMoneda(datos.total_entrance_value || 0) : 'No incluye'}
                        </div>
                        <div class="col-12">
                            <strong class="fs-5">Costo Total:</strong>
                            <span class="fs-4 text-primary fw-bold">${formatearMoneda(costoTotal)}</span>
                        </div>
                        
                        <div class="col-12 mt-4">
                            <h6 class="border-bottom pb-2"><i class="bi bi-clipboard-check me-2"></i>Aprobaci√≥n</h6>
                        </div>
                        <div class="col-md-6">
                            <strong>Aprobador:</strong><br>
                            ${aprobador}
                        </div>
                        <div class="col-md-6">
                            <strong>Estado:</strong><br>
                            ${getBadgeEstadoSolicitud(estadoSolicitud)}
                        </div>
                        
                        ${estudiantesHTML}
                    </div>
                `;
                
                // Mostrar en modal
                document.getElementById('detalleContent').innerHTML = detalleHTML;
                const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
                modal.show();
                
            } catch (error) {
                console.error('‚ùå Error al ver detalle:', error);
                showMessage('Error al cargar los detalles de la salida', 'danger');
            }
        }
        
        // ==================== FUNCI√ìN AUXILIAR: Agrupar estudiantes por curso ====================
        function agruparEstudiantesPorCurso(estudiantes, esAsistente) {
            // Agrupar por curso
            const porCurso = {};
            estudiantes.forEach(est => {
                if (!porCurso[est.course_name]) {
                    porCurso[est.course_name] = [];
                }
                porCurso[est.course_name].push(est);
            });
            
            // Generar HTML
            let html = '';
            Object.keys(porCurso).sort().forEach(curso => {
                const estudiantesCurso = porCurso[curso];
                html += `
                    <div class="mb-2">
                        <strong class="text-muted">${curso}</strong> (${estudiantesCurso.length})
                        <ul class="list-unstyled ms-3 mb-0">
                            ${estudiantesCurso.map(est => `
                                <li class="small ${esAsistente ? '' : 'text-warning'}">
                                    <i class="bi bi-${esAsistente ? 'check-circle' : 'x-circle'} me-1"></i>
                                    ${est.first_name} ${est.last_name}
                                    ${!esAsistente && est.unlinked_reason ? 
                                        `<br><span class="ms-3 text-muted fst-italic" style="font-size: 0.85em;">
                                            Raz√≥n: ${est.unlinked_reason}
                                        </span>` 
                                        : ''}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            });
            
            return html;
        }
        
        
        async function editarSalida(tripId) {
            try {
                console.log('‚úèÔ∏è Editar salida:', tripId);
                
                // Cargar datos completos de la salida + adultos + nodos
                const [salida, adultos, nodos] = await Promise.all([
                    supabaseRequest(`/svc_pedagogical_trips?select=*,svc_pedagogical_trip_grades(grades(grade_id)),request:svc_service_requests(approver_id)&trip_id=eq.${tripId}`),
                    supabaseRequest(`/svc_pedagogical_trip_adults?select=worker_id&trip_id=eq.${tripId}`),
                    supabaseRequest(`/svc_trip_transport_nodes?select=node_id,node_role,node_order,svc_transport_nodes(node_id,node_name)&service_type=eq.pedagogical_trip&trip_id=eq.${tripId}&order=node_role,node_order`)
                ]);
                
                if (!salida || salida.length === 0) {
                    throw new Error('No se encontr√≥ la salida');
                }
                
                const datos = salida[0];
                console.log('üì• Datos cargados:', datos);
                
                // Resetear wizard
                document.getElementById('formWizardSalida').reset();
                currentWizardStep = 1;
                
                // Llenar STEP 1: Informaci√≥n General
                const gradosIds = datos.svc_pedagogical_trip_grades.map(g => g.grades.grade_id);
                const selectGrados = document.getElementById('wizardGrados');
                Array.from(selectGrados.options).forEach(option => {
                    option.selected = gradosIds.includes(option.value);
                });
                
                document.getElementById('wizardDestino').value = datos.destination_id;
                
                // Setear fecha usando Flatpickr (sin restricci√≥n de minDate al editar)
                if (fpWizardFecha) {
                    fpWizardFecha.set('minDate', null); // Permitir la fecha original
                    fpWizardFecha.setDate(datos.trip_date, true);
                }
                
                document.getElementById('wizardHoraSalida').value = datos.departure_time;
                document.getElementById('wizardHoraRegreso').value = datos.return_time;
                
                // Modalidad
                document.querySelector(`input[name="wizardModalidad"][value="${datos.transport_modality}"]`).checked = true;
                
                // Nodos de transporte
                selectedNodosSalida = [];
                selectedNodosLlegada = [];
                (nodos || []).forEach(n => {
                    const nodoData = n.svc_transport_nodes || datosGlobales.nodos.find(nd => nd.node_id === n.node_id);
                    if (nodoData) {
                        if (n.node_role === 'departure') {
                            selectedNodosSalida.push(nodoData);
                        } else {
                            selectedNodosLlegada.push(nodoData);
                        }
                    }
                });
                actualizarVisibilidadNodos();
                renderNodos('departure');
                renderNodos('arrival');
                
                // STEP 2: Descripci√≥n + T√≠tulo
                document.getElementById('wizardTitulo').value = datos.trip_title || '';
                document.getElementById('wizardDescripcion').value = datos.trip_description || '';
                document.getElementById('wizardUnidadIndagacion').value = datos.inquiry_unit || '';
                document.getElementById('wizardObservaciones').value = datos.observations || '';
                
                // STEP 3: Participantes
                await calcularEstudiantes();
                
               // Adultos acompa√±antes (workers)
                selectedAdultosPedagogicas = (adultos || []).map(a => a.worker_id);
                renderBadgesAdultosPedagogicas();
                filtrarWorkersPedagogicas();
                actualizarTotalParticipantes();
                
                // STEP 4: Servicios Opcionales
                // Refrigerios
                if (datos.catering_menu_id) {
                    document.getElementById('wizardIncluirRefrigerios').checked = true;
                    document.getElementById('wizardRefrigeriosFields').style.display = 'block';
                    document.getElementById('wizardMenuRefrigerio').value = datos.catering_menu_id;
                    document.getElementById('wizardCantidadRefrigerios').value = datos.catering_quantity || 0;
                } else {
                    document.getElementById('wizardIncluirRefrigerios').checked = false;
                    document.getElementById('wizardRefrigeriosFields').style.display = 'none';
                }
                
                // Entradas
                if (datos.entrance_unit_value) {
                    document.getElementById('wizardIncluirEntradas').checked = true;
                    document.getElementById('wizardEntradasFields').style.display = 'block';
                    document.getElementById('wizardValorEntrada').value = datos.entrance_unit_value;
                } else {
                    document.getElementById('wizardIncluirEntradas').checked = false;
                    document.getElementById('wizardEntradasFields').style.display = 'none';
                }
                
                // STEP 5: Aprobaci√≥n
                if (datos.request && datos.request.approver_id) {
                    document.getElementById('wizardAprobador').value = datos.request.approver_id;
                }
                
                // Resetear UI del wizard
                document.querySelectorAll('.wizard-step').forEach(step => {
                    step.classList.remove('active', 'completed');
                });
                document.querySelectorAll('.wizard-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                document.querySelector('.wizard-step[data-step="1"]').classList.add('active');
                document.querySelector('.wizard-content[data-step="1"]').classList.add('active');
                
                actualizarBotonesWizard();
                actualizarProgressBar();
                
                // Calcular costos con los datos cargados
                await calcularCostosWizard();
                
                // Guardar el trip_id en un atributo del formulario para saber que estamos editando
                document.getElementById('formWizardSalida').setAttribute('data-editing-trip-id', tripId);
                
                // Cambiar t√≠tulo del modal
                document.querySelector('#modalWizardSalida .modal-title').innerHTML = 
                    '<i class="bi bi-pencil me-2"></i>Editar Salida Pedag√≥gica';
                
                // Cambiar texto del bot√≥n de guardar
                document.getElementById('btnWizardGuardar').innerHTML = 
                    '<i class="bi bi-check-circle me-1"></i>Actualizar Salida';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalWizardSalida'));
                modal.show();
                
                
            } catch (error) {
                console.error('‚ùå Error al editar:', error);
                showMessage('Error al cargar datos para edici√≥n: ' + error.message, 'danger');
                hideLoading('tablaSalidasBody');
            }
        }
        
        async function eliminarSalida(tripId) {
            if (!confirm('¬øEst√° seguro de eliminar esta salida?')) return;
            
            try {
                await supabaseRequest(`/svc_pedagogical_trips?trip_id=eq.${tripId}`, {
                    method: 'DELETE'
                });
                
                showMessage('Salida eliminada correctamente', 'success');
                await cargarSalidas();
                
            } catch (error) {
                console.error('Error eliminando:', error);
                showMessage('Error al eliminar la salida', 'danger');
            }
        }
    </script>
</body>
</html>
