<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.07.18.25">
    <title>Salidas Pedag√≥gicas - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Configuraci√≥n global -->
    <script src="/assets/js/config.js"></script>
    
    <style>
        :root {
            --service-primary: #1B365D;
            --service-accent: #667eea;
            --service-warning: #ffc107;
        }
        
        /* ==================== WIZARD STYLES ==================== */
        .wizard-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .wizard-progress {
            margin-bottom: 2rem;
        }
        
        .wizard-progress .progress {
            height: 8px;
            border-radius: 10px;
        }
        
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .wizard-step {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 0 10px;
        }
        
        .wizard-step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-weight: 600;
            transition: all 0.3s;
            border: 3px solid transparent;
        }
        
        .wizard-step.active .wizard-step-circle {
            background: var(--service-primary);
            color: white;
            border-color: var(--service-primary);
            transform: scale(1.1);
        }
        
        .wizard-step.completed .wizard-step-circle {
            background: #28a745;
            color: white;
        }
        
        .wizard-step-title {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .wizard-step.active .wizard-step-title {
            color: var(--service-primary);
            font-weight: 600;
        }
        
        .wizard-content {
            display: none;
        }
        
        .wizard-content.active {
            display: block;
            animation: fadeInUp 0.3s;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ==================== TABLE STYLES ==================== */
        .table-actions {
            display: flex;
            gap: 0.25rem;
            justify-content: center;
        }
        
        .table-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .badge-status {
            padding: 0.5rem 0.75rem;
            font-weight: 500;
            font-size: 0.8rem;
        }
        
        /* ==================== COST SUMMARY ==================== */
        .cost-summary-card {
            background: linear-gradient(135deg, var(--service-primary) 0%, var(--service-accent) 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .cost-item:last-child {
            border-bottom: none;
            font-size: 1.25rem;
            font-weight: 700;
            padding-top: 1rem;
        }
        
        /* ==================== FILTER PANEL ==================== */
        .filter-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        /* ==================== OFFCANVAS ATTENDANCE ==================== */
        .offcanvas-attendance {
            width: 500px !important;
        }
        
        .student-list-group {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }
        
        .student-item {
            transition: background 0.2s;
        }
        
        .student-item:hover {
            background: #f8f9fa;
        }
        
        .student-item.unlinked {
            background: #fff3cd;
            opacity: 0.6;
        }
        
        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .wizard-step-title {
                font-size: 0.7rem;
            }
            
            .wizard-step-circle {
                width: 35px;
                height: 35px;
                font-size: 0.875rem;
            }
            
            .offcanvas-attendance {
                width: 100% !important;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
        }
        
        /* ==================== UTILITIES ==================== */
        .cursor-pointer {
            cursor: pointer;
        }
        
        .text-muted-light {
            color: #adb5bd;
        }
    </style>
</head>
<body>
    <!-- Contenedor principal -->
    <div class="container-fluid py-4">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html">Inicio</a></li>
                <li class="breadcrumb-item"><a href="index.html">Servicios</a></li>
                <li class="breadcrumb-item active" aria-current="page">Salidas pedag√≥gicas</li>
            </ol>
        </nav>
        
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="mb-1">
                    <i class="bi bi-backpack3 me-2"></i>Salidas Pedag√≥gicas
                </h3>
                <p class="text-muted mb-0">Gesti√≥n completa de salidas educativas</p>
            </div>
            <button class="btn btn-primary" onclick="abrirWizardNuevaSalida()">
                <i class="bi bi-plus-circle me-2"></i>Nueva Salida
            </button>
        </div>
        
        <!-- Panel de Filtros -->
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center cursor-pointer" 
                 data-bs-toggle="collapse" data-bs-target="#filtrosCollapse">
                <span><i class="bi bi-funnel me-2"></i>Filtros de b√∫squeda</span>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="collapse show" id="filtrosCollapse">
                <div class="card-body">
                    <form id="formFiltros">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Fecha inicio</label>
                                <input type="date" class="form-control" id="filtroFechaInicio">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Fecha fin</label>
                                <input type="date" class="form-control" id="filtroFechaFin">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Estado</label>
                                <select class="form-select" id="filtroEstado">
                                    <option value="">Todos los estados</option>
                                    <option value="scheduled">Programaci√≥n</option>
                                    <option value="imminent">Inminente</option>
                                    <option value="in_progress">En proceso</option>
                                    <option value="completed">Realizada</option>
                                    <option value="suspended">Suspendida</option>
                                    <option value="cancelled">Cancelada</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Grado</label>
                                <select class="form-select" id="filtroGrado" multiple>
                                    <!-- Se carga din√°micamente -->
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="button" class="btn btn-primary me-2" onclick="aplicarFiltros()">
                                    <i class="bi bi-search me-2"></i>Filtrar
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                                    <i class="bi bi-x-circle me-2"></i>Limpiar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Contador de resultados -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <span class="badge bg-secondary" id="contadorResultados">
                    <i class="bi bi-list-ul me-1"></i>0 salidas encontradas
                </span>
            </div>
        </div>
        
        <!-- Tabla de Salidas -->
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="tablaSalidas">
                        <thead class="table-dark">
                            <tr>
                                <th>Fecha</th>
                                <th>Grados</th>
                                <th>Destino</th>
                                <th>Estado</th>
                                <th class="text-center">Estudiantes</th>
                                <th class="text-center">Adultos</th>
                                <th class="text-end">Costo Total</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaSalidasBody">
                            <!-- Se carga din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Paginaci√≥n -->
        <nav aria-label="Paginaci√≥n" class="mt-3">
            <ul class="pagination justify-content-center" id="paginacion">
                <!-- Se genera din√°micamente -->
            </ul>
        </nav>
    </div>
    
    <!-- ==================== MODAL: WIZARD NUEVA SALIDA ==================== -->
    <div class="modal fade" id="modalWizardSalida" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle me-2"></i>Nueva Salida Pedag√≥gica
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="wizard-container">
                        <!-- Progress Bar -->
                        <div class="wizard-progress">
                            <div class="progress">
                                <div class="progress-bar" id="wizardProgressBar" style="width: 20%"></div>
                            </div>
                        </div>
                        
                        <!-- Wizard Steps -->
                        <div class="wizard-steps">
                            <div class="wizard-step active" data-step="1">
                                <div class="wizard-step-circle">1</div>
                                <div class="wizard-step-title">Informaci√≥n General</div>
                            </div>
                            <div class="wizard-step" data-step="2">
                                <div class="wizard-step-circle">2</div>
                                <div class="wizard-step-title">Descripci√≥n</div>
                            </div>
                            <div class="wizard-step" data-step="3">
                                <div class="wizard-step-circle">3</div>
                                <div class="wizard-step-title">Participantes</div>
                            </div>
                            <div class="wizard-step" data-step="4">
                                <div class="wizard-step-circle">4</div>
                                <div class="wizard-step-title">Servicios</div>
                            </div>
                            <div class="wizard-step" data-step="5">
                                <div class="wizard-step-circle">5</div>
                                <div class="wizard-step-title">Aprobaci√≥n</div>
                            </div>
                        </div>
                        
                        <!-- Wizard Content -->
                        <form id="formWizardSalida">
                            <!-- STEP 1: Informaci√≥n General -->
                            <div class="wizard-content active" data-step="1">
                                <h5 class="mb-3">Informaci√≥n General</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Grados participantes <span class="text-danger">*</span></label>
                                        <select class="form-select" id="wizardGrados" multiple required>
                                            <!-- Se carga din√°micamente -->
                                        </select>
                                        <small class="text-muted">Mant√©n presionado Ctrl para seleccionar m√∫ltiples</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Destino <span class="text-danger">*</span></label>
                                        <select class="form-select" id="wizardDestino" required>
                                            <option value="">Seleccione un destino</option>
                                            <!-- Se carga din√°micamente -->
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Fecha de salida <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="wizardFecha" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Hora de salida <span class="text-danger">*</span></label>
                                        <input type="time" class="form-control" id="wizardHoraSalida" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Hora de regreso <span class="text-danger">*</span></label>
                                        <input type="time" class="form-control" id="wizardHoraRegreso" required>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">Modalidad de transporte <span class="text-danger">*</span></label>
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="wizardModalidad" id="modalidadIda" value="outbound" required>
                                            <label class="btn btn-outline-primary" for="modalidadIda">
                                                <i class="bi bi-arrow-right me-1"></i>Solo ida
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="wizardModalidad" id="modalidadRegreso" value="return">
                                            <label class="btn btn-outline-primary" for="modalidadRegreso">
                                                <i class="bi bi-arrow-left me-1"></i>Solo regreso
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="wizardModalidad" id="modalidadIdaVuelta" value="round_trip" checked>
                                            <label class="btn btn-outline-primary" for="modalidadIdaVuelta">
                                                <i class="bi bi-arrow-left-right me-1"></i>Ida y vuelta
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- STEP 2: Descripci√≥n -->
                            <div class="wizard-content" data-step="2">
                                <h5 class="mb-3">Descripci√≥n de la Salida</h5>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Descripci√≥n <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="wizardDescripcion" rows="4" required 
                                                  placeholder="Describa el objetivo y actividades de la salida"></textarea>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">Unidad de indagaci√≥n</label>
                                        <textarea class="form-control" id="wizardUnidadIndagacion" rows="3" 
                                                  placeholder="¬øA qu√© unidad de indagaci√≥n est√° vinculada esta salida?"></textarea>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">Observaciones</label>
                                        <textarea class="form-control" id="wizardObservaciones" rows="3" 
                                                  placeholder="Informaci√≥n adicional relevante"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- STEP 3: Participantes -->
                            <div class="wizard-content" data-step="3">
                                <h5 class="mb-3">Participantes</h5>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>Estudiantes:</strong> Se calculan autom√°ticamente seg√∫n los grados seleccionados.
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">N√∫mero de estudiantes</label>
                                        <input type="number" class="form-control" id="wizardNumEstudiantes" readonly 
                                               style="background-color: #e9ecef;">
                                        <small class="text-muted" id="wizardDesglosePorGrado">
                                            <!-- Se actualiza din√°micamente -->
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">N√∫mero de adultos <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="wizardNumAdultos" min="0" value="0" required>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">Adultos acompa√±antes</label>
                                        <textarea class="form-control" id="wizardAdultosNombres" rows="3" 
                                                  placeholder="Nombres de los adultos acompa√±antes (Ej: Mar√≠a Garc√≠a, Pedro L√≥pez, Ana Ruiz)"></textarea>
                                        <small class="text-muted">Separe los nombres con comas</small>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="alert alert-success">
                                            <strong>Total de participantes:</strong> <span id="wizardTotalParticipantes">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- STEP 4: Servicios Opcionales -->
                            <div class="wizard-content" data-step="4">
                                <h5 class="mb-3">Servicios Opcionales</h5>
                                
                                <!-- Refrigerios -->
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="wizardIncluirRefrigerios">
                                            <label class="form-check-label fw-bold" for="wizardIncluirRefrigerios">
                                                <i class="bi bi-cup-straw me-2"></i>Incluir Refrigerios
                                            </label>
                                        </div>
                                        <div id="wizardRefrigeriosFields" style="display: none;">
                                            <div class="row g-3">
                                                <div class="col-md-8">
                                                    <label class="form-label">Men√∫</label>
                                                    <select class="form-select" id="wizardMenuRefrigerio">
                                                        <option value="">Seleccione un men√∫</option>
                                                        <!-- Se carga din√°micamente -->
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Cantidad</label>
                                                    <input type="number" class="form-control" id="wizardCantidadRefrigerios" min="1" placeholder="Se auto-llena con total de participantes">
                                                    <small class="text-muted">Auto-llenado. Puedes modificarlo si necesitas.</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Entradas -->
                                <div class="card">
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="wizardIncluirEntradas">
                                            <label class="form-check-label fw-bold" for="wizardIncluirEntradas">
                                                <i class="bi bi-ticket-perforated me-2"></i>Incluir Entradas
                                            </label>
                                        </div>
                                        <div id="wizardEntradasFields" style="display: none;">
                                            <div class="row g-3">
                                                <div class="col-md-12">
                                                    <label class="form-label">Valor unitario de la entrada</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control" id="wizardValorEntrada" min="0" step="1000">
                                                    </div>
                                                    <small class="text-muted">Este valor aplica para todos los participantes</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- STEP 5: Aprobaci√≥n y Resumen -->
                            <div class="wizard-content" data-step="5">
                                <h5 class="mb-3">Aprobaci√≥n y Resumen</h5>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Aprobador <span class="text-danger">*</span></label>
                                        <select class="form-select" id="wizardAprobador" required>
                                            <option value="">Seleccione un aprobador</option>
                                            <!-- Se carga din√°micamente -->
                                        </select>
                                        <small class="text-muted">Solo usuarios con permiso de "Resoluci√≥n de solicitudes"</small>
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">Comentarios/Justificaci√≥n</label>
                                        <textarea class="form-control" id="wizardComentarios" rows="3" 
                                                  placeholder="Informaci√≥n adicional para el aprobador"></textarea>
                                    </div>
                                    
                                    <!-- Resumen de Costos -->
                                    <div class="col-md-12">
                                        <div class="cost-summary-card">
                                            <h5 class="mb-3">
                                                <i class="bi bi-calculator me-2"></i>Resumen de Costos
                                            </h5>
                                            <div class="cost-item">
                                                <span>Transporte:</span>
                                                <span id="wizardCostoTransporte">$0</span>
                                            </div>
                                            <div id="detalleVehiculosContainer" style="display: none; margin-left: 20px; font-size: 0.85em; color: #666;">
                                                <!-- Aqu√≠ se mostrar√° el detalle de veh√≠culos -->
                                            </div>
                                            <div class="cost-item">
                                                <span>Refrigerios:</span>
                                                <span id="wizardCostoRefrigerios">$0</span>
                                            </div>
                                            <div class="cost-item">
                                                <span>Entradas:</span>
                                                <span id="wizardCostoEntradas">$0</span>
                                            </div>
                                            <div class="cost-item">
                                                <span>TOTAL:</span>
                                                <span id="wizardCostoTotal">$0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" id="btnWizardAnterior" onclick="wizardAnterior()">
                        <i class="bi bi-chevron-left me-1"></i>Anterior
                    </button>
                    <button type="button" class="btn btn-primary" id="btnWizardSiguiente" onclick="wizardSiguiente()">
                        Siguiente<i class="bi bi-chevron-right ms-1"></i>
                    </button>
                    <button type="button" class="btn btn-success" id="btnWizardGuardar" style="display: none;" onclick="guardarNuevaSalida()">
                        <i class="bi bi-check-circle me-1"></i>Guardar y Solicitar Aprobaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== OFFCANVAS: REGISTRO DE ASISTENCIA ==================== -->
    <div class="offcanvas offcanvas-end offcanvas-attendance" id="offcanvasAsistencia" tabindex="-1">
        <div class="offcanvas-header bg-primary text-white">
            <h5 class="offcanvas-title">
                <i class="bi bi-person-check me-2"></i>Registro de Asistencia
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <!-- Informaci√≥n de la salida -->
            <div class="alert alert-info mb-3">
                <strong id="asistenciaTituloSalida">Salida Pedag√≥gica</strong><br>
                <small id="asistenciaInfoSalida"></small>
            </div>
            
            <!-- B√∫squeda r√°pida -->
            <div class="mb-3">
                <input type="text" class="form-control" id="buscarEstudiante" 
                       placeholder="Buscar estudiante por nombre...">
            </div>
            
            <!-- Resumen -->
            <div class="row g-2 mb-3">
                <div class="col-4">
                    <div class="card text-center">
                        <div class="card-body p-2">
                            <h6 class="mb-0" id="asistenciaPlaneados">0</h6>
                            <small class="text-muted">Planeados</small>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card text-center bg-success text-white">
                        <div class="card-body p-2">
                            <h6 class="mb-0" id="asistenciaConfirmados">0</h6>
                            <small>Confirmados</small>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card text-center bg-warning">
                        <div class="card-body p-2">
                            <h6 class="mb-0" id="asistenciaDesvinculados">0</h6>
                            <small>Desvinculados</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lista de estudiantes -->
            <div class="student-list-group" id="listaEstudiantesAsistencia">
                <!-- Se carga din√°micamente -->
            </div>
            
            <!-- Bot√≥n para desvincular -->
            <div class="mt-3">
                <button class="btn btn-warning w-100" id="btnDesvincularSeleccionados" 
                        onclick="desvincularSeleccionados()" disabled>
                    <i class="bi bi-person-dash me-2"></i>Desvincular seleccionados
                </button>
            </div>
        </div>
    </div>
    
    <!-- ==================== MODAL: CONFIRMAR BANDERAZO ==================== -->
    <div class="modal fade" id="modalBanderazo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-flag-fill me-2"></i>Banderazo de Salida
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">¬øConfirmar que los veh√≠culos han partido?</p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Esta acci√≥n cambiar√° el estado de la salida a <strong>"En proceso"</strong>
                    </div>
                    <input type="hidden" id="banderazoTripId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="confirmarBanderazo()">
                        <i class="bi bi-flag-fill me-2"></i>Dar Banderazo
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== MODAL: SUSPENDER/CANCELAR ==================== -->
    <div class="modal fade" id="modalSuspender" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-x-circle me-2"></i>Suspender Salida
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formSuspender">
                        <div class="mb-3">
                            <label class="form-label">Raz√≥n de suspensi√≥n <span class="text-danger">*</span></label>
                            <select class="form-select mb-2" id="suspenderRazonSelect">
                                <option value="">Seleccione una raz√≥n</option>
                                <option value="clima">Condiciones clim√°ticas adversas</option>
                                <option value="orden_publico">Situaci√≥n de orden p√∫blico</option>
                                <option value="transporte">Problema con el transporte</option>
                                <option value="destino">Problema en el destino</option>
                                <option value="otro">Otro</option>
                            </select>
                            <textarea class="form-control" id="suspenderRazonDetalle" rows="3" 
                                      placeholder="Detalles adicionales..." required></textarea>
                        </div>
                        <input type="hidden" id="suspenderTripId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarSuspension()">
                        <i class="bi bi-x-circle me-2"></i>Suspender Salida
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== MODAL: VER DETALLE ==================== -->
    <div class="modal fade" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-eye me-2"></i>Detalle de Salida Pedag√≥gica
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="detalleContent">
                        <!-- Se carga din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ==================== VARIABLES GLOBALES ====================
        let currentUser = null;
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentWizardStep = 1;
        let filtrosActivos = {};
        let datosGlobales = {
            grados: [],
            destinos: [],
            menus: [],
            aprobadores: [],
            salidas: [],
            detalleTransporte: null // Info de veh√≠culos calculados para optimizaci√≥n
        };
        
        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando m√≥dulo de Salidas Pedag√≥gicas...');
            
            try {
                // Verificar que config.js se haya cargado
                if (typeof validatePageAccess !== 'function') {
                    console.error('‚ùå Error: config.js no se carg√≥ correctamente');
                    alert('Error al cargar el m√≥dulo: validatePageAccess is not defined. Verifique que config.js est√© en la ruta correcta.');
                    return;
                }
                
                if (typeof supabaseRequest !== 'function') {
                    console.error('‚ùå Error: supabaseRequest no est√° definida');
                    alert('Error al cargar el m√≥dulo: supabaseRequest is not defined. Verifique que config.js est√© en la ruta correcta.');
                    return;
                }
                
                // Validar acceso
                const tieneAcceso = await validatePageAccess('Salidas pedag√≥gicas');
                if (!tieneAcceso) return;
                
                // Cargar colores corporativos
                if (typeof loadAndApplyBrandColors === 'function') {
                    await loadAndApplyBrandColors();
                }
                
                // Obtener usuario actual
                if (typeof getStoredSession === 'function') {
                    const session = getStoredSession();
                    if (session && session.user) {
                        currentUser = session.user;
                    }
                } else {
                    console.warn('‚ö†Ô∏è getStoredSession no est√° disponible');
                }
                
                // Cargar datos iniciales
                await cargarDatosIniciales();
                
                // Cargar salidas
                await cargarSalidas();
                
                // Configurar event listeners
                configurarEventListeners();
                
                console.log('‚úÖ M√≥dulo cargado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando m√≥dulo:', error);
                alert('Error al cargar el m√≥dulo: ' + error.message);
            }
        });
        
        // ==================== CARGAR DATOS INICIALES ====================
        async function cargarDatosIniciales() {
            try {
                console.log('üì• Cargando datos iniciales...');
                
                // Cargar grados
                const grados = await supabaseRequest('/grades?select=grade_id,grade_name&grade_status=eq.active&order=grade_order');
                datosGlobales.grados = grados || [];
                
                // Cargar destinos
                const destinos = await supabaseRequest('/svc_transport_destinations?select=destination_id,destination_name,destination_address&is_active=eq.true&order=destination_name');
                datosGlobales.destinos = destinos || [];
                
                // Cargar men√∫s de refrigerios
                const menus = await supabaseRequest('/svc_catering_menus?select=menu_id,menu_name,unit_price&is_active=eq.true&order=menu_name');
                datosGlobales.menus = menus || [];
                
                // Cargar aprobadores (workers con permiso "Resoluci√≥n de solicitudes")
                // Usa funci√≥n RPC get_workers_with_permission
                try {
                    const aprobadores = await supabaseRequest('/rpc/get_workers_with_permission', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            permission_name: 'Resoluci√≥n de solicitudes' 
                        })
                    });
                    datosGlobales.aprobadores = aprobadores || [];
                    console.log('‚úÖ Aprobadores cargados:', aprobadores.length);
                } catch (error) {
                    console.error('‚ùå Error cargando aprobadores:', error);
                    // Fallback: cargar todos los workers activos
                    console.warn('‚ö†Ô∏è Fallback: Cargando todos los workers activos');
                    const todosWorkers = await supabaseRequest('/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,email&worker_status=eq.active&order=worker_first_name');
                    datosGlobales.aprobadores = todosWorkers || [];
                }
                
                // Llenar selects
                llenarSelectGrados();
                llenarSelectDestinos();
                llenarSelectMenus();
                llenarSelectAprobadores();
                
                console.log('‚úÖ Datos iniciales cargados');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos iniciales:', error);
                throw error;
            }
        }
        
        // ==================== LLENAR SELECTS ====================
        function llenarSelectGrados() {
            const selects = ['filtroGrado', 'wizardGrados'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = datosGlobales.grados.map(g => 
                        `<option value="${g.grade_id}">${g.grade_name}</option>`
                    ).join('');
                }
            });
        }
        
        function llenarSelectDestinos() {
            const select = document.getElementById('wizardDestino');
            if (select) {
                select.innerHTML = '<option value="">Seleccione un destino</option>' +
                    datosGlobales.destinos.map(d => 
                        `<option value="${d.destination_id}">${d.destination_name}</option>`
                    ).join('');
            }
        }
        
        function llenarSelectMenus() {
            const select = document.getElementById('wizardMenuRefrigerio');
            if (select) {
                select.innerHTML = '<option value="">Seleccione un men√∫</option>' +
                    datosGlobales.menus.map(m => 
                        `<option value="${m.menu_id}" data-price="${m.unit_price}">${m.menu_name} - $${formatNumber(m.unit_price)}</option>`
                    ).join('');
            }
        }
        
        function llenarSelectAprobadores() {
            const select = document.getElementById('wizardAprobador');
            if (select) {
                select.innerHTML = '<option value="">Seleccione un aprobador</option>' +
                    datosGlobales.aprobadores.map(a => {
                        const nombreCompleto = `${a.worker_first_name} ${a.worker_last_name_1}${a.worker_last_name_2 ? ' ' + a.worker_last_name_2 : ''}`;
                        return `<option value="${a.worker_id}">${nombreCompleto}</option>`;
                    }).join('');
            }
        }
        
        // ==================== EVENT LISTENERS ====================
        function configurarEventListeners() {
            // Toggle refrigerios
            document.getElementById('wizardIncluirRefrigerios').addEventListener('change', function() {
                const mostrar = this.checked;
                document.getElementById('wizardRefrigeriosFields').style.display = mostrar ? 'block' : 'none';
                
                // Auto-llenar cantidad con total de participantes al activar
                if (mostrar) {
                    const totalParticipantes = parseInt(document.getElementById('wizardTotalParticipantes').textContent) || 0;
                    if (totalParticipantes > 0) {
                        document.getElementById('wizardCantidadRefrigerios').value = totalParticipantes;
                    }
                }
                
                calcularCostosWizard();
            });
            
            // Toggle entradas
            document.getElementById('wizardIncluirEntradas').addEventListener('change', function() {
                document.getElementById('wizardEntradasFields').style.display = this.checked ? 'block' : 'none';
                calcularCostosWizard();
            });
            
            // Actualizar c√°lculos al cambiar grados
            document.getElementById('wizardGrados').addEventListener('change', async function() {
                await calcularEstudiantes();
                calcularCostosWizard();
            });
            
            // Actualizar c√°lculos al cambiar destino
            document.getElementById('wizardDestino').addEventListener('change', function() {
                calcularCostosWizard();
            });
            
            // Actualizar c√°lculos al cambiar adultos
            document.getElementById('wizardNumAdultos').addEventListener('input', function() {
                actualizarTotalParticipantes();
                calcularCostosWizard();
            });
            
            // Actualizar c√°lculos al cambiar servicios
            ['wizardMenuRefrigerio', 'wizardCantidadRefrigerios', 'wizardValorEntrada'].forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    calcularCostosWizard();
                });
            });
            
            // B√∫squeda de estudiantes en asistencia
            document.getElementById('buscarEstudiante').addEventListener('input', function() {
                filtrarEstudiantesAsistencia(this.value);
            });
        }
        
        // ==================== CARGAR SALIDAS ====================
        async function cargarSalidas() {
            try {
                showLoading('tablaSalidasBody');
                
                // Construir query con filtros
                let query = '/svc_pedagogical_trips?select=*,svc_pedagogical_trip_grades(grades(grade_id,grade_name)),destination:svc_transport_destinations(destination_name)';
                
                // Aplicar filtros
                if (filtrosActivos.fechaInicio) {
                    query += `&trip_date=gte.${filtrosActivos.fechaInicio}`;
                }
                if (filtrosActivos.fechaFin) {
                    query += `&trip_date=lte.${filtrosActivos.fechaFin}`;
                }
                if (filtrosActivos.estado) {
                    query += `&trip_status=eq.${filtrosActivos.estado}`;
                }
                
                query += '&order=trip_date.desc';
                
                const salidas = await supabaseRequest(query);
                datosGlobales.salidas = salidas || [];
                
                // Filtrar por grados si es necesario (filtro client-side porque es relaci√≥n N:M)
                if (filtrosActivos.grados && filtrosActivos.grados.length > 0) {
                    datosGlobales.salidas = datosGlobales.salidas.filter(salida => {
                        const gradosSalida = salida.svc_pedagogical_trip_grades?.map(g => g.grades?.grade_id).filter(Boolean) || [];
                        return filtrosActivos.grados.some(g => gradosSalida.includes(g));
                    });
                }
                
                renderizarTablaSalidas();
                actualizarContador();
                
            } catch (error) {
                console.error('‚ùå Error cargando salidas:', error);
                showMessage('Error al cargar las salidas', 'danger');
                document.getElementById('tablaSalidasBody').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar datos</td></tr>';
            }
        }
        
        // ==================== RENDERIZAR TABLA ====================
        function renderizarTablaSalidas() {
            const tbody = document.getElementById('tablaSalidasBody');
            
            if (datosGlobales.salidas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No se encontraron salidas pedag√≥gicas</td></tr>';
                return;
            }
            
            const inicio = (currentPage - 1) * itemsPerPage;
            const fin = inicio + itemsPerPage;
            const salidasPagina = datosGlobales.salidas.slice(inicio, fin);
            
            tbody.innerHTML = salidasPagina.map(salida => {
                const grados = salida.svc_pedagogical_trip_grades?.map(g => g.grades?.grade_name).filter(Boolean).join(', ') || 'N/A';
                const destino = salida.destination?.destination_name || 'N/A';
                const badgeEstado = getBadgeEstado(salida.trip_status);
                const acciones = getAccionesSalida(salida);
                
                return `
                    <tr>
                        <td>${formatDate(salida.trip_date)}</td>
                        <td>${grados}</td>
                        <td>${destino}</td>
                        <td>${badgeEstado}</td>
                        <td class="text-center">${salida.actual_students || salida.planned_students}</td>
                        <td class="text-center">${salida.num_adults}</td>
                        <td class="text-end fw-bold">$${formatNumber(salida.total_transport_value + (salida.total_catering_value || 0) + (salida.total_entrance_value || 0))}</td>
                        <td class="text-center">${acciones}</td>
                    </tr>
                `;
            }).join('');
            
            renderizarPaginacion();
        }
        
        // ==================== BADGES DE ESTADO ====================
        function getBadgeEstado(status) {
            const estados = {
                'scheduled': { texto: 'Programaci√≥n', clase: 'bg-primary' },
                'imminent': { texto: 'Inminente', clase: 'bg-warning text-dark' },
                'in_progress': { texto: 'En proceso', clase: 'bg-success' },
                'completed': { texto: 'Realizada', clase: 'bg-secondary' },
                'suspended': { texto: 'Suspendida', clase: 'bg-danger' },
                'cancelled': { texto: 'Cancelada', clase: 'bg-dark' }
            };
            
            const estado = estados[status] || { texto: status, clase: 'bg-secondary' };
            return `<span class="badge ${estado.clase} badge-status">${estado.texto}</span>`;
        }
        
        // ==================== ACCIONES SEG√öN ESTADO ====================
        function getAccionesSalida(salida) {
            const acciones = [];
            
            // Ver detalle (siempre disponible)
            acciones.push(`<button class="btn btn-sm btn-info" onclick="verDetalleSalida('${salida.trip_id}')" title="Ver detalle">
                <i class="bi bi-eye"></i>
            </button>`);
            
            if (salida.trip_status === 'scheduled') {
                // Editar y eliminar
                acciones.push(`<button class="btn btn-sm btn-warning" onclick="editarSalida('${salida.trip_id}')" title="Editar">
                    <i class="bi bi-pencil"></i>
                </button>`);
                acciones.push(`<button class="btn btn-sm btn-danger" onclick="eliminarSalida('${salida.trip_id}')" title="Eliminar">
                    <i class="bi bi-trash"></i>
                </button>`);
            }
            
            if (salida.trip_status === 'imminent') {
                // Registrar asistencia, banderazo, suspender
                acciones.push(`<button class="btn btn-sm btn-success" onclick="abrirAsistencia('${salida.trip_id}')" title="Registrar asistencia">
                    <i class="bi bi-person-check"></i>
                </button>`);
                acciones.push(`<button class="btn btn-sm btn-primary" onclick="mostrarModalBanderazo('${salida.trip_id}')" title="Dar banderazo">
                    <i class="bi bi-flag-fill"></i>
                </button>`);
                acciones.push(`<button class="btn btn-sm btn-danger" onclick="mostrarModalSuspender('${salida.trip_id}')" title="Suspender">
                    <i class="bi bi-x-circle"></i>
                </button>`);
            }
            
            return `<div class="table-actions">${acciones.join('')}</div>`;
        }
        
        // ==================== PAGINACI√ìN ====================
        function renderizarPaginacion() {
            const totalPaginas = Math.ceil(datosGlobales.salidas.length / itemsPerPage);
            const paginacion = document.getElementById('paginacion');
            
            if (totalPaginas <= 1) {
                paginacion.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Anterior
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="cambiarPagina(${currentPage - 1}); return false;">Anterior</a>
            </li>`;
            
            // P√°ginas
            for (let i = 1; i <= totalPaginas; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="cambiarPagina(${i}); return false;">${i}</a>
                </li>`;
            }
            
            // Siguiente
            html += `<li class="page-item ${currentPage === totalPaginas ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="cambiarPagina(${currentPage + 1}); return false;">Siguiente</a>
            </li>`;
            
            paginacion.innerHTML = html;
        }
        
        function cambiarPagina(pagina) {
            const totalPaginas = Math.ceil(datosGlobales.salidas.length / itemsPerPage);
            if (pagina < 1 || pagina > totalPaginas) return;
            
            currentPage = pagina;
            renderizarTablaSalidas();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ==================== FILTROS ====================
        function aplicarFiltros() {
            filtrosActivos = {
                fechaInicio: document.getElementById('filtroFechaInicio').value,
                fechaFin: document.getElementById('filtroFechaFin').value,
                estado: document.getElementById('filtroEstado').value,
                grados: Array.from(document.getElementById('filtroGrado').selectedOptions).map(o => o.value)
            };
            
            currentPage = 1;
            cargarSalidas();
        }
        
        function limpiarFiltros() {
            document.getElementById('formFiltros').reset();
            filtrosActivos = {};
            currentPage = 1;
            cargarSalidas();
        }
        
        function actualizarContador() {
            document.getElementById('contadorResultados').innerHTML = 
                `<i class="bi bi-list-ul me-1"></i>${datosGlobales.salidas.length} salida${datosGlobales.salidas.length !== 1 ? 's' : ''} encontrada${datosGlobales.salidas.length !== 1 ? 's' : ''}`;
        }
        
        // ==================== WIZARD ====================
        function abrirWizardNuevaSalida() {
            // Limpiar estado de edici√≥n
            delete datosGlobales.editandoTripId;
            delete datosGlobales.editandoRequestId;
            
            // Resetear t√≠tulo y bot√≥n
            document.querySelector('#modalWizardSalida .modal-title').textContent = 'Nueva Salida Pedag√≥gica';
            document.getElementById('btnWizardGuardar').innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar y Solicitar Aprobaci√≥n';
            
            // Resetear formulario
            document.getElementById('formWizardSalida').reset();
            currentWizardStep = 1;
            
            // Resetear wizard UI
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            document.querySelectorAll('.wizard-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector('.wizard-step[data-step="1"]').classList.add('active');
            document.querySelector('.wizard-content[data-step="1"]').classList.add('active');
            
            actualizarBotonesWizard();
            actualizarProgressBar();
            
            // Ocultar campos opcionales
            document.getElementById('wizardRefrigeriosFields').style.display = 'none';
            document.getElementById('wizardEntradasFields').style.display = 'none';
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalWizardSalida'));
            modal.show();
        }
        
        function wizardSiguiente() {
            // Validar step actual
            const stepActual = document.querySelector(`.wizard-content[data-step="${currentWizardStep}"]`);
            const camposRequeridos = stepActual.querySelectorAll('[required]');
            let valido = true;
            
            camposRequeridos.forEach(campo => {
                if (!campo.value || (campo.type === 'radio' && !document.querySelector(`input[name="${campo.name}"]:checked`))) {
                    campo.classList.add('is-invalid');
                    valido = false;
                } else {
                    campo.classList.remove('is-invalid');
                }
            });
            
            if (!valido) {
                showMessage('Por favor complete todos los campos requeridos', 'warning');
                return;
            }
            
            // Marcar como completado
            document.querySelector(`.wizard-step[data-step="${currentWizardStep}"]`).classList.add('completed');
            
            // Avanzar
            currentWizardStep++;
            actualizarWizardUI();
        }
        
        function wizardAnterior() {
            if (currentWizardStep > 1) {
                currentWizardStep--;
                actualizarWizardUI();
            }
        }
        
        function actualizarWizardUI() {
            // Actualizar steps
            document.querySelectorAll('.wizard-step').forEach(step => {
                const stepNum = parseInt(step.getAttribute('data-step'));
                step.classList.remove('active');
                if (stepNum === currentWizardStep) {
                    step.classList.add('active');
                }
            });
            
            // Actualizar contenido
            document.querySelectorAll('.wizard-content').forEach(content => {
                const stepNum = parseInt(content.getAttribute('data-step'));
                content.classList.remove('active');
                if (stepNum === currentWizardStep) {
                    content.classList.add('active');
                }
            });
            
            // Si llegamos al √∫ltimo paso, cargar resumen y calcular costos
            if (currentWizardStep === 5) {
                calcularCostosWizard();
            }
            
            actualizarBotonesWizard();
            actualizarProgressBar();
        }
        
        function actualizarBotonesWizard() {
            const btnAnterior = document.getElementById('btnWizardAnterior');
            const btnSiguiente = document.getElementById('btnWizardSiguiente');
            const btnGuardar = document.getElementById('btnWizardGuardar');
            
            btnAnterior.style.display = currentWizardStep === 1 ? 'none' : 'inline-block';
            btnSiguiente.style.display = currentWizardStep === 5 ? 'none' : 'inline-block';
            btnGuardar.style.display = currentWizardStep === 5 ? 'inline-block' : 'none';
        }
        
        function actualizarProgressBar() {
            const progreso = (currentWizardStep / 5) * 100;
            document.getElementById('wizardProgressBar').style.width = progreso + '%';
        }
        
        // ==================== CALCULAR ESTUDIANTES ====================
        async function calcularEstudiantes() {
            const gradosSeleccionados = Array.from(document.getElementById('wizardGrados').selectedOptions).map(o => o.value);
            
            if (gradosSeleccionados.length === 0) {
                document.getElementById('wizardNumEstudiantes').value = 0;
                document.getElementById('wizardDesglosePorGrado').textContent = '';
                actualizarTotalParticipantes();
                return;
            }
            
            try {
                // Obtener cursos de los grados seleccionados
                const cursosQuery = `/courses?select=course_id,grade_id,grade:grades(grade_name)&grade_id=in.(${gradosSeleccionados.join(',')})&course_status=eq.active`;
                const cursos = await supabaseRequest(cursosQuery);
                
                if (!cursos || cursos.length === 0) {
                    document.getElementById('wizardNumEstudiantes').value = 0;
                    document.getElementById('wizardDesglosePorGrado').textContent = 'No hay cursos activos para los grados seleccionados';
                    actualizarTotalParticipantes();
                    return;
                }
                
                // Obtener estudiantes activos de esos cursos (asumiendo status_code 1 = activo)
                const cursosIds = cursos.map(c => c.course_id);
                const estudiantesQuery = `/students?select=student_id,course_id,status:student_status(status_code),course:courses(grade:grades(grade_name))&course_id=in.(${cursosIds.join(',')})`;
                const estudiantesBruto = await supabaseRequest(estudiantesQuery);
                
                // Filtrar solo los activos (status_code = 1)
                const estudiantes = estudiantesBruto.filter(e => e.status?.status_code === 1);
                
                // Contar por grado
                const conteosPorGrado = {};
                estudiantes.forEach(est => {
                    const gradoNombre = est.course.grade.grade_name;
                    conteosPorGrado[gradoNombre] = (conteosPorGrado[gradoNombre] || 0) + 1;
                });
                
                // Actualizar UI
                const total = estudiantes.length;
                document.getElementById('wizardNumEstudiantes').value = total;
                
                const desglose = Object.entries(conteosPorGrado)
                    .map(([grado, cantidad]) => `${grado}: ${cantidad}`)
                    .join(', ');
                document.getElementById('wizardDesglosePorGrado').textContent = 
                    total > 0 ? `Desglose: ${desglose}` : 'No hay estudiantes activos en los grados seleccionados';
                
                actualizarTotalParticipantes();
                
            } catch (error) {
                console.error('Error calculando estudiantes:', error);
                showMessage('Error al calcular estudiantes', 'danger');
            }
        }
        
        function actualizarTotalParticipantes() {
            const estudiantes = parseInt(document.getElementById('wizardNumEstudiantes').value) || 0;
            const adultos = parseInt(document.getElementById('wizardNumAdultos').value) || 0;
            const total = estudiantes + adultos;
            
            document.getElementById('wizardTotalParticipantes').textContent = total;
            
            // Auto-llenar cantidad de refrigerios con el total de participantes
            const cantidadRefrigeriosInput = document.getElementById('wizardCantidadRefrigerios');
            if (cantidadRefrigeriosInput && total > 0) {
                cantidadRefrigeriosInput.value = total;
            }
        }
        
        // ==================== CALCULAR COSTOS WIZARD ====================
        async function calcularCostosWizard() {
            try {
                const totalParticipantes = parseInt(document.getElementById('wizardTotalParticipantes').textContent) || 0;
                const destinoId = document.getElementById('wizardDestino').value;
                
                let costoTransporte = 0;
                let costoRefrigerios = 0;
                let costoEntradas = 0;
                
                // TRANSPORTE - Usar funci√≥n RPC del backend para optimizaci√≥n
                if (destinoId && totalParticipantes > 0) {
                    console.log('üöå Calculando transporte:', {
                        destinoId,
                        totalParticipantes
                    });
                    
                    try {
                        // Llamar a funci√≥n RPC que optimiza el c√°lculo
                        const resultado = await supabaseRequest('/rpc/calculate_transport_cost', {
                            method: 'POST',
                            body: JSON.stringify({
                                destination_id_param: destinoId,
                                total_participants: totalParticipantes
                            })
                        });
                        
                        console.log('üìä Resultado del c√°lculo:', resultado);
                        
                        if (resultado && !resultado.error) {
                            costoTransporte = parseFloat(resultado.total_cost);
                            
                            // Guardar detalle para mostrar en UI y para guardar luego
                            datosGlobales.detalleTransporte = {
                                costoTotal: resultado.total_cost,
                                numeroVehiculos: resultado.vehicle_count,
                                tarifaCongelada: resultado.frozen_rate,
                                capacidadCongelada: resultado.frozen_capacity,
                                vehiculos: resultado.breakdown || []
                            };
                            
                            console.log('‚úÖ Costo transporte calculado:', {
                                costo: costoTransporte,
                                vehiculos: resultado.vehicle_count
                            });
                        } else {
                            console.error('‚ùå Error en c√°lculo de transporte:', resultado.message);
                            showMessage(resultado.message || 'Error al calcular costo de transporte', 'warning');
                            datosGlobales.detalleTransporte = null;
                        }
                    } catch (error) {
                        console.error('‚ùå Error llamando a calculate_transport_cost:', error);
                        showMessage('Error al calcular costo de transporte', 'danger');
                        datosGlobales.detalleTransporte = null;
                    }
                } else {
                    console.log('‚ÑπÔ∏è Transporte no calculado:', {
                        destinoId: destinoId || 'NO SELECCIONADO',
                        totalParticipantes
                    });
                    datosGlobales.detalleTransporte = null;
                }
                
                // REFRIGERIOS
                if (document.getElementById('wizardIncluirRefrigerios').checked) {
                    const menuSelect = document.getElementById('wizardMenuRefrigerio');
                    const cantidad = parseInt(document.getElementById('wizardCantidadRefrigerios').value) || 0;
                    
                    if (menuSelect.value && cantidad > 0) {
                        const precioUnitario = parseFloat(menuSelect.selectedOptions[0].getAttribute('data-price'));
                        costoRefrigerios = precioUnitario * cantidad;
                    }
                }
                
                // ENTRADAS
                if (document.getElementById('wizardIncluirEntradas').checked) {
                    const valorEntrada = parseFloat(document.getElementById('wizardValorEntrada').value) || 0;
                    if (valorEntrada > 0 && totalParticipantes > 0) {
                        costoEntradas = valorEntrada * totalParticipantes;
                    }
                }
                
                const costoTotal = costoTransporte + costoRefrigerios + costoEntradas;
                
                // Actualizar UI
                document.getElementById('wizardCostoTransporte').textContent = '$' + formatNumber(costoTransporte);
                
                // Mostrar detalle de veh√≠culos si hay informaci√≥n
                const detalleContainer = document.getElementById('detalleVehiculosContainer');
                if (datosGlobales.detalleTransporte && datosGlobales.detalleTransporte.vehiculos && datosGlobales.detalleTransporte.vehiculos.length > 0) {
                    const detalle = datosGlobales.detalleTransporte;
                    let detalleHTML = `<div style="margin-top: 5px; padding: 5px; background: #f8f9fa; border-radius: 4px;">`;
                    detalleHTML += `<i class="bi bi-bus-front me-1"></i><strong>${detalle.numeroVehiculos} veh√≠culo${detalle.numeroVehiculos > 1 ? 's' : ''} requerido${detalle.numeroVehiculos > 1 ? 's' : ''}:</strong><br>`;
                    detalle.vehiculos.forEach((v) => {
                        detalleHTML += `<span style="display: block; margin-left: 15px; font-size: 0.9em;">‚Ä¢ Veh√≠culo ${v.vehicle_number}: ${v.passengers} pasajeros (cap. ${v.capacity_range}) = $${formatNumber(v.rate_value)}</span>`;
                    });
                    detalleHTML += `</div>`;
                    detalleContainer.innerHTML = detalleHTML;
                    detalleContainer.style.display = 'block';
                } else {
                    detalleContainer.style.display = 'none';
                }
                
                document.getElementById('wizardCostoRefrigerios').textContent = '$' + formatNumber(costoRefrigerios);
                document.getElementById('wizardCostoEntradas').textContent = '$' + formatNumber(costoEntradas);
                document.getElementById('wizardCostoTotal').textContent = '$' + formatNumber(costoTotal);
                
            } catch (error) {
                console.error('Error calculando costos:', error);
            }
        }
        
        // ==================== NOTIFICACIONES ====================
        
        /**
         * Env√≠a notificaci√≥n por email al aprobador de una salida pedag√≥gica
         */
        async function enviarNotificacionAprobador(tripId, requestId, aprobadorId, datosSalida) {
            try {
                console.log('üìß Enviando notificaci√≥n al aprobador...');
                
                // Obtener datos del aprobador
                const aprobador = datosGlobales.aprobadores.find(a => a.worker_id === aprobadorId);
                if (!aprobador || !aprobador.email) {
                    console.warn('‚ö†Ô∏è No se encontr√≥ email del aprobador');
                    return false;
                }
                
                // Obtener datos del solicitante
                const solicitante = `${currentUser.user_display_name || currentUser.user_name}`;
                
                // Obtener nombre del destino
                const destino = datosGlobales.destinos.find(d => d.destination_id === datosSalida.p_destino_id);
                const nombreDestino = destino ? destino.destination_name : 'Destino no especificado';
                
                // Obtener nombres de grados
                const nombresGrados = datosSalida.p_grados.map(gId => {
                    const grado = datosGlobales.grados.find(g => g.grade_id === gId);
                    return grado ? grado.grade_name : gId;
                }).join(', ');
                
                // Formatear fecha
                const fechaFormateada = new Date(datosSalida.p_fecha + 'T00:00:00').toLocaleDateString('es-CO', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Construir HTML del email
                const asunto = `Nueva Solicitud: Salida Pedag√≥gica - ${nombreDestino}`;
                
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;">
                        <div style="background-color: #1b365d; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                            <h1 style="margin: 0; font-size: 24px;">Nueva Solicitud de Salida Pedag√≥gica</h1>
                        </div>
                        
                        <div style="background-color: white; padding: 30px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <p style="font-size: 16px; color: #333; margin-bottom: 20px;">
                                Estimado/a <strong>${aprobador.worker_first_name} ${aprobador.worker_last_name_1}</strong>,
                            </p>
                            
                            <p style="font-size: 14px; color: #666; margin-bottom: 25px;">
                                Se ha creado una nueva solicitud de salida pedag√≥gica que requiere su aprobaci√≥n:
                            </p>
                            
                            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 25px;">
                                <h3 style="color: #1b365d; margin-top: 0; margin-bottom: 15px; font-size: 18px;">Detalles de la Salida</h3>
                                
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Destino:</td>
                                        <td style="padding: 8px 0; color: #333;">${nombreDestino}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Fecha:</td>
                                        <td style="padding: 8px 0; color: #333;">${fechaFormateada}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Horario:</td>
                                        <td style="padding: 8px 0; color: #333;">${datosSalida.p_hora_salida} - ${datosSalida.p_hora_regreso}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Grados:</td>
                                        <td style="padding: 8px 0; color: #333;">${nombresGrados}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Estudiantes:</td>
                                        <td style="padding: 8px 0; color: #333;">${datosSalida.p_num_estudiantes} estudiantes</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Adultos:</td>
                                        <td style="padding: 8px 0; color: #333;">${datosSalida.p_num_adultos} adultos acompa√±antes</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px 0; color: #666; font-weight: bold;">Solicitado por:</td>
                                        <td style="padding: 8px 0; color: #333;">${solicitante}</td>
                                    </tr>
                                </table>
                                
                                ${datosSalida.p_descripcion ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                                    <p style="color: #666; font-weight: bold; margin-bottom: 5px;">Descripci√≥n:</p>
                                    <p style="color: #333; margin: 0;">${datosSalida.p_descripcion}</p>
                                </div>
                                ` : ''}
                                
                                ${datosSalida.p_unidad_indagacion ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                                    <p style="color: #666; font-weight: bold; margin-bottom: 5px;">Unidad de Indagaci√≥n:</p>
                                    <p style="color: #333; margin: 0;">${datosSalida.p_unidad_indagacion}</p>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div style="text-align: center; margin-top: 30px; padding: 20px; background-color: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                                <p style="margin: 0; color: #856404; font-size: 14px;">
                                    <strong>Para revisar y aprobar esta solicitud:</strong><br>
                                    Ingrese a <strong>SchoolNet</strong> y vaya al m√≥dulo de <strong>Salidas Pedag√≥gicas</strong>
                                </p>
                            </div>
                            
                            <p style="font-size: 12px; color: #999; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center;">
                                Este es un mensaje autom√°tico del sistema SchoolNet.<br>
                                Por favor, no responder a este correo.
                            </p>
                        </div>
                    </div>
                `;
                
                // Enviar notificaci√≥n usando la funci√≥n global de config.js
                const resultado = await sendNotification(aprobador.email, asunto, htmlContent, true);
                
                if (resultado) {
                    console.log('‚úÖ Notificaci√≥n enviada al aprobador:', aprobador.email);
                } else {
                    console.warn('‚ö†Ô∏è No se pudo enviar la notificaci√≥n al aprobador');
                }
                
                return resultado;
                
            } catch (error) {
                console.error('‚ùå Error enviando notificaci√≥n:', error);
                return false;
            }
        }
        
        // ==================== GUARDAR NUEVA SALIDA ====================
        async function guardarNuevaSalida() {
            try {
                showLoading('btnWizardGuardar');
                
                // Detectar si est√° editando o creando
                if (datosGlobales.editandoTripId) {
                    await actualizarSalidaExistente();
                } else {
                    await crearNuevaSalida();
                }
                
            } catch (error) {
                console.error('‚ùå Error guardando salida:', error);
                showMessage('Error al guardar la salida: ' + error.message, 'danger');
            } finally {
                hideLoading('btnWizardGuardar');
            }
        }
        
        async function crearNuevaSalida() {
            // Validar campos requeridos
            const gradosSeleccionados = Array.from(document.getElementById('wizardGrados').selectedOptions).map(o => o.value);
            const destinoId = document.getElementById('wizardDestino').value;
            const fecha = document.getElementById('wizardFecha').value;
            const horaSalida = document.getElementById('wizardHoraSalida').value;
            const horaRegreso = document.getElementById('wizardHoraRegreso').value;
            const modalidadElement = document.querySelector('input[name="wizardModalidad"]:checked');
            const aprobadorId = document.getElementById('wizardAprobador').value;
            
            if (gradosSeleccionados.length === 0 || !destinoId || !fecha || !horaSalida || !horaRegreso || !modalidadElement || !aprobadorId) {
                showMessage('Por favor complete todos los campos requeridos', 'warning');
                return;
            }
            
            // Obtener datos de refrigerios
                const incluirRefrigerios = document.getElementById('wizardIncluirRefrigerios').checked;
                let menuId = null;
                let cantidadRefrigerios = null;
                let precioUnitarioRefrigerio = null;
                let costoRefrigerios = 0;
                
                if (incluirRefrigerios) {
                    const menuSelect = document.getElementById('wizardMenuRefrigerio');
                    menuId = menuSelect.value;
                    cantidadRefrigerios = parseInt(document.getElementById('wizardCantidadRefrigerios').value) || 0;
                    precioUnitarioRefrigerio = menuSelect.selectedOptions[0] ? parseFloat(menuSelect.selectedOptions[0].getAttribute('data-price')) : 0;
                    costoRefrigerios = precioUnitarioRefrigerio * cantidadRefrigerios;
                }
                
                // Obtener datos de entradas
                const incluirEntradas = document.getElementById('wizardIncluirEntradas').checked;
                let valorEntrada = null;
                let costoEntradas = 0;
                
                if (incluirEntradas) {
                    valorEntrada = parseFloat(document.getElementById('wizardValorEntrada').value) || 0;
                    const totalParticipantes = parseInt(document.getElementById('wizardTotalParticipantes').textContent) || 0;
                    costoEntradas = valorEntrada * totalParticipantes;
                }
                
                // Obtener datos de transporte del c√°lculo previo
                const detalleTransporte = datosGlobales.detalleTransporte || {};
                const costoTransporte = detalleTransporte.costoTotal || 0;
                const tarifaCongelada = detalleTransporte.tarifaCongelada || 0;
                const capacidadCongelada = detalleTransporte.capacidadCongelada || 0;
                const numVehiculos = detalleTransporte.numeroVehiculos || 0;
                
                // Preparar datos para enviar (orden correcto: obligatorios primero, opcionales despu√©s)
                const datosFormulario = {
                    // ============ OBLIGATORIOS ============
                    // Informaci√≥n general
                    p_fecha: fecha,
                    p_hora_salida: horaSalida,
                    p_hora_regreso: horaRegreso,
                    p_destino_id: destinoId,
                    p_descripcion: document.getElementById('wizardDescripcion').value || '',
                    p_unidad_indagacion: document.getElementById('wizardUnidadIndagacion').value || '',
                    p_observaciones: document.getElementById('wizardObservaciones').value || '',
                    
                    // Participantes
                    p_grados: gradosSeleccionados,
                    p_num_estudiantes: parseInt(document.getElementById('wizardNumEstudiantes').value) || 0,
                    p_num_adultos: parseInt(document.getElementById('wizardNumAdultos').value) || 0,
                    p_adultos_nombres: document.getElementById('wizardAdultosNombres').value || '',
                    
                    // Modalidad
                    p_modalidad: modalidadElement.value,
                    
                    // Transporte
                    p_costo_transporte: costoTransporte,
                    p_tarifa_congelada: tarifaCongelada,
                    p_capacidad_congelada: capacidadCongelada,
                    p_num_vehiculos: numVehiculos,
                    
                    // Flags
                    p_incluir_refrigerios: incluirRefrigerios,
                    p_incluir_entradas: incluirEntradas,
                    
                    // Aprobaci√≥n
                    p_aprobador_id: aprobadorId,
                    
                    // Usuario actual
                    p_user_id: currentUser.user_id,
                    
                    // ============ OPCIONALES (con DEFAULT) ============
                    // Refrigerios
                    p_menu_id: menuId,
                    p_cantidad_refrigerios: cantidadRefrigerios,
                    p_precio_unitario_refrigerio: precioUnitarioRefrigerio,
                    p_costo_refrigerios: costoRefrigerios,
                    
                    // Entradas
                    p_valor_entrada: valorEntrada,
                    p_costo_entradas: costoEntradas,
                    
                    // Comentarios
                    p_comentarios: document.getElementById('wizardComentarios').value || null
                };
                
                console.log('üì§ Enviando datos de salida:', datosFormulario);
                
                // Enviar al backend
                const resultado = await supabaseRequest('/rpc/create_pedagogical_trip', {
                    method: 'POST',
                    body: JSON.stringify(datosFormulario)
                });
                
                console.log('üì• Respuesta del backend:', resultado);
                
                if (resultado && resultado.success) {
                    showMessage('‚úÖ ' + resultado.message, 'success');
                    
                    // Enviar notificaci√≥n al aprobador
                    await enviarNotificacionAprobador(resultado.trip_id, resultado.request_id, aprobadorId, datosFormulario);
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalWizardSalida'));
                    if (modal) modal.hide();
                    
                    // Limpiar formulario
                    const formulario = document.getElementById('formWizardSalida');
                    if (formulario) formulario.reset();
                    
                    // Recargar tabla
                    await cargarSalidas();
                } else {
                    throw new Error(resultado?.error || 'No se recibi√≥ respuesta del servidor');
                }
                
            } catch (error) {
                console.error('‚ùå Error guardando salida:', error);
                showMessage('Error al guardar la salida: ' + error.message, 'danger');
            } finally {
                hideLoading('btnWizardGuardar');
            }
        }
        
        async function actualizarSalidaExistente() {
            const tripId = datosGlobales.editandoTripId;
            const requestId = datosGlobales.editandoRequestId;
            
            if (!tripId) {
                throw new Error('ID de salida no encontrado');
            }
            
            // Recopilar datos del formulario
            const gradosSeleccionados = Array.from(document.getElementById('wizardGrados').selectedOptions).map(o => o.value);
            const destinoId = document.getElementById('wizardDestino').value;
            const fecha = document.getElementById('wizardFecha').value;
            const horaSalida = document.getElementById('wizardHoraSalida').value;
            const horaRegreso = document.getElementById('wizardHoraRegreso').value;
            const modalidadElement = document.querySelector('input[name="wizardModalidad"]:checked');
            const aprobadorId = document.getElementById('wizardAprobador').value;
            
            if (gradosSeleccionados.length === 0 || !destinoId || !fecha || !horaSalida || !horaRegreso || !modalidadElement || !aprobadorId) {
                showMessage('Por favor complete todos los campos requeridos', 'warning');
                return;
            }
            
            // Obtener datos de refrigerios
            const incluirRefrigerios = document.getElementById('wizardIncluirRefrigerios').checked;
            let menuId = null;
            let cantidadRefrigerios = null;
            let precioUnitarioRefrigerio = null;
            let costoRefrigerios = 0;
            
            if (incluirRefrigerios) {
                const menuSelect = document.getElementById('wizardMenuRefrigerio');
                menuId = menuSelect.value;
                cantidadRefrigerios = parseInt(document.getElementById('wizardCantidadRefrigerios').value) || 0;
                precioUnitarioRefrigerio = menuSelect.selectedOptions[0] ? parseFloat(menuSelect.selectedOptions[0].getAttribute('data-price')) : 0;
                costoRefrigerios = precioUnitarioRefrigerio * cantidadRefrigerios;
            }
            
            // Obtener datos de entradas
            const incluirEntradas = document.getElementById('wizardIncluirEntradas').checked;
            let valorEntrada = null;
            let costoEntradas = 0;
            
            if (incluirEntradas) {
                valorEntrada = parseFloat(document.getElementById('wizardValorEntrada').value) || 0;
                const totalParticipantes = parseInt(document.getElementById('wizardTotalParticipantes').textContent) || 0;
                costoEntradas = valorEntrada * totalParticipantes;
            }
            
            // Obtener datos de transporte
            const detalleTransporte = datosGlobales.detalleTransporte || {};
            const costoTransporte = detalleTransporte.costoTotal || 0;
            const tarifaCongelada = detalleTransporte.tarifaCongelada || 0;
            const capacidadCongelada = detalleTransporte.capacidadCongelada || 0;
            const numVehiculos = detalleTransporte.numeroVehiculos || 0;
            
            console.log('üì§ Actualizando salida:', tripId);
            
            // 1. Actualizar la salida pedag√≥gica
            await supabaseRequest(`/svc_pedagogical_trips?trip_id=eq.${tripId}`, {
                method: 'PATCH',
                body: JSON.stringify({
                    trip_date: fecha,
                    departure_time: horaSalida,
                    return_time: horaRegreso,
                    destination_id: destinoId,
                    trip_description: document.getElementById('wizardDescripcion').value || null,
                    accompanying_adults: document.getElementById('wizardAdultosNombres').value || null,
                    inquiry_unit: document.getElementById('wizardUnidadIndagacion').value || null,
                    observations: document.getElementById('wizardObservaciones').value || null,
                    num_adults: parseInt(document.getElementById('wizardNumAdultos').value) || 0,
                    planned_students: parseInt(document.getElementById('wizardNumEstudiantes').value) || 0,
                    transport_modality: modalidadElement.value,
                    frozen_transport_rate: tarifaCongelada,
                    frozen_vehicle_capacity: capacidadCongelada,
                    frozen_vehicle_count: numVehiculos,
                    total_transport_value: costoTransporte,
                    catering_menu_id: incluirRefrigerios ? menuId : null,
                    catering_quantity: incluirRefrigerios ? cantidadRefrigerios : null,
                    frozen_catering_unit_price: incluirRefrigerios ? precioUnitarioRefrigerio : null,
                    total_catering_value: incluirRefrigerios ? costoRefrigerios : 0,
                    entrance_unit_value: incluirEntradas ? valorEntrada : null,
                    total_entrance_value: incluirEntradas ? costoEntradas : 0,
                    updated_at: new Date().toISOString()
                })
            });
            
            // 2. Actualizar grados asociados (eliminar y recrear)
            await supabaseRequest(`/svc_pedagogical_trip_grades?trip_id=eq.${tripId}`, {
                method: 'DELETE'
            });
            
            for (const gradeId of gradosSeleccionados) {
                await supabaseRequest('/svc_pedagogical_trip_grades', {
                    method: 'POST',
                    body: JSON.stringify({
                        trip_id: tripId,
                        grade_id: gradeId
                    })
                });
            }
            
            // 3. Actualizar aprobador en la solicitud (si cambi√≥)
            if (requestId) {
                await supabaseRequest(`/svc_service_requests?request_id=eq.${requestId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        approver_id: aprobadorId,
                        updated_at: new Date().toISOString()
                    })
                });
            }
            
            showMessage('‚úÖ Salida pedag√≥gica actualizada exitosamente', 'success');
            
            // Limpiar estado de edici√≥n
            delete datosGlobales.editandoTripId;
            delete datosGlobales.editandoRequestId;
            
            // Cerrar modal y limpiar
            cerrarYLimpiarWizard();
            
            // Recargar tabla
            await cargarSalidas();
        }
        
        function cerrarYLimpiarWizard() {
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalWizardSalida'));
            if (modal) modal.hide();
            
            // Limpiar formulario
            const formulario = document.getElementById('formWizardSalida');
            if (formulario) formulario.reset();
            
            // Resetear t√≠tulo y bot√≥n
            document.querySelector('#modalWizardSalida .modal-title').textContent = 'Nueva Salida Pedag√≥gica';
            document.getElementById('btnWizardGuardar').innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar y Solicitar Aprobaci√≥n';
            
            // Limpiar estado de edici√≥n
            delete datosGlobales.editandoTripId;
            delete datosGlobales.editandoRequestId;
        }
        
        // ==================== ASISTENCIA ====================
        async function abrirAsistencia(tripId) {
            try {
                // Obtener datos de la salida
                const salida = await supabaseRequest(`/svc_pedagogical_trips?select=*,grades:svc_pedagogical_trip_grades(grade:grades(grade_name)),destination:svc_transport_destinations(destination_name)&trip_id=eq.${tripId}`);
                
                if (!salida || salida.length === 0) {
                    throw new Error('No se encontr√≥ la salida');
                }
                
                const datosSalida = salida[0];
                
                // Actualizar header
                document.getElementById('asistenciaTituloSalida').textContent = 
                    datosSalida.destination?.destination_name || 'Salida Pedag√≥gica';
                document.getElementById('asistenciaInfoSalida').textContent = 
                    `${formatDate(datosSalida.trip_date)} ‚Ä¢ ${datosSalida.grades.map(g => g.grade.grade_name).join(', ')}`;
                
                // Obtener estudiantes con su estado de asistencia
                const estudiantesQuery = `/rpc/get_pedagogical_trip_students?trip_id_param=${tripId}`;
                const estudiantes = await supabaseRequest(estudiantesQuery);
                
                // Renderizar lista
                renderizarListaAsistencia(estudiantes, tripId);
                
                // Actualizar resumen
                const confirmados = estudiantes.filter(e => e.is_attending).length;
                const desvinculados = estudiantes.length - confirmados;
                
                document.getElementById('asistenciaPlaneados').textContent = estudiantes.length;
                document.getElementById('asistenciaConfirmados').textContent = confirmados;
                document.getElementById('asistenciaDesvinculados').textContent = desvinculados;
                
                // Abrir offcanvas
                const offcanvas = new bootstrap.Offcanvas(document.getElementById('offcanvasAsistencia'));
                offcanvas.show();
                
            } catch (error) {
                console.error('Error abriendo asistencia:', error);
                showMessage('Error al cargar la asistencia', 'danger');
            }
        }
        
        function renderizarListaAsistencia(estudiantes, tripId) {
            const lista = document.getElementById('listaEstudiantesAsistencia');
            
            if (estudiantes.length === 0) {
                lista.innerHTML = '<div class="text-center text-muted py-4">No hay estudiantes registrados</div>';
                return;
            }
            
            // Agrupar por curso
            const porCurso = {};
            estudiantes.forEach(est => {
                const curso = est.course_name || 'Sin curso';
                if (!porCurso[curso]) porCurso[curso] = [];
                porCurso[curso].push(est);
            });
            
            let html = '';
            Object.keys(porCurso).sort().forEach(curso => {
                html += `
                    <div class="mb-3">
                        <div class="fw-bold text-primary mb-2">${curso}</div>
                        ${porCurso[curso].map(est => `
                            <div class="student-item list-group-item ${!est.is_attending ? 'unlinked' : ''}" data-student-id="${est.student_id}">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="student_${est.student_id}" 
                                           ${est.is_attending ? 'checked' : ''}
                                           ${!est.is_attending ? 'disabled' : ''}
                                           onchange="toggleSeleccionEstudiante()">
                                    <label class="form-check-label" for="student_${est.student_id}">
                                        ${est.first_name} ${est.last_name}
                                        ${!est.is_attending ? '<span class="badge bg-warning ms-2">Desvinculado</span>' : ''}
                                    </label>
                                </div>
                                ${!est.is_attending && est.unlinked_reason ? `
                                    <small class="text-muted d-block mt-1 ms-4">${est.unlinked_reason}</small>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            lista.innerHTML = html;
            lista.setAttribute('data-trip-id', tripId);
        }
        
        function toggleSeleccionEstudiante() {
            const checkboxes = document.querySelectorAll('.student-item input[type="checkbox"]:not(:disabled)');
            const seleccionados = Array.from(checkboxes).filter(cb => !cb.checked);
            
            document.getElementById('btnDesvincularSeleccionados').disabled = seleccionados.length === 0;
        }
        
        function filtrarEstudiantesAsistencia(texto) {
            const items = document.querySelectorAll('.student-item');
            const textoBusqueda = texto.toLowerCase();
            
            items.forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.style.display = label.includes(textoBusqueda) ? '' : 'none';
            });
        }
        
        async function desvincularSeleccionados() {
            const checkboxes = document.querySelectorAll('.student-item input[type="checkbox"]:not(:disabled):not(:checked)');
            const estudiantesIds = Array.from(checkboxes).map(cb => cb.id.replace('student_', ''));
            
            if (estudiantesIds.length === 0) return;
            
            // Pedir raz√≥n
            let razon;
            
            if (typeof Swal !== 'undefined') {
                const { value } = await Swal.fire({
                    title: '¬øRaz√≥n de desvinculaci√≥n?',
                    input: 'textarea',
                    inputLabel: 'Motivo',
                    inputPlaceholder: 'Ejemplo: No present√≥ autorizaci√≥n, No asisti√≥...',
                    inputValidator: (value) => {
                        if (!value) return '¬°Debe especificar una raz√≥n!';
                    }
                });
                
                if (!value) return;
                razon = value;
            } else {
                // Fallback a prompt
                razon = prompt('Raz√≥n de desvinculaci√≥n:\n(Ejemplo: No present√≥ autorizaci√≥n, No asisti√≥...)');
                if (!razon || razon.trim() === '') {
                    alert('Debe especificar una raz√≥n');
                    return;
                }
            }
            
            try {
                const tripId = document.getElementById('listaEstudiantesAsistencia').getAttribute('data-trip-id');
                
                await supabaseRequest('/rpc/unlink_students_from_trip', {
                    method: 'POST',
                    body: JSON.stringify({
                        trip_id_param: tripId,
                        student_ids: estudiantesIds,
                        reason: razon
                    })
                });
                
                showMessage('Estudiantes desvinculados correctamente', 'success');
                abrirAsistencia(tripId); // Recargar
                
            } catch (error) {
                console.error('Error desvinculando estudiantes:', error);
                showMessage('Error al desvincular estudiantes', 'danger');
            }
        }
        
        // ==================== BANDERAZO ====================
        function mostrarModalBanderazo(tripId) {
            document.getElementById('banderazoTripId').value = tripId;
            const modal = new bootstrap.Modal(document.getElementById('modalBanderazo'));
            modal.show();
        }
        
        async function confirmarBanderazo() {
            const tripId = document.getElementById('banderazoTripId').value;
            
            try {
                await supabaseRequest('/rpc/start_trip', {
                    method: 'POST',
                    body: JSON.stringify({ trip_id_param: tripId })
                });
                
                showMessage('¬°Banderazo dado! La salida est√° en proceso', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalBanderazo')).hide();
                await cargarSalidas();
                
            } catch (error) {
                console.error('Error dando banderazo:', error);
                showMessage('Error al cambiar estado', 'danger');
            }
        }
        
        // ==================== SUSPENDER ====================
        function mostrarModalSuspender(tripId) {
            document.getElementById('suspenderTripId').value = tripId;
            document.getElementById('formSuspender').reset();
            const modal = new bootstrap.Modal(document.getElementById('modalSuspender'));
            modal.show();
        }
        
        async function confirmarSuspension() {
            const tripId = document.getElementById('suspenderTripId').value;
            const razonSelect = document.getElementById('suspenderRazonSelect').value;
            const razonDetalle = document.getElementById('suspenderRazonDetalle').value;
            
            if (!razonDetalle) {
                showMessage('Debe especificar los detalles de la suspensi√≥n', 'warning');
                return;
            }
            
            const razonCompleta = razonSelect ? 
                `${razonSelect}: ${razonDetalle}` : razonDetalle;
            
            try {
                await supabaseRequest('/rpc/suspend_trip', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        trip_id_param: tripId,
                        reason: razonCompleta
                    })
                });
                
                showMessage('Salida suspendida correctamente', 'info');
                bootstrap.Modal.getInstance(document.getElementById('modalSuspender')).hide();
                await cargarSalidas();
                
            } catch (error) {
                console.error('Error suspendiendo salida:', error);
                showMessage('Error al suspender la salida', 'danger');
            }
        }
        
        // ==================== UTILIDADES ====================
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function formatNumber(num) {
            return new Intl.NumberFormat('es-CO').format(num);
        }
        
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element.tagName === 'TBODY') {
                element.innerHTML = '<tr><td colspan="8" class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary me-2"></div>Cargando...</td></tr>';
            } else {
                element.disabled = true;
                element.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
            }
        }
        
        function hideLoading(elementId, originalContent) {
            const element = document.getElementById(elementId);
            element.disabled = false;
            element.innerHTML = originalContent;
        }
        
        function showMessage(message, type = 'info') {
            // Usar toasts de Bootstrap o SweetAlert si est√° disponible
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: type === 'danger' ? 'error' : type,
                    title: message,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
            } else if (typeof showToast === 'function') {
                // Usar funci√≥n de config.js si est√° disponible
                showToast(message, type);
            } else {
                // Fallback a console y alert
                console.log(`[${type.toUpperCase()}] ${message}`);
                if (type === 'danger' || type === 'error') {
                    alert(`‚ùå Error: ${message}`);
                } else if (type === 'warning') {
                    alert(`‚ö†Ô∏è Advertencia: ${message}`);
                } else if (type === 'success') {
                    console.log('‚úÖ ' + message);
                }
            }
        }
        
        // Funciones placeholder (se implementar√°n seg√∫n necesidad)
        async function verDetalleSalida(tripId) {
            try {
                console.log('üìã Ver detalle:', tripId);
                
                // Obtener detalles completos de la salida
                const salida = await supabaseRequest(`/svc_pedagogical_trips?select=*,svc_pedagogical_trip_grades(grades(grade_id,grade_name)),destination:svc_transport_destinations(destination_name,destination_address),menu:svc_catering_menus(menu_name,unit_price),request:svc_service_requests(request_status,approver_id,approver:workers!svc_service_requests_approver_fkey(worker_first_name,worker_last_name_1))&trip_id=eq.${tripId}`);
                
                if (!salida || salida.length === 0) {
                    throw new Error('No se encontr√≥ la salida');
                }
                
                const datos = salida[0];
                
                // Formatear fecha
                const fecha = new Date(datos.trip_date + 'T00:00:00').toLocaleDateString('es-CO', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Obtener grados
                const grados = datos.svc_pedagogical_trip_grades.map(g => g.grades.grade_name).join(', ');
                
                // Obtener aprobador
                const aprobador = datos.request?.approver ? 
                    `${datos.request.approver.worker_first_name} ${datos.request.approver.worker_last_name_1}` : 
                    'No especificado';
                
                // Estado de la solicitud
                const estadoSolicitud = datos.request?.request_status || 'pending';
                const estadoBadge = {
                    'pending': '<span class="badge bg-warning">Pendiente</span>',
                    'approved': '<span class="badge bg-success">Aprobada</span>',
                    'rejected': '<span class="badge bg-danger">Rechazada</span>'
                }[estadoSolicitud] || '<span class="badge bg-secondary">Desconocido</span>';
                
                // Estado de la salida
                const estadoSalida = {
                    'scheduled': '<span class="badge bg-info">Programada</span>',
                    'imminent': '<span class="badge bg-warning">Inminente</span>',
                    'in_progress': '<span class="badge bg-primary">En progreso</span>',
                    'completed': '<span class="badge bg-success">Completada</span>',
                    'suspended': '<span class="badge bg-danger">Suspendida</span>',
                    'cancelled': '<span class="badge bg-secondary">Cancelada</span>'
                }[datos.trip_status] || '<span class="badge bg-secondary">Desconocido</span>';
                
                // Construir HTML del modal
                const detalleHTML = `
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Destino:</strong><br>
                            ${datos.destination?.destination_name || 'No especificado'}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Fecha:</strong><br>
                            ${fecha}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Horario:</strong><br>
                            ${datos.departure_time} - ${datos.return_time}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Modalidad:</strong><br>
                            ${datos.transport_modality === 'round_trip' ? 'Ida y vuelta' : datos.transport_modality === 'outbound' ? 'Solo ida' : 'Solo vuelta'}
                        </div>
                        <div class="col-md-12 mb-3">
                            <strong>Grados:</strong><br>
                            ${grados}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Estudiantes planeados:</strong><br>
                            ${datos.planned_students}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Adultos acompa√±antes:</strong><br>
                            ${datos.num_adults}
                        </div>
                        ${datos.accompanying_adults ? `
                        <div class="col-md-12 mb-3">
                            <strong>Nombres de adultos:</strong><br>
                            ${datos.accompanying_adults}
                        </div>
                        ` : ''}
                        ${datos.trip_description ? `
                        <div class="col-md-12 mb-3">
                            <strong>Descripci√≥n:</strong><br>
                            ${datos.trip_description}
                        </div>
                        ` : ''}
                        ${datos.inquiry_unit ? `
                        <div class="col-md-12 mb-3">
                            <strong>Unidad de Indagaci√≥n:</strong><br>
                            ${datos.inquiry_unit}
                        </div>
                        ` : ''}
                        ${datos.observations ? `
                        <div class="col-md-12 mb-3">
                            <strong>Observaciones:</strong><br>
                            ${datos.observations}
                        </div>
                        ` : ''}
                        
                        <div class="col-md-12 mb-3">
                            <hr>
                            <h6>Costos</h6>
                        </div>
                        
                        <div class="col-md-6 mb-2">
                            <strong>Transporte:</strong><br>
                            $${formatNumber(datos.total_transport_value || 0)}
                            ${datos.frozen_vehicle_count ? `<small class="text-muted">(${datos.frozen_vehicle_count} veh√≠culo${datos.frozen_vehicle_count > 1 ? 's' : ''})</small>` : ''}
                        </div>
                        <div class="col-md-6 mb-2">
                            <strong>Refrigerios:</strong><br>
                            $${formatNumber(datos.total_catering_value || 0)}
                            ${datos.catering_quantity ? `<small class="text-muted">(${datos.catering_quantity} unidades)</small>` : ''}
                        </div>
                        <div class="col-md-6 mb-2">
                            <strong>Entradas:</strong><br>
                            $${formatNumber(datos.total_entrance_value || 0)}
                        </div>
                        <div class="col-md-6 mb-2">
                            <strong class="text-primary">TOTAL:</strong><br>
                            <strong class="text-primary">$${formatNumber((datos.total_transport_value || 0) + (datos.total_catering_value || 0) + (datos.total_entrance_value || 0))}</strong>
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <hr>
                            <h6>Estado de Aprobaci√≥n</h6>
                        </div>
                        
                        <div class="col-md-6 mb-2">
                            <strong>Estado de solicitud:</strong><br>
                            ${estadoBadge}
                        </div>
                        <div class="col-md-6 mb-2">
                            <strong>Estado de salida:</strong><br>
                            ${estadoSalida}
                        </div>
                        <div class="col-md-12 mb-2">
                            <strong>Aprobador asignado:</strong><br>
                            ${aprobador}
                        </div>
                    </div>
                `;
                
                // Mostrar en modal usando SweetAlert2
                Swal.fire({
                    title: 'Detalle de Salida Pedag√≥gica',
                    html: detalleHTML,
                    width: '800px',
                    showCloseButton: true,
                    confirmButtonText: 'Cerrar',
                    confirmButtonColor: '#1b365d'
                });
                
            } catch (error) {
                console.error('‚ùå Error cargando detalle:', error);
                showMessage('Error al cargar detalle: ' + error.message, 'danger');
            }
        }
        
        async function editarSalida(tripId) {
            try {
                console.log('‚úèÔ∏è Editar salida:', tripId);
                
                // Obtener datos completos de la salida
                const salida = await supabaseRequest(`/svc_pedagogical_trips?select=*,svc_pedagogical_trip_grades(grades(grade_id,grade_name)),destination:svc_transport_destinations(destination_id,destination_name),menu:svc_catering_menus(menu_id,menu_name,unit_price),request:svc_service_requests(request_id,request_status,approver_id,approver:workers!svc_service_requests_approver_fkey(worker_id,worker_first_name,worker_last_name_1))&trip_id=eq.${tripId}`);
                
                if (!salida || salida.length === 0) {
                    throw new Error('No se encontr√≥ la salida');
                }
                
                const datos = salida[0];
                
                // Verificar que la salida pueda editarse
                if (datos.trip_status !== 'scheduled') {
                    showMessage('Solo se pueden editar salidas en estado "Programada"', 'warning');
                    return;
                }
                
                // Guardar ID para actualizaci√≥n
                datosGlobales.editandoTripId = tripId;
                datosGlobales.editandoRequestId = datos.request?.request_id || null;
                
                // Poblar el wizard con los datos
                
                // 1. Grados
                const gradosIds = datos.svc_pedagogical_trip_grades.map(g => g.grades.grade_id);
                const selectGrados = document.getElementById('wizardGrados');
                Array.from(selectGrados.options).forEach(option => {
                    option.selected = gradosIds.includes(option.value);
                });
                
                // 2. Destino
                document.getElementById('wizardDestino').value = datos.destination_id;
                
                // 3. Fecha y horarios
                document.getElementById('wizardFecha').value = datos.trip_date;
                document.getElementById('wizardHoraSalida').value = datos.departure_time;
                document.getElementById('wizardHoraRegreso').value = datos.return_time;
                
                // 4. Modalidad de transporte
                document.querySelector(`input[name="wizardModalidad"][value="${datos.transport_modality}"]`).checked = true;
                
                // 5. Descripci√≥n y detalles
                document.getElementById('wizardDescripcion').value = datos.trip_description || '';
                document.getElementById('wizardUnidadIndagacion').value = datos.inquiry_unit || '';
                document.getElementById('wizardObservaciones').value = datos.observations || '';
                
                // 6. Participantes
                document.getElementById('wizardNumAdultos').value = datos.num_adults;
                document.getElementById('wizardAdultosNombres').value = datos.accompanying_adults || '';
                
                // 7. Aprobador
                document.getElementById('wizardAprobador').value = datos.request?.approver_id || '';
                document.getElementById('wizardComentarios').value = '';
                
                // 8. Refrigerios
                if (datos.catering_menu_id) {
                    document.getElementById('wizardIncluirRefrigerios').checked = true;
                    document.getElementById('wizardMenuRefrigerio').value = datos.catering_menu_id;
                    // Disparar evento para mostrar campos
                    document.getElementById('wizardIncluirRefrigerios').dispatchEvent(new Event('change'));
                }
                
                // 9. Entradas
                if (datos.entrance_unit_value && datos.entrance_unit_value > 0) {
                    document.getElementById('wizardIncluirEntradas').checked = true;
                    document.getElementById('wizardValorEntrada').value = datos.entrance_unit_value;
                    // Disparar evento para mostrar campos
                    document.getElementById('wizardIncluirEntradas').dispatchEvent(new Event('change'));
                }
                
                // 10. Cargar estudiantes seg√∫n grados
                await cargarEstudiantesPorGrados();
                
                // 11. Cambiar t√≠tulo y bot√≥n del modal
                document.querySelector('#modalWizardSalida .modal-title').textContent = '‚úèÔ∏è Editar Salida Pedag√≥gica';
                document.getElementById('btnWizardGuardar').innerHTML = '<i class="bi bi-save me-1"></i>Actualizar Salida';
                
                // 12. Abrir modal
                const modal = new bootstrap.Modal(document.getElementById('modalWizardSalida'));
                modal.show();
                
                showMessage('Datos cargados. Modifique lo necesario y haga clic en "Actualizar Salida"', 'info');
                
            } catch (error) {
                console.error('‚ùå Error al editar:', error);
                showMessage('Error al cargar datos para edici√≥n: ' + error.message, 'danger');
            }
        }
        
        async function eliminarSalida(tripId) {
            if (!confirm('¬øEst√° seguro de eliminar esta salida?')) return;
            
            try {
                await supabaseRequest(`/svc_pedagogical_trips?trip_id=eq.${tripId}`, {
                    method: 'DELETE'
                });
                
                showMessage('Salida eliminada correctamente', 'success');
                await cargarSalidas();
                
            } catch (error) {
                console.error('Error eliminando:', error);
                showMessage('Error al eliminar la salida', 'danger');
            }
        }
    </script>
</body>
</html>
