<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.27.07.14">
    <title>Salidas Deportivas - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .loading-overlay.hidden { display: none; }
        .loading-content { background: white; padding: 2rem; border-radius: 8px; text-align: center; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Wizard Steps */
        .wizard-steps { display: flex; justify-content: center; margin-bottom: 1.5rem; gap: 0; }
        .wizard-step { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; color: #6c757d; font-size: 0.85rem; position: relative; }
        .wizard-step .step-number { width: 28px; height: 28px; border-radius: 50%; background: #e9ecef; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.8rem; }
        .wizard-step.active { color: #0d6efd; font-weight: 600; }
        .wizard-step.active .step-number { background: #0d6efd; color: white; }
        .wizard-step.completed .step-number { background: #198754; color: white; }
        .wizard-step.completed { color: #198754; }
        .wizard-connector { width: 30px; height: 2px; background: #e9ecef; align-self: center; }
        .wizard-connector.active { background: #198754; }
        .wizard-panel { display: none; }
        .wizard-panel.active { display: block; }

        /* Status badges */
        .badge-scheduled { background-color: #6c757d; }
        .badge-imminent { background-color: #fd7e14; }
        .badge-in_progress { background-color: #0d6efd; }
        .badge-completed { background-color: #198754; }
        .badge-suspended { background-color: #dc3545; }
        .badge-cancelled { background-color: #dc3545; }

        /* Trip cards */
        .trip-card { border-left: 4px solid #6c757d; transition: all 0.2s; cursor: pointer; }
        .trip-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); transform: translateY(-1px); }
        .trip-card.status-scheduled { border-left-color: #6c757d; }
        .trip-card.status-imminent { border-left-color: #fd7e14; }
        .trip-card.status-in_progress { border-left-color: #0d6efd; }
        .trip-card.status-completed { border-left-color: #198754; }
        .trip-card.status-suspended { border-left-color: #dc3545; }
        .trip-card.status-cancelled { border-left-color: #dc3545; }

        /* Cost summary */
        .cost-summary { background: #f8f9fa; border-radius: 8px; padding: 1rem; }
        .cost-total { font-size: 1.3rem; font-weight: 700; color: #198754; }

        /* Attendance list */
        .student-attendance-item { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0; }
        .student-attendance-item:last-child { border-bottom: none; }
        .student-unlinked { text-decoration: line-through; color: #999; }

        /* Node badges */
        .node-badge { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.25rem 0.6rem; border-radius: 20px; font-size: 0.8rem; background: #e7f1ff; color: #0d6efd; margin: 0.15rem; }
        .node-badge.arrival { background: #d1e7dd; color: #198754; }
        .node-badge .remove-node { cursor: pointer; font-size: 0.7rem; opacity: 0.7; }
        .node-badge .remove-node:hover { opacity: 1; }

        /* Detail sections */
        .detail-section { margin-bottom: 1rem; }
        .detail-section h6 { color: #495057; border-bottom: 1px solid #dee2e6; padding-bottom: 0.3rem; margin-bottom: 0.5rem; }
        .detail-label { font-size: 0.8rem; color: #6c757d; margin-bottom: 0; }
        .detail-value { font-weight: 500; }
    </style>

    <!-- jsPDF para generaci√≥n de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
</head>
<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a></li>
                <li class="breadcrumb-item"><a href="index.html">Servicios</a></li>
                <li class="breadcrumb-item active" aria-current="page">Salidas Deportivas</li>
            </ol>
        </nav>

        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-trophy me-2"></i>Salidas Deportivas
                </h1>
                <p class="text-muted">Gesti√≥n de salidas deportivas: programaci√≥n, transporte, asistencia y estados</p>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- Filters & Actions Bar -->
        <div class="card mb-3">
            <div class="card-body py-2">
                <div class="row align-items-center g-2">
                    <div class="col-md-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="filterSearch" placeholder="Buscar salida..." oninput="applyFilters()">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="filterStatus" onchange="applyFilters()">
                            <option value="">Todos los estados</option>
                            <option value="scheduled">Programaci√≥n</option>
                            <option value="imminent">Inminente</option>
                            <option value="in_progress">En proceso</option>
                            <option value="completed">Realizada</option>
                            <option value="suspended">Suspendida</option>
                            <option value="cancelled">Cancelada</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="filterDiscipline" onchange="applyFilters()">
                            <option value="">Todas las disciplinas</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="month" class="form-control form-control-sm" id="filterMonth" onchange="applyFilters()">
                    </div>
                    <div class="col-md-3 text-end">
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="loadTrips()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="openCreateWizard()">
                            <i class="bi bi-plus-circle me-1"></i>Nueva Salida
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trips Listing -->
        <div id="tripsContainer">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>
                <div class="mt-2">Cargando salidas deportivas...</div>
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- MODAL: CREATE WIZARD -->
    <!-- ================================================================ -->
    <div class="modal fade" id="createWizardModal" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-trophy me-2"></i>Nueva Salida Deportiva</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Wizard Steps Indicator -->
                    <div class="wizard-steps" id="wizardStepsIndicator">
                        <div class="wizard-step active" data-step="1">
                            <span class="step-number">1</span><span class="d-none d-md-inline">Informaci√≥n</span>
                        </div>
                        <div class="wizard-connector"></div>
                        <div class="wizard-step" data-step="2">
                            <span class="step-number">2</span><span class="d-none d-md-inline">Equipo</span>
                        </div>
                        <div class="wizard-connector"></div>
                        <div class="wizard-step" data-step="3">
                            <span class="step-number">3</span><span class="d-none d-md-inline">Transporte</span>
                        </div>
                        <div class="wizard-connector"></div>
                        <div class="wizard-step" data-step="4">
                            <span class="step-number">4</span><span class="d-none d-md-inline">Refrigerios</span>
                        </div>
                        <div class="wizard-connector"></div>
                        <div class="wizard-step" data-step="5">
                            <span class="step-number">5</span><span class="d-none d-md-inline">Confirmar</span>
                        </div>
                    </div>

                    <!-- STEP 1: Basic Info -->
                    <div class="wizard-panel active" id="wizardStep1">
                        <h6 class="text-primary mb-3"><i class="bi bi-info-circle me-1"></i>Informaci√≥n B√°sica</h6>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Nombre de la salida <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="wz_trip_name" placeholder='Ej: "Campeonato UNCOLI"' required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Fecha del evento <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="wz_trip_date" placeholder="Seleccione fecha" required>
                                <div class="form-text text-danger d-none" id="dateWarning">
                                    <i class="bi bi-exclamation-triangle me-1"></i><span id="dateWarningText"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Hora del evento</label>
                                <input type="time" class="form-control" id="wz_event_time">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Adultos acompa√±antes</label>
                                <select class="form-select" id="wz_adult_workers" multiple size="4" onchange="onAdultWorkersChange()">
                                    <!-- Se carga din√°micamente -->
                                </select>
                                <small class="text-muted">Ctrl+click para seleccionar varios</small>
                                <div class="mt-1">
                                    <span class="badge bg-info" id="wz_adults_count">0 adultos seleccionados</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Hora de salida <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" id="wz_departure_time" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Hora de regreso <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" id="wz_return_time" required>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2: Team Selection -->
                    <div class="wizard-panel" id="wizardStep2">
                        <h6 class="text-primary mb-3"><i class="bi bi-people me-1"></i>Selecci√≥n de Equipo</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Disciplina <span class="text-danger">*</span></label>
                                <select class="form-select" id="wz_discipline" onchange="onDisciplineChange()">
                                    <option value="">Seleccionar disciplina...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Categor√≠a <span class="text-danger">*</span></label>
                                <select class="form-select" id="wz_category" onchange="onCategoryChange()">
                                    <option value="">Seleccionar categor√≠a...</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <div id="teamInfo" class="d-none">
                                    <div class="card bg-light">
                                        <div class="card-body py-2">
                                            <div class="row align-items-center">
                                                <div class="col-md-8">
                                                    <strong id="teamName"></strong>
                                                    <span class="text-muted ms-2" id="teamGender"></span>
                                                    <br><small class="text-muted" id="teamCoach"></small>
                                                </div>
                                                <div class="col-md-4 text-end">
                                                    <span class="badge bg-primary fs-6" id="teamMemberCount">0 estudiantes</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle me-1"></i>
                                            Los integrantes del equipo se cargar√°n autom√°ticamente como participantes.
                                        </small>
                                    </div>
                                </div>
                                <div id="noTeamWarning" class="d-none">
                                    <div class="alert alert-warning mb-0">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        No se encontr√≥ un equipo activo para esta combinaci√≥n de disciplina y categor√≠a.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 3: Transport -->
                    <div class="wizard-panel" id="wizardStep3">
                        <h6 class="text-primary mb-3"><i class="bi bi-bus-front me-1"></i>Transporte</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Destino tarifario <span class="text-danger">*</span></label>
                                <select class="form-select" id="wz_destination" onchange="onDestinationChange()">
                                    <option value="">Seleccionar destino...</option>
                                </select>
                                <div class="form-text">Para calcular el costo del transporte</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Destino espec√≠fico</label>
                                <input type="text" class="form-control" id="wz_specific_destination" placeholder='Ej: "Colegio Rochester"'>
                                <div class="form-text">Lugar exacto al que se dirigen</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Modalidad de recorrido <span class="text-danger">*</span></label>
                                <select class="form-select" id="wz_modality" onchange="onModalityChange()">
                                    <option value="">Seleccionar modalidad...</option>
                                    <option value="outbound">Solo ida</option>
                                    <option value="return">Solo regreso</option>
                                    <option value="round_trip">Ida y regreso</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <!-- Placeholder for cost preview -->
                            </div>
                            <!-- Departure Nodes -->
                            <div class="col-md-6" id="departureNodesSection" style="display:none;">
                                <label class="form-label">Nodos de salida</label>
                                <select class="form-select form-select-sm" id="wz_departure_node_select" onchange="addNode('departure')">
                                    <option value="">Agregar nodo de salida...</option>
                                </select>
                                <div id="departureNodesList" class="mt-1"></div>
                            </div>
                            <!-- Arrival Nodes -->
                            <div class="col-md-6" id="arrivalNodesSection" style="display:none;">
                                <label class="form-label">Nodos de llegada</label>
                                <select class="form-select form-select-sm" id="wz_arrival_node_select" onchange="addNode('arrival')">
                                    <option value="">Agregar nodo de llegada...</option>
                                </select>
                                <div id="arrivalNodesList" class="mt-1"></div>
                            </div>
                            <!-- Transport Cost Preview -->
                            <div class="col-12" id="transportCostPreview" style="display:none;">
                                <div class="cost-summary">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="detail-label">Total participantes</div>
                                            <div class="detail-value" id="costParticipants">0</div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="detail-label">Veh√≠culos necesarios</div>
                                            <div class="detail-value" id="costVehicles">0</div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="detail-label">Valor del transporte</div>
                                            <div class="cost-total" id="costTotal">$0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 4: Refrigerios -->
                    <div class="wizard-panel" id="wizardStep4">
                        <h6 class="text-primary mb-3"><i class="bi bi-cup-straw me-1"></i>Refrigerios</h6>
                        <div class="card">
                            <div class="card-body">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="wz_include_catering" onchange="toggleCatering()">
                                    <label class="form-check-label fw-bold" for="wz_include_catering">
                                        <i class="bi bi-cup-hot me-2"></i>Incluir Refrigerios
                                    </label>
                                </div>
                                <div id="cateringFields" style="display: none;">
                                    <div class="row g-3">
                                        <div class="col-md-8">
                                            <label class="form-label">Men√∫ <span class="text-danger">*</span></label>
                                            <select class="form-select" id="wz_catering_menu" onchange="updateCateringCost()">
                                                <option value="">Seleccione un men√∫</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Cantidad</label>
                                            <input type="number" class="form-control" id="wz_catering_quantity" min="1" oninput="updateCateringCost()">
                                            <small class="text-muted">Auto-llenado con total de participantes</small>
                                        </div>
                                        <div class="col-12" id="cateringCostPreview" style="display: none;">
                                            <div class="cost-summary">
                                                <div class="row align-items-center">
                                                    <div class="col-md-4">
                                                        <div class="detail-label">Precio unitario</div>
                                                        <div class="detail-value" id="cateringUnitPrice">$0</div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="detail-label">Cantidad</div>
                                                        <div class="detail-value" id="cateringQtyDisplay">0</div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="detail-label">Total refrigerios</div>
                                                        <div class="cost-total" id="cateringTotal">$0</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 5: Summary & Confirm -->
                    <div class="wizard-panel" id="wizardStep4">
                        <h6 class="text-primary mb-3"><i class="bi bi-clipboard-check me-1"></i>Resumen y Confirmaci√≥n</h6>
                        <div id="wizardSummary"></div>
                        <hr>
                        <div class="mb-3">
                            <label class="form-label">Seleccionar aprobador <span class="text-danger">*</span></label>
                            <select class="form-select" id="wz_approver">
                                <option value="">Seleccionar quien aprueba...</option>
                            </select>
                            <div class="form-text">Personas con permiso de "Resoluci√≥n de solicitudes"</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-outline-primary d-none" id="btnWizardPrev" onclick="wizardPrev()">
                        <i class="bi bi-arrow-left me-1"></i>Anterior
                    </button>
                    <button type="button" class="btn btn-primary" id="btnWizardNext" onclick="wizardNext()">
                        Siguiente<i class="bi bi-arrow-right ms-1"></i>
                    </button>
                    <button type="button" class="btn btn-success d-none" id="btnWizardSubmit" onclick="submitTrip()">
                        <i class="bi bi-send me-1"></i>Enviar Solicitud
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- MODAL: TRIP DETAIL -->
    <!-- ================================================================ -->
    <div class="modal fade" id="tripDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailTitle"><i class="bi bi-trophy me-2"></i>Detalle de Salida</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailBody">
                    <!-- Populated dynamically -->
                </div>
                <div class="modal-footer" id="detailFooter">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- MODAL: ATTENDANCE -->
    <!-- ================================================================ -->
    <div class="modal fade" id="attendanceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-check me-2"></i>Registro de Asistencia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="attendanceBody">
                    <!-- Populated dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- MODAL: Status Change (Suspend/Cancel) -->
    <!-- ================================================================ -->
    <div class="modal fade" id="statusChangeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statusChangeTitle">Cambiar Estado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Raz√≥n <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="statusChangeReason" rows="3" placeholder="Indique la raz√≥n..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmStatusChange" onclick="confirmStatusChange()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="../../assets/js/config.js"></script>
     
    <script>
        // ==========================================
        // GLOBAL STATE
        // ==========================================
        let allTrips = [];
        let catalogDestinations = [];
        let catalogRates = [];
        let catalogNodes = [];
        let catalogDisciplines = [];
        let catalogCategories = [];
        let catalogTeams = [];
        let catalogApprovers = [];
        let catalogMenus = [];
        let catalogWorkers = [];
        let moduleConfig = {};
        let emailChef = '';
        let emailSupervisor = '';
        let currentSession = null;
        let currentWorker = null;

        // Wizard state
        let wizardCurrentStep = 1;
        const WIZARD_TOTAL_STEPS = 5;
        let selectedTeamId = null;
        let selectedTeamMembers = [];
        let selectedDepartureNodes = [];
        let selectedArrivalNodes = [];
        let selectedAdultWorkers = [];
        let calculatedTransport = { rate: 0, capacity: 0, count: 0, total: 0 };
        let pendingStatusChange = { tripId: null, newStatus: null };
        let fpWizardFecha = null;

        // Status labels in Spanish
        const STATUS_LABELS = {
            scheduled: 'Programaci√≥n',
            imminent: 'Inminente',
            in_progress: 'En proceso',
            completed: 'Realizada',
            suspended: 'Suspendida',
            cancelled: 'Cancelada'
        };

        const STATUS_ICONS = {
            scheduled: 'bi-calendar-check',
            imminent: 'bi-alarm',
            in_progress: 'bi-play-circle',
            completed: 'bi-check-circle',
            suspended: 'bi-pause-circle',
            cancelled: 'bi-x-circle'
        };

        const MODALITY_LABELS = {
            outbound: 'Solo ida',
            'return': 'Solo regreso',
            round_trip: 'Ida y regreso'
        };

        const GENDER_LABELS = {
            male: 'Masculino',
            female: 'Femenino',
            mixed: 'Mixto'
        };

        // ==========================================
        // INITIALIZATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üèüÔ∏è Iniciando Salidas Deportivas...');
            try {
                const hasAccess = await validatePageAccess('Salidas deportivas');
                if (!hasAccess) return;

                currentSession = getStoredSession();
                if (!currentSession) {
                    showMessage('Sesi√≥n no v√°lida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '../../login.html', 2000);
                    return;
                }

                // Load worker info for current user
                await loadCurrentWorker();
                // Load all catalogs in parallel
                await loadCatalogs();
                // Load trips
                await loadTrips();

                // Inicializar Flatpickr
                initializeFlatpickr();

                console.log('‚úÖ Salidas Deportivas cargada correctamente');
            } catch (error) {
                console.error('Error inicializando:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // DATA LOADING
        // ==========================================
        async function loadCurrentWorker() {
            try {
                // workers no tiene user_id: obtener email del usuario y buscar worker por email
                const userData = await supabaseRequest(`/users?select=user_mail&user_id=eq.${currentSession.user.user_id}`);
                if (!userData || userData.length === 0 || !userData[0].user_mail) return;
                
                const workers = await supabaseRequest(
                    `/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,email&email=eq.${userData[0].user_mail}`
                );
                if (workers && workers.length > 0) {
                    currentWorker = workers[0];
                }
            } catch (e) {
                console.error('Error loading worker:', e);
            }
        }

        async function loadCatalogs() {
            try {
                const [destinations, rates, nodes, disciplines, categories, teams, config, approvers, menus, workers] = await Promise.all([
                    supabaseRequest('/svc_transport_destinations?select=destination_id,destination_name,destination_address&is_active=eq.true&order=destination_name'),
                    supabaseRequest('/svc_transport_rates_students?select=rate_id,destination_id,min_capacity,max_capacity,rate_value&is_active=eq.true'),
                    supabaseRequest('/svc_transport_nodes?select=node_id,node_name,node_description,node_order&is_active=eq.true&order=node_order,node_name'),
                    supabaseRequest('/svc_sports_disciplines?select=discipline_id,discipline_name&is_active=eq.true&order=discipline_name'),
                    supabaseRequest('/svc_sports_categories?select=category_id,category_name,category_order&is_active=eq.true&order=category_order,category_name'),
                    supabaseRequest('/svc_sports_teams?select=team_id,discipline_id,category_id,gender,coach_name,coach_contact,is_active&is_active=eq.true'),
                    supabaseRequest('/svc_module_config?select=config_key,config_value'),
                    loadApprovers(),
                    supabaseRequest('/svc_catering_menus?select=menu_id,menu_name,unit_price&is_active=eq.true&order=menu_name'),
                    supabaseRequest('/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2&worker_status=eq.active&order=worker_last_name_1,worker_first_name')
                ]);

                catalogDestinations = destinations || [];
                catalogRates = rates || [];
                catalogNodes = nodes || [];
                catalogDisciplines = disciplines || [];
                catalogCategories = categories || [];
                catalogTeams = teams || [];
                catalogApprovers = approvers || [];
                catalogMenus = menus || [];
                catalogWorkers = workers || [];

                // Parse module config into object
                moduleConfig = {};
                (config || []).forEach(c => moduleConfig[c.config_key] = c.config_value);
                
                // Extraer emails fijos
                emailChef = moduleConfig['email_chef'] || '';
                emailSupervisor = moduleConfig['email_supervisor'] || '';
                console.log('üìß Emails fijos cargados:', { emailChef, emailSupervisor });

                // Populate filter selects
                populateFilterDisciplines();

            } catch (error) {
                console.error('Error loading catalogs:', error);
                showMessage('Error cargando cat√°logos', 'danger');
            }
        }

        function initializeFlatpickr() {
            const minDays = parseInt(moduleConfig['min_days_advance'] || '7');
            const today = new Date();
            const minDate = new Date(today);
            minDate.setDate(today.getDate() + minDays);

            fpWizardFecha = flatpickr('#wz_trip_date', {
                locale: 'es',
                dateFormat: 'Y-m-d',
                minDate: minDate,
                altInput: true,
                altFormat: 'j \\de F \\de Y',
                disableMobile: true,
                onReady: function(selectedDates, dateStr, instance) {
                    instance.altInput.placeholder = `M√≠nimo ${minDays} d√≠as de antelaci√≥n`;
                }
            });

            console.log('‚úÖ Flatpickr inicializado (m√≠nimo ' + minDays + ' d√≠as)');
        }

        async function loadApprovers() {
            try {
                // Find workers with "Resoluci√≥n de solicitudes" permission
                const PERM_ID = '5c503ff3-559f-4755-9d47-b63fe7f561a2';
                const rolePerms = await supabaseRequest(`/role_permissions?select=role_id&permission_id=eq.${PERM_ID}`);
                if (!rolePerms || rolePerms.length === 0) return [];

                const roleIds = rolePerms.map(rp => rp.role_id);
                const roleFilter = roleIds.map(id => `role_id.eq.${id}`).join(',');

                const userRoles = await supabaseRequest(`/user_roles?select=user_id&or=(${roleFilter})`);
                if (!userRoles || userRoles.length === 0) return [];

                const userIds = [...new Set(userRoles.map(ur => ur.user_id))];
                const userFilter = userIds.map(id => `user_id.eq.${id}`).join(',');

                // Obtener emails de esos usuarios
                const users = await supabaseRequest(`/users?select=user_mail&or=(${userFilter})`);
                if (!users || users.length === 0) return [];

                const emails = users.map(u => u.user_mail).filter(Boolean);
                const emailFilter = emails.map(e => `email.eq.${e}`).join(',');

                // Obtener workers por email
                const workers = await supabaseRequest(
                    `/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2&or=(${emailFilter})&order=worker_last_name_1,worker_first_name`
                );

                return workers || [];
            } catch (e) {
                console.error('Error loading approvers:', e);
                return [];
            }
        }

        async function loadTrips() {
            try {
                const trips = await supabaseRequest(
                    `/svc_sports_trips?select=*,svc_transport_destinations(destination_name),svc_sports_teams(team_id,discipline_id,category_id,gender,svc_sports_disciplines(discipline_name),svc_sports_categories(category_name)),svc_service_requests(request_id,request_status,approver_id,rejection_reason,requested_at,resolved_at)&order=trip_date.desc,created_at.desc`
                );

                allTrips = trips || [];

                // Check for automatic status transitions
                await checkAutoStatusTransitions();

                applyFilters();

            } catch (error) {
                console.error('Error loading trips:', error);
                showMessage('Error cargando salidas deportivas', 'danger');
            }
        }

        // ==========================================
        // AUTO STATUS TRANSITIONS
        // ==========================================
        async function checkAutoStatusTransitions() {
            const today = getCurrentDateColombia();
            const daysImminent = parseInt(moduleConfig['days_before_imminent'] || '3');

            for (const trip of allTrips) {
                const tripDate = trip.trip_date;
                const daysUntil = daysBetween(today, tripDate);

                // Scheduled ‚Üí Imminent (X days before)
                if (trip.trip_status === 'scheduled' && daysUntil <= daysImminent && daysUntil >= 0) {
                    // Only if approved
                    if (trip.svc_service_requests && trip.svc_service_requests.request_status === 'approved') {
                        await updateTripStatus(trip.trip_id, 'imminent');
                        trip.trip_status = 'imminent';
                    }
                }

                // In Process ‚Üí Completed (day after)
                if (trip.trip_status === 'in_progress' && daysUntil < 0) {
                    await updateTripStatus(trip.trip_id, 'completed');
                    trip.trip_status = 'completed';
                }
            }
        }

        function daysBetween(dateStr1, dateStr2) {
            const d1 = new Date(dateStr1 + 'T00:00:00');
            const d2 = new Date(dateStr2 + 'T00:00:00');
            return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
        }

        async function updateTripStatus(tripId, newStatus, reason = null) {
            try {
                const body = { trip_status: newStatus };
                if (reason) body.status_reason = reason;
                await supabaseRequest(`/svc_sports_trips?trip_id=eq.${tripId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(body)
                });
            } catch (e) {
                console.error('Error updating status:', e);
            }
        }

        // ==========================================
        // FILTER & RENDER TRIPS
        // ==========================================
        function populateFilterDisciplines() {
            const select = document.getElementById('filterDiscipline');
            select.innerHTML = '<option value="">Todas las disciplinas</option>';
            catalogDisciplines.forEach(d => {
                select.innerHTML += `<option value="${d.discipline_id}">${d.discipline_name}</option>`;
            });
        }

        function applyFilters() {
            const search = document.getElementById('filterSearch').value.toLowerCase().trim();
            const status = document.getElementById('filterStatus').value;
            const discipline = document.getElementById('filterDiscipline').value;
            const month = document.getElementById('filterMonth').value;

            let filtered = allTrips.filter(trip => {
                if (search && !trip.trip_name.toLowerCase().includes(search) &&
                    !(trip.specific_destination || '').toLowerCase().includes(search)) return false;
                if (status && trip.trip_status !== status) return false;
                if (discipline && trip.svc_sports_teams?.discipline_id !== discipline) return false;
                if (month && !trip.trip_date.startsWith(month)) return false;
                return true;
            });

            renderTrips(filtered);
        }

        function renderTrips(trips) {
            const container = document.getElementById('tripsContainer');

            if (trips.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-trophy" style="font-size: 3rem; color: #ccc;"></i>
                        <p class="mt-2 text-muted">No hay salidas deportivas registradas</p>
                        <button class="btn btn-sm btn-primary mt-2" onclick="openCreateWizard()">
                            <i class="bi bi-plus-circle me-1"></i>Crear primera salida
                        </button>
                    </div>`;
                return;
            }

            let html = '<div class="row g-3">';
            trips.forEach(trip => {
                const team = trip.svc_sports_teams;
                const dest = trip.svc_transport_destinations;
                const req = trip.svc_service_requests;
                const discipline = team?.svc_sports_disciplines?.discipline_name || '-';
                const category = team?.svc_sports_categories?.category_name || '-';
                const destName = dest?.destination_name || '-';
                const statusLabel = STATUS_LABELS[trip.trip_status] || trip.trip_status;
                const statusIcon = STATUS_ICONS[trip.trip_status] || 'bi-circle';
                const tripDateFormatted = formatDateDisplay(trip.trip_date);

                // Request status badge
                let reqBadge = '';
                if (req) {
                    if (req.request_status === 'pending') reqBadge = '<span class="badge bg-warning text-dark ms-1" title="Pendiente de aprobaci√≥n"><i class="bi bi-hourglass-split"></i></span>';
                    else if (req.request_status === 'rejected') reqBadge = '<span class="badge bg-danger ms-1" title="Rechazada"><i class="bi bi-x-lg"></i></span>';
                    else if (req.request_status === 'approved') reqBadge = '<span class="badge bg-success ms-1" title="Aprobada"><i class="bi bi-check-lg"></i></span>';
                }

                html += `
                <div class="col-md-6 col-xl-4">
                    <div class="card trip-card status-${trip.trip_status}" onclick="openTripDetail('${trip.trip_id}')">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0 text-truncate" style="max-width:70%;">${escapeHtml(trip.trip_name)}</h6>
                                <span class="badge badge-${trip.trip_status}">
                                    <i class="bi ${statusIcon} me-1"></i>${statusLabel}
                                </span>
                            </div>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                <small class="text-muted"><i class="bi bi-calendar me-1"></i>${tripDateFormatted}</small>
                                <small class="text-muted"><i class="bi bi-clock me-1"></i>${trip.departure_time?.substring(0,5) || ''}</small>
                                <small class="text-muted"><i class="bi bi-geo-alt me-1"></i>${escapeHtml(destName)}</small>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-dribbble me-1"></i>${discipline} - ${category}
                                </span>
                                <span>
                                    <small class="text-success fw-bold">$${formatNumber((trip.total_transport_value || 0) + (trip.total_catering_value || 0))}</small>
                                    ${reqBadge}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            html += '</div>';

            // Summary bar
            const total = trips.length;
            const scheduled = trips.filter(t => t.trip_status === 'scheduled').length;
            const imminent = trips.filter(t => t.trip_status === 'imminent').length;
            const inProgress = trips.filter(t => t.trip_status === 'in_progress').length;
            const completed = trips.filter(t => t.trip_status === 'completed').length;

            const summaryHtml = `
                <div class="d-flex flex-wrap gap-3 mb-3">
                    <small class="text-muted"><strong>${total}</strong> salidas</small>
                    ${scheduled ? `<small><span class="badge badge-scheduled">${scheduled}</span> Programaci√≥n</small>` : ''}
                    ${imminent ? `<small><span class="badge badge-imminent">${imminent}</span> Inminentes</small>` : ''}
                    ${inProgress ? `<small><span class="badge badge-in_progress">${inProgress}</span> En proceso</small>` : ''}
                    ${completed ? `<small><span class="badge badge-completed">${completed}</span> Realizadas</small>` : ''}
                </div>`;

            container.innerHTML = summaryHtml + html;
        }

        // ==========================================
        // WIZARD: CREATE TRIP
        // ==========================================
        function openCreateWizard() {
            // Reset wizard
            wizardCurrentStep = 1;
            selectedTeamId = null;
            selectedTeamMembers = [];
            selectedDepartureNodes = [];
            selectedArrivalNodes = [];
            calculatedTransport = { rate: 0, capacity: 0, count: 0, total: 0 };

            // Reset form fields
            document.getElementById('wz_trip_name').value = '';
            if (fpWizardFecha) fpWizardFecha.clear();
            document.getElementById('wz_event_time').value = '';
            document.getElementById('wz_departure_time').value = '';
            document.getElementById('wz_return_time').value = '';
            document.getElementById('wz_specific_destination').value = '';
            document.getElementById('dateWarning').classList.add('d-none');

            // Populate selects
            populateWizardDisciplines();
            populateWizardDestinations();
            populateWizardNodes();
            populateWizardApprovers();
            populateWizardWorkers();

            // Reset adult workers
            selectedAdultWorkers = [];
            document.getElementById('wz_adults_count').textContent = '0 adultos seleccionados';

            // Reset team info
            document.getElementById('teamInfo').classList.add('d-none');
            document.getElementById('noTeamWarning').classList.add('d-none');
            document.getElementById('wz_discipline').value = '';
            document.getElementById('wz_category').value = '';
            document.getElementById('wz_destination').value = '';
            document.getElementById('wz_modality').value = '';

            // Hide node sections
            document.getElementById('departureNodesSection').style.display = 'none';
            document.getElementById('arrivalNodesSection').style.display = 'none';
            document.getElementById('transportCostPreview').style.display = 'none';
            document.getElementById('departureNodesList').innerHTML = '';
            document.getElementById('arrivalNodesList').innerHTML = '';
            // Reset catering
            document.getElementById('wz_include_catering').checked = false;
            document.getElementById('cateringFields').style.display = 'none';
            document.getElementById('cateringCostPreview').style.display = 'none';

            updateWizardUI();
            new bootstrap.Modal(document.getElementById('createWizardModal')).show();
        }

        function populateWizardDisciplines() {
            const sel = document.getElementById('wz_discipline');
            sel.innerHTML = '<option value="">Seleccionar disciplina...</option>';
            catalogDisciplines.forEach(d => {
                sel.innerHTML += `<option value="${d.discipline_id}">${d.discipline_name}</option>`;
            });
        }

        function populateWizardDestinations() {
            const sel = document.getElementById('wz_destination');
            sel.innerHTML = '<option value="">Seleccionar destino...</option>';
            catalogDestinations.forEach(d => {
                sel.innerHTML += `<option value="${d.destination_id}">${d.destination_name}</option>`;
            });
        }

        function populateWizardNodes() {
            const depSel = document.getElementById('wz_departure_node_select');
            const arrSel = document.getElementById('wz_arrival_node_select');
            const optionsHtml = catalogNodes.map(n =>
                `<option value="${n.node_id}">${n.node_name}</option>`
            ).join('');
            depSel.innerHTML = '<option value="">Agregar nodo de salida...</option>' + optionsHtml;
            arrSel.innerHTML = '<option value="">Agregar nodo de llegada...</option>' + optionsHtml;
        }

        function populateWizardApprovers() {
            const sel = document.getElementById('wz_approver');
            sel.innerHTML = '<option value="">Seleccionar quien aprueba...</option>';
            catalogApprovers.forEach(w => {
                const name = `${w.worker_last_name_1}${w.worker_last_name_2 ? ' ' + w.worker_last_name_2 : ''}, ${w.worker_first_name}`;
                sel.innerHTML += `<option value="${w.worker_id}">${name}</option>`;
            });
        }

        function populateWizardWorkers() {
            const sel = document.getElementById('wz_adult_workers');
            sel.innerHTML = '';
            catalogWorkers.forEach(w => {
                const name = `${w.worker_last_name_1}${w.worker_last_name_2 ? ' ' + w.worker_last_name_2 : ''}, ${w.worker_first_name}`;
                sel.innerHTML += `<option value="${w.worker_id}">${name}</option>`;
            });
        }

        function onAdultWorkersChange() {
            selectedAdultWorkers = Array.from(document.getElementById('wz_adult_workers').selectedOptions).map(o => o.value);
            document.getElementById('wz_adults_count').textContent = `${selectedAdultWorkers.length} adulto${selectedAdultWorkers.length !== 1 ? 's' : ''} seleccionado${selectedAdultWorkers.length !== 1 ? 's' : ''}`;
            calculateTransportCost();
        }

        // Wizard Navigation
        function updateWizardUI() {
            // Update step indicators
            document.querySelectorAll('.wizard-step').forEach(el => {
                const step = parseInt(el.dataset.step);
                el.classList.remove('active', 'completed');
                if (step === wizardCurrentStep) el.classList.add('active');
                else if (step < wizardCurrentStep) el.classList.add('completed');
            });
            document.querySelectorAll('.wizard-connector').forEach((el, i) => {
                el.classList.toggle('active', i + 1 < wizardCurrentStep);
            });

            // Show/hide panels
            document.querySelectorAll('.wizard-panel').forEach((el, i) => {
                el.classList.toggle('active', i + 1 === wizardCurrentStep);
            });

            // Button visibility
            document.getElementById('btnWizardPrev').classList.toggle('d-none', wizardCurrentStep === 1);
            document.getElementById('btnWizardNext').classList.toggle('d-none', wizardCurrentStep === WIZARD_TOTAL_STEPS);
            document.getElementById('btnWizardSubmit').classList.toggle('d-none', wizardCurrentStep !== WIZARD_TOTAL_STEPS);
        }

        function wizardNext() {
            if (!validateWizardStep(wizardCurrentStep)) return;
            if (wizardCurrentStep < WIZARD_TOTAL_STEPS) {
                wizardCurrentStep++;
                if (wizardCurrentStep === 5) buildSummary();
                updateWizardUI();
            }
        }

        function wizardPrev() {
            if (wizardCurrentStep > 1) {
                wizardCurrentStep--;
                updateWizardUI();
            }
        }

        function validateWizardStep(step) {
            switch (step) {
                case 1:
                    const name = document.getElementById('wz_trip_name').value.trim();
                    const date = document.getElementById('wz_trip_date').value;
                    const dep = document.getElementById('wz_departure_time').value;
                    const ret = document.getElementById('wz_return_time').value;

                    if (!name) { showMessage('Ingrese el nombre de la salida', 'warning'); return false; }
                    if (!date) { showMessage('Seleccione la fecha del evento', 'warning'); return false; }
                    if (!dep || !ret) { showMessage('Ingrese hora de salida y regreso', 'warning'); return false; }

                   // Flatpickr ya restringe la fecha m√≠nima, pero validamos por seguridad
                    if (!date) {
                        showMessage('Seleccione la fecha del evento', 'warning');
                        return false;
                    }
                    return true;

                case 2:
                    if (!selectedTeamId) {
                        showMessage('Seleccione un equipo (disciplina y categor√≠a)', 'warning');
                        return false;
                    }
                    if (selectedTeamMembers.length === 0) {
                        showMessage('El equipo seleccionado no tiene integrantes', 'warning');
                        return false;
                    }
                    return true;

                case 3:
                    const dest = document.getElementById('wz_destination').value;
                    const mod = document.getElementById('wz_modality').value;
                    if (!dest) { showMessage('Seleccione el destino tarifario', 'warning'); return false; }
                    if (!mod) { showMessage('Seleccione la modalidad de recorrido', 'warning'); return false; }
                    // Recalculate transport
                    calculateTransportCost();
                    if (calculatedTransport.total === 0 && calculatedTransport.rate === 0) {
                        showMessage('No se encontr√≥ tarifa para este destino y cantidad de participantes. Verifique el tarifario.', 'warning');
                        return false;
                    }
                    return true;

                case 4:
                    if (document.getElementById('wz_include_catering').checked) {
                        const menuVal = document.getElementById('wz_catering_menu').value;
                        const qtyVal = parseInt(document.getElementById('wz_catering_quantity').value) || 0;
                        if (!menuVal) { showMessage('Seleccione un men√∫ de refrigerios', 'warning'); return false; }
                        if (qtyVal <= 0) { showMessage('La cantidad de refrigerios debe ser mayor a 0', 'warning'); return false; }
                    }
                    return true;

                default:
                    return true;
            }
        }

        // ==========================================
        // WIZARD: TEAM SELECTION LOGIC
        // ==========================================
        function onDisciplineChange() {
            const disciplineId = document.getElementById('wz_discipline').value;
            const catSel = document.getElementById('wz_category');
            catSel.innerHTML = '<option value="">Seleccionar categor√≠a...</option>';

            // Show all categories (they're universal, not per discipline)
            catalogCategories.forEach(c => {
                catSel.innerHTML += `<option value="${c.category_id}">${c.category_name}</option>`;
            });

            document.getElementById('teamInfo').classList.add('d-none');
            document.getElementById('noTeamWarning').classList.add('d-none');
            selectedTeamId = null;
            selectedTeamMembers = [];
        }

        async function onCategoryChange() {
            const disciplineId = document.getElementById('wz_discipline').value;
            const categoryId = document.getElementById('wz_category').value;

            document.getElementById('teamInfo').classList.add('d-none');
            document.getElementById('noTeamWarning').classList.add('d-none');
            selectedTeamId = null;
            selectedTeamMembers = [];

            if (!disciplineId || !categoryId) return;

            // Find matching team
            const team = catalogTeams.find(t =>
                t.discipline_id === disciplineId &&
                t.category_id === categoryId &&
                t.is_active
            );

            if (!team) {
                document.getElementById('noTeamWarning').classList.remove('d-none');
                return;
            }

            selectedTeamId = team.team_id;

            // Load team members
            try {
                const members = await supabaseRequest(
                    `/svc_sports_team_members?select=student_id,students(student_id,student_first_name,student_last_name_1,student_last_name_2,student_code,courses(course_name))&team_id=eq.${team.team_id}&is_active=eq.true`
                );
                selectedTeamMembers = members || [];
            } catch (e) {
                console.error('Error loading team members:', e);
                selectedTeamMembers = [];
            }

            // Get discipline/category names
            const disc = catalogDisciplines.find(d => d.discipline_id === disciplineId);
            const cat = catalogCategories.find(c => c.category_id === categoryId);

            document.getElementById('teamName').textContent = `${disc?.discipline_name || ''} - ${cat?.category_name || ''}`;
            document.getElementById('teamGender').textContent = `(${GENDER_LABELS[team.gender] || team.gender})`;
            document.getElementById('teamCoach').textContent = team.coach_name ? `Entrenador: ${team.coach_name}` : 'Sin entrenador asignado';
            document.getElementById('teamMemberCount').textContent = `${selectedTeamMembers.length} estudiantes`;
            document.getElementById('teamInfo').classList.remove('d-none');

            // Trigger transport recalculation
            calculateTransportCost();
        }

        // ==========================================
        // WIZARD: TRANSPORT LOGIC
        // ==========================================
        function onDestinationChange() {
            calculateTransportCost();
        }

        function onModalityChange() {
            const mod = document.getElementById('wz_modality').value;
            const showDeparture = mod === 'outbound' || mod === 'round_trip';
            const showArrival = mod === 'return' || mod === 'round_trip';

            document.getElementById('departureNodesSection').style.display = showDeparture ? '' : 'none';
            document.getElementById('arrivalNodesSection').style.display = showArrival ? '' : 'none';

            if (!showDeparture) { selectedDepartureNodes = []; document.getElementById('departureNodesList').innerHTML = ''; }
            if (!showArrival) { selectedArrivalNodes = []; document.getElementById('arrivalNodesList').innerHTML = ''; }

            calculateTransportCost();
        }

        function addNode(role) {
            const selectId = role === 'departure' ? 'wz_departure_node_select' : 'wz_arrival_node_select';
            const sel = document.getElementById(selectId);
            const nodeId = sel.value;
            if (!nodeId) return;

            const nodeArr = role === 'departure' ? selectedDepartureNodes : selectedArrivalNodes;
            if (nodeArr.find(n => n.node_id === nodeId)) { sel.value = ''; return; } // Already added

            const node = catalogNodes.find(n => n.node_id === nodeId);
            if (node) {
                nodeArr.push(node);
                renderNodes(role);
            }
            sel.value = '';
        }

        function removeNode(role, nodeId) {
            if (role === 'departure') {
                selectedDepartureNodes = selectedDepartureNodes.filter(n => n.node_id !== nodeId);
            } else {
                selectedArrivalNodes = selectedArrivalNodes.filter(n => n.node_id !== nodeId);
            }
            renderNodes(role);
        }

        function renderNodes(role) {
            const nodes = role === 'departure' ? selectedDepartureNodes : selectedArrivalNodes;
            const containerId = role === 'departure' ? 'departureNodesList' : 'arrivalNodesList';
            const cssClass = role === 'departure' ? '' : 'arrival';

            document.getElementById(containerId).innerHTML = nodes.map(n => `
                <span class="node-badge ${cssClass}">
                    <i class="bi bi-geo-alt-fill"></i>${escapeHtml(n.node_name)}
                    <span class="remove-node" onclick="removeNode('${role}','${n.node_id}')"><i class="bi bi-x-circle"></i></span>
                </span>
            `).join('');
        }

        function calculateTransportCost() {
            const destId = document.getElementById('wz_destination').value;
            const numAdults = selectedAdultWorkers.length;
            const numStudents = selectedTeamMembers.length;
            const totalParticipants = numStudents + numAdults;

            if (!destId || totalParticipants === 0) {
                document.getElementById('transportCostPreview').style.display = 'none';
                calculatedTransport = { rate: 0, capacity: 0, count: 0, total: 0 };
                return;
            }

            // Find applicable rate for destination and capacity
            const destRates = catalogRates
                .filter(r => r.destination_id === destId)
                .sort((a, b) => a.min_capacity - b.min_capacity);

            if (destRates.length === 0) {
                document.getElementById('transportCostPreview').style.display = 'none';
                calculatedTransport = { rate: 0, capacity: 0, count: 0, total: 0 };
                return;
            }

            // Find the best fitting rate
            // Strategy: find the rate whose capacity range best covers participants
            let bestRate = null;
            let vehicleCount = 0;

            for (const rate of destRates) {
                const capacity = rate.max_capacity;
                const needed = Math.ceil(totalParticipants / capacity);
                if (!bestRate || needed * rate.rate_value < vehicleCount * bestRate.rate_value) {
                    bestRate = rate;
                    vehicleCount = needed;
                }
            }

            if (!bestRate) {
                // Fallback: use largest capacity
                bestRate = destRates[destRates.length - 1];
                vehicleCount = Math.ceil(totalParticipants / bestRate.max_capacity);
            }

            const modality = document.getElementById('wz_modality').value;
            const multiplier = modality === 'round_trip' ? 2 : 1;
            const totalCost = vehicleCount * bestRate.rate_value * multiplier;

            calculatedTransport = {
                rate: bestRate.rate_value,
                capacity: bestRate.max_capacity,
                count: vehicleCount,
                total: totalCost
            };

            document.getElementById('costParticipants').textContent = `${numStudents} estudiantes + ${numAdults} adultos = ${totalParticipants}`;
            document.getElementById('costVehicles').textContent = `${vehicleCount} veh√≠culo(s) de ${bestRate.min_capacity}-${bestRate.max_capacity} pax${modality === 'round_trip' ? ' √ó 2 (ida y vuelta)' : ''}`;
            document.getElementById('costTotal').textContent = `$${formatNumber(totalCost)}`;
            document.getElementById('transportCostPreview').style.display = '';
        }

        // ==========================================
        // WIZARD: CATERING LOGIC
        // ==========================================
        function populateWizardMenus() {
            const sel = document.getElementById('wz_catering_menu');
            sel.innerHTML = '<option value="">Seleccione un men√∫</option>';
            catalogMenus.forEach(m => {
                sel.innerHTML += `<option value="${m.menu_id}" data-price="${m.unit_price}">${m.menu_name} ‚Äî $${formatNumber(m.unit_price)}</option>`;
            });
        }
        
        function toggleCatering() {
            const show = document.getElementById('wz_include_catering').checked;
            document.getElementById('cateringFields').style.display = show ? 'block' : 'none';
        
            if (show) {
                populateWizardMenus();
                // Auto-llenar cantidad con total de participantes
                const numStudents = selectedTeamMembers.length;
                const numAdults = selectedAdultWorkers.length;
                document.getElementById('wz_catering_quantity').value = numStudents + numAdults;
                updateCateringCost();
            } else {
                document.getElementById('cateringCostPreview').style.display = 'none';
            }
        }
        
        function updateCateringCost() {
            const menuSel = document.getElementById('wz_catering_menu');
            const qty = parseInt(document.getElementById('wz_catering_quantity').value) || 0;
        
            if (!menuSel.value || qty <= 0) {
                document.getElementById('cateringCostPreview').style.display = 'none';
                return;
            }
        
            const unitPrice = parseFloat(menuSel.selectedOptions[0].getAttribute('data-price')) || 0;
            const total = unitPrice * qty;
        
            document.getElementById('cateringUnitPrice').textContent = '$' + formatNumber(unitPrice);
            document.getElementById('cateringQtyDisplay').textContent = qty + ' porciones';
            document.getElementById('cateringTotal').textContent = '$' + formatNumber(total);
            document.getElementById('cateringCostPreview').style.display = '';
        }
        
        function getCateringData() {
            if (!document.getElementById('wz_include_catering').checked) {
                return { included: false, menuId: null, quantity: null, unitPrice: null, total: 0 };
            }
            const menuSel = document.getElementById('wz_catering_menu');
            const qty = parseInt(document.getElementById('wz_catering_quantity').value) || 0;
            const unitPrice = menuSel.value ? parseFloat(menuSel.selectedOptions[0].getAttribute('data-price')) || 0 : 0;
        
            return {
                included: true,
                menuId: menuSel.value || null,
                menuName: menuSel.selectedOptions[0]?.text || '',
                quantity: qty,
                unitPrice: unitPrice,
                total: unitPrice * qty
            };
        }

        // ==========================================
        // WIZARD: SUMMARY
        // ==========================================
        // BUSCAR la funci√≥n buildSummary() completa y REEMPLAZAR CON:
        function buildSummary() {
            const name = document.getElementById('wz_trip_name').value;
            const date = document.getElementById('wz_trip_date').value;
            const eventTime = document.getElementById('wz_event_time').value;
            const depTime = document.getElementById('wz_departure_time').value;
            const retTime = document.getElementById('wz_return_time').value;
            const numAdults = selectedAdultWorkers.length;
            const destSel = document.getElementById('wz_destination');
            const destName = destSel.options[destSel.selectedIndex]?.text || '-';
            const specific = document.getElementById('wz_specific_destination').value;
            const modSel = document.getElementById('wz_modality');
            const modLabel = modSel.options[modSel.selectedIndex]?.text || '-';
        
            const disc = document.getElementById('wz_discipline');
            const discName = disc.options[disc.selectedIndex]?.text || '-';
            const cat = document.getElementById('wz_category');
            const catName = cat.options[cat.selectedIndex]?.text || '-';
        
            calculateTransportCost();
            const catering = getCateringData();
            const costoTotal = calculatedTransport.total + catering.total;
        
            const nodesHtml = [];
            if (selectedDepartureNodes.length > 0) {
                nodesHtml.push(`<strong>Salida:</strong> ${selectedDepartureNodes.map(n => n.node_name).join(', ')}`);
            }
            if (selectedArrivalNodes.length > 0) {
                nodesHtml.push(`<strong>Llegada:</strong> ${selectedArrivalNodes.map(n => n.node_name).join(', ')}`);
            }

            // Build adult workers names
            const adultNames = selectedAdultWorkers.map(wId => {
                const w = catalogWorkers.find(cw => cw.worker_id === wId);
                return w ? `${w.worker_first_name} ${w.worker_last_name_1}` : 'N/A';
            }).join(', ') || 'Ninguno';
        
            document.getElementById('wizardSummary').innerHTML = `
                <div class="detail-section">
                    <h6><i class="bi bi-info-circle me-1"></i>Informaci√≥n General</h6>
                    <div class="row g-2">
                        <div class="col-md-12"><div class="detail-label">Nombre</div><div class="detail-value">${escapeHtml(name)}</div></div>
                        <div class="col-md-4"><div class="detail-label">Fecha</div><div class="detail-value">${formatDateDisplay(date)}</div></div>
                        <div class="col-md-4"><div class="detail-label">Hora evento</div><div class="detail-value">${eventTime || 'No especificada'}</div></div>
                        <div class="col-md-4"><div class="detail-label">Adultos</div><div class="detail-value">${numAdults}</div></div>
                        <div class="col-md-6"><div class="detail-label">Hora salida</div><div class="detail-value">${depTime}</div></div>
                        <div class="col-md-6"><div class="detail-label">Hora regreso</div><div class="detail-value">${retTime}</div></div>
                        <div class="col-12"><div class="detail-label">Adultos acompa√±antes</div><div class="detail-value">${escapeHtml(adultNames)}</div></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h6><i class="bi bi-people me-1"></i>Equipo</h6>
                    <div class="row g-2">
                        <div class="col-md-4"><div class="detail-label">Disciplina</div><div class="detail-value">${discName}</div></div>
                        <div class="col-md-4"><div class="detail-label">Categor√≠a</div><div class="detail-value">${catName}</div></div>
                        <div class="col-md-4"><div class="detail-label">Participantes</div><div class="detail-value">${selectedTeamMembers.length} estudiantes + ${numAdults} adultos</div></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h6><i class="bi bi-bus-front me-1"></i>Transporte</h6>
                    <div class="row g-2">
                        <div class="col-md-6"><div class="detail-label">Destino tarifario</div><div class="detail-value">${destName}</div></div>
                        <div class="col-md-6"><div class="detail-label">Destino espec√≠fico</div><div class="detail-value">${escapeHtml(specific) || 'No especificado'}</div></div>
                        <div class="col-md-4"><div class="detail-label">Modalidad</div><div class="detail-value">${modLabel}</div></div>
                        <div class="col-md-4"><div class="detail-label">Veh√≠culos</div><div class="detail-value">${calculatedTransport.count} √ó ${calculatedTransport.capacity} pax</div></div>
                        <div class="col-md-4"><div class="detail-label">Valor transporte</div><div class="detail-value text-success fw-bold">$${formatNumber(calculatedTransport.total)}</div></div>
                        ${nodesHtml.length > 0 ? `<div class="col-12"><div class="detail-label">Nodos de transporte</div><div class="detail-value">${nodesHtml.join('<br>')}</div></div>` : ''}
                    </div>
                </div>
                <div class="detail-section">
                    <h6><i class="bi bi-cup-straw me-1"></i>Refrigerios</h6>
                    ${catering.included ? `
                        <div class="row g-2">
                            <div class="col-md-4"><div class="detail-label">Men√∫</div><div class="detail-value">${escapeHtml(catering.menuName)}</div></div>
                            <div class="col-md-4"><div class="detail-label">Cantidad</div><div class="detail-value">${catering.quantity} porciones</div></div>
                            <div class="col-md-4"><div class="detail-label">Valor refrigerios</div><div class="detail-value text-success fw-bold">$${formatNumber(catering.total)}</div></div>
                        </div>
                    ` : '<p class="text-muted mb-0">No incluye refrigerios</p>'}
                </div>
                <div class="cost-summary mt-3">
                    <div class="row align-items-center">
                        <div class="col-md-4"><div class="detail-label">Transporte</div><div class="detail-value">$${formatNumber(calculatedTransport.total)}</div></div>
                        <div class="col-md-4"><div class="detail-label">Refrigerios</div><div class="detail-value">$${formatNumber(catering.total)}</div></div>
                        <div class="col-md-4"><div class="detail-label">COSTO TOTAL</div><div class="cost-total">$${formatNumber(costoTotal)}</div></div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // SUBMIT TRIP
        // ==========================================
        async function submitTrip() {
            const approverId = document.getElementById('wz_approver').value;
            if (!approverId) {
                showMessage('Seleccione un aprobador', 'warning');
                return;
            }

            if (!currentWorker) {
                showMessage('No se pudo identificar su perfil de trabajador', 'danger');
                return;
            }

            const btn = document.getElementById('btnWizardSubmit');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Enviando...';

            try {
                // 1. Create service request
                const requestData = await supabaseRequest('/svc_service_requests', {
                    method: 'POST',
                    body: JSON.stringify({
                        service_type: 'sports_trip',
                        requested_by: currentWorker.worker_id,
                        approver_id: approverId,
                        request_status: 'pending'
                    })
                });

                const requestId = requestData[0].request_id;

                // 2. Create sports trip
                const catering = getCateringData();
                const tripBody = {
                    request_id: requestId,
                    trip_name: document.getElementById('wz_trip_name').value.trim(),
                    trip_date: formatDateForDatabase(document.getElementById('wz_trip_date').value),
                    event_time: document.getElementById('wz_event_time').value || null,
                    departure_time: document.getElementById('wz_departure_time').value,
                    return_time: document.getElementById('wz_return_time').value,
                    destination_id: document.getElementById('wz_destination').value,
                    specific_destination: document.getElementById('wz_specific_destination').value.trim() || null,
                    team_id: selectedTeamId,
                    transport_modality: document.getElementById('wz_modality').value,
                    num_adults: selectedAdultWorkers.length,
                    planned_students: selectedTeamMembers.length,
                    trip_status: 'scheduled',
                    frozen_transport_rate: calculatedTransport.rate,
                    frozen_vehicle_capacity: calculatedTransport.capacity,
                    frozen_vehicle_count: calculatedTransport.count,
                    total_transport_value: calculatedTransport.total,
                    catering_menu_id: catering.menuId || null,
                    catering_quantity: catering.quantity,
                    frozen_catering_unit_price: catering.unitPrice,
                    total_catering_value: catering.total,
                    created_by: currentSession.user.user_id
                };
                const tripData = await supabaseRequest('/svc_sports_trips', {
                    method: 'POST',
                    body: JSON.stringify(tripBody)
                });

                const tripId = tripData[0].trip_id;

                // 3. Create attendance records for team members
                if (selectedTeamMembers.length > 0) {
                    const attendanceRecords = selectedTeamMembers.map(m => ({
                        trip_id: tripId,
                        student_id: m.student_id,
                        is_attending: true
                    }));

                    await supabaseRequest('/svc_sports_trip_attendance', {
                        method: 'POST',
                        body: JSON.stringify(attendanceRecords)
                    });
                }

                // 4. Create transport nodes
                const nodeRecords = [];
                selectedDepartureNodes.forEach((n, i) => {
                    nodeRecords.push({
                        service_type: 'sports_trip',
                        trip_id: tripId,
                        node_id: n.node_id,
                        node_role: 'departure',
                        node_order: i + 1
                    });
                });
                selectedArrivalNodes.forEach((n, i) => {
                    nodeRecords.push({
                        service_type: 'sports_trip',
                        trip_id: tripId,
                        node_id: n.node_id,
                        node_role: 'arrival',
                        node_order: i + 1
                    });
                });

                if (nodeRecords.length > 0) {
                    await supabaseRequest('/svc_trip_transport_nodes', {
                        method: 'POST',
                        body: JSON.stringify(nodeRecords)
                    });
                }

                // 5. Create adult worker records
                if (selectedAdultWorkers.length > 0) {
                    const adultRecords = selectedAdultWorkers.map(wId => ({
                        trip_id: tripId,
                        worker_id: wId
                    }));
                    await supabaseRequest('/svc_sports_trip_adults', {
                        method: 'POST',
                        body: JSON.stringify(adultRecords)
                    });
                }

                // 6. Send notification to approver
                await notifyApprover(approverId, tripBody.trip_name, formatDateDisplay(tripBody.trip_date));
                
                // 7. Send notification to fixed recipients (chef, supervisor)
                const disc = catalogDisciplines.find(d => d.discipline_id === document.getElementById('wz_discipline').value);
                const cat = catalogCategories.find(c => c.category_id === document.getElementById('wz_category').value);
                await notifyFixedRecipients(
                    tripBody.trip_name,
                    formatDateDisplay(tripBody.trip_date),
                    disc?.discipline_name || '',
                    cat?.category_name || ''
                );

                // Close modal, reload
                bootstrap.Modal.getInstance(document.getElementById('createWizardModal')).hide();
                showMessage('Salida deportiva creada exitosamente. Solicitud enviada al aprobador.', 'success');
                await loadTrips();

            } catch (error) {
                console.error('Error creating trip:', error);
                showMessage('Error al crear la salida: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-send me-1"></i>Enviar Solicitud';
            }
        }

        async function notifyApprover(approverId, tripName, tripDate) {
            try {
                const approverData = await supabaseRequest(
                    `/workers?select=email,worker_first_name&worker_id=eq.${approverId}`
                );
                if (approverData && approverData.length > 0 && approverData[0].email) {
                    const senderName = currentWorker ? `${currentWorker.worker_first_name} ${currentWorker.worker_last_name_1}${currentWorker.worker_last_name_2 ? ' ' + currentWorker.worker_last_name_2 : ''}` : 'Un usuario';
                    const html = `
                        <div style="font-family:Arial,sans-serif;max-width:600px;margin:0 auto;padding:20px;">
                            <div style="background:#0d6efd;color:white;padding:15px;border-radius:8px 8px 0 0;">
                                <h2 style="margin:0;">üèüÔ∏è Nueva Solicitud de Salida Deportiva</h2>
                            </div>
                            <div style="background:white;padding:20px;border:1px solid #dee2e6;border-radius:0 0 8px 8px;">
                                <p>Hola ${approverData[0].worker_first_name},</p>
                                <p><strong>${escapeHtml(senderName)}</strong> ha solicitado la aprobaci√≥n de una salida deportiva:</p>
                                <table style="width:100%;border-collapse:collapse;margin:15px 0;">
                                    <tr><td style="padding:8px;border:1px solid #dee2e6;font-weight:bold;">Salida:</td><td style="padding:8px;border:1px solid #dee2e6;">${escapeHtml(tripName)}</td></tr>
                                    <tr><td style="padding:8px;border:1px solid #dee2e6;font-weight:bold;">Fecha:</td><td style="padding:8px;border:1px solid #dee2e6;">${tripDate}</td></tr>
                                </table>
                                <p>Por favor, ingresa a SchoolNet para revisar y aprobar o rechazar esta solicitud.</p>
                            </div>
                            <p style="color:#6c757d;font-size:12px;text-align:center;margin-top:15px;">
                                Correo autom√°tico de SchoolNet - No responder
                            </p>
                        </div>`;
                    await sendNotification(approverData[0].email, `SchoolNet - Solicitud: ${tripName}`, html);
                }
            } catch (e) {
                console.error('Error notifying approver:', e);
            }
        }

        async function notifyFixedRecipients(tripName, tripDate, disciplineName, categoryName) {
            try {
                console.log('üìß Enviando notificaciones a destinatarios fijos...');
        
                const senderName = currentWorker
                    ? `${currentWorker.worker_first_name} ${currentWorker.worker_last_name_1}${currentWorker.worker_last_name_2 ? ' ' + currentWorker.worker_last_name_2 : ''}`
                    : 'Un usuario';
        
                const buildHTML = (destinatario) => `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;">
                        <div style="background-color: #1b365d; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                            <h1 style="margin: 0; font-size: 22px;">Notificaci√≥n de Salida Deportiva</h1>
                        </div>
                        <div style="background-color: white; padding: 30px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <p style="font-size: 16px; color: #333;">
                                Estimado/a <strong>${destinatario}</strong>,
                            </p>
                            <p style="font-size: 14px; color: #666;">
                                Se ha registrado una nueva salida deportiva:
                            </p>
                            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 6px; margin: 20px 0;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Salida:</td><td style="padding: 8px 0; color: #333;">${escapeHtml(tripName)}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Equipo:</td><td style="padding: 8px 0; color: #333;">${disciplineName} - ${categoryName}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Fecha:</td><td style="padding: 8px 0; color: #333;">${tripDate}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Estudiantes:</td><td style="padding: 8px 0; color: #333;">${selectedTeamMembers.length}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Adultos:</td><td style="padding: 8px 0; color: #333;">${selectedAdultWorkers.length}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #666; font-weight: bold;">Solicitado por:</td><td style="padding: 8px 0; color: #333;">${escapeHtml(senderName)}</td></tr>
                                </table>
                            </div>
                            <p style="font-size: 12px; color: #999; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center;">
                                Este es un mensaje autom√°tico del sistema SchoolNet.<br>
                                Por favor, no responder a este correo.
                            </p>
                        </div>
                    </div>
                `;
        
                const asunto = `Salida Deportiva programada ‚Äî ${tripName} ‚Äî ${tripDate}`;
        
                const destinatarios = [
                    { email: emailChef, label: 'Chef' },
                    { email: emailSupervisor, label: 'Supervisora' }
                ];
        
                for (const dest of destinatarios) {
                    if (dest.email) {
                        await sendNotification(dest.email, asunto, buildHTML(dest.label), true);
                        console.log(`‚úÖ Notificaci√≥n enviada a ${dest.label}: ${dest.email}`);
                    } else {
                        console.warn(`‚ö†Ô∏è No hay email configurado para ${dest.label}`);
                    }
                }
        
            } catch (error) {
                console.error('‚ùå Error enviando notificaciones fijas:', error);
            }
        }

        // ==========================================
        // TRIP DETAIL VIEW
        // ==========================================
        async function openTripDetail(tripId) {
            const trip = allTrips.find(t => t.trip_id === tripId);
            if (!trip) return;

            const team = trip.svc_sports_teams;
            const dest = trip.svc_transport_destinations;
            const req = trip.svc_service_requests;

            // Load transport nodes for this trip
            let nodes = [];
            try {
                nodes = await supabaseRequest(
                    `/svc_trip_transport_nodes?select=*,svc_transport_nodes(node_name)&service_type=eq.sports_trip&trip_id=eq.${tripId}&order=node_role,node_order`
                );
            } catch (e) { console.error(e); }

            // Load adult workers for this trip
            let tripAdults = [];
            try {
                tripAdults = await supabaseRequest(
                    `/svc_sports_trip_adults?select=worker_id,workers(worker_first_name,worker_last_name_1,worker_last_name_2)&trip_id=eq.${tripId}`
                );
            } catch (e) { console.error(e); }

            const depNodes = (nodes || []).filter(n => n.node_role === 'departure').map(n => n.svc_transport_nodes?.node_name || '-');
            const arrNodes = (nodes || []).filter(n => n.node_role === 'arrival').map(n => n.svc_transport_nodes?.node_name || '-');
            const adultWorkerNames = (tripAdults || []).map(a => {
                const w = a.workers;
                return w ? `${w.worker_first_name} ${w.worker_last_name_1}${w.worker_last_name_2 ? ' ' + w.worker_last_name_2 : ''}` : '-';
            });

            // Build detail HTML
            const discipline = team?.svc_sports_disciplines?.discipline_name || '-';
            const category = team?.svc_sports_categories?.category_name || '-';
            const gender = GENDER_LABELS[team?.gender] || '-';
            const statusLabel = STATUS_LABELS[trip.trip_status];
            const modalityLabel = MODALITY_LABELS[trip.transport_modality] || trip.transport_modality;

            // Request info
            let reqHtml = '';
            if (req) {
                const reqStatusLabels = { pending: 'Pendiente', approved: 'Aprobada', rejected: 'Rechazada' };
                const reqBadge = req.request_status === 'approved' ? 'bg-success' : req.request_status === 'rejected' ? 'bg-danger' : 'bg-warning text-dark';
                reqHtml = `
                    <div class="detail-section">
                        <h6><i class="bi bi-check-square me-1"></i>Estado de Aprobaci√≥n</h6>
                        <span class="badge ${reqBadge}">${reqStatusLabels[req.request_status]}</span>
                        ${req.rejection_reason ? `<p class="text-danger mt-1 mb-0"><small>${escapeHtml(req.rejection_reason)}</small></p>` : ''}
                    </div>`;
            }

            let html = `
                ${reqHtml}
                <div class="detail-section">
                    <h6><i class="bi bi-info-circle me-1"></i>Informaci√≥n General</h6>
                    <div class="row g-2">
                        <div class="col-md-8"><div class="detail-label">Nombre</div><div class="detail-value">${escapeHtml(trip.trip_name)}</div></div>
                        <div class="col-md-4"><div class="detail-label">Estado</div><div><span class="badge badge-${trip.trip_status}"><i class="bi ${STATUS_ICONS[trip.trip_status]} me-1"></i>${statusLabel}</span></div></div>
                        ${trip.status_reason ? `<div class="col-12"><div class="detail-label">Raz√≥n</div><div class="detail-value text-danger">${escapeHtml(trip.status_reason)}</div></div>` : ''}
                        <div class="col-md-4"><div class="detail-label">Fecha</div><div class="detail-value">${formatDateDisplay(trip.trip_date)}</div></div>
                        <div class="col-md-4"><div class="detail-label">Hora evento</div><div class="detail-value">${trip.event_time?.substring(0,5) || 'N/A'}</div></div>
                        <div class="col-md-4"><div class="detail-label">Adultos</div><div class="detail-value">${trip.num_adults}</div></div>
                        ${adultWorkerNames.length > 0 ? `<div class="col-12"><div class="detail-label">Adultos acompa√±antes</div><div class="detail-value">${adultWorkerNames.join(', ')}</div></div>` : ''}
                        <div class="col-md-6"><div class="detail-label">Hora salida</div><div class="detail-value">${trip.departure_time?.substring(0,5)}</div></div>
                        <div class="col-md-6"><div class="detail-label">Hora regreso</div><div class="detail-value">${trip.return_time?.substring(0,5)}</div></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h6><i class="bi bi-people me-1"></i>Equipo</h6>
                    <div class="row g-2">
                        <div class="col-md-4"><div class="detail-label">Disciplina</div><div class="detail-value">${discipline}</div></div>
                        <div class="col-md-4"><div class="detail-label">Categor√≠a</div><div class="detail-value">${category}</div></div>
                        <div class="col-md-4"><div class="detail-label">G√©nero</div><div class="detail-value">${gender}</div></div>
                        <div class="col-md-6"><div class="detail-label">Estudiantes planeados</div><div class="detail-value">${trip.planned_students}</div></div>
                        <div class="col-md-6"><div class="detail-label">Estudiantes reales</div><div class="detail-value">${trip.actual_students ?? 'Pendiente'}</div></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h6><i class="bi bi-bus-front me-1"></i>Transporte</h6>
                    <div class="row g-2">
                        <div class="col-md-6"><div class="detail-label">Destino tarifario</div><div class="detail-value">${dest?.destination_name || '-'}</div></div>
                        <div class="col-md-6"><div class="detail-label">Destino espec√≠fico</div><div class="detail-value">${escapeHtml(trip.specific_destination || 'N/A')}</div></div>
                        <div class="col-md-4"><div class="detail-label">Modalidad</div><div class="detail-value">${modalityLabel}</div></div>
                        <div class="col-md-4"><div class="detail-label">Veh√≠culos</div><div class="detail-value">${trip.frozen_vehicle_count || 0} √ó ${trip.frozen_vehicle_capacity || 0} pax</div></div>
                        <div class="col-md-4"><div class="detail-label">Valor transporte</div><div class="cost-total">$${formatNumber(trip.total_transport_value || 0)}</div></div>
                        ${depNodes.length > 0 ? `<div class="col-md-6"><div class="detail-label">Nodos salida</div><div class="detail-value">${depNodes.join(', ')}</div></div>` : ''}
                        ${arrNodes.length > 0 ? `<div class="col-md-6"><div class="detail-label">Nodos llegada</div><div class="detail-value">${arrNodes.join(', ')}</div></div>` : ''}
                    </div>
                </div>
            `;

            // Secci√≥n de refrigerios en detalle
            if (trip.catering_menu_id) {
                // Buscar nombre del men√∫
                const menuInfo = catalogMenus.find(m => m.menu_id === trip.catering_menu_id);
                const menuName = menuInfo ? menuInfo.menu_name : 'Men√∫ no disponible';
                html += `
                    <div class="detail-section">
                        <h6><i class="bi bi-cup-straw me-1"></i>Refrigerios</h6>
                        <div class="row g-2">
                            <div class="col-md-4"><div class="detail-label">Men√∫</div><div class="detail-value">${escapeHtml(menuName)}</div></div>
                            <div class="col-md-4"><div class="detail-label">Cantidad</div><div class="detail-value">${trip.catering_quantity || 0} porciones</div></div>
                            <div class="col-md-4"><div class="detail-label">Valor refrigerios</div><div class="cost-total">$${formatNumber(trip.total_catering_value || 0)}</div></div>
                        </div>
                    </div>
                `;
            }
            
            // Costo total consolidado
            const costoTotalTrip = (trip.total_transport_value || 0) + (trip.total_catering_value || 0);
            html += `
                <div class="detail-section">
                    <h6><i class="bi bi-calculator me-1"></i>Costo Total</h6>
                    <div class="cost-summary">
                        <div class="row">
                            <div class="col-md-4"><div class="detail-label">Transporte</div><div class="detail-value">$${formatNumber(trip.total_transport_value || 0)}</div></div>
                            <div class="col-md-4"><div class="detail-label">Refrigerios</div><div class="detail-value">$${formatNumber(trip.total_catering_value || 0)}</div></div>
                            <div class="col-md-4"><div class="detail-label">TOTAL</div><div class="cost-total">$${formatNumber(costoTotalTrip)}</div></div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('detailTitle').innerHTML = `<i class="bi bi-trophy me-2"></i>${escapeHtml(trip.trip_name)}`;
            document.getElementById('detailBody').innerHTML = html;

            // Footer actions based on status
            let footerHtml = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>';

            const isApproved = req && req.request_status === 'approved';

            if (trip.trip_status === 'imminent' && isApproved) {
                footerHtml = `
                    <button class="btn btn-outline-info" onclick="openAttendance('${tripId}')"><i class="bi bi-person-check me-1"></i>Asistencia</button>
                    <button class="btn btn-primary" onclick="changeStatus('${tripId}','in_progress')"><i class="bi bi-play-circle me-1"></i>Iniciar Salida</button>
                    <button class="btn btn-danger" onclick="openStatusChange('${tripId}','suspended')"><i class="bi bi-pause-circle me-1"></i>Suspender</button>
                    ${footerHtml}`;
            } else if (trip.trip_status === 'scheduled' && isApproved) {
                footerHtml = `
                    <button class="btn btn-danger" onclick="openStatusChange('${tripId}','cancelled')"><i class="bi bi-x-circle me-1"></i>Cancelar</button>
                    ${footerHtml}`;
            } else if (trip.trip_status === 'in_progress') {
                footerHtml = `
                    <button class="btn btn-outline-dark" onclick="generarPDFDeportiva('${tripId}')"><i class="bi bi-file-earmark-pdf me-1"></i>Descargar PDF</button>
                    <button class="btn btn-outline-info" onclick="openAttendance('${tripId}')"><i class="bi bi-person-check me-1"></i>Ver Asistencia</button>
                    <button class="btn btn-danger" onclick="openStatusChange('${tripId}','suspended')"><i class="bi bi-pause-circle me-1"></i>Suspender</button>
                    ${footerHtml}`;
            } else if (trip.trip_status === 'completed') {
                footerHtml = `
                    <button class="btn btn-outline-dark" onclick="generarPDFDeportiva('${tripId}')"><i class="bi bi-file-earmark-pdf me-1"></i>Descargar PDF</button>
                    <button class="btn btn-outline-info" onclick="openAttendance('${tripId}')"><i class="bi bi-person-check me-1"></i>Ver Asistencia</button>
                    ${footerHtml}`;
            }

            document.getElementById('detailFooter').innerHTML = footerHtml;
            new bootstrap.Modal(document.getElementById('tripDetailModal')).show();
        }

        // ==========================================
        // STATUS CHANGES
        // ==========================================
        async function changeStatus(tripId, newStatus) {
            if (newStatus === 'in_progress') {
                if (!confirm('¬øConfirma que los veh√≠culos est√°n saliendo? Esta acci√≥n marca el inicio de la salida.')) return;
                try {
                    await updateTripStatus(tripId, 'in_progress');
                    // Update actual students count
                    const attendance = await supabaseRequest(
                        `/svc_sports_trip_attendance?select=attendance_id&trip_id=eq.${tripId}&is_attending=eq.true`
                    );
                    const actualCount = attendance ? attendance.length : 0;
                    await supabaseRequest(`/svc_sports_trips?trip_id=eq.${tripId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ actual_students: actualCount })
                    });

                    bootstrap.Modal.getInstance(document.getElementById('tripDetailModal')).hide();
                    showMessage('Salida marcada como "En proceso"', 'success');
                    await loadTrips();
                } catch (e) {
                    showMessage('Error al cambiar estado: ' + e.message, 'danger');
                }
            }
        }

        function openStatusChange(tripId, newStatus) {
            pendingStatusChange = { tripId, newStatus };
            document.getElementById('statusChangeReason').value = '';
            const titles = { suspended: 'Suspender Salida', cancelled: 'Cancelar Salida' };
            document.getElementById('statusChangeTitle').textContent = titles[newStatus] || 'Cambiar Estado';
            document.getElementById('btnConfirmStatusChange').className = 'btn btn-danger';
            new bootstrap.Modal(document.getElementById('statusChangeModal')).show();
        }

        async function confirmStatusChange() {
            const reason = document.getElementById('statusChangeReason').value.trim();
            if (!reason) { showMessage('Debe indicar la raz√≥n', 'warning'); return; }

            const btn = document.getElementById('btnConfirmStatusChange');
            btn.disabled = true;

            try {
                await updateTripStatus(pendingStatusChange.tripId, pendingStatusChange.newStatus, reason);
                bootstrap.Modal.getInstance(document.getElementById('statusChangeModal')).hide();
                bootstrap.Modal.getInstance(document.getElementById('tripDetailModal'))?.hide();
                showMessage(`Salida ${pendingStatusChange.newStatus === 'suspended' ? 'suspendida' : 'cancelada'} exitosamente`, 'success');
                await loadTrips();
            } catch (e) {
                showMessage('Error: ' + e.message, 'danger');
            } finally {
                btn.disabled = false;
            }
        }

        // ==========================================
        // ATTENDANCE MANAGEMENT
        // ==========================================
        async function openAttendance(tripId) {
            const trip = allTrips.find(t => t.trip_id === tripId);
            if (!trip) return;

            try {
                const attendance = await supabaseRequest(
                    `/svc_sports_trip_attendance?select=*,students(student_id,student_first_name,student_last_name_1,student_last_name_2,student_code,courses(course_name))&trip_id=eq.${tripId}&order=students(student_last_name_1),students(student_first_name)`
                );

                const canEdit = trip.trip_status === 'imminent';
                const attending = (attendance || []).filter(a => a.is_attending);
                const unlinked = (attendance || []).filter(a => !a.is_attending);

                let html = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong>Planeados:</strong> ${trip.planned_students} |
                            <strong class="text-success">Asistentes:</strong> ${attending.length} |
                            <strong class="text-danger">Desvinculados:</strong> ${unlinked.length}
                        </div>
                    </div>`;

                if (attending.length > 0) {
                    html += '<h6 class="text-success"><i class="bi bi-check-circle me-1"></i>Asistentes</h6>';
                    attending.forEach(a => {
                        const s = a.students;
                        const studentName = s ? `${s.student_last_name_1} ${s.student_last_name_2 || ''} ${s.student_first_name}`.trim() : 'Estudiante';
                        const course = s?.courses?.course_name || '';
                        html += `
                            <div class="student-attendance-item">
                                <div>
                                    <strong>${escapeHtml(studentName)}</strong>
                                    <small class="text-muted ms-2">${course}</small>
                                </div>
                                ${canEdit ? `
                                    <button class="btn btn-sm btn-outline-danger" onclick="unlinkStudent('${tripId}','${a.attendance_id}','${escapeHtml(studentName)}')">
                                        <i class="bi bi-person-dash me-1"></i>Desvincular
                                    </button>
                                ` : ''}
                            </div>`;
                    });
                }

                if (unlinked.length > 0) {
                    html += '<h6 class="text-danger mt-3"><i class="bi bi-x-circle me-1"></i>Desvinculados</h6>';
                    unlinked.forEach(a => {
                        const s = a.students;
                        const studentName = s ? `${s.student_last_name_1} ${s.student_last_name_2 || ''} ${s.student_first_name}`.trim() : 'Estudiante';
                        html += `
                            <div class="student-attendance-item student-unlinked">
                                <div>
                                    <strong>${escapeHtml(studentName)}</strong>
                                    <small class="text-danger ms-2">${escapeHtml(a.unlinked_reason || '')}</small>
                                </div>
                            </div>`;
                    });
                }

                document.getElementById('attendanceBody').innerHTML = html;
                // Hide detail modal first if open
                const detailModal = bootstrap.Modal.getInstance(document.getElementById('tripDetailModal'));
                if (detailModal) detailModal.hide();
                setTimeout(() => {
                    new bootstrap.Modal(document.getElementById('attendanceModal')).show();
                }, 300);

            } catch (e) {
                console.error('Error loading attendance:', e);
                showMessage('Error cargando asistencia', 'danger');
            }
        }

        async function unlinkStudent(tripId, attendanceId, studentName) {
            const reason = prompt(`Raz√≥n para desvincular a ${studentName}:`, 'No se present√≥');
            if (reason === null) return; // Cancelled

            try {
                await supabaseRequest(`/svc_sports_trip_attendance?attendance_id=eq.${attendanceId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        is_attending: false,
                        unlinked_at: new Date().toISOString(),
                        unlinked_reason: reason || 'No se present√≥'
                    })
                });
                showMessage(`${studentName} desvinculado`, 'info');
                openAttendance(tripId);
            } catch (e) {
                showMessage('Error: ' + e.message, 'danger');
            }
        }

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        function formatNumber(num) {
            return new Intl.NumberFormat('es-CO').format(Math.round(num));
        }

        function formatDateDisplay(dateStr) {
            if (!dateStr) return '-';
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function formatDateForDatabase(dateString) {
            if (!dateString) return null;
            if (dateString.includes('T')) return dateString.split('T')[0];
            return dateString;
        }

        function getCurrentDateColombia() {
            const now = new Date();
            const colombiaOffset = -5 * 60;
            const localOffset = now.getTimezoneOffset();
            const colombiaTime = new Date(now.getTime() + (localOffset + colombiaOffset) * 60000);
            const year = colombiaTime.getFullYear();
            const month = String(colombiaTime.getMonth() + 1).padStart(2, '0');
            const day = String(colombiaTime.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ==========================================
        // PDF UTILITIES
        // ==========================================
        function cargarImagenBase64(url) {
            return new Promise((resolve) => {
                if (!url) { resolve(null); return; }
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas.toDataURL('image/png'));
                    } catch (e) {
                        console.warn('‚ö†Ô∏è No se pudo convertir imagen a base64:', e);
                        resolve(null);
                    }
                };
                img.onerror = () => { resolve(null); };
                img.src = url;
            });
        }

        function calcularEdad(birthday) {
            if (!birthday) return '';
            const birth = new Date(birthday + 'T00:00:00');
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }

        function formatearHora12(timeStr) {
            if (!timeStr) return '';
            const [h, m] = timeStr.split(':');
            let hour = parseInt(h);
            const ampm = hour >= 12 ? 'pm' : 'am';
            if (hour > 12) hour -= 12;
            if (hour === 0) hour = 12;
            return `${hour}:${m} ${ampm}`;
        }

        // ==========================================
        // PDF GENERATION
        // ==========================================
        async function generarPDFDeportiva(tripId) {
            try {
                showMessage('<i class="bi bi-hourglass-split me-1"></i>Generando PDF, por favor espere...', 'info');

                // ‚îÄ‚îÄ 1. OBTENER TODOS LOS DATOS ‚îÄ‚îÄ
                const [tripArr, nodos, asistencia, adultos, configArr] = await Promise.all([
                    supabaseRequest(
                        `/svc_sports_trips?select=*,` +
                        `destination:svc_transport_destinations(destination_name),` +
                        `team:svc_sports_teams(gender,coach_name,coach_contact,` +
                            `discipline:svc_sports_disciplines(discipline_name),` +
                            `category:svc_sports_categories(category_name)),` +
                        `request:svc_service_requests(` +
                            `requested_by,approver_id,` +
                            `requester:workers!svc_service_requests_requested_by_fkey(worker_first_name,worker_last_name_1,worker_last_name_2,worker_phone,worker_id_doc,worker_birthday,` +
                                `document_type:document_types(document_type_abbr),eps:eps_entities(eps_name)),` +
                            `approver:workers!svc_service_requests_approver_fkey(worker_first_name,worker_last_name_1,worker_last_name_2)` +
                        `)` +
                        `&trip_id=eq.${tripId}`
                    ),
                    supabaseRequest(
                        `/svc_trip_transport_nodes?select=node_role,node_order,svc_transport_nodes(node_name)` +
                        `&service_type=eq.sports_trip&trip_id=eq.${tripId}&order=node_role,node_order`
                    ),
                    supabaseRequest(
                        `/svc_sports_trip_attendance?select=student_id,` +
                        `students(student_first_name,student_last_name_1,student_last_name_2,student_id_document,student_birthday,` +
                            `document_type:document_types(document_type_abbr),eps:eps_entities(eps_name),` +
                            `course:courses(course_name,grade:grades(grade_name)))` +
                        `&trip_id=eq.${tripId}&is_attending=eq.true`
                    ),
                    supabaseRequest(
                        `/svc_sports_trip_adults?select=worker_id,` +
                        `workers(worker_first_name,worker_last_name_1,worker_last_name_2,worker_id_doc,worker_birthday,` +
                            `document_type:document_types(document_type_abbr),eps:eps_entities(eps_name))` +
                        `&trip_id=eq.${tripId}`
                    ),
                    supabaseRequest(
                        `/system_config?select=organization_name,logo_url,principal_name,principal_signature_url,` +
                        `academic_year:academic_years!system_config_current_academic_year_fkey(year_name)`
                    )
                ]);

                if (!tripArr || tripArr.length === 0) {
                    showMessage('No se encontr√≥ la salida deportiva', 'danger');
                    return;
                }

                const trip = tripArr[0];
                const config = configArr && configArr.length > 0 ? configArr[0] : {};
                const request = trip.request;
                const requester = request?.requester;
                const team = trip.team;

                // Procesar nodos
                const nodosSalida = (nodos || []).filter(n => n.node_role === 'departure').map(n => n.svc_transport_nodes?.node_name).filter(Boolean);
                const nodosLlegada = (nodos || []).filter(n => n.node_role === 'arrival').map(n => n.svc_transport_nodes?.node_name).filter(Boolean);

                // Procesar fecha
                const mesesArr = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO',
                               'JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
                const fechaObj = new Date(trip.trip_date + 'T00:00:00');
                const dia = fechaObj.getDate();
                const mes = mesesArr[fechaObj.getMonth()];
                const anio = fechaObj.getFullYear();

                // Procesar estudiantes (ordenar por apellido)
                const estudiantes = (asistencia || [])
                    .filter(a => a.students)
                    .sort((a, b) => (a.students.student_last_name_1 || '').localeCompare(b.students.student_last_name_1 || ''));

                // Procesar adultos (ordenar por apellido)
                const profesores = (adultos || [])
                    .filter(a => a.workers)
                    .sort((a, b) => (a.workers.worker_last_name_1 || '').localeCompare(b.workers.worker_last_name_1 || ''));

                // Cargar im√°genes
                const [logoBase64, firmaBase64] = await Promise.all([
                    cargarImagenBase64(config.logo_url),
                    cargarImagenBase64(config.principal_signature_url)
                ]);

                const yearName = config.academic_year?.year_name || `${anio}-${anio + 1}`;

                // Info del equipo
                const disciplina = team?.discipline?.discipline_name || '';
                const categoria = team?.category?.category_name || '';
                const genero = GENDER_LABELS[team?.gender] || '';
                const entrenador = team?.coach_name || '';

                // ‚îÄ‚îÄ 2. CREAR PDF ‚îÄ‚îÄ
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'letter');
                const pageWidth = 216;
                const margin = 15;
                const contentWidth = pageWidth - margin * 2;
                let y = 15;

                const azulOscuro = [27, 54, 93];
                const grisClaro = [240, 240, 240];
                const negro = [0, 0, 0];

                // ‚îÄ‚îÄ ENCABEZADO ‚îÄ‚îÄ
                if (logoBase64) {
                    try { doc.addImage(logoBase64, 'PNG', margin, y, 30, 30); } catch (e) {}
                }

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(...azulOscuro);
                doc.text(`SALIDAS DEPORTIVAS ${yearName}`, pageWidth / 2, y + 12, { align: 'center' });
                y += 35;

                // ‚îÄ‚îÄ TABLA DE INFORMACI√ìN ‚îÄ‚îÄ
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.3);
                doc.setFontSize(8);
                doc.setTextColor(...negro);

                // Fila: Instituci√≥n | Municipio
                doc.rect(margin, y, contentWidth, 7);
                doc.rect(margin, y, contentWidth * 0.6, 7);
                doc.setFont('helvetica', 'bold');
                doc.text('INSTITUCI√ìN: COLEGIO TILAT√Å - NIT. 800.164.741-5', margin + 2, y + 5);
                doc.text('MUNICIPIO: LA CALERA', margin + contentWidth * 0.6 + 2, y + 5);
                y += 7;

                // Fila: Evento | Fecha
                doc.rect(margin, y, contentWidth, 7);
                doc.rect(margin, y, contentWidth * 0.5, 7);
                doc.setFont('helvetica', 'normal');
                doc.text('EVENTO:', margin + 2, y + 5);
                doc.setFont('helvetica', 'bold');
                doc.text(trip.trip_name || '', margin + 20, y + 5);
                doc.setFont('helvetica', 'normal');
                doc.text('FECHA:', margin + contentWidth * 0.5 + 2, y + 5);
                doc.setFont('helvetica', 'bold');
                doc.text(`${dia}  ${mes}  ${anio}`, margin + contentWidth * 0.5 + 18, y + 5);
                y += 7;

                // Fila: Equipo
                doc.rect(margin, y, contentWidth, 7);
                doc.setFont('helvetica', 'bold');
                const equipoTexto = `EQUIPO: ${disciplina} ‚Äî ${categoria} ‚Äî ${genero}` +
                    (entrenador ? `   |   ENTRENADOR: ${entrenador}` : '');
                doc.text(equipoTexto, margin + 2, y + 5);
                y += 7;

                // Fila: Destino
                const nombreDestino = trip.destination?.destination_name || '';
                const destinoEspecifico = trip.specific_destination || '';
                doc.rect(margin, y, contentWidth, 7);
                doc.text(`DESTINO: ${nombreDestino}${destinoEspecifico ? '  ‚Äî  ' + destinoEspecifico : ''}`, margin + 2, y + 5);
                y += 7;

                // Fila: Hora salida + nodos
                doc.rect(margin, y, contentWidth, 7);
                const horaSalidaTexto = `SALIENDO DE TILAT√Å A LAS: ${formatearHora12(trip.departure_time)}` +
                    (nodosSalida.length > 0 ? ` ‚Äî Paradas: ${nodosSalida.join(', ')}` : '');
                doc.text(horaSalidaTexto, margin + 2, y + 5);
                y += 7;

                // Fila: Hora regreso + nodos
                doc.rect(margin, y, contentWidth, 7);
                const horaRegresoTexto = `HORA FINALIZACI√ìN EVENTO: ${formatearHora12(trip.return_time)}` +
                    (nodosLlegada.length > 0 ? ` ‚Äî Paradas: ${nodosLlegada.join(', ')}` : '');
                doc.text(horaRegresoTexto, margin + 2, y + 5);
                y += 7;

                // Fila: Hora del evento (si existe)
                if (trip.event_time) {
                    doc.rect(margin, y, contentWidth, 7);
                    doc.text(`HORA DEL EVENTO: ${formatearHora12(trip.event_time)}`, margin + 2, y + 5);
                    y += 7;
                }

                y += 3;

                // ‚îÄ‚îÄ CONTACTOS ‚îÄ‚îÄ
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(7);
                doc.setTextColor(80, 80, 80);
                doc.text('CONTACTO EN TILAT√Å ANTE EVENTUALIDAD M√âDICA: 3176592097 - 6013849880 Ext. 137 - 121', pageWidth / 2, y, { align: 'center' });
                y += 4;
                doc.text('CONTACTO FUERA DE TILAT√Å ANTE EVENTUALIDAD M√âDICA AXA COLPATRIA # 247', pageWidth / 2, y, { align: 'center' });
                y += 6;

                // ‚îÄ‚îÄ RESPONSABLE ‚îÄ‚îÄ
                doc.setFontSize(8);
                doc.setTextColor(...negro);
                doc.setFont('helvetica', 'bold');
                const nombreResponsable = requester ?
                    `${requester.worker_first_name} ${requester.worker_last_name_1}${requester.worker_last_name_2 ? ' ' + requester.worker_last_name_2 : ''}` : 'N/A';
                const celularResponsable = requester?.worker_phone || '';

                doc.text(`RESPONSABLE DE LA SALIDA: ${nombreResponsable}`, margin, y);
                doc.text(`CELULAR: ${celularResponsable}`, pageWidth - margin, y, { align: 'right' });
                y += 6;

                // ‚îÄ‚îÄ TABLA DE ESTUDIANTES ‚îÄ‚îÄ
                const studentHeaders = [['No.', 'ESTUDIANTE', 'TIPO DE\nDOCUMENTO', 'DOCUMENTO DE\nIDENTIDAD', 'EDAD', 'EPS', 'GRADO']];

                const studentRows = estudiantes.map((est, idx) => {
                    const s = est.students;
                    const nombre = `${s.student_last_name_1 || ''}${s.student_last_name_2 ? ' ' + s.student_last_name_2 : ''}, ${s.student_first_name || ''}`;
                    const tipoDoc = s.document_type?.document_type_abbr || '';
                    const numDoc = s.student_id_document || '';
                    const edad = calcularEdad(s.student_birthday);
                    const eps = s.eps?.eps_name || '';
                    const grado = s.course?.course_name || '';
                    return [idx + 1, nombre, tipoDoc, numDoc, edad, eps, grado];
                });

                doc.autoTable({
                    startY: y,
                    head: studentHeaders,
                    body: studentRows,
                    theme: 'grid',
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 7,
                        cellPadding: 1.5,
                        lineColor: [180, 180, 180],
                        lineWidth: 0.2,
                        textColor: negro
                    },
                    headStyles: {
                        fillColor: grisClaro,
                        textColor: negro,
                        fontStyle: 'bold',
                        halign: 'center',
                        fontSize: 7
                    },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 10 },
                        1: { cellWidth: 55 },
                        2: { halign: 'center', cellWidth: 18 },
                        3: { halign: 'center', cellWidth: 28 },
                        4: { halign: 'center', cellWidth: 12 },
                        5: { cellWidth: 30 },
                        6: { cellWidth: 33 }
                    }
                });

                y = doc.lastAutoTable.finalY + 8;

                // ‚îÄ‚îÄ ADULTOS ACOMPA√ëANTES ‚îÄ‚îÄ
                if (y + 40 > 270) {
                    doc.addPage();
                    y = 15;
                }

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.setTextColor(...negro);
                doc.text('ADULTOS ACOMPA√ëANTES', pageWidth / 2, y, { align: 'center' });
                y += 5;

                const profHeaders = [['No.', 'NOMBRE', 'TIPO DE\nDOCUMENTO', 'DOCUMENTO DE\nIDENTIDAD', 'EDAD', 'EPS']];

                const profRows = profesores.map((prof, idx) => {
                    const w = prof.workers;
                    const nombre = `${w.worker_first_name || ''} ${w.worker_last_name_1 || ''}${w.worker_last_name_2 ? ' ' + w.worker_last_name_2 : ''}`;
                    const tipoDoc = w.document_type?.document_type_abbr || 'c.c.';
                    const numDoc = w.worker_id_doc || '';
                    const edad = calcularEdad(w.worker_birthday);
                    const eps = w.eps?.eps_name || '';
                    return [idx + 1, nombre, tipoDoc, numDoc, edad, eps];
                });

                doc.autoTable({
                    startY: y,
                    head: profHeaders,
                    body: profRows,
                    theme: 'grid',
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 7,
                        cellPadding: 1.5,
                        lineColor: [180, 180, 180],
                        lineWidth: 0.2,
                        textColor: negro
                    },
                    headStyles: {
                        fillColor: grisClaro,
                        textColor: negro,
                        fontStyle: 'bold',
                        halign: 'center',
                        fontSize: 7
                    },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 10 },
                        1: { cellWidth: 60 },
                        2: { halign: 'center', cellWidth: 22 },
                        3: { halign: 'center', cellWidth: 35 },
                        4: { halign: 'center', cellWidth: 15 },
                        5: { cellWidth: 44 }
                    }
                });

                y = doc.lastAutoTable.finalY + 15;

                // ‚îÄ‚îÄ FIRMA DEL RECTOR ‚îÄ‚îÄ
                if (y + 45 > 270) {
                    doc.addPage();
                    y = 15;
                }

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.text('Aprob√≥:', margin, y);
                y += 5;

                if (firmaBase64) {
                    try { doc.addImage(firmaBase64, 'PNG', margin, y, 40, 20); } catch (e) {}
                }
                y += 22;

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                const nombreRector = (config.principal_name || 'RECTOR').toUpperCase();
                doc.text(nombreRector, margin, y);
                y += 4;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.text('RECTOR', margin, y);

                if (logoBase64) {
                    try { doc.addImage(logoBase64, 'PNG', pageWidth / 2 - 10, y - 22, 20, 20); } catch (e) {}
                }

                // ‚îÄ‚îÄ PIE DE P√ÅGINA ‚îÄ‚îÄ
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(6);
                    doc.setTextColor(150, 150, 150);
                    doc.text(
                        `Documento generado por SchoolNet ‚Äî Colegio Tilat√° ‚Äî P√°gina ${i} de ${totalPages}`,
                        pageWidth / 2, 275, { align: 'center' }
                    );
                }

                // ‚îÄ‚îÄ 3. DESCARGAR ‚îÄ‚îÄ
                const nombreArchivo = (trip.trip_name || 'salida').replace(/\s+/g, '_');
                doc.save(`Salida_Deportiva_${nombreArchivo}_${trip.trip_date}.pdf`);

                showMessage('‚úÖ PDF descargado correctamente', 'success');

            } catch (error) {
                console.error('‚ùå Error generando PDF:', error);
                showMessage('Error al generar el PDF: ' + error.message, 'danger');
            }
        }

        console.log('‚úÖ Sports Trips page loaded');
    </script>
</body>
</html>
