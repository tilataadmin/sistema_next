<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.27.16.00">
    <title>Grupos de Representación - SchoolNet</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .loading-overlay.hidden { display: none; }
        .loading-content { background: white; padding: 2rem; border-radius: 8px; text-align: center; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #0d9488; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .btn-teal { background-color: #0d9488; border-color: #0d9488; color: #fff; }
        .btn-teal:hover { background-color: #0f766e; border-color: #0f766e; color: #fff; }
        .btn-outline-teal { color: #0d9488; border-color: #0d9488; }
        .btn-outline-teal:hover { background-color: #0d9488; color: #fff; }

        .badge-active { background-color: #d1fae5; color: #065f46; }
        .badge-inactive { background-color: #fee2e2; color: #991b1b; }

        .table th { font-size: 0.85rem; white-space: nowrap; }
        .table td { vertical-align: middle; font-size: 0.9rem; }
        .empty-state { text-align: center; padding: 3rem 1rem; color: #6c757d; }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; display: block; }

        .catalog-table th, .catalog-table td { font-size: 0.85rem; padding: 0.5rem 0.75rem; }

        /* Panel de integrantes */
        .members-panel { background: #f8f9fa; border-radius: 8px; padding: 1.25rem; margin-top: 1rem; }
        .member-row { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef; }
        .member-row:last-child { border-bottom: none; }
        .member-info { display: flex; align-items: center; gap: 0.75rem; }

        /* Buscador de estudiantes */
        .search-results { max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; background: white; }
        .search-result-item { padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .search-result-item:hover { background-color: #ccfbf1; }
        .search-result-item:last-child { border-bottom: none; }

        .group-row { cursor: pointer; }
        .group-row:hover { background-color: #f0fdfa !important; }
        .group-row.selected { background-color: #ccfbf1 !important; }

        .count-badge { background-color: #0d9488; color: white; font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 1rem; }
    </style>
</head>

<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando grupos de representación...</p>
        </div>
    </div>

    <div class="container-fluid">

        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a></li>
                <li class="breadcrumb-item"><a href="index.html">Servicios y Eventos</a></li>
                <li class="breadcrumb-item active" aria-current="page">Grupos de Representación</li>
            </ol>
        </nav>

        <!-- HEADER -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-music-note-beamed me-2" style="color: #0d9488;"></i>
                    Grupos de Representación
                </h1>
                <p class="text-muted">Disciplinas de representación, directores e integrantes de cada grupo.</p>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- ============================================================ -->
        <!-- CATÁLOGO DE DISCIPLINAS (COLAPSABLE) -->
        <!-- ============================================================ -->
        <div class="accordion mb-4" id="accordionCatalogos">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-disciplinas">
                        <i class="bi bi-stars me-2"></i>Disciplinas de Representación
                        <span class="ms-2 count-badge" id="count-disciplinas">0</span>
                    </button>
                </h2>
                <div id="collapse-disciplinas" class="accordion-collapse collapse" data-bs-parent="#accordionCatalogos">
                    <div class="accordion-body">
                        <div class="d-flex justify-content-end mb-2">
                            <button class="btn btn-teal btn-sm" onclick="abrirModalDisciplina()">
                                <i class="bi bi-plus-circle me-1"></i>Nueva Disciplina
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm catalog-table mb-0">
                                <thead class="table-light">
                                    <tr><th>Nombre</th><th>Estado</th><th class="text-end">Acciones</th></tr>
                                </thead>
                                <tbody id="tbody-disciplinas"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- GRUPOS — SECCIÓN PRINCIPAL -->
        <!-- ============================================================ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="mb-0"><i class="bi bi-people me-2"></i>Grupos</h5>
                <div class="d-flex gap-2 flex-wrap">
                    <select class="form-select form-select-sm" id="filtro-disciplina" style="width: auto;" onchange="renderGrupos()">
                        <option value="">Todas las disciplinas</option>
                    </select>
                    <button class="btn btn-teal btn-sm" onclick="abrirModalGrupo()">
                        <i class="bi bi-plus-circle me-1"></i>Nuevo Grupo
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Disciplina</th>
                                <th>Director</th>
                                <th class="text-center">Integrantes</th>
                                <th>Estado</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-grupos"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- PANEL DE INTEGRANTES -->
        <!-- ============================================================ -->
        <div class="card mb-4 d-none" id="panel-integrantes">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-person-lines-fill me-2"></i>
                    Integrantes — <span id="titulo-grupo-seleccionado"></span>
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="cerrarPanelIntegrantes()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="card-body">
                <!-- Buscador para agregar -->
                <div class="row mb-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label fw-semibold">Agregar estudiante</label>
                        <input type="text" class="form-control" id="buscar-estudiante" placeholder="Escribir nombre del estudiante..." oninput="buscarEstudiantes()">
                        <div id="resultados-busqueda" class="search-results d-none mt-1"></div>
                    </div>
                </div>

                <!-- Lista de integrantes actuales -->
                <h6 class="text-secondary mb-2">Integrantes actuales <span class="count-badge" id="count-integrantes">0</span></h6>
                <div id="lista-integrantes">
                    <div class="text-muted text-center py-3">Selecciona un grupo para ver sus integrantes</div>
                </div>
            </div>
        </div>

    </div><!-- /container -->

    <!-- ================================================================= -->
    <!-- MODAL DISCIPLINA -->
    <!-- ================================================================= -->
    <div class="modal fade" id="modal-disciplina" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-disciplina-title"><i class="bi bi-stars me-2"></i>Nueva Disciplina</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-disciplina" onsubmit="guardarDisciplina(event)">
                    <div class="modal-body">
                        <input type="hidden" id="disciplina-id">
                        <div class="mb-3">
                            <label class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="disciplina-nombre" required>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="disciplina-activo" checked>
                            <label class="form-check-label" for="disciplina-activo">Activa</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-teal btn-sm">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ================================================================= -->
    <!-- MODAL GRUPO -->
    <!-- ================================================================= -->
    <div class="modal fade" id="modal-grupo" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-grupo-title"><i class="bi bi-people me-2"></i>Nuevo Grupo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-grupo" onsubmit="guardarGrupo(event)">
                    <div class="modal-body">
                        <input type="hidden" id="grupo-id">
                        <div class="mb-3">
                            <label class="form-label">Disciplina <span class="text-danger">*</span></label>
                            <select class="form-select" id="grupo-disciplina" required>
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Director</label>
                            <select class="form-select" id="grupo-director">
                                <option value="">— Sin asignar —</option>
                            </select>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="grupo-activo" checked>
                            <label class="form-check-label" for="grupo-activo">Activo</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-teal">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let cacheDisciplinas = [];
        let cacheGrupos = [];
        let cacheIntegrantes = [];
        let cacheWorkers = [];
        let grupoSeleccionado = null;
        let timeoutBusqueda = null;

        let modalDisciplina, modalGrupo;

        const badgeEstado = a => a ? '<span class="badge badge-active">Activo</span>' : '<span class="badge badge-inactive">Inactivo</span>';
        const emptyRow = (cols, msg) => `<tr><td colspan="${cols}" class="empty-state"><i class="bi bi-inbox"></i>${msg || 'No hay registros'}</td></tr>`;

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const hasAccess = await validatePageAccess('Grupos de representación');
                if (!hasAccess) return;

                const session = getStoredSession();
                if (!session || !session.user) {
                    showMessage('Sesión no válida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '../../login.html', 1500);
                    return;
                }
                currentUser = session.user;

                await inicializarPagina();
            } catch (error) {
                console.error('❌ Error:', error);
                showMessage('Error de validación: ' + error.message, 'danger');
            }
        });

        async function inicializarPagina() {
            try {
                mostrarLoading();

                modalDisciplina = new bootstrap.Modal(document.getElementById('modal-disciplina'));
                modalGrupo = new bootstrap.Modal(document.getElementById('modal-grupo'));

                await Promise.all([
                    cargarDisciplinas(),
                    cargarWorkers()
                ]);

                await cargarGrupos();

                ocultarLoading();
                console.log('✅ Grupos de representación cargados');
            } catch (error) {
                console.error('❌ Error inicializando:', error);
                showMessage('Error al cargar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // DISCIPLINAS
        // ==========================================
        async function cargarDisciplinas() {
            try {
                const data = await supabaseRequest('/svc_rep_disciplines?select=*&order=discipline_name.asc');
                cacheDisciplinas = data || [];
                renderDisciplinas();
                poblarFiltroDisciplinas();
                document.getElementById('count-disciplinas').textContent = cacheDisciplinas.length;
            } catch (e) { console.error('❌ Error disciplinas:', e); }
        }

        function renderDisciplinas() {
            const tbody = document.getElementById('tbody-disciplinas');
            if (cacheDisciplinas.length === 0) { tbody.innerHTML = emptyRow(3, 'No hay disciplinas'); return; }
            tbody.innerHTML = cacheDisciplinas.map(d => `
                <tr>
                    <td><strong>${d.discipline_name}</strong></td>
                    <td>${badgeEstado(d.is_active)}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="editarDisciplina('${d.discipline_id}')"><i class="bi bi-pencil"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function abrirModalDisciplina() {
            document.getElementById('form-disciplina').reset();
            document.getElementById('disciplina-id').value = '';
            document.getElementById('disciplina-activo').checked = true;
            document.getElementById('modal-disciplina-title').innerHTML = '<i class="bi bi-stars me-2"></i>Nueva Disciplina';
            modalDisciplina.show();
        }

        function editarDisciplina(id) {
            const d = cacheDisciplinas.find(x => x.discipline_id === id);
            if (!d) return;
            document.getElementById('disciplina-id').value = d.discipline_id;
            document.getElementById('disciplina-nombre').value = d.discipline_name;
            document.getElementById('disciplina-activo').checked = d.is_active;
            document.getElementById('modal-disciplina-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Disciplina';
            modalDisciplina.show();
        }

        async function guardarDisciplina(e) {
            e.preventDefault();
            const id = document.getElementById('disciplina-id').value;
            const payload = {
                discipline_name: document.getElementById('disciplina-nombre').value.trim(),
                is_active: document.getElementById('disciplina-activo').checked
            };
            try {
                if (id) {
                    await supabaseRequest(`/svc_rep_disciplines?discipline_id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(payload) });
                } else {
                    await supabaseRequest('/svc_rep_disciplines', { method: 'POST', body: JSON.stringify(payload) });
                }
                modalDisciplina.hide();
                showMessage('Disciplina guardada', 'success');
                await cargarDisciplinas();
            } catch (err) { showMessage('Error: ' + err.message, 'danger'); }
        }

        // ==========================================
        // WORKERS (para selector de director)
        // ==========================================
        async function cargarWorkers() {
            try {
                const data = await supabaseRequest('/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2&worker_status=eq.active&order=worker_last_name_1.asc,worker_last_name_2.asc.nullslast,worker_first_name.asc');
                cacheWorkers = data || [];
            } catch (e) { console.error('❌ Error cargando workers:', e); }
        }

        function poblarSelectorDirector() {
            const select = document.getElementById('grupo-director');
            select.innerHTML = '<option value="">— Sin asignar —</option>' +
                cacheWorkers.map(w => `<option value="${w.worker_id}">${formatWorkerName(w)}</option>`).join('');
        }

        // ==========================================
        // GRUPOS
        // ==========================================
        async function cargarGrupos() {
            try {
                const data = await supabaseRequest('/svc_rep_groups?select=*,svc_rep_disciplines(discipline_name),workers(worker_id,worker_first_name,worker_last_name_1,worker_last_name_2)&order=svc_rep_disciplines(discipline_name).asc');
                cacheGrupos = data || [];

                // Cargar conteo de integrantes por grupo
                const members = await supabaseRequest('/svc_rep_group_members?select=group_id,is_active');
                const memberCounts = {};
                (members || []).forEach(m => {
                    if (m.is_active) {
                        memberCounts[m.group_id] = (memberCounts[m.group_id] || 0) + 1;
                    }
                });
                cacheGrupos.forEach(g => {
                    g._memberCount = memberCounts[g.group_id] || 0;
                });

                renderGrupos();
            } catch (e) { console.error('❌ Error grupos:', e); }
        }

        function renderGrupos() {
            const tbody = document.getElementById('tbody-grupos');
            const filtroDis = document.getElementById('filtro-disciplina').value;

            let filtered = cacheGrupos;
            if (filtroDis) filtered = filtered.filter(g => g.discipline_id === filtroDis);

            if (filtered.length === 0) { tbody.innerHTML = emptyRow(5, 'No hay grupos con los filtros seleccionados'); return; }

            tbody.innerHTML = filtered.map(g => {
                const disName = g.svc_rep_disciplines?.discipline_name || '—';
                const director = g.workers ? formatWorkerName(g.workers) : '<span class="text-muted">— Sin asignar —</span>';
                const selected = grupoSeleccionado === g.group_id ? 'selected' : '';

                return `
                    <tr class="group-row ${selected}" onclick="seleccionarGrupo('${g.group_id}')">
                        <td>${disName}</td>
                        <td>${director}</td>
                        <td class="text-center"><span class="count-badge">${g._memberCount}</span></td>
                        <td>${badgeEstado(g.is_active)}</td>
                        <td class="text-end" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-outline-primary" onclick="editarGrupo('${g.group_id}')"><i class="bi bi-pencil"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function poblarFiltroDisciplinas() {
            const select = document.getElementById('filtro-disciplina');
            const selectModal = document.getElementById('grupo-disciplina');
            const activas = cacheDisciplinas.filter(d => d.is_active);
            const opts = activas.map(d => `<option value="${d.discipline_id}">${d.discipline_name}</option>`).join('');

            select.innerHTML = '<option value="">Todas las disciplinas</option>' + opts;
            selectModal.innerHTML = '<option value="">Seleccionar...</option>' + opts;
        }

        function abrirModalGrupo() {
            document.getElementById('form-grupo').reset();
            document.getElementById('grupo-id').value = '';
            document.getElementById('grupo-activo').checked = true;
            document.getElementById('modal-grupo-title').innerHTML = '<i class="bi bi-people me-2"></i>Nuevo Grupo';
            poblarSelectorDirector();
            modalGrupo.show();
        }

        function editarGrupo(id) {
            const g = cacheGrupos.find(x => x.group_id === id);
            if (!g) return;
            poblarSelectorDirector();
            document.getElementById('grupo-id').value = g.group_id;
            document.getElementById('grupo-disciplina').value = g.discipline_id;
            document.getElementById('grupo-director').value = g.director_id || '';
            document.getElementById('grupo-activo').checked = g.is_active;
            document.getElementById('modal-grupo-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Grupo';
            modalGrupo.show();
        }

        async function guardarGrupo(e) {
            e.preventDefault();
            const id = document.getElementById('grupo-id').value;
            const payload = {
                discipline_id: document.getElementById('grupo-disciplina').value,
                director_id: document.getElementById('grupo-director').value || null,
                is_active: document.getElementById('grupo-activo').checked
            };
            try {
                if (id) {
                    await supabaseRequest(`/svc_rep_groups?group_id=eq.${id}`, { method: 'PATCH', body: JSON.stringify(payload) });
                } else {
                    await supabaseRequest('/svc_rep_groups', { method: 'POST', body: JSON.stringify(payload) });
                }
                modalGrupo.hide();
                showMessage('Grupo guardado', 'success');
                await cargarGrupos();
            } catch (err) { showMessage('Error: ' + err.message, 'danger'); }
        }

        // ==========================================
        // INTEGRANTES
        // ==========================================
        async function seleccionarGrupo(groupId) {
            grupoSeleccionado = groupId;

            // Actualizar highlight en la tabla
            document.querySelectorAll('.group-row').forEach(r => r.classList.remove('selected'));
            event.currentTarget?.classList.add('selected');

            // Título del panel
            const g = cacheGrupos.find(x => x.group_id === groupId);
            if (g) {
                const dis = g.svc_rep_disciplines?.discipline_name || '';
                document.getElementById('titulo-grupo-seleccionado').textContent = dis;
            }

            // Mostrar panel
            document.getElementById('panel-integrantes').classList.remove('d-none');

            // Limpiar buscador
            document.getElementById('buscar-estudiante').value = '';
            document.getElementById('resultados-busqueda').classList.add('d-none');

            // Cargar integrantes
            await cargarIntegrantes(groupId);
        }

        function cerrarPanelIntegrantes() {
            grupoSeleccionado = null;
            document.getElementById('panel-integrantes').classList.add('d-none');
            document.querySelectorAll('.group-row').forEach(r => r.classList.remove('selected'));
        }

        async function cargarIntegrantes(groupId) {
            try {
                const data = await supabaseRequest(`/svc_rep_group_members?select=*,students(student_id,student_first_name,student_last_name_1,student_last_name_2,courses(course_name,grades(grade_name)))&group_id=eq.${groupId}&order=students(student_last_name_1).asc`);
                cacheIntegrantes = data || [];
                renderIntegrantes();
            } catch (e) {
                console.error('❌ Error integrantes:', e);
            }
        }

        function renderIntegrantes() {
            const container = document.getElementById('lista-integrantes');
            const activos = cacheIntegrantes.filter(m => m.is_active);
            const inactivos = cacheIntegrantes.filter(m => !m.is_active);

            document.getElementById('count-integrantes').textContent = activos.length;

            if (cacheIntegrantes.length === 0) {
                container.innerHTML = '<div class="text-muted text-center py-3"><i class="bi bi-people" style="font-size:2rem;"></i><p class="mt-2">No hay integrantes en este grupo</p></div>';
                return;
            }

            let html = '';

            activos.forEach(m => {
                const st = m.students;
                const nombre = st ? `${st.student_last_name_1} ${st.student_last_name_2 || ''} ${st.student_first_name}`.trim() : `ID: ${m.student_id}`;
                const curso = st?.courses?.course_name || '';
                const grado = st?.courses?.grades?.grade_name || '';
                const ubicacion = grado ? `${grado} — ${curso}` : curso;

                html += `
                    <div class="member-row">
                        <div class="member-info">
                            <i class="bi bi-person-fill text-muted"></i>
                            <div>
                                <div class="fw-semibold" style="font-size:0.9rem;">${nombre}</div>
                                <small class="text-muted">${ubicacion}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="desactivarIntegrante(${m.student_id})" title="Retirar del grupo">
                            <i class="bi bi-person-dash"></i>
                        </button>
                    </div>
                `;
            });

            if (inactivos.length > 0) {
                html += `<div class="mt-3 mb-2"><small class="text-muted fw-semibold">Retirados (${inactivos.length})</small></div>`;
                inactivos.forEach(m => {
                    const st = m.students;
                    const nombre = st ? `${st.student_last_name_1} ${st.student_last_name_2 || ''} ${st.student_first_name}`.trim() : `ID: ${m.student_id}`;
                    html += `
                        <div class="member-row" style="opacity:0.5;">
                            <div class="member-info">
                                <i class="bi bi-person text-muted"></i>
                                <div><div style="font-size:0.9rem;">${nombre}</div></div>
                            </div>
                            <button class="btn btn-sm btn-outline-success" onclick="reactivarIntegrante(${m.student_id})" title="Reactivar">
                                <i class="bi bi-person-plus"></i>
                            </button>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        // ==========================================
        // BÚSQUEDA DE ESTUDIANTES
        // ==========================================
        function buscarEstudiantes() {
            clearTimeout(timeoutBusqueda);
            const texto = document.getElementById('buscar-estudiante').value.trim();
            const container = document.getElementById('resultados-busqueda');

            if (texto.length < 3) {
                container.classList.add('d-none');
                return;
            }

            timeoutBusqueda = setTimeout(async () => {
                try {
                    const termino = texto.replace(/'/g, "''");
                    const data = await supabaseRequest(`/students?select=student_id,student_first_name,student_last_name_1,student_last_name_2,courses(course_name,grades(grade_name)),student_status!inner(status_description)&student_status.status_description=eq.Activo&or=(student_first_name.ilike.*${termino}*,student_last_name_1.ilike.*${termino}*,student_last_name_2.ilike.*${termino}*)&limit=15`);

                    if (!data || data.length === 0) {
                        container.innerHTML = '<div class="p-3 text-muted text-center">No se encontraron estudiantes</div>';
                        container.classList.remove('d-none');
                        return;
                    }

                    // Excluir los que ya son integrantes activos
                    const idsActuales = cacheIntegrantes.filter(m => m.is_active).map(m => m.student_id);
                    const disponibles = data.filter(s => !idsActuales.includes(s.student_id));

                    if (disponibles.length === 0) {
                        container.innerHTML = '<div class="p-3 text-muted text-center">Todos los resultados ya están en el grupo</div>';
                        container.classList.remove('d-none');
                        return;
                    }

                    container.innerHTML = disponibles.map(s => {
                        const nombre = `${s.student_last_name_1} ${s.student_last_name_2 || ''} ${s.student_first_name}`.trim();
                        const curso = s.courses?.course_name || '';
                        const grado = s.courses?.grades?.grade_name || '';
                        const ubicacion = grado ? `${grado} — ${curso}` : curso;
                        return `
                            <div class="search-result-item" onclick="agregarIntegrante(${s.student_id})">
                                <div>
                                    <div class="fw-semibold">${nombre}</div>
                                    <small class="text-muted">${ubicacion}</small>
                                </div>
                                <i class="bi bi-plus-circle text-success"></i>
                            </div>
                        `;
                    }).join('');

                    container.classList.remove('d-none');
                } catch (e) {
                    console.error('❌ Error buscando estudiantes:', e);
                }
            }, 400);
        }

        async function agregarIntegrante(studentId) {
            if (!grupoSeleccionado) return;

            try {
                // Verificar si ya existe (inactivo) para reactivar
                const existente = cacheIntegrantes.find(m => m.student_id === studentId);
                if (existente && !existente.is_active) {
                    await supabaseRequest(`/svc_rep_group_members?group_id=eq.${grupoSeleccionado}&student_id=eq.${studentId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ is_active: true })
                    });
                } else {
                    await supabaseRequest('/svc_rep_group_members', {
                        method: 'POST',
                        body: JSON.stringify({
                            group_id: grupoSeleccionado,
                            student_id: studentId,
                            is_active: true
                        })
                    });
                }

                showMessage('Integrante agregado', 'success');
                document.getElementById('buscar-estudiante').value = '';
                document.getElementById('resultados-busqueda').classList.add('d-none');
                await cargarIntegrantes(grupoSeleccionado);
                await cargarGrupos();
            } catch (err) {
                showMessage('Error al agregar: ' + err.message, 'danger');
            }
        }

        async function desactivarIntegrante(studentId) {
            if (!grupoSeleccionado) return;
            if (!confirm('¿Retirar este estudiante del grupo?')) return;

            try {
                await supabaseRequest(`/svc_rep_group_members?group_id=eq.${grupoSeleccionado}&student_id=eq.${studentId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: false })
                });
                showMessage('Integrante retirado', 'success');
                await cargarIntegrantes(grupoSeleccionado);
                await cargarGrupos();
            } catch (err) { showMessage('Error: ' + err.message, 'danger'); }
        }

        async function reactivarIntegrante(studentId) {
            if (!grupoSeleccionado) return;

            try {
                await supabaseRequest(`/svc_rep_group_members?group_id=eq.${grupoSeleccionado}&student_id=eq.${studentId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: true })
                });
                showMessage('Integrante reactivado', 'success');
                await cargarIntegrantes(grupoSeleccionado);
                await cargarGrupos();
            } catch (err) { showMessage('Error: ' + err.message, 'danger'); }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function mostrarLoading() { document.getElementById('loading-overlay')?.classList.remove('hidden'); }
        function ocultarLoading() { document.getElementById('loading-overlay')?.classList.add('hidden'); }

        // Cerrar resultados de búsqueda al hacer clic fuera
        document.addEventListener('click', function(e) {
            const buscar = document.getElementById('buscar-estudiante');
            const resultados = document.getElementById('resultados-busqueda');
            if (buscar && resultados && !buscar.contains(e.target) && !resultados.contains(e.target)) {
                resultados.classList.add('d-none');
            }
        });

        console.log('✅ Grupos de representación cargado');
    </script>
</body>
</html>
