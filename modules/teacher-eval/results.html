<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.28.19.00">
    <title>Resultados - Evaluaci√≥n Docente - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center;
            align-items: center; z-index: 9999;
        }
        .loading-overlay.hidden { display: none; }
        .loading-content {
            background: white; padding: 2rem; border-radius: 8px; text-align: center;
        }
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #0ea5e9;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 1rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .filter-card {
            border: none; border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        .results-card {
            border: none; border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        .summary-big {
            font-size: 2.5rem; font-weight: 700; line-height: 1;
        }
        .summary-label {
            font-size: 0.85rem; color: #6c757d;
        }

        .nav-tabs .nav-link {
            font-size: 0.85rem; font-weight: 500; color: #6c757d;
        }
        .nav-tabs .nav-link.active {
            color: #0ea5e9; border-bottom: 2px solid #0ea5e9; font-weight: 600;
        }

        .period-check-container {
            border: 1px solid #dee2e6; border-radius: 8px; padding: 0.75rem;
            max-height: 150px; overflow-y: auto; background: #f8f9fa;
        }

        .table-results th {
            background: #f1f5f9; font-size: 0.8rem;
            text-transform: uppercase; letter-spacing: 0.3px; color: #475569;
        }
        .table-results td {
            font-size: 0.9rem; vertical-align: middle;
        }

        .avg-badge {
            display: inline-block; padding: 0.25rem 0.6rem;
            border-radius: 1rem; font-weight: 600; font-size: 0.85rem;
        }
        .avg-high { background: #d1fae5; color: #065f46; }
        .avg-mid { background: #fef3c7; color: #92400e; }
        .avg-low { background: #fee2e2; color: #991b1b; }

        .comment-card {
            border-left: 3px solid #0ea5e9;
            background: #f8f9fa; border-radius: 0 8px 8px 0;
            padding: 0.75rem 1rem; margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .chart-container {
            position: relative; height: 350px; width: 100%;
        }

        .evolution-table th, .evolution-table td {
            text-align: center; font-size: 0.85rem;
        }

        .empty-tab {
            text-align: center; padding: 2rem; color: #6c757d;
        }
        .empty-tab i {
            font-size: 2.5rem; display: block; margin-bottom: 0.75rem;
        }
    </style>
</head>

<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando resultados...</p>
        </div>
    </div>

    <div class="container-fluid">
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Evaluaci√≥n Docente</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Resultados</li>
            </ol>
        </nav>

        <div class="row mb-3">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-bar-chart-line me-2" style="color: #0ea5e9;"></i>Resultados de Evaluaci√≥n Docente
                </h1>
                <p class="text-muted mb-0">Reportes completos con evoluci√≥n, desglose y comparativos</p>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- FILTROS -->
        <div class="card filter-card mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Per√≠odos de evaluaci√≥n</label>
                        <div class="period-check-container" id="periodChecks">
                            <small class="text-muted">Cargando per√≠odos...</small>
                        </div>
                        <div class="form-text">Seleccione uno o m√°s para comparar</div>
                    </div>
                    <div class="col-md-4">
                        <label for="filterTeacher" class="form-label fw-bold">Profesor</label>
                        <select class="form-select" id="filterTeacher">
                            <option value="">Todos los profesores</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filterSection" class="form-label fw-bold">Secci√≥n</label>
                        <select class="form-select" id="filterSection">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="consultarResultados()" id="btnConsultar">
                            <i class="bi bi-search me-1"></i>Consultar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENIDO DE RESULTADOS -->
        <div id="resultsContent" style="display: none;">

            <!-- RESUMEN R√ÅPIDO -->
            <div class="row g-3 mb-4" id="summaryCards">
                <div class="col-6 col-lg-3">
                    <div class="card results-card">
                        <div class="card-body text-center">
                            <div class="summary-big text-primary" id="sumAvgGlobal">-</div>
                            <p class="summary-label mb-0">Promedio Global</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card results-card">
                        <div class="card-body text-center">
                            <div class="summary-big text-success" id="sumTotalEvals">0</div>
                            <p class="summary-label mb-0">Evaluaciones</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card results-card">
                        <div class="card-body text-center">
                            <div class="summary-big text-info" id="sumTotalTeachers">0</div>
                            <p class="summary-label mb-0">Profesores</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card results-card">
                        <div class="card-body text-center">
                            <div class="summary-big text-warning" id="sumPeriods">0</div>
                            <p class="summary-label mb-0">Per√≠odos Consultados</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PESTA√ëAS -->
            <div class="card results-card">
                <div class="card-header bg-white">
                    <ul class="nav nav-tabs card-header-tabs" id="resultsTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="tab-resumen" data-bs-toggle="tab" data-bs-target="#panel-resumen">
                                <i class="bi bi-clipboard-data me-1"></i>Resumen
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="tab-secciones" data-bs-toggle="tab" data-bs-target="#panel-secciones">
                                <i class="bi bi-layout-text-sidebar me-1"></i>Secciones
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="tab-preguntas" data-bs-toggle="tab" data-bs-target="#panel-preguntas">
                                <i class="bi bi-question-circle me-1"></i>Preguntas
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="tab-cursos" data-bs-toggle="tab" data-bs-target="#panel-cursos">
                                <i class="bi bi-people me-1"></i>Cursos / Grados
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="tab-estudiantes" data-bs-toggle="tab" data-bs-target="#panel-estudiantes">
                                <i class="bi bi-person-badge me-1"></i>Estudiantes
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="tab-comentarios" data-bs-toggle="tab" data-bs-target="#panel-comentarios">
                                <i class="bi bi-chat-left-text me-1"></i>Comentarios
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="tab-evolucion" data-bs-toggle="tab" data-bs-target="#panel-evolucion">
                                <i class="bi bi-graph-up me-1"></i>Evoluci√≥n
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="resultsTabContent">
                        <div class="tab-pane fade show active" id="panel-resumen" role="tabpanel"></div>
                        <div class="tab-pane fade" id="panel-secciones" role="tabpanel"></div>
                        <div class="tab-pane fade" id="panel-preguntas" role="tabpanel"></div>
                        <div class="tab-pane fade" id="panel-cursos" role="tabpanel"></div>
                        <div class="tab-pane fade" id="panel-estudiantes" role="tabpanel"></div>
                        <div class="tab-pane fade" id="panel-comentarios" role="tabpanel"></div>
                        <div class="tab-pane fade" id="panel-evolucion" role="tabpanel"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let periodosDisponibles = [];
        let profesores = [];
        let seccionesAcademicas = [];
        let datosResultados = null; // Objeto con todos los datos procesados
        let chartInstances = {};    // Para destruir gr√°ficos antes de recrearlos

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Validando acceso...');
            try {
                const hasAccess = await validatePageAccess('Resultados de evaluaci√≥n');
                if (!hasAccess) return;

                await cargarFiltros();

                console.log('‚úÖ P√°gina de resultados inicializada');
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGAR FILTROS
        // ==========================================
        async function cargarFiltros() {
            try {
                // Per√≠odos (todos, ordenados por fecha)
                periodosDisponibles = await supabaseRequest(
                    '/teval_periods?select=period_id,period_name,period_status,academic_years(year_name)&order=created_at.desc'
                );

                const periodChecks = document.getElementById('periodChecks');
                if (periodosDisponibles.length === 0) {
                    periodChecks.innerHTML = '<small class="text-muted">No hay per√≠odos creados</small>';
                } else {
                    let html = '';
                    periodosDisponibles.forEach(p => {
                        const yearName = p.academic_years?.year_name || '';
                        const statusIcon = p.period_status === 'open' ? 'üü¢' : '‚ö™';
                        html += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="${p.period_id}" id="period-${p.period_id}">
                                <label class="form-check-label" for="period-${p.period_id}">
                                    ${statusIcon} ${escapeHtml(p.period_name)} <small class="text-muted">(${yearName})</small>
                                </label>
                            </div>`;
                    });
                    periodChecks.innerHTML = html;
                }

                // Profesores (workers que tienen asignaciones acad√©micas)
                profesores = await supabaseRequest(
                    '/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2&order=worker_last_name_1,worker_first_name'
                );

                const selectTeacher = document.getElementById('filterTeacher');
                selectTeacher.innerHTML = '<option value="">Todos los profesores</option>';
                profesores.forEach(w => {
                    const fullName = `${w.worker_last_name_1} ${w.worker_last_name_2 || ''} ${w.worker_first_name}`.trim();
                    selectTeacher.innerHTML += `<option value="${w.worker_id}">${fullName}</option>`;
                });

                // Secciones acad√©micas
                seccionesAcademicas = await supabaseRequest(
                    '/sections?select=section_id,section_name&section_status=eq.active&order=section_name'
                );

                const selectSection = document.getElementById('filterSection');
                selectSection.innerHTML = '<option value="">Todas</option>';
                seccionesAcademicas.forEach(s => {
                    selectSection.innerHTML += `<option value="${s.section_id}">${s.section_name}</option>`;
                });

                console.log(`‚úÖ Filtros cargados: ${periodosDisponibles.length} per√≠odos, ${profesores.length} profesores`);
            } catch (error) {
                console.error('‚ùå Error cargando filtros:', error);
                showMessage('Error al cargar filtros: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // OBTENER PER√çODOS SELECCIONADOS
        // ==========================================
        function obtenerPeriodosSeleccionados() {
            const checks = document.querySelectorAll('#periodChecks input[type="checkbox"]:checked');
            return Array.from(checks).map(c => c.value);
        }

        // ==========================================
        // CONSULTAR RESULTADOS
        // ==========================================
        async function consultarResultados() {
            const selectedPeriods = obtenerPeriodosSeleccionados();
            if (selectedPeriods.length === 0) {
                showMessage('Seleccione al menos un per√≠odo para consultar', 'warning');
                return;
            }

            const btn = document.getElementById('btnConsultar');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Consultando...';

            try {
                document.getElementById('loading-overlay').classList.remove('hidden');

                const teacherFilter = document.getElementById('filterTeacher').value;
                const sectionFilter = document.getElementById('filterSection').value;

                const periodIds = selectedPeriods.map(id => `"${id}"`).join(',');

                // Obtener sesiones con datos relacionados
                let sessionQuery = `/teval_sessions?select=session_id,period_id,form_id,student_id,worker_id,session_status,completed_at,students(student_first_name,student_last_name_1,student_last_name_2,course_id,courses(course_name,grade_id,grades(grade_name,section_id,sections(section_name)))),workers(worker_first_name,worker_last_name_1,worker_last_name_2)&period_id=in.(${periodIds})&session_status=eq.completed`;

                if (teacherFilter) {
                    sessionQuery += `&worker_id=eq.${teacherFilter}`;
                }

                const sessions = await supabaseRequest(sessionQuery);

                if (!sessions || sessions.length === 0) {
                    showMessage('No se encontraron evaluaciones completadas para los filtros seleccionados', 'info');
                    document.getElementById('resultsContent').style.display = 'none';
                    return;
                }

                // Filtrar por secci√≥n acad√©mica si aplica
                let filteredSessions = sessions;
                if (sectionFilter) {
                    filteredSessions = sessions.filter(s =>
                        s.students?.courses?.grades?.section_id === sectionFilter
                    );
                    if (filteredSessions.length === 0) {
                        showMessage('No hay evaluaciones para la secci√≥n seleccionada', 'info');
                        document.getElementById('resultsContent').style.display = 'none';
                        return;
                    }
                }

                // Obtener IDs de sesiones
                const sessionIds = filteredSessions.map(s => `"${s.session_id}"`).join(',');

                // Obtener respuestas de esas sesiones
                const responses = await supabaseRequest(
                    `/teval_responses?select=response_id,session_id,question_id,response_value,response_text,teval_form_questions(question_text,question_type,question_order,form_section_id,teval_form_sections(section_title,section_order,english_only,scale_id))&session_id=in.(${sessionIds})`
                );

                // Obtener nombres de per√≠odos seleccionados
                const periodNames = {};
                selectedPeriods.forEach(pid => {
                    const p = periodosDisponibles.find(pp => pp.period_id === pid);
                    if (p) periodNames[pid] = p.period_name;
                });

                // Procesar datos
                datosResultados = procesarDatos(filteredSessions, responses, periodNames);

                // Mostrar resultados
                document.getElementById('resultsContent').style.display = 'block';
                renderizarResumenCards();
                renderizarTabResumen();
                renderizarTabSecciones();
                renderizarTabPreguntas();
                renderizarTabCursos();
                renderizarTabEstudiantes();
                renderizarTabComentarios();
                renderizarTabEvolucion();

                console.log('‚úÖ Resultados renderizados');

            } catch (error) {
                console.error('‚ùå Error consultando resultados:', error);
                showMessage('Error al consultar: ' + error.message, 'danger');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-search me-1"></i>Consultar';
            }
        }

        // ==========================================
        // PROCESAR DATOS EN ESTRUCTURA √öTIL
        // ==========================================
        function procesarDatos(sessions, responses, periodNames) {
            const data = {
                periodNames: periodNames,
                periods: Object.keys(periodNames),
                teachers: {},       // worker_id -> { name, periods: { period_id -> { sessions, responses } } }
                sections: {},       // form_section_id -> { title, order, questions }
                comments: [],       // { text, sectionTitle, periodName, courseName }
                byStudent: {},      // student_id -> { name, course, sessions[] }
                byCourse: {},       // course_id -> { name, grade, section, sessions[] }
                totalSessions: sessions.length
            };

            // Indexar sesiones por session_id
            const sessionMap = {};
            sessions.forEach(s => {
                sessionMap[s.session_id] = s;

                // Profesor
                const wid = s.worker_id;
                if (!data.teachers[wid]) {
                    const w = s.workers;
                    data.teachers[wid] = {
                        name: `${w.worker_last_name_1} ${w.worker_last_name_2 || ''} ${w.worker_first_name}`.trim(),
                        periods: {}
                    };
                }
                if (!data.teachers[wid].periods[s.period_id]) {
                    data.teachers[wid].periods[s.period_id] = { sessions: 0, totalValue: 0, totalCount: 0 };
                }
                data.teachers[wid].periods[s.period_id].sessions++;

                // Estudiante
                const sid = s.student_id;
                if (!data.byStudent[sid]) {
                    const st = s.students;
                    data.byStudent[sid] = {
                        name: `${st.student_last_name_1} ${st.student_last_name_2 || ''} ${st.student_first_name}`.trim(),
                        course: st.courses?.course_name || '-',
                        courseId: st.course_id,
                        sessions: []
                    };
                }
                data.byStudent[sid].sessions.push(s);

                // Curso
                const cid = s.students?.course_id;
                if (cid && !data.byCourse[cid]) {
                    const c = s.students.courses;
                    data.byCourse[cid] = {
                        name: c?.course_name || '-',
                        grade: c?.grades?.grade_name || '-',
                        section: c?.grades?.sections?.section_name || '-',
                        sessions: []
                    };
                }
                if (cid) data.byCourse[cid].sessions.push(s);
            });

            // Procesar respuestas
            responses.forEach(r => {
                const session = sessionMap[r.session_id];
                if (!session) return;

                const q = r.teval_form_questions;
                const sec = q?.teval_form_sections;
                const fsId = q?.form_section_id;

                // Secciones del instrumento
                if (fsId && !data.sections[fsId]) {
                    data.sections[fsId] = {
                        title: sec?.section_title || '-',
                        order: sec?.section_order || 0,
                        englishOnly: sec?.english_only || false,
                        questions: {}
                    };
                }

                // Preguntas
                if (fsId && q) {
                    if (!data.sections[fsId].questions[r.question_id]) {
                        data.sections[fsId].questions[r.question_id] = {
                            text: q.question_text,
                            type: q.question_type,
                            order: q.question_order,
                            responses: []
                        };
                    }
                    data.sections[fsId].questions[r.question_id].responses.push({
                        value: r.response_value,
                        text: r.response_text,
                        periodId: session.period_id,
                        workerId: session.worker_id,
                        studentId: session.student_id,
                        courseId: session.students?.course_id
                    });
                }

                // Acumular promedios por profesor/per√≠odo
                if (r.response_value !== null && session.worker_id) {
                    const tp = data.teachers[session.worker_id].periods[session.period_id];
                    tp.totalValue += r.response_value;
                    tp.totalCount++;
                }

                // Comentarios de texto abierto
                if (r.response_text && r.response_text.trim()) {
                    data.comments.push({
                        text: r.response_text.trim(),
                        sectionTitle: sec?.section_title || '-',
                        periodId: session.period_id,
                        periodName: periodNames[session.period_id] || '-',
                        courseName: session.students?.courses?.course_name || '-',
                        teacherName: data.teachers[session.worker_id]?.name || '-'
                    });
                }
            });

            return data;
        }

        // ==========================================
        // RENDERIZAR TARJETAS DE RESUMEN
        // ==========================================
        function renderizarResumenCards() {
            const d = datosResultados;
            const teacherIds = Object.keys(d.teachers);
            let totalValue = 0, totalCount = 0;

            teacherIds.forEach(wid => {
                Object.values(d.teachers[wid].periods).forEach(p => {
                    totalValue += p.totalValue;
                    totalCount += p.totalCount;
                });
            });

            const avgGlobal = totalCount > 0 ? (totalValue / totalCount).toFixed(2) : '-';

            document.getElementById('sumAvgGlobal').textContent = avgGlobal;
            document.getElementById('sumTotalEvals').textContent = d.totalSessions.toLocaleString('es-CO');
            document.getElementById('sumTotalTeachers').textContent = teacherIds.length;
            document.getElementById('sumPeriods').textContent = d.periods.length;
        }

        // ==========================================
        // PESTA√ëA: RESUMEN
        // ==========================================
        function renderizarTabResumen() {
            const d = datosResultados;
            const panel = document.getElementById('panel-resumen');
            const teacherIds = Object.keys(d.teachers);

            if (teacherIds.length === 0) {
                panel.innerHTML = emptyTab('Sin datos para mostrar');
                return;
            }

            // Tabla de profesores con promedios por per√≠odo
            let html = '<h6 class="mb-3"><i class="bi bi-table me-1"></i>Promedio por Profesor</h6>';
            html += '<div class="table-responsive"><table class="table table-hover table-results">';
            html += '<thead><tr><th>Profesor</th><th class="text-center">Evaluaciones</th>';

            d.periods.forEach(pid => {
                html += `<th class="text-center">${escapeHtml(d.periodNames[pid])}</th>`;
            });
            html += '<th class="text-center">Promedio General</th></tr></thead><tbody>';

            // Calcular y ordenar por promedio general
            const teacherRows = teacherIds.map(wid => {
                const t = d.teachers[wid];
                let totalVal = 0, totalCnt = 0, totalSessions = 0;
                const periodAvgs = {};

                d.periods.forEach(pid => {
                    const p = t.periods[pid];
                    if (p && p.totalCount > 0) {
                        periodAvgs[pid] = (p.totalValue / p.totalCount).toFixed(2);
                        totalVal += p.totalValue;
                        totalCnt += p.totalCount;
                        totalSessions += p.sessions;
                    } else {
                        periodAvgs[pid] = null;
                    }
                });

                const avgGeneral = totalCnt > 0 ? (totalVal / totalCnt).toFixed(2) : null;
                return { wid, name: t.name, periodAvgs, avgGeneral, totalSessions };
            });

            teacherRows.sort((a, b) => (b.avgGeneral || 0) - (a.avgGeneral || 0));

            teacherRows.forEach(row => {
                html += `<tr>
                    <td><strong>${escapeHtml(row.name)}</strong></td>
                    <td class="text-center">${row.totalSessions}</td>`;

                d.periods.forEach(pid => {
                    const val = row.periodAvgs[pid];
                    html += `<td class="text-center">${val ? avgBadge(val) : '<span class="text-muted">-</span>'}</td>`;
                });

                html += `<td class="text-center">${row.avgGeneral ? avgBadge(row.avgGeneral) : '-'}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            panel.innerHTML = html;
        }

        // ==========================================
        // PESTA√ëA: SECCIONES DEL INSTRUMENTO
        // ==========================================
        function renderizarTabSecciones() {
            const d = datosResultados;
            const panel = document.getElementById('panel-secciones');
            const sectionIds = Object.keys(d.sections);

            if (sectionIds.length === 0) {
                panel.innerHTML = emptyTab('Sin datos de secciones');
                return;
            }

            // Ordenar secciones
            const sortedSections = sectionIds
                .map(id => ({ id, ...d.sections[id] }))
                .sort((a, b) => a.order - b.order);

            let html = '';

            sortedSections.forEach(sec => {
                const englishBadge = sec.englishOnly
                    ? ' <span class="badge bg-info" style="font-size:0.65rem;"><i class="bi bi-translate me-1"></i>Solo ingl√©s</span>'
                    : '';

                // Calcular promedio de la secci√≥n por per√≠odo
                let sectionHtml = `
                    <div class="mb-4 p-3 border rounded">
                        <h6 class="fw-bold">${sec.order}. ${escapeHtml(sec.title)}${englishBadge}</h6>`;

                // Tabla de promedios por per√≠odo para esta secci√≥n
                sectionHtml += '<div class="table-responsive"><table class="table table-sm table-results">';
                sectionHtml += '<thead><tr><th>Per√≠odo</th><th class="text-center">Respuestas</th><th class="text-center">Promedio</th></tr></thead><tbody>';

                d.periods.forEach(pid => {
                    let totalVal = 0, totalCnt = 0;
                    Object.values(sec.questions).forEach(q => {
                        if (q.type !== 'scale') return;
                        q.responses.forEach(r => {
                            if (r.periodId === pid && r.value !== null) {
                                totalVal += r.value;
                                totalCnt++;
                            }
                        });
                    });
                    const avg = totalCnt > 0 ? (totalVal / totalCnt).toFixed(2) : null;
                    sectionHtml += `<tr>
                        <td>${escapeHtml(d.periodNames[pid])}</td>
                        <td class="text-center">${totalCnt}</td>
                        <td class="text-center">${avg ? avgBadge(avg) : '-'}</td>
                    </tr>`;
                });

                sectionHtml += '</tbody></table></div>';

                // Desglose por pregunta
                const sortedQuestions = Object.entries(sec.questions)
                    .map(([qid, q]) => ({ qid, ...q }))
                    .sort((a, b) => a.order - b.order);

                sectionHtml += '<details class="mt-2"><summary class="text-primary" style="cursor:pointer;font-size:0.85rem;">Ver detalle por pregunta</summary>';
                sectionHtml += '<div class="table-responsive mt-2"><table class="table table-sm table-results">';
                sectionHtml += '<thead><tr><th>#</th><th>Pregunta</th><th class="text-center">Tipo</th>';
                d.periods.forEach(pid => {
                    sectionHtml += `<th class="text-center">${escapeHtml(d.periodNames[pid])}</th>`;
                });
                sectionHtml += '</tr></thead><tbody>';

                sortedQuestions.forEach(q => {
                    sectionHtml += `<tr><td>${q.order}</td><td>${escapeHtml(q.text)}</td>`;
                    sectionHtml += `<td class="text-center"><span class="badge ${q.type === 'scale' ? 'bg-primary' : 'bg-warning text-dark'}">${q.type === 'scale' ? 'Escala' : 'Texto'}</span></td>`;

                    d.periods.forEach(pid => {
                        if (q.type === 'scale') {
                            const vals = q.responses.filter(r => r.periodId === pid && r.value !== null);
                            const avg = vals.length > 0
                                ? (vals.reduce((s, r) => s + r.value, 0) / vals.length).toFixed(2)
                                : null;
                            sectionHtml += `<td class="text-center">${avg ? avgBadge(avg) : '-'}</td>`;
                        } else {
                            const texts = q.responses.filter(r => r.periodId === pid && r.text);
                            sectionHtml += `<td class="text-center">${texts.length} comentarios</td>`;
                        }
                    });

                    sectionHtml += '</tr>';
                });

                sectionHtml += '</tbody></table></div></details>';
                sectionHtml += '</div>';
                html += sectionHtml;
            });

            panel.innerHTML = html;
        }

        // ==========================================
        // PESTA√ëA: PREGUNTAS
        // ==========================================
        function renderizarTabPreguntas() {
            const d = datosResultados;
            const panel = document.getElementById('panel-preguntas');
            const sectionIds = Object.keys(d.sections);

            if (sectionIds.length === 0) {
                panel.innerHTML = emptyTab('Sin datos de preguntas');
                return;
            }

            // Recopilar todas las preguntas tipo escala
            const allQuestions = [];
            Object.entries(d.sections)
                .sort(([, a], [, b]) => a.order - b.order)
                .forEach(([secId, sec]) => {
                    Object.entries(sec.questions)
                        .map(([qid, q]) => ({ qid, ...q, sectionTitle: sec.title, sectionOrder: sec.order }))
                        .sort((a, b) => a.order - b.order)
                        .forEach(q => allQuestions.push(q));
                });

            const scaleQuestions = allQuestions.filter(q => q.type === 'scale');

            if (scaleQuestions.length === 0) {
                panel.innerHTML = emptyTab('No hay preguntas tipo escala');
                return;
            }

            let html = '<h6 class="mb-3"><i class="bi bi-list-ol me-1"></i>Todas las preguntas tipo escala ‚Äî Promedio por per√≠odo</h6>';
            html += '<div class="table-responsive"><table class="table table-hover table-results">';
            html += '<thead><tr><th style="width:5%;">#</th><th style="width:30%;">Pregunta</th><th>Secci√≥n</th>';

            d.periods.forEach(pid => {
                html += `<th class="text-center">${escapeHtml(d.periodNames[pid])}</th>`;
            });

            if (d.periods.length > 1) {
                html += '<th class="text-center">Variaci√≥n</th>';
            }

            html += '</tr></thead><tbody>';

            scaleQuestions.forEach((q, idx) => {
                html += `<tr><td>${idx + 1}</td><td>${escapeHtml(q.text)}</td>`;
                html += `<td><small class="text-muted">${escapeHtml(q.sectionTitle)}</small></td>`;

                const periodAvgs = [];

                d.periods.forEach(pid => {
                    const vals = q.responses.filter(r => r.periodId === pid && r.value !== null);
                    const avg = vals.length > 0
                        ? (vals.reduce((s, r) => s + r.value, 0) / vals.length).toFixed(2)
                        : null;
                    periodAvgs.push(avg);
                    html += `<td class="text-center">${avg ? avgBadge(avg) : '-'}</td>`;
                });

                // Variaci√≥n entre primer y √∫ltimo per√≠odo
                if (d.periods.length > 1) {
                    const first = periodAvgs.find(v => v !== null);
                    const last = [...periodAvgs].reverse().find(v => v !== null);
                    if (first !== null && last !== null && first !== last) {
                        const diff = (parseFloat(last) - parseFloat(first)).toFixed(2);
                        const diffNum = parseFloat(diff);
                        const icon = diffNum > 0 ? 'bi-arrow-up-circle text-success' : 'bi-arrow-down-circle text-danger';
                        const sign = diffNum > 0 ? '+' : '';
                        html += `<td class="text-center"><i class="bi ${icon} me-1"></i>${sign}${diff}</td>`;
                    } else {
                        html += '<td class="text-center"><span class="text-muted">‚Äî</span></td>';
                    }
                }

                html += '</tr>';
            });

            html += '</tbody></table></div>';
            panel.innerHTML = html;
        }

        // ==========================================
        // PESTA√ëA: CURSOS / GRADOS
        // ==========================================
        function renderizarTabCursos() {
            const d = datosResultados;
            const panel = document.getElementById('panel-cursos');
            const courseIds = Object.keys(d.byCourse);

            if (courseIds.length === 0) {
                panel.innerHTML = emptyTab('Sin datos de cursos');
                return;
            }

            // Calcular promedio por curso y per√≠odo
            const courseRows = courseIds.map(cid => {
                const course = d.byCourse[cid];
                const periodData = {};

                d.periods.forEach(pid => {
                    let totalVal = 0, totalCnt = 0, sessionCount = 0;

                    // Recorrer todas las respuestas de todas las secciones
                    Object.values(d.sections).forEach(sec => {
                        Object.values(sec.questions).forEach(q => {
                            if (q.type !== 'scale') return;
                            q.responses.forEach(r => {
                                if (r.courseId === cid && r.periodId === pid && r.value !== null) {
                                    totalVal += r.value;
                                    totalCnt++;
                                }
                            });
                        });
                    });

                    sessionCount = course.sessions.filter(s => s.period_id === pid).length;
                    periodData[pid] = {
                        avg: totalCnt > 0 ? (totalVal / totalCnt).toFixed(2) : null,
                        sessions: sessionCount
                    };
                });

                // Promedio general del curso
                let gVal = 0, gCnt = 0;
                Object.values(periodData).forEach(pd => {
                    if (pd.avg !== null) {
                        gVal += parseFloat(pd.avg) * pd.sessions;
                        gCnt += pd.sessions;
                    }
                });

                return {
                    cid, name: course.name, grade: course.grade, section: course.section,
                    periodData,
                    avgGeneral: gCnt > 0 ? (gVal / gCnt).toFixed(2) : null,
                    totalSessions: course.sessions.length
                };
            });

            courseRows.sort((a, b) =>
                a.section.localeCompare(b.section) || a.grade.localeCompare(b.grade) || a.name.localeCompare(b.name)
            );

            let html = '<h6 class="mb-3"><i class="bi bi-people me-1"></i>Resultados por Curso</h6>';
            html += '<div class="table-responsive"><table class="table table-hover table-results">';
            html += '<thead><tr><th>Curso</th><th>Grado</th><th>Secci√≥n</th><th class="text-center">Evaluaciones</th>';

            d.periods.forEach(pid => {
                html += `<th class="text-center">${escapeHtml(d.periodNames[pid])}</th>`;
            });

            html += '<th class="text-center">Promedio</th></tr></thead><tbody>';

            courseRows.forEach(row => {
                html += `<tr>
                    <td><strong>${escapeHtml(row.name)}</strong></td>
                    <td>${escapeHtml(row.grade)}</td>
                    <td><small class="text-muted">${escapeHtml(row.section)}</small></td>
                    <td class="text-center">${row.totalSessions}</td>`;

                d.periods.forEach(pid => {
                    const pd = row.periodData[pid];
                    html += `<td class="text-center">${pd && pd.avg ? avgBadge(pd.avg) : '-'}</td>`;
                });

                html += `<td class="text-center">${row.avgGeneral ? avgBadge(row.avgGeneral) : '-'}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';

            // Gr√°fico comparativo por curso
            html += `
                <div class="mt-4">
                    <h6 class="mb-3"><i class="bi bi-bar-chart me-1"></i>Comparativo por Curso</h6>
                    <div class="chart-container"><canvas id="chartCursos"></canvas></div>
                </div>`;

            panel.innerHTML = html;

            // Renderizar gr√°fico
            renderizarGraficoCursos(courseRows);
        }

        function renderizarGraficoCursos(courseRows) {
            if (chartInstances.cursos) chartInstances.cursos.destroy();

            const ctx = document.getElementById('chartCursos');
            if (!ctx) return;

            const labels = courseRows.map(r => r.name);
            const datasets = datosResultados.periods.map((pid, idx) => {
                const colors = ['#0ea5e9', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6'];
                return {
                    label: datosResultados.periodNames[pid],
                    data: courseRows.map(r => r.periodData[pid]?.avg ? parseFloat(r.periodData[pid].avg) : null),
                    backgroundColor: colors[idx % colors.length],
                    borderRadius: 4
                };
            });

            chartInstances.cursos = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Promedio' } }
                    }
                }
            });
        }

        // ==========================================
        // PESTA√ëA: ESTUDIANTES
        // ==========================================
        function renderizarTabEstudiantes() {
            const d = datosResultados;
            const panel = document.getElementById('panel-estudiantes');
            const studentIds = Object.keys(d.byStudent);

            if (studentIds.length === 0) {
                panel.innerHTML = emptyTab('Sin datos de estudiantes');
                return;
            }

            // Filtro de b√∫squeda y selector de profesor
            let html = `
                <div class="row g-3 mb-3">
                    <div class="col-md-5">
                        <input type="text" class="form-control form-control-sm" id="filterStudent"
                               placeholder="Buscar estudiante..." oninput="filtrarTablaEstudiantes()">
                    </div>
                    <div class="col-md-5">
                        <select class="form-select form-select-sm" id="filterStudentTeacher" onchange="filtrarTablaEstudiantes()">
                            <option value="">Todos los profesores</option>
                        </select>
                    </div>
                    <div class="col-md-2 text-end">
                        <small class="text-muted" id="studentCount">${studentIds.length} estudiantes</small>
                    </div>
                </div>`;

            // Poblar select de profesores
            const teacherOptions = Object.entries(d.teachers)
                .map(([wid, t]) => ({ wid, name: t.name }))
                .sort((a, b) => a.name.localeCompare(b.name));

            // Tabla de estudiantes
            html += '<div class="table-responsive"><table class="table table-hover table-results" id="tableStudents">';
            html += '<thead><tr><th>Estudiante</th><th>Curso</th><th class="text-center">Evaluaciones</th><th class="text-center">Detalle</th></tr></thead><tbody>';

            const studentRows = studentIds.map(sid => {
                const st = d.byStudent[sid];
                return { sid, name: st.name, course: st.course, sessionCount: st.sessions.length };
            }).sort((a, b) => a.name.localeCompare(b.name));

            studentRows.forEach(row => {
                html += `<tr class="student-row" data-student-name="${escapeHtml(row.name.toLowerCase())}" data-student-id="${row.sid}">
                    <td><strong>${escapeHtml(row.name)}</strong></td>
                    <td>${escapeHtml(row.course)}</td>
                    <td class="text-center">${row.sessionCount}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="verDetalleEstudiante('${row.sid}')">
                            <i class="bi bi-eye me-1"></i>Ver
                        </button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div>';

            // Panel de detalle (oculto inicialmente)
            html += `
                <div id="studentDetailPanel" style="display:none;" class="mt-4 p-3 border rounded bg-light">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0" id="studentDetailTitle"><i class="bi bi-person-badge me-2"></i>Detalle</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="cerrarDetalleEstudiante()">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                    <div id="studentDetailContent"></div>
                </div>`;

            panel.innerHTML = html;

            // Poblar select de profesores despu√©s del render
            const selectTeacher = document.getElementById('filterStudentTeacher');
            teacherOptions.forEach(t => {
                selectTeacher.innerHTML += `<option value="${t.wid}">${escapeHtml(t.name)}</option>`;
            });
        }

        // ==========================================
        // VER DETALLE DE UN ESTUDIANTE
        // ==========================================
        function verDetalleEstudiante(studentId) {
            const d = datosResultados;
            const student = d.byStudent[studentId];
            if (!student) return;

            document.getElementById('studentDetailPanel').style.display = 'block';
            document.getElementById('studentDetailTitle').innerHTML =
                `<i class="bi bi-person-badge me-2"></i>${escapeHtml(student.name)} ‚Äî ${escapeHtml(student.course)}`;

            // Obtener sesiones del estudiante con detalle de profesor
            let html = '<div class="table-responsive"><table class="table table-sm table-results">';
            html += '<thead><tr><th>Profesor Evaluado</th><th>Per√≠odo</th>';

            // Columnas por secci√≥n del instrumento
            const sortedSections = Object.entries(d.sections)
                .map(([id, sec]) => ({ id, ...sec }))
                .sort((a, b) => a.order - b.order);

            sortedSections.forEach(sec => {
                html += `<th class="text-center" title="${escapeHtml(sec.title)}">${escapeHtml(sec.title.substring(0, 15))}...</th>`;
            });

            html += '<th class="text-center">Promedio</th></tr></thead><tbody>';

            student.sessions.forEach(session => {
                const teacherName = d.teachers[session.worker_id]?.name || '-';
                const periodName = d.periodNames[session.period_id] || '-';

                html += `<tr><td>${escapeHtml(teacherName)}</td><td><small>${escapeHtml(periodName)}</small></td>`;

                let totalVal = 0, totalCnt = 0;

                sortedSections.forEach(sec => {
                    let secVal = 0, secCnt = 0;
                    Object.values(sec.questions).forEach(q => {
                        if (q.type !== 'scale') return;
                        q.responses.forEach(r => {
                            if (r.studentId === parseInt(studentId) && r.periodId === session.period_id
                                && r.workerId === session.worker_id && r.value !== null) {
                                secVal += r.value;
                                secCnt++;
                            }
                        });
                    });
                    const secAvg = secCnt > 0 ? (secVal / secCnt).toFixed(2) : null;
                    totalVal += secVal;
                    totalCnt += secCnt;
                    html += `<td class="text-center">${secAvg ? avgBadge(secAvg) : '-'}</td>`;
                });

                const rowAvg = totalCnt > 0 ? (totalVal / totalCnt).toFixed(2) : null;
                html += `<td class="text-center">${rowAvg ? avgBadge(rowAvg) : '-'}</td></tr>`;
            });

            html += '</tbody></table></div>';

            document.getElementById('studentDetailContent').innerHTML = html;

            // Scroll al detalle
            document.getElementById('studentDetailPanel').scrollIntoView({ behavior: 'smooth' });
        }

        function cerrarDetalleEstudiante() {
            document.getElementById('studentDetailPanel').style.display = 'none';
        }

        function filtrarTablaEstudiantes() {
            const filterName = document.getElementById('filterStudent').value.toLowerCase().trim();
            const filterTeacher = document.getElementById('filterStudentTeacher').value;
            const rows = document.querySelectorAll('.student-row');
            let visible = 0;

            rows.forEach(row => {
                const name = row.getAttribute('data-student-name') || '';
                const sid = row.getAttribute('data-student-id');
                let matchName = name.includes(filterName);
                let matchTeacher = true;

                if (filterTeacher && datosResultados.byStudent[sid]) {
                    matchTeacher = datosResultados.byStudent[sid].sessions.some(s => s.worker_id === filterTeacher);
                }

                if (matchName && matchTeacher) {
                    row.style.display = '';
                    visible++;
                } else {
                    row.style.display = 'none';
                }
            });

            document.getElementById('studentCount').textContent = `${visible} estudiantes`;
        }

        // ==========================================
        // PESTA√ëA: COMENTARIOS
        // ==========================================
        function renderizarTabComentarios() {
            const d = datosResultados;
            const panel = document.getElementById('panel-comentarios');

            if (!d.comments || d.comments.length === 0) {
                panel.innerHTML = emptyTab('No hay comentarios de texto abierto');
                return;
            }

            // Filtro por profesor
            let html = `
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <select class="form-select form-select-sm" id="filterCommentTeacher" onchange="filtrarComentarios()">
                            <option value="">Todos los profesores</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select form-select-sm" id="filterCommentPeriod" onchange="filtrarComentarios()">
                            <option value="">Todos los per√≠odos</option>
                        </select>
                    </div>
                    <div class="col-md-4 text-end">
                        <small class="text-muted" id="commentCount">${d.comments.length} comentarios</small>
                    </div>
                </div>
                <div id="commentsContainer"></div>`;

            panel.innerHTML = html;

            // Poblar filtros
            const selectTeacher = document.getElementById('filterCommentTeacher');
            Object.entries(d.teachers)
                .map(([wid, t]) => ({ wid, name: t.name }))
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(t => {
                    selectTeacher.innerHTML += `<option value="${escapeHtml(t.name)}">${escapeHtml(t.name)}</option>`;
                });

            const selectPeriod = document.getElementById('filterCommentPeriod');
            d.periods.forEach(pid => {
                selectPeriod.innerHTML += `<option value="${pid}">${escapeHtml(d.periodNames[pid])}</option>`;
            });

            filtrarComentarios();
        }

        function filtrarComentarios() {
            const d = datosResultados;
            const filterTeacher = document.getElementById('filterCommentTeacher').value;
            const filterPeriod = document.getElementById('filterCommentPeriod').value;
            const container = document.getElementById('commentsContainer');

            let filtered = d.comments;

            if (filterTeacher) {
                filtered = filtered.filter(c => c.teacherName === filterTeacher);
            }
            if (filterPeriod) {
                filtered = filtered.filter(c => c.periodId === filterPeriod);
            }

            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-3">No hay comentarios con los filtros seleccionados</p>';
                document.getElementById('commentCount').textContent = '0 comentarios';
                return;
            }

            let html = '';
            filtered.forEach(c => {
                html += `
                    <div class="comment-card">
                        <p class="mb-1">"${escapeHtml(c.text)}"</p>
                        <div class="d-flex gap-3">
                            <small class="text-muted"><i class="bi bi-person me-1"></i>${escapeHtml(c.teacherName)}</small>
                            <small class="text-muted"><i class="bi bi-calendar me-1"></i>${escapeHtml(c.periodName)}</small>
                            <small class="text-muted"><i class="bi bi-layout-text-sidebar me-1"></i>${escapeHtml(c.sectionTitle)}</small>
                            <small class="text-muted"><i class="bi bi-mortarboard me-1"></i>${escapeHtml(c.courseName)}</small>
                        </div>
                    </div>`;
            });

            container.innerHTML = html;
            document.getElementById('commentCount').textContent = `${filtered.length} comentarios`;
        }

        // ==========================================
        // PESTA√ëA: EVOLUCI√ìN
        // ==========================================
        function renderizarTabEvolucion() {
            const d = datosResultados;
            const panel = document.getElementById('panel-evolucion');

            if (d.periods.length < 2) {
                panel.innerHTML = emptyTab('Seleccione al menos 2 per√≠odos para ver la evoluci√≥n');
                return;
            }

            const teacherIds = Object.keys(d.teachers);

            let html = '';

            // ---- GR√ÅFICO 1: Evoluci√≥n global ----
            html += `
                <div class="mb-5">
                    <h6 class="mb-3"><i class="bi bi-graph-up me-1"></i>Evoluci√≥n del Promedio Global</h6>
                    <div class="chart-container"><canvas id="chartEvolucionGlobal"></canvas></div>
                </div>`;

            // ---- GR√ÅFICO 2: Evoluci√≥n por secci√≥n del instrumento ----
            html += `
                <div class="mb-5">
                    <h6 class="mb-3"><i class="bi bi-graph-up-arrow me-1"></i>Evoluci√≥n por Secci√≥n del Instrumento</h6>
                    <div class="chart-container"><canvas id="chartEvolucionSecciones"></canvas></div>
                </div>`;

            // ---- GR√ÅFICO 3: Evoluci√≥n por profesor (top 10) ----
            html += `
                <div class="mb-5">
                    <h6 class="mb-3"><i class="bi bi-person-lines-fill me-1"></i>Evoluci√≥n por Profesor</h6>
                    <div class="mb-2">
                        <select class="form-select form-select-sm" id="evolTeacherSelect" onchange="renderizarGraficoEvolucionProfesores()" style="max-width:300px;">
                            <option value="top10">Top 10 profesores</option>
                            <option value="bottom10">Bottom 10 profesores</option>
                            <option value="all">Todos</option>
                        </select>
                    </div>
                    <div class="chart-container"><canvas id="chartEvolucionProfesores"></canvas></div>
                </div>`;

            // ---- TABLA COMPARATIVA: Evoluci√≥n detallada ----
            html += `
                <div class="mb-4">
                    <h6 class="mb-3"><i class="bi bi-table me-1"></i>Tabla Comparativa entre Per√≠odos</h6>
                    <div class="table-responsive"><table class="table table-hover evolution-table">
                    <thead><tr><th class="text-start">Profesor</th>`;

            d.periods.forEach(pid => {
                html += `<th>${escapeHtml(d.periodNames[pid])}</th>`;
            });

            html += '<th>Variaci√≥n</th><th>Tendencia</th></tr></thead><tbody>';

            // Calcular datos de evoluci√≥n por profesor
            const evolRows = teacherIds.map(wid => {
                const t = d.teachers[wid];
                const avgs = d.periods.map(pid => {
                    const p = t.periods[pid];
                    return (p && p.totalCount > 0) ? (p.totalValue / p.totalCount) : null;
                });
                return { wid, name: t.name, avgs };
            }).sort((a, b) => a.name.localeCompare(b.name));

            evolRows.forEach(row => {
                html += `<tr><td class="text-start"><strong>${escapeHtml(row.name)}</strong></td>`;

                row.avgs.forEach(avg => {
                    html += `<td>${avg !== null ? avgBadge(avg.toFixed(2)) : '-'}</td>`;
                });

                // Variaci√≥n entre primer y √∫ltimo dato disponible
                const validAvgs = row.avgs.filter(a => a !== null);
                if (validAvgs.length >= 2) {
                    const first = validAvgs[0];
                    const last = validAvgs[validAvgs.length - 1];
                    const diff = (last - first).toFixed(2);
                    const diffNum = parseFloat(diff);
                    const sign = diffNum > 0 ? '+' : '';
                    const colorClass = diffNum > 0 ? 'text-success' : diffNum < 0 ? 'text-danger' : 'text-muted';

                    html += `<td class="${colorClass} fw-bold">${sign}${diff}</td>`;

                    // Tendencia con flechas
                    let trend = '';
                    if (diffNum > 0.3) trend = '<i class="bi bi-arrow-up-circle-fill text-success fs-5"></i>';
                    else if (diffNum > 0) trend = '<i class="bi bi-arrow-up-short text-success fs-5"></i>';
                    else if (diffNum < -0.3) trend = '<i class="bi bi-arrow-down-circle-fill text-danger fs-5"></i>';
                    else if (diffNum < 0) trend = '<i class="bi bi-arrow-down-short text-danger fs-5"></i>';
                    else trend = '<i class="bi bi-dash-circle text-muted fs-5"></i>';

                    html += `<td>${trend}</td>`;
                } else {
                    html += '<td>-</td><td>-</td>';
                }

                html += '</tr>';
            });

            html += '</tbody></table></div>';

            panel.innerHTML = html;

            // Renderizar gr√°ficos
            renderizarGraficoEvolucionGlobal(evolRows);
            renderizarGraficoEvolucionSecciones();
            renderizarGraficoEvolucionProfesores();
        }

        // ==========================================
        // GR√ÅFICO: EVOLUCI√ìN GLOBAL
        // ==========================================
        function renderizarGraficoEvolucionGlobal(evolRows) {
            if (chartInstances.evolGlobal) chartInstances.evolGlobal.destroy();

            const ctx = document.getElementById('chartEvolucionGlobal');
            if (!ctx) return;

            const d = datosResultados;
            const labels = d.periods.map(pid => d.periodNames[pid]);

            // Promedio global por per√≠odo
            const globalAvgs = d.periods.map(pid => {
                let totalVal = 0, totalCnt = 0;
                Object.values(d.teachers).forEach(t => {
                    const p = t.periods[pid];
                    if (p && p.totalCount > 0) {
                        totalVal += p.totalValue;
                        totalCnt += p.totalCount;
                    }
                });
                return totalCnt > 0 ? parseFloat((totalVal / totalCnt).toFixed(2)) : null;
            });

            chartInstances.evolGlobal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Promedio Global',
                        data: globalAvgs,
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 6,
                        pointBackgroundColor: '#0ea5e9',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => `Promedio: ${ctx.parsed.y}` } }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Promedio' } }
                    }
                }
            });
        }

        // ==========================================
        // GR√ÅFICO: EVOLUCI√ìN POR SECCI√ìN DEL INSTRUMENTO
        // ==========================================
        function renderizarGraficoEvolucionSecciones() {
            if (chartInstances.evolSecciones) chartInstances.evolSecciones.destroy();

            const ctx = document.getElementById('chartEvolucionSecciones');
            if (!ctx) return;

            const d = datosResultados;
            const labels = d.periods.map(pid => d.periodNames[pid]);
            const colors = ['#0ea5e9', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];

            const sortedSections = Object.entries(d.sections)
                .map(([id, sec]) => ({ id, ...sec }))
                .sort((a, b) => a.order - b.order);

            const datasets = sortedSections.map((sec, idx) => {
                const data = d.periods.map(pid => {
                    let totalVal = 0, totalCnt = 0;
                    Object.values(sec.questions).forEach(q => {
                        if (q.type !== 'scale') return;
                        q.responses.forEach(r => {
                            if (r.periodId === pid && r.value !== null) {
                                totalVal += r.value;
                                totalCnt++;
                            }
                        });
                    });
                    return totalCnt > 0 ? parseFloat((totalVal / totalCnt).toFixed(2)) : null;
                });

                return {
                    label: sec.title,
                    data,
                    borderColor: colors[idx % colors.length],
                    backgroundColor: 'transparent',
                    tension: 0.3,
                    pointRadius: 5,
                    borderWidth: 2
                };
            });

            chartInstances.evolSecciones = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Promedio' } }
                    }
                }
            });
        }

        // ==========================================
        // GR√ÅFICO: EVOLUCI√ìN POR PROFESOR
        // ==========================================
        function renderizarGraficoEvolucionProfesores() {
            if (chartInstances.evolProfesores) chartInstances.evolProfesores.destroy();

            const ctx = document.getElementById('chartEvolucionProfesores');
            if (!ctx) return;

            const d = datosResultados;
            const labels = d.periods.map(pid => d.periodNames[pid]);
            const colors = ['#0ea5e9', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#84cc16'];

            const mode = document.getElementById('evolTeacherSelect')?.value || 'top10';

            // Calcular promedio general por profesor
            const teacherAvgs = Object.entries(d.teachers).map(([wid, t]) => {
                let totalVal = 0, totalCnt = 0;
                Object.values(t.periods).forEach(p => {
                    totalVal += p.totalValue;
                    totalCnt += p.totalCount;
                });
                const avg = totalCnt > 0 ? totalVal / totalCnt : 0;

                const periodData = d.periods.map(pid => {
                    const p = t.periods[pid];
                    return (p && p.totalCount > 0) ? parseFloat((p.totalValue / p.totalCount).toFixed(2)) : null;
                });

                return { wid, name: t.name, avg, periodData };
            });

            // Ordenar y filtrar
            let filtered;
            if (mode === 'top10') {
                filtered = teacherAvgs.sort((a, b) => b.avg - a.avg).slice(0, 10);
            } else if (mode === 'bottom10') {
                filtered = teacherAvgs.sort((a, b) => a.avg - b.avg).slice(0, 10);
            } else {
                filtered = teacherAvgs.sort((a, b) => a.name.localeCompare(b.name));
            }

            const datasets = filtered.map((t, idx) => ({
                label: t.name,
                data: t.periodData,
                borderColor: colors[idx % colors.length],
                backgroundColor: 'transparent',
                tension: 0.3,
                pointRadius: 4,
                borderWidth: 2
            }));

            chartInstances.evolProfesores = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Promedio' } }
                    }
                }
            });
        }

        // ==========================================
        // FUNCIONES UTILITARIAS
        // ==========================================
        function avgBadge(value) {
            const num = parseFloat(value);
            let cls = 'avg-mid';
            if (num >= 4) cls = 'avg-high';
            else if (num < 3) cls = 'avg-low';
            return `<span class="avg-badge ${cls}">${value}</span>`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function emptyTab(message) {
            return `<div class="empty-tab">
                <i class="bi bi-inbox"></i>
                <p>${message}</p>
            </div>`;
        }

        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.consultarResultados = consultarResultados;
        window.verDetalleEstudiante = verDetalleEstudiante;
        window.cerrarDetalleEstudiante = cerrarDetalleEstudiante;
        window.filtrarTablaEstudiantes = filtrarTablaEstudiantes;
        window.filtrarComentarios = filtrarComentarios;
        window.renderizarGraficoEvolucionProfesores = renderizarGraficoEvolucionProfesores;

        console.log('‚úÖ P√°gina Resultados de Evaluaci√≥n Docente cargada');
    </script>
</body>
</html>
