<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.28.17.00">
    <title>Formularios - Evaluaci√≥n Docente - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center;
            align-items: center; z-index: 9999;
        }
        .loading-overlay.hidden { display: none; }
        .loading-content {
            background: white; padding: 2rem; border-radius: 8px; text-align: center;
        }
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #0ea5e9;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 1rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .form-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
        }
        .form-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        .form-card .card-header {
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
            padding: 1rem 1.25rem;
        }
        .status-badge-active {
            background: #d1fae5; color: #065f46;
            padding: 0.25rem 0.75rem; border-radius: 1rem;
            font-size: 0.75rem; font-weight: 500;
        }
        .status-badge-inactive {
            background: #fee2e2; color: #991b1b;
            padding: 0.25rem 0.75rem; border-radius: 1rem;
            font-size: 0.75rem; font-weight: 500;
        }

        .section-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: #f8f9fa;
        }
        .section-item:hover {
            background: #e9ecef;
        }
        .question-item {
            border-left: 3px solid #0ea5e9;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 0 4px 4px 0;
            font-size: 0.9rem;
        }
        .question-item.open-text {
            border-left-color: #f59e0b;
        }
        .english-badge {
            background: #dbeafe; color: #1e40af;
            padding: 0.15rem 0.5rem; border-radius: 0.75rem;
            font-size: 0.7rem; font-weight: 500;
        }
        .empty-state {
            text-align: center; padding: 3rem 1rem; color: #6c757d;
        }
        .empty-state i {
            font-size: 3rem; display: block; margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <div class="container-fluid">
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Evaluaci√≥n Docente</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Formularios</li>
            </ol>
        </nav>

        <div class="row mb-3">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div>
                        <h1 class="h3">
                            <i class="bi bi-file-earmark-text me-2" style="color: #0ea5e9;"></i>Formularios de Evaluaci√≥n
                        </h1>
                        <p class="text-muted mb-0">Cree y gestione los formularios con secciones y preguntas</p>
                    </div>
                    <button class="btn btn-primary" onclick="abrirModalFormulario()">
                        <i class="bi bi-plus-circle me-1"></i>Nuevo Formulario
                    </button>
                </div>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- LISTADO DE FORMULARIOS -->
        <div id="formsList">
            <div class="empty-state">
                <i class="bi bi-file-earmark-text"></i>
                <p>Cargando formularios...</p>
            </div>
        </div>
    </div>
    <!-- MODAL: CREAR/EDITAR FORMULARIO -->
    <div class="modal fade" id="modalFormulario" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalFormularioTitle">
                        <i class="bi bi-file-earmark-text me-2"></i>Nuevo Formulario
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="formFormulario" onsubmit="guardarFormulario(event)">
                    <div class="modal-body">
                        <input type="hidden" id="formId">
                        <div class="mb-3">
                            <label for="formName" class="form-label fw-bold">Nombre del formulario <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="formName" required
                                   placeholder="Ej: Evaluaci√≥n Docente - Primaria">
                        </div>
                        <div class="mb-3">
                            <label for="formSection" class="form-label fw-bold">Secci√≥n acad√©mica <span class="text-danger">*</span></label>
                            <select class="form-select" id="formSection" required>
                                <option value="">Seleccione una secci√≥n...</option>
                            </select>
                            <div class="form-text">Secci√≥n del colegio a la que aplica este formulario</div>
                        </div>
                        <div class="mb-3">
                            <label for="formDescription" class="form-label fw-bold">Descripci√≥n</label>
                            <textarea class="form-control" id="formDescription" rows="2"
                                      placeholder="Descripci√≥n opcional del formulario..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="formStatus" class="form-label fw-bold">Estado</label>
                            <select class="form-select" id="formStatus">
                                <option value="active">Activo</option>
                                <option value="inactive">Inactivo</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btnGuardarFormulario">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: CREAR/EDITAR SECCI√ìN DEL FORMULARIO -->
    <div class="modal fade" id="modalSeccion" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="modalSeccionTitle">
                        <i class="bi bi-layout-text-sidebar me-2"></i>Nueva Secci√≥n
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="formSeccion" onsubmit="guardarSeccion(event)">
                    <div class="modal-body">
                        <input type="hidden" id="seccionFormId">
                        <input type="hidden" id="seccionId">
                        <div class="mb-3">
                            <label for="seccionTitle" class="form-label fw-bold">T√≠tulo de la secci√≥n <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="seccionTitle" required
                                   placeholder="Ej: Metodolog√≠a de ense√±anza">
                        </div>
                        <div class="mb-3">
                            <label for="seccionDescription" class="form-label fw-bold">Descripci√≥n</label>
                            <textarea class="form-control" id="seccionDescription" rows="2"
                                      placeholder="Instrucciones o contexto para esta secci√≥n..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="seccionScale" class="form-label fw-bold">Escala de respuesta <span class="text-danger">*</span></label>
                            <select class="form-select" id="seccionScale" required>
                                <option value="">Seleccione una escala...</option>
                            </select>
                            <div class="form-text">Escala que usar√°n las preguntas tipo "Escala" en esta secci√≥n</div>
                        </div>
                        <div class="mb-3">
                            <label for="seccionOrder" class="form-label fw-bold">Orden <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="seccionOrder" min="1" value="1" required>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="seccionEnglishOnly">
                            <label class="form-check-label fw-bold" for="seccionEnglishOnly">
                                Solo para asignaturas en ingl√©s
                            </label>
                            <div class="form-text">Si se activa, esta secci√≥n solo se mostrar√° cuando el estudiante eval√∫e a un profesor que dicta su asignatura en ingl√©s</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-info text-white" id="btnGuardarSeccion">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: CREAR/EDITAR PREGUNTA -->
    <div class="modal fade" id="modalPregunta" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalPreguntaTitle">
                        <i class="bi bi-question-circle me-2"></i>Nueva Pregunta
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="formPregunta" onsubmit="guardarPregunta(event)">
                    <div class="modal-body">
                        <input type="hidden" id="preguntaSectionId">
                        <input type="hidden" id="preguntaId">
                        <div class="mb-3">
                            <label for="preguntaText" class="form-label fw-bold">Texto de la pregunta <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="preguntaText" rows="2" required
                                      placeholder="Ej: ¬øEl profesor explica con claridad los temas?"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="preguntaType" class="form-label fw-bold">Tipo de pregunta <span class="text-danger">*</span></label>
                            <select class="form-select" id="preguntaType" required>
                                <option value="scale">Escala (usa la escala de la secci√≥n)</option>
                                <option value="open_text">Texto abierto</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="preguntaOrder" class="form-label fw-bold">Orden <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="preguntaOrder" min="1" value="1" required>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="preguntaRequired" checked>
                            <label class="form-check-label fw-bold" for="preguntaRequired">Obligatoria</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success" id="btnGuardarPregunta">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUserId = null;
        let secciones = [];       // sections del colegio
        let escalas = [];         // survey_scales
        let formularios = [];     // teval_forms con secciones y preguntas

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Validando acceso...');
            try {
                const hasAccess = await validatePageAccess('Formularios de evaluaci√≥n');
                if (!hasAccess) return;

                const session = getStoredSession();
                currentUserId = session?.user?.user_id || null;

                await cargarDatosMaestros();
                await cargarFormularios();

                console.log('‚úÖ P√°gina de formularios inicializada');
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGAR DATOS MAESTROS
        // ==========================================
        async function cargarDatosMaestros() {
            try {
                // Secciones del colegio (Preescolar, Primaria, etc.)
                secciones = await supabaseRequest(
                    '/sections?select=section_id,section_name&section_status=eq.active&order=section_name'
                );

                const selectSection = document.getElementById('formSection');
                selectSection.innerHTML = '<option value="">Seleccione una secci√≥n...</option>';
                secciones.forEach(s => {
                    selectSection.innerHTML += `<option value="${s.section_id}">${s.section_name}</option>`;
                });

                // Escalas de evaluaci√≥n
                escalas = await supabaseRequest(
                    '/survey_scales?select=scale_id,scale_name&order=scale_name'
                );

                const selectScale = document.getElementById('seccionScale');
                selectScale.innerHTML = '<option value="">Seleccione una escala...</option>';
                escalas.forEach(e => {
                    selectScale.innerHTML += `<option value="${e.scale_id}">${e.scale_name}</option>`;
                });

                console.log(`‚úÖ ${secciones.length} secciones, ${escalas.length} escalas cargadas`);
            } catch (error) {
                console.error('‚ùå Error cargando datos maestros:', error);
            }
        }

        // ==========================================
        // CARGAR FORMULARIOS CON SECCIONES Y PREGUNTAS
        // ==========================================
        async function cargarFormularios() {
            try {
                document.getElementById('loading-overlay').classList.remove('hidden');

                formularios = await supabaseRequest(
                    '/teval_forms?select=*,sections(section_name),teval_form_sections(*,survey_scales(scale_name),teval_form_questions(*))&order=created_at.desc'
                );

                renderizarFormularios();
                console.log(`‚úÖ ${formularios.length} formularios cargados`);
            } catch (error) {
                console.error('‚ùå Error cargando formularios:', error);
                showMessage('Error al cargar formularios: ' + error.message, 'danger');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // ==========================================
        // RENDERIZAR FORMULARIOS
        // ==========================================
        function renderizarFormularios() {
            const container = document.getElementById('formsList');

            if (!formularios || formularios.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-file-earmark-text"></i>
                        <p>No hay formularios creados a√∫n</p>
                        <button class="btn btn-primary btn-sm" onclick="abrirModalFormulario()">
                            <i class="bi bi-plus-circle me-1"></i>Crear primer formulario
                        </button>
                    </div>`;
                return;
            }

            let html = '';
            formularios.forEach(form => {
                const statusBadge = form.form_status === 'active'
                    ? '<span class="status-badge-active">Activo</span>'
                    : '<span class="status-badge-inactive">Inactivo</span>';

                const sectionName = form.sections?.section_name || 'Sin secci√≥n';

                // Ordenar secciones del formulario
                const formSections = (form.teval_form_sections || [])
                    .sort((a, b) => a.section_order - b.section_order);

                const totalQuestions = formSections.reduce((sum, s) => 
                    sum + (s.teval_form_questions?.length || 0), 0);

                html += `
                    <div class="card form-card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 fw-bold">${escapeHtml(form.form_name)}</h6>
                                <small class="text-muted">
                                    <i class="bi bi-building me-1"></i>${sectionName}
                                    <span class="mx-2">|</span>
                                    <i class="bi bi-layout-text-sidebar me-1"></i>${formSections.length} secciones
                                    <span class="mx-2">|</span>
                                    <i class="bi bi-question-circle me-1"></i>${totalQuestions} preguntas
                                </small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                ${statusBadge}
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#" onclick="editarFormulario('${form.form_id}')">
                                            <i class="bi bi-pencil me-2"></i>Editar formulario
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="abrirModalSeccion('${form.form_id}')">
                                            <i class="bi bi-plus-circle me-2"></i>Agregar secci√≥n
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="eliminarFormulario('${form.form_id}', '${escapeHtml(form.form_name)}')">
                                            <i class="bi bi-trash me-2"></i>Eliminar formulario
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            ${form.form_description ? `<p class="text-muted small mb-3">${escapeHtml(form.form_description)}</p>` : ''}
                            ${renderizarSeccionesFormulario(formSections, form.form_id)}
                        </div>
                    </div>`;
            });

            container.innerHTML = html;
        }

        // ==========================================
        // RENDERIZAR SECCIONES DE UN FORMULARIO
        // ==========================================
        function renderizarSeccionesFormulario(formSections, formId) {
            if (!formSections || formSections.length === 0) {
                return `<div class="text-center text-muted py-2">
                    <small>Sin secciones ‚Äî 
                        <a href="#" onclick="abrirModalSeccion('${formId}')">Agregar primera secci√≥n</a>
                    </small>
                </div>`;
            }

            let html = '';
            formSections.forEach(sec => {
                const questions = (sec.teval_form_questions || [])
                    .sort((a, b) => a.question_order - b.question_order);

                const englishBadge = sec.english_only
                    ? ' <span class="english-badge"><i class="bi bi-translate me-1"></i>Solo ingl√©s</span>'
                    : '';

                const scaleName = sec.survey_scales?.scale_name || 'Sin escala';

                html += `
                    <div class="section-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong>${sec.section_order}. ${escapeHtml(sec.section_title)}</strong>
                                ${englishBadge}
                                <br>
                                <small class="text-muted">
                                    <i class="bi bi-speedometer2 me-1"></i>Escala: ${escapeHtml(scaleName)}
                                    <span class="mx-1">|</span>
                                    ${questions.length} pregunta${questions.length !== 1 ? 's' : ''}
                                </small>
                            </div>
                            <div class="d-flex gap-1">
                                <button class="btn btn-sm btn-outline-success" onclick="abrirModalPregunta('${sec.form_section_id}')"
                                        title="Agregar pregunta">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="editarSeccion('${sec.form_section_id}')"
                                        title="Editar secci√≥n">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="eliminarSeccion('${sec.form_section_id}', '${escapeHtml(sec.section_title)}')"
                                        title="Eliminar secci√≥n">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        ${renderizarPreguntas(questions)}
                    </div>`;
            });

            return html;
        }

        // ==========================================
        // RENDERIZAR PREGUNTAS DE UNA SECCI√ìN
        // ==========================================
        function renderizarPreguntas(questions) {
            if (!questions || questions.length === 0) {
                return '<small class="text-muted ms-3">Sin preguntas a√∫n</small>';
            }

            let html = '<div class="ms-2 mt-2">';
            questions.forEach(q => {
                const typeClass = q.question_type === 'open_text' ? 'open-text' : '';
                const typeLabel = q.question_type === 'open_text'
                    ? '<span class="badge bg-warning text-dark ms-2" style="font-size:0.65rem;">Texto abierto</span>'
                    : '';
                const requiredLabel = !q.is_required
                    ? '<span class="badge bg-secondary ms-1" style="font-size:0.65rem;">Opcional</span>'
                    : '';

                html += `
                    <div class="question-item ${typeClass} d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted me-1">${q.question_order}.</span>
                            ${escapeHtml(q.question_text)}
                            ${typeLabel}${requiredLabel}
                        </div>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-link text-primary p-0 me-2" onclick="editarPregunta('${q.question_id}')"
                                    title="Editar pregunta">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-sm btn-link text-danger p-0" onclick="eliminarPregunta('${q.question_id}', '${escapeHtml(q.question_text).substring(0, 30)}')"
                                    title="Eliminar pregunta">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </div>`;
            });
            html += '</div>';
            return html;
        }

        // ==========================================
        // CRUD: FORMULARIOS
        // ==========================================
        function abrirModalFormulario() {
            document.getElementById('formId').value = '';
            document.getElementById('formName').value = '';
            document.getElementById('formSection').value = '';
            document.getElementById('formDescription').value = '';
            document.getElementById('formStatus').value = 'active';
            document.getElementById('modalFormularioTitle').innerHTML = '<i class="bi bi-file-earmark-text me-2"></i>Nuevo Formulario';
            new bootstrap.Modal(document.getElementById('modalFormulario')).show();
        }

        function editarFormulario(formId) {
            const form = formularios.find(f => f.form_id === formId);
            if (!form) return;

            document.getElementById('formId').value = form.form_id;
            document.getElementById('formName').value = form.form_name;
            document.getElementById('formSection').value = form.section_id;
            document.getElementById('formDescription').value = form.form_description || '';
            document.getElementById('formStatus').value = form.form_status;
            document.getElementById('modalFormularioTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Formulario';
            new bootstrap.Modal(document.getElementById('modalFormulario')).show();
        }

        async function guardarFormulario(e) {
            e.preventDefault();
            const btn = document.getElementById('btnGuardarFormulario');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';

            try {
                const formId = document.getElementById('formId').value;
                const payload = {
                    form_name: document.getElementById('formName').value.trim(),
                    section_id: document.getElementById('formSection').value,
                    form_description: document.getElementById('formDescription').value.trim() || null,
                    form_status: document.getElementById('formStatus').value,
                    updated_at: new Date().toISOString()
                };

                if (formId) {
                    await supabaseRequest(`/teval_forms?form_id=eq.${formId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(payload)
                    });
                    showMessage('Formulario actualizado correctamente', 'success');
                } else {
                    payload.created_by = currentUserId;
                    await supabaseRequest('/teval_forms', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    showMessage('Formulario creado correctamente', 'success');
                }

                bootstrap.Modal.getInstance(document.getElementById('modalFormulario')).hide();
                await cargarFormularios();
            } catch (error) {
                console.error('‚ùå Error guardando formulario:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar';
            }
        }

        async function eliminarFormulario(formId, formName) {
            if (!confirm(`¬øEliminar el formulario "${formName}" y todas sus secciones y preguntas?`)) return;

            try {
                // Obtener secciones del formulario
                const secciones = await supabaseRequest(
                    `/teval_form_sections?select=form_section_id&form_id=eq.${formId}`
                );

                // Eliminar preguntas de cada secci√≥n
                for (const sec of (secciones || [])) {
                    await supabaseRequest(
                        `/teval_form_questions?form_section_id=eq.${sec.form_section_id}`,
                        { method: 'DELETE' }
                    );
                }

                // Eliminar secciones
                await supabaseRequest(
                    `/teval_form_sections?form_id=eq.${formId}`,
                    { method: 'DELETE' }
                );

                // Eliminar v√≠nculos con per√≠odos
                await supabaseRequest(
                    `/teval_period_forms?form_id=eq.${formId}`,
                    { method: 'DELETE' }
                );

                // Eliminar formulario
                await supabaseRequest(
                    `/teval_forms?form_id=eq.${formId}`,
                    { method: 'DELETE' }
                );

                showMessage('Formulario eliminado correctamente', 'success');
                await cargarFormularios();
            } catch (error) {
                console.error('‚ùå Error eliminando formulario:', error);
                showMessage('Error al eliminar: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // CRUD: SECCIONES DEL FORMULARIO
        // ==========================================
        function abrirModalSeccion(formId, nextOrder) {
            document.getElementById('seccionFormId').value = formId;
            document.getElementById('seccionId').value = '';
            document.getElementById('seccionTitle').value = '';
            document.getElementById('seccionDescription').value = '';
            document.getElementById('seccionScale').value = '';
            document.getElementById('seccionEnglishOnly').checked = false;
            document.getElementById('modalSeccionTitle').innerHTML = '<i class="bi bi-layout-text-sidebar me-2"></i>Nueva Secci√≥n';

            // Calcular siguiente orden
            const form = formularios.find(f => f.form_id === formId);
            const maxOrder = (form?.teval_form_sections || []).reduce((max, s) => Math.max(max, s.section_order), 0);
            document.getElementById('seccionOrder').value = maxOrder + 1;

            new bootstrap.Modal(document.getElementById('modalSeccion')).show();
        }

        function editarSeccion(formSectionId) {
            let seccion = null;
            let parentFormId = null;

            for (const form of formularios) {
                const found = (form.teval_form_sections || []).find(s => s.form_section_id === formSectionId);
                if (found) {
                    seccion = found;
                    parentFormId = form.form_id;
                    break;
                }
            }

            if (!seccion) return;

            document.getElementById('seccionFormId').value = parentFormId;
            document.getElementById('seccionId').value = seccion.form_section_id;
            document.getElementById('seccionTitle').value = seccion.section_title;
            document.getElementById('seccionDescription').value = seccion.section_description || '';
            document.getElementById('seccionScale').value = seccion.scale_id;
            document.getElementById('seccionOrder').value = seccion.section_order;
            document.getElementById('seccionEnglishOnly').checked = seccion.english_only || false;
            document.getElementById('modalSeccionTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Secci√≥n';

            new bootstrap.Modal(document.getElementById('modalSeccion')).show();
        }

        async function guardarSeccion(e) {
            e.preventDefault();
            const btn = document.getElementById('btnGuardarSeccion');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';

            try {
                const seccionId = document.getElementById('seccionId').value;
                const payload = {
                    form_id: document.getElementById('seccionFormId').value,
                    section_title: document.getElementById('seccionTitle').value.trim(),
                    section_description: document.getElementById('seccionDescription').value.trim() || null,
                    scale_id: document.getElementById('seccionScale').value,
                    section_order: parseInt(document.getElementById('seccionOrder').value),
                    english_only: document.getElementById('seccionEnglishOnly').checked
                };

                if (seccionId) {
                    await supabaseRequest(`/teval_form_sections?form_section_id=eq.${seccionId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(payload)
                    });
                    showMessage('Secci√≥n actualizada correctamente', 'success');
                } else {
                    await supabaseRequest('/teval_form_sections', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    showMessage('Secci√≥n creada correctamente', 'success');
                }

                bootstrap.Modal.getInstance(document.getElementById('modalSeccion')).hide();
                await cargarFormularios();
            } catch (error) {
                console.error('‚ùå Error guardando secci√≥n:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar';
            }
        }

        async function eliminarSeccion(formSectionId, sectionTitle) {
            if (!confirm(`¬øEliminar la secci√≥n "${sectionTitle}" y todas sus preguntas?`)) return;

            try {
                // Eliminar preguntas primero
                await supabaseRequest(
                    `/teval_form_questions?form_section_id=eq.${formSectionId}`,
                    { method: 'DELETE' }
                );

                // Eliminar secci√≥n
                await supabaseRequest(
                    `/teval_form_sections?form_section_id=eq.${formSectionId}`,
                    { method: 'DELETE' }
                );

                showMessage('Secci√≥n eliminada correctamente', 'success');
                await cargarFormularios();
            } catch (error) {
                console.error('‚ùå Error eliminando secci√≥n:', error);
                showMessage('Error al eliminar: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // CRUD: PREGUNTAS
        // ==========================================
        function abrirModalPregunta(formSectionId) {
            document.getElementById('preguntaSectionId').value = formSectionId;
            document.getElementById('preguntaId').value = '';
            document.getElementById('preguntaText').value = '';
            document.getElementById('preguntaType').value = 'scale';
            document.getElementById('preguntaRequired').checked = true;
            document.getElementById('modalPreguntaTitle').innerHTML = '<i class="bi bi-question-circle me-2"></i>Nueva Pregunta';

            // Calcular siguiente orden
            let maxOrder = 0;
            for (const form of formularios) {
                const sec = (form.teval_form_sections || []).find(s => s.form_section_id === formSectionId);
                if (sec) {
                    maxOrder = (sec.teval_form_questions || []).reduce((max, q) => Math.max(max, q.question_order), 0);
                    break;
                }
            }
            document.getElementById('preguntaOrder').value = maxOrder + 1;

            new bootstrap.Modal(document.getElementById('modalPregunta')).show();
        }

        function editarPregunta(questionId) {
            let pregunta = null;
            let parentSectionId = null;

            for (const form of formularios) {
                for (const sec of (form.teval_form_sections || [])) {
                    const found = (sec.teval_form_questions || []).find(q => q.question_id === questionId);
                    if (found) {
                        pregunta = found;
                        parentSectionId = sec.form_section_id;
                        break;
                    }
                }
                if (pregunta) break;
            }

            if (!pregunta) return;

            document.getElementById('preguntaSectionId').value = parentSectionId;
            document.getElementById('preguntaId').value = pregunta.question_id;
            document.getElementById('preguntaText').value = pregunta.question_text;
            document.getElementById('preguntaType').value = pregunta.question_type;
            document.getElementById('preguntaOrder').value = pregunta.question_order;
            document.getElementById('preguntaRequired').checked = pregunta.is_required !== false;
            document.getElementById('modalPreguntaTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Pregunta';

            new bootstrap.Modal(document.getElementById('modalPregunta')).show();
        }

        async function guardarPregunta(e) {
            e.preventDefault();
            const btn = document.getElementById('btnGuardarPregunta');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';

            try {
                const preguntaId = document.getElementById('preguntaId').value;
                const payload = {
                    form_section_id: document.getElementById('preguntaSectionId').value,
                    question_text: document.getElementById('preguntaText').value.trim(),
                    question_type: document.getElementById('preguntaType').value,
                    question_order: parseInt(document.getElementById('preguntaOrder').value),
                    is_required: document.getElementById('preguntaRequired').checked
                };

                if (preguntaId) {
                    await supabaseRequest(`/teval_form_questions?question_id=eq.${preguntaId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(payload)
                    });
                    showMessage('Pregunta actualizada correctamente', 'success');
                } else {
                    await supabaseRequest('/teval_form_questions', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    showMessage('Pregunta creada correctamente', 'success');
                }

                bootstrap.Modal.getInstance(document.getElementById('modalPregunta')).hide();
                await cargarFormularios();
            } catch (error) {
                console.error('‚ùå Error guardando pregunta:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar';
            }
        }

        async function eliminarPregunta(questionId, questionText) {
            if (!confirm(`¬øEliminar la pregunta "${questionText}..."?`)) return;

            try {
                await supabaseRequest(
                    `/teval_form_questions?question_id=eq.${questionId}`,
                    { method: 'DELETE' }
                );

                showMessage('Pregunta eliminada correctamente', 'success');
                await cargarFormularios();
            } catch (error) {
                console.error('‚ùå Error eliminando pregunta:', error);
                showMessage('Error al eliminar: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.abrirModalFormulario = abrirModalFormulario;
        window.editarFormulario = editarFormulario;
        window.eliminarFormulario = eliminarFormulario;
        window.abrirModalSeccion = abrirModalSeccion;
        window.editarSeccion = editarSeccion;
        window.eliminarSeccion = eliminarSeccion;
        window.abrirModalPregunta = abrirModalPregunta;
        window.editarPregunta = editarPregunta;
        window.eliminarPregunta = eliminarPregunta;

        console.log('‚úÖ P√°gina Formularios de Evaluaci√≥n Docente cargada');
    </script>
</body>
</html>
