<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.28.17.30">
    <title>Per√≠odos - Evaluaci√≥n Docente - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center;
            align-items: center; z-index: 9999;
        }
        .loading-overlay.hidden { display: none; }
        .loading-content {
            background: white; padding: 2rem; border-radius: 8px; text-align: center;
        }
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #0ea5e9;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 1rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .period-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }
        .period-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        .period-card .card-header {
            border-radius: 12px 12px 0 0;
            padding: 1rem 1.25rem;
        }
        .period-open .card-header {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
        }
        .period-closed .card-header {
            background: #f8f9fa;
            color: #495057;
        }
        .status-badge-open {
            background: #d1fae5; color: #065f46;
            padding: 0.3rem 0.85rem; border-radius: 1rem;
            font-size: 0.8rem; font-weight: 600;
        }
        .status-badge-closed {
            background: #e5e7eb; color: #374151;
            padding: 0.3rem 0.85rem; border-radius: 1rem;
            font-size: 0.8rem; font-weight: 600;
        }
        .form-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #e0f2fe;
            color: #0369a1;
            padding: 0.25rem 0.6rem;
            border-radius: 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .info-row {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .info-row i {
            width: 20px;
            text-align: center;
        }
        .empty-state {
            text-align: center; padding: 3rem 1rem; color: #6c757d;
        }
        .empty-state i {
            font-size: 3rem; display: block; margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <div class="container-fluid">
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Evaluaci√≥n Docente</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Per√≠odos</li>
            </ol>
        </nav>

        <div class="row mb-3">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div>
                        <h1 class="h3">
                            <i class="bi bi-calendar-check me-2" style="color: #0ea5e9;"></i>Per√≠odos de Evaluaci√≥n
                        </h1>
                        <p class="text-muted mb-0">Gestione los per√≠odos en que los estudiantes pueden evaluar</p>
                    </div>
                    <button class="btn btn-primary" onclick="abrirModalPeriodo()">
                        <i class="bi bi-plus-circle me-1"></i>Nuevo Per√≠odo
                    </button>
                </div>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div id="periodsList">
            <div class="empty-state">
                <i class="bi bi-calendar-check"></i>
                <p>Cargando per√≠odos...</p>
            </div>
        </div>
    </div>

    <!-- MODAL: CREAR/EDITAR PER√çODO -->
    <div class="modal fade" id="modalPeriodo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalPeriodoTitle">
                        <i class="bi bi-calendar-plus me-2"></i>Nuevo Per√≠odo
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="formPeriodo" onsubmit="guardarPeriodo(event)">
                    <div class="modal-body">
                        <input type="hidden" id="periodId">
                        <div class="mb-3">
                            <label for="periodName" class="form-label fw-bold">Nombre del per√≠odo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="periodName" required
                                   placeholder="Ej: Evaluaci√≥n Semestre I - 2026">
                        </div>
                        <div class="mb-3">
                            <label for="periodYear" class="form-label fw-bold">A√±o acad√©mico <span class="text-danger">*</span></label>
                            <select class="form-select" id="periodYear" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Formularios asociados</label>
                            <div id="formsCheckboxes" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                <small class="text-muted">Cargando formularios...</small>
                            </div>
                            <div class="form-text">Seleccione los formularios que estar√°n activos en este per√≠odo</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btnGuardarPeriodo">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUserId = null;
        let periodos = [];
        let aniosAcademicos = [];
        let formulariosActivos = [];

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Validando acceso...');
            try {
                const hasAccess = await validatePageAccess('Per√≠odos de evaluaci√≥n');
                if (!hasAccess) return;

                const session = getStoredSession();
                currentUserId = session?.user?.user_id || null;

                await cargarDatosMaestros();
                await cargarPeriodos();

                console.log('‚úÖ P√°gina de per√≠odos inicializada');
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGAR DATOS MAESTROS
        // ==========================================
        async function cargarDatosMaestros() {
            try {
                // A√±os acad√©micos
                aniosAcademicos = await supabaseRequest(
                    '/academic_years?select=year_id,year_name,is_current&order=year_name.desc'
                );

                const selectYear = document.getElementById('periodYear');
                selectYear.innerHTML = '<option value="">Seleccione...</option>';
                aniosAcademicos.forEach(a => {
                    const current = a.is_current ? ' (Actual)' : '';
                    selectYear.innerHTML += `<option value="${a.year_id}" ${a.is_current ? 'selected' : ''}>${a.year_name}${current}</option>`;
                });

                // Formularios activos
                formulariosActivos = await supabaseRequest(
                    '/teval_forms?select=form_id,form_name,sections(section_name)&form_status=eq.active&order=form_name'
                );

                renderizarCheckboxesFormularios([]);

                console.log(`‚úÖ ${aniosAcademicos.length} a√±os, ${formulariosActivos.length} formularios cargados`);
            } catch (error) {
                console.error('‚ùå Error cargando datos maestros:', error);
            }
        }

        // ==========================================
        // RENDERIZAR CHECKBOXES DE FORMULARIOS
        // ==========================================
        function renderizarCheckboxesFormularios(selectedFormIds) {
            const container = document.getElementById('formsCheckboxes');

            if (!formulariosActivos || formulariosActivos.length === 0) {
                container.innerHTML = '<small class="text-muted">No hay formularios activos disponibles</small>';
                return;
            }

            let html = '';
            formulariosActivos.forEach(f => {
                const checked = selectedFormIds.includes(f.form_id) ? 'checked' : '';
                const sectionName = f.sections?.section_name || '';
                html += `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="${f.form_id}" 
                               id="form-check-${f.form_id}" ${checked}>
                        <label class="form-check-label" for="form-check-${f.form_id}">
                            ${escapeHtml(f.form_name)}
                            ${sectionName ? `<small class="text-muted ms-1">(${sectionName})</small>` : ''}
                        </label>
                    </div>`;
            });

            container.innerHTML = html;
        }

        // ==========================================
        // CARGAR PER√çODOS
        // ==========================================
        async function cargarPeriodos() {
            try {
                document.getElementById('loading-overlay').classList.remove('hidden');

                periodos = await supabaseRequest(
                    '/teval_periods?select=*,academic_years(year_name),teval_period_forms(form_id,teval_forms(form_name,sections(section_name)))&order=created_at.desc'
                );

                renderizarPeriodos();
                console.log(`‚úÖ ${periodos.length} per√≠odos cargados`);
            } catch (error) {
                console.error('‚ùå Error cargando per√≠odos:', error);
                showMessage('Error al cargar per√≠odos: ' + error.message, 'danger');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // ==========================================
        // RENDERIZAR PER√çODOS
        // ==========================================
        function renderizarPeriodos() {
            const container = document.getElementById('periodsList');

            if (!periodos || periodos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-calendar-check"></i>
                        <p>No hay per√≠odos creados a√∫n</p>
                        <button class="btn btn-primary btn-sm" onclick="abrirModalPeriodo()">
                            <i class="bi bi-plus-circle me-1"></i>Crear primer per√≠odo
                        </button>
                    </div>`;
                return;
            }

            let html = '';
            periodos.forEach(p => {
                const isOpen = p.period_status === 'open';
                const cardClass = isOpen ? 'period-open' : 'period-closed';
                const statusBadge = isOpen
                    ? '<span class="status-badge-open"><i class="bi bi-unlock me-1"></i>Abierto</span>'
                    : '<span class="status-badge-closed"><i class="bi bi-lock me-1"></i>Cerrado</span>';

                const yearName = p.academic_years?.year_name || 'Sin a√±o';

                // Formularios asociados
                const periodForms = p.teval_period_forms || [];
                let formsHtml = '';
                if (periodForms.length > 0) {
                    formsHtml = '<div class="d-flex flex-wrap gap-1 mt-2">';
                    periodForms.forEach(pf => {
                        const fname = pf.teval_forms?.form_name || 'Sin nombre';
                        const sname = pf.teval_forms?.sections?.section_name || '';
                        formsHtml += `<span class="form-tag">
                            <i class="bi bi-file-earmark-text"></i>${escapeHtml(fname)}${sname ? ' ¬∑ ' + sname : ''}
                        </span>`;
                    });
                    formsHtml += '</div>';
                } else {
                    formsHtml = '<small class="text-muted mt-2 d-block"><i class="bi bi-exclamation-triangle me-1"></i>Sin formularios asociados</small>';
                }

                // Informaci√≥n de apertura/cierre
                let infoHtml = '';
                if (p.opened_at) {
                    const fechaApertura = new Date(p.opened_at).toLocaleString('es-CO');
                    infoHtml += `<div class="info-row"><i class="bi bi-unlock me-1"></i>Abierto: ${fechaApertura}</div>`;
                }
                if (p.closed_at) {
                    const fechaCierre = new Date(p.closed_at).toLocaleString('es-CO');
                    infoHtml += `<div class="info-row"><i class="bi bi-lock me-1"></i>Cerrado: ${fechaCierre}</div>`;
                }

                // Botones de acci√≥n seg√∫n estado
                let actionButtons = '';
                if (isOpen) {
                    actionButtons = `
                        <button class="btn btn-sm btn-warning" onclick="cerrarPeriodo('${p.period_id}', '${escapeHtml(p.period_name)}')">
                            <i class="bi bi-lock me-1"></i>Cerrar Per√≠odo
                        </button>`;
                } else {
                    actionButtons = `
                        <button class="btn btn-sm btn-success" onclick="abrirPeriodo('${p.period_id}', '${escapeHtml(p.period_name)}')">
                            <i class="bi bi-unlock me-1"></i>Abrir Per√≠odo
                        </button>`;
                }

                html += `
                    <div class="card period-card ${cardClass}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 fw-bold">${escapeHtml(p.period_name)}</h6>
                                <small ${isOpen ? 'class="opacity-75"' : 'class="text-muted"'}>
                                    <i class="bi bi-mortarboard me-1"></i>${yearName}
                                </small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                ${statusBadge}
                                <div class="dropdown">
                                    <button class="btn btn-sm ${isOpen ? 'btn-outline-light' : 'btn-outline-secondary'}" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#" onclick="editarPeriodo('${p.period_id}')">
                                            <i class="bi bi-pencil me-2"></i>Editar per√≠odo
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="eliminarPeriodo('${p.period_id}', '${escapeHtml(p.period_name)}')">
                                            <i class="bi bi-trash me-2"></i>Eliminar per√≠odo
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                                <div class="flex-grow-1">
                                    <strong class="small text-muted">Formularios asociados:</strong>
                                    ${formsHtml}
                                    <div class="mt-2">${infoHtml}</div>
                                </div>
                                <div class="d-flex flex-column gap-2">
                                    ${actionButtons}
                                </div>
                            </div>
                        </div>
                    </div>`;
            });

            container.innerHTML = html;
        }

        // ==========================================
        // CRUD: PER√çODOS
        // ==========================================
        function abrirModalPeriodo() {
            document.getElementById('periodId').value = '';
            document.getElementById('periodName').value = '';
            // Seleccionar a√±o actual por defecto
            const currentYear = aniosAcademicos.find(a => a.is_current);
            document.getElementById('periodYear').value = currentYear ? currentYear.year_id : '';
            renderizarCheckboxesFormularios([]);
            document.getElementById('modalPeriodoTitle').innerHTML = '<i class="bi bi-calendar-plus me-2"></i>Nuevo Per√≠odo';
            new bootstrap.Modal(document.getElementById('modalPeriodo')).show();
        }

        function editarPeriodo(periodId) {
            const periodo = periodos.find(p => p.period_id === periodId);
            if (!periodo) return;

            document.getElementById('periodId').value = periodo.period_id;
            document.getElementById('periodName').value = periodo.period_name;
            document.getElementById('periodYear').value = periodo.academic_year_id;

            const selectedFormIds = (periodo.teval_period_forms || []).map(pf => pf.form_id);
            renderizarCheckboxesFormularios(selectedFormIds);

            document.getElementById('modalPeriodoTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Per√≠odo';
            new bootstrap.Modal(document.getElementById('modalPeriodo')).show();
        }

        async function guardarPeriodo(e) {
            e.preventDefault();
            const btn = document.getElementById('btnGuardarPeriodo');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';

            try {
                const periodId = document.getElementById('periodId').value;
                const payload = {
                    period_name: document.getElementById('periodName').value.trim(),
                    academic_year_id: document.getElementById('periodYear').value,
                    updated_at: new Date().toISOString()
                };

                // Obtener formularios seleccionados
                const selectedForms = [];
                document.querySelectorAll('#formsCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                    selectedForms.push(cb.value);
                });

                let targetPeriodId = periodId;

                if (periodId) {
                    // Actualizar per√≠odo
                    await supabaseRequest(`/teval_periods?period_id=eq.${periodId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(payload)
                    });
                } else {
                    // Crear per√≠odo
                    payload.created_by = currentUserId;
                    payload.period_status = 'closed';
                    const result = await supabaseRequest('/teval_periods', {
                        method: 'POST',
                        headers: { 'Prefer': 'return=representation' },
                        body: JSON.stringify(payload)
                    });
                    if (result && result.length > 0) {
                        targetPeriodId = result[0].period_id;
                    }
                }

                // Sincronizar formularios asociados
                if (targetPeriodId) {
                    await sincronizarFormulariosPeriodo(targetPeriodId, selectedForms);
                }

                showMessage(periodId ? 'Per√≠odo actualizado correctamente' : 'Per√≠odo creado correctamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalPeriodo')).hide();
                await cargarPeriodos();

            } catch (error) {
                console.error('‚ùå Error guardando per√≠odo:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar';
            }
        }

        // ==========================================
        // SINCRONIZAR FORMULARIOS DEL PER√çODO
        // ==========================================
        async function sincronizarFormulariosPeriodo(periodId, selectedFormIds) {
            try {
                // Eliminar asociaciones actuales
                await supabaseRequest(
                    `/teval_period_forms?period_id=eq.${periodId}`,
                    { method: 'DELETE' }
                );

                // Crear nuevas asociaciones
                if (selectedFormIds.length > 0) {
                    const inserts = selectedFormIds.map(formId => ({
                        period_id: periodId,
                        form_id: formId
                    }));

                    await supabaseRequest('/teval_period_forms', {
                        method: 'POST',
                        body: JSON.stringify(inserts)
                    });
                }

                console.log(`‚úÖ ${selectedFormIds.length} formularios sincronizados para per√≠odo`);
            } catch (error) {
                console.error('‚ùå Error sincronizando formularios:', error);
                throw error;
            }
        }

        // ==========================================
        // ABRIR / CERRAR PER√çODO
        // ==========================================
        async function abrirPeriodo(periodId, periodName) {
            if (!confirm(`¬øAbrir el per√≠odo "${periodName}"?\n\nLos estudiantes podr√°n comenzar a evaluar.`)) return;

            try {
                // Verificar que no haya otro per√≠odo abierto
                const abiertos = await supabaseRequest(
                    '/teval_periods?select=period_id,period_name&period_status=eq.open'
                );

                if (abiertos && abiertos.length > 0) {
                    const nombreAbierto = abiertos[0].period_name;
                    if (!confirm(`Ya existe un per√≠odo abierto: "${nombreAbierto}".\n\n¬øDesea cerrarlo y abrir "${periodName}" en su lugar?`)) {
                        return;
                    }

                    // Cerrar el per√≠odo actualmente abierto
                    await supabaseRequest(`/teval_periods?period_id=eq.${abiertos[0].period_id}`, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            period_status: 'closed',
                            closed_by: currentUserId,
                            closed_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                    });
                }

                // Verificar que tenga formularios asociados
                const forms = await supabaseRequest(
                    `/teval_period_forms?select=form_id&period_id=eq.${periodId}`
                );

                if (!forms || forms.length === 0) {
                    showMessage('No puede abrir un per√≠odo sin formularios asociados. Edite el per√≠odo y asigne al menos un formulario.', 'warning');
                    return;
                }

                // Abrir el per√≠odo
                await supabaseRequest(`/teval_periods?period_id=eq.${periodId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        period_status: 'open',
                        opened_by: currentUserId,
                        opened_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                });

                showMessage(`Per√≠odo "${periodName}" abierto correctamente`, 'success');
                await cargarPeriodos();

            } catch (error) {
                console.error('‚ùå Error abriendo per√≠odo:', error);
                showMessage('Error al abrir per√≠odo: ' + error.message, 'danger');
            }
        }

        async function cerrarPeriodo(periodId, periodName) {
            if (!confirm(`¬øCerrar el per√≠odo "${periodName}"?\n\nLos estudiantes ya no podr√°n evaluar.`)) return;

            try {
                await supabaseRequest(`/teval_periods?period_id=eq.${periodId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        period_status: 'closed',
                        closed_by: currentUserId,
                        closed_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                });

                showMessage(`Per√≠odo "${periodName}" cerrado correctamente`, 'success');
                await cargarPeriodos();

            } catch (error) {
                console.error('‚ùå Error cerrando per√≠odo:', error);
                showMessage('Error al cerrar per√≠odo: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // ELIMINAR PER√çODO
        // ==========================================
        async function eliminarPeriodo(periodId, periodName) {
            const periodo = periodos.find(p => p.period_id === periodId);
            if (periodo && periodo.period_status === 'open') {
                showMessage('No se puede eliminar un per√≠odo abierto. Ci√©rrelo primero.', 'warning');
                return;
            }

            if (!confirm(`¬øEliminar el per√≠odo "${periodName}"?\n\nEsta acci√≥n no se puede deshacer.`)) return;

            try {
                // Eliminar asociaciones de formularios
                await supabaseRequest(
                    `/teval_period_forms?period_id=eq.${periodId}`,
                    { method: 'DELETE' }
                );

                // Eliminar per√≠odo
                await supabaseRequest(
                    `/teval_periods?period_id=eq.${periodId}`,
                    { method: 'DELETE' }
                );

                showMessage('Per√≠odo eliminado correctamente', 'success');
                await cargarPeriodos();

            } catch (error) {
                console.error('‚ùå Error eliminando per√≠odo:', error);
                showMessage('Error al eliminar: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.abrirModalPeriodo = abrirModalPeriodo;
        window.editarPeriodo = editarPeriodo;
        window.eliminarPeriodo = eliminarPeriodo;
        window.abrirPeriodo = abrirPeriodo;
        window.cerrarPeriodo = cerrarPeriodo;

        console.log('‚úÖ P√°gina Per√≠odos de Evaluaci√≥n Docente cargada');
    </script>
</body>
</html>
