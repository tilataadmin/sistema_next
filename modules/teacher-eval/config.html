<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.28.16.30">
    <title>Configuraci√≥n - Evaluaci√≥n Docente - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center;
            align-items: center; z-index: 9999;
        }
        .loading-overlay.hidden { display: none; }
        .loading-content {
            background: white; padding: 2rem; border-radius: 8px; text-align: center;
        }
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #0ea5e9;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 1rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .config-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        .config-card .card-header {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 1rem 1.5rem;
        }
        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #0ea5e9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e0f2fe;
        }
        .min-max-fields {
            transition: all 0.3s ease;
        }
        .min-max-fields.disabled-fields {
            opacity: 0.4;
            pointer-events: none;
        }
        .last-update-info {
            font-size: 0.8rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando configuraci√≥n...</p>
        </div>
    </div>

    <div class="container-fluid">
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Evaluaci√≥n Docente</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Configuraci√≥n</li>
            </ol>
        </nav>

        <div class="row mb-3">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-gear me-2" style="color: #0ea5e9;"></i>Configuraci√≥n de Evaluaci√≥n Docente
                </h1>
                <p class="text-muted">Par√°metros generales del m√≥dulo de evaluaci√≥n por estudiantes</p>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card config-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Par√°metros del M√≥dulo</h5>
                        <span class="last-update-info" id="lastUpdateInfo"></span>
                    </div>
                    <div class="card-body p-4">
                        <form id="configForm">

                            <!-- SECCI√ìN: Modo de evaluaci√≥n -->
                            <div class="mb-4">
                                <div class="section-title">
                                    <i class="bi bi-toggles me-1"></i>Modo de Evaluaci√≥n
                                </div>
                                <div class="mb-3">
                                    <label for="evalMode" class="form-label fw-bold">¬øCu√°ntos profesores eval√∫a cada estudiante?</label>
                                    <select class="form-select" id="evalMode" onchange="toggleMinMax()">
                                        <option value="all">Todos sus profesores</option>
                                        <option value="min_max">Un rango (m√≠nimo y m√°ximo)</option>
                                    </select>
                                    <div class="form-text">En modo "Todos", el estudiante debe evaluar a cada profesor asignado a su curso.</div>
                                </div>

                                <div class="row g-3 min-max-fields disabled-fields" id="minMaxFields">
                                    <div class="col-md-6">
                                        <label for="minTeachers" class="form-label fw-bold">M√≠nimo de profesores</label>
                                        <input type="number" class="form-control" id="minTeachers" min="1" value="1">
                                        <div class="form-text">Cantidad m√≠nima que debe evaluar</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="maxTeachers" class="form-label fw-bold">M√°ximo de profesores</label>
                                        <input type="number" class="form-control" id="maxTeachers" min="1" value="5">
                                        <div class="form-text">Cantidad m√°xima permitida</div>
                                    </div>
                                </div>
                            </div>

                            <!-- SECCI√ìN: Textos del formulario p√∫blico -->
                            <div class="mb-4">
                                <div class="section-title">
                                    <i class="bi bi-chat-left-text me-1"></i>Textos del Formulario P√∫blico
                                </div>
                                <div class="mb-3">
                                    <label for="welcomeText" class="form-label fw-bold">Texto de bienvenida</label>
                                    <textarea class="form-control" id="welcomeText" rows="3"
                                        placeholder="Mensaje que ver√° el estudiante al ingresar al sistema de evaluaci√≥n..."></textarea>
                                    <div class="form-text">Se muestra en la pantalla inicial antes de iniciar sesi√≥n</div>
                                </div>
                                <div class="mb-3">
                                    <label for="instructionsText" class="form-label fw-bold">Texto de instrucciones</label>
                                    <textarea class="form-control" id="instructionsText" rows="3"
                                        placeholder="Instrucciones para el estudiante antes de comenzar a evaluar..."></textarea>
                                    <div class="form-text">Se muestra despu√©s de la autenticaci√≥n, antes de la primera evaluaci√≥n</div>
                                </div>
                                <div class="mb-3">
                                    <label for="thankYouText" class="form-label fw-bold">Texto de agradecimiento</label>
                                    <textarea class="form-control" id="thankYouText" rows="3"
                                        placeholder="Mensaje de agradecimiento al finalizar todas las evaluaciones..."></textarea>
                                    <div class="form-text">Se muestra al completar todas las evaluaciones asignadas</div>
                                </div>
                            </div>

                            <!-- SECCI√ìN: Sesi√≥n -->
                            <div class="mb-4">
                                <div class="section-title">
                                    <i class="bi bi-clock me-1"></i>Sesi√≥n del Estudiante
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="sessionTimeout" class="form-label fw-bold">Timeout de sesi√≥n (minutos)</label>
                                        <input type="number" class="form-control" id="sessionTimeout" min="10" max="180" value="60">
                                        <div class="form-text">Tiempo m√°ximo de inactividad antes de cerrar sesi√≥n autom√°ticamente</div>
                                    </div>
                                </div>
                            </div>

                            <!-- BOT√ìN GUARDAR -->
                            <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                                <button type="button" class="btn btn-outline-secondary" onclick="cargarConfiguracion()">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>Descartar Cambios
                                </button>
                                <button type="submit" class="btn btn-primary" id="btnGuardar">
                                    <i class="bi bi-check-circle me-1"></i>Guardar Configuraci√≥n
                                </button>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let configId = null;
        let currentUserId = null;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Validando acceso...');
            try {
                const hasAccess = await validatePageAccess('Configuraci√≥n de evaluaci√≥n');
                if (!hasAccess) return;

                const session = getStoredSession();
                currentUserId = session?.user?.user_id || null;

                await cargarConfiguracion();

                document.getElementById('configForm').addEventListener('submit', guardarConfiguracion);

                console.log('‚úÖ P√°gina de configuraci√≥n inicializada');
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGAR CONFIGURACI√ìN
        // ==========================================
        async function cargarConfiguracion() {
            try {
                document.getElementById('loading-overlay').classList.remove('hidden');

                const data = await supabaseRequest(
                    '/teval_config?select=*&limit=1'
                );

                if (data && data.length > 0) {
                    const config = data[0];
                    configId = config.config_id;

                    // Modo de evaluaci√≥n
                    document.getElementById('evalMode').value = config.eval_mode || 'all';
                    document.getElementById('minTeachers').value = config.min_teachers || 1;
                    document.getElementById('maxTeachers').value = config.max_teachers || 5;

                    // Textos
                    document.getElementById('welcomeText').value = config.welcome_text || '';
                    document.getElementById('instructionsText').value = config.instructions_text || '';
                    document.getElementById('thankYouText').value = config.thank_you_text || '';

                    // Sesi√≥n
                    document.getElementById('sessionTimeout').value = config.session_timeout_minutes || 60;

                    // Toggle min/max
                    toggleMinMax();

                    // Info de √∫ltima actualizaci√≥n
                    if (config.updated_at) {
                        const fecha = new Date(config.updated_at).toLocaleString('es-CO');
                        document.getElementById('lastUpdateInfo').textContent = `√öltima actualizaci√≥n: ${fecha}`;
                    }

                    console.log('‚úÖ Configuraci√≥n cargada');
                } else {
                    // No hay configuraci√≥n, se crear√° al guardar
                    console.log('‚ÑπÔ∏è No hay configuraci√≥n previa, se usar√°n valores por defecto');
                    toggleMinMax();
                }

            } catch (error) {
                console.error('‚ùå Error cargando configuraci√≥n:', error);
                showMessage('Error al cargar la configuraci√≥n: ' + error.message, 'danger');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // ==========================================
        // GUARDAR CONFIGURACI√ìN
        // ==========================================
        async function guardarConfiguracion(e) {
            e.preventDefault();

            const btn = document.getElementById('btnGuardar');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';

            try {
                const evalMode = document.getElementById('evalMode').value;
                const minTeachers = parseInt(document.getElementById('minTeachers').value) || 1;
                const maxTeachers = parseInt(document.getElementById('maxTeachers').value) || null;
                const sessionTimeout = parseInt(document.getElementById('sessionTimeout').value) || 60;

                // Validaciones
                if (evalMode === 'min_max') {
                    if (minTeachers < 1) {
                        showMessage('El m√≠nimo de profesores debe ser al menos 1', 'warning');
                        return;
                    }
                    if (maxTeachers && maxTeachers < minTeachers) {
                        showMessage('El m√°ximo no puede ser menor que el m√≠nimo', 'warning');
                        return;
                    }
                }

                if (sessionTimeout < 10 || sessionTimeout > 180) {
                    showMessage('El timeout debe estar entre 10 y 180 minutos', 'warning');
                    return;
                }

                const payload = {
                    eval_mode: evalMode,
                    min_teachers: evalMode === 'min_max' ? minTeachers : 1,
                    max_teachers: evalMode === 'min_max' ? maxTeachers : null,
                    welcome_text: document.getElementById('welcomeText').value.trim() || null,
                    instructions_text: document.getElementById('instructionsText').value.trim() || null,
                    thank_you_text: document.getElementById('thankYouText').value.trim() || null,
                    session_timeout_minutes: sessionTimeout,
                    updated_by: currentUserId,
                    updated_at: new Date().toISOString()
                };

                if (configId) {
                    // Actualizar registro existente
                    await supabaseRequest(
                        `/teval_config?config_id=eq.${configId}`,
                        {
                            method: 'PATCH',
                            body: JSON.stringify(payload)
                        }
                    );
                } else {
                    // Crear primer registro
                    const result = await supabaseRequest(
                        '/teval_config',
                        {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        }
                    );
                    if (result && result.length > 0) {
                        configId = result[0].config_id;
                    }
                }

                // Actualizar info de √∫ltima actualizaci√≥n
                const ahora = new Date().toLocaleString('es-CO');
                document.getElementById('lastUpdateInfo').textContent = `√öltima actualizaci√≥n: ${ahora}`;

                showMessage('Configuraci√≥n guardada correctamente', 'success');
                console.log('‚úÖ Configuraci√≥n guardada');

            } catch (error) {
                console.error('‚ùå Error guardando:', error);
                showMessage('Error al guardar la configuraci√≥n: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar Configuraci√≥n';
            }
        }

        // ==========================================
        // TOGGLE CAMPOS MIN/MAX
        // ==========================================
        function toggleMinMax() {
            const evalMode = document.getElementById('evalMode').value;
            const minMaxFields = document.getElementById('minMaxFields');

            if (evalMode === 'min_max') {
                minMaxFields.classList.remove('disabled-fields');
                document.getElementById('minTeachers').required = true;
                document.getElementById('maxTeachers').required = true;
            } else {
                minMaxFields.classList.add('disabled-fields');
                document.getElementById('minTeachers').required = false;
                document.getElementById('maxTeachers').required = false;
            }
        }

        console.log('‚úÖ P√°gina Configuraci√≥n de Evaluaci√≥n Docente cargada');
    </script>
</body>
</html>
