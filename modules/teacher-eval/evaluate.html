<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.28.20.00">
    <title>Evaluaci√≥n Docente - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <style>
        body {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
            min-height: 100vh;
        }
        .eval-container {
            max-width: 700px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .eval-card {
            border: none; border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .eval-card .card-header {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white; padding: 1.5rem; text-align: center;
        }
        .eval-card .card-header h4 {
            margin-bottom: 0.25rem;
        }
        .eval-card .card-body {
            padding: 2rem;
        }

        .step { display: none; }
        .step.active { display: block; }

        .welcome-icon {
            font-size: 4rem; color: #0ea5e9; display: block;
            text-align: center; margin-bottom: 1rem;
        }

        .code-inputs {
            display: flex; gap: 0.5rem; justify-content: center; margin: 1.5rem 0;
        }
        .code-inputs input {
            width: 48px; height: 56px; text-align: center;
            font-size: 1.5rem; font-weight: 700; border: 2px solid #dee2e6;
            border-radius: 8px; transition: border-color 0.2s;
        }
        .code-inputs input:focus {
            border-color: #0ea5e9; outline: none;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
        }

        .teacher-card {
            border: 2px solid #e9ecef; border-radius: 12px;
            padding: 1rem; margin-bottom: 0.75rem;
            cursor: pointer; transition: all 0.2s;
        }
        .teacher-card:hover {
            border-color: #0ea5e9; background: #f0f9ff;
        }
        .teacher-card.completed {
            border-color: #10b981; background: #ecfdf5;
        }
        .teacher-card.current {
            border-color: #0ea5e9; background: #e0f2fe;
        }

        .section-header {
            background: #f1f5f9; border-radius: 8px;
            padding: 0.75rem 1rem; margin-bottom: 1rem;
        }

        .question-block {
            padding: 1rem 0; border-bottom: 1px solid #f1f5f9;
        }
        .question-block:last-child {
            border-bottom: none;
        }
        .question-text {
            font-weight: 500; margin-bottom: 0.75rem;
        }

        .scale-options {
            display: flex; gap: 0.5rem; flex-wrap: wrap;
        }
        .scale-option {
            border: 2px solid #e9ecef; border-radius: 8px;
            padding: 0.5rem 0.75rem; text-align: center;
            cursor: pointer; transition: all 0.2s; min-width: 60px;
        }
        .scale-option:hover {
            border-color: #0ea5e9; background: #f0f9ff;
        }
        .scale-option.selected {
            border-color: #0ea5e9; background: #0ea5e9; color: white;
        }
        .scale-option .option-icon {
            font-size: 1.25rem; display: block;
        }
        .scale-option .option-label {
            font-size: 0.7rem; display: block; margin-top: 0.15rem;
        }

        .progress-eval {
            height: 6px; border-radius: 3px; background: #e9ecef;
            margin-bottom: 1.5rem;
        }
        .progress-eval .fill {
            height: 100%; border-radius: 3px; background: #0ea5e9;
            transition: width 0.3s;
        }

        .timeout-bar {
            font-size: 0.8rem; color: #6c757d; text-align: center;
            margin-top: 1rem;
        }

        .thankyou-icon {
            font-size: 5rem; color: #10b981; display: block;
            text-align: center; margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <div class="eval-container">
        <div class="card eval-card">
            <div class="card-header">
                <h4><i class="bi bi-clipboard2-pulse me-2"></i>Evaluaci√≥n Docente</h4>
                <small class="opacity-75">SchoolNet</small>
            </div>
            <div class="card-body">

                <div id="alertContainer"></div>

                <!-- PASO 1: BIENVENIDA -->
                <div class="step active" id="step-welcome">
                    <i class="bi bi-emoji-smile welcome-icon"></i>
                    <div id="welcomeText" class="text-center mb-4">
                        <h5>Bienvenido al sistema de Evaluaci√≥n Docente</h5>
                        <p class="text-muted">Tu opini√≥n es importante para mejorar la calidad educativa.</p>
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-primary btn-lg" onclick="irAPaso('step-email')">
                            <i class="bi bi-arrow-right-circle me-2"></i>Comenzar
                        </button>
                    </div>
                </div>

                <!-- PASO 2: INGRESAR EMAIL -->
                <div class="step" id="step-email">
                    <h5 class="text-center mb-3"><i class="bi bi-envelope me-2"></i>Identificaci√≥n</h5>
                    <p class="text-center text-muted mb-4">Ingresa tu correo electr√≥nico institucional para recibir un c√≥digo de verificaci√≥n.</p>
                    <form onsubmit="solicitarCodigo(event)">
                        <div class="mb-3">
                            <label for="studentEmail" class="form-label fw-bold">Correo electr√≥nico</label>
                            <input type="email" class="form-control form-control-lg" id="studentEmail" required
                                   placeholder="tu.correo@colegio.edu">
                        </div>
                        <div class="mb-3 d-flex justify-content-center">
                            <div class="g-recaptcha" data-sitekey="RECAPTCHA_SITE_KEY_AQUI" id="recaptchaWidget"></div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="btnSendCode">
                                <i class="bi bi-send me-2"></i>Enviar C√≥digo
                            </button>
                        </div>
                    </form>
                    <div class="text-center mt-3">
                        <button class="btn btn-link text-muted btn-sm" onclick="irAPaso('step-welcome')">
                            <i class="bi bi-arrow-left me-1"></i>Volver
                        </button>
                    </div>
                </div>

                <!-- PASO 3: VERIFICAR C√ìDIGO -->
                <div class="step" id="step-code">
                    <h5 class="text-center mb-3"><i class="bi bi-shield-lock me-2"></i>Verificaci√≥n</h5>
                    <p class="text-center text-muted mb-2">Ingresa el c√≥digo de 6 d√≠gitos enviado a:</p>
                    <p class="text-center fw-bold mb-3" id="emailDisplay">-</p>
                    <div class="code-inputs" id="codeInputs">
                        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" class="code-digit" data-index="0">
                        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" class="code-digit" data-index="1">
                        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" class="code-digit" data-index="2">
                        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" class="code-digit" data-index="3">
                        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" class="code-digit" data-index="4">
                        <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" class="code-digit" data-index="5">
                    </div>
                    <div class="d-grid mb-3">
                        <button class="btn btn-primary btn-lg" onclick="verificarCodigo()" id="btnVerifyCode">
                            <i class="bi bi-check-circle me-2"></i>Verificar
                        </button>
                    </div>
                    <div class="text-center">
                        <button class="btn btn-link text-muted btn-sm" onclick="irAPaso('step-email')" id="btnResend">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Reenviar c√≥digo
                        </button>
                    </div>
                </div>

                <!-- PASO 4: INSTRUCCIONES Y LISTA DE PROFESORES -->
                <div class="step" id="step-teachers">
                    <div id="instructionsText" class="mb-4">
                        <h5 class="text-center"><i class="bi bi-info-circle me-2"></i>Instrucciones</h5>
                        <p class="text-center text-muted">Eval√∫a a cada uno de tus profesores respondiendo las preguntas con sinceridad.</p>
                    </div>
                    <h6 class="mb-3"><i class="bi bi-people me-2"></i>Tus profesores a evaluar:</h6>
                    <div class="progress-eval">
                        <div class="fill" id="teacherProgressBar" style="width: 0%;"></div>
                    </div>
                    <small class="text-muted d-block mb-3" id="teacherProgressText">0 de 0 evaluados</small>
                    <div id="teachersList"></div>
                    <div class="timeout-bar">
                        <i class="bi bi-clock me-1"></i>Tiempo restante: <strong id="timeoutDisplay">--:--</strong>
                    </div>
                </div>

                <!-- PASO 5: FORMULARIO DE EVALUACI√ìN -->
                <div class="step" id="step-evaluate">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="volverAListaProfesores()">
                            <i class="bi bi-arrow-left me-1"></i>Volver
                        </button>
                        <small class="text-muted" id="evaluatingInfo">-</small>
                    </div>
                    <div class="progress-eval">
                        <div class="fill" id="sectionProgressBar" style="width: 0%;"></div>
                    </div>
                    <div id="evaluationContent"></div>
                    <div class="d-grid mt-4">
                        <button class="btn btn-success btn-lg" onclick="enviarEvaluacion()" id="btnSubmitEval">
                            <i class="bi bi-check-circle me-2"></i>Enviar Evaluaci√≥n
                        </button>
                    </div>
                </div>

                <!-- PASO 6: AGRADECIMIENTO -->
                <div class="step" id="step-thankyou">
                    <i class="bi bi-check-circle thankyou-icon"></i>
                    <div id="thankYouText" class="text-center">
                        <h4 class="text-success">¬°Gracias por tu participaci√≥n!</h4>
                        <p class="text-muted">Tus respuestas han sido registradas de forma an√≥nima y ayudar√°n a mejorar la calidad educativa.</p>
                    </div>
                    <div class="d-grid mt-4">
                        <button class="btn btn-outline-primary btn-lg" onclick="cerrarSesionEstudiante()">
                            <i class="bi bi-box-arrow-right me-2"></i>Salir
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let studentEmail = '';
        let studentData = null;     // { student_id, course_id, ... }
        let periodoAbierto = null;
        let formAssigned = null;    // Formulario asignado a este estudiante
        let formSections = [];      // Secciones con preguntas y opciones de escala
        let teachersList = [];      // Profesores a evaluar
        let currentTeacherIndex = -1;
        let currentResponses = {};  // question_id -> { value, text }
        let completedTeachers = []; // worker_ids ya evaluados
        let sessionTimeoutMinutes = 60;
        let timeoutInterval = null;
        let sessionExpiry = null;
        let scaleOptionsCache = {}; // scale_id -> options[]
        let englishTeachers = {};   // worker_id -> boolean (dicta en ingl√©s)

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìã Inicializando evaluaci√≥n docente...');

            try {
                // Verificar si hay per√≠odo abierto
                const periodos = await supabaseRequest(
                    '/teval_periods?select=*,academic_years(year_id,year_name)&period_status=eq.open&limit=1'
                );

                if (!periodos || periodos.length === 0) {
                    mostrarError('No hay per√≠odo de evaluaci√≥n abierto en este momento.');
                    return;
                }

                periodoAbierto = periodos[0];
                console.log('‚úÖ Per√≠odo abierto:', periodoAbierto.period_name);

                // Cargar configuraci√≥n
                await cargarConfiguracion();

                // Configurar inputs del c√≥digo
                configurarCodeInputs();

                console.log('‚úÖ Evaluaci√≥n docente inicializada');
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                mostrarError('Error al cargar el sistema de evaluaci√≥n.');
            }
        });

        // ==========================================
        // CARGAR CONFIGURACI√ìN
        // ==========================================
        async function cargarConfiguracion() {
            try {
                const config = await supabaseRequest('/teval_config?select=*&limit=1');

                if (config && config.length > 0) {
                    const c = config[0];
                    sessionTimeoutMinutes = c.session_timeout_minutes || 60;

                    if (c.welcome_text) {
                        document.getElementById('welcomeText').innerHTML = `
                            <h5>Evaluaci√≥n Docente</h5>
                            <p class="text-muted">${escapeHtml(c.welcome_text)}</p>`;
                    }
                    if (c.instructions_text) {
                        document.getElementById('instructionsText').innerHTML = `
                            <h5 class="text-center"><i class="bi bi-info-circle me-2"></i>Instrucciones</h5>
                            <p class="text-center text-muted">${escapeHtml(c.instructions_text)}</p>`;
                    }
                    if (c.thank_you_text) {
                        document.getElementById('thankYouText').innerHTML = `
                            <h4 class="text-success">¬°Gracias!</h4>
                            <p class="text-muted">${escapeHtml(c.thank_you_text)}</p>`;
                    }
                }

                console.log(`‚úÖ Configuraci√≥n cargada (timeout: ${sessionTimeoutMinutes} min)`);
            } catch (error) {
                console.error('‚ùå Error cargando configuraci√≥n:', error);
            }
        }

        // ==========================================
        // CONFIGURAR INPUTS DEL C√ìDIGO DE VERIFICACI√ìN
        // ==========================================
        function configurarCodeInputs() {
            const inputs = document.querySelectorAll('.code-digit');

            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    const value = e.target.value.replace(/[^0-9]/g, '');
                    e.target.value = value;

                    if (value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }

                    // Auto-verificar cuando se llenan todos
                    if (index === inputs.length - 1 && value) {
                        const code = Array.from(inputs).map(i => i.value).join('');
                        if (code.length === 6) {
                            verificarCodigo();
                        }
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });

                // Soporte para pegar c√≥digo completo
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pasteData = (e.clipboardData || window.clipboardData).getData('text').replace(/[^0-9]/g, '');
                    if (pasteData.length === 6) {
                        inputs.forEach((inp, i) => { inp.value = pasteData[i] || ''; });
                        inputs[5].focus();
                        verificarCodigo();
                    }
                });
            });
        }

        // ==========================================
        // PASO 2: SOLICITAR C√ìDIGO DE VERIFICACI√ìN
        // ==========================================
        async function solicitarCodigo(e) {
            e.preventDefault();

            const email = document.getElementById('studentEmail').value.trim().toLowerCase();
            if (!email) return;

            // Validar ReCaptcha
            const recaptchaResponse = grecaptcha.getResponse();
            if (!recaptchaResponse) {
                mostrarAlerta('Por favor completa la verificaci√≥n de seguridad', 'warning');
                return;
            }

            const btn = document.getElementById('btnSendCode');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Enviando...';

            try {
                // Verificar que el email pertenece a un estudiante activo
                const students = await supabaseRequest(
                    `/students?select=student_id,student_first_name,student_last_name_1,student_last_name_2,course_id,student_email,courses(course_name,grade_id,grades(grade_name,section_id))&student_email=eq.${encodeURIComponent(email)}&limit=1`
                );

                if (!students || students.length === 0) {
                    mostrarAlerta('El correo no est√° registrado como estudiante activo', 'danger');
                    grecaptcha.reset();
                    return;
                }

                studentData = students[0];
                studentEmail = email;

                // Generar c√≥digo de 6 d√≠gitos
                const code = String(Math.floor(100000 + Math.random() * 900000));
                const expiresAt = new Date(Date.now() + 10 * 60 * 1000).toISOString(); // 10 minutos

                // Guardar c√≥digo en BD
                await supabaseRequest('/teval_verification_codes', {
                    method: 'POST',
                    body: JSON.stringify({
                        student_email: email,
                        verification_code: code,
                        is_used: false,
                        expires_at: expiresAt
                    })
                });

                // Enviar email con el c√≥digo
                const studentName = `${studentData.student_first_name} ${studentData.student_last_name_1}`;
                const htmlContent = `
                    <div style="font-family:Arial,sans-serif; max-width:500px; margin:0 auto; padding:20px;">
                        <h2 style="color:#0ea5e9; text-align:center;">Evaluaci√≥n Docente</h2>
                        <p>Hola <strong>${studentName}</strong>,</p>
                        <p>Tu c√≥digo de verificaci√≥n es:</p>
                        <div style="text-align:center; margin:20px 0;">
                            <span style="font-size:2rem; font-weight:700; letter-spacing:8px; color:#0ea5e9; background:#f0f9ff; padding:10px 20px; border-radius:8px;">${code}</span>
                        </div>
                        <p style="color:#6c757d; font-size:0.9rem;">Este c√≥digo vence en 10 minutos. No lo compartas con nadie.</p>
                        <hr style="border-color:#e9ecef;">
                        <p style="color:#adb5bd; font-size:0.8rem; text-align:center;">SchoolNet - Evaluaci√≥n Docente</p>
                    </div>`;

                await sendNotification(email, 'C√≥digo de Verificaci√≥n - Evaluaci√≥n Docente', htmlContent);

                // Ir al paso de verificaci√≥n
                document.getElementById('emailDisplay').textContent = email;
                irAPaso('step-code');
                document.querySelector('.code-digit[data-index="0"]').focus();

                console.log('‚úÖ C√≥digo enviado a:', email);

            } catch (error) {
                console.error('‚ùå Error enviando c√≥digo:', error);
                mostrarAlerta('Error al enviar el c√≥digo. Intenta nuevamente.', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-send me-2"></i>Enviar C√≥digo';
                grecaptcha.reset();
            }
        }

        // ==========================================
        // PASO 3: VERIFICAR C√ìDIGO
        // ==========================================
        async function verificarCodigo() {
            const inputs = document.querySelectorAll('.code-digit');
            const code = Array.from(inputs).map(i => i.value).join('');

            if (code.length !== 6) {
                mostrarAlerta('Ingresa el c√≥digo completo de 6 d√≠gitos', 'warning');
                return;
            }

            const btn = document.getElementById('btnVerifyCode');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Verificando...';

            try {
                // Buscar c√≥digo v√°lido
                const codes = await supabaseRequest(
                    `/teval_verification_codes?select=code_id,expires_at&student_email=eq.${encodeURIComponent(studentEmail)}&verification_code=eq.${code}&is_used=eq.false&order=created_at.desc&limit=1`
                );

                if (!codes || codes.length === 0) {
                    mostrarAlerta('C√≥digo inv√°lido o expirado. Solicita uno nuevo.', 'danger');
                    inputs.forEach(i => { i.value = ''; });
                    inputs[0].focus();
                    return;
                }

                // Verificar expiraci√≥n
                const expiresAt = new Date(codes[0].expires_at);
                if (expiresAt < new Date()) {
                    mostrarAlerta('El c√≥digo ha expirado. Solicita uno nuevo.', 'danger');
                    inputs.forEach(i => { i.value = ''; });
                    inputs[0].focus();
                    return;
                }

                // Marcar c√≥digo como usado
                await supabaseRequest(`/teval_verification_codes?code_id=eq.${codes[0].code_id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_used: true })
                });

                console.log('‚úÖ C√≥digo verificado correctamente');

                // Iniciar sesi√≥n de evaluaci√≥n
                await iniciarSesionEvaluacion();

            } catch (error) {
                console.error('‚ùå Error verificando c√≥digo:', error);
                mostrarAlerta('Error al verificar. Intenta nuevamente.', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Verificar';
            }
        }

        // ==========================================
        // INICIAR SESI√ìN DE EVALUACI√ìN
        // ==========================================
        async function iniciarSesionEvaluacion() {
            try {
                const periodId = periodoAbierto.period_id;
                const yearId = periodoAbierto.academic_years?.year_id;
                const courseId = studentData.course_id;
                const sectionId = studentData.courses?.grades?.section_id;

                // Obtener formulario asignado a la secci√≥n del estudiante
                const periodForms = await supabaseRequest(
                    `/teval_period_forms?select=form_id,teval_forms(form_id,form_name,section_id)&period_id=eq.${periodId}`
                );

                formAssigned = periodForms.find(pf =>
                    pf.teval_forms?.section_id === sectionId
                );

                if (!formAssigned) {
                    mostrarError('No hay un formulario de evaluaci√≥n asignado para tu secci√≥n.');
                    return;
                }

                const formId = formAssigned.teval_forms.form_id;

                // Cargar secciones y preguntas del formulario
                const sections = await supabaseRequest(
                    `/teval_form_sections?select=form_section_id,section_title,section_order,english_only,scale_id&form_id=eq.${formId}&order=section_order`
                );

                const questions = await supabaseRequest(
                    `/teval_form_questions?select=question_id,form_section_id,question_text,question_type,question_order,is_required&form_section_id=in.(${sections.map(s => `"${s.form_section_id}"`).join(',')})&order=question_order`
                );

                // Cargar opciones de escala para cada scale_id √∫nico
                const scaleIds = [...new Set(sections.map(s => s.scale_id).filter(Boolean))];
                for (const scaleId of scaleIds) {
                    if (!scaleOptionsCache[scaleId]) {
                        const options = await supabaseRequest(
                            `/survey_scale_options?select=option_id,option_text,option_value,option_icon&scale_id=eq.${scaleId}&order=option_value`
                        );
                        scaleOptionsCache[scaleId] = options || [];
                    }
                }

                // Armar estructura: secciones con sus preguntas
                formSections = sections.map(sec => ({
                    ...sec,
                    questions: questions.filter(q => q.form_section_id === sec.form_section_id)
                }));

                // Obtener profesores del curso del estudiante en el a√±o acad√©mico
                const assignments = await supabaseRequest(
                    `/academic_assignments?select=worker_id,workers(worker_id,worker_first_name,worker_last_name_1,worker_last_name_2),academic_subjects(subject_name,is_english)&course_id=eq.${courseId}&academic_year_id=eq.${yearId}`
                );

                if (!assignments || assignments.length === 0) {
                    mostrarError('No se encontraron profesores asignados a tu curso.');
                    return;
                }

                // Agrupar por profesor (uno puede tener varias materias)
                const teacherMap = {};
                assignments.forEach(a => {
                    const wid = a.worker_id;
                    if (!teacherMap[wid]) {
                        const w = a.workers;
                        teacherMap[wid] = {
                            workerId: wid,
                            name: `${w.worker_first_name} ${w.worker_last_name_1} ${w.worker_last_name_2 || ''}`.trim(),
                            subjects: [],
                            teachesEnglish: false
                        };
                    }
                    teacherMap[wid].subjects.push(a.academic_subjects?.subject_name || '-');
                    if (a.academic_subjects?.is_english) {
                        teacherMap[wid].teachesEnglish = true;
                    }
                });

                teachersList = Object.values(teacherMap).sort((a, b) => a.name.localeCompare(b.name));

                // Registrar qu√© profesores dictan ingl√©s
                teachersList.forEach(t => {
                    englishTeachers[t.workerId] = t.teachesEnglish;
                });

                // Verificar evaluaciones ya completadas en este per√≠odo
                const existing = await supabaseRequest(
                    `/teval_sessions?select=worker_id&period_id=eq.${periodId}&student_id=eq.${studentData.student_id}&session_status=eq.completed`
                );

                completedTeachers = (existing || []).map(s => s.worker_id);

                // Aplicar modo de evaluaci√≥n (all o min_max)
                await aplicarModoEvaluacion();

                // Iniciar temporizador
                iniciarTimeout();

                // Mostrar lista de profesores
                renderizarListaProfesores();
                irAPaso('step-teachers');

                console.log(`‚úÖ Sesi√≥n iniciada: ${teachersList.length} profesores, ${formSections.length} secciones`);

            } catch (error) {
                console.error('‚ùå Error iniciando sesi√≥n:', error);
                mostrarError('Error al cargar la evaluaci√≥n. Intenta nuevamente.');
            }
        }

        // ==========================================
        // APLICAR MODO DE EVALUACI√ìN (all o min_max)
        // ==========================================
        async function aplicarModoEvaluacion() {
            try {
                const config = await supabaseRequest('/teval_config?select=eval_mode,min_teachers,max_teachers&limit=1');

                if (!config || config.length === 0) return;

                const c = config[0];

                if (c.eval_mode === 'min_max' && teachersList.length > c.max_teachers) {
                    // El estudiante solo necesita evaluar entre min y max profesores
                    // No se restringe la lista, pero se muestra un mensaje
                    console.log(`üìã Modo min_max: evaluar entre ${c.min_teachers} y ${c.max_teachers} de ${teachersList.length} profesores`);
                }
                // En modo 'all' se eval√∫an todos

            } catch (error) {
                console.error('‚ùå Error aplicando modo:', error);
            }
        }

        // ==========================================
        // TEMPORIZADOR DE SESI√ìN
        // ==========================================
        function iniciarTimeout() {
            sessionExpiry = new Date(Date.now() + sessionTimeoutMinutes * 60 * 1000);

            actualizarDisplayTimeout();
            timeoutInterval = setInterval(() => {
                actualizarDisplayTimeout();

                if (new Date() >= sessionExpiry) {
                    clearInterval(timeoutInterval);
                    mostrarError('Tu sesi√≥n ha expirado. Por favor ingresa nuevamente.');
                    setTimeout(() => {
                        irAPaso('step-welcome');
                        resetearEstado();
                    }, 3000);
                }
            }, 1000);
        }

        function actualizarDisplayTimeout() {
            const now = new Date();
            const diff = Math.max(0, sessionExpiry - now);
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            const display = document.getElementById('timeoutDisplay');
            if (display) {
                display.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                display.style.color = minutes < 5 ? '#ef4444' : '';
            }
        }

        function resetearEstado() {
            studentEmail = '';
            studentData = null;
            formAssigned = null;
            formSections = [];
            teachersList = [];
            currentTeacherIndex = -1;
            currentResponses = {};
            completedTeachers = [];
            if (timeoutInterval) clearInterval(timeoutInterval);
        }

        // ==========================================
        // RENDERIZAR LISTA DE PROFESORES
        // ==========================================
        function renderizarListaProfesores() {
            const container = document.getElementById('teachersList');
            const totalTeachers = teachersList.length;
            const totalCompleted = completedTeachers.length;
            const pct = totalTeachers > 0 ? Math.round((totalCompleted / totalTeachers) * 100) : 0;

            document.getElementById('teacherProgressBar').style.width = pct + '%';
            document.getElementById('teacherProgressText').textContent =
                `${totalCompleted} de ${totalTeachers} evaluados`;

            let html = '';
            teachersList.forEach((t, idx) => {
                const isCompleted = completedTeachers.includes(t.workerId);
                const cardClass = isCompleted ? 'completed' : '';
                const subjects = t.subjects.join(', ');

                const statusIcon = isCompleted
                    ? '<i class="bi bi-check-circle-fill text-success fs-5"></i>'
                    : '<i class="bi bi-circle text-muted fs-5"></i>';

                const englishBadge = t.teachesEnglish
                    ? ' <span class="badge bg-info" style="font-size:0.65rem;"><i class="bi bi-translate me-1"></i>Ingl√©s</span>'
                    : '';

                html += `
                    <div class="teacher-card ${cardClass}" onclick="${isCompleted ? '' : `iniciarEvaluacionProfesor(${idx})`}" 
                         style="${isCompleted ? 'cursor:default; opacity:0.7;' : ''}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${escapeHtml(t.name)}</strong>${englishBadge}
                                <br><small class="text-muted">${escapeHtml(subjects)}</small>
                            </div>
                            <div>
                                ${isCompleted
                                    ? '<span class="badge bg-success">Evaluado</span>'
                                    : '<span class="badge bg-light text-dark">Pendiente</span>'}
                                ${statusIcon}
                            </div>
                        </div>
                    </div>`;
            });

            // Verificar si ya termin√≥ todos
            if (totalCompleted === totalTeachers && totalTeachers > 0) {
                html += `
                    <div class="d-grid mt-3">
                        <button class="btn btn-success btn-lg" onclick="finalizarEvaluacion()">
                            <i class="bi bi-check-all me-2"></i>Finalizar Evaluaci√≥n
                        </button>
                    </div>`;
            }

            container.innerHTML = html;
        }

        // ==========================================
        // INICIAR EVALUACI√ìN DE UN PROFESOR
        // ==========================================
        function iniciarEvaluacionProfesor(index) {
            currentTeacherIndex = index;
            const teacher = teachersList[index];
            currentResponses = {};

            document.getElementById('evaluatingInfo').innerHTML =
                `<strong>${escapeHtml(teacher.name)}</strong>`;

            // Determinar si el profesor dicta ingl√©s
            const isEnglishTeacher = englishTeachers[teacher.workerId] || false;

            // Construir contenido del formulario
            let html = '';
            let questionCount = 0;
            let sectionCount = 0;

            // Filtrar secciones: incluir english_only solo si el profesor dicta ingl√©s
            const visibleSections = formSections.filter(sec => {
                if (sec.english_only && !isEnglishTeacher) return false;
                return true;
            });

            visibleSections.forEach(sec => {
                sectionCount++;
                const scaleOptions = scaleOptionsCache[sec.scale_id] || [];

                const englishTag = sec.english_only
                    ? ' <span class="badge bg-info" style="font-size:0.65rem;"><i class="bi bi-translate me-1"></i>Solo ingl√©s</span>'
                    : '';

                html += `
                    <div class="section-header">
                        <strong>${sectionCount}. ${escapeHtml(sec.section_title)}</strong>${englishTag}
                    </div>`;

                sec.questions.forEach(q => {
                    questionCount++;
                    const requiredMark = q.is_required ? ' <span class="text-danger">*</span>' : '';

                    html += `<div class="question-block" data-question-id="${q.question_id}">`;
                    html += `<div class="question-text">${questionCount}. ${escapeHtml(q.question_text)}${requiredMark}</div>`;

                    if (q.question_type === 'scale' && scaleOptions.length > 0) {
                        html += '<div class="scale-options">';
                        scaleOptions.forEach(opt => {
                            const iconHtml = opt.option_icon ? `<span class="option-icon">${opt.option_icon}</span>` : '';
                            html += `
                                <div class="scale-option" data-question="${q.question_id}" data-value="${opt.option_value}"
                                     onclick="seleccionarOpcion(this, '${q.question_id}', ${opt.option_value})">
                                    ${iconHtml}
                                    <span class="option-label">${escapeHtml(opt.option_text)}</span>
                                </div>`;
                        });
                        html += '</div>';
                    } else if (q.question_type === 'open_text') {
                        html += `
                            <textarea class="form-control" rows="3" placeholder="Escribe tu comentario aqu√≠..."
                                      onchange="guardarTexto('${q.question_id}', this.value)"
                                      oninput="guardarTexto('${q.question_id}', this.value)"></textarea>`;
                    }

                    html += '</div>';
                });
            });

            document.getElementById('evaluationContent').innerHTML = html;
            document.getElementById('sectionProgressBar').style.width = '0%';
            irAPaso('step-evaluate');

            // Scroll al inicio
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==========================================
        // SELECCIONAR OPCI√ìN DE ESCALA
        // ==========================================
        function seleccionarOpcion(element, questionId, value) {
            // Deseleccionar anteriores de la misma pregunta
            document.querySelectorAll(`.scale-option[data-question="${questionId}"]`).forEach(el => {
                el.classList.remove('selected');
            });

            element.classList.add('selected');
            currentResponses[questionId] = { value: value, text: null };

            actualizarProgreso();
        }

        // ==========================================
        // GUARDAR TEXTO ABIERTO
        // ==========================================
        function guardarTexto(questionId, text) {
            currentResponses[questionId] = { value: null, text: text.trim() };
            actualizarProgreso();
        }

        // ==========================================
        // ACTUALIZAR BARRA DE PROGRESO
        // ==========================================
        function actualizarProgreso() {
            const teacher = teachersList[currentTeacherIndex];
            const isEnglishTeacher = englishTeachers[teacher.workerId] || false;

            const visibleSections = formSections.filter(sec => {
                if (sec.english_only && !isEnglishTeacher) return false;
                return true;
            });

            let totalRequired = 0;
            let answeredRequired = 0;

            visibleSections.forEach(sec => {
                sec.questions.forEach(q => {
                    if (q.is_required) {
                        totalRequired++;
                        if (currentResponses[q.question_id]) {
                            const resp = currentResponses[q.question_id];
                            if (resp.value !== null || (resp.text && resp.text.length > 0)) {
                                answeredRequired++;
                            }
                        }
                    }
                });
            });

            const pct = totalRequired > 0 ? Math.round((answeredRequired / totalRequired) * 100) : 0;
            document.getElementById('sectionProgressBar').style.width = pct + '%';
        }

        function volverAListaProfesores() {
            currentTeacherIndex = -1;
            currentResponses = {};
            renderizarListaProfesores();
            irAPaso('step-teachers');
        }

      // ==========================================
        // ENVIAR EVALUACI√ìN DE UN PROFESOR
        // ==========================================
        async function enviarEvaluacion() {
            const teacher = teachersList[currentTeacherIndex];
            const isEnglishTeacher = englishTeachers[teacher.workerId] || false;

            // Validar preguntas obligatorias
            const visibleSections = formSections.filter(sec => {
                if (sec.english_only && !isEnglishTeacher) return false;
                return true;
            });

            let missingRequired = false;
            visibleSections.forEach(sec => {
                sec.questions.forEach(q => {
                    if (!q.is_required) return;
                    const resp = currentResponses[q.question_id];
                    if (!resp || (resp.value === null && (!resp.text || resp.text.length === 0))) {
                        missingRequired = true;
                        // Marcar visualmente
                        const block = document.querySelector(`.question-block[data-question-id="${q.question_id}"]`);
                        if (block) {
                            block.style.background = '#fff5f5';
                            block.style.borderRadius = '8px';
                            block.style.padding = '1rem';
                        }
                    }
                });
            });

            if (missingRequired) {
                mostrarAlerta('Por favor responde todas las preguntas obligatorias (marcadas con *)', 'warning');
                return;
            }

            // Verificar timeout
            if (new Date() >= sessionExpiry) {
                mostrarError('Tu sesi√≥n ha expirado. Por favor ingresa nuevamente.');
                setTimeout(() => { irAPaso('step-welcome'); resetearEstado(); }, 3000);
                return;
            }

            const btn = document.getElementById('btnSubmitEval');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Enviando...';

            try {
                const formId = formAssigned.teval_forms.form_id;

                // Crear sesi√≥n
                const sessionResult = await supabaseRequest('/teval_sessions', {
                    method: 'POST',
                    headers: { 'Prefer': 'return=representation' },
                    body: JSON.stringify({
                        period_id: periodoAbierto.period_id,
                        form_id: formId,
                        student_id: studentData.student_id,
                        worker_id: teacher.workerId,
                        session_status: 'in_progress',
                        started_at: new Date().toISOString()
                    })
                });

                if (!sessionResult || sessionResult.length === 0) {
                    throw new Error('No se pudo crear la sesi√≥n');
                }

                const sessionId = sessionResult[0].session_id;

                // Guardar respuestas
                const responsesToInsert = [];

                visibleSections.forEach(sec => {
                    sec.questions.forEach(q => {
                        const resp = currentResponses[q.question_id];
                        if (resp) {
                            responsesToInsert.push({
                                session_id: sessionId,
                                question_id: q.question_id,
                                response_value: resp.value,
                                response_text: resp.text || null,
                                responded_at: new Date().toISOString()
                            });
                        }
                    });
                });

                if (responsesToInsert.length > 0) {
                    await supabaseRequest('/teval_responses', {
                        method: 'POST',
                        body: JSON.stringify(responsesToInsert)
                    });
                }

                // Marcar sesi√≥n como completada
                await supabaseRequest(`/teval_sessions?session_id=eq.${sessionId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        session_status: 'completed',
                        completed_at: new Date().toISOString()
                    })
                });

                // Actualizar estado local
                completedTeachers.push(teacher.workerId);

                console.log(`‚úÖ Evaluaci√≥n enviada para: ${teacher.name}`);
                mostrarAlerta(`Evaluaci√≥n de ${teacher.name} enviada correctamente`, 'success');

                // Volver a lista de profesores
                currentTeacherIndex = -1;
                currentResponses = {};
                renderizarListaProfesores();
                irAPaso('step-teachers');

            } catch (error) {
                console.error('‚ùå Error enviando evaluaci√≥n:', error);
                mostrarAlerta('Error al enviar la evaluaci√≥n. Intenta nuevamente.', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Enviar Evaluaci√≥n';
            }
        }

        // ==========================================
        // FINALIZAR EVALUACI√ìN (TODOS LOS PROFESORES)
        // ==========================================
        function finalizarEvaluacion() {
            if (timeoutInterval) clearInterval(timeoutInterval);
            irAPaso('step-thankyou');
            console.log('üéâ Evaluaci√≥n completa');
        }

        // ==========================================
        // CERRAR SESI√ìN DEL ESTUDIANTE
        // ==========================================
        function cerrarSesionEstudiante() {
            resetearEstado();

            // Limpiar formulario
            document.getElementById('studentEmail').value = '';
            document.querySelectorAll('.code-digit').forEach(i => { i.value = ''; });

            irAPaso('step-welcome');

            console.log('üëã Sesi√≥n cerrada');
        }

        // ==========================================
        // NAVEGACI√ìN ENTRE PASOS
        // ==========================================
        function irAPaso(stepId) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(stepId);
            if (target) target.classList.add('active');
        }

        // ==========================================
        // MENSAJES Y ALERTAS
        // ==========================================
        function mostrarAlerta(message, type) {
            const container = document.getElementById('alertContainer');
            const id = 'alert-' + Date.now();
            container.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" id="${id}" role="alert">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'x-circle'} me-2"></i>
                    ${escapeHtml(message)}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`;

            setTimeout(() => {
                const el = document.getElementById(id);
                if (el) el.remove();
            }, 5000);
        }

        function mostrarError(message) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));

            const container = document.querySelector('.card-body');
            const alertHtml = `
                <div class="text-center py-4" id="errorGeneral">
                    <i class="bi bi-exclamation-triangle" style="font-size:3rem; color:#f59e0b;"></i>
                    <h5 class="mt-3">${escapeHtml(message)}</h5>
                    <button class="btn btn-outline-primary mt-3" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Reintentar
                    </button>
                </div>`;

            // Insertar despu√©s del alertContainer
            const alertContainer = document.getElementById('alertContainer');
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = alertHtml;
            alertContainer.after(errorDiv);
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.solicitarCodigo = solicitarCodigo;
        window.verificarCodigo = verificarCodigo;
        window.iniciarEvaluacionProfesor = iniciarEvaluacionProfesor;
        window.seleccionarOpcion = seleccionarOpcion;
        window.guardarTexto = guardarTexto;
        window.enviarEvaluacion = enviarEvaluacion;
        window.volverAListaProfesores = volverAListaProfesores;
        window.finalizarEvaluacion = finalizarEvaluacion;
        window.cerrarSesionEstudiante = cerrarSesionEstudiante;
        window.irAPaso = irAPaso;

        console.log('‚úÖ P√°gina Evaluaci√≥n Docente (p√∫blica) cargada');
    </script>
</body>
</html>

  
