<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Centros de Costo - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        .module-card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 0.5rem;
        }
        
        .table-container {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }
        
        .center-order {
            width: 60px;
            text-align: center;
            font-weight: bold;
            color: #6c757d;
        }
        
        .loading-row {
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .division-info {
            font-size: 0.875rem;
            color: #6c757d;
        }
    </style>
</head>
<body class="bg-light">
    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS MODERNOS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Talento Humano</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Centros de Costo
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO MODERNO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-building me-2"></i>
                    Gesti√≥n de Centros de Costo
                </h1>
                <p class="text-muted">
                    Gestiona los centros de costo por divisi√≥n organizacional
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>
        <!-- Panel Principal -->
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="mb-1">
                        <i class="bi bi-building me-2 text-info"></i>
                        Centros de Costo
                    </h4>
                    <p class="text-muted mb-0">Lista de centros de costo por divisi√≥n</p>
                </div>
                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#costCenterModal" onclick="openCreateModal()">
                    <i class="bi bi-plus-circle me-2"></i>
                    Nuevo Centro de Costo
                </button>
            </div>

            <!-- Tabla de Centros de Costo -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th width="80">Orden</th>
                            <th>Nombre del Centro de Costo</th>
                            <th width="200">Divisi√≥n</th>
                            <th width="120">Estado</th>
                            <th width="150">Fecha Creaci√≥n</th>
                            <th width="140">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="costCentersTableBody">
                        <tr>
                            <td colspan="6" class="loading-row">
                                <i class="bi bi-hourglass-split me-2"></i>
                                Cargando centros de costo...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para Crear/Editar Centro de Costo -->
    <div class="modal fade" id="costCenterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="bi bi-plus-circle me-2"></i>
                        Nuevo Centro de Costo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <form id="costCenterForm">
                    <div class="modal-body">
                        <!-- Campo oculto para ID -->
                        <input type="hidden" id="costCenterId">
                        
                        <!-- Divisi√≥n -->
                        <div class="mb-3">
                            <label for="divisionId" class="form-label">
                                <i class="bi bi-diagram-3 me-1"></i>
                                Divisi√≥n <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="divisionId" required>
                                <option value="">Seleccione una divisi√≥n...</option>
                            </select>
                            <div class="form-text">
                                Divisi√≥n a la que pertenece este centro de costo
                            </div>
                        </div>

                        <!-- Nombre del Centro de Costo -->
                        <div class="mb-3">
                            <label for="costCenterName" class="form-label">
                                <i class="bi bi-building me-1"></i>
                                Nombre del Centro de Costo <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="costCenterName" 
                                   placeholder="Ej: Administraci√≥n, Tecnolog√≠a, Recursos Humanos..."
                                   required 
                                   maxlength="100">
                            <div class="form-text">
                                Nombre √∫nico dentro de la divisi√≥n seleccionada
                            </div>
                        </div>

                        <!-- Orden -->
                        <div class="mb-3">
                            <label for="costCenterOrder" class="form-label">
                                <i class="bi bi-sort-numeric-up me-1"></i>
                                Orden de Visualizaci√≥n
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="costCenterOrder" 
                                   placeholder="1, 2, 3..."
                                   min="1" 
                                   max="100">
                            <div class="form-text">
                                N√∫mero que define el orden en que aparecer√° el centro de costo
                            </div>
                        </div>

                        <!-- Estado -->
                        <div class="mb-3">
                            <label for="costCenterStatus" class="form-label">
                                <i class="bi bi-toggle-on me-1"></i>
                                Estado
                            </label>
                            <select class="form-select" id="costCenterStatus" required>
                                <option value="active">Activo</option>
                                <option value="inactive">Inactivo</option>
                            </select>
                            <div class="form-text">
                                Los centros de costo inactivos no aparecer√°n en la asignaci√≥n de trabajadores
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i>
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-info" id="saveButton">
                            <i class="bi bi-check-circle me-2"></i>
                            Guardar Centro de Costo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Eliminar -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Confirmar Eliminaci√≥n
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">¬øEst√°s seguro de que deseas eliminar este centro de costo?</p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Advertencia:</strong> Esta acci√≥n no se puede deshacer. Si el centro de costo tiene √°reas organizacionales asociadas, deber√°s reasignarlas antes de eliminar.
                    </div>
                    <p class="fw-bold mb-0" id="costCenterToDelete"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">
                        <i class="bi bi-trash me-2"></i>
                        Eliminar Centro de Costo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let currentCostCenterId = null;
        let costCenters = [];
        let divisions = [];

        // ==========================================
        // VALIDACI√ìN DE ACCESO A LA P√ÅGINA
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Centros de costos');
                
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                
                // Inicializar la carga de datos
                await loadInitialData();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        // ==========================================
        // FUNCIONES DE CARGA DE DATOS
        // ==========================================

        async function loadInitialData() {
            try {
                // Cargar divisiones y centros de costo en paralelo
                await Promise.all([
                    loadDivisions(),
                    loadCostCenters()
                ]);
                
            } catch (error) {
                console.error('‚ùå Error cargando datos iniciales:', error);
                showMessage('Error al cargar los datos iniciales: ' + error.message, 'danger');
            }
        }

        async function loadDivisions() {
            try {
                console.log('üì° Cargando divisiones...');
                
                const data = await supabaseRequest('/organizational_divisions?select=*&division_status=eq.active&order=division_order.asc.nullslast,division_name.asc');

                divisions = data || [];
                populateDivisionDropdown();
                
                console.log(`‚úÖ ${divisions.length} divisiones activas cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando divisiones:', error);
                showMessage('Error al cargar las divisiones: ' + error.message, 'danger');
            }
        }

        async function loadCostCenters() {
            try {
                console.log('üì° Cargando centros de costo...');
                
                const data = await supabaseRequest('/cost_centers?select=*,organizational_divisions(division_name)&order=cost_center_order.asc.nullslast,cost_center_name.asc');

                costCenters = data || [];
                renderCostCentersTable();
                
                console.log(`‚úÖ ${costCenters.length} centros de costo cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando centros de costo:', error);
                showMessage('Error al cargar los centros de costo: ' + error.message, 'danger');
                renderEmptyState('Error al cargar los datos');
            }
        }

        function populateDivisionDropdown() {
            const select = document.getElementById('divisionId');
            
            // Limpiar opciones existentes excepto la primera
            select.innerHTML = '<option value="">Seleccione una divisi√≥n...</option>';
            
            divisions.forEach(division => {
                const option = document.createElement('option');
                option.value = division.division_id;
                option.textContent = division.division_name;
                select.appendChild(option);
            });
        }

        // ==========================================
        // FUNCIONES DE RENDERIZADO
        // ==========================================

        function renderCostCentersTable() {
            const tbody = document.getElementById('costCentersTableBody');
            
            if (costCenters.length === 0) {
                renderEmptyState('No hay centros de costo registrados');
                return;
            }

            tbody.innerHTML = costCenters.map(costCenter => `
                <tr>
                    <td class="center-order">${costCenter.cost_center_order || '-'}</td>
                    <td>
                        <strong>${escapeHtml(costCenter.cost_center_name)}</strong>
                    </td>
                    <td>
                        <div class="division-info">
                            <i class="bi bi-diagram-3 me-1"></i>
                            ${escapeHtml(costCenter.organizational_divisions?.division_name || 'Sin divisi√≥n')}
                        </div>
                    </td>
                    <td>
                        <span class="badge status-badge ${costCenter.cost_center_status === 'active' ? 'bg-success' : 'bg-secondary'}">
                            <i class="bi bi-${costCenter.cost_center_status === 'active' ? 'check-circle' : 'pause-circle'} me-1"></i>
                            ${costCenter.cost_center_status === 'active' ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td class="text-muted">
                        ${formatDate(costCenter.created_at)}
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button type="button" 
                                    class="btn btn-outline-info btn-action" 
                                    onclick="editCostCenter('${costCenter.cost_center_id}')"
                                    title="Editar centro de costo">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button type="button" 
                                    class="btn btn-outline-danger btn-action" 
                                    onclick="deleteCostCenter('${costCenter.cost_center_id}', '${escapeHtml(costCenter.cost_center_name)}')"
                                    title="Eliminar centro de costo">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderEmptyState(message) {
            const tbody = document.getElementById('costCentersTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <i class="bi bi-building"></i>
                        <h5>${escapeHtml(message)}</h5>
                        <p>Crea el primer centro de costo para organizar tu estructura</p>
                        <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#costCenterModal" onclick="openCreateModal()">
                            <i class="bi bi-plus-circle me-2"></i>
                            Nuevo Centro de Costo
                        </button>
                    </td>
                </tr>
            `;
        }

        // ==========================================
        // FUNCIONES DEL MODAL
        // ==========================================

        function openCreateModal() {
            currentCostCenterId = null;
            document.getElementById('modalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nuevo Centro de Costo';
            document.getElementById('saveButton').innerHTML = '<i class="bi bi-check-circle me-2"></i>Guardar Centro de Costo';
            
            // Limpiar formulario
            document.getElementById('costCenterForm').reset();
            document.getElementById('costCenterId').value = '';
            document.getElementById('costCenterStatus').value = 'active';
        }

        function updateOrderSuggestion() {
            const selectedDivisionId = document.getElementById('divisionId').value;
            if (!selectedDivisionId) return;
            
            // Filtrar centros de costo de la divisi√≥n seleccionada
            const centersInDivision = costCenters.filter(cc => cc.division_id === selectedDivisionId);
            const maxOrder = Math.max(...centersInDivision.map(cc => cc.cost_center_order || 0), 0);
            document.getElementById('costCenterOrder').value = maxOrder + 1;
        }

        function editCostCenter(costCenterId) {
            currentCostCenterId = costCenterId;
            const costCenter = costCenters.find(cc => cc.cost_center_id === costCenterId);
            
            if (!costCenter) {
                showMessage('Centro de costo no encontrado', 'danger');
                return;
            }

            // Actualizar modal
            document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Centro de Costo';
            document.getElementById('saveButton').innerHTML = '<i class="bi bi-check-circle me-2"></i>Actualizar Centro de Costo';
            
            // Llenar formulario
            document.getElementById('costCenterId').value = costCenter.cost_center_id;
            document.getElementById('divisionId').value = costCenter.division_id;
            document.getElementById('costCenterName').value = costCenter.cost_center_name;
            document.getElementById('costCenterOrder').value = costCenter.cost_center_order || '';
            document.getElementById('costCenterStatus').value = costCenter.cost_center_status;
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('costCenterModal'));
            modal.show();
        }

        function deleteCostCenter(costCenterId, costCenterName) {
            currentCostCenterId = costCenterId;
            document.getElementById('costCenterToDelete').textContent = `Centro de Costo: "${costCenterName}"`;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Hacer funciones disponibles globalmente
        window.openCreateModal = openCreateModal;
        window.editCostCenter = editCostCenter;
        window.deleteCostCenter = deleteCostCenter;
        // ==========================================
        // FUNCIONES CRUD
        // ==========================================

        document.getElementById('costCenterForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validaci√≥n b√°sica
            if (!validateCostCenterForm()) {
                return;
            }

            const saveButton = document.getElementById('saveButton');
            const originalText = saveButton.innerHTML;
            
            try {
                saveButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Guardando...';
                saveButton.disabled = true;

                const formData = {
                    cost_center_name: document.getElementById('costCenterName').value.trim(),
                    division_id: document.getElementById('divisionId').value,
                    cost_center_order: parseInt(document.getElementById('costCenterOrder').value) || null,
                    cost_center_status: document.getElementById('costCenterStatus').value
                };

                let response;

                if (currentCostCenterId) {
                    // Actualizar centro de costo existente
                    response = await supabaseRequest(`/cost_centers?cost_center_id=eq.${currentCostCenterId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            ...formData,
                            updated_at: new Date().toISOString()
                        })
                    });
                    
                    showMessage('Centro de costo actualizado correctamente', 'success');
                } else {
                    // Crear nuevo centro de costo
                    response = await supabaseRequest('/cost_centers', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    
                    showMessage('Centro de costo creado correctamente', 'success');
                }

                // Cerrar modal y recargar datos
                const modal = bootstrap.Modal.getInstance(document.getElementById('costCenterModal'));
                modal.hide();
                
                await loadCostCenters();

            } catch (error) {
                console.error('‚ùå Error guardando centro de costo:', error);
                
                if (error.message.includes('duplicate key')) {
                    showMessage('Ya existe un centro de costo con ese nombre en la divisi√≥n seleccionada', 'danger');
                } else if (error.message.includes('foreign key')) {
                    showMessage('La divisi√≥n seleccionada no es v√°lida', 'danger');
                } else {
                    showMessage('Error al guardar el centro de costo: ' + error.message, 'danger');
                }
            } finally {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        });

        document.getElementById('confirmDeleteButton').addEventListener('click', async function() {
            if (!currentCostCenterId) return;

            const deleteButton = this;
            const originalText = deleteButton.innerHTML;
            
            try {
                deleteButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Eliminando...';
                deleteButton.disabled = true;

                await supabaseRequest(`/cost_centers?cost_center_id=eq.${currentCostCenterId}`, {
                    method: 'DELETE'
                });

                showMessage('Centro de costo eliminado correctamente', 'success');
                
                // Cerrar modal y recargar datos
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                modal.hide();
                
                await loadCostCenters();

            } catch (error) {
                console.error('‚ùå Error eliminando centro de costo:', error);
                
                if (error.message.includes('foreign key')) {
                    showMessage('No se puede eliminar el centro de costo porque tiene √°reas organizacionales asociadas', 'danger');
                } else {
                    showMessage('Error al eliminar el centro de costo: ' + error.message, 'danger');
                }
            } finally {
                deleteButton.innerHTML = originalText;
                deleteButton.disabled = false;
            }
        });

        // ==========================================
        // FUNCIONES DE UTILIDAD Y VALIDACI√ìN
        // ==========================================

        function validateCostCenterForm() {
            const name = document.getElementById('costCenterName').value.trim();
            const divisionId = document.getElementById('divisionId').value;
            
            if (!divisionId) {
                showMessage('Debe seleccionar una divisi√≥n', 'danger');
                return false;
            }
            
            if (!name) {
                showMessage('El nombre del centro de costo es requerido', 'danger');
                return false;
            }
            
            if (name.length < 2) {
                showMessage('El nombre debe tener al menos 2 caracteres', 'danger');
                return false;
            }
            
            // Verificar nombre √∫nico dentro de la misma divisi√≥n
            const existingCostCenter = costCenters.find(cc => 
                cc.cost_center_name.toLowerCase() === name.toLowerCase() && 
                cc.division_id === divisionId &&
                cc.cost_center_id !== currentCostCenterId
            );
            
            if (existingCostCenter) {
                showMessage('Ya existe un centro de costo con ese nombre en la divisi√≥n seleccionada', 'danger');
                return false;
            }
            
            return true;
        }

        // Validaci√≥n en tiempo real para nombres √∫nicos
        document.getElementById('costCenterName').addEventListener('blur', function() {
            const name = this.value.trim();
            const divisionId = document.getElementById('divisionId').value;
            
            if (!name || !divisionId) return;

            const existingCostCenter = costCenters.find(cc => 
                cc.cost_center_name.toLowerCase() === name.toLowerCase() && 
                cc.division_id === divisionId &&
                cc.cost_center_id !== currentCostCenterId
            );

            if (existingCostCenter) {
                this.classList.add('is-invalid');
                if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('invalid-feedback')) {
                    const feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    feedback.textContent = 'Ya existe un centro de costo con este nombre en esta divisi√≥n';
                    this.parentNode.appendChild(feedback);
                }
            } else {
                this.classList.remove('is-invalid');
                const feedback = this.parentNode.querySelector('.invalid-feedback');
                if (feedback) feedback.remove();
            }
        });

        // Tambi√©n validar cuando cambie la divisi√≥n
        document.getElementById('divisionId').addEventListener('change', function() {
            const nameField = document.getElementById('costCenterName');
            if (nameField.value.trim()) {
                nameField.dispatchEvent(new Event('blur'));
            }
            updateOrderSuggestion();
        });

        // Limpiar validaciones al cerrar modal
        document.getElementById('costCenterModal').addEventListener('hidden.bs.modal', function() {
            const form = document.getElementById('costCenterForm');
            form.classList.remove('was-validated');
            
            // Limpiar clases de validaci√≥n
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            form.querySelectorAll('.invalid-feedback').forEach(el => el.remove());
        });

        // Inicializar p√°gina con config.js
        if (window.SUPABASE_CONFIG) {
            initializePage('costCenters', 'Talento Humano');
        } else {
            setTimeout(() => initializePage('costCenters', 'Talento Humano'), 100);
        }
    </script>
</body>
</html>
