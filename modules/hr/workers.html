<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="2025.11.01.05.53">
    <title>Gestionar Trabajadores - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .card-header {
            background-color: var(--bs-light);
            border-bottom: 1px solid #dee2e6;
        }
        
        .table th {
            background-color: var(--bs-light);
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .role-badge {
            font-size: 0.75rem;
            margin: 0.1rem;
        }
        
        .role-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: 1px solid #0056b3;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .organizational-path {
            font-size: 0.9rem;
            color: #6c757d;
            font-style: italic;
        }
        
        .level-progress {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .level-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 50%, #17a2b8 100%);
            transition: width 0.3s ease;
        }
        
        .nav-tabs .nav-link {
            border: 1px solid transparent;
            border-radius: 0.375rem 0.375rem 0 0;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--bs-primary);
            color: white;
            border-color: var(--bs-primary);
        }
        
        .tab-content {
            border: 1px solid #dee2e6;
            border-top: 0;
            border-radius: 0 0 0.375rem 0.375rem;
            padding: 1.5rem;
            background: white;
        }

        .btn-create-user {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            color: white;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .btn-create-user:hover {
            background: linear-gradient(45deg, #218838, #1ea085);
            transform: translateY(-1px);
            color: white;
        }

        .btn-create-user:disabled {
            background: #6c757d;
            color: #ffffff;
            cursor: not-allowed;
        }

        .user-status-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }
    </style>
</head>
<body class="bg-light">

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div>Procesando...</div>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS MODERNOS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Talento Humano</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gestionar Trabajadores
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO MODERNO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-people-fill me-2"></i>
                    Gestionar Trabajadores
                </h1>
                <p class="text-muted">
                    CRUD completo de colaboradores con ubicaci√≥n organizacional
                </p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" onclick="openCreateModal()">
                    <i class="bi bi-person-plus me-1"></i>Nuevo Trabajador
                </button>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>
        <!-- Tarjeta principal con tabla -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>Lista de Trabajadores
                </h5>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" style="width: 150px;" id="statusFilter" onchange="filterByStatus()">
                        <option value="">Todos los estados</option>
                        <option value="active">Activos</option>
                        <option value="inactive">Inactivos</option>
                        <option value="suspended">Suspendidos</option>
                    </select>
                    <div class="input-group input-group-sm" style="width: 300px;">
                        <input type="text" class="form-control" placeholder="Buscar trabajador..." id="searchInput">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchWorkers()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="loadWorkers()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Trabajador</th>
                                <th>Ubicaci√≥n Organizacional</th>
                                <th>Roles Asignados</th>
                                <th>Estado</th>
                                <th>Fecha Ingreso</th>
                                <th style="width: 150px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="workersTableBody">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando trabajadores...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-people text-primary" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="totalWorkers">-</h4>
                        <small class="text-muted">Total Trabajadores</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="activeWorkers">-</h4>
                        <small class="text-muted">Activos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-award text-warning" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="workersWithRoles">-</h4>
                        <small class="text-muted">Con Roles Asignados</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-calendar text-info" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="avgTenure">-</h4>
                        <small class="text-muted">Antig√ºedad Promedio</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para Crear/Editar Trabajador -->
    <div class="modal fade" id="workerModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="bi bi-person-plus me-2"></i>Nuevo Trabajador
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <form id="workerForm">
                    <div class="modal-body">
                        <input type="hidden" id="workerId" name="worker_id">
                        
                        <!-- Pesta√±as de Navegaci√≥n -->
                        <ul class="nav nav-tabs mb-3" id="workerTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" 
                                        data-bs-target="#personal" type="button" role="tab">
                                    <i class="bi bi-person me-2"></i>Informaci√≥n Personal
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="organizational-tab" data-bs-toggle="tab" 
                                        data-bs-target="#organizational" type="button" role="tab">
                                    <i class="bi bi-diagram-3 me-2"></i>Ubicaci√≥n Organizacional
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="roles-tab" data-bs-toggle="tab" 
                                        data-bs-target="#roles" type="button" role="tab">
                                    <i class="bi bi-award me-2"></i>Roles y Cargos
                                    <span class="badge bg-warning ms-1 d-none" id="rolesCount">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="summary-tab" data-bs-toggle="tab" 
                                        data-bs-target="#summary" type="button" role="tab">
                                    <i class="bi bi-check-circle me-2"></i>Resumen
                                </button>
                            </li>
                        </ul>

                        <!-- Contenido de las Pesta√±as -->
                        <div class="tab-content" id="workerTabsContent">

                            <!-- PESTA√ëA 1: INFORMACI√ìN PERSONAL -->
                            <div class="tab-pane fade show active" id="personal" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="workerIdDoc" class="form-label">Documento de Identidad *</label>
                                            <input type="text" class="form-control" id="workerIdDoc" name="worker_id_doc" required>
                                            <div class="form-text">N√∫mero √∫nico de identificaci√≥n</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="workerFirstName" class="form-label">Primer Nombre *</label>
                                            <input type="text" class="form-control" id="workerFirstName" name="worker_first_name" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="workerLastName1" class="form-label">Primer Apellido *</label>
                                            <input type="text" class="form-control" id="workerLastName1" name="worker_last_name_1" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="workerLastName2" class="form-label">Segundo Apellido</label>
                                            <input type="text" class="form-control" id="workerLastName2" name="worker_last_name_2">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="workerEmail" class="form-label">Correo Electr√≥nico *</label>
                                            <input type="text" class="form-control" id="workerEmail" name="email" required>
                                            <div class="form-text">Ser√° usado para autenticaci√≥n si tiene acceso al sistema</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="genderId" class="form-label">G√©nero *</label>
                                            <select class="form-select" id="genderId" name="gender_id" required>
                                                <option value="">Seleccionar...</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="workerBirthday" class="form-label">Fecha de Nacimiento *</label>
                                            <input type="date" class="form-control" id="workerBirthday" name="worker_birthday" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="workerEntryDate" class="form-label">Fecha de Ingreso *</label>
                                            <input type="date" class="form-control" id="workerEntryDate" name="worker_entry_date" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="workerStatus" class="form-label">Estado *</label>
                                            <select class="form-select" id="workerStatus" name="worker_status" required>
                                                <option value="active">Activo</option>
                                                <option value="inactive">Inactivo</option>
                                                <option value="suspended">Suspendido</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="alternativeCalendar" class="form-label">Calendario Alternativo</label>
                                            <input type="text" class="form-control" id="alternativeCalendar" name="alternative_calendar">
                                            <div class="form-text">Ej: Calendario B, Calendario Docente, etc.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PESTA√ëA 2: UBICACI√ìN ORGANIZACIONAL -->
                            <div class="tab-pane fade" id="organizational" role="tabpanel">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    La estructura organizacional define la ubicaci√≥n del trabajador en el organigrama institucional.
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="organizationalDivisionId" class="form-label">Divisi√≥n *</label>
                                            <select class="form-select" id="organizationalDivisionId" 
                                                    name="organizational_division_id" required onchange="loadCostCenters()">
                                                <option value="">Seleccionar Divisi√≥n...</option>
                                            </select>
                                            <div class="form-text">Nivel 1: Divisi√≥n organizacional principal</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="organizationalCostCenterId" class="form-label">Centro de Costo *</label>
                                            <select class="form-select" id="organizationalCostCenterId" 
                                                    name="organizational_cost_center_id" required onchange="loadAreas()" disabled>
                                                <option value="">Primero selecciona una divisi√≥n...</option>
                                            </select>
                                            <div class="form-text">Nivel 2: Centro de costo espec√≠fico</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="organizationalAreaId" class="form-label">√Årea/Secci√≥n</label>
                                            <select class="form-select" id="organizationalAreaId" 
                                                    name="organizational_area_id" onchange="loadSubareas()" disabled>
                                                <option value="">Primero selecciona un centro de costo...</option>
                                            </select>
                                            <div class="form-text">Nivel 3: √Årea operativa (seg√∫n el cargo)</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="organizationalSubareaId" class="form-label">Sub√°rea</label>
                                            <select class="form-select" id="organizationalSubareaId" 
                                                    name="organizational_subarea_id" onchange="updateLevelProgress()" disabled>
                                                <option value="">Primero selecciona un √°rea...</option>
                                            </select>
                                            <div class="form-text">Nivel 4: Sub√°rea especializada (seg√∫n el cargo)</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="sectionId" class="form-label">Secci√≥n Acad√©mica - Solo personal acad√©mico</label>
                                            <select class="form-select" id="sectionId" name="section_id">
                                                <option value="">Seleccionar secci√≥n...</option>
                                            </select>
                                            <div class="form-text">Solo para personal acad√©mico</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6><i class="bi bi-target me-2"></i>Nivel Organizacional Requerido</h6>
                                        <div class="mb-3">
                                            <label for="requiredOrganizationalLevel" class="form-label">Hasta qu√© nivel debe estar ubicado</label>
                                            <select class="form-select" id="requiredOrganizationalLevel" 
                                                    name="required_organizational_level" onchange="updateLevelProgress()">
                                                <option value="2">Nivel 2 - Hasta Centro de Costo</option>
                                                <option value="3">Nivel 3 - Hasta √Årea/Secci√≥n</option>
                                                <option value="4">Nivel 4 - Hasta Sub√°rea</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted">Progreso de ubicaci√≥n:</small>
                                        </div>
                                        <div class="level-progress">
                                            <div class="level-progress-bar" style="width: 0%" id="levelProgressBar"></div>
                                        </div>
                                        <div class="mt-2">
                                            <small id="levelProgressText" class="text-muted">Selecciona la divisi√≥n para comenzar</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- PESTA√ëA 3: ROLES Y CARGOS -->
                            <div class="tab-pane fade" id="roles" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="bi bi-plus-circle me-2"></i>Asignar Nuevo Rol</h6>
                                        <div class="mb-3">
                                            <label for="newRoleSelect" class="form-label">Seleccionar Rol/Cargo</label>
                                            <select class="form-select" id="newRoleSelect">
                                                <option value="">Seleccionar rol...</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="isPrimaryRole">
                                                <label class="form-check-label" for="isPrimaryRole">
                                                    <strong>Es el rol principal del trabajador</strong>
                                                </label>
                                            </div>
                                            <div class="form-text">Solo puede haber un rol principal por trabajador</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="roleNotes" class="form-label">Notas adicionales</label>
                                            <textarea class="form-control" id="roleNotes" rows="2" 
                                                      placeholder="Comentarios sobre la asignaci√≥n del rol..."></textarea>
                                        </div>
                                        <button type="button" class="btn btn-primary" onclick="assignRole()">
                                            <i class="bi bi-plus"></i> Asignar Rol
                                        </button>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6><i class="bi bi-list-ul me-2"></i>Roles Asignados</h6>
                                        <div id="assignedRolesList" style="max-height: 300px; overflow-y: auto;">
                                            <div class="alert alert-info">
                                                <i class="bi bi-info-circle me-2"></i>
                                                No hay roles asignados a√∫n
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PESTA√ëA 4: RESUMEN -->
                            <div class="tab-pane fade" id="summary" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="bi bi-person me-2"></i>Informaci√≥n Personal</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="personalSummary">
                                                    <p class="text-muted">Complete la informaci√≥n personal para ver el resumen</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Ubicaci√≥n Organizacional</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="organizationalSummary">
                                                    <p class="text-muted">Configure la ubicaci√≥n organizacional para ver el resumen</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="bi bi-award me-2"></i>Roles y Cargos</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="rolesSummary">
                                                    <p class="text-muted">Asigne roles para ver el resumen</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="previousTab()" id="prevButton">
                                <i class="bi bi-arrow-left me-1"></i>Anterior
                            </button>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="nextTab()" id="nextButton">
                                Siguiente <i class="bi bi-arrow-right ms-1"></i>
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle me-1"></i>Guardar Trabajador
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Modal de Confirmaci√≥n para Eliminar -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminaci√≥n
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¬øEst√°s seguro de que deseas eliminar al trabajador:</p>
                    <p class="fw-bold" id="deleteWorkerName"></p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <strong>Advertencia:</strong> Esta acci√≥n eliminar√°:
                        <ul class="mb-0 mt-2">
                            <li>Toda la informaci√≥n personal del trabajador</li>
                            <li>Su ubicaci√≥n organizacional</li>
                            <li>Todas las asignaciones de roles</li>
                        </ul>
                    </div>
                    <p class="text-danger">
                        <strong>Esta acci√≥n no se puede deshacer.</strong>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="bi bi-trash me-1"></i>Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let allWorkers = [];
        let currentEditingWorkerId = null;
        let currentDeleteWorkerId = null;
        let tempAssignedRoles = []; // Roles asignados temporalmente en el modal
        let currentTabIndex = 0;
        const tabIds = ['personal', 'organizational', 'roles', 'summary'];
        
        // Datos para dropdowns
        let genders = [];
        let divisions = [];
        let costCenters = [];
        let areas = [];
        let subareas = [];
        let sections = [];
        let jobRoles = [];

        // ==========================================
        // UTILIDAD PARA MANEJO CORRECTO DE FECHAS
        // ==========================================
        
        /**
         * Convierte una fecha del input date a formato YYYY-MM-DD sin afectaci√≥n de timezone
         * @param {string} dateString - Fecha en formato YYYY-MM-DD del input
         * @returns {string} - Fecha en formato YYYY-MM-DD garantizada
         */
        function formatDateForDatabase(dateString) {
            if (!dateString) return null;
            
            // Si ya viene en formato correcto, verificar que no tenga timezone
            if (dateString.includes('T')) {
                return dateString.split('T')[0];
            }
            
            // Para fechas del input type="date", retornar tal cual
            // porque ya est√°n en formato YYYY-MM-DD local
            return dateString;
        }
        
        /**
         * Obtiene la fecha actual en timezone de Colombia (UTC-5) en formato YYYY-MM-DD
         * @returns {string} - Fecha actual en formato YYYY-MM-DD
         */
        function getCurrentDateColombia() {
            // Crear fecha en timezone de Colombia
            const now = new Date();
            const colombiaOffset = -5 * 60; // UTC-5 en minutos
            const localOffset = now.getTimezoneOffset(); // Offset del navegador
            const colombiaTime = new Date(now.getTime() + (localOffset + colombiaOffset) * 60000);
            
            const year = colombiaTime.getFullYear();
            const month = String(colombiaTime.getMonth() + 1).padStart(2, '0');
            const day = String(colombiaTime.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }

        // ==========================================
        // VALIDACI√ìN DE ACCESO Y INICIALIZACI√ìN
        // ==========================================

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Gestionar trabajadores');
                
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                console.log('üë• Gesti√≥n de Trabajadores - Iniciando...');
                
                // Inicializar componentes
                initializeEventListeners();
                await loadInitialData();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });

        function initializeEventListeners() {
            // Formulario principal
            document.getElementById('workerForm').addEventListener('submit', handleFormSubmit);
            
            // B√∫squeda
            document.getElementById('searchInput').addEventListener('input', debounce(searchWorkers, 300));
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchWorkers();
                }
            });
            
            // Tabs
            document.getElementById('workerTabs').addEventListener('shown.bs.tab', function(e) {
                const targetId = e.target.getAttribute('data-bs-target').substring(1);
                currentTabIndex = tabIds.indexOf(targetId);
                updateTabButtons();
                
                if (targetId === 'summary') {
                    updateSummary();
                }
            });
        }

        async function loadInitialData() {
            try {
                showLoading(true);
                
                // Cargar todos los datos necesarios en paralelo
                const [
                    gendersData,
                    divisionsData,
                    sectionsData,
                    jobRolesData
                ] = await Promise.all([
                    supabaseRequest('/genders?select=*&order=gender_name.asc'),
                    supabaseRequest('/organizational_divisions?select=*&division_status=eq.active&order=division_order.asc'),
                    supabaseRequest('/sections?select=*&section_status=eq.active&order=section_name.asc'),
                    supabaseRequest('/job_roles?select=*&role_status=eq.active&order=role_name.asc')
                ]);
                
                // Guardar datos globalmente
                genders = gendersData || [];
                divisions = divisionsData || [];
                sections = sectionsData || [];
                jobRoles = jobRolesData || [];
                
                // Poblar dropdowns est√°ticos
                populateDropdowns();
                
                // Cargar trabajadores
                await loadWorkers();
                
                console.log('‚úÖ Datos iniciales cargados correctamente');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos iniciales:', error);
                showMessage('Error al cargar datos iniciales: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function populateDropdowns() {
            // G√©neros
            const genderSelect = document.getElementById('genderId');
            genderSelect.innerHTML = '<option value="">Seleccionar...</option>' +
                genders.map(g => `<option value="${g.gender_id}">${escapeHtml(g.gender_name)}</option>`).join('');
            
            // Divisiones
            const divisionSelect = document.getElementById('organizationalDivisionId');
            divisionSelect.innerHTML = '<option value="">Seleccionar Divisi√≥n...</option>' +
                divisions.map(d => `<option value="${d.division_id}">${escapeHtml(d.division_name)}</option>`).join('');
            
            // Secciones acad√©micas
            const sectionSelect = document.getElementById('sectionId');
            sectionSelect.innerHTML = '<option value="">Seleccionar secci√≥n...</option>' +
                sections.map(s => `<option value="${s.section_id}">${escapeHtml(s.section_name)}</option>`).join('');
            
            // Roles disponibles
            const roleSelect = document.getElementById('newRoleSelect');
            roleSelect.innerHTML = '<option value="">Seleccionar rol...</option>' +
                jobRoles.map(jr => `<option value="${jr.role_id}">${escapeHtml(jr.role_name)}</option>`).join('');
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        // ==========================================
        // FUNCIONES DE CARGA DE DATOS
        // ==========================================

        async function loadWorkers() {
            try {
                console.log('üì° Cargando trabajadores...');
                showLoading(true);
                
                // Cargar trabajadores con todas las relaciones - CONSULTA EN UNA SOLA L√çNEA
                const workers = await supabaseRequest('/workers?select=*,genders(gender_name),sections(section_name),organizational_divisions(division_name),cost_centers(cost_center_name),organizational_areas(area_name),organizational_subareas(subarea_name)&order=worker_last_name_1.asc,worker_last_name_2.asc,worker_first_name.asc');

                allWorkers = workers || [];
                
                // Cargar roles de cada trabajador
                await loadWorkersRoles();
                
                renderWorkersTable(allWorkers);
                updateStatistics();
                
                console.log(`‚úÖ ${allWorkers.length} trabajadores cargados`);
                
                // Verificar usuarios existentes
                setTimeout(() => checkExistingUsers(), 500);
                
            } catch (error) {
                console.error('‚ùå Error cargando trabajadores:', error);
                showMessage('Error al cargar trabajadores: ' + error.message, 'danger');
                renderWorkersTable([]);
            } finally {
                showLoading(false);
            }
        }

        async function loadWorkersRoles() {
            try {
                if (allWorkers.length === 0) return;
                
                const workerIds = allWorkers.map(w => w.worker_id);
                const workerRoles = await supabaseRequest(`/worker_job_roles?select=*,job_roles(role_name)&worker_id=in.(${workerIds.join(',')})&assignment_status=eq.active&order=is_primary_role.desc,job_roles(role_name).asc`);
                
                // Agrupar roles por trabajador
                const rolesByWorker = {};
                if (workerRoles) {
                    workerRoles.forEach(wr => {
                        if (!rolesByWorker[wr.worker_id]) {
                            rolesByWorker[wr.worker_id] = [];
                        }
                        rolesByWorker[wr.worker_id].push(wr);
                    });
                }
                
                // Asignar roles a cada trabajador
                allWorkers.forEach(worker => {
                    worker.roles = rolesByWorker[worker.worker_id] || [];
                });
                
            } catch (error) {
                console.error('‚ùå Error cargando roles de trabajadores:', error);
            }
        }

        async function loadWorkerRoles(workerId) {
            try {
                const workerRoles = await supabaseRequest(`/worker_job_roles?select=*,job_roles(role_name)&worker_id=eq.${workerId}&assignment_status=eq.active&order=is_primary_role.desc,job_roles(role_name).asc`);
                
                tempAssignedRoles = (workerRoles || []).map(wr => ({
                    job_role_id: wr.job_role_id,
                    role_name: wr.job_roles?.role_name || 'Rol desconocido',
                    is_primary_role: wr.is_primary_role,
                    assigned_date: wr.assigned_date,
                    assignment_status: wr.assignment_status,
                    notes: wr.notes || '',
                    _isExisting: true
                }));
                
            } catch (error) {
                console.error('‚ùå Error cargando roles del trabajador:', error);
                tempAssignedRoles = [];
            }
        }

        // Verificar si workers ya tienen usuarios creados
        async function checkExistingUsers() {
            try {
                if (allWorkers.length === 0) return;
                
                const workerEmails = allWorkers.map(w => w.email);
                const existingUsers = await supabaseRequest(`/users?select=user_mail,user_name,user_status&user_mail=in.(${workerEmails.map(e => `"${e}"`).join(',')})`);
                
                // Crear mapa de usuarios existentes
                const userMap = {};
                if (existingUsers) {
                    existingUsers.forEach(user => {
                        userMap[user.user_mail] = user;
                    });
                }
                
                // Actualizar estado en la tabla y marcar workers con usuario
                allWorkers.forEach(worker => {
                    const user = userMap[worker.email];
                    worker.hasUser = !!user;
                    
                    const statusElement = document.getElementById(`userStatus_${worker.worker_id}`);
                    if (statusElement && user) {
                        statusElement.innerHTML = `<span class="badge user-status-badge bg-info"><i class="bi bi-person-check me-1"></i>Usuario: ${escapeHtml(user.user_name)}</span>`;
                    }
                });
                
                // Re-renderizar tabla para actualizar botones
                renderWorkersTable(allWorkers);
                
            } catch (error) {
                console.error('Error verificando usuarios existentes:', error);
            }
        }
        // ==========================================
        // FUNCIONES DE RENDERIZADO
        // ==========================================

        function renderWorkersTable(workers) {
            const tbody = document.getElementById('workersTableBody');
            
            if (!workers || workers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <div class="mt-2 text-muted">No se encontraron trabajadores</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = workers.map(worker => {
                const fullName = `${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''} ${worker.worker_first_name}`.trim();
                const orgPath = buildOrganizationalPath(worker);
                const rolesHtml = buildRolesHtml(worker.roles || []);
                
                return `
                    <tr>
                        <td>
                            <div>
                                <strong>${escapeHtml(fullName)}</strong>
                            </div>
                            <small class="text-muted">${escapeHtml(worker.worker_id_doc)} ‚Ä¢ ${escapeHtml(worker.email)}</small>
                            <div id="userStatus_${worker.worker_id}"></div>
                        </td>
                        <td>
                            <div class="organizational-path">${orgPath}</div>
                        </td>
                        <td>${rolesHtml}</td>
                        <td>
                            <span class="badge ${getStatusClass(worker.worker_status)}">
                                <i class="bi bi-${getStatusIcon(worker.worker_status)} me-1"></i>
                                ${getStatusText(worker.worker_status)}
                            </span>
                        </td>
                        <td>
                            <small class="text-muted">
                                ${formatDate(worker.worker_entry_date)}
                            </small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" title="Editar" 
                                        onclick="editWorker('${worker.worker_id}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-success" title="Gestionar Roles" 
                                        onclick="manageWorkerRoles('${worker.worker_id}')">
                                    <i class="bi bi-award"></i>
                                </button>
                                ${worker.worker_status === 'active' && (worker.roles && worker.roles.length > 0) ? `
                                    <button class="btn btn-outline-info" 
                                            title="Generar ruta de formaci√≥n" 
                                            onclick="generarRutaFormacion('${worker.worker_id}', '${escapeHtml(fullName).replace(/'/g, "\\'")}')"
                                            data-worker-id="${worker.worker_id}">
                                        <i class="bi bi-diagram-3"></i>
                                    </button>
                                ` : ''}
                                ${worker.worker_status === 'active' ? `
                                    <button class="btn btn-create-user ${worker.hasUser ? 'disabled' : ''}" 
                                            title="${worker.hasUser ? 'Usuario ya creado' : 'Crear como usuario'}" 
                                            onclick="createUserFromWorker('${worker.worker_id}', '${escapeHtml(fullName).replace(/'/g, "\\'")}')"
                                            ${worker.hasUser ? 'disabled' : ''}>
                                        <i class="bi bi-${worker.hasUser ? 'person-check' : 'person-plus'}"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-outline-danger" title="Eliminar" 
                                        onclick="prepareDelete('${worker.worker_id}', '${escapeHtml(fullName)}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function buildOrganizationalPath(worker) {
            const parts = [];
            
            if (worker.organizational_divisions?.division_name) {
                parts.push(escapeHtml(worker.organizational_divisions.division_name));
            }
            if (worker.cost_centers?.cost_center_name) {
                parts.push(escapeHtml(worker.cost_centers.cost_center_name));
            }
            if (worker.organizational_areas?.area_name) {
                parts.push(escapeHtml(worker.organizational_areas.area_name));
            }
            if (worker.organizational_subareas?.subarea_name) {
                parts.push(escapeHtml(worker.organizational_subareas.subarea_name));
            }
            
            return parts.length > 0 ? parts.join(' ‚Üí ') : 'Sin ubicaci√≥n organizacional';
        }

        function buildRolesHtml(roles) {
            if (!roles || roles.length === 0) {
                return '<span class="text-muted"><i class="bi bi-dash-circle me-1"></i>Sin roles</span>';
            }
            
            return roles.map(role => {
                const badgeClass = role.is_primary_role ? 'role-primary' : 'bg-secondary';
                const primaryIcon = role.is_primary_role ? '<i class="bi bi-star-fill me-1"></i>' : '';
                return `<span class="badge ${badgeClass} role-badge">${primaryIcon}${escapeHtml(role.job_roles?.role_name || 'Rol desconocido')}</span>`;
            }).join(' ');
        }

        // ==========================================
        // FUNCIONES DE DROPDOWNS EN CASCADA
        // ==========================================

        async function loadCostCenters() {
            const divisionId = document.getElementById('organizationalDivisionId').value;
            const costCenterSelect = document.getElementById('organizationalCostCenterId');
            const areaSelect = document.getElementById('organizationalAreaId');
            const subareaSelect = document.getElementById('organizationalSubareaId');
            
            // Reset dropdowns dependientes
            costCenterSelect.innerHTML = '<option value="">Cargando centros de costo...</option>';
            costCenterSelect.disabled = true;
            areaSelect.innerHTML = '<option value="">Primero selecciona un centro de costo...</option>';
            areaSelect.disabled = true;
            subareaSelect.innerHTML = '<option value="">Primero selecciona un √°rea...</option>';
            subareaSelect.disabled = true;
            
            if (!divisionId) {
                costCenterSelect.innerHTML = '<option value="">Primero selecciona una divisi√≥n...</option>';
                updateLevelProgress();
                return;
            }
            
            try {
                const centers = await supabaseRequest(`/cost_centers?select=*&division_id=eq.${divisionId}&cost_center_status=eq.active&order=cost_center_order.asc`);
                costCenters = centers || [];
                
                costCenterSelect.innerHTML = '<option value="">Seleccionar centro de costo...</option>' +
                    costCenters.map(cc => `<option value="${cc.cost_center_id}">${escapeHtml(cc.cost_center_name)}</option>`).join('');
                costCenterSelect.disabled = false;
                
                updateLevelProgress();
                
            } catch (error) {
                console.error('‚ùå Error cargando centros de costo:', error);
                costCenterSelect.innerHTML = '<option value="">Error cargando centros de costo</option>';
            }
        }

        async function loadAreas() {
            const costCenterId = document.getElementById('organizationalCostCenterId').value;
            const areaSelect = document.getElementById('organizationalAreaId');
            const subareaSelect = document.getElementById('organizationalSubareaId');
            
            areaSelect.innerHTML = '<option value="">Cargando √°reas...</option>';
            areaSelect.disabled = true;
            subareaSelect.innerHTML = '<option value="">Primero selecciona un √°rea...</option>';
            subareaSelect.disabled = true;
            
            if (!costCenterId) {
                areaSelect.innerHTML = '<option value="">Primero selecciona un centro de costo...</option>';
                updateLevelProgress();
                return;
            }
            
            try {
                const areasData = await supabaseRequest(`/organizational_areas?select=*&cost_center_id=eq.${costCenterId}&area_status=eq.active&order=area_order.asc`);
                areas = areasData || [];
                
                areaSelect.innerHTML = '<option value="">Seleccionar √°rea...</option>' +
                    areas.map(a => `<option value="${a.area_id}">${escapeHtml(a.area_name)}</option>`).join('');
                areaSelect.disabled = false;
                
                updateLevelProgress();
                
            } catch (error) {
                console.error('‚ùå Error cargando √°reas:', error);
                areaSelect.innerHTML = '<option value="">Error cargando √°reas</option>';
            }
        }

        async function loadSubareas() {
            const areaId = document.getElementById('organizationalAreaId').value;
            const subareaSelect = document.getElementById('organizationalSubareaId');
            
            subareaSelect.innerHTML = '<option value="">Cargando sub√°reas...</option>';
            subareaSelect.disabled = true;
            
            if (!areaId) {
                subareaSelect.innerHTML = '<option value="">Primero selecciona un √°rea...</option>';
                updateLevelProgress();
                return;
            }
            
            try {
                const subareasData = await supabaseRequest(`/organizational_subareas?select=*&area_id=eq.${areaId}&subarea_status=eq.active&order=subarea_order.asc`);
                subareas = subareasData || [];
                
                subareaSelect.innerHTML = '<option value="">Seleccionar sub√°rea...</option>' +
                    subareas.map(sa => `<option value="${sa.subarea_id}">${escapeHtml(sa.subarea_name)}</option>`).join('');
                subareaSelect.disabled = false;
                
                updateLevelProgress();
                
            } catch (error) {
                console.error('‚ùå Error cargando sub√°reas:', error);
                subareaSelect.innerHTML = '<option value="">Error cargando sub√°reas</option>';
            }
        }

        function updateLevelProgress() {
            const divisionId = document.getElementById('organizationalDivisionId').value;
            const costCenterId = document.getElementById('organizationalCostCenterId').value;
            const areaId = document.getElementById('organizationalAreaId').value;
            const subareaId = document.getElementById('organizationalSubareaId').value;
            const requiredLevel = parseInt(document.getElementById('requiredOrganizationalLevel').value) || 2;
            
            const progressBar = document.getElementById('levelProgressBar');
            const progressText = document.getElementById('levelProgressText');
            
            let currentLevel = 0;
            let levelText = 'Selecciona la divisi√≥n para comenzar';
            
            if (divisionId) {
                currentLevel = 1;
                levelText = 'Divisi√≥n seleccionada';
            }
            if (costCenterId) {
                currentLevel = 2;
                levelText = 'Centro de costo seleccionado';
            }
            if (areaId) {
                currentLevel = 3;
                levelText = '√Årea/Secci√≥n seleccionada';
            }
            if (subareaId) {
                currentLevel = 4;
                levelText = 'Sub√°rea seleccionada - Ubicaci√≥n completa';
            }
            
            const progress = (currentLevel / 4) * 100;
            progressBar.style.width = progress + '%';
            
            if (currentLevel >= requiredLevel) {
                progressText.innerHTML = `<i class="bi bi-check-circle text-success me-1"></i>${levelText} - Nivel requerido completado`;
                progressText.className = 'text-success';
            } else if (currentLevel > 0) {
                progressText.innerHTML = `<i class="bi bi-arrow-right text-warning me-1"></i>${levelText} - Contin√∫a hasta nivel ${requiredLevel}`;
                progressText.className = 'text-warning';
            } else {
                progressText.innerHTML = levelText;
                progressText.className = 'text-muted';
            }
        }

        // Hacer funciones disponibles globalmente
        window.loadCostCenters = loadCostCenters;
        window.loadAreas = loadAreas;
        window.loadSubareas = loadSubareas;
        window.updateLevelProgress = updateLevelProgress;
        // ==========================================
        // FUNCIONES DE GESTI√ìN DE ROLES
        // ==========================================

        // ‚úÖ C√ìDIGO CORREGIDO
        function assignRole() {
            const roleId = document.getElementById('newRoleSelect').value;
            const isPrimary = document.getElementById('isPrimaryRole').checked;
            const notes = document.getElementById('roleNotes').value.trim();
            
            if (!roleId) {
                showMessage('Selecciona un rol para asignar', 'warning');
                return;
            }
            
            // Verificar que no est√© ya asignado
            if (tempAssignedRoles.some(r => r.job_role_id === roleId)) {
                showMessage('Este rol ya est√° asignado al trabajador', 'warning');
                return;
            }
            
            // Si es rol principal, desmarcar otros
            if (isPrimary) {
                tempAssignedRoles.forEach(r => r.is_primary_role = false);
            }
            
            // Buscar informaci√≥n del rol
            const role = jobRoles.find(jr => jr.role_id === roleId);
            if (!role) {
                showMessage('Error: Rol no encontrado', 'danger');
                return;
            }
            
            // Agregar rol temporal
            const tempRole = {
                job_role_id: roleId,
                role_name: role.role_name,
                is_primary_role: isPrimary,
                assigned_date: getCurrentDateColombia(),  // ‚Üê Corregido
                assignment_status: 'active',
                notes: notes,
                _isNew: true
            };
            
            tempAssignedRoles.push(tempRole);
            
            // Actualizar UI
            renderAssignedRoles();
            updateRolesCount();
            
            // Limpiar formulario
            document.getElementById('newRoleSelect').value = '';
            document.getElementById('isPrimaryRole').checked = false;
            document.getElementById('roleNotes').value = '';
            
            showMessage('Rol asignado temporalmente. Guarda el trabajador para confirmar', 'success');
        }

        function removeRole(roleId) {
            tempAssignedRoles = tempAssignedRoles.filter(r => r.job_role_id !== roleId);
            renderAssignedRoles();
            updateRolesCount();
        }

        function togglePrimaryRole(roleId) {
            tempAssignedRoles.forEach(r => {
                r.is_primary_role = (r.job_role_id === roleId);
            });
            renderAssignedRoles();
        }

        function renderAssignedRoles() {
            const container = document.getElementById('assignedRolesList');
            
            if (tempAssignedRoles.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No hay roles asignados a√∫n
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tempAssignedRoles.map(role => `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold">${escapeHtml(role.role_name)}</span>
                                ${role.is_primary_role ? '<span class="badge bg-warning ms-2">Principal</span>' : ''}
                                ${role._isNew ? '<span class="badge bg-info ms-2">Nuevo</span>' : ''}
                                ${role.notes ? `<br><small class="text-muted">${escapeHtml(role.notes)}</small>` : ''}
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-warning" title="Hacer principal" 
                                        onclick="togglePrimaryRole('${role.job_role_id}')" 
                                        ${role.is_primary_role ? 'disabled' : ''}>
                                    <i class="bi bi-star${role.is_primary_role ? '-fill' : ''}"></i>
                                </button>
                                <button class="btn btn-outline-danger" title="Remover" 
                                        onclick="removeRole('${role.job_role_id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateRolesCount() {
            const badge = document.getElementById('rolesCount');
            const count = tempAssignedRoles.length;
            badge.textContent = count;
            badge.className = count > 0 ? 'badge bg-success ms-1' : 'badge bg-warning ms-1 d-none';
        }

        async function manageWorkerRoles(workerId) {
            await editWorker(workerId);
            
            setTimeout(() => {
                const rolesTab = new bootstrap.Tab(document.querySelector('#roles-tab'));
                rolesTab.show();
            }, 100);
        }

        // Hacer funciones disponibles globalmente
        window.assignRole = assignRole;
        window.removeRole = removeRole;
        window.togglePrimaryRole = togglePrimaryRole;
        window.manageWorkerRoles = manageWorkerRoles;
        // ==========================================
        // FUNCIONES DE NAVEGACI√ìN DE PESTA√ëAS
        // ==========================================

        function nextTab() {
            if (currentTabIndex < tabIds.length - 1) {
                currentTabIndex++;
                const nextTab = new bootstrap.Tab(document.querySelector(`#${tabIds[currentTabIndex]}-tab`));
                nextTab.show();
            }
        }

        function previousTab() {
            if (currentTabIndex > 0) {
                currentTabIndex--;
                const prevTab = new bootstrap.Tab(document.querySelector(`#${tabIds[currentTabIndex]}-tab`));
                prevTab.show();
            }
        }

        function updateTabButtons() {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            
            prevButton.style.display = currentTabIndex === 0 ? 'none' : 'inline-block';
            nextButton.style.display = currentTabIndex === tabIds.length - 1 ? 'none' : 'inline-block';
        }

        function updateSummary() {
            // Resumen informaci√≥n personal
            const personalData = {
                document: document.getElementById('workerIdDoc').value,
                name: `${document.getElementById('workerFirstName').value} ${document.getElementById('workerLastName1').value} ${document.getElementById('workerLastName2').value || ''}`.trim(),
                email: document.getElementById('workerEmail').value,
                birthday: document.getElementById('workerBirthday').value,
                entryDate: document.getElementById('workerEntryDate').value,
                status: document.getElementById('workerStatus').value
            };
            
            const personalSummary = document.getElementById('personalSummary');
            if (personalData.name && personalData.document) {
                personalSummary.innerHTML = `
                    <p><strong>Nombre:</strong> ${escapeHtml(personalData.name)}</p>
                    <p><strong>Documento:</strong> ${escapeHtml(personalData.document)}</p>
                    <p><strong>Email:</strong> ${escapeHtml(personalData.email)}</p>
                    <p><strong>Fecha Nacimiento:</strong> ${formatDate(personalData.birthday)}</p>
                    <p><strong>Fecha Ingreso:</strong> ${formatDate(personalData.entryDate)}</p>
                    <p><strong>Estado:</strong> <span class="badge ${getStatusClass(personalData.status)}">${getStatusText(personalData.status)}</span></p>
                `;
            } else {
                personalSummary.innerHTML = '<p class="text-muted">Complete la informaci√≥n personal para ver el resumen</p>';
            }
            
            // Resumen organizacional
            const orgData = {
                division: document.getElementById('organizationalDivisionId').selectedOptions[0]?.text,
                costCenter: document.getElementById('organizationalCostCenterId').selectedOptions[0]?.text,
                area: document.getElementById('organizationalAreaId').selectedOptions[0]?.text,
                subarea: document.getElementById('organizationalSubareaId').selectedOptions[0]?.text,
                requiredLevel: document.getElementById('requiredOrganizationalLevel').value
            };
            
            const orgSummary = document.getElementById('organizationalSummary');
            const orgPath = [orgData.division, orgData.costCenter, orgData.area, orgData.subarea]
                .filter(x => x && x !== 'Seleccionar...' && !x.includes('Primero')).join(' ‚Üí ');
            
            if (orgPath) {
                orgSummary.innerHTML = `
                    <p><strong>Ubicaci√≥n:</strong> ${escapeHtml(orgPath)}</p>
                    <p><strong>Nivel Requerido:</strong> ${orgData.requiredLevel}</p>
                `;
            } else {
                orgSummary.innerHTML = '<p class="text-muted">Configure la ubicaci√≥n organizacional para ver el resumen</p>';
            }
            
            // Resumen de roles
            const rolesSummary = document.getElementById('rolesSummary');
            if (tempAssignedRoles.length > 0) {
                const primaryRole = tempAssignedRoles.find(r => r.is_primary_role);
                const secondaryRoles = tempAssignedRoles.filter(r => !r.is_primary_role);
                
                rolesSummary.innerHTML = `
                    ${primaryRole ? `<p><strong>Rol Principal:</strong> <span class="badge bg-primary">${escapeHtml(primaryRole.role_name)}</span></p>` : ''}
                    ${secondaryRoles.length > 0 ? `<p><strong>Roles Secundarios:</strong> ${secondaryRoles.map(r => `<span class="badge bg-secondary me-1">${escapeHtml(r.role_name)}</span>`).join('')}</p>` : ''}
                    <p><strong>Total Roles:</strong> ${tempAssignedRoles.length}</p>
                `;
            } else {
                rolesSummary.innerHTML = '<p class="text-muted">Asigne roles para ver el resumen</p>';
            }
        }

        // ==========================================
        // FUNCIONES DE FORMULARIO
        // ==========================================

        function openCreateModal() {
            currentEditingWorkerId = null;
            tempAssignedRoles = [];
            document.getElementById('modalTitle').innerHTML = '<i class="bi bi-person-plus me-2"></i>Nuevo Trabajador';
            document.getElementById('workerForm').reset();
            document.getElementById('workerStatus').value = 'active';
            document.getElementById('requiredOrganizationalLevel').value = '3';
            
            currentTabIndex = 0;
            const firstTab = new bootstrap.Tab(document.querySelector('#personal-tab'));
            firstTab.show();
            
            resetCascadingDropdowns();
            updateTabButtons();
            updateRolesCount();
            renderAssignedRoles();
            updateLevelProgress();
            
            const modal = new bootstrap.Modal(document.getElementById('workerModal'));
            modal.show();
        }

        async function editWorker(workerId) {
            try {
                showLoading(true);
                
                const workers = await supabaseRequest(`/workers?select=*&worker_id=eq.${workerId}`);
                const worker = workers?.[0];
                
                if (!worker) {
                    showMessage('Trabajador no encontrado', 'danger');
                    return;
                }

                currentEditingWorkerId = workerId;
                document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Trabajador';
                
                // Llenar informaci√≥n personal
                document.getElementById('workerId').value = worker.worker_id;
                document.getElementById('workerIdDoc').value = worker.worker_id_doc || '';
                document.getElementById('workerFirstName').value = worker.worker_first_name || '';
                document.getElementById('workerLastName1').value = worker.worker_last_name_1 || '';
                document.getElementById('workerLastName2').value = worker.worker_last_name_2 || '';
                document.getElementById('workerEmail').value = worker.email || '';
                document.getElementById('genderId').value = worker.gender_id || '';
                document.getElementById('workerBirthday').value = worker.worker_birthday || '';
                document.getElementById('workerEntryDate').value = worker.worker_entry_date || '';
                document.getElementById('workerStatus').value = worker.worker_status || 'active';
                document.getElementById('alternativeCalendar').value = worker.alternative_calendar || '';
                
                // Llenar ubicaci√≥n organizacional
                document.getElementById('organizationalDivisionId').value = worker.organizational_division_id || '';
                document.getElementById('sectionId').value = worker.section_id || '';
                document.getElementById('requiredOrganizationalLevel').value = worker.required_organizational_level || 3;
                
                // Cargar dropdowns en cascada
                if (worker.organizational_division_id) {
                    await loadCostCenters();
                    document.getElementById('organizationalCostCenterId').value = worker.organizational_cost_center_id || '';
                    
                    if (worker.organizational_cost_center_id) {
                        await loadAreas();
                        document.getElementById('organizationalAreaId').value = worker.organizational_area_id || '';
                        
                        if (worker.organizational_area_id) {
                            await loadSubareas();
                            document.getElementById('organizationalSubareaId').value = worker.organizational_subarea_id || '';
                        }
                    }
                }
                
                // Cargar roles asignados
                await loadWorkerRoles(workerId);
                
                currentTabIndex = 0;
                const firstTab = new bootstrap.Tab(document.querySelector('#personal-tab'));
                firstTab.show();
                
                updateTabButtons();
                updateRolesCount();
                renderAssignedRoles();
                updateLevelProgress();

                const modal = new bootstrap.Modal(document.getElementById('workerModal'));
                modal.show();

            } catch (error) {
                console.error('‚ùå Error preparando edici√≥n:', error);
                showMessage('Error al preparar edici√≥n: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function resetCascadingDropdowns() {
            document.getElementById('organizationalCostCenterId').innerHTML = '<option value="">Primero selecciona una divisi√≥n...</option>';
            document.getElementById('organizationalCostCenterId').disabled = true;
            document.getElementById('organizationalAreaId').innerHTML = '<option value="">Primero selecciona un centro de costo...</option>';
            document.getElementById('organizationalAreaId').disabled = true;
            document.getElementById('organizationalSubareaId').innerHTML = '<option value="">Primero selecciona un √°rea...</option>';
            document.getElementById('organizationalSubareaId').disabled = true;
        }

        // Hacer funciones disponibles globalmente
        window.openCreateModal = openCreateModal;
        window.editWorker = editWorker;
        window.nextTab = nextTab;
        window.previousTab = previousTab;
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const divisionField = document.getElementById('organizationalDivisionId');
            const costCenterField = document.getElementById('organizationalCostCenterId');
            const areaField = document.getElementById('organizationalAreaId');
            const requiredLevel = parseInt(document.getElementById('requiredOrganizationalLevel').value) || 2;
            
            let hasOrgError = false;
            if (requiredLevel >= 1 && !divisionField.value) hasOrgError = true;
            if (requiredLevel >= 2 && !costCenterField.value) hasOrgError = true;
            if (requiredLevel >= 3 && !areaField.value) hasOrgError = true;
            
            if (hasOrgError) {
                const orgTab = new bootstrap.Tab(document.querySelector('#organizational-tab'));
                orgTab.show();
                setTimeout(() => {
                    if (!divisionField.value) divisionField.focus();
                    else if (!costCenterField.value) costCenterField.focus();
                    else if (!areaField.value) areaField.focus();
                }, 100);
            }
            
            try {
                showLoading(true);
                
                const formData = new FormData(e.target);
                // ‚úÖ C√ìDIGO CORREGIDO
                const workerData = {
                    worker_id_doc: formData.get('worker_id_doc').trim(),
                    worker_first_name: formData.get('worker_first_name').trim(),
                    worker_last_name_1: formData.get('worker_last_name_1').trim(),
                    worker_last_name_2: formData.get('worker_last_name_2')?.trim() || null,
                    email: formData.get('email').trim(),
                    gender_id: formData.get('gender_id') || null,
                    worker_birthday: formatDateForDatabase(formData.get('worker_birthday')),           // ‚Üê Corregido
                    worker_entry_date: formatDateForDatabase(formData.get('worker_entry_date')),       // ‚Üê Corregido
                    worker_status: formData.get('worker_status'),
                    alternative_calendar: formData.get('alternative_calendar')?.trim() || null,
                    section_id: formData.get('section_id') || null,
                    organizational_division_id: formData.get('organizational_division_id') || null,
                    organizational_cost_center_id: formData.get('organizational_cost_center_id') || null,
                    organizational_area_id: formData.get('organizational_area_id') || null,
                    organizational_subarea_id: formData.get('organizational_subarea_id') || null,
                    required_organizational_level: parseInt(formData.get('required_organizational_level')) || 2
                };
        
                // Validaciones
                if (!workerData.worker_id_doc) {
                    showMessage('El documento de identidad es requerido', 'danger');
                    const personalTab = new bootstrap.Tab(document.querySelector('#personal-tab'));
                    personalTab.show();
                    setTimeout(() => document.getElementById('workerIdDoc').focus(), 100);
                    return;
                }
                
                if (!workerData.worker_first_name || !workerData.worker_last_name_1) {
                    showMessage('El nombre y primer apellido son requeridos', 'danger');
                    return;
                }
                
                if (!workerData.email) {
                    showMessage('El correo electr√≥nico es requerido', 'danger');
                    return;
                }
                
                if (requiredLevel >= 1 && !workerData.organizational_division_id) {
                    showMessage('Debe seleccionar una divisi√≥n organizacional', 'danger');
                    return;
                }
                if (requiredLevel >= 2 && !workerData.organizational_cost_center_id) {
                    showMessage('Debe seleccionar un centro de costo', 'danger');
                    return;
                }
                if (requiredLevel >= 3 && !workerData.organizational_area_id) {
                    showMessage('Debe seleccionar un √°rea/secci√≥n organizacional', 'danger');
                    return;
                }
        
                let response;
                if (currentEditingWorkerId) {
                    response = await supabaseRequest(`/workers?worker_id=eq.${currentEditingWorkerId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(workerData)
                    });
                } else {
                    response = await supabaseRequest('/workers', {
                        method: 'POST',
                        body: JSON.stringify(workerData)
                    });
                }
        
                const workerId = currentEditingWorkerId || (response && response[0]?.worker_id);
                
                if (!workerId) {
                    throw new Error('No se pudo obtener el ID del trabajador');
                }
        
                await saveWorkerRoles(workerId);
        
                let successMessage = currentEditingWorkerId ? 
                    'Trabajador actualizado exitosamente' : 
                    'Trabajador creado exitosamente';
        
                let userCreationResult = null;
                if (!currentEditingWorkerId && workerData.worker_status === 'active') {
                    userCreationResult = await attemptAutomaticUserCreation(workerId, workerData);
                    if (userCreationResult.success) {
                        successMessage += `\n\n‚úÖ Usuario del sistema creado autom√°ticamente:\n‚Ä¢ Usuario: ${userCreationResult.userName}\n‚Ä¢ Contrase√±a temporal: TempPass123!`;
                    } else if (userCreationResult.skipped) {
                        successMessage += `\n\n‚ÑπÔ∏è Usuario del sistema NO creado autom√°ticamente (Divisi√≥n: Servicios generales)`;
                    } else if (userCreationResult.error) {
                        successMessage += `\n\n‚ö†Ô∏è Trabajador creado exitosamente, pero no se pudo crear el usuario del sistema:\n${userCreationResult.error}`;
                    }
                }
        
                showMessage(successMessage, 'success');
                bootstrap.Modal.getInstance(document.getElementById('workerModal')).hide();
                await loadWorkers();
        
            } catch (error) {
                console.error('‚ùå Error guardando trabajador:', error);
                let errorMessage = 'Error al guardar el trabajador';
                
                if (error.message.includes('duplicate key')) {
                    if (error.message.includes('worker_id_doc')) {
                        errorMessage = 'Ya existe un trabajador con este documento de identidad';
                    } else if (error.message.includes('email')) {
                        errorMessage = 'Ya existe un trabajador con este correo electr√≥nico';
                    }
                } else if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                
                showMessage(errorMessage, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // ‚úÖ C√ìDIGO CORREGIDO
        async function saveWorkerRoles(workerId) {
            try {
                if (currentEditingWorkerId) {
                    await supabaseRequest(`/worker_job_roles?worker_id=eq.${workerId}`, {
                        method: 'DELETE'
                    });
                }
        
                if (tempAssignedRoles.length > 0) {
                    const roleAssignments = tempAssignedRoles.map(role => ({
                        worker_id: workerId,
                        job_role_id: role.job_role_id,
                        assigned_date: role.assigned_date || getCurrentDateColombia(),  // ‚Üê Corregido
                        is_primary_role: role.is_primary_role,
                        assignment_status: 'active',
                        notes: role.notes || null
                    }));
        
                    await supabaseRequest('/worker_job_roles', {
                        method: 'POST',
                        body: JSON.stringify(roleAssignments)
                    });
                }
        
            } catch (error) {
                console.error('‚ùå Error guardando roles:', error);
                throw new Error('Error al guardar los roles del trabajador');
            }
        }

        // ==========================================
        // CREACI√ìN DE USUARIOS
        // ==========================================


        async function attemptAutomaticUserCreation(workerId, workerData) {
            try {
                if (workerData.organizational_division_id) {
                    const divisionData = await supabaseRequest(`/organizational_divisions?select=division_name&division_id=eq.${workerData.organizational_division_id}`);
                    if (divisionData && divisionData[0]?.division_name === 'Servicios generales') {
                        return { success: false, skipped: true, reason: 'Divisi√≥n Servicios generales' };
                    }
                }
                
                const existingUsers = await supabaseRequest(`/users?select=user_id,user_name&user_mail=eq.${encodeURIComponent(workerData.email)}`);
                if (existingUsers && existingUsers.length > 0) {
                    return { success: false, error: `Ya existe un usuario con el email: ${workerData.email}` };
                }
                
                const userName = await generateUserName(workerData.worker_first_name, workerData.worker_last_name_1);
                
                // CAMBIO 1: Formato Apellido1 Apellido2 Nombres
                const newUser = {
                    user_name: userName,
                    user_display_name: `${workerData.worker_last_name_1} ${workerData.worker_last_name_2 || ''} ${workerData.worker_first_name}`.trim(),
                    user_mail: workerData.email,
                    user_password: 'TempPass123!',
                    auth_provider: 'local',
                    email_verified: true,
                    user_status: 'active'
                };
                
                const createdUser = await supabaseRequest('/users', {
                    method: 'POST',
                    body: JSON.stringify(newUser)
                });
                
                if (!createdUser || createdUser.length === 0) {
                    throw new Error('Error al crear el usuario autom√°ticamente');
                }
                
                const userId = createdUser[0].user_id;
                
                // CAMBIO 2: Asignar rol "Usuario base" autom√°ticamente
                try {
                    const baseRoleData = await supabaseRequest(`/roles?select=role_id&role_name=eq.Usuario base&role_status=eq.active`);
                    
                    if (baseRoleData && baseRoleData.length > 0) {
                        const baseRoleId = baseRoleData[0].role_id;
                        
                        await supabaseRequest('/user_roles', {
                            method: 'POST',
                            body: JSON.stringify({
                                user_id: userId,
                                role_id: baseRoleId
                            })
                        });
                        
                        console.log('‚úÖ Rol "Usuario base" asignado autom√°ticamente');
                    } else {
                        console.warn('‚ö†Ô∏è No se encontr√≥ el rol "Usuario base" activo');
                    }
                } catch (roleError) {
                    console.error('‚ö†Ô∏è Error asignando rol base (usuario creado exitosamente):', roleError);
                    // No lanzar error - el usuario ya fue creado exitosamente
                }
                
                return { success: true, userName: userName, userDisplayName: newUser.user_display_name };
                
            } catch (error) {
                console.error('‚ùå Error en creaci√≥n autom√°tica de usuario:', error);
                let errorMessage = 'Error al crear usuario autom√°ticamente';
                if (error.message.includes('duplicate key')) {
                    if (error.message.includes('user_name')) errorMessage = 'Ya existe un usuario con ese nombre de usuario';
                    else if (error.message.includes('user_mail')) errorMessage = 'Ya existe un usuario con ese correo electr√≥nico';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                return { success: false, error: errorMessage };
            }
        }
        
        async function createUserFromWorker(workerId, workerFullName) {
            try {
                const confirmed = confirm(
                    `¬øCrear usuario del sistema para:\n${workerFullName}?\n\n` +
                    `Se generar√° autom√°ticamente:\n` +
                    `‚Ä¢ Nombre de usuario basado en inicial + apellido\n` +
                    `‚Ä¢ Contrase√±a temporal: TempPass123!\n` +
                    `‚Ä¢ Autenticaci√≥n local (usuario/contrase√±a)\n\n` +
                    `El usuario deber√° cambiar la contrase√±a en su primer acceso.`
                );
                
                if (!confirmed) return;
                
                showLoading(true);
                
                const workers = await supabaseRequest(`/workers?select=*&worker_id=eq.${workerId}`);
                const worker = workers?.[0];
                
                if (!worker) throw new Error('Trabajador no encontrado');
                if (worker.worker_status !== 'active') throw new Error('Solo se pueden crear usuarios para trabajadores activos');
                
                const workerData = {
                    worker_first_name: worker.worker_first_name,
                    worker_last_name_1: worker.worker_last_name_1,
                    worker_last_name_2: worker.worker_last_name_2,
                    email: worker.email,
                    organizational_division_id: worker.organizational_division_id
                };
                
                const result = await attemptAutomaticUserCreation(workerId, workerData);
                
                if (result.success) {
                    showMessage(
                        `Usuario creado exitosamente:\n` +
                        `‚Ä¢ Nombre: ${result.userDisplayName}\n` +
                        `‚Ä¢ Usuario: ${result.userName}\n` +
                        `‚Ä¢ Email: ${worker.email}\n` +
                        `‚Ä¢ Contrase√±a temporal: TempPass123!\n\n` +
                        `IMPORTANTE: El usuario debe cambiar la contrase√±a en su primer acceso.`,
                        'success'
                    );
                } else if (result.skipped) {
                    showMessage('No se puede crear usuario autom√°ticamente para trabajadores de Divisi√≥n "Servicios generales".', 'warning');
                } else {
                    throw new Error(result.error);
                }
                
                await loadWorkers();
                
            } catch (error) {
                console.error('‚ùå Error creando usuario:', error);
                showMessage(error.message || 'Error al crear usuario del sistema', 'danger');
            } finally {
                showLoading(false);
            }
        }

        async function generateUserName(firstName, lastName) {
            const cleanFirstName = firstName.toLowerCase().trim().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const cleanLastName = lastName.toLowerCase().trim().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            let firstInitial = cleanFirstName.charAt(0);
            let secondInitial = '';
            const nameParts = cleanFirstName.split(/\s+/);
            if (nameParts.length > 1 && nameParts[1]) {
                secondInitial = nameParts[1].charAt(0);
            }
            
            const baseUserName = firstInitial + cleanLastName.replace(/\s+/g, '');
            
            const existingUser = await supabaseRequest(`/users?select=user_name&user_name=eq.${encodeURIComponent(baseUserName)}`);
            if (!existingUser || existingUser.length === 0) return baseUserName;
            
            if (secondInitial) {
                const altUserName = firstInitial + secondInitial + cleanLastName.replace(/\s+/g, '');
                const existingAltUser = await supabaseRequest(`/users?select=user_name&user_name=eq.${encodeURIComponent(altUserName)}`);
                if (!existingAltUser || existingAltUser.length === 0) return altUserName;
            }
            
            let counter = 2;
            let finalUserName;
            do {
                finalUserName = baseUserName + counter;
                const existing = await supabaseRequest(`/users?select=user_name&user_name=eq.${encodeURIComponent(finalUserName)}`);
                if (!existing || existing.length === 0) break;
                counter++;
            } while (counter <= 99);
            
            return finalUserName;
        }

        // ==========================================
        // ELIMINACI√ìN
        // ==========================================

        function prepareDelete(workerId, workerName) {
            currentDeleteWorkerId = workerId;
            document.getElementById('deleteWorkerName').textContent = workerName;
            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            modal.show();
        }

        async function confirmDelete() {
            if (!currentDeleteWorkerId) return;
            
            try {
                showLoading(true);
                await supabaseRequest(`/workers?worker_id=eq.${currentDeleteWorkerId}`, { method: 'DELETE' });
                showMessage('Trabajador eliminado exitosamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
                await loadWorkers();
            } catch (error) {
                console.error('‚ùå Error eliminando trabajador:', error);
                let errorMessage = 'Error al eliminar el trabajador';
                if (error.message.includes('foreign key')) {
                    errorMessage = 'No se puede eliminar: el trabajador tiene datos relacionados en otras tablas';
                } else if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                showMessage(errorMessage, 'danger');
            } finally {
                showLoading(false);
                currentDeleteWorkerId = null;
            }
        }

        // ==========================================
        // B√öSQUEDA Y FILTROS
        // ==========================================

        function searchWorkers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filtered = allWorkers;
            
            if (searchTerm) {
                filtered = filtered.filter(worker => {
                    const fullName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.toLowerCase();
                    const document = worker.worker_id_doc.toLowerCase();
                    const email = worker.email.toLowerCase();
                    return fullName.includes(searchTerm) || document.includes(searchTerm) || email.includes(searchTerm);
                });
            }
            
            if (statusFilter) {
                filtered = filtered.filter(worker => worker.worker_status === statusFilter);
            }
            
            renderWorkersTable(filtered);
        }

        function filterByStatus() {
            searchWorkers();
        }

        // ==========================================
        // UTILIDADES
        // ==========================================

        function updateStatistics() {
            const total = allWorkers.length;
            const active = allWorkers.filter(w => w.worker_status === 'active').length;
            const withRoles = allWorkers.filter(w => w.roles && w.roles.length > 0).length;
            
            const now = new Date();
            const tenures = allWorkers
                .filter(w => w.worker_entry_date)
                .map(w => {
                    const entryDate = new Date(w.worker_entry_date);
                    return Math.floor((now - entryDate) / (365.25 * 24 * 60 * 60 * 1000));
                });
            
            const avgTenure = tenures.length > 0 ? Math.round(tenures.reduce((sum, t) => sum + t, 0) / tenures.length) : 0;
            
            document.getElementById('totalWorkers').textContent = total;
            document.getElementById('activeWorkers').textContent = active;
            document.getElementById('workersWithRoles').textContent = withRoles;
            document.getElementById('avgTenure').textContent = avgTenure > 0 ? `${avgTenure} a√±os` : '-';
        }

        function getStatusClass(status) {
            const classes = { 'active': 'bg-success', 'inactive': 'bg-danger', 'suspended': 'bg-warning' };
            return classes[status] || 'bg-secondary';
        }

        function getStatusIcon(status) {
            const icons = { 'active': 'check-circle', 'inactive': 'x-circle', 'suspended': 'pause-circle' };
            return icons[status] || 'question-circle';
        }

        function getStatusText(status) {
            const texts = { 'active': 'Activo', 'inactive': 'Inactivo', 'suspended': 'Suspendido' };
            return texts[status] || status;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Hacer funciones disponibles globalmente
        window.createUserFromWorker = createUserFromWorker;
        window.prepareDelete = prepareDelete;
        window.confirmDelete = confirmDelete;
        window.searchWorkers = searchWorkers;
        window.filterByStatus = filterByStatus;
        window.loadWorkers = loadWorkers;

        // Inicializar p√°gina
        if (window.SUPABASE_CONFIG) {
            initializePage('workers', 'Talento Humano');
        } else {
            setTimeout(() => initializePage('workers', 'Talento Humano'), 100);
        }

        // ==========================================
        // GENERACI√ìN DE RUTA DE FORMACI√ìN INDIVIDUAL
        // ==========================================
        
        async function generarRutaFormacion(workerId, workerName) {
            if (!confirm(`¬øGenerar/actualizar la ruta de formaci√≥n para ${workerName}?\n\nEsto agregar√° las unidades formativas seg√∫n sus roles asignados.`)) {
                return;
            }
            
            try {
                showLoading(true);
                
                console.log(`üìö Generando ruta de formaci√≥n para trabajador: ${workerId}`);
                
                // PASO 1: Obtener roles del trabajador
                const workerRolesData = await supabaseRequest('/worker_job_roles?select=job_role_id&worker_id=eq.' + workerId + '&assignment_status=eq.active');
                
                if (!workerRolesData || workerRolesData.length === 0) {
                    showMessage('Este trabajador no tiene roles asignados. Asigna roles primero.', 'warning');
                    showLoading(false);
                    return;
                }
                
                const roleIds = workerRolesData.map(wr => wr.job_role_id);
                console.log(`üë§ Roles del trabajador (${roleIds.length}):`, roleIds);
                
                // PASO 2: Obtener unidades formativas asociadas a esos roles
                const modulesData = await supabaseRequest('/training_module_roles?select=module_id,is_mandatory&job_role_id=in.(' + roleIds.join(',') + ')');
                
                if (!modulesData || modulesData.length === 0) {
                    showMessage('No hay unidades formativas asociadas a los roles de este trabajador.', 'info');
                    showLoading(false);
                    return;
                }
                
                console.log(`üìö Unidades encontradas: ${modulesData.length}`);
                
                // PASO 3: Eliminar duplicados y determinar obligatoriedad
                // Si una unidad aparece en m√∫ltiples roles, es obligatoria si AL MENOS UNO la requiere como obligatoria
                const uniqueModules = {};
                modulesData.forEach(item => {
                    if (!uniqueModules[item.module_id]) {
                        uniqueModules[item.module_id] = item.is_mandatory;
                    } else {
                        // Si ya existe, mantener como obligatorio si cualquiera lo es
                        uniqueModules[item.module_id] = uniqueModules[item.module_id] || item.is_mandatory;
                    }
                });
                
                console.log(`üìã Unidades √∫nicas: ${Object.keys(uniqueModules).length}`);
                
                // PASO 4: Verificar cu√°les ya existen en la ruta del trabajador
                const existingPathsData = await supabaseRequest('/worker_training_paths?select=module_id,assignment_type&worker_id=eq.' + workerId);
                
                // Solo considerar las que son "Por rol" para no tocar las "Por inter√©s"
                const existingModuleIds = existingPathsData
                    .filter(p => p.assignment_type === 'Por rol')
                    .map(p => p.module_id);
                
                console.log(`‚úÖ Unidades ya en ruta (Por rol): ${existingModuleIds.length}`);
                
                // PASO 5: Preparar inserciones solo de las que NO existen
                const pathsToInsert = [];
                
                // Obtener usuario actual para asignaci√≥n
                const session = getStoredSession();
                const currentUserId = session?.user?.user_id || null;
                
                for (const [moduleId, isMandatory] of Object.entries(uniqueModules)) {
                    if (!existingModuleIds.includes(moduleId)) {
                        // ‚úÖ C√ìDIGO CORREGIDO
                        pathsToInsert.push({
                            worker_id: workerId,
                            module_id: moduleId,
                            assignment_type: 'Por rol',
                            assigned_by: currentUserId,
                            assignment_date: getCurrentDateColombia(),  // ‚Üê Corregido
                            completion_status: 'Pendiente',
                            path_status: 'active'
                        });
                    }
                }
                
                console.log(`‚ûï Unidades nuevas a insertar: ${pathsToInsert.length}`);
                
                // PASO 6: Insertar en batch si hay nuevas unidades
                if (pathsToInsert.length > 0) {
                    await supabaseRequest('/worker_training_paths', {
                        method: 'POST',
                        body: JSON.stringify(pathsToInsert)
                    });
                    
                    showMessage(
                        `‚úÖ Ruta de formaci√≥n generada exitosamente para ${workerName}\n\n` +
                        `‚Ä¢ ${pathsToInsert.length} unidad(es) agregada(s)\n` +
                        `‚Ä¢ ${existingModuleIds.length} unidad(es) ya existente(s)\n` +
                        `‚Ä¢ Total en ruta: ${Object.keys(uniqueModules).length} unidad(es)`,
                        'success'
                    );
                } else {
                    showMessage(
                        `‚ÑπÔ∏è La ruta de formaci√≥n de ${workerName} ya est√° actualizada\n\n` +
                        `‚Ä¢ Todas las unidades requeridas (${Object.keys(uniqueModules).length}) ya est√°n asignadas`,
                        'info'
                    );
                }
                
                console.log(`‚úÖ Proceso completado para ${workerName}`);
                
            } catch (error) {
                console.error('‚ùå Error generando ruta de formaci√≥n:', error);
                showMessage('Error al generar ruta de formaci√≥n: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // ==========================================
        // FIX: Problema con @ en inputs de email
        // ==========================================
        
        // Esperar a que todos los modales est√©n completamente inicializados
        setTimeout(() => {
            // Obtener todos los inputs de email
            const emailInputs = document.querySelectorAll('input[type="email"], input#workerEmail');
            
            emailInputs.forEach(input => {
                // Prevenir propagaci√≥n de eventos que interfieren
                input.addEventListener('keydown', function(e) {
                    e.stopPropagation();
                }, true);
                
                input.addEventListener('keypress', function(e) {
                    e.stopPropagation();
                }, true);
                
                input.addEventListener('keyup', function(e) {
                    e.stopPropagation();
                }, true);
            });
            
            console.log('‚úÖ Fix de email inputs aplicado');
        }, 500);
        
        // Tambi√©n aplicar el fix cuando se abra el modal de trabajador
        document.getElementById('workerModal').addEventListener('shown.bs.modal', function() {
            const emailInput = document.getElementById('workerEmail');
            if (emailInput) {
                emailInput.addEventListener('keydown', function(e) {
                    e.stopImmediatePropagation();
                }, true);
                
                emailInput.addEventListener('keypress', function(e) {
                    e.stopImmediatePropagation();
                }, true);
                
                emailInput.addEventListener('keyup', function(e) {
                    e.stopImmediatePropagation();
                }, true);
            }
        });

        
        // Hacer funci√≥n disponible globalmente
        window.generarRutaFormacion = generarRutaFormacion;
    </script>
</body>
</html>
