<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Trabajadores - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <!-- Nuestros estilos principales -->
    <link href="../../assets/css/main.css" rel="stylesheet">
    
    <style>
        .card-header {
            background-color: var(--bs-light);
            border-bottom: 1px solid var(--border-color);
        }
        
        .table th {
            background-color: var(--bs-light);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }
        
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .status-active { color: var(--success-color); }
        .status-inactive { color: var(--danger-color); }
        .status-suspended { color: var(--warning-color); }
        
        .role-badge {
            font-size: 0.75rem;
            margin: 0.1rem;
        }
        
        .role-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: 1px solid #0056b3;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .organizational-path {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-style: italic;
        }
        
        .level-progress {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .level-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 50%, #17a2b8 100%);
            transition: width 0.3s ease;
        }
        
        .nav-tabs .nav-link {
            border: 1px solid transparent;
            border-radius: 0.375rem 0.375rem 0 0;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--bs-primary);
            color: white;
            border-color: var(--bs-primary);
        }
        
        .tab-content {
            border: 1px solid #dee2e6;
            border-top: 0;
            border-radius: 0 0 0.375rem 0.375rem;
            padding: 1.5rem;
            background: white;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div>Procesando...</div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="main-container">
            <nav class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">SchoolNet</h4>
                    <span class="text-muted">Gestionar Trabajadores</span>
                </div>
                <div>
                    <a href="index.html" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left me-1"></i>Talento Humano
                    </a>
                    <a href="../../dashboard.html" class="btn btn-outline-secondary">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </div>
            </nav>
        </div>
    </div>

    <div class="main-container">
        <!-- T√≠tulo de la p√°gina -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="bi bi-people-fill me-2"></i>Gestionar Trabajadores</h2>
                <p class="text-muted mb-0">CRUD completo de colaboradores con ubicaci√≥n organizacional</p>
            </div>
            <button class="btn btn-primary" onclick="openCreateModal()">
                <i class="bi bi-person-plus me-1"></i>Nuevo Trabajador
            </button>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Tarjeta principal con tabla -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>Lista de Trabajadores
                </h5>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" style="width: 150px;" id="statusFilter" onchange="filterByStatus()">
                        <option value="">Todos los estados</option>
                        <option value="active">Activos</option>
                        <option value="inactive">Inactivos</option>
                        <option value="suspended">Suspendidos</option>
                    </select>
                    <div class="input-group input-group-sm" style="width: 300px;">
                        <input type="text" class="form-control" placeholder="Buscar trabajador..." id="searchInput">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchWorkers()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="loadWorkers()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Trabajador</th>
                                <th>Ubicaci√≥n Organizacional</th>
                                <th>Roles Asignados</th>
                                <th>Estado</th>
                                <th>Fecha Ingreso</th>
                                <th style="width: 150px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="workersTableBody">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando trabajadores...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-people text-primary" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="totalWorkers">-</h4>
                        <small class="text-muted">Total Trabajadores</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="activeWorkers">-</h4>
                        <small class="text-muted">Activos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-award text-warning" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="workersWithRoles">-</h4>
                        <small class="text-muted">Con Roles Asignados</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-calendar text-info" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="avgTenure">-</h4>
                        <small class="text-muted">Antig√ºedad Promedio</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Crear/Editar Trabajador -->
    <div class="modal fade" id="workerModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="bi bi-person-plus me-2"></i>Nuevo Trabajador
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <form id="workerForm">
                    <div class="modal-body">
                        <input type="hidden" id="workerId" name="worker_id">
                        
                        <!-- Pesta√±as de Navegaci√≥n -->
                        <ul class="nav nav-tabs mb-3" id="workerTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" 
                                        data-bs-target="#personal" type="button" role="tab">
                                    <i class="bi bi-person me-2"></i>Informaci√≥n Personal
                                    <span class="badge bg-danger ms-1 d-none" id="personalErrors">!</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="organizational-tab" data-bs-toggle="tab" 
                                        data-bs-target="#organizational" type="button" role="tab">
                                    <i class="bi bi-diagram-3 me-2"></i>Ubicaci√≥n Organizacional
                                    <span class="badge bg-danger ms-1 d-none" id="organizationalErrors">!</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="roles-tab" data-bs-toggle="tab" 
                                        data-bs-target="#roles" type="button" role="tab">
                                    <i class="bi bi-award me-2"></i>Roles y Cargos
                                    <span class="badge bg-warning ms-1 d-none" id="rolesCount">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="summary-tab" data-bs-toggle="tab" 
                                        data-bs-target="#summary" type="button" role="tab">
                                    <i class="bi bi-check-circle me-2"></i>Resumen
                                </button>
                            </li>
                        </ul>

                        <!-- Contenido de las Pesta√±as -->
                        <div class="tab-content" id="workerTabsContent">
                            
                            <!-- PESTA√ëA 1: INFORMACI√ìN PERSONAL -->
                            <div class="tab-pane fade show active" id="personal" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <!-- Documento de identidad -->
                                        <div class="mb-3">
                                            <label for="workerIdDoc" class="form-label">Documento de Identidad *</label>
                                            <input type="text" class="form-control" id="workerIdDoc" name="worker_id_doc" required>
                                            <div class="form-text">N√∫mero √∫nico de identificaci√≥n</div>
                                        </div>
                                        
                                        <!-- Primer nombre -->
                                        <div class="mb-3">
                                            <label for="workerFirstName" class="form-label">Primer Nombre *</label>
                                            <input type="text" class="form-control" id="workerFirstName" name="worker_first_name" required>
                                        </div>
                                        
                                        <!-- Primer apellido -->
                                        <div class="mb-3">
                                            <label for="workerLastName1" class="form-label">Primer Apellido *</label>
                                            <input type="text" class="form-control" id="workerLastName1" name="worker_last_name_1" required>
                                        </div>
                                        
                                        <!-- Segundo apellido -->
                                        <div class="mb-3">
                                            <label for="workerLastName2" class="form-label">Segundo Apellido</label>
                                            <input type="text" class="form-control" id="workerLastName2" name="worker_last_name_2">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <!-- Email -->
                                        <div class="mb-3">
                                            <label for="workerEmail" class="form-label">Correo Electr√≥nico *</label>
                                            <input type="email" class="form-control" id="workerEmail" name="email" required>
                                            <div class="form-text">Ser√° usado para autenticaci√≥n si tiene acceso al sistema</div>
                                        </div>
                                        
                                        <!-- G√©nero -->
                                        <div class="mb-3">
                                            <label for="genderId" class="form-label">G√©nero *</label>
                                            <select class="form-select" id="genderId" name="gender_id" required>
                                                <option value="">Seleccionar...</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Fecha de nacimiento -->
                                        <div class="mb-3">
                                            <label for="workerBirthday" class="form-label">Fecha de Nacimiento *</label>
                                            <input type="date" class="form-control" id="workerBirthday" name="worker_birthday" required>
                                        </div>
                                        
                                        <!-- Fecha de ingreso -->
                                        <div class="mb-3">
                                            <label for="workerEntryDate" class="form-label">Fecha de Ingreso *</label>
                                            <input type="date" class="form-control" id="workerEntryDate" name="worker_entry_date" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <!-- Estado -->
                                        <div class="mb-3">
                                            <label for="workerStatus" class="form-label">Estado *</label>
                                            <select class="form-select" id="workerStatus" name="worker_status" required>
                                                <option value="active">Activo</option>
                                                <option value="inactive">Inactivo</option>
                                                <option value="suspended">Suspendido</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <!-- Calendario alternativo -->
                                        <div class="mb-3">
                                            <label for="alternativeCalendar" class="form-label">Calendario Alternativo</label>
                                            <input type="text" class="form-control" id="alternativeCalendar" name="alternative_calendar">
                                            <div class="form-text">Ej: Calendario B, Calendario Docente, etc.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PESTA√ëA 2: UBICACI√ìN ORGANIZACIONAL -->
                            <div class="tab-pane fade" id="organizational" role="tabpanel">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    La estructura organizacional define la ubicaci√≥n del trabajador en el organigrama institucional.
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <!-- Divisi√≥n (Nivel 1) -->
                                        <div class="mb-3">
                                            <label for="organizationalDivisionId" class="form-label">Divisi√≥n *</label>
                                            <select class="form-select" id="organizationalDivisionId" 
                                                    name="organizational_division_id" required onchange="loadCostCenters()">
                                                <option value="">Seleccionar Divisi√≥n...</option>
                                            </select>
                                            <div class="form-text">Nivel 1: Divisi√≥n organizacional principal</div>
                                        </div>
                                        
                                        <!-- Centro de Costo (Nivel 2) -->
                                        <div class="mb-3">
                                            <label for="organizationalCostCenterId" class="form-label">Centro de Costo *</label>
                                            <select class="form-select" id="organizationalCostCenterId" 
                                                    name="organizational_cost_center_id" required onchange="loadAreas()" disabled>
                                                <option value="">Primero selecciona una divisi√≥n...</option>
                                            </select>
                                            <div class="form-text">Nivel 2: Centro de costo espec√≠fico</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <!-- √Årea/Secci√≥n (Nivel 3) -->
                                        <div class="mb-3">
                                            <label for="organizationalAreaId" class="form-label">√Årea/Secci√≥n</label>
                                            <select class="form-select" id="organizationalAreaId" 
                                                    name="organizational_area_id" onchange="loadSubareas()" disabled>
                                                <option value="">Primero selecciona un centro de costo...</option>
                                            </select>
                                            <div class="form-text">Nivel 3: √Årea operativa (seg√∫n el cargo)</div>
                                        </div>
                                        
                                        <!-- Sub√°rea (Nivel 4) -->
                                        <div class="mb-3">
                                            <label for="organizationalSubareaId" class="form-label">Sub√°rea</label>
                                            <select class="form-select" id="organizationalSubareaId" 
                                                    name="organizational_subarea_id" onchange="updateLevelProgress()" disabled>
                                                <option value="">Primero selecciona un √°rea...</option>
                                            </select>
                                            <div class="form-text">Nivel 4: Sub√°rea especializada (seg√∫n el cargo)</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Secciones acad√©micas y √°reas de gesti√≥n -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <!-- Secci√≥n acad√©mica -->
                                        <div class="mb-3">
                                            <label for="sectionId" class="form-label">Secci√≥n Acad√©mica</label>
                                            <select class="form-select" id="sectionId" name="section_id">
                                                <option value="">Seleccionar secci√≥n...</option>
                                            </select>
                                            <div class="form-text">Solo para personal acad√©mico</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <!-- √Årea de gesti√≥n -->
                                        <div class="mb-3">
                                            <label for="managementAreaId" class="form-label">√Årea de Gesti√≥n</label>
                                            <select class="form-select" id="managementAreaId" name="management_area_id">
                                                <option value="">Seleccionar √°rea...</option>
                                            </select>
                                            <div class="form-text">Solo para personal administrativo</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Indicador visual del nivel requerido -->
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6><i class="bi bi-target me-2"></i>Nivel Organizacional Requerido</h6>
                                        <div class="mb-3">
                                            <label for="requiredOrganizationalLevel" class="form-label">Hasta qu√© nivel debe estar ubicado</label>
                                            <select class="form-select" id="requiredOrganizationalLevel" 
                                                    name="required_organizational_level" onchange="updateLevelProgress()">
                                                <option value="2">Nivel 2 - Hasta Centro de Costo</option>
                                                <option value="3">Nivel 3 - Hasta √Årea/Secci√≥n</option>
                                                <option value="4">Nivel 4 - Hasta Sub√°rea</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted">Progreso de ubicaci√≥n:</small>
                                        </div>
                                        <div class="level-progress">
                                            <div class="level-progress-bar" style="width: 0%" id="levelProgressBar"></div>
                                        </div>
                                        <div class="mt-2">
                                            <small id="levelProgressText" class="text-muted">Selecciona la divisi√≥n para comenzar</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PESTA√ëA 3: ROLES Y CARGOS -->
                            <div class="tab-pane fade" id="roles" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="bi bi-plus-circle me-2"></i>Asignar Nuevo Rol</h6>
                                        <div class="mb-3">
                                            <label for="newRoleSelect" class="form-label">Seleccionar Rol/Cargo</label>
                                            <select class="form-select" id="newRoleSelect">
                                                <option value="">Seleccionar rol...</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="isPrimaryRole">
                                                <label class="form-check-label" for="isPrimaryRole">
                                                    <strong>Es el rol principal del trabajador</strong>
                                                </label>
                                            </div>
                                            <div class="form-text">Solo puede haber un rol principal por trabajador</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="roleNotes" class="form-label">Notas adicionales</label>
                                            <textarea class="form-control" id="roleNotes" rows="2" 
                                                      placeholder="Comentarios sobre la asignaci√≥n del rol..."></textarea>
                                        </div>
                                        <button type="button" class="btn btn-primary" onclick="assignRole()">
                                            <i class="bi bi-plus"></i> Asignar Rol
                                        </button>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6><i class="bi bi-list-ul me-2"></i>Roles Asignados</h6>
                                        <div id="assignedRolesList" style="max-height: 300px; overflow-y: auto;">
                                            <div class="alert alert-info">
                                                <i class="bi bi-info-circle me-2"></i>
                                                No hay roles asignados a√∫n
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PESTA√ëA 4: RESUMEN -->
                            <div class="tab-pane fade" id="summary" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="bi bi-person me-2"></i>Informaci√≥n Personal</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="personalSummary">
                                                    <p class="text-muted">Complete la informaci√≥n personal para ver el resumen</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Ubicaci√≥n Organizacional</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="organizationalSummary">
                                                    <p class="text-muted">Configure la ubicaci√≥n organizacional para ver el resumen</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="bi bi-award me-2"></i>Roles y Cargos</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="rolesSummary">
                                                    <p class="text-muted">Asigne roles para ver el resumen</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="previousTab()" id="prevButton">
                                <i class="bi bi-arrow-left me-1"></i>Anterior
                            </button>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="nextTab()" id="nextButton">
                                Siguiente <i class="bi bi-arrow-right ms-1"></i>
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle me-1"></i>Guardar Trabajador
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Eliminar -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminaci√≥n
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¬øEst√°s seguro de que deseas eliminar al trabajador:</p>
                    <p class="fw-bold" id="deleteWorkerName"></p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <strong>Advertencia:</strong> Esta acci√≥n eliminar√°:
                        <ul class="mb-0 mt-2">
                            <li>Toda la informaci√≥n personal del trabajador</li>
                            <li>Su ubicaci√≥n organizacional</li>
                            <li>Todas las asignaciones de roles</li>
                        </ul>
                    </div>
                    <p class="text-danger">
                        <strong>Esta acci√≥n no se puede deshacer.</strong>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="bi bi-trash me-1"></i>Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer del sistema -->
    <div class="system-footer">
        <div class="main-container">
            <p class="mb-0">SchoolNet - Gesti√≥n de Trabajadores v1.0</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let allWorkers = [];
        let currentEditingWorkerId = null;
        let currentDeleteWorkerId = null;
        let tempAssignedRoles = []; // Roles asignados temporalmente en el modal
        let currentTabIndex = 0;
        const tabIds = ['personal', 'organizational', 'roles', 'summary'];
        
        // Datos para dropdowns
        let genders = [];
        let divisions = [];
        let costCenters = [];
        let areas = [];
        let subareas = [];
        let sections = [];
        let managementAreas = [];
        let jobRoles = [];

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üë• Gesti√≥n de Trabajadores - Iniciando...');
            
            // Verificar dependencias
            console.log('‚úÖ SUPABASE_CONFIG disponible:', typeof SUPABASE_CONFIG);
            console.log('‚úÖ supabaseRequest disponible:', typeof supabaseRequest);
            console.log('‚úÖ showMessage disponible:', typeof showMessage);
            
            // Configurar t√≠tulo
            document.title = 'Gestionar Trabajadores - SchoolNet';
            
            // Inicializar componentes
            initializeEventListeners();
            loadInitialData();
        });

        function initializeEventListeners() {
            // Formulario principal
            document.getElementById('workerForm').addEventListener('submit', handleFormSubmit);
            
            // B√∫squeda
            document.getElementById('searchInput').addEventListener('input', debounce(searchWorkers, 300));
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchWorkers();
                }
            });
            
            // Tabs
            document.getElementById('workerTabs').addEventListener('shown.bs.tab', function(e) {
                const targetId = e.target.getAttribute('data-bs-target').substring(1);
                currentTabIndex = tabIds.indexOf(targetId);
                updateTabButtons();
                
                if (targetId === 'summary') {
                    updateSummary();
                }
            });
        }

        async function loadInitialData() {
            try {
                showLoading(true);
                
                // Cargar todos los datos necesarios en paralelo
                const [
                    gendersData,
                    divisionsData,
                    sectionsData,
                    managementAreasData,
                    jobRolesData
                ] = await Promise.all([
                    supabaseRequest('/genders?select=*&order=gender_name.asc'),
                    supabaseRequest('/organizational_divisions?select=*&division_status=eq.active&order=division_order.asc'),
                    supabaseRequest('/sections?select=*&section_status=eq.active&order=section_name.asc'),
                    supabaseRequest('/management_areas?select=*&area_status=eq.active&order=area_name.asc'),
                    supabaseRequest('/job_roles?select=*&role_status=eq.active&order=role_name.asc')
                ]);
                
                // Guardar datos globalmente
                genders = gendersData || [];
                divisions = divisionsData || [];
                sections = sectionsData || [];
                managementAreas = managementAreasData || [];
                jobRoles = jobRolesData || [];
                
                // Poblar dropdowns est√°ticos
                populateDropdowns();
                
                // Cargar trabajadores
                await loadWorkers();
                
                console.log('‚úÖ Datos iniciales cargados correctamente');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos iniciales:', error);
                showMessage('Error al cargar datos iniciales: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function populateDropdowns() {
            // G√©neros
            const genderSelect = document.getElementById('genderId');
            genderSelect.innerHTML = '<option value="">Seleccionar...</option>' +
                genders.map(g => `<option value="${g.gender_id}">${g.gender_name}</option>`).join('');
            
            // Divisiones
            const divisionSelect = document.getElementById('organizationalDivisionId');
            divisionSelect.innerHTML = '<option value="">Seleccionar Divisi√≥n...</option>' +
                divisions.map(d => `<option value="${d.division_id}">${d.division_name}</option>`).join('');
            
            // Secciones acad√©micas
            const sectionSelect = document.getElementById('sectionId');
            sectionSelect.innerHTML = '<option value="">Seleccionar secci√≥n...</option>' +
                sections.map(s => `<option value="${s.section_id}">${s.section_name}</option>`).join('');
            
            // √Åreas de gesti√≥n
            const managementAreaSelect = document.getElementById('managementAreaId');
            managementAreaSelect.innerHTML = '<option value="">Seleccionar √°rea...</option>' +
                managementAreas.map(ma => `<option value="${ma.area_id}">${ma.area_name}</option>`).join('');
            
            // Roles disponibles
            const roleSelect = document.getElementById('newRoleSelect');
            roleSelect.innerHTML = '<option value="">Seleccionar rol...</option>' +
                jobRoles.map(jr => `<option value="${jr.role_id}">${jr.role_name}</option>`).join('');
        }

        // ==========================================
        // FUNCIONES DE CARGA DE DATOS
        // ==========================================

        async function loadWorkers() {
            try {
                console.log('üì° Cargando trabajadores...');
                showLoading(true);
                
                // Cargar trabajadores con todas las relaciones
                const workers = await supabaseRequest(`
                    /workers?select=*,
                    genders(gender_name),
                    sections(section_name),
                    management_areas(area_name),
                    organizational_divisions(division_name),
                    cost_centers(cost_center_name),
                    organizational_areas(area_name),
                    organizational_subareas(subarea_name)
                    &order=worker_first_name.asc
                `);
                
                allWorkers = workers || [];
                
                // Cargar roles de cada trabajador
                await loadWorkersRoles();
                
                renderWorkersTable(allWorkers);
                updateStatistics();
                
                console.log(`‚úÖ ${allWorkers.length} trabajadores cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando trabajadores:', error);
                showMessage('Error al cargar trabajadores: ' + error.message, 'danger');
                renderWorkersTable([]);
            } finally {
                showLoading(false);
            }
        }

        async function loadWorkersRoles() {
            try {
                if (allWorkers.length === 0) return;
                
                const workerIds = allWorkers.map(w => w.worker_id);
                const workerRoles = await supabaseRequest(`
                    /worker_job_roles?select=*,
                    job_roles(role_name)
                    &worker_id=in.(${workerIds.join(',')})
                    &assignment_status=eq.active
                    &order=is_primary_role.desc,job_roles(role_name).asc
                `);
                
                // Agrupar roles por trabajador
                const rolesByWorker = {};
                if (workerRoles) {
                    workerRoles.forEach(wr => {
                        if (!rolesByWorker[wr.worker_id]) {
                            rolesByWorker[wr.worker_id] = [];
                        }
                        rolesByWorker[wr.worker_id].push(wr);
                    });
                }
                
                // Asignar roles a cada trabajador
                allWorkers.forEach(worker => {
                    worker.roles = rolesByWorker[worker.worker_id] || [];
                });
                
            } catch (error) {
                console.error('‚ùå Error cargando roles de trabajadores:', error);
            }
        }

        function renderWorkersTable(workers) {
            const tbody = document.getElementById('workersTableBody');
            
            if (!workers || workers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <div class="mt-2 text-muted">No se encontraron trabajadores</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = workers.map(worker => {
                const fullName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
                const orgPath = buildOrganizationalPath(worker);
                const rolesHtml = buildRolesHtml(worker.roles || []);
                
                return `
                    <tr>
                        <td>
                            <div>
                                <strong>${fullName}</strong>
                            </div>
                            <small class="text-muted">${worker.worker_id_doc} ‚Ä¢ ${worker.email}</small>
                        </td>
                        <td>
                            <div class="organizational-path">${orgPath}</div>
                        </td>
                        <td>${rolesHtml}</td>
                        <td>
                            <span class="badge ${getStatusClass(worker.worker_status)}">
                                <i class="bi bi-${getStatusIcon(worker.worker_status)} me-1"></i>
                                ${getStatusText(worker.worker_status)}
                            </span>
                        </td>
                        <td>
                            <small class="text-muted">
                                ${formatDate(worker.worker_entry_date)}
                            </small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" title="Editar" 
                                        onclick="editWorker('${worker.worker_id}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-success" title="Gestionar Roles" 
                                        onclick="manageWorkerRoles('${worker.worker_id}')">
                                    <i class="bi bi-award"></i>
                                </button>
                                <button class="btn btn-outline-danger" title="Eliminar" 
                                        onclick="prepareDelete('${worker.worker_id}', '${fullName}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function buildOrganizationalPath(worker) {
            const parts = [];
            
            if (worker.organizational_divisions?.division_name) {
                parts.push(worker.organizational_divisions.division_name);
            }
            if (worker.cost_centers?.cost_center_name) {
                parts.push(worker.cost_centers.cost_center_name);
            }
            if (worker.organizational_areas?.area_name) {
                parts.push(worker.organizational_areas.area_name);
            }
            if (worker.organizational_subareas?.subarea_name) {
                parts.push(worker.organizational_subareas.subarea_name);
            }
            
            return parts.length > 0 ? parts.join(' ‚Üí ') : 'Sin ubicaci√≥n organizacional';
        }

        function buildRolesHtml(roles) {
            if (!roles || roles.length === 0) {
                return '<span class="text-muted"><i class="bi bi-dash-circle me-1"></i>Sin roles</span>';
            }
            
            return roles.map(role => {
                const badgeClass = role.is_primary_role ? 'role-primary' : 'bg-secondary';
                const primaryIcon = role.is_primary_role ? '<i class="bi bi-star-fill me-1"></i>' : '';
                return `<span class="badge ${badgeClass} role-badge">${primaryIcon}${role.job_roles?.role_name || 'Rol desconocido'}</span>`;
            }).join(' ');
        }

        // ==========================================
        // FUNCIONES DE DROPDOWNS EN CASCADA
        // ==========================================

        async function loadCostCenters() {
            const divisionId = document.getElementById('organizationalDivisionId').value;
            const costCenterSelect = document.getElementById('organizationalCostCenterId');
            const areaSelect = document.getElementById('organizationalAreaId');
            const subareaSelect = document.getElementById('organizationalSubareaId');
            
            // Reset dropdowns dependientes
            costCenterSelect.innerHTML = '<option value="">Cargando centros de costo...</option>';
            costCenterSelect.disabled = true;
            areaSelect.innerHTML = '<option value="">Primero selecciona un centro de costo...</option>';
            areaSelect.disabled = true;
            subareaSelect.innerHTML = '<option value="">Primero selecciona un √°rea...</option>';
            subareaSelect.disabled = true;
            
            if (!divisionId) {
                costCenterSelect.innerHTML = '<option value="">Primero selecciona una divisi√≥n...</option>';
                updateLevelProgress();
                return;
            }
            
            try {
                const centers = await supabaseRequest(`/cost_centers?select=*&division_id=eq.${divisionId}&cost_center_status=eq.active&order=cost_center_order.asc`);
                costCenters = centers || [];
                
                costCenterSelect.innerHTML = '<option value="">Seleccionar centro de costo...</option>' +
                    costCenters.map(cc => `<option value="${cc.cost_center_id}">${cc.cost_center_name}</option>`).join('');
                costCenterSelect.disabled = false;
                
                updateLevelProgress();
                
            } catch (error) {
                console.error('‚ùå Error cargando centros de costo:', error);
                costCenterSelect.innerHTML = '<option value="">Error cargando centros de costo</option>';
            }
        }

        async function loadAreas() {
            const costCenterId = document.getElementById('organizationalCostCenterId').value;
            const areaSelect = document.getElementById('organizationalAreaId');
            const subareaSelect = document.getElementById('organizationalSubareaId');
            
            // Reset dropdowns dependientes
            areaSelect.innerHTML = '<option value="">Cargando √°reas...</option>';
            areaSelect.disabled = true;
            subareaSelect.innerHTML = '<option value="">Primero selecciona un √°rea...</option>';
            subareaSelect.disabled = true;
            
            if (!costCenterId) {
                areaSelect.innerHTML = '<option value="">Primero selecciona un centro de costo...</option>';
                updateLevelProgress();
                return;
            }
            
            try {
                const areasData = await supabaseRequest(`/organizational_areas?select=*&cost_center_id=eq.${costCenterId}&area_status=eq.active&order=area_order.asc`);
                areas = areasData || [];
                
                areaSelect.innerHTML = '<option value="">Seleccionar √°rea...</option>' +
                    areas.map(a => `<option value="${a.area_id}">${a.area_name}</option>`).join('');
                areaSelect.disabled = false;
                
                updateLevelProgress();
                
            } catch (error) {
                console.error('‚ùå Error cargando √°reas:', error);
                areaSelect.innerHTML = '<option value="">Error cargando √°reas</option>';
            }
        }

        async function loadSubareas() {
            const areaId = document.getElementById('organizationalAreaId').value;
            const subareaSelect = document.getElementById('organizationalSubareaId');
            
            // Reset dropdown
            subareaSelect.innerHTML = '<option value="">Cargando sub√°reas...</option>';
            subareaSelect.disabled = true;
            
            if (!areaId) {
                subareaSelect.innerHTML = '<option value="">Primero selecciona un √°rea...</option>';
                updateLevelProgress();
                return;
            }
            
            try {
                const subareasData = await supabaseRequest(`/organizational_subareas?select=*&area_id=eq.${areaId}&subarea_status=eq.active&order=subarea_order.asc`);
                subareas = subareasData || [];
                
                subareaSelect.innerHTML = '<option value="">Seleccionar sub√°rea...</option>' +
                    subareas.map(sa => `<option value="${sa.subarea_id}">${sa.subarea_name}</option>`).join('');
                subareaSelect.disabled = false;
                
                updateLevelProgress();
                
            } catch (error) {
                console.error('‚ùå Error cargando sub√°reas:', error);
                subareaSelect.innerHTML = '<option value="">Error cargando sub√°reas</option>';
            }
        }

        function updateLevelProgress() {
            const divisionId = document.getElementById('organizationalDivisionId').value;
            const costCenterId = document.getElementById('organizationalCostCenterId').value;
            const areaId = document.getElementById('organizationalAreaId').value;
            const subareaId = document.getElementById('organizationalSubareaId').value;
            const requiredLevel = parseInt(document.getElementById('requiredOrganizationalLevel').value) || 2;
            
            const progressBar = document.getElementById('levelProgressBar');
            const progressText = document.getElementById('levelProgressText');
            
            let currentLevel = 0;
            let levelText = 'Selecciona la divisi√≥n para comenzar';
            
            if (divisionId) {
                currentLevel = 1;
                levelText = 'Divisi√≥n seleccionada';
            }
            if (costCenterId) {
                currentLevel = 2;
                levelText = 'Centro de costo seleccionado';
            }
            if (areaId) {
                currentLevel = 3;
                levelText = '√Årea/Secci√≥n seleccionada';
            }
            if (subareaId) {
                currentLevel = 4;
                levelText = 'Sub√°rea seleccionada - Ubicaci√≥n completa';
            }
            
            const progress = (currentLevel / 4) * 100;
            progressBar.style.width = progress + '%';
            
            if (currentLevel >= requiredLevel) {
                progressText.innerHTML = `<i class="bi bi-check-circle text-success me-1"></i>${levelText} - Nivel requerido completado`;
                progressText.className = 'text-success';
            } else if (currentLevel > 0) {
                progressText.innerHTML = `<i class="bi bi-arrow-right text-warning me-1"></i>${levelText} - Contin√∫a hasta nivel ${requiredLevel}`;
                progressText.className = 'text-warning';
            } else {
                progressText.innerHTML = levelText;
                progressText.className = 'text-muted';
            }
        }

        // ==========================================
        // FUNCIONES DE GESTI√ìN DE ROLES
        // ==========================================

        function assignRole() {
            const roleId = document.getElementById('newRoleSelect').value;
            const isPrimary = document.getElementById('isPrimaryRole').checked;
            const notes = document.getElementById('roleNotes').value.trim();
            
            if (!roleId) {
                showMessage('Selecciona un rol para asignar', 'warning');
                return;
            }
            
            // Verificar que no est√© ya asignado
            if (tempAssignedRoles.some(r => r.job_role_id === roleId)) {
                showMessage('Este rol ya est√° asignado al trabajador', 'warning');
                return;
            }
            
            // Si es rol principal, desmarcar otros
            if (isPrimary) {
                tempAssignedRoles.forEach(r => r.is_primary_role = false);
            }
            
            // Buscar informaci√≥n del rol
            const role = jobRoles.find(jr => jr.role_id === roleId);
            if (!role) {
                showMessage('Error: Rol no encontrado', 'danger');
                return;
            }
            
            // Agregar rol temporal
            const tempRole = {
                job_role_id: roleId,
                role_name: role.role_name,
                is_primary_role: isPrimary,
                assigned_date: new Date().toISOString().split('T')[0],
                assignment_status: 'active',
                notes: notes,
                _isNew: true // Marcar como nuevo para identificarlo
            };
            
            tempAssignedRoles.push(tempRole);
            
            // Actualizar UI
            renderAssignedRoles();
            updateRolesCount();
            
            // Limpiar formulario
            document.getElementById('newRoleSelect').value = '';
            document.getElementById('isPrimaryRole').checked = false;
            document.getElementById('roleNotes').value = '';
            
            showMessage('Rol asignado temporalmente. Guarda el trabajador para confirmar', 'success');
        }

        function removeRole(roleId) {
            tempAssignedRoles = tempAssignedRoles.filter(r => r.job_role_id !== roleId);
            renderAssignedRoles();
            updateRolesCount();
        }

        function togglePrimaryRole(roleId) {
            tempAssignedRoles.forEach(r => {
                r.is_primary_role = (r.job_role_id === roleId);
            });
            renderAssignedRoles();
        }

        function renderAssignedRoles() {
            const container = document.getElementById('assignedRolesList');
            
            if (tempAssignedRoles.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No hay roles asignados a√∫n
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tempAssignedRoles.map(role => `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold">${role.role_name}</span>
                                ${role.is_primary_role ? '<span class="badge bg-warning ms-2">Principal</span>' : ''}
                                ${role._isNew ? '<span class="badge bg-info ms-2">Nuevo</span>' : ''}
                                ${role.notes ? `<br><small class="text-muted">${role.notes}</small>` : ''}
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-warning" title="Hacer principal" 
                                        onclick="togglePrimaryRole('${role.job_role_id}')" 
                                        ${role.is_primary_role ? 'disabled' : ''}>
                                    <i class="bi bi-star${role.is_primary_role ? '-fill' : ''}"></i>
                                </button>
                                <button class="btn btn-outline-danger" title="Remover" 
                                        onclick="removeRole('${role.job_role_id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateRolesCount() {
            const badge = document.getElementById('rolesCount');
            const count = tempAssignedRoles.length;
            badge.textContent = count;
            badge.className = count > 0 ? 'badge bg-success ms-1' : 'badge bg-warning ms-1 d-none';
        }

        // ==========================================
        // FUNCIONES DE NAVEGACI√ìN DE PESTA√ëAS
        // ==========================================

        function nextTab() {
            if (currentTabIndex < tabIds.length - 1) {
                currentTabIndex++;
                const nextTab = new bootstrap.Tab(document.querySelector(`#${tabIds[currentTabIndex]}-tab`));
                nextTab.show();
            }
        }

        function previousTab() {
            if (currentTabIndex > 0) {
                currentTabIndex--;
                const prevTab = new bootstrap.Tab(document.querySelector(`#${tabIds[currentTabIndex]}-tab`));
                prevTab.show();
            }
        }

        function updateTabButtons() {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            
            prevButton.style.display = currentTabIndex === 0 ? 'none' : 'inline-block';
            nextButton.style.display = currentTabIndex === tabIds.length - 1 ? 'none' : 'inline-block';
        }

        function updateSummary() {
            // Resumen informaci√≥n personal
            const personalData = {
                document: document.getElementById('workerIdDoc').value,
                name: `${document.getElementById('workerFirstName').value} ${document.getElementById('workerLastName1').value} ${document.getElementById('workerLastName2').value || ''}`.trim(),
                email: document.getElementById('workerEmail').value,
                birthday: document.getElementById('workerBirthday').value,
                entryDate: document.getElementById('workerEntryDate').value,
                status: document.getElementById('workerStatus').value
            };
            
            const personalSummary = document.getElementById('personalSummary');
            if (personalData.name && personalData.document) {
                personalSummary.innerHTML = `
                    <p><strong>Nombre:</strong> ${personalData.name}</p>
                    <p><strong>Documento:</strong> ${personalData.document}</p>
                    <p><strong>Email:</strong> ${personalData.email}</p>
                    <p><strong>Fecha Nacimiento:</strong> ${formatDate(personalData.birthday)}</p>
                    <p><strong>Fecha Ingreso:</strong> ${formatDate(personalData.entryDate)}</p>
                    <p><strong>Estado:</strong> <span class="badge ${getStatusClass(personalData.status)}">${getStatusText(personalData.status)}</span></p>
                `;
            } else {
                personalSummary.innerHTML = '<p class="text-muted">Complete la informaci√≥n personal para ver el resumen</p>';
            }
            
            // Resumen organizacional
            const orgData = {
                division: document.getElementById('organizationalDivisionId').selectedOptions[0]?.text,
                costCenter: document.getElementById('organizationalCostCenterId').selectedOptions[0]?.text,
                area: document.getElementById('organizationalAreaId').selectedOptions[0]?.text,
                subarea: document.getElementById('organizationalSubareaId').selectedOptions[0]?.text,
                requiredLevel: document.getElementById('requiredOrganizationalLevel').value
            };
            
            const orgSummary = document.getElementById('organizationalSummary');
            const orgPath = [orgData.division, orgData.costCenter, orgData.area, orgData.subarea].filter(x => x && x !== 'Seleccionar...' && !x.includes('Primero')).join(' ‚Üí ');
            
            if (orgPath) {
                orgSummary.innerHTML = `
                    <p><strong>Ubicaci√≥n:</strong> ${orgPath}</p>
                    <p><strong>Nivel Requerido:</strong> ${orgData.requiredLevel}</p>
                `;
            } else {
                orgSummary.innerHTML = '<p class="text-muted">Configure la ubicaci√≥n organizacional para ver el resumen</p>';
            }
            
            // Resumen de roles
            const rolesSummary = document.getElementById('rolesSummary');
            if (tempAssignedRoles.length > 0) {
                const primaryRole = tempAssignedRoles.find(r => r.is_primary_role);
                const secondaryRoles = tempAssignedRoles.filter(r => !r.is_primary_role);
                
                rolesSummary.innerHTML = `
                    ${primaryRole ? `<p><strong>Rol Principal:</strong> <span class="badge bg-primary">${primaryRole.role_name}</span></p>` : ''}
                    ${secondaryRoles.length > 0 ? `<p><strong>Roles Secundarios:</strong> ${secondaryRoles.map(r => `<span class="badge bg-secondary me-1">${r.role_name}</span>`).join('')}</p>` : ''}
                    <p><strong>Total Roles:</strong> ${tempAssignedRoles.length}</p>
                `;
            } else {
                rolesSummary.innerHTML = '<p class="text-muted">Asigne roles para ver el resumen</p>';
            }
        }

        // ==========================================
        // FUNCIONES DE FORMULARIO
        // ==========================================

        function openCreateModal() {
            currentEditingWorkerId = null;
            tempAssignedRoles = [];
            document.getElementById('modalTitle').innerHTML = '<i class="bi bi-person-plus me-2"></i>Nuevo Trabajador';
            document.getElementById('workerForm').reset();
            document.getElementById('workerStatus').value = 'active';
            document.getElementById('requiredOrganizationalLevel').value = '3';
            
            // Reset pesta√±as
            currentTabIndex = 0;
            const firstTab = new bootstrap.Tab(document.querySelector('#personal-tab'));
            firstTab.show();
            
            // Reset dropdowns en cascada
            resetCascadingDropdowns();
            
            // Actualizar UI
            updateTabButtons();
            updateRolesCount();
            renderAssignedRoles();
            updateLevelProgress();
            
            const modal = new bootstrap.Modal(document.getElementById('workerModal'));
            modal.show();
        }

        async function editWorker(workerId) {
            try {
                showLoading(true);
                
                // Cargar datos completos del trabajador
                const workers = await supabaseRequest(`/workers?select=*&worker_id=eq.${workerId}`);
                const worker = workers?.[0];
                
                if (!worker) {
                    showMessage('Trabajador no encontrado', 'danger');
                    return;
                }

                currentEditingWorkerId = workerId;
                document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Trabajador';
                
                // Llenar informaci√≥n personal
                document.getElementById('workerId').value = worker.worker_id;
                document.getElementById('workerIdDoc').value = worker.worker_id_doc || '';
                document.getElementById('workerFirstName').value = worker.worker_first_name || '';
                document.getElementById('workerLastName1').value = worker.worker_last_name_1 || '';
                document.getElementById('workerLastName2').value = worker.worker_last_name_2 || '';
                document.getElementById('workerEmail').value = worker.email || '';
                document.getElementById('genderId').value = worker.gender_id || '';
                document.getElementById('workerBirthday').value = worker.worker_birthday || '';
                document.getElementById('workerEntryDate').value = worker.worker_entry_date || '';
                document.getElementById('workerStatus').value = worker.worker_status || 'active';
                document.getElementById('alternativeCalendar').value = worker.alternative_calendar || '';
                
                // Llenar ubicaci√≥n organizacional
                document.getElementById('organizationalDivisionId').value = worker.organizational_division_id || '';
                document.getElementById('sectionId').value = worker.section_id || '';
                document.getElementById('managementAreaId').value = worker.management_area_id || '';
                document.getElementById('requiredOrganizationalLevel').value = worker.required_organizational_level || 3;
                
                // Cargar dropdowns en cascada
                if (worker.organizational_division_id) {
                    await loadCostCenters();
                    document.getElementById('organizationalCostCenterId').value = worker.organizational_cost_center_id || '';
                    
                    if (worker.organizational_cost_center_id) {
                        await loadAreas();
                        document.getElementById('organizationalAreaId').value = worker.organizational_area_id || '';
                        
                        if (worker.organizational_area_id) {
                            await loadSubareas();
                            document.getElementById('organizationalSubareaId').value = worker.organizational_subarea_id || '';
                        }
                    }
                }
                
                // Cargar roles asignados
                await loadWorkerRoles(workerId);
                
                // Reset pesta√±as
                currentTabIndex = 0;
                const firstTab = new bootstrap.Tab(document.querySelector('#personal-tab'));
                firstTab.show();
                
                // Actualizar UI
                updateTabButtons();
                updateRolesCount();
                renderAssignedRoles();
                updateLevelProgress();

                const modal = new bootstrap.Modal(document.getElementById('workerModal'));
                modal.show();

            } catch (error) {
                console.error('‚ùå Error preparando edici√≥n:', error);
                showMessage('Error al preparar edici√≥n: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        async function loadWorkerRoles(workerId) {
            try {
                const workerRoles = await supabaseRequest(`
                    /worker_job_roles?select=*,job_roles(role_name)
                    &worker_id=eq.${workerId}
                    &assignment_status=eq.active
                    &order=is_primary_role.desc,job_roles(role_name).asc
                `);
                
                tempAssignedRoles = (workerRoles || []).map(wr => ({
                    job_role_id: wr.job_role_id,
                    role_name: wr.job_roles?.role_name || 'Rol desconocido',
                    is_primary_role: wr.is_primary_role,
                    assigned_date: wr.assigned_date,
                    assignment_status: wr.assignment_status,
                    notes: wr.notes || '',
                    _isExisting: true // Marcar como existente
                }));
                
            } catch (error) {
                console.error('‚ùå Error cargando roles del trabajador:', error);
                tempAssignedRoles = [];
            }
        }

        function resetCascadingDropdowns() {
            document.getElementById('organizationalCostCenterId').innerHTML = '<option value="">Primero selecciona una divisi√≥n...</option>';
            document.getElementById('organizationalCostCenterId').disabled = true;
            document.getElementById('organizationalAreaId').innerHTML = '<option value="">Primero selecciona un centro de costo...</option>';
            document.getElementById('organizationalAreaId').disabled = true;
            document.getElementById('organizationalSubareaId').innerHTML = '<option value="">Primero selecciona un √°rea...</option>';
            document.getElementById('organizationalSubareaId').disabled = true;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            try {
                showLoading(true);
                
                const formData = new FormData(e.target);
                const workerData = {
                    worker_id_doc: formData.get('worker_id_doc').trim(),
                    worker_first_name: formData.get('worker_first_name').trim(),
                    worker_last_name_1: formData.get('worker_last_name_1').trim(),
                    worker_last_name_2: formData.get('worker_last_name_2')?.trim() || null,
                    email: formData.get('email').trim(),
                    gender_id: formData.get('gender_id') || null,
                    worker_birthday: formData.get('worker_birthday'),
                    worker_entry_date: formData.get('worker_entry_date'),
                    worker_status: formData.get('worker_status'),
                    alternative_calendar: formData.get('alternative_calendar')?.trim() || null,
                    section_id: formData.get('section_id') || null,
                    management_area_id: formData.get('management_area_id') || null,
                    organizational_division_id: formData.get('organizational_division_id') || null,
                    organizational_cost_center_id: formData.get('organizational_cost_center_id') || null,
                    organizational_area_id: formData.get('organizational_area_id') || null,
                    organizational_subarea_id: formData.get('organizational_subarea_id') || null,
                    required_organizational_level: parseInt(formData.get('required_organizational_level')) || 2
                };

                // Validaciones b√°sicas
                if (!workerData.worker_id_doc) {
                    showMessage('El documento de identidad es requerido', 'danger');
                    return;
                }
                
                if (!workerData.worker_first_name || !workerData.worker_last_name_1) {
                    showMessage('El nombre y primer apellido son requeridos', 'danger');
                    return;
                }
                
                if (!workerData.email) {
                    showMessage('El correo electr√≥nico es requerido', 'danger');
                    return;
                }
                
                // Validar estructura organizacional seg√∫n nivel requerido
                const requiredLevel = workerData.required_organizational_level;
                if (requiredLevel >= 1 && !workerData.organizational_division_id) {
                    showMessage('Debe seleccionar una divisi√≥n organizacional', 'danger');
                    return;
                }
                if (requiredLevel >= 2 && !workerData.organizational_cost_center_id) {
                    showMessage('Debe seleccionar un centro de costo', 'danger');
                    return;
                }
                if (requiredLevel >= 3 && !workerData.organizational_area_id) {
                    showMessage('Debe seleccionar un √°rea/secci√≥n organizacional', 'danger');
                    return;
                }
                if (requiredLevel >= 4 && !workerData.organizational_subarea_id) {
                    showMessage('Debe seleccionar una sub√°rea organizacional', 'danger');
                    return;
                }

                let response;
                if (currentEditingWorkerId) {
                    // Actualizar trabajador
                    response = await supabaseRequest(`/workers?worker_id=eq.${currentEditingWorkerId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(workerData)
                    });
                } else {
                    // Crear trabajador
                    response = await supabaseRequest('/workers', {
                        method: 'POST',
                        body: JSON.stringify(workerData)
                    });
                }

                const workerId = currentEditingWorkerId || (response && response[0]?.worker_id);
                
                if (!workerId) {
                    throw new Error('No se pudo obtener el ID del trabajador');
                }

                // Gestionar roles asignados
                await saveWorkerRoles(workerId);

                showMessage(
                    currentEditingWorkerId ? 'Trabajador actualizado exitosamente' : 'Trabajador creado exitosamente', 
                    'success'
                );

                // Cerrar modal y recargar
                bootstrap.Modal.getInstance(document.getElementById('workerModal')).hide();
                await loadWorkers();

            } catch (error) {
                console.error('‚ùå Error guardando trabajador:', error);
                let errorMessage = 'Error al guardar el trabajador';
                
                if (error.message.includes('duplicate key')) {
                    if (error.message.includes('worker_id_doc')) {
                        errorMessage = 'Ya existe un trabajador con este documento de identidad';
                    } else if (error.message.includes('email')) {
                        errorMessage = 'Ya existe un trabajador con este correo electr√≥nico';
                    } else {
                        errorMessage = 'Ya existe un trabajador con estos datos';
                    }
                } else if (error.message.includes('foreign key')) {
                    errorMessage = 'Error de referencia: Verifica que todas las selecciones organizacionales sean v√°lidas';
                } else if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                
                showMessage(errorMessage, 'danger');
            } finally {
                showLoading(false);
            }
        }

        async function saveWorkerRoles(workerId) {
            try {
                // Eliminar todas las asignaciones actuales (solo las que no son nuevas)
                if (currentEditingWorkerId) {
                    await supabaseRequest(`/worker_job_roles?worker_id=eq.${workerId}`, {
                        method: 'DELETE'
                    });
                }

                // Crear nuevas asignaciones
                if (tempAssignedRoles.length > 0) {
                    const roleAssignments = tempAssignedRoles.map(role => ({
                        worker_id: workerId,
                        job_role_id: role.job_role_id,
                        assigned_date: role.assigned_date || new Date().toISOString().split('T')[0],
                        is_primary_role: role.is_primary_role,
                        assignment_status: 'active',
                        notes: role.notes || null
                    }));

                    await supabaseRequest('/worker_job_roles', {
                        method: 'POST',
                        body: JSON.stringify(roleAssignments)
                    });
                }

            } catch (error) {
                console.error('‚ùå Error guardando roles:', error);
                throw new Error('Error al guardar los roles del trabajador');
            }
        }

        // ==========================================
        // FUNCIONES DE GESTI√ìN R√ÅPIDA DE ROLES
        // ==========================================

        async function manageWorkerRoles(workerId) {
            // Esta funci√≥n podr√≠a abrir un modal espec√≠fico para gesti√≥n r√°pida de roles
            // Por ahora, abre el modal de edici√≥n en la pesta√±a de roles
            await editWorker(workerId);
            
            // Cambiar a la pesta√±a de roles
            setTimeout(() => {
                const rolesTab = new bootstrap.Tab(document.querySelector('#roles-tab'));
                rolesTab.show();
            }, 100);
        }

        // ==========================================
        // FUNCIONES DE ELIMINACI√ìN
        // ==========================================

        function prepareDelete(workerId, workerName) {
            currentDeleteWorkerId = workerId;
            document.getElementById('deleteWorkerName').textContent = workerName;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            modal.show();
        }

        async function confirmDelete() {
            if (!currentDeleteWorkerId) return;
            
            try {
                showLoading(true);
                
                // Eliminar trabajador (CASCADE eliminar√° autom√°ticamente los roles asignados)
                await supabaseRequest(`/workers?worker_id=eq.${currentDeleteWorkerId}`, {
                    method: 'DELETE'
                });
                
                showMessage('Trabajador eliminado exitosamente', 'success');
                
                // Cerrar modal y recargar
                bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
                await loadWorkers();
                
            } catch (error) {
                console.error('‚ùå Error eliminando trabajador:', error);
                let errorMessage = 'Error al eliminar el trabajador';
                
                if (error.message.includes('foreign key')) {
                    errorMessage = 'No se puede eliminar: el trabajador tiene datos relacionados en otras tablas';
                } else if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                
                showMessage(errorMessage, 'danger');
            } finally {
                showLoading(false);
                currentDeleteWorkerId = null;
            }
        }

        // ==========================================
        // FUNCIONES DE B√öSQUEDA Y FILTROS
        // ==========================================

        function searchWorkers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filtered = allWorkers;
            
            // Filtro por texto
            if (searchTerm) {
                filtered = filtered.filter(worker => {
                    const fullName = `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.toLowerCase();
                    const document = worker.worker_id_doc.toLowerCase();
                    const email = worker.email.toLowerCase();
                    
                    return fullName.includes(searchTerm) || 
                           document.includes(searchTerm) || 
                           email.includes(searchTerm);
                });
            }
            
            // Filtro por estado
            if (statusFilter) {
                filtered = filtered.filter(worker => worker.worker_status === statusFilter);
            }
            
            renderWorkersTable(filtered);
        }

        function filterByStatus() {
            searchWorkers();
        }

        // Funci√≥n debounce para b√∫squeda
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================

        function updateStatistics() {
            const total = allWorkers.length;
            const active = allWorkers.filter(w => w.worker_status === 'active').length;
            const withRoles = allWorkers.filter(w => w.roles && w.roles.length > 0).length;
            
            // Calcular antig√ºedad promedio
            const now = new Date();
            const tenures = allWorkers
                .filter(w => w.worker_entry_date)
                .map(w => {
                    const entryDate = new Date(w.worker_entry_date);
                    return Math.floor((now - entryDate) / (365.25 * 24 * 60 * 60 * 1000));
                });
            
            const avgTenure = tenures.length > 0 ? 
                Math.round(tenures.reduce((sum, t) => sum + t, 0) / tenures.length) : 0;
            
            document.getElementById('totalWorkers').textContent = total;
            document.getElementById('activeWorkers').textContent = active;
            document.getElementById('workersWithRoles').textContent = withRoles;
            document.getElementById('avgTenure').textContent = avgTenure > 0 ? `${avgTenure} a√±os` : '-';
        }

        function getStatusClass(status) {
            const classes = {
                'active': 'bg-success',
                'inactive': 'bg-danger', 
                'suspended': 'bg-warning'
            };
            return classes[status] || 'bg-secondary';
        }

        function getStatusIcon(status) {
            const icons = {
                'active': 'check-circle',
                'inactive': 'x-circle',
                'suspended': 'pause-circle'
            };
            return icons[status] || 'question-circle';
        }

        function getStatusText(status) {
            const texts = {
                'active': 'Activo',
                'inactive': 'Inactivo',
                'suspended': 'Suspendido'
            };
            return texts[status] || status;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
