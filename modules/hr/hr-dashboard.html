<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA -->
    <meta name="page-version" content="25.11.03.11.29">
    
    <title>Dashboard Talento Humano - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            --color-success: #198754;
            --color-warning: #ffc107;
            --color-danger: #dc3545;
            --color-info: #0dcaf0;
            --color-primary: #0d6efd;
        }

        /* CARDS DE M√âTRICAS */
        .metric-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            height: 100%;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-trend {
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .trend-up {
            color: var(--color-success);
            background: rgba(25, 135, 84, 0.1);
        }

        .trend-down {
            color: var(--color-danger);
            background: rgba(220, 53, 69, 0.1);
        }

        /* ALERTAS CR√çTICAS */
        .alert-card {
            border-left: 4px solid;
            border-radius: 8px;
            background: white;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .alert-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .alert-card.critical {
            border-left-color: var(--color-danger);
        }

        .alert-card.warning {
            border-left-color: var(--color-warning);
        }

        .alert-card.info {
            border-left-color: var(--color-info);
        }

        /* GR√ÅFICOS */
        .chart-container {
            position: relative;
            height: 250px;
        }

        /* PR√ìXIMAS AUSENCIAS */
        .absence-item {
            border-left: 4px solid #0d6efd;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .absence-item:hover {
            background: #e9ecef;
            transform: translateX(4px);
        }

        .absence-date {
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: 600;
        }

        .absence-worker {
            font-weight: 600;
            color: #212529;
        }

        .absence-category {
            font-size: 0.75rem;
            color: #6c757d;
        }

        /* BADGES */
        .status-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* TOP ITEMS */
        .top-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .top-item-rank {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .top-item-name {
            flex: 1;
            margin-left: 12px;
            font-weight: 500;
        }

        .top-item-value {
            font-weight: 700;
            color: var(--color-primary);
        }

        /* ACCESOS R√ÅPIDOS */
        .quick-action {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            text-decoration: none;
            display: block;
            color: inherit;
        }

        .quick-action:hover {
            border-color: var(--color-primary);
            background: rgba(13, 110, 253, 0.05);
            transform: translateY(-4px);
            color: inherit;
        }

        .quick-action i {
            font-size: 2rem;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .quick-action-label {
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* LOADING */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0d6efd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .metric-value {
                font-size: 1.5rem;
            }

            .chart-container {
                height: 200px;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="spinner mx-auto mb-3"></div>
            <p class="text-white">Cargando datos...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Talento Humano</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Dashboard
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div>
                        <h1 class="h3 mb-2">
                            <i class="bi bi-speedometer2 me-2"></i>
                            Dashboard de Talento Humano
                        </h1>
                        <p class="text-muted mb-0">Vista ejecutiva del estado actual de ausencias y asistencia</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- M√âTRICAS PRINCIPALES -->
        <div class="row g-3 mb-4">
            <!-- Ausencias Hoy -->
            <div class="col-6 col-lg-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-icon" style="background: rgba(13, 110, 253, 0.1); color: var(--color-primary);">
                            <i class="bi bi-calendar-x"></i>
                        </div>
                        <div class="metric-value" id="metric-absences-today">0</div>
                        <div class="metric-label">Ausencias Hoy</div>
                    </div>
                </div>
            </div>

            <!-- Pendientes Autorizaci√≥n -->
            <div class="col-6 col-lg-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-icon" style="background: rgba(255, 193, 7, 0.1); color: var(--color-warning);">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                        <div class="metric-value" id="metric-pending">0</div>
                        <div class="metric-label">Pendientes</div>
                    </div>
                </div>
            </div>

            <!-- % Asistencia Mensual -->
            <div class="col-6 col-lg-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-icon" style="background: rgba(25, 135, 84, 0.1); color: var(--color-success);">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="metric-value" id="metric-attendance">0%</div>
                        <div class="metric-label">Asistencia Mensual</div>
                    </div>
                </div>
            </div>

            <!-- Inconsistencias -->
            <div class="col-6 col-lg-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-icon" style="background: rgba(220, 53, 69, 0.1); color: var(--color-danger);">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                        <div class="metric-value" id="metric-inconsistencies">0</div>
                        <div class="metric-label">Inconsistencias</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- FILA DE ALERTAS Y GR√ÅFICOS -->
        <div class="row g-4 mb-4">
            
            <!-- ALERTAS CR√çTICAS -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-bell text-danger me-2"></i>
                            Alertas Cr√≠ticas
                        </h5>
                    </div>
                    <div class="card-body" id="alerts-container">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1"></i>
                            <p class="mt-2">Cargando alertas...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TENDENCIA MENSUAL -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up text-primary me-2"></i>
                            Tendencia de Ausencias (√öltimos 6 Meses)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- FILA DE DISTRIBUCI√ìN Y PR√ìXIMAS AUSENCIAS -->
        <div class="row g-4 mb-4">
            
            <!-- DISTRIBUCI√ìN POR CATEGOR√çA -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-pie-chart text-info me-2"></i>
                            Distribuci√≥n por Categor√≠a (Mes Actual)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PR√ìXIMAS AUSENCIAS -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-event text-primary me-2"></i>
                            Pr√≥ximas Ausencias (7 d√≠as)
                        </h5>
                        <span class="badge bg-primary" id="upcoming-count">0</span>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;" id="upcoming-absences">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-calendar3 fs-1"></i>
                            <p class="mt-2">Cargando ausencias...</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- FILA DE TOP ESTAD√çSTICAS -->
        <div class="row g-4 mb-4">
            
            <!-- TOP 5 TRABAJADORES -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-person-lines-fill text-warning me-2"></i>
                            Top 5 Trabajadores (Mes Actual)
                        </h5>
                    </div>
                    <div class="card-body" id="top-workers">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-people fs-1"></i>
                            <p class="mt-2">Cargando datos...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TOP 5 CATEGOR√çAS -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-tags text-success me-2"></i>
                            Top 5 Categor√≠as M√°s Usadas
                        </h5>
                    </div>
                    <div class="card-body" id="top-categories">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-bookmark fs-1"></i>
                            <p class="mt-2">Cargando datos...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TOP 5 SECCIONES -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-building text-danger me-2"></i>
                            Top 5 Secciones con Mayor Ausentismo
                        </h5>
                    </div>
                    <div class="card-body" id="top-sections">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-diagram-3 fs-1"></i>
                            <p class="mt-2">Cargando datos...</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ACCESOS R√ÅPIDOS -->
        <div class="row mb-4">
            <div class="col-12">
                <h5 class="mb-3">
                    <i class="bi bi-lightning-charge text-warning me-2"></i>
                    Accesos R√°pidos
                </h5>
            </div>
        </div>

        <div class="row g-3 mb-5">
            
            <div class="col-6 col-md-3">
                <a href="request-absence.html" class="quick-action">
                    <i class="bi bi-plus-circle"></i>
                    <div class="quick-action-label">Nueva Solicitud</div>
                </a>
            </div>

            <div class="col-6 col-md-3">
                <a href="authorize-absences.html" class="quick-action">
                    <i class="bi bi-check-circle"></i>
                    <div class="quick-action-label">Autorizar Ausencias</div>
                </a>
            </div>

            <div class="col-6 col-md-3">
                <a href="manage-absences.html" class="quick-action">
                    <i class="bi bi-list-check"></i>
                    <div class="quick-action-label">Gestionar Ausencias</div>
                </a>
            </div>

            <div class="col-6 col-md-3">
                <a href="absence-reports.html" class="quick-action">
                    <i class="bi bi-file-earmark-bar-graph"></i>
                    <div class="quick-action-label">Ver Reportes</div>
                </a>
            </div>

            <div class="col-6 col-md-3">
                <a href="work-calendar.html" class="quick-action">
                    <i class="bi bi-calendar3"></i>
                    <div class="quick-action-label">Calendario Laboral</div>
                </a>
            </div>

            <div class="col-6 col-md-3">
                <a href="adjust-balances.html" class="quick-action">
                    <i class="bi bi-sliders"></i>
                    <div class="quick-action-label">Ajustar Saldos</div>
                </a>
            </div>

            <div class="col-6 col-md-3">
                <a href="absence-categories.html" class="quick-action">
                    <i class="bi bi-tags"></i>
                    <div class="quick-action-label">Categor√≠as</div>
                </a>
            </div>

            <div class="col-6 col-md-3">
                <a href="absence-config.html" class="quick-action">
                    <i class="bi bi-gear"></i>
                    <div class="quick-action-label">Configuraci√≥n</div>
                </a>
            </div>

        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let trendChart = null;
        let categoryChart = null;
        let dashboardData = {
            metrics: {},
            alerts: [],
            upcomingAbsences: [],
            topWorkers: [],
            topCategories: [],
            topSections: [],
            trendData: {},
            categoryData: {}
        };

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîí Iniciando validaci√≥n de acceso...');
            
            try {
                // PASO 1: Validar permisos
                const hasAccess = await validatePageAccess('Ver dashboard de talento humano');
                if (!hasAccess) return;
                
                console.log('‚úÖ Acceso validado');
                
                // PASO 2: Cargar datos del dashboard
                await loadDashboard();
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                showMessage('Error al inicializar el dashboard: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGA DE DATOS DEL DASHBOARD
        // ==========================================
        async function loadDashboard() {
            try {
                showLoading(true);
                
                // Cargar todas las m√©tricas en paralelo
                await Promise.all([
                    loadMetrics(),
                    loadAlerts(),
                    loadTrendData(),
                    loadCategoryDistribution(),
                    loadUpcomingAbsences(),
                    loadTopWorkers(),
                    loadTopCategories(),
                    loadTopSections()
                ]);
                
                console.log('‚úÖ Dashboard cargado completamente');
                
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                showMessage('Error al cargar el dashboard: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // ==========================================
        // M√âTRICAS PRINCIPALES
        // ==========================================
        async function loadMetrics() {
            try {
                const today = new Date();
                const todayStr = formatDateForDB(today);
                
                // Primer d√≠a del mes actual
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const firstDayStr = formatDateForDB(firstDayOfMonth);
                
                // √öltimo d√≠a del mes actual
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                const lastDayStr = formatDateForDB(lastDayOfMonth);
                
                // 1. Ausencias de hoy
                const absencesToday = await supabaseRequest(
                    '/hr_absence_requests?select=request_id&status=eq.approved&start_date=lte.' + todayStr + '&end_date=gte.' + todayStr,
                    { method: 'GET' }
                );
                
                // 2. Pendientes de autorizaci√≥n
                const pending = await supabaseRequest(
                    '/hr_absence_requests?select=request_id&status=eq.pending',
                    { method: 'GET' }
                );
                
                // 3. Calcular % asistencia mensual
                const workDays = await calculateWorkDaysInMonth(firstDayStr, lastDayStr);
                const attendances = await supabaseRequest(
                    '/attendance?select=attendance_date,person_id_document&person_type=eq.worker&attendance_date=gte.' + firstDayStr + '&attendance_date=lte.' + lastDayStr + '&registro_tipo=eq.entrada',
                    { method: 'GET' }
                );
                
                // Contar d√≠as √∫nicos de asistencia
                const uniqueAttendances = new Set(attendances.map(a => `${a.person_id_document}-${a.attendance_date}`)).size;
                
                // Total trabajadores activos
                const workers = await supabaseRequest(
                    '/workers?select=worker_id&worker_status=eq.active',
                    { method: 'GET' }
                );
                
                const totalPossibleAttendances = workers.length * workDays;
                const attendancePercent = totalPossibleAttendances > 0 ? 
                    ((uniqueAttendances / totalPossibleAttendances) * 100).toFixed(1) : 0;
                
                // 4. Inconsistencias (√∫ltimos 30 d√≠as)
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const thirtyDaysAgoStr = formatDateForDB(thirtyDaysAgo);
                
                const inconsistencies = await detectInconsistencies(thirtyDaysAgoStr, todayStr);
                
                // Actualizar m√©tricas en UI
                document.getElementById('metric-absences-today').textContent = absencesToday.length;
                document.getElementById('metric-pending').textContent = pending.length;
                document.getElementById('metric-attendance').textContent = attendancePercent + '%';
                document.getElementById('metric-inconsistencies').textContent = inconsistencies.length;
                
                dashboardData.metrics = {
                    absencesToday: absencesToday.length,
                    pending: pending.length,
                    attendancePercent: attendancePercent,
                    inconsistencies: inconsistencies.length
                };
                
            } catch (error) {
                console.error('Error cargando m√©tricas:', error);
            }
        }
      // ==========================================
        // ALERTAS CR√çTICAS
        // ==========================================
        async function loadAlerts() {
            try {
                const alerts = [];
                
                // 1. Trabajadores con saldo cr√≠tico (< 20%)
                const hrConfig = await supabaseRequest('/hr_config?select=*&limit=1', { method: 'GET' });
                const config = hrConfig && hrConfig.length > 0 ? hrConfig[0] : null;
                
                if (config) {
                    const adjustments = await supabaseRequest('/hr_balance_adjustments?select=worker_id,adjustment_type,amount', { method: 'GET' });
                    const absences = await supabaseRequest('/hr_absence_requests?select=worker_id,total_hours,total_days,category_id&status=eq.approved', { method: 'GET' });
                    const categories = await supabaseRequest('/hr_absence_categories?select=category_id,accumulates_personal_hours,controls_calamity_days_limit', { method: 'GET' });
                    
                    const categoryMap = {};
                    categories.forEach(cat => categoryMap[cat.category_id] = cat);
                    
                    const balanceMap = {};
                    adjustments.forEach(adj => {
                        if (!balanceMap[adj.worker_id]) {
                            balanceMap[adj.worker_id] = { personal_hours: 0, calamity_days: 0 };
                        }
                        if (adj.adjustment_type === 'personal_hours') {
                            balanceMap[adj.worker_id].personal_hours += parseFloat(adj.amount);
                        } else if (adj.adjustment_type === 'calamity_days') {
                            balanceMap[adj.worker_id].calamity_days += parseFloat(adj.amount);
                        }
                    });
                    
                    absences.forEach(absence => {
                        const category = categoryMap[absence.category_id];
                        if (category && balanceMap[absence.worker_id]) {
                            if (category.accumulates_personal_hours) {
                                balanceMap[absence.worker_id].personal_hours -= parseFloat(absence.total_hours || 0);
                            }
                            if (category.controls_calamity_days_limit) {
                                balanceMap[absence.worker_id].calamity_days -= parseFloat(absence.total_days || 0);
                            }
                        }
                    });
                    
                    let criticalCount = 0;
                    Object.entries(balanceMap).forEach(([workerId, balance]) => {
                        const hoursPercent = (balance.personal_hours / config.personal_hours_limit);
                        const daysPercent = (balance.calamity_days / config.calamity_days_limit);
                        
                        if (hoursPercent < 0.2 || daysPercent < 0.2) {
                            criticalCount++;
                        }
                    });
                    
                    if (criticalCount > 0) {
                        alerts.push({
                            type: 'warning',
                            icon: 'speedometer2',
                            title: 'Saldos Cr√≠ticos',
                            message: `${criticalCount} trabajador(es) con saldo menor al 20%`,
                            action: 'adjust-balances.html'
                        });
                    }
                }
                
                // 2. Solicitudes urgentes sin responder (> 48h)
                const twoDaysAgo = new Date();
                twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
                const twoDaysAgoStr = formatDateForDB(twoDaysAgo) + 'T00:00:00';
                
                const urgentPending = await supabaseRequest(
                    '/hr_absence_requests?select=request_id&status=eq.pending&created_at=lt.' + twoDaysAgoStr,
                    { method: 'GET' }
                );
                
                if (urgentPending.length > 0) {
                    alerts.push({
                        type: 'critical',
                        icon: 'clock-history',
                        title: 'Solicitudes Urgentes',
                        message: `${urgentPending.length} solicitud(es) pendiente(s) por m√°s de 48 horas`,
                        action: 'authorize-absences.html'
                    });
                }
                
                // 3. Inconsistencias detectadas hoy
                const today = formatDateForDB(new Date());
                const todayInconsistencies = await detectInconsistencies(today, today);
                
                if (todayInconsistencies.length > 0) {
                    alerts.push({
                        type: 'critical',
                        icon: 'exclamation-triangle',
                        title: 'Inconsistencias Detectadas Hoy',
                        message: `${todayInconsistencies.length} inconsistencia(s) entre ausencias y asistencia`,
                        action: 'absence-reports.html'
                    });
                }
                
                dashboardData.alerts = alerts;
                displayAlerts(alerts);
                
            } catch (error) {
                console.error('Error cargando alertas:', error);
            }
        }

        function displayAlerts(alerts) {
            const container = document.getElementById('alerts-container');
            
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-success py-4">
                        <i class="bi bi-check-circle fs-1"></i>
                        <p class="mt-2">¬°No hay alertas cr√≠ticas!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = alerts.map(alert => `
                <div class="alert-card ${alert.type}">
                    <div class="d-flex align-items-start">
                        <div class="me-3">
                            <i class="bi bi-${alert.icon} fs-4 ${alert.type === 'critical' ? 'text-danger' : 'text-warning'}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${alert.title}</h6>
                            <p class="mb-2 text-muted small">${alert.message}</p>
                            ${alert.action ? `<a href="${alert.action}" class="btn btn-sm btn-outline-primary">Ver Detalles</a>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // TENDENCIA MENSUAL
        // ==========================================
        async function loadTrendData() {
            try {
                const monthsData = [];
                const today = new Date();
                
                // √öltimos 6 meses
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const firstDay = formatDateForDB(date);
                    const lastDay = formatDateForDB(new Date(date.getFullYear(), date.getMonth() + 1, 0));
                    
                    const absences = await supabaseRequest(
                        '/hr_absence_requests?select=request_id&status=eq.approved&start_date=gte.' + firstDay + '&start_date=lte.' + lastDay,
                        { method: 'GET' }
                    );
                    
                    monthsData.push({
                        month: date.toLocaleDateString('es-CO', { month: 'short', year: 'numeric' }),
                        count: absences.length
                    });
                }
                
                dashboardData.trendData = monthsData;
                displayTrendChart(monthsData);
                
            } catch (error) {
                console.error('Error cargando tendencia:', error);
            }
        }

        function displayTrendChart(data) {
            const ctx = document.getElementById('trendChart');
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: 'Ausencias Aprobadas',
                        data: data.map(d => d.count),
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // ==========================================
        // DISTRIBUCI√ìN POR CATEGOR√çA
        // ==========================================
        async function loadCategoryDistribution() {
            try {
                const today = new Date();
                const firstDay = formatDateForDB(new Date(today.getFullYear(), today.getMonth(), 1));
                const lastDay = formatDateForDB(new Date(today.getFullYear(), today.getMonth() + 1, 0));
                
                const absences = await supabaseRequest(
                    '/hr_absence_requests?select=category_id,category:hr_absence_categories(name)&status=eq.approved&start_date=gte.' + firstDay + '&start_date=lte.' + lastDay,
                    { method: 'GET' }
                );
                
                const categoryCount = {};
                absences.forEach(absence => {
                    const catName = absence.category?.name || 'Sin categor√≠a';
                    categoryCount[catName] = (categoryCount[catName] || 0) + 1;
                });
                
                const categoryData = Object.entries(categoryCount).map(([name, count]) => ({ name, count }));
                
                dashboardData.categoryData = categoryData;
                displayCategoryChart(categoryData);
                
            } catch (error) {
                console.error('Error cargando distribuci√≥n por categor√≠a:', error);
            }
        }

        function displayCategoryChart(data) {
            const ctx = document.getElementById('categoryChart');
            
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            const colors = [
                '#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0',
                '#6f42c1', '#fd7e14', '#20c997', '#d63384', '#6c757d'
            ];
            
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: colors.slice(0, data.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // ==========================================
        // PR√ìXIMAS AUSENCIAS
        // ==========================================
        async function loadUpcomingAbsences() {
            try {
                const today = new Date();
                const todayStr = formatDateForDB(today);
                const sevenDaysLater = new Date(today);
                sevenDaysLater.setDate(sevenDaysLater.getDate() + 7);
                const sevenDaysStr = formatDateForDB(sevenDaysLater);
                
                const absences = await supabaseRequest(
                    '/hr_absence_requests?select=*,worker:workers!hr_absence_requests_worker_id_fkey(worker_first_name,worker_last_name_1,worker_last_name_2),category:hr_absence_categories(name)&status=eq.approved&start_date=gte.' + todayStr + '&start_date=lte.' + sevenDaysStr + '&order=start_date.asc',
                    { method: 'GET' }
                );
                
                dashboardData.upcomingAbsences = absences;
                displayUpcomingAbsences(absences);
                
            } catch (error) {
                console.error('Error cargando pr√≥ximas ausencias:', error);
            }
        }

        function displayUpcomingAbsences(absences) {
            const container = document.getElementById('upcoming-absences');
            document.getElementById('upcoming-count').textContent = absences.length;
            
            if (absences.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-check-circle fs-1 text-success"></i>
                        <p class="mt-2">No hay ausencias programadas</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = absences.map(absence => {
                const workerName = `${absence.worker.worker_first_name} ${absence.worker.worker_last_name_1}`;
                const startDate = new Date(absence.start_date + 'T00:00:00');
                const dateStr = startDate.toLocaleDateString('es-CO', { weekday: 'short', day: 'numeric', month: 'short' });
                
                return `
                    <div class="absence-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="absence-worker">${workerName}</div>
                                <div class="absence-category">${absence.category?.name || 'N/A'}</div>
                            </div>
                            <div class="text-end">
                                <div class="absence-date">${dateStr}</div>
                                ${absence.is_full_day ? 
                                    '<span class="status-badge bg-primary text-white">D√≠a completo</span>' : 
                                    '<span class="status-badge bg-info text-white">Parcial</span>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==========================================
        // TOP TRABAJADORES
        // ==========================================
        async function loadTopWorkers() {
            try {
                const today = new Date();
                const firstDay = formatDateForDB(new Date(today.getFullYear(), today.getMonth(), 1));
                const lastDay = formatDateForDB(new Date(today.getFullYear(), today.getMonth() + 1, 0));
                
                const absences = await supabaseRequest(
                    '/hr_absence_requests?select=worker_id,worker:workers!hr_absence_requests_worker_id_fkey(worker_first_name,worker_last_name_1)&status=eq.approved&start_date=gte.' + firstDay + '&start_date=lte.' + lastDay,
                    { method: 'GET' }
                );
                
                const workerCount = {};
                absences.forEach(absence => {
                    const workerId = absence.worker_id;
                    const workerName = `${absence.worker.worker_first_name} ${absence.worker.worker_last_name_1}`;
                    if (!workerCount[workerId]) {
                        workerCount[workerId] = { name: workerName, count: 0 };
                    }
                    workerCount[workerId].count++;
                });
                
                const topWorkers = Object.values(workerCount)
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                
                dashboardData.topWorkers = topWorkers;
                displayTopWorkers(topWorkers);
                
            } catch (error) {
                console.error('Error cargando top trabajadores:', error);
            }
        }

        function displayTopWorkers(workers) {
            const container = document.getElementById('top-workers');
            
            if (workers.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1"></i>
                        <p class="mt-2">Sin datos</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = workers.map((worker, index) => `
                <div class="top-item">
                    <div class="top-item-rank">${index + 1}</div>
                    <div class="top-item-name">${worker.name}</div>
                    <div class="top-item-value">${worker.count}</div>
                </div>
            `).join('');
        }

        // ==========================================
        // TOP CATEGOR√çAS
        // ==========================================
        async function loadTopCategories() {
            try {
                const today = new Date();
                const firstDay = formatDateForDB(new Date(today.getFullYear(), today.getMonth(), 1));
                const lastDay = formatDateForDB(new Date(today.getFullYear(), today.getMonth() + 1, 0));
                
                const absences = await supabaseRequest(
                    '/hr_absence_requests?select=category:hr_absence_categories(name)&status=eq.approved&start_date=gte.' + firstDay + '&start_date=lte.' + lastDay,
                    { method: 'GET' }
                );
                
                const categoryCount = {};
                absences.forEach(absence => {
                    const catName = absence.category?.name || 'Sin categor√≠a';
                    categoryCount[catName] = (categoryCount[catName] || 0) + 1;
                });
                
                const topCategories = Object.entries(categoryCount)
                    .map(([name, count]) => ({ name, count }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                
                dashboardData.topCategories = topCategories;
                displayTopCategories(topCategories);
                
            } catch (error) {
                console.error('Error cargando top categor√≠as:', error);
            }
        }

        function displayTopCategories(categories) {
            const container = document.getElementById('top-categories');
            
            if (categories.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1"></i>
                        <p class="mt-2">Sin datos</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = categories.map((cat, index) => `
                <div class="top-item">
                    <div class="top-item-rank">${index + 1}</div>
                    <div class="top-item-name">${cat.name}</div>
                    <div class="top-item-value">${cat.count}</div>
                </div>
            `).join('');
        }

        // ==========================================
        // TOP SECCIONES
        // ==========================================
        async function loadTopSections() {
            try {
                const today = new Date();
                const firstDay = formatDateForDB(new Date(today.getFullYear(), today.getMonth(), 1));
                const lastDay = formatDateForDB(new Date(today.getFullYear(), today.getMonth() + 1, 0));
                
                const absences = await supabaseRequest(
                    '/hr_absence_requests?select=worker:workers!hr_absence_requests_worker_id_fkey(section_id,sections(section_name))&status=eq.approved&start_date=gte.' + firstDay + '&start_date=lte.' + lastDay,
                    { method: 'GET' }
                );
                
                const sectionCount = {};
                absences.forEach(absence => {
                    const sectionName = absence.worker?.sections?.section_name || 'Sin secci√≥n';
                    sectionCount[sectionName] = (sectionCount[sectionName] || 0) + 1;
                });
                
                const topSections = Object.entries(sectionCount)
                    .map(([name, count]) => ({ name, count }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                
                dashboardData.topSections = topSections;
                displayTopSections(topSections);
                
            } catch (error) {
                console.error('Error cargando top secciones:', error);
            }
        }

        function displayTopSections(sections) {
            const container = document.getElementById('top-sections');
            
            if (sections.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1"></i>
                        <p class="mt-2">Sin datos</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = sections.map((section, index) => `
                <div class="top-item">
                    <div class="top-item-rank">${index + 1}</div>
                    <div class="top-item-name">${section.name}</div>
                    <div class="top-item-value">${section.count}</div>
                </div>
            `).join('');
        }

        // ==========================================
        // FUNCIONES AUXILIARES
        // ==========================================
        async function calculateWorkDaysInMonth(startDate, endDate) {
            const nonWorkDays = await supabaseRequest(
                '/hr_non_work_days?select=start_date,end_date',
                { method: 'GET' }
            );
            
            let workDays = 0;
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dayOfWeek = d.getDay();
                const dateStr = formatDateForDB(new Date(d));
                
                if (dayOfWeek === 0 || dayOfWeek === 6) continue;
                
                let isNonWorkDay = false;
                for (const period of nonWorkDays) {
                    if (dateStr >= period.start_date && dateStr <= period.end_date) {
                        isNonWorkDay = true;
                        break;
                    }
                }
                
                if (!isNonWorkDay) workDays++;
            }
            
            return workDays;
        }

        async function detectInconsistencies(startDate, endDate) {
            const absences = await supabaseRequest(
                '/hr_absence_requests?select=*,worker:workers!hr_absence_requests_worker_id_fkey(worker_id_doc)&status=eq.approved&is_full_day=eq.true&start_date=gte.' + startDate + '&end_date=lte.' + endDate,
                { method: 'GET' }
            );
            
            const inconsistencies = [];
            
            for (const absence of absences) {
                const attendances = await supabaseRequest(
                    '/attendance?select=attendance_date&person_id_document=eq.' + encodeURIComponent(absence.worker.worker_id_doc) +
                    '&person_type=eq.worker&attendance_date=gte.' + absence.start_date +
                    '&attendance_date=lte.' + absence.end_date,
                    { method: 'GET' }
                );
                
                if (attendances.length > 0) {
                    inconsistencies.push({ absence, attendances });
                }
            }
            
            return inconsistencies;
        }

        async function refreshDashboard() {
            await loadDashboard();
            showMessage('Dashboard actualizado correctamente', 'success');
        }

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function formatDateForDB(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

    </script>
</body>
</html>
