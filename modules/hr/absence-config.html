<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.02.16.09">
    <title>Configuración de Ausencias - Schoolnet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .info-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            background-color: #e3f2fd;
            color: #1976d2;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }
        .section-card {
            margin-bottom: 1.5rem;
        }
        .section-card .card-header {
            background-color: #f8f9fa;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4 px-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../dashboard.html">Inicio</a></li>
                <li class="breadcrumb-item"><a href="index.html">Talento Humano</a></li>
                <li class="breadcrumb-item active">Configuración de Ausencias</li>
            </ol>
        </nav>

        <!-- Título y Descripción -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1"><i class="bi bi-gear-fill text-primary me-2"></i>Configuración de Ausencias</h2>
                <p class="text-muted mb-0">Configure los límites, correos de notificación y jornada laboral del módulo</p>
            </div>
        </div>

        <!-- Formulario de Configuración -->
        <form id="configForm">
            <!-- Sección: Límites -->
            <div class="card section-card">
                <div class="card-header">
                    <i class="bi bi-speedometer2 me-2"></i>Límites Configurables
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="personalHoursLimit" class="form-label">
                                Límite de horas personales
                                <span class="info-badge">Por trabajador/año</span>
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="personalHoursLimit" 
                                       required min="0" step="1" placeholder="Ej: 40">
                                <span class="input-group-text">horas</span>
                            </div>
                            <div class="form-text">Cantidad máxima de horas personales al año</div>
                        </div>
                        <div class="col-md-4">
                            <label for="calamityDaysLimit" class="form-label">
                                Límite de días de calamidad
                                <span class="info-badge">Por trabajador/año</span>
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="calamityDaysLimit" 
                                       required min="0" step="1" placeholder="Ej: 3">
                                <span class="input-group-text">días</span>
                            </div>
                            <div class="form-text">Cantidad máxima de días de calamidad al año</div>
                        </div>
                        <div class="col-md-4">
                            <label for="maxHoursPerMedical" class="form-label">
                                Máximo de horas por cita médica
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="maxHoursPerMedical" 
                                       required min="0" step="1" placeholder="Ej: 4">
                                <span class="input-group-text">horas</span>
                            </div>
                            <div class="form-text">Duración máxima permitida por cita</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección: Correos de Notificación -->
            <div class="card section-card">
                <div class="card-header">
                    <i class="bi bi-envelope-fill me-2"></i>Correos de Notificación
                </div>
                <div class="card-body">
                    <div class="alert alert-info d-flex align-items-center mb-3">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <small>Estos correos recibirán notificaciones según la sección educativa del trabajador</small>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="hrManagerEmail" class="form-label">
                                <i class="bi bi-person-badge me-1"></i>Coordinación de Talento Humano
                            </label>
                            <input type="text" class="form-control" id="hrManagerEmail" 
                                   placeholder="talentohumano@ejemplo.com">
                        </div>
                        <div class="col-md-6">
                            <label for="preschoolEmail" class="form-label">
                                <i class="bi bi-building me-1"></i>Preescolar
                            </label>
                            <input type="text" class="form-control" id="preschoolEmail" 
                                   placeholder="preescolar@ejemplo.com">
                        </div>
                        <div class="col-md-6">
                            <label for="elementaryEmail" class="form-label">
                                <i class="bi bi-building me-1"></i>Primaria
                            </label>
                            <input type="text" class="form-control" id="elementaryEmail" 
                                   placeholder="primaria@ejemplo.com">
                        </div>
                        <div class="col-md-6">
                            <label for="middleSchoolEmail" class="form-label">
                                <i class="bi bi-building me-1"></i>Bachillerato
                            </label>
                            <input type="text" class="form-control" id="middleSchoolEmail" 
                                   placeholder="bachillerato@ejemplo.com">
                        </div>
                        <div class="col-md-6">
                            <label for="highSchoolEmail" class="form-label">
                                <i class="bi bi-building me-1"></i>Media
                            </label>
                            <input type="text" class="form-control" id="highSchoolEmail" 
                                   placeholder="media@ejemplo.com">
                        </div>
                        <div class="col-md-6">
                            <label for="nonSchoolEmail" class="form-label">
                                <i class="bi bi-building me-1"></i>Personal No Escolar
                            </label>
                            <input type="text" class="form-control" id="nonSchoolEmail" 
                                   placeholder="administrativo@ejemplo.com">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección: Jornada Laboral -->
            <div class="card section-card">
                <div class="card-header">
                    <i class="bi bi-clock-fill me-2"></i>Jornada Laboral
                </div>
                <div class="card-body">
                    <div class="alert alert-warning d-flex align-items-center mb-3">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <small>La jornada se usa para calcular horas en ausencias de día completo: <strong>(hora fin - hora inicio) - 1 hora de almuerzo</strong></small>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="workdayStart" class="form-label">Hora de inicio</label>
                            <input type="time" class="form-control" id="workdayStart" required>
                            <div class="form-text">Hora de inicio de la jornada laboral</div>
                        </div>
                        <div class="col-md-6">
                            <label for="workdayEnd" class="form-label">Hora de finalización</label>
                            <input type="time" class="form-control" id="workdayEnd" required>
                            <div class="form-text">Hora de fin de la jornada laboral</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Guardar Configuración
                        </button>
                        <button type="button" class="btn btn-warning" id="btnInitializeBalances">
                            <i class="bi bi-arrow-repeat me-2"></i>Inicializar Saldos
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Modal: Confirmación de Inicialización -->
    <div class="modal fade" id="initializeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirmar Inicialización de Saldos
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning mb-3">
                        <strong>Atención:</strong> Esta acción reemplazará los saldos de <strong>TODOS los trabajadores activos</strong> con los valores configurados.
                    </div>
                    <p class="mb-2"><strong>Valores que se asignarán:</strong></p>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-check-circle text-primary me-2"></i>Horas personales: <strong id="modalPersonalHours">-</strong> horas</li>
                        <li><i class="bi bi-check-circle text-primary me-2"></i>Días de calamidad: <strong id="modalCalamityDays">-</strong> días</li>
                    </ul>
                    <hr>
                    <p class="mb-0 text-muted small">
                        Se creará un registro de ajuste para cada trabajador con la razón: 
                        <em>"Inicialización de saldos - [fecha]"</em>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="btnConfirmInitialize">
                        <i class="bi bi-arrow-repeat me-2"></i>Sí, Inicializar Saldos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Progreso -->
    <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Procesando...</span>
                    </div>
                    <h5 class="mb-2">Inicializando saldos...</h5>
                    <p class="text-muted mb-0" id="progressText">Procesando trabajadores activos</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        let supabase;
        let currentConfig = null;
        let initializeModalInstance = null;
        let progressModalInstance = null;

        // Al cargar el DOM
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Inicializar Supabase client
                supabase = createSupabaseClient();
                // Verificar autenticación
                const isAuthenticated = await checkAuth();
                if (!isAuthenticated) {
                    window.location.href = '../../index.html';
                    return;
                }

                // Verificar permisos
                const hasPermission = await checkPermission('/modules/hr/absence-config.html');
                if (!hasPermission) {
                    showAlert('No tienes permisos para acceder a esta página', 'danger');
                    setTimeout(() => window.location.href = '../../dashboard.html', 2000);
                    return;
                }

                // Inicializar modales
                initializeModalInstance = new bootstrap.Modal(document.getElementById('initializeModal'));
                progressModalInstance = new bootstrap.Modal(document.getElementById('progressModal'));

                // Cargar configuración
                await loadConfiguration();

                // Event listeners
                document.getElementById('configForm').addEventListener('submit', handleSaveConfiguration);
                document.getElementById('btnInitializeBalances').addEventListener('click', handleInitializeBalances);
                document.getElementById('btnConfirmInitialize').addEventListener('click', handleConfirmInitialize);

                // Validación de horarios
                document.getElementById('workdayEnd').addEventListener('change', validateWorkdayTimes);

            } catch (error) {
                console.error('Error al inicializar:', error);
                showAlert('Error al cargar la página', 'danger');
            }
        });

        // Cargar configuración existente o crear una nueva
        async function loadConfiguration() {
            try {
                const { data, error } = await supabase
                    .from('hr_config')
                    .select('*')
                    .limit(1)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
                    throw error;
                }

                if (data) {
                    // Configuración existente
                    currentConfig = data;
                    populateForm(data);
                } else {
                    // No existe configuración, crear una vacía
                    const { data: newConfig, error: createError } = await supabase
                        .from('hr_config')
                        .insert([{
                            personal_hours_limit: null,
                            calamity_days_limit: null,
                            max_hours_per_medical_appointment: null,
                            hr_manager_email: null,
                            preschool_email: null,
                            elementary_email: null,
                            middle_school_email: null,
                            high_school_email: null,
                            non_school_email: null,
                            workday_start_time: '07:00:00',
                            workday_end_time: '15:00:00'
                        }])
                        .select()
                        .single();

                    if (createError) throw createError;

                    currentConfig = newConfig;
                    populateForm(newConfig);
                    showAlert('Se creó la configuración inicial. Complete los campos necesarios.', 'info');
                }
            } catch (error) {
                console.error('Error al cargar configuración:', error);
                showAlert('Error al cargar la configuración', 'danger');
            }
        }

        // Llenar formulario con datos existentes
        function populateForm(config) {
            document.getElementById('personalHoursLimit').value = config.personal_hours_limit || '';
            document.getElementById('calamityDaysLimit').value = config.calamity_days_limit || '';
            document.getElementById('maxHoursPerMedical').value = config.max_hours_per_medical_appointment || '';
            
            document.getElementById('hrManagerEmail').value = config.hr_manager_email || '';
            document.getElementById('preschoolEmail').value = config.preschool_email || '';
            document.getElementById('elementaryEmail').value = config.elementary_email || '';
            document.getElementById('middleSchoolEmail').value = config.middle_school_email || '';
            document.getElementById('highSchoolEmail').value = config.high_school_email || '';
            document.getElementById('nonSchoolEmail').value = config.non_school_email || '';
            
            document.getElementById('workdayStart').value = config.workday_start_time?.substring(0, 5) || '07:00';
            document.getElementById('workdayEnd').value = config.workday_end_time?.substring(0, 5) || '15:00';
        }

        // Validar que hora fin > hora inicio
        function validateWorkdayTimes() {
            const startTime = document.getElementById('workdayStart').value;
            const endTime = document.getElementById('workdayEnd').value;

            if (startTime && endTime && endTime <= startTime) {
                showAlert('La hora de finalización debe ser mayor que la hora de inicio', 'warning');
                document.getElementById('workdayEnd').value = '';
                return false;
            }
            return true;
        }

        // Validar formato de emails
        function validateEmails() {
            const emailFields = [
                'hrManagerEmail', 'preschoolEmail', 'elementaryEmail',
                'middleSchoolEmail', 'highSchoolEmail', 'nonSchoolEmail'
            ];

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            for (const fieldId of emailFields) {
                const value = document.getElementById(fieldId).value.trim();
                if (value && !emailRegex.test(value)) {
                    showAlert(`El correo en el campo "${document.querySelector(`label[for="${fieldId}"]`).textContent.trim()}" no es válido`, 'warning');
                    document.getElementById(fieldId).focus();
                    return false;
                }
            }
            return true;
        }

        // Guardar configuración
        async function handleSaveConfiguration(e) {
            e.preventDefault();

            // Validaciones
            if (!validateWorkdayTimes()) return;
            if (!validateEmails()) return;

            const personalHours = parseInt(document.getElementById('personalHoursLimit').value);
            const calamityDays = parseInt(document.getElementById('calamityDaysLimit').value);
            const maxHours = parseInt(document.getElementById('maxHoursPerMedical').value);

            if (personalHours < 0 || calamityDays < 0 || maxHours < 0) {
                showAlert('Los límites deben ser valores positivos', 'warning');
                return;
            }

            try {
                const configData = {
                    personal_hours_limit: personalHours,
                    calamity_days_limit: calamityDays,
                    max_hours_per_medical_appointment: maxHours,
                    hr_manager_email: document.getElementById('hrManagerEmail').value.trim() || null,
                    preschool_email: document.getElementById('preschoolEmail').value.trim() || null,
                    elementary_email: document.getElementById('elementaryEmail').value.trim() || null,
                    middle_school_email: document.getElementById('middleSchoolEmail').value.trim() || null,
                    high_school_email: document.getElementById('highSchoolEmail').value.trim() || null,
                    non_school_email: document.getElementById('nonSchoolEmail').value.trim() || null,
                    workday_start_time: document.getElementById('workdayStart').value + ':00',
                    workday_end_time: document.getElementById('workdayEnd').value + ':00',
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('hr_config')
                    .update(configData)
                    .eq('config_id', currentConfig.config_id)
                    .select()
                    .single();

                if (error) throw error;

                currentConfig = data;
                showAlert('Configuración guardada exitosamente', 'success');
            } catch (error) {
                console.error('Error al guardar configuración:', error);
                showAlert('Error al guardar la configuración', 'danger');
            }
        }

        // Mostrar modal de confirmación de inicialización
        function handleInitializeBalances() {
            if (!currentConfig) {
                showAlert('Debe guardar la configuración antes de inicializar saldos', 'warning');
                return;
            }

            const personalHours = currentConfig.personal_hours_limit;
            const calamityDays = currentConfig.calamity_days_limit;

            if (!personalHours || !calamityDays) {
                showAlert('Debe configurar los límites antes de inicializar saldos', 'warning');
                return;
            }

            // Mostrar valores en el modal
            document.getElementById('modalPersonalHours').textContent = personalHours;
            document.getElementById('modalCalamityDays').textContent = calamityDays;

            initializeModalInstance.show();
        }

        // Confirmar y ejecutar inicialización
        async function handleConfirmInitialize() {
            initializeModalInstance.hide();
            progressModalInstance.show();

            try {
                const user = await getAuthenticatedUser();
                
                // Obtener trabajadores activos
                const { data: workers, error: workersError } = await supabase
                    .from('workers')
                    .select('worker_id, first_name, last_name')
                    .eq('is_active', true);

                if (workersError) throw workersError;

                if (!workers || workers.length === 0) {
                    showAlert('No se encontraron trabajadores activos', 'warning');
                    progressModalInstance.hide();
                    return;
                }

                document.getElementById('progressText').textContent = 
                    `Procesando ${workers.length} trabajadores...`;

                const adjustments = [];
                const now = new Date().toISOString();
                const reason = `Inicialización de saldos - ${new Date().toLocaleDateString('es-CO')}`;

                // Crear ajustes para cada trabajador
                for (const worker of workers) {
                    // Ajuste para horas personales
                    adjustments.push({
                        worker_id: worker.worker_id,
                        adjustment_type: 'personal_hours',
                        amount: currentConfig.personal_hours_limit,
                        reason: reason,
                        adjusted_by: user.worker_id,
                        created_at: now
                    });

                    // Ajuste para días de calamidad
                    adjustments.push({
                        worker_id: worker.worker_id,
                        adjustment_type: 'calamity_days',
                        amount: currentConfig.calamity_days_limit,
                        reason: reason,
                        adjusted_by: user.worker_id,
                        created_at: now
                    });
                }

                // Insertar todos los ajustes
                const { error: insertError } = await supabase
                    .from('hr_balance_adjustments')
                    .insert(adjustments);

                if (insertError) throw insertError;

                progressModalInstance.hide();
                showAlert(
                    `Saldos inicializados exitosamente para ${workers.length} trabajadores`, 
                    'success'
                );
            } catch (error) {
                console.error('Error al inicializar saldos:', error);
                progressModalInstance.hide();
                showAlert('Error al inicializar saldos', 'danger');
            }
        }
    </script>
</body>
</html>
