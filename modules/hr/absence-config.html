<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA - Actualizar en cada modificaci√≥n (Formato: YY.MM.DD.HH.MM) -->
    <meta name="page-version" content="25.11.02.16.26">
    
    <title>Configuraci√≥n de Ausencias - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos personalizados espec√≠ficos de la p√°gina -->
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            background-color: #e3f2fd;
            color: #1976d2;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }

        .section-card {
            margin-bottom: 1.5rem;
        }

        .section-card .card-header {
            background-color: #f8f9fa;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay - PATR√ìN EST√ÅNDAR -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL - USAR SIEMPRE container-fluid -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS - PATR√ìN MODERNO OBLIGATORIO -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Talento Humano</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Configuraci√≥n de Ausencias
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA - ESTRUCTURA EST√ÅNDAR -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-gear-fill me-2"></i>
                    Configuraci√≥n de Ausencias
                </h1>
                <p class="text-muted">
                    Configure los l√≠mites, correos de notificaci√≥n y jornada laboral del m√≥dulo
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS - OBLIGATORIO -->
        <div id="alertContainer"></div>

        <!-- CONTENIDO ESPEC√çFICO DE LA P√ÅGINA -->
        <form id="configForm">
            <!-- Secci√≥n: L√≠mites -->
            <div class="card section-card">
                <div class="card-header">
                    <i class="bi bi-speedometer2 me-2"></i>L√≠mites Configurables
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="personalHoursLimit" class="form-label">
                                L√≠mite de horas personales
                                <span class="info-badge">Por trabajador/a√±o</span>
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="personalHoursLimit" 
                                       required min="0" step="1">
                                <span class="input-group-text">horas</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="calamityDaysLimit" class="form-label">
                                L√≠mite de d√≠as de calamidad
                                <span class="info-badge">Por trabajador/a√±o</span>
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="calamityDaysLimit" 
                                       required min="0" step="1">
                                <span class="input-group-text">d√≠as</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="maxHoursPerMedical" class="form-label">
                                M√°ximo de horas por cita m√©dica
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="maxHoursPerMedical" 
                                       required min="0" step="1">
                                <span class="input-group-text">horas</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n: Correos -->
            <div class="card section-card">
                <div class="card-header">
                    <i class="bi bi-envelope-fill me-2"></i>Correos de Notificaci√≥n
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="hrManagerEmail" class="form-label">
                                <i class="bi bi-person-badge me-1"></i>Coordinaci√≥n de Talento Humano
                            </label>
                            <input type="text" class="form-control" id="hrManagerEmail">
                        </div>
                        <div class="col-md-6">
                            <label for="preschoolEmail" class="form-label">
                                <i class="bi bi-building me-1"></i>Preescolar
                            </label>
                            <input type="text" class="form-control" id="preschoolEmail">
                        </div>
                        <div class="col-md-6">
                            <label for="elementaryEmail" class="form-label">
                                <i class="bi bi-building me-1"></i>Primaria
                            </label>
                            <input type="text" class="form-control" id="elementaryEmail">
                        </div>
                        <div class="col-md-6">
                            <label for="middleSchoolEmail" class="form-label">
                                <i class="bi bi-building me-1"></i>Bachillerato
                            </label>
                            <input type="text" class="form-control" id="middleSchoolEmail">
                        </div>
                        <div class="col-md-6">
                            <label for="highSchoolEmail" class="form-label">
                                <i class="bi bi-building me-1"></i>Media
                            </label>
                            <input type="text" class="form-control" id="highSchoolEmail">
                        </div>
                        <div class="col-md-6">
                            <label for="nonSchoolEmail" class="form-label">
                                <i class="bi bi-building me-1"></i>Personal No Escolar
                            </label>
                            <input type="text" class="form-control" id="nonSchoolEmail">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n: Jornada -->
            <div class="card section-card">
                <div class="card-header">
                    <i class="bi bi-clock-fill me-2"></i>Jornada Laboral
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="workdayStart" class="form-label">Hora de inicio</label>
                            <input type="time" class="form-control" id="workdayStart" required>
                        </div>
                        <div class="col-md-6">
                            <label for="workdayEnd" class="form-label">Hora de finalizaci√≥n</label>
                            <input type="time" class="form-control" id="workdayEnd" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Guardar Configuraci√≥n
                        </button>
                        <button type="button" class="btn btn-warning" id="btnInitializeBalances">
                            <i class="bi bi-arrow-repeat me-2"></i>Inicializar Saldos
                        </button>
                    </div>
                </div>
            </div>
        </form>

    </div>

    <!-- MODAL: Confirmaci√≥n de Inicializaci√≥n -->
    <div class="modal fade" id="initializeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirmar Inicializaci√≥n
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Atenci√≥n:</strong> Esta acci√≥n reemplazar√° los saldos de TODOS los trabajadores activos.
                    </div>
                    <p><strong>Valores:</strong></p>
                    <ul>
                        <li>Horas personales: <strong id="modalPersonalHours">-</strong> horas</li>
                        <li>D√≠as de calamidad: <strong id="modalCalamityDays">-</strong> d√≠as</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="btnConfirmInitialize">
                        S√≠, Inicializar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Progreso -->
    <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3"></div>
                    <h5>Inicializando saldos...</h5>
                    <p class="text-muted" id="progressText">Procesando trabajadores</p>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS - ORDEN CR√çTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- RUTA DE CONFIG.JS - Para m√≥dulos: ../../assets/js/config.js -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentConfig = null;
        let initializeModalInstance = null;
        let progressModalInstance = null;
        
        // ==========================================
        // INICIALIZACI√ìN - PATR√ìN OBLIGATORIO
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // PASO 1: SIEMPRE validar permisos primero
                const hasAccess = await validatePageAccess('Configurar ausencias');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                
                // PASO 2: Inicializar p√°gina
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN PRINCIPAL
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Configurar elementos DOM
                inicializarElementos();
                
                // Configurar event listeners
                configurarEventos();
                
                // Cargar datos iniciales
                await cargarConfiguracion();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CONFIGURACI√ìN DE ELEMENTOS
        // ==========================================
        function inicializarElementos() {
            // Inicializar modales de Bootstrap
            initializeModalInstance = new bootstrap.Modal(document.getElementById('initializeModal'));
            progressModalInstance = new bootstrap.Modal(document.getElementById('progressModal'));
            
            console.log('‚úÖ Elementos DOM inicializados');
        }
        
        function configurarEventos() {
            // Event listeners para formularios
            document.getElementById('configForm').addEventListener('submit', manejarGuardar);
            document.getElementById('btnInitializeBalances').addEventListener('click', manejarInicializar);
            document.getElementById('btnConfirmInitialize').addEventListener('click', confirmarInicializar);
            document.getElementById('workdayEnd').addEventListener('change', validarHorarios);
            
            console.log('‚úÖ Event listeners configurados');
        }
        
        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        async function cargarConfiguracion() {
            try {
                console.log('üì° Cargando configuraci√≥n...');
                
                const data = await supabaseRequest('/hr_config?select=*&limit=1');
                
                if (data && data.length > 0) {
                    currentConfig = data[0];
                    llenarFormulario(currentConfig);
                } else {
                    // Crear configuraci√≥n inicial
                    await crearConfiguracionInicial();
                }
                
                console.log('‚úÖ Configuraci√≥n cargada');
                
            } catch (error) {
                console.error('‚ùå Error cargando configuraci√≥n:', error);
                showMessage('Error al cargar la configuraci√≥n', 'danger');
            }
        }
        
        async function crearConfiguracionInicial() {
            try {
                const newConfig = {
                    personal_hours_limit: null,
                    calamity_days_limit: null,
                    max_hours_per_medical_appointment: null,
                    hr_manager_email: null,
                    preschool_email: null,
                    elementary_email: null,
                    middle_school_email: null,
                    high_school_email: null,
                    non_school_email: null,
                    workday_start_time: '07:00:00',
                    workday_end_time: '15:00:00'
                };
                
                const data = await supabaseRequest('/hr_config', {
                    method: 'POST',
                    body: newConfig
                });
                
                currentConfig = data[0];
                llenarFormulario(currentConfig);
                showMessage('Configuraci√≥n inicial creada', 'info');
                
            } catch (error) {
                console.error('‚ùå Error creando configuraci√≥n:', error);
                throw error;
            }
        }
        
        function llenarFormulario(config) {
            document.getElementById('personalHoursLimit').value = config.personal_hours_limit || '';
            document.getElementById('calamityDaysLimit').value = config.calamity_days_limit || '';
            document.getElementById('maxHoursPerMedical').value = config.max_hours_per_medical_appointment || '';
            
            document.getElementById('hrManagerEmail').value = config.hr_manager_email || '';
            document.getElementById('preschoolEmail').value = config.preschool_email || '';
            document.getElementById('elementaryEmail').value = config.elementary_email || '';
            document.getElementById('middleSchoolEmail').value = config.middle_school_email || '';
            document.getElementById('highSchoolEmail').value = config.high_school_email || '';
            document.getElementById('nonSchoolEmail').value = config.non_school_email || '';
            
            document.getElementById('workdayStart').value = config.workday_start_time?.substring(0, 5) || '07:00';
            document.getElementById('workdayEnd').value = config.workday_end_time?.substring(0, 5) || '15:00';
        }
        
        // ==========================================
        // VALIDACIONES
        // ==========================================
        function validarHorarios() {
            const inicio = document.getElementById('workdayStart').value;
            const fin = document.getElementById('workdayEnd').value;
            
            if (inicio && fin && fin <= inicio) {
                showMessage('La hora de finalizaci√≥n debe ser mayor que la hora de inicio', 'warning');
                document.getElementById('workdayEnd').value = '';
                return false;
            }
            return true;
        }
        
        function validarEmails() {
            const campos = ['hrManagerEmail', 'preschoolEmail', 'elementaryEmail', 
                           'middleSchoolEmail', 'highSchoolEmail', 'nonSchoolEmail'];
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            for (const campo of campos) {
                const valor = document.getElementById(campo).value.trim();
                if (valor && !regex.test(valor)) {
                    showMessage('Formato de email inv√°lido en: ' + campo, 'warning');
                    return false;
                }
            }
            return true;
        }
        
        // ==========================================
        // MANEJO DE EVENTOS
        // ==========================================
        async function manejarGuardar(e) {
            e.preventDefault();
            
            if (!validarHorarios() || !validarEmails()) return;
            
            try {
                mostrarLoading();
                
                const configData = {
                    personal_hours_limit: parseInt(document.getElementById('personalHoursLimit').value),
                    calamity_days_limit: parseInt(document.getElementById('calamityDaysLimit').value),
                    max_hours_per_medical_appointment: parseInt(document.getElementById('maxHoursPerMedical').value),
                    hr_manager_email: document.getElementById('hrManagerEmail').value.trim() || null,
                    preschool_email: document.getElementById('preschoolEmail').value.trim() || null,
                    elementary_email: document.getElementById('elementaryEmail').value.trim() || null,
                    middle_school_email: document.getElementById('middleSchoolEmail').value.trim() || null,
                    high_school_email: document.getElementById('highSchoolEmail').value.trim() || null,
                    non_school_email: document.getElementById('nonSchoolEmail').value.trim() || null,
                    workday_start_time: document.getElementById('workdayStart').value + ':00',
                    workday_end_time: document.getElementById('workdayEnd').value + ':00',
                    updated_at: new Date().toISOString()
                };
                
                const data = await supabaseRequest('/hr_config?config_id=eq.' + currentConfig.config_id, {
                    method: 'PATCH',
                    body: configData
                });
                
                currentConfig = data[0];
                showMessage('Configuraci√≥n guardada exitosamente', 'success');
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error guardando:', error);
                showMessage('Error al guardar la configuraci√≥n', 'danger');
                ocultarLoading();
            }
        }
        
        function manejarInicializar() {
            if (!currentConfig || !currentConfig.personal_hours_limit) {
                showMessage('Debe guardar la configuraci√≥n antes de inicializar saldos', 'warning');
                return;
            }
            
            document.getElementById('modalPersonalHours').textContent = currentConfig.personal_hours_limit;
            document.getElementById('modalCalamityDays').textContent = currentConfig.calamity_days_limit;
            initializeModalInstance.show();
        }
        
        async function confirmarInicializar() {
            initializeModalInstance.hide();
            progressModalInstance.show();
            
            try {
                const session = getStoredSession();
                
                const workers = await supabaseRequest('/workers?select=worker_id,first_name,last_name&is_active=eq.true');
                
                if (!workers || workers.length === 0) {
                    showMessage('No se encontraron trabajadores activos', 'warning');
                    progressModalInstance.hide();
                    return;
                }
                
                document.getElementById('progressText').textContent = `Procesando ${workers.length} trabajadores...`;
                
                const adjustments = [];
                const now = new Date().toISOString();
                const reason = `Inicializaci√≥n de saldos - ${new Date().toLocaleDateString('es-CO')}`;
                
                for (const worker of workers) {
                    adjustments.push({
                        worker_id: worker.worker_id,
                        adjustment_type: 'personal_hours',
                        amount: currentConfig.personal_hours_limit,
                        reason: reason,
                        adjusted_by: session.user.worker_id,
                        created_at: now
                    });
                    
                    adjustments.push({
                        worker_id: worker.worker_id,
                        adjustment_type: 'calamity_days',
                        amount: currentConfig.calamity_days_limit,
                        reason: reason,
                        adjusted_by: session.user.worker_id,
                        created_at: now
                    });
                }
                
                await supabaseRequest('/hr_balance_adjustments', {
                    method: 'POST',
                    body: adjustments
                });
                
                progressModalInstance.hide();
                showMessage(`Saldos inicializados para ${workers.length} trabajadores`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                progressModalInstance.hide();
                showMessage('Error al inicializar saldos', 'danger');
            }
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
    </script>
</body>
</html>
