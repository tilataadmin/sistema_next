<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA - Actualizar en cada modificaci√≥n -->
    <meta name="page-version" content="25.11.03.06.16">
    
    <title>Ajustar Saldos - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .balance-card {
            border-left: 4px solid #0d6efd;
        }

        .balance-positive {
            color: #198754;
            font-weight: bold;
        }

        .balance-negative {
            color: #dc3545;
            font-weight: bold;
        }

        .balance-zero {
            color: #6c757d;
        }

        .adjustment-positive {
            background-color: #d1e7dd;
            border-left: 3px solid #198754;
        }

        .adjustment-negative {
            background-color: #f8d7da;
            border-left: 3px solid #dc3545;
        }

        .history-section {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Talento Humano</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Ajustar Saldos
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-calculator me-2"></i>
                    Ajustar Saldos de Ausencias
                </h1>
                <p class="text-muted">
                    Gestiona manualmente los saldos de horas personales y d√≠as de calamidad del personal
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- SECCI√ìN: BUSCAR TRABAJADOR -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-search me-2"></i>Buscar Trabajador
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-person"></i>
                            </span>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="workerSearch" 
                                placeholder="Buscar por nombre, apellido o documento..."
                                autocomplete="off">
                            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <!-- Resultados de b√∫squeda -->
                        <div id="searchResults" class="list-group mt-2" style="display: none; position: absolute; z-index: 1000; max-height: 300px; overflow-y: auto; width: calc(100% - 30px);"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN: INFORMACI√ìN DEL TRABAJADOR (Oculta inicialmente) -->
        <div id="workerInfoSection" style="display: none;">
            
            <!-- Info del trabajador y saldos actuales -->
            <div class="card mb-4 balance-card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-person-badge me-2"></i>
                        <span id="workerFullName"></span>
                    </h5>
                    <button class="btn btn-sm btn-light" onclick="clearWorkerSelection()">
                        <i class="bi bi-x-circle me-1"></i>Cambiar trabajador
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <p class="mb-1 text-muted small">Documento</p>
                            <p class="fw-bold" id="workerIdDoc"></p>
                        </div>
                        <div class="col-md-3">
                            <p class="mb-1 text-muted small">Email</p>
                            <p id="workerEmail"></p>
                        </div>
                        <div class="col-md-3">
                            <p class="mb-1 text-muted small">Horas Personales Disponibles</p>
                            <h4 class="mb-0" id="personalHoursBalance">--</h4>
                        </div>
                        <div class="col-md-3">
                            <p class="mb-1 text-muted small">D√≠as de Calamidad Disponibles</p>
                            <h4 class="mb-0" id="calamityDaysBalance">--</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulario de ajuste -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil-square me-2"></i>Realizar Ajuste
                    </h5>
                </div>
                <div class="card-body">
                    <form id="adjustmentForm">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="adjustmentType" class="form-label">
                                    Tipo de Ajuste <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="adjustmentType" required>
                                    <option value="">Seleccione...</option>
                                    <option value="personal_hours">Horas Personales</option>
                                    <option value="calamity_days">D√≠as de Calamidad</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="adjustmentAmount" class="form-label">
                                    Cantidad <span class="text-danger">*</span>
                                </label>
                                <input 
                                    type="number" 
                                    class="form-control" 
                                    id="adjustmentAmount" 
                                    step="0.01"
                                    placeholder="Ej: 5 o -3.5"
                                    required>
                                <small class="text-muted">Positivo para agregar, negativo para restar</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-success" onclick="applyQuickAdjustment(10)">
                                        <i class="bi bi-plus-circle me-1"></i>+10
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <label for="adjustmentReason" class="form-label">
                                    Raz√≥n del Ajuste <span class="text-danger">*</span>
                                </label>
                                <textarea 
                                    class="form-control" 
                                    id="adjustmentReason" 
                                    rows="3" 
                                    placeholder="Describa la raz√≥n de este ajuste..."
                                    required></textarea>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle me-1"></i>Aplicar Ajuste
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>Limpiar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Historial de ajustes -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>Historial de Ajustes
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadAdjustmentHistory()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                </div>
                <div class="card-body history-section">
                    <div id="adjustmentHistory">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <div class="mt-2">Cargando historial...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Solicitudes de ausencias aprobadas -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-check me-2"></i>Solicitudes de Ausencias
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadAbsenceRequests()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha Solicitud</th>
                                    <th>Categor√≠a</th>
                                    <th>Per√≠odo</th>
                                    <th>Horas/D√≠as</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="absenceRequestsTable">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                        <div class="mt-2">Cargando solicitudes...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let selectedWorker = null;
        let currentBalances = {
            personal_hours: 0,
            calamity_days: 0
        };

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîí Iniciando validaci√≥n de acceso...');
            
            try {
                // PASO 1: Validar permisos
                const hasAccess = await validatePageAccess('Ajustar saldos de ausencias');
                if (!hasAccess) return;
                
                console.log('‚úÖ Acceso validado');
                
                // PASO 2: Configurar b√∫squeda de trabajadores
                setupWorkerSearch();
                
                // PASO 3: Configurar formulario
                setupForm();
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                showMessage('Error al inicializar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // B√öSQUEDA DE TRABAJADORES
        // ==========================================
        function setupWorkerSearch() {
            const searchInput = document.getElementById('workerSearch');
            const searchResults = document.getElementById('searchResults');
            
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    searchResults.style.display = 'none';
                    searchResults.innerHTML = '';
                    return;
                }
                
                searchTimeout = setTimeout(() => searchWorkers(query), 300);
            });
            
            // Cerrar resultados al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.style.display = 'none';
                }
            });
        }

        async function searchWorkers(query) {
            const searchResults = document.getElementById('searchResults');
            
            try {
                const lowerQuery = query.toLowerCase();
                
                const workers = await supabaseRequest(
                    '/workers?select=worker_id,worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2,email,worker_status&worker_status=eq.active&order=worker_first_name.asc',
                    { method: 'GET' }
                );
                
                const filtered = workers.filter(w => {
                    const fullName = `${w.worker_first_name} ${w.worker_last_name_1} ${w.worker_last_name_2 || ''}`.toLowerCase();
                    const doc = w.worker_id_doc.toLowerCase();
                    return fullName.includes(lowerQuery) || doc.includes(lowerQuery);
                });
                
                if (filtered.length === 0) {
                    searchResults.innerHTML = '<div class="list-group-item text-muted">No se encontraron trabajadores</div>';
                    searchResults.style.display = 'block';
                    return;
                }
                
                searchResults.innerHTML = filtered.map(worker => `
                    <button type="button" class="list-group-item list-group-item-action" onclick='selectWorker(${JSON.stringify(worker)})'>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}</strong>
                                <br>
                                <small class="text-muted">Documento: ${worker.worker_id_doc}</small>
                            </div>
                            <i class="bi bi-arrow-right-circle"></i>
                        </div>
                    </button>
                `).join('');
                
                searchResults.style.display = 'block';
                
            } catch (error) {
                console.error('Error buscando trabajadores:', error);
                showMessage('Error al buscar trabajadores: ' + error.message, 'danger');
            }
        }

        async function selectWorker(worker) {
            selectedWorker = worker;
            
            // Ocultar resultados de b√∫squeda
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('workerSearch').value = '';
            
            // Mostrar informaci√≥n del trabajador
            document.getElementById('workerFullName').textContent = 
                `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`;
            document.getElementById('workerIdDoc').textContent = worker.worker_id_doc;
            document.getElementById('workerEmail').textContent = worker.email;
            
            // Mostrar la secci√≥n de informaci√≥n
            document.getElementById('workerInfoSection').style.display = 'block';
            
            // Cargar saldos actuales
            await loadCurrentBalances();
            
            // Cargar historial de ajustes
            await loadAdjustmentHistory();
            
            // Cargar solicitudes de ausencias
            await loadAbsenceRequests();
            
            // Scroll a la secci√≥n
            document.getElementById('workerInfoSection').scrollIntoView({ behavior: 'smooth' });
        }

        function clearSearch() {
            document.getElementById('workerSearch').value = '';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchResults').innerHTML = '';
        }

        function clearWorkerSelection() {
            selectedWorker = null;
            document.getElementById('workerInfoSection').style.display = 'none';
            document.getElementById('workerSearch').value = '';
            resetForm();
        }

        // ==========================================
        // C√ÅLCULO DE SALDOS
        // ==========================================
        async function loadCurrentBalances() {
            if (!selectedWorker) return;
            
            try {
                // Obtener ajustes del trabajador
                const adjustments = await supabaseRequest(
                    '/hr_balance_adjustments?select=adjustment_type,amount&worker_id=eq.' + selectedWorker.worker_id,
                    { method: 'GET' }
                );
                
                // Calcular saldos por tipo
                let personalHours = 0;
                let calamityDays = 0;
                
                adjustments.forEach(adj => {
                    if (adj.adjustment_type === 'personal_hours') {
                        personalHours += parseFloat(adj.amount);
                    } else if (adj.adjustment_type === 'calamity_days') {
                        calamityDays += parseFloat(adj.amount);
                    }
                });
                
                // Obtener ausencias aprobadas que consumen del saldo
                const absences = await supabaseRequest(
                    '/hr_absence_requests?select=total_hours,total_days,category_id&worker_id=eq.' + selectedWorker.worker_id + '&status=eq.approved',
                    { method: 'GET' }
                );
                
                // Obtener categor√≠as para saber cu√°les consumen del saldo
                const categories = await supabaseRequest(
                    '/hr_absence_categories?select=category_id,accumulates_personal_hours,controls_calamity_days_limit',
                    { method: 'GET' }
                );
                
                const categoryMap = {};
                categories.forEach(cat => {
                    categoryMap[cat.category_id] = cat;
                });
                
                // Restar ausencias que consumen del saldo
                absences.forEach(absence => {
                    const category = categoryMap[absence.category_id];
                    if (category) {
                        if (category.accumulates_personal_hours) {
                            personalHours -= parseFloat(absence.total_hours || 0);
                        }
                        if (category.controls_calamity_days_limit) {
                            calamityDays -= parseFloat(absence.total_days || 0);
                        }
                    }
                });
                
                // Actualizar variables globales
                currentBalances.personal_hours = personalHours;
                currentBalances.calamity_days = calamityDays;
                
                // Mostrar en la UI
                displayBalance('personalHoursBalance', personalHours, ' hrs');
                displayBalance('calamityDaysBalance', calamityDays, ' d√≠as');
                
            } catch (error) {
                console.error('Error calculando saldos:', error);
                showMessage('Error al calcular saldos: ' + error.message, 'danger');
            }
        }

        function displayBalance(elementId, value, suffix = '') {
            const element = document.getElementById(elementId);
            const rounded = Math.round(value * 100) / 100;
            
            element.textContent = rounded + suffix;
            
            // Aplicar clase seg√∫n el valor
            element.className = '';
            if (rounded > 0) {
                element.classList.add('balance-positive');
            } else if (rounded < 0) {
                element.classList.add('balance-negative');
            } else {
                element.classList.add('balance-zero');
            }
        }

        // ==========================================
        // HISTORIAL DE AJUSTES
        // ==========================================
        async function loadAdjustmentHistory() {
            if (!selectedWorker) return;
            
            const historyDiv = document.getElementById('adjustmentHistory');
            
            try {
                const adjustments = await supabaseRequest(
                    '/hr_balance_adjustments?select=*,adjusted_by_worker:workers!hr_balance_adjustments_adjusted_by_fkey(worker_first_name,worker_last_name_1)&worker_id=eq.' + selectedWorker.worker_id + '&order=created_at.desc',
                    { method: 'GET' }
                );
                
                if (adjustments.length === 0) {
                    historyDiv.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1"></i>
                            <p class="mt-2">No hay ajustes registrados para este trabajador</p>
                        </div>
                    `;
                    return;
                }
                
                historyDiv.innerHTML = adjustments.map(adj => {
                    const isPositive = parseFloat(adj.amount) >= 0;
                    const adjustmentClass = isPositive ? 'adjustment-positive' : 'adjustment-negative';
                    const icon = isPositive ? 'bi-plus-circle-fill' : 'bi-dash-circle-fill';
                    const typeLabel = adj.adjustment_type === 'personal_hours' ? 'Horas Personales' : 'D√≠as de Calamidad';
                    const adjustedBy = adj.adjusted_by_worker ? 
                        `${adj.adjusted_by_worker.worker_first_name} ${adj.adjusted_by_worker.worker_last_name_1}` : 
                        'Sistema';
                    
                    return `
                        <div class="card mb-2 ${adjustmentClass}">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="bi ${icon} me-2"></i>
                                            ${isPositive ? '+' : ''}${adj.amount} ${typeLabel}
                                        </h6>
                                        <p class="mb-1 small">${adj.reason}</p>
                                        <small class="text-muted">
                                            <i class="bi bi-person me-1"></i>${adjustedBy} ‚Ä¢ 
                                            <i class="bi bi-calendar me-1"></i>${formatDateTime(adj.created_at)}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error cargando historial:', error);
                historyDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Error al cargar el historial: ${error.message}
                    </div>
                `;
            }
        }

        // ==========================================
        // SOLICITUDES DE AUSENCIAS
        // ==========================================
        async function loadAbsenceRequests() {
            if (!selectedWorker) return;
            
            const tableBody = document.getElementById('absenceRequestsTable');
            
            try {
                const requests = await supabaseRequest(
                    '/hr_absence_requests?select=*,category:hr_absence_categories(name)&worker_id=eq.' + selectedWorker.worker_id + '&order=created_at.desc&limit=20',
                    { method: 'GET' }
                );
                
                if (requests.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                <i class="bi bi-inbox fs-1"></i>
                                <p class="mt-2">No hay solicitudes de ausencias registradas</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tableBody.innerHTML = requests.map(req => {
                    const statusBadge = getStatusBadge(req.status);
                    const period = req.is_full_day ? 
                        `${formatDate(req.start_date)} - ${formatDate(req.end_date)}` :
                        `${formatDate(req.start_date)} ${req.start_time} - ${req.end_time}`;
                    const amount = req.is_full_day ? 
                        `${req.total_days} d√≠as` :
                        `${req.total_hours} hrs`;
                    
                    return `
                        <tr>
                            <td>${formatDate(req.created_at)}</td>
                            <td>${req.category?.name || 'N/A'}</td>
                            <td>${period}</td>
                            <td>${amount}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error cargando solicitudes:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="alert alert-danger mb-0">
                                Error al cargar solicitudes: ${error.message}
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge bg-warning">Pendiente</span>',
                'approved': '<span class="badge bg-success">Aprobada</span>',
                'rejected': '<span class="badge bg-danger">Rechazada</span>',
                'cancelled': '<span class="badge bg-secondary">Cancelada</span>'
            };
            return badges[status] || '<span class="badge bg-secondary">Desconocido</span>';
        }

        // ==========================================
        // FORMULARIO DE AJUSTE
        // ==========================================
        function setupForm() {
            const form = document.getElementById('adjustmentForm');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveAdjustment();
            });
        }

        function applyQuickAdjustment(amount) {
            document.getElementById('adjustmentAmount').value = amount;
        }

        async function saveAdjustment() {
            if (!selectedWorker) {
                showMessage('Debe seleccionar un trabajador', 'warning');
                return;
            }
            
            const adjustmentType = document.getElementById('adjustmentType').value;
            const amount = parseFloat(document.getElementById('adjustmentAmount').value);
            const reason = document.getElementById('adjustmentReason').value.trim();
            
            if (!adjustmentType || isNaN(amount) || !reason) {
                showMessage('Complete todos los campos requeridos', 'warning');
                return;
            }
            
            if (amount === 0) {
                showMessage('La cantidad no puede ser cero', 'warning');
                return;
            }
            
            // Obtener el usuario actual
            const session = getStoredSession();
            if (!session || !session.user) {
                showMessage('No se pudo identificar el usuario actual', 'danger');
                return;
            }
            
            try {
                showLoading(true);
                
                const adjustmentData = {
                    worker_id: selectedWorker.worker_id,
                    adjustment_type: adjustmentType,
                    amount: amount,
                    reason: reason,
                    adjusted_by: session.user.worker_id
                };
                
                await supabaseRequest('/hr_balance_adjustments', {
                    method: 'POST',
                    body: JSON.stringify(adjustmentData)
                });
                
                showMessage('Ajuste aplicado correctamente', 'success');
                
                // Recargar datos
                await loadCurrentBalances();
                await loadAdjustmentHistory();
                
                // Limpiar formulario
                resetForm();
                
            } catch (error) {
                console.error('Error guardando ajuste:', error);
                showMessage('Error al guardar el ajuste: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function resetForm() {
            document.getElementById('adjustmentForm').reset();
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit' 
            });
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

    </script>
</body>
</html>
