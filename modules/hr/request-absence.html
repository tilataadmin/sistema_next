<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.02.18.36">
    <title>Solicitar Ausencia - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .balance-card {
            border-left: 4px solid #0d6efd;
        }
        
        .balance-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0d6efd;
        }
        
        .balance-label {
            font-size: 0.875rem;
            color: #6c757d;
            text-transform: uppercase;
        }
        
        .file-preview {
            position: relative;
            display: inline-block;
            margin: 0.5rem;
        }
        
        .file-preview img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .file-preview .remove-file {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .camera-preview {
            max-width: 100%;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-top: 1rem;
        }
        
        #videoPreview {
            width: 100%;
            max-width: 400px;
            border-radius: 4px;
        }
        
        .required-field::after {
            content: " *";
            color: #dc3545;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        
        .status-rejected {
            background-color: #f8d7da;
            color: #842029;
        }
        
        .status-cancelled {
            background-color: #e2e3e5;
            color: #41464b;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Talento Humano</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Solicitar Ausencia
                </li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-calendar-x me-2"></i>
                    Solicitar Ausencia
                </h1>
                <p class="text-muted">
                    Registra tu solicitud de ausencia con los documentos de soporte necesarios
                </p>
            </div>
        </div>

        <!-- Contenedor de Alertas -->
        <div id="alertContainer"></div>

        <!-- Cards de Saldos -->
        <div class="row mb-4" id="balanceCards">
            <div class="col-md-6 mb-3">
                <div class="card balance-card">
                    <div class="card-body">
                        <div class="balance-label">Horas Personales Disponibles</div>
                        <div class="balance-value" id="availableHours">
                            <span class="spinner-border spinner-border-sm"></span>
                        </div>
                        <small class="text-muted">L√≠mite anual configurado</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card balance-card">
                    <div class="card-body">
                        <div class="balance-label">D√≠as de Calamidad Disponibles</div>
                        <div class="balance-value" id="availableDays">
                            <span class="spinner-border spinner-border-sm"></span>
                        </div>
                        <small class="text-muted">L√≠mite anual configurado</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario de Solicitud -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-file-text me-2"></i>Nueva Solicitud de Ausencia
                </h5>
            </div>
            <div class="card-body">
                <form id="absenceForm">
                    
                    <!-- Categor√≠a -->
                    <div class="mb-3">
                        <label for="categorySelect" class="form-label required-field">
                            Categor√≠a de Ausencia
                        </label>
                        <select class="form-select" id="categorySelect" required>
                            <option value="">Seleccione una categor√≠a...</option>
                        </select>
                        <div class="form-text" id="categoryHelp"></div>
                    </div>

                    <!-- Campos Din√°micos seg√∫n Categor√≠a -->
                    <div id="dynamicFields"></div>

                    <!-- Descripci√≥n -->
                    <div class="mb-3">
                        <label for="description" class="form-label">
                            Descripci√≥n / Motivo
                        </label>
                        <textarea class="form-control" id="description" rows="3" 
                            placeholder="Describe brevemente el motivo de tu ausencia..."></textarea>
                    </div>

                    <!-- Archivos Adjuntos -->
                    <div class="mb-3">
                        <label class="form-label">
                            Documentos de Soporte
                        </label>
                        <div class="d-flex gap-2 mb-2">
                            <button type="button" class="btn btn-outline-primary" onclick="triggerFileInput()">
                                <i class="bi bi-paperclip me-1"></i>Adjuntar Archivos
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="openCamera()">
                                <i class="bi bi-camera me-1"></i>Capturar Foto
                            </button>
                        </div>
                        <input type="file" id="fileInput" multiple accept="image/*,application/pdf,.doc,.docx" 
                            style="display: none;" onchange="handleFileSelect(event)">
                        <div class="form-text">
                            Formatos permitidos: PDF, im√°genes (JPG, PNG), documentos Word. M√°ximo 10MB por archivo.
                        </div>
                        <div id="filePreviewContainer" class="mt-2"></div>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send me-1"></i>Enviar Solicitud
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                    </div>

                </form>
            </div>
        </div>
        <!-- Historial de Solicitudes -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>Mis Solicitudes
                </h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="loadMyRequests()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Fecha Solicitud</th>
                                <th>Categor√≠a</th>
                                <th>Fechas</th>
                                <th>D√≠as</th>
                                <th>Horas</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    Cargando solicitudes...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal de C√°mara -->
    <div class="modal fade" id="cameraModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-camera me-2"></i>Capturar Foto
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <video id="videoPreview" autoplay playsinline></video>
                    <canvas id="photoCanvas" style="display: none;"></canvas>
                    <div id="capturedPhoto" style="display: none;">
                        <img id="capturedImage" class="camera-preview" alt="Foto capturada">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cerrar
                    </button>
                    <button type="button" class="btn btn-danger" id="retakeBtn" style="display: none;" onclick="retakePhoto()">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Tomar Otra
                    </button>
                    <button type="button" class="btn btn-primary" id="captureBtn" onclick="capturePhoto()">
                        <i class="bi bi-camera me-1"></i>Capturar
                    </button>
                    <button type="button" class="btn btn-success" id="savePhotoBtn" style="display: none;" onclick="savePhoto()">
                        <i class="bi bi-check-lg me-1"></i>Guardar Foto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalle de Solicitud -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle me-2"></i>Detalle de Solicitud
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailModalBody">
                    <div class="text-center py-4">
                        <span class="spinner-border"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentSession = null;
        let categories = [];
        let selectedCategory = null;
        let selectedFiles = [];
        let cameraStream = null;
        let capturedPhotoBlob = null;
        let hrConfig = null;
        let workers = [];
        
        // ==========================================
        // UTILIDADES PARA MANEJO DE FECHAS
        // ==========================================
        function formatDateForDatabase(dateString) {
            if (!dateString) return null;
            if (dateString.includes('T')) {
                return dateString.split('T')[0];
            }
            return dateString;
        }

        function getCurrentDateColombia() {
            const now = new Date();
            const colombiaOffset = -5 * 60;
            const localOffset = now.getTimezoneOffset();
            const colombiaTime = new Date(now.getTime() + (localOffset + colombiaOffset) * 60000);
            
            const year = colombiaTime.getFullYear();
            const month = String(colombiaTime.getMonth() + 1).padStart(2, '0');
            const day = String(colombiaTime.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Solicitar ausencias');
                if (!hasAccess) return;
                
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        });

        async function inicializarPagina() {
            showLoading(true);
            
            try {
                // Obtener sesi√≥n - CORREGIDO
                const sessionData = localStorage.getItem('nextSystemSession') || sessionStorage.getItem('nextSystemSession');
                
                if (!sessionData) {
                    throw new Error('No hay sesi√≥n activa');
                }
                
                currentSession = JSON.parse(sessionData);
                
                // Verificar que tenga worker_id
                if (!currentSession.worker_id) {
                    throw new Error('La sesi√≥n no tiene informaci√≥n de trabajador asociado');
                }
                
                console.log('üë§ Usuario:', currentSession.worker_name || currentSession.user_name);
                console.log('üÜî Worker ID:', currentSession.worker_id);
                
                // Cargar datos en paralelo
                await Promise.all([
                    loadHRConfig(),
                    loadCategories(),
                    loadWorkers(),
                    loadBalances(),
                    loadMyRequests()
                ]);
                
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                showMessage('Error al inicializar: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        
        // ==========================================
        // CARGAR CONFIGURACI√ìN
        // ==========================================
        async function loadHRConfig() {
            try {
                const data = await supabaseRequest('/hr_config?select=*');
                if (data && data.length > 0) {
                    hrConfig = data[0];
                    console.log('‚öôÔ∏è Configuraci√≥n cargada:', hrConfig);
                } else {
                    throw new Error('No se encontr√≥ configuraci√≥n del m√≥dulo');
                }
            } catch (error) {
                console.error('Error al cargar configuraci√≥n:', error);
                throw error;
            }
        }

        // ==========================================
        // CARGAR CATEGOR√çAS
        // ==========================================
        async function loadCategories() {
            try {
                const data = await supabaseRequest('/hr_absence_categories?is_active=eq.true&select=*&order=name');
                categories = data || [];
                
                const select = document.getElementById('categorySelect');
                select.innerHTML = '<option value="">Seleccione una categor√≠a...</option>';
                
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.category_id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
                
                console.log(`üìã ${categories.length} categor√≠as cargadas`);
                
            } catch (error) {
                console.error('Error al cargar categor√≠as:', error);
                throw error;
            }
        }

        // ==========================================
        // CARGAR TRABAJADORES (para reemplazos)
        // ==========================================
        async function loadWorkers() {
            try {
                const data = await supabaseRequest('/workers?worker_status=eq.active&select=worker_id,worker_first_name,worker_last_name_1,section_id,is_replacement&order=worker_first_name');
                workers = data || [];
                console.log(`üë• ${workers.length} trabajadores cargados`);
            } catch (error) {
                console.error('Error al cargar trabajadores:', error);
                throw error;
            }
        }
      // ==========================================
        // CARGAR SALDOS DEL USUARIO
        // ==========================================
        async function loadBalances() {
            try {
                const workerId = currentSession.worker_id;
                
                // Obtener l√≠mites de configuraci√≥n
                const personalHoursLimit = hrConfig.personal_hours_limit || 40;
                const calamityDaysLimit = hrConfig.calamity_days_limit || 3;
                
                // Calcular saldo de horas personales
                const hoursBalance = await calculateBalance(workerId, 'personal_hours');
                const availableHours = personalHoursLimit + hoursBalance.adjustments - hoursBalance.consumed;
                
                // Calcular saldo de d√≠as de calamidad
                const daysBalance = await calculateBalance(workerId, 'calamity_days');
                const availableDays = calamityDaysLimit + daysBalance.adjustments - daysBalance.consumed;
                
                // Actualizar UI
                document.getElementById('availableHours').innerHTML = `${availableHours.toFixed(2)} <small>hrs</small>`;
                document.getElementById('availableDays').innerHTML = `${availableDays.toFixed(2)} <small>d√≠as</small>`;
                
                // Guardar en variables globales para validaciones
                window.currentBalances = {
                    personalHours: availableHours,
                    calamityDays: availableDays
                };
                
                console.log('üí∞ Saldos cargados:', window.currentBalances);
                
            } catch (error) {
                console.error('Error al cargar saldos:', error);
                document.getElementById('availableHours').innerHTML = '<span class="text-danger">Error</span>';
                document.getElementById('availableDays').innerHTML = '<span class="text-danger">Error</span>';
            }
        }

        async function calculateBalance(workerId, type) {
            try {
                // Obtener ajustes manuales
                const adjustmentsData = await supabaseRequest(
                    '/hr_balance_adjustments?worker_id=eq.' + workerId + '&adjustment_type=eq.' + type + '&select=amount'
                );
                const adjustments = adjustmentsData.reduce((sum, adj) => sum + parseFloat(adj.amount || 0), 0);
                
                // Obtener consumo de ausencias aprobadas
                let consumed = 0;
                if (type === 'personal_hours') {
                    const requestsData = await supabaseRequest(
                        '/hr_absence_requests?worker_id=eq.' + workerId + '&status=eq.approved&select=total_hours,category_id'
                    );
                    
                    for (const req of requestsData) {
                        const category = categories.find(c => c.category_id === req.category_id);
                        if (category && category.accumulates_personal_hours) {
                            consumed += parseFloat(req.total_hours || 0);
                        }
                    }
                } else if (type === 'calamity_days') {
                    const requestsData = await supabaseRequest(
                        '/hr_absence_requests?worker_id=eq.' + workerId + '&status=eq.approved&select=total_days,category_id'
                    );
                    
                    for (const req of requestsData) {
                        const category = categories.find(c => c.category_id === req.category_id);
                        if (category && category.controls_calamity_days_limit) {
                            consumed += parseFloat(req.total_days || 0);
                        }
                    }
                }
                
                return { adjustments, consumed };
                
            } catch (error) {
                console.error('Error al calcular balance:', error);
                return { adjustments: 0, consumed: 0 };
            }
        }

        // ==========================================
        // CAMBIO DE CATEGOR√çA
        // ==========================================
        document.getElementById('categorySelect').addEventListener('change', function() {
            const categoryId = this.value;
            if (!categoryId) {
                document.getElementById('dynamicFields').innerHTML = '';
                document.getElementById('categoryHelp').textContent = '';
                selectedCategory = null;
                return;
            }
            
            selectedCategory = categories.find(c => c.category_id === categoryId);
            if (!selectedCategory) return;
            
            renderDynamicFields(selectedCategory);
        });

        function renderDynamicFields(category) {
            const container = document.getElementById('dynamicFields');
            let html = '';
            
            // Mostrar informaci√≥n de la categor√≠a
            let helpText = '';
            if (category.is_paid) {
                helpText += '‚úì Ausencia remunerada. ';
            }
            if (category.requires_authorization) {
                helpText += '‚úì Requiere autorizaci√≥n. ';
            }
            document.getElementById('categoryHelp').textContent = helpText;
            
            // Campos de fecha seg√∫n configuraci√≥n
            if (category.full_day_only) {
                html += `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="startDate" class="form-label required-field">Fecha Inicial</label>
                            <input type="date" class="form-control" id="startDate" required onchange="calculateTotals()">
                        </div>
                        <div class="col-md-6">
                            <label for="endDate" class="form-label required-field">Fecha Final</label>
                            <input type="date" class="form-control" id="endDate" required onchange="calculateTotals()">
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="singleDate" class="form-label required-field">Fecha</label>
                            <input type="date" class="form-control" id="singleDate" required onchange="calculateTotals()">
                        </div>
                        <div class="col-md-4">
                            <label for="startTime" class="form-label required-field">Hora Inicial</label>
                            <input type="time" class="form-control" id="startTime" required onchange="calculateTotals()">
                        </div>
                        <div class="col-md-4">
                            <label for="endTime" class="form-label required-field">Hora Final</label>
                            <input type="time" class="form-control" id="endTime" required onchange="calculateTotals()">
                        </div>
                    </div>
                `;
            }
            
            // Campo de reemplazo si es necesario
            if (category.worker_finds_replacement) {
                const currentWorker = workers.find(w => w.worker_id === currentSession.worker_id);
                const hasSection = currentWorker && currentWorker.section_id;
                
                // Filtrar trabajadores seg√∫n secci√≥n
                const filteredWorkers = workers.filter(w => {
                    if (w.worker_id === currentSession.worker_id) return false; // Excluir al usuario actual
                    if (w.is_replacement) return false; // Excluir reemplazos
                    if (hasSection) {
                        return w.section_id !== null; // Mostrar solo con secci√≥n
                    } else {
                        return w.section_id === null; // Mostrar solo sin secci√≥n
                    }
                });
                
                html += `
                    <div class="mb-3">
                        <label for="replacementWorker" class="form-label required-field">Trabajador de Reemplazo</label>
                        <select class="form-select" id="replacementWorker" required>
                            <option value="">Seleccione un reemplazo...</option>
                            ${filteredWorkers.map(w => 
                                `<option value="${w.worker_id}">${w.worker_first_name} ${w.worker_last_name_1}</option>`
                            ).join('')}
                        </select>
                        <div class="form-text">Debe buscar un reemplazo para cubrir su ausencia</div>
                    </div>
                `;
            }
            
            // Mostrar alertas de saldo si aplica
            if (category.accumulates_personal_hours || category.controls_calamity_days_limit) {
                html += '<div class="alert alert-info" id="balanceAlert"></div>';
            }
            
            // Totales calculados
            html += `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Total D√≠as</label>
                        <input type="text" class="form-control" id="totalDays" readonly value="0">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Total Horas</label>
                        <input type="text" class="form-control" id="totalHours" readonly value="0">
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Establecer fechas m√≠nimas (hoy)
            const today = getCurrentDateColombia();
            if (category.full_day_only) {
                document.getElementById('startDate').min = today;
                document.getElementById('endDate').min = today;
            } else {
                document.getElementById('singleDate').min = today;
            }
        }

        // ==========================================
        // CALCULAR TOTALES
        // ==========================================
        function calculateTotals() {
            if (!selectedCategory) return;
            
            let totalDays = 0;
            let totalHours = 0;
            
            if (selectedCategory.full_day_only) {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) return;
                
                if (new Date(endDate) < new Date(startDate)) {
                    showMessage('La fecha final debe ser mayor o igual a la fecha inicial', 'warning');
                    return;
                }
                
                // Calcular d√≠as calendario (inclusivo)
                const start = new Date(startDate);
                const end = new Date(endDate);
                totalDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                // Calcular horas por d√≠a
                const workdayStart = hrConfig.workday_start_time || '07:00:00';
                const workdayEnd = hrConfig.workday_end_time || '15:00:00';
                const hoursPerDay = calculateHoursPerDay(workdayStart, workdayEnd);
                
                totalHours = totalDays * hoursPerDay;
                
            } else {
                const singleDate = document.getElementById('singleDate').value;
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;
                
                if (!singleDate || !startTime || !endTime) return;
                
                if (endTime <= startTime) {
                    showMessage('La hora final debe ser mayor a la hora inicial', 'warning');
                    return;
                }
                
                // Calcular diferencia de horas
                const start = new Date('2000-01-01 ' + startTime);
                const end = new Date('2000-01-01 ' + endTime);
                totalHours = (end - start) / (1000 * 60 * 60);
                
                // Calcular d√≠as
                const workdayStart = hrConfig.workday_start_time || '07:00:00';
                const workdayEnd = hrConfig.workday_end_time || '15:00:00';
                const hoursPerDay = calculateHoursPerDay(workdayStart, workdayEnd);
                totalDays = totalHours / hoursPerDay;
            }
            
            // Actualizar campos
            document.getElementById('totalDays').value = totalDays.toFixed(2);
            document.getElementById('totalHours').value = totalHours.toFixed(2);
            
            // Validar saldos
            validateBalances(totalDays, totalHours);
        }

        function calculateHoursPerDay(startTime, endTime) {
            const start = new Date('2000-01-01 ' + startTime);
            const end = new Date('2000-01-01 ' + endTime);
            const hours = (end - start) / (1000 * 60 * 60);
            return hours - 1; // Restar 1 hora de almuerzo
        }

        function validateBalances(totalDays, totalHours) {
            if (!selectedCategory) return;
            
            const alertDiv = document.getElementById('balanceAlert');
            if (!alertDiv) return;
            
            let message = '';
            let hasError = false;
            
            if (selectedCategory.controls_personal_hours_limit && window.currentBalances) {
                if (totalHours > window.currentBalances.personalHours) {
                    message += `‚ö†Ô∏è <strong>Saldo insuficiente:</strong> Tienes ${window.currentBalances.personalHours.toFixed(2)} horas disponibles, est√°s solicitando ${totalHours.toFixed(2)} horas.<br>`;
                    hasError = true;
                }
            }
            
            if (selectedCategory.controls_calamity_days_limit && window.currentBalances) {
                if (totalDays > window.currentBalances.calamityDays) {
                    message += `‚ö†Ô∏è <strong>Saldo insuficiente:</strong> Tienes ${window.currentBalances.calamityDays.toFixed(2)} d√≠as de calamidad disponibles, est√°s solicitando ${totalDays.toFixed(2)} d√≠as.<br>`;
                    hasError = true;
                }
            }
            
            if (hasError) {
                alertDiv.className = 'alert alert-danger';
                alertDiv.innerHTML = message + '<strong>No podr√°s enviar esta solicitud.</strong>';
                document.querySelector('button[type="submit"]').disabled = true;
            } else {
                alertDiv.className = 'alert alert-success';
                alertDiv.innerHTML = '‚úì Tienes saldo suficiente para esta solicitud.';
                document.querySelector('button[type="submit"]').disabled = false;
            }
        }

        // ==========================================
        // MANEJO DE ARCHIVOS
        // ==========================================
        function triggerFileInput() {
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            
            for (const file of files) {
                // Validar tama√±o (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showMessage(`El archivo ${file.name} excede el tama√±o m√°ximo de 10MB`, 'warning');
                    continue;
                }
                
                // Agregar a la lista
                selectedFiles.push(file);
            }
            
            renderFilePreview();
            event.target.value = ''; // Limpiar input para permitir seleccionar el mismo archivo
        }

        function renderFilePreview() {
            const container = document.getElementById('filePreviewContainer');
            container.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const preview = document.createElement('div');
                preview.className = 'file-preview';
                
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.alt = file.name;
                    preview.appendChild(img);
                } else {
                    const icon = document.createElement('div');
                    icon.style.cssText = 'width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;';
                    icon.innerHTML = `<i class="bi bi-file-earmark-pdf" style="font-size: 2rem;"></i><br><small>${file.name}</small>`;
                    preview.appendChild(icon);
                }
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-file';
                removeBtn.innerHTML = '√ó';
                removeBtn.onclick = () => removeFile(index);
                preview.appendChild(removeBtn);
                
                container.appendChild(preview);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderFilePreview();
        }
      // ==========================================
        // MANEJO DE C√ÅMARA
        // ==========================================
        let cameraModal = null;

        async function openCamera() {
            try {
                cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
                cameraModal.show();
                
                const video = document.getElementById('videoPreview');
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' },
                    audio: false 
                });
                
                video.srcObject = cameraStream;
                video.style.display = 'block';
                document.getElementById('capturedPhoto').style.display = 'none';
                document.getElementById('captureBtn').style.display = 'inline-block';
                document.getElementById('retakeBtn').style.display = 'none';
                document.getElementById('savePhotoBtn').style.display = 'none';
                
            } catch (error) {
                console.error('Error al acceder a la c√°mara:', error);
                showMessage('No se pudo acceder a la c√°mara. Verifica los permisos.', 'danger');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('videoPreview');
            const canvas = document.getElementById('photoCanvas');
            const capturedImage = document.getElementById('capturedImage');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            canvas.toBlob(blob => {
                capturedPhotoBlob = blob;
                capturedImage.src = URL.createObjectURL(blob);
                
                video.style.display = 'none';
                document.getElementById('capturedPhoto').style.display = 'block';
                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('retakeBtn').style.display = 'inline-block';
                document.getElementById('savePhotoBtn').style.display = 'inline-block';
            }, 'image/jpeg', 0.95);
        }

        function retakePhoto() {
            const video = document.getElementById('videoPreview');
            video.style.display = 'block';
            document.getElementById('capturedPhoto').style.display = 'none';
            document.getElementById('captureBtn').style.display = 'inline-block';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('savePhotoBtn').style.display = 'none';
            capturedPhotoBlob = null;
        }

        function savePhoto() {
            if (!capturedPhotoBlob) return;
            
            const timestamp = new Date().getTime();
            const file = new File([capturedPhotoBlob], `foto_${timestamp}.jpg`, { type: 'image/jpeg' });
            selectedFiles.push(file);
            renderFilePreview();
            
            closeCamera();
            showMessage('Foto guardada exitosamente', 'success');
        }

        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            if (cameraModal) {
                cameraModal.hide();
            }
        }

        // Cerrar c√°mara cuando se cierra el modal
        document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function() {
            closeCamera();
        });

        // ==========================================
        // ENV√çO DEL FORMULARIO
        // ==========================================
        document.getElementById('absenceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!selectedCategory) {
                showMessage('Debes seleccionar una categor√≠a', 'warning');
                return;
            }
            
            // Validar campos requeridos
            if (selectedCategory.full_day_only) {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                if (!startDate || !endDate) {
                    showMessage('Debes completar las fechas', 'warning');
                    return;
                }
            } else {
                const singleDate = document.getElementById('singleDate').value;
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;
                if (!singleDate || !startTime || !endTime) {
                    showMessage('Debes completar la fecha y horas', 'warning');
                    return;
                }
            }
            
            // Validar reemplazo si es necesario
            if (selectedCategory.worker_finds_replacement) {
                const replacementId = document.getElementById('replacementWorker').value;
                if (!replacementId) {
                    showMessage('Debes seleccionar un trabajador de reemplazo', 'warning');
                    return;
                }
            }
            
            // Confirmar env√≠o
            if (!confirm('¬øEst√°s seguro de enviar esta solicitud de ausencia?')) {
                return;
            }
            
            showLoading(true);
            
            try {
                // Crear la solicitud
                const requestId = await createAbsenceRequest();
                
                // Subir archivos si hay
                if (selectedFiles.length > 0) {
                    await uploadFiles(requestId);
                }
                
                // Determinar y crear autorizaciones
                await createAuthorizations(requestId);
                
                // Enviar notificaciones
                await sendNotifications(requestId);
                
                showMessage('¬°Solicitud enviada exitosamente! Recibir√°s notificaciones sobre el estado de tu solicitud.', 'success');
                
                // Limpiar formulario y recargar
                resetForm();
                await loadBalances();
                await loadMyRequests();
                
            } catch (error) {
                console.error('Error al enviar solicitud:', error);
                showMessage('Error al enviar la solicitud: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        });

        async function createAbsenceRequest() {
            const totalDays = parseFloat(document.getElementById('totalDays').value);
            const totalHours = parseFloat(document.getElementById('totalHours').value);
            const description = document.getElementById('description').value;
            
            let requestData = {
                worker_id: currentSession.worker_id,
                category_id: selectedCategory.category_id,
                total_days: totalDays,
                total_hours: totalHours,
                description: description,
                status: 'pending'
            };
            
            if (selectedCategory.full_day_only) {
                requestData.start_date = formatDateForDatabase(document.getElementById('startDate').value);
                requestData.end_date = formatDateForDatabase(document.getElementById('endDate').value);
                requestData.is_full_day = true;
            } else {
                const singleDate = formatDateForDatabase(document.getElementById('singleDate').value);
                requestData.start_date = singleDate;
                requestData.end_date = singleDate;
                requestData.start_time = document.getElementById('startTime').value;
                requestData.end_time = document.getElementById('endTime').value;
                requestData.is_full_day = false;
            }
            
            if (selectedCategory.worker_finds_replacement) {
                requestData.replacement_worker_id = document.getElementById('replacementWorker').value;
            }
            
            const result = await supabaseRequest('/hr_absence_requests', {
                method: 'POST',
                body: JSON.stringify(requestData)
            });
            
            if (!result || result.length === 0) {
                throw new Error('No se pudo crear la solicitud');
            }
            
            console.log('‚úÖ Solicitud creada:', result[0].request_id);
            return result[0].request_id;
        }

        async function uploadFiles(requestId) {
            const year = new Date().getFullYear();
            const workerId = currentSession.worker_id;
            
            for (const file of selectedFiles) {
                try {
                    const filePath = `${year}/${workerId}/${requestId}/${file.name}`;
                    
                    // Subir archivo a Supabase Storage
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const uploadResponse = await fetch(
                        `${supabaseUrl}/storage/v1/object/hr-absence-supports/${filePath}`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${supabaseAnonKey}`
                            },
                            body: formData
                        }
                    );
                    
                    if (!uploadResponse.ok) {
                        throw new Error(`Error al subir ${file.name}`);
                    }
                    
                    // Registrar en la tabla de attachments
                    await supabaseRequest('/hr_absence_attachments', {
                        method: 'POST',
                        body: JSON.stringify({
                            request_id: requestId,
                            file_name: file.name,
                            file_path: filePath,
                            file_type: file.type,
                            file_size: file.size
                        })
                    });
                    
                    console.log('‚úÖ Archivo subido:', file.name);
                    
                } catch (error) {
                    console.error('Error al subir archivo:', file.name, error);
                }
            }
        }

        async function createAuthorizations(requestId) {
            const totalDays = parseFloat(document.getElementById('totalDays').value);
            
            // Obtener jefe principal del trabajador
            const managersData = await supabaseRequest(
                '/worker_managers?worker_id=eq.' + currentSession.worker_id + '&is_primary_manager=eq.true&assignment_status=eq.active&select=manager_id'
            );
            
            if (!managersData || managersData.length === 0) {
                throw new Error('No se encontr√≥ jefe principal asignado');
            }
            
            const authorizations = [];
            
            // NIVEL 1: Jefe principal (SIEMPRE)
            authorizations.push({
                request_id: requestId,
                authorizer_id: managersData[0].manager_id,
                authorization_level: 'primary_manager',
                status: 'pending'
            });
            
            // NIVEL 2: TH (CONDICIONAL)
            if (selectedCategory.days_require_hr_authorization && 
                totalDays >= selectedCategory.days_require_hr_authorization) {
                
                const thData = await supabaseRequest(
                    "/worker_job_roles?job_role_id=eq.062dc47e-6206-4c15-999e-c935363221e9&assignment_status=eq.active&select=worker_id"
                );
                
                if (thData && thData.length > 0) {
                    authorizations.push({
                        request_id: requestId,
                        authorizer_id: thData[0].worker_id,
                        authorization_level: 'hr',
                        status: 'pending'
                    });
                }
            }
            
            // NIVEL 3: Instancia superior (CONDICIONAL)
            if (selectedCategory.days_require_upper_authorization && 
                totalDays >= selectedCategory.days_require_upper_authorization) {
                
                const workerData = await supabaseRequest('/workers?worker_id=eq.' + currentSession.worker_id + '&select=section_id');
                const hasSection = workerData && workerData[0] && workerData[0].section_id;
                
                // Si tiene secci√≥n -> Rector√≠a, si no -> DAFI
                const roleId = hasSection ? 'a2b87928-a634-4dad-a35c-177d1a0f7fbc' : '1e188037-9e62-4140-b6dd-4273e2d84a12';
                
                const upperData = await supabaseRequest(
                    '/worker_job_roles?job_role_id=eq.' + roleId + '&assignment_status=eq.active&select=worker_id'
                );
                
                if (upperData && upperData.length > 0) {
                    authorizations.push({
                        request_id: requestId,
                        authorizer_id: upperData[0].worker_id,
                        authorization_level: 'upper_management',
                        status: 'pending'
                    });
                }
            }
            
            // Insertar todas las autorizaciones
            for (const auth of authorizations) {
                await supabaseRequest('/hr_absence_authorizations', {
                    method: 'POST',
                    body: JSON.stringify(auth)
                });
            }
            
            console.log(`‚úÖ ${authorizations.length} autorizaciones creadas`);
        }

        async function sendNotifications(requestId) {
            // Obtener autorizadores
            const authData = await supabaseRequest(
                '/hr_absence_authorizations?request_id=eq.' + requestId + '&select=authorizer_id'
            );
            
            if (!authData || authData.length === 0) return;
            
            // Obtener emails de autorizadores
            const authorizerIds = authData.map(a => a.authorizer_id);
            const workersData = await supabaseRequest(
                '/workers?worker_id=in.(' + authorizerIds.join(',') + ')&select=email,worker_first_name'
            );
            
            const emails = workersData.map(w => w.email);
            
            // Preparar contenido del email
            const requestData = selectedCategory.full_day_only ? 
                `${document.getElementById('startDate').value} al ${document.getElementById('endDate').value}` :
                `${document.getElementById('singleDate').value} de ${document.getElementById('startTime').value} a ${document.getElementById('endTime').value}`;
            
            const emailBody = `
                <h3>Nueva Solicitud de Ausencia</h3>
                <p><strong>Solicitante:</strong> ${currentSession.worker_name}</p>
                <p><strong>Categor√≠a:</strong> ${selectedCategory.name}</p>
                <p><strong>Fechas:</strong> ${requestData}</p>
                <p><strong>Total d√≠as:</strong> ${document.getElementById('totalDays').value}</p>
                <p><strong>Total horas:</strong> ${document.getElementById('totalHours').value}</p>
                <p><strong>Descripci√≥n:</strong> ${document.getElementById('description').value || 'Sin descripci√≥n'}</p>
                <p><a href="${window.location.origin}/modules/hr/authorize-absences.html">Ver y autorizar solicitud</a></p>
            `;
            
            // Enviar notificaci√≥n (funci√≥n de config.js)
            try {
                await sendNotification(
                    emails.join(','),
                    'Nueva solicitud de ausencia pendiente de autorizaci√≥n',
                    emailBody,
                    false
                );
                console.log('‚úÖ Notificaciones enviadas');
            } catch (error) {
                console.error('Error al enviar notificaciones:', error);
            }
        }

        // ==========================================
        // CARGAR HISTORIAL DE SOLICITUDES
        // ==========================================
        async function loadMyRequests() {
            try {
                const tbody = document.getElementById('requestsTableBody');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3"><span class="spinner-border spinner-border-sm"></span> Cargando...</td></tr>';
                
                const data = await supabaseRequest(
                    '/hr_absence_requests?worker_id=eq.' + currentSession.worker_id + '&select=*,hr_absence_categories(name)&order=created_at.desc'
                );
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3 text-muted">No tienes solicitudes registradas</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                data.forEach(request => {
                    const row = document.createElement('tr');
                    
                    const createdDate = new Date(request.created_at).toLocaleDateString('es-CO');
                    const categoryName = request.hr_absence_categories?.name || 'N/A';
                    
                    let dateRange = '';
                    if (request.is_full_day) {
                        dateRange = `${request.start_date} al ${request.end_date}`;
                    } else {
                        dateRange = `${request.start_date} (${request.start_time} - ${request.end_time})`;
                    }
                    
                    let statusBadge = '';
                    switch(request.status) {
                        case 'pending':
                            statusBadge = '<span class="status-badge status-pending">Pendiente</span>';
                            break;
                        case 'approved':
                            statusBadge = '<span class="status-badge status-approved">Aprobada</span>';
                            break;
                        case 'rejected':
                            statusBadge = '<span class="status-badge status-rejected">Rechazada</span>';
                            break;
                        case 'cancelled':
                            statusBadge = '<span class="status-badge status-cancelled">Cancelada</span>';
                            break;
                    }
                    
                    row.innerHTML = `
                        <td>${createdDate}</td>
                        <td>${categoryName}</td>
                        <td>${dateRange}</td>
                        <td>${request.total_days.toFixed(2)}</td>
                        <td>${request.total_hours.toFixed(2)}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewRequestDetail('${request.request_id}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                console.log(`üìã ${data.length} solicitudes cargadas`);
                
            } catch (error) {
                console.error('Error al cargar solicitudes:', error);
                const tbody = document.getElementById('requestsTableBody');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3 text-danger">Error al cargar solicitudes</td></tr>';
            }
        }

        async function viewRequestDetail(requestId) {
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            const modalBody = document.getElementById('detailModalBody');
            
            modal.show();
            modalBody.innerHTML = '<div class="text-center py-4"><span class="spinner-border"></span></div>';
            
            try {
                const data = await supabaseRequest(
                    '/hr_absence_requests?request_id=eq.' + requestId + '&select=*,hr_absence_categories(name)'
                );
                
                if (!data || data.length === 0) {
                    modalBody.innerHTML = '<p class="text-danger">No se encontr√≥ la solicitud</p>';
                    return;
                }
                
                const request = data[0];
                
                // Obtener autorizaciones
                const authData = await supabaseRequest(
                    '/hr_absence_authorizations?request_id=eq.' + requestId + '&select=*'
                );
                
                let authHTML = '<h6>Autorizaciones:</h6><ul class="list-unstyled">';
                for (const auth of authData) {
                    const workerData = await supabaseRequest('/workers?worker_id=eq.' + auth.authorizer_id + '&select=worker_first_name,worker_last_name_1');
                    const authorizerName = workerData[0] ? `${workerData[0].worker_first_name} ${workerData[0].worker_last_name_1}` : 'N/A';
                    
                    let statusIcon = '';
                    switch(auth.status) {
                        case 'pending': statusIcon = '‚è≥'; break;
                        case 'approved': statusIcon = '‚úÖ'; break;
                        case 'rejected': statusIcon = '‚ùå'; break;
                    }
                    
                    authHTML += `<li>${statusIcon} ${authorizerName} (${auth.authorization_level})</li>`;
                }
                authHTML += '</ul>';
                
                modalBody.innerHTML = `
                    <div class="mb-3">
                        <strong>Categor√≠a:</strong> ${request.hr_absence_categories?.name || 'N/A'}<br>
                        <strong>Fechas:</strong> ${request.is_full_day ? `${request.start_date} al ${request.end_date}` : `${request.start_date} (${request.start_time} - ${request.end_time})`}<br>
                        <strong>Total d√≠as:</strong> ${request.total_days.toFixed(2)}<br>
                        <strong>Total horas:</strong> ${request.total_hours.toFixed(2)}<br>
                        <strong>Estado:</strong> ${request.status}<br>
                        <strong>Descripci√≥n:</strong> ${request.description || 'Sin descripci√≥n'}
                    </div>
                    ${authHTML}
                `;
                
            } catch (error) {
                console.error('Error:', error);
                modalBody.innerHTML = '<p class="text-danger">Error al cargar detalle</p>';
            }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function resetForm() {
            document.getElementById('absenceForm').reset();
            document.getElementById('dynamicFields').innerHTML = '';
            document.getElementById('categoryHelp').textContent = '';
            selectedCategory = null;
            selectedFiles = [];
            renderFilePreview();
        }

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
