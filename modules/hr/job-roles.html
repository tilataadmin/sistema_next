<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roles y Cargos - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .card-header {
            background-color: var(--bs-light);
            border-bottom: 1px solid #dee2e6;
        }
        
        .table th {
            background-color: var(--bs-light);
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .loading-spinner {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div>Procesando...</div>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS MODERNOS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Talento Humano</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Roles y Cargos
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO MODERNO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-award me-2"></i>
                    Roles y Cargos
                </h1>
                <p class="text-muted">
                    Gesti√≥n de roles laborales y responsabilidades
                </p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" onclick="openCreateModal()">
                    <i class="bi bi-plus-circle me-1"></i>Nuevo Rol
                </button>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>
        <!-- Tarjeta principal con tabla -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>Lista de Roles y Cargos
                </h5>
                <div class="d-flex gap-2">
                    <div class="input-group input-group-sm" style="width: 250px;">
                        <input type="text" class="form-control" placeholder="Buscar rol..." id="searchInput">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchRoles()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="loadJobRoles()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Rol/Cargo</th>
                                <th>Estado</th>
                                <th>Fecha Creaci√≥n</th>
                                <th style="width: 120px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="jobRolesTableBody">
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando roles...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-award text-primary" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="totalRoles">-</h4>
                        <small class="text-muted">Total de Roles</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="activeRoles">-</h4>
                        <small class="text-muted">Roles Activos</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Crear/Editar Rol -->
    <div class="modal fade" id="jobRoleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="bi bi-plus-circle me-2"></i>Nuevo Rol
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="jobRoleForm">
                    <div class="modal-body">
                        <input type="hidden" id="roleId" name="role_id">
                        
                        <!-- Nombre del Rol -->
                        <div class="mb-3">
                            <label for="roleName" class="form-label">
                                <i class="bi bi-award me-1"></i>
                                Nombre del Rol/Cargo <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="roleName" name="role_name" 
                                   placeholder="Ej: Director Acad√©mico, Secretaria, Docente..." 
                                   required maxlength="100">
                            <div class="form-text">Ingresa un nombre descriptivo para el rol o cargo</div>
                        </div>

                        <!-- Estado -->
                        <div class="mb-3">
                            <label for="roleStatus" class="form-label">
                                <i class="bi bi-toggle-on me-1"></i>
                                Estado
                            </label>
                            <select class="form-select" id="roleStatus" name="role_status" required>
                                <option value="active">Activo</option>
                                <option value="inactive">Inactivo</option>
                            </select>
                            <div class="form-text">Los roles inactivos no estar√°n disponibles para asignaci√≥n</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Eliminar -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminaci√≥n
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¬øEst√°s seguro de que deseas eliminar el rol:</p>
                    <p class="fw-bold" id="deleteRoleName"></p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <strong>Advertencia:</strong> Esta acci√≥n no se puede deshacer.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="bi bi-trash me-1"></i>Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let allJobRoles = [];
        let currentEditingRoleId = null;
        let currentDeleteRoleId = null;

        // ==========================================
        // VALIDACI√ìN DE ACCESO A LA P√ÅGINA
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Roles y cargos');
                
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                
                // Inicializar componentes
                initializeEventListeners();
                await loadJobRoles();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================

        function initializeEventListeners() {
            // Formulario principal
            document.getElementById('jobRoleForm').addEventListener('submit', handleFormSubmit);
            
            // B√∫squeda
            document.getElementById('searchInput').addEventListener('input', debounce(searchRoles, 300));
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchRoles();
                }
            });
        }

        // Funci√≥n debounce para b√∫squeda
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        // ==========================================
        // FUNCIONES PRINCIPALES - CRUD
        // ==========================================

        async function loadJobRoles() {
            try {
                console.log('üì° Cargando roles y cargos...');
                showLoading(true);
                
                const roles = await supabaseRequest('/job_roles?select=*&order=role_name.asc');
                allJobRoles = roles || [];
                
                renderJobRolesTable(allJobRoles);
                updateStatistics();
                
                console.log(`‚úÖ ${allJobRoles.length} roles cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando roles:', error);
                showMessage('Error al cargar los roles: ' + error.message, 'danger');
                renderJobRolesTable([]);
            } finally {
                showLoading(false);
            }
        }

        function renderJobRolesTable(roles) {
            const tbody = document.getElementById('jobRolesTableBody');
            
            if (!roles || roles.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <div class="mt-2 text-muted">No se encontraron roles</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = roles.map(role => `
                <tr>
                    <td>
                        <i class="bi bi-award me-2 text-primary"></i>
                        <strong>${escapeHtml(role.role_name)}</strong>
                    </td>
                    <td>
                        <span class="badge ${role.role_status === 'active' ? 'bg-success' : 'bg-danger'}">
                            <i class="bi bi-${role.role_status === 'active' ? 'check-circle' : 'x-circle'} me-1"></i>
                            ${role.role_status === 'active' ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td>
                        <small class="text-muted">
                            ${formatDate(role.created_at)}
                        </small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" title="Editar" 
                                    onclick="editJobRole('${role.role_id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" title="Eliminar" 
                                    onclick="prepareDelete('${role.role_id}', '${escapeHtml(role.role_name)}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // ==========================================
        // FUNCIONES DE FORMULARIO
        // ==========================================

        function openCreateModal() {
            currentEditingRoleId = null;
            document.getElementById('modalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nuevo Rol';
            document.getElementById('jobRoleForm').reset();
            document.getElementById('roleStatus').value = 'active';
            
            const modal = new bootstrap.Modal(document.getElementById('jobRoleModal'));
            modal.show();
        }

        async function editJobRole(roleId) {
            try {
                const role = allJobRoles.find(r => r.role_id === roleId);
                if (!role) {
                    showMessage('Rol no encontrado', 'danger');
                    return;
                }

                currentEditingRoleId = roleId;
                document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Rol';
                
                // Llenar formulario
                document.getElementById('roleId').value = role.role_id;
                document.getElementById('roleName').value = role.role_name;
                document.getElementById('roleStatus').value = role.role_status;

                const modal = new bootstrap.Modal(document.getElementById('jobRoleModal'));
                modal.show();

            } catch (error) {
                console.error('‚ùå Error preparando edici√≥n:', error);
                showMessage('Error al preparar edici√≥n: ' + error.message, 'danger');
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            try {
                showLoading(true);
                
                const formData = new FormData(e.target);
                const roleData = {
                    role_name: formData.get('role_name').trim(),
                    role_status: formData.get('role_status')
                };

                // Validaciones
                if (!roleData.role_name) {
                    showMessage('El nombre del rol es requerido', 'danger');
                    showLoading(false);
                    return;
                }

                if (roleData.role_name.length < 2) {
                    showMessage('El nombre debe tener al menos 2 caracteres', 'danger');
                    showLoading(false);
                    return;
                }

                let response;
                if (currentEditingRoleId) {
                    // Actualizar
                    response = await supabaseRequest(`/job_roles?role_id=eq.${currentEditingRoleId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            ...roleData,
                            updated_at: new Date().toISOString()
                        })
                    });
                    showMessage('Rol actualizado exitosamente', 'success');
                } else {
                    // Crear
                    response = await supabaseRequest('/job_roles', {
                        method: 'POST',
                        body: JSON.stringify(roleData)
                    });
                    showMessage('Rol creado exitosamente', 'success');
                }

                // Cerrar modal y recargar
                bootstrap.Modal.getInstance(document.getElementById('jobRoleModal')).hide();
                await loadJobRoles();

            } catch (error) {
                console.error('‚ùå Error guardando rol:', error);
                let errorMessage = 'Error al guardar el rol';
                
                if (error.message.includes('duplicate key')) {
                    errorMessage = 'Ya existe un rol con este nombre';
                } else if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                
                showMessage(errorMessage, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // ==========================================
        // FUNCIONES DE ELIMINACI√ìN
        // ==========================================

        function prepareDelete(roleId, roleName) {
            currentDeleteRoleId = roleId;
            document.getElementById('deleteRoleName').textContent = roleName;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            modal.show();
        }

        async function confirmDelete() {
            if (!currentDeleteRoleId) return;
            
            try {
                showLoading(true);
                
                await supabaseRequest(`/job_roles?role_id=eq.${currentDeleteRoleId}`, {
                    method: 'DELETE'
                });
                
                showMessage('Rol eliminado exitosamente', 'success');
                
                // Cerrar modal y recargar
                bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
                await loadJobRoles();
                
            } catch (error) {
                console.error('‚ùå Error eliminando rol:', error);
                let errorMessage = 'Error al eliminar el rol';
                
                if (error.message.includes('foreign key')) {
                    errorMessage = 'No se puede eliminar: el rol est√° siendo utilizado por trabajadores';
                } else if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                
                showMessage(errorMessage, 'danger');
            } finally {
                showLoading(false);
                currentDeleteRoleId = null;
            }
        }
        // ==========================================
        // FUNCIONES DE B√öSQUEDA Y FILTROS
        // ==========================================

        function searchRoles() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderJobRolesTable(allJobRoles);
                return;
            }
            
            const filtered = allJobRoles.filter(role => 
                role.role_name.toLowerCase().includes(searchTerm)
            );
            
            renderJobRolesTable(filtered);
            
            if (filtered.length === 0) {
                showMessage(`No se encontraron roles que coincidan con "${searchTerm}"`, 'info');
            }
        }

        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================

        function updateStatistics() {
            const total = allJobRoles.length;
            const active = allJobRoles.filter(r => r.role_status === 'active').length;
            
            document.getElementById('totalRoles').textContent = total;
            document.getElementById('activeRoles').textContent = active;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Hacer funciones disponibles globalmente
        window.openCreateModal = openCreateModal;
        window.editJobRole = editJobRole;
        window.prepareDelete = prepareDelete;
        window.confirmDelete = confirmDelete;
        window.searchRoles = searchRoles;
        window.loadJobRoles = loadJobRoles;

        // Inicializar p√°gina con config.js
        if (window.SUPABASE_CONFIG) {
            initializePage('jobRoles', 'Talento Humano');
        } else {
            setTimeout(() => initializePage('jobRoles', 'Talento Humano'), 100);
        }
    </script>
</body>
</html>
