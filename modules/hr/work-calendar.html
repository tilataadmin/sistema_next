<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA -->
    <meta name="page-version" content="25.11.03.10.45">
    
    <title>Calendario Laboral - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .calendar-day {
            min-height: 80px;
            border: 1px solid #dee2e6;
            padding: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            background-color: #f8f9fa;
            transform: scale(1.02);
        }

        .calendar-day.weekend {
            background-color: #e9ecef;
        }

        .calendar-day.holiday {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .calendar-day.paid-break {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .calendar-day.unpaid-break {
            background-color: #ffe5cc;
            border-left: 4px solid #fd7e14;
        }

        .calendar-day.workday {
            background-color: #d1ecf1;
        }

        .calendar-day .day-number {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .calendar-day .day-label {
            font-size: 0.75rem;
            margin-top: 5px;
        }

        .calendar-month {
            margin-bottom: 2rem;
        }

        .calendar-header {
            background-color: #0d6efd;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 5px;
        }

        .period-card {
            border-left: 4px solid #0d6efd;
            margin-bottom: 10px;
        }

        .period-holiday {
            border-left-color: #dc3545;
        }

        .period-paid {
            border-left-color: #ffc107;
        }

        .period-unpaid {
            border-left-color: #fd7e14;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Talento Humano</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Calendario Laboral
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-calendar3 me-2"></i>
                    Calendario Laboral
                </h1>
                <p class="text-muted">
                    Gestiona los d√≠as laborables, festivos y recesos del a√±o acad√©mico
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- SECCI√ìN: CONTROLES -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label for="academicYearSelect" class="form-label">
                            <i class="bi bi-calendar-range me-1"></i>A√±o Acad√©mico
                        </label>
                        <select class="form-select" id="academicYearSelect" onchange="loadCalendar()">
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="viewMode" class="form-label">
                            <i class="bi bi-view-list me-1"></i>Vista
                        </label>
                        <select class="form-select" id="viewMode" onchange="changeViewMode()">
                            <option value="annual">Anual (12 meses)</option>
                            <option value="monthly">Mensual</option>
                        </select>
                    </div>
                    <div class="col-md-4" id="monthSelectorContainer" style="display: none;">
                        <label for="monthSelect" class="form-label">
                            <i class="bi bi-calendar-month me-1"></i>Mes
                        </label>
                        <select class="form-select" id="monthSelect" onchange="loadCalendar()">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <button class="btn btn-primary me-2" onclick="openCreatePeriodModal()">
                            <i class="bi bi-plus-circle me-1"></i>Nuevo Periodo
                        </button>
                        <button class="btn btn-success" onclick="preloadHolidays()">
                            <i class="bi bi-star me-1"></i>Pre-cargar Festivos Colombianos
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- LEYENDA -->
        <div class="card mb-4">
            <div class="card-body">
                <h6 class="mb-3"><i class="bi bi-palette me-2"></i>Leyenda</h6>
                <div class="d-flex flex-wrap">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e9ecef;"></div>
                        <span>Fin de semana</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #d1ecf1;"></div>
                        <span>D√≠a laboral</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f8d7da; border-left: 4px solid #dc3545;"></div>
                        <span>Festivo</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #fff3cd; border-left: 4px solid #ffc107;"></div>
                        <span>Receso remunerado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffe5cc; border-left: 4px solid #fd7e14;"></div>
                        <span>Receso no remunerado</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN: CALENDARIO -->
        <div id="calendarContainer">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <div class="mt-2">Cargando calendario...</div>
            </div>
        </div>

        <!-- SECCI√ìN: PERIODOS NO LABORABLES -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>Periodos No Laborables
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadPeriods()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                </button>
            </div>
            <div class="card-body">
                <div id="periodsContainer">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <div class="mt-2">Cargando periodos...</div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- MODAL: CREAR/EDITAR PERIODO -->
    <div class="modal fade" id="periodModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="periodModalTitle">
                        <i class="bi bi-plus-circle me-2"></i>Nuevo Periodo No Laborable
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="periodForm">
                    <div class="modal-body">
                        <input type="hidden" id="periodId">
                        
                        <div class="mb-3">
                            <label for="periodAcademicYear" class="form-label">
                                A√±o Acad√©mico <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="periodAcademicYear" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="periodType" class="form-label">
                                Tipo <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="periodType" required>
                                <option value="">Seleccione...</option>
                                <option value="holiday">Festivo</option>
                                <option value="paid_break">Receso Remunerado</option>
                                <option value="unpaid_break">Receso No Remunerado</option>
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="periodStartDate" class="form-label">
                                        Fecha Inicial <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="periodStartDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="periodEndDate" class="form-label">
                                        Fecha Final <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="periodEndDate" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="periodDescription" class="form-label">
                                Descripci√≥n <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="periodDescription" rows="3" 
                                placeholder="Ej: Semana Santa, Vacaciones de mitad de a√±o..." required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: CONFIRMAR ELIMINACI√ìN -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminaci√≥n
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¬øEst√° seguro de que desea eliminar este periodo?</p>
                    <div class="alert alert-warning">
                        <strong>Periodo:</strong> <span id="deleteModalDescription"></span><br>
                        <strong>Fechas:</strong> <span id="deleteModalDates"></span>
                    </div>
                    <p class="text-muted mb-0">Esta acci√≥n no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="bi bi-trash me-1"></i>Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: PRE-CARGAR FESTIVOS -->
    <div class="modal fade" id="holidaysModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-star me-2"></i>Pre-cargar Festivos Colombianos
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Se cargar√°n los festivos nacionales de Colombia para el a√±o seleccionado.
                        Solo se agregar√°n los festivos que no est√©n ya registrados.
                    </div>
                    
                    <div class="mb-3">
                        <label for="holidaysYear" class="form-label">
                            A√±o Acad√©mico <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="holidaysYear">
                            <option value="">Seleccione...</option>
                        </select>
                    </div>

                    <div id="holidaysPreview" style="display: none;">
                        <h6>Festivos a cargar:</h6>
                        <div id="holidaysList" class="list-group" style="max-height: 300px; overflow-y: auto;">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="generateHolidaysPreview()">
                        <i class="bi bi-eye me-1"></i>Vista Previa
                    </button>
                    <button type="button" class="btn btn-success" id="confirmHolidaysBtn" style="display: none;" onclick="confirmLoadHolidays()">
                        <i class="bi bi-check-circle me-1"></i>Cargar Festivos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let academicYears = [];
        let nonWorkDays = [];
        let currentYear = null;
        let currentMonth = null;
        let periodModalInstance = null;
        let deleteModalInstance = null;
        let holidaysModalInstance = null;
        let periodToDelete = null;

        // Festivos de Colombia - Ley Emiliani
        const colombianHolidays = {
            getHolidays: function(year) {
                const holidays = [];
                
                // Festivos de fecha fija
                holidays.push({ date: `${year}-01-01`, description: 'A√±o Nuevo' });
                holidays.push({ date: `${year}-05-01`, description: 'D√≠a del Trabajo' });
                holidays.push({ date: `${year}-07-20`, description: 'D√≠a de la Independencia' });
                holidays.push({ date: `${year}-08-07`, description: 'Batalla de Boyac√°' });
                holidays.push({ date: `${year}-12-08`, description: 'Inmaculada Concepci√≥n' });
                holidays.push({ date: `${year}-12-25`, description: 'Navidad' });
                
                // Festivos trasladables al lunes (Ley Emiliani)
                const movableHolidays = [
                    { month: 1, day: 6, description: 'Reyes Magos' },
                    { month: 3, day: 19, description: 'San Jos√©' },
                    { month: 6, day: 29, description: 'San Pedro y San Pablo' },
                    { month: 8, day: 15, description: 'Asunci√≥n de la Virgen' },
                    { month: 10, day: 12, description: 'D√≠a de la Raza' },
                    { month: 11, day: 1, description: 'Todos los Santos' },
                    { month: 11, day: 11, description: 'Independencia de Cartagena' }
                ];
                
                movableHolidays.forEach(h => {
                    const date = new Date(year, h.month - 1, h.day);
                    const dayOfWeek = date.getDay();
                    
                    // Si no es lunes, mover al siguiente lunes
                    if (dayOfWeek !== 1) {
                        const daysToAdd = dayOfWeek === 0 ? 1 : 8 - dayOfWeek;
                        date.setDate(date.getDate() + daysToAdd);
                    }
                    
                    holidays.push({
                        date: date.toISOString().split('T')[0],
                        description: h.description
                    });
                });
                
                // Semana Santa (depende del a√±o)
                const easter = this.calculateEaster(year);
                holidays.push({
                    date: new Date(easter.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    description: 'Jueves Santo'
                });
                holidays.push({
                    date: new Date(easter.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    description: 'Viernes Santo'
                });
                
                // Ascensi√≥n del Se√±or (39 d√≠as despu√©s de Pascua, trasladado al lunes)
                const ascension = new Date(easter.getTime() + 39 * 24 * 60 * 60 * 1000);
                const ascensionMonday = this.moveToMonday(ascension);
                holidays.push({
                    date: ascensionMonday.toISOString().split('T')[0],
                    description: 'Ascensi√≥n del Se√±or'
                });
                
                // Corpus Christi (60 d√≠as despu√©s de Pascua, trasladado al lunes)
                const corpus = new Date(easter.getTime() + 60 * 24 * 60 * 60 * 1000);
                const corpusMonday = this.moveToMonday(corpus);
                holidays.push({
                    date: corpusMonday.toISOString().split('T')[0],
                    description: 'Corpus Christi'
                });
                
                // Sagrado Coraz√≥n (68 d√≠as despu√©s de Pascua, trasladado al lunes)
                const sacredHeart = new Date(easter.getTime() + 68 * 24 * 60 * 60 * 1000);
                const sacredHeartMonday = this.moveToMonday(sacredHeart);
                holidays.push({
                    date: sacredHeartMonday.toISOString().split('T')[0],
                    description: 'Sagrado Coraz√≥n de Jes√∫s'
                });
                
                return holidays.sort((a, b) => a.date.localeCompare(b.date));
            },
            
            calculateEaster: function(year) {
                // Algoritmo de Meeus para calcular la Pascua
                const a = year % 19;
                const b = Math.floor(year / 100);
                const c = year % 100;
                const d = Math.floor(b / 4);
                const e = b % 4;
                const f = Math.floor((b + 8) / 25);
                const g = Math.floor((b - f + 1) / 3);
                const h = (19 * a + b - d - g + 15) % 30;
                const i = Math.floor(c / 4);
                const k = c % 4;
                const l = (32 + 2 * e + 2 * i - h - k) % 7;
                const m = Math.floor((a + 11 * h + 22 * l) / 451);
                const month = Math.floor((h + l - 7 * m + 114) / 31);
                const day = ((h + l - 7 * m + 114) % 31) + 1;
                
                return new Date(year, month - 1, day);
            },
            
            moveToMonday: function(date) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek !== 1) {
                    const daysToAdd = dayOfWeek === 0 ? 1 : 8 - dayOfWeek;
                    date.setDate(date.getDate() + daysToAdd);
                }
                return date;
            }
        };

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîí Iniciando validaci√≥n de acceso...');
            
            try {
                // PASO 1: Validar permisos
                const hasAccess = await validatePageAccess('Configurar calendario laboral');
                if (!hasAccess) return;
                
                console.log('‚úÖ Acceso validado');
                
                // PASO 2: Inicializar modales
                periodModalInstance = new bootstrap.Modal(document.getElementById('periodModal'));
                deleteModalInstance = new bootstrap.Modal(document.getElementById('deleteModal'));
                holidaysModalInstance = new bootstrap.Modal(document.getElementById('holidaysModal'));
                
                // PASO 3: Cargar a√±os acad√©micos
                await loadAcademicYears();
                
                // PASO 4: Configurar formulario
                setupForm();
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                showMessage('Error al inicializar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGA DE DATOS INICIALES
        // ==========================================
        async function loadAcademicYears() {
            try {
                const years = await supabaseRequest(
                    '/academic_years?select=year_id,year_name,start_month,start_year,end_month,end_year&order=year_order.desc',
                    { method: 'GET' }
                );
                
                academicYears = years;
                
                // Obtener el a√±o acad√©mico actual desde system_config
                const systemConfig = await supabaseRequest(
                    '/system_config?select=current_academic_year_id&limit=1',
                    { method: 'GET' }
                );
                
                const currentAcademicYearId = systemConfig && systemConfig.length > 0 ? 
                    systemConfig[0].current_academic_year_id : null;
                
                // Llenar selectores
                const selects = ['academicYearSelect', 'periodAcademicYear', 'holidaysYear'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Seleccione...</option>' +
                        years.map(y => `<option value="${y.year_id}">${y.year_name}</option>`).join('');
                });
                
                // Seleccionar el a√±o actual por defecto
                if (currentAcademicYearId) {
                    document.getElementById('academicYearSelect').value = currentAcademicYearId;
                } else if (years.length > 0) {
                    document.getElementById('academicYearSelect').value = years[0].year_id;
                }
                
                await loadCalendar();
                
            } catch (error) {
                console.error('Error cargando a√±os acad√©micos:', error);
                showMessage('Error al cargar a√±os acad√©micos: ' + error.message, 'danger');
            }
        }

        
        async function loadPeriods() {
            const selectedYear = document.getElementById('academicYearSelect').value;
            if (!selectedYear) return;
            
            try {
                // Obtener el nombre del a√±o acad√©mico
                const year = academicYears.find(y => y.year_id === selectedYear);
                if (!year) return;
                
                const periods = await supabaseRequest(
                    '/hr_non_work_days?select=*&academic_year=eq.' + encodeURIComponent(year.year_name) + '&order=start_date.asc',
                    { method: 'GET' }
                );
                
                nonWorkDays = periods;
                displayPeriods(periods);
                
            } catch (error) {
                console.error('Error cargando periodos:', error);
                showMessage('Error al cargar periodos: ' + error.message, 'danger');
            }
        }
        
        function displayPeriods(periods) {
            const container = document.getElementById('periodsContainer');
            
            if (periods.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1"></i>
                        <p class="mt-2">No hay periodos registrados para este a√±o</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = periods.map(period => {
                const typeClass = period.day_type === 'holiday' ? 'period-holiday' :
                                 period.day_type === 'paid_break' ? 'period-paid' : 'period-unpaid';
                const typeName = period.day_type === 'holiday' ? 'Festivo' :
                                period.day_type === 'paid_break' ? 'Receso Remunerado' : 'Receso No Remunerado';
                
                return `
                    <div class="card period-card ${typeClass}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">${period.description}</h6>
                                    <p class="mb-1 text-muted small">
                                        <i class="bi bi-calendar-range me-1"></i>
                                        ${formatDate(period.start_date)} - ${formatDate(period.end_date)}
                                    </p>
                                    <span class="badge bg-secondary">${typeName}</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick='editPeriod(${JSON.stringify(period)})' title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick='openDeleteModal(${JSON.stringify(period)})' title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==========================================
        // CARGA DE DATOS INICIALES
        // ==========================================
        async function loadAcademicYears() {
            try {
                const years = await supabaseRequest(
                    '/academic_years?select=year_id,year_name,start_month,start_year,end_month,end_year&order=year_order.desc',
                    { method: 'GET' }
                );
                
                academicYears = years;
                
                // Obtener el a√±o acad√©mico actual desde system_config
                const systemConfig = await supabaseRequest(
                    '/system_config?select=current_academic_year_id&limit=1',
                    { method: 'GET' }
                );
                
                const currentAcademicYearId = systemConfig && systemConfig.length > 0 ? 
                    systemConfig[0].current_academic_year_id : null;
                
                // Llenar selectores
                const selects = ['academicYearSelect', 'periodAcademicYear', 'holidaysYear'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Seleccione...</option>' +
                        years.map(y => `<option value="${y.year_id}">${y.year_name}</option>`).join('');
                });
                
                // Seleccionar el a√±o actual por defecto
                if (currentAcademicYearId) {
                    document.getElementById('academicYearSelect').value = currentAcademicYearId;
                } else if (years.length > 0) {
                    document.getElementById('academicYearSelect').value = years[0].year_id;
                }
                
                await loadCalendar();
                
            } catch (error) {
                console.error('Error cargando a√±os acad√©micos:', error);
                showMessage('Error al cargar a√±os acad√©micos: ' + error.message, 'danger');
            }
        }
        
        async function loadPeriods() {
            const selectedYear = document.getElementById('academicYearSelect').value;
            if (!selectedYear) return;
            
            try {
                // Obtener el nombre del a√±o acad√©mico
                const year = academicYears.find(y => y.year_id === selectedYear);
                if (!year) return;
                
                const periods = await supabaseRequest(
                    '/hr_non_work_days?select=*&academic_year=eq.' + encodeURIComponent(year.year_name) + '&order=start_date.asc',
                    { method: 'GET' }
                );
                
                nonWorkDays = periods;
                displayPeriods(periods);
                
            } catch (error) {
                console.error('Error cargando periodos:', error);
                showMessage('Error al cargar periodos: ' + error.message, 'danger');
            }
        }
        
        function displayPeriods(periods) {
            const container = document.getElementById('periodsContainer');
            
            if (periods.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1"></i>
                        <p class="mt-2">No hay periodos registrados para este a√±o</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = periods.map(period => {
                const typeClass = period.day_type === 'holiday' ? 'period-holiday' :
                                 period.day_type === 'paid_break' ? 'period-paid' : 'period-unpaid';
                const typeName = period.day_type === 'holiday' ? 'Festivo' :
                                period.day_type === 'paid_break' ? 'Receso Remunerado' : 'Receso No Remunerado';
                
                return `
                    <div class="card period-card ${typeClass}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">${period.description}</h6>
                                    <p class="mb-1 text-muted small">
                                        <i class="bi bi-calendar-range me-1"></i>
                                        ${formatDate(period.start_date)} - ${formatDate(period.end_date)}
                                    </p>
                                    <span class="badge bg-secondary">${typeName}</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick='editPeriod(${JSON.stringify(period)})' title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick='openDeleteModal(${JSON.stringify(period)})' title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ==========================================
        // CALENDARIO
        // ==========================================
        async function loadCalendar() {
            const yearId = document.getElementById('academicYearSelect').value;
            const viewMode = document.getElementById('viewMode').value;
            
            if (!yearId) return;
            
            showLoading(true);
            
            try {
                // Cargar periodos no laborables
                await loadPeriods();
                
                // Obtener el a√±o acad√©mico seleccionado
                const year = academicYears.find(y => y.year_id === yearId);
                if (!year) return;
                
                currentYear = year;
                
                if (viewMode === 'annual') {
                    renderAnnualCalendar(year);
                } else {
                    const month = parseInt(document.getElementById('monthSelect').value);
                    currentMonth = month;
                    renderMonthCalendar(year, month);
                }
                
            } catch (error) {
                console.error('Error cargando calendario:', error);
                showMessage('Error al cargar calendario: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        function changeViewMode() {
            const viewMode = document.getElementById('viewMode').value;
            const monthContainer = document.getElementById('monthSelectorContainer');
            
            if (viewMode === 'monthly') {
                monthContainer.style.display = 'block';
                
                // Actualizar el selector de meses seg√∫n el a√±o acad√©mico actual
                const yearId = document.getElementById('academicYearSelect').value;
                if (yearId) {
                    const year = academicYears.find(y => y.year_id === yearId);
                    if (year) {
                        updateMonthSelector(year);
                    }
                }
            } else {
                monthContainer.style.display = 'none';
            }
            
            loadCalendar();
        }
        
        function updateMonthSelector(academicYear) {
            const monthSelect = document.getElementById('monthSelect');
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const startMonth = parseInt(academicYear.start_month);
            const startYear = parseInt(academicYear.start_year);
            
            let html = '';
            let currentMonth = startMonth;
            let currentYear = startYear;
            
            // Generar opciones en orden acad√©mico (din√°mico seg√∫n BD)
            for (let i = 0; i < 12; i++) {
                const label = `${monthNames[currentMonth - 1]} ${currentYear}`;
                html += `<option value="${currentMonth}">${label}</option>`;
                
                currentMonth++;
                if (currentMonth > 12) {
                    currentMonth = 1;
                    currentYear++;
                }
            }
            
            monthSelect.innerHTML = html;
        }
        
        function renderAnnualCalendar(academicYear) {
            const container = document.getElementById('calendarContainer');
            let html = '<div class="row">';
            
            // A√±o acad√©mico din√°mico desde BD
            const startMonth = parseInt(academicYear.start_month);
            const startYear = parseInt(academicYear.start_year);
            const endMonth = parseInt(academicYear.end_month);
            const endYear = parseInt(academicYear.end_year);
            
            let currentMonth = startMonth;
            let currentYear = startYear;
            
            // Iterar por los 12 meses del a√±o acad√©mico
            for (let i = 0; i < 12; i++) {
                html += `
                    <div class="col-lg-6 col-xl-4">
                        <div class="calendar-month">
                            ${renderMonth(currentYear, currentMonth)}
                        </div>
                    </div>
                `;
                
                // Avanzar al siguiente mes
                currentMonth++;
                if (currentMonth > 12) {
                    currentMonth = 1;
                    currentYear++;
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderMonthCalendar(academicYear, monthNumber) {
            const container = document.getElementById('calendarContainer');
            
            // Determinar el a√±o correcto seg√∫n el mes
            const startMonth = parseInt(academicYear.start_month);
            const startYear = parseInt(academicYear.start_year);
            
            let year = startYear;
            if (monthNumber < startMonth) {
                year = parseInt(academicYear.end_year);
            }
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-12">
                        <div class="calendar-month">
                            ${renderMonth(year, monthNumber, true)}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderMonth(year, month, large = false) {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();
            
            let html = `
                <div class="calendar-header">
                    ${monthNames[month - 1]} ${year}
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
            `;
            
            // D√≠as de la semana
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            dayNames.forEach(day => {
                html += `<div class="text-center fw-bold small p-1">${day}</div>`;
            });
            
            // Espacios vac√≠os antes del primer d√≠a
            for (let i = 0; i < startDayOfWeek; i++) {
                html += '<div></div>';
            }
            
            // D√≠as del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dateStr = formatDateForDB(date);
                const dayInfo = getDayInfo(dateStr, date);
                
                html += `
                    <div>
                        <div class="calendar-day ${dayInfo.class}" style="min-height: ${large ? '100px' : '80px'}; height: 100%;">
                            <div class="day-number">${day}</div>
                            ${dayInfo.label ? `<div class="day-label text-truncate" title="${dayInfo.label}">${dayInfo.label}</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        function getDayInfo(dateStr, date) {
            const dayOfWeek = date.getDay();
            
            // Verificar si es fin de semana
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return { class: 'weekend', label: '' };
            }
            
            // Verificar si est√° en periodos no laborables
            for (const period of nonWorkDays) {
                if (dateStr >= period.start_date && dateStr <= period.end_date) {
                    const typeClass = period.day_type === 'holiday' ? 'holiday' :
                                     period.day_type === 'paid_break' ? 'paid-break' : 'unpaid-break';
                    return { class: typeClass, label: period.description };
                }
            }
            
            return { class: 'workday', label: '' };
        }
        
        // ==========================================
        // CRUD DE PERIODOS
        // ==========================================
        function setupForm() {
            const form = document.getElementById('periodForm');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                await savePeriod();
            });
            
            // Validar que la fecha final sea mayor o igual a la inicial
            document.getElementById('periodStartDate').addEventListener('change', validateDates);
            document.getElementById('periodEndDate').addEventListener('change', validateDates);
        }

        function validateDates() {
            const startDate = document.getElementById('periodStartDate').value;
            const endDate = document.getElementById('periodEndDate').value;
            
            if (startDate && endDate && endDate < startDate) {
                document.getElementById('periodEndDate').value = startDate;
                showMessage('La fecha final no puede ser anterior a la fecha inicial', 'warning');
            }
        }

        function openCreatePeriodModal() {
            document.getElementById('periodModalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nuevo Periodo No Laborable';
            document.getElementById('periodForm').reset();
            document.getElementById('periodId').value = '';
            
            // Pre-seleccionar el a√±o actual
            const currentYearId = document.getElementById('academicYearSelect').value;
            if (currentYearId) {
                document.getElementById('periodAcademicYear').value = currentYearId;
            }
            
            periodModalInstance.show();
        }

        function editPeriod(period) {
            document.getElementById('periodModalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Periodo No Laborable';
            document.getElementById('periodId').value = period.non_work_day_id;
            
            // Buscar el year_id que corresponda al academic_year
            const year = academicYears.find(y => y.year_name === period.academic_year);
            if (year) {
                document.getElementById('periodAcademicYear').value = year.year_id;
            }
            
            document.getElementById('periodType').value = period.day_type;
            document.getElementById('periodStartDate').value = period.start_date;
            document.getElementById('periodEndDate').value = period.end_date;
            document.getElementById('periodDescription').value = period.description;
            
            periodModalInstance.show();
        }

        async function savePeriod() {
            const periodId = document.getElementById('periodId').value;
            const academicYearId = document.getElementById('periodAcademicYear').value;
            const periodType = document.getElementById('periodType').value;
            const startDate = document.getElementById('periodStartDate').value;
            const endDate = document.getElementById('periodEndDate').value;
            const description = document.getElementById('periodDescription').value.trim();
            
            if (!academicYearId || !periodType || !startDate || !endDate || !description) {
                showMessage('Complete todos los campos requeridos', 'warning');
                return;
            }
            
            // Obtener el nombre del a√±o acad√©mico
            const year = academicYears.find(y => y.year_id === academicYearId);
            if (!year) {
                showMessage('A√±o acad√©mico no v√°lido', 'danger');
                return;
            }
            
            try {
                showLoading(true);
                
                const periodData = {
                    academic_year: year.year_name,
                    day_type: periodType,
                    start_date: startDate,
                    end_date: endDate,
                    description: description
                };
                
                if (periodId) {
                    // Actualizar
                    await supabaseRequest('/hr_non_work_days?non_work_day_id=eq.' + periodId, {
                        method: 'PATCH',
                        body: JSON.stringify(periodData)
                    });
                    showMessage('Periodo actualizado correctamente', 'success');
                } else {
                    // Crear
                    await supabaseRequest('/hr_non_work_days', {
                        method: 'POST',
                        body: JSON.stringify(periodData)
                    });
                    showMessage('Periodo creado correctamente', 'success');
                }
                
                periodModalInstance.hide();
                await loadCalendar();
                
            } catch (error) {
                console.error('Error guardando periodo:', error);
                showMessage('Error al guardar el periodo: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        
        function openDeleteModal(period) {
            periodToDelete = period;
            document.getElementById('deleteModalDescription').textContent = period.description;
            document.getElementById('deleteModalDates').textContent = 
                `${formatDate(period.start_date)} - ${formatDate(period.end_date)}`;
            deleteModalInstance.show();
        }

        async function confirmDelete() {
            if (!periodToDelete) return;
            
            try {
                showLoading(true);
                
                await supabaseRequest('/hr_non_work_days?non_work_day_id=eq.' + periodToDelete.non_work_day_id, {
                    method: 'DELETE'
                });
                
                showMessage('Periodo eliminado correctamente', 'success');
                deleteModalInstance.hide();
                await loadCalendar();
                
            } catch (error) {
                console.error('Error eliminando periodo:', error);
                showMessage('Error al eliminar el periodo: ' + error.message, 'danger');
            } finally {
                showLoading(false);
                periodToDelete = null;
            }
        }

        
        // ==========================================
        // PRE-CARGA DE FESTIVOS COLOMBIANOS
        // ==========================================
        function preloadHolidays() {
            const yearId = document.getElementById('academicYearSelect').value;
            if (yearId) {
                document.getElementById('holidaysYear').value = yearId;
            }
            
            document.getElementById('holidaysPreview').style.display = 'none';
            document.getElementById('confirmHolidaysBtn').style.display = 'none';
            
            holidaysModalInstance.show();
        }

        function generateHolidaysPreview() {
            const yearId = document.getElementById('holidaysYear').value;
            if (!yearId) {
                showMessage('Seleccione un a√±o acad√©mico', 'warning');
                return;
            }
            
            const year = academicYears.find(y => y.year_id === yearId);
            if (!year) return;
            
            console.log('Generando festivos para:', year);
            
            // Generar festivos para ambos a√±os calendario que componen el a√±o acad√©mico
            const startYear = parseInt(year.start_year);
            const endYear = parseInt(year.end_year);
            const startMonth = parseInt(year.start_month);
            const endMonth = parseInt(year.end_month);
            
            let holidays = [];
            
            // Festivos del primer a√±o calendario
            const firstYearHolidays = colombianHolidays.getHolidays(startYear);
            console.log('Festivos totales a√±o ' + startYear + ':', firstYearHolidays.length);
            
            // Filtrar festivos del primer a√±o (desde start_month hasta diciembre)
            firstYearHolidays.forEach(h => {
                const month = parseInt(h.date.split('-')[1]);
                if (month >= startMonth) {
                    holidays.push(h);
                }
            });
            
            console.log('Festivos filtrados del primer a√±o:', holidays.length);
            
            // Festivos del segundo a√±o calendario
            const secondYearHolidays = colombianHolidays.getHolidays(endYear);
            console.log('Festivos totales a√±o ' + endYear + ':', secondYearHolidays.length);
            
            // Filtrar festivos del segundo a√±o (desde enero hasta end_month)
            secondYearHolidays.forEach(h => {
                const month = parseInt(h.date.split('-')[1]);
                if (month <= endMonth) {
                    holidays.push(h);
                }
            });
            
            console.log('Total festivos despu√©s del segundo a√±o:', holidays.length);
            
            // Ordenar por fecha
            holidays.sort((a, b) => a.date.localeCompare(b.date));
            
            // Filtrar festivos que ya existen
            const existingDates = nonWorkDays
                .filter(p => p.day_type === 'holiday' && p.academic_year === year.year_name)
                .map(p => p.start_date);
            
            console.log('Festivos ya registrados:', existingDates.length);
            
            const newHolidays = holidays.filter(h => !existingDates.includes(h.date));
            
            console.log('Festivos nuevos a cargar:', newHolidays.length);
            
            if (newHolidays.length === 0) {
                showMessage('Todos los festivos ya est√°n registrados para este a√±o', 'info');
                document.getElementById('holidaysPreview').style.display = 'none';
                document.getElementById('confirmHolidaysBtn').style.display = 'none';
                return;
            }
            
            const listHtml = newHolidays.map(h => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${h.description}</strong>
                            <br>
                            <small class="text-muted">${formatDate(h.date)}</small>
                        </div>
                        <span class="badge bg-danger">Festivo</span>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('holidaysList').innerHTML = listHtml;
            document.getElementById('holidaysPreview').style.display = 'block';
            document.getElementById('confirmHolidaysBtn').style.display = 'inline-block';
        }
        
        async function confirmLoadHolidays() {
            const yearId = document.getElementById('holidaysYear').value;
            if (!yearId) return;
            
            const year = academicYears.find(y => y.year_id === yearId);
            if (!year) return;
            
            // Generar festivos para ambos a√±os calendario
            const startYear = parseInt(year.start_year);
            const endYear = parseInt(year.end_year);
            const startMonth = parseInt(year.start_month);
            const endMonth = parseInt(year.end_month);
            
            let holidays = [];
            
            // Festivos del primer a√±o (desde start_month hasta diciembre)
            const firstYearHolidays = colombianHolidays.getHolidays(startYear);
            firstYearHolidays.forEach(h => {
                const month = parseInt(h.date.split('-')[1]);
                if (month >= startMonth) {
                    holidays.push(h);
                }
            });
            
            // Festivos del segundo a√±o (desde enero hasta end_month)
            const secondYearHolidays = colombianHolidays.getHolidays(endYear);
            secondYearHolidays.forEach(h => {
                const month = parseInt(h.date.split('-')[1]);
                if (month <= endMonth) {
                    holidays.push(h);
                }
            });
            
            // Filtrar festivos que ya existen
            const existingDates = nonWorkDays
                .filter(p => p.day_type === 'holiday' && p.academic_year === year.year_name)
                .map(p => p.start_date);
            
            const newHolidays = holidays.filter(h => !existingDates.includes(h.date));
            
            if (newHolidays.length === 0) {
                showMessage('No hay festivos nuevos para cargar', 'info');
                holidaysModalInstance.hide();
                return;
            }
            
            try {
                showLoading(true);
                
                for (const holiday of newHolidays) {
                    const periodData = {
                        academic_year: year.year_name,
                        day_type: 'holiday',
                        start_date: holiday.date,
                        end_date: holiday.date,
                        description: holiday.description
                    };
                    
                    await supabaseRequest('/hr_non_work_days', {
                        method: 'POST',
                        body: JSON.stringify(periodData)
                    });
                }
                
                showMessage(`Se cargaron ${newHolidays.length} festivos correctamente`, 'success');
                holidaysModalInstance.hide();
                await loadCalendar();
                
            } catch (error) {
                console.error('Error cargando festivos:', error);
                showMessage('Error al cargar festivos: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function formatDateForDB(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

    </script>
</body>
</html>
