<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA -->
    <meta name="page-version" content="25.11.03.11.00">
    
    <title>Reportes de Ausencias - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .metric-card {
            border-left: 4px solid #0d6efd;
            transition: all 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0d6efd;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6c757d;
            text-transform: uppercase;
        }

        .alert-danger-custom {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .alert-warning-custom {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .alert-success-custom {
            background-color: #d1e7dd;
            border-left: 4px solid #198754;
        }

        .progress-thin {
            height: 8px;
        }

        .table-sm-custom td, .table-sm-custom th {
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .filter-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .badge-metric {
            font-size: 0.75rem;
            padding: 0.35rem 0.65rem;
        }

        .inconsistency-row {
            background-color: #fff3cd;
        }

        .nav-tabs .nav-link {
            color: #495057;
        }

        .nav-tabs .nav-link.active {
            font-weight: 600;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Generando reporte...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Talento Humano</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Reportes de Ausencias
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-graph-up me-2"></i>
                    Reportes de Ausencias
                </h1>
                <p class="text-muted">
                    An√°lisis y estad√≠sticas de asistencia y ausencias del personal
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- TABS DE REPORTES -->
        <ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-report1" data-bs-toggle="tab" data-bs-target="#report1" type="button" role="tab">
                    <i class="bi bi-calendar-check me-1"></i>Asistencia vs Ausencias
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-report2" data-bs-toggle="tab" data-bs-target="#report2" type="button" role="tab">
                    <i class="bi bi-speedometer2 me-1"></i>Control de L√≠mites
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-report3" data-bs-toggle="tab" data-bs-target="#report3" type="button" role="tab">
                    <i class="bi bi-pie-chart me-1"></i>Por Categor√≠a
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-report4" data-bs-toggle="tab" data-bs-target="#report4" type="button" role="tab">
                    <i class="bi bi-exclamation-triangle me-1"></i>Inconsistencias
                </button>
            </li>
        </ul>

        <!-- CONTENIDO DE TABS -->
        <div class="tab-content" id="reportTabsContent">

          <!-- ========================================= -->
            <!-- REPORTE 1: ASISTENCIA VS AUSENCIAS -->
            <!-- ========================================= -->
            <div class="tab-pane fade show active" id="report1" role="tabpanel">
                
                <!-- Filtros -->
                <div class="filter-panel">
                    <h5 class="mb-3"><i class="bi bi-funnel me-2"></i>Filtros</h5>
                    <form id="report1Form">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="r1_startDate" class="form-label">Fecha Inicio <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="r1_startDate" required>
                            </div>
                            <div class="col-md-3">
                                <label for="r1_endDate" class="form-label">Fecha Fin <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="r1_endDate" required>
                            </div>
                            <div class="col-md-3">
                                <label for="r1_worker" class="form-label">Trabajador</label>
                                <select class="form-select" id="r1_worker">
                                    <option value="">Todos los trabajadores</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="r1_section" class="form-label">Secci√≥n</label>
                                <select class="form-select" id="r1_section">
                                    <option value="">Todas las secciones</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-play-fill me-1"></i>Generar Reporte
                                </button>
                                <button type="button" class="btn btn-success" onclick="exportReport1ToExcel()" id="btnExportR1" style="display: none;">
                                    <i class="bi bi-file-earmark-excel me-1"></i>Exportar a Excel
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Resultados -->
                <div id="report1Results" style="display: none;">
                    
                    <!-- M√©tricas Resumen -->
                    <div class="row mb-4" id="report1Metrics">
                        <!-- Se llenan din√°micamente -->
                    </div>

                    <!-- Tabla de Resultados -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-table me-2"></i>Detalle por Trabajador</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm-custom mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Trabajador</th>
                                            <th>Secci√≥n</th>
                                            <th>D√≠as Laborables</th>
                                            <th>D√≠as Asisti√≥</th>
                                            <th>D√≠as Ausencia Aprobada</th>
                                            <th>D√≠as Injustificados</th>
                                            <th>% Ausentismo</th>
                                            <th>Inconsistencias</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report1Table">
                                        <!-- Se llena din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Placeholder inicial -->
                <div id="report1Placeholder" class="text-center py-5">
                    <i class="bi bi-bar-chart fs-1 text-muted"></i>
                    <p class="text-muted mt-3">Configure los filtros y haga clic en "Generar Reporte"</p>
                </div>

            </div>

            <!-- ========================================= -->
            <!-- REPORTE 2: CONTROL DE L√çMITES -->
            <!-- ========================================= -->
            <div class="tab-pane fade" id="report2" role="tabpanel">
                
                <!-- Filtros -->
                <div class="filter-panel">
                    <h5 class="mb-3"><i class="bi bi-funnel me-2"></i>Filtros</h5>
                    <form id="report2Form">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="r2_worker" class="form-label">Trabajador</label>
                                <select class="form-select" id="r2_worker">
                                    <option value="">Todos los trabajadores</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="r2_section" class="form-label">Secci√≥n</label>
                                <select class="form-select" id="r2_section">
                                    <option value="">Todas las secciones</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="r2_onlyAlerts">
                                    <label class="form-check-label" for="r2_onlyAlerts">
                                        Solo mostrar alertas (saldo < 20%)
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-play-fill me-1"></i>Generar Reporte
                                </button>
                                <button type="button" class="btn btn-success" onclick="exportReport2ToExcel()" id="btnExportR2" style="display: none;">
                                    <i class="bi bi-file-earmark-excel me-1"></i>Exportar a Excel
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Resultados -->
                <div id="report2Results" style="display: none;">
                    
                    <!-- Tabla de Resultados -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Estado de Saldos</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm-custom mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Trabajador</th>
                                            <th>Secci√≥n</th>
                                            <th>Horas Personales</th>
                                            <th>% Usado (Horas)</th>
                                            <th>D√≠as Calamidad</th>
                                            <th>% Usado (D√≠as)</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report2Table">
                                        <!-- Se llena din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Placeholder inicial -->
                <div id="report2Placeholder" class="text-center py-5">
                    <i class="bi bi-speedometer2 fs-1 text-muted"></i>
                    <p class="text-muted mt-3">Configure los filtros y haga clic en "Generar Reporte"</p>
                </div>

            </div>

            <!-- ========================================= -->
            <!-- REPORTE 3: AUSENCIAS POR CATEGOR√çA -->
            <!-- ========================================= -->
            <div class="tab-pane fade" id="report3" role="tabpanel">
                
                <!-- Filtros -->
                <div class="filter-panel">
                    <h5 class="mb-3"><i class="bi bi-funnel me-2"></i>Filtros</h5>
                    <form id="report3Form">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="r3_startDate" class="form-label">Fecha Inicio <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="r3_startDate" required>
                            </div>
                            <div class="col-md-3">
                                <label for="r3_endDate" class="form-label">Fecha Fin <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="r3_endDate" required>
                            </div>
                            <div class="col-md-3">
                                <label for="r3_category" class="form-label">Categor√≠a</label>
                                <select class="form-select" id="r3_category">
                                    <option value="">Todas las categor√≠as</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="r3_status" class="form-label">Estado</label>
                                <select class="form-select" id="r3_status">
                                    <option value="">Todos los estados</option>
                                    <option value="pending">Pendiente</option>
                                    <option value="approved">Aprobada</option>
                                    <option value="rejected">Rechazada</option>
                                    <option value="cancelled">Cancelada</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-play-fill me-1"></i>Generar Reporte
                                </button>
                                <button type="button" class="btn btn-success" onclick="exportReport3ToExcel()" id="btnExportR3" style="display: none;">
                                    <i class="bi bi-file-earmark-excel me-1"></i>Exportar a Excel
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Resultados -->
                <div id="report3Results" style="display: none;">
                    
                    <!-- Gr√°fico de Tendencias -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Tendencia Mensual</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="report3Chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Resultados -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-table me-2"></i>An√°lisis por Categor√≠a</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm-custom mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Categor√≠a</th>
                                            <th>Total Solicitudes</th>
                                            <th>Aprobadas</th>
                                            <th>Rechazadas</th>
                                            <th>Pendientes</th>
                                            <th>Total D√≠as</th>
                                            <th>Total Horas</th>
                                            <th>Top Usuarios</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report3Table">
                                        <!-- Se llena din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Placeholder inicial -->
                <div id="report3Placeholder" class="text-center py-5">
                    <i class="bi bi-pie-chart fs-1 text-muted"></i>
                    <p class="text-muted mt-3">Configure los filtros y haga clic en "Generar Reporte"</p>
                </div>

            </div>

            <!-- ========================================= -->
            <!-- REPORTE 4: INCONSISTENCIAS -->
            <!-- ========================================= -->
            <div class="tab-pane fade" id="report4" role="tabpanel">
                
                <!-- Filtros -->
                <div class="filter-panel">
                    <h5 class="mb-3"><i class="bi bi-funnel me-2"></i>Filtros</h5>
                    <form id="report4Form">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="r4_startDate" class="form-label">Fecha Inicio <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="r4_startDate" required>
                            </div>
                            <div class="col-md-4">
                                <label for="r4_endDate" class="form-label">Fecha Fin <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="r4_endDate" required>
                            </div>
                            <div class="col-md-4">
                                <label for="r4_worker" class="form-label">Trabajador</label>
                                <select class="form-select" id="r4_worker">
                                    <option value="">Todos los trabajadores</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-play-fill me-1"></i>Generar Reporte
                                </button>
                                <button type="button" class="btn btn-success" onclick="exportReport4ToExcel()" id="btnExportR4" style="display: none;">
                                    <i class="bi bi-file-earmark-excel me-1"></i>Exportar a Excel
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Resultados -->
                <div id="report4Results" style="display: none;">
                    
                    <!-- Alerta si hay inconsistencias -->
                    <div class="alert alert-warning" id="report4Alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Se encontraron <strong id="report4Count">0</strong> inconsistencias en el per√≠odo seleccionado.
                    </div>

                    <!-- Tabla de Resultados -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Inconsistencias Detectadas</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm-custom mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Trabajador</th>
                                            <th>Fecha</th>
                                            <th>Categor√≠a Ausencia</th>
                                            <th>Hora Registro</th>
                                            <th>M√©todo Registro</th>
                                            <th>Registrado Por</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report4Table">
                                        <!-- Se llena din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Placeholder inicial -->
                <div id="report4Placeholder" class="text-center py-5">
                    <i class="bi bi-exclamation-triangle fs-1 text-muted"></i>
                    <p class="text-muted mt-3">Configure los filtros y haga clic en "Generar Reporte"</p>
                </div>

            </div>

        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let allWorkers = [];
        let allSections = [];
        let allCategories = [];
        let hrConfig = null;
        let report1Data = [];
        let report2Data = [];
        let report3Data = [];
        let report4Data = [];
        let chartInstance = null;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîí Iniciando validaci√≥n de acceso...');
            
            try {
                // PASO 1: Validar permisos
                const hasAccess = await validatePageAccess('Ver reportes de ausencias');
                if (!hasAccess) return;
                
                console.log('‚úÖ Acceso validado');
                
                // PASO 2: Cargar datos iniciales
                await loadInitialData();
                
                // PASO 3: Configurar formularios
                setupForms();
                
                // PASO 4: Establecer fechas por defecto (√∫ltimo mes)
                setDefaultDates();
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                showMessage('Error al inicializar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGA DE DATOS INICIALES
        // ==========================================
        async function loadInitialData() {
            try {
                showLoading(true);
                
                // Cargar trabajadores activos
                allWorkers = await supabaseRequest(
                    '/workers?select=worker_id,worker_id_doc,worker_first_name,worker_last_name_1,worker_last_name_2,section_id,sections(section_name),organizational_division_id,organizational_cost_center_id,organizational_area_id&worker_status=eq.active&order=worker_first_name.asc',
                    { method: 'GET' }
                );
                
                // Cargar secciones
                allSections = await supabaseRequest(
                    '/sections?select=section_id,section_name&order=section_name.asc',
                    { method: 'GET' }
                );
                
                // Cargar categor√≠as de ausencias
                allCategories = await supabaseRequest(
                    '/hr_absence_categories?select=category_id,name&is_active=eq.true&order=name.asc',
                    { method: 'GET' }
                );
                
                // Cargar configuraci√≥n de HR
                const configs = await supabaseRequest(
                    '/hr_config?select=*&limit=1',
                    { method: 'GET' }
                );
                hrConfig = configs && configs.length > 0 ? configs[0] : null;
                
                // Llenar selectores
                populateSelectors();
                
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
                showMessage('Error al cargar datos: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function populateSelectors() {
            // Llenar selectores de trabajadores
            const workerSelects = ['r1_worker', 'r2_worker', 'r4_worker'];
            workerSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Todos los trabajadores</option>' +
                    allWorkers.map(w => {
                        const fullName = `${w.worker_first_name} ${w.worker_last_name_1} ${w.worker_last_name_2 || ''}`;
                        return `<option value="${w.worker_id}">${fullName}</option>`;
                    }).join('');
            });
            
            // Llenar selectores de secciones
            const sectionSelects = ['r1_section', 'r2_section'];
            sectionSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Todas las secciones</option>' +
                    allSections.map(s => `<option value="${s.section_id}">${s.section_name}</option>`).join('');
            });
            
            // Llenar selector de categor√≠as
            const categorySelect = document.getElementById('r3_category');
            categorySelect.innerHTML = '<option value="">Todas las categor√≠as</option>' +
                allCategories.map(c => `<option value="${c.category_id}">${c.name}</option>`).join('');
        }

        function setDefaultDates() {
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
            
            // Reporte 1
            document.getElementById('r1_startDate').value = formatDateForInput(lastMonth);
            document.getElementById('r1_endDate').value = formatDateForInput(lastMonthEnd);
            
            // Reporte 3
            document.getElementById('r3_startDate').value = formatDateForInput(lastMonth);
            document.getElementById('r3_endDate').value = formatDateForInput(lastMonthEnd);
            
            // Reporte 4
            document.getElementById('r4_startDate').value = formatDateForInput(lastMonth);
            document.getElementById('r4_endDate').value = formatDateForInput(lastMonthEnd);
        }

        // ==========================================
        // CONFIGURACI√ìN DE FORMULARIOS
        // ==========================================
        function setupForms() {
            document.getElementById('report1Form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await generateReport1();
            });
            
            document.getElementById('report2Form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await generateReport2();
            });
            
            document.getElementById('report3Form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await generateReport3();
            });
            
            document.getElementById('report4Form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await generateReport4();
            });
        }

        // ==========================================
        // FUNCI√ìN: CALCULAR D√çAS LABORABLES
        // ==========================================
        async function calculateWorkDays(startDate, endDate) {
            let workDays = 0;
            
            // Obtener periodos no laborables
            const nonWorkDays = await supabaseRequest(
                '/hr_non_work_days?select=start_date,end_date,day_type',
                { method: 'GET' }
            );
            
            // Iterar cada d√≠a del rango
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dayOfWeek = d.getDay();
                const dateStr = formatDateForDB(new Date(d));
                
                // Excluir fines de semana
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    continue;
                }
                
                // Excluir d√≠as no laborables
                let isNonWorkDay = false;
                for (const period of nonWorkDays) {
                    if (dateStr >= period.start_date && dateStr <= period.end_date) {
                        isNonWorkDay = true;
                        break;
                    }
                }
                
                if (!isNonWorkDay) {
                    workDays++;
                }
            }
            
            return workDays;
        }

        // ==========================================
        // FUNCI√ìN: OBTENER D√çAS DE ASISTENCIA
        // ==========================================
        async function getAttendanceDays(workerIdDoc, startDate, endDate) {
            const attendances = await supabaseRequest(
                '/attendance?select=attendance_date,registro_tipo&person_id_document=eq.' + 
                encodeURIComponent(workerIdDoc) + 
                '&person_type=eq.worker&attendance_date=gte.' + startDate + 
                '&attendance_date=lte.' + endDate +
                '&order=attendance_date.asc,attendance_time.asc',
                { method: 'GET' }
            );
            
            // Contar solo d√≠as con al menos una entrada
            const daysWithEntry = new Set();
            attendances.forEach(att => {
                if (att.registro_tipo === 'entrada') {
                    daysWithEntry.add(att.attendance_date);
                }
            });
            
            return daysWithEntry;
        }

        // ==========================================
        // FUNCI√ìN: OBTENER D√çAS DE AUSENCIA APROBADA
        // ==========================================
        async function getAbsenceDays(workerId, startDate, endDate) {
            const absences = await supabaseRequest(
                '/hr_absence_requests?select=*,category:hr_absence_categories(*)&worker_id=eq.' + 
                workerId + '&status=eq.approved&start_date=lte.' + endDate + 
                '&end_date=gte.' + startDate,
                { method: 'GET' }
            );
            
            const absenceDays = new Set();
            
            absences.forEach(absence => {
                if (absence.is_full_day) {
                    // Iterar cada d√≠a de la ausencia
                    const start = new Date(absence.start_date + 'T00:00:00');
                    const end = new Date(absence.end_date + 'T00:00:00');
                    
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        // Solo contar d√≠as laborables
                        const dayOfWeek = d.getDay();
                        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                            absenceDays.add(formatDateForDB(new Date(d)));
                        }
                    }
                }
            });
            
            return absenceDays;
        }

        // ==========================================
        // FUNCI√ìN: CALCULAR SALDOS
        // ==========================================
        async function calculateBalances(workerId) {
            try {
                // Obtener ajustes
                const adjustments = await supabaseRequest(
                    '/hr_balance_adjustments?select=adjustment_type,amount&worker_id=eq.' + workerId,
                    { method: 'GET' }
                );
                
                let personalHours = 0;
                let calamityDays = 0;
                
                adjustments.forEach(adj => {
                    if (adj.adjustment_type === 'personal_hours') {
                        personalHours += parseFloat(adj.amount);
                    } else if (adj.adjustment_type === 'calamity_days') {
                        calamityDays += parseFloat(adj.amount);
                    }
                });
                
                // Obtener ausencias aprobadas
                const absences = await supabaseRequest(
                    '/hr_absence_requests?select=total_hours,total_days,category_id&worker_id=eq.' + 
                    workerId + '&status=eq.approved',
                    { method: 'GET' }
                );
                
                // Obtener categor√≠as para saber cu√°les consumen saldo
                const categories = await supabaseRequest(
                    '/hr_absence_categories?select=category_id,accumulates_personal_hours,controls_calamity_days_limit',
                    { method: 'GET' }
                );
                
                const categoryMap = {};
                categories.forEach(cat => {
                    categoryMap[cat.category_id] = cat;
                });
                
                // Restar ausencias que consumen del saldo
                absences.forEach(absence => {
                    const category = categoryMap[absence.category_id];
                    if (category) {
                        if (category.accumulates_personal_hours) {
                            personalHours -= parseFloat(absence.total_hours || 0);
                        }
                        if (category.controls_calamity_days_limit) {
                            calamityDays -= parseFloat(absence.total_days || 0);
                        }
                    }
                });
                
                return {
                    personalHours: personalHours,
                    calamityDays: calamityDays
                };
                
            } catch (error) {
                console.error('Error calculando saldos:', error);
                return { personalHours: 0, calamityDays: 0 };
            }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit' 
            });
        }

        function formatDateForDB(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForInput(date) {
            return formatDateForDB(date);
        }

        function getWorkerFullName(worker) {
            return `${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}`.trim();
        }

        function getSectionName(worker) {
            return worker.sections?.section_name || 'Sin secci√≥n';
        }
      // ==========================================
        // REPORTE 1: ASISTENCIA VS AUSENCIAS
        // ==========================================
        async function generateReport1() {
            const startDate = document.getElementById('r1_startDate').value;
            const endDate = document.getElementById('r1_endDate').value;
            const workerId = document.getElementById('r1_worker').value;
            const sectionId = document.getElementById('r1_section').value;
            
            if (!startDate || !endDate) {
                showMessage('Complete las fechas requeridas', 'warning');
                return;
            }
            
            try {
                showLoading(true);
                
                // Filtrar trabajadores seg√∫n criterios
                let workers = allWorkers;
                if (workerId) {
                    workers = workers.filter(w => w.worker_id === workerId);
                }
                if (sectionId) {
                    workers = workers.filter(w => w.section_id === sectionId);
                }
                
                // Calcular d√≠as laborables del per√≠odo
                const totalWorkDays = await calculateWorkDays(startDate, endDate);
                
                // Procesar cada trabajador
                const results = [];
                let totalAttendance = 0;
                let totalAbsences = 0;
                let totalUnjustified = 0;
                let totalInconsistencies = 0;
                
                for (const worker of workers) {
                    // D√≠as con asistencia
                    const attendanceDays = await getAttendanceDays(worker.worker_id_doc, startDate, endDate);
                    
                    // D√≠as con ausencia aprobada
                    const absenceDays = await getAbsenceDays(worker.worker_id, startDate, endDate);
                    
                    // Detectar inconsistencias (d√≠a con ausencia Y asistencia)
                    const inconsistencies = [];
                    absenceDays.forEach(day => {
                        if (attendanceDays.has(day)) {
                            inconsistencies.push(day);
                        }
                    });
                    
                    // Calcular d√≠as injustificados
                    const unjustifiedDays = totalWorkDays - attendanceDays.size - absenceDays.size;
                    
                    // Calcular porcentaje de ausentismo
                    const absenteeismPercent = totalWorkDays > 0 ? 
                        ((absenceDays.size / totalWorkDays) * 100).toFixed(2) : 0;
                    
                    results.push({
                        worker: worker,
                        workDays: totalWorkDays,
                        attendanceDays: attendanceDays.size,
                        absenceDays: absenceDays.size,
                        unjustifiedDays: unjustifiedDays > 0 ? unjustifiedDays : 0,
                        absenteeismPercent: absenteeismPercent,
                        inconsistencies: inconsistencies.length
                    });
                    
                    totalAttendance += attendanceDays.size;
                    totalAbsences += absenceDays.size;
                    totalUnjustified += (unjustifiedDays > 0 ? unjustifiedDays : 0);
                    totalInconsistencies += inconsistencies.length;
                }
                
                report1Data = results;
                
                // Mostrar m√©tricas
                displayReport1Metrics(workers.length, totalWorkDays, totalAttendance, totalAbsences, totalUnjustified, totalInconsistencies);
                
                // Mostrar tabla
                displayReport1Table(results);
                
                // Mostrar secci√≥n de resultados
                document.getElementById('report1Placeholder').style.display = 'none';
                document.getElementById('report1Results').style.display = 'block';
                document.getElementById('btnExportR1').style.display = 'inline-block';
                
            } catch (error) {
                console.error('Error generando reporte 1:', error);
                showMessage('Error al generar el reporte: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function displayReport1Metrics(workers, workDays, attendance, absences, unjustified, inconsistencies) {
            const container = document.getElementById('report1Metrics');
            container.innerHTML = `
                <div class="col-md-4">
                    <div class="card metric-card">
                        <div class="card-body text-center">
                            <div class="metric-value">${workers}</div>
                            <div class="metric-label">Trabajadores</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card metric-card">
                        <div class="card-body text-center">
                            <div class="metric-value">${workDays}</div>
                            <div class="metric-label">D√≠as Laborables</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card metric-card ${unjustified > 0 ? 'alert-danger-custom' : ''}">
                        <div class="card-body text-center">
                            <div class="metric-value">${unjustified}</div>
                            <div class="metric-label">D√≠as Injustificados</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mt-3">
                    <div class="card metric-card alert-success-custom">
                        <div class="card-body text-center">
                            <div class="metric-value">${attendance}</div>
                            <div class="metric-label">Total D√≠as Asistencia</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mt-3">
                    <div class="card metric-card alert-warning-custom">
                        <div class="card-body text-center">
                            <div class="metric-value">${absences}</div>
                            <div class="metric-label">Total D√≠as Ausencia</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mt-3">
                    <div class="card metric-card ${inconsistencies > 0 ? 'alert-danger-custom' : ''}">
                        <div class="card-body text-center">
                            <div class="metric-value">${inconsistencies}</div>
                            <div class="metric-label">Inconsistencias</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function displayReport1Table(results) {
            const tbody = document.getElementById('report1Table');
            
            if (results.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            No se encontraron registros con los filtros seleccionados
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = results.map(r => {
                const rowClass = r.inconsistencies > 0 || r.unjustifiedDays > 0 ? 'table-warning' : '';
                return `
                    <tr class="${rowClass}">
                        <td>${getWorkerFullName(r.worker)}</td>
                        <td>${getSectionName(r.worker)}</td>
                        <td class="text-center">${r.workDays}</td>
                        <td class="text-center">${r.attendanceDays}</td>
                        <td class="text-center">${r.absenceDays}</td>
                        <td class="text-center ${r.unjustifiedDays > 0 ? 'text-danger fw-bold' : ''}">${r.unjustifiedDays}</td>
                        <td class="text-center">${r.absenteeismPercent}%</td>
                        <td class="text-center ${r.inconsistencies > 0 ? 'text-danger fw-bold' : ''}">${r.inconsistencies}</td>
                    </tr>
                `;
            }).join('');
        }

        // ==========================================
        // REPORTE 2: CONTROL DE L√çMITES
        // ==========================================
        async function generateReport2() {
            const workerId = document.getElementById('r2_worker').value;
            const sectionId = document.getElementById('r2_section').value;
            const onlyAlerts = document.getElementById('r2_onlyAlerts').checked;
            
            if (!hrConfig) {
                showMessage('No se pudo cargar la configuraci√≥n de l√≠mites', 'danger');
                return;
            }
            
            try {
                showLoading(true);
                
                // Filtrar trabajadores seg√∫n criterios
                let workers = allWorkers;
                if (workerId) {
                    workers = workers.filter(w => w.worker_id === workerId);
                }
                if (sectionId) {
                    workers = workers.filter(w => w.section_id === sectionId);
                }
                
                // Procesar cada trabajador
                const results = [];
                
                for (const worker of workers) {
                    const balances = await calculateBalances(worker.worker_id);
                    
                    const hoursLimit = hrConfig.personal_hours_limit;
                    const daysLimit = hrConfig.calamity_days_limit;
                    
                    const hoursUsedPercent = hoursLimit > 0 ? 
                        (((hoursLimit - balances.personalHours) / hoursLimit) * 100).toFixed(2) : 0;
                    const daysUsedPercent = daysLimit > 0 ? 
                        (((daysLimit - balances.calamityDays) / daysLimit) * 100).toFixed(2) : 0;
                    
                    const hoursAlert = (balances.personalHours / hoursLimit) < 0.2;
                    const daysAlert = (balances.calamityDays / daysLimit) < 0.2;
                    
                    const result = {
                        worker: worker,
                        personalHours: balances.personalHours,
                        hoursLimit: hoursLimit,
                        hoursUsedPercent: hoursUsedPercent,
                        hoursAlert: hoursAlert,
                        calamityDays: balances.calamityDays,
                        daysLimit: daysLimit,
                        daysUsedPercent: daysUsedPercent,
                        daysAlert: daysAlert
                    };
                    
                    // Filtrar por alertas si est√° marcado
                    if (!onlyAlerts || (hoursAlert || daysAlert)) {
                        results.push(result);
                    }
                }
                
                report2Data = results;
                
                // Mostrar tabla
                displayReport2Table(results);
                
                // Mostrar secci√≥n de resultados
                document.getElementById('report2Placeholder').style.display = 'none';
                document.getElementById('report2Results').style.display = 'block';
                document.getElementById('btnExportR2').style.display = 'inline-block';
                
            } catch (error) {
                console.error('Error generando reporte 2:', error);
                showMessage('Error al generar el reporte: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function displayReport2Table(results) {
            const tbody = document.getElementById('report2Table');
            
            if (results.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            No se encontraron registros con los filtros seleccionados
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = results.map(r => {
                const rowClass = r.hoursAlert || r.daysAlert ? 'table-danger' : '';
                const statusBadge = r.hoursAlert || r.daysAlert ? 
                    '<span class="badge bg-danger">‚ö† Alerta</span>' : 
                    '<span class="badge bg-success">‚úì OK</span>';
                
                return `
                    <tr class="${rowClass}">
                        <td>${getWorkerFullName(r.worker)}</td>
                        <td>${getSectionName(r.worker)}</td>
                        <td>
                            ${r.personalHours.toFixed(2)} / ${r.hoursLimit} hrs
                            <div class="progress progress-thin mt-1">
                                <div class="progress-bar ${r.hoursAlert ? 'bg-danger' : 'bg-success'}" 
                                     style="width: ${Math.min(100, (r.personalHours / r.hoursLimit) * 100)}%"></div>
                            </div>
                        </td>
                        <td class="text-center ${r.hoursAlert ? 'text-danger fw-bold' : ''}">${r.hoursUsedPercent}%</td>
                        <td>
                            ${r.calamityDays.toFixed(2)} / ${r.daysLimit} d√≠as
                            <div class="progress progress-thin mt-1">
                                <div class="progress-bar ${r.daysAlert ? 'bg-danger' : 'bg-success'}" 
                                     style="width: ${Math.min(100, (r.calamityDays / r.daysLimit) * 100)}%"></div>
                            </div>
                        </td>
                        <td class="text-center ${r.daysAlert ? 'text-danger fw-bold' : ''}">${r.daysUsedPercent}%</td>
                        <td class="text-center">${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        // ==========================================
        // REPORTE 3: AUSENCIAS POR CATEGOR√çA
        // ==========================================
        async function generateReport3() {
            const startDate = document.getElementById('r3_startDate').value;
            const endDate = document.getElementById('r3_endDate').value;
            const categoryId = document.getElementById('r3_category').value;
            const status = document.getElementById('r3_status').value;
            
            if (!startDate || !endDate) {
                showMessage('Complete las fechas requeridas', 'warning');
                return;
            }
            
            try {
                showLoading(true);
                
                // Construir query
                let query = '/hr_absence_requests?select=*,category:hr_absence_categories(name),worker:workers(worker_first_name,worker_last_name_1,worker_last_name_2)' +
                    '&start_date=gte.' + startDate + '&end_date=lte.' + endDate;
                
                if (categoryId) {
                    query += '&category_id=eq.' + categoryId;
                }
                if (status) {
                    query += '&status=eq.' + status;
                }
                
                const requests = await supabaseRequest(query, { method: 'GET' });
                
                // Agrupar por categor√≠a
                const categoryStats = {};
                const monthlyData = {};
                
                requests.forEach(req => {
                    const catName = req.category?.name || 'Sin categor√≠a';
                    
                    if (!categoryStats[catName]) {
                        categoryStats[catName] = {
                            total: 0,
                            approved: 0,
                            rejected: 0,
                            pending: 0,
                            cancelled: 0,
                            totalDays: 0,
                            totalHours: 0,
                            workers: new Set()
                        };
                    }
                    
                    categoryStats[catName].total++;
                    categoryStats[catName][req.status]++;
                    categoryStats[catName].totalDays += parseFloat(req.total_days || 0);
                    categoryStats[catName].totalHours += parseFloat(req.total_hours || 0);
                    categoryStats[catName].workers.add(getWorkerFullName(req.worker));
                    
                    // Agrupar por mes
                    const month = req.start_date.substring(0, 7); // YYYY-MM
                    if (!monthlyData[month]) {
                        monthlyData[month] = 0;
                    }
                    monthlyData[month]++;
                });
                
                report3Data = categoryStats;
                
                // Mostrar tabla
                displayReport3Table(categoryStats);
                
                // Mostrar gr√°fico
                displayReport3Chart(monthlyData);
                
                // Mostrar secci√≥n de resultados
                document.getElementById('report3Placeholder').style.display = 'none';
                document.getElementById('report3Results').style.display = 'block';
                document.getElementById('btnExportR3').style.display = 'inline-block';
                
            } catch (error) {
                console.error('Error generando reporte 3:', error);
                showMessage('Error al generar el reporte: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function displayReport3Table(stats) {
            const tbody = document.getElementById('report3Table');
            
            if (Object.keys(stats).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            No se encontraron solicitudes en el per√≠odo seleccionado
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = Object.entries(stats).map(([category, data]) => {
                const topWorkers = Array.from(data.workers).slice(0, 3).join(', ');
                
                return `
                    <tr>
                        <td><strong>${category}</strong></td>
                        <td class="text-center">${data.total}</td>
                        <td class="text-center">${data.approved || 0}</td>
                        <td class="text-center">${data.rejected || 0}</td>
                        <td class="text-center">${data.pending || 0}</td>
                        <td class="text-center">${data.totalDays.toFixed(2)}</td>
                        <td class="text-center">${data.totalHours.toFixed(2)}</td>
                        <td><small>${topWorkers}</small></td>
                    </tr>
                `;
            }).join('');
        }

        function displayReport3Chart(monthlyData) {
            const ctx = document.getElementById('report3Chart');
            
            // Destruir gr√°fico anterior si existe
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Preparar datos
            const months = Object.keys(monthlyData).sort();
            const values = months.map(m => monthlyData[m]);
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString('es-CO', { month: 'short', year: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Solicitudes de Ausencia',
                        data: values,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // ==========================================
        // REPORTE 4: INCONSISTENCIAS
        // ==========================================
        async function generateReport4() {
            const startDate = document.getElementById('r4_startDate').value;
            const endDate = document.getElementById('r4_endDate').value;
            const workerId = document.getElementById('r4_worker').value;
            
            if (!startDate || !endDate) {
                showMessage('Complete las fechas requeridas', 'warning');
                return;
            }
            
            try {
                showLoading(true);
                
                // Buscar ausencias aprobadas de d√≠a completo
                let query = '/hr_absence_requests?select=*,worker:workers(*),category:hr_absence_categories(name)' +
                    '&status=eq.approved&is_full_day=eq.true' +
                    '&start_date=gte.' + startDate + '&end_date=lte.' + endDate;
                
                if (workerId) {
                    query += '&worker_id=eq.' + workerId;
                }
                
                const absences = await supabaseRequest(query, { method: 'GET' });
                
                const inconsistencies = [];
                
                // Para cada ausencia, buscar asistencias
                for (const absence of absences) {
                    const attendances = await supabaseRequest(
                        '/attendance?select=*,registered_by:workers(worker_first_name,worker_last_name_1)' +
                        '&person_id_document=eq.' + encodeURIComponent(absence.worker.worker_id_doc) +
                        '&person_type=eq.worker' +
                        '&attendance_date=gte.' + absence.start_date +
                        '&attendance_date=lte.' + absence.end_date,
                        { method: 'GET' }
                    );
                    
                    if (attendances.length > 0) {
                        attendances.forEach(att => {
                            inconsistencies.push({
                                worker: absence.worker,
                                date: att.attendance_date,
                                category: absence.category?.name || 'N/A',
                                time: att.attendance_time,
                                method: att.registration_method,
                                registeredBy: att.registered_by ? 
                                    `${att.registered_by.worker_first_name} ${att.registered_by.worker_last_name_1}` : 
                                    'Sistema'
                            });
                        });
                    }
                }
                
                report4Data = inconsistencies;
                
                // Actualizar contador
                document.getElementById('report4Count').textContent = inconsistencies.length;
                
                // Mostrar tabla
                displayReport4Table(inconsistencies);
                
                // Mostrar secci√≥n de resultados
                document.getElementById('report4Placeholder').style.display = 'none';
                document.getElementById('report4Results').style.display = 'block';
                document.getElementById('btnExportR4').style.display = 'inline-block';
                
            } catch (error) {
                console.error('Error generando reporte 4:', error);
                showMessage('Error al generar el reporte: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function displayReport4Table(inconsistencies) {
            const tbody = document.getElementById('report4Table');
            
            if (inconsistencies.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="bi bi-check-circle text-success fs-1"></i>
                            <p class="text-muted mt-2">No se encontraron inconsistencias en el per√≠odo seleccionado</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = inconsistencies.map(inc => `
                <tr class="inconsistency-row">
                    <td>${getWorkerFullName(inc.worker)}</td>
                    <td>${formatDate(inc.date)}</td>
                    <td>${inc.category}</td>
                    <td>${inc.time}</td>
                    <td>
                        <span class="badge badge-metric ${inc.method === 'manual' ? 'bg-warning' : 'bg-info'}">
                            ${inc.method}
                        </span>
                    </td>
                    <td>${inc.registeredBy}</td>
                </tr>
            `).join('');
        }

        // ==========================================
        // EXPORTACI√ìN A EXCEL
        // ==========================================
        function exportReport1ToExcel() {
            if (report1Data.length === 0) {
                showMessage('No hay datos para exportar', 'warning');
                return;
            }
            
            const data = report1Data.map(r => ({
                'Trabajador': getWorkerFullName(r.worker),
                'Secci√≥n': getSectionName(r.worker),
                'D√≠as Laborables': r.workDays,
                'D√≠as Asisti√≥': r.attendanceDays,
                'D√≠as Ausencia': r.absenceDays,
                'D√≠as Injustificados': r.unjustifiedDays,
                '% Ausentismo': r.absenteeismPercent,
                'Inconsistencias': r.inconsistencies
            }));
            
            exportToExcel(data, 'Reporte_Asistencia_vs_Ausencias');
        }

        function exportReport2ToExcel() {
            if (report2Data.length === 0) {
                showMessage('No hay datos para exportar', 'warning');
                return;
            }
            
            const data = report2Data.map(r => ({
                'Trabajador': getWorkerFullName(r.worker),
                'Secci√≥n': getSectionName(r.worker),
                'Horas Disponibles': r.personalHours.toFixed(2),
                'L√≠mite Horas': r.hoursLimit,
                '% Usado Horas': r.hoursUsedPercent,
                'D√≠as Disponibles': r.calamityDays.toFixed(2),
                'L√≠mite D√≠as': r.daysLimit,
                '% Usado D√≠as': r.daysUsedPercent,
                'Estado': (r.hoursAlert || r.daysAlert) ? 'ALERTA' : 'OK'
            }));
            
            exportToExcel(data, 'Reporte_Control_Limites');
        }

        function exportReport3ToExcel() {
            if (Object.keys(report3Data).length === 0) {
                showMessage('No hay datos para exportar', 'warning');
                return;
            }
            
            const data = Object.entries(report3Data).map(([category, stats]) => ({
                'Categor√≠a': category,
                'Total Solicitudes': stats.total,
                'Aprobadas': stats.approved || 0,
                'Rechazadas': stats.rejected || 0,
                'Pendientes': stats.pending || 0,
                'Total D√≠as': stats.totalDays.toFixed(2),
                'Total Horas': stats.totalHours.toFixed(2),
                'Trabajadores √önicos': stats.workers.size
            }));
            
            exportToExcel(data, 'Reporte_Ausencias_por_Categoria');
        }

        function exportReport4ToExcel() {
            if (report4Data.length === 0) {
                showMessage('No hay datos para exportar', 'warning');
                return;
            }
            
            const data = report4Data.map(inc => ({
                'Trabajador': getWorkerFullName(inc.worker),
                'Fecha': formatDate(inc.date),
                'Categor√≠a Ausencia': inc.category,
                'Hora Registro': inc.time,
                'M√©todo': inc.method,
                'Registrado Por': inc.registeredBy
            }));
            
            exportToExcel(data, 'Reporte_Inconsistencias');
        }

        function exportToExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Reporte');
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
            showMessage('Reporte exportado correctamente', 'success');
        }

    </script>
</body>
</html>
