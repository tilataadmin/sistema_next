<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.04.18.15">
    <title>Gesti√≥n de Ausencias - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        
        .status-rejected {
            background-color: #f8d7da;
            color: #842029;
        }
        
        .status-cancelled {
            background-color: #e2e3e5;
            color: #41464b;
        }
        
        .filter-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        
        .table-actions {
            white-space: nowrap;
        }
        
        .file-preview {
            position: relative;
            display: inline-block;
            margin: 0.5rem;
        }
        
        .file-preview img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            object-fit: cover;
        }
        
        .file-preview .file-icon {
            width: 100px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        
        .file-preview .file-icon i {
            font-size: 2rem;
            color: #6c757d;
        }
        
        .file-preview .file-name {
            font-size: 0.7rem;
            text-align: center;
            margin-top: 0.25rem;
            word-break: break-all;
            max-width: 100px;
        }
        
        .file-preview .remove-file {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            line-height: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .file-preview .remove-file:hover {
            background: #bb2d3b;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-text {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .modal-lg-custom {
            max-width: 900px;
        }
        
        .authorization-item {
            padding: 0.75rem;
            border-left: 3px solid #dee2e6;
            margin-bottom: 0.5rem;
            background-color: #f8f9fa;
        }
        
        .authorization-item.pending {
            border-left-color: #ffc107;
        }
        
        .authorization-item.approved {
            border-left-color: #28a745;
        }
        
        .authorization-item.rejected {
            border-left-color: #dc3545;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Procesando...</p>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Talento Humano</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gestionar Ausencias
                </li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Gesti√≥n de Ausencias
                </h1>
                <p class="text-muted">
                    Administraci√≥n completa de solicitudes de ausencias del personal
                </p>
            </div>
        </div>

        <!-- Contenedor de Alertas -->
        <div id="alertContainer"></div>

        <!-- Filtros -->
        <div class="card mb-4 filter-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-funnel me-2"></i>Filtros de B√∫squeda
                </h5>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                    <i class="bi bi-chevron-down"></i>
                </button>
            </div>
            <div class="collapse show" id="filterCollapse">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filterWorker" class="form-label">Trabajador</label>
                            <input type="text" class="form-control" id="filterWorker" placeholder="Buscar por nombre...">
                        </div>
                        <div class="col-md-3">
                            <label for="filterCategory" class="form-label">Categor√≠a</label>
                            <select class="form-select" id="filterCategory">
                                <option value="">Todas las categor√≠as</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterStatus" class="form-label">Estado</label>
                            <select class="form-select" id="filterStatus">
                                <option value="">Todos los estados</option>
                                <option value="pending">Pendiente</option>
                                <option value="approved">Aprobada</option>
                                <option value="rejected">Rechazada</option>
                                <option value="cancelled">Cancelada</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterSection" class="form-label">Secci√≥n</label>
                            <select class="form-select" id="filterSection">
                                <option value="">Todas las secciones</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterStartDate" class="form-label">Fecha desde</label>
                            <input type="date" class="form-control" id="filterStartDate">
                        </div>
                        <div class="col-md-3">
                            <label for="filterEndDate" class="form-label">Fecha hasta</label>
                            <input type="date" class="form-control" id="filterEndDate">
                        </div>
                        <div class="col-md-3">
                            <label for="filterDivision" class="form-label">Divisi√≥n</label>
                            <select class="form-select" id="filterDivision">
                                <option value="">Todas las divisiones</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterCostCenter" class="form-label">Centro de Costo</label>
                            <select class="form-select" id="filterCostCenter">
                                <option value="">Todos los centros</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterArea" class="form-label">√Årea</label>
                            <select class="form-select" id="filterArea">
                                <option value="">Todas las √°reas</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterRole" class="form-label">Rol</label>
                            <select class="form-select" id="filterRole">
                                <option value="">Todos los roles</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterManager" class="form-label">Jefe Principal</label>
                            <select class="form-select" id="filterManager">
                                <option value="">Todos los jefes</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12 d-flex gap-2">
                            <button class="btn btn-primary" onclick="applyFilters()">
                                <i class="bi bi-search me-1"></i>Aplicar Filtros
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de Acci√≥n Principales -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-task me-2"></i>Solicitudes de Ausencia
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" onclick="loadRequests()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                    <button class="btn btn-primary" onclick="openCreateRequestModal()">
                        <i class="bi bi-plus-circle me-1"></i>Nueva Solicitud
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Trabajador</th>
                                <th>Categor√≠a</th>
                                <th>Fechas</th>
                                <th>D√≠as</th>
                                <th>Horas</th>
                                <th>Estado</th>
                                <th>Fecha Solicitud</th>
                                <th class="table-actions">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    Cargando solicitudes...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal: Ver Detalle -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle me-2"></i>Detalle de Solicitud
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailModalBody">
                    <div class="text-center py-4">
                        <span class="spinner-border"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Solicitud -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i>Editar Solicitud
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editForm">
                    <div class="modal-body">
                        <input type="hidden" id="editRequestId">
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Nota:</strong> Al editar, no se modificar√° el estado ni las autorizaciones existentes.
                        </div>

                        <div class="mb-3">
                            <label for="editWorker" class="form-label">Trabajador</label>
                            <select class="form-select" id="editWorker" required>
                                <option value="">Seleccione un trabajador...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="editCategory" class="form-label">Categor√≠a</label>
                            <select class="form-select" id="editCategory" required>
                                <option value="">Seleccione una categor√≠a...</option>
                            </select>
                        </div>

                        <div id="editDynamicFields"></div>

                        <div class="mb-3">
                            <label for="editDescription" class="form-label">Descripci√≥n</label>
                            <textarea class="form-control" id="editDescription" rows="3"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Total D√≠as</label>
                                <input type="text" class="form-control" id="editTotalDays" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Total Horas</label>
                                <input type="text" class="form-control" id="editTotalHours" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Agregar Archivos -->
    <div class="modal fade" id="addFilesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-paperclip me-2"></i>Agregar Archivos
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="addFilesRequestId">
                    
                    <div class="mb-3">
                        <label class="form-label">Seleccionar Archivos</label>
                        <input type="file" class="form-control" id="addFilesInput" multiple 
                            accept="image/*,application/pdf,.doc,.docx">
                        <div class="form-text">
                            Formatos: PDF, im√°genes, documentos Word. M√°ximo 10MB por archivo.
                        </div>
                    </div>
                    
                    <div id="addFilesPreview"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="uploadAdditionalFiles()">
                        <i class="bi bi-upload me-1"></i>Subir Archivos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Nueva Solicitud -->
    <div class="modal fade" id="createRequestModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle me-2"></i>Nueva Solicitud de Ausencia
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="createRequestForm">
                    <div class="modal-body">
                        
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Importante:</strong> Est√°s creando una solicitud a nombre de otro trabajador.
                        </div>

                        <div class="mb-3">
                            <label for="createWorker" class="form-label">
                                Trabajador <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="createWorker" required>
                                <option value="">Seleccione un trabajador...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="createCategory" class="form-label">
                                Categor√≠a de Ausencia <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="createCategory" required>
                                <option value="">Seleccione una categor√≠a...</option>
                            </select>
                            <div class="form-text" id="createCategoryHelp"></div>
                        </div>

                        <div id="createDynamicFields"></div>

                        <div class="mb-3">
                            <label for="createDescription" class="form-label">Descripci√≥n / Motivo</label>
                            <textarea class="form-control" id="createDescription" rows="3" 
                                placeholder="Describe el motivo de la ausencia"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Archivos Adjuntos</label>
                            <input type="file" class="form-control" id="createFilesInput" multiple 
                                accept="image/*,application/pdf,.doc,.docx">
                            <div class="form-text">
                                Formatos: PDF, im√°genes, documentos Word. M√°ximo 10MB por archivo.
                            </div>
                            <div id="createFilesPreview" class="mt-2"></div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Total D√≠as</label>
                                <input type="text" class="form-control" id="createTotalDays" readonly value="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Total Horas</label>
                                <input type="text" class="form-control" id="createTotalHours" readonly value="0">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="createInitialStatus" class="form-label">
                                Estado Inicial <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="createInitialStatus" required>
                                <option value="pending">Pendiente (seguir√° flujo de autorizaciones)</option>
                                <option value="approved">Aprobada (se registra como ya autorizada)</option>
                            </select>
                            <div class="form-text">
                                Si seleccionas "Aprobada", la solicitud no requerir√° autorizaciones adicionales.
                            </div>
                        </div>

                        <div id="createBalanceAlert"></div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="createSubmitBtn">
                            <i class="bi bi-check-lg me-1"></i>Crear Solicitud
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentSession = null;
        let supabaseClient = null;
        let categories = [];
        let workers = [];
        let sections = [];
        let divisions = [];
        let costCenters = [];
        let areas = [];
        let roles = [];
        let managers = [];
        let hrConfig = null;
        let allRequests = [];
        let filteredRequests = [];
        let selectedCategory = null;
        let selectedFiles = [];
        let editingRequest = null;
        
        // ==========================================
        // UTILIDADES PARA MANEJO DE FECHAS
        // ==========================================
        function formatDateForDatabase(dateString) {
            if (!dateString) return null;
            if (dateString.includes('T')) {
                return dateString.split('T')[0];
            }
            return dateString;
        }

        function getCurrentDateColombia() {
            const now = new Date();
            const colombiaOffset = -5 * 60;
            const localOffset = now.getTimezoneOffset();
            const colombiaTime = new Date(now.getTime() + (localOffset + colombiaOffset) * 60000);
            
            const year = colombiaTime.getFullYear();
            const month = String(colombiaTime.getMonth() + 1).padStart(2, '0');
            const day = String(colombiaTime.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Gestionar todas las ausencias');
                if (!hasAccess) return;
                
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        });

        async function inicializarPagina() {
            showLoading(true);
            
            try {
                // Obtener sesi√≥n
                const sessionData = localStorage.getItem('nextSystemSession') || sessionStorage.getItem('nextSystemSession');
                
                if (!sessionData) {
                    throw new Error('No hay sesi√≥n activa');
                }
                
                const session = JSON.parse(sessionData);
                
                if (!session.user || !session.user.user_id) {
                    throw new Error('Sesi√≥n inv√°lida');
                }
                
                currentSession = {
                    user_id: session.user.user_id,
                    user_name: session.user.user_display_name || session.user.user_name,
                    user_mail: session.user.user_mail
                };
                
                console.log('‚úÖ Usuario:', currentSession.user_name);
                
                // Inicializar cliente de Supabase
                supabaseClient = supabase.createClient(
                    SUPABASE_CONFIG.url,
                    SUPABASE_CONFIG.anonKey
                );
                
                // Cargar datos iniciales
                await loadHRConfig();
                await Promise.all([
                    loadCategories(),
                    loadWorkers(),
                    loadSections(),
                    loadDivisions(),
                    loadCostCenters(),
                    loadAreas(),
                    loadRoles(),
                    loadManagers()
                ]);
                
                await loadRequests();
                
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error al inicializar:', error);
                showMessage('Error al inicializar: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // ==========================================
        // CARGAR DATOS INICIALES
        // ==========================================
        async function loadHRConfig() {
            try {
                const data = await supabaseRequest('/hr_config?select=*');
                if (data && data.length > 0) {
                    hrConfig = data[0];
                    console.log('‚öôÔ∏è Configuraci√≥n HR cargada');
                } else {
                    throw new Error('No se encontr√≥ configuraci√≥n del m√≥dulo');
                }
            } catch (error) {
                console.error('Error al cargar configuraci√≥n:', error);
                throw error;
            }
        }

        async function loadCategories() {
            try {
                const data = await supabaseRequest('/hr_absence_categories?is_active=eq.true&select=*&order=name');
                categories = data || [];
                
                // Poblar filtros
                const filterSelect = document.getElementById('filterCategory');
                const createSelect = document.getElementById('createCategory');
                const editSelect = document.getElementById('editCategory');
                
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.category_id;
                    option.textContent = cat.name;
                    filterSelect.appendChild(option.cloneNode(true));
                    createSelect.appendChild(option.cloneNode(true));
                    editSelect.appendChild(option.cloneNode(true));
                });
                
                console.log(`üìã ${categories.length} categor√≠as cargadas`);
            } catch (error) {
                console.error('Error al cargar categor√≠as:', error);
            }
        }

        async function loadWorkers() {
            try {
                const data = await supabaseRequest('/workers?worker_status=eq.active&select=*&order=worker_first_name');
                workers = data || [];
                
                const createSelect = document.getElementById('createWorker');
                const editSelect = document.getElementById('editWorker');
                
                workers.forEach(w => {
                    const option = document.createElement('option');
                    option.value = w.worker_id;
                    option.textContent = `${w.worker_first_name} ${w.worker_last_name_1} ${w.worker_last_name_2 || ''}`.trim();
                    option.dataset.sectionId = w.section_id || '';
                    createSelect.appendChild(option.cloneNode(true));
                    editSelect.appendChild(option.cloneNode(true));
                });
                
                console.log(`üë• ${workers.length} trabajadores cargados`);
            } catch (error) {
                console.error('Error al cargar trabajadores:', error);
            }
        }

        async function loadSections() {
            try {
                const data = await supabaseRequest('/sections?select=section_id,section_name&order=section_name');
                sections = data || [];
                
                const filterSelect = document.getElementById('filterSection');
                sections.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.section_id;
                    option.textContent = s.section_name;
                    filterSelect.appendChild(option);
                });
                
                console.log(`üìö ${sections.length} secciones cargadas`);
            } catch (error) {
                console.error('Error al cargar secciones:', error);
            }
        }

        async function loadDivisions() {
            try {
                const data = await supabaseRequest('/divisions?select=division_id,division_name&order=division_name');
                divisions = data || [];
                
                const filterSelect = document.getElementById('filterDivision');
                divisions.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.division_id;
                    option.textContent = d.division_name;
                    filterSelect.appendChild(option);
                });
                
                console.log(`üè¢ ${divisions.length} divisiones cargadas`);
            } catch (error) {
                console.error('Error al cargar divisiones:', error);
            }
        }

        async function loadCostCenters() {
            try {
                const data = await supabaseRequest('/cost_centers?select=cost_center_id,cost_center_name&order=cost_center_name');
                costCenters = data || [];
                
                const filterSelect = document.getElementById('filterCostCenter');
                costCenters.forEach(cc => {
                    const option = document.createElement('option');
                    option.value = cc.cost_center_id;
                    option.textContent = cc.cost_center_name;
                    filterSelect.appendChild(option);
                });
                
                console.log(`üí∞ ${costCenters.length} centros de costo cargados`);
            } catch (error) {
                console.error('Error al cargar centros de costo:', error);
            }
        }

        async function loadAreas() {
            try {
                const data = await supabaseRequest('/organizational_areas?select=area_id,area_name&order=area_name');
                areas = data || [];
                
                const filterSelect = document.getElementById('filterArea');
                areas.forEach(a => {
                    const option = document.createElement('option');
                    option.value = a.area_id;
                    option.textContent = a.area_name;
                    filterSelect.appendChild(option);
                });
                
                console.log(`üèõÔ∏è ${areas.length} √°reas cargadas`);
            } catch (error) {
                console.error('Error al cargar √°reas:', error);
            }
        }

        async function loadRoles() {
            try {
                const data = await supabaseRequest('/job_roles?select=job_role_id,job_role_name&order=job_role_name');
                roles = data || [];
                
                const filterSelect = document.getElementById('filterRole');
                roles.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r.job_role_id;
                    option.textContent = r.job_role_name;
                    filterSelect.appendChild(option);
                });
                
                console.log(`üëî ${roles.length} roles cargados`);
            } catch (error) {
                console.error('Error al cargar roles:', error);
            }
        }

        async function loadManagers() {
            try {
                const data = await supabaseRequest('/worker_managers?is_primary_manager=eq.true&assignment_status=eq.active&select=manager_id,workers!worker_managers_manager_id_fkey(worker_first_name,worker_last_name_1)');
                
                const uniqueManagers = new Map();
                data?.forEach(m => {
                    if (m.workers && !uniqueManagers.has(m.manager_id)) {
                        uniqueManagers.set(m.manager_id, {
                            manager_id: m.manager_id,
                            name: `${m.workers.worker_first_name} ${m.workers.worker_last_name_1}`
                        });
                    }
                });
                
                managers = Array.from(uniqueManagers.values());
                
                const filterSelect = document.getElementById('filterManager');
                managers.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.manager_id;
                    option.textContent = m.name;
                    filterSelect.appendChild(option);
                });
                
                console.log(`üë®‚Äçüíº ${managers.length} jefes principales cargados`);
            } catch (error) {
                console.error('Error al cargar jefes:', error);
            }
        }

        // ==========================================
        // CARGAR SOLICITUDES
        // ==========================================
        async function loadRequests() {
            try {
                const tbody = document.getElementById('requestsTableBody');
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4"><span class="spinner-border spinner-border-sm me-2"></span>Cargando solicitudes...</td></tr>';
                
                const data = await supabaseRequest('/hr_absence_requests?select=*,hr_absence_categories(name),workers(worker_first_name,worker_last_name_1,worker_last_name_2,section_id,division_id,cost_center_id,area_id)&order=created_at.desc');
                
                allRequests = data || [];
                filteredRequests = [...allRequests];
                
                renderRequestsTable();
                
                console.log(`üìã ${allRequests.length} solicitudes cargadas`);
                
            } catch (error) {
                console.error('Error al cargar solicitudes:', error);
                const tbody = document.getElementById('requestsTableBody');
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-3 text-danger">Error al cargar solicitudes</td></tr>';
            }
        }

        function renderRequestsTable() {
            const tbody = document.getElementById('requestsTableBody');
            
            if (filteredRequests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-3 text-muted">No se encontraron solicitudes</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            filteredRequests.forEach(request => {
                const row = document.createElement('tr');
                
                const requestIdShort = request.request_id.substring(0, 8);
                const workerName = request.workers ? 
                    `${request.workers.worker_first_name} ${request.workers.worker_last_name_1}` : 'N/A';
                const categoryName = request.hr_absence_categories?.name || 'N/A';
                
                let dateRange = '';
                if (request.is_full_day) {
                    dateRange = `${request.start_date}<br><small class="text-muted">al ${request.end_date}</small>`;
                } else {
                    dateRange = `${request.start_date}<br><small class="text-muted">${request.start_time} - ${request.end_time}</small>`;
                }
                
                let statusBadge = '';
                switch(request.status) {
                    case 'pending':
                        statusBadge = '<span class="status-badge status-pending">Pendiente</span>';
                        break;
                    case 'approved':
                        statusBadge = '<span class="status-badge status-approved">Aprobada</span>';
                        break;
                    case 'rejected':
                        statusBadge = '<span class="status-badge status-rejected">Rechazada</span>';
                        break;
                    case 'cancelled':
                        statusBadge = '<span class="status-badge status-cancelled">Cancelada</span>';
                        break;
                }
                
                const createdDate = new Date(request.created_at).toLocaleDateString('es-CO');
                
                row.innerHTML = `
                    <td><small>${requestIdShort}</small></td>
                    <td>${workerName}</td>
                    <td>${categoryName}</td>
                    <td>${dateRange}</td>
                    <td>${request.total_days.toFixed(2)}</td>
                    <td>${request.total_hours.toFixed(2)}</td>
                    <td>${statusBadge}</td>
                    <td>${createdDate}</td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewRequestDetail('${request.request_id}')" title="Ver detalle">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="openEditModal('${request.request_id}')" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="openAddFilesModal('${request.request_id}')" title="Agregar archivos">
                            <i class="bi bi-paperclip"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // ==========================================
        // FILTROS
        // ==========================================
        async function applyFilters() {
            showLoading(true);
            
            try {
                const filters = {
                    worker: document.getElementById('filterWorker').value.toLowerCase(),
                    category: document.getElementById('filterCategory').value,
                    status: document.getElementById('filterStatus').value,
                    section: document.getElementById('filterSection').value,
                    startDate: document.getElementById('filterStartDate').value,
                    endDate: document.getElementById('filterEndDate').value,
                    division: document.getElementById('filterDivision').value,
                    costCenter: document.getElementById('filterCostCenter').value,
                    area: document.getElementById('filterArea').value,
                    role: document.getElementById('filterRole').value,
                    manager: document.getElementById('filterManager').value
                };
                
                filteredRequests = allRequests.filter(request => {
                    // Filtro por trabajador (nombre)
                    if (filters.worker) {
                        const workerName = request.workers ? 
                            `${request.workers.worker_first_name} ${request.workers.worker_last_name_1} ${request.workers.worker_last_name_2 || ''}`.toLowerCase() : '';
                        if (!workerName.includes(filters.worker)) return false;
                    }
                    
                    // Filtro por categor√≠a
                    if (filters.category && request.category_id !== filters.category) return false;
                    
                    // Filtro por estado
                    if (filters.status && request.status !== filters.status) return false;
                    
                    // Filtro por secci√≥n
                    if (filters.section && request.workers?.section_id !== filters.section) return false;
                    
                    // Filtro por rango de fechas
                    if (filters.startDate && request.start_date < filters.startDate) return false;
                    if (filters.endDate && request.start_date > filters.endDate) return false;
                    
                    // Filtro por divisi√≥n
                    if (filters.division && request.workers?.division_id !== filters.division) return false;
                    
                    // Filtro por centro de costo
                    if (filters.costCenter && request.workers?.cost_center_id !== filters.costCenter) return false;
                    
                    // Filtro por √°rea
                    if (filters.area && request.workers?.area_id !== filters.area) return false;
                    
                    // Filtro por rol (requiere consulta adicional)
                    // TODO: Implementar si es necesario
                    
                    // Filtro por jefe principal (requiere consulta adicional)
                    // TODO: Implementar si es necesario
                    
                    return true;
                });
                
                renderRequestsTable();
                showMessage(`Filtros aplicados: ${filteredRequests.length} solicitudes encontradas`, 'info');
                
            } catch (error) {
                console.error('Error al aplicar filtros:', error);
                showMessage('Error al aplicar filtros: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function clearFilters() {
            document.getElementById('filterWorker').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterSection').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterDivision').value = '';
            document.getElementById('filterCostCenter').value = '';
            document.getElementById('filterArea').value = '';
            document.getElementById('filterRole').value = '';
            document.getElementById('filterManager').value = '';
            
            filteredRequests = [...allRequests];
            renderRequestsTable();
            
            showMessage('Filtros limpiados', 'info');
        }

        // ==========================================
        // VER DETALLE DE SOLICITUD
        // ==========================================
        async function viewRequestDetail(requestId) {
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            const modalBody = document.getElementById('detailModalBody');
            
            modal.show();
            modalBody.innerHTML = '<div class="text-center py-4"><span class="spinner-border"></span><p class="mt-2">Cargando detalle...</p></div>';
            
            try {
                const data = await supabaseRequest('/hr_absence_requests?request_id=eq.' + requestId + '&select=*,hr_absence_categories(*),workers(*),replacement:workers!hr_absence_requests_replacement_worker_id_fkey(worker_first_name,worker_last_name_1)');
                
                if (!data || data.length === 0) {
                    modalBody.innerHTML = '<p class="text-danger">No se encontr√≥ la solicitud</p>';
                    return;
                }
                
                const request = data[0];
                const category = request.hr_absence_categories;
                const worker = request.workers;
                const replacement = request.replacement;
                
                // Cargar autorizaciones
                const authData = await supabaseRequest('/hr_absence_authorizations?request_id=eq.' + requestId + '&select=*,workers(worker_first_name,worker_last_name_1)');
                
                let authHTML = '';
                if (authData && authData.length > 0) {
                    authHTML = '<h6 class="mt-3 mb-2">Autorizaciones:</h6>';
                    authData.forEach(auth => {
                        const authorizerName = auth.workers ? 
                            `${auth.workers.worker_first_name} ${auth.workers.worker_last_name_1}` : 'N/A';
                        
                        let statusText = '';
                        let statusClass = '';
                        switch(auth.status) {
                            case 'pending':
                                statusText = '‚è≥ Pendiente';
                                statusClass = 'pending';
                                break;
                            case 'approved':
                                statusText = '‚úÖ Aprobada';
                                statusClass = 'approved';
                                break;
                            case 'rejected':
                                statusText = '‚ùå Rechazada';
                                statusClass = 'rejected';
                                break;
                        }
                        
                        const levelText = auth.authorization_level === 'primary_manager' ? 'Jefe Principal' :
                                         auth.authorization_level === 'hr' ? 'Talento Humano' : 'Instancia Superior';
                        
                        const decisionDate = auth.decision_date ? 
                            new Date(auth.decision_date).toLocaleDateString('es-CO') : 'Pendiente';
                        
                        authHTML += `
                            <div class="authorization-item ${statusClass}">
                                <strong>${authorizerName}</strong> (${levelText})<br>
                                <small>Estado: ${statusText}</small><br>
                                ${auth.decision_date ? `<small>Fecha: ${decisionDate}</small>` : ''}
                                ${auth.comments ? `<br><small>Comentarios: ${auth.comments}</small>` : ''}
                            </div>
                        `;
                    });
                }
                
                // Cargar archivos adjuntos
                const attachmentsData = await supabaseRequest('/hr_absence_attachments?request_id=eq.' + requestId + '&select=*');
                
                let attachmentsHTML = '';
                if (attachmentsData && attachmentsData.length > 0) {
                    attachmentsHTML = '<h6 class="mt-3 mb-2">Archivos Adjuntos:</h6><div class="list-group mb-3">';
                    attachmentsData.forEach(att => {
                        const fileSize = (att.file_size / 1024).toFixed(2);
                        attachmentsHTML += `
                            <a href="${att.file_path}" 
                               target="_blank"
                               class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="bi bi-file-earmark me-2"></i>
                                    <strong>${att.file_name}</strong>
                                </span>
                                <span class="badge bg-secondary">${fileSize} KB</span>
                            </a>
                        `;
                    });
                    attachmentsHTML += '</div>';
                }
                
                // Informaci√≥n de edici√≥n
                let editInfo = '';
                if (request.edited_by) {
                    const editorData = await supabaseRequest('/workers?worker_id=eq.' + request.edited_by + '&select=worker_first_name,worker_last_name_1');
                    if (editorData && editorData.length > 0) {
                        const editorName = `${editorData[0].worker_first_name} ${editorData[0].worker_last_name_1}`;
                        const editedDate = new Date(request.edited_at).toLocaleString('es-CO');
                        editInfo = `
                            <div class="alert alert-info mt-3">
                                <i class="bi bi-pencil-square me-2"></i>
                                <strong>Editada por:</strong> ${editorName} el ${editedDate}
                            </div>
                        `;
                    }
                }
                
                modalBody.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Trabajador:</strong><br>${worker.worker_first_name} ${worker.worker_last_name_1} ${worker.worker_last_name_2 || ''}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Categor√≠a:</strong><br>${category.name}</p>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Tipo:</strong><br>${request.is_full_day ? 'D√≠a completo' : 'Parcial'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Estado:</strong><br>
                                ${request.status === 'pending' ? '<span class="status-badge status-pending">Pendiente</span>' : ''}
                                ${request.status === 'approved' ? '<span class="status-badge status-approved">Aprobada</span>' : ''}
                                ${request.status === 'rejected' ? '<span class="status-badge status-rejected">Rechazada</span>' : ''}
                                ${request.status === 'cancelled' ? '<span class="status-badge status-cancelled">Cancelada</span>' : ''}
                            </p>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Fecha Inicial:</strong><br>${request.start_date}</p>
                            ${!request.is_full_day ? `<p><strong>Hora Inicial:</strong><br>${request.start_time}</p>` : ''}
                        </div>
                        <div class="col-md-6">
                            <p><strong>Fecha Final:</strong><br>${request.end_date}</p>
                            ${!request.is_full_day ? `<p><strong>Hora Final:</strong><br>${request.end_time}</p>` : ''}
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Total D√≠as:</strong><br>${request.total_days.toFixed(2)}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Total Horas:</strong><br>${request.total_hours.toFixed(2)}</p>
                        </div>
                    </div>
                    
                    ${replacement ? `
                        <div class="mb-3">
                            <p><strong>Trabajador de Reemplazo:</strong><br>${replacement.worker_first_name} ${replacement.worker_last_name_1}</p>
                        </div>
                    ` : ''}
                    
                    ${request.description ? `
                        <div class="mb-3">
                            <p><strong>Descripci√≥n:</strong><br>${request.description}</p>
                        </div>
                    ` : ''}
                    
                    <div class="mb-3">
                        <p><strong>Fecha de Solicitud:</strong><br>${new Date(request.created_at).toLocaleString('es-CO')}</p>
                    </div>
                    
                    ${authHTML}
                    ${attachmentsHTML}
                    ${editInfo}
                `;
                
            } catch (error) {
                console.error('Error:', error);
                modalBody.innerHTML = '<p class="text-danger">Error al cargar detalle: ' + error.message + '</p>';
            }
        }

        // ==========================================
        // EDITAR SOLICITUD
        // ==========================================
        async function openEditModal(requestId) {
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            
            try {
                showLoading(true);
                
                const data = await supabaseRequest('/hr_absence_requests?request_id=eq.' + requestId + '&select=*');
                
                if (!data || data.length === 0) {
                    throw new Error('No se encontr√≥ la solicitud');
                }
                
                editingRequest = data[0];
                
                document.getElementById('editRequestId').value = editingRequest.request_id;
                document.getElementById('editWorker').value = editingRequest.worker_id;
                document.getElementById('editCategory').value = editingRequest.category_id;
                document.getElementById('editDescription').value = editingRequest.description || '';
                document.getElementById('editTotalDays').value = editingRequest.total_days.toFixed(2);
                document.getElementById('editTotalHours').value = editingRequest.total_hours.toFixed(2);
                
                selectedCategory = categories.find(c => c.category_id === editingRequest.category_id);
                renderEditDynamicFields();
                
                modal.show();
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error al cargar solicitud: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        function renderEditDynamicFields() {
            const container = document.getElementById('editDynamicFields');
            let html = '';
            
            if (selectedCategory.full_day_only) {
                html += `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editStartDate" class="form-label">Fecha Inicial</label>
                            <input type="date" class="form-control" id="editStartDate" value="${editingRequest.start_date}" required onchange="calculateEditTotals()">
                        </div>
                        <div class="col-md-6">
                            <label for="editEndDate" class="form-label">Fecha Final</label>
                            <input type="date" class="form-control" id="editEndDate" value="${editingRequest.end_date}" required onchange="calculateEditTotals()">
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="editSingleDate" class="form-label">Fecha</label>
                            <input type="date" class="form-control" id="editSingleDate" value="${editingRequest.start_date}" required onchange="calculateEditTotals()">
                        </div>
                        <div class="col-md-4">
                            <label for="editStartTime" class="form-label">Hora Inicial</label>
                            <input type="time" class="form-control" id="editStartTime" value="${editingRequest.start_time}" required onchange="calculateEditTotals()">
                        </div>
                        <div class="col-md-4">
                            <label for="editEndTime" class="form-label">Hora Final</label>
                            <input type="time" class="form-control" id="editEndTime" value="${editingRequest.end_time}" required onchange="calculateEditTotals()">
                        </div>
                    </div>
                `;
            }
            
            if (selectedCategory.worker_finds_replacement) {
                const currentWorker = workers.find(w => w.worker_id === editingRequest.worker_id);
                const hasSection = currentWorker && currentWorker.section_id;
                
                const filteredWorkers = workers.filter(w => {
                    if (w.worker_id === editingRequest.worker_id) return false;
                    if (w.is_replacement) return false;
                    if (hasSection) {
                        return w.section_id !== null;
                    } else {
                        return w.section_id === null;
                    }
                });
                
                html += `
                    <div class="mb-3">
                        <label for="editReplacementWorker" class="form-label">Trabajador de Reemplazo</label>
                        <select class="form-select" id="editReplacementWorker">
                            <option value="">Sin reemplazo</option>
                            ${filteredWorkers.map(w => 
                                `<option value="${w.worker_id}" ${editingRequest.replacement_worker_id === w.worker_id ? 'selected' : ''}>
                                    ${w.worker_first_name} ${w.worker_last_name_1}
                                </option>`
                            ).join('')}
                        </select>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function calculateEditTotals() {
            if (!selectedCategory) return;
            
            let totalDays = 0;
            let totalHours = 0;
            
            if (selectedCategory.full_day_only) {
                const startDate = document.getElementById('editStartDate').value;
                const endDate = document.getElementById('editEndDate').value;
                
                if (!startDate || !endDate) return;
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                totalDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                const workdayStart = hrConfig.workday_start_time || '07:00:00';
                const workdayEnd = hrConfig.workday_end_time || '15:00:00';
                const hoursPerDay = calculateHoursPerDay(workdayStart, workdayEnd);
                
                totalHours = totalDays * hoursPerDay;
                
            } else {
                const singleDate = document.getElementById('editSingleDate').value;
                const startTime = document.getElementById('editStartTime').value;
                const endTime = document.getElementById('editEndTime').value;
                
                if (!singleDate || !startTime || !endTime) return;
                
                const start = new Date('2000-01-01 ' + startTime);
                const end = new Date('2000-01-01 ' + endTime);
                totalHours = (end - start) / (1000 * 60 * 60);
                
                const workdayStart = hrConfig.workday_start_time || '07:00:00';
                const workdayEnd = hrConfig.workday_end_time || '15:00:00';
                const hoursPerDay = calculateHoursPerDay(workdayStart, workdayEnd);
                totalDays = totalHours / hoursPerDay;
            }
            
            document.getElementById('editTotalDays').value = totalDays.toFixed(2);
            document.getElementById('editTotalHours').value = totalHours.toFixed(2);
        }

        function calculateHoursPerDay(startTime, endTime) {
            const start = new Date('2000-01-01 ' + startTime);
            const end = new Date('2000-01-01 ' + endTime);
            const hours = (end - start) / (1000 * 60 * 60);
            return hours - 1;
        }

        document.getElementById('editCategory').addEventListener('change', function() {
            const categoryId = this.value;
            if (!categoryId) return;
            
            selectedCategory = categories.find(c => c.category_id === categoryId);
            renderEditDynamicFields();
        });

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!confirm('¬øEst√°s seguro de guardar los cambios? Esto no modificar√° el estado ni las autorizaciones existentes.')) {
                return;
            }
            
            showLoading(true);
            
            try {
                const totalDays = parseFloat(document.getElementById('editTotalDays').value);
                const totalHours = parseFloat(document.getElementById('editTotalHours').value);
                
                const updateData = {
                    worker_id: document.getElementById('editWorker').value,
                    category_id: document.getElementById('editCategory').value,
                    total_days: totalDays,
                    total_hours: totalHours,
                    description: document.getElementById('editDescription').value,
                    edited_by: currentSession.user_id,
                    edited_at: new Date().toISOString()
                };
                
                if (selectedCategory.full_day_only) {
                    updateData.start_date = formatDateForDatabase(document.getElementById('editStartDate').value);
                    updateData.end_date = formatDateForDatabase(document.getElementById('editEndDate').value);
                    updateData.is_full_day = true;
                } else {
                    const singleDate = formatDateForDatabase(document.getElementById('editSingleDate').value);
                    updateData.start_date = singleDate;
                    updateData.end_date = singleDate;
                    updateData.start_time = document.getElementById('editStartTime').value;
                    updateData.end_time = document.getElementById('editEndTime').value;
                    updateData.is_full_day = false;
                }
                
                if (selectedCategory.worker_finds_replacement) {
                    const replacementId = document.getElementById('editReplacementWorker').value;
                    updateData.replacement_worker_id = replacementId || null;
                }
                
                const requestId = document.getElementById('editRequestId').value;
                
                await supabaseRequest('/hr_absence_requests?request_id=eq.' + requestId, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });
                
                showMessage('Solicitud actualizada exitosamente', 'success');
                
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                await loadRequests();
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error al actualizar solicitud: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        });

        // ==========================================
        // AGREGAR ARCHIVOS A SOLICITUD EXISTENTE
        // ==========================================
        function openAddFilesModal(requestId) {
            document.getElementById('addFilesRequestId').value = requestId;
            document.getElementById('addFilesInput').value = '';
            document.getElementById('addFilesPreview').innerHTML = '';
            
            const modal = new bootstrap.Modal(document.getElementById('addFilesModal'));
            modal.show();
        }

        document.getElementById('addFilesInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const preview = document.getElementById('addFilesPreview');
            preview.innerHTML = '';
            
            if (files.length === 0) return;
            
            files.forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    showMessage(`El archivo ${file.name} excede el tama√±o m√°ximo de 10MB`, 'warning');
                    return;
                }
                
                const fileDiv = document.createElement('div');
                fileDiv.className = 'alert alert-info';
                fileDiv.innerHTML = `
                    <i class="bi bi-file-earmark me-2"></i>
                    ${file.name} (${(file.size / 1024).toFixed(2)} KB)
                `;
                preview.appendChild(fileDiv);
            });
        });

        async function uploadAdditionalFiles() {
            const requestId = document.getElementById('addFilesRequestId').value;
            const fileInput = document.getElementById('addFilesInput');
            const files = fileInput.files;
            
            if (!files || files.length === 0) {
                showMessage('Selecciona al menos un archivo', 'warning');
                return;
            }
            
            showLoading(true);
            
            try {
                const BUCKET_NAME = 'hr-absence-supports';
                
                for (const file of files) {
                    // Obtener datos del request para construir la ruta
                    const requestData = await supabaseRequest('/hr_absence_requests?request_id=eq.' + requestId + '&select=worker_id');
                    
                    if (!requestData || requestData.length === 0) {
                        throw new Error('No se encontr√≥ la solicitud');
                    }
                    
                    const workerId = requestData[0].worker_id;
                    
                    // Generar ruta √∫nica en Storage
                    const timestamp = Date.now();
                    const sanitizedName = file.name.replace(/[^a-z0-9.-]/gi, '_').toLowerCase();
                    const filePath = `${workerId}/${requestId}/${timestamp}_${sanitizedName}`;
                    
                    // Subir a Supabase Storage
                    const { data, error } = await supabaseClient
                        .storage
                        .from(BUCKET_NAME)
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (error) {
                        console.error('Error de Supabase Storage:', error);
                        throw error;
                    }
                    
                    // Obtener URL p√∫blica
                    const { data: urlData } = supabaseClient
                        .storage
                        .from(BUCKET_NAME)
                        .getPublicUrl(filePath);
                    
                    const publicUrl = urlData.publicUrl;
                    
                    // Guardar referencia en base de datos
                    await supabaseRequest('/hr_absence_attachments', {
                        method: 'POST',
                        body: JSON.stringify({
                            request_id: requestId,
                            file_name: file.name,
                            file_path: publicUrl,
                            file_type: file.type,
                            file_size: file.size,
                            uploaded_by: currentSession.user_id
                        })
                    });
                }
                
                showMessage(`${files.length} archivo(s) subido(s) exitosamente`, 'success');
                
                bootstrap.Modal.getInstance(document.getElementById('addFilesModal')).hide();
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error al subir archivos: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // ==========================================
        // CREAR NUEVA SOLICITUD
        // ==========================================
        function openCreateRequestModal() {
            document.getElementById('createRequestForm').reset();
            document.getElementById('createDynamicFields').innerHTML = '';
            document.getElementById('createCategoryHelp').textContent = '';
            document.getElementById('createFilesPreview').innerHTML = '';
            document.getElementById('createBalanceAlert').innerHTML = '';
            selectedCategory = null;
            selectedFiles = [];
            
            const modal = new bootstrap.Modal(document.getElementById('createRequestModal'));
            modal.show();
        }

        document.getElementById('createCategory').addEventListener('change', function() {
            const categoryId = this.value;
            if (!categoryId) {
                document.getElementById('createDynamicFields').innerHTML = '';
                document.getElementById('createCategoryHelp').textContent = '';
                selectedCategory = null;
                return;
            }
            
            selectedCategory = categories.find(c => c.category_id === categoryId);
            if (!selectedCategory) return;
            
            renderCreateDynamicFields(selectedCategory);
        });

        function renderCreateDynamicFields(category) {
            const container = document.getElementById('createDynamicFields');
            let html = '';
            
            // Informaci√≥n de la categor√≠a
            let helpText = '';
            if (category.is_paid) {
                helpText += '‚úì Ausencia remunerada. ';
            }
            if (category.requires_authorization) {
                helpText += '‚úì Requiere autorizaci√≥n. ';
            }
            document.getElementById('createCategoryHelp').textContent = helpText;
            
            // Campos de fecha seg√∫n configuraci√≥n
            if (category.full_day_only) {
                html += `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="createStartDate" class="form-label">Fecha Inicial <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="createStartDate" required onchange="calculateCreateTotals()">
                        </div>
                        <div class="col-md-6">
                            <label for="createEndDate" class="form-label">Fecha Final <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="createEndDate" required onchange="calculateCreateTotals()">
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="createSingleDate" class="form-label">Fecha <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="createSingleDate" required onchange="calculateCreateTotals()">
                        </div>
                        <div class="col-md-4">
                            <label for="createStartTime" class="form-label">Hora Inicial <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="createStartTime" required onchange="calculateCreateTotals()">
                        </div>
                        <div class="col-md-4">
                            <label for="createEndTime" class="form-label">Hora Final <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="createEndTime" required onchange="calculateCreateTotals()">
                        </div>
                    </div>
                `;
            }
            
            // Campo de reemplazo si es necesario
            if (category.worker_finds_replacement) {
                html += `
                    <div class="mb-3">
                        <label for="createReplacementWorker" class="form-label">Trabajador de Reemplazo</label>
                        <select class="form-select" id="createReplacementWorker">
                            <option value="">Sin reemplazo</option>
                        </select>
                        <div class="form-text">Opcional para esta categor√≠a</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Actualizar opciones de reemplazo cuando cambie el trabajador
            if (category.worker_finds_replacement) {
                document.getElementById('createWorker').addEventListener('change', updateReplacementOptions);
            }
        }

        function updateReplacementOptions() {
            const workerId = document.getElementById('createWorker').value;
            if (!workerId) return;
            
            const replacementSelect = document.getElementById('createReplacementWorker');
            if (!replacementSelect) return;
            
            const currentWorker = workers.find(w => w.worker_id === workerId);
            const hasSection = currentWorker && currentWorker.section_id;
            
            const filteredWorkers = workers.filter(w => {
                if (w.worker_id === workerId) return false;
                if (w.is_replacement) return false;
                if (hasSection) {
                    return w.section_id !== null;
                } else {
                    return w.section_id === null;
                }
            });
            
            replacementSelect.innerHTML = '<option value="">Sin reemplazo</option>';
            filteredWorkers.forEach(w => {
                const option = document.createElement('option');
                option.value = w.worker_id;
                option.textContent = `${w.worker_first_name} ${w.worker_last_name_1}`;
                replacementSelect.appendChild(option);
            });
        }

        function calculateCreateTotals() {
            if (!selectedCategory) return;
            
            let totalDays = 0;
            let totalHours = 0;
            
            if (selectedCategory.full_day_only) {
                const startDate = document.getElementById('createStartDate').value;
                const endDate = document.getElementById('createEndDate').value;
                
                if (!startDate || !endDate) return;
                
                if (new Date(endDate) < new Date(startDate)) {
                    showMessage('La fecha final debe ser mayor o igual a la fecha inicial', 'warning');
                    return;
                }
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                totalDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                const workdayStart = hrConfig.workday_start_time || '07:00:00';
                const workdayEnd = hrConfig.workday_end_time || '15:00:00';
                const hoursPerDay = calculateHoursPerDay(workdayStart, workdayEnd);
                
                totalHours = totalDays * hoursPerDay;
                
            } else {
                const singleDate = document.getElementById('createSingleDate').value;
                const startTime = document.getElementById('createStartTime').value;
                const endTime = document.getElementById('createEndTime').value;
                
                if (!singleDate || !startTime || !endTime) return;
                
                if (endTime <= startTime) {
                    showMessage('La hora final debe ser mayor a la hora inicial', 'warning');
                    return;
                }
                
                const start = new Date('2000-01-01 ' + startTime);
                const end = new Date('2000-01-01 ' + endTime);
                totalHours = (end - start) / (1000 * 60 * 60);
                
                const workdayStart = hrConfig.workday_start_time || '07:00:00';
                const workdayEnd = hrConfig.workday_end_time || '15:00:00';
                const hoursPerDay = calculateHoursPerDay(workdayStart, workdayEnd);
                totalDays = totalHours / hoursPerDay;
            }
            
            document.getElementById('createTotalDays').value = totalDays.toFixed(2);
            document.getElementById('createTotalHours').value = totalHours.toFixed(2);
            
            // Mostrar advertencia de saldo si aplica (pero no bloquear)
            showBalanceWarning(totalDays, totalHours);
        }

        async function showBalanceWarning(totalDays, totalHours) {
            if (!selectedCategory) return;
            
            const workerId = document.getElementById('createWorker').value;
            if (!workerId) return;
            
            const alertDiv = document.getElementById('createBalanceAlert');
            if (!alertDiv) return;
            
            // Calcular saldos del trabajador seleccionado
            const balances = await calculateWorkerBalances(workerId);
            
            let message = '';
            let hasWarning = false;
            
            if (selectedCategory.controls_personal_hours_limit) {
                if (totalHours > balances.personalHours) {
                    message += `‚ö†Ô∏è <strong>Advertencia:</strong> El trabajador tiene ${balances.personalHours.toFixed(2)} horas disponibles, se est√°n solicitando ${totalHours.toFixed(2)} horas.<br>`;
                    hasWarning = true;
                }
            }
            
            if (selectedCategory.controls_calamity_days_limit) {
                if (totalDays > balances.calamityDays) {
                    message += `‚ö†Ô∏è <strong>Advertencia:</strong> El trabajador tiene ${balances.calamityDays.toFixed(2)} d√≠as de calamidad disponibles, se est√°n solicitando ${totalDays.toFixed(2)} d√≠as.<br>`;
                    hasWarning = true;
                }
            }
            
            if (hasWarning) {
                alertDiv.className = 'alert alert-warning';
                alertDiv.innerHTML = message + '<small>Como administrador, puedes crear la solicitud de todas formas.</small>';
                alertDiv.style.display = 'block';
            } else {
                alertDiv.style.display = 'none';
            }
        }

        async function calculateWorkerBalances(workerId) {
            try {
                // Obtener ajustes manuales de horas personales
                const personalAdjustments = await supabaseRequest('/hr_balance_adjustments?worker_id=eq.' + workerId + '&adjustment_type=eq.personal_hours&select=amount');
                let personalTotal = 0;
                if (personalAdjustments && personalAdjustments.length > 0) {
                    personalTotal = personalAdjustments.reduce((sum, adj) => sum + parseFloat(adj.amount || 0), 0);
                }
                
                // Obtener consumo de horas personales
                const personalRequests = await supabaseRequest('/hr_absence_requests?worker_id=eq.' + workerId + '&status=eq.approved&select=total_hours,category_id');
                let personalConsumed = 0;
                if (personalRequests && personalRequests.length > 0) {
                    for (const req of personalRequests) {
                        const category = categories.find(c => c.category_id === req.category_id);
                        if (category && category.accumulates_personal_hours) {
                            personalConsumed += parseFloat(req.total_hours || 0);
                        }
                    }
                }
                
                const personalHours = personalTotal - personalConsumed;
                
                // Obtener ajustes manuales de d√≠as de calamidad
                const calamityAdjustments = await supabaseRequest('/hr_balance_adjustments?worker_id=eq.' + workerId + '&adjustment_type=eq.calamity_days&select=amount');
                let calamityTotal = 0;
                if (calamityAdjustments && calamityAdjustments.length > 0) {
                    calamityTotal = calamityAdjustments.reduce((sum, adj) => sum + parseFloat(adj.amount || 0), 0);
                }
                
                // Obtener consumo de d√≠as de calamidad
                const calamityRequests = await supabaseRequest('/hr_absence_requests?worker_id=eq.' + workerId + '&status=eq.approved&select=total_days,category_id');
                let calamityConsumed = 0;
                if (calamityRequests && calamityRequests.length > 0) {
                    for (const req of calamityRequests) {
                        const category = categories.find(c => c.category_id === req.category_id);
                        if (category && category.controls_calamity_days_limit) {
                            calamityConsumed += parseFloat(req.total_days || 0);
                        }
                    }
                }
                
                const calamityDays = calamityTotal - calamityConsumed;
                
                return {
                    personalHours,
                    calamityDays
                };
                
            } catch (error) {
                console.error('Error al calcular saldos:', error);
                return {
                    personalHours: 0,
                    calamityDays: 0
                };
            }
        }

        document.getElementById('createFilesInput').addEventListener('change', function(e) {
            selectedFiles = Array.from(e.target.files);
            renderCreateFilesPreview();
        });

        function renderCreateFilesPreview() {
            const preview = document.getElementById('createFilesPreview');
            preview.innerHTML = '';
            
            if (selectedFiles.length === 0) return;
            
            selectedFiles.forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'alert alert-info d-flex justify-content-between align-items-center';
                fileDiv.innerHTML = `
                    <span>
                        <i class="bi bi-file-earmark me-2"></i>
                        ${file.name} (${(file.size / 1024).toFixed(2)} KB)
                    </span>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeCreateFile(${index})">
                        <i class="bi bi-x"></i>
                    </button>
                `;
                preview.appendChild(fileDiv);
            });
        }

        function removeCreateFile(index) {
            selectedFiles.splice(index, 1);
            renderCreateFilesPreview();
        }

        // ==========================================
        // ENV√çO DEL FORMULARIO DE CREACI√ìN
        // ==========================================
        document.getElementById('createRequestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!selectedCategory) {
                showMessage('Debes seleccionar una categor√≠a', 'warning');
                return;
            }
            
            const workerId = document.getElementById('createWorker').value;
            if (!workerId) {
                showMessage('Debes seleccionar un trabajador', 'warning');
                return;
            }
            
            // Validar campos requeridos seg√∫n tipo de categor√≠a
            if (selectedCategory.full_day_only) {
                const startDate = document.getElementById('createStartDate').value;
                const endDate = document.getElementById('createEndDate').value;
                if (!startDate || !endDate) {
                    showMessage('Debes completar las fechas', 'warning');
                    return;
                }
            } else {
                const singleDate = document.getElementById('createSingleDate').value;
                const startTime = document.getElementById('createStartTime').value;
                const endTime = document.getElementById('createEndTime').value;
                if (!singleDate || !startTime || !endTime) {
                    showMessage('Debes completar la fecha y horas', 'warning');
                    return;
                }
            }
            
            if (!confirm('¬øEst√°s seguro de crear esta solicitud de ausencia?')) {
                return;
            }
            
            showLoading(true);
            
            try {
                const initialStatus = document.getElementById('createInitialStatus').value;
                const requestId = await createRequest(workerId, initialStatus);
                
                // Subir archivos si hay
                if (selectedFiles.length > 0) {
                    await uploadRequestFiles(requestId, workerId);
                }
                
                // Crear autorizaciones y notificar seg√∫n estado inicial
                if (initialStatus === 'pending' && selectedCategory.requires_authorization) {
                    await createRequestAuthorizations(requestId, workerId);
                    await sendAuthorizationNotifications(requestId, workerId);
                } else if (initialStatus === 'approved') {
                    await sendApprovedNotification(requestId, workerId);
                }
                
                // Notificaciones adicionales seg√∫n configuraci√≥n de categor√≠a
                await sendCategoryNotifications(requestId, workerId);
                
                showMessage('¬°Solicitud creada exitosamente!', 'success');
                
                bootstrap.Modal.getInstance(document.getElementById('createRequestModal')).hide();
                await loadRequests();
                
            } catch (error) {
                console.error('Error al crear solicitud:', error);
                showMessage('Error al crear la solicitud: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        });

        async function createRequest(workerId, initialStatus) {
            const totalDays = parseFloat(document.getElementById('createTotalDays').value);
            const totalHours = parseFloat(document.getElementById('createTotalHours').value);
            const description = document.getElementById('createDescription').value;
            
            let requestData = {
                worker_id: workerId,
                category_id: selectedCategory.category_id,
                total_days: totalDays,
                total_hours: totalHours,
                description: description,
                status: initialStatus
            };
            
            if (selectedCategory.full_day_only) {
                requestData.start_date = formatDateForDatabase(document.getElementById('createStartDate').value);
                requestData.end_date = formatDateForDatabase(document.getElementById('createEndDate').value);
                requestData.is_full_day = true;
            } else {
                const singleDate = formatDateForDatabase(document.getElementById('createSingleDate').value);
                requestData.start_date = singleDate;
                requestData.end_date = singleDate;
                requestData.start_time = document.getElementById('createStartTime').value;
                requestData.end_time = document.getElementById('createEndTime').value;
                requestData.is_full_day = false;
            }
            
            if (selectedCategory.worker_finds_replacement) {
                const replacementId = document.getElementById('createReplacementWorker').value;
                if (replacementId) {
                    requestData.replacement_worker_id = replacementId;
                }
            }
            
            const result = await supabaseRequest('/hr_absence_requests', {
                method: 'POST',
                body: JSON.stringify(requestData)
            });
            
            if (!result || result.length === 0) {
                throw new Error('No se pudo crear la solicitud');
            }
            
            console.log('‚úÖ Solicitud creada:', result[0].request_id);
            return result[0].request_id;
        }

        async function uploadRequestFiles(requestId, workerId) {
            console.log(`üìé Subiendo ${selectedFiles.length} archivos...`);
            const BUCKET_NAME = 'hr-absence-supports';
            
            for (const file of selectedFiles) {
                try {
                    if (file.size > 10 * 1024 * 1024) {
                        console.warn(`Archivo ${file.name} excede 10MB, omitiendo...`);
                        continue;
                    }
                    
                    const timestamp = Date.now();
                    const sanitizedName = file.name.replace(/[^a-z0-9.-]/gi, '_').toLowerCase();
                    const filePath = `${workerId}/${requestId}/${timestamp}_${sanitizedName}`;
                    
                    const { data, error } = await supabaseClient
                        .storage
                        .from(BUCKET_NAME)
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (error) {
                        console.error('Error al subir archivo:', error);
                        continue;
                    }
                    
                    const { data: urlData } = supabaseClient
                        .storage
                        .from(BUCKET_NAME)
                        .getPublicUrl(filePath);
                    
                    const publicUrl = urlData.publicUrl;
                    
                    await supabaseRequest('/hr_absence_attachments', {
                        method: 'POST',
                        body: JSON.stringify({
                            request_id: requestId,
                            file_name: file.name,
                            file_path: publicUrl,
                            file_type: file.type,
                            file_size: file.size,
                            uploaded_by: currentSession.user_id
                        })
                    });
                    
                    console.log('‚úÖ Archivo subido:', file.name);
                    
                } catch (error) {
                    console.error('Error al procesar archivo:', file.name, error);
                }
            }
        }

        async function createRequestAuthorizations(requestId, workerId) {
            const totalDays = parseFloat(document.getElementById('createTotalDays').value);
            
            // Buscar jefe principal
            const managersData = await supabaseRequest('/worker_managers?worker_id=eq.' + workerId + '&is_primary_manager=eq.true&assignment_status=eq.active&select=manager_id');
            
            if (!managersData || managersData.length === 0) {
                console.warn('‚ö†Ô∏è No se encontr√≥ jefe principal, omitiendo autorizaci√≥n nivel 1');
                return;
            }
            
            const authorizations = [];
            
            // NIVEL 1: Jefe principal
            authorizations.push({
                request_id: requestId,
                authorizer_id: managersData[0].manager_id,
                authorization_level: 'primary_manager',
                status: 'pending'
            });
            
            // NIVEL 2: TH (condicional)
            if (selectedCategory.days_require_hr_authorization && 
                totalDays >= selectedCategory.days_require_hr_authorization) {
                
                const thData = await supabaseRequest('/worker_job_roles?job_role_id=eq.062dc47e-6206-4c15-999e-c935363221e9&assignment_status=eq.active&select=worker_id');
                
                if (thData && thData.length > 0) {
                    authorizations.push({
                        request_id: requestId,
                        authorizer_id: thData[0].worker_id,
                        authorization_level: 'hr',
                        status: 'pending'
                    });
                }
            }
            
            // NIVEL 3: Instancia superior (condicional)
            if (selectedCategory.days_require_upper_authorization && 
                totalDays >= selectedCategory.days_require_upper_authorization) {
                
                const workerData = workers.find(w => w.worker_id === workerId);
                const hasSection = workerData && workerData.section_id;
                const roleId = hasSection ? 'a2b87928-a634-4dad-a35c-177d1a0f7fbc' : '1e188037-9e62-4140-b6dd-4273e2d84a12';
                
                const upperData = await supabaseRequest('/worker_job_roles?job_role_id=eq.' + roleId + '&assignment_status=eq.active&select=worker_id');
                
                if (upperData && upperData.length > 0) {
                    authorizations.push({
                        request_id: requestId,
                        authorizer_id: upperData[0].worker_id,
                        authorization_level: 'upper_management',
                        status: 'pending'
                    });
                }
            }
            
            // Crear registros de autorizaci√≥n
            for (const auth of authorizations) {
                await supabaseRequest('/hr_absence_authorizations', {
                    method: 'POST',
                    body: JSON.stringify(auth)
                });
            }
            
            console.log(`‚úÖ ${authorizations.length} autorizaciones creadas`);
        }

        async function sendAuthorizationNotifications(requestId, workerId) {
            try {
                const authData = await supabaseRequest('/hr_absence_authorizations?request_id=eq.' + requestId + '&select=authorizer_id');
                
                if (!authData || authData.length === 0) return;
                
                const authorizerIds = authData.map(a => a.authorizer_id);
                const workersData = await supabaseRequest('/workers?worker_id=in.(' + authorizerIds.join(',') + ')&select=email,worker_first_name,worker_last_name_1');
                
                if (!workersData || workersData.length === 0) return;
                
                const emails = workersData.map(w => w.email).filter(e => e);
                
                if (emails.length === 0) return;
                
                // Obtener datos del trabajador solicitante
                const requestWorkerData = await supabaseRequest('/workers?worker_id=eq.' + workerId + '&select=worker_first_name,worker_last_name_1');
                const workerName = requestWorkerData[0] ? 
                    `${requestWorkerData[0].worker_first_name} ${requestWorkerData[0].worker_last_name_1}` : 'N/A';
                
                const requestData = selectedCategory.full_day_only ? 
                    `${document.getElementById('createStartDate').value} al ${document.getElementById('createEndDate').value}` :
                    `${document.getElementById('createSingleDate').value} de ${document.getElementById('createStartTime').value} a ${document.getElementById('createEndTime').value}`;
                
                const emailBody = `
                    <h3>Nueva Solicitud de Ausencia</h3>
                    <p><strong>Solicitante:</strong> ${workerName}</p>
                    <p><strong>Categor√≠a:</strong> ${selectedCategory.name}</p>
                    <p><strong>Fechas:</strong> ${requestData}</p>
                    <p><strong>Total d√≠as:</strong> ${document.getElementById('createTotalDays').value}</p>
                    <p><strong>Total horas:</strong> ${document.getElementById('createTotalHours').value}</p>
                    <p><strong>Descripci√≥n:</strong> ${document.getElementById('createDescription').value || 'Sin descripci√≥n'}</p>
                    <p><strong>Nota:</strong> Esta solicitud fue creada por el personal de Talento Humano.</p>
                    <p><a href="${window.location.origin}/modules/hr/authorize-absences.html">Ver y autorizar solicitud</a></p>
                `;
                
                await sendNotification(
                    emails.join(','),
                    'Nueva solicitud de ausencia pendiente de autorizaci√≥n',
                    emailBody,
                    false
                );
                
                console.log('‚úÖ Notificaciones de autorizaci√≥n enviadas');
                
            } catch (error) {
                console.error('Error al enviar notificaciones de autorizaci√≥n:', error);
            }
        }

        async function sendApprovedNotification(requestId, workerId) {
            try {
                const workerData = await supabaseRequest('/workers?worker_id=eq.' + workerId + '&select=email,worker_first_name,worker_last_name_1');
                
                if (!workerData || workerData.length === 0) return;
                
                const workerEmail = workerData[0].email;
                if (!workerEmail) return;
                
                const workerName = `${workerData[0].worker_first_name} ${workerData[0].worker_last_name_1}`;
                
                const requestData = selectedCategory.full_day_only ? 
                    `${document.getElementById('createStartDate').value} al ${document.getElementById('createEndDate').value}` :
                    `${document.getElementById('createSingleDate').value} de ${document.getElementById('createStartTime').value} a ${document.getElementById('createEndTime').value}`;
                
                const emailBody = `
                    <h3>Solicitud de Ausencia Aprobada</h3>
                    <p>Hola ${workerName},</p>
                    <p>Tu solicitud de ausencia ha sido registrada como <strong>APROBADA</strong> por el personal de Talento Humano.</p>
                    <p><strong>Categor√≠a:</strong> ${selectedCategory.name}</p>
                    <p><strong>Fechas:</strong> ${requestData}</p>
                    <p><strong>Total d√≠as:</strong> ${document.getElementById('createTotalDays').value}</p>
                    <p><strong>Total horas:</strong> ${document.getElementById('createTotalHours').value}</p>
                    ${document.getElementById('createDescription').value ? `<p><strong>Descripci√≥n:</strong> ${document.getElementById('createDescription').value}</p>` : ''}
                    <p>No requiere autorizaciones adicionales.</p>
                `;
                
                await sendNotification(
                    workerEmail,
                    'Solicitud de ausencia aprobada',
                    emailBody,
                    false
                );
                
                console.log('‚úÖ Notificaci√≥n de aprobaci√≥n enviada al trabajador');
                
            } catch (error) {
                console.error('Error al enviar notificaci√≥n de aprobaci√≥n:', error);
            }
        }

        async function sendCategoryNotifications(requestId, workerId) {
            try {
                const emails = [];
                
                // Notificar a TH si la categor√≠a lo requiere
                if (selectedCategory.notify_hr && hrConfig.hr_manager_email) {
                    emails.push(hrConfig.hr_manager_email);
                }
                
                // Notificar al jefe principal si la categor√≠a lo requiere
                if (selectedCategory.notify_managers) {
                    const managersData = await supabaseRequest('/worker_managers?worker_id=eq.' + workerId + '&is_primary_manager=eq.true&assignment_status=eq.active&select=manager:workers!worker_managers_manager_id_fkey(email)');
                    
                    if (managersData && managersData.length > 0 && managersData[0].manager?.email) {
                        emails.push(managersData[0].manager.email);
                    }
                }
                
                // Notificar al email de la secci√≥n si la categor√≠a lo requiere
                if (selectedCategory.notify_section_email) {
                    const workerData = workers.find(w => w.worker_id === workerId);
                    if (workerData && workerData.section_id) {
                        const sectionData = await supabaseRequest('/sections?section_id=eq.' + workerData.section_id + '&select=section_name');
                        
                        if (sectionData && sectionData.length > 0) {
                            const sectionName = sectionData[0].section_name.toLowerCase();
                            
                            // Mapear nombre de secci√≥n a email configurado
                            if (sectionName.includes('preescolar') && hrConfig.preschool_email) {
                                emails.push(hrConfig.preschool_email);
                            } else if (sectionName.includes('primaria') && hrConfig.elementary_email) {
                                emails.push(hrConfig.elementary_email);
                            } else if (sectionName.includes('media') && hrConfig.middle_school_email) {
                                emails.push(hrConfig.middle_school_email);
                            } else if (sectionName.includes('bachillerato') && hrConfig.high_school_email) {
                                emails.push(hrConfig.high_school_email);
                            }
                        }
                    } else if (hrConfig.non_school_email) {
                        emails.push(hrConfig.non_school_email);
                    }
                }
                
                if (emails.length === 0) return;
                
                // Eliminar duplicados
                const uniqueEmails = [...new Set(emails)];
                
                const workerData = await supabaseRequest('/workers?worker_id=eq.' + workerId + '&select=worker_first_name,worker_last_name_1');
                const workerName = workerData[0] ? 
                    `${workerData[0].worker_first_name} ${workerData[0].worker_last_name_1}` : 'N/A';
                
                const requestData = selectedCategory.full_day_only ? 
                    `${document.getElementById('createStartDate').value} al ${document.getElementById('createEndDate').value}` :
                    `${document.getElementById('createSingleDate').value} de ${document.getElementById('createStartTime').value} a ${document.getElementById('createEndTime').value}`;
                
                const emailBody = `
                    <h3>Notificaci√≥n de Ausencia</h3>
                    <p><strong>Trabajador:</strong> ${workerName}</p>
                    <p><strong>Categor√≠a:</strong> ${selectedCategory.name}</p>
                    <p><strong>Fechas:</strong> ${requestData}</p>
                    <p><strong>Total d√≠as:</strong> ${document.getElementById('createTotalDays').value}</p>
                    <p><strong>Total horas:</strong> ${document.getElementById('createTotalHours').value}</p>
                    ${document.getElementById('createDescription').value ? `<p><strong>Descripci√≥n:</strong> ${document.getElementById('createDescription').value}</p>` : ''}
                    <p><small>Esta es una notificaci√≥n informativa seg√∫n la configuraci√≥n de la categor√≠a de ausencia.</small></p>
                `;
                
                await sendNotification(
                    uniqueEmails.join(','),
                    'Notificaci√≥n de ausencia - ' + selectedCategory.name,
                    emailBody,
                    true
                );
                
                console.log('‚úÖ Notificaciones adicionales enviadas');
                
            } catch (error) {
                console.error('Error al enviar notificaciones adicionales:', error);
            }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
