<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.10.30.19.23">
    <title>Aplicaciones de Encuestas - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge-status {
            font-size: 0.75rem;
            padding: 0.35rem 0.65rem;
        }

        .status-draft {
            background-color: #6c757d;
        }

        .status-open {
            background-color: #28a745;
        }

        .status-closed {
            background-color: #dc3545;
        }

        .url-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .url-input {
            flex: 1;
            font-family: monospace;
            font-size: 0.85rem;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .btn-copy {
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }

        .application-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: #e7f1ff;
            color: #0d6efd;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .date-range {
            font-size: 0.85rem;
            color: #6c757d;
        }

        /* Estilos para aplicaciones vencidas */
        .status-expired {
            background-color: #ff6b6b;
            animation: pulse-expired 2s infinite;
        }
        
        @keyframes pulse-expired {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .badge-vencida {
            background-color: #ff9800;
            color: white;
            font-weight: bold;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .row-vencida {
            background-color: #fff3cd !important;
            border-left: 4px solid #ff9800;
        }
        
        .btn-close-expired {
            animation: shake 0.5s infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Encuestas</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Aplicaciones
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-send-check me-2"></i>
                    Aplicaciones de Encuestas
                </h1>
                <p class="text-muted">
                    Crear y gestionar aplicaciones de encuestas con URLs √∫nicas
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- TARJETA PRINCIPAL -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list me-2"></i>Listado de Aplicaciones
                    <span id="badge-vencidas" class="badge bg-warning ms-2" style="display: none;">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <span id="count-vencidas">0</span> vencidas
                    </span>
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-warning" onclick="cerrarTodasVencidas()" 
                            id="btnCerrarVencidas" style="display: none;">
                        <i class="bi bi-lock-fill me-1"></i>Cerrar Vencidas
                    </button>
                    <button class="btn btn-primary" onclick="abrirModalCrear()" id="btnCrear">
                        <i class="bi bi-plus-circle me-1"></i>Nueva Aplicaci√≥n
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tabla-applications">
                        <thead class="table-dark">
                            <tr>
                                <th width="60">#</th>
                                <th>Nombre de Aplicaci√≥n</th>
                                <th>Maestro</th>
                                <th>Fechas</th>
                                <th>Estado</th>
                                <th>Respuestas</th>
                                <th>URL P√∫blica</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando aplicaciones...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    <!-- MODAL PARA CREAR/EDITAR APLICACI√ìN -->
    <div class="modal fade" id="modal-application" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">
                        <i class="bi bi-plus-circle me-2"></i>Nueva Aplicaci√≥n
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="formulario-application">
                    <input type="hidden" id="application_id" name="application_id">
                    
                    <div class="modal-body">
                        
                        <!-- Selecci√≥n de Maestro -->
                        <div class="mb-3">
                            <label for="survey_master_id" class="form-label">
                                Maestro de Encuesta <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="survey_master_id" 
                                    name="survey_master_id" required>
                                <option value="">Cargando maestros...</option>
                            </select>
                            <div class="form-text">
                                Selecciona qu√© encuesta maestra deseas aplicar
                            </div>
                        </div>

                        <!-- Nombre de Aplicaci√≥n -->
                        <div class="mb-3">
                            <label for="application_name" class="form-label">
                                Nombre de la Aplicaci√≥n <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="application_name" 
                                   name="application_name" required 
                                   placeholder="Ej: Semestre 1 - 2025">
                            <div class="form-text">
                                Nombre descriptivo que identifique esta aplicaci√≥n en el tiempo
                            </div>
                        </div>

                        <!-- Fechas -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="start_date" class="form-label">
                                        Fecha de Inicio <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="start_date" 
                                           name="start_date" required>
                                    <div class="form-text">
                                        Cu√°ndo estar√° disponible para responder
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="end_date" class="form-label">
                                        Fecha de Fin <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="end_date" 
                                           name="end_date" required>
                                    <div class="form-text">
                                        Cu√°ndo se cerrar√° autom√°ticamente
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Estado -->
                        <div class="mb-3">
                            <label for="status" class="form-label">
                                Estado Inicial <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="draft">Borrador (no se puede responder a√∫n)</option>
                                <option value="open">Abierta (lista para recibir respuestas)</option>
                            </select>
                            <div class="form-text">
                                Puedes crear en modo borrador y activarla despu√©s
                            </div>
                        </div>

                        <!-- Info de n√∫mero de aplicaci√≥n -->
                        <div class="alert alert-info" id="app-number-info" style="display: none;">
                            <i class="bi bi-info-circle me-2"></i>
                            Esta ser√° la aplicaci√≥n <strong>#<span id="next-app-number">1</span></strong> 
                            de este maestro
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btn-guardar">
                            <i class="bi bi-save me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let mastersCache = [];
        let applicationsCache = [];
        let modalInstance = null;
        let currentUser = null;
        let modoEdicion = false;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // Obtener sesi√≥n
                const session = getStoredSession();
                if (!session || !session.user) {
                    console.log('‚ùå No hay sesi√≥n activa');
                    window.location.href = '../../login.html';
                    return;
                }
                currentUser = session.user;
                
                // Verificar permisos
                const hasAccess = await validatePageAccess('Gestionar aplicaciones');
                if (!hasAccess) {
                    console.log('‚ùå Sin permisos para este m√≥dulo');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido');
                
                // Inicializar p√°gina
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Inicializar modal
                modalInstance = new bootstrap.Modal(document.getElementById('modal-application'));
                
                // Configurar event listeners
                document.getElementById('formulario-application').addEventListener('submit', manejarSubmitFormulario);
                document.getElementById('survey_master_id').addEventListener('change', calcularNumeroAplicacion);
                
                // Cargar datos iniciales
                await cargarMaestros();
                await cargarAplicaciones();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR MAESTROS DEL USUARIO
        // ==========================================
        async function cargarMaestros() {
            try {
                console.log('üì° Cargando maestros...');
                
                const data = await supabaseRequest('/survey_masters?select=*&created_by=eq.' + currentUser.user_id + '&is_active=eq.true&order=survey_name.asc');
                mastersCache = data || [];
                
                console.log(`‚úÖ ${mastersCache.length} maestros cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando maestros:', error);
                showMessage('Error al cargar maestros: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // POBLAR SELECT DE MAESTROS EN MODAL
        // ==========================================
        function poblarSelectMaestros() {
            const selectMaster = document.getElementById('survey_master_id');
            
            if (mastersCache.length === 0) {
                selectMaster.innerHTML = '<option value="">No tienes maestros creados</option>';
                return;
            }
            
            selectMaster.innerHTML = '<option value="">Selecciona un maestro...</option>' +
                mastersCache.map(m => `<option value="${m.survey_master_id}">${escapeHtml(m.survey_name)}</option>`).join('');
        }
      // ==========================================
        // CALCULAR N√öMERO DE APLICACI√ìN
        // ==========================================
        async function calcularNumeroAplicacion() {
            const masterId = document.getElementById('survey_master_id').value;
            
            if (!masterId) {
                document.getElementById('app-number-info').style.display = 'none';
                return;
            }
            
            try {
                // Contar aplicaciones existentes para este maestro
                const existingApps = applicationsCache.filter(app => app.survey_master_id === masterId);
                const nextNumber = existingApps.length + 1;
                
                document.getElementById('next-app-number').textContent = nextNumber;
                document.getElementById('app-number-info').style.display = 'block';
                
            } catch (error) {
                console.error('Error calculando n√∫mero de aplicaci√≥n:', error);
            }
        }

        // ==========================================
        // CARGA DE APLICACIONES CON CIERRE AUTOM√ÅTICO MEJORADO
        // ==========================================
        async function cargarAplicaciones() {
            try {
                console.log('üì° Cargando aplicaciones...');
                
                // Cargar aplicaciones de los maestros del usuario
                const masterIds = mastersCache.map(m => m.survey_master_id);
                
                if (masterIds.length === 0) {
                    applicationsCache = [];
                    renderizarTabla([]);
                    actualizarContadorVencidas();
                    return;
                }
                
                // Construir query con filtro por maestros del usuario
                const query = '/survey_applications?select=*,survey_masters(survey_name)&survey_master_id=in.(' + masterIds.join(',') + ')&order=created_at.desc';
                const data = await supabaseRequest(query);
                applicationsCache = data || [];
                
                let cerradasAutomaticamente = 0;
                
                // Contar respuestas y procesar cierre autom√°tico
                for (let app of applicationsCache) {
                    const responses = await supabaseRequest('/survey_respondent_profile?select=profile_id&application_id=eq.' + app.application_id);
                    app.responses_count = responses.length;
                    
                    // L√ìGICA DE CIERRE AUTOM√ÅTICO MEJORADA
                    if (app.status === 'open' && app.closed_manually !== false) {
                        // Crear fecha de fin a las 23:59:59 del d√≠a configurado
                        const endDate = new Date(app.end_date + 'T23:59:59');
                        const now = new Date();
                        
                        // Solo cerrar si YA pas√≥ completamente el d√≠a de fin
                        if (now > endDate) {
                            try {
                                await supabaseRequest('/survey_applications?application_id=eq.' + app.application_id, {
                                    method: 'PATCH',
                                    body: JSON.stringify({ 
                                        status: 'closed',
                                        closed_manually: null,
                                        closed_by: null,
                                        closed_at: new Date().toISOString()
                                    })
                                });
                                app.status = 'closed';
                                cerradasAutomaticamente++;
                                console.log(`‚úÖ Aplicaci√≥n "${app.application_name}" cerrada autom√°ticamente`);
                            } catch (error) {
                                console.error(`‚ùå Error cerrando aplicaci√≥n ${app.application_name}:`, error);
                            }
                        }
                    }
                    
                    // Marcar como vencida si est√° abierta pero pas√≥ la fecha
                    app.isExpired = (app.status === 'open' || app.status === 'draft') && 
                                    new Date(app.end_date + 'T23:59:59') < new Date();
                }
                
                // Mostrar notificaci√≥n si se cerraron aplicaciones
                if (cerradasAutomaticamente > 0) {
                    showMessage(
                        `‚úÖ Se cerraron autom√°ticamente ${cerradasAutomaticamente} aplicaci√≥n(es) vencida(s). Ahora puedes ver sus resultados.`,
                        'success',
                        5000
                    );
                }
                
                renderizarTabla(applicationsCache);
                actualizarContadorVencidas();
                
                console.log(`‚úÖ ${applicationsCache.length} aplicaciones cargadas (${cerradasAutomaticamente} cerradas autom√°ticamente)`);
                
            } catch (error) {
                console.error('‚ùå Error cargando aplicaciones:', error);
                showMessage('Error al cargar aplicaciones: ' + error.message, 'danger');
                
                document.getElementById('tabla-body').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <i class="bi bi-exclamation-triangle text-warning"></i>
                            <div class="mt-2">Error al cargar datos</div>
                        </td>
                    </tr>
                `;
            }
        }
        
        // ==========================================
        // RENDERIZADO DE TABLA CON INDICADORES VISUALES DE VENCIDAS
        // ==========================================
        function renderizarTabla(datos) {
            const tbody = document.getElementById('tabla-body');
            
            if (!datos || datos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <i class="bi bi-inbox"></i>
                            <div class="mt-2">No hay aplicaciones creadas</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = datos.map(app => {
                const masterName = app.survey_masters?.survey_name || 'Maestro desconocido';
                const statusClass = 'status-' + app.status;
                const statusLabel = {
                    'draft': 'Borrador',
                    'open': 'Abierta',
                    'closed': 'Cerrada'
                }[app.status] || app.status;
                
                // Determinar si est√° vencida
                const isExpired = app.isExpired || false;
                const rowClass = isExpired ? 'row-vencida' : '';
                
                const dateRange = `
                    <div class="date-range">
                        <i class="bi bi-calendar-event me-1"></i>
                        ${formatDate(app.start_date)} - ${formatDate(app.end_date)}
                    </div>
                `;
                
                const publicUrl = `${window.location.origin}/modules/surveys/respond.html?app=${app.unique_url_code}`;
                
                // Badge de estado con indicador de vencida
                let statusBadge = `<span class="badge badge-status ${statusClass}">${statusLabel}</span>`;
                if (isExpired && app.status !== 'closed') {
                    statusBadge += ` <span class="badge badge-vencida ms-1">VENCIDA</span>`;
                }
                
                // Botones de acci√≥n seg√∫n estado
                let actionButtons = `
                    <button class="btn btn-outline-primary btn-sm" 
                            onclick="editarAplicacion('${app.application_id}')" 
                            title="Editar">
                        <i class="bi bi-pencil"></i>
                    </button>
                `;
                
                // Permitir cerrar desde cualquier estado excepto 'closed'
                if (app.status !== 'closed') {
                    const btnClass = isExpired ? 'btn-warning btn-close-expired' : 'btn-outline-warning';
                    const btnTitle = isExpired ? '‚ö†Ô∏è CERRAR AHORA - Aplicaci√≥n vencida' : 'Cerrar ahora';
                    
                    actionButtons += `
                        <button class="btn ${btnClass} btn-sm" 
                                onclick="cerrarAplicacion('${app.application_id}')" 
                                title="${btnTitle}">
                            <i class="bi bi-lock"></i>
                        </button>
                    `;
                } else {
                    // Si est√° cerrada, mostrar bot√≥n para reabrir
                    actionButtons += `
                        <button class="btn btn-outline-success btn-sm" 
                                onclick="reabrirAplicacion('${app.application_id}')" 
                                title="Reabrir aplicaci√≥n">
                            <i class="bi bi-unlock"></i>
                        </button>
                    `;
                }
                
                actionButtons += `
                    <button class="btn btn-outline-danger btn-sm" 
                            onclick="eliminarAplicacion('${app.application_id}', ${app.responses_count})" 
                            title="Eliminar">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
                
                return `
                    <tr class="${rowClass}">
                        <td class="text-center">
                            <div class="application-number">#${app.application_number}</div>
                        </td>
                        <td>
                            <strong>${escapeHtml(app.application_name)}</strong>
                            ${isExpired && app.status !== 'closed' ? '<br><small class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Cerrar para ver resultados</small>' : ''}
                        </td>
                        <td>${escapeHtml(masterName)}</td>
                        <td>${dateRange}</td>
                        <td>${statusBadge}</td>
                        <td class="text-center">
                            <span class="badge bg-info">${app.responses_count}</span>
                        </td>
                        <td>
                            <div class="url-container">
                                <input type="text" class="url-input" value="${publicUrl}" readonly id="url-${app.application_id}">
                                <button class="btn btn-sm btn-outline-secondary btn-copy" 
                                        onclick="copiarURL('${app.application_id}')" 
                                        title="Copiar URL">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                ${actionButtons}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ==========================================
        // ACTUALIZAR CONTADOR DE APLICACIONES VENCIDAS
        // ==========================================
        function actualizarContadorVencidas() {
            const vencidas = applicationsCache.filter(app => 
                app.isExpired && app.status !== 'closed'
            );
            
            const badgeVencidas = document.getElementById('badge-vencidas');
            const countVencidas = document.getElementById('count-vencidas');
            const btnCerrarVencidas = document.getElementById('btnCerrarVencidas');
            
            if (vencidas.length > 0) {
                countVencidas.textContent = vencidas.length;
                badgeVencidas.style.display = 'inline-block';
                btnCerrarVencidas.style.display = 'block';
            } else {
                badgeVencidas.style.display = 'none';
                btnCerrarVencidas.style.display = 'none';
            }
        }

        // ==========================================
        // CERRAR TODAS LAS APLICACIONES VENCIDAS
        // ==========================================
        async function cerrarTodasVencidas() {
            try {
                const vencidas = applicationsCache.filter(app => 
                    app.isExpired && app.status !== 'closed'
                );
                
                if (vencidas.length === 0) {
                    showMessage('No hay aplicaciones vencidas para cerrar', 'info');
                    return;
                }
                
                const nombres = vencidas.map(app => `‚Ä¢ ${app.application_name}`).join('\n');
                
                if (!confirm(
                    `¬øCerrar ${vencidas.length} aplicaci√≥n(es) vencida(s)?\n\n${nombres}\n\n` +
                    `Despu√©s de cerrarlas podr√°s ver los resultados.`
                )) {
                    return;
                }
                
                mostrarLoading();
                
                let cerradas = 0;
                let errores = 0;
                
                for (const app of vencidas) {
                    try {
                        await supabaseRequest('/survey_applications?application_id=eq.' + app.application_id, {
                            method: 'PATCH',
                            body: JSON.stringify({
                                status: 'closed',
                                closed_manually: true,
                                closed_by: currentUser.user_id,
                                closed_at: new Date().toISOString()
                            })
                        });
                        cerradas++;
                        console.log(`‚úÖ Cerrada: ${app.application_name}`);
                    } catch (error) {
                        errores++;
                        console.error(`‚ùå Error cerrando ${app.application_name}:`, error);
                    }
                }
                
                if (cerradas > 0) {
                    showMessage(
                        `‚úÖ Se cerraron ${cerradas} aplicaci√≥n(es) exitosamente.${errores > 0 ? ` (${errores} con errores)` : ''}`,
                        cerradas === vencidas.length ? 'success' : 'warning'
                    );
                }
                
                await cargarAplicaciones();
                
            } catch (error) {
                console.error('Error en cierre masivo:', error);
                showMessage('Error al cerrar aplicaciones: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // COPIAR URL AL PORTAPAPELES
        // ==========================================
        function copiarURL(applicationId) {
            const input = document.getElementById('url-' + applicationId);
            input.select();
            input.setSelectionRange(0, 99999); // Para m√≥viles
            
            navigator.clipboard.writeText(input.value).then(() => {
                showMessage('URL copiada al portapapeles', 'success');
            }).catch(err => {
                console.error('Error al copiar:', err);
                showMessage('Error al copiar URL', 'danger');
            });
        }
      // ==========================================
        // GENERAR C√ìDIGO √öNICO ALEATORIO
        // ==========================================
        function generarCodigoUnico() {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let codigo = '';
            for (let i = 0; i < 8; i++) {
                codigo += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
            }
            return codigo;
        }
        
        // ==========================================
        // ABRIR MODAL PARA CREAR
        // ==========================================
        function abrirModalCrear() {
            if (mastersCache.length === 0) {
                showMessage('Primero debes crear un maestro de encuesta', 'warning');
                return;
            }
            
            modoEdicion = false;
            document.getElementById('formulario-application').reset();
            document.getElementById('application_id').value = '';
            document.getElementById('modalLabel').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nueva Aplicaci√≥n';
            document.getElementById('app-number-info').style.display = 'none';
            
            poblarSelectMaestros();
            
            // Establecer fecha de hoy como m√≠nimo
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start_date').setAttribute('min', today);
            document.getElementById('end_date').setAttribute('min', today);
            
            modalInstance.show();
        }
        
        // ==========================================
        // EDITAR APLICACI√ìN
        // ==========================================
        async function editarAplicacion(applicationId) {
            try {
                modoEdicion = true;
                const app = applicationsCache.find(a => a.application_id === applicationId);
                
                if (!app) {
                    showMessage('Aplicaci√≥n no encontrada', 'danger');
                    return;
                }
                
                poblarSelectMaestros();
                
                // Llenar formulario
                document.getElementById('application_id').value = app.application_id;
                document.getElementById('survey_master_id').value = app.survey_master_id;
                document.getElementById('application_name').value = app.application_name;
                document.getElementById('start_date').value = app.start_date;
                document.getElementById('end_date').value = app.end_date;
                document.getElementById('status').value = app.status;
                document.getElementById('app-number-info').style.display = 'none';
                
                // Deshabilitar cambio de maestro si tiene respuestas
                if (app.responses_count > 0) {
                    document.getElementById('survey_master_id').disabled = true;
                }
                
                document.getElementById('modalLabel').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Aplicaci√≥n';
                modalInstance.show();
                
            } catch (error) {
                console.error('Error al editar:', error);
                showMessage('Error al cargar datos de la aplicaci√≥n', 'danger');
            }
        }
        
        // ==========================================
        // CERRAR APLICACI√ìN MANUALMENTE
        // ==========================================
        async function cerrarAplicacion(applicationId) {
            try {
                const app = applicationsCache.find(a => a.application_id === applicationId);
                
                if (!confirm(`¬øEst√° seguro de cerrar la aplicaci√≥n "${app.application_name}"?\n\nDespu√©s de cerrarla:\n- No se aceptar√°n m√°s respuestas\n- Podr√°s ver los resultados\n- Esta acci√≥n no se puede deshacer`)) {
                    return;
                }
                
                mostrarLoading();
                
                await supabaseRequest('/survey_applications?application_id=eq.' + applicationId, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        status: 'closed',
                        closed_manually: true,
                        closed_by: currentUser.user_id,
                        closed_at: new Date().toISOString()
                    })
                });
                
                showMessage('Aplicaci√≥n cerrada exitosamente', 'success');
                await cargarAplicaciones();
                
            } catch (error) {
                console.error('Error al cerrar:', error);
                showMessage('Error al cerrar aplicaci√≥n: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }

        // ==========================================
        // REABRIR APLICACI√ìN
        // ==========================================
        async function reabrirAplicacion(applicationId) {
            try {
                const app = applicationsCache.find(a => a.application_id === applicationId);
                
                if (!confirm(`¬øEst√° seguro de reabrir la aplicaci√≥n "${app.application_name}"?\n\nDespu√©s de reabrirla:\n- Volver√° a aceptar respuestas\n- Se activar√° hasta la fecha de fin configurada`)) {
                    return;
                }
                
                mostrarLoading();
                
                await supabaseRequest('/survey_applications?application_id=eq.' + applicationId, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        status: 'open',
                        closed_manually: false,
                        closed_by: null,
                        closed_at: null
                    })
                });
                
                showMessage('Aplicaci√≥n reabierta exitosamente', 'success');
                await cargarAplicaciones();
                
            } catch (error) {
                console.error('Error al reabrir:', error);
                showMessage('Error al reabrir aplicaci√≥n: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // ELIMINAR APLICACI√ìN
        // ==========================================
        async function eliminarAplicacion(applicationId, responsesCount) {
            try {
                if (responsesCount > 0) {
                    showMessage(
                        `No se puede eliminar esta aplicaci√≥n porque tiene ${responsesCount} respuesta(s) asociada(s).`,
                        'warning'
                    );
                    return;
                }
                
                const app = applicationsCache.find(a => a.application_id === applicationId);
                
                if (!confirm(`¬øEst√° seguro de eliminar la aplicaci√≥n "${app.application_name}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                    return;
                }
                
                mostrarLoading();
                
                await supabaseRequest('/survey_applications?application_id=eq.' + applicationId, {
                    method: 'DELETE'
                });
                
                showMessage('Aplicaci√≥n eliminada exitosamente', 'success');
                await cargarAplicaciones();
                
            } catch (error) {
                console.error('Error al eliminar:', error);
                showMessage('Error al eliminar aplicaci√≥n: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }

        // ==========================================
        // SUBMIT DEL FORMULARIO - CORREGIDO CON VALIDACI√ìN DE FECHAS
        // ==========================================
        async function manejarSubmitFormulario(e) {
            e.preventDefault();
            
            try {
                mostrarLoading();
                
                const formData = new FormData(e.target);
                const applicationId = document.getElementById('application_id').value;
                
                // Validar fechas
                const startDate = new Date(formData.get('start_date') + 'T00:00:00');
                const endDate = new Date(formData.get('end_date') + 'T23:59:59');
                const now = new Date();
                
                // Validaci√≥n 1: Fecha de fin debe ser posterior a fecha de inicio
                if (endDate <= startDate) {
                    showMessage('La fecha de fin debe ser posterior a la fecha de inicio', 'warning');
                    ocultarLoading();
                    return;
                }
                
                // Validaci√≥n 2: Advertencia si la fecha de fin ya pas√≥
                if (endDate < now) {
                    const confirmPast = confirm(
                        'ADVERTENCIA: La fecha de fin que seleccionaste ya pas√≥.\n\n' +
                        'Si guardas esta aplicaci√≥n con estado "Abierta", ' +
                        'se cerrar√° autom√°ticamente al cargar la p√°gina.\n\n' +
                        '¬øDeseas continuar de todas formas?'
                    );
                    
                    if (!confirmPast) {
                        ocultarLoading();
                        return;
                    }
                }
                
                const datos = {
                    application_name: formData.get('application_name'),
                    start_date: formData.get('start_date'),
                    end_date: formData.get('end_date'),
                    status: formData.get('status')
                };
                
                // CR√çTICO: Solo incluir survey_master_id si NO est√° deshabilitado
                const selectMaster = document.getElementById('survey_master_id');
                if (!selectMaster.disabled) {
                    datos.survey_master_id = formData.get('survey_master_id');
                }
                
                if (modoEdicion && applicationId) {
                    // Actualizar - Resetear campos de cierre manual si se cambia la fecha
                    const appOriginal = applicationsCache.find(a => a.application_id === applicationId);
                    
                    if (appOriginal && appOriginal.end_date !== datos.end_date) {
                        // Si se cambi√≥ la fecha de fin, resetear flags de cierre manual
                        datos.closed_manually = null;
                        datos.closed_by = null;
                        datos.closed_at = null;
                        console.log('Fecha de fin modificada - reseteando flags de cierre manual');
                    }
                    
                    await supabaseRequest('/survey_applications?application_id=eq.' + applicationId, {
                        method: 'PATCH',
                        body: JSON.stringify(datos)
                    });
                    
                    showMessage('Aplicaci√≥n actualizada exitosamente', 'success');
                } else {
                    // Crear - calcular application_number
                    const existingApps = await supabaseRequest('/survey_applications?select=application_number&survey_master_id=eq.' + datos.survey_master_id + '&order=application_number.desc&limit=1');
                    const nextNumber = existingApps.length > 0 ? existingApps[0].application_number + 1 : 1;
                    
                    datos.application_number = nextNumber;
                    datos.unique_url_code = generarCodigoUnico();
                    
                    await supabaseRequest('/survey_applications', {
                        method: 'POST',
                        body: JSON.stringify(datos)
                    });
                    
                    showMessage('Aplicaci√≥n creada exitosamente', 'success');
                }
                
                // Rehabilitar select de maestro
                document.getElementById('survey_master_id').disabled = false;
                
                modalInstance.hide();
                await cargarAplicaciones();
                
            } catch (error) {
                console.error('Error al guardar:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
         
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.abrirModalCrear = abrirModalCrear;
        window.editarAplicacion = editarAplicacion;
        window.eliminarAplicacion = eliminarAplicacion;
        window.cerrarAplicacion = cerrarAplicacion;
        window.copiarURL = copiarURL;
        window.calcularNumeroAplicacion = calcularNumeroAplicacion;
        window.reabrirAplicacion = reabrirAplicacion;
        window.cerrarTodasVencidas = cerrarTodasVencidas;
        
        
        console.log('üéâ applications.html cargado correctamente');
    </script>
</body>
</html>
