<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responder Encuesta - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }

        .survey-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .survey-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .survey-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .survey-header h1 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 600;
        }

        .survey-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }

        .survey-body {
            padding: 2rem;
        }

        .progress-bar-container {
            margin-bottom: 2rem;
        }

        .section-title {
            background: #f8f9fa;
            padding: 1rem;
            border-left: 4px solid #667eea;
            margin-bottom: 1.5rem;
            border-radius: 4px;
        }

        .section-title h3 {
            margin: 0;
            font-size: 1.25rem;
            color: #667eea;
        }

        .section-description {
            margin: 0.5rem 0 0 0;
            color: #6c757d;
            font-size: 0.95rem;
        }

        .question-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .question-text {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .question-required {
            color: #dc3545;
            font-weight: bold;
        }

        .scale-option {
            margin-bottom: 0.75rem;
        }

        .scale-option input[type="radio"] {
            margin-right: 0.5rem;
        }

        .scale-option label {
            cursor: pointer;
            padding: 0.5rem;
            display: block;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .scale-option label:hover {
            background: #e9ecef;
        }

        .btn-navigation {
            min-width: 120px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            text-align: center;
            padding: 3rem 2rem;
        }

        .success-message i {
            font-size: 4rem;
            color: #28a745;
            margin-bottom: 1rem;
        }

        .error-state {
            text-align: center;
            padding: 3rem 2rem;
        }

        .error-state i {
            font-size: 4rem;
            color: #dc3545;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando encuesta...</p>
        </div>
    </div>

    <div class="survey-container">
        <div class="survey-card">
            
            <!-- HEADER -->
            <div class="survey-header">
                <h1 id="survey-title">Cargando encuesta...</h1>
                <p id="survey-description"></p>
            </div>

            <!-- BODY -->
            <div class="survey-body" id="survey-content">
                <!-- Contenido din√°mico -->
            </div>

        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
      // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let applicationData = null;
        let masterData = null;
        let sectionsData = [];
        let questionsData = [];
        let segmentsData = [];
        let scalesData = {};
        let currentSectionIndex = 0;
        let responsesCollected = {};
        let profileData = null;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìã Iniciando formulario de encuesta p√∫blica...');
            
            try {
                mostrarLoading();
                
                // Obtener c√≥digo de aplicaci√≥n de la URL
                const urlParams = new URLSearchParams(window.location.search);
                const appCode = urlParams.get('app');
                
                if (!appCode) {
                    mostrarError('URL inv√°lida', 'No se proporcion√≥ un c√≥digo de aplicaci√≥n v√°lido.');
                    return;
                }
                
                // Validar aplicaci√≥n
                await validarYCargarAplicacion(appCode);
                
                // Cargar estructura de la encuesta
                await cargarEstructuraEncuesta();
                
                // Mostrar formulario de perfil
                mostrarFormularioPerfil();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error inicializando encuesta:', error);
                mostrarError('Error al cargar', error.message);
                ocultarLoading();
            }
        });
        
        // ==========================================
        // VALIDAR Y CARGAR APLICACI√ìN
        // ==========================================
        async function validarYCargarAplicacion(appCode) {
            try {
                console.log('üîç Validando aplicaci√≥n...');
                
                // Buscar aplicaci√≥n por c√≥digo √∫nico
                const apps = await supabaseRequest('/survey_applications?select=*,survey_masters(*)&unique_url_code=eq.' + appCode);
                
                if (!apps || apps.length === 0) {
                    throw new Error('Esta encuesta no existe o el c√≥digo es incorrecto.');
                }
                
                applicationData = apps[0];
                masterData = applicationData.survey_masters;
                
                // Validar estado
                if (applicationData.status !== 'open') {
                    throw new Error('Esta encuesta no est√° disponible en este momento.');
                }
                
                // Validar fechas
                const today = new Date();
                const startDate = new Date(applicationData.start_date);
                const endDate = new Date(applicationData.end_date);
                
                if (today < startDate) {
                    throw new Error('Esta encuesta a√∫n no est√° disponible. Estar√° activa desde el ' + formatDate(applicationData.start_date));
                }
                
                if (today > endDate) {
                    throw new Error('Esta encuesta ya cerr√≥. Finaliz√≥ el ' + formatDate(applicationData.end_date));
                }
                
                console.log('‚úÖ Aplicaci√≥n v√°lida:', masterData.survey_name);
                
                // Actualizar header
                document.getElementById('survey-title').textContent = masterData.survey_name;
                document.getElementById('survey-description').textContent = masterData.description || '';
                
            } catch (error) {
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR ESTRUCTURA DE LA ENCUESTA
        // ==========================================
        async function cargarEstructuraEncuesta() {
            try {
                console.log('üìö Cargando estructura de encuesta...');
                
                // Cargar secciones
                const sections = await supabaseRequest('/survey_sections?select=*,survey_scales(scale_id,scale_name,survey_scale_options(*))&survey_master_id=eq.' + masterData.survey_master_id + '&order=section_order.asc');
                sectionsData = sections || [];
                
                if (sectionsData.length === 0) {
                    throw new Error('Esta encuesta no tiene secciones configuradas.');
                }
                
                // Cargar preguntas de todas las secciones
                const sectionIds = sectionsData.map(s => s.section_id);
                const questions = await supabaseRequest('/survey_questions?select=*&section_id=in.(' + sectionIds.join(',') + ')&order=question_order.asc');
                questionsData = questions || [];
                
                if (questionsData.length === 0) {
                    throw new Error('Esta encuesta no tiene preguntas configuradas.');
                }
                
                // Cargar segmentaciones configuradas
                const segments = await supabaseRequest('/survey_master_segments?select=*,segments(segment_id,segment_name,segment_description,segment_options(*))&survey_master_id=eq.' + masterData.survey_master_id);
                segmentsData = segments || [];
                
                // Organizar escalas por ID para acceso r√°pido
                sectionsData.forEach(section => {
                    if (section.survey_scales) {
                        scalesData[section.scale_id] = section.survey_scales;
                    }
                });
                
                console.log(`‚úÖ ${sectionsData.length} secciones, ${questionsData.length} preguntas, ${segmentsData.length} segmentaciones`);
                
            } catch (error) {
                throw error;
            }
        }
      // ==========================================
        // MOSTRAR FORMULARIO DE PERFIL
        // ==========================================
        function mostrarFormularioPerfil() {
            const content = document.getElementById('survey-content');
            
            // Construir formulario seg√∫n segmentaciones configuradas
            let formHtml = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Antes de comenzar, necesitamos algunos datos para contextualizar tus respuestas.
                </div>
                
                <form id="profile-form">
            `;
            
            // Agregar campos seg√∫n segmentaciones configuradas
            segmentsData.forEach(segmentConfig => {
                const segment = segmentConfig.segments;
                const isRequired = segmentConfig.is_required;
                const requiredMark = isRequired ? '<span class="text-danger">*</span>' : '';
                
                formHtml += `
                    <div class="mb-3">
                        <label class="form-label">
                            <strong>${escapeHtml(segment.segment_name)}</strong> ${requiredMark}
                        </label>
                `;
                
                if (segment.segment_description) {
                    formHtml += `<div class="form-text mb-2">${escapeHtml(segment.segment_description)}</div>`;
                }
                
                // Ordenar opciones por option_order
                const options = segment.segment_options ? segment.segment_options.sort((a, b) => a.option_order - b.option_order) : [];
                
                if (options.length > 0) {
                    formHtml += `<select class="form-select" name="segment_${segment.segment_id}" ${isRequired ? 'required' : ''}>
                        <option value="">Selecciona...</option>`;
                    
                    options.forEach(opt => {
                        formHtml += `<option value="${escapeHtml(opt.option_value)}">${escapeHtml(opt.option_name)}</option>`;
                    });
                    
                    formHtml += `</select>`;
                } else {
                    formHtml += `<input type="text" class="form-control" name="segment_${segment.segment_id}" ${isRequired ? 'required' : ''} placeholder="Escribe tu respuesta">`;
                }
                
                formHtml += `</div>`;
            });
            
            formHtml += `
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-arrow-right me-2"></i>Comenzar Encuesta
                        </button>
                    </div>
                </form>
            `;
            
            content.innerHTML = formHtml;
            
            // Event listener para el formulario
            document.getElementById('profile-form').addEventListener('submit', manejarSubmitPerfil);
        }
        
        // ==========================================
        // MANEJAR SUBMIT DEL PERFIL
        // ==========================================
        async function manejarSubmitPerfil(e) {
            e.preventDefault();
            
            try {
                mostrarLoading();
                
                const formData = new FormData(e.target);
                
                // Construir objeto de perfil
                // Construir objeto de perfil
                let respondentType = masterData.target_audience;
                
                // Corregir plural a singular para respondent_type
                if (respondentType === 'families') {
                    respondentType = 'family';
                } else if (respondentType === 'students') {
                    respondentType = 'student';
                } else if (respondentType === 'workers') {
                    respondentType = 'worker';
                }
                
                profileData = {
                    application_id: applicationData.application_id,
                    respondent_type: respondentType,
                    segment_data: {}
                };                
                // Recopilar datos de segmentaci√≥n
                segmentsData.forEach(segmentConfig => {
                    const segment = segmentConfig.segments;
                    const value = formData.get('segment_' + segment.segment_id);
                    if (value) {
                        profileData.segment_data[segment.segment_name] = value;
                    }
                });
                
                // Crear registro de perfil
                const profiles = await supabaseRequest('/survey_respondent_profile', {
                    method: 'POST',
                    body: JSON.stringify(profileData)
                });
                
                profileData.profile_id = profiles[0].profile_id;
                
                console.log('‚úÖ Perfil creado:', profileData.profile_id);
                
                // Mostrar primera secci√≥n
                currentSectionIndex = 0;
                mostrarSeccion(currentSectionIndex);
                
                ocultarLoading();
                
            } catch (error) {
                console.error('Error creando perfil:', error);
                showMessage('Error al iniciar encuesta: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // MOSTRAR SECCI√ìN
        // ==========================================
        function mostrarSeccion(sectionIndex) {
            const content = document.getElementById('survey-content');
            const section = sectionsData[sectionIndex];
            const sectionQuestions = questionsData.filter(q => q.section_id === section.section_id);
            
            // Barra de progreso
            const progressPercent = Math.round(((sectionIndex) / sectionsData.length) * 100);
            
            let html = `
                <div class="progress-bar-container">
                    <div class="d-flex justify-content-between mb-2">
                        <small class="text-muted">Secci√≥n ${sectionIndex + 1} de ${sectionsData.length}</small>
                        <small class="text-muted">${progressPercent}% completado</small>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%" 
                             aria-valuenow="${progressPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                
                <div class="section-title">
                    <h3>${escapeHtml(section.section_title)}</h3>
                    ${section.section_description ? `<p class="section-description">${escapeHtml(section.section_description)}</p>` : ''}
                </div>
                
                <form id="section-form">
            `;
            
            // Renderizar preguntas
            sectionQuestions.forEach(question => {
                html += renderizarPregunta(question, section);
            });
            
            // Botones de navegaci√≥n
            html += `
                <div class="d-flex justify-content-between mt-4">
            `;
            
            if (sectionIndex > 0) {
                html += `
                    <button type="button" class="btn btn-outline-secondary btn-navigation" onclick="retrocederSeccion()">
                        <i class="bi bi-arrow-left me-1"></i>Anterior
                    </button>
                `;
            } else {
                html += `<div></div>`;
            }
            
            if (sectionIndex < sectionsData.length - 1) {
                html += `
                    <button type="submit" class="btn btn-primary btn-navigation">
                        Siguiente<i class="bi bi-arrow-right ms-1"></i>
                    </button>
                `;
            } else {
                html += `
                    <button type="submit" class="btn btn-success btn-navigation">
                        <i class="bi bi-check-circle me-1"></i>Finalizar
                    </button>
                `;
            }
            
            html += `
                </div>
                </form>
            `;
            
            content.innerHTML = html;
            
            // Restaurar respuestas previas si existen
            restaurarRespuestas(section.section_id);
            
            // Event listener
            document.getElementById('section-form').addEventListener('submit', manejarSubmitSeccion);
            
            // Scroll al inicio
            window.scrollTo(0, 0);
        }
      // ==========================================
        // RENDERIZAR PREGUNTA
        // ==========================================
        function renderizarPregunta(question, section) {
            const requiredMark = question.is_required ? '<span class="question-required">*</span>' : '';
            
            let html = `
                <div class="question-card">
                    <div class="question-text">
                        ${escapeHtml(question.question_text)} ${requiredMark}
                    </div>
            `;
            
            if (question.question_type === 'scale') {
                // Pregunta con escala
                const scale = scalesData[section.scale_id];
                if (scale && scale.survey_scale_options) {
                    const options = scale.survey_scale_options.sort((a, b) => a.option_order - b.option_order);
                    
                    options.forEach(opt => {
                        html += `
                            <div class="scale-option">
                                <label>
                                    <input type="radio" 
                                           name="question_${question.question_id}" 
                                           value="${opt.option_value}" 
                                           ${question.is_required ? 'required' : ''}>
                                    ${escapeHtml(opt.option_text)}
                                </label>
                            </div>
                        `;
                    });
                }
            } else if (question.question_type === 'open_text') {
                // Pregunta de texto abierto
                html += `
                    <textarea class="form-control" 
                              name="question_${question.question_id}" 
                              rows="4" 
                              ${question.is_required ? 'required' : ''}
                              placeholder="Escribe tu respuesta aqu√≠..."></textarea>
                `;
            }
            
            html += `</div>`;
            
            return html;
        }
        
        // ==========================================
        // MANEJAR SUBMIT DE SECCI√ìN
        // ==========================================
        async function manejarSubmitSeccion(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(e.target);
                const section = sectionsData[currentSectionIndex];
                const sectionQuestions = questionsData.filter(q => q.section_id === section.section_id);
                
                // Guardar respuestas de esta secci√≥n
                sectionQuestions.forEach(question => {
                    const value = formData.get('question_' + question.question_id);
                    if (value) {
                        responsesCollected[question.question_id] = {
                            question_id: question.question_id,
                            question_type: question.question_type,
                            value: value
                        };
                    }
                });
                
                // Si es la √∫ltima secci√≥n, guardar todo
                if (currentSectionIndex === sectionsData.length - 1) {
                    await guardarTodasLasRespuestas();
                } else {
                    // Avanzar a siguiente secci√≥n
                    currentSectionIndex++;
                    mostrarSeccion(currentSectionIndex);
                }
                
            } catch (error) {
                console.error('Error procesando secci√≥n:', error);
                alert('Error al procesar las respuestas. Por favor, intenta de nuevo.');
            }
        }
        
        // ==========================================
        // RETROCEDER SECCI√ìN
        // ==========================================
        function retrocederSeccion() {
            if (currentSectionIndex > 0) {
                // Guardar respuestas actuales antes de retroceder
                const formData = new FormData(document.getElementById('section-form'));
                const section = sectionsData[currentSectionIndex];
                const sectionQuestions = questionsData.filter(q => q.section_id === section.section_id);
                
                sectionQuestions.forEach(question => {
                    const value = formData.get('question_' + question.question_id);
                    if (value) {
                        responsesCollected[question.question_id] = {
                            question_id: question.question_id,
                            question_type: question.question_type,
                            value: value
                        };
                    }
                });
                
                currentSectionIndex--;
                mostrarSeccion(currentSectionIndex);
            }
        }
        
        // ==========================================
        // RESTAURAR RESPUESTAS PREVIAS
        // ==========================================
        function restaurarRespuestas(sectionId) {
            const sectionQuestions = questionsData.filter(q => q.section_id === sectionId);
            
            sectionQuestions.forEach(question => {
                const savedResponse = responsesCollected[question.question_id];
                if (savedResponse) {
                    const inputName = 'question_' + question.question_id;
                    
                    if (question.question_type === 'scale') {
                        const radio = document.querySelector(`input[name="${inputName}"][value="${savedResponse.value}"]`);
                        if (radio) radio.checked = true;
                    } else if (question.question_type === 'open_text') {
                        const textarea = document.querySelector(`textarea[name="${inputName}"]`);
                        if (textarea) textarea.value = savedResponse.value;
                    }
                }
            });
        }
        
        // ==========================================
        // GUARDAR TODAS LAS RESPUESTAS
        // ==========================================
        async function guardarTodasLasRespuestas() {
            try {
                mostrarLoading();
                
                console.log('üíæ Guardando respuestas...');
                
                // Preparar array de respuestas para inserci√≥n masiva
                const responsesToSave = [];
                
                Object.values(responsesCollected).forEach(response => {
                    const data = {
                        profile_id: profileData.profile_id,
                        question_id: response.question_id,
                        responded_at: new Date().toISOString()
                    };
                    
                    if (response.question_type === 'scale') {
                        data.response_value = parseInt(response.value);
                    } else if (response.question_type === 'open_text') {
                        data.response_text = response.value;
                    }
                    
                    responsesToSave.push(data);
                });
                
                // Insertar todas las respuestas
                await supabaseRequest('/survey_responses', {
                    method: 'POST',
                    body: JSON.stringify(responsesToSave)
                });
                
                console.log(`‚úÖ ${responsesToSave.length} respuestas guardadas`);
                
                mostrarMensajeExito();
                
            } catch (error) {
                console.error('‚ùå Error guardando respuestas:', error);
                alert('Error al guardar tus respuestas. Por favor, contacta al administrador.');
                ocultarLoading();
            }
        }
      // ==========================================
        // MOSTRAR MENSAJE DE √âXITO
        // ==========================================
        function mostrarMensajeExito() {
            const content = document.getElementById('survey-content');
            
            content.innerHTML = `
                <div class="success-message">
                    <i class="bi bi-check-circle-fill"></i>
                    <h2>¬°Gracias por tu participaci√≥n!</h2>
                    <p class="lead">Tus respuestas han sido registradas exitosamente.</p>
                    <p class="text-muted">Puedes cerrar esta ventana.</p>
                </div>
            `;
            
            ocultarLoading();
        }
        
        // ==========================================
        // MOSTRAR ERROR
        // ==========================================
        function mostrarError(titulo, mensaje) {
            const content = document.getElementById('survey-content');
            
            document.getElementById('survey-title').textContent = titulo;
            document.getElementById('survey-description').textContent = '';
            
            content.innerHTML = `
                <div class="error-state">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <h3>${escapeHtml(titulo)}</h3>
                    <p>${escapeHtml(mensaje)}</p>
                </div>
            `;
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        
        // No necesitamos showMessage porque no usamos alertContainer aqu√≠
        // Esta es una p√°gina p√∫blica sin el sistema de alertas est√°ndar
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.retrocederSeccion = retrocederSeccion;
        
        console.log('üìã respond.html cargado correctamente');
    </script>
</body>
</html>
