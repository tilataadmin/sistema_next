<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparar Aplicaciones - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Variables CSS del m√≥dulo */
        :root {
            --module-primary: #6f42c1;
            --module-secondary: #9b7ec9;
            --module-light: #f3e8ff;
        }
        
        /* Estilos para cards */
        .comparison-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        /* Estilos para el gr√°fico */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }
        
        /* Estilos para tabla de comparaci√≥n */
        .comparison-table {
            font-size: 0.95rem;
        }
        
        .comparison-table th {
            background-color: var(--module-light);
            color: var(--module-primary);
            font-weight: 600;
            border: none;
        }
        
        .trend-up {
            color: #198754;
            font-weight: bold;
        }
        
        .trend-down {
            color: #dc3545;
            font-weight: bold;
        }
        
        .trend-neutral {
            color: #6c757d;
        }
        
        /* Badge para tipo de comparaci√≥n */
        .comparison-type-badge {
            background-color: var(--module-light);
            color: var(--module-primary);
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }
        
        /* Estilos para checkboxes de aplicaciones */
        .application-checkbox {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .application-checkbox:hover {
            border-color: var(--module-primary);
            background-color: var(--module-light);
        }
        
        .application-checkbox input[type="checkbox"]:checked ~ label {
            font-weight: 600;
            color: var(--module-primary);
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--module-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Stats cards */
        .stat-card {
            background: linear-gradient(135deg, var(--module-light) 0%, #fff 100%);
            border-left: 4px solid var(--module-primary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--module-primary);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6c757d;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando comparaci√≥n...</p>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Encuestas</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Comparar Aplicaciones
                </li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-graph-up-arrow me-2" style="color: var(--module-primary);"></i>
                    Comparar Aplicaciones
                </h1>
                <p class="text-muted">Analiza la evoluci√≥n temporal de preguntas y secciones entre diferentes aplicaciones</p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Panel de Configuraci√≥n -->
        <div class="card comparison-card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-sliders me-2"></i>Configuraci√≥n de Comparaci√≥n
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Selecci√≥n de Encuesta Maestra -->
                    <div class="col-md-6 mb-3">
                        <label for="survey-master" class="form-label">
                            <i class="bi bi-clipboard-data me-1"></i>
                            Encuesta Maestra <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="survey-master" required>
                            <option value="">Selecciona una encuesta...</option>
                        </select>
                        <small class="text-muted">Solo se muestran encuestas con aplicaciones cerradas</small>
                    </div>

                    <!-- Tipo de Comparaci√≥n -->
                    <div class="col-md-6 mb-3">
                        <label for="comparison-type" class="form-label">
                            <i class="bi bi-list-check me-1"></i>
                            Tipo de Comparaci√≥n <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="comparison-type" required>
                            <option value="">Selecciona el tipo...</option>
                            <option value="question">Por Pregunta Individual</option>
                            <option value="section">Por Secci√≥n Completa</option>
                        </select>
                    </div>
                </div>

                <!-- Contenedor din√°mico para aplicaciones -->
                <div id="applications-container" class="row mb-3" style="display: none;">
                    <div class="col-12">
                        <label class="form-label">
                            <i class="bi bi-calendar-check me-1"></i>
                            Selecciona las Aplicaciones a Comparar <span class="text-danger">*</span>
                        </label>
                        <small class="text-muted d-block mb-2">Selecciona al menos 2 aplicaciones</small>
                        <div id="applications-list" class="row">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>

                <!-- Contenedor din√°mico para pregunta/secci√≥n -->
                <div id="item-selector-container" class="row mb-3" style="display: none;">
                    <div class="col-md-6">
                        <label for="item-selector" class="form-label">
                            <i class="bi bi-question-circle me-1"></i>
                            <span id="item-selector-label">Selecciona...</span> <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="item-selector" required>
                            <option value="">Selecciona...</option>
                        </select>
                    </div>
                </div>

                <!-- Segmentaci√≥n Opcional -->
                <div id="segmentation-container" class="row mb-3" style="display: none;">
                    <div class="col-md-6">
                        <label for="segment-filter" class="form-label">
                            <i class="bi bi-funnel me-1"></i>
                            Segmentar por (opcional)
                        </label>
                        <select class="form-select" id="segment-filter">
                            <option value="">Sin segmentaci√≥n (vista general)</option>
                            <option value="course">Por Curso</option>
                            <option value="gender">Por G√©nero</option>
                        </select>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="row">
                    <div class="col-12">
                        <button class="btn btn-primary" id="btn-generate-comparison" disabled>
                            <i class="bi bi-bar-chart-line me-1"></i>Generar Comparaci√≥n
                        </button>
                        <button class="btn btn-outline-secondary" id="btn-reset">
                            <i class="bi bi-arrow-clockwise me-1"></i>Reiniciar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Resultados (inicialmente oculto) -->
        <div id="results-container" style="display: none;">
            
            <!-- Informaci√≥n de la comparaci√≥n -->
            <div class="card comparison-card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>Informaci√≥n de la Comparaci√≥n
                    </h5>
                    <button class="btn btn-success btn-sm" id="btn-export">
                        <i class="bi bi-file-earmark-excel me-1"></i>Exportar a Excel
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-label">Encuesta</div>
                                <div class="stat-value" id="stat-survey-name">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-label">Tipo de Comparaci√≥n</div>
                                <div class="stat-value" id="stat-comparison-type">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-label">Aplicaciones Comparadas</div>
                                <div class="stat-value" id="stat-applications-count">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-label">Tendencia General</div>
                                <div class="stat-value" id="stat-trend">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <p class="mb-1"><strong>Elemento analizado:</strong> <span id="stat-item-name">-</span></p>
                            <p class="mb-0"><strong>Segmentaci√≥n:</strong> <span id="stat-segmentation">-</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico de Evoluci√≥n -->
            <div class="card comparison-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>Evoluci√≥n Temporal
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="comparison-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tabla de Comparaci√≥n Detallada -->
            <div class="card comparison-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-table me-2"></i>Datos Detallados
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover comparison-table" id="comparison-table">
                            <thead>
                                <tr>
                                    <th>Aplicaci√≥n</th>
                                    <th class="text-center">Promedio</th>
                                    <th class="text-center">Respuestas</th>
                                    <th class="text-center">Cambio</th>
                                    <th class="text-center">Tendencia</th>
                                </tr>
                            </thead>
                            <tbody id="comparison-table-body">
                                <!-- Se llena din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let surveyMasters = [];
        let applications = [];
        let sections = [];
        let questions = [];
        let comparisonChart = null;
        let comparisonData = [];
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // Validar permisos
                const hasAccess = await validatePageAccess('Comparar aplicaciones');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - iniciando p√°gina');
                
                // Inicializar p√°gina
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN PRINCIPAL
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Obtener usuario actual
                const session = getStoredSession();
                if (session && session.user) {
                    currentUser = session.user;
                }
                
                // Cargar encuestas maestras con aplicaciones cerradas
                await cargarEncuestasMaestras();
                
                // Configurar event listeners
                configurarEventListeners();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR ENCUESTAS MAESTRAS
        // ==========================================
        async function cargarEncuestasMaestras() {
            try {
                console.log('üì° Cargando encuestas maestras...');
                
                // Obtener todas las encuestas maestras activas
                const masters = await supabaseRequest('/survey_masters?select=*&is_active=eq.true&order=survey_name.asc');
                
                // Filtrar solo las que tienen aplicaciones cerradas
                surveyMasters = [];
                for (const master of masters) {
                    const apps = await supabaseRequest('/survey_applications?select=application_id&survey_master_id=eq.' + master.survey_master_id + '&status=eq.closed');
                    if (apps.length >= 2) { // Al menos 2 aplicaciones para comparar
                        surveyMasters.push(master);
                    }
                }
                
                // Llenar dropdown
                const select = document.getElementById('survey-master');
                select.innerHTML = '<option value="">Selecciona una encuesta...</option>';
                
                if (surveyMasters.length === 0) {
                    select.innerHTML = '<option value="">No hay encuestas con suficientes aplicaciones cerradas</option>';
                    showMessage('No hay encuestas disponibles para comparar. Se requieren al menos 2 aplicaciones cerradas.', 'warning');
                    return;
                }
                
                surveyMasters.forEach(master => {
                    const option = document.createElement('option');
                    option.value = master.survey_master_id;
                    option.textContent = master.survey_name;
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ ${surveyMasters.length} encuestas maestras cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando encuestas maestras:', error);
                showMessage('Error al cargar encuestas: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // CONFIGURAR EVENT LISTENERS
        // ==========================================
        function configurarEventListeners() {
            // Cambio en encuesta maestra
            document.getElementById('survey-master').addEventListener('change', async function() {
                const surveyId = this.value;
                if (surveyId) {
                    await cargarAplicacionesYSecciones(surveyId);
                    document.getElementById('comparison-type').disabled = false;
                } else {
                    resetearFormulario();
                }
            });
            
            // Cambio en tipo de comparaci√≥n
            document.getElementById('comparison-type').addEventListener('change', async function() {
                const type = this.value;
                if (type) {
                    await mostrarSelectorItems(type);
                    verificarFormularioCompleto();
                } else {
                    document.getElementById('item-selector-container').style.display = 'none';
                }
            });
            
            // Cambio en checkboxes de aplicaciones
            document.getElementById('applications-list').addEventListener('change', function(e) {
                if (e.target.type === 'checkbox') {
                    verificarFormularioCompleto();
                }
            });
            
            // Cambio en selector de pregunta/secci√≥n
            document.getElementById('item-selector').addEventListener('change', function() {
                verificarFormularioCompleto();
            });
            
            // Bot√≥n generar comparaci√≥n
            document.getElementById('btn-generate-comparison').addEventListener('click', generarComparacion);
            
            // Bot√≥n reiniciar
            document.getElementById('btn-reset').addEventListener('click', function() {
                resetearFormulario();
                document.getElementById('results-container').style.display = 'none';
            });
            
            // Bot√≥n exportar
            document.getElementById('btn-export').addEventListener('click', exportarAExcel);
            
            console.log('‚úÖ Event listeners configurados');
        }
        
        // ==========================================
        // CARGAR APLICACIONES Y SECCIONES
        // ==========================================
        async function cargarAplicacionesYSecciones(surveyMasterId) {
            try {
                mostrarLoading();
                
                // Cargar aplicaciones cerradas
                applications = await supabaseRequest('/survey_applications?select=*&survey_master_id=eq.' + surveyMasterId + '&status=eq.closed&order=application_number.asc');
                
                // Cargar secciones de la encuesta
                sections = await supabaseRequest('/survey_sections?select=*,survey_scales(scale_name)&survey_master_id=eq.' + surveyMasterId + '&order=section_order.asc');
                
                // Cargar preguntas de la encuesta
                questions = await supabaseRequest('/survey_questions?select=*,survey_sections(section_title,section_order)&survey_sections.survey_master_id=eq.' + surveyMasterId + '&order=question_order.asc');
                
                // Ordenar manualmente por section_order y luego por question_order
                questions.sort((a, b) => {
                    const sectionOrderA = a.survey_sections?.section_order || 0;
                    const sectionOrderB = b.survey_sections?.section_order || 0;
                    
                    if (sectionOrderA !== sectionOrderB) {
                        return sectionOrderA - sectionOrderB;
                    }
                    return (a.question_order || 0) - (b.question_order || 0);
                });
                // Mostrar aplicaciones como checkboxes
                mostrarAplicaciones();
                
                // Mostrar contenedor de aplicaciones
                document.getElementById('applications-container').style.display = 'block';
                
                ocultarLoading();
                console.log(`‚úÖ ${applications.length} aplicaciones, ${sections.length} secciones y ${questions.length} preguntas cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                showMessage('Error al cargar datos: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // MOSTRAR APLICACIONES COMO CHECKBOXES
        // ==========================================
        function mostrarAplicaciones() {
            const container = document.getElementById('applications-list');
            container.innerHTML = '';
            
            applications.forEach(app => {
                const col = document.createElement('div');
                col.className = 'col-md-4';
                
                col.innerHTML = `
                    <div class="application-checkbox">
                        <input type="checkbox" class="form-check-input me-2" 
                               id="app-${app.application_id}" 
                               value="${app.application_id}">
                        <label class="form-check-label" for="app-${app.application_id}">
                            ${escapeHtml(app.application_name)}
                        </label>
                    </div>
                `;
                
                container.appendChild(col);
            });
        }
        
        // ==========================================
        // MOSTRAR SELECTOR DE ITEMS (PREGUNTA/SECCI√ìN)
        // ==========================================
        async function mostrarSelectorItems(type) {
            const container = document.getElementById('item-selector-container');
            const select = document.getElementById('item-selector');
            const label = document.getElementById('item-selector-label');
            
            select.innerHTML = '<option value="">Selecciona...</option>';
            
            if (type === 'question') {
                label.textContent = 'Pregunta a Analizar';
                
                questions.forEach(q => {
                    const option = document.createElement('option');
                    option.value = q.question_id;
                    option.textContent = `[${q.survey_sections.section_title}] ${q.question_text}`;
                    select.appendChild(option);
                });
                
            } else if (type === 'section') {
                label.textContent = 'Secci√≥n a Analizar';
                
                sections.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.section_id;
                    option.textContent = s.section_title;
                    select.appendChild(option);
                });
            }
            
            container.style.display = 'block';
            document.getElementById('segmentation-container').style.display = 'block';
        }
        
        // ==========================================
        // VERIFICAR SI FORMULARIO EST√Å COMPLETO
        // ==========================================
        function verificarFormularioCompleto() {
            const surveySelected = document.getElementById('survey-master').value;
            const typeSelected = document.getElementById('comparison-type').value;
            const itemSelected = document.getElementById('item-selector').value;
            
            // Verificar aplicaciones seleccionadas
            const selectedApps = Array.from(document.querySelectorAll('#applications-list input[type="checkbox"]:checked'));
            const appsValid = selectedApps.length >= 2;
            
            // Habilitar/deshabilitar bot√≥n
            const btnGenerate = document.getElementById('btn-generate-comparison');
            btnGenerate.disabled = !(surveySelected && typeSelected && itemSelected && appsValid);
            
            // Mostrar mensaje si no hay suficientes aplicaciones
            if (typeSelected && selectedApps.length > 0 && selectedApps.length < 2) {
                showMessage('Selecciona al menos 2 aplicaciones para comparar', 'warning');
            }
        }
        
        // ==========================================
        // RESETEAR FORMULARIO
        // ==========================================
        function resetearFormulario() {
            document.getElementById('survey-master').value = '';
            document.getElementById('comparison-type').value = '';
            document.getElementById('comparison-type').disabled = true;
            document.getElementById('item-selector').value = '';
            document.getElementById('segment-filter').value = '';
            document.getElementById('applications-container').style.display = 'none';
            document.getElementById('item-selector-container').style.display = 'none';
            document.getElementById('segmentation-container').style.display = 'none';
            document.getElementById('btn-generate-comparison').disabled = true;
            
            // Limpiar checkboxes
            document.querySelectorAll('#applications-list input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            // Limpiar alertas
            document.getElementById('alertContainer').innerHTML = '';
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
      // ==========================================
        // GENERAR COMPARACI√ìN
        // ==========================================
        async function generarComparacion() {
            try {
                mostrarLoading();
                
                // Obtener valores del formulario
                const surveyMasterId = document.getElementById('survey-master').value;
                const comparisonType = document.getElementById('comparison-type').value;
                const itemId = document.getElementById('item-selector').value;
                const segmentFilter = document.getElementById('segment-filter').value;
                
                // Obtener aplicaciones seleccionadas
                const selectedApps = Array.from(document.querySelectorAll('#applications-list input[type="checkbox"]:checked'))
                    .map(cb => cb.value);
                
                console.log('üìä Generando comparaci√≥n:', {
                    surveyMasterId,
                    comparisonType,
                    itemId,
                    segmentFilter,
                    selectedApps
                });
                
                // Obtener datos seg√∫n el tipo de comparaci√≥n
                if (comparisonType === 'question') {
                    comparisonData = await obtenerDatosPorPregunta(itemId, selectedApps, segmentFilter);
                } else if (comparisonType === 'section') {
                    comparisonData = await obtenerDatosPorSeccion(itemId, selectedApps, segmentFilter);
                }
                
                // Verificar que haya datos
                if (!comparisonData || comparisonData.length === 0) {
                    showMessage('No hay datos suficientes para generar la comparaci√≥n', 'warning');
                    ocultarLoading();
                    return;
                }
                
                // Mostrar panel de resultados
                document.getElementById('results-container').style.display = 'block';
                
                // Actualizar informaci√≥n de la comparaci√≥n
                actualizarInfoComparacion(comparisonType, itemId, segmentFilter);
                
                // Generar gr√°fico
                generarGrafico();
                
                // Generar tabla
                generarTabla();
                
                // Scroll suave a resultados
                document.getElementById('results-container').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
                ocultarLoading();
                showMessage('Comparaci√≥n generada exitosamente', 'success');
                
            } catch (error) {
                console.error('‚ùå Error generando comparaci√≥n:', error);
                showMessage('Error al generar comparaci√≥n: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // OBTENER DATOS POR PREGUNTA
        // ==========================================
        async function obtenerDatosPorPregunta(questionId, applicationIds, segmentFilter) {
            try {
                console.log('üì° Obteniendo datos por pregunta...');
                
                const results = [];
                
                for (const appId of applicationIds) {
                    // Query base
                    let query = '/survey_responses?select=response_value,survey_respondent_profile!inner(application_id';
                    
                    // Agregar campos de segmentaci√≥n si aplica
                    if (segmentFilter === 'course') {
                        query += ',student_course_id,courses(course_name)';
                    } else if (segmentFilter === 'gender') {
                        query += ',student_gender';
                    }
                    
                    query += ')&question_id=eq.' + questionId;
                    query += '&survey_respondent_profile.application_id=eq.' + appId;
                    
                    const responses = await supabaseRequest(query);
                    
                    if (!responses || responses.length === 0) {
                        continue;
                    }
                    
                    // Obtener nombre de la aplicaci√≥n
                    const app = applications.find(a => a.application_id === appId);
                    
                    if (segmentFilter && segmentFilter !== '') {
                        // Agrupar por segmento
                        const grouped = agruparPorSegmento(responses, segmentFilter);
                        
                        for (const [segmentValue, segmentResponses] of Object.entries(grouped)) {
                            const promedio = calcularPromedio(segmentResponses);
                            results.push({
                                application_id: appId,
                                application_name: app.application_name,
                                application_number: app.application_number,
                                promedio: promedio,
                                total_respuestas: segmentResponses.length,
                                segment: segmentValue
                            });
                        }
                    } else {
                        // Sin segmentaci√≥n
                        const promedio = calcularPromedio(responses);
                        results.push({
                            application_id: appId,
                            application_name: app.application_name,
                            application_number: app.application_number,
                            promedio: promedio,
                            total_respuestas: responses.length,
                            segment: null
                        });
                    }
                }
                
                // Ordenar por n√∫mero de aplicaci√≥n
                results.sort((a, b) => a.application_number - b.application_number);
                
                console.log(`‚úÖ ${results.length} puntos de datos obtenidos`);
                return results;
                
            } catch (error) {
                console.error('‚ùå Error obteniendo datos por pregunta:', error);
                throw error;
            }
        }
        
        // ==========================================
        // OBTENER DATOS POR SECCI√ìN
        // ==========================================
        async function obtenerDatosPorSeccion(sectionId, applicationIds, segmentFilter) {
            try {
                console.log('üì° Obteniendo datos por secci√≥n...');
                
                // Obtener todas las preguntas de la secci√≥n
                const sectionQuestions = await supabaseRequest('/survey_questions?select=question_id&section_id=eq.' + sectionId);
                const questionIds = sectionQuestions.map(q => q.question_id);
                
                if (questionIds.length === 0) {
                    throw new Error('No hay preguntas en esta secci√≥n');
                }
                
                const results = [];
                
                for (const appId of applicationIds) {
                    // Query base para todas las preguntas de la secci√≥n
                    let query = '/survey_responses?select=response_value,question_id,survey_respondent_profile!inner(application_id';
                    
                    // Agregar campos de segmentaci√≥n si aplica
                    if (segmentFilter === 'course') {
                        query += ',student_course_id,courses(course_name)';
                    } else if (segmentFilter === 'gender') {
                        query += ',student_gender';
                    }
                    
                    query += ')&question_id=in.(' + questionIds.join(',') + ')';
                    query += '&survey_respondent_profile.application_id=eq.' + appId;
                    
                    const responses = await supabaseRequest(query);
                    
                    if (!responses || responses.length === 0) {
                        continue;
                    }
                    
                    // Obtener nombre de la aplicaci√≥n
                    const app = applications.find(a => a.application_id === appId);
                    
                    if (segmentFilter && segmentFilter !== '') {
                        // Agrupar por segmento
                        const grouped = agruparPorSegmento(responses, segmentFilter);
                        
                        for (const [segmentValue, segmentResponses] of Object.entries(grouped)) {
                            const promedio = calcularPromedio(segmentResponses);
                            results.push({
                                application_id: appId,
                                application_name: app.application_name,
                                application_number: app.application_number,
                                promedio: promedio,
                                total_respuestas: segmentResponses.length,
                                segment: segmentValue
                            });
                        }
                    } else {
                        // Sin segmentaci√≥n - promedio de todas las respuestas
                        const promedio = calcularPromedio(responses);
                        results.push({
                            application_id: appId,
                            application_name: app.application_name,
                            application_number: app.application_number,
                            promedio: promedio,
                            total_respuestas: responses.length,
                            segment: null
                        });
                    }
                }
                
                // Ordenar por n√∫mero de aplicaci√≥n
                results.sort((a, b) => a.application_number - b.application_number);
                
                console.log(`‚úÖ ${results.length} puntos de datos obtenidos para secci√≥n`);
                return results;
                
            } catch (error) {
                console.error('‚ùå Error obteniendo datos por secci√≥n:', error);
                throw error;
            }
        }
        
        // ==========================================
        // AGRUPAR POR SEGMENTO
        // ==========================================
        function agruparPorSegmento(responses, segmentType) {
            const grouped = {};
            
            responses.forEach(response => {
                let segmentValue;
                
                if (segmentType === 'course') {
                    segmentValue = response.survey_respondent_profile.courses?.course_name || 'Sin curso';
                } else if (segmentType === 'gender') {
                    segmentValue = response.survey_respondent_profile.student_gender || 'No especificado';
                }
                
                if (!grouped[segmentValue]) {
                    grouped[segmentValue] = [];
                }
                
                grouped[segmentValue].push(response);
            });
            
            return grouped;
        }
        
        // ==========================================
        // CALCULAR PROMEDIO
        // ==========================================
        function calcularPromedio(responses) {
            if (!responses || responses.length === 0) return 0;
            
            const suma = responses.reduce((acc, r) => acc + (r.response_value || 0), 0);
            return (suma / responses.length).toFixed(2);
        }
        
        // ==========================================
        // ACTUALIZAR INFORMACI√ìN DE LA COMPARACI√ìN
        // ==========================================
        function actualizarInfoComparacion(comparisonType, itemId, segmentFilter) {
            // Nombre de la encuesta
            const surveyMasterId = document.getElementById('survey-master').value;
            const survey = surveyMasters.find(s => s.survey_master_id === surveyMasterId);
            document.getElementById('stat-survey-name').textContent = survey.survey_name;
            
            // Tipo de comparaci√≥n
            const typeText = comparisonType === 'question' ? 'Por Pregunta' : 'Por Secci√≥n';
            document.getElementById('stat-comparison-type').textContent = typeText;
            
            // N√∫mero de aplicaciones
            const uniqueApps = [...new Set(comparisonData.map(d => d.application_id))];
            document.getElementById('stat-applications-count').textContent = uniqueApps.length;
            
            // Nombre del elemento
            let itemName = '';
            if (comparisonType === 'question') {
                const question = questions.find(q => q.question_id === itemId);
                itemName = question ? question.question_text : '-';
            } else {
                const section = sections.find(s => s.section_id === itemId);
                itemName = section ? section.section_title : '-';
            }
            document.getElementById('stat-item-name').textContent = itemName;
            
            // Segmentaci√≥n
            const segmentText = segmentFilter === 'course' ? 'Por Curso' : 
                               segmentFilter === 'gender' ? 'Por G√©nero' : 
                               'Vista General (sin segmentaci√≥n)';
            document.getElementById('stat-segmentation').textContent = segmentText;
            
            // Calcular tendencia general
            if (comparisonData.length >= 2) {
                const firstValue = parseFloat(comparisonData[0].promedio);
                const lastValue = parseFloat(comparisonData[comparisonData.length - 1].promedio);
                const diff = lastValue - firstValue;
                const diffPercent = ((diff / firstValue) * 100).toFixed(1);
                
                let trendHTML = '';
                if (diff > 0) {
                    trendHTML = `<span class="trend-up">‚Üë +${diffPercent}%</span>`;
                } else if (diff < 0) {
                    trendHTML = `<span class="trend-down">‚Üì ${diffPercent}%</span>`;
                } else {
                    trendHTML = `<span class="trend-neutral">‚Üí 0%</span>`;
                }
                
                document.getElementById('stat-trend').innerHTML = trendHTML;
            } else {
                document.getElementById('stat-trend').textContent = '-';
            }
        }
        
        // ==========================================
        // GENERAR GR√ÅFICO
        // ==========================================
        function generarGrafico() {
            const ctx = document.getElementById('comparison-chart').getContext('2d');
            
            // Destruir gr√°fico anterior si existe
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            // Preparar datos para el gr√°fico
            const segmentFilter = document.getElementById('segment-filter').value;
            
            if (segmentFilter && segmentFilter !== '') {
                // Gr√°fico con m√∫ltiples l√≠neas (una por segmento)
                generarGraficoSegmentado(ctx, segmentFilter);
            } else {
                // Gr√°fico simple con una l√≠nea
                generarGraficoSimple(ctx);
            }
        }
        
        // ==========================================
        // GENERAR GR√ÅFICO SIMPLE (SIN SEGMENTACI√ìN)
        // ==========================================
        function generarGraficoSimple(ctx) {
            const labels = comparisonData.map(d => d.application_name);
            const data = comparisonData.map(d => parseFloat(d.promedio));
            
            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Promedio',
                        data: data,
                        borderColor: 'rgb(111, 66, 193)',
                        backgroundColor: 'rgba(111, 66, 193, 0.1)',
                        borderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: 'rgb(111, 66, 193)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    return 'Promedio: ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // GENERAR GR√ÅFICO SEGMENTADO
        // ==========================================
        function generarGraficoSegmentado(ctx, segmentType) {
            // Obtener segmentos √∫nicos
            const segments = [...new Set(comparisonData.map(d => d.segment))];
            
            // Obtener aplicaciones √∫nicas (labels del eje X)
            const applications = [...new Set(comparisonData.map(d => d.application_name))];
            
            // Colores para cada segmento
            const colors = [
                'rgb(111, 66, 193)',   // P√∫rpura
                'rgb(25, 135, 84)',    // Verde
                'rgb(220, 53, 69)',    // Rojo
                'rgb(255, 193, 7)',    // Amarillo
                'rgb(13, 110, 253)',   // Azul
                'rgb(13, 202, 240)',   // Cian
                'rgb(255, 102, 0)',    // Naranja
                'rgb(111, 111, 111)'   // Gris
            ];
            
            // Crear dataset para cada segmento
            const datasets = segments.map((segment, index) => {
                const segmentData = applications.map(appName => {
                    const dataPoint = comparisonData.find(d => 
                        d.application_name === appName && d.segment === segment
                    );
                    return dataPoint ? parseFloat(dataPoint.promedio) : null;
                });
                
                const color = colors[index % colors.length];
                
                return {
                    label: segment,
                    data: segmentData,
                    borderColor: color,
                    backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                    borderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: color,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    tension: 0.2
                };
            });
            
            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: applications,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // GENERAR TABLA
        // ==========================================
        function generarTabla() {
            const tbody = document.getElementById('comparison-table-body');
            tbody.innerHTML = '';
            
            const segmentFilter = document.getElementById('segment-filter').value;
            
            if (segmentFilter && segmentFilter !== '') {
                // Tabla segmentada
                generarTablaSegmentada(tbody);
            } else {
                // Tabla simple
                generarTablaSimple(tbody);
            }
        }
        
        // ==========================================
        // GENERAR TABLA SIMPLE
        // ==========================================
        function generarTablaSimple(tbody) {
            comparisonData.forEach((item, index) => {
                const tr = document.createElement('tr');
                
                // Calcular cambio respecto a la aplicaci√≥n anterior
                let cambio = '-';
                let tendencia = '';
                
                if (index > 0) {
                    const prevPromedio = parseFloat(comparisonData[index - 1].promedio);
                    const currPromedio = parseFloat(item.promedio);
                    const diff = currPromedio - prevPromedio;
                    const diffPercent = ((diff / prevPromedio) * 100).toFixed(1);
                    
                    if (diff > 0) {
                        cambio = `+${diff.toFixed(2)} (+${diffPercent}%)`;
                        tendencia = '<span class="trend-up">‚Üë Mejora</span>';
                    } else if (diff < 0) {
                        cambio = `${diff.toFixed(2)} (${diffPercent}%)`;
                        tendencia = '<span class="trend-down">‚Üì Deterioro</span>';
                    } else {
                        cambio = '0 (0%)';
                        tendencia = '<span class="trend-neutral">‚Üí Sin cambio</span>';
                    }
                }
                
                tr.innerHTML = `
                    <td><strong>${escapeHtml(item.application_name)}</strong></td>
                    <td class="text-center"><strong>${item.promedio}</strong></td>
                    <td class="text-center">${item.total_respuestas}</td>
                    <td class="text-center">${cambio}</td>
                    <td class="text-center">${tendencia}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }
        
        // ==========================================
        // GENERAR TABLA SEGMENTADA
        // ==========================================
        function generarTablaSegmentada(tbody) {
            // Obtener aplicaciones √∫nicas
            const applications = [...new Set(comparisonData.map(d => d.application_name))];
            
            // Agrupar por segmento
            const segments = [...new Set(comparisonData.map(d => d.segment))];
            
            segments.forEach(segment => {
                // Fila de encabezado del segmento
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = `
                    <td colspan="5" class="bg-light">
                        <strong><i class="bi bi-tag me-2"></i>${escapeHtml(segment)}</strong>
                    </td>
                `;
                tbody.appendChild(headerRow);
                
                // Datos del segmento
                const segmentData = comparisonData.filter(d => d.segment === segment);
                
                segmentData.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    
                    // Calcular cambio respecto a la aplicaci√≥n anterior
                    let cambio = '-';
                    let tendencia = '';
                    
                    if (index > 0) {
                        const prevPromedio = parseFloat(segmentData[index - 1].promedio);
                        const currPromedio = parseFloat(item.promedio);
                        const diff = currPromedio - prevPromedio;
                        const diffPercent = ((diff / prevPromedio) * 100).toFixed(1);
                        
                        if (diff > 0) {
                            cambio = `+${diff.toFixed(2)} (+${diffPercent}%)`;
                            tendencia = '<span class="trend-up">‚Üë Mejora</span>';
                        } else if (diff < 0) {
                            cambio = `${diff.toFixed(2)} (${diffPercent}%)`;
                            tendencia = '<span class="trend-down">‚Üì Deterioro</span>';
                        } else {
                            cambio = '0 (0%)';
                            tendencia = '<span class="trend-neutral">‚Üí Sin cambio</span>';
                        }
                    }
                    
                    tr.innerHTML = `
                        <td class="ps-4">${escapeHtml(item.application_name)}</td>
                        <td class="text-center"><strong>${item.promedio}</strong></td>
                        <td class="text-center">${item.total_respuestas}</td>
                        <td class="text-center">${cambio}</td>
                        <td class="text-center">${tendencia}</td>
                    `;
                    
                    tbody.appendChild(tr);
                });
            });
        }
      // ==========================================
        // EXPORTAR A EXCEL
        // ==========================================
        async function exportarAExcel() {
            try {
                mostrarLoading();
                
                console.log('üìä Generando archivo Excel...');
                
                // Obtener informaci√≥n de la comparaci√≥n
                const surveyMasterId = document.getElementById('survey-master').value;
                const survey = surveyMasters.find(s => s.survey_master_id === surveyMasterId);
                const comparisonType = document.getElementById('comparison-type').value;
                const itemId = document.getElementById('item-selector').value;
                const segmentFilter = document.getElementById('segment-filter').value;
                
                // Obtener nombre del elemento analizado
                let itemName = '';
                if (comparisonType === 'question') {
                    const question = questions.find(q => q.question_id === itemId);
                    itemName = question ? question.question_text : '';
                } else {
                    const section = sections.find(s => s.section_id === itemId);
                    itemName = section ? section.section_title : '';
                }
                
                // Crear libro de trabajo
                const wb = XLSX.utils.book_new();
                
                // === HOJA 1: INFORMACI√ìN GENERAL ===
                const infoData = [
                    ['COMPARACI√ìN DE APLICACIONES - SCHOOLNET'],
                    [''],
                    ['Encuesta:', survey.survey_name],
                    ['Tipo de comparaci√≥n:', comparisonType === 'question' ? 'Por Pregunta' : 'Por Secci√≥n'],
                    ['Elemento analizado:', itemName],
                    ['Segmentaci√≥n:', segmentFilter === 'course' ? 'Por Curso' : 
                                     segmentFilter === 'gender' ? 'Por G√©nero' : 
                                     'Sin segmentaci√≥n'],
                    ['Fecha de generaci√≥n:', new Date().toLocaleString('es-CO')],
                    ['Generado por:', currentUser ? currentUser.user_display_name : 'Usuario'],
                    [''],
                    ['RESUMEN ESTAD√çSTICO'],
                    ['Total de aplicaciones comparadas:', [...new Set(comparisonData.map(d => d.application_id))].length],
                    ['Total de respuestas analizadas:', comparisonData.reduce((sum, d) => sum + d.total_respuestas, 0)]
                ];
                
                // Calcular tendencia general
                if (comparisonData.length >= 2) {
                    const firstValue = parseFloat(comparisonData[0].promedio);
                    const lastValue = parseFloat(comparisonData[comparisonData.length - 1].promedio);
                    const diff = lastValue - firstValue;
                    const diffPercent = ((diff / firstValue) * 100).toFixed(2);
                    
                    infoData.push(['Valor inicial:', firstValue]);
                    infoData.push(['Valor final:', lastValue]);
                    infoData.push(['Cambio absoluto:', diff.toFixed(2)]);
                    infoData.push(['Cambio porcentual:', diffPercent + '%']);
                    infoData.push(['Tendencia:', diff > 0 ? 'Mejora' : diff < 0 ? 'Deterioro' : 'Sin cambio']);
                }
                
                const wsInfo = XLSX.utils.aoa_to_sheet(infoData);
                
                // Aplicar estilos a la hoja de informaci√≥n
                wsInfo['!cols'] = [
                    { wch: 30 },  // Columna A
                    { wch: 50 }   // Columna B
                ];
                
                XLSX.utils.book_append_sheet(wb, wsInfo, 'Informaci√≥n General');
                
                // === HOJA 2: DATOS DETALLADOS ===
                if (segmentFilter && segmentFilter !== '') {
                    // Exportaci√≥n con segmentaci√≥n
                    generarHojaSegmentada(wb);
                } else {
                    // Exportaci√≥n simple
                    generarHojaSimple(wb);
                }
                
                // === HOJA 3: AN√ÅLISIS DE CAMBIOS ===
                generarHojaCambios(wb, segmentFilter);
                
                // Generar archivo
                const nombreArchivo = generarNombreArchivo(survey.survey_name, comparisonType);
                XLSX.writeFile(wb, nombreArchivo, { bookType: 'xlsx', type: 'binary' });
                
                ocultarLoading();
                showMessage('Archivo Excel generado exitosamente', 'success');
                console.log('‚úÖ Archivo Excel generado:', nombreArchivo);
                
            } catch (error) {
                console.error('‚ùå Error exportando a Excel:', error);
                showMessage('Error al generar archivo Excel: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // GENERAR HOJA SIMPLE (SIN SEGMENTACI√ìN)
        // ==========================================
        function generarHojaSimple(wb) {
            const datosExcel = [
                ['Aplicaci√≥n', 'Promedio', 'Total Respuestas', 'Cambio vs Anterior', '% Cambio', 'Tendencia']
            ];
            
            comparisonData.forEach((item, index) => {
                let cambio = '-';
                let porcentajeCambio = '-';
                let tendencia = '-';
                
                if (index > 0) {
                    const prevPromedio = parseFloat(comparisonData[index - 1].promedio);
                    const currPromedio = parseFloat(item.promedio);
                    const diff = currPromedio - prevPromedio;
                    const diffPercent = ((diff / prevPromedio) * 100).toFixed(2);
                    
                    cambio = diff.toFixed(2);
                    porcentajeCambio = diffPercent + '%';
                    tendencia = diff > 0 ? 'Mejora' : diff < 0 ? 'Deterioro' : 'Sin cambio';
                }
                
                datosExcel.push([
                    item.application_name,
                    parseFloat(item.promedio),
                    item.total_respuestas,
                    cambio,
                    porcentajeCambio,
                    tendencia
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(datosExcel);
            
            // Configurar anchos de columna
            ws['!cols'] = [
                { wch: 30 },  // Aplicaci√≥n
                { wch: 12 },  // Promedio
                { wch: 18 },  // Total Respuestas
                { wch: 18 },  // Cambio
                { wch: 12 },  // % Cambio
                { wch: 15 }   // Tendencia
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Datos Comparaci√≥n');
        }
        
        // ==========================================
        // GENERAR HOJA SEGMENTADA
        // ==========================================
        function generarHojaSegmentada(wb) {
            const datosExcel = [
                ['Segmento', 'Aplicaci√≥n', 'Promedio', 'Total Respuestas', 'Cambio vs Anterior', '% Cambio', 'Tendencia']
            ];
            
            // Agrupar por segmento
            const segments = [...new Set(comparisonData.map(d => d.segment))];
            
            segments.forEach(segment => {
                const segmentData = comparisonData.filter(d => d.segment === segment);
                
                segmentData.forEach((item, index) => {
                    let cambio = '-';
                    let porcentajeCambio = '-';
                    let tendencia = '-';
                    
                    if (index > 0) {
                        const prevPromedio = parseFloat(segmentData[index - 1].promedio);
                        const currPromedio = parseFloat(item.promedio);
                        const diff = currPromedio - prevPromedio;
                        const diffPercent = ((diff / prevPromedio) * 100).toFixed(2);
                        
                        cambio = diff.toFixed(2);
                        porcentajeCambio = diffPercent + '%';
                        tendencia = diff > 0 ? 'Mejora' : diff < 0 ? 'Deterioro' : 'Sin cambio';
                    }
                    
                    datosExcel.push([
                        segment,
                        item.application_name,
                        parseFloat(item.promedio),
                        item.total_respuestas,
                        cambio,
                        porcentajeCambio,
                        tendencia
                    ]);
                });
                
                // Fila en blanco entre segmentos
                datosExcel.push(['', '', '', '', '', '', '']);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(datosExcel);
            
            // Configurar anchos de columna
            ws['!cols'] = [
                { wch: 25 },  // Segmento
                { wch: 30 },  // Aplicaci√≥n
                { wch: 12 },  // Promedio
                { wch: 18 },  // Total Respuestas
                { wch: 18 },  // Cambio
                { wch: 12 },  // % Cambio
                { wch: 15 }   // Tendencia
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Datos Comparaci√≥n');
        }
        
        // ==========================================
        // GENERAR HOJA DE AN√ÅLISIS DE CAMBIOS
        // ==========================================
        function generarHojaCambios(wb, segmentFilter) {
            const datosAnalisis = [
                ['AN√ÅLISIS DE CAMBIOS ENTRE APLICACIONES'],
                ['']
            ];
            
            if (segmentFilter && segmentFilter !== '') {
                // An√°lisis por segmento
                const segments = [...new Set(comparisonData.map(d => d.segment))];
                
                segments.forEach(segment => {
                    datosAnalisis.push([`SEGMENTO: ${segment}`]);
                    datosAnalisis.push(['Per√≠odo', 'Cambio Absoluto', 'Cambio %', 'Evaluaci√≥n']);
                    
                    const segmentData = comparisonData.filter(d => d.segment === segment);
                    
                    for (let i = 1; i < segmentData.length; i++) {
                        const prev = parseFloat(segmentData[i - 1].promedio);
                        const curr = parseFloat(segmentData[i].promedio);
                        const diff = curr - prev;
                        const diffPercent = ((diff / prev) * 100).toFixed(2);
                        
                        const periodo = `${segmentData[i - 1].application_name} ‚Üí ${segmentData[i].application_name}`;
                        const evaluacion = diff > 0.5 ? 'Mejora Significativa' :
                                          diff > 0 ? 'Mejora Leve' :
                                          diff < -0.5 ? 'Deterioro Significativo' :
                                          diff < 0 ? 'Deterioro Leve' :
                                          'Sin Cambio Relevante';
                        
                        datosAnalisis.push([
                            periodo,
                            diff.toFixed(2),
                            diffPercent + '%',
                            evaluacion
                        ]);
                    }
                    
                    datosAnalisis.push(['']);
                });
            } else {
                // An√°lisis simple
                datosAnalisis.push(['Per√≠odo', 'Cambio Absoluto', 'Cambio %', 'Evaluaci√≥n']);
                
                for (let i = 1; i < comparisonData.length; i++) {
                    const prev = parseFloat(comparisonData[i - 1].promedio);
                    const curr = parseFloat(comparisonData[i].promedio);
                    const diff = curr - prev;
                    const diffPercent = ((diff / prev) * 100).toFixed(2);
                    
                    const periodo = `${comparisonData[i - 1].application_name} ‚Üí ${comparisonData[i].application_name}`;
                    const evaluacion = diff > 0.5 ? 'Mejora Significativa' :
                                      diff > 0 ? 'Mejora Leve' :
                                      diff < -0.5 ? 'Deterioro Significativo' :
                                      diff < 0 ? 'Deterioro Leve' :
                                      'Sin Cambio Relevante';
                    
                    datosAnalisis.push([
                        periodo,
                        diff.toFixed(2),
                        diffPercent + '%',
                        evaluacion
                    ]);
                }
                
                datosAnalisis.push(['']);
                
                // Resumen estad√≠stico
                datosAnalisis.push(['RESUMEN ESTAD√çSTICO']);
                datosAnalisis.push(['']);
                
                const promedios = comparisonData.map(d => parseFloat(d.promedio));
                const promGeneral = (promedios.reduce((a, b) => a + b, 0) / promedios.length).toFixed(2);
                const maxProm = Math.max(...promedios).toFixed(2);
                const minProm = Math.min(...promedios).toFixed(2);
                const rangoVar = (maxProm - minProm).toFixed(2);
                
                datosAnalisis.push(['Promedio general:', promGeneral]);
                datosAnalisis.push(['Valor m√°ximo:', maxProm]);
                datosAnalisis.push(['Valor m√≠nimo:', minProm]);
                datosAnalisis.push(['Rango de variaci√≥n:', rangoVar]);
                
                // Calcular desviaci√≥n est√°ndar
                const varianza = promedios.reduce((acc, val) => {
                    return acc + Math.pow(val - promGeneral, 2);
                }, 0) / promedios.length;
                const desvEstandar = Math.sqrt(varianza).toFixed(2);
                
                datosAnalisis.push(['Desviaci√≥n est√°ndar:', desvEstandar]);
                datosAnalisis.push(['Coeficiente de variaci√≥n:', ((desvEstandar / promGeneral) * 100).toFixed(2) + '%']);
            }
            
            const wsAnalisis = XLSX.utils.aoa_to_sheet(datosAnalisis);
            
            // Configurar anchos de columna
            wsAnalisis['!cols'] = [
                { wch: 50 },  // Per√≠odo/Concepto
                { wch: 18 },  // Cambio Absoluto
                { wch: 12 },  // Cambio %
                { wch: 25 }   // Evaluaci√≥n
            ];
            
            XLSX.utils.book_append_sheet(wb, wsAnalisis, 'An√°lisis de Cambios');
        }
        
        // ==========================================
        // GENERAR NOMBRE DE ARCHIVO
        // ==========================================
        function generarNombreArchivo(surveyName, comparisonType) {
            // Limpiar nombre de encuesta
            const cleanSurveyName = surveyName
                .replace(/[^a-zA-Z0-9\s]/g, '')
                .replace(/\s+/g, '_')
                .substring(0, 30);
            
            const tipo = comparisonType === 'question' ? 'Pregunta' : 'Seccion';
            const fecha = new Date().toISOString().split('T')[0];
            
            return `Comparacion_${cleanSurveyName}_${tipo}_${fecha}.xlsx`;
        }
        
        // ==========================================
        // CERRAR SCRIPT
        // ==========================================
        console.log('‚úÖ Sistema de comparaci√≥n de aplicaciones cargado correctamente');
        
    </script>
</body>
</html>
      
