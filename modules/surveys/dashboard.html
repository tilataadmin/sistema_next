<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Encuestas - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Variables CSS del m√≥dulo */
        :root {
            --module-primary: #6f42c1;
            --module-secondary: #9b7ec9;
            --module-light: #f3e8ff;
        }
        
        /* Tarjetas de m√©tricas */
        .metric-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            height: 100%;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--module-primary);
            line-height: 1;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }
        
        .metric-icon {
            color: var(--module-primary);
            font-size: 2rem;
            opacity: 0.3;
        }
        
        /* Cards generales */
        .dashboard-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        /* Estado operativo */
        .status-card {
            background: linear-gradient(135deg, var(--module-light) 0%, #fff 100%);
            border-left: 4px solid var(--module-primary);
            padding: 1.25rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }
        
        .status-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.35rem 0.75rem;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .status-open {
            background-color: #d1f2eb;
            color: #0c5460;
        }
        
        .status-closed {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-draft {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .days-remaining {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .days-remaining.urgent {
            color: #dc3545;
        }
        
        .days-remaining.warning {
            color: #ffc107;
        }
        
        .days-remaining.normal {
            color: #198754;
        }
        
        /* Contenedores de gr√°ficos */
        .chart-container {
            position: relative;
            height: 350px;
            margin: 1rem 0;
        }
        
        .chart-container-small {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }
        
        /* Tabla de actividad */
        .activity-table {
            font-size: 0.9rem;
        }
        
        .activity-table th {
            background-color: var(--module-light);
            color: var(--module-primary);
            font-weight: 600;
            border: none;
            font-size: 0.85rem;
        }
        
        .activity-table td {
            vertical-align: middle;
        }
        
        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .activity-icon.created {
            background-color: #d1f2eb;
            color: #0c5460;
        }
        
        .activity-icon.closed {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .activity-icon.response {
            background-color: #cfe2ff;
            color: #084298;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--module-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .metric-value {
                font-size: 2rem;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .chart-container-small {
                height: 200px;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando dashboard...</p>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Encuestas</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Dashboard
                </li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-speedometer2 me-2" style="color: var(--module-primary);"></i>
                    Dashboard de Encuestas
                </h1>
                <p class="text-muted">Vista ejecutiva consolidada del m√≥dulo</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-primary btn-sm" id="btn-refresh-dashboard">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar Dashboard
                </button>
                <button class="btn btn-success btn-sm" id="btn-export-pdf">
                    <i class="bi bi-file-earmark-pdf me-1"></i>Exportar PDF
                </button>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Secci√≥n: KPIs Principales -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-muted mb-0">
                        <i class="bi bi-graph-up me-2"></i>Indicadores Clave
                    </h5>
                    <button class="btn btn-outline-primary btn-sm" id="btn-load-metrics">
                        <i class="bi bi-bar-chart me-1"></i>Cargar M√©tricas
                    </button>
                </div>
                
                <div class="row" id="metrics-container">
                    <!-- M√©trica 1: Encuestas Activas -->
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="card metric-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="metric-label">Encuestas Activas</div>
                                    <i class="bi bi-clipboard-data metric-icon"></i>
                                </div>
                                <div class="metric-value" id="metric-active-surveys">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- M√©trica 2: Aplicaciones Abiertas -->
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="card metric-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="metric-label">Aplicaciones Abiertas</div>
                                    <i class="bi bi-door-open metric-icon"></i>
                                </div>
                                <div class="metric-value" id="metric-open-apps">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- M√©trica 3: Aplicaciones Cerradas (Este A√±o) -->
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="card metric-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="metric-label">Cerradas Este A√±o</div>
                                    <i class="bi bi-archive metric-icon"></i>
                                </div>
                                <div class="metric-value" id="metric-closed-apps">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- M√©trica 4: Total Respuestas (A√±o Actual) -->
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="card metric-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="metric-label">Respuestas A√±o Actual</div>
                                    <i class="bi bi-chat-left-text metric-icon"></i>
                                </div>
                                <div class="metric-value" id="metric-total-responses">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- M√©trica 5: Tasa de Respuesta Promedio -->
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="card metric-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="metric-label">Tasa de Respuesta</div>
                                    <i class="bi bi-percent metric-icon"></i>
                                </div>
                                <div class="metric-value" id="metric-response-rate">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- M√©trica 6: Encuesta M√°s Reciente -->
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="card metric-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="metric-label">√öltima Aplicaci√≥n</div>
                                    <i class="bi bi-calendar-event metric-icon"></i>
                                </div>
                                <div class="metric-value" style="font-size: 1rem; line-height: 1.3;" id="metric-latest-survey">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n: Estado Operativo -->
        <div class="row mb-4">
            <div class="col-12">
                <h5 class="text-muted mb-3">
                    <i class="bi bi-activity me-2"></i>Estado Operativo
                </h5>
            </div>

            <!-- Aplicaciones Abiertas -->
            <div class="col-lg-4 mb-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">
                            <i class="bi bi-door-open me-2"></i>Aplicaciones Abiertas
                            <span class="badge bg-success" id="badge-open-count">0</span>
                        </h6>
                    </div>
                    <div class="card-body" id="open-apps-container">
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-inbox"></i>
                            <p class="mb-0 mt-2">No hay aplicaciones abiertas</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aplicaciones Pendientes de An√°lisis -->
            <div class="col-lg-4 mb-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">
                            <i class="bi bi-hourglass-split me-2"></i>Pendientes de An√°lisis
                            <span class="badge bg-warning text-dark" id="badge-pending-count">0</span>
                        </h6>
                    </div>
                    <div class="card-body" id="pending-apps-container">
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-inbox"></i>
                            <p class="mb-0 mt-2">No hay aplicaciones pendientes</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Borradores de Encuestas -->
            <div class="col-lg-4 mb-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">
                            <i class="bi bi-pencil-square me-2"></i>Borradores
                            <span class="badge bg-secondary" id="badge-draft-count">0</span>
                        </h6>
                    </div>
                    <div class="card-body" id="draft-surveys-container">
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-inbox"></i>
                            <p class="mb-0 mt-2">No hay borradores</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n: Gr√°ficos Anal√≠ticos -->
        <div class="row mb-4">
            <div class="col-12">
                <h5 class="text-muted mb-3">
                    <i class="bi bi-graph-up me-2"></i>An√°lisis Visual
                </h5>
            </div>

            <!-- Gr√°fico 1: Evoluci√≥n de Respuestas -->
            <div class="col-lg-6 mb-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">
                            <i class="bi bi-graph-up-arrow me-2"></i>Evoluci√≥n de Respuestas en el Tiempo
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="chart-responses-timeline"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico 2: Distribuci√≥n por P√∫blico -->
            <div class="col-lg-6 mb-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">
                            <i class="bi bi-pie-chart me-2"></i>Distribuci√≥n por P√∫blico Objetivo
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-small">
                            <canvas id="chart-audience-distribution"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico 3: Top 5 Encuestas con Mayor Participaci√≥n -->
            <div class="col-lg-6 mb-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">
                            <i class="bi bi-trophy me-2"></i>Top 5 Encuestas con Mayor Participaci√≥n
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-small">
                            <canvas id="chart-top-participation"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico 4: Promedio de Satisfacci√≥n -->
            <div class="col-lg-6 mb-3">
                <div class="card dashboard-card">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">
                            <i class="bi bi-star me-2"></i>Promedio de Satisfacci√≥n por Encuesta
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-small">
                            <canvas id="chart-satisfaction"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n: Tabla de Actividad Reciente -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">
                            <i class="bi bi-clock-history me-2"></i>Actividad Reciente
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover activity-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;"></th>
                                        <th>Fecha/Hora</th>
                                        <th>Tipo de Evento</th>
                                        <th>Descripci√≥n</th>
                                        <th>Usuario</th>
                                    </tr>
                                </thead>
                                <tbody id="activity-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <i class="bi bi-hourglass-split"></i>
                                            <div class="mt-2">Cargando actividad reciente...</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let currentAcademicYear = null;
        let metricsLoaded = false;
        let chartsInstances = {
            timeline: null,
            distribution: null,
            participation: null,
            satisfaction: null
        };
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // Validar permisos
                const hasAccess = await validatePageAccess('Dashboard de encuestas');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - iniciando dashboard');
                
                // Inicializar p√°gina
                await inicializarDashboard();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN PRINCIPAL
        // ==========================================
        async function inicializarDashboard() {
            try {
                mostrarLoading();
                
                // Obtener usuario actual
                const session = getStoredSession();
                if (session && session.user) {
                    currentUser = session.user;
                }
                
                // Obtener a√±o acad√©mico actual
                await obtenerAnoAcademicoActual();
                
                // Cargar estado operativo (no requiere bot√≥n)
                await cargarEstadoOperativo();
                
                // Cargar actividad reciente
                await cargarActividadReciente();
                
                // Configurar event listeners
                configurarEventListeners();
                
                ocultarLoading();
                console.log('‚úÖ Dashboard inicializado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando dashboard:', error);
                showMessage('Error al cargar el dashboard: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // OBTENER A√ëO ACAD√âMICO ACTUAL
        // ==========================================
        async function obtenerAnoAcademicoActual() {
            try {
                const years = await supabaseRequest('/academic_years?select=*&is_current=eq.true&limit=1');
                
                if (years && years.length > 0) {
                    currentAcademicYear = years[0];
                    console.log('üìÖ A√±o acad√©mico actual:', currentAcademicYear.year_name);
                } else {
                    console.warn('‚ö†Ô∏è No hay a√±o acad√©mico marcado como actual');
                    showMessage('Advertencia: No hay a√±o acad√©mico actual configurado', 'warning');
                }
                
            } catch (error) {
                console.error('‚ùå Error obteniendo a√±o acad√©mico:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CONFIGURAR EVENT LISTENERS
        // ==========================================
        function configurarEventListeners() {
            // Bot√≥n cargar m√©tricas
            document.getElementById('btn-load-metrics').addEventListener('click', cargarMetricas);
            
            // Bot√≥n actualizar dashboard
            document.getElementById('btn-refresh-dashboard').addEventListener('click', async function() {
                await cargarEstadoOperativo();
                await cargarActividadReciente();
                if (metricsLoaded) {
                    await cargarMetricas();
                }
                showMessage('Dashboard actualizado', 'success');
            });
            
            // Bot√≥n exportar PDF
            document.getElementById('btn-export-pdf').addEventListener('click', exportarDashboardPDF);
            
            console.log('‚úÖ Event listeners configurados');
        }
        
        // ==========================================
        // CARGAR M√âTRICAS
        // ==========================================
        async function cargarMetricas() {
            if (metricsLoaded) {
                // Si ya est√°n cargadas, solo actualizar
                console.log('üîÑ Actualizando m√©tricas...');
            } else {
                console.log('üìä Cargando m√©tricas por primera vez...');
            }
            
            const btnLoadMetrics = document.getElementById('btn-load-metrics');
            
            try {
                // Cambiar estado del bot√≥n
                btnLoadMetrics.disabled = true;
                btnLoadMetrics.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Cargando...';
                
                mostrarLoading();
                
                // Cargar todas las m√©tricas en paralelo
                await Promise.all([
                    cargarMetricaEncuestasActivas(),
                    cargarMetricaAplicacionesAbiertas(),
                    cargarMetricaAplicacionesCerradas(),
                    cargarMetricaTotalRespuestas(),
                    cargarMetricaTasaRespuesta(),
                    cargarMetricaUltimaEncuesta()
                ]);
                
                // Cargar gr√°ficos
                await cargarTodosLosGraficos();
                
                metricsLoaded = true;
                
                // Actualizar bot√≥n
                btnLoadMetrics.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Actualizar M√©tricas';
                btnLoadMetrics.disabled = false;
                
                ocultarLoading();
                showMessage('M√©tricas cargadas exitosamente', 'success');
                console.log('‚úÖ Todas las m√©tricas cargadas');
                
            } catch (error) {
                console.error('‚ùå Error cargando m√©tricas:', error);
                btnLoadMetrics.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Error al cargar';
                btnLoadMetrics.disabled = false;
                ocultarLoading();
                showMessage('Error al cargar m√©tricas: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // M√âTRICA 1: ENCUESTAS ACTIVAS
        // ==========================================
        async function cargarMetricaEncuestasActivas() {
            try {
                const data = await supabaseRequest('/survey_masters?select=count&is_active=eq.true');
                const count = data[0]?.count || 0;
                
                document.getElementById('metric-active-surveys').textContent = count;
                console.log('‚úÖ Encuestas activas:', count);
                
            } catch (error) {
                console.error('‚ùå Error en m√©trica encuestas activas:', error);
                document.getElementById('metric-active-surveys').innerHTML = '<span class="text-danger">Error</span>';
            }
        }
        
        // ==========================================
        // M√âTRICA 2: APLICACIONES ABIERTAS
        // ==========================================
        async function cargarMetricaAplicacionesAbiertas() {
            try {
                const data = await supabaseRequest('/survey_applications?select=count&status=eq.open');
                const count = data[0]?.count || 0;
                
                document.getElementById('metric-open-apps').textContent = count;
                console.log('‚úÖ Aplicaciones abiertas:', count);
                
            } catch (error) {
                console.error('‚ùå Error en m√©trica aplicaciones abiertas:', error);
                document.getElementById('metric-open-apps').innerHTML = '<span class="text-danger">Error</span>';
            }
        }
        
        // ==========================================
        // M√âTRICA 3: APLICACIONES CERRADAS ESTE A√ëO
        // ==========================================
        async function cargarMetricaAplicacionesCerradas() {
            try {
                if (!currentAcademicYear) {
                    document.getElementById('metric-closed-apps').textContent = '0';
                    return;
                }
                
                // Obtener fechas del a√±o acad√©mico
                const startDate = `${currentAcademicYear.start_year}-${String(currentAcademicYear.start_month).padStart(2, '0')}-01`;
                const endDate = `${currentAcademicYear.end_year}-${String(currentAcademicYear.end_month).padStart(2, '0')}-31`;
                
                const data = await supabaseRequest('/survey_applications?select=count&status=eq.closed&closed_at=gte.' + startDate + '&closed_at=lte.' + endDate);
                const count = data[0]?.count || 0;
                
                document.getElementById('metric-closed-apps').textContent = count;
                console.log('‚úÖ Aplicaciones cerradas este a√±o:', count);
                
            } catch (error) {
                console.error('‚ùå Error en m√©trica aplicaciones cerradas:', error);
                document.getElementById('metric-closed-apps').innerHTML = '<span class="text-danger">Error</span>';
            }
        }
        
        // ==========================================
        // M√âTRICA 4: TOTAL RESPUESTAS A√ëO ACTUAL
        // ==========================================
        async function cargarMetricaTotalRespuestas() {
            try {
                if (!currentAcademicYear) {
                    document.getElementById('metric-total-responses').textContent = '0';
                    return;
                }
                
                // Obtener fechas del a√±o acad√©mico
                const startDate = `${currentAcademicYear.start_year}-${String(currentAcademicYear.start_month).padStart(2, '0')}-01`;
                const endDate = `${currentAcademicYear.end_year}-${String(currentAcademicYear.end_month).padStart(2, '0')}-31`;
                
                const data = await supabaseRequest('/survey_responses?select=count&responded_at=gte.' + startDate + '&responded_at=lte.' + endDate);
                const count = data[0]?.count || 0;
                
                document.getElementById('metric-total-responses').textContent = new Intl.NumberFormat('es-CO').format(count);
                console.log('‚úÖ Total respuestas a√±o actual:', count);
                
            } catch (error) {
                console.error('‚ùå Error en m√©trica total respuestas:', error);
                document.getElementById('metric-total-responses').innerHTML = '<span class="text-danger">Error</span>';
            }
        }
        
        // ==========================================
        // M√âTRICA 5: TASA DE RESPUESTA PROMEDIO
        // ==========================================
        async function cargarMetricaTasaRespuesta() {
            try {
                // Obtener aplicaciones cerradas del a√±o actual
                if (!currentAcademicYear) {
                    document.getElementById('metric-response-rate').textContent = '0%';
                    return;
                }
                
                const startDate = `${currentAcademicYear.start_year}-${String(currentAcademicYear.start_month).padStart(2, '0')}-01`;
                const endDate = `${currentAcademicYear.end_year}-${String(currentAcademicYear.end_month).padStart(2, '0')}-31`;
                
                const applications = await supabaseRequest('/survey_applications?select=application_id,survey_masters(target_audience)&status=eq.closed&closed_at=gte.' + startDate + '&closed_at=lte.' + endDate);
                
                if (!applications || applications.length === 0) {
                    document.getElementById('metric-response-rate').textContent = '0%';
                    return;
                }
                
                // Calcular tasa promedio
                let totalRate = 0;
                let validApplications = 0;
                
                for (const app of applications) {
                    const rate = await calcularTasaRespuestaPorAplicacion(app.application_id, app.survey_masters.target_audience);
                    if (rate !== null) {
                        totalRate += rate;
                        validApplications++;
                    }
                }
                
                const avgRate = validApplications > 0 ? (totalRate / validApplications).toFixed(1) : 0;
                
                document.getElementById('metric-response-rate').textContent = avgRate + '%';
                console.log('‚úÖ Tasa de respuesta promedio:', avgRate + '%');
                
            } catch (error) {
                console.error('‚ùå Error en m√©trica tasa de respuesta:', error);
                document.getElementById('metric-response-rate').innerHTML = '<span class="text-danger">Error</span>';
            }
        }
        
        // ==========================================
        // CALCULAR TASA DE RESPUESTA POR APLICACI√ìN
        // ==========================================
        async function calcularTasaRespuestaPorAplicacion(applicationId, targetAudience) {
            try {
                // Obtener n√∫mero de respuestas
                const responsesData = await supabaseRequest('/survey_respondent_profile?select=count&application_id=eq.' + applicationId);
                const totalResponses = responsesData[0]?.count || 0;
                
                if (totalResponses === 0) {
                    return 0;
                }
                
                // Calcular poblaci√≥n objetivo seg√∫n tipo de audiencia
                let poblacionObjetivo = 0;
                
                if (targetAudience === 'students') {
                    // Solo estudiantes activos
                    const studentsData = await supabaseRequest('/students?select=count&student_status!inner(status_code)&student_status.status_code=in.(1,2,3)');
                    poblacionObjetivo = studentsData[0]?.count || 0;
                    
                } else if (targetAudience === 'families') {
                    // Familias con estudiantes activos * 2 (padre y madre)
                    const familiesData = await supabaseRequest('/families?select=count,students!inner(student_status!inner(status_code))&students.student_status.status_code=in.(1,2,3)');
                    const uniqueFamilies = familiesData[0]?.count || 0;
                    poblacionObjetivo = uniqueFamilies * 2;
                    
                } else if (targetAudience === 'workers') {
                    // Solo trabajadores activos
                    const workersData = await supabaseRequest('/workers?select=count&worker_status=eq.active');
                    poblacionObjetivo = workersData[0]?.count || 0;
                    
                } else if (targetAudience === 'mixed') {
                    // Para mixtas, sumar todos (estudiantes + familias*2 + trabajadores)
                    const studentsData = await supabaseRequest('/students?select=count&student_status!inner(status_code)&student_status.status_code=in.(1,2,3)');
                    const familiesData = await supabaseRequest('/families?select=count,students!inner(student_status!inner(status_code))&students.student_status.status_code=in.(1,2,3)');
                    const workersData = await supabaseRequest('/workers?select=count&worker_status=eq.active');
                    
                    const students = studentsData[0]?.count || 0;
                    const families = (familiesData[0]?.count || 0) * 2;
                    const workers = workersData[0]?.count || 0;
                    
                    poblacionObjetivo = students + families + workers;
                }
                
                if (poblacionObjetivo === 0) {
                    return null;
                }
                
                // Calcular tasa de respuesta
                const rate = (totalResponses / poblacionObjetivo) * 100;
                return rate;
                
            } catch (error) {
                console.error('‚ùå Error calculando tasa de respuesta:', error);
                return null;
            }
        }
        
        // ==========================================
        // M√âTRICA 6: √öLTIMA ENCUESTA
        // ==========================================
        async function cargarMetricaUltimaEncuesta() {
            try {
                const data = await supabaseRequest('/survey_applications?select=application_name,start_date,survey_masters(survey_name)&order=start_date.desc&limit=1');
                
                if (data && data.length > 0) {
                    const app = data[0];
                    const date = new Date(app.start_date);
                    const formattedDate = date.toLocaleDateString('es-CO', { month: 'short', day: 'numeric' });
                    
                    document.getElementById('metric-latest-survey').innerHTML = `
                        <div style="font-size: 0.85rem; font-weight: 600; color: var(--module-primary);">
                            ${escapeHtml(app.application_name)}
                        </div>
                        <div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;">
                            ${formattedDate}
                        </div>
                    `;
                } else {
                    document.getElementById('metric-latest-survey').innerHTML = '<div style="font-size: 0.85rem;">Sin datos</div>';
                }
                
                console.log('‚úÖ √öltima encuesta cargada');
                
            } catch (error) {
                console.error('‚ùå Error en m√©trica √∫ltima encuesta:', error);
                document.getElementById('metric-latest-survey').innerHTML = '<span class="text-danger">Error</span>';
            }
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
      // ==========================================
        // CARGAR ESTADO OPERATIVO
        // ==========================================
        async function cargarEstadoOperativo() {
            try {
                console.log('üìç Cargando estado operativo...');
                
                await Promise.all([
                    cargarAplicacionesAbiertas(),
                    cargarAplicacionesPendientes(),
                    cargarBorradores()
                ]);
                
                console.log('‚úÖ Estado operativo cargado');
                
            } catch (error) {
                console.error('‚ùå Error cargando estado operativo:', error);
                showMessage('Error al cargar estado operativo: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // CARGAR APLICACIONES ABIERTAS
        // ==========================================
        async function cargarAplicacionesAbiertas() {
            try {
                const applications = await supabaseRequest('/survey_applications?select=*,survey_masters(survey_name)&status=eq.open&order=end_date.asc');
                
                const container = document.getElementById('open-apps-container');
                const badge = document.getElementById('badge-open-count');
                
                badge.textContent = applications.length;
                
                if (!applications || applications.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-inbox"></i>
                            <p class="mb-0 mt-2">No hay aplicaciones abiertas</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                const today = new Date();
                
                applications.forEach(app => {
                    const endDate = new Date(app.end_date);
                    const daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                    
                    let daysClass = 'normal';
                    let daysText = `${daysRemaining} d√≠as restantes`;
                    
                    if (daysRemaining <= 0) {
                        daysClass = 'urgent';
                        daysText = 'Venci√≥';
                    } else if (daysRemaining <= 3) {
                        daysClass = 'urgent';
                    } else if (daysRemaining <= 7) {
                        daysClass = 'warning';
                    }
                    
                    html += `
                        <div class="status-card">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${escapeHtml(app.application_name)}</h6>
                                    <small class="text-muted">${escapeHtml(app.survey_masters.survey_name)}</small>
                                </div>
                                <span class="status-badge status-open">Abierta</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="bi bi-calendar-event me-1"></i>
                                    Cierra: ${formatDate(app.end_date, 'DD/MM/YYYY')}
                                </small>
                                <span class="days-remaining ${daysClass}">
                                    <i class="bi bi-clock me-1"></i>${daysText}
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                console.log(`‚úÖ ${applications.length} aplicaciones abiertas cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando aplicaciones abiertas:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR APLICACIONES PENDIENTES DE AN√ÅLISIS
        // ==========================================
        async function cargarAplicacionesPendientes() {
            try {
                // Aplicaciones cerradas en los √∫ltimos 30 d√≠as
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const dateFilter = thirtyDaysAgo.toISOString().split('T')[0];
                
                const applications = await supabaseRequest('/survey_applications?select=*,survey_masters(survey_name)&status=eq.closed&closed_at=gte.' + dateFilter + '&order=closed_at.desc&limit=10');
                
                const container = document.getElementById('pending-apps-container');
                const badge = document.getElementById('badge-pending-count');
                
                badge.textContent = applications.length;
                
                if (!applications || applications.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-inbox"></i>
                            <p class="mb-0 mt-2">No hay aplicaciones pendientes</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                applications.forEach(app => {
                    html += `
                        <div class="status-card">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${escapeHtml(app.application_name)}</h6>
                                    <small class="text-muted">${escapeHtml(app.survey_masters.survey_name)}</small>
                                </div>
                                <span class="status-badge status-closed">Cerrada</span>
                            </div>
                            <div>
                                <small class="text-muted">
                                    <i class="bi bi-calendar-x me-1"></i>
                                    Cerrada: ${formatDate(app.closed_at, 'DD/MM/YYYY')}
                                </small>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                console.log(`‚úÖ ${applications.length} aplicaciones pendientes cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando aplicaciones pendientes:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR BORRADORES
        // ==========================================
        async function cargarBorradores() {
            try {
                // Encuestas maestras con status 'draft' o aplicaciones con status 'draft'
                const draftMasters = await supabaseRequest('/survey_masters?select=survey_master_id,survey_name,created_at&is_active=eq.false&order=created_at.desc&limit=10');
                
                const container = document.getElementById('draft-surveys-container');
                const badge = document.getElementById('badge-draft-count');
                
                badge.textContent = draftMasters.length;
                
                if (!draftMasters || draftMasters.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-inbox"></i>
                            <p class="mb-0 mt-2">No hay borradores</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                draftMasters.forEach(master => {
                    html += `
                        <div class="status-card">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${escapeHtml(master.survey_name)}</h6>
                                    <small class="text-muted">Encuesta maestra</small>
                                </div>
                                <span class="status-badge status-draft">Borrador</span>
                            </div>
                            <div>
                                <small class="text-muted">
                                    <i class="bi bi-calendar-plus me-1"></i>
                                    Creada: ${formatDate(master.created_at, 'DD/MM/YYYY')}
                                </small>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                console.log(`‚úÖ ${draftMasters.length} borradores cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando borradores:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR TODOS LOS GR√ÅFICOS
        // ==========================================
        async function cargarTodosLosGraficos() {
            try {
                console.log('üìà Cargando gr√°ficos...');
                
                await Promise.all([
                    cargarGraficoEvolucionRespuestas(),
                    cargarGraficoDistribucionPublico(),
                    cargarGraficoTopParticipacion(),
                    cargarGraficoPromedioSatisfaccion()
                ]);
                
                console.log('‚úÖ Todos los gr√°ficos cargados');
                
            } catch (error) {
                console.error('‚ùå Error cargando gr√°ficos:', error);
                throw error;
            }
        }
        
        // ==========================================
        // GR√ÅFICO 1: EVOLUCI√ìN DE RESPUESTAS
        // ==========================================
        async function cargarGraficoEvolucionRespuestas() {
            try {
                if (!currentAcademicYear) {
                    console.warn('‚ö†Ô∏è No hay a√±o acad√©mico para gr√°fico de evoluci√≥n');
                    return;
                }
                
                // Obtener respuestas agrupadas por mes
                const startDate = `${currentAcademicYear.start_year}-${String(currentAcademicYear.start_month).padStart(2, '0')}-01`;
                const endDate = `${currentAcademicYear.end_year}-${String(currentAcademicYear.end_month).padStart(2, '0')}-31`;
                
                // Obtener todas las respuestas del per√≠odo
                const responses = await supabaseRequest('/survey_responses?select=responded_at&responded_at=gte.' + startDate + '&responded_at=lte.' + endDate);
                
                // Agrupar por mes
                const monthsData = {};
                
                responses.forEach(r => {
                    const date = new Date(r.responded_at);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthsData[monthKey]) {
                        monthsData[monthKey] = 0;
                    }
                    monthsData[monthKey]++;
                });
                
                // Preparar datos para el gr√°fico
                const sortedMonths = Object.keys(monthsData).sort();
                const labels = sortedMonths.map(m => {
                    const [year, month] = m.split('-');
                    const date = new Date(year, parseInt(month) - 1);
                    return date.toLocaleDateString('es-CO', { month: 'short', year: 'numeric' });
                });
                const data = sortedMonths.map(m => monthsData[m]);
                
                // Destruir gr√°fico anterior si existe
                if (chartsInstances.timeline) {
                    chartsInstances.timeline.destroy();
                }
                
                // Crear gr√°fico
                const ctx = document.getElementById('chart-responses-timeline').getContext('2d');
                
                chartsInstances.timeline = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Respuestas',
                            data: data,
                            borderColor: 'rgb(111, 66, 193)',
                            backgroundColor: 'rgba(111, 66, 193, 0.1)',
                            borderWidth: 3,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: 'rgb(111, 66, 193)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 14
                                },
                                bodyFont: {
                                    size: 13
                                },
                                callbacks: {
                                    label: function(context) {
                                        return 'Respuestas: ' + context.parsed.y.toLocaleString('es-CO');
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value) {
                                        return value.toLocaleString('es-CO');
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de evoluci√≥n cargado');
                
            } catch (error) {
                console.error('‚ùå Error en gr√°fico de evoluci√≥n:', error);
                throw error;
            }
        }
        
        // ==========================================
        // GR√ÅFICO 2: DISTRIBUCI√ìN POR P√öBLICO
        // ==========================================
        async function cargarGraficoDistribucionPublico() {
            try {
                if (!currentAcademicYear) {
                    console.warn('‚ö†Ô∏è No hay a√±o acad√©mico para gr√°fico de distribuci√≥n');
                    return;
                }
                
                // Obtener respuestas agrupadas por tipo de respondiente
                const startDate = `${currentAcademicYear.start_year}-${String(currentAcademicYear.start_month).padStart(2, '0')}-01`;
                const endDate = `${currentAcademicYear.end_year}-${String(currentAcademicYear.end_month).padStart(2, '0')}-31`;
                
                // Query para contar por tipo de respondiente
                const profiles = await supabaseRequest('/survey_respondent_profile?select=respondent_type&responded_at=gte.' + startDate + '&responded_at=lte.' + endDate);
                
                // Agrupar por tipo
                const distribution = {
                    student: 0,
                    family: 0,
                    worker: 0
                };
                
                profiles.forEach(p => {
                    if (distribution.hasOwnProperty(p.respondent_type)) {
                        distribution[p.respondent_type]++;
                    }
                });
                
                // Preparar datos para el gr√°fico
                const labels = ['Estudiantes', 'Familias', 'Trabajadores'];
                const data = [distribution.student, distribution.family, distribution.worker];
                const colors = [
                    'rgb(111, 66, 193)',   // P√∫rpura para estudiantes
                    'rgb(25, 135, 84)',    // Verde para familias
                    'rgb(13, 110, 253)'    // Azul para trabajadores
                ];
                
                // Destruir gr√°fico anterior si existe
                if (chartsInstances.distribution) {
                    chartsInstances.distribution.destroy();
                }
                
                // Crear gr√°fico
                const ctx = document.getElementById('chart-audience-distribution').getContext('2d');
                
                chartsInstances.distribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderColor: '#fff',
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 14
                                },
                                bodyFont: {
                                    size: 13
                                },
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const value = context.parsed;
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return context.label + ': ' + value.toLocaleString('es-CO') + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de distribuci√≥n cargado');
                
            } catch (error) {
                console.error('‚ùå Error en gr√°fico de distribuci√≥n:', error);
                throw error;
            }
        }
      // ==========================================
        // GR√ÅFICO 3: TOP 5 ENCUESTAS CON MAYOR PARTICIPACI√ìN
        // ==========================================
        async function cargarGraficoTopParticipacion() {
            try {
                if (!currentAcademicYear) {
                    console.warn('‚ö†Ô∏è No hay a√±o acad√©mico para gr√°fico de participaci√≥n');
                    return;
                }
                
                // Obtener aplicaciones cerradas del a√±o actual
                const startDate = `${currentAcademicYear.start_year}-${String(currentAcademicYear.start_month).padStart(2, '0')}-01`;
                const endDate = `${currentAcademicYear.end_year}-${String(currentAcademicYear.end_month).padStart(2, '0')}-31`;
                
                const applications = await supabaseRequest('/survey_applications?select=application_id,application_name,survey_masters(target_audience)&status=eq.closed&closed_at=gte.' + startDate + '&closed_at=lte.' + endDate);
                
                if (!applications || applications.length === 0) {
                    console.log('‚ÑπÔ∏è No hay aplicaciones cerradas para gr√°fico de participaci√≥n');
                    return;
                }
                
                // Calcular tasa de respuesta para cada aplicaci√≥n
                const participationData = [];
                
                for (const app of applications) {
                    const rate = await calcularTasaRespuestaPorAplicacion(app.application_id, app.survey_masters.target_audience);
                    
                    if (rate !== null) {
                        participationData.push({
                            name: app.application_name,
                            rate: rate
                        });
                    }
                }
                
                // Ordenar por tasa de respuesta (descendente) y tomar top 5
                participationData.sort((a, b) => b.rate - a.rate);
                const top5 = participationData.slice(0, 5);
                
                if (top5.length === 0) {
                    console.log('‚ÑπÔ∏è No hay datos suficientes para gr√°fico de participaci√≥n');
                    return;
                }
                
                // Preparar datos para el gr√°fico
                const labels = top5.map(item => item.name);
                const data = top5.map(item => item.rate.toFixed(1));
                
                // Destruir gr√°fico anterior si existe
                if (chartsInstances.participation) {
                    chartsInstances.participation.destroy();
                }
                
                // Crear gr√°fico
                const ctx = document.getElementById('chart-top-participation').getContext('2d');
                
                chartsInstances.participation = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Tasa de Respuesta (%)',
                            data: data,
                            backgroundColor: 'rgba(111, 66, 193, 0.8)',
                            borderColor: 'rgb(111, 66, 193)',
                            borderWidth: 2,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 14
                                },
                                bodyFont: {
                                    size: 13
                                },
                                callbacks: {
                                    label: function(context) {
                                        return 'Participaci√≥n: ' + context.parsed.x + '%';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value, index) {
                                        const label = this.getLabelForValue(value);
                                        // Truncar etiquetas largas
                                        return label.length > 25 ? label.substring(0, 25) + '...' : label;
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de participaci√≥n cargado');
                
            } catch (error) {
                console.error('‚ùå Error en gr√°fico de participaci√≥n:', error);
                throw error;
            }
        }
        
        // ==========================================
        // GR√ÅFICO 4: PROMEDIO DE SATISFACCI√ìN
        // ==========================================
        async function cargarGraficoPromedioSatisfaccion() {
            try {
                if (!currentAcademicYear) {
                    console.warn('‚ö†Ô∏è No hay a√±o acad√©mico para gr√°fico de satisfacci√≥n');
                    return;
                }
                
                // Obtener aplicaciones cerradas del a√±o actual
                const startDate = `${currentAcademicYear.start_year}-${String(currentAcademicYear.start_month).padStart(2, '0')}-01`;
                const endDate = `${currentAcademicYear.end_year}-${String(currentAcademicYear.end_month).padStart(2, '0')}-31`;
                
                const applications = await supabaseRequest('/survey_applications?select=application_id,application_name,survey_masters(survey_master_id,survey_name)&status=eq.closed&closed_at=gte.' + startDate + '&closed_at=lte.' + endDate + '&limit=10');
                
                if (!applications || applications.length === 0) {
                    console.log('‚ÑπÔ∏è No hay aplicaciones cerradas para gr√°fico de satisfacci√≥n');
                    return;
                }
                
                // Calcular promedio de respuestas para cada aplicaci√≥n
                const satisfactionData = [];
                
                for (const app of applications) {
                    // Obtener todas las respuestas num√©ricas de esta aplicaci√≥n
                    const responses = await supabaseRequest('/survey_responses?select=response_value,survey_respondent_profile!inner(application_id)&survey_respondent_profile.application_id=eq.' + app.application_id + '&response_value=not.is.null');
                    
                    if (responses && responses.length > 0) {
                        // Calcular promedio
                        const sum = responses.reduce((acc, r) => acc + (r.response_value || 0), 0);
                        const avg = sum / responses.length;
                        
                        satisfactionData.push({
                            name: app.application_name,
                            average: avg
                        });
                    }
                }
                
                if (satisfactionData.length === 0) {
                    console.log('‚ÑπÔ∏è No hay datos de satisfacci√≥n disponibles');
                    return;
                }
                
                // Ordenar por promedio (descendente) y tomar top 10
                satisfactionData.sort((a, b) => b.average - a.average);
                const top10 = satisfactionData.slice(0, 10);
                
                // Preparar datos para el gr√°fico
                const labels = top10.map(item => item.name);
                const data = top10.map(item => item.average.toFixed(2));
                
                // Colores graduales seg√∫n el valor (verde para alto, amarillo medio, rojo bajo)
                const colors = data.map(value => {
                    const numValue = parseFloat(value);
                    if (numValue >= 4) return 'rgba(25, 135, 84, 0.8)';      // Verde
                    if (numValue >= 3) return 'rgba(255, 193, 7, 0.8)';      // Amarillo
                    return 'rgba(220, 53, 69, 0.8)';                          // Rojo
                });
                
                // Destruir gr√°fico anterior si existe
                if (chartsInstances.satisfaction) {
                    chartsInstances.satisfaction.destroy();
                }
                
                // Crear gr√°fico
                const ctx = document.getElementById('chart-satisfaction').getContext('2d');
                
                chartsInstances.satisfaction = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Promedio',
                            data: data,
                            backgroundColor: colors,
                            borderColor: colors.map(c => c.replace('0.8', '1')),
                            borderWidth: 2,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 14
                                },
                                bodyFont: {
                                    size: 13
                                },
                                callbacks: {
                                    label: function(context) {
                                        return 'Promedio: ' + context.parsed.y;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 5,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    stepSize: 1
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 10
                                    },
                                    callback: function(value, index) {
                                        const label = this.getLabelForValue(value);
                                        // Truncar etiquetas largas
                                        return label.length > 20 ? label.substring(0, 20) + '...' : label;
                                    },
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico de satisfacci√≥n cargado');
                
            } catch (error) {
                console.error('‚ùå Error en gr√°fico de satisfacci√≥n:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR ACTIVIDAD RECIENTE
        // ==========================================
        async function cargarActividadReciente() {
            try {
                console.log('üïê Cargando actividad reciente...');
                
                const tbody = document.getElementById('activity-table-body');
                
                // Obtener eventos recientes
                const eventos = [];
                
                // 1. Aplicaciones creadas recientemente
                const appCreated = await supabaseRequest('/survey_applications?select=application_id,application_name,created_at,survey_masters(survey_name),users!survey_applications_closed_by_fkey(user_display_name)&order=created_at.desc&limit=10');
                
                appCreated.forEach(app => {
                    eventos.push({
                        type: 'created',
                        icon: 'bi-plus-circle',
                        fecha: new Date(app.created_at),
                        evento: 'Aplicaci√≥n Creada',
                        descripcion: `${app.application_name} - ${app.survey_masters.survey_name}`,
                        usuario: app.users?.user_display_name || 'Sistema'
                    });
                });
                
                // 2. Aplicaciones cerradas recientemente
                const appClosed = await supabaseRequest('/survey_applications?select=application_id,application_name,closed_at,survey_masters(survey_name),users!survey_applications_closed_by_fkey(user_display_name)&status=eq.closed&closed_at=not.is.null&order=closed_at.desc&limit=10');
                
                appClosed.forEach(app => {
                    if (app.closed_at) {
                        eventos.push({
                            type: 'closed',
                            icon: 'bi-lock',
                            fecha: new Date(app.closed_at),
                            evento: 'Aplicaci√≥n Cerrada',
                            descripcion: `${app.application_name} - ${app.survey_masters.survey_name}`,
                            usuario: app.users?.user_display_name || 'Sistema'
                        });
                    }
                });
                
                // 3. Encuestas maestras creadas recientemente
                const mastersCreated = await supabaseRequest('/survey_masters?select=survey_master_id,survey_name,created_at,users!survey_masters_created_by_fkey(user_display_name)&order=created_at.desc&limit=10');
                
                mastersCreated.forEach(master => {
                    eventos.push({
                        type: 'created',
                        icon: 'bi-file-earmark-plus',
                        fecha: new Date(master.created_at),
                        evento: 'Encuesta Maestra Creada',
                        descripcion: master.survey_name,
                        usuario: master.users?.user_display_name || 'Sistema'
                    });
                });
                
                // Ordenar todos los eventos por fecha (m√°s reciente primero)
                eventos.sort((a, b) => b.fecha - a.fecha);
                
                // Tomar solo los 20 m√°s recientes
                const eventosRecientes = eventos.slice(0, 20);
                
                if (eventosRecientes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <i class="bi bi-inbox"></i>
                                <div class="mt-2">No hay actividad reciente</div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Renderizar tabla
                let html = '';
                
                eventosRecientes.forEach(evento => {
                    const iconClass = evento.type === 'created' ? 'created' : 'closed';
                    const fechaFormateada = evento.fecha.toLocaleString('es-CO', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    html += `
                        <tr>
                            <td>
                                <div class="activity-icon ${iconClass}">
                                    <i class="${evento.icon}"></i>
                                </div>
                            </td>
                            <td>
                                <small>${fechaFormateada}</small>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">${evento.evento}</span>
                            </td>
                            <td>${escapeHtml(evento.descripcion)}</td>
                            <td>
                                <small class="text-muted">${escapeHtml(evento.usuario)}</small>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
                console.log(`‚úÖ ${eventosRecientes.length} eventos de actividad cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando actividad reciente:', error);
                const tbody = document.getElementById('activity-table-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            <div class="mt-2">Error al cargar actividad</div>
                        </td>
                    </tr>
                `;
            }
        }
      // ==========================================
        // EXPORTAR DASHBOARD A PDF
        // ==========================================
        async function exportarDashboardPDF() {
            try {
                mostrarLoading();
                console.log('üìÑ Generando PDF del dashboard...');
                
                // Verificar que las m√©tricas est√©n cargadas
                if (!metricsLoaded) {
                    ocultarLoading();
                    showMessage('Por favor carga las m√©tricas antes de exportar el PDF', 'warning');
                    return;
                }
                
                // Crear instancia de jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                let yPosition = margin;
                
                // === P√ÅGINA 1: PORTADA Y M√âTRICAS ===
                
                // Header - Logo y t√≠tulo
                doc.setFillColor(111, 66, 193);
                doc.rect(0, 0, pageWidth, 40, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('Dashboard de Encuestas', margin, 20);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('SchoolNet - Reporte Ejecutivo', margin, 30);
                
                // Informaci√≥n del reporte
                doc.setTextColor(0, 0, 0);
                yPosition = 50;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const fechaGeneracion = new Date().toLocaleString('es-CO', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                doc.text(`Fecha de generaci√≥n: ${fechaGeneracion}`, margin, yPosition);
                yPosition += 6;
                
                if (currentAcademicYear) {
                    doc.text(`A√±o acad√©mico: ${currentAcademicYear.year_name}`, margin, yPosition);
                    yPosition += 6;
                }
                
                doc.text(`Generado por: ${currentUser ? currentUser.user_display_name : 'Usuario'}`, margin, yPosition);
                yPosition += 15;
                
                // Secci√≥n: Indicadores Clave
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(111, 66, 193);
                doc.text('Indicadores Clave', margin, yPosition);
                yPosition += 8;
                
                // Dibujar m√©tricas en cards
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                
                const metricas = [
                    {
                        label: 'Encuestas Activas',
                        value: document.getElementById('metric-active-surveys').textContent
                    },
                    {
                        label: 'Aplicaciones Abiertas',
                        value: document.getElementById('metric-open-apps').textContent
                    },
                    {
                        label: 'Cerradas Este A√±o',
                        value: document.getElementById('metric-closed-apps').textContent
                    },
                    {
                        label: 'Respuestas A√±o Actual',
                        value: document.getElementById('metric-total-responses').textContent
                    },
                    {
                        label: 'Tasa de Respuesta',
                        value: document.getElementById('metric-response-rate').textContent
                    }
                ];
                
                const cardWidth = 35;
                const cardHeight = 25;
                const cardSpacing = 5;
                let xPosition = margin;
                
                metricas.forEach((metrica, index) => {
                    if (index === 3) {
                        // Nueva fila despu√©s de 3 m√©tricas
                        xPosition = margin;
                        yPosition += cardHeight + cardSpacing;
                    }
                    
                    // Dibujar card
                    doc.setDrawColor(111, 66, 193);
                    doc.setLineWidth(0.5);
                    doc.rect(xPosition, yPosition, cardWidth, cardHeight);
                    
                    // Label
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(metrica.label, xPosition + 2, yPosition + 5);
                    
                    // Value
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(111, 66, 193);
                    doc.text(metrica.value, xPosition + 2, yPosition + 15);
                    
                    doc.setFont('helvetica', 'normal');
                    xPosition += cardWidth + cardSpacing;
                });
                
                yPosition += cardHeight + 15;
                
                // Secci√≥n: Estado Operativo
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(111, 66, 193);
                doc.text('Estado Operativo', margin, yPosition);
                yPosition += 8;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                
                // Aplicaciones abiertas
                const openAppsCount = document.getElementById('badge-open-count').textContent;
                doc.text(`‚Ä¢ Aplicaciones Abiertas: ${openAppsCount}`, margin + 5, yPosition);
                yPosition += 6;
                
                // Pendientes de an√°lisis
                const pendingCount = document.getElementById('badge-pending-count').textContent;
                doc.text(`‚Ä¢ Pendientes de An√°lisis: ${pendingCount}`, margin + 5, yPosition);
                yPosition += 6;
                
                // Borradores
                const draftCount = document.getElementById('badge-draft-count').textContent;
                doc.text(`‚Ä¢ Borradores: ${draftCount}`, margin + 5, yPosition);
                yPosition += 15;
                
                // === P√ÅGINA 2: GR√ÅFICOS ===
                doc.addPage();
                yPosition = margin;
                
                // T√≠tulo de la p√°gina
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(111, 66, 193);
                doc.text('An√°lisis Visual', margin, yPosition);
                yPosition += 10;
                
                // Capturar gr√°ficos y agregarlos al PDF
                try {
                    // Gr√°fico 1: Evoluci√≥n de Respuestas
                    const chartTimeline = document.getElementById('chart-responses-timeline');
                    if (chartTimeline) {
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text('Evoluci√≥n de Respuestas en el Tiempo', margin, yPosition);
                        yPosition += 5;
                        
                        const canvas1 = await html2canvas(chartTimeline, {
                            backgroundColor: '#ffffff',
                            scale: 2
                        });
                        const imgData1 = canvas1.toDataURL('image/png');
                        const imgWidth1 = pageWidth - (2 * margin);
                        const imgHeight1 = (canvas1.height * imgWidth1) / canvas1.width;
                        
                        doc.addImage(imgData1, 'PNG', margin, yPosition, imgWidth1, Math.min(imgHeight1, 70));
                        yPosition += Math.min(imgHeight1, 70) + 10;
                    }
                    
                    // Verificar si necesitamos nueva p√°gina
                    if (yPosition > pageHeight - 80) {
                        doc.addPage();
                        yPosition = margin;
                    }
                    
                    // Gr√°fico 2: Distribuci√≥n por P√∫blico
                    const chartDistribution = document.getElementById('chart-audience-distribution');
                    if (chartDistribution) {
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Distribuci√≥n por P√∫blico Objetivo', margin, yPosition);
                        yPosition += 5;
                        
                        const canvas2 = await html2canvas(chartDistribution, {
                            backgroundColor: '#ffffff',
                            scale: 2
                        });
                        const imgData2 = canvas2.toDataURL('image/png');
                        const imgWidth2 = (pageWidth - (2 * margin)) / 2;
                        const imgHeight2 = (canvas2.height * imgWidth2) / canvas2.width;
                        
                        doc.addImage(imgData2, 'PNG', margin, yPosition, imgWidth2, Math.min(imgHeight2, 60));
                        yPosition += Math.min(imgHeight2, 60) + 10;
                    }
                    
                    // Nueva p√°gina para gr√°ficos 3 y 4
                    doc.addPage();
                    yPosition = margin;
                    
                    // Gr√°fico 3: Top 5 Participaci√≥n
                    const chartParticipation = document.getElementById('chart-top-participation');
                    if (chartParticipation) {
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Top 5 Encuestas con Mayor Participaci√≥n', margin, yPosition);
                        yPosition += 5;
                        
                        const canvas3 = await html2canvas(chartParticipation, {
                            backgroundColor: '#ffffff',
                            scale: 2
                        });
                        const imgData3 = canvas3.toDataURL('image/png');
                        const imgWidth3 = pageWidth - (2 * margin);
                        const imgHeight3 = (canvas3.height * imgWidth3) / canvas3.width;
                        
                        doc.addImage(imgData3, 'PNG', margin, yPosition, imgWidth3, Math.min(imgHeight3, 70));
                        yPosition += Math.min(imgHeight3, 70) + 10;
                    }
                    
                    // Verificar si necesitamos nueva p√°gina
                    if (yPosition > pageHeight - 80) {
                        doc.addPage();
                        yPosition = margin;
                    }
                    
                    // Gr√°fico 4: Promedio de Satisfacci√≥n
                    const chartSatisfaction = document.getElementById('chart-satisfaction');
                    if (chartSatisfaction) {
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Promedio de Satisfacci√≥n por Encuesta', margin, yPosition);
                        yPosition += 5;
                        
                        const canvas4 = await html2canvas(chartSatisfaction, {
                            backgroundColor: '#ffffff',
                            scale: 2
                        });
                        const imgData4 = canvas4.toDataURL('image/png');
                        const imgWidth4 = pageWidth - (2 * margin);
                        const imgHeight4 = (canvas4.height * imgWidth4) / canvas4.width;
                        
                        doc.addImage(imgData4, 'PNG', margin, yPosition, imgWidth4, Math.min(imgHeight4, 70));
                    }
                    
                } catch (chartError) {
                    console.error('Error capturando gr√°ficos:', chartError);
                    doc.setFontSize(10);
                    doc.setTextColor(220, 53, 69);
                    doc.text('Error al capturar gr√°ficos', margin, yPosition);
                }
                
                // === P√ÅGINA 3: ACTIVIDAD RECIENTE ===
                doc.addPage();
                yPosition = margin;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(111, 66, 193);
                doc.text('Actividad Reciente', margin, yPosition);
                yPosition += 10;
                
                // Obtener datos de la tabla de actividad
                const activityRows = document.querySelectorAll('#activity-table-body tr');
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                
                let rowCount = 0;
                activityRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    
                    if (cells.length >= 4) {
                        // Verificar si necesitamos nueva p√°gina
                        if (yPosition > pageHeight - 20) {
                            doc.addPage();
                            yPosition = margin;
                        }
                        
                        const fecha = cells[1].textContent.trim();
                        const tipo = cells[2].textContent.trim();
                        const descripcion = cells[3].textContent.trim();
                        
                        // Formatear l√≠nea de actividad
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${fecha}`, margin, yPosition);
                        
                        doc.setFont('helvetica', 'normal');
                        doc.text(`[${tipo}] ${descripcion.substring(0, 70)}`, margin + 40, yPosition);
                        
                        yPosition += 6;
                        rowCount++;
                        
                        if (rowCount >= 15) return; // M√°ximo 15 eventos en el PDF
                    }
                });
                
                // Footer en todas las p√°ginas
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(
                        `P√°gina ${i} de ${totalPages}`,
                        pageWidth / 2,
                        pageHeight - 10,
                        { align: 'center' }
                    );
                    doc.text(
                        'SchoolNet - Sistema de Gesti√≥n Educativa',
                        pageWidth - margin,
                        pageHeight - 10,
                        { align: 'right' }
                    );
                }
                
                // Generar nombre de archivo
                const fileName = generarNombreArchivoPDF();
                
                // Guardar PDF
                doc.save(fileName);
                
                ocultarLoading();
                showMessage('PDF generado exitosamente', 'success');
                console.log('‚úÖ PDF generado:', fileName);
                
            } catch (error) {
                console.error('‚ùå Error generando PDF:', error);
                ocultarLoading();
                showMessage('Error al generar PDF: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // GENERAR NOMBRE DE ARCHIVO PDF
        // ==========================================
        function generarNombreArchivoPDF() {
            const fecha = new Date().toISOString().split('T')[0];
            let nombreBase = 'Dashboard_Encuestas';
            
            if (currentAcademicYear) {
                const yearName = currentAcademicYear.year_name
                    .replace(/[^a-zA-Z0-9]/g, '_')
                    .substring(0, 20);
                nombreBase += `_${yearName}`;
            }
            
            return `${nombreBase}_${fecha}.pdf`;
        }
        
        // ==========================================
        // CERRAR SCRIPT
        // ==========================================
        console.log('‚úÖ Dashboard de encuestas cargado correctamente');
        console.log('üìä M√©tricas en modo carga diferida');
        console.log('üé® 4 gr√°ficos interactivos disponibles');
        console.log('üìÑ Exportaci√≥n a PDF habilitada');
        
    </script>
</body>
</html>
