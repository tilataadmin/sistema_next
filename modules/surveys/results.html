<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados de Encuesta - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Estilos para el módulo de resultados */
        .results-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        .question-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        .question-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        .scale-option {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .scale-label {
            min-width: 200px;
            font-size: 0.875rem;
        }
        
        .scale-bar {
            flex-grow: 1;
            height: 30px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .scale-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .scale-count {
            margin-left: 1rem;
            font-weight: 600;
            color: #495057;
            min-width: 60px;
        }
        
        .filter-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .open-response {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-results {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .section-header {
            background: #667eea;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando resultados...</p>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Encuestas</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Resultados
                </li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-bar-chart-line me-2"></i>
                    Resultados de Encuesta
                </h1>
                <p class="text-muted">Análisis detallado de respuestas</p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Selector de aplicación -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <label for="applicationSelect" class="form-label fw-bold">
                            Selecciona una aplicación cerrada para ver resultados
                        </label>
                        <select class="form-select" id="applicationSelect">
                            <option value="">Cargando aplicaciones...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" id="loadResultsBtn" disabled>
                            <i class="bi bi-search me-2"></i>Ver Resultados
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de resultados (oculta inicialmente) -->
        <div id="resultsArea" style="display: none;">
            
            <!-- Header de la aplicación -->
            <div class="results-header" id="applicationHeader">
                <div class="row">
                    <div class="col-md-8">
                        <h2 class="h4 mb-2" id="surveyTitle">Nombre de la Encuesta</h2>
                        <p class="mb-1" id="applicationName">Aplicación X</p>
                        <small id="dateRange">Período: DD/MM/YYYY - DD/MM/YYYY</small>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="stat-value text-white" id="totalResponses">0</div>
                        <div class="text-white-50">respuestas recibidas</div>
                    </div>
                </div>
            </div>
            <!-- Sección de filtros (se muestra solo si hay segmentos disponibles) -->
            <div class="filter-section" id="filterSection" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>Filtrar Resultados por Segmentos
                    </h5>
                    <button class="btn btn-outline-secondary btn-sm" id="clearFiltersBtn">
                        <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                    </button>
                </div>
                
                <!-- Contenedor de filtros dinámicos -->
                <div class="row" id="filtersContainer">
                    <!-- Los filtros se generarán dinámicamente según los segmentos disponibles -->
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-primary" id="applyFiltersBtn">
                        <i class="bi bi-check-circle me-1"></i>Aplicar Filtros
                    </button>
                </div>
            </div>

            <!-- Estadísticas generales -->
            <div class="row mb-4" id="statsContainer">
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <div class="stat-value" id="filteredResponsesCount">0</div>
                            <div class="stat-label">Respuestas (filtradas)</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <div class="stat-value" id="totalQuestionsCount">0</div>
                            <div class="stat-label">Preguntas</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <div class="stat-value" id="scaleQuestionsCount">0</div>
                            <div class="stat-label">Tipo Escala</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <div class="stat-value" id="openQuestionsCount">0</div>
                            <div class="stat-label">Tipo Abierta</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenedor de secciones y preguntas -->
            <div id="sectionsContainer">
                <!-- Las secciones y preguntas se renderizarán aquí -->
            </div>

        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let selectedApplication = null;
        let surveyData = null;
        let allResponses = [];
        let filteredResponses = [];
        let availableSegments = {};
        let activeFilters = {};
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                // Validar permisos
                const hasAccess = await validatePageAccess('Crear encuestas');
                if (!hasAccess) {
                    console.log('❌ Acceso denegado');
                    return;
                }
                
                console.log('✅ Acceso permitido - inicializando página');
                
                // Obtener usuario actual
                const session = getStoredSession();
                if (session && session.user) {
                    currentUser = session.user;
                    console.log('✅ Usuario actual:', currentUser.user_display_name);
                }
                
                // Cargar aplicaciones cerradas
                await loadClosedApplications();
                
                // Configurar event listeners
                setupEventListeners();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
                ocultarLoading();
            }
        });
        
        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        function setupEventListeners() {
            // Cambio en selector de aplicación
            document.getElementById('applicationSelect').addEventListener('change', function() {
                const applicationId = this.value;
                document.getElementById('loadResultsBtn').disabled = !applicationId;
            });
            
            // Botón cargar resultados
            document.getElementById('loadResultsBtn').addEventListener('click', loadResults);
            
            // Botón aplicar filtros
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            
            // Botón limpiar filtros
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
        }
        
        // ==========================================
        // CARGAR APLICACIONES CERRADAS
        // ==========================================
        async function loadClosedApplications() {
            try {
                console.log('📡 Cargando aplicaciones cerradas...');
                
                // Obtener aplicaciones cerradas del usuario actual
                const applications = await supabaseRequest(
                    '/survey_applications?select=*,survey_masters(survey_name,created_by)&status=eq.closed&order=created_at.desc'
                );
                
                // Filtrar solo las aplicaciones de encuestas del usuario
                const userApplications = applications.filter(app => 
                    app.survey_masters.created_by === currentUser.user_id
                );
                
                const select = document.getElementById('applicationSelect');
                
                if (userApplications.length === 0) {
                    select.innerHTML = '<option value="">No hay aplicaciones cerradas disponibles</option>';
                    showMessage('No tienes aplicaciones cerradas para analizar', 'info');
                    return;
                }
                
                // Llenar selector
                select.innerHTML = '<option value="">Selecciona una aplicación...</option>';
                userApplications.forEach(app => {
                    const option = document.createElement('option');
                    option.value = app.application_id;
                    option.textContent = `${app.survey_masters.survey_name} - ${app.application_name}`;
                    option.dataset.appData = JSON.stringify(app);
                    select.appendChild(option);
                });
                
                console.log(`✅ ${userApplications.length} aplicaciones cargadas`);
                
            } catch (error) {
                console.error('❌ Error cargando aplicaciones:', error);
                showMessage('Error al cargar aplicaciones: ' + error.message, 'danger');
            }
        }
      // ==========================================
        // CARGAR RESULTADOS DE LA APLICACIÓN
        // ==========================================
        async function loadResults() {
            try {
                mostrarLoading();
                
                const select = document.getElementById('applicationSelect');
                const selectedOption = select.options[select.selectedIndex];
                selectedApplication = JSON.parse(selectedOption.dataset.appData);
                
                console.log('📊 Cargando resultados para:', selectedApplication.application_name);
                
                // 1. Cargar estructura completa de la encuesta
                await loadSurveyStructure();
                
                // 2. Cargar todas las respuestas con perfiles
                await loadAllResponses();
                
                // 3. Analizar segmentos disponibles
                analyzeAvailableSegments();
                
                // 4. Renderizar interfaz
                renderApplicationHeader();
                renderFilters();
                renderResults();
                
                // Mostrar área de resultados
                document.getElementById('resultsArea').style.display = 'block';
                
                ocultarLoading();
                console.log('✅ Resultados cargados exitosamente');
                
            } catch (error) {
                console.error('❌ Error cargando resultados:', error);
                showMessage('Error al cargar resultados: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR ESTRUCTURA DE LA ENCUESTA
        // ==========================================
        async function loadSurveyStructure() {
            try {
                console.log('📡 Cargando estructura de la encuesta...');
                
                // Cargar maestro con secciones, preguntas y escalas
                const masterData = await supabaseRequest(
                    `/survey_masters?select=*,survey_sections(*,survey_questions(*),survey_scales(*,survey_scale_options(*)))&survey_master_id=eq.${selectedApplication.survey_master_id}`
                );
                
                if (!masterData || masterData.length === 0) {
                    throw new Error('No se encontró la estructura de la encuesta');
                }
                
                surveyData = masterData[0];
                
                // Ordenar secciones y preguntas
                surveyData.survey_sections.sort((a, b) => a.section_order - b.section_order);
                surveyData.survey_sections.forEach(section => {
                    section.survey_questions.sort((a, b) => a.question_order - b.question_order);
                    // Ordenar opciones de escala
                    if (section.survey_scales && section.survey_scales.survey_scale_options) {
                        section.survey_scales.survey_scale_options.sort((a, b) => a.option_order - b.option_order);
                    }
                });
                
                console.log('✅ Estructura cargada:', surveyData.survey_name);
                
            } catch (error) {
                console.error('❌ Error cargando estructura:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR TODAS LAS RESPUESTAS
        // ==========================================
        async function loadAllResponses() {
            try {
                console.log('📡 Cargando respuestas...');
                
                // Cargar perfiles de respondientes con sus respuestas
                const profiles = await supabaseRequest(
                    `/survey_respondent_profile?select=*,survey_responses(*)&application_id=eq.${selectedApplication.application_id}`
                );
                
                allResponses = profiles;
                filteredResponses = [...allResponses];
                
                console.log(`✅ ${allResponses.length} respuestas cargadas`);
                
            } catch (error) {
                console.error('❌ Error cargando respuestas:', error);
                throw error;
            }
        }
        
        // ==========================================
        // ANALIZAR SEGMENTOS DISPONIBLES
        // ==========================================
        function analyzeAvailableSegments() {
            console.log('🔍 Analizando segmentos disponibles...');
            
            availableSegments = {};
            
            // Campos posibles de segmentación por tipo de respondiente
            const segmentFields = {
                student: ['student_course_id', 'student_gender'],
                family: ['family_children_courses', 'family_parent_type', 'family_age_range'],
                worker: ['worker_area', 'worker_role', 'worker_age_range', 'worker_gender']
            };
            
            // Analizar qué campos tienen datos
            allResponses.forEach(profile => {
                const type = profile.respondent_type;
                const fields = segmentFields[type] || [];
                
                fields.forEach(field => {
                    // Verificar si el campo tiene valor
                    const value = profile[field];
                    if (value !== null && value !== undefined && value !== '') {
                        // Inicializar segmento si no existe
                        if (!availableSegments[field]) {
                            availableSegments[field] = {
                                label: getSegmentLabel(field),
                                values: new Set()
                            };
                        }
                        
                        // Agregar valores únicos
                        if (Array.isArray(value)) {
                            value.forEach(v => availableSegments[field].values.add(v));
                        } else {
                            availableSegments[field].values.add(value);
                        }
                    }
                });
            });
            
            // Convertir Sets a Arrays
            Object.keys(availableSegments).forEach(field => {
                availableSegments[field].values = Array.from(availableSegments[field].values).sort();
            });
            
            console.log('✅ Segmentos encontrados:', Object.keys(availableSegments));
        }
        
        // ==========================================
        // OBTENER ETIQUETA LEGIBLE DE SEGMENTO
        // ==========================================
        function getSegmentLabel(field) {
            const labels = {
                'student_course_id': 'Curso',
                'student_gender': 'Género del Estudiante',
                'family_children_courses': 'Cursos de los Hijos',
                'family_parent_type': 'Tipo de Padre/Madre',
                'family_age_range': 'Rango de Edad (Familia)',
                'worker_area': 'Área Organizacional',
                'worker_role': 'Rol/Cargo',
                'worker_age_range': 'Rango de Edad (Trabajador)',
                'worker_gender': 'Género (Trabajador)'
            };
            
            return labels[field] || field;
        }
        
        // ==========================================
        // RENDERIZAR HEADER DE APLICACIÓN
        // ==========================================
        function renderApplicationHeader() {
            document.getElementById('surveyTitle').textContent = surveyData.survey_name;
            document.getElementById('applicationName').textContent = selectedApplication.application_name;
            
            const startDate = formatDate(selectedApplication.start_date);
            const endDate = formatDate(selectedApplication.end_date);
            document.getElementById('dateRange').textContent = `Período: ${startDate} - ${endDate}`;
            
            document.getElementById('totalResponses').textContent = allResponses.length;
        }
        
        // ==========================================
        // RENDERIZAR FILTROS DINÁMICOS
        // ==========================================
        function renderFilters() {
            const filtersContainer = document.getElementById('filtersContainer');
            const filterSection = document.getElementById('filterSection');
            
            // Si no hay segmentos, ocultar sección
            if (Object.keys(availableSegments).length === 0) {
                filterSection.style.display = 'none';
                return;
            }
            
            filterSection.style.display = 'block';
            filtersContainer.innerHTML = '';
            
            // Crear un select por cada segmento disponible
            Object.entries(availableSegments).forEach(([field, data]) => {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-3';
                
                const label = document.createElement('label');
                label.className = 'form-label fw-bold';
                label.textContent = data.label;
                
                const select = document.createElement('select');
                select.className = 'form-select';
                select.id = `filter_${field}`;
                select.dataset.field = field;
                
                // Opción "Todos"
                const allOption = document.createElement('option');
                allOption.value = '';
                allOption.textContent = 'Todos';
                select.appendChild(allOption);
                
                // Opciones de valores únicos
                data.values.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });
                
                col.appendChild(label);
                col.appendChild(select);
                filtersContainer.appendChild(col);
            });
        }
      // ==========================================
        // APLICAR FILTROS
        // ==========================================
        function applyFilters() {
            try {
                console.log('🔍 Aplicando filtros...');
                
                // Recopilar filtros activos
                activeFilters = {};
                
                Object.keys(availableSegments).forEach(field => {
                    const select = document.getElementById(`filter_${field}`);
                    if (select && select.value) {
                        activeFilters[field] = select.value;
                    }
                });
                
                // Filtrar respuestas
                if (Object.keys(activeFilters).length === 0) {
                    filteredResponses = [...allResponses];
                } else {
                    filteredResponses = allResponses.filter(profile => {
                        return Object.entries(activeFilters).every(([field, value]) => {
                            const profileValue = profile[field];
                            
                            // Manejar arrays (como family_children_courses)
                            if (Array.isArray(profileValue)) {
                                return profileValue.includes(value);
                            }
                            
                            return profileValue === value;
                        });
                    });
                }
                
                console.log(`✅ ${filteredResponses.length} respuestas después de filtrar`);
                
                // Re-renderizar resultados con datos filtrados
                renderResults();
                
                showMessage(`Filtros aplicados: ${filteredResponses.length} respuestas`, 'success');
                
            } catch (error) {
                console.error('❌ Error aplicando filtros:', error);
                showMessage('Error al aplicar filtros: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // LIMPIAR FILTROS
        // ==========================================
        function clearFilters() {
            // Resetear todos los selects de filtros
            Object.keys(availableSegments).forEach(field => {
                const select = document.getElementById(`filter_${field}`);
                if (select) {
                    select.value = '';
                }
            });
            
            activeFilters = {};
            filteredResponses = [...allResponses];
            
            renderResults();
            showMessage('Filtros eliminados', 'info');
        }
        
        // ==========================================
        // RENDERIZAR RESULTADOS
        // ==========================================
        function renderResults() {
            // Actualizar estadísticas
            updateStats();
            
            // Renderizar secciones y preguntas
            const sectionsContainer = document.getElementById('sectionsContainer');
            sectionsContainer.innerHTML = '';
            
            if (filteredResponses.length === 0) {
                sectionsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-3">No hay respuestas que coincidan con los filtros seleccionados</p>
                    </div>
                `;
                return;
            }
            
            // Renderizar cada sección
            surveyData.survey_sections.forEach(section => {
                renderSection(section, sectionsContainer);
            });
        }
        
        // ==========================================
        // ACTUALIZAR ESTADÍSTICAS
        // ==========================================
        function updateStats() {
            document.getElementById('filteredResponsesCount').textContent = filteredResponses.length;
            
            // Contar tipos de preguntas
            let totalQuestions = 0;
            let scaleQuestions = 0;
            let openQuestions = 0;
            
            surveyData.survey_sections.forEach(section => {
                section.survey_questions.forEach(question => {
                    totalQuestions++;
                    if (question.question_type === 'scale') {
                        scaleQuestions++;
                    } else if (question.question_type === 'open_text') {
                        openQuestions++;
                    }
                });
            });
            
            document.getElementById('totalQuestionsCount').textContent = totalQuestions;
            document.getElementById('scaleQuestionsCount').textContent = scaleQuestions;
            document.getElementById('openQuestionsCount').textContent = openQuestions;
        }
        
        // ==========================================
        // RENDERIZAR SECCIÓN
        // ==========================================
        function renderSection(section, container) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'mb-5';
            
            // Header de sección
            const sectionHeader = document.createElement('div');
            sectionHeader.className = 'section-header';
            sectionHeader.innerHTML = `
                <h4 class="mb-1">${escapeHtml(section.section_title)}</h4>
                ${section.section_description ? `<p class="mb-0 small">${escapeHtml(section.section_description)}</p>` : ''}
            `;
            sectionDiv.appendChild(sectionHeader);
            
            // Renderizar cada pregunta de la sección
            section.survey_questions.forEach(question => {
                renderQuestion(question, section, sectionDiv);
            });
            
            container.appendChild(sectionDiv);
        }
        
        // ==========================================
        // RENDERIZAR PREGUNTA
        // ==========================================
        function renderQuestion(question, section, container) {
            const questionCard = document.createElement('div');
            questionCard.className = 'question-card card';
            
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            
            // Título de pregunta
            const questionTitle = document.createElement('div');
            questionTitle.className = 'question-title';
            questionTitle.textContent = question.question_text;
            cardBody.appendChild(questionTitle);
            
            // Renderizar según tipo de pregunta
            if (question.question_type === 'scale') {
                renderScaleQuestion(question, section, cardBody);
            } else if (question.question_type === 'open_text') {
                renderOpenQuestion(question, cardBody);
            }
            
            questionCard.appendChild(cardBody);
            container.appendChild(questionCard);
        }
        
        // ==========================================
        // RENDERIZAR PREGUNTA TIPO ESCALA
        // ==========================================
        function renderScaleQuestion(question, section, container) {
            // Obtener todas las respuestas a esta pregunta de los perfiles filtrados
            const responses = [];
            filteredResponses.forEach(profile => {
                const response = profile.survey_responses.find(r => r.question_id === question.question_id);
                if (response && response.response_value !== null) {
                    responses.push(response.response_value);
                }
            });
            
            if (responses.length === 0) {
                container.innerHTML += '<p class="text-muted">No hay respuestas para esta pregunta</p>';
                return;
            }
            
            // Calcular distribución
            const distribution = {};
            const scaleOptions = section.survey_scales.survey_scale_options;
            
            scaleOptions.forEach(option => {
                distribution[option.option_value] = {
                    text: option.option_text,
                    count: 0
                };
            });
            
            responses.forEach(value => {
                if (distribution[value]) {
                    distribution[value].count++;
                }
            });
            
            // Total de respuestas
            const totalResponses = responses.length;
            
            // Renderizar barras de distribución
            const distributionDiv = document.createElement('div');
            distributionDiv.className = 'mt-3';
            
            // Ordenar por option_value descendente (mayor a menor)
            const sortedOptions = scaleOptions.sort((a, b) => b.option_value - a.option_value);
            
            sortedOptions.forEach(option => {
                const data = distribution[option.option_value];
                const percentage = totalResponses > 0 ? (data.count / totalResponses * 100).toFixed(1) : 0;
                
                const optionDiv = document.createElement('div');
                optionDiv.className = 'scale-option';
                optionDiv.innerHTML = `
                    <div class="scale-label">${escapeHtml(data.text)}</div>
                    <div class="scale-bar">
                        <div class="scale-fill" style="width: ${percentage}%">
                            ${percentage}%
                        </div>
                    </div>
                    <div class="scale-count">${data.count} resp.</div>
                `;
                distributionDiv.appendChild(optionDiv);
            });
            
            container.appendChild(distributionDiv);
            
            // Información adicional
            const infoDiv = document.createElement('div');
            infoDiv.className = 'mt-3 text-muted small';
            infoDiv.textContent = `Total de respuestas: ${totalResponses}`;
            container.appendChild(infoDiv);
        }
        
        // ==========================================
        // RENDERIZAR PREGUNTA ABIERTA
        // ==========================================
        function renderOpenQuestion(question, container) {
            // Obtener todas las respuestas de texto
            const responses = [];
            filteredResponses.forEach(profile => {
                const response = profile.survey_responses.find(r => r.question_id === question.question_id);
                if (response && response.response_text && response.response_text.trim()) {
                    responses.push({
                        text: response.response_text,
                        date: response.responded_at
                    });
                }
            });
            
            if (responses.length === 0) {
                container.innerHTML += '<p class="text-muted">No hay respuestas para esta pregunta</p>';
                return;
            }
            
            // Título de respuestas
            const responsesTitle = document.createElement('div');
            responsesTitle.className = 'mt-3 mb-2 fw-bold';
            responsesTitle.textContent = `${responses.length} respuestas recibidas:`;
            container.appendChild(responsesTitle);
            
            // Contenedor de respuestas
            const responsesContainer = document.createElement('div');
            responsesContainer.className = 'mt-2';
            
            // Renderizar cada respuesta
            responses.forEach((response, index) => {
                const responseDiv = document.createElement('div');
                responseDiv.className = 'open-response';
                responseDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <small class="text-muted">Respuesta #${index + 1}</small>
                        <small class="text-muted">${formatDate(response.date)}</small>
                    </div>
                    <div>${escapeHtml(response.text)}</div>
                `;
                responsesContainer.appendChild(responseDiv);
            });
            
            container.appendChild(responsesContainer);
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        console.log('✅ Módulo de resultados cargado');
    </script>
</body>
</html>
