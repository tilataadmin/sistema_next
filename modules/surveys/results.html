<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados de Encuesta - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Estilos del m√≥dulo de resultados */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 2px 12px rgba(0,0,0,0.08);
            --card-shadow-hover: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .results-header {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .filter-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 2px solid #e9ecef;
        }
        
        .filter-active {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .section-card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }
        
        .section-header {
            background: var(--primary-gradient);
            color: white;
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
        }
        
        .section-summary {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        
        .question-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: white;
        }
        
        .question-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .question-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .badge-best {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-worst {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Distribuci√≥n de respuestas - Vista Global */
        .distribution-bar {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .bar-label {
            min-width: 180px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .bar-container {
            flex-grow: 1;
            height: 32px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .bar-fill {
            height: 100%;
            background: var(--primary-gradient);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .bar-count {
            margin-left: 1rem;
            font-weight: 600;
            color: #495057;
            min-width: 80px;
            font-size: 0.875rem;
        }
        
        /* Vista segmentada - Comparaci√≥n */
        .segment-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .segment-item {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            background: white;
        }
        
        .segment-name {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .segment-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .segment-average {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .segment-count {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .segment-distribution {
            margin-top: 0.75rem;
            font-size: 0.75rem;
        }
        
        .segment-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 0.25rem 0;
        }
        
        .segment-bar-fill {
            height: 100%;
            background: var(--primary-gradient);
        }
        
        /* Tabla de respuestas abiertas */
        .open-responses-table {
            width: 100%;
            margin-top: 1rem;
        }
        
        .open-responses-table th {
            background: #f8f9fa;
            padding: 0.75rem;
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 2px solid #dee2e6;
        }
        
        .open-responses-table td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }
        
        .response-number {
            font-weight: 600;
            color: #667eea;
            min-width: 80px;
        }
        
        .response-text {
            line-height: 1.6;
        }
        
        .response-date {
            color: #6c757d;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        /* ==========================================
           NUEVOS ESTILOS PARA RESUMEN DE SECCIONES
           ========================================== */
        
        /* Contenedor de tarjetas de secciones */
        .sections-summary {
            margin-bottom: 2rem;
        }
        
        .sections-summary-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
            margin-bottom: 1rem;
        }
        
        .sections-summary-header h4 {
            margin: 0;
            font-size: 1.25rem;
        }
        
        .sections-summary-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 0.875rem;
        }
        
        /* Tarjeta individual de secci√≥n colapsable */
        .section-summary-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 1rem;
            background: white;
            transition: all 0.2s ease;
            overflow: hidden;
        }
        
        .section-summary-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .section-summary-card.expanded {
            border-color: #667eea;
        }
        
        /* Header de tarjeta (siempre visible) */
        .section-summary-header-card {
            padding: 1.25rem;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .section-summary-header-card:hover {
            background: #f8f9fa;
        }
        
        .section-summary-header-card.expanded {
            background: #f0f4ff;
            border-bottom: 2px solid #e9ecef;
        }
        
        /* Icono de expansi√≥n */
        .section-expand-icon {
            font-size: 1.25rem;
            color: #667eea;
            transition: transform 0.3s ease;
        }
        
        .section-expand-icon.expanded {
            transform: rotate(90deg);
        }
        
        /* Contenido principal del header */
        .section-summary-content {
            flex: 1;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
        }
        
        .section-title-area h5 {
            margin: 0;
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .section-title-area p {
            margin: 0.25rem 0 0 0;
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        /* M√©tricas de secci√≥n */
        .section-metric {
            text-align: center;
        }
        
        .section-metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #667eea;
            line-height: 1;
        }
        
        .section-metric-label {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        /* Badge de desempe√±o */
        .section-performance-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        .section-performance-badge.excellent {
            background: #d4edda;
            color: #155724;
        }
        
        .section-performance-badge.good {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .section-performance-badge.average {
            background: #fff3cd;
            color: #856404;
        }
        
        .section-performance-badge.needs-attention {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Contenido expandible de la secci√≥n */
        .section-detail-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .section-detail-content.expanded {
            max-height: 10000px;
            transition: max-height 0.5s ease-in;
        }
        
        .section-detail-inner {
            padding: 1.5rem;
            background: #fafbfc;
        }
        
        /* Filtro de secciones */
        .sections-filter {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .sections-filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .sections-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.75rem;
        }
        
        .section-checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .section-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .section-checkbox-item label {
            cursor: pointer;
            margin: 0;
            font-size: 0.95rem;
        }

        /* ==========================================
           ESTILOS PARA AN√ÅLISIS DE PALABRAS CLAVE
           ========================================== */
        
        /* Panel de an√°lisis */
        .card-header[onclick] {
            transition: background-color 0.2s ease;
        }
        
        .card-header[onclick]:hover {
            background-color: rgba(13, 202, 240, 0.15) !important;
        }
        
        /* Badges de palabras clave */
        .keyword-badge {
            transition: all 0.2s ease;
            margin: 0.25rem;
        }
        
        .keyword-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .keyword-badge.fs-6 {
            font-size: 1rem !important;
            font-weight: 600;
        }
        
        .keyword-badge.fs-7 {
            font-size: 0.9rem !important;
        }
        
        .keyword-badge.fs-8 {
            font-size: 0.8rem !important;
        }
        
        /* Campo de b√∫squeda mejorado */
        #filtersContainer input[type="text"][id^="search_"] {
            border: 2px solid #e9ecef;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        #filtersContainer input[type="text"][id^="search_"]:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        /* Resaltado de palabras */
        mark {
            background-color: #fff3cd !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            font-weight: 500;
        }
        
        /* Indicador de filtro activo */
        #resultsContainer [id^="filter_indicator_"] {
            border-left: 4px solid #ffc107;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Filas de respuestas con hover mejorado */
        .response-row {
            transition: background-color 0.2s ease;
        }
        
        .response-row:hover {
            background-color: #f8f9fa;
        }
        
        /* Tabla de respuestas abiertas - mejoras */
        .open-responses-table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .open-responses-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Badges de sentimiento */
        .sentiment-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .sentiment-positive {
            background: #d4edda;
            color: #155724;
        }
        
        .sentiment-neutral {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .sentiment-negative {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Animaci√≥n para el chevron del panel */
        [id^="chevron_"] {
            transition: transform 0.3s ease;
        }
        
        /* Contador de respuestas destacado */
        [id^="response_count_"] {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1rem;
        }
        
        /* Estilos para collapse del an√°lisis */
        .collapse {
            transition: height 0.3s ease;
        }
        
        .collapse:not(.show) {
            display: none;
        }
        
        .collapse.show {
            display: block;
        }
        
        /* Mensaje de "no resultados" en b√∫squeda */
        .open-responses-table tbody td[colspan] {
            background: #f8f9fa;
        }
        
        /* Bot√≥n de exportar mejorado */
        button[onclick^="exportResponses"] {
            transition: all 0.2s ease;
        }
        
        button[onclick^="exportResponses"]:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* Responsive - ajustes para m√≥viles */
        @media (max-width: 768px) {
            .keyword-badge {
                font-size: 0.75rem !important;
                padding: 0.25rem 0.5rem;
            }
            
            .keyword-badge .badge {
                font-size: 0.65rem;
                padding: 0.1rem 0.3rem;
            }
            
            #filtersContainer [id^="search_"] {
                font-size: 0.9rem;
            }
            
            .open-responses-table {
                font-size: 0.875rem;
            }
            
            .response-text {
                max-width: 300px;
                word-wrap: break-word;
            }
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-results {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .summary-metric {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .summary-metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        .metric-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .section-summary-content {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .section-metric {
                text-align: left;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .section-metric-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando resultados...</p>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Encuestas</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Resultados
                </li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-bar-chart-line me-2"></i>
                    An√°lisis de Resultados
                </h1>
                <p class="text-muted">Vista detallada con segmentaci√≥n din√°mica y an√°lisis por secciones</p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Selector de aplicaci√≥n -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <label for="applicationSelect" class="form-label fw-bold">
                            <i class="bi bi-clipboard-data me-2"></i>
                            Selecciona una aplicaci√≥n cerrada
                        </label>
                        <select class="form-select form-select-lg" id="applicationSelect">
                            <option value="">Cargando aplicaciones...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary btn-lg w-100" id="loadResultsBtn" disabled>
                            <i class="bi bi-search me-2"></i>Cargar Resultados
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- √Årea de resultados -->
        <div id="resultsArea" style="display: none;">

            <!-- Header de la aplicaci√≥n seleccionada -->
            <div class="results-header" id="applicationHeader">
                <div class="row">
                    <div class="col-md-8">
                        <h2 class="h4 mb-2" id="surveyTitle">Nombre de la Encuesta</h2>
                        <p class="mb-1 opacity-75" id="applicationName">Aplicaci√≥n X</p>
                        <small class="opacity-75" id="dateRange">Per√≠odo: DD/MM/YYYY - DD/MM/YYYY</small>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="stat-value text-white" id="totalResponses">0</div>
                        <div class="text-white-50">respuestas totales</div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n de filtros -->
            <div class="filter-section" id="filterSection" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="mb-1">
                            <i class="bi bi-funnel me-2"></i>Filtrar Resultados por Segmentos
                        </h5>
                        <small class="text-muted">
                            Selecciona uno o m√°s filtros para comparar segmentos espec√≠ficos
                        </small>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm" id="clearFiltersBtn">
                        <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                    </button>
                </div>
                
                <!-- Contenedor de filtros din√°micos -->
                <div class="row" id="filtersContainer">
                    <!-- Los filtros se generan din√°micamente -->
                </div>
                
                <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-primary" id="applyFiltersBtn">
                        <i class="bi bi-check-circle me-1"></i>Aplicar Filtros
                    </button>
                    <button class="btn btn-outline-info" id="compareSegmentsBtn" style="display: none;">
                        <i class="bi bi-arrows-angle-expand me-1"></i>Vista Comparativa
                    </button>
                </div>
                
                <!-- Indicador de filtros activos -->
                <div id="activeFiltersIndicator" class="mt-3" style="display: none;">
                    <div class="alert alert-info mb-0">
                        <strong>
                            <i class="bi bi-info-circle me-2"></i>Filtros activos:
                        </strong>
                        <span id="activeFiltersList"></span>
                    </div>
                </div>
            </div>

            <!-- NUEVO: Filtro de secciones -->
            <div class="sections-filter" id="sectionsFilter" style="display: none;">
                <div class="sections-filter-header">
                    <div>
                        <h5 class="mb-1">
                            <i class="bi bi-list-check me-2"></i>Filtrar por Secciones
                        </h5>
                        <small class="text-muted">
                            Selecciona las secciones que deseas visualizar
                        </small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary" id="selectAllSectionsBtn">
                            <i class="bi bi-check-square me-1"></i>Todas
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="deselectAllSectionsBtn">
                            <i class="bi bi-square me-1"></i>Ninguna
                        </button>
                    </div>
                </div>
                
                <div class="sections-checkboxes" id="sectionsCheckboxes">
                    <!-- Los checkboxes se generan din√°micamente -->
                </div>
            </div>

            <!-- Estad√≠sticas generales -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <div class="stat-value" id="filteredResponsesCount">0</div>
                            <div class="stat-label">Personas que respondieron</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <div class="stat-value" id="sectionsCount">0</div>
                            <div class="stat-label">Secciones</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <div class="stat-value" id="scaleQuestionsCount">0</div>
                            <div class="stat-label">Preguntas tipo escala</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <div class="stat-value" id="openQuestionsCount">0</div>
                            <div class="stat-label">Preguntas abiertas</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bot√≥n de exportaci√≥n consolidada -->
            <div class="row mb-4">
                <div class="col-12 text-end">
                    <button class="btn btn-success" 
                            id="exportAllOpenBtn" 
                            onclick="exportAllOpenResponses()"
                            style="display: none;">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                        Exportar An√°lisis Consolidado de Todas las Preguntas Abiertas
                    </button>
                </div>
            </div>

            <!-- Modo de visualizaci√≥n -->
            <div id="viewModeSelector" class="mb-3" style="display: none;">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="viewMode" id="viewGlobal" value="global" checked>
                    <label class="btn btn-outline-primary" for="viewGlobal">
                        <i class="bi bi-bar-chart me-1"></i>Vista Global
                    </label>
                    
                    <input type="radio" class="btn-check" name="viewMode" id="viewSegmented" value="segmented">
                    <label class="btn btn-outline-primary" for="viewSegmented">
                        <i class="bi bi-diagram-3 me-1"></i>Vista Segmentada
                    </label>
                </div>
                <small class="text-muted ms-3">
                    Vista Global: Todas las respuestas juntas | Vista Segmentada: Comparaci√≥n entre grupos
                </small>
            </div>

            <!-- NUEVO: Resumen de Secciones -->
            <div class="sections-summary" id="sectionsSummary" style="display: none;">
                <div class="sections-summary-header">
                    <h4>
                        <i class="bi bi-bar-chart-steps me-2"></i>
                        Resumen por Secciones
                    </h4>
                    <p class="mb-0">Haz clic en una secci√≥n para ver el detalle de sus preguntas</p>
                </div>
                
                <div id="sectionsSummaryCards">
                    <!-- Las tarjetas de secci√≥n se generan din√°micamente -->
                </div>
            </div>

            <!-- Contenedor principal de resultados detallados -->
            <div id="resultsContainer">
                <!-- Las secciones detalladas se renderizar√°n aqu√≠ -->
            </div>

        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let selectedApplication = null;
        let surveyMaster = null;
        let allProfiles = [];
        let filteredProfiles = [];
        let availableSegments = {};
        let activeFilters = {};
        let currentViewMode = 'global'; // 'global' o 'segmented'
        let selectedSections = new Set(); // Secciones seleccionadas para mostrar
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Crear encuestas');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido');
                
                const session = getStoredSession();
                if (session && session.user) {
                    currentUser = session.user;
                    console.log('‚úÖ Usuario:', currentUser.user_display_name);
                }
                
                await loadClosedApplications();
                setupEventListeners();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        });
        
        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        function setupEventListeners() {
            document.getElementById('applicationSelect').addEventListener('change', function() {
                document.getElementById('loadResultsBtn').disabled = !this.value;
            });
            
            document.getElementById('loadResultsBtn').addEventListener('click', loadResults);
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            
            // Cambio de modo de vista
            document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentViewMode = this.value;
                    renderResults();
                });
            });
            
            // NUEVO: Botones de selecci√≥n de secciones
            document.getElementById('selectAllSectionsBtn').addEventListener('click', selectAllSections);
            document.getElementById('deselectAllSectionsBtn').addEventListener('click', deselectAllSections);
        }
        
        // ==========================================
        // CARGAR APLICACIONES CERRADAS
        // ==========================================
        async function loadClosedApplications() {
            try {
                console.log('üì° Cargando aplicaciones cerradas...');
                
                // CAMBIO: Ya no filtramos por created_by
                // Cualquier usuario con permiso "Crear encuestas" puede ver TODAS las aplicaciones cerradas
                const applications = await supabaseRequest(
                    '/survey_applications?select=*,survey_masters(survey_name,created_by,users!survey_masters_created_by_fkey(user_display_name))&status=eq.closed&order=created_at.desc'
                );
                
                const select = document.getElementById('applicationSelect');
                
                if (applications.length === 0) {
                    select.innerHTML = '<option value="">No hay aplicaciones cerradas disponibles</option>';
                    showMessage('No hay aplicaciones cerradas para analizar', 'info');
                    return;
                }
                
                select.innerHTML = '<option value="">Selecciona una aplicaci√≥n...</option>';
                applications.forEach(app => {
                    const option = document.createElement('option');
                    option.value = app.application_id;
                    
                    // Mostrar el nombre del creador si est√° disponible
                    const creatorName = app.survey_masters?.users?.user_display_name || 'Desconocido';
                    option.textContent = `${app.survey_masters.survey_name} - ${app.application_name} (Creador: ${creatorName})`;
                    
                    option.dataset.appData = JSON.stringify(app);
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ ${applications.length} aplicaciones cargadas (todas disponibles)`);
                
            } catch (error) {
                console.error('‚ùå Error cargando aplicaciones:', error);
                showMessage('Error al cargar aplicaciones: ' + error.message, 'danger');
            }
        }

        
        
        // ==========================================
        // CARGAR RESULTADOS
        // ==========================================
        async function loadResults() {
            try {
                mostrarLoading();
                
                const select = document.getElementById('applicationSelect');
                const selectedOption = select.options[select.selectedIndex];
                selectedApplication = JSON.parse(selectedOption.dataset.appData);
                
                console.log('üìä Cargando resultados para:', selectedApplication.application_name);
                
                // Limpiar estado previo
                activeFilters = {};
                currentViewMode = 'global';
                selectedSections = new Set();
                document.getElementById('viewGlobal').checked = true;
                
                // 1. Cargar estructura de la encuesta
                await loadSurveyStructure();
                
                // 2. Cargar todos los perfiles con respuestas
                await loadAllProfiles();
                
                // 3. Analizar segmentos disponibles
                analyzeAvailableSegments();
                
                // 4. NUEVO: Inicializar secciones seleccionadas (todas por defecto)
                initializeSelectedSections();
                
                // 5. Renderizar interfaz
                renderApplicationHeader();
                renderFilters();
                renderSectionsFilter(); // NUEVO
                renderStats();
                renderSectionsSummary(); // NUEVO
                renderResults();
                
                // Mostrar √°rea de resultados
                document.getElementById('resultsArea').style.display = 'block';
                
                // Scroll suave al inicio de resultados
                document.getElementById('resultsArea').scrollIntoView({ behavior: 'smooth' });
                
                ocultarLoading();
                console.log('‚úÖ Resultados cargados exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error cargando resultados:', error);
                showMessage('Error al cargar resultados: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        // ==========================================
        // CARGAR ESTRUCTURA DE LA ENCUESTA
        // ==========================================
        async function loadSurveyStructure() {
            try {
                console.log('üì° Cargando estructura de la encuesta...');
                
                const masterData = await supabaseRequest(
                    `/survey_masters?select=*,survey_sections(*,survey_questions(*),survey_scales(*,survey_scale_options(*))),survey_master_segments(*,segments(segment_name,segment_options(*)))&survey_master_id=eq.${selectedApplication.survey_master_id}`
                );
                
                if (!masterData || masterData.length === 0) {
                    throw new Error('No se encontr√≥ la estructura de la encuesta');
                }
                
                surveyMaster = masterData[0];
                
                // Ordenar secciones
                surveyMaster.survey_sections.sort((a, b) => a.section_order - b.section_order);
                
                // Ordenar preguntas y opciones de escala
                surveyMaster.survey_sections.forEach(section => {
                    section.survey_questions.sort((a, b) => a.question_order - b.question_order);
                    
                    if (section.survey_scales && section.survey_scales.survey_scale_options) {
                        section.survey_scales.survey_scale_options.sort((a, b) => b.option_value - a.option_value);
                    }
                });
                
                console.log('‚úÖ Estructura cargada:', surveyMaster.survey_name);
                console.log('‚úÖ Secciones:', surveyMaster.survey_sections.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando estructura:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR PERFILES Y RESPUESTAS
        // ==========================================
        async function loadAllProfiles() {
            try {
                console.log('üì° Cargando perfiles y respuestas...');
                
                const profiles = await supabaseRequest(
                    `/survey_respondent_profile?select=*,survey_responses(*),courses(course_name)&application_id=eq.${selectedApplication.application_id}`
                );
                
                allProfiles = profiles.map(profile => {
                    if (profile.courses && profile.courses.course_name) {
                        profile.student_course_name = profile.courses.course_name;
                    }
                    return profile;
                });
                
                filteredProfiles = [...allProfiles];
                
                console.log(`‚úÖ ${allProfiles.length} perfiles cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando perfiles:', error);
                throw error;
            }
        }

        // ==========================================
        // ANALIZAR SEGMENTOS DISPONIBLES
        // ==========================================
        function analyzeAvailableSegments() {
            console.log('üîç Analizando segmentos configurados...');
            
            availableSegments = {};
            
            const configuredSegments = surveyMaster.survey_master_segments || [];
            
            if (configuredSegments.length === 0) {
                console.log('‚ÑπÔ∏è Esta encuesta no tiene segmentos configurados');
                return;
            }
            
            configuredSegments.forEach(segmentAssignment => {
                const segment = segmentAssignment.segments;
                const segmentName = segment.segment_name;
                const options = segment.segment_options || [];
                
                const sortedOptions = options.sort((a, b) => a.option_order - b.option_order);
                
                availableSegments[segmentName] = {
                    label: segmentName,
                    options: sortedOptions
                };
            });
            
            console.log('‚úÖ Segmentos analizados:', availableSegments);
        }
        
        // ==========================================
        // NUEVO: INICIALIZAR SECCIONES SELECCIONADAS
        // ==========================================
        function initializeSelectedSections() {
            selectedSections.clear();
            surveyMaster.survey_sections.forEach(section => {
                selectedSections.add(section.section_id);
            });
            console.log('‚úÖ Todas las secciones seleccionadas por defecto');
        }
        
        // ==========================================
        // NUEVO: SELECCIONAR TODAS LAS SECCIONES
        // ==========================================
        function selectAllSections() {
            selectedSections.clear();
            surveyMaster.survey_sections.forEach(section => {
                selectedSections.add(section.section_id);
            });
            
            // Actualizar checkboxes
            document.querySelectorAll('#sectionsCheckboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            
            renderSectionsSummary();
            renderResults();
            showMessage('Todas las secciones seleccionadas', 'info');
        }
        
        // ==========================================
        // NUEVO: DESELECCIONAR TODAS LAS SECCIONES
        // ==========================================
        function deselectAllSections() {
            selectedSections.clear();
            
            // Actualizar checkboxes
            document.querySelectorAll('#sectionsCheckboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            renderSectionsSummary();
            renderResults();
            showMessage('Todas las secciones deseleccionadas', 'info');
        }
        // ==========================================
        // NUEVO: RENDERIZAR FILTRO DE SECCIONES
        // ==========================================
        function renderSectionsFilter() {
            const filterContainer = document.getElementById('sectionsFilter');
            const checkboxesContainer = document.getElementById('sectionsCheckboxes');
            
            if (surveyMaster.survey_sections.length === 0) {
                filterContainer.style.display = 'none';
                return;
            }
            
            filterContainer.style.display = 'block';
            checkboxesContainer.innerHTML = '';
            
            surveyMaster.survey_sections.forEach(section => {
                const item = document.createElement('div');
                item.className = 'section-checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `section_${section.section_id}`;
                checkbox.value = section.section_id;
                checkbox.checked = true;
                checkbox.addEventListener('change', handleSectionCheckboxChange);
                
                const label = document.createElement('label');
                label.htmlFor = `section_${section.section_id}`;
                label.textContent = section.section_title;
                
                item.appendChild(checkbox);
                item.appendChild(label);
                checkboxesContainer.appendChild(item);
            });
        }
        
        // ==========================================
        // NUEVO: MANEJAR CAMBIO EN CHECKBOX DE SECCI√ìN
        // ==========================================
        function handleSectionCheckboxChange(e) {
            const sectionId = e.target.value;
            
            if (e.target.checked) {
                selectedSections.add(sectionId);
            } else {
                selectedSections.delete(sectionId);
            }
            
            renderSectionsSummary();
            renderResults();
        }
        
        // ==========================================
        // APLICAR FILTROS
        // ==========================================
        function applyFilters() {
            try {
                console.log('üîç Aplicando filtros...');
                
                activeFilters = {};
                
                Object.keys(availableSegments).forEach(segmentName => {
                    const select = document.getElementById(`filter_${segmentName}`);
                    if (select && select.value) {
                        activeFilters[segmentName] = select.value;
                    }
                });
                
                if (Object.keys(activeFilters).length === 0) {
                    filteredProfiles = [...allProfiles];
                } else {
                    filteredProfiles = allProfiles.filter(profile => {
                        return Object.entries(activeFilters).every(([segmentName, value]) => {
                            if (profile.segment_data && profile.segment_data[segmentName]) {
                                return profile.segment_data[segmentName] === value;
                            }
                            return false;
                        });
                    });
                }
                
                console.log(`‚úÖ ${filteredProfiles.length} respuestas despu√©s de filtrar`);
                
                updateActiveFiltersIndicator();
                renderStats();
                renderSectionsSummary();
                renderResults();
                
                const hasFilters = Object.keys(activeFilters).length > 0;
                document.getElementById('viewModeSelector').style.display = hasFilters ? 'block' : 'none';
                
                if (hasFilters) {
                    showMessage(`Filtros aplicados: ${filteredProfiles.length} respuestas`, 'success');
                } else {
                    showMessage('Mostrando todas las respuestas', 'info');
                }
                
            } catch (error) {
                console.error('‚ùå Error aplicando filtros:', error);
                showMessage('Error al aplicar filtros: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // LIMPIAR FILTROS
        // ==========================================
        function clearFilters() {
            Object.keys(availableSegments).forEach(field => {
                const select = document.getElementById(`filter_${field}`);
                if (select) select.value = '';
            });
            
            activeFilters = {};
            filteredProfiles = [...allProfiles];
            currentViewMode = 'global';
            document.getElementById('viewGlobal').checked = true;
            
            updateActiveFiltersIndicator();
            renderStats();
            renderSectionsSummary();
            renderResults();
            
            document.getElementById('viewModeSelector').style.display = 'none';
            
            showMessage('Filtros eliminados', 'info');
        }
        
        // ==========================================
        // ACTUALIZAR INDICADOR DE FILTROS ACTIVOS
        // ==========================================
        function updateActiveFiltersIndicator() {
            const indicator = document.getElementById('activeFiltersIndicator');
            const filtersList = document.getElementById('activeFiltersList');
            
            if (Object.keys(activeFilters).length === 0) {
                indicator.style.display = 'none';
                document.getElementById('filterSection').classList.remove('filter-active');
                return;
            }
            
            indicator.style.display = 'block';
            document.getElementById('filterSection').classList.add('filter-active');
            
            const filtersText = Object.entries(activeFilters).map(([field, value]) => {
                const label = availableSegments[field].label;
                return `${label}: <strong>${value}</strong>`;
            }).join(', ');
            
            filtersList.innerHTML = filtersText;
        }
        
        // ==========================================
        // RENDERIZAR HEADER DE APLICACI√ìN
        // ==========================================
        function renderApplicationHeader() {
            document.getElementById('surveyTitle').textContent = surveyMaster.survey_name;
            document.getElementById('applicationName').textContent = selectedApplication.application_name;
            
            const startDate = formatDate(selectedApplication.start_date);
            const endDate = formatDate(selectedApplication.end_date);
            document.getElementById('dateRange').textContent = `Per√≠odo: ${startDate} - ${endDate}`;
            
            document.getElementById('totalResponses').textContent = allProfiles.length;
        }
        
        // ==========================================
        // RENDERIZAR FILTROS DE SEGMENTOS
        // ==========================================
        function renderFilters() {
            const filtersContainer = document.getElementById('filtersContainer');
            const filterSection = document.getElementById('filterSection');
            
            if (Object.keys(availableSegments).length === 0) {
                filterSection.style.display = 'none';
                return;
            }
            
            filterSection.style.display = 'block';
            filtersContainer.innerHTML = '';
            
            Object.entries(availableSegments).forEach(([segmentName, data]) => {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-3';
                
                const label = document.createElement('label');
                label.className = 'form-label fw-bold';
                label.textContent = data.label;
                
                const select = document.createElement('select');
                select.className = 'form-select';
                select.id = `filter_${segmentName}`;
                
                const allOption = document.createElement('option');
                allOption.value = '';
                allOption.textContent = 'Todos';
                select.appendChild(allOption);
                
                data.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.option_value;
                    option.textContent = opt.option_name;
                    select.appendChild(option);
                });
                
                col.appendChild(label);
                col.appendChild(select);
                filtersContainer.appendChild(col);
            });
        }
        
        // ==========================================
        // RENDERIZAR ESTAD√çSTICAS
        // ==========================================
        // Buscar la funci√≥n renderStats() y modificar su final para agregar un bot√≥n global
        // REEMPLAZAR la funci√≥n renderStats() con esta versi√≥n mejorada:
        
        function renderStats() {
            document.getElementById('filteredResponsesCount').textContent = filteredProfiles.length;
            document.getElementById('sectionsCount').textContent = surveyMaster.survey_sections.length;
            
            let scaleCount = 0;
            let openCount = 0;
            
            surveyMaster.survey_sections.forEach(section => {
                section.survey_questions.forEach(q => {
                    if (q.question_type === 'scale') scaleCount++;
                    if (q.question_type === 'open_text') openCount++;
                });
            });
            
            document.getElementById('scaleQuestionsCount').textContent = scaleCount;
            document.getElementById('openQuestionsCount').textContent = openCount;
            
            // NUEVO: Mostrar/ocultar bot√≥n de exportaci√≥n consolidada
            const exportAllBtn = document.getElementById('exportAllOpenBtn');
            if (exportAllBtn) {
                exportAllBtn.style.display = openCount > 0 ? 'inline-block' : 'none';
            }
        }


        
        // ==========================================
        // NUEVO: CALCULAR PROMEDIO DE SECCI√ìN
        // ==========================================
        function calculateSectionAverage(section, profiles) {
            const scaleQuestions = section.survey_questions.filter(q => q.question_type === 'scale');
            
            if (scaleQuestions.length === 0) {
                return null;
            }
            
            const allValues = [];
            let totalResponses = 0;
            
            scaleQuestions.forEach(question => {
                profiles.forEach(profile => {
                    const response = profile.survey_responses.find(r => r.question_id === question.question_id);
                    if (response && response.response_value !== null) {
                        allValues.push(response.response_value);
                        totalResponses++;
                    }
                });
            });
            
            if (allValues.length === 0) {
                return null;
            }
            
            const average = allValues.reduce((a, b) => a + b, 0) / allValues.length;
            
            return {
                average: parseFloat(average.toFixed(2)),
                totalResponses: totalResponses,
                scaleQuestionsCount: scaleQuestions.length,
                averageResponsesPerQuestion: (totalResponses / scaleQuestions.length).toFixed(1)
            };
        }
        
        // ==========================================
        // NUEVO: OBTENER BADGE DE DESEMPE√ëO
        // ==========================================
        function getPerformanceBadge(average, maxValue = 5) {
            const percentage = (average / maxValue) * 100;
            
            if (percentage >= 85) {
                return { class: 'excellent', text: 'Excelente', icon: 'trophy-fill' };
            } else if (percentage >= 70) {
                return { class: 'good', text: 'Bueno', icon: 'hand-thumbs-up' };
            } else if (percentage >= 50) {
                return { class: 'average', text: 'Promedio', icon: 'dash-circle' };
            } else {
                return { class: 'needs-attention', text: 'Requiere atenci√≥n', icon: 'exclamation-triangle' };
            }
        }
        
        // ==========================================
        // NUEVO: RENDERIZAR RESUMEN DE SECCIONES
        // ==========================================
        function renderSectionsSummary() {
            const summaryContainer = document.getElementById('sectionsSummary');
            const cardsContainer = document.getElementById('sectionsSummaryCards');
            
            summaryContainer.style.display = 'block';
            cardsContainer.innerHTML = '';
            
            const sectionsToShow = surveyMaster.survey_sections.filter(section => 
                selectedSections.has(section.section_id)
            );
            
            if (sectionsToShow.length === 0) {
                cardsContainer.innerHTML = '<div class="no-results"><p>No hay secciones seleccionadas para mostrar</p></div>';
                return;
            }
            
            sectionsToShow.forEach(section => {
                const stats = calculateSectionAverage(section, filteredProfiles);
                
                if (!stats) {
                    return; // Skip si no hay preguntas tipo escala
                }
                
                const badge = getPerformanceBadge(stats.average);
                
                const card = document.createElement('div');
                card.className = 'section-summary-card';
                card.id = `summary_card_${section.section_id}`;
                
                card.innerHTML = `
                    <div class="section-summary-header-card" onclick="toggleSectionDetail('${section.section_id}')">
                        <i class="bi bi-chevron-right section-expand-icon" id="icon_${section.section_id}"></i>
                        <div class="section-summary-content">
                            <div class="section-title-area">
                                <h5>${escapeHtml(section.section_title)}</h5>
                                ${section.section_description ? `<p>${escapeHtml(section.section_description)}</p>` : ''}
                            </div>
                            <div class="section-metric">
                                <div class="section-metric-value">${stats.average}</div>
                                <div class="section-metric-label">Promedio</div>
                            </div>
                            <div class="section-metric">
                                <div class="section-metric-value">${stats.scaleQuestionsCount}</div>
                                <div class="section-metric-label">Preguntas</div>
                            </div>
                            <div class="section-metric">
                                <div class="section-metric-value">${stats.totalResponses}</div>
                                <div class="section-metric-label">Respuestas</div>
                            </div>
                            <div>
                                <span class="section-performance-badge ${badge.class}">
                                    <i class="bi bi-${badge.icon} me-1"></i>${badge.text}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="section-detail-content" id="detail_${section.section_id}">
                        <div class="section-detail-inner" id="detail_inner_${section.section_id}">
                            <!-- El contenido se cargar√° al expandir -->
                        </div>
                    </div>
                `;
                
                cardsContainer.appendChild(card);
            });
        }
        // ==========================================
        // NUEVO: ALTERNAR DETALLE DE SECCI√ìN
        // ==========================================
        function toggleSectionDetail(sectionId) {
            const card = document.getElementById(`summary_card_${sectionId}`);
            const icon = document.getElementById(`icon_${sectionId}`);
            const header = card.querySelector('.section-summary-header-card');
            const detailContent = document.getElementById(`detail_${sectionId}`);
            const detailInner = document.getElementById(`detail_inner_${sectionId}`);
            
            const isExpanded = card.classList.contains('expanded');
            
            if (isExpanded) {
                // Colapsar
                card.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.classList.remove('expanded');
                detailContent.classList.remove('expanded');
            } else {
                // Expandir
                card.classList.add('expanded');
                header.classList.add('expanded');
                icon.classList.add('expanded');
                detailContent.classList.add('expanded');
                
                // Renderizar contenido si est√° vac√≠o
                if (detailInner.children.length === 0) {
                    const section = surveyMaster.survey_sections.find(s => s.section_id === sectionId);
                    if (section) {
                        renderSectionDetail(section, detailInner);
                    }
                }
            }
        }
        
        // ==========================================
        // NUEVO: RENDERIZAR DETALLE DE SECCI√ìN
        // ==========================================
        function renderSectionDetail(section, container) {
            container.innerHTML = '';
            
            // Resumen de la secci√≥n
            const scaleQuestions = section.survey_questions.filter(q => q.question_type === 'scale');
            if (scaleQuestions.length > 0) {
                const summary = calculateSectionSummary(scaleQuestions, section);
                container.appendChild(renderSectionSummaryDetail(summary, scaleQuestions.length));
            }
            
            // Renderizar cada pregunta
            section.survey_questions.forEach(question => {
                if (currentViewMode === 'global') {
                    container.appendChild(renderQuestionGlobal(question, section));
                } else {
                    container.appendChild(renderQuestionSegmented(question, section));
                }
            });
        }
        
        // ==========================================
        // RENDERIZAR RESULTADOS (PRINCIPAL)
        // ==========================================
        function renderResults() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';
            
            if (filteredProfiles.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-3">No hay respuestas que coincidan con los filtros seleccionados</p>
                    </div>
                `;
                return;
            }
            
            // Renderizar solo secciones seleccionadas
            const sectionsToShow = surveyMaster.survey_sections.filter(section => 
                selectedSections.has(section.section_id)
            );
            
            if (sectionsToShow.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <i class="bi bi-list-check" style="font-size: 3rem;"></i>
                        <p class="mt-3">No hay secciones seleccionadas para mostrar en vista detallada</p>
                    </div>
                `;
                return;
            }
            
            sectionsToShow.forEach(section => {
                renderSection(section, container);
            });
        }
        
        // ==========================================
        // RENDERIZAR SECCI√ìN (DETALLADA)
        // ==========================================
        function renderSection(section, container) {
            const sectionCard = document.createElement('div');
            sectionCard.className = 'section-card';
            
            const header = document.createElement('div');
            header.className = 'section-header';
            header.innerHTML = `
                <h3 class="h5 mb-1">${escapeHtml(section.section_title)}</h3>
                ${section.section_description ? `<p class="mb-0 small opacity-75">${escapeHtml(section.section_description)}</p>` : ''}
            `;
            sectionCard.appendChild(header);
            
            const body = document.createElement('div');
            body.className = 'p-4';
            
            const scaleQuestions = section.survey_questions.filter(q => q.question_type === 'scale');
            if (scaleQuestions.length > 0) {
                const summary = calculateSectionSummary(scaleQuestions, section);
                body.appendChild(renderSectionSummaryDetail(summary, scaleQuestions.length));
            }
            
            section.survey_questions.forEach(question => {
                if (currentViewMode === 'global') {
                    body.appendChild(renderQuestionGlobal(question, section));
                } else {
                    body.appendChild(renderQuestionSegmented(question, section));
                }
            });
            
            sectionCard.appendChild(body);
            container.appendChild(sectionCard);
        }
        
        // ==========================================
        // CALCULAR RESUMEN DE SECCI√ìN
        // ==========================================
        function calculateSectionSummary(scaleQuestions, section) {
            const allValues = [];
            let totalResponses = 0;
            
            scaleQuestions.forEach(question => {
                filteredProfiles.forEach(profile => {
                    const response = profile.survey_responses.find(r => r.question_id === question.question_id);
                    if (response && response.response_value !== null) {
                        allValues.push(response.response_value);
                        totalResponses++;
                    }
                });
            });
            
            const average = allValues.length > 0 ? 
                (allValues.reduce((a, b) => a + b, 0) / allValues.length).toFixed(2) : 0;
            
            let bestQuestion = null;
            let worstQuestion = null;
            let bestAvg = -1;
            let worstAvg = 999;
            
            scaleQuestions.forEach(question => {
                const questionValues = [];
                filteredProfiles.forEach(profile => {
                    const response = profile.survey_responses.find(r => r.question_id === question.question_id);
                    if (response && response.response_value !== null) {
                        questionValues.push(response.response_value);
                    }
                });
                
                if (questionValues.length > 0) {
                    const avg = questionValues.reduce((a, b) => a + b, 0) / questionValues.length;
                    
                    if (avg > bestAvg) {
                        bestAvg = avg;
                        bestQuestion = question;
                    }
                    
                    if (avg < worstAvg) {
                        worstAvg = avg;
                        worstQuestion = question;
                    }
                }
            });
            
            return {
                totalQuestions: scaleQuestions.length,
                totalResponses: totalResponses,
                averageResponses: totalResponses > 0 ? (totalResponses / scaleQuestions.length).toFixed(1) : 0,
                overallAverage: average,
                bestQuestion: bestQuestion,
                bestAverage: bestAvg.toFixed(2),
                worstQuestion: worstQuestion,
                worstAverage: worstAvg.toFixed(2)
            };
        }
        
        // ==========================================
        // RENDERIZAR RESUMEN DE SECCI√ìN (DETALLE)
        // ==========================================
        function renderSectionSummaryDetail(summary, questionCount) {
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'section-summary mb-4';
            summaryDiv.innerHTML = `
                <h6 class="mb-3">
                    <i class="bi bi-clipboard-data me-2"></i>Resumen de la Secci√≥n
                </h6>
                <div class="summary-metric">
                    <span class="metric-label">Total de preguntas tipo escala:</span>
                    <span class="metric-value">${summary.totalQuestions}</span>
                </div>
                <div class="summary-metric">
                    <span class="metric-label">Total de respuestas recibidas:</span>
                    <span class="metric-value">${summary.totalResponses}</span>
                </div>
                <div class="summary-metric">
                    <span class="metric-label">Promedio de respuestas por pregunta:</span>
                    <span class="metric-value">${summary.averageResponses}</span>
                </div>
                ${summary.bestQuestion ? `
                <div class="mt-3 pt-3" style="border-top: 1px solid #dee2e6;">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div style="flex: 1;">
                            <small class="text-success fw-bold">
                                <i class="bi bi-arrow-up-circle me-1"></i>Mejor valorada:
                            </small>
                            <div class="small mt-1">${escapeHtml(summary.bestQuestion.question_text)}</div>
                        </div>
                        <span class="badge bg-success ms-2">${summary.bestAverage}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-start">
                        <div style="flex: 1;">
                            <small class="text-danger fw-bold">
                                <i class="bi bi-arrow-down-circle me-1"></i>Menor valoraci√≥n:
                            </small>
                            <div class="small mt-1">${escapeHtml(summary.worstQuestion.question_text)}</div>
                        </div>
                        <span class="badge bg-danger ms-2">${summary.worstAverage}</span>
                    </div>
                </div>
                ` : ''}
            `;
            
            return summaryDiv;
        }
        
        // ==========================================
        // RENDERIZAR PREGUNTA - VISTA GLOBAL
        // ==========================================
        function renderQuestionGlobal(question, section) {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-card';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'question-title';
            titleDiv.textContent = question.question_text;
            
            if (question.question_type === 'scale') {
                const scaleQuestions = section.survey_questions.filter(q => q.question_type === 'scale');
                const summary = calculateSectionSummary(scaleQuestions, section);
                
                if (summary.bestQuestion && summary.bestQuestion.question_id === question.question_id) {
                    const badge = document.createElement('span');
                    badge.className = 'question-badge badge-best';
                    badge.innerHTML = '<i class="bi bi-trophy me-1"></i>Mejor valorada';
                    titleDiv.appendChild(badge);
                }
                
                if (summary.worstQuestion && summary.worstQuestion.question_id === question.question_id) {
                    const badge = document.createElement('span');
                    badge.className = 'question-badge badge-worst';
                    badge.innerHTML = '<i class="bi bi-arrow-down-circle me-1"></i>Menor valoraci√≥n';
                    titleDiv.appendChild(badge);
                }
            }
            
            questionDiv.appendChild(titleDiv);
            
            if (question.question_type === 'scale') {
                questionDiv.appendChild(renderScaleQuestionGlobal(question, section));
            } else if (question.question_type === 'open_text') {
                questionDiv.appendChild(renderOpenQuestionGlobal(question));
            }
            
            return questionDiv;
        }
        
        // ==========================================
        // RENDERIZAR PREGUNTA SCALE - VISTA GLOBAL
        // ==========================================
        function renderScaleQuestionGlobal(question, section) {
            const container = document.createElement('div');
            
            const responses = [];
            filteredProfiles.forEach(profile => {
                const response = profile.survey_responses.find(r => r.question_id === question.question_id);
                if (response && response.response_value !== null) {
                    responses.push(response.response_value);
                }
            });
            
            if (responses.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay respuestas para esta pregunta</p>';
                return container;
            }
            
            const distribution = {};
            const scaleOptions = section.survey_scales.survey_scale_options;
            
            scaleOptions.forEach(option => {
                distribution[option.option_value] = {
                    text: option.option_text,
                    count: 0
                };
            });
            
            responses.forEach(value => {
                if (distribution[value]) {
                    distribution[value].count++;
                }
            });
            
            const totalResponses = responses.length;
            
            const barsDiv = document.createElement('div');
            barsDiv.className = 'mt-3';
            
            scaleOptions.forEach(option => {
                const data = distribution[option.option_value];
                const percentage = (data.count / totalResponses * 100).toFixed(1);
                
                const barDiv = document.createElement('div');
                barDiv.className = 'distribution-bar';
                barDiv.innerHTML = `
                    <div class="bar-label">${escapeHtml(data.text)}</div>
                    <div class="bar-container">
                        <div class="bar-fill" style="width: ${percentage}%">
                            ${percentage}%
                        </div>
                    </div>
                    <div class="bar-count">${data.count} resp.</div>
                `;
                barsDiv.appendChild(barDiv);
            });
            
            container.appendChild(barsDiv);
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'mt-3 text-muted small';
            infoDiv.textContent = `Total de respuestas: ${totalResponses}`;
            container.appendChild(infoDiv);
            
            return container;
        }
        
        // ==========================================
        // RENDERIZAR PREGUNTA - VISTA SEGMENTADA
        // ==========================================
        function renderQuestionSegmented(question, section) {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-card';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'question-title';
            titleDiv.innerHTML = `
                ${escapeHtml(question.question_text)}
                <span class="badge bg-info ms-2">
                    <i class="bi bi-diagram-3 me-1"></i>Vista Comparativa
                </span>
            `;
            questionDiv.appendChild(titleDiv);
            
            if (question.question_type === 'scale') {
                questionDiv.appendChild(renderScaleQuestionSegmented(question, section));
            } else if (question.question_type === 'open_text') {
                questionDiv.appendChild(renderOpenQuestionGlobal(question));
            }
            
            return questionDiv;
        }
        
        // ==========================================
        // RENDERIZAR PREGUNTA SCALE SEGMENTADA
        // ==========================================
        function renderScaleQuestionSegmented(question, section) {
            const container = document.createElement('div');
            
            const segmentField = Object.keys(activeFilters)[0];
            if (!segmentField) {
                container.innerHTML = '<p class="text-muted">Aplica un filtro para ver comparaci√≥n por segmentos</p>';
                return container;
            }
            
            const segmentValues = availableSegments[segmentField].options.map(opt => opt.option_value);
            
            const segmentData = {};
            
            segmentValues.forEach(value => {
                const segmentProfiles = allProfiles.filter(profile => {
                    if (profile.segment_data && profile.segment_data[segmentField]) {
                        return profile.segment_data[segmentField] === value;
                    }
                    return false;
                });
                
                const responses = [];
                const distribution = {};
                
                section.survey_scales.survey_scale_options.forEach(option => {
                    distribution[option.option_value] = 0;
                });
                
                segmentProfiles.forEach(profile => {
                    const response = profile.survey_responses.find(r => r.question_id === question.question_id);
                    if (response && response.response_value !== null) {
                        responses.push(response.response_value);
                        distribution[response.response_value]++;
                    }
                });
                
                if (responses.length > 0) {
                    const average = (responses.reduce((a, b) => a + b, 0) / responses.length).toFixed(2);
                    
                    const optionName = availableSegments[segmentField].options.find(opt => opt.option_value === value)?.option_name || value;
                    
                    segmentData[optionName] = {
                        count: responses.length,
                        average: average,
                        distribution: distribution
                    };
                }
            });
            
            if (Object.keys(segmentData).length === 0) {
                container.innerHTML = '<p class="text-muted">No hay respuestas para comparar</p>';
                return container;
            }
            
            const comparisonDiv = document.createElement('div');
            comparisonDiv.className = 'segment-comparison mt-3';
            
            Object.entries(segmentData).forEach(([segmentName, data]) => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'segment-item';
                
                let distributionHTML = '';
                section.survey_scales.survey_scale_options.forEach(option => {
                    const count = data.distribution[option.option_value] || 0;
                    const percentage = data.count > 0 ? (count / data.count * 100).toFixed(0) : 0;
                    distributionHTML += `
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small>${escapeHtml(option.option_text)}</small>
                            <small>${count}</small>
                        </div>
                        <div class="segment-bar">
                            <div class="segment-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    `;
                });
                
                segmentDiv.innerHTML = `
                    <div class="segment-name">${escapeHtml(segmentName)}</div>
                    <div class="segment-stats">
                        <div class="segment-average">${data.average}</div>
                        <div class="segment-count">${data.count} resp.</div>
                    </div>
                    <div class="segment-distribution mt-2">
                        ${distributionHTML}
                    </div>
                `;
                
                comparisonDiv.appendChild(segmentDiv);
            });
            
            container.appendChild(comparisonDiv);
            
            return container;
        }

        // ==========================================
        // RENDERIZAR PREGUNTA ABIERTA CON AN√ÅLISIS
        // ==========================================
        function renderOpenQuestionGlobal(question) {
            const container = document.createElement('div');
            
            const responses = [];
            filteredProfiles.forEach(profile => {
                const response = profile.survey_responses.find(r => r.question_id === question.question_id);
                if (response && response.response_text && response.response_text.trim()) {
                    responses.push({
                        text: response.response_text,
                        date: response.responded_at
                    });
                }
            });
            
            if (responses.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay respuestas para esta pregunta</p>';
                return container;
            }
            
            // Analizar palabras clave
            const texts = responses.map(r => r.text);
            const frequencies = countWordFrequencies(texts);
            const topWords = getTopWords(frequencies, 20);
            const sentimentStats = getSentimentStats(responses);
            
            // Panel de an√°lisis (colapsable)
            const analysisPanel = document.createElement('div');
            analysisPanel.className = 'card border-info mb-3';
            analysisPanel.innerHTML = `
                <div class="card-header bg-info bg-opacity-10 d-flex justify-content-between align-items-center" 
                     style="cursor: pointer;"
                     onclick="toggleAnalysisPanel('${question.question_id}')">
                    <div>
                        <i class="bi bi-bar-chart-line me-2"></i>
                        <strong>An√°lisis de Palabras Clave</strong>
                        <span class="badge bg-info ms-2">${topWords.length} palabras principales</span>
                    </div>
                    <i class="bi bi-chevron-down" id="chevron_${question.question_id}"></i>
                </div>
                <div class="collapse" id="analysis_${question.question_id}">
                    <div class="card-body">
                        <!-- Indicadores de sentimiento -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-muted mb-2">
                                    <i class="bi bi-emoji-smile me-1"></i>An√°lisis de Sentimiento
                                </h6>
                                <div class="d-flex gap-3">
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-success me-2" style="width: 60px;">
                                            ${sentimentStats.positive}
                                        </span>
                                        <small class="text-muted">Positivas</small>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-secondary me-2" style="width: 60px;">
                                            ${sentimentStats.neutral}
                                        </span>
                                        <small class="text-muted">Neutrales</small>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-danger me-2" style="width: 60px;">
                                            ${sentimentStats.negative}
                                        </span>
                                        <small class="text-muted">Negativas</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- B√∫squeda r√°pida -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-search me-1"></i>Buscar en respuestas
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="search_${question.question_id}"
                                   placeholder="Escribe una palabra para buscar..."
                                   onkeyup="searchInResponses('${question.question_id}')">
                        </div>
                        
                        <!-- Palabras clave -->
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-tag me-1"></i>Palabras m√°s frecuentes
                            </h6>
                            <div id="keywords_${question.question_id}" class="d-flex flex-wrap gap-2">
                                ${renderKeywordBadges(topWords, question.question_id)}
                            </div>
                        </div>
                        
                        <!-- Indicador de filtro activo -->
                        <div id="filter_indicator_${question.question_id}" 
                             class="alert alert-warning" 
                             style="display: none;">
                            <i class="bi bi-funnel me-2"></i>
                            Mostrando respuestas que contienen: 
                            <strong id="filter_word_${question.question_id}"></strong>
                            <button class="btn btn-sm btn-outline-warning ms-2" 
                                    onclick="clearResponseFilter('${question.question_id}')">
                                <i class="bi bi-x"></i> Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(analysisPanel);
            
            // T√≠tulo de respuestas
            const titleDiv = document.createElement('div');
            titleDiv.className = 'mt-3 mb-2 d-flex justify-content-between align-items-center';
            titleDiv.innerHTML = `
                <div class="fw-bold">
                    <span id="response_count_${question.question_id}">${responses.length}</span> 
                    respuestas recibidas
                </div>
                <button class="btn btn-sm btn-outline-secondary" 
                        onclick="exportResponses('${question.question_id}')">
                    <i class="bi bi-download me-1"></i>Exportar
                </button>
            `;
            container.appendChild(titleDiv);
            
            // Tabla de respuestas
            const table = document.createElement('table');
            table.className = 'open-responses-table';
            table.id = `responses_table_${question.question_id}`;
            table.innerHTML = `
                <thead>
                    <tr>
                        <th style="width: 100px;">#</th>
                        <th>Respuesta</th>
                        <th style="width: 120px;">Fecha</th>
                    </tr>
                </thead>
            `;
            
            const tbody = document.createElement('tbody');
            tbody.id = `responses_body_${question.question_id}`;
            
            responses.forEach((response, index) => {
                const row = document.createElement('tr');
                row.className = 'response-row';
                row.innerHTML = `
                    <td class="response-number">#${index + 1}</td>
                    <td class="response-text">${escapeHtml(response.text)}</td>
                    <td class="response-date">${formatDate(response.date)}</td>
                `;
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
            
            // Guardar respuestas en el DOM para b√∫squeda
            container.dataset.responses = JSON.stringify(responses);
            container.dataset.questionId = question.question_id;
            
            return container;
        }
        
        /**
         * Renderizar badges de palabras clave
         */
        function renderKeywordBadges(topWords, questionId) {
            if (topWords.length === 0) {
                return '<span class="text-muted">No hay palabras frecuentes</span>';
            }
            
            // Calcular tama√±o de badge seg√∫n frecuencia
            const maxCount = topWords[0].count;
            
            return topWords.map(item => {
                const size = item.count === maxCount ? 'fs-6' : 
                             item.count >= maxCount * 0.7 ? 'fs-7' : 'fs-8';
                
                return `
                    <button class="btn btn-outline-primary btn-sm keyword-badge ${size}"
                            onclick="filterByKeyword('${questionId}', '${item.word}')"
                            title="Aparece ${item.count} veces">
                        ${escapeHtml(item.word)}
                        <span class="badge bg-primary ms-1">${item.count}</span>
                    </button>
                `;
            }).join('');
        }
        
        /**
         * Toggle del panel de an√°lisis
         */
        function toggleAnalysisPanel(questionId) {
            const panel = document.getElementById(`analysis_${questionId}`);
            const chevron = document.getElementById(`chevron_${questionId}`);
            
            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
                chevron.classList.remove('bi-chevron-up');
                chevron.classList.add('bi-chevron-down');
            } else {
                panel.classList.add('show');
                chevron.classList.remove('bi-chevron-down');
                chevron.classList.add('bi-chevron-up');
            }
        }
        
        /**
         * Filtrar respuestas por palabra clave
         */
        function filterByKeyword(questionId, keyword) {
            const container = document.querySelector(`[data-question-id="${questionId}"]`);
            if (!container) return;
            
            const responses = JSON.parse(container.dataset.responses);
            const matchingResponses = findResponsesWithKeyword(responses, keyword);
            
            // Actualizar tabla
            const tbody = document.getElementById(`responses_body_${questionId}`);
            tbody.innerHTML = '';
            
            matchingResponses.forEach((response, index) => {
                const row = document.createElement('tr');
                row.className = 'response-row';
                row.innerHTML = `
                    <td class="response-number">#${index + 1}</td>
                    <td class="response-text">${highlightKeyword(response.text, keyword)}</td>
                    <td class="response-date">${formatDate(response.date)}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Mostrar indicador de filtro
            document.getElementById(`filter_indicator_${questionId}`).style.display = 'block';
            document.getElementById(`filter_word_${questionId}`).textContent = keyword;
            document.getElementById(`response_count_${questionId}`).textContent = matchingResponses.length;
        }
        
        /**
         * Limpiar filtro de respuestas
         */
        function clearResponseFilter(questionId) {
            const container = document.querySelector(`[data-question-id="${questionId}"]`);
            if (!container) return;
            
            const responses = JSON.parse(container.dataset.responses);
            
            // Restaurar todas las respuestas
            const tbody = document.getElementById(`responses_body_${questionId}`);
            tbody.innerHTML = '';
            
            responses.forEach((response, index) => {
                const row = document.createElement('tr');
                row.className = 'response-row';
                row.innerHTML = `
                    <td class="response-number">#${index + 1}</td>
                    <td class="response-text">${escapeHtml(response.text)}</td>
                    <td class="response-date">${formatDate(response.date)}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Ocultar indicador
            document.getElementById(`filter_indicator_${questionId}`).style.display = 'none';
            document.getElementById(`response_count_${questionId}`).textContent = responses.length;
            
            // Limpiar b√∫squeda
            const searchInput = document.getElementById(`search_${questionId}`);
            if (searchInput) searchInput.value = '';
        }
        // Hacer funciones disponibles globalmente
        window.toggleAnalysisPanel = toggleAnalysisPanel;
        window.filterByKeyword = filterByKeyword;
        window.clearResponseFilter = clearResponseFilter;


        // ==========================================
        // B√öSQUEDA EN TIEMPO REAL
        // ==========================================
        
        /**
         * Buscar en respuestas mientras el usuario escribe
         */
        function searchInResponses(questionId) {
            const searchInput = document.getElementById(`search_${questionId}`);
            const searchTerm = searchInput.value.trim();
            
            const container = document.querySelector(`[data-question-id="${questionId}"]`);
            if (!container) return;
            
            const responses = JSON.parse(container.dataset.responses);
            
            // Si el campo est√° vac√≠o, mostrar todas las respuestas
            if (!searchTerm) {
                clearResponseFilter(questionId);
                return;
            }
            
            // Filtrar respuestas que contienen el t√©rmino
            const matchingResponses = findResponsesWithKeyword(responses, searchTerm);
            
            // Actualizar tabla con resultados
            const tbody = document.getElementById(`responses_body_${questionId}`);
            tbody.innerHTML = '';
            
            if (matchingResponses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center py-4 text-muted">
                            <i class="bi bi-search"></i>
                            <div class="mt-2">No se encontraron respuestas con "${escapeHtml(searchTerm)}"</div>
                        </td>
                    </tr>
                `;
            } else {
                matchingResponses.forEach((response, index) => {
                    const row = document.createElement('tr');
                    row.className = 'response-row';
                    row.innerHTML = `
                        <td class="response-number">#${index + 1}</td>
                        <td class="response-text">${highlightKeyword(response.text, searchTerm)}</td>
                        <td class="response-date">${formatDate(response.date)}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // Actualizar contador
            document.getElementById(`response_count_${questionId}`).textContent = matchingResponses.length;
            
            // Mostrar/ocultar indicador de filtro
            const filterIndicator = document.getElementById(`filter_indicator_${questionId}`);
            if (searchTerm) {
                filterIndicator.style.display = 'block';
                document.getElementById(`filter_word_${questionId}`).textContent = `"${searchTerm}"`;
            } else {
                filterIndicator.style.display = 'none';
            }
        }
        
        // ==========================================
        // EXPORTACI√ìN MEJORADA
        // ==========================================
        
        /**
         * Exportar respuestas de una pregunta abierta con an√°lisis
         */
        function exportResponses(questionId) {
            const container = document.querySelector(`[data-question-id="${questionId}"]`);
            if (!container) {
                showMessage('Error al exportar: no se encontr√≥ la pregunta', 'danger');
                return;
            }
            
            const responses = JSON.parse(container.dataset.responses);
            
            // Encontrar la pregunta en la estructura
            let questionText = '';
            let sectionTitle = '';
            
            surveyMaster.survey_sections.forEach(section => {
                const question = section.survey_questions.find(q => q.question_id === questionId);
                if (question) {
                    questionText = question.question_text;
                    sectionTitle = section.section_title;
                }
            });
            
            // Analizar palabras clave
            const texts = responses.map(r => r.text);
            const frequencies = countWordFrequencies(texts);
            const topWords = getTopWords(frequencies, 50); // Top 50 para exportaci√≥n
            const sentimentStats = getSentimentStats(responses);
            
            // Crear CSV con m√∫ltiples hojas (simulado con secciones)
            let csvContent = '';
            
            // ===== SECCI√ìN 1: INFORMACI√ìN GENERAL =====
            csvContent += '===== INFORMACI√ìN GENERAL =====\n';
            csvContent += `Encuesta,${escapeCSV(surveyMaster.survey_name)}\n`;
            csvContent += `Aplicaci√≥n,${escapeCSV(selectedApplication.application_name)}\n`;
            csvContent += `Secci√≥n,${escapeCSV(sectionTitle)}\n`;
            csvContent += `Pregunta,${escapeCSV(questionText)}\n`;
            csvContent += `Total de respuestas,${responses.length}\n`;
            csvContent += `Fecha de exportaci√≥n,${new Date().toLocaleString('es-CO')}\n`;
            csvContent += '\n\n';
            
            // ===== SECCI√ìN 2: AN√ÅLISIS DE SENTIMIENTO =====
            csvContent += '===== AN√ÅLISIS DE SENTIMIENTO =====\n';
            csvContent += 'Tipo,Cantidad,Porcentaje\n';
            const totalSentiment = sentimentStats.positive + sentimentStats.negative + sentimentStats.neutral;
            csvContent += `Positivas,${sentimentStats.positive},${((sentimentStats.positive/totalSentiment)*100).toFixed(1)}%\n`;
            csvContent += `Neutrales,${sentimentStats.neutral},${((sentimentStats.neutral/totalSentiment)*100).toFixed(1)}%\n`;
            csvContent += `Negativas,${sentimentStats.negative},${((sentimentStats.negative/totalSentiment)*100).toFixed(1)}%\n`;
            csvContent += '\n\n';
            
            // ===== SECCI√ìN 3: PALABRAS CLAVE =====
            csvContent += '===== TOP 50 PALABRAS CLAVE =====\n';
            csvContent += 'Posici√≥n,Palabra,Frecuencia,Porcentaje del total\n';
            
            topWords.forEach((item, index) => {
                const percentage = ((item.count / responses.length) * 100).toFixed(1);
                csvContent += `${index + 1},${escapeCSV(item.word)},${item.count},${percentage}%\n`;
            });
            csvContent += '\n\n';
            
            // ===== SECCI√ìN 4: RESPUESTAS COMPLETAS =====
            csvContent += '===== RESPUESTAS COMPLETAS =====\n';
            csvContent += 'N√∫mero,Fecha,Sentimiento,Respuesta\n';
            
            responses.forEach((response, index) => {
                const sentiment = analyzeBasicSentiment(response.text);
                const sentimentLabel = sentiment === 'positive' ? 'Positiva' : 
                                       sentiment === 'negative' ? 'Negativa' : 'Neutral';
                
                csvContent += `${index + 1},${formatDate(response.date)},${sentimentLabel},${escapeCSV(response.text)}\n`;
            });
            
            // Descargar archivo con BOM UTF-8
            const BOM = '\uFEFF'; // Byte Order Mark para UTF-8
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const filename = `respuestas_${sanitizeFilename(questionText.substring(0, 50))}_${Date.now()}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('An√°lisis exportado exitosamente con palabras clave y sentimientos', 'success');
        }
        
        /**
         * Escapar texto para CSV
         */
        function escapeCSV(text) {
            if (!text) return '';
            
            // Convertir a string y eliminar saltos de l√≠nea problem√°ticos
            let escaped = String(text)
                .replace(/\r\n/g, ' ')
                .replace(/\n/g, ' ')
                .replace(/\r/g, ' ');
            
            // Si contiene comas o comillas, encerrar entre comillas y escapar comillas internas
            if (escaped.includes(',') || escaped.includes('"') || escaped.includes('\n')) {
                escaped = '"' + escaped.replace(/"/g, '""') + '"';
            }
            
            return escaped;
        }
        
        /**
         * Sanitizar nombre de archivo
         */
        function sanitizeFilename(text) {
            return text
                .toLowerCase()
                .replace(/[^a-z0-9]/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '');
        }
        
        // ==========================================
        // EXPORTACI√ìN GLOBAL DE TODAS LAS RESPUESTAS ABIERTAS
        // ==========================================
        
        /**
         * Exportar an√°lisis consolidado de todas las preguntas abiertas
         */
        function exportAllOpenResponses() {
            console.log('üìä Exportando an√°lisis consolidado de todas las preguntas abiertas...');
            
            let csvContent = '';
            
            // Encabezado general
            csvContent += '===== AN√ÅLISIS CONSOLIDADO DE RESPUESTAS ABIERTAS =====\n';
            csvContent += `Encuesta,${escapeCSV(surveyMaster.survey_name)}\n`;
            csvContent += `Aplicaci√≥n,${escapeCSV(selectedApplication.application_name)}\n`;
            csvContent += `Fecha de exportaci√≥n,${new Date().toLocaleString('es-CO')}\n`;
            csvContent += `Total de respuestas en la aplicaci√≥n,${filteredProfiles.length}\n`;
            csvContent += '\n\n';
            
            // Procesar cada secci√≥n
            surveyMaster.survey_sections.forEach((section, sectionIndex) => {
                const openQuestions = section.survey_questions.filter(q => q.question_type === 'open_text');
                
                if (openQuestions.length === 0) return;
                
                csvContent += `${'='.repeat(80)}\n`;
                csvContent += `SECCI√ìN ${sectionIndex + 1}: ${escapeCSV(section.section_title)}\n`;
                csvContent += `${'='.repeat(80)}\n\n`;
                
                openQuestions.forEach((question, qIndex) => {
                    // Recolectar respuestas
                    const responses = [];
                    filteredProfiles.forEach(profile => {
                        const response = profile.survey_responses.find(r => r.question_id === question.question_id);
                        if (response && response.response_text && response.response_text.trim()) {
                            responses.push({
                                text: response.response_text,
                                date: response.responded_at
                            });
                        }
                    });
                    
                    if (responses.length === 0) return;
                    
                    // An√°lisis
                    const texts = responses.map(r => r.text);
                    const frequencies = countWordFrequencies(texts);
                    const topWords = getTopWords(frequencies, 20);
                    const sentimentStats = getSentimentStats(responses);
                    
                    csvContent += `--- Pregunta ${qIndex + 1}: ${escapeCSV(question.question_text)} ---\n`;
                    csvContent += `Total de respuestas,${responses.length}\n\n`;
                    
                    // Sentimientos
                    csvContent += 'AN√ÅLISIS DE SENTIMIENTO\n';
                    csvContent += `Positivas,${sentimentStats.positive}\n`;
                    csvContent += `Neutrales,${sentimentStats.neutral}\n`;
                    csvContent += `Negativas,${sentimentStats.negative}\n\n`;
                    
                    // Top palabras
                    csvContent += 'TOP 20 PALABRAS CLAVE\n';
                    csvContent += 'Palabra,Frecuencia\n';
                    topWords.forEach(item => {
                        csvContent += `${escapeCSV(item.word)},${item.count}\n`;
                    });
                    csvContent += '\n\n';
                });
            });
            
            // Descargar
            // Descargar con BOM UTF-8
            const BOM = '\uFEFF'; // Byte Order Mark para UTF-8
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const filename = `analisis_completo_${sanitizeFilename(selectedApplication.application_name)}_${Date.now()}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('An√°lisis consolidado exportado exitosamente', 'success');
        }
        
        // Hacer funciones disponibles globalmente
        window.searchInResponses = searchInResponses;
        window.exportResponses = exportResponses;
        window.exportAllOpenResponses = exportAllOpenResponses;
        
        console.log('‚úÖ Funciones de b√∫squeda y exportaci√≥n cargadas');

        
     
        // ==========================================
        // UTILIDADES
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Hacer funci√≥n global para onclick
        window.toggleSectionDetail = toggleSectionDetail;

        // ==========================================
        // AN√ÅLISIS DE TEXTO - PALABRAS CLAVE
        // ==========================================
        
        /**
         * Lista de palabras vac√≠as en espa√±ol a excluir del an√°lisis
         */
        const STOP_WORDS = new Set([
            // Art√≠culos
            'el', 'la', 'los', 'las', 'un', 'una', 'unos', 'unas',
            // Preposiciones
            'de', 'del', 'a', 'al', 'en', 'por', 'para', 'con', 'sin', 'sobre', 
            'entre', 'hasta', 'desde', 'hacia', 'bajo', 'tras',
            // Conjunciones
            'y', 'e', 'o', 'u', 'pero', 'sino', 'aunque', 'porque', 'como', 'si',
            'que', 'cual', 'quien', 'cuando', 'donde', 'mientras',
            // Pronombres
            'yo', 'tu', 't√∫', '√©l', 'ella', 'nosotros', 'nosotras', 'vosotros', 
            'vosotras', 'ellos', 'ellas', 'me', 'te', 'se', 'le', 'les', 'lo', 
            'la', 'los', 'las', 'mi', 'mis', 'su', 'sus', 'nuestro', 'nuestra',
            // Verbos comunes
            'es', 'son', 'est√°', 'est√°n', 'hay', 'ha', 'han', 'ser', 'estar',
            'tener', 'hacer', 'haber', 'fue', 'sido', 'ido',
            // Otros
            'm√°s', 'muy', 'tambi√©n', 'tan', 'tanto', 'as√≠', 'ya', 'solo', 's√≥lo',
            'aqu√≠', 'all√≠', 'ah√≠', 'esto', 'eso', 'aquello', 'este', 'ese', 'aquel',
            'esta', 'esa', 'aquella', 'estos', 'esos', 'aquellos', 'estas', 'esas',
            'aquellas', 'todo', 'toda', 'todos', 'todas', 'otro', 'otra', 'otros',
            'otras', 'mismo', 'misma', 'mismos', 'mismas', 'tal', 'tales'
        ]);
        
        /**
         * Limpiar y normalizar texto
         * @param {string} text - Texto a limpiar
         * @returns {string} Texto limpio
         */
        function cleanText(text) {
            if (!text) return '';
            
            return text
                .toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Quitar acentos
                .replace(/[^\w\s]/g, ' ') // Quitar puntuaci√≥n
                .replace(/\s+/g, ' ') // Normalizar espacios
                .trim();
        }
        
        /**
         * Extraer palabras de un texto
         * @param {string} text - Texto a procesar
         * @returns {Array<string>} Array de palabras limpias
         */
        function extractWords(text) {
            const cleaned = cleanText(text);
            return cleaned
                .split(' ')
                .filter(word => word.length >= 3) // M√≠nimo 3 caracteres
                .filter(word => !STOP_WORDS.has(word)) // Excluir palabras vac√≠as
                .filter(word => !/^\d+$/.test(word)); // Excluir n√∫meros puros
        }
        
        /**
         * Contar frecuencia de palabras en m√∫ltiples textos
         * @param {Array<string>} texts - Array de textos
         * @returns {Object} Objeto con palabras y sus frecuencias
         */
        function countWordFrequencies(texts) {
            const frequencies = {};
            
            texts.forEach(text => {
                const words = extractWords(text);
                words.forEach(word => {
                    frequencies[word] = (frequencies[word] || 0) + 1;
                });
            });
            
            return frequencies;
        }
        
        /**
         * Obtener top N palabras m√°s frecuentes
         * @param {Object} frequencies - Objeto de frecuencias
         * @param {number} limit - Cantidad de palabras a retornar
         * @returns {Array<Object>} Array de {word, count} ordenado por frecuencia
         */
        function getTopWords(frequencies, limit = 20) {
            return Object.entries(frequencies)
                .map(([word, count]) => ({ word, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, limit);
        }
        
        /**
         * Buscar respuestas que contienen una palabra espec√≠fica
         * @param {Array<Object>} responses - Array de respuestas con text
         * @param {string} keyword - Palabra a buscar
         * @returns {Array<Object>} Respuestas que contienen la palabra
         */
        function findResponsesWithKeyword(responses, keyword) {
            const cleanKeyword = cleanText(keyword);
            
            return responses.filter(response => {
                const cleanResponse = cleanText(response.text);
                return cleanResponse.includes(cleanKeyword);
            });
        }
        
        /**
         * Resaltar palabra en texto
         * @param {string} text - Texto original
         * @param {string} keyword - Palabra a resaltar
         * @returns {string} HTML con palabra resaltada
         */
        function highlightKeyword(text, keyword) {
            if (!text || !keyword) return escapeHtml(text);
            
            const cleanKeyword = cleanText(keyword);
            const escapedText = escapeHtml(text);
            
            // Buscar coincidencias sin importar acentos o may√∫sculas
            const regex = new RegExp(
                cleanKeyword.split('').map(char => 
                    `[${char}${char.toUpperCase()}]`
                ).join('\\s*'),
                'gi'
            );
            
            return escapedText.replace(regex, match => 
                `<mark style="background-color: #fff3cd; padding: 2px 4px; border-radius: 3px;">${match}</mark>`
            );
        }
        
        /**
         * Analizar sentimiento b√°sico de un texto
         * @param {string} text - Texto a analizar
         * @returns {string} 'positive', 'negative', 'neutral'
         */
        function analyzeBasicSentiment(text) {
            const cleaned = cleanText(text);
            
            const positiveWords = [
                'excelente', 'bueno', 'buena', 'mejor', 'genial', 'fantastico', 
                'maravilloso', 'perfecto', 'satisfecho', 'feliz', 'alegre', 'contento',
                'agradable', 'positivo', 'favorable', 'bien', 'encantado', 'gusto'
            ];
            
            const negativeWords = [
                'malo', 'mala', 'peor', 'terrible', 'horrible', 'deficiente',
                'insatisfecho', 'triste', 'molesto', 'enojado', 'frustrado',
                'desagradable', 'negativo', 'desfavorable', 'mal', 'problema',
                'dificultad', 'defecto'
            ];
            
            let positiveCount = 0;
            let negativeCount = 0;
            
            positiveWords.forEach(word => {
                if (cleaned.includes(word)) positiveCount++;
            });
            
            negativeWords.forEach(word => {
                if (cleaned.includes(word)) negativeCount++;
            });
            
            if (positiveCount > negativeCount) return 'positive';
            if (negativeCount > positiveCount) return 'negative';
            return 'neutral';
        }
        
        /**
         * Obtener estad√≠sticas de sentimientos para m√∫ltiples respuestas
         * @param {Array<Object>} responses - Array de respuestas
         * @returns {Object} Estad√≠sticas de sentimientos
         */
        function getSentimentStats(responses) {
            const sentiments = {
                positive: 0,
                negative: 0,
                neutral: 0
            };
            
            responses.forEach(response => {
                const sentiment = analyzeBasicSentiment(response.text);
                sentiments[sentiment]++;
            });
            
            return sentiments;
        }

        console.log('‚úÖ Funciones de an√°lisis de texto cargadas');
        console.log('‚úÖ M√≥dulo de resultados con an√°lisis por secciones cargado correctamente');
    </script>
</body>
</html>
