<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.05.15.15">
    <title>Mi Perfil - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --module-primary: #9b59b6;
            --module-secondary: #8e44ad;
            --module-light: #e8daef;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--module-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tabs personalizados */
        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link:hover {
            border-bottom-color: var(--module-light);
            color: var(--module-primary);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--module-primary);
            border-bottom-color: var(--module-primary);
            font-weight: 600;
            background: transparent;
        }
        
        /* Profile card */
        .profile-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--module-light);
            object-fit: cover;
        }
        
        .profile-avatar-placeholder {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--module-primary), var(--module-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            font-weight: 600;
        }
        
        /* Info rows */
        .info-row {
            padding: 1rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            font-size: 1rem;
            color: #2c3e50;
        }
        
        /* Connection status */
        .connection-status {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .connection-status.not-configured {
            background: #fff3cd;
            color: #856404;
        }
        
        .connection-status.connected {
            background: #d1e7dd;
            color: #0f5132;
        }
        
        .connection-status.error {
            background: #f8d7da;
            color: #842029;
        }
        
        /* Calendar input */
        .calendar-input-group {
            position: relative;
        }
        
        .calendar-input-group .form-control {
            padding-right: 100px;
        }
        
        .calendar-input-group .btn-test {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0" id="loadingText">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">

      <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Mi Perfil</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Perfil Completo
                </li>
            </ol>
        </nav>

        <!-- HEADER -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-person-vcard me-2" style="color: var(--module-primary);"></i>
                    Mi Perfil
                </h1>
                <p class="text-muted">
                    Ver y configurar informaci√≥n personal, seguridad y calendario
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- TABS NAVIGATION -->
        <ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="info-tab" data-bs-toggle="tab" 
                        data-bs-target="#tab-info" type="button" role="tab">
                    <i class="bi bi-person-vcard me-2"></i>
                    Informaci√≥n Personal
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="security-tab" data-bs-toggle="tab" 
                        data-bs-target="#tab-security" type="button" role="tab">
                    <i class="bi bi-shield-lock me-2"></i>
                    Seguridad
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" 
                        data-bs-target="#tab-calendar" type="button" role="tab">
                    <i class="bi bi-calendar-event me-2"></i>
                    Calendario
                </button>
            </li>
        </ul>

        <!-- TABS CONTENT -->
        <div class="tab-content" id="profileTabsContent">
            
            <!-- ============================================ -->
            <!-- TAB 1: INFORMACI√ìN PERSONAL -->
            <!-- ============================================ -->
            <div class="tab-pane fade show active" id="tab-info" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="card profile-card">
                            <div class="card-body">
                                <!-- Avatar y Nombre -->
                                <div class="text-center mb-4 pb-4 border-bottom">
                                    <div id="avatar-container" class="mb-3">
                                        <!-- Avatar se carga din√°micamente -->
                                    </div>
                                    <h4 class="mb-1" id="profile-full-name">-</h4>
                                    <p class="text-muted mb-0" id="profile-role">-</p>
                                </div>

                                <!-- Informaci√≥n Personal -->
                                <div class="info-row">
                                    <div class="info-label">
                                        <i class="bi bi-card-text me-1"></i>Documento de Identidad
                                    </div>
                                    <div class="info-value" id="profile-document">-</div>
                                </div>

                                <div class="info-row">
                                    <div class="info-label">
                                        <i class="bi bi-envelope me-1"></i>Email Institucional
                                    </div>
                                    <div class="info-value" id="profile-email">-</div>
                                </div>

                                <div class="info-row">
                                    <div class="info-label">
                                        <i class="bi bi-phone me-1"></i>Tel√©fono
                                    </div>
                                    <div class="info-value" id="profile-phone">-</div>
                                </div>

                                <div class="info-row">
                                    <div class="info-label">
                                        <i class="bi bi-cake2 me-1"></i>Fecha de Nacimiento
                                    </div>
                                    <div class="info-value" id="profile-birthdate">-</div>
                                </div>

                                <div class="info-row">
                                    <div class="info-label">
                                        <i class="bi bi-calendar-check me-1"></i>Fecha de Ingreso
                                    </div>
                                    <div class="info-value" id="profile-hire-date">-</div>
                                </div>

                                <div class="alert alert-info mt-4 mb-0">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <small>
                                        Si necesitas actualizar tu informaci√≥n personal, contacta al √°rea de Talento Humano.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- TAB 2: SEGURIDAD -->
            <!-- ============================================ -->
            <div class="tab-pane fade" id="tab-security" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6 mx-auto">
                        <div class="card profile-card">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-key me-2"></i>Cambiar Contrase√±a
                                </h5>

                                <div class="mb-4">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="bi bi-clock-history me-2 text-muted"></i>
                                        <span class="text-muted">√öltima modificaci√≥n:</span>
                                        <strong class="ms-2" id="last-password-change">-</strong>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-primary w-100" id="btn-change-password">
                                    <i class="bi bi-shield-lock me-2"></i>
                                    Cambiar Contrase√±a
                                </button>

                                <div class="alert alert-warning mt-4 mb-0">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <small>
                                        <strong>Importante:</strong> Usa una contrase√±a segura con al menos 8 caracteres, 
                                        combinando may√∫sculas, min√∫sculas y n√∫meros.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- TAB 3: CALENDARIO -->
            <!-- ============================================ -->
            <div class="tab-pane fade" id="tab-calendar" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="card profile-card">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    <i class="bi bi-calendar-event me-2"></i>
                                    Configuraci√≥n de Google Calendar
                                </h5>

                                <div class="alert alert-info mb-4">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>¬øPara qu√© sirve esto?</strong><br>
                                    <small>
                                        Este Calendar ID se usa para agendar <strong>tus eventos recurrentes</strong> 
                                        en d√≠as Tilat√°. Los eventos se crear√°n en tu calendario personal, 
                                        no en el institucional.
                                    </small>
                                </div>

                                <!-- Accordion con instrucciones -->
                                <div class="accordion mb-4" id="accordionInstrucciones">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseInstrucciones">
                                                <i class="bi bi-question-circle me-2"></i>
                                                ¬øC√≥mo obtener mi Calendar ID?
                                            </button>
                                        </h2>
                                        <div id="collapseInstrucciones" class="accordion-collapse collapse">
                                            <div class="accordion-body">
                                                <ol class="mb-0">
                                                    <li class="mb-3">
                                                        <strong>Abre Google Calendar</strong><br>
                                                        <small class="text-muted">
                                                            Ve a <a href="https://calendar.google.com" target="_blank">calendar.google.com</a>
                                                        </small>
                                                    </li>
                                                    <li class="mb-3">
                                                        <strong>Accede a Configuraci√≥n</strong><br>
                                                        <small class="text-muted">
                                                            Haz clic en el √≠cono de engranaje ‚öôÔ∏è ‚Üí "Configuraci√≥n"
                                                        </small>
                                                    </li>
                                                    <li class="mb-3">
                                                        <strong>Selecciona tu calendario</strong><br>
                                                        <small class="text-muted">
                                                            En el men√∫ lateral, busca tu calendario personal bajo 
                                                            "Configuraci√≥n de mis calendarios"
                                                        </small>
                                                    </li>
                                                    <li class="mb-3">
                                                        <strong>Copia el ID del calendario</strong><br>
                                                        <small class="text-muted">
                                                            Despl√°zate hasta "Integrar calendario" y copia el "ID del calendario"
                                                        </small>
                                                    </li>
                                                    <li>
                                                        <strong>P√©galo en el campo de abajo</strong><br>
                                                        <small class="text-muted">
                                                            El ID tiene este formato: 
                                                            <code>c_xxxxx@group.calendar.google.com</code>
                                                        </small>
                                                    </li>
                                                </ol>
                                                
                                                <div class="alert alert-success mb-0 mt-3">
                                                    <i class="bi bi-lightbulb me-2"></i>
                                                    <small>
                                                        <strong>Tip:</strong> Puedes usar tu calendario personal del dominio 
                                                        institucional o crear un calendario nuevo espec√≠fico para eventos de Tilat√°.
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Campo Calendar ID -->
                                <div class="mb-4">
                                    <label for="alternative_calendar" class="form-label">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        Calendar ID de Google
                                    </label>
                                    <div class="input-group">
                                        <input type="text" 
                                               class="form-control" 
                                               id="alternative_calendar"
                                               placeholder="ejemplo@gmail.com o c_xxxxx@group.calendar.google.com">
                                        <button class="btn btn-outline-secondary" type="button" id="btn-test-connection">
                                            <i class="bi bi-wifi me-1"></i>Probar
                                        </button>
                                    </div>
                                    <small class="text-muted">
                                        Formato: <code>usuario@dominio.com</code> o <code>c_xxxxx@group.calendar.google.com</code>
                                    </small>
                                    <div class="invalid-feedback" id="calendar-feedback"></div>
                                </div>

                                <!-- Estado de conexi√≥n -->
                                <div class="mb-4">
                                    <label class="form-label">Estado de Conexi√≥n:</label>
                                    <div>
                                        <span class="connection-status not-configured" id="connection-status">
                                            <i class="bi bi-circle me-2"></i>
                                            No configurado
                                        </span>
                                    </div>
                                </div>

                                <!-- Bot√≥n Guardar -->
                                <button type="button" class="btn btn-primary w-100" id="btn-save-calendar">
                                    <i class="bi bi-save me-2"></i>
                                    Guardar Configuraci√≥n
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

  <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let workerData = null;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando Mi Perfil...');
            
            try {
                // 1. Obtener sesi√≥n
                const session = getStoredSession();
                if (!session || !session.user) {
                    console.log('‚ùå No hay sesi√≥n activa');
                    redirectToLogin();
                    return;
                }
                
                currentUser = session.user;
                console.log('‚úÖ Usuario actual:', currentUser.user_display_name);
                
                // 2. Cargar datos del trabajador
                await cargarDatosWorker();
                
                // 3. Configurar event listeners
                setupEventListeners();
                
                console.log('‚úÖ Mi Perfil inicializado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando perfil:', error);
                showMessage('Error al cargar el perfil: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGAR DATOS DEL TRABAJADOR
        // ==========================================
        async function cargarDatosWorker() {
            try {
                mostrarLoading('Cargando informaci√≥n del perfil...');
                
                // Query completa con todos los datos necesarios
                const query = `/workers?select=*,job_roles(role_name),genders(gender_name)&email=eq.${currentUser.user_mail}&limit=1`;
                const data = await supabaseRequest(query);
                
                if (!data || data.length === 0) {
                    throw new Error('No se encontraron datos del trabajador');
                }
                
                workerData = data[0];
                console.log('‚úÖ Datos del trabajador cargados:', workerData);
                
                // Renderizar datos en las tabs
                renderizarInformacionPersonal();
                renderizarSeguridad();
                renderizarCalendario();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                ocultarLoading();
                showMessage('Error al cargar informaci√≥n del perfil: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // RENDERIZAR INFORMACI√ìN PERSONAL
        // ==========================================
        function renderizarInformacionPersonal() {
            try {
                // Avatar
                const avatarContainer = document.getElementById('avatar-container');
                const iniciales = obtenerIniciales(workerData.worker_first_name, workerData.worker_last_name_1);
                avatarContainer.innerHTML = `
                    <div class="profile-avatar-placeholder">
                        ${iniciales}
                    </div>
                `;
                
                // Nombre completo
                const nombreCompleto = `${workerData.worker_first_name} ${workerData.worker_last_name_1} ${workerData.worker_last_name_2 || ''}`.trim();
                document.getElementById('profile-full-name').textContent = nombreCompleto;
                
                // Cargo
                const cargo = workerData.job_roles?.role_name || 'Sin cargo asignado';
                document.getElementById('profile-role').textContent = cargo;
                
                // Documento
                document.getElementById('profile-document').textContent = workerData.worker_id_doc || '-';
                
                // Email
                document.getElementById('profile-email').textContent = workerData.email || '-';
                
                // Tel√©fono
                document.getElementById('profile-phone').textContent = workerData.cellphone || 'No registrado';
                
                // Fecha de nacimiento
                if (workerData.birthdate) {
                    const birthdate = new Date(workerData.birthdate);
                    document.getElementById('profile-birthdate').textContent = birthdate.toLocaleDateString('es-CO', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } else {
                    document.getElementById('profile-birthdate').textContent = 'No registrada';
                }
                
                // Fecha de ingreso
                if (workerData.hire_date) {
                    const hireDate = new Date(workerData.hire_date);
                    document.getElementById('profile-hire-date').textContent = hireDate.toLocaleDateString('es-CO', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } else {
                    document.getElementById('profile-hire-date').textContent = 'No registrada';
                }
                
                console.log('‚úÖ Informaci√≥n personal renderizada');
                
            } catch (error) {
                console.error('‚ùå Error renderizando informaci√≥n personal:', error);
            }
        }

        // ==========================================
        // RENDERIZAR SEGURIDAD
        // ==========================================
        function renderizarSeguridad() {
            try {
                // Por ahora solo mostramos "No disponible"
                // La funcionalidad de cambio de contrase√±a viene del modal de config.js
                document.getElementById('last-password-change').textContent = 'No disponible';
                
                console.log('‚úÖ Seguridad renderizada');
                
            } catch (error) {
                console.error('‚ùå Error renderizando seguridad:', error);
            }
        }

        // ==========================================
        // RENDERIZAR CALENDARIO
        // ==========================================
        function renderizarCalendario() {
            try {
                // Cargar alternative_calendar si existe
                const calendarInput = document.getElementById('alternative_calendar');
                if (workerData.alternative_calendar) {
                    calendarInput.value = workerData.alternative_calendar;
                    
                    // Actualizar estado visual
                    actualizarEstadoConexion('not-configured', 'Configurado - No verificado');
                }
                
                console.log('‚úÖ Calendario renderizado');
                
            } catch (error) {
                console.error('‚ùå Error renderizando calendario:', error);
            }
        }

        // ==========================================
        // CONFIGURAR EVENT LISTENERS
        // ==========================================
        function setupEventListeners() {
            // Bot√≥n cambiar contrase√±a
            const btnChangePassword = document.getElementById('btn-change-password');
            if (btnChangePassword) {
                btnChangePassword.addEventListener('click', function() {
                    // Abrir modal de config.js
                    const modal = new bootstrap.Modal(document.getElementById('change-password-modal'));
                    modal.show();
                });
            }
            
            // Bot√≥n probar conexi√≥n
            const btnTestConnection = document.getElementById('btn-test-connection');
            if (btnTestConnection) {
                btnTestConnection.addEventListener('click', probarConexionCalendario);
            }
            
            // Bot√≥n guardar calendario
            const btnSaveCalendar = document.getElementById('btn-save-calendar');
            if (btnSaveCalendar) {
                btnSaveCalendar.addEventListener('click', guardarConfiguracionCalendario);
            }
            
            // Validaci√≥n en tiempo real del Calendar ID
            const calendarInput = document.getElementById('alternative_calendar');
            if (calendarInput) {
                calendarInput.addEventListener('input', validarFormatoCalendarId);
            }
            
            console.log('‚úÖ Event listeners configurados');
        }

        // ==========================================
        // VALIDAR FORMATO CALENDAR ID
        // ==========================================
        function validarFormatoCalendarId(e) {
            const value = e.target.value.trim();
            const feedback = document.getElementById('calendar-feedback');
            
            // Formato v√°lido: email@domain.com o c_xxxxx@group.calendar.google.com
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (value === '') {
                // Vac√≠o es v√°lido
                e.target.classList.remove('is-invalid', 'is-valid');
                feedback.textContent = '';
                return true;
            }
            
            if (emailPattern.test(value)) {
                e.target.classList.remove('is-invalid');
                e.target.classList.add('is-valid');
                feedback.textContent = '';
                return true;
            } else {
                e.target.classList.remove('is-valid');
                e.target.classList.add('is-invalid');
                feedback.textContent = 'Formato inv√°lido. Debe ser un email v√°lido (ej: usuario@gmail.com)';
                return false;
            }
        }

    // ==========================================
        // PROBAR CONEXI√ìN AL CALENDARIO
        // ==========================================
        async function probarConexionCalendario() {
            const calendarInput = document.getElementById('alternative_calendar');
            const calendarId = calendarInput.value.trim();
            const btnTest = document.getElementById('btn-test-connection');
            
            // Validar que haya un valor
            if (!calendarId) {
                showMessage('Por favor ingresa un Calendar ID para probar', 'warning');
                return;
            }
            
            // Validar formato
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(calendarId)) {
                showMessage('Formato de Calendar ID inv√°lido', 'danger');
                return;
            }
            
            try {
                // Deshabilitar bot√≥n
                btnTest.disabled = true;
                btnTest.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Probando...';
                
                mostrarLoading('Verificando conexi√≥n con Google Calendar...');
                
                // TODO: AQU√ç VA LA LLAMADA A GOOGLE APPS SCRIPT
                // Por ahora simulamos la respuesta
                console.log('üîó Probando conexi√≥n a Calendar ID:', calendarId);
                
                // Simulaci√≥n de respuesta exitosa
                await sleep(2000); // Simular tiempo de conexi√≥n
                
                const mockResponse = {
                    success: true,
                    message: 'Conexi√≥n exitosa',
                    calendarName: 'Mi Calendario Personal'
                };
                
                if (mockResponse.success) {
                    actualizarEstadoConexion('connected', `Conectado: "${mockResponse.calendarName}"`);
                    showMessage(`‚úÖ ${mockResponse.message}. Calendario: "${mockResponse.calendarName}"`, 'success');
                } else {
                    actualizarEstadoConexion('error', 'Error de conexi√≥n');
                    showMessage('‚ùå ' + mockResponse.message, 'danger');
                }
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error probando conexi√≥n:', error);
                actualizarEstadoConexion('error', 'Error de conexi√≥n');
                showMessage('Error al probar conexi√≥n: ' + error.message, 'danger');
                ocultarLoading();
            } finally {
                // Rehabilitar bot√≥n
                btnTest.disabled = false;
                btnTest.innerHTML = '<i class="bi bi-wifi me-1"></i>Probar';
            }
        }

        // ==========================================
        // GUARDAR CONFIGURACI√ìN DE CALENDARIO
        // ==========================================
        async function guardarConfiguracionCalendario() {
            const calendarInput = document.getElementById('alternative_calendar');
            const calendarId = calendarInput.value.trim();
            const btnSave = document.getElementById('btn-save-calendar');
            
            // Validar formato si hay valor
            if (calendarId) {
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailPattern.test(calendarId)) {
                    showMessage('Formato de Calendar ID inv√°lido', 'danger');
                    return;
                }
            }
            
            try {
                // Deshabilitar bot√≥n
                btnSave.disabled = true;
                btnSave.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';
                
                mostrarLoading('Guardando configuraci√≥n...');
                
                // Actualizar en base de datos
                const updateData = {
                    alternative_calendar: calendarId || null
                };
                
                const response = await supabaseRequest(
                    `/workers?worker_id=eq.${workerData.worker_id}`,
                    'PATCH',
                    updateData
                );
                
                console.log('‚úÖ Calendar ID guardado:', calendarId);
                
                // Actualizar datos locales
                workerData.alternative_calendar = calendarId;
                
                // Actualizar estado visual
                if (calendarId) {
                    actualizarEstadoConexion('not-configured', 'Configurado - No verificado');
                } else {
                    actualizarEstadoConexion('not-configured', 'No configurado');
                }
                
                ocultarLoading();
                showMessage('‚úÖ Configuraci√≥n guardada correctamente', 'success');
                
            } catch (error) {
                console.error('‚ùå Error guardando configuraci√≥n:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
                ocultarLoading();
            } finally {
                // Rehabilitar bot√≥n
                btnSave.disabled = false;
                btnSave.innerHTML = '<i class="bi bi-save me-2"></i>Guardar Configuraci√≥n';
            }
        }

        // ==========================================
        // ACTUALIZAR ESTADO DE CONEXI√ìN
        // ==========================================
        function actualizarEstadoConexion(estado, texto) {
            const statusElement = document.getElementById('connection-status');
            
            // Remover todas las clases de estado
            statusElement.classList.remove('not-configured', 'connected', 'error');
            
            // Agregar nueva clase
            statusElement.classList.add(estado);
            
            // Actualizar icono y texto
            let iconClass = 'bi-circle';
            if (estado === 'connected') iconClass = 'bi-check-circle-fill';
            if (estado === 'error') iconClass = 'bi-x-circle-fill';
            
            statusElement.innerHTML = `
                <i class="bi ${iconClass} me-2"></i>
                ${texto}
            `;
        }

        // ==========================================
        // OBTENER INICIALES
        // ==========================================
        function obtenerIniciales(firstName, lastName) {
            const first = firstName ? firstName.charAt(0).toUpperCase() : '';
            const last = lastName ? lastName.charAt(0).toUpperCase() : '';
            return first + last || '??';
        }

        // ==========================================
        // UTILIDADES DE LOADING
        // ==========================================
        function mostrarLoading(texto = 'Cargando...') {
            document.getElementById('loadingText').textContent = texto;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        console.log('üéâ Mi Perfil cargado correctamente');
    </script>
</body>
</html>
