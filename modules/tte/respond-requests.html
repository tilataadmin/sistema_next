<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responder Solicitudes TTE - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #e83e8c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge-pendiente {
            background-color: #ffc107;
            color: #000;
        }

        .badge-proceso {
            background-color: #0dcaf0;
            color: #000;
        }

        .badge-cerrado {
            background-color: #198754;
            color: #fff;
        }

        .days-warning {
            color: #dc3545;
            font-weight: bold;
        }

        .days-ok {
            color: #198754;
        }

        .filter-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .request-row {
            cursor: pointer;
        }

        .request-row:hover {
            background-color: #f8f9fa;
        }

        .folio-badge {
            font-family: monospace;
            font-weight: bold;
            background-color: #e83e8c;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Tilat√° te Escucha</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Responder Solicitudes
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-reply me-2"></i>
                    Mis Solicitudes Asignadas
                </h1>
                <p class="text-muted">
                    Responder solicitudes PQR de tus categor√≠as asignadas
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- FILTROS -->
        <div class="filter-section">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Estado</label>
                    <select class="form-select" id="filter-status">
                        <option value="">Todos</option>
                        <option value="En proceso" selected>En proceso</option>
                        <option value="Cerrado">Cerrado</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Estado de Respuesta</label>
                    <select class="form-select" id="filter-response">
                        <option value="">Todos</option>
                        <option value="pending" selected>Sin respuesta</option>
                        <option value="draft">Respuesta propuesta</option>
                        <option value="approved">Respuesta aprobada</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button class="btn btn-primary" onclick="aplicarFiltros()">
                            <i class="bi bi-funnel me-1"></i>Filtrar
                        </button>
                        <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                            <i class="bi bi-x-circle me-1"></i>Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tarjeta de solicitudes -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-inbox me-2"></i>Solicitudes Asignadas
                    <span class="badge bg-secondary" id="total-requests">0</span>
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" onclick="cargarSolicitudes()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tabla-solicitudes">
                        <thead class="table-dark">
                            <tr>
                                <th>Folio</th>
                                <th>Fecha</th>
                                <th>Solicitante</th>
                                <th>Categor√≠a</th>
                                <th>Estado</th>
                                <th>D√≠as</th>
                                <th>Respuesta</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body">
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando solicitudes...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    <!-- MODAL DETALLE DE SOLICITUD -->
    <div class="modal fade" id="modal-detalle" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">
                        <i class="bi bi-file-text me-2"></i>Detalle de Solicitud
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <!-- SECCI√ìN 1: Informaci√≥n del Solicitante -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-person me-2"></i>Informaci√≥n del Solicitante
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Folio:</strong> <span class="folio-badge" id="detail-folio"></span></p>
                                    <p><strong>Tipo:</strong> <span id="detail-type"></span></p>
                                    <p><strong>Nombre:</strong> <span id="detail-name"></span></p>
                                    <p><strong>Email:</strong> <span id="detail-email"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Fecha:</strong> <span id="detail-date"></span></p>
                                    <p id="detail-student-row" style="display:none;"><strong>Estudiante:</strong> <span id="detail-student"></span></p>
                                    <p id="detail-course-row" style="display:none;"><strong>Curso:</strong> <span id="detail-course"></span></p>
                                    <p><strong>Estado:</strong> <span id="detail-status-badge"></span></p>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <p><strong>Mensaje:</strong></p>
                                    <div class="p-3 bg-light rounded" id="detail-message"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECCI√ìN 2: Comentarios Internos -->
                    <div class="card mb-3">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-chat-left-text me-2"></i>Comentarios Internos
                            </h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="mostrarFormComentario()">
                                <i class="bi bi-plus-circle me-1"></i>Agregar Comentario
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- Formulario agregar comentario -->
                            <div id="form-comentario" style="display:none;" class="mb-3">
                                <div class="mb-2">
                                    <label class="form-label">Nuevo Comentario</label>
                                    <textarea class="form-control" id="nuevo-comentario" rows="3" placeholder="Escribe tu comentario aqu√≠..."></textarea>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="guardarComentario()">
                                    <i class="bi bi-save me-1"></i>Guardar
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="cancelarComentario()">
                                    Cancelar
                                </button>
                            </div>

                            <!-- Lista de comentarios -->
                            <div id="lista-comentarios">
                                <p class="text-muted text-center">No hay comentarios internos a√∫n</p>
                            </div>
                        </div>
                    </div>

                    <!-- SECCI√ìN 3: Proponer Respuesta -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-reply me-2"></i>Respuesta al Usuario
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Ya existe respuesta propuesta -->
                            <div id="respuesta-existente" style="display:none;">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Ya propusiste una respuesta. Pendiente de aprobaci√≥n por el equipo TTE.</strong>
                                </div>
                                <div class="p-3 bg-light rounded mb-3" id="texto-respuesta-existente"></div>
                                <button class="btn btn-warning" onclick="editarRespuestaPropuesta()">
                                    <i class="bi bi-pencil me-1"></i>Editar Respuesta Propuesta
                                </button>
                            </div>

                            <!-- Ya fue aprobada -->
                            <div id="respuesta-aprobada" style="display:none;">
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <strong>Esta respuesta fue aprobada y enviada al usuario</strong>
                                </div>
                                <div class="p-3 bg-light rounded" id="texto-respuesta-aprobada"></div>
                            </div>

                            <!-- Formulario para proponer respuesta -->
                            <div id="form-respuesta" style="display:none;">
                                <div class="mb-3">
                                    <label class="form-label">Proponer Respuesta al Usuario</label>
                                    <textarea class="form-control" id="texto-respuesta" rows="6" placeholder="Escribe tu propuesta de respuesta..."></textarea>
                                    <small class="text-muted">Esta respuesta ser√° revisada y aprobada por el equipo TTE antes de ser enviada al usuario.</small>
                                </div>
                                <button class="btn btn-primary" onclick="proponerRespuesta()">
                                    <i class="bi bi-send me-1"></i>Proponer Respuesta
                                </button>
                                <button class="btn btn-secondary" onclick="cancelarRespuesta()">
                                    Cancelar
                                </button>
                            </div>

                            <!-- Bot√≥n inicial para proponer -->
                            <div id="btn-proponer-inicial">
                                <button class="btn btn-primary" onclick="mostrarFormRespuesta()">
                                    <i class="bi bi-reply me-1"></i>Proponer Respuesta
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let solicitudesCache = [];
        let cursosCache = [];
        let modalInstance = null;
        let solicitudActual = null;
        let comentariosActuales = [];
        let userEmail = null;
      // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Responder solicitudes TTE');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // INICIALIZACI√ìN DE P√ÅGINA
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Obtener email del usuario actual
                const session = getStoredSession();
                if (!session || !session.user) {
                    throw new Error('No hay sesi√≥n activa');
                }
                userEmail = session.user.user_mail;
                
                // Inicializar modal
                modalInstance = new bootstrap.Modal(document.getElementById('modal-detalle'));
                
                // Cargar cursos
                await cargarCursos();
                
                // Cargar solicitudes
                await cargarSolicitudes();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR CURSOS
        // ==========================================
        async function cargarCursos() {
            try {
                const cursos = await supabaseRequest('/courses?select=course_id,course_name,grades(grade_name,sections(section_name))&course_status=eq.active&order=course_order.asc');
                cursosCache = cursos || [];
                console.log(`‚úÖ ${cursos.length} cursos cargados`);
            } catch (error) {
                console.error('‚ùå Error cargando cursos:', error);
            }
        }
        
        // ==========================================
        // CARGAR SOLICITUDES - FILTRADAS POR RESPONSABLE
        // ==========================================
        async function cargarSolicitudes() {
            try {
                console.log('üì° Cargando solicitudes asignadas...');
                
                // Obtener categor√≠as donde soy responsable
                const categoriasResponsable = await supabaseRequest(`/tte_categories?select=category_id&responsible_email=eq.${userEmail}`);
                
                if (!categoriasResponsable || categoriasResponsable.length === 0) {
                    solicitudesCache = [];
                    renderizarTabla([]);
                    document.getElementById('total-requests').textContent = '0';
                    showMessage('No tienes categor√≠as asignadas como responsable', 'info');
                    console.log('‚ö†Ô∏è No hay categor√≠as asignadas a este usuario');
                    return;
                }
                
                const categoryIds = categoriasResponsable.map(c => c.category_id);
                
                // Obtener solicitudes de esas categor√≠as
                const solicitudes = await supabaseRequest(`/tte_requests?select=*,tte_categories(category_name),tte_priorities(priority_name,max_response_days)&category_id=in.(${categoryIds.join(',')})&order=created_at.desc`);
                
                solicitudesCache = solicitudes || [];
                renderizarTabla(solicitudesCache);
                
                document.getElementById('total-requests').textContent = solicitudesCache.length;
                console.log(`‚úÖ ${solicitudesCache.length} solicitudes cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando solicitudes:', error);
                showMessage('Error al cargar solicitudes: ' + error.message, 'danger');
                
                document.getElementById('tabla-body').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-exclamation-triangle text-warning"></i>
                            <div class="mt-2">Error al cargar datos</div>
                        </td>
                    </tr>
                `;
            }
        }
        
        // ==========================================
        // RENDERIZAR TABLA
        // ==========================================
        function renderizarTabla(solicitudes) {
            const tbody = document.getElementById('tabla-body');
            
            if (!solicitudes || solicitudes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-inbox"></i>
                            <div class="mt-2">No hay solicitudes asignadas</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = solicitudes.map(sol => {
                // Badges de estado
                let estadoBadge = '';
                if (sol.status === 'Pendiente') estadoBadge = '<span class="badge badge-pendiente">Pendiente</span>';
                else if (sol.status === 'En proceso') estadoBadge = '<span class="badge badge-proceso">En proceso</span>';
                else if (sol.status === 'Cerrado') estadoBadge = '<span class="badge badge-cerrado">Cerrado</span>';
                
                // Badge de estado de respuesta
                let respuestaBadge = '';
                if (sol.response_status === 'pending') respuestaBadge = '<span class="badge bg-secondary">Sin respuesta</span>';
                else if (sol.response_status === 'draft') respuestaBadge = '<span class="badge bg-warning text-dark">Propuesta</span>';
                else if (sol.response_status === 'approved') respuestaBadge = '<span class="badge bg-success">Aprobada</span>';
                
                // Calcular d√≠as transcurridos
                const fechaCreacion = new Date(sol.created_at);
                const hoy = new Date();
                const diasTranscurridos = Math.floor((hoy - fechaCreacion) / (1000 * 60 * 60 * 24));
                
                // Comparar con d√≠as m√°ximos si tiene prioridad
                let diasHtml = `<span>${diasTranscurridos}</span>`;
                if (sol.tte_priorities && sol.tte_priorities.max_response_days) {
                    const maxDias = sol.tte_priorities.max_response_days;
                    if (diasTranscurridos > maxDias) {
                        diasHtml = `<span class="days-warning">${diasTranscurridos}/${maxDias}</span>`;
                    } else {
                        diasHtml = `<span class="days-ok">${diasTranscurridos}/${maxDias}</span>`;
                    }
                }
                
                const fecha = formatDate(sol.created_at);
                const categoria = sol.tte_categories?.category_name || 'Sin categor√≠a';
                
                return `
                    <tr class="request-row" onclick="verDetalle('${sol.request_id}')">
                        <td><span class="folio-badge">${escapeHtml(sol.request_folio)}</span></td>
                        <td>${fecha}</td>
                        <td>${escapeHtml(sol.requester_name)}</td>
                        <td>${categoria}</td>
                        <td>${estadoBadge}</td>
                        <td>${diasHtml}</td>
                        <td>${respuestaBadge}</td>
                    </tr>
                `;
            }).join('');
        }
      // ==========================================
        // APLICAR FILTROS
        // ==========================================
        function aplicarFiltros() {
            const filterStatus = document.getElementById('filter-status').value;
            const filterResponse = document.getElementById('filter-response').value;
            
            let filtradas = solicitudesCache;
            
            if (filterStatus) {
                filtradas = filtradas.filter(s => s.status === filterStatus);
            }
            
            if (filterResponse) {
                filtradas = filtradas.filter(s => s.response_status === filterResponse);
            }
            
            renderizarTabla(filtradas);
            document.getElementById('total-requests').textContent = filtradas.length;
        }
        
        // ==========================================
        // LIMPIAR FILTROS
        // ==========================================
        function limpiarFiltros() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-response').value = '';
            
            renderizarTabla(solicitudesCache);
            document.getElementById('total-requests').textContent = solicitudesCache.length;
        }
        
        // ==========================================
        // VER DETALLE DE SOLICITUD
        // ==========================================
        async function verDetalle(requestId) {
            try {
                mostrarLoading();
                
                const solicitud = solicitudesCache.find(s => s.request_id === requestId);
                
                if (!solicitud) {
                    showMessage('Solicitud no encontrada', 'danger');
                    return;
                }
                
                solicitudActual = solicitud;
                
                // Llenar informaci√≥n del solicitante
                document.getElementById('detail-folio').textContent = solicitud.request_folio;
                document.getElementById('detail-type').textContent = solicitud.requester_type;
                document.getElementById('detail-name').textContent = solicitud.requester_name;
                document.getElementById('detail-email').textContent = solicitud.requester_email;
                document.getElementById('detail-date').textContent = formatDate(solicitud.created_at);
                document.getElementById('detail-message').textContent = solicitud.message;
                
                // Badge de estado
                let estadoBadge = '';
                if (solicitud.status === 'Pendiente') estadoBadge = '<span class="badge badge-pendiente">Pendiente</span>';
                else if (solicitud.status === 'En proceso') estadoBadge = '<span class="badge badge-proceso">En proceso</span>';
                else if (solicitud.status === 'Cerrado') estadoBadge = '<span class="badge badge-cerrado">Cerrado</span>';
                document.getElementById('detail-status-badge').innerHTML = estadoBadge;
                
                // Campos condicionales
                if (solicitud.student_name) {
                    document.getElementById('detail-student-row').style.display = 'block';
                    document.getElementById('detail-student').textContent = solicitud.student_name;
                } else {
                    document.getElementById('detail-student-row').style.display = 'none';
                }
                
                if (solicitud.course_id) {
                    const curso = cursosCache.find(c => c.course_id === solicitud.course_id);
                    if (curso) {
                        document.getElementById('detail-course-row').style.display = 'block';
                        const nombreCurso = `${curso.grades?.sections?.section_name || ''} - ${curso.grades?.grade_name || ''} ${curso.course_name}`.trim();
                        document.getElementById('detail-course').textContent = nombreCurso;
                    } else {
                        document.getElementById('detail-course-row').style.display = 'none';
                    }
                } else {
                    document.getElementById('detail-course-row').style.display = 'none';
                }
                
                // Cargar comentarios
                await cargarComentarios(requestId);
                
                // Mostrar secci√≥n de respuesta seg√∫n estado
                mostrarSeccionRespuesta(solicitud);
                
                modalInstance.show();
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error cargando detalle:', error);
                showMessage('Error al cargar detalle de la solicitud', 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR COMENTARIOS
        // ==========================================
        async function cargarComentarios(requestId) {
            try {
                const comentarios = await supabaseRequest(`/tte_request_comments?select=*,workers(worker_first_name,worker_last_name_1,worker_last_name_2)&request_id=eq.${requestId}&order=created_at.desc`);
                
                comentariosActuales = comentarios || [];
                
                const listaComentarios = document.getElementById('lista-comentarios');
                
                if (comentarios.length === 0) {
                    listaComentarios.innerHTML = '<p class="text-muted text-center">No hay comentarios internos a√∫n</p>';
                    return;
                }
                
                listaComentarios.innerHTML = comentarios.map(com => {
                    const nombreWorker = `${com.workers.worker_first_name} ${com.workers.worker_last_name_1} ${com.workers.worker_last_name_2 || ''}`.trim();
                    const fecha = formatDate(com.created_at);
                    
                    return `
                        <div class="border-bottom pb-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <strong class="text-primary">${escapeHtml(nombreWorker)}</strong>
                                <small class="text-muted">${fecha}</small>
                            </div>
                            <p class="mb-0">${escapeHtml(com.comment_text)}</p>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('‚ùå Error cargando comentarios:', error);
            }
        }
      // ==========================================
        // MOSTRAR FORMULARIO COMENTARIO
        // ==========================================
        function mostrarFormComentario() {
            document.getElementById('form-comentario').style.display = 'block';
            document.getElementById('nuevo-comentario').focus();
        }
        
        function cancelarComentario() {
            document.getElementById('form-comentario').style.display = 'none';
            document.getElementById('nuevo-comentario').value = '';
        }
        
        // ==========================================
        // GUARDAR COMENTARIO
        // ==========================================
        async function guardarComentario() {
            try {
                const comentarioTexto = document.getElementById('nuevo-comentario').value.trim();
                
                if (!comentarioTexto) {
                    showMessage('Debes escribir un comentario', 'warning');
                    return;
                }
                
                mostrarLoading();
                
                const session = getStoredSession();
                const workerData = await supabaseRequest(`/workers?select=worker_id&email=eq.${session.user.user_mail}&limit=1`);
                
                if (!workerData || workerData.length === 0) {
                    throw new Error('No se encontr√≥ el trabajador asociado');
                }
                
                const datos = {
                    request_id: solicitudActual.request_id,
                    worker_id: workerData[0].worker_id,
                    comment_text: comentarioTexto
                };
                
                await supabaseRequest('/tte_request_comments', {
                    method: 'POST',
                    body: JSON.stringify(datos)
                });
                
                showMessage('Comentario agregado exitosamente', 'success');
                
                await cargarComentarios(solicitudActual.request_id);
                cancelarComentario();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error guardando comentario:', error);
                showMessage('Error al guardar comentario: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // MOSTRAR SECCI√ìN DE RESPUESTA
        // ==========================================
        function mostrarSeccionRespuesta(solicitud) {
            // Ocultar todas las secciones
            document.getElementById('respuesta-existente').style.display = 'none';
            document.getElementById('respuesta-aprobada').style.display = 'none';
            document.getElementById('form-respuesta').style.display = 'none';
            document.getElementById('btn-proponer-inicial').style.display = 'none';
            
            if (solicitud.response_status === 'approved') {
                // Respuesta ya aprobada
                document.getElementById('respuesta-aprobada').style.display = 'block';
                document.getElementById('texto-respuesta-aprobada').textContent = solicitud.response_text || '';
            } else if (solicitud.response_status === 'draft') {
                // Ya existe respuesta propuesta
                document.getElementById('respuesta-existente').style.display = 'block';
                document.getElementById('texto-respuesta-existente').textContent = solicitud.response_text || '';
            } else {
                // Sin respuesta - mostrar bot√≥n
                document.getElementById('btn-proponer-inicial').style.display = 'block';
            }
        }
        
        // ==========================================
        // MOSTRAR FORMULARIO DE RESPUESTA
        // ==========================================
        function mostrarFormRespuesta() {
            document.getElementById('btn-proponer-inicial').style.display = 'none';
            document.getElementById('form-respuesta').style.display = 'block';
            document.getElementById('texto-respuesta').value = '';
        }
        
        function cancelarRespuesta() {
            document.getElementById('form-respuesta').style.display = 'none';
            document.getElementById('btn-proponer-inicial').style.display = 'block';
        }
        
        // ==========================================
        // EDITAR RESPUESTA PROPUESTA
        // ==========================================
        function editarRespuestaPropuesta() {
            document.getElementById('respuesta-existente').style.display = 'none';
            document.getElementById('form-respuesta').style.display = 'block';
            document.getElementById('texto-respuesta').value = solicitudActual.response_text || '';
        }
        
        // ==========================================
        // PROPONER RESPUESTA
        // ==========================================
        async function proponerRespuesta() {
            const respuestaTexto = document.getElementById('texto-respuesta').value.trim();
            
            if (!respuestaTexto) {
                showMessage('Debes escribir una respuesta', 'warning');
                return;
            }
            
            if (!confirm('¬øProponer esta respuesta?\n\nSer√° revisada por el equipo TTE antes de ser enviada al usuario.')) {
                return;
            }
            
            try {
                mostrarLoading();
                
                await supabaseRequest(`/tte_requests?request_id=eq.${solicitudActual.request_id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        response_text: respuestaTexto,
                        response_status: 'draft'
                    })
                });
                
                showMessage('Respuesta propuesta exitosamente. Pendiente de aprobaci√≥n.', 'success');
                
                // Recargar solicitudes y cerrar modal
                await cargarSolicitudes();
                modalInstance.hide();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error proponiendo respuesta:', error);
                showMessage('Error al proponer respuesta: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
      // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.cargarSolicitudes = cargarSolicitudes;
        window.aplicarFiltros = aplicarFiltros;
        window.limpiarFiltros = limpiarFiltros;
        window.verDetalle = verDetalle;
        window.mostrarFormComentario = mostrarFormComentario;
        window.cancelarComentario = cancelarComentario;
        window.guardarComentario = guardarComentario;
        window.mostrarFormRespuesta = mostrarFormRespuesta;
        window.cancelarRespuesta = cancelarRespuesta;
        window.editarRespuestaPropuesta = editarRespuestaPropuesta;
        window.proponerRespuesta = proponerRespuesta;
        
        console.log('‚úÖ P√°gina de responder solicitudes TTE cargada correctamente');
    </script>
</body>
</html>
