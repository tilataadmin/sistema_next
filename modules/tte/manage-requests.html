<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Solicitudes TTE - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #e83e8c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge-pendiente {
            background-color: #ffc107;
            color: #000;
        }

        .badge-proceso {
            background-color: #0dcaf0;
            color: #000;
        }

        .badge-cerrado {
            background-color: #198754;
            color: #fff;
        }

        .badge-positivo {
            background-color: #d4edda;
            color: #155724;
        }

        .badge-neutro {
            background-color: #fff3cd;
            color: #856404;
        }

        .badge-negativo {
            background-color: #f8d7da;
            color: #721c24;
        }

        .days-warning {
            color: #dc3545;
            font-weight: bold;
        }

        .days-ok {
            color: #198754;
        }

        .filter-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .request-row {
            cursor: pointer;
        }

        .request-row:hover {
            background-color: #f8f9fa;
        }

        .folio-badge {
            font-family: monospace;
            font-weight: bold;
            background-color: #e83e8c;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Tilatá te Escucha</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gestión de Solicitudes
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE PÁGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-list-check me-2"></i>
                    Gestión de Solicitudes PQR
                </h1>
                <p class="text-muted">
                    Clasificar, hacer seguimiento y aprobar respuestas de solicitudes
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- FILTROS -->
        <div class="filter-section">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Estado</label>
                    <select class="form-select" id="filter-status">
                        <option value="">Todos</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="En proceso">En proceso</option>
                        <option value="Cerrado">Cerrado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tipo de Solicitante</label>
                    <select class="form-select" id="filter-type">
                        <option value="">Todos</option>
                        <option value="Estudiante">Estudiante</option>
                        <option value="Familia">Familia</option>
                        <option value="Trabajador">Trabajador</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Categoría</label>
                    <select class="form-select" id="filter-category">
                        <option value="">Todas</option>
                        <!-- Se cargan dinámicamente -->
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Estado de Respuesta</label>
                    <select class="form-select" id="filter-response">
                        <option value="">Todos</option>
                        <option value="pending">Sin respuesta</option>
                        <option value="draft">Respuesta propuesta</option>
                        <option value="approved">Respuesta aprobada</option>
                    </select>
                </div>
                <div class="col-12">
                    <button class="btn btn-primary" onclick="aplicarFiltros()">
                        <i class="bi bi-funnel me-1"></i>Filtrar
                    </button>
                    <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                        <i class="bi bi-x-circle me-1"></i>Limpiar
                    </button>
                </div>
            </div>
        </div>
        <!-- Tarjeta de solicitudes -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-inbox me-2"></i>Solicitudes PQR
                    <span class="badge bg-secondary" id="total-requests">0</span>
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" onclick="cargarSolicitudes()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tabla-solicitudes">
                        <thead class="table-dark">
                            <tr>
                                <th>Folio</th>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Solicitante</th>
                                <th>Categoría</th>
                                <th>Prioridad</th>
                                <th>Estado</th>
                                <th>Días</th>
                                <th>Respuesta</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body">
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando solicitudes...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL DETALLE DE SOLICITUD -->
    <div class="modal fade" id="modal-detalle" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">
                        <i class="bi bi-file-text me-2"></i>Detalle de Solicitud
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <!-- SECCIÓN 1: Información del Solicitante -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-person me-2"></i>Información del Solicitante
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Folio:</strong> <span class="folio-badge" id="detail-folio"></span></p>
                                    <p><strong>Tipo:</strong> <span id="detail-type"></span></p>
                                    <p><strong>Nombre:</strong> <span id="detail-name"></span></p>
                                    <p><strong>Email:</strong> <span id="detail-email"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Fecha:</strong> <span id="detail-date"></span></p>
                                    <p id="detail-student-row" style="display:none;"><strong>Estudiante:</strong> <span id="detail-student"></span></p>
                                    <p id="detail-course-row" style="display:none;"><strong>Curso:</strong> <span id="detail-course"></span></p>
                                    <p><strong>reCAPTCHA Score:</strong> <span id="detail-captcha"></span></p>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <p><strong>Mensaje:</strong></p>
                                    <div class="p-3 bg-light rounded" id="detail-message"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECCIÓN 2: Clasificación -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-tags me-2"></i>Clasificación
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="form-clasificacion">
                                <input type="hidden" id="request-id">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Categoría</label>
                                        <select class="form-select" id="detail-category">
                                            <option value="">Sin asignar</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Prioridad</label>
                                        <select class="form-select" id="detail-priority">
                                            <option value="">Sin asignar</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Tipología</label>
                                        <select class="form-select" id="detail-typology">
                                            <option value="">Sin definir</option>
                                            <option value="Positivo">Positivo</option>
                                            <option value="Neutro">Neutro</option>
                                            <option value="Negativo">Negativo</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Estado</label>
                                        <select class="form-select" id="detail-status">
                                            <option value="Pendiente">Pendiente</option>
                                            <option value="En proceso">En proceso</option>
                                            <option value="Cerrado">Cerrado</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <button type="button" class="btn btn-primary" onclick="guardarClasificacion()">
                                            <i class="bi bi-save me-1"></i>Guardar Clasificación
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- SECCIÓN 3: Comentarios Internos -->
                    <div class="card mb-3">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-chat-left-text me-2"></i>Comentarios Internos
                            </h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="mostrarFormComentario()">
                                <i class="bi bi-plus-circle me-1"></i>Agregar Comentario
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- Formulario agregar comentario (oculto por defecto) -->
                            <div id="form-comentario" style="display:none;" class="mb-3">
                                <div class="mb-2">
                                    <label class="form-label">Nuevo Comentario</label>
                                    <textarea class="form-control" id="nuevo-comentario" rows="3" placeholder="Escribe tu comentario aquí..."></textarea>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="guardarComentario()">
                                    <i class="bi bi-save me-1"></i>Guardar
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="cancelarComentario()">
                                    Cancelar
                                </button>
                            </div>

                            <!-- Lista de comentarios -->
                            <div id="lista-comentarios">
                                <p class="text-muted text-center">No hay comentarios internos aún</p>
                            </div>
                        </div>
                    </div>

                    <!-- SECCIÓN 4: Respuesta Final -->
                    <div class="card mb-3" id="seccion-respuesta">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-reply me-2"></i>Respuesta al Usuario
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Mostrar respuesta propuesta si existe -->
                            <div id="respuesta-propuesta" style="display:none;">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>El responsable ha propuesto una respuesta:</strong>
                                </div>
                                <div class="p-3 bg-light rounded mb-3" id="texto-respuesta-propuesta"></div>
                                <button class="btn btn-success" onclick="aprobarRespuesta()">
                                    <i class="bi bi-check-circle me-1"></i>Aprobar y Enviar al Usuario
                                </button>
                                <button class="btn btn-warning" onclick="editarRespuesta()">
                                    <i class="bi bi-pencil me-1"></i>Editar Respuesta
                                </button>
                            </div>

                            <!-- Formulario para editar/escribir respuesta -->
                            <div id="form-respuesta" style="display:none;">
                                <div class="mb-3">
                                    <label class="form-label">Respuesta al Usuario</label>
                                    <textarea class="form-control" id="texto-respuesta" rows="6" placeholder="Escribe la respuesta que se enviará al usuario..."></textarea>
                                </div>
                                <button class="btn btn-success" onclick="enviarRespuestaDirecta()">
                                    <i class="bi bi-send me-1"></i>Aprobar y Enviar al Usuario
                                </button>
                                <button class="btn btn-secondary" onclick="cancelarEdicionRespuesta()">
                                    Cancelar
                                </button>
                            </div>

                            <!-- Si ya está cerrada y aprobada -->
                            <div id="respuesta-enviada" style="display:none;">
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <strong>Respuesta aprobada y enviada al usuario</strong>
                                </div>
                                <div class="p-3 bg-light rounded" id="texto-respuesta-enviada"></div>
                            </div>

                            <!-- Si no hay respuesta aún -->
                            <div id="sin-respuesta">
                                <p class="text-muted text-center">Sin respuesta aún. El responsable debe proponer una respuesta.</p>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let solicitudesCache = [];
        let categoriasCache = [];
        let prioridadesCache = [];
        let cursosCache = [];
        let modalInstance = null;
        let solicitudActual = null;
        let comentariosActuales = [];
      // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Gestionar solicitudes TTE');
                if (!hasAccess) {
                    console.log('❌ Acceso denegado');
                    return;
                }
                
                console.log('✅ Acceso permitido - continuando con inicialización');
                await inicializarPagina();
                
            } catch (error) {
                console.error('❌ Error en validación:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });
        
        // ==========================================
        // INICIALIZACIÓN DE PÁGINA
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Inicializar modal
                modalInstance = new bootstrap.Modal(document.getElementById('modal-detalle'));
                
                // Cargar datos necesarios
                await Promise.all([
                    cargarCategorias(),
                    cargarPrioridades(),
                    cargarCursos()
                ]);
                
                // Cargar solicitudes
                await cargarSolicitudes();
                
                ocultarLoading();
                console.log('✅ Página inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR CATEGORÍAS
        // ==========================================
        async function cargarCategorias() {
            try {
                const categorias = await supabaseRequest('/tte_categories?select=*&category_status=eq.active&order=category_name.asc');
                categoriasCache = categorias || [];
                
                // Llenar filtro
                const filterSelect = document.getElementById('filter-category');
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.category_id;
                    option.textContent = cat.category_name;
                    filterSelect.appendChild(option);
                });
                
                // Llenar select del modal
                const detailSelect = document.getElementById('detail-category');
                detailSelect.innerHTML = '<option value="">Sin asignar</option>';
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.category_id;
                    option.textContent = cat.category_name;
                    detailSelect.appendChild(option);
                });
                
                console.log(`✅ ${categorias.length} categorías cargadas`);
                
            } catch (error) {
                console.error('❌ Error cargando categorías:', error);
            }
        }
        
        // ==========================================
        // CARGAR PRIORIDADES
        // ==========================================
        async function cargarPrioridades() {
            try {
                const prioridades = await supabaseRequest('/tte_priorities?select=*&priority_status=eq.active&order=priority_order.asc');
                prioridadesCache = prioridades || [];
                
                // Llenar select del modal
                const detailSelect = document.getElementById('detail-priority');
                detailSelect.innerHTML = '<option value="">Sin asignar</option>';
                prioridades.forEach(prio => {
                    const option = document.createElement('option');
                    option.value = prio.priority_id;
                    option.textContent = `${prio.priority_name} (${prio.max_response_days} días)`;
                    detailSelect.appendChild(option);
                });
                
                console.log(`✅ ${prioridades.length} prioridades cargadas`);
                
            } catch (error) {
                console.error('❌ Error cargando prioridades:', error);
            }
        }
        
        // ==========================================
        // CARGAR CURSOS
        // ==========================================
        async function cargarCursos() {
            try {
                const cursos = await supabaseRequest('/courses?select=course_id,course_name,grades(grade_name,sections(section_name))&course_status=eq.active&order=course_order.asc');
                cursosCache = cursos || [];
                console.log(`✅ ${cursos.length} cursos cargados`);
            } catch (error) {
                console.error('❌ Error cargando cursos:', error);
            }
        }
        
        // ==========================================
        // CARGAR SOLICITUDES
        // ==========================================
        async function cargarSolicitudes() {
            try {
                console.log('📡 Cargando solicitudes...');
                
                const solicitudes = await supabaseRequest('/tte_requests?select=*,tte_categories(category_name),tte_priorities(priority_name,max_response_days)&order=created_at.desc');
                
                solicitudesCache = solicitudes || [];
                renderizarTabla(solicitudesCache);
                
                document.getElementById('total-requests').textContent = solicitudesCache.length;
                console.log(`✅ ${solicitudesCache.length} solicitudes cargadas`);
                
            } catch (error) {
                console.error('❌ Error cargando solicitudes:', error);
                showMessage('Error al cargar solicitudes: ' + error.message, 'danger');
                
                document.getElementById('tabla-body').innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="bi bi-exclamation-triangle text-warning"></i>
                            <div class="mt-2">Error al cargar datos</div>
                        </td>
                    </tr>
                `;
            }
        }
      // ==========================================
        // RENDERIZAR TABLA
        // ==========================================
        function renderizarTabla(solicitudes) {
            const tbody = document.getElementById('tabla-body');
            
            if (!solicitudes || solicitudes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="bi bi-inbox"></i>
                            <div class="mt-2">No hay solicitudes</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = solicitudes.map(sol => {
                // Badges de estado
                let estadoBadge = '';
                if (sol.status === 'Pendiente') estadoBadge = '<span class="badge badge-pendiente">Pendiente</span>';
                else if (sol.status === 'En proceso') estadoBadge = '<span class="badge badge-proceso">En proceso</span>';
                else if (sol.status === 'Cerrado') estadoBadge = '<span class="badge badge-cerrado">Cerrado</span>';
                
                // Badge de estado de respuesta
                let respuestaBadge = '';
                if (sol.response_status === 'pending') respuestaBadge = '<span class="badge bg-secondary">Sin respuesta</span>';
                else if (sol.response_status === 'draft') respuestaBadge = '<span class="badge bg-warning text-dark">Propuesta</span>';
                else if (sol.response_status === 'approved') respuestaBadge = '<span class="badge bg-success">Aprobada</span>';
                
                // Calcular días transcurridos
                const fechaCreacion = new Date(sol.created_at);
                const hoy = new Date();
                const diasTranscurridos = Math.floor((hoy - fechaCreacion) / (1000 * 60 * 60 * 24));
                
                // Comparar con días máximos si tiene prioridad
                let diasHtml = `<span>${diasTranscurridos}</span>`;
                if (sol.tte_priorities && sol.tte_priorities.max_response_days) {
                    const maxDias = sol.tte_priorities.max_response_days;
                    if (diasTranscurridos > maxDias) {
                        diasHtml = `<span class="days-warning">${diasTranscurridos}/${maxDias}</span>`;
                    } else {
                        diasHtml = `<span class="days-ok">${diasTranscurridos}/${maxDias}</span>`;
                    }
                }
                
                const fecha = formatDate(sol.created_at);
                const categoria = sol.tte_categories?.category_name || '<span class="text-muted">Sin asignar</span>';
                const prioridad = sol.tte_priorities?.priority_name || '<span class="text-muted">Sin asignar</span>';
                
                return `
                    <tr class="request-row" onclick="verDetalle('${sol.request_id}')">
                        <td><span class="folio-badge">${escapeHtml(sol.request_folio)}</span></td>
                        <td>${fecha}</td>
                        <td>${escapeHtml(sol.requester_type)}</td>
                        <td>${escapeHtml(sol.requester_name)}</td>
                        <td>${categoria}</td>
                        <td>${prioridad}</td>
                        <td>${estadoBadge}</td>
                        <td>${diasHtml}</td>
                        <td>${respuestaBadge}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // ==========================================
        // APLICAR FILTROS
        // ==========================================
        function aplicarFiltros() {
            const filterStatus = document.getElementById('filter-status').value;
            const filterType = document.getElementById('filter-type').value;
            const filterCategory = document.getElementById('filter-category').value;
            const filterResponse = document.getElementById('filter-response').value;
            
            let filtradas = solicitudesCache;
            
            if (filterStatus) {
                filtradas = filtradas.filter(s => s.status === filterStatus);
            }
            
            if (filterType) {
                filtradas = filtradas.filter(s => s.requester_type === filterType);
            }
            
            if (filterCategory) {
                filtradas = filtradas.filter(s => s.category_id === filterCategory);
            }
            
            if (filterResponse) {
                filtradas = filtradas.filter(s => s.response_status === filterResponse);
            }
            
            renderizarTabla(filtradas);
            document.getElementById('total-requests').textContent = filtradas.length;
        }
        
        // ==========================================
        // LIMPIAR FILTROS
        // ==========================================
        function limpiarFiltros() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-response').value = '';
            
            renderizarTabla(solicitudesCache);
            document.getElementById('total-requests').textContent = solicitudesCache.length;
        }
      // ==========================================
        // VER DETALLE DE SOLICITUD
        // ==========================================
        async function verDetalle(requestId) {
            try {
                mostrarLoading();
                
                // Buscar solicitud en cache
                const solicitud = solicitudesCache.find(s => s.request_id === requestId);
                
                if (!solicitud) {
                    showMessage('Solicitud no encontrada', 'danger');
                    return;
                }
                
                solicitudActual = solicitud;
                
                // Llenar información del solicitante
                document.getElementById('detail-folio').textContent = solicitud.request_folio;
                document.getElementById('detail-type').textContent = solicitud.requester_type;
                document.getElementById('detail-name').textContent = solicitud.requester_name;
                document.getElementById('detail-email').textContent = solicitud.requester_email;
                document.getElementById('detail-date').textContent = formatDate(solicitud.created_at);
                document.getElementById('detail-message').textContent = solicitud.message;
                document.getElementById('detail-captcha').textContent = solicitud.recaptcha_score || 'N/A';
                
                // Mostrar campos condicionales
                if (solicitud.student_name) {
                    document.getElementById('detail-student-row').style.display = 'block';
                    document.getElementById('detail-student').textContent = solicitud.student_name;
                } else {
                    document.getElementById('detail-student-row').style.display = 'none';
                }
                
                if (solicitud.course_id) {
                    const curso = cursosCache.find(c => c.course_id === solicitud.course_id);
                    if (curso) {
                        document.getElementById('detail-course-row').style.display = 'block';
                        const nombreCurso = `${curso.grades?.sections?.section_name || ''} - ${curso.grades?.grade_name || ''} ${curso.course_name}`.trim();
                        document.getElementById('detail-course').textContent = nombreCurso;
                    } else {
                        document.getElementById('detail-course-row').style.display = 'none';
                    }
                } else {
                    document.getElementById('detail-course-row').style.display = 'none';
                }
                
                // Llenar clasificación
                document.getElementById('request-id').value = solicitud.request_id;
                document.getElementById('detail-category').value = solicitud.category_id || '';
                document.getElementById('detail-priority').value = solicitud.priority_id || '';
                document.getElementById('detail-typology').value = solicitud.typology || '';
                document.getElementById('detail-status').value = solicitud.status;
                
                // Cargar comentarios
                await cargarComentarios(requestId);
                
                // Mostrar sección de respuesta según estado
                mostrarSeccionRespuesta(solicitud);
                
                modalInstance.show();
                ocultarLoading();
                
            } catch (error) {
                console.error('❌ Error cargando detalle:', error);
                showMessage('Error al cargar detalle de la solicitud', 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // GUARDAR CLASIFICACIÓN
        // ==========================================
        async function guardarClasificacion() {
            try {
                mostrarLoading();
                
                const requestId = document.getElementById('request-id').value;
                const datos = {
                    category_id: document.getElementById('detail-category').value || null,
                    priority_id: document.getElementById('detail-priority').value || null,
                    typology: document.getElementById('detail-typology').value || null,
                    status: document.getElementById('detail-status').value
                };
                
                await supabaseRequest(`/tte_requests?request_id=eq.${requestId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(datos)
                });
                
                showMessage('Clasificación guardada exitosamente', 'success');
                
                // Recargar solicitudes
                await cargarSolicitudes();
                
                // Actualizar solicitud actual
                solicitudActual = solicitudesCache.find(s => s.request_id === requestId);
                
                ocultarLoading();
                
            } catch (error) {
                console.error('❌ Error guardando clasificación:', error);
                showMessage('Error al guardar clasificación: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR COMENTARIOS
        // ==========================================
        async function cargarComentarios(requestId) {
            try {
                const comentarios = await supabaseRequest(`/tte_request_comments?select=*,workers(worker_first_name,worker_last_name_1,worker_last_name_2)&request_id=eq.${requestId}&order=created_at.desc`);
                
                comentariosActuales = comentarios || [];
                
                const listaComentarios = document.getElementById('lista-comentarios');
                
                if (comentarios.length === 0) {
                    listaComentarios.innerHTML = '<p class="text-muted text-center">No hay comentarios internos aún</p>';
                    return;
                }
                
                listaComentarios.innerHTML = comentarios.map(com => {
                    const nombreWorker = `${com.workers.worker_first_name} ${com.workers.worker_last_name_1} ${com.workers.worker_last_name_2 || ''}`.trim();
                    const fecha = formatDate(com.created_at);
                    
                    return `
                        <div class="border-bottom pb-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <strong class="text-primary">${escapeHtml(nombreWorker)}</strong>
                                <small class="text-muted">${fecha}</small>
                            </div>
                            <p class="mb-0">${escapeHtml(com.comment_text)}</p>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('❌ Error cargando comentarios:', error);
            }
        }
        
        // ==========================================
        // MOSTRAR FORMULARIO COMENTARIO
        // ==========================================
        function mostrarFormComentario() {
            document.getElementById('form-comentario').style.display = 'block';
            document.getElementById('nuevo-comentario').focus();
        }
        
        function cancelarComentario() {
            document.getElementById('form-comentario').style.display = 'none';
            document.getElementById('nuevo-comentario').value = '';
        }
        
        // ==========================================
        // GUARDAR COMENTARIO
        // ==========================================
        async function guardarComentario() {
            try {
                const comentarioTexto = document.getElementById('nuevo-comentario').value.trim();
                
                if (!comentarioTexto) {
                    showMessage('Debes escribir un comentario', 'warning');
                    return;
                }
                
                mostrarLoading();
                
                const session = getStoredSession();
                const workerData = await supabaseRequest(`/workers?select=worker_id&email=eq.${session.user.user_mail}&limit=1`);
                
                if (!workerData || workerData.length === 0) {
                    throw new Error('No se encontró el trabajador asociado');
                }
                
                const datos = {
                    request_id: solicitudActual.request_id,
                    worker_id: workerData[0].worker_id,
                    comment_text: comentarioTexto
                };
                
                await supabaseRequest('/tte_request_comments', {
                    method: 'POST',
                    body: JSON.stringify(datos)
                });
                
                showMessage('Comentario agregado exitosamente', 'success');
                
                // Recargar comentarios
                await cargarComentarios(solicitudActual.request_id);
                
                // Limpiar formulario
                cancelarComentario();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('❌ Error guardando comentario:', error);
                showMessage('Error al guardar comentario: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
      // ==========================================
        // MOSTRAR SECCIÓN DE RESPUESTA
        // ==========================================
        function mostrarSeccionRespuesta(solicitud) {
            // Ocultar todas las secciones primero
            document.getElementById('respuesta-propuesta').style.display = 'none';
            document.getElementById('form-respuesta').style.display = 'none';
            document.getElementById('respuesta-enviada').style.display = 'none';
            document.getElementById('sin-respuesta').style.display = 'none';
            
            if (solicitud.response_status === 'approved') {
                // Respuesta ya aprobada y enviada
                document.getElementById('respuesta-enviada').style.display = 'block';
                document.getElementById('texto-respuesta-enviada').textContent = solicitud.response_text || '';
            } else if (solicitud.response_status === 'draft') {
                // Hay respuesta propuesta por el responsable
                document.getElementById('respuesta-propuesta').style.display = 'block';
                document.getElementById('texto-respuesta-propuesta').textContent = solicitud.response_text || '';
            } else {
                // Sin respuesta aún
                document.getElementById('sin-respuesta').style.display = 'block';
            }
        }
        
        // ==========================================
        // EDITAR RESPUESTA
        // ==========================================
        function editarRespuesta() {
            document.getElementById('respuesta-propuesta').style.display = 'none';
            document.getElementById('form-respuesta').style.display = 'block';
            document.getElementById('texto-respuesta').value = solicitudActual.response_text || '';
        }
        
        function cancelarEdicionRespuesta() {
            document.getElementById('form-respuesta').style.display = 'none';
            mostrarSeccionRespuesta(solicitudActual);
        }
        
        // ==========================================
        // APROBAR RESPUESTA (SIN EDITAR)
        // ==========================================
        async function aprobarRespuesta() {
            if (!confirm('¿Aprobar y enviar esta respuesta al usuario?\n\nSe enviará un email con la respuesta y la solicitud se cerrará.')) {
                return;
            }
            
            try {
                mostrarLoading();
                
                // Actualizar estado en BD
                await supabaseRequest(`/tte_requests?request_id=eq.${solicitudActual.request_id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        response_status: 'approved',
                        status: 'Cerrado',
                        closed_at: new Date().toISOString()
                    })
                });
                
                // Enviar email al usuario
                await enviarEmailRespuesta(solicitudActual);
                
                showMessage('Respuesta aprobada y enviada exitosamente', 'success');
                
                // Recargar solicitudes y cerrar modal
                await cargarSolicitudes();
                modalInstance.hide();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('❌ Error aprobando respuesta:', error);
                showMessage('Error al aprobar respuesta: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // ENVIAR RESPUESTA DIRECTA (EDITADA O NUEVA)
        // ==========================================
        async function enviarRespuestaDirecta() {
            const respuestaTexto = document.getElementById('texto-respuesta').value.trim();
            
            if (!respuestaTexto) {
                showMessage('Debes escribir una respuesta', 'warning');
                return;
            }
            
            if (!confirm('¿Aprobar y enviar esta respuesta al usuario?\n\nSe enviará un email y la solicitud se cerrará.')) {
                return;
            }
            
            try {
                mostrarLoading();
                
                // Actualizar en BD
                await supabaseRequest(`/tte_requests?request_id=eq.${solicitudActual.request_id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        response_text: respuestaTexto,
                        response_status: 'approved',
                        status: 'Cerrado',
                        closed_at: new Date().toISOString()
                    })
                });
                
                // Actualizar solicitud actual para el email
                solicitudActual.response_text = respuestaTexto;
                
                // Enviar email
                await enviarEmailRespuesta(solicitudActual);
                
                showMessage('Respuesta enviada exitosamente', 'success');
                
                // Recargar y cerrar
                await cargarSolicitudes();
                modalInstance.hide();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('❌ Error enviando respuesta:', error);
                showMessage('Error al enviar respuesta: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // ENVIAR EMAIL DE RESPUESTA AL USUARIO
        // ==========================================
        async function enviarEmailRespuesta(solicitud) {
            try {
                const subject = `Respuesta a tu solicitud ${solicitud.request_folio} - Tilatá te Escucha`;
                
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <div style="background: linear-gradient(135deg, #e83e8c 0%, #d63384 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
                            <h1 style="color: white; margin: 0;">Tilatá te Escucha</h1>
                        </div>
                        
                        <div style="background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 10px 10px;">
                            <h2 style="color: #e83e8c; margin-top: 0;">Hemos respondido tu solicitud</h2>
                            
                            <p>Hola <strong>${escapeHtml(solicitud.requester_name)}</strong>,</p>
                            
                            <p>Gracias por contactarnos. Hemos revisado tu solicitud con folio <strong>${solicitud.request_folio}</strong> y queremos darte la siguiente respuesta:</p>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-left: 4px solid #e83e8c; margin: 20px 0;">
                                <p style="margin: 0; white-space: pre-wrap;">${escapeHtml(solicitud.response_text)}</p>
                            </div>
                            
                            <p>Si tienes alguna duda adicional, no dudes en contactarnos nuevamente.</p>
                            
                            <p style="color: #666; font-size: 14px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                                Este correo es generado automáticamente por SchoolNet.<br>
                                <strong>Colegio Tilatá</strong> - Tilatá te Escucha
                            </p>
                        </div>
                    </div>
                `;
                
                await sendNotification(solicitud.requester_email, subject, htmlContent, true);
                console.log('✅ Email de respuesta enviado a:', solicitud.requester_email);
                
            } catch (error) {
                console.error('⚠️ Error enviando email:', error);
                // No bloquear el flujo si falla el email
            }
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.cargarSolicitudes = cargarSolicitudes;
        window.aplicarFiltros = aplicarFiltros;
        window.limpiarFiltros = limpiarFiltros;
        window.verDetalle = verDetalle;
        window.guardarClasificacion = guardarClasificacion;
        window.mostrarFormComentario = mostrarFormComentario;
        window.cancelarComentario = cancelarComentario;
        window.guardarComentario = guardarComentario;
        window.editarRespuesta = editarRespuesta;
        window.cancelarEdicionRespuesta = cancelarEdicionRespuesta;
        window.aprobarRespuesta = aprobarRespuesta;
        window.enviarRespuestaDirecta = enviarRespuestaDirecta;
        
        console.log('✅ Página de gestión de solicitudes TTE cargada correctamente');
    </script>
</body>
</html>
