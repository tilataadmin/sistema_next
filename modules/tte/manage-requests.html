<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.03.17.05">
    <title>Gesti√≥n de Solicitudes TTE - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #e83e8c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge-pendiente {
            background-color: #ffc107;
            color: #000;
        }

        .badge-proceso {
            background-color: #0dcaf0;
            color: #000;
        }

        .badge-cerrado {
            background-color: #198754;
            color: #fff;
        }

        .badge-positivo {
            background-color: #d4edda;
            color: #155724;
        }

        .badge-neutro {
            background-color: #fff3cd;
            color: #856404;
        }

        .badge-negativo {
            background-color: #f8d7da;
            color: #721c24;
        }

        .days-warning {
            color: #dc3545;
            font-weight: bold;
        }

        .days-ok {
            color: #198754;
        }

        .filter-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .request-row {
            cursor: pointer;
        }

        .request-row:hover {
            background-color: #f8f9fa;
        }

        .folio-badge {
            font-family: monospace;
            font-weight: bold;
            background-color: #e83e8c;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        /* Estilos para fragmentos */
        .categoria-btn {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .categoria-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .fragmento-card {
            border-left: 4px solid #e83e8c;
            background: #f8f9fa;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            position: relative;
        }
        
        .fragmento-card .badge {
            font-size: 0.875rem;
        }
        
        .fragmento-text {
            background: white;
            padding: 0.75rem;
            border-radius: 4px;
            margin: 0.5rem 0;
            font-style: italic;
            border-left: 3px solid #dee2e6;
        }
        
        .fragmento-delete {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
        }
        
        #detail-message::selection {
            background-color: #ffe4f0;
            color: #000;
        }
        
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Tilat√° te Escucha</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gesti√≥n de Solicitudes
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-list-check me-2"></i>
                    Gesti√≥n de Solicitudes T.T.E.
                </h1>
                <p class="text-muted">
                    Clasificar, hacer seguimiento y aprobar respuestas de solicitudes
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- FILTROS -->
        <div class="filter-section">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Estado</label>
                    <select class="form-select" id="filter-status">
                        <option value="">Todos</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="En proceso">En proceso</option>
                        <option value="Cerrado">Cerrado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tipo de Solicitante</label>
                    <select class="form-select" id="filter-type">
                        <option value="">Todos</option>
                        <option value="Estudiante">Estudiante</option>
                        <option value="Familia">Familia</option>
                        <option value="Trabajador">Trabajador</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Categor√≠a</label>
                    <select class="form-select" id="filter-category">
                        <option value="">Todas</option>
                        <!-- Se cargan din√°micamente -->
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Estado de Respuesta</label>
                    <select class="form-select" id="filter-response">
                        <option value="">Todos</option>
                        <option value="pending">Sin respuesta</option>
                        <option value="draft">Respuesta propuesta</option>
                        <option value="approved">Respuesta aprobada</option>
                    </select>
                </div>
                <div class="col-12">
                    <button class="btn btn-primary" onclick="aplicarFiltros()">
                        <i class="bi bi-funnel me-1"></i>Filtrar
                    </button>
                    <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                        <i class="bi bi-x-circle me-1"></i>Limpiar
                    </button>
                </div>
            </div>
        </div>
        <!-- Tarjeta de solicitudes -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-inbox me-2"></i>Solicitudes T.T.E.
                    <span class="badge bg-secondary" id="total-requests">0</span>
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" onclick="cargarSolicitudes()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tabla-solicitudes">
                        <thead class="table-dark">
                            <tr>
                                <th>Folio</th>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Solicitante</th>
                                <th>Categor√≠a</th>
                                <th>Prioridad</th>
                                <th>Estado</th>
                                <th>D√≠as</th>
                                <th>Respuesta</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-body">
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando solicitudes...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL DETALLE DE SOLICITUD -->
    <div class="modal fade" id="modal-detalle" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">
                        <i class="bi bi-file-text me-2"></i>Detalle de Solicitud
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <!-- SECCI√ìN 1: Informaci√≥n del Solicitante -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-person me-2"></i>Informaci√≥n del Solicitante
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Folio:</strong> <span class="folio-badge" id="detail-folio"></span></p>
                                    <p><strong>Tipo:</strong> <span id="detail-type"></span></p>
                                    <p><strong>Nombre:</strong> <span id="detail-name"></span></p>
                                    <p><strong>Email:</strong> <span id="detail-email"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Fecha:</strong> <span id="detail-date"></span></p>
                                    <p id="detail-student-row" style="display:none;"><strong>Estudiante:</strong> <span id="detail-student"></span></p>
                                    <p id="detail-course-row" style="display:none;"><strong>Curso:</strong> <span id="detail-course"></span></p>
                                    <p><strong>reCAPTCHA Score:</strong> <span id="detail-captcha"></span></p>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <p><strong>Mensaje:</strong></p>
                                    <div class="p-3 bg-light rounded" id="detail-message" style="user-select: text; cursor: text;"></div>
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Selecciona texto y haz clic en una categor√≠a abajo para crear un fragmento
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECCI√ìN 2: Clasificaci√≥n -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-tags me-2"></i>Clasificaci√≥n General
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="form-clasificacion">
                                <input type="hidden" id="request-id">
                                <div class="row g-3">
                                    <!-- ‚úÖ ELIMINADO: Campo de Categor√≠a (ahora se maneja con fragmentos) -->
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Prioridad</label>
                                        <select class="form-select" id="detail-priority">
                                            <option value="">Sin asignar</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Tipolog√≠a</label>
                                        <select class="form-select" id="detail-typology">
                                            <option value="">Sin definir</option>
                                            <option value="Positivo">Positivo</option>
                                            <option value="Neutro">Neutro</option>
                                            <option value="Negativo">Negativo</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Estado</label>
                                        <select class="form-select" id="detail-status">
                                            <option value="Pendiente">Pendiente</option>
                                            <option value="En proceso">En proceso</option>
                                            <option value="Cerrado">Cerrado</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <button type="button" class="btn btn-primary" onclick="guardarClasificacion()">
                                            <i class="bi bi-save me-1"></i>Guardar Clasificaci√≥n
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- SECCI√ìN 2.5: Fragmentos por Categor√≠a (NUEVO) -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-scissors me-2"></i>Fragmentos por Categor√≠a
                            </h6>
                        </div>
                        <div class="card-body">
                            
                            <!-- Instrucciones -->
                            <div class="alert alert-info" id="instrucciones-fragmentos">
                                <i class="bi bi-lightbulb me-2"></i>
                                <strong>¬øC√≥mo fragmentar?</strong>
                                <ol class="mb-0 mt-2">
                                    <li>Selecciona con el mouse el texto del mensaje que deseas asignar</li>
                                    <li>Haz clic en la categor√≠a correspondiente abajo</li>
                                    <li>El fragmento se agregar√° autom√°ticamente</li>
                                </ol>
                            </div>
                    
                            <!-- Categor√≠as disponibles (botones) -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <strong>Categor√≠as Disponibles:</strong>
                                </label>
                                <div id="categorias-botones" class="d-flex flex-wrap gap-2">
                                    <!-- Se llenan din√°micamente -->
                                </div>
                            </div>
                    
                            <hr>
                    
                            <!-- Lista de fragmentos creados -->
                            <div id="fragmentos-lista">
                                <p class="text-muted text-center">No hay fragmentos asignados</p>
                            </div>
                    
                        </div>
                    </div>


                    
                    <!-- SECCI√ìN 3: Comentarios Internos -->
                    <div class="card mb-3">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-chat-left-text me-2"></i>Comentarios Internos
                            </h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="mostrarFormComentario()">
                                <i class="bi bi-plus-circle me-1"></i>Agregar Comentario
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- Formulario agregar comentario (oculto por defecto) -->
                            <div id="form-comentario" style="display:none;" class="mb-3">
                                <div class="mb-2">
                                    <label class="form-label">Nuevo Comentario</label>
                                    <textarea class="form-control" id="nuevo-comentario" rows="3" placeholder="Escribe tu comentario aqu√≠..."></textarea>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="guardarComentario()">
                                    <i class="bi bi-save me-1"></i>Guardar
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="cancelarComentario()">
                                    Cancelar
                                </button>
                            </div>

                            <!-- Lista de comentarios -->
                            <div id="lista-comentarios">
                                <p class="text-muted text-center">No hay comentarios internos a√∫n</p>
                            </div>
                        </div>
                    </div>

                    <!-- SECCI√ìN 4: Respuesta Final -->
                    <div class="card mb-3" id="seccion-respuesta">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-reply me-2"></i>Respuesta al Usuario
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Mostrar respuesta propuesta si existe -->
                            <div id="respuesta-propuesta" style="display:none;">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>El responsable ha propuesto una respuesta:</strong>
                                </div>
                                <div class="p-3 bg-light rounded mb-3" id="texto-respuesta-propuesta"></div>
                                <button class="btn btn-success" onclick="aprobarRespuesta()">
                                    <i class="bi bi-check-circle me-1"></i>Aprobar y Enviar al Usuario
                                </button>
                                <button class="btn btn-warning" onclick="editarRespuesta()">
                                    <i class="bi bi-pencil me-1"></i>Editar Respuesta
                                </button>
                            </div>

                            <!-- Formulario para editar/escribir respuesta -->
                            <div id="form-respuesta" style="display:none;">
                                <div class="mb-3">
                                    <label class="form-label">Respuesta al Usuario</label>
                                    <textarea class="form-control" id="texto-respuesta" rows="6" placeholder="Escribe la respuesta que se enviar√° al usuario..."></textarea>
                                </div>
                                <button class="btn btn-success" onclick="enviarRespuestaDirecta()">
                                    <i class="bi bi-send me-1"></i>Aprobar y Enviar al Usuario
                                </button>
                                <button class="btn btn-secondary" onclick="cancelarEdicionRespuesta()">
                                    Cancelar
                                </button>
                            </div>

                            <!-- Si ya est√° cerrada y aprobada -->
                            <div id="respuesta-enviada" style="display:none;">
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <strong>Respuesta aprobada y enviada al usuario</strong>
                                </div>
                                <div class="p-3 bg-light rounded" id="texto-respuesta-enviada"></div>
                            </div>

                            <!-- Si no hay respuesta a√∫n -->
                            <div id="sin-respuesta">
                                <p class="text-muted text-center">Sin respuesta a√∫n. El responsable debe proponer una respuesta.</p>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let solicitudesCache = [];
        let categoriasCache = [];
        let prioridadesCache = [];
        let cursosCache = [];
        let modalInstance = null;
        let solicitudActual = null;
        let comentariosActuales = [];
      // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Gestionar solicitudes TTE');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // INICIALIZACI√ìN DE P√ÅGINA
        // ==========================================
        async function inicializarPagina() {
            try {
                mostrarLoading();
                
                // Inicializar modal
                modalInstance = new bootstrap.Modal(document.getElementById('modal-detalle'));
                
                // Cargar datos necesarios
                await Promise.all([
                    cargarCategorias(),
                    cargarPrioridades(),
                    cargarCursos()
                ]);
                
                // Cargar solicitudes
                await cargarSolicitudes();
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR CATEGOR√çAS
        // ==========================================
        async function cargarCategorias() {
            try {
                const categorias = await supabaseRequest('/tte_categories?select=*&category_status=eq.active&order=category_name.asc');
                categoriasCache = categorias || [];
                
                // Llenar filtro
                const filterSelect = document.getElementById('filter-category');
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.category_id;
                    option.textContent = cat.category_name;
                    filterSelect.appendChild(option);
                });
                
                console.log(`‚úÖ ${categorias.length} categor√≠as cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando categor√≠as:', error);
            }
        }
        
        // ==========================================
        // CARGAR PRIORIDADES
        // ==========================================
        async function cargarPrioridades() {
            try {
                const prioridades = await supabaseRequest('/tte_priorities?select=*&priority_status=eq.active&order=priority_order.asc');
                prioridadesCache = prioridades || [];
                
                // Llenar select del modal
                const detailSelect = document.getElementById('detail-priority');
                detailSelect.innerHTML = '<option value="">Sin asignar</option>';
                prioridades.forEach(prio => {
                    const option = document.createElement('option');
                    option.value = prio.priority_id;
                    option.textContent = `${prio.priority_name} (${prio.max_response_days} d√≠as)`;
                    detailSelect.appendChild(option);
                });
                
                console.log(`‚úÖ ${prioridades.length} prioridades cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando prioridades:', error);
            }
        }
        
        // ==========================================
        // CARGAR CURSOS
        // ==========================================
        async function cargarCursos() {
            try {
                const cursos = await supabaseRequest('/courses?select=course_id,course_name,grades(grade_name,sections(section_name))&course_status=eq.active&order=course_order.asc');
                cursosCache = cursos || [];
                console.log(`‚úÖ ${cursos.length} cursos cargados`);
            } catch (error) {
                console.error('‚ùå Error cargando cursos:', error);
            }
        }
        
        // ==========================================
        // CARGAR SOLICITUDES
        // ==========================================
        async function cargarSolicitudes() {
            try {
                console.log('üì° Cargando solicitudes...');
                
                const solicitudes = await supabaseRequest('/tte_requests?select=*,tte_categories(category_name),tte_priorities(priority_name,max_response_days)&order=created_at.desc');
                
                solicitudesCache = solicitudes || [];
                renderizarTabla(solicitudesCache);
                
                document.getElementById('total-requests').textContent = solicitudesCache.length;
                console.log(`‚úÖ ${solicitudesCache.length} solicitudes cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando solicitudes:', error);
                showMessage('Error al cargar solicitudes: ' + error.message, 'danger');
                
                document.getElementById('tabla-body').innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="bi bi-exclamation-triangle text-warning"></i>
                            <div class="mt-2">Error al cargar datos</div>
                        </td>
                    </tr>
                `;
            }
        }
      // ==========================================
        // RENDERIZAR TABLA
        // ==========================================
        function renderizarTabla(solicitudes) {
            const tbody = document.getElementById('tabla-body');
            
            if (!solicitudes || solicitudes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="bi bi-inbox"></i>
                            <div class="mt-2">No hay solicitudes</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = solicitudes.map(sol => {
                // Badges de estado
                let estadoBadge = '';
                if (sol.status === 'Pendiente') estadoBadge = '<span class="badge badge-pendiente">Pendiente</span>';
                else if (sol.status === 'En proceso') estadoBadge = '<span class="badge badge-proceso">En proceso</span>';
                else if (sol.status === 'Cerrado') estadoBadge = '<span class="badge badge-cerrado">Cerrado</span>';
                
                // Badge de estado de respuesta
                let respuestaBadge = '';
                if (sol.response_status === 'pending') respuestaBadge = '<span class="badge bg-secondary">Sin respuesta</span>';
                else if (sol.response_status === 'draft') respuestaBadge = '<span class="badge bg-warning text-dark">Propuesta</span>';
                else if (sol.response_status === 'approved') respuestaBadge = '<span class="badge bg-success">Aprobada</span>';
                
                // Calcular d√≠as transcurridos
                const fechaCreacion = new Date(sol.created_at);
                const hoy = new Date();
                const diasTranscurridos = Math.floor((hoy - fechaCreacion) / (1000 * 60 * 60 * 24));
                
                // Comparar con d√≠as m√°ximos si tiene prioridad
                let diasHtml = `<span>${diasTranscurridos}</span>`;
                if (sol.tte_priorities && sol.tte_priorities.max_response_days) {
                    const maxDias = sol.tte_priorities.max_response_days;
                    if (diasTranscurridos > maxDias) {
                        diasHtml = `<span class="days-warning">${diasTranscurridos}/${maxDias}</span>`;
                    } else {
                        diasHtml = `<span class="days-ok">${diasTranscurridos}/${maxDias}</span>`;
                    }
                }
                
                const fecha = formatDate(sol.created_at);

                // ‚úÖ NUEVO: Mostrar si est√° fragmentada o categor√≠a √∫nica
                let categoria = '';
                if (sol.has_fragments) {
                    categoria = '<span class="badge bg-info"><i class="bi bi-scissors me-1"></i>Fragmentada</span>';
                } else if (sol.tte_categories?.category_name) {
                    categoria = sol.tte_categories.category_name;
                } else {
                    categoria = '<span class="text-muted">Sin asignar</span>';
                }
                
                const prioridad = sol.tte_priorities?.priority_name || '<span class="text-muted">Sin asignar</span>';
                
                return `
                    <tr class="request-row" onclick="verDetalle('${sol.request_id}')">
                        <td><span class="folio-badge">${escapeHtml(sol.request_folio)}</span></td>
                        <td>${fecha}</td>
                        <td>${escapeHtml(sol.requester_type)}</td>
                        <td>${escapeHtml(sol.requester_name)}</td>
                        <td>${categoria}</td>
                        <td>${prioridad}</td>
                        <td>${estadoBadge}</td>
                        <td>${diasHtml}</td>
                        <td>${respuestaBadge}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // ==========================================
        // APLICAR FILTROS
        // ==========================================
        function aplicarFiltros() {
            const filterStatus = document.getElementById('filter-status').value;
            const filterType = document.getElementById('filter-type').value;
            const filterCategory = document.getElementById('filter-category').value;
            const filterResponse = document.getElementById('filter-response').value;
            
            let filtradas = solicitudesCache;
            
            if (filterStatus) {
                filtradas = filtradas.filter(s => s.status === filterStatus);
            }
            
            if (filterType) {
                filtradas = filtradas.filter(s => s.requester_type === filterType);
            }
            
            if (filterCategory) {
                filtradas = filtradas.filter(s => s.category_id === filterCategory);
            }
            
            if (filterResponse) {
                filtradas = filtradas.filter(s => s.response_status === filterResponse);
            }
            
            renderizarTabla(filtradas);
            document.getElementById('total-requests').textContent = filtradas.length;
        }
        
        // ==========================================
        // LIMPIAR FILTROS
        // ==========================================
        function limpiarFiltros() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-response').value = '';
            
            renderizarTabla(solicitudesCache);
            document.getElementById('total-requests').textContent = solicitudesCache.length;
        }
      // ==========================================
        // VER DETALLE DE SOLICITUD
        // ==========================================
        async function verDetalle(requestId) {
            try {
                mostrarLoading();
                
                // Buscar solicitud en cache
                const solicitud = solicitudesCache.find(s => s.request_id === requestId);
                
                if (!solicitud) {
                    showMessage('Solicitud no encontrada', 'danger');
                    return;
                }
                
                solicitudActual = solicitud;
                
                // Llenar informaci√≥n del solicitante
                document.getElementById('detail-folio').textContent = solicitud.request_folio;
                document.getElementById('detail-type').textContent = solicitud.requester_type;
                document.getElementById('detail-name').textContent = solicitud.requester_name;
                document.getElementById('detail-email').textContent = solicitud.requester_email;
                document.getElementById('detail-date').textContent = formatDate(solicitud.created_at);
                document.getElementById('detail-message').textContent = solicitud.message;
                document.getElementById('detail-captcha').textContent = solicitud.recaptcha_score || 'N/A';
                
                // Mostrar campos condicionales
                if (solicitud.student_name) {
                    document.getElementById('detail-student-row').style.display = 'block';
                    document.getElementById('detail-student').textContent = solicitud.student_name;
                } else {
                    document.getElementById('detail-student-row').style.display = 'none';
                }
                
                if (solicitud.course_id) {
                    const curso = cursosCache.find(c => c.course_id === solicitud.course_id);
                    if (curso) {
                        document.getElementById('detail-course-row').style.display = 'block';
                        const nombreCurso = `${curso.grades?.sections?.section_name || ''} - ${curso.grades?.grade_name || ''} ${curso.course_name}`.trim();
                        document.getElementById('detail-course').textContent = nombreCurso;
                    } else {
                        document.getElementById('detail-course-row').style.display = 'none';
                    }
                } else {
                    document.getElementById('detail-course-row').style.display = 'none';
                }
                
                // Llenar clasificaci√≥n
                document.getElementById('request-id').value = solicitud.request_id;
                document.getElementById('detail-priority').value = solicitud.priority_id || '';
                document.getElementById('detail-typology').value = solicitud.typology || '';
                document.getElementById('detail-status').value = solicitud.status;
                
                // Cargar comentarios
                await cargarComentarios(requestId);
                
                // Mostrar secci√≥n de respuesta seg√∫n estado
                mostrarSeccionRespuesta(solicitud);

                await cargarFragmentos(requestId);
                renderizarBotonesCategoria();
                
                modalInstance.show();
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error cargando detalle:', error);
                showMessage('Error al cargar detalle de la solicitud', 'danger');
                ocultarLoading();
            }
        }


        // ==========================================
        // NOTIFICAR AL RESPONSABLE DE LA CATEGOR√çA
        // ==========================================
        async function notificarResponsable(requestId, categoryId) {
            try {
                // Obtener datos de la categor√≠a y responsable
                const categoria = categoriasCache.find(c => c.category_id === categoryId);
                
                if (!categoria || !categoria.responsible_email) {
                    console.log('‚ö†Ô∏è Categor√≠a sin responsable asignado');
                    return;
                }
                
                // Obtener datos completos de la solicitud
                const solicitud = solicitudesCache.find(s => s.request_id === requestId);
                
                const subject = `Nueva solicitud TTE asignada: ${solicitud.request_folio}`;
                
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <div style="background: linear-gradient(135deg, #e83e8c 0%, #d63384 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
                            <h1 style="color: white; margin: 0;">Tilat√° te Escucha</h1>
                        </div>
                        
                        <div style="background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 10px 10px;">
                            <h2 style="color: #e83e8c; margin-top: 0;">Nueva solicitud asignada a tu categor√≠a</h2>
                            
                            <p>Hola,</p>
                            
                            <p>Se te ha asignado una nueva solicitud PQR en la categor√≠a <strong>${escapeHtml(categoria.category_name)}</strong>.</p>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <p><strong>Folio:</strong> ${solicitud.request_folio}</p>
                                <p><strong>Tipo:</strong> ${solicitud.requester_type}</p>
                                <p><strong>Solicitante:</strong> ${escapeHtml(solicitud.requester_name)}</p>
                                <p><strong>Fecha:</strong> ${formatDate(solicitud.created_at)}</p>
                                <p><strong>Mensaje:</strong></p>
                                <div style="background: white; padding: 15px; border-left: 4px solid #e83e8c; margin-top: 10px;">
                                    <p style="margin: 0; white-space: pre-wrap;">${escapeHtml(solicitud.message)}</p>
                                </div>
                            </div>
                            
                            <p>Por favor, ingresa al sistema para revisar el detalle completo y proponer una respuesta:</p>
                            
                            <div style="text-align: center; margin: 30px 0;">
                                <a href="${window.location.origin}/modules/tte/respond-requests.html" 
                                   style="display: inline-block; background: linear-gradient(135deg, #e83e8c 0%, #d63384 100%); 
                                          color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold;">
                                    Ver Solicitud
                                </a>
                            </div>
                            
                            <p style="color: #666; font-size: 14px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                                Este correo es generado autom√°ticamente por SchoolNet.<br>
                                <strong>Colegio Tilat√°</strong> - Tilat√° te Escucha
                            </p>
                        </div>
                    </div>
                `;
                
                await sendNotification(categoria.responsible_email, subject, htmlContent, true);
                console.log('‚úÖ Email enviado al responsable:', categoria.responsible_email);
                
            } catch (error) {
                console.error('‚ö†Ô∏è Error notificando responsable:', error);
                // No bloquear el flujo si falla el email
            }
        }
        
        // ==========================================
        // GUARDAR CLASIFICACI√ìN
        // ==========================================
        async function guardarClasificacion() {
            try {
                mostrarLoading();
                
                const requestId = document.getElementById('request-id').value;
                
                const datos = {
                    priority_id: document.getElementById('detail-priority').value || null,
                    typology: document.getElementById('detail-typology').value || null,
                    status: document.getElementById('detail-status').value
                };
                
                await supabaseRequest(`/tte_requests?request_id=eq.${requestId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(datos)
                });
                
                showMessage('Clasificaci√≥n guardada exitosamente', 'success');
                
                // ‚úÖ ELIMINADO el bloque de notificaci√≥n
                
                // Recargar solicitudes
                await cargarSolicitudes();
                
                // Actualizar solicitud actual
                solicitudActual = solicitudesCache.find(s => s.request_id === requestId);
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error guardando clasificaci√≥n:', error);
                showMessage('Error al guardar clasificaci√≥n: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR COMENTARIOS
        // ==========================================
        async function cargarComentarios(requestId) {
            try {
                const comentarios = await supabaseRequest(`/tte_request_comments?select=*,workers(worker_first_name,worker_last_name_1,worker_last_name_2)&request_id=eq.${requestId}&order=created_at.desc`);
                
                comentariosActuales = comentarios || [];
                
                const listaComentarios = document.getElementById('lista-comentarios');
                
                if (comentarios.length === 0) {
                    listaComentarios.innerHTML = '<p class="text-muted text-center">No hay comentarios internos a√∫n</p>';
                    return;
                }
                
                listaComentarios.innerHTML = comentarios.map(com => {
                    const nombreWorker = `${com.workers.worker_first_name} ${com.workers.worker_last_name_1} ${com.workers.worker_last_name_2 || ''}`.trim();
                    const fecha = formatDate(com.created_at);
                    
                    return `
                        <div class="border-bottom pb-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <strong class="text-primary">${escapeHtml(nombreWorker)}</strong>
                                <small class="text-muted">${fecha}</small>
                            </div>
                            <p class="mb-0">${escapeHtml(com.comment_text)}</p>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('‚ùå Error cargando comentarios:', error);
            }
        }
        
        // ==========================================
        // MOSTRAR FORMULARIO COMENTARIO
        // ==========================================
        function mostrarFormComentario() {
            document.getElementById('form-comentario').style.display = 'block';
            document.getElementById('nuevo-comentario').focus();
        }
        
        function cancelarComentario() {
            document.getElementById('form-comentario').style.display = 'none';
            document.getElementById('nuevo-comentario').value = '';
        }
        
        // ==========================================
        // GUARDAR COMENTARIO
        // ==========================================
        async function guardarComentario() {
            try {
                const comentarioTexto = document.getElementById('nuevo-comentario').value.trim();
                
                if (!comentarioTexto) {
                    showMessage('Debes escribir un comentario', 'warning');
                    return;
                }
                
                mostrarLoading();
                
                const session = getStoredSession();
                const workerData = await supabaseRequest(`/workers?select=worker_id&email=eq.${session.user.user_mail}&limit=1`);
                
                if (!workerData || workerData.length === 0) {
                    throw new Error('No se encontr√≥ el trabajador asociado');
                }
                
                const datos = {
                    request_id: solicitudActual.request_id,
                    worker_id: workerData[0].worker_id,
                    comment_text: comentarioTexto
                };
                
                await supabaseRequest('/tte_request_comments', {
                    method: 'POST',
                    body: JSON.stringify(datos)
                });
                
                showMessage('Comentario agregado exitosamente', 'success');
                
                // Recargar comentarios
                await cargarComentarios(solicitudActual.request_id);
                
                // Limpiar formulario
                cancelarComentario();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error guardando comentario:', error);
                showMessage('Error al guardar comentario: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
      // ==========================================
        // MOSTRAR SECCI√ìN DE RESPUESTA
        // ==========================================
        function mostrarSeccionRespuesta(solicitud) {
            // Ocultar todas las secciones primero
            document.getElementById('respuesta-propuesta').style.display = 'none';
            document.getElementById('form-respuesta').style.display = 'none';
            document.getElementById('respuesta-enviada').style.display = 'none';
            document.getElementById('sin-respuesta').style.display = 'none';
            
            if (solicitud.response_status === 'approved') {
                // Respuesta ya aprobada y enviada
                document.getElementById('respuesta-enviada').style.display = 'block';
                document.getElementById('texto-respuesta-enviada').textContent = solicitud.response_text || '';
            } else if (solicitud.response_status === 'draft') {
                // Hay respuesta propuesta por el responsable
                document.getElementById('respuesta-propuesta').style.display = 'block';
                document.getElementById('texto-respuesta-propuesta').textContent = solicitud.response_text || '';
            } else {
                // Sin respuesta a√∫n
                document.getElementById('sin-respuesta').style.display = 'block';
            }
        }
        
        // ==========================================
        // EDITAR RESPUESTA
        // ==========================================
        function editarRespuesta() {
            document.getElementById('respuesta-propuesta').style.display = 'none';
            document.getElementById('form-respuesta').style.display = 'block';
            document.getElementById('texto-respuesta').value = solicitudActual.response_text || '';
        }
        
        function cancelarEdicionRespuesta() {
            document.getElementById('form-respuesta').style.display = 'none';
            mostrarSeccionRespuesta(solicitudActual);
        }
        
        // ==========================================
        // APROBAR RESPUESTA (SIN EDITAR)
        // ==========================================
        async function aprobarRespuesta() {
            if (!confirm('¬øAprobar y enviar esta respuesta al usuario?\n\nSe enviar√° un email con la respuesta y la solicitud se cerrar√°.')) {
                return;
            }
            
            try {
                mostrarLoading();
                
                // Actualizar estado en BD
                await supabaseRequest(`/tte_requests?request_id=eq.${solicitudActual.request_id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        response_status: 'approved',
                        status: 'Cerrado',
                        closed_at: new Date().toISOString()
                    })
                });
                
                // Enviar email al usuario
                await enviarEmailRespuesta(solicitudActual);
                
                showMessage('Respuesta aprobada y enviada exitosamente', 'success');
                
                // Recargar solicitudes y cerrar modal
                await cargarSolicitudes();
                modalInstance.hide();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error aprobando respuesta:', error);
                showMessage('Error al aprobar respuesta: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // ENVIAR RESPUESTA DIRECTA (EDITADA O NUEVA)
        // ==========================================
        async function enviarRespuestaDirecta() {
            const respuestaTexto = document.getElementById('texto-respuesta').value.trim();
            
            if (!respuestaTexto) {
                showMessage('Debes escribir una respuesta', 'warning');
                return;
            }
            
            if (!confirm('¬øAprobar y enviar esta respuesta al usuario?\n\nSe enviar√° un email y la solicitud se cerrar√°.')) {
                return;
            }
            
            try {
                mostrarLoading();
                
                // Actualizar en BD
                await supabaseRequest(`/tte_requests?request_id=eq.${solicitudActual.request_id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        response_text: respuestaTexto,
                        response_status: 'approved',
                        status: 'Cerrado',
                        closed_at: new Date().toISOString()
                    })
                });
                
                // Actualizar solicitud actual para el email
                solicitudActual.response_text = respuestaTexto;
                
                // Enviar email
                await enviarEmailRespuesta(solicitudActual);
                
                showMessage('Respuesta enviada exitosamente', 'success');
                
                // Recargar y cerrar
                await cargarSolicitudes();
                modalInstance.hide();
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error enviando respuesta:', error);
                showMessage('Error al enviar respuesta: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // ENVIAR EMAIL DE RESPUESTA AL USUARIO
        // ==========================================
        async function enviarEmailRespuesta(solicitud) {
            try {
                const subject = `Respuesta a tu solicitud ${solicitud.request_folio} - Tilat√° te Escucha`;
                
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <div style="background: linear-gradient(135deg, #e83e8c 0%, #d63384 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
                            <h1 style="color: white; margin: 0;">Tilat√° te Escucha</h1>
                        </div>
                        
                        <div style="background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 10px 10px;">
                            <h2 style="color: #e83e8c; margin-top: 0;">Hemos respondido tu solicitud</h2>
                            
                            <p>Hola <strong>${escapeHtml(solicitud.requester_name)}</strong>,</p>
                            
                            <p>Gracias por contactarnos. Hemos revisado tu solicitud con folio <strong>${solicitud.request_folio}</strong> y queremos darte la siguiente respuesta:</p>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-left: 4px solid #e83e8c; margin: 20px 0;">
                                <p style="margin: 0; white-space: pre-wrap;">${escapeHtml(solicitud.response_text)}</p>
                            </div>
                            
                            <p>Si tienes alguna duda adicional, no dudes en contactarnos nuevamente.</p>
                            
                            <p style="color: #666; font-size: 14px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                                Este correo es generado autom√°ticamente por SchoolNet.<br>
                                <strong>Colegio Tilat√°</strong> - Tilat√° te Escucha
                            </p>
                        </div>
                    </div>
                `;
                
                await sendNotification(solicitud.requester_email, subject, htmlContent, true);
                console.log('‚úÖ Email de respuesta enviado a:', solicitud.requester_email);
                
            } catch (error) {
                console.error('‚ö†Ô∏è Error enviando email:', error);
                // No bloquear el flujo si falla el email
            }
        }

        // ==========================================
        // RENDERIZAR BOTONES DE CATEGOR√çAS
        // ==========================================
        function renderizarBotonesCategoria() {
            const container = document.getElementById('categorias-botones');
            
            if (!categoriasCache || categoriasCache.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay categor√≠as disponibles</p>';
                return;
            }
            
            container.innerHTML = categoriasCache.map(cat => `
                <button 
                    type="button" 
                    class="btn btn-outline-primary categoria-btn" 
                    onclick="asignarFragmento('${cat.category_id}')"
                    data-category-name="${escapeHtml(cat.category_name)}">
                    <i class="bi bi-tag me-1"></i>${escapeHtml(cat.category_name)}
                </button>
            `).join('');
        }
        
        // ==========================================
        // ASIGNAR FRAGMENTO A CATEGOR√çA
        // ==========================================
        async function asignarFragmento(categoryId) {
            try {
                // Obtener texto seleccionado
                const selection = window.getSelection();
                const textoSeleccionado = selection.toString().trim();
                
                if (!textoSeleccionado) {
                    showMessage('Primero selecciona un fragmento de texto del mensaje', 'warning');
                    return;
                }
                
                if (textoSeleccionado.length < 10) {
                    showMessage('El fragmento debe tener al menos 10 caracteres', 'warning');
                    return;
                }
                
                // Verificar si ya existe este fragmento
                const fragmentosActuales = await supabaseRequest(
                    `/tte_request_fragments?request_id=eq.${solicitudActual.request_id}&select=fragment_text`
                );
                
                const yaExiste = fragmentosActuales?.some(f => 
                    f.fragment_text.toLowerCase() === textoSeleccionado.toLowerCase()
                );
                
                if (yaExiste) {
                    showMessage('Este fragmento ya est√° asignado', 'warning');
                    return;
                }
                
                mostrarLoading();
                
                // Obtener el siguiente orden
                const maxOrder = fragmentosActuales?.length ? 
                    Math.max(...fragmentosActuales.map(f => f.fragment_order || 0)) : 0;
                
                // Guardar fragmento
                const nuevoFragmento = {
                    request_id: solicitudActual.request_id,
                    category_id: categoryId,
                    fragment_text: textoSeleccionado,
                    fragment_order: maxOrder + 1,
                    response_status: 'pending'
                };
                
                await supabaseRequest('/tte_request_fragments', {
                    method: 'POST',
                    body: JSON.stringify(nuevoFragmento)
                });
                
                // Actualizar has_fragments en la solicitud
                await supabaseRequest(`/tte_requests?request_id=eq.${solicitudActual.request_id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ has_fragments: true })
                });
                
                showMessage('Fragmento asignado exitosamente', 'success');
                
                // Recargar fragmentos
                await cargarFragmentos(solicitudActual.request_id);
                
                // Limpiar selecci√≥n
                selection.removeAllRanges();
                
                // Notificar al responsable de la nueva categor√≠a
                await notificarResponsableFragmento(solicitudActual.request_id, categoryId, textoSeleccionado);
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error asignando fragmento:', error);
                showMessage('Error al asignar fragmento: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR FRAGMENTOS
        // ==========================================
        async function cargarFragmentos(requestId) {
            try {
                const fragmentos = await supabaseRequest(
                    `/tte_request_fragments?request_id=eq.${requestId}&select=*,tte_categories(category_name,responsible_email)&order=fragment_order.asc`
                );
                
                const container = document.getElementById('fragmentos-lista');
                
                if (!fragmentos || fragmentos.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">No hay fragmentos asignados</p>';
                    return;
                }
                
                container.innerHTML = fragmentos.map(frag => {
                    let statusBadge = '';
                    if (frag.response_status === 'pending') {
                        statusBadge = '<span class="badge bg-secondary">Sin respuesta</span>';
                    } else if (frag.response_status === 'draft') {
                        statusBadge = '<span class="badge bg-warning text-dark">Respuesta propuesta</span>';
                    } else if (frag.response_status === 'approved') {
                        statusBadge = '<span class="badge bg-success">Respuesta aprobada</span>';
                    }
                    
                    return `
                        <div class="fragmento-card">
                            <button 
                                class="btn btn-sm btn-outline-danger fragmento-delete" 
                                onclick="eliminarFragmento('${frag.fragment_id}')"
                                title="Eliminar fragmento">
                                <i class="bi bi-trash"></i>
                            </button>
                            <div class="mb-2">
                                <span class="badge bg-primary me-2">
                                    <i class="bi bi-tag me-1"></i>${escapeHtml(frag.tte_categories?.category_name || 'Sin categor√≠a')}
                                </span>
                                ${statusBadge}
                            </div>
                            <div class="fragmento-text">
                                "${escapeHtml(frag.fragment_text)}"
                            </div>
                            ${frag.response_text ? `
                                <div class="mt-2">
                                    <strong class="text-success">Respuesta:</strong>
                                    <div class="p-2 bg-white rounded mt-1">
                                        ${escapeHtml(frag.response_text)}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('‚ùå Error cargando fragmentos:', error);
            }
        }
        
        // ==========================================
        // ELIMINAR FRAGMENTO
        // ==========================================
        async function eliminarFragmento(fragmentId) {
            if (!confirm('¬øEliminar este fragmento?\n\nSi el responsable ya trabaj√≥ en √©l, se perder√° esa informaci√≥n.')) {
                return;
            }
            
            try {
                mostrarLoading();
                
                await supabaseRequest(`/tte_request_fragments?fragment_id=eq.${fragmentId}`, {
                    method: 'DELETE'
                });
                
                showMessage('Fragmento eliminado', 'success');
                
                // Recargar fragmentos
                await cargarFragmentos(solicitudActual.request_id);
                
                // Verificar si quedan fragmentos
                const fragmentosRestantes = await supabaseRequest(
                    `/tte_request_fragments?request_id=eq.${solicitudActual.request_id}&select=fragment_id`
                );
                
                if (!fragmentosRestantes || fragmentosRestantes.length === 0) {
                    // Si no quedan fragmentos, actualizar has_fragments
                    await supabaseRequest(`/tte_requests?request_id=eq.${solicitudActual.request_id}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ has_fragments: false })
                    });
                }
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error eliminando fragmento:', error);
                showMessage('Error al eliminar fragmento: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // NOTIFICAR RESPONSABLE DE NUEVO FRAGMENTO
        // ==========================================
        async function notificarResponsableFragmento(requestId, categoryId, fragmentoTexto) {
            try {
                const categoria = categoriasCache.find(c => c.category_id === categoryId);
                
                if (!categoria || !categoria.responsible_email) {
                    console.log('‚ö†Ô∏è Categor√≠a sin responsable asignado');
                    return;
                }
                
                const solicitud = solicitudesCache.find(s => s.request_id === requestId);
                
                const subject = `Nuevo fragmento TTE asignado: ${solicitud.request_folio}`;
                
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <div style="background: linear-gradient(135deg, #e83e8c 0%, #d63384 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
                            <h1 style="color: white; margin: 0;">Tilat√° te Escucha</h1>
                        </div>
                        
                        <div style="background: white; padding: 30px; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 10px 10px;">
                            <h2 style="color: #e83e8c; margin-top: 0;">Nuevo fragmento asignado</h2>
                            
                            <p>Se te ha asignado un fragmento espec√≠fico de la solicitud <strong>${solicitud.request_folio}</strong> en la categor√≠a <strong>${escapeHtml(categoria.category_name)}</strong>.</p>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <p><strong>Folio:</strong> ${solicitud.request_folio}</p>
                                <p><strong>Solicitante:</strong> ${escapeHtml(solicitud.requester_name)}</p>
                                <p><strong>Fragmento asignado:</strong></p>
                                <div style="background: white; padding: 15px; border-left: 4px solid #e83e8c; margin-top: 10px;">
                                    <p style="margin: 0; font-style: italic;">"${escapeHtml(fragmentoTexto)}"</p>
                                </div>
                            </div>
                            
                            <p>Por favor, ingresa al sistema para proponer una respuesta a este fragmento:</p>
                            
                            <div style="text-align: center; margin: 30px 0;">
                                <a href="${window.location.origin}/modules/tte/respond-requests.html" 
                                   style="display: inline-block; background: linear-gradient(135deg, #e83e8c 0%, #d63384 100%); 
                                          color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold;">
                                    Ver Fragmento
                                </a>
                            </div>
                            
                            <p style="color: #666; font-size: 14px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                                Este correo es generado autom√°ticamente por SchoolNet.<br>
                                <strong>Colegio Tilat√°</strong> - Tilat√° te Escucha
                            </p>
                        </div>
                    </div>
                `;
                
                await sendNotification(categoria.responsible_email, subject, htmlContent, true);
                console.log('‚úÖ Email enviado al responsable del fragmento');
                
            } catch (error) {
                console.error('‚ö†Ô∏è Error notificando responsable:', error);
            }
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.cargarSolicitudes = cargarSolicitudes;
        window.aplicarFiltros = aplicarFiltros;
        window.limpiarFiltros = limpiarFiltros;
        window.verDetalle = verDetalle;
        window.guardarClasificacion = guardarClasificacion;
        window.mostrarFormComentario = mostrarFormComentario;
        window.cancelarComentario = cancelarComentario;
        window.guardarComentario = guardarComentario;
        window.editarRespuesta = editarRespuesta;
        window.cancelarEdicionRespuesta = cancelarEdicionRespuesta;
        window.aprobarRespuesta = aprobarRespuesta;
        window.enviarRespuestaDirecta = enviarRespuestaDirecta;
        window.notificarResponsable = notificarResponsable;
        window.asignarFragmento = asignarFragmento;
        window.eliminarFragmento = eliminarFragmento;
        
        console.log('‚úÖ P√°gina de gesti√≥n de solicitudes TTE cargada correctamente');
    </script>
</body>
</html>
