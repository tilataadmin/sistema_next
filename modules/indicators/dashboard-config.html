<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.10.30.18.08">
    <title>Configurar Mi Dashboard - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSIÓN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .indicator-item {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
            cursor: pointer;
            background: white;
        }
        
        .indicator-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        .indicator-item.selected {
            border-color: #667eea;
            background-color: #f8f9ff;
        }
        
        .indicator-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .formula-preview {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            color: #495057;
        }
        
        .result-format-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .format-decimal { background-color: #e0f2fe; color: #0c4a6e; }
        .format-percentage { background-color: #f0fdf4; color: #166534; }
        .format-integer { background-color: #fef3c7; color: #92400e; }
        
        .selection-summary {
            position: sticky;
            top: 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Guardando configuración...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Indicadores</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Configurar Mi Dashboard
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-grid-3x3 me-2"></i>
                    Configurar Mi Dashboard
                </h1>
                <p class="text-muted">
                    Selecciona los indicadores que deseas visualizar en tu dashboard personal
                </p>
            </div>
        </div>

        <!-- ALERTAS -->
        <div id="alertContainer"></div>
        <!-- Información -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex">
                    <div class="me-3">
                        <i class="bi bi-info-circle text-info" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">¿Cómo funciona?</h6>
                        <p class="text-muted mb-0">
                            Marca los indicadores que quieres ver en tu dashboard personal. 
                            Los indicadores seleccionados se calcularán automáticamente cuando visites "Mi Dashboard".
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Columna izquierda: Lista de indicadores -->
            <div class="col-lg-8">
                <!-- Controles -->
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-speedometer2 me-2"></i>Indicadores Disponibles
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="loadIndicators()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Búsqueda y Filtro de Categorías -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="searchIndicators" 
                                       placeholder="Buscar indicadores..." onkeyup="handleFilterChange()">
                            </div>
                            <div class="col-md-4">
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" 
                                            id="categoryFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-funnel me-2"></i>
                                        <span id="categoryFilterLabel">Todas las categorías</span>
                                    </button>
                                    <div class="dropdown-menu p-3" style="min-width: 300px; max-height: 400px; overflow-y: auto;" 
                                         onclick="event.stopPropagation();">
                                        <div class="mb-2">
                                            <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="selectAllCategories()">
                                                <i class="bi bi-check-all me-1"></i>Seleccionar todas
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary w-100" onclick="clearCategoryFilter()">
                                                <i class="bi bi-x-circle me-1"></i>Limpiar selección
                                            </button>
                                        </div>
                                        <hr>
                                        <div id="categoryFilterOptions">
                                            <div class="text-center text-muted py-2">
                                                <small>Cargando categorías...</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtros rápidos -->
                        <div class="mb-3">
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="filterType" id="filterAll" 
                                       value="all" checked onchange="filterIndicators()">
                                <label class="btn btn-outline-primary" for="filterAll">
                                    Todos <span class="badge bg-primary" id="countAll">0</span>
                                </label>
                                
                                <input type="radio" class="btn-check" name="filterType" id="filterSelected" 
                                       value="selected" onchange="filterIndicators()">
                                <label class="btn btn-outline-success" for="filterSelected">
                                    Seleccionados <span class="badge bg-success" id="countSelected">0</span>
                                </label>
                                
                                <input type="radio" class="btn-check" name="filterType" id="filterUnselected" 
                                       value="unselected" onchange="filterIndicators()">
                                <label class="btn btn-outline-secondary" for="filterUnselected">
                                    No seleccionados <span class="badge bg-secondary" id="countUnselected">0</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenedor de indicadores -->
                <div id="indicatorsContainer">
                    <div class="empty-state">
                        <div class="spinner-border text-primary"></div>
                        <p>Cargando indicadores...</p>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: Resumen y acciones -->
            <div class="col-lg-4">
                <div class="selection-summary">
                    <h5 class="mb-3">
                        <i class="bi bi-check-circle me-2 text-success"></i>
                        Resumen de Selección
                    </h5>
                    
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Indicadores seleccionados:</span>
                            <h3 class="mb-0 text-success" id="selectedCount">0</h3>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" id="selectionProgress" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted">
                            <span id="selectedPercentage">0</span>% del total disponible
                        </small>
                    </div>
                    
                    <div class="alert alert-info mb-4" id="recommendationAlert">
                        <i class="bi bi-lightbulb me-2"></i>
                        <small>Selecciona al menos un indicador para crear tu dashboard.</small>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" id="saveBtn" onclick="saveConfiguration()" disabled>
                            <i class="bi bi-check-circle me-2"></i>Guardar Configuración
                        </button>
                        <a href="dashboard.html" class="btn btn-outline-primary">
                            <i class="bi bi-bar-chart-line me-2"></i>Ver Mi Dashboard
                        </a>
                        <button class="btn btn-outline-secondary" onclick="clearSelection()">
                            <i class="bi bi-x-circle me-2"></i>Limpiar Selección
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VALIDACIÓN DE ACCESO
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Configurar mi dashboard');
                
                if (!hasAccess) {
                    console.log('❌ Acceso denegado');
                    return;
                }
                
                console.log('✅ Acceso permitido');
                initializePage();
                
            } catch (error) {
                console.error('❌ Error en validación:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });
        
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let allIndicators = [];
        let filteredIndicators = [];
        let selectedIndicators = new Set(); // IDs de indicadores seleccionados
        let availableCategories = [];
        let selectedCategoryFilters = []; // Categorías seleccionadas para filtro
        let currentUser = null;
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        
        async function initializePage() {
            console.log('🔧 Inicializando configuración de dashboard');
            
            try {
                getCurrentUser();
                await loadCategories();
                await loadIndicators();
                
                console.log('✅ Página inicializada');
                
            } catch (error) {
                console.error('❌ Error inicializando:', error);
                showMessage('Error al inicializar la página: ' + error.message, 'danger');
            }
        }
        
        function getCurrentUser() {
            try {
                const session = localStorage.getItem('nextSystemSession') || 
                               sessionStorage.getItem('nextSystemSession');
                if (session) {
                    const sessionData = JSON.parse(session);
                    currentUser = sessionData.user;
                    console.log('👤 Usuario:', currentUser.user_display_name || currentUser.user_name);
                }
            } catch (error) {
                console.error('❌ Error obteniendo sesión:', error);
            }
        }
        
        // ==========================================
        // CARGAR CATEGORÍAS
        // ==========================================
        async function loadCategories() {
            try {
                const categories = await supabaseRequest('/indicator_categories?select=*&is_active=eq.true&order=category_order.asc,category_name.asc');
                availableCategories = categories || [];
                
                // Cargar selección guardada de localStorage
                const savedFilters = localStorage.getItem('dashboardCategoryFilters');
                if (savedFilters) {
                    try {
                        selectedCategoryFilters = JSON.parse(savedFilters);
                    } catch (e) {
                        selectedCategoryFilters = [];
                    }
                }
                
                // Renderizar opciones en el dropdown de filtro
                renderCategoryFilterOptions();
                updateCategoryFilterLabel();
                
                console.log(`✅ ${availableCategories.length} categorías cargadas`);
            } catch (error) {
                console.error('❌ Error cargando categorías:', error);
                availableCategories = [];
            }
        }

        // ==========================================
        // RENDERIZAR OPCIONES DE FILTRO DE CATEGORÍAS
        // ==========================================
        
        function renderCategoryFilterOptions() {
            const container = document.getElementById('categoryFilterOptions');
            
            if (!container) {
                console.error('Contenedor de opciones de categorías no encontrado');
                return;
            }
            
            if (availableCategories.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-2">
                        <small>No hay categorías disponibles</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            availableCategories.forEach(category => {
                const isChecked = selectedCategoryFilters.includes(category.category_id);
                html += `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" 
                               id="catFilter_${category.category_id}" 
                               value="${category.category_id}"
                               ${isChecked ? 'checked' : ''}
                               onchange="handleCategoryToggle('${category.category_id}')">
                        <label class="form-check-label d-flex align-items-center" 
                               for="catFilter_${category.category_id}">
                            <span class="badge me-2" 
                                  style="background-color: ${category.category_color}; width: 20px; height: 20px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-${category.category_icon}" style="font-size: 0.7rem;"></i>
                            </span>
                            <span>${category.category_name}</span>
                        </label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // TOGGLE CATEGORÍA EN FILTRO
        // ==========================================
        
        function toggleCategoryFilter(categoryId) {
            const index = selectedCategoryFilters.indexOf(categoryId);
            
            if (index > -1) {
                selectedCategoryFilters.splice(index, 1);
            } else {
                selectedCategoryFilters.push(categoryId);
            }
            
            // Guardar en localStorage
            localStorage.setItem('dashboardCategoryFilters', JSON.stringify(selectedCategoryFilters));
            
            updateCategoryFilterLabel();
            // NO llamar filterIndicators aquí, se llama desde handleCategoryToggle
        }
        
        // ==========================================
        // ACTUALIZAR LABEL DEL FILTRO DE CATEGORÍAS
        // ==========================================
        
        function updateCategoryFilterLabel() {
            const label = document.getElementById('categoryFilterLabel');
            
            if (!label) return;
            
            if (selectedCategoryFilters.length === 0) {
                label.innerHTML = 'Todas las categorías';
            } else if (selectedCategoryFilters.length === 1) {
                const category = availableCategories.find(c => c.category_id === selectedCategoryFilters[0]);
                label.innerHTML = category ? category.category_name : '1 categoría';
            } else {
                label.innerHTML = `${selectedCategoryFilters.length} categorías`;
            }
        }
        
        // ==========================================
        // SELECCIONAR TODAS LAS CATEGORÍAS
        // ==========================================
        
        async function selectAllCategories() {
            selectedCategoryFilters = availableCategories.map(c => c.category_id);
            localStorage.setItem('dashboardCategoryFilters', JSON.stringify(selectedCategoryFilters));
            renderCategoryFilterOptions();
            updateCategoryFilterLabel();
            await filterIndicators();
        }
        
        async function clearCategoryFilter() {
            selectedCategoryFilters = [];
            localStorage.removeItem('dashboardCategoryFilters');
            renderCategoryFilterOptions();
            updateCategoryFilterLabel();
            await filterIndicators();
        }
        
        // ==========================================
        // CARGAR INDICADORES Y SELECCIÓN
        // ==========================================
        async function loadIndicators() {
            const container = document.getElementById('indicatorsContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="spinner-border text-primary"></div>
                    <p>Cargando indicadores...</p>
                </div>
            `;
            
            try {
                // CARGA RÁPIDA INICIAL: Solo indicadores del usuario
                // ✅ CORRECTO - Especificar la relación owner_id
                const indicators = await supabaseRequest(`/indicators?select=*,users!indicators_owner_id_fkey(user_display_name,user_name)&indicator_status=eq.active&owner_id=eq.${currentUser.user_id}&order=indicator_name`);
                allIndicators = indicators || [];
                
                // Cargar categorías de cada indicador
                for (let indicator of allIndicators) {
                    const assignments = await supabaseRequest(`/indicator_category_assignments?select=indicator_categories(*)&indicator_id=eq.${indicator.indicator_id}`);
                    indicator.categories = assignments ? assignments.map(a => a.indicator_categories) : [];
                }
                
                // Cargar selección actual del usuario
                if (currentUser) {
                    const userSelection = await supabaseRequest(`/user_dashboard_indicators?select=indicator_id&user_id=eq.${currentUser.user_id}`);
                    
                    selectedIndicators = new Set(
                        (userSelection || []).map(item => item.indicator_id)
                    );
                }
                
                filteredIndicators = [...allIndicators];
                renderIndicators();
                updateCounts();
                
                console.log(`✅ ${allIndicators.length} indicadores del usuario cargados (carga rápida)`);
                console.log(`✅ ${selectedIndicators.size} indicadores seleccionados`);
                
            } catch (error) {
                console.error('❌ Error cargando indicadores:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        <h6>Error cargando indicadores</h6>
                        <p class="text-muted">${error.message}</p>
                        <button class="btn btn-outline-primary" onclick="loadIndicators()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Reintentar
                        </button>
                    </div>
                `;
            }
        }

        // ==========================================
        // CARGAR TODOS LOS INDICADORES (bajo demanda)
        // ==========================================
        
        let allIndicatorsLoaded = false; // Bandera para saber si ya se cargaron todos
        
        async function loadAllIndicators() {
            if (allIndicatorsLoaded) {
                return; // Ya están cargados, no hacer nada
            }
            
            try {
                console.log('📥 Cargando TODOS los indicadores...');
                
                // Cargar TODOS los indicadores activos (sin filtro de owner)
                const indicators = await supabaseRequest('/indicators?select=*,users!indicators_owner_id_fkey(user_display_name,user_name)&indicator_status=eq.active&order=indicator_name');
                allIndicators = indicators || [];
                
                // Cargar categorías de cada indicador
                for (let indicator of allIndicators) {
                    const assignments = await supabaseRequest(`/indicator_category_assignments?select=indicator_categories(*)&indicator_id=eq.${indicator.indicator_id}`);
                    indicator.categories = assignments ? assignments.map(a => a.indicator_categories) : [];
                }
                
                allIndicatorsLoaded = true;
                filteredIndicators = [...allIndicators];
                
                console.log(`✅ ${allIndicators.length} indicadores totales cargados`);
                
            } catch (error) {
                console.error('❌ Error cargando todos los indicadores:', error);
                throw error;
            }
        }
        
        // ==========================================
        // RENDERIZAR INDICADORES
        // ==========================================
        
        function renderIndicators() {
            const container = document.getElementById('indicatorsContainer');
            
            if (filteredIndicators.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-search text-muted"></i>
                        <h6>No se encontraron indicadores</h6>
                        <p class="text-muted">
                            ${allIndicators.length === 0 ? 
                                'No hay indicadores activos en el sistema.' : 
                                'Intenta con otro filtro de búsqueda.'}
                        </p>
                        ${allIndicators.length > 0 ? 
                            '<button class="btn btn-outline-secondary" onclick="clearFilters()">Limpiar Filtros</button>' : 
                            ''}
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            filteredIndicators.forEach(indicator => {
                const isSelected = selectedIndicators.has(indicator.indicator_id);
                const ownerName = indicator.users ? 
                    (indicator.users.user_display_name || indicator.users.user_name) : 'Sin propietario';
                
                html += `
                    <div class="indicator-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleIndicator('${indicator.indicator_id}')">
                        <div class="d-flex align-items-start">
                            <div class="me-3">
                                <input type="checkbox" class="indicator-checkbox" 
                                       ${isSelected ? 'checked' : ''} 
                                       onclick="event.stopPropagation(); toggleIndicator('${indicator.indicator_id}')">
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-1">${escapeHtml(indicator.indicator_name)}</h6>
                                    <span class="result-format-badge format-${indicator.result_format}">
                                        ${indicator.result_format.toUpperCase()}
                                    </span>
                                </div>
                                
                                ${indicator.indicator_description ? 
                                    `<p class="text-muted small mb-2">${escapeHtml(indicator.indicator_description)}</p>` : 
                                    ''}
                                
                                <div class="formula-preview">
                                    ${escapeHtml(indicator.formula_expression)}
                                </div>
                                
                                ${indicator.categories && indicator.categories.length > 0 ? `
                                <div class="mt-2 mb-2">
                                    <small class="text-muted d-block mb-1">Categorías:</small>
                                    <div class="d-flex flex-wrap gap-1">
                                        ${indicator.categories.map(cat => `
                                            <span class="badge" style="background-color: ${cat.category_color || '#6c757d'}; font-size: 0.7rem;">
                                                <i class="bi bi-${cat.category_icon || 'folder'} me-1"></i>${cat.category_name}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-person me-1"></i>${ownerName}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
      // ==========================================
        // TOGGLE SELECCIÓN DE INDICADOR
        // ==========================================
        
        function toggleIndicator(indicatorId) {
            if (selectedIndicators.has(indicatorId)) {
                selectedIndicators.delete(indicatorId);
            } else {
                selectedIndicators.add(indicatorId);
            }
            
            renderIndicators();
            updateCounts();
        }
        
        // ==========================================
        // ACTUALIZAR CONTADORES Y RESUMEN
        // ==========================================
        
        function updateCounts() {
            // Contar basado en indicadores FILTRADOS
            const totalCount = filteredIndicators.length;
            const selectedCount = filteredIndicators.filter(ind => selectedIndicators.has(ind.indicator_id)).length;
            const unselectedCount = totalCount - selectedCount;
            
            // Actualizar badges de filtros
            document.getElementById('countAll').textContent = totalCount;
            document.getElementById('countSelected').textContent = selectedCount;
            document.getElementById('countUnselected').textContent = unselectedCount;
            
            // Actualizar resumen lateral
            document.getElementById('selectedCount').textContent = selectedCount;
            
            // Actualizar porcentaje
            const percentage = totalCount > 0 ? Math.round((selectedCount / totalCount) * 100) : 0;
            document.getElementById('selectedPercentage').textContent = percentage;
            document.getElementById('selectionProgress').style.width = percentage + '%';
            
            // Actualizar botón de guardar
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = selectedCount === 0;
            
            // Actualizar recomendación
            const recommendationAlert = document.getElementById('recommendationAlert');
            if (selectedCount === 0) {
                recommendationAlert.className = 'alert alert-info mb-4';
                recommendationAlert.innerHTML = '<i class="bi bi-lightbulb me-2"></i><small>Selecciona al menos un indicador para crear tu dashboard.</small>';
            } else if (selectedCount >= 10) {
                recommendationAlert.className = 'alert alert-warning mb-4';
                recommendationAlert.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i><small>Has seleccionado muchos indicadores. Considera reducir para mejor visualización.</small>';
            } else {
                recommendationAlert.className = 'alert alert-success mb-4';
                recommendationAlert.innerHTML = `<i class="bi bi-check-circle me-2"></i><small>Perfecto. ${selectedCount} indicador${selectedCount !== 1 ? 'es' : ''} seleccionado${selectedCount !== 1 ? 's' : ''}.</small>`;
            }
        }
        
        // ==========================================
        // FILTRADO
        // ==========================================
        async function filterIndicators() {
            // Si hay algún filtro activo y no se han cargado todos, cargarlos
            const searchTerm = document.getElementById('searchIndicators').value.toLowerCase();
            const filterType = document.querySelector('input[name="filterType"]:checked').value;
            const hasActiveFilters = searchTerm || selectedCategoryFilters.length > 0;
            
            if (hasActiveFilters && !allIndicatorsLoaded) {
                mostrarLoading();
                try {
                    await loadAllIndicators();
                } catch (error) {
                    ocultarLoading();
                    showMessage('Error cargando indicadores: ' + error.message, 'danger');
                    return;
                }
                ocultarLoading();
            }
            
            filteredIndicators = allIndicators.filter(indicator => {
                // Filtro de búsqueda
                const matchesSearch = !searchTerm || 
                    indicator.indicator_name.toLowerCase().includes(searchTerm) ||
                    (indicator.indicator_description && indicator.indicator_description.toLowerCase().includes(searchTerm)) ||
                    indicator.formula_expression.toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return false;
                
                // Filtro de categorías múltiple (OR lógico - al menos una categoría coincide)
                const matchesCategory = selectedCategoryFilters.length === 0 || 
                    (indicator.categories && indicator.categories.some(cat => selectedCategoryFilters.includes(cat.category_id)));
                
                if (!matchesCategory) return false;
                
                // Filtro de tipo
                const isSelected = selectedIndicators.has(indicator.indicator_id);
                
                switch (filterType) {
                    case 'selected':
                        return isSelected;
                    case 'unselected':
                        return !isSelected;
                    case 'all':
                    default:
                        return true;
                }
            });
            
            renderIndicators();
            updateCounts(); // Actualizar contadores con base en filtrados
            console.log(`🔍 Filtrado: ${filteredIndicators.length} de ${allIndicators.length} indicadores`);
        }
        
        function clearFilters() {
            document.getElementById('searchIndicators').value = '';
            document.getElementById('filterAll').checked = true;
            
            // Limpiar filtro de categorías
            clearCategoryFilter();
            
            filteredIndicators = [...allIndicators];
            renderIndicators();
            updateCounts();
        }
        
        // ==========================================
        // LIMPIAR SELECCIÓN
        // ==========================================
        
        function clearSelection() {
            if (selectedIndicators.size === 0) {
                showMessage('No hay indicadores seleccionados para limpiar', 'info');
                return;
            }
            
            if (!confirm(`¿Estás seguro de deseleccionar todos los ${selectedIndicators.size} indicadores?`)) {
                return;
            }
            
            selectedIndicators.clear();
            renderIndicators();
            updateCounts();
            showMessage('Selección limpiada', 'info');
        }
        
        // ==========================================
        // GUARDAR CONFIGURACIÓN
        // ==========================================
        
        async function saveConfiguration() {
            if (selectedIndicators.size === 0) {
                showMessage('Selecciona al menos un indicador', 'warning');
                return;
            }
            
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
            
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            try {
                // PASO 1: Eliminar configuración anterior
                await supabaseRequest(`/user_dashboard_indicators?user_id=eq.${currentUser.user_id}`, {
                    method: 'DELETE'
                });
                
                console.log('✅ Configuración anterior eliminada');
                
                // PASO 2: Insertar nueva configuración
                const newConfiguration = Array.from(selectedIndicators).map((indicatorId, index) => ({
                    user_id: currentUser.user_id,
                    indicator_id: indicatorId,
                    display_order: index + 1
                }));
                
                await supabaseRequest('/user_dashboard_indicators', {
                    method: 'POST',
                    body: JSON.stringify(newConfiguration)
                });
                
                console.log(`✅ ${newConfiguration.length} indicadores guardados`);
                
                showMessage(`Configuración guardada exitosamente. ${selectedIndicators.size} indicador${selectedIndicators.size !== 1 ? 'es' : ''} en tu dashboard.`, 'success');
                
                // Opcional: Redirigir al dashboard después de 2 segundos
                setTimeout(() => {
                    if (confirm('¿Deseas ver tu dashboard ahora?')) {
                        window.location.href = 'dashboard.html';
                    }
                }, 1500);
                
            } catch (error) {
                console.error('❌ Error guardando configuración:', error);
                showMessage('Error guardando configuración: ' + error.message, 'danger');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Guardar Configuración';
            }
        }
      // ==========================================
        // UTILIDADES
        // ==========================================
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // ==========================================
        // WRAPPERS PARA MANEJAR ASYNC EN EVENT HANDLERS
        // ==========================================
        
        function handleFilterChange() {
            filterIndicators().catch(error => {
                console.error('Error en filtro:', error);
            });
        }
        
        function handleCategoryToggle(categoryId) {
            toggleCategoryFilter(categoryId);
            filterIndicators().catch(error => {
                console.error('Error en filtro:', error);
            });
        }
        
        // ==========================================
        // FUNCIONES GLOBALES
        // ==========================================
        
        window.loadIndicators = loadIndicators;
        window.toggleIndicator = toggleIndicator;
        window.filterIndicators = filterIndicators;
        window.clearFilters = clearFilters;
        window.clearSelection = clearSelection;
        window.saveConfiguration = saveConfiguration;
        window.toggleCategoryFilter = toggleCategoryFilter;
        window.selectAllCategories = selectAllCategories;
        window.clearCategoryFilter = clearCategoryFilter;
        console.log('🎉 Página de configuración de dashboard cargada correctamente');
    </script>
</body>
</html>
