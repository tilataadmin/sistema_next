<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.25.07.48">
    <title>Configurar Mi Dashboard - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .indicator-item, .variable-item {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
            cursor: pointer;
            background: white;
        }
        
        .indicator-item:hover, .variable-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        .indicator-item.selected, .variable-item.selected {
            border-color: #667eea;
            background-color: #f8f9ff;
        }
        
        .indicator-checkbox, .variable-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .formula-preview {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            color: #495057;
        }
        
        .result-format-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .format-decimal { background-color: #e0f2fe; color: #0c4a6e; }
        .format-percentage { background-color: #f0fdf4; color: #166534; }
        .format-integer { background-color: #fef3c7; color: #92400e; }
        
        .periodicity-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .periodicity-annual { background-color: #dbeafe; color: #1e40af; }
        .periodicity-monthly { background-color: #fef3c7; color: #92400e; }
        
        .selection-summary {
            position: sticky;
            top: 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .nav-tabs .nav-link {
            color: #6c757d;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            color: #667eea;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Guardando configuraci√≥n...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Indicadores</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Configurar Mi Dashboard
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-grid-3x3 me-2"></i>
                    Configurar Mi Dashboard
                </h1>
                <p class="text-muted">
                    Selecciona los indicadores y variables que deseas visualizar en tu dashboard personal
                </p>
            </div>
        </div>

        <!-- ALERTAS -->
        <div id="alertContainer"></div>

        <!-- Informaci√≥n -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex">
                    <div class="me-3">
                        <i class="bi bi-info-circle text-info" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">¬øC√≥mo funciona?</h6>
                        <p class="text-muted mb-0">
                            Marca los <strong>indicadores</strong> (f√≥rmulas calculadas) y las <strong>variables independientes</strong> 
                            (valores individuales) que quieres ver en tu dashboard personal.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Columna izquierda: Lista de indicadores/variables -->
            <div class="col-lg-8">
                <!-- Pesta√±as para Indicadores y Variables -->
                <div class="card mb-4">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="configTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="indicators-tab" data-bs-toggle="tab" 
                                        data-bs-target="#indicators-pane" type="button" role="tab" 
                                        aria-controls="indicators-pane" aria-selected="true">
                                    <i class="bi bi-speedometer2 me-2"></i>Indicadores
                                    <span class="badge bg-primary ms-1" id="indicatorTabCount">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="variables-tab" data-bs-toggle="tab" 
                                        data-bs-target="#variables-pane" type="button" role="tab" 
                                        aria-controls="variables-pane" aria-selected="false">
                                    <i class="bi bi-graph-up me-2"></i>Variables Independientes
                                    <span class="badge bg-secondary ms-1" id="variableTabCount">0</span>
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="configTabContent">
                            <!-- ==================== TAB DE INDICADORES ==================== -->
                            <div class="tab-pane fade show active" id="indicators-pane" role="tabpanel" 
                                 aria-labelledby="indicators-tab">
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">Indicadores Disponibles</h6>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="loadIndicators()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                                    </button>
                                </div>

                                <!-- B√∫squeda y Filtro de Categor√≠as (Indicadores) -->
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <input type="text" class="form-control" id="searchIndicators" 
                                               placeholder="Buscar indicadores..." onkeyup="handleFilterChange()">
                                    </div>
                                    <div class="col-md-4">
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" 
                                                    id="categoryFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-funnel me-2"></i>
                                                <span id="categoryFilterLabel">Todas las categor√≠as</span>
                                            </button>
                                            <div class="dropdown-menu p-3" style="min-width: 300px; max-height: 400px; overflow-y: auto;" 
                                                 onclick="event.stopPropagation();">
                                                <div class="mb-2">
                                                    <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="selectAllCategories()">
                                                        <i class="bi bi-check-all me-1"></i>Seleccionar todas
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary w-100" onclick="clearCategoryFilter()">
                                                        <i class="bi bi-x-circle me-1"></i>Limpiar selecci√≥n
                                                    </button>
                                                </div>
                                                <hr>
                                                <div id="categoryFilterOptions">
                                                    <div class="text-center text-muted py-2">
                                                        <small>Cargando categor√≠as...</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Filtros r√°pidos (Indicadores) -->
                                <div class="mb-3">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="filterTypeIndicators" id="filterAllIndicators" 
                                               value="all" checked onchange="filterIndicators()">
                                        <label class="btn btn-outline-primary" for="filterAllIndicators">
                                            Todos <span class="badge bg-primary" id="countAllIndicators">0</span>
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="filterTypeIndicators" id="filterSelectedIndicators" 
                                               value="selected" onchange="filterIndicators()">
                                        <label class="btn btn-outline-success" for="filterSelectedIndicators">
                                            Seleccionados <span class="badge bg-success" id="countSelectedIndicators">0</span>
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="filterTypeIndicators" id="filterUnselectedIndicators" 
                                               value="unselected" onchange="filterIndicators()">
                                        <label class="btn btn-outline-secondary" for="filterUnselectedIndicators">
                                            No seleccionados <span class="badge bg-secondary" id="countUnselectedIndicators">0</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Contenedor de indicadores -->
                                <div id="indicatorsContainer">
                                    <div class="empty-state">
                                        <div class="spinner-border text-primary"></div>
                                        <p>Cargando indicadores...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- ==================== TAB DE VARIABLES ==================== -->
                            <div class="tab-pane fade" id="variables-pane" role="tabpanel" 
                                 aria-labelledby="variables-tab">
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">Variables Independientes Disponibles</h6>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="loadVariables()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                                    </button>
                                </div>

                                <!-- B√∫squeda (Variables) -->
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <input type="text" class="form-control" id="searchVariables" 
                                               placeholder="Buscar variables..." onkeyup="handleVariableFilterChange()">
                                    </div>
                                </div>
                                
                                <!-- Filtros r√°pidos (Variables) -->
                                <div class="mb-3">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="filterTypeVariables" id="filterAllVariables" 
                                               value="all" checked onchange="filterVariables()">
                                        <label class="btn btn-outline-primary" for="filterAllVariables">
                                            Todos <span class="badge bg-primary" id="countAllVariables">0</span>
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="filterTypeVariables" id="filterSelectedVariables" 
                                               value="selected" onchange="filterVariables()">
                                        <label class="btn btn-outline-success" for="filterSelectedVariables">
                                            Seleccionados <span class="badge bg-success" id="countSelectedVariables">0</span>
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="filterTypeVariables" id="filterUnselectedVariables" 
                                               value="unselected" onchange="filterVariables()">
                                        <label class="btn btn-outline-secondary" for="filterUnselectedVariables">
                                            No seleccionados <span class="badge bg-secondary" id="countUnselectedVariables">0</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Contenedor de variables -->
                                <div id="variablesContainer">
                                    <div class="empty-state">
                                        <div class="spinner-border text-secondary"></div>
                                        <p>Cargando variables...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: Resumen y acciones -->
            <div class="col-lg-4">
                <div class="selection-summary">
                    <h5 class="mb-3">
                        <i class="bi bi-check-circle me-2 text-success"></i>
                        Resumen de Selecci√≥n
                    </h5>
                    
                    <!-- Indicadores seleccionados -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">
                                <i class="bi bi-speedometer2 me-1"></i>Indicadores:
                            </span>
                            <h4 class="mb-0 text-primary" id="selectedIndicatorsCount">0</h4>
                        </div>
                        <div class="progress mb-1" style="height: 6px;">
                            <div class="progress-bar bg-primary" id="selectionProgressIndicators" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted">
                            <span id="selectedIndicatorsPercentage">0</span>% del total
                        </small>
                    </div>
                    
                    <hr>
                    
                    <!-- Variables seleccionadas -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">
                                <i class="bi bi-graph-up me-1"></i>Variables:
                            </span>
                            <h4 class="mb-0 text-secondary" id="selectedVariablesCount">0</h4>
                        </div>
                        <div class="progress mb-1" style="height: 6px;">
                            <div class="progress-bar bg-secondary" id="selectionProgressVariables" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted">
                            <span id="selectedVariablesPercentage">0</span>% del total
                        </small>
                    </div>
                    
                    <div class="alert alert-info mb-4" id="recommendationAlert">
                        <i class="bi bi-lightbulb me-2"></i>
                        <small>Selecciona al menos un indicador o variable para crear tu dashboard.</small>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" id="saveBtn" onclick="saveConfiguration()" disabled>
                            <i class="bi bi-check-circle me-2"></i>Guardar Configuraci√≥n
                        </button>
                        <a href="dashboard.html" class="btn btn-outline-primary">
                            <i class="bi bi-bar-chart-line me-2"></i>Ver Mi Dashboard
                        </a>
                        <button class="btn btn-outline-secondary" onclick="clearAllSelections()">
                            <i class="bi bi-x-circle me-2"></i>Limpiar Todo
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VALIDACI√ìN DE ACCESO
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Configurar mi dashboard');
                
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido');
                initializePage();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let allIndicators = [];
        let filteredIndicators = [];
        let selectedIndicators = new Set();
        
        let allVariables = [];
        let filteredVariables = [];
        let selectedVariables = new Set();
        
        let availableCategories = [];
        let selectedCategoryFilters = [];
        let currentUser = null;
        
        let allIndicatorsLoaded = false;
        let allVariablesLoaded = false;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        
        async function initializePage() {
            console.log('üîß Inicializando configuraci√≥n de dashboard');
            
            try {
                getCurrentUser();
                await loadCategories();
                await loadIndicators();
                await loadVariables();
                
                console.log('‚úÖ P√°gina inicializada');
                
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al inicializar la p√°gina: ' + error.message, 'danger');
            }
        }
        
        function getCurrentUser() {
            try {
                const session = localStorage.getItem('nextSystemSession') || 
                               sessionStorage.getItem('nextSystemSession');
                if (session) {
                    const sessionData = JSON.parse(session);
                    currentUser = sessionData.user;
                    console.log('üë§ Usuario:', currentUser.user_display_name || currentUser.user_name);
                }
            } catch (error) {
                console.error('‚ùå Error obteniendo sesi√≥n:', error);
            }
        }
        
        // ==========================================
        // CARGAR CATEGOR√çAS
        // ==========================================
        
        async function loadCategories() {
            try {
                const categories = await supabaseRequest('/indicator_categories?select=*&is_active=eq.true&order=category_order.asc,category_name.asc');
                availableCategories = categories || [];
                
                const savedFilters = localStorage.getItem('dashboardCategoryFilters');
                if (savedFilters) {
                    try {
                        selectedCategoryFilters = JSON.parse(savedFilters);
                    } catch (e) {
                        selectedCategoryFilters = [];
                    }
                }
                
                renderCategoryFilterOptions();
                updateCategoryFilterLabel();
                
                console.log(`‚úÖ ${availableCategories.length} categor√≠as cargadas`);
            } catch (error) {
                console.error('‚ùå Error cargando categor√≠as:', error);
                availableCategories = [];
            }
        }

        function renderCategoryFilterOptions() {
            const container = document.getElementById('categoryFilterOptions');
            
            if (!container) {
                console.error('Contenedor de opciones de categor√≠as no encontrado');
                return;
            }
            
            if (availableCategories.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-2">
                        <small>No hay categor√≠as disponibles</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            availableCategories.forEach(category => {
                const isChecked = selectedCategoryFilters.includes(category.category_id);
                html += `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" 
                               id="catFilter_${category.category_id}" 
                               value="${category.category_id}"
                               ${isChecked ? 'checked' : ''}
                               onchange="handleCategoryToggle('${category.category_id}')">
                        <label class="form-check-label d-flex align-items-center" 
                               for="catFilter_${category.category_id}">
                            <span class="badge me-2" 
                                  style="background-color: ${category.category_color}; width: 20px; height: 20px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-${category.category_icon}" style="font-size: 0.7rem;"></i>
                            </span>
                            <span>${category.category_name}</span>
                        </label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function toggleCategoryFilter(categoryId) {
            const index = selectedCategoryFilters.indexOf(categoryId);
            
            if (index > -1) {
                selectedCategoryFilters.splice(index, 1);
            } else {
                selectedCategoryFilters.push(categoryId);
            }
            
            localStorage.setItem('dashboardCategoryFilters', JSON.stringify(selectedCategoryFilters));
            
            updateCategoryFilterLabel();
        }
        
        function updateCategoryFilterLabel() {
            const label = document.getElementById('categoryFilterLabel');
            
            if (!label) return;
            
            if (selectedCategoryFilters.length === 0) {
                label.innerHTML = 'Todas las categor√≠as';
            } else if (selectedCategoryFilters.length === 1) {
                const category = availableCategories.find(c => c.category_id === selectedCategoryFilters[0]);
                label.innerHTML = category ? category.category_name : '1 categor√≠a';
            } else {
                label.innerHTML = `${selectedCategoryFilters.length} categor√≠as`;
            }
        }
        
        async function selectAllCategories() {
            selectedCategoryFilters = availableCategories.map(c => c.category_id);
            localStorage.setItem('dashboardCategoryFilters', JSON.stringify(selectedCategoryFilters));
            renderCategoryFilterOptions();
            updateCategoryFilterLabel();
            await filterIndicators();
        }
        
        async function clearCategoryFilter() {
            selectedCategoryFilters = [];
            localStorage.removeItem('dashboardCategoryFilters');
            renderCategoryFilterOptions();
            updateCategoryFilterLabel();
            await filterIndicators();
        }
        
        // ==========================================
        // CARGAR INDICADORES Y SELECCI√ìN
        // ==========================================
        
        async function loadIndicators() {
            const container = document.getElementById('indicatorsContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="spinner-border text-primary"></div>
                    <p>Cargando indicadores...</p>
                </div>
            `;
            
            try {
                // üî• CARGAR TODOS LOS INDICADORES ACTIVOS DEL SISTEMA (sin filtro de owner)
                const indicators = await supabaseRequest(`/indicators?select=*,users!indicators_owner_id_fkey(user_display_name,user_name)&indicator_status=eq.active&order=indicator_name`);
                allIndicators = indicators || [];
                
                for (let indicator of allIndicators) {
                    const assignments = await supabaseRequest(`/indicator_category_assignments?select=indicator_categories(*)&indicator_id=eq.${indicator.indicator_id}`);
                    indicator.categories = assignments ? assignments.map(a => a.indicator_categories) : [];
                }
                
                if (currentUser) {
                    const userSelection = await supabaseRequest(`/user_dashboard_indicators?select=indicator_id&user_id=eq.${currentUser.user_id}`);
                    
                    selectedIndicators = new Set(
                        (userSelection || []).map(item => item.indicator_id)
                    );
                }
                
                filteredIndicators = [...allIndicators];
                renderIndicators();
                updateCounts();
                
                console.log(`‚úÖ ${allIndicators.length} indicadores cargados`);
                console.log(`‚úÖ ${selectedIndicators.size} indicadores seleccionados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando indicadores:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        <h6>Error cargando indicadores</h6>
                        <p class="text-muted">${error.message}</p>
                        <button class="btn btn-outline-primary" onclick="loadIndicators()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Reintentar
                        </button>
                    </div>
                `;
            }
        }

        async function loadAllIndicators() {
            if (allIndicatorsLoaded) {
                return;
            }
            
            try {
                console.log('üì• Cargando TODOS los indicadores...');
                
                const indicators = await supabaseRequest('/indicators?select=*,users!indicators_owner_id_fkey(user_display_name,user_name)&indicator_status=eq.active&order=indicator_name');
                allIndicators = indicators || [];
                
                for (let indicator of allIndicators) {
                    const assignments = await supabaseRequest(`/indicator_category_assignments?select=indicator_categories(*)&indicator_id=eq.${indicator.indicator_id}`);
                    indicator.categories = assignments ? assignments.map(a => a.indicator_categories) : [];
                }
                
                allIndicatorsLoaded = true;
                filteredIndicators = [...allIndicators];
                
                console.log(`‚úÖ ${allIndicators.length} indicadores totales cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando todos los indicadores:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR VARIABLES Y SELECCI√ìN
        // ==========================================
        
        async function loadVariables() {
            const container = document.getElementById('variablesContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="spinner-border text-secondary"></div>
                    <p>Cargando variables...</p>
                </div>
            `;
            
            try {
                // üî• CARGAR TODAS LAS VARIABLES ACTIVAS DEL SISTEMA (sin filtro de owner)
                const variables = await supabaseRequest(`/variables?select=*,users!variables_owner_id_fkey(user_display_name,user_name)&variable_status=eq.active&order=variable_name`);
                allVariables = variables || [];
                
                if (currentUser) {
                    const userSelection = await supabaseRequest(`/user_dashboard_variables?select=variable_id&user_id=eq.${currentUser.user_id}`);
                    
                    selectedVariables = new Set(
                        (userSelection || []).map(item => item.variable_id)
                    );
                }
                
                filteredVariables = [...allVariables];
                renderVariables();
                updateCounts();
                
                console.log(`‚úÖ ${allVariables.length} variables cargadas`);
                console.log(`‚úÖ ${selectedVariables.size} variables seleccionadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando variables:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        <h6>Error cargando variables</h6>
                        <p class="text-muted">${error.message}</p>
                        <button class="btn btn-outline-secondary" onclick="loadVariables()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Reintentar
                        </button>
                    </div>
                `;
            }
        }

        async function loadAllVariables() {
            if (allVariablesLoaded) {
                return;
            }
            
            try {
                console.log('üì• Cargando TODAS las variables...');
                
                const variables = await supabaseRequest('/variables?select=*,users!variables_owner_id_fkey(user_display_name,user_name)&variable_status=eq.active&order=variable_name');
                allVariables = variables || [];
                
                allVariablesLoaded = true;
                filteredVariables = [...allVariables];
                
                console.log(`‚úÖ ${allVariables.length} variables totales cargadas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando todas las variables:', error);
                throw error;
            }
        }
        
        // ==========================================
        // RENDERIZAR INDICADORES
        // ==========================================
        
        function renderIndicators() {
            const container = document.getElementById('indicatorsContainer');
            
            if (filteredIndicators.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-search text-muted"></i>
                        <h6>No se encontraron indicadores</h6>
                        <p class="text-muted">
                            ${allIndicators.length === 0 ? 
                                'No hay indicadores activos en el sistema.' : 
                                'Intenta con otro filtro de b√∫squeda.'}
                        </p>
                        ${allIndicators.length > 0 ? 
                            '<button class="btn btn-outline-secondary" onclick="clearFilters()">Limpiar Filtros</button>' : 
                            ''}
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            filteredIndicators.forEach(indicator => {
                const isSelected = selectedIndicators.has(indicator.indicator_id);
                const ownerName = indicator.users ? 
                    (indicator.users.user_display_name || indicator.users.user_name) : 'Sin propietario';
                
                html += `
                    <div class="indicator-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleIndicator('${indicator.indicator_id}')">
                        <div class="d-flex align-items-start">
                            <div class="me-3">
                                <input type="checkbox" class="indicator-checkbox" 
                                       ${isSelected ? 'checked' : ''} 
                                       onclick="event.stopPropagation(); toggleIndicator('${indicator.indicator_id}')">
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-1">${escapeHtml(indicator.indicator_name)}</h6>
                                    <span class="result-format-badge format-${indicator.result_format}">
                                        ${indicator.result_format.toUpperCase()}
                                    </span>
                                </div>
                                
                                ${indicator.indicator_description ? 
                                    `<p class="text-muted small mb-2">${escapeHtml(indicator.indicator_description)}</p>` : 
                                    ''}
                                
                                <div class="formula-preview">
                                    ${escapeHtml(indicator.formula_expression)}
                                </div>
                                
                                ${indicator.categories && indicator.categories.length > 0 ? `
                                <div class="mt-2 mb-2">
                                    <small class="text-muted d-block mb-1">Categor√≠as:</small>
                                    <div class="d-flex flex-wrap gap-1">
                                        ${indicator.categories.map(cat => `
                                            <span class="badge" style="background-color: ${cat.category_color || '#6c757d'}; font-size: 0.7rem;">
                                                <i class="bi bi-${cat.category_icon || 'folder'} me-1"></i>${cat.category_name}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-person me-1"></i>${ownerName}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ==========================================
        // RENDERIZAR VARIABLES
        // ==========================================
        
        function renderVariables() {
            const container = document.getElementById('variablesContainer');
            
            if (filteredVariables.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-search text-muted"></i>
                        <h6>No se encontraron variables</h6>
                        <p class="text-muted">
                            ${allVariables.length === 0 ? 
                                'No hay variables activas en el sistema.' : 
                                'Intenta con otro filtro de b√∫squeda.'}
                        </p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            filteredVariables.forEach(variable => {
                const isSelected = selectedVariables.has(variable.variable_id);
                const ownerName = variable.users ? 
                    (variable.users.user_display_name || variable.users.user_name) : 'Sin propietario';
                
                html += `
                    <div class="variable-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleVariable('${variable.variable_id}')">
                        <div class="d-flex align-items-start">
                            <div class="me-3">
                                <input type="checkbox" class="variable-checkbox" 
                                       ${isSelected ? 'checked' : ''} 
                                       onclick="event.stopPropagation(); toggleVariable('${variable.variable_id}')">
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-1">${escapeHtml(variable.variable_name)}</h6>
                                    <div>
                                        <span class="result-format-badge format-${variable.data_type}">
                                            ${variable.data_type.toUpperCase()}
                                        </span>
                                        <span class="periodicity-badge periodicity-${variable.periodicity} ms-1">
                                            ${variable.periodicity === 'annual' ? 'ANUAL' : 'MENSUAL'}
                                        </span>
                                    </div>
                                </div>
                                
                                ${variable.variable_description ? 
                                    `<p class="text-muted small mb-2">${escapeHtml(variable.variable_description)}</p>` : 
                                    ''}
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-person me-1"></i>${ownerName}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // TOGGLE SELECCI√ìN
        // ==========================================
        
        function toggleIndicator(indicatorId) {
            if (selectedIndicators.has(indicatorId)) {
                selectedIndicators.delete(indicatorId);
            } else {
                selectedIndicators.add(indicatorId);
            }
            
            renderIndicators();
            updateCounts();
        }
        
        function toggleVariable(variableId) {
            if (selectedVariables.has(variableId)) {
                selectedVariables.delete(variableId);
            } else {
                selectedVariables.add(variableId);
            }
            
            renderVariables();
            updateCounts();
        }
        
        // ==========================================
        // ACTUALIZAR CONTADORES Y RESUMEN
        // ==========================================
        
        function updateCounts() {
            // Contadores de indicadores
            const totalIndicators = filteredIndicators.length;
            const selectedIndicatorsCount = filteredIndicators.filter(ind => selectedIndicators.has(ind.indicator_id)).length;
            const unselectedIndicatorsCount = totalIndicators - selectedIndicatorsCount;
            
            document.getElementById('countAllIndicators').textContent = totalIndicators;
            document.getElementById('countSelectedIndicators').textContent = selectedIndicatorsCount;
            document.getElementById('countUnselectedIndicators').textContent = unselectedIndicatorsCount;
            
            // Contadores de variables
            const totalVariables = filteredVariables.length;
            const selectedVariablesCount = filteredVariables.filter(v => selectedVariables.has(v.variable_id)).length;
            const unselectedVariablesCount = totalVariables - selectedVariablesCount;
            
            document.getElementById('countAllVariables').textContent = totalVariables;
            document.getElementById('countSelectedVariables').textContent = selectedVariablesCount;
            document.getElementById('countUnselectedVariables').textContent = unselectedVariablesCount;
            
            // Actualizar badges en tabs
            document.getElementById('indicatorTabCount').textContent = selectedIndicators.size;
            document.getElementById('variableTabCount').textContent = selectedVariables.size;
            
            // Actualizar resumen lateral - Indicadores
            document.getElementById('selectedIndicatorsCount').textContent = selectedIndicators.size;
            const percentageIndicators = totalIndicators > 0 ? Math.round((selectedIndicatorsCount / totalIndicators) * 100) : 0;
            document.getElementById('selectedIndicatorsPercentage').textContent = percentageIndicators;
            document.getElementById('selectionProgressIndicators').style.width = percentageIndicators + '%';
            
            // Actualizar resumen lateral - Variables
            document.getElementById('selectedVariablesCount').textContent = selectedVariables.size;
            const percentageVariables = totalVariables > 0 ? Math.round((selectedVariablesCount / totalVariables) * 100) : 0;
            document.getElementById('selectedVariablesPercentage').textContent = percentageVariables;
            document.getElementById('selectionProgressVariables').style.width = percentageVariables + '%';
            
            // Actualizar bot√≥n de guardar
            const saveBtn = document.getElementById('saveBtn');
            const totalSelected = selectedIndicators.size + selectedVariables.size;
            saveBtn.disabled = totalSelected === 0;
            
            // Actualizar recomendaci√≥n
            const recommendationAlert = document.getElementById('recommendationAlert');
            if (totalSelected === 0) {
                recommendationAlert.className = 'alert alert-info mb-4';
                recommendationAlert.innerHTML = '<i class="bi bi-lightbulb me-2"></i><small>Selecciona al menos un indicador o variable para crear tu dashboard.</small>';
            } else if (totalSelected >= 15) {
                recommendationAlert.className = 'alert alert-warning mb-4';
                recommendationAlert.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i><small>Has seleccionado muchos elementos. Considera reducir para mejor visualizaci√≥n.</small>';
            } else {
                recommendationAlert.className = 'alert alert-success mb-4';
                recommendationAlert.innerHTML = `<i class="bi bi-check-circle me-2"></i><small>Perfecto. ${totalSelected} elemento${totalSelected !== 1 ? 's' : ''} seleccionado${totalSelected !== 1 ? 's' : ''}.</small>`;
            }
        }
        
        // ==========================================
        // FILTRADO
        // ==========================================
        
        async function filterIndicators() {
            const searchTerm = document.getElementById('searchIndicators').value.toLowerCase();
            const filterType = document.querySelector('input[name="filterTypeIndicators"]:checked').value;
            const hasActiveFilters = searchTerm || selectedCategoryFilters.length > 0;
            
            if (hasActiveFilters && !allIndicatorsLoaded) {
                mostrarLoading();
                try {
                    await loadAllIndicators();
                } catch (error) {
                    ocultarLoading();
                    showMessage('Error cargando indicadores: ' + error.message, 'danger');
                    return;
                }
                ocultarLoading();
            }
            
            filteredIndicators = allIndicators.filter(indicator => {
                const matchesSearch = !searchTerm || 
                    indicator.indicator_name.toLowerCase().includes(searchTerm) ||
                    (indicator.indicator_description && indicator.indicator_description.toLowerCase().includes(searchTerm)) ||
                    indicator.formula_expression.toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return false;
                
                const matchesCategory = selectedCategoryFilters.length === 0 || 
                    (indicator.categories && indicator.categories.some(cat => selectedCategoryFilters.includes(cat.category_id)));
                
                if (!matchesCategory) return false;
                
                const isSelected = selectedIndicators.has(indicator.indicator_id);
                
                switch (filterType) {
                    case 'selected':
                        return isSelected;
                    case 'unselected':
                        return !isSelected;
                    case 'all':
                    default:
                        return true;
                }
            });
            
            renderIndicators();
            updateCounts();
            console.log(`üîç Filtrado indicadores: ${filteredIndicators.length} de ${allIndicators.length}`);
        }
        
        async function filterVariables() {
            const searchTerm = document.getElementById('searchVariables').value.toLowerCase();
            const filterType = document.querySelector('input[name="filterTypeVariables"]:checked').value;
            const hasActiveFilters = searchTerm;
            
            if (hasActiveFilters && !allVariablesLoaded) {
                mostrarLoading();
                try {
                    await loadAllVariables();
                } catch (error) {
                    ocultarLoading();
                    showMessage('Error cargando variables: ' + error.message, 'danger');
                    return;
                }
                ocultarLoading();
            }
            
            filteredVariables = allVariables.filter(variable => {
                const matchesSearch = !searchTerm || 
                    variable.variable_name.toLowerCase().includes(searchTerm) ||
                    (variable.variable_description && variable.variable_description.toLowerCase().includes(searchTerm));
                
                if (!matchesSearch) return false;
                
                const isSelected = selectedVariables.has(variable.variable_id);
                
                switch (filterType) {
                    case 'selected':
                        return isSelected;
                    case 'unselected':
                        return !isSelected;
                    case 'all':
                    default:
                        return true;
                }
            });
            
            renderVariables();
            updateCounts();
            console.log(`üîç Filtrado variables: ${filteredVariables.length} de ${allVariables.length}`);
        }
        
        function clearFilters() {
            document.getElementById('searchIndicators').value = '';
            document.getElementById('filterAllIndicators').checked = true;
            clearCategoryFilter();
            
            filteredIndicators = [...allIndicators];
            renderIndicators();
            updateCounts();
        }
        
        // ==========================================
        // LIMPIAR SELECCI√ìN
        // ==========================================
        
        function clearAllSelections() {
            const totalSelected = selectedIndicators.size + selectedVariables.size;
            
            if (totalSelected === 0) {
                showMessage('No hay elementos seleccionados para limpiar', 'info');
                return;
            }
            
            if (!confirm(`¬øEst√°s seguro de deseleccionar todos los ${totalSelected} elementos?`)) {
                return;
            }
            
            selectedIndicators.clear();
            selectedVariables.clear();
            renderIndicators();
            renderVariables();
            updateCounts();
            showMessage('Selecci√≥n limpiada', 'info');
        }
        
        // ==========================================
        // GUARDAR CONFIGURACI√ìN
        // ==========================================
        
        async function saveConfiguration() {
            const totalSelected = selectedIndicators.size + selectedVariables.size;
            
            if (totalSelected === 0) {
                showMessage('Selecciona al menos un indicador o variable', 'warning');
                return;
            }
            
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
            
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            try {
                // PASO 1: Eliminar configuraci√≥n anterior de indicadores
                await supabaseRequest(`/user_dashboard_indicators?user_id=eq.${currentUser.user_id}`, {
                    method: 'DELETE'
                });
                
                // PASO 2: Eliminar configuraci√≥n anterior de variables
                await supabaseRequest(`/user_dashboard_variables?user_id=eq.${currentUser.user_id}`, {
                    method: 'DELETE'
                });
                
                console.log('‚úÖ Configuraci√≥n anterior eliminada');
                
                // PASO 3: Insertar nueva configuraci√≥n de indicadores
                if (selectedIndicators.size > 0) {
                    const indicatorConfiguration = Array.from(selectedIndicators).map((indicatorId, index) => ({
                        user_id: currentUser.user_id,
                        indicator_id: indicatorId,
                        display_order: index + 1
                    }));
                    
                    await supabaseRequest('/user_dashboard_indicators', {
                        method: 'POST',
                        body: JSON.stringify(indicatorConfiguration)
                    });
                    
                    console.log(`‚úÖ ${indicatorConfiguration.length} indicadores guardados`);
                }
                
                // PASO 4: Insertar nueva configuraci√≥n de variables
                if (selectedVariables.size > 0) {
                    const variableConfiguration = Array.from(selectedVariables).map((variableId, index) => ({
                        user_id: currentUser.user_id,
                        variable_id: variableId,
                        display_order: index + 1
                    }));
                    
                    await supabaseRequest('/user_dashboard_variables', {
                        method: 'POST',
                        body: JSON.stringify(variableConfiguration)
                    });
                    
                    console.log(`‚úÖ ${variableConfiguration.length} variables guardadas`);
                }
                
                showMessage(`Configuraci√≥n guardada exitosamente. ${totalSelected} elemento${totalSelected !== 1 ? 's' : ''} en tu dashboard.`, 'success');
                
                setTimeout(() => {
                    if (confirm('¬øDeseas ver tu dashboard ahora?')) {
                        window.location.href = 'dashboard.html';
                    }
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Error guardando configuraci√≥n:', error);
                showMessage('Error guardando configuraci√≥n: ' + error.message, 'danger');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Guardar Configuraci√≥n';
            }
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // ==========================================
        // WRAPPERS PARA MANEJAR ASYNC EN EVENT HANDLERS
        // ==========================================
        
        function handleFilterChange() {
            filterIndicators().catch(error => {
                console.error('Error en filtro:', error);
            });
        }
        
        function handleVariableFilterChange() {
            filterVariables().catch(error => {
                console.error('Error en filtro:', error);
            });
        }
        
        function handleCategoryToggle(categoryId) {
            toggleCategoryFilter(categoryId);
            filterIndicators().catch(error => {
                console.error('Error en filtro:', error);
            });
        }
        
        // ==========================================
        // FUNCIONES GLOBALES
        // ==========================================
        
        window.loadIndicators = loadIndicators;
        window.loadVariables = loadVariables;
        window.toggleIndicator = toggleIndicator;
        window.toggleVariable = toggleVariable;
        window.filterIndicators = filterIndicators;
        window.filterVariables = filterVariables;
        window.clearFilters = clearFilters;
        window.clearAllSelections = clearAllSelections;
        window.saveConfiguration = saveConfiguration;
        window.toggleCategoryFilter = toggleCategoryFilter;
        window.selectAllCategories = selectAllCategories;
        window.clearCategoryFilter = clearCategoryFilter;
        
        console.log('üéâ P√°gina de configuraci√≥n de dashboard cargada correctamente');
    </script>
</body>
</html>
