<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categorías de Indicadores - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .category-card {
            transition: all 0.2s ease;
            cursor: pointer;
            border-left: 4px solid;
        }
        
        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .category-icon-preview {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .color-picker-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }
        
        .color-picker-option:hover {
            transform: scale(1.1);
        }
        
        .color-picker-option.selected {
            border-color: #000;
            transform: scale(1.15);
        }
        
        .icon-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .icon-option {
            width: 50px;
            height: 50px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.5rem;
        }
        
        .icon-option:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        
        .icon-option.selected {
            border-color: #0d6efd;
            background-color: #e7f1ff;
            border-width: 3px;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Indicadores</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Categorías
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-tags me-2"></i>
                    Categorías de Indicadores
                </h1>
                <p class="text-muted">
                    Organiza tus indicadores por áreas temáticas
                </p>
            </div>
        </div>

        <!-- ALERTAS -->
        <div id="alertContainer"></div>

        <!-- CONTROLES -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0"><i class="bi bi-tags me-2"></i>Categorías del Sistema</h5>
                    <small class="text-muted">Administra las categorías para organizar indicadores</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" onclick="loadCategories()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                    <button class="btn btn-primary" onclick="showCreateForm()">
                        <i class="bi bi-plus-circle me-1"></i>Nueva Categoría
                    </button>
                </div>
            </div>
            
            <!-- CONTENEDOR DE CATEGORÍAS -->
            <div class="card-body" id="categoriesContainer">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando categorías...</p>
                </div>
            </div>
        </div>

    </div>
    <!-- MODAL DE CREAR/EDITAR CATEGORÍA -->
    <div class="modal fade" id="categoryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalTitle">
                        <i class="bi bi-plus-circle me-2"></i>Nueva Categoría
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        
                        <!-- Nombre -->
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">
                                Nombre de la Categoría <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="categoryName" required 
                                   placeholder="Ej: Estrategia, Finanzas, Academia">
                        </div>
                        
                        <!-- Descripción -->
                        <div class="mb-3">
                            <label for="categoryDescription" class="form-label">Descripción</label>
                            <textarea class="form-control" id="categoryDescription" rows="3"
                                      placeholder="Descripción opcional de la categoría"></textarea>
                        </div>
                        
                        <!-- Selector de Icono -->
                        <div class="mb-3">
                            <label class="form-label">Icono <span class="text-danger">*</span></label>
                            <div class="d-flex gap-3 align-items-start">
                                <div>
                                    <div class="category-icon-preview border" id="iconPreview" 
                                         style="background-color: #6c757d; color: white;">
                                        <i class="bi bi-folder"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <input type="text" class="form-control mb-2" id="iconSearch" 
                                           placeholder="Buscar icono...">
                                    <div class="icon-picker-grid" id="iconPickerGrid">
                                        <!-- Iconos se cargan dinámicamente -->
                                    </div>
                                    <input type="hidden" id="categoryIcon" value="folder" required>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Selector de Color -->
                        <div class="mb-3">
                            <label class="form-label">Color <span class="text-danger">*</span></label>
                            <div class="d-flex gap-2 flex-wrap">
                                <div class="color-picker-option selected" 
                                     style="background-color: #6c757d;" 
                                     data-color="#6c757d" 
                                     onclick="selectColor('#6c757d')"></div>
                                <div class="color-picker-option" 
                                     style="background-color: #dc3545;" 
                                     data-color="#dc3545" 
                                     onclick="selectColor('#dc3545')"></div>
                                <div class="color-picker-option" 
                                     style="background-color: #fd7e14;" 
                                     data-color="#fd7e14" 
                                     onclick="selectColor('#fd7e14')"></div>
                                <div class="color-picker-option" 
                                     style="background-color: #ffc107;" 
                                     data-color="#ffc107" 
                                     onclick="selectColor('#ffc107')"></div>
                                <div class="color-picker-option" 
                                     style="background-color: #198754;" 
                                     data-color="#198754" 
                                     onclick="selectColor('#198754')"></div>
                                <div class="color-picker-option" 
                                     style="background-color: #0d6efd;" 
                                     data-color="#0d6efd" 
                                     onclick="selectColor('#0d6efd')"></div>
                                <div class="color-picker-option" 
                                     style="background-color: #6f42c1;" 
                                     data-color="#6f42c1" 
                                     onclick="selectColor('#6f42c1')"></div>
                                <div class="color-picker-option" 
                                     style="background-color: #d63384;" 
                                     data-color="#d63384" 
                                     onclick="selectColor('#d63384')"></div>
                                <div class="color-picker-option" 
                                     style="background-color: #20c997;" 
                                     data-color="#20c997" 
                                     onclick="selectColor('#20c997')"></div>
                                <div class="color-picker-option" 
                                     style="background-color: #0dcaf0;" 
                                     data-color="#0dcaf0" 
                                     onclick="selectColor('#0dcaf0')"></div>
                            </div>
                            <input type="hidden" id="categoryColor" value="#6c757d" required>
                        </div>
                        
                        <!-- Orden -->
                        <div class="mb-3">
                            <label for="categoryOrder" class="form-label">Orden de visualización</label>
                            <input type="number" class="form-control" id="categoryOrder" 
                                   value="1" min="1" step="1">
                            <small class="text-muted">Define el orden en que aparecerá la categoría</small>
                        </div>
                        
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="submitBtn" onclick="saveCategory()">
                        <i class="bi bi-check-circle me-1"></i>Guardar Categoría
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let allCategories = [];
        let currentCategoryId = null;
        let modalInstance = null;
        
        // Iconos disponibles de Bootstrap Icons
        const availableIcons = [
            'folder', 'tags', 'bookmark', 'flag', 'star', 'heart',
            'compass', 'megaphone', 'book', 'currency-dollar', 'people',
            'gear', 'tree', 'mortarboard', 'briefcase', 'graph-up',
            'bar-chart', 'pie-chart', 'clipboard-data', 'bank', 'building',
            'award', 'trophy', 'lightbulb', 'rocket', 'shield',
            'file-text', 'calendar', 'clock', 'bell', 'envelope'
        ];
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('🔧 Inicializando página de categorías...');
                
                // Verificar sesión
                const session = getStoredSession();
                if (!session || !session.user) {
                    window.location.href = '/login.html';
                    return;
                }
                currentUser = session.user;
                
                // Verificar permiso
                const hasPermission = await checkPagePermission();
                if (!hasPermission) {
                    showMessage('No tienes permiso para acceder a esta página', 'danger');
                    setTimeout(() => {
                        window.location.href = '../../dashboard.html';
                    }, 2000);
                    return;
                }
                
                // Inicializar modal
                modalInstance = new bootstrap.Modal(document.getElementById('categoryModal'));
                
                // Cargar iconos en el picker
                renderIconPicker();
                
                // Configurar búsqueda de iconos
                document.getElementById('iconSearch').addEventListener('input', filterIcons);
                
                // Cargar categorías
                await loadCategories();
                
                console.log('✅ Página inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
            }
        });
        
        // ==========================================
        // CARGAR CATEGORÍAS
        // ==========================================
        async function loadCategories() {
            try {
                console.log('📊 Cargando categorías...');
                
                const categories = await supabaseRequest('/indicator_categories?select=*&order=category_order.asc,category_name.asc');
                
                allCategories = categories || [];
                renderCategories();
                
                console.log(`✅ ${allCategories.length} categorías cargadas`);
                
            } catch (error) {
                console.error('❌ Error cargando categorías:', error);
                showMessage('Error al cargar categorías: ' + error.message, 'danger');
                document.getElementById('categoriesContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        <h6>Error al cargar</h6>
                        <p>No se pudieron cargar las categorías</p>
                    </div>
                `;
            }
        }
        
        // ==========================================
        // RENDERIZAR CATEGORÍAS
        // ==========================================
        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            
            if (allCategories.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-tags text-muted"></i>
                        <h6>No hay categorías</h6>
                        <p class="text-muted">Crea la primera categoría para organizar tus indicadores</p>
                        <button class="btn btn-primary" onclick="showCreateForm()">
                            <i class="bi bi-plus-circle me-1"></i>Nueva Categoría
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="row g-3">';
            
            allCategories.forEach(category => {
                const isActive = category.is_active;
                const statusBadge = isActive 
                    ? '<span class="badge bg-success">Activa</span>' 
                    : '<span class="badge bg-secondary">Inactiva</span>';
                
                html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="card category-card h-100 ${!isActive ? 'opacity-50' : ''}" 
                             style="border-left-color: ${category.category_color};">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="category-icon-preview" 
                                         style="background-color: ${category.category_color}; color: white;">
                                        <i class="bi bi-${category.category_icon}"></i>
                                    </div>
                                    ${statusBadge}
                                </div>
                                
                                <h6 class="card-title mb-2">${category.category_name}</h6>
                                <p class="card-text text-muted small mb-3">
                                    ${category.category_description || 'Sin descripción'}
                                </p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Orden: ${category.category_order}</small>
                                    
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" 
                                                onclick="editCategory('${category.category_id}')" 
                                                title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-${isActive ? 'warning' : 'success'}" 
                                                onclick="toggleCategoryStatus('${category.category_id}', ${isActive})" 
                                                title="${isActive ? 'Desactivar' : 'Activar'}">
                                            <i class="bi bi-${isActive ? 'pause' : 'play'}"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // ==========================================
        // RENDERIZAR SELECTOR DE ICONOS
        // ==========================================
        function renderIconPicker() {
            const grid = document.getElementById('iconPickerGrid');
            let html = '';
            
            availableIcons.forEach(icon => {
                html += `
                    <div class="icon-option ${icon === 'folder' ? 'selected' : ''}" 
                         data-icon="${icon}" 
                         onclick="selectIcon('${icon}')">
                        <i class="bi bi-${icon}"></i>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        // ==========================================
        // FILTRAR ICONOS
        // ==========================================
        function filterIcons() {
            const searchTerm = document.getElementById('iconSearch').value.toLowerCase();
            const iconOptions = document.querySelectorAll('.icon-option');
            
            iconOptions.forEach(option => {
                const iconName = option.getAttribute('data-icon');
                if (iconName.includes(searchTerm)) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }
      // ==========================================
        // SELECCIONAR ICONO
        // ==========================================
        function selectIcon(iconName) {
            // Remover selección previa
            document.querySelectorAll('.icon-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Seleccionar nuevo icono
            const selectedOption = document.querySelector(`.icon-option[data-icon="${iconName}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            // Actualizar preview
            const currentColor = document.getElementById('categoryColor').value;
            document.getElementById('iconPreview').innerHTML = `<i class="bi bi-${iconName}"></i>`;
            document.getElementById('iconPreview').style.backgroundColor = currentColor;
            
            // Guardar valor
            document.getElementById('categoryIcon').value = iconName;
        }
        
        // ==========================================
        // SELECCIONAR COLOR
        // ==========================================
        function selectColor(colorHex) {
            // Remover selección previa
            document.querySelectorAll('.color-picker-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Seleccionar nuevo color
            const selectedOption = document.querySelector(`.color-picker-option[data-color="${colorHex}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            // Actualizar preview
            document.getElementById('iconPreview').style.backgroundColor = colorHex;
            
            // Guardar valor
            document.getElementById('categoryColor').value = colorHex;
        }
        
        // ==========================================
        // MOSTRAR FORMULARIO DE CREACIÓN
        // ==========================================
        function showCreateForm() {
            currentCategoryId = null;
            
            // Resetear formulario
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryModalTitle').innerHTML = 
                '<i class="bi bi-plus-circle me-2"></i>Nueva Categoría';
            document.getElementById('submitBtn').innerHTML = 
                '<i class="bi bi-check-circle me-1"></i>Guardar Categoría';
            
            // Resetear selecciones
            selectIcon('folder');
            selectColor('#6c757d');
            document.getElementById('categoryOrder').value = (allCategories.length + 1);
            
            // Mostrar modal
            modalInstance.show();
        }
        
        // ==========================================
        // EDITAR CATEGORÍA
        // ==========================================
        async function editCategory(categoryId) {
            try {
                currentCategoryId = categoryId;
                
                const category = allCategories.find(c => c.category_id === categoryId);
                if (!category) {
                    showMessage('Categoría no encontrada', 'danger');
                    return;
                }
                
                // Llenar formulario
                document.getElementById('categoryName').value = category.category_name;
                document.getElementById('categoryDescription').value = category.category_description || '';
                document.getElementById('categoryOrder').value = category.category_order;
                
                // Seleccionar icono y color
                selectIcon(category.category_icon);
                selectColor(category.category_color);
                
                // Actualizar título
                document.getElementById('categoryModalTitle').innerHTML = 
                    '<i class="bi bi-pencil me-2"></i>Editar Categoría';
                document.getElementById('submitBtn').innerHTML = 
                    '<i class="bi bi-check-circle me-1"></i>Actualizar Categoría';
                
                // Mostrar modal
                modalInstance.show();
                
            } catch (error) {
                console.error('Error cargando categoría:', error);
                showMessage('Error cargando categoría: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // GUARDAR CATEGORÍA (CREAR O ACTUALIZAR)
        // ==========================================
        async function saveCategory() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
            
            try {
                // Validar formulario
                const form = document.getElementById('categoryForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const categoryData = {
                    category_name: document.getElementById('categoryName').value.trim(),
                    category_description: document.getElementById('categoryDescription').value.trim() || null,
                    category_icon: document.getElementById('categoryIcon').value,
                    category_color: document.getElementById('categoryColor').value,
                    category_order: parseInt(document.getElementById('categoryOrder').value),
                    updated_at: new Date().toISOString()
                };
                
                if (currentCategoryId) {
                    // ACTUALIZAR
                    await supabaseRequest(`/indicator_categories?category_id=eq.${currentCategoryId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(categoryData)
                    });
                    
                    showMessage('Categoría actualizada exitosamente', 'success');
                } else {
                    // CREAR
                    categoryData.created_at = new Date().toISOString();
                    categoryData.is_active = true;
                    
                    await supabaseRequest('/indicator_categories', {
                        method: 'POST',
                        body: JSON.stringify(categoryData)
                    });
                    
                    showMessage('Categoría creada exitosamente', 'success');
                }
                
                // Cerrar modal y recargar
                modalInstance.hide();
                await loadCategories();
                
            } catch (error) {
                console.error('Error guardando categoría:', error);
                showMessage('Error guardando categoría: ' + error.message, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = currentCategoryId 
                    ? '<i class="bi bi-check-circle me-1"></i>Actualizar Categoría'
                    : '<i class="bi bi-check-circle me-1"></i>Guardar Categoría';
            }
        }
        
        // ==========================================
        // ACTIVAR/DESACTIVAR CATEGORÍA
        // ==========================================
        async function toggleCategoryStatus(categoryId, currentStatus) {
            try {
                const category = allCategories.find(c => c.category_id === categoryId);
                if (!category) {
                    showMessage('Categoría no encontrada', 'danger');
                    return;
                }
                
                const newStatus = !currentStatus;
                const action = newStatus ? 'activar' : 'desactivar';
                
                if (!confirm(`¿Estás seguro de ${action} la categoría "${category.category_name}"?`)) {
                    return;
                }
                
                await supabaseRequest(`/indicator_categories?category_id=eq.${categoryId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        is_active: newStatus,
                        updated_at: new Date().toISOString()
                    })
                });
                
                showMessage(`Categoría ${newStatus ? 'activada' : 'desactivada'} exitosamente`, 'success');
                await loadCategories();
                
            } catch (error) {
                console.error('Error cambiando estado:', error);
                showMessage('Error cambiando estado: ' + error.message, 'danger');
            }
        }
      // ==========================================
        // FUNCIONES GLOBALES
        // ==========================================
        window.loadCategories = loadCategories;
        window.showCreateForm = showCreateForm;
        window.editCategory = editCategory;
        window.saveCategory = saveCategory;
        window.toggleCategoryStatus = toggleCategoryStatus;
        window.selectIcon = selectIcon;
        window.selectColor = selectColor;
        
        console.log('🎉 Página de categorías de indicadores cargada correctamente');
    </script>
</body>
</html>
