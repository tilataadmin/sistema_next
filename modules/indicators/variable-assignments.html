<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignar Variables a Usuarios - Sistema NEXT</title>
    
    <!-- Bootstrap Grid + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap-grid.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <!-- Nuestros estilos principales -->
    <link href="../../assets/css/main.css" rel="stylesheet">
    
    <style>
        .variable-card {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .variable-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .variable-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(37, 99, 235, 0.05);
        }
        
        .users-assignment {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .user-item {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        
        .user-item.assigned {
            border-color: var(--success-color);
            background-color: rgba(16, 185, 129, 0.1);
        }
        
        .user-item.available {
            border-color: var(--border-color);
            background-color: var(--white-bg);
        }
        
        .user-item:hover {
            border-color: var(--primary-color);
        }
        
        .assignment-panel {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 400px;
        }
        
        .empty-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: var(--text-muted);
        }
        
        .permission-type-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .type-read { background-color: #e0f2fe; color: #0c4a6e; }
        .type-write { background-color: #f0fdf4; color: #166534; }
        .type-admin { background-color: #fdf2f8; color: #831843; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="main-container">
            <nav class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">Sistema NEXT</h4>
                    <span class="text-muted">Asignar Variables a Usuarios</span>
                </div>
                <a href="index.html" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Volver al Módulo
                </a>
            </nav>
        </div>
    </div>

    <div class="main-container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <span class="breadcrumb-item">Indicadores</span>
            <span class="breadcrumb-item active">Asignar Variables</span>
        </nav>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Instrucciones -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex">
                    <div class="me-3">
                        <i class="bi bi-info-circle text-info" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Cómo asignar variables a usuarios</h6>
                        <p class="text-muted mb-0">
                            Selecciona una variable de la lista para gestionar qué usuarios pueden trabajar con ella. 
                            Los usuarios solo podrán capturar datos de las variables que tengan asignadas.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Panel izquierdo: Lista de variables -->
            <div class="col-md-5 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-database me-2"></i>Variables</h5>
                        <button class="btn btn-outline-secondary btn-sm" onclick="loadVariables()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    
                    <div class="card-body p-0">
                        <div class="p-3 border-bottom">
                            <input type="text" class="form-control" id="searchVariables" 
                                   placeholder="Buscar variables..." onkeyup="filterVariables()">
                        </div>
                        
                        <div class="p-3 border-bottom">
                            <select class="form-select" id="filterOwner" onchange="filterVariables()">
                                <option value="">Todos los propietarios</option>
                            </select>
                        </div>
                        
                        <div id="variablesContainer" style="max-height: 500px; overflow-y: auto;">
                            <div class="loading-state">
                                <div class="spinner-border text-primary"></div>
                                <span>Cargando variables...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel derecho: Asignación de usuarios -->
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-people me-2"></i>Gestión de Accesos</h5>
                            <small class="text-muted" id="selectedVariableInfo">Selecciona una variable para gestionar sus accesos</small>
                        </div>
                        <div id="permissionsSummary" style="display: none;">
                            <span class="badge bg-info" id="assignedCount">0 asignados</span>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div id="usersAssignmentPanel" class="assignment-panel">
                            <div class="empty-selection">
                                <i class="bi bi-person-circle" style="font-size: 4rem;"></i>
                                <h6 class="mt-3 mb-2">Ninguna variable seleccionada</h6>
                                <p class="text-center">Selecciona una variable de la lista para gestionar qué usuarios pueden acceder a ella</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen de asignaciones -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Resumen de Asignaciones</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <i class="bi bi-database text-primary" style="font-size: 2rem;"></i>
                            <h4 class="mt-2 mb-1" id="totalVariables">-</h4>
                            <small class="text-muted">Variables Totales</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <i class="bi bi-people text-success" style="font-size: 2rem;"></i>
                            <h4 class="mt-2 mb-1" id="totalUsers">-</h4>
                            <small class="text-muted">Usuarios Activos</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <i class="bi bi-link text-info" style="font-size: 2rem;"></i>
                            <h4 class="mt-2 mb-1" id="totalAssignments">-</h4>
                            <small class="text-muted">Asignaciones Activas</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <i class="bi bi-database-check text-warning" style="font-size: 2rem;"></i>
                            <h4 class="mt-2 mb-1" id="variablesWithUsers">-</h4>
                            <small class="text-muted">Variables con Usuarios</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer del sistema -->
    <div class="system-footer">
        <div class="main-container">
            <p class="mb-0">Sistema NEXT - Asignación de Variables v1.0</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let allVariables = [];
        let allUsers = [];
        let filteredVariables = [];
        let selectedVariable = null;
        let variablePermissions = [];
        let currentUser = null;
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔗 Asignación de Variables - Cargando...');
            
            if (window.SUPABASE_CONFIG) {
                initializePage();
            } else {
                setTimeout(initializePage, 100);
            }
        });
        
        async function initializePage() {
    console.log('🔧 Inicializando página de asignaciones');
    
    // Obtener usuario de la sesión
    const session = getSession();
    if (session) {
        currentUser = session.user;
    }
    
    await Promise.all([loadVariables(), loadUsers()]);
    loadStats();
}


        function getSession() {
    const session = localStorage.getItem('nextSystemSession') || 
                   sessionStorage.getItem('nextSystemSession');
    return session ? JSON.parse(session) : null;
}
        
        
        // ==========================================
        // CARGAR DATOS
        // ==========================================
        
        async function loadVariables() {
            const container = document.getElementById('variablesContainer');
            container.innerHTML = `
                <div class="loading-state p-3">
                    <div class="spinner-border text-primary"></div>
                    <span>Cargando variables...</span>
                </div>
            `;
            
            try {
                // Cargar variables con información del propietario
                const variables = await supabaseRequest('/variables?select=*&variable_status=eq.active&order=variable_name');
                allVariables = variables || [];
                filteredVariables = [...allVariables];
                
                // Cargar propietarios para el filtro
                await populateOwnerFilter();
                
                renderVariablesList();
                
                console.log(`✅ ${allVariables.length} variables cargadas`);
                
            } catch (error) {
                console.error('Error cargando variables:', error);
                container.innerHTML = `
                    <div class="empty-state p-3">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        <h6>Error cargando variables</h6>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadVariables()">Reintentar</button>
                    </div>
                `;
            }
        }
        
        async function loadUsers() {
            try {
                const users = await supabaseRequest('/users?select=*&user_status=eq.active&order=user_name');
                allUsers = users || [];
                
                console.log(`✅ ${allUsers.length} usuarios cargados`);
                
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                allUsers = [];
            }
        }
        
        async function populateOwnerFilter() {
            const filterOwner = document.getElementById('filterOwner');
            const owners = [...new Set(allVariables.map(v => v.users))].filter(u => u);
            
            // Limpiar opciones existentes (excepto la primera)
            filterOwner.innerHTML = '<option value="">Todos los propietarios</option>';
            
            owners.forEach(owner => {
                const option = document.createElement('option');
                option.value = owner.user_name;
                option.textContent = owner.user_display_name || owner.user_name;
                filterOwner.appendChild(option);
            });
        }
        
        async function loadStats() {
            try {
                const [variablePermissionsData] = await Promise.all([
                    supabaseRequest('/variable_permissions?select=variable_id,user_id')
                ]);
                
                const totalAssignments = variablePermissionsData ? variablePermissionsData.length : 0;
                const variablesWithUsers = variablePermissionsData ? 
                    new Set(variablePermissionsData.map(vp => vp.variable_id)).size : 0;
                
                document.getElementById('totalVariables').textContent = allVariables.length;
                document.getElementById('totalUsers').textContent = allUsers.length;
                document.getElementById('totalAssignments').textContent = totalAssignments;
                document.getElementById('variablesWithUsers').textContent = variablesWithUsers;
                
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }
        
        // ==========================================
        // RENDERIZAR VARIABLES
        // ==========================================
        
        function renderVariablesList() {
            const container = document.getElementById('variablesContainer');
            
            if (filteredVariables.length === 0) {
                container.innerHTML = `
                    <div class="empty-state p-3">
                        <i class="bi bi-database text-muted"></i>
                        <h6>No hay variables</h6>
                        <p>No se encontraron variables activas</p>
                    </div>
                `;
                return;
            }
            
            let variablesHtml = '';
            
            filteredVariables.forEach(variable => {
                const isSelected = selectedVariable && selectedVariable.variable_id === variable.variable_id;
                const ownerName = variable.users ? (variable.users.user_display_name || variable.users.user_name) : 'Sin propietario';
                
                variablesHtml += `
                    <div class="variable-card p-3 border-bottom ${isSelected ? 'selected' : ''}" 
                         onclick="selectVariable('${variable.variable_id}')">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="bi bi-database text-primary" style="font-size: 2rem;"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${variable.variable_name}</h6>
                                <p class="text-muted mb-1 small">${variable.variable_description || 'Sin descripción'}</p>
                                <div class="mt-1">
                                    <span class="badge bg-secondary">${variable.periodicity}</span>
                                    <span class="badge bg-info ms-1">${variable.data_type}</span>
                                </div>
                                <small class="text-muted">Propietario: ${ownerName}</small>
                            </div>
                            ${isSelected ? '<i class="bi bi-check-circle text-success"></i>' : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = variablesHtml;
        }
        
        function filterVariables() {
            const searchTerm = document.getElementById('searchVariables').value.toLowerCase();
            const ownerFilter = document.getElementById('filterOwner').value;
            
            filteredVariables = allVariables.filter(variable => {
                const matchesSearch = !searchTerm || 
                    variable.variable_name.toLowerCase().includes(searchTerm) ||
                    (variable.variable_description && variable.variable_description.toLowerCase().includes(searchTerm));
                
                const ownerName = variable.users ? variable.users.user_name : '';
                const matchesOwner = !ownerFilter || ownerName === ownerFilter;
                
                return matchesSearch && matchesOwner;
            });
            
            renderVariablesList();
        }
        
        // ==========================================
        // SELECCIONAR VARIABLE Y GESTIONAR USUARIOS
        // ==========================================
        
        async function selectVariable(variableId) {
            try {
                selectedVariable = allVariables.find(v => v.variable_id === variableId);
                if (!selectedVariable) return;
                
                console.log('📊 Variable seleccionada:', selectedVariable.variable_name);
                
                // Actualizar info de la variable seleccionada
                document.getElementById('selectedVariableInfo').textContent = 
                    `Gestionando accesos para: ${selectedVariable.variable_name}`;
                
                // Cargar permisos de la variable
                await loadVariablePermissions(variableId);
                
                // Renderizar panel de asignación
                renderUsersAssignment();
                
                // Actualizar UI de selección
                renderVariablesList();
                
                // Mostrar resumen
                document.getElementById('permissionsSummary').style.display = 'block';
                updatePermissionsSummary();
                
            } catch (error) {
                console.error('Error seleccionando variable:', error);
                showMessage(`Error cargando datos de la variable: ${error.message}`, 'danger');
            }
        }
        
        async function loadVariablePermissions(variableId) {
            try {
                const permissionsData = await supabaseRequest(`/variable_permissions?select=*&variable_id=eq.${variableId}`);
                variablePermissions = permissionsData || [];
                
                console.log(`✅ ${variablePermissions.length} permisos cargados para la variable`);
                
            } catch (error) {
                console.error('Error cargando permisos de la variable:', error);
                variablePermissions = [];
            }
        }
        
        function renderUsersAssignment() {
            const panel = document.getElementById('usersAssignmentPanel');
            
            if (!selectedVariable) {
                panel.innerHTML = `
                    <div class="empty-selection">
                        <i class="bi bi-person-circle" style="font-size: 4rem;"></i>
                        <h6 class="mt-3 mb-2">Ninguna variable seleccionada</h6>
                        <p class="text-center">Selecciona una variable de la lista para gestionar qué usuarios pueden acceder a ella</p>
                    </div>
                `;
                return;
            }
            
            if (allUsers.length === 0) {
                panel.innerHTML = `
                    <div class="empty-selection">
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
                        <h6 class="mt-3 mb-2">No hay usuarios disponibles</h6>
                        <p class="text-center">No se encontraron usuarios activos en el sistema</p>
                    </div>
                `;
                return;
            }
            
            let usersHtml = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Usuarios con acceso a: ${selectedVariable.variable_name}</h6>
                    <span class="badge bg-info">${variablePermissions.length} asignados</span>
                </div>
                <div class="users-assignment">
            `;
            
            allUsers.forEach(user => {
                const userPermission = variablePermissions.find(vp => vp.user_id === user.user_id);
                const hasAccess = !!userPermission;
                const permissionType = userPermission ? userPermission.permission_type : 'read';
                
                usersHtml += `
                    <div class="user-item ${hasAccess ? 'assigned' : 'available'}" 
                         onclick="toggleUserAccess('${user.user_id}')">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="bi bi-${hasAccess ? 'check-circle-fill text-success' : 'circle'}" 
                                       style="font-size: 1.25rem;"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">${user.user_name}</h6>
                                    <p class="text-muted mb-0 small">${user.user_display_name || 'Sin nombre para mostrar'}</p>
                                    <small class="text-muted">${user.user_mail}</small>
                                </div>
                            </div>
                            <div>
                                ${hasAccess ? `
                                    <span class="permission-type-badge type-${permissionType}">${permissionType.toUpperCase()}</span>
                                    <select class="form-select form-select-sm ms-2" style="width: auto; display: inline-block;" 
                                            onchange="changePermissionType('${user.user_id}', this.value)" 
                                            onclick="event.stopPropagation()">
                                        <option value="read" ${permissionType === 'read' ? 'selected' : ''}>Lectura</option>
                                        <option value="write" ${permissionType === 'write' ? 'selected' : ''}>Escritura</option>
                                        <option value="admin" ${permissionType === 'admin' ? 'selected' : ''}>Admin</option>
                                    </select>
                                ` : ''}
                                <span class="badge ${hasAccess ? 'bg-success' : 'bg-secondary'} ms-2">
                                    ${hasAccess ? 'Con Acceso' : 'Sin Acceso'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            usersHtml += '</div>';
            panel.innerHTML = usersHtml;
        }
        
        async function toggleUserAccess(userId) {
            if (!selectedVariable) return;
            
            try {
                const userPermission = variablePermissions.find(vp => vp.user_id === userId);
                const user = allUsers.find(u => u.user_id === userId);
                const hasAccess = !!userPermission;
                
                if (hasAccess) {
                    // Quitar acceso
                    await supabaseRequest(`/variable_permissions?variable_id=eq.${selectedVariable.variable_id}&user_id=eq.${userId}`, {
                        method: 'DELETE'
                    });
                    
                    variablePermissions = variablePermissions.filter(vp => vp.user_id !== userId);
                    showMessage(`Acceso removido para ${user.user_name}`, 'success');
                    
                } else {
                    // Asignar acceso (por defecto: lectura)
                    const newPermission = {
                        variable_id: selectedVariable.variable_id,
                        user_id: userId,
                        permission_type: 'read',
                        granted_by: currentUser.user_id,
                        granted_at: new Date().toISOString()
                    };
                    
                    await supabaseRequest('/variable_permissions', {
                        method: 'POST',
                        body: JSON.stringify(newPermission)
                    });
                    
                    variablePermissions.push(newPermission);
                    showMessage(`Acceso de lectura asignado a ${user.user_name}`, 'success');
                }
                
                // Actualizar UI
                renderUsersAssignment();
                updatePermissionsSummary();
                loadStats();
                
            } catch (error) {
                console.error('Error gestionando acceso:', error);
                showMessage(`Error gestionando acceso: ${error.message}`, 'danger');
            }
        }
        
        async function changePermissionType(userId, newPermissionType) {
            if (!selectedVariable) return;
            
            try {
                const user = allUsers.find(u => u.user_id === userId);
                
                await supabaseRequest(`/variable_permissions?variable_id=eq.${selectedVariable.variable_id}&user_id=eq.${userId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        permission_type: newPermissionType,
                        granted_by: currentUser.user_id,
                        granted_at: new Date().toISOString()
                    })
                });
                
                // Actualizar en memoria
                const permissionIndex = variablePermissions.findIndex(vp => vp.user_id === userId);
                if (permissionIndex !== -1) {
                    variablePermissions[permissionIndex].permission_type = newPermissionType;
                }
                
                showMessage(`Permiso actualizado a ${newPermissionType} para ${user.user_name}`, 'success');
                renderUsersAssignment();
                
            } catch (error) {
                console.error('Error cambiando tipo de permiso:', error);
                showMessage(`Error cambiando permiso: ${error.message}`, 'danger');
            }
        }
        
        function updatePermissionsSummary() {
            document.getElementById('assignedCount').textContent = `${variablePermissions.length} asignados`;
        }
    </script>
</body>
</html>
