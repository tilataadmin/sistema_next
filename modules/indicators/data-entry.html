<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.21.14.25">
    <title>Captura de Datos - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .variable-card {
            transition: all 0.2s ease;
            border-left: 4px solid #0d6efd;
        }
        
        .variable-card.manual {
            border-left-color: #6c757d;
        }
        
        .variable-card.query {
            border-left-color: #198754;
        }
        
        .variable-card.api {
            border-left-color: #0dcaf0;
        }
        
        .variable-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .segment-selector {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .value-input {
            font-size: 1.25rem;
            font-weight: 600;
            text-align: center;
        }
        
        .execution-log {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        
        .execution-log .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .execution-log .log-entry:last-child {
            border-bottom: none;
        }
        
        .status-badge {
            font-size: 0.875rem;
            padding: 0.35rem 0.75rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .filter-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .filter-section select {
            background: rgba(255,255,255,0.9);
        }
    </style>
</head>
<body>
    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Indicadores</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Captura de Datos
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-clipboard-data me-2"></i>
                    Captura de Datos de Variables
                </h1>
                <p class="text-muted">
                    Ingresa valores manualmente o ejecuta capturas autom√°ticas de tus variables asignadas
                </p>
            </div>
        </div>

        <!-- ALERTAS -->
        <div id="alertContainer"></div>
        <!-- FILTROS -->
        <div class="filter-section">
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label for="filterYear" class="form-label fw-bold">
                        <i class="bi bi-calendar-event me-1"></i>A√±o Acad√©mico
                    </label>
                    <select class="form-select" id="filterYear" onchange="loadVariables()">
                        <option value="">Seleccionar a√±o...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="filterMonth" class="form-label fw-bold">
                        <i class="bi bi-calendar-month me-1"></i>Mes (para variables mensuales)
                    </label>
                    <select class="form-select" id="filterMonth" onchange="loadVariables()">
                        <option value="">Todos los meses</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-light w-100" onclick="loadVariables()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar Variables
                    </button>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN: VARIABLES MANUALES -->
        <div class="card mb-4" id="manualVariablesSection">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-keyboard me-2"></i>Variables de Captura Manual
                    <span class="badge bg-light text-dark ms-2" id="manualCount">0</span>
                </h5>
                <small>Variables donde ingresas valores manualmente</small>
            </div>
            <div class="card-body">
                <div id="manualVariablesContainer">
                    <div class="empty-state">
                        <i class="bi bi-inbox text-muted"></i>
                        <p class="mb-0">Selecciona un a√±o acad√©mico para ver tus variables</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN: VARIABLES AUTOM√ÅTICAS -->
        <div class="card mb-4" id="automaticVariablesSection">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-database me-2"></i>Variables de Captura Autom√°tica
                    <span class="badge bg-light text-dark ms-2" id="automaticCount">0</span>
                </h5>
                <small>Variables que se ejecutan mediante consultas SQL o APIs</small>
            </div>
            <div class="card-body">
                <div id="automaticVariablesContainer">
                    <div class="empty-state">
                        <i class="bi bi-inbox text-muted"></i>
                        <p class="mb-0">Selecciona un a√±o acad√©mico para ver tus variables</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VALIDACI√ìN DE ACCESO
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Captura de datos');
                
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido');
                initializePage();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let currentUser = null;
        let academicYears = [];
        let myVariables = []; // Variables donde soy responsable
        let manualVariables = [];
        let automaticVariables = [];
        let availableSegments = [];
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        
        async function initializePage() {
            console.log('üîß Inicializando p√°gina de captura de datos');
            
            try {
                // Obtener usuario actual
                getCurrentUser();
                
                // Cargar a√±os acad√©micos
                await loadAcademicYears();
                
                // Cargar segmentaciones
                await loadSegments();
                
                console.log('‚úÖ P√°gina inicializada');
                
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al inicializar la p√°gina: ' + error.message, 'danger');
            }
        }
        
        function getCurrentUser() {
            try {
                const session = localStorage.getItem('nextSystemSession') || 
                               sessionStorage.getItem('nextSystemSession');
                if (session) {
                    const sessionData = JSON.parse(session);
                    currentUser = sessionData.user;
                    console.log('üë§ Usuario:', currentUser.user_display_name || currentUser.user_name);
                } else {
                    console.warn('‚ö†Ô∏è Sin sesi√≥n');
                    window.location.href = '../../login.html';
                }
            } catch (error) {
                console.error('‚ùå Error sesi√≥n:', error);
                window.location.href = '../../login.html';
            }
        }
        
        // ==========================================
        // CARGAR A√ëOS ACAD√âMICOS
        // ==========================================
        
        async function loadAcademicYears() {
            try {
                const years = await supabaseRequest('/academic_years?select=*&year_status=eq.active&order=year_order.desc');
                academicYears = years || [];
                
                const select = document.getElementById('filterYear');
                select.innerHTML = '<option value="">Seleccionar a√±o...</option>';
                
                academicYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.year_id;
                    option.textContent = year.year_name;
                    if (year.is_current) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ ${academicYears.length} a√±os acad√©micos cargados`);
                
                // Si hay un a√±o seleccionado, cargar variables
                if (select.value) {
                    await loadVariables();
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando a√±os:', error);
                showMessage('Error cargando a√±os acad√©micos', 'danger');
            }
        }
        
        // ==========================================
        // CARGAR SEGMENTACIONES
        // ==========================================
        
        async function loadSegments() {
            try {
                const segments = await supabaseRequest('/segments?select=*&segment_status=eq.active&order=segment_name');
                availableSegments = segments || [];
                console.log(`‚úÖ ${availableSegments.length} segmentaciones cargadas`);
            } catch (error) {
                console.error('‚ùå Error cargando segmentaciones:', error);
                availableSegments = [];
            }
        }
        // ==========================================
        // CARGAR VARIABLES ASIGNADAS AL USUARIO
        // ==========================================
        
        async function loadVariables() {
            const yearId = document.getElementById('filterYear').value;
            
            if (!yearId) {
                showMessage('Selecciona un a√±o acad√©mico', 'warning');
                return;
            }
            
            try {
                console.log('üì° Cargando variables asignadas...');
                
                // Cargar variables donde el usuario actual es responsable
                const variables = await supabaseRequest(
                    '/variables?select=*,variable_segments(segment_id,segments(segment_name,is_table_linked,source_table,source_id_column,source_name_column,source_filter_column,source_filter_value))&capture_responsible_id=eq.' + currentUser.user_id + '&variable_status=eq.active&order=variable_name'
                );
                
                myVariables = variables || [];
                
                // Separar en manuales y autom√°ticas
                manualVariables = myVariables.filter(v => (v.data_source || 'manual') === 'manual');
                automaticVariables = myVariables.filter(v => v.data_source === 'query' || v.data_source === 'api');
                
                console.log(`‚úÖ ${manualVariables.length} manuales, ${automaticVariables.length} autom√°ticas`);
                
                // Actualizar contadores
                document.getElementById('manualCount').textContent = manualVariables.length;
                document.getElementById('automaticCount').textContent = automaticVariables.length;
                
                // Renderizar variables
                await renderManualVariables();
                await renderAutomaticVariables();
                
            } catch (error) {
                console.error('‚ùå Error cargando variables:', error);
                showMessage('Error cargando variables: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // RENDERIZAR VARIABLES MANUALES
        // ==========================================
        
        async function renderManualVariables() {
            const container = document.getElementById('manualVariablesContainer');
            const yearId = document.getElementById('filterYear').value;
            const monthNumber = document.getElementById('filterMonth').value || null;
            
            if (manualVariables.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox text-muted"></i>
                        <p class="mb-0">No tienes variables manuales asignadas</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            for (const variable of manualVariables) {
                // Verificar periodicidad y mes
                if (variable.periodicity === 'monthly' && !monthNumber) {
                    continue; // Saltar variables mensuales si no hay mes seleccionado
                }
                
                const segments = variable.variable_segments || [];
                const hasSegments = segments.length > 0;
                
                html += `
                    <div class="card variable-card manual mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h6 class="mb-1">${variable.variable_name}</h6>
                                    <small class="text-muted">${variable.variable_description || 'Sin descripci√≥n'}</small>
                                    <div class="mt-2">
                                        <span class="badge bg-secondary">${variable.periodicity === 'annual' ? 'Anual' : 'Mensual'}</span>
                                        <span class="badge bg-info">${variable.data_type}</span>
                                        ${hasSegments ? '<span class="badge bg-warning">Con segmentaci√≥n</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div id="capture-form-${variable.variable_id}">
                                ${hasSegments ? 
                                    await renderManualWithSegments(variable, yearId, monthNumber) :
                                    await renderManualWithoutSegments(variable, yearId, monthNumber)
                                }
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html || `
                <div class="empty-state">
                    <i class="bi bi-info-circle text-muted"></i>
                    <p class="mb-0">No hay variables autom√°ticas para el per√≠odo seleccionado</p>
                    <small class="text-muted">
                        ${monthNumber ? 'Intenta seleccionar otro mes' : 'Selecciona un mes para ver variables mensuales'}
                    </small>
                </div>
            `;
        }
        // ==========================================
        // RENDERIZAR MANUAL SIN SEGMENTACIONES
        // ==========================================
        
        async function renderManualWithoutSegments(variable, yearId, monthNumber) {
            // Verificar si ya existe un valor capturado
            let query = `/variable_values?select=*&variable_id=eq.${variable.variable_id}&academic_year_id=eq.${yearId}`;
            
            if (variable.periodicity === 'monthly') {
                query += `&month_number=eq.${monthNumber}`;
            } else {
                query += `&month_number=is.null`;
            }
            
            query += `&segment_combination=is.null`;
            
            const existingValues = await supabaseRequest(query);
            const existingValue = existingValues.length > 0 ? existingValues[0] : null;
            
            const valueId = existingValue ? existingValue.value_id : null;
            const currentValue = existingValue ? existingValue.value_numeric : '';
            const currentNotes = existingValue ? existingValue.notes || '' : '';
            
            return `
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Valor</label>
                        <input 
                            type="number" 
                            class="form-control value-input" 
                            id="value-${variable.variable_id}"
                            value="${currentValue ? formatNumber(currentValue) : ''}"
                            placeholder="0"
                            step="${variable.data_type === 'integer' ? '1' : '0.01'}"
                        >
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Notas (opcional)</label>
                        <textarea 
                            class="form-control" 
                            id="notes-${variable.variable_id}"
                            rows="1"
                            placeholder="Observaciones adicionales..."
                        >${currentNotes}</textarea>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button 
                            class="btn btn-primary w-100" 
                            onclick="saveManualValue('${variable.variable_id}', '${yearId}', ${monthNumber}, null, ${valueId ? "'" + valueId + "'" : 'null'})"
                        >
                            <i class="bi bi-${existingValue ? 'pencil' : 'save'} me-1"></i>
                            ${existingValue ? 'Actualizar' : 'Guardar'}
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // RENDERIZAR MANUAL CON SEGMENTACIONES
        // ==========================================
        
        async function renderManualWithSegments(variable, yearId, monthNumber) {
            const segment = variable.variable_segments[0]; // Solo 1 segmentaci√≥n para manuales
            
            // ‚úÖ CORRECCI√ìN: Asegurar que segment_id est√© disponible
            const segmentInfo = {
                segment_id: segment.segment_id,  // Tomar del nivel correcto
                ...segment.segments               // Expandir las dem√°s propiedades
            };
            
            // Obtener opciones de la segmentaci√≥n (gen√©ricas o din√°micas)
            const segmentOptions = await getSegmentOptions(segmentInfo);
            
            if (!segmentOptions || segmentOptions.length === 0) {
                return `
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        La segmentaci√≥n "${segmentInfo.segment_name}" no tiene opciones disponibles
                    </div>
                `;
            }
            
            // Generar select de segmentaci√≥n
            let segmentSelectHtml = `
                <div class="segment-selector">
                    <label class="form-label fw-bold">${segmentInfo.segment_name}</label>
                    <select class="form-select" id="segment-${variable.variable_id}" onchange="loadSegmentValue('${variable.variable_id}', '${yearId}', ${monthNumber})">
                        <option value="">Seleccionar ${segmentInfo.segment_name}...</option>
            `;
            
            segmentOptions.forEach(opt => {
                segmentSelectHtml += `<option value="${opt.option_value}">${opt.option_name}</option>`;
            });
            
            segmentSelectHtml += `
                    </select>
                </div>
            `;
            
            // Contenedor para valor y notas (se carga din√°micamente al seleccionar segmento)
            segmentSelectHtml += `
                <div id="segment-value-container-${variable.variable_id}">
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-arrow-up-circle me-1"></i>
                        Selecciona una opci√≥n arriba para ingresar el valor
                    </div>
                </div>
            `;
            
            return segmentSelectHtml;
        }

        // ==========================================
        // CARGAR VALOR DE SEGMENTO ESPEC√çFICO
        // ==========================================
        
        async function loadSegmentValue(variableId, yearId, monthNumber) {
            const segmentSelect = document.getElementById(`segment-${variableId}`);
            const selectedValue = segmentSelect.value;
            const container = document.getElementById(`segment-value-container-${variableId}`);
            
            if (!selectedValue) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-arrow-up-circle me-1"></i>
                        Selecciona una opci√≥n arriba para ingresar el valor
                    </div>
                `;
                return;
            }
            
            // Buscar variable completa
            const variable = manualVariables.find(v => v.variable_id === variableId);
            const segmentId = variable.variable_segments[0].segment_id;
            
            // Construir segment_combination
            const segmentCombination = {
                [segmentId]: selectedValue
            };
            
            // Guardar en variable temporal global para uso posterior
            window[`segmentData_${variableId}`] = {
                segmentCombination: segmentCombination,
                segmentId: segmentId,
                selectedValue: selectedValue
            };
            
            // Buscar valor existente
            let query = `/variable_values?select=*&variable_id=eq.${variableId}&academic_year_id=eq.${yearId}`;
            
            if (variable.periodicity === 'monthly') {
                query += `&month_number=eq.${monthNumber}`;
            } else {
                query += `&month_number=is.null`;
            }
            
            const existingValues = await supabaseRequest(query);
            
            // Filtrar por segment_combination (hacer comparaci√≥n manual porque jsonb es complicado en query)
            const existingValue = existingValues.find(ev => {
                if (!ev.segment_combination) return false;
                return JSON.stringify(ev.segment_combination) === JSON.stringify(segmentCombination);
            });
            
            const valueId = existingValue ? existingValue.value_id : null;
            const currentValue = existingValue ? existingValue.value_numeric : '';
            const currentNotes = existingValue ? existingValue.notes || '' : '';
            
            container.innerHTML = `
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Valor</label>
                        <input 
                            type="number" 
                            class="form-control value-input" 
                            id="value-${variableId}-segment"
                            value="${currentValue ? formatNumber(currentValue) : ''}"
                            placeholder="0"
                            step="${variable.data_type === 'integer' ? '1' : '0.01'}"
                        >
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Notas (opcional)</label>
                        <textarea 
                            class="form-control" 
                            id="notes-${variableId}-segment"
                            rows="1"
                            placeholder="Observaciones adicionales..."
                        >${currentNotes}</textarea>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button 
                            class="btn btn-primary w-100" 
                            onclick="saveManualValueWithSegment('${variableId}', '${yearId}', ${monthNumber}, ${valueId ? "'" + valueId + "'" : 'null'})"
                        >
                            <i class="bi bi-${existingValue ? 'pencil' : 'save'} me-1"></i>
                            ${existingValue ? 'Actualizar' : 'Guardar'}
                        </button>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // GUARDAR VALOR MANUAL CON SEGMENTO (helper)
        // ==========================================
        
        async function saveManualValueWithSegment(variableId, yearId, monthNumber, valueId) {
            // Recuperar datos de segmentaci√≥n guardados temporalmente
            const segmentData = window[`segmentData_${variableId}`];
            
            if (!segmentData || !segmentData.segmentCombination) {
                showMessage('Error: No se pudo recuperar la informaci√≥n de segmentaci√≥n', 'danger');
                return;
            }
            
            // üîç DEBUG: Ver qu√© valor estamos capturando
            const valueInput = document.getElementById(`value-${variableId}-segment`);
            const capturedValue = parseFloat(valueInput.value);
            
            console.log('üîç DEBUG - Valor capturado del input:', valueInput.value);
            console.log('üîç DEBUG - Valor parseado:', capturedValue);
            console.log('üîç DEBUG - Tipo de dato:', typeof capturedValue);
            console.log('üîç DEBUG - Segmentaci√≥n:', segmentData.segmentCombination);
            
            // Llamar a la funci√≥n principal con el objeto correcto
            await saveManualValue(variableId, yearId, monthNumber, segmentData.segmentCombination, valueId);
        }


        
        // ==========================================
        // GUARDAR VALOR MANUAL
        // ==========================================
        
        async function saveManualValue(variableId, yearId, monthNumber, segmentCombinationParam, valueId) {
            const variable = manualVariables.find(v => v.variable_id === variableId);
            
            // Determinar el ID correcto del input seg√∫n si tiene segmentaci√≥n
            const hasSegments = variable.variable_segments && variable.variable_segments.length > 0;
            const valueInput = document.getElementById(hasSegments ? `value-${variableId}-segment` : `value-${variableId}`);
            const notesInput = document.getElementById(hasSegments ? `notes-${variableId}-segment` : `notes-${variableId}`);
            
            const rawValue = valueInput.value.trim();
            const value = parseFormattedNumber(rawValue) || parseFloat(rawValue);
            const notes = notesInput.value.trim() || null;
            
            // Validaciones
            if (isNaN(value) || value === '') {
                showMessage('Debes ingresar un valor num√©rico', 'warning');
                valueInput.focus();
                return;
            }
            
            if (variable.data_type === 'integer' && !Number.isInteger(value)) {
                showMessage('Esta variable requiere un valor entero', 'warning');
                valueInput.focus();
                return;
            }
            
            try {
                // ‚úÖ CORRECCI√ìN: Manejar tanto objeto como null/string
                let segmentCombination = null;
                
                if (segmentCombinationParam) {
                    // Si es string (caso antiguo), parsear
                    if (typeof segmentCombinationParam === 'string') {
                        segmentCombination = JSON.parse(segmentCombinationParam);
                    } 
                    // Si ya es objeto, usar directamente
                    else if (typeof segmentCombinationParam === 'object') {
                        segmentCombination = segmentCombinationParam;
                    }
                }
                
                const data = {
                    variable_id: variableId,
                    academic_year_id: yearId,
                    month_number: variable.periodicity === 'monthly' ? parseInt(monthNumber) : null,
                    segment_combination: segmentCombination,
                    value_numeric: value,
                    captured_by: currentUser.user_id,
                    value_source: 'manual',
                    notes: notes
                };
                
                if (valueId && valueId !== 'null') {
                    // UPDATE
                    await supabaseRequest(`/variable_values?value_id=eq.${valueId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            value_numeric: value,
                            notes: notes,
                            captured_at: new Date().toISOString()
                        })
                    });
                    
                    showMessage('Valor actualizado correctamente', 'success');
                } else {
                    // INSERT
                    await supabaseRequest('/variable_values', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    
                    showMessage('Valor guardado correctamente', 'success');
                }
                
                // Recargar la secci√≥n para actualizar botones
                await renderManualVariables();
                
            } catch (error) {
                console.error('Error guardando valor:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
            }
        }

                
        // ==========================================
        // RENDERIZAR VARIABLES AUTOM√ÅTICAS
        // ==========================================
        
        async function renderAutomaticVariables() {
            const container = document.getElementById('automaticVariablesContainer');
            const yearId = document.getElementById('filterYear').value;
            const monthNumber = document.getElementById('filterMonth').value || null;
            
            if (automaticVariables.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox text-muted"></i>
                        <p class="mb-0">No tienes variables autom√°ticas asignadas</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            for (const variable of automaticVariables) {
                // Verificar periodicidad y mes
                if (variable.periodicity === 'monthly' && !monthNumber) {
                    continue;
                }
                
                // Verificar si ya fue ejecutada
                let query = `/variable_values?select=value_id,captured_at&variable_id=eq.${variable.variable_id}&academic_year_id=eq.${yearId}&value_source=eq.calculated`;
                
                if (variable.periodicity === 'monthly') {
                    query += `&month_number=eq.${monthNumber}`;
                } else {
                    query += `&month_number=is.null`;
                }
                
                const existingValues = await supabaseRequest(query);
                const isExecuted = existingValues.length > 0;
                const executedDate = isExecuted ? formatDate(existingValues[0].captured_at) : null;
                
                const segments = variable.variable_segments || [];
                const combinationsCount = segments.length > 0 ? 'M√∫ltiples combinaciones' : '1 valor';
                
                const badgeClass = variable.data_source === 'query' ? 'bg-success' : 'bg-info';
                const sourceText = variable.data_source === 'query' ? 'Consulta SQL' : 'API Externa';
                
                html += `
                    <div class="card variable-card ${variable.data_source} mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${variable.variable_name}</h6>
                                    <small class="text-muted">${variable.variable_description || 'Sin descripci√≥n'}</small>
                                    <div class="mt-2">
                                        <span class="badge ${badgeClass}">${sourceText}</span>
                                        <span class="badge bg-secondary">${variable.periodicity === 'annual' ? 'Anual' : 'Mensual'}</span>
                                        <span class="badge bg-light text-dark">${combinationsCount}</span>
                                    </div>
                                    
                                    ${isExecuted ? `
                                        <div class="mt-2">
                                            <span class="status-badge badge bg-success">
                                                <i class="bi bi-check-circle me-1"></i>
                                                Ejecutado el ${executedDate}
                                            </span>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div>
                                    ${isExecuted ? `
                                        <button class="btn btn-outline-secondary" disabled>
                                            <i class="bi bi-lock me-1"></i>Ya ejecutado
                                        </button>
                                    ` : `
                                        <button 
                                            class="btn btn-success" 
                                            onclick="executeAutomaticVariable('${variable.variable_id}', '${yearId}', ${monthNumber})"
                                            id="execute-btn-${variable.variable_id}"
                                        >
                                            <i class="bi bi-play-circle me-1"></i>Ejecutar Captura
                                        </button>
                                    `}
                                </div>
                            </div>
                            
                            <!-- Log de ejecuci√≥n -->
                            <div id="execution-log-${variable.variable_id}" class="mt-3" style="display: none;">
                                <div class="execution-log"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html || `
                <div class="empty-state">
                    <i class="bi bi-info-circle text-muted"></i>
                    <p class="mb-0">No hay variables autom√°ticas para el per√≠odo seleccionado</p>
                </div>
            `;
        }
        // ==========================================
        // EJECUTAR VARIABLE AUTOM√ÅTICA
        // ==========================================
        
        async function executeAutomaticVariable(variableId, yearId, monthNumber) {
            const variable = automaticVariables.find(v => v.variable_id === variableId);
            const executeBtn = document.getElementById(`execute-btn-${variableId}`);
            const logContainer = document.getElementById(`execution-log-${variableId}`);
            
            // Mostrar log
            logContainer.style.display = 'block';
            const logDiv = logContainer.querySelector('.execution-log');
            
            // Deshabilitar bot√≥n
            executeBtn.disabled = true;
            executeBtn.innerHTML = '<span class="loading-spinner me-2"></span>Ejecutando...';
            
            // Log inicial
            addLogEntry(logDiv, 'Iniciando ejecuci√≥n...', 'info');
            
            try {
                const segments = variable.variable_segments || [];
                
                if (segments.length === 0) {
                    // Sin segmentaciones - ejecutar una sola vez
                    addLogEntry(logDiv, 'Variable sin segmentaciones - ejecuci√≥n √∫nica', 'info');
                    await executeSingleQuery(variable, yearId, monthNumber, null, logDiv);
                } else {
                    // Con segmentaciones - ejecutar por cada combinaci√≥n
                    addLogEntry(logDiv, `Variable con ${segments.length} segmentaci√≥n(es)`, 'info');
                    await executeWithSegments(variable, yearId, monthNumber, segments, logDiv);
                }
                
                addLogEntry(logDiv, '‚úì Ejecuci√≥n completada exitosamente', 'success');
                showMessage(`Variable "${variable.variable_name}" ejecutada correctamente`, 'success');
                
                // Recargar para actualizar estado
                setTimeout(() => {
                    renderAutomaticVariables();
                }, 1000);
                
            } catch (error) {
                console.error('Error ejecutando variable:', error);
                addLogEntry(logDiv, `‚úó Error: ${error.message}`, 'error');
                showMessage('Error en la ejecuci√≥n: ' + error.message, 'danger');
                
                executeBtn.disabled = false;
                executeBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Reintentar';
            }
        }
        
        // ==========================================
        // EJECUTAR QUERY/API √öNICA
        // ==========================================
        
        async function executeSingleQuery(variable, yearId, monthNumber, segmentCombination, logDiv) {
            const startTime = Date.now();
            
            try {
                let result;
                
                if (variable.data_source === 'query') {
                    addLogEntry(logDiv, 'Ejecutando consulta SQL...', 'info');
                    result = await executeQuery(variable, yearId, monthNumber, segmentCombination);
                } else if (variable.data_source === 'api') {
                    addLogEntry(logDiv, 'Llamando API externa...', 'info');
                    result = await executeAPI(variable, yearId, monthNumber, segmentCombination);
                }
                
                const executionTime = Date.now() - startTime;
                
                // Guardar en variable_values
                const data = {
                    variable_id: variable.variable_id,
                    academic_year_id: yearId,
                    month_number: variable.periodicity === 'monthly' ? parseInt(monthNumber) : null,
                    segment_combination: segmentCombination,
                    value_numeric: parseFloat(result),
                    captured_by: currentUser.user_id,
                    value_source: 'calculated',
                    execution_time_ms: executionTime
                };
                
                await supabaseRequest('/variable_values', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                const segmentText = segmentCombination ? ` (${JSON.stringify(segmentCombination)})` : '';
                addLogEntry(logDiv, `‚úì Valor guardado: ${result}${segmentText} [${executionTime}ms]`, 'success');
                
            } catch (error) {
                throw error;
            }
        }
        
        // ==========================================
        // EJECUTAR CON SEGMENTACIONES
        // ==========================================
        
        async function executeWithSegments(variable, yearId, monthNumber, segments, logDiv) {
            // Por ahora solo soportamos 1 segmentaci√≥n para autom√°ticas
            // Puedes extender para m√∫ltiples segmentaciones despu√©s
            const segment = segments[0];
            const segmentInfo = segment.segments;
            
            addLogEntry(logDiv, `Obteniendo opciones de "${segmentInfo.segment_name}"...`, 'info');
            
            const segmentOptions = await getSegmentOptions(segmentInfo);
            
            if (!segmentOptions || segmentOptions.length === 0) {
                throw new Error(`La segmentaci√≥n "${segmentInfo.segment_name}" no tiene opciones`);
            }
            
            addLogEntry(logDiv, `${segmentOptions.length} opciones encontradas - ejecutando...`, 'info');
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const option of segmentOptions) {
                try {
                    const segmentCombination = {
                        [segment.segment_id]: option.option_value
                    };
                    
                    addLogEntry(logDiv, `‚ñ∏ Procesando: ${option.option_name}...`, 'info');
                    
                    await executeSingleQuery(variable, yearId, monthNumber, segmentCombination, logDiv);
                    successCount++;
                    
                } catch (error) {
                    errorCount++;
                    addLogEntry(logDiv, `‚úó Error en ${option.option_name}: ${error.message}`, 'error');
                }
            }
            
            addLogEntry(logDiv, `Resumen: ${successCount} exitosas, ${errorCount} errores`, successCount > 0 ? 'success' : 'error');
        }
        
        // ==========================================
        // EJECUTAR QUERY SQL
        // ==========================================
        
        async function executeQuery(variable, yearId, monthNumber, segmentCombination) {
            const config = variable.data_source_config;
            if (!config || !config.query) {
                throw new Error('Query no configurada');
            }
            
            let query = config.query;
            
            // Sustituir par√°metros
            query = query.replace(/:academic_year_id/g, `'${yearId}'`);
            
            if (monthNumber) {
                query = query.replace(/:month_number/g, monthNumber);
            }
            
            // Sustituir segmentaciones
            if (segmentCombination) {
                for (const [segmentId, value] of Object.entries(segmentCombination)) {
                    const segment = availableSegments.find(s => s.segment_id === segmentId);
                    if (segment) {
                        const paramName = `:segment_${segment.segment_name.toLowerCase().replace(/\s+/g, '_')}_id`;
                        query = query.replace(new RegExp(paramName, 'g'), `'${value}'`);
                    }
                }
            }
            
            // Ejecutar usando funci√≥n RPC
            const response = await fetch(`${SUPABASE_CONFIG.apiUrl}/rpc/execute_test_query`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ test_query: query })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Error ejecutando query: ${errorText}`);
            }
            
            const result = await response.json();
            return result;
        }
        
        // ==========================================
        // EJECUTAR API
        // ==========================================
        
        async function executeAPI(variable, yearId, monthNumber, segmentCombination) {
            const config = variable.data_source_config;
            if (!config || !config.endpoint) {
                throw new Error('API no configurada');
            }
            
            // Implementaci√≥n b√°sica - puedes extender seg√∫n necesidades
            const response = await fetch(config.endpoint, {
                method: config.method || 'GET',
                headers: config.headers || {}
            });
            
            if (!response.ok) {
                throw new Error(`Error en API: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Extraer valor seg√∫n path configurado (si existe)
            // Por ahora retornamos el dato directo
            return data;
        }
        // ==========================================
        // OBTENER OPCIONES DE SEGMENTACI√ìN (igual que en variables.html)
        // ==========================================
        
        async function getSegmentOptions(segmentInfo) {
            try {
                // Si es vinculada a tabla, obtener datos din√°micos
                if (segmentInfo.is_table_linked && segmentInfo.source_table) {
                    let query = `/${segmentInfo.source_table}?select=${segmentInfo.source_id_column},${segmentInfo.source_name_column}`;
                    
                    // Aplicar filtro si existe
                    if (segmentInfo.source_filter_column && segmentInfo.source_filter_value) {
                        query += `&${segmentInfo.source_filter_column}=eq.${segmentInfo.source_filter_value}`;
                    }
                    
                    // Orden
                    query += `&order=${segmentInfo.source_name_column}`;
                    
                    const data = await supabaseRequest(query);
                    
                    // Convertir a formato option_name/option_value
                    return data.map(item => ({
                        option_name: item[segmentInfo.source_name_column],
                        option_value: item[segmentInfo.source_id_column],
                        is_dynamic: true
                    }));
                }
                
                // Si es gen√©rica, obtener segment_options
                const options = await supabaseRequest(`/segment_options?select=*&segment_id=eq.${segmentInfo.segment_id}&option_status=eq.active&order=option_order`);
                return options || [];
                
            } catch (error) {
                console.error('Error obteniendo opciones de segmentaci√≥n:', error);
                return [];
            }
        }
        
        // ==========================================
        // AGREGAR ENTRADA AL LOG
        // ==========================================
        
        function addLogEntry(logDiv, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('es-CO', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            let icon = 'bi-info-circle';
            let color = 'text-secondary';
            
            switch(type) {
                case 'success':
                    icon = 'bi-check-circle';
                    color = 'text-success';
                    break;
                case 'error':
                    icon = 'bi-exclamation-triangle';
                    color = 'text-danger';
                    break;
                case 'warning':
                    icon = 'bi-exclamation-circle';
                    color = 'text-warning';
                    break;
            }
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${color}`;
            entry.innerHTML = `
                <i class="bi ${icon} me-2"></i>
                <small class="text-muted">[${timestamp}]</small> ${message}
            `;
            
            logDiv.appendChild(entry);
            
            // Auto-scroll al final
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // ==========================================
        // FUNCIONES GLOBALES
        // ==========================================
        
        window.loadVariables = loadVariables;
        window.saveManualValue = saveManualValue;
        window.saveManualValueWithSegment = saveManualValueWithSegment;  // ‚úÖ AGREGAR ESTA L√çNEA
        window.loadSegmentValue = loadSegmentValue;
        window.executeAutomaticVariable = executeAutomaticVariable;

        // ==========================================
        // FORMATEAR N√öMEROS CON SEPARADORES DE MILES
        // ==========================================
        
        function formatNumber(value) {
            if (!value || isNaN(value)) return '';
            return new Intl.NumberFormat('es-CO', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(value);
        }
        
        function parseFormattedNumber(formattedValue) {
            if (!formattedValue) return null;
            // Remover puntos de miles y reemplazar coma decimal por punto
            return parseFloat(formattedValue.replace(/\./g, '').replace(',', '.'));
        }

        function setupNumberFormatting() {
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('value-input')) {
                    let cursorPosition = e.target.selectionStart;
                    let oldValue = e.target.value;
                    let oldLength = oldValue.length;
                    
                    // Remover formato y mantener solo n√∫meros y coma decimal
                    let numbers = oldValue.replace(/[^\d,]/g, '');
                    
                    // Separar enteros y decimales
                    let parts = numbers.split(',');
                    let integers = parts[0];
                    let decimals = parts[1] || '';
                    
                    // Formatear enteros con separadores de miles
                    integers = integers.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    
                    // Reconstruir valor
                    let newValue = integers;
                    if (parts.length > 1) {
                        newValue += ',' + decimals.substring(0, 2);
                    }
                    
                    e.target.value = newValue;
                    
                    // Ajustar cursor
                    let newLength = newValue.length;
                    cursorPosition += (newLength - oldLength);
                    e.target.setSelectionRange(cursorPosition, cursorPosition);
                }
            });
        }
        
        // Llamar al inicializar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(setupNumberFormatting, 500);
        });
        
        console.log('üéâ P√°gina de captura de datos cargada correctamente');
    </script>
</body>
</html>
