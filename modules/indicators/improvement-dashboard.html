<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.01.10.58">
    <title>Tablero de Mejora - Indicadores</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #1B365D;
            --secondary-color: #667eea;
            --tertiary-color: #764ba2;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        /* Content cards */
        .content-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        /* KPI Cards */
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
            cursor: pointer;
            height: 100%;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .kpi-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .kpi-label {
            font-size: 0.9rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-trend {
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .kpi-trend.positive {
            color: #10b981;
        }

        .kpi-trend.negative {
            color: #ef4444;
        }

        .kpi-trend.neutral {
            color: #6b7280;
        }

        /* Filters */
        .filters-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group > div {
            flex: 1;
            min-width: 200px;
        }

        /* Chart containers */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 1rem;
        }

        /* Activity timeline */
        .activity-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .activity-timeline::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e2e8f0;
        }

        .activity-item {
            position: relative;
            margin-bottom: 1.5rem;
            padding-left: 1rem;
        }

        .activity-item::before {
            content: '';
            position: absolute;
            left: -1.35rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--secondary-color);
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--secondary-color);
        }

        .activity-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .activity-icon.plan { background: rgba(102, 126, 234, 0.1); color: #667eea; }
        .activity-icon.note { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .activity-icon.update { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }

        .activity-text {
            color: #334155;
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        /* Table styles */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        .table thead {
            background: #f8f9fa;
        }

        .table thead th {
            border-bottom: 2px solid #e2e8f0;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            padding: 1rem;
        }

        .table tbody td {
            vertical-align: middle;
            padding: 1rem;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        /* Status badges */
        .status-active { background-color: #3b82f6; color: white; }
        .status-draft { background-color: #94a3b8; color: white; }
        .status-completed { background-color: #10b981; color: white; }
        .status-cancelled { background-color: #ef4444; color: white; }

        /* Loading */
        .loading-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
        }

        .empty-state i {
            font-size: 4rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }

        .empty-state h5 {
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        /* Modal */
        .modal-header {
            background: var(--primary-color);
            color: white;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .content-card {
                padding: 1.5rem;
            }

            .kpi-value {
                font-size: 2rem;
            }

            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <div class="container-fluid">
        <!-- Loading State -->
        <div class="loading-container" id="loadingContainer">
            <div class="spinner-container text-center">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3 text-muted">Cargando tablero de mejora...</p>
            </div>
        </div>

        <!-- Page Content (hidden initially) -->
        <div id="pageContent" style="display: none;">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mt-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="../../dashboard.html">
                            <i class="bi bi-house-door-fill me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="./index.html">Indicadores</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        Tablero de Mejora
                    </li>
                </ol>
            </nav>

            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h1 class="h3 mb-1">
                                <i class="bi bi-clipboard-data me-2" style="color: var(--primary-color);"></i>
                                Tablero de Mejora
                            </h1>
                            <p class="text-muted mb-0">Dashboard analítico de planes de mejora y actividad de indicadores</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary" onclick="refreshDashboard()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                            </button>
                            <a href="./improvement.html" class="btn btn-primary">
                                <i class="bi bi-graph-up-arrow me-1"></i>Ir a Gestión de Mejora
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Filters -->
            <div class="content-card">
                <div class="filters-section">
                    <div class="filter-group">
                        <div>
                            <label class="form-label">Período de Análisis</label>
                            <select class="form-select" id="filterPeriod" onchange="applyFilters()">
                                <option value="30">Últimos 30 días</option>
                                <option value="60">Últimos 60 días</option>
                                <option value="90" selected>Últimos 90 días</option>
                                <option value="180">Últimos 6 meses</option>
                                <option value="365">Último año</option>
                                <option value="all">Todo el tiempo</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Indicador</label>
                            <select class="form-select" id="filterIndicator" onchange="applyFilters()">
                                <option value="">Todos los indicadores</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Estado del Plan</label>
                            <select class="form-select" id="filterStatus" onchange="applyFilters()">
                                <option value="">Todos los estados</option>
                                <option value="draft">Borrador</option>
                                <option value="active">Activo</option>
                                <option value="completed">Completado</option>
                                <option value="cancelled">Cancelado</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: end;">
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-1"></i>Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPIs -->
            <div class="row g-3 mb-4">
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="kpi-card" onclick="filterByStatus('active')">
                        <div class="kpi-icon text-primary">
                            <i class="bi bi-play-circle-fill"></i>
                        </div>
                        <div class="kpi-value text-primary" id="kpiActivePlans">0</div>
                        <div class="kpi-label">Planes Activos</div>
                        <div class="kpi-trend" id="trendActivePlans">
                            <span class="text-muted">Sin cambios</span>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="kpi-card" onclick="filterByStatus('completed')">
                        <div class="kpi-icon text-success">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        <div class="kpi-value text-success" id="kpiCompletedPlans">0</div>
                        <div class="kpi-label">Planes Completados</div>
                        <div class="kpi-trend" id="trendCompletedPlans">
                            <span class="text-muted">Sin cambios</span>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="kpi-card">
                        <div class="kpi-icon text-info">
                            <i class="bi bi-speedometer2"></i>
                        </div>
                        <div class="kpi-value text-info" id="kpiIndicatorsWithPlans">0</div>
                        <div class="kpi-label">Indicadores con Planes</div>
                        <div class="kpi-trend" id="trendIndicators">
                            <span class="text-muted">Sin cambios</span>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="kpi-card">
                        <div class="kpi-icon text-warning">
                            <i class="bi bi-list-task"></i>
                        </div>
                        <div class="kpi-value text-warning" id="kpiPendingTasks">0</div>
                        <div class="kpi-label">Tareas Vinculadas</div>
                        <div class="kpi-trend" id="trendTasks">
                            <span class="text-muted">Sin datos</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="row g-4 mb-4">
                <div class="col-12 col-lg-6">
                    <div class="content-card">
                        <h5 class="mb-3">
                            <i class="bi bi-pie-chart me-2"></i>
                            Estado de Planes
                        </h5>
                        <div class="chart-container">
                            <canvas id="chartPlanStatus"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="content-card">
                        <h5 class="mb-3">
                            <i class="bi bi-graph-up me-2"></i>
                            Actividad en el Tiempo
                        </h5>
                        <div class="chart-container">
                            <canvas id="chartActivity"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="row g-4 mb-4">
                <div class="col-12 col-lg-6">
                    <div class="content-card">
                        <h5 class="mb-3">
                            <i class="bi bi-bar-chart me-2"></i>
                            Top 5 Indicadores con Más Planes
                        </h5>
                        <div class="chart-container">
                            <canvas id="chartTopIndicators"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="content-card">
                        <h5 class="mb-3">
                            <i class="bi bi-people-fill me-2"></i>
                            Top 5 Contribuidores
                        </h5>
                        <div class="chart-container">
                            <canvas id="chartTopContributors"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Timeline -->
            <div class="content-card mb-4">
                <h5 class="mb-3">
                    <i class="bi bi-clock-history me-2"></i>
                    Actividad Reciente
                </h5>
                <div id="activityTimeline" class="activity-timeline">
                    <!-- Se llenará dinámicamente -->
                </div>
                <div id="emptyActivity" class="empty-state" style="display: none;">
                    <i class="bi bi-inbox"></i>
                    <h5>No hay actividad reciente</h5>
                    <p class="text-muted">Aún no se han registrado acciones en el período seleccionado.</p>
                </div>
            </div>

            <!-- Plans Table -->
            <div class="content-card">
                <h5 class="mb-3">
                    <i class="bi bi-table me-2"></i>
                    Planes de Mejora
                    <span class="badge bg-primary ms-2" id="plansCount">0</span>
                </h5>
                
                <div class="table-responsive">
                    <table class="table table-hover" id="plansTable">
                        <thead>
                            <tr>
                                <th>Plan</th>
                                <th>Indicador</th>
                                <th>Estado</th>
                                <th>Tareas Vinculadas</th>
                                <th>Última Actualización</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="plansTableBody">
                            <!-- Se llenará dinámicamente -->
                        </tbody>
                    </table>
                </div>

                <div id="emptyPlans" class="empty-state" style="display: none;">
                    <i class="bi bi-clipboard-x"></i>
                    <h5>No hay planes de mejora</h5>
                    <p class="text-muted">No se encontraron planes con los filtros aplicados.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Plan Details -->
    <div class="modal fade" id="planDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-clipboard-data me-2"></i>
                        <span id="modalPlanName">Detalles del Plan</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalPlanContent">
                    <!-- Se llenará dinámicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cerrar
                    </button>
                    <a href="./improvement.html" class="btn btn-primary" id="modalGoToImprovement">
                        <i class="bi bi-box-arrow-up-right me-1"></i>
                        Ir a Gestión de Mejora
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    
    <!-- Config.js -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let currentUser = null;
        let hasAccess = false;
        
        let allPlans = [];
        let filteredPlans = [];
        let allIndicators = [];
        let allActivity = [];
        let allTasks = [];
        
        // Datos del período anterior para comparación
        let previousPeriodData = {
            activePlans: 0,
            completedPlans: 0,
            indicatorsWithPlans: 0,
            tasks: 0
        };
        
        let charts = {};
        let planDetailsModalInstance = null;
        
        const CHART_COLORS = {
            primary: '#667eea',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            info: '#3b82f6',
            muted: '#94a3b8',
            secondary: '#764ba2'
        };
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('📄 Página Tablero de Mejora iniciada');
            
            const session = getStoredSession();
            if (!session || !session.user) {
                console.log('❌ No hay sesión activa, redirigiendo a login...');
                window.location.href = '/login.html';
                return;
            }
            
            currentUser = session.user;
            console.log('✅ Usuario autenticado:', currentUser.user_name);
            
            // Validar permiso de acceso
            hasAccess = await validatePageAccess('Tablero de mejora');
            
            if (!hasAccess) {
                return;
            }
            
            await loadPage();
        });
        
        // ==========================================
        // CARGAR PÁGINA
        // ==========================================
        
        async function loadPage() {
            try {
                applyInstitutionColors();
                
                planDetailsModalInstance = new bootstrap.Modal(document.getElementById('planDetailsModal'));
                
                await loadIndicators();
                await loadDashboardData();
                
                initializeCharts();
                renderDashboard();
                
                document.getElementById('loadingContainer').style.display = 'none';
                document.getElementById('pageContent').style.display = 'block';
                
            } catch (error) {
                console.error('❌ Error cargando página:', error);
                showError('Error al cargar la página. Por favor, recarga.');
            }
        }
        
        // ==========================================
        // APLICAR COLORES CORPORATIVOS
        // ==========================================
        
        function applyInstitutionColors() {
            if (APP_CONFIG && APP_CONFIG.institution && APP_CONFIG.institution.colors) {
                const colors = APP_CONFIG.institution.colors;
                
                document.documentElement.style.setProperty('--primary-color', colors.primary);
                document.documentElement.style.setProperty('--secondary-color', colors.secondary);
                document.documentElement.style.setProperty('--tertiary-color', colors.tertiary);
                
                CHART_COLORS.primary = colors.secondary;
                CHART_COLORS.secondary = colors.tertiary;
                
                console.log('🎨 Colores corporativos aplicados:', colors);
            }
        }
        
        // ==========================================
        // CARGAR DATOS
        // ==========================================
        
        async function loadIndicators() {
            try {
                const query = '/indicators?select=indicator_id,indicator_name&order=indicator_name.asc';
                allIndicators = await supabaseRequest(query);
                
                const select = document.getElementById('filterIndicator');
                allIndicators.forEach(ind => {
                    const option = document.createElement('option');
                    option.value = ind.indicator_id;
                    option.textContent = ind.indicator_name;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error cargando indicadores:', error);
            }
        }
        
        async function loadDashboardData() {
            try {
                // Cargar planes con sus relaciones
                const plansQuery = '/kpi_improvement_plans?select=*,indicators(indicator_name),indicator_goals(period,goal_value),users!created_by(user_display_name,user_name)&order=created_at.desc';
                allPlans = await supabaseRequest(plansQuery);
                
                filteredPlans = [...allPlans];
                
                // Cargar tareas vinculadas
                await loadTasks();
                
                // Cargar actividad
                await loadActivity();
                
                // Cargar datos del período anterior para comparación
                await loadPreviousPeriodData();
                
                console.log('✅ Datos cargados:', allPlans.length, 'planes');
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                showAlert('Error al cargar los datos del dashboard', 'danger');
            }
        }
        
        async function loadTasks() {
            try {
                const tasksQuery = '/tasks?select=*,improvement_plan:kpi_improvement_plans!improvement_plan_id(plan_id,plan_name)&task_state=neq.cancelled&order=created_at.desc';
                allTasks = await supabaseRequest(tasksQuery);
                console.log('✅ Tareas cargadas:', allTasks.length);
            } catch (error) {
                console.error('Error cargando tareas:', error);
                allTasks = [];
            }
        }
        
        async function loadActivity() {
            try {
                allActivity = [];
                
                // Notas de análisis
                const notesQuery = '/kpi_indicator_analysis_notes?select=*,indicators(indicator_name),users!created_by(user_display_name,user_name)&order=created_at.desc&limit=50';
                const notes = await supabaseRequest(notesQuery);
                
                notes.forEach(note => {
                    allActivity.push({
                        type: 'note',
                        text: `agregó una nota en ${note.indicators?.indicator_name}`,
                        user: note.users?.user_display_name || note.users?.user_name,
                        timestamp: note.created_at
                    });
                });
                
                // Actualizaciones de planes
                const updatesQuery = '/kpi_plan_updates?select=*,kpi_improvement_plans(plan_name),users!created_by(user_display_name,user_name)&order=created_at.desc&limit=50';
                const updates = await supabaseRequest(updatesQuery);
                
                updates.forEach(update => {
                    allActivity.push({
                        type: 'update',
                        text: `actualizó el plan "${update.kpi_improvement_plans?.plan_name}"`,
                        user: update.users?.user_display_name || update.users?.user_name,
                        timestamp: update.created_at
                    });
                });
                
                // Planes creados
                allPlans.forEach(plan => {
                    allActivity.push({
                        type: 'plan',
                        text: `creó el plan "${plan.plan_name}"`,
                        user: plan.users?.user_display_name || plan.users?.user_name,
                        timestamp: plan.created_at
                    });
                });
                
                // Ordenar por fecha
                allActivity.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
            } catch (error) {
                console.error('Error cargando actividad:', error);
            }
        }
        
        async function loadPreviousPeriodData() {
            try {
                const currentPeriod = parseInt(document.getElementById('filterPeriod').value);
                
                if (currentPeriod === 'all') {
                    // No hay período anterior para comparar
                    return;
                }
                
                // Calcular fechas del período anterior
                const now = new Date();
                const previousStart = new Date();
                previousStart.setDate(previousStart.getDate() - (currentPeriod * 2));
                
                const previousEnd = new Date();
                previousEnd.setDate(previousEnd.getDate() - currentPeriod);
                
                // Consultar planes del período anterior
                const previousPlansQuery = '/kpi_improvement_plans?select=*&created_at=gte.' + previousStart.toISOString() + '&created_at=lte.' + previousEnd.toISOString();
                const previousPlans = await supabaseRequest(previousPlansQuery);
                
                previousPeriodData.activePlans = previousPlans.filter(p => p.plan_status === 'active').length;
                previousPeriodData.completedPlans = previousPlans.filter(p => p.plan_status === 'completed').length;
                previousPeriodData.indicatorsWithPlans = new Set(previousPlans.map(p => p.indicator_id)).size;
                
                // Tareas del período anterior
                const previousTasksQuery = '/tasks?select=task_id&improvement_plan_id=not.is.null&created_at=gte.' + previousStart.toISOString() + '&created_at=lte.' + previousEnd.toISOString() + '&task_state=neq.cancelled';
                const previousTasks = await supabaseRequest(previousTasksQuery);
                previousPeriodData.tasks = previousTasks ? previousTasks.length : 0;
                
                console.log('✅ Datos del período anterior cargados para comparación');
                
            } catch (error) {
                console.error('Error cargando datos del período anterior:', error);
            }
        }
        
        // ==========================================
        // FILTROS
        // ==========================================
        
        function applyFilters() {
            const period = document.getElementById('filterPeriod').value;
            const indicatorId = document.getElementById('filterIndicator').value;
            const status = document.getElementById('filterStatus').value;
            
            filteredPlans = allPlans.filter(plan => {
                // Filtro de período
                if (period !== 'all') {
                    const periodDays = parseInt(period);
                    const daysAgo = new Date();
                    daysAgo.setDate(daysAgo.getDate() - periodDays);
                    const planDate = new Date(plan.created_at);
                    if (planDate < daysAgo) return false;
                }
                
                // Filtro de indicador
                if (indicatorId && plan.indicator_id !== indicatorId) {
                    return false;
                }
                
                // Filtro de estado
                if (status && plan.plan_status !== status) {
                    return false;
                }
                
                return true;
            });
            
            // Recargar datos del período anterior si cambió el período
            loadPreviousPeriodData();
            
            renderDashboard();
        }
        
        function clearFilters() {
            document.getElementById('filterPeriod').value = '90';
            document.getElementById('filterIndicator').value = '';
            document.getElementById('filterStatus').value = '';
            
            filteredPlans = [...allPlans];
            renderDashboard();
        }
        
        function filterByStatus(status) {
            document.getElementById('filterStatus').value = status;
            applyFilters();
        }
        
        // ==========================================
        // RENDERIZAR DASHBOARD
        // ==========================================
        
        function renderDashboard() {
            renderKPIs();
            updateCharts();
            renderActivityTimeline();
            renderPlansTable();
        }
        
        function renderKPIs() {
            const activePlans = filteredPlans.filter(p => p.plan_status === 'active').length;
            const completedPlans = filteredPlans.filter(p => p.plan_status === 'completed').length;
            const uniqueIndicators = new Set(filteredPlans.map(p => p.indicator_id)).size;
            const tasksCount = allTasks.filter(t => 
                filteredPlans.some(p => p.plan_id === t.improvement_plan_id)
            ).length;
            
            // Actualizar valores
            document.getElementById('kpiActivePlans').textContent = activePlans;
            document.getElementById('kpiCompletedPlans').textContent = completedPlans;
            document.getElementById('kpiIndicatorsWithPlans').textContent = uniqueIndicators;
            document.getElementById('kpiPendingTasks').textContent = tasksCount;
            
            // Calcular y mostrar tendencias
            renderTrend('trendActivePlans', activePlans, previousPeriodData.activePlans);
            renderTrend('trendCompletedPlans', completedPlans, previousPeriodData.completedPlans);
            renderTrend('trendIndicators', uniqueIndicators, previousPeriodData.indicatorsWithPlans);
            renderTrend('trendTasks', tasksCount, previousPeriodData.tasks);
        }
        
        function renderTrend(elementId, currentValue, previousValue) {
            const element = document.getElementById(elementId);
            
            if (previousValue === 0) {
                element.innerHTML = '<span class="text-muted">Sin datos previos</span>';
                element.className = 'kpi-trend neutral';
                return;
            }
            
            const difference = currentValue - previousValue;
            const percentChange = Math.round((difference / previousValue) * 100);
            
            if (difference > 0) {
                element.innerHTML = `
                    <i class="bi bi-arrow-up"></i>
                    +${difference} (${percentChange}%)
                `;
                element.className = 'kpi-trend positive';
            } else if (difference < 0) {
                element.innerHTML = `
                    <i class="bi bi-arrow-down"></i>
                    ${difference} (${percentChange}%)
                `;
                element.className = 'kpi-trend negative';
            } else {
                element.innerHTML = `
                    <i class="bi bi-dash"></i>
                    Sin cambios
                `;
                element.className = 'kpi-trend neutral';
            }
        }
        
        // ==========================================
        // INICIALIZAR GRÁFICOS
        // ==========================================
        
        function initializeCharts() {
            // Estado de planes (Donut)
            const ctxStatus = document.getElementById('chartPlanStatus').getContext('2d');
            charts.planStatus = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Activo', 'Completado', 'Borrador', 'Cancelado'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            CHART_COLORS.info,
                            CHART_COLORS.success,
                            CHART_COLORS.muted,
                            CHART_COLORS.danger
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Actividad en el tiempo (Line)
            const ctxActivity = document.getElementById('chartActivity').getContext('2d');
            charts.activity = new Chart(ctxActivity, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Notas',
                            data: [],
                            borderColor: CHART_COLORS.success,
                            backgroundColor: CHART_COLORS.success + '20',
                            tension: 0.4
                        },
                        {
                            label: 'Actualizaciones',
                            data: [],
                            borderColor: CHART_COLORS.warning,
                            backgroundColor: CHART_COLORS.warning + '20',
                            tension: 0.4
                        },
                        {
                            label: 'Planes Creados',
                            data: [],
                            borderColor: CHART_COLORS.primary,
                            backgroundColor: CHART_COLORS.primary + '20',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            
            // Top Indicadores (Bar Horizontal)
            const ctxIndicators = document.getElementById('chartTopIndicators').getContext('2d');
            charts.topIndicators = new Chart(ctxIndicators, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Número de Planes',
                        data: [],
                        backgroundColor: CHART_COLORS.primary
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            
            // Top Contribuidores (Bar Horizontal)
            const ctxContributors = document.getElementById('chartTopContributors').getContext('2d');
            charts.topContributors = new Chart(ctxContributors, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Contribuciones',
                        data: [],
                        backgroundColor: CHART_COLORS.secondary
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // ACTUALIZAR GRÁFICOS
        // ==========================================
        
        function updateCharts() {
            // Estado de planes
            const statusCounts = {
                active: filteredPlans.filter(p => p.plan_status === 'active').length,
                completed: filteredPlans.filter(p => p.plan_status === 'completed').length,
                draft: filteredPlans.filter(p => p.plan_status === 'draft').length,
                cancelled: filteredPlans.filter(p => p.plan_status === 'cancelled').length
            };
            
            charts.planStatus.data.datasets[0].data = [
                statusCounts.active,
                statusCounts.completed,
                statusCounts.draft,
                statusCounts.cancelled
            ];
            charts.planStatus.update();
            
            // Top Indicadores
            const indicatorCounts = {};
            filteredPlans.forEach(plan => {
                const name = plan.indicators?.indicator_name || 'Sin nombre';
                indicatorCounts[name] = (indicatorCounts[name] || 0) + 1;
            });
            
            const topIndicators = Object.entries(indicatorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            charts.topIndicators.data.labels = topIndicators.map(i => i[0]);
            charts.topIndicators.data.datasets[0].data = topIndicators.map(i => i[1]);
            charts.topIndicators.update();
            
            // Top Contribuidores
            const contributorCounts = {};
            allActivity.forEach(activity => {
                if (activity.user) {
                    contributorCounts[activity.user] = (contributorCounts[activity.user] || 0) + 1;
                }
            });
            
            const topContributors = Object.entries(contributorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            charts.topContributors.data.labels = topContributors.map(c => c[0]);
            charts.topContributors.data.datasets[0].data = topContributors.map(c => c[1]);
            charts.topContributors.update();
            
            // Actividad en el tiempo (últimos 6 meses)
            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push(d.toLocaleDateString('es-CO', { month: 'short', year: 'numeric' }));
            }
            
            // Contar actividad por tipo y mes
            const notesByMonth = new Array(6).fill(0);
            const updatesByMonth = new Array(6).fill(0);
            const plansByMonth = new Array(6).fill(0);
            
            allActivity.forEach(activity => {
                const activityDate = new Date(activity.timestamp);
                const monthsAgo = Math.floor((now - activityDate) / (1000 * 60 * 60 * 24 * 30));
                
                if (monthsAgo >= 0 && monthsAgo < 6) {
                    const index = 5 - monthsAgo;
                    
                    if (activity.type === 'note') {
                        notesByMonth[index]++;
                    } else if (activity.type === 'update') {
                        updatesByMonth[index]++;
                    } else if (activity.type === 'plan') {
                        plansByMonth[index]++;
                    }
                }
            });
            
            charts.activity.data.labels = months;
            charts.activity.data.datasets[0].data = notesByMonth;
            charts.activity.data.datasets[1].data = updatesByMonth;
            charts.activity.data.datasets[2].data = plansByMonth;
            charts.activity.update();
        }
        
        // ==========================================
        // TIMELINE DE ACTIVIDAD
        // ==========================================
        
        function renderActivityTimeline() {
            const container = document.getElementById('activityTimeline');
            const emptyState = document.getElementById('emptyActivity');
            
            const recentActivity = allActivity.slice(0, 15);
            
            if (recentActivity.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            emptyState.style.display = 'none';
            
            let html = '';
            
            recentActivity.forEach(activity => {
                const iconClass = activity.type === 'plan' ? 'plan' : 
                                activity.type === 'note' ? 'note' : 'update';
                
                const icon = activity.type === 'plan' ? 'bi-plus-circle-fill' :
                           activity.type === 'note' ? 'bi-chat-left-text-fill' :
                           'bi-pencil-square';
                
                const timeAgo = getTimeAgo(activity.timestamp);
                
                html += `
                    <div class="activity-item">
                        <div class="d-flex align-items-start">
                            <div class="activity-icon ${iconClass}">
                                <i class="bi ${icon}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="activity-text">
                                    <strong>${escapeHtml(activity.user)}</strong> ${escapeHtml(activity.text)}
                                </div>
                                <div class="activity-time">${timeAgo}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // TABLA DE PLANES
        // ==========================================
        
        function renderPlansTable() {
            const tbody = document.getElementById('plansTableBody');
            const emptyState = document.getElementById('emptyPlans');
            const countBadge = document.getElementById('plansCount');
            
            countBadge.textContent = filteredPlans.length;
            
            if (filteredPlans.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('plansTable').style.display = 'none';
                return;
            }
            
            emptyState.style.display = 'none';
            document.getElementById('plansTable').style.display = 'table';
            
            let html = '';
            
            filteredPlans.forEach(plan => {
                const statusLabels = {
                    draft: 'Borrador',
                    active: 'Activo',
                    completed: 'Completado',
                    cancelled: 'Cancelado'
                };

                const indicatorName = plan.indicators?.indicator_name || 'Sin indicador';
                const lastUpdate = plan.updated_at ? new Date(plan.updated_at).toLocaleDateString('es-CO') : 
                                  new Date(plan.created_at).toLocaleDateString('es-CO');
                
                // Contar tareas vinculadas
                const planTasks = allTasks.filter(t => t.improvement_plan_id === plan.plan_id);
                const tasksText = planTasks.length > 0 ? planTasks.length : '-';
                
                html += `
                    <tr onclick="showPlanDetails('${plan.plan_id}')">
                        <td><strong>${escapeHtml(plan.plan_name)}</strong></td>
                        <td>${escapeHtml(indicatorName)}</td>
                        <td>
                            <span class="badge status-${plan.plan_status}">
                                ${statusLabels[plan.plan_status]}
                            </span>
                        </td>
                        <td class="text-center">${tasksText}</td>
                        <td>${lastUpdate}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showPlanDetails('${plan.plan_id}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // ==========================================
        // MOSTRAR DETALLES DE PLAN
        // ==========================================
        
        async function showPlanDetails(planId) {
            const plan = filteredPlans.find(p => p.plan_id === planId);
            
            if (!plan) {
                showAlert('Plan no encontrado', 'danger');
                return;
            }
            
            document.getElementById('modalPlanName').textContent = plan.plan_name;
            
            const goal = plan.indicator_goals;
            const indicator = plan.indicators;
            
            const statusLabels = {
                draft: 'Borrador',
                active: 'Activo',
                completed: 'Completado',
                cancelled: 'Cancelado'
            };
            
            // Contar tareas vinculadas
            const planTasks = allTasks.filter(t => t.improvement_plan_id === plan.plan_id);
            
            let html = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Indicador:</strong>
                        <p class="mb-0">${escapeHtml(indicator?.indicator_name || 'Sin indicador')}</p>
                    </div>
                    <div class="col-md-6">
                        <strong>Estado:</strong>
                        <p class="mb-0">
                            <span class="badge status-${plan.plan_status}">${statusLabels[plan.plan_status]}</span>
                        </p>
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Meta asociada:</strong>
                    <p class="mb-0">
                        ${goal ? `Período: ${goal.period} | Valor meta: ${goal.goal_value}` : 'Sin meta asociada'}
                    </p>
                </div>
                
                <div class="mb-3">
                    <strong>Objetivo del plan:</strong>
                    <p class="mb-0">${escapeHtml(plan.plan_objective)}</p>
                </div>
            `;
            
            if (plan.strategy_summary) {
                html += `
                    <div class="mb-3">
                        <strong>Estrategia:</strong>
                        <p class="mb-0">${escapeHtml(plan.strategy_summary)}</p>
                    </div>
                `;
            }
            
            html += `
                <div class="mb-3">
                    <strong>Tareas vinculadas:</strong>
                    <p class="mb-0">${planTasks.length} tarea(s) asociada(s)</p>
                </div>
                
                <div class="mb-3">
                    <strong>Creado por:</strong>
                    <p class="mb-0">${escapeHtml(plan.users?.user_display_name || plan.users?.user_name || 'Usuario')}</p>
                </div>
                
                <div class="mb-0">
                    <strong>Fecha de creación:</strong>
                    <p class="mb-0">${new Date(plan.created_at).toLocaleString('es-CO')}</p>
                </div>
            `;
            
            document.getElementById('modalPlanContent').innerHTML = html;
            planDetailsModalInstance.show();
        }
        
        // ==========================================
        // REFRESH DASHBOARD
        // ==========================================
        
        async function refreshDashboard() {
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Actualizando...';
            
            try {
                await loadDashboardData();
                applyFilters();
                showAlert('Dashboard actualizado exitosamente', 'success');
            } catch (error) {
                console.error('Error al actualizar:', error);
                showAlert('Error al actualizar el dashboard', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        
        function getTimeAgo(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'hace un momento';
            if (seconds < 3600) return `hace ${Math.floor(seconds / 60)} min`;
            if (seconds < 86400) return `hace ${Math.floor(seconds / 3600)} horas`;
            if (seconds < 604800) return `hace ${Math.floor(seconds / 86400)} días`;
            
            return date.toLocaleDateString('es-CO');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            
            const icons = {
                success: 'check-circle',
                danger: 'exclamation-triangle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            container.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="${alertId}">
                    <i class="bi bi-${icons[type]} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
        
        function showError(message) {
            document.getElementById('loadingContainer').innerHTML = `
                <div class="text-center">
                    <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                    <p class="mt-3 text-danger">${message}</p>
                    <button class="btn btn-primary mt-2" onclick="window.location.reload()">
                        Recargar
                    </button>
                </div>
            `;
        }
        
        console.log('✅ Tablero de Mejora cargado correctamente');
    </script>
</body>
</html>
