<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.01.10.22">
    <title>Gestión de Mejora - Indicadores</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #1B365D;
            --secondary-color: #667eea;
            --tertiary-color: #764ba2;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        /* Content cards */
        .content-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        /* Filters */
        .filters-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group > div {
            flex: 1;
            min-width: 200px;
        }

        /* Indicator cards */
        .indicator-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
            cursor: pointer;
            background: white;
        }

        .indicator-card:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .indicator-card.selected {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .indicator-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .indicator-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }

        .indicator-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .indicator-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .indicator-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        /* Notes timeline */
        .notes-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .notes-timeline::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e2e8f0;
        }

        .note-item {
            position: relative;
            margin-bottom: 1.5rem;
            padding-left: 1rem;
        }

        .note-item::before {
            content: '';
            position: absolute;
            left: -1.35rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--secondary-color);
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--secondary-color);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .note-author {
            font-weight: 600;
            color: var(--primary-color);
        }

        .note-date {
            font-size: 0.8rem;
            color: #64748b;
        }

        .note-text {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 8px;
            border-left: 3px solid var(--secondary-color);
        }

        .note-type-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        /* Plans section */
        .plan-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: white;
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .plan-name {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }

        .plan-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .plan-meta-item {
            display: flex;
            flex-direction: column;
        }

        .plan-meta-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .plan-meta-value {
            font-weight: 600;
            color: var(--primary-color);
        }

        .plan-updates {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .update-item {
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-left: 3px solid var(--tertiary-color);
        }

        .update-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .update-author {
            font-weight: 600;
            color: var(--primary-color);
        }

        .update-date {
            color: #64748b;
        }

        /* Status badges */
        .status-active { background-color: #10b981; color: white; }
        .status-draft { background-color: #94a3b8; color: white; }
        .status-completed { background-color: #3b82f6; color: white; }
        .status-cancelled { background-color: #ef4444; color: white; }

        /* Loading */
        .loading-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
        }

        .empty-state i {
            font-size: 4rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }

        .empty-state h5 {
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        /* Modal customization */
        .modal-header {
            background: var(--primary-color);
            color: white;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        .required-field::after {
            content: " *";
            color: #dc2626;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .content-card {
                padding: 1.5rem;
            }

            .filter-group {
                flex-direction: column;
            }

            .filter-group > div {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <div class="container-fluid">
        <!-- Loading State -->
        <div class="loading-container" id="loadingContainer">
            <div class="spinner-container text-center">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3 text-muted">Cargando gestión de mejora...</p>
            </div>
        </div>

        <!-- Page Content (hidden initially) -->
        <div id="pageContent" style="display: none;">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mt-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="../../dashboard.html">
                            <i class="bi bi-house-door-fill me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="./index.html">Indicadores</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        Gestión de Mejora
                    </li>
                </ol>
            </nav>

            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col">
                    <h1 class="h3">
                        <i class="bi bi-graph-up-arrow me-2" style="color: var(--primary-color);"></i>
                        Gestión de Mejora
                    </h1>
                    <p class="text-muted">Analiza el desempeño de los indicadores, documenta observaciones colaborativas y crea planes de acción vinculados a metas específicas</p>
                </div>
            </div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Info Banner -->
            <div class="content-card">
                <div class="d-flex">
                    <div class="me-3">
                        <i class="bi bi-info-circle text-info" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Acerca de la Gestión de Mejora</h6>
                        <p class="text-muted mb-0">
                            Este módulo permite analizar el desempeño de los indicadores, documentar observaciones colaborativas y 
                            crear planes de acción vinculados a metas específicas para la mejora continua.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="content-card">
                <div class="filters-section">
                    <div class="filter-group">
                        <div>
                            <label class="form-label">Buscar Indicador</label>
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Nombre del indicador..." onkeyup="applyFilters()">
                        </div>
                        <div>
                            <label class="form-label">Estado del Indicador</label>
                            <select class="form-select" id="filterStatus" onchange="applyFilters()">
                                <option value="">Todos</option>
                                <option value="active">Activos</option>
                                <option value="inactive">Inactivos</option>
                                <option value="testing">En Pruebas</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Filtro Especial</label>
                            <select class="form-select" id="filterSpecial" onchange="applyFilters()">
                                <option value="">Todos los indicadores</option>
                                <option value="my_indicators">Mis indicadores</option>
                                <option value="with_plans">Con planes activos</option>
                                <option value="without_plans">Sin planes</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: end;">
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-1"></i>Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Indicators List -->
            <div class="content-card" id="mainContent">
                <h5 class="mb-3">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Indicadores
                    <span class="badge bg-primary ms-2" id="indicatorCount">0</span>
                </h5>
                
                <div id="indicatorsContainer">
                    <!-- Se llenará dinámicamente -->
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <i class="bi bi-speedometer2"></i>
                    <h5>No hay indicadores</h5>
                    <p class="text-muted">
                        No se encontraron indicadores con los filtros aplicados.
                    </p>
                </div>
            </div>

            <!-- Detail Panel (shown when indicator selected) -->
            <div class="content-card" id="detailPanel" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-clipboard-data me-2"></i>
                        <span id="detailIndicatorName">Indicador</span>
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="closeDetailPanel()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="detailTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="notes-tab" data-bs-toggle="tab" 
                                data-bs-target="#notes-panel" type="button" role="tab">
                            <i class="bi bi-chat-left-text me-1"></i>Notas de Análisis
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="plans-tab" data-bs-toggle="tab" 
                                data-bs-target="#plans-panel" type="button" role="tab">
                            <i class="bi bi-list-check me-1"></i>Planes de Mejora
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="detailTabContent">
                    <!-- Notes Panel -->
                    <div class="tab-pane fade show active" id="notes-panel" role="tabpanel">
                        <div class="mb-3">
                            <button class="btn btn-primary btn-sm" onclick="openAddNoteModal()">
                                <i class="bi bi-plus-circle me-1"></i>Agregar Nota
                            </button>
                        </div>
                        <div id="notesContainer">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>

                    <!-- Plans Panel -->
                    <div class="tab-pane fade" id="plans-panel" role="tabpanel">
                        <div class="mb-3" id="createPlanButtonContainer">
                            <!-- Botón solo visible para propietario -->
                        </div>
                        <div id="plansContainer">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Add Analysis Note -->
    <div class="modal fade" id="addNoteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-chat-left-text me-2"></i>Agregar Nota de Análisis
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addNoteForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="noteType" class="form-label required-field">Tipo de Nota</label>
                            <select class="form-select" id="noteType" required>
                                <option value="analysis">Análisis</option>
                                <option value="observation">Observación</option>
                                <option value="concern">Preocupación</option>
                                <option value="insight">Hallazgo</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="noteText" class="form-label required-field">Nota</label>
                            <textarea class="form-control" id="noteText" rows="5" required
                                      placeholder="Describe tu análisis, observación o hallazgo..."></textarea>
                            <small class="text-muted">
                                Esta nota será visible para todos los usuarios con acceso al módulo de mejora.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar Nota
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Create/Edit Improvement Plan -->
    <div class="modal fade" id="planModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="planModalTitle">
                        <i class="bi bi-plus-circle me-2"></i>Nuevo Plan de Mejora
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="planForm">
                    <div class="modal-body">
                        <input type="hidden" id="planId">
                        <input type="hidden" id="planIndicatorId">

                        <!-- Goal Selection -->
                        <div class="mb-3">
                            <label for="planGoalId" class="form-label required-field">Meta Asociada</label>
                            <select class="form-select" id="planGoalId" required>
                                <option value="">-- Seleccionar meta --</option>
                            </select>
                            <small class="text-muted">
                                El plan debe estar vinculado a una meta específica del indicador.
                                <span id="noGoalsWarning" class="text-danger" style="display: none;">
                                    ⚠️ Este indicador no tiene metas configuradas.
                                </span>
                            </small>
                        </div>

                        <!-- Goal Details (shown when goal selected) -->
                        <div id="goalDetails" class="alert alert-info" style="display: none;">
                            <strong>Meta seleccionada:</strong>
                            <div class="mt-2">
                                <div><strong>Período:</strong> <span id="goalDetailPeriod"></span></div>
                                <div><strong>Valor meta:</strong> <span id="goalDetailValue"></span></div>
                                <div><strong>Justificación:</strong> <span id="goalDetailJustification"></span></div>
                            </div>
                        </div>

                        <!-- Plan Information -->
                        <div class="mb-3">
                            <label for="planName" class="form-label required-field">Nombre del Plan</label>
                            <input type="text" class="form-control" id="planName" required
                                   placeholder="ej: Plan de mejora Q1 2025">
                        </div>

                        <div class="mb-3">
                            <label for="planObjective" class="form-label required-field">Objetivo</label>
                            <textarea class="form-control" id="planObjective" rows="3" required
                                      placeholder="¿Qué se quiere lograr con este plan?"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="planStrategy" class="form-label">Estrategia / Acciones Planeadas</label>
                            <textarea class="form-control" id="planStrategy" rows="4"
                                      placeholder="Describe la estrategia general y las principales acciones..."></textarea>
                            <small class="text-muted">
                                Las tareas específicas se pueden gestionar desde el módulo de Tareas.
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="planStatus" class="form-label">Estado</label>
                            <select class="form-select" id="planStatus">
                                <option value="draft">Borrador</option>
                                <option value="active" selected>Activo</option>
                                <option value="completed">Completado</option>
                                <option value="cancelled">Cancelado</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" id="planSubmitBtn">
                            <i class="bi bi-check-circle me-1"></i>Crear Plan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Add Plan Update -->
    <div class="modal fade" id="addUpdateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-chat-square-text me-2"></i>Agregar Actualización
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addUpdateForm">
                    <div class="modal-body">
                        <input type="hidden" id="updatePlanId">

                        <div class="mb-3">
                            <label for="updateText" class="form-label required-field">Actualización de Progreso</label>
                            <textarea class="form-control" id="updateText" rows="4" required
                                      placeholder="Describe los avances, logros o dificultades..."></textarea>
                            <small class="text-muted">
                                Esta actualización será visible para todos.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar Actualización
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Config.js -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let currentUser = null;
        let hasAccess = false;
        
        let allIndicators = [];
        let filteredIndicators = [];
        let selectedIndicatorId = null;
        let selectedIndicator = null;
        
        let addNoteModalInstance = null;
        let planModalInstance = null;
        let addUpdateModalInstance = null;
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('📄 Página Gestión de Mejora iniciada');
            
            const session = getStoredSession();
            if (!session || !session.user) {
                console.log('❌ No hay sesión activa, redirigiendo a login...');
                window.location.href = '/login.html';
                return;
            }
            
            currentUser = session.user;
            console.log('✅ Usuario autenticado:', currentUser.user_name);
            
            // Validar permiso de acceso a esta página
            hasAccess = await validatePageAccess('Gestión de mejora');
            
            if (!hasAccess) {
                return;
            }
            
            await loadPage();
        });
        
        // ==========================================
        // CARGAR PÁGINA
        // ==========================================
        
        async function loadPage() {
            try {
                applyInstitutionColors();

                addNoteModalInstance = new bootstrap.Modal(document.getElementById('addNoteModal'));
                planModalInstance = new bootstrap.Modal(document.getElementById('planModal'));
                addUpdateModalInstance = new bootstrap.Modal(document.getElementById('addUpdateModal'));
                
                await loadIndicators();
                
                document.getElementById('loadingContainer').style.display = 'none';
                document.getElementById('pageContent').style.display = 'block';
                
            } catch (error) {
                console.error('❌ Error cargando página:', error);
                showError('Error al cargar la página. Por favor, recarga.');
            }
        }
        
        // ==========================================
        // APLICAR COLORES CORPORATIVOS
        // ==========================================
        
        function applyInstitutionColors() {
            if (APP_CONFIG && APP_CONFIG.institution && APP_CONFIG.institution.colors) {
                const colors = APP_CONFIG.institution.colors;
                
                document.documentElement.style.setProperty('--primary-color', colors.primary);
                document.documentElement.style.setProperty('--secondary-color', colors.secondary);
                document.documentElement.style.setProperty('--tertiary-color', colors.tertiary);
                
                console.log('🎨 Colores corporativos aplicados');
            }
        }
        
        // ==========================================
        // CARGAR INDICADORES
        // ==========================================
        
        async function loadIndicators() {
            try {
                const query = '/indicators?select=*,owner:users!owner_id(user_display_name,user_name)&order=indicator_name.asc';
                allIndicators = await supabaseRequest(query);
                
                console.log('✅ Indicadores cargados:', allIndicators.length);
                
                filteredIndicators = [...allIndicators];
                renderIndicatorsList();
                
            } catch (error) {
                console.error('❌ Error cargando indicadores:', error);
                showAlert('Error al cargar los indicadores', 'danger');
            }
        }
        
        // ==========================================
        // FILTROS
        // ==========================================
        
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            const special = document.getElementById('filterSpecial').value;
            
            filteredIndicators = allIndicators.filter(indicator => {
                const matchesSearch = !searchTerm || 
                    indicator.indicator_name.toLowerCase().includes(searchTerm) ||
                    (indicator.indicator_description && indicator.indicator_description.toLowerCase().includes(searchTerm));
                
                const matchesStatus = !status || indicator.indicator_status === status;
                
                let matchesSpecial = true;
                if (special === 'my_indicators') {
                    matchesSpecial = indicator.owner_id === currentUser.user_id;
                }
                
                return matchesSearch && matchesStatus && matchesSpecial;
            });
            
            renderIndicatorsList();
        }
        
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterSpecial').value = '';
            
            filteredIndicators = [...allIndicators];
            renderIndicatorsList();
        }
        
        // ==========================================
        // RENDERIZAR LISTA DE INDICADORES
        // ==========================================
        
        function renderIndicatorsList() {
            const container = document.getElementById('indicatorsContainer');
            const emptyState = document.getElementById('emptyState');
            const countBadge = document.getElementById('indicatorCount');
            
            countBadge.textContent = filteredIndicators.length;
            
            if (filteredIndicators.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            let html = '';
            
            filteredIndicators.forEach(indicator => {
                const statusBadge = indicator.indicator_status === 'active' ? 'success' : 
                                  indicator.indicator_status === 'testing' ? 'warning' : 'secondary';
                const statusText = indicator.indicator_status === 'active' ? 'Activo' : 
                                 indicator.indicator_status === 'testing' ? 'En Pruebas' : 'Inactivo';
                
                const ownerName = indicator.owner?.user_display_name || indicator.owner?.user_name || 'Sin propietario';
                const isOwner = indicator.owner_id === currentUser.user_id;
                
                const isSelected = selectedIndicatorId === indicator.indicator_id;
                
                html += `
                    <div class="indicator-card ${isSelected ? 'selected' : ''}" 
                         onclick="selectIndicator('${indicator.indicator_id}')">
                        <div class="indicator-header">
                            <h6 class="indicator-name">${escapeHtml(indicator.indicator_name)}</h6>
                            <div class="indicator-badges">
                                <span class="badge bg-${statusBadge}">${statusText}</span>
                                ${isOwner ? '<span class="badge bg-primary">Propietario</span>' : ''}
                            </div>
                        </div>
                        
                        <div class="indicator-meta">
                            <span><i class="bi bi-person me-1"></i>${escapeHtml(ownerName)}</span>
                            <span><i class="bi bi-calendar me-1"></i>${new Date(indicator.created_at).toLocaleDateString('es-CO')}</span>
                        </div>
                        
                        ${indicator.indicator_description ? 
                            `<p class="text-muted small mb-2">${escapeHtml(indicator.indicator_description)}</p>` : ''}
                        
                        <div class="indicator-actions">
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); selectIndicator('${indicator.indicator_id}')">
                                <i class="bi bi-eye me-1"></i>Ver Detalles
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // SELECCIONAR INDICADOR
        // ==========================================
        
        async function selectIndicator(indicatorId) {
            selectedIndicatorId = indicatorId;
            selectedIndicator = allIndicators.find(i => i.indicator_id === indicatorId);
            
            if (!selectedIndicator) {
                showAlert('Indicador no encontrado', 'danger');
                return;
            }
            
            renderIndicatorsList();
            
            document.getElementById('detailIndicatorName').textContent = selectedIndicator.indicator_name;
            document.getElementById('detailPanel').style.display = 'block';
            
            // Scroll to detail panel
            document.getElementById('detailPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Load data for tabs
            await loadIndicatorNotes(indicatorId);
            await loadIndicatorPlans(indicatorId);
            
            // Show create plan button only if user is owner
            const createPlanBtnContainer = document.getElementById('createPlanButtonContainer');
            if (selectedIndicator.owner_id === currentUser.user_id) {
                createPlanBtnContainer.innerHTML = `
                    <button class="btn btn-primary btn-sm" onclick="openCreatePlanModal()">
                        <i class="bi bi-plus-circle me-1"></i>Crear Plan de Mejora
                    </button>
                `;
            } else {
                createPlanBtnContainer.innerHTML = `
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Solo el propietario del indicador puede crear planes de mejora.
                    </div>
                `;
            }
        }
        
        function closeDetailPanel() {
            selectedIndicatorId = null;
            selectedIndicator = null;
            document.getElementById('detailPanel').style.display = 'none';
            renderIndicatorsList();
        }
        
        // ==========================================
        // CARGAR NOTAS DEL INDICADOR
        // ==========================================
        
        async function loadIndicatorNotes(indicatorId) {
            try {
                const query = '/kpi_indicator_analysis_notes?select=*,users!created_by(user_display_name,user_name)&indicator_id=eq.' + indicatorId + '&order=created_at.desc';
                const notes = await supabaseRequest(query);
                
                renderNotes(notes);
                
            } catch (error) {
                console.error('❌ Error cargando notas:', error);
                document.getElementById('notesContainer').innerHTML = '<p class="text-muted">Error al cargar las notas</p>';
            }
        }
        
        function renderNotes(notes) {
            const container = document.getElementById('notesContainer');
            
            if (!notes || notes.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay notas de análisis aún. Sé el primero en agregar una.</p>';
                return;
            }
            
            let html = '<div class="notes-timeline">';
            
            notes.forEach(note => {
                const authorName = note.users?.user_display_name || note.users?.user_name || 'Usuario';
                const noteDate = new Date(note.created_at).toLocaleString('es-CO');
                
                const typeLabels = {
                    'analysis': 'Análisis',
                    'observation': 'Observación',
                    'concern': 'Preocupación',
                    'insight': 'Hallazgo'
                };
                
                const typeBadges = {
                    'analysis': 'bg-primary',
                    'observation': 'bg-info',
                    'concern': 'bg-warning',
                    'insight': 'bg-success'
                };
                
                html += `
                    <div class="note-item">
                        <div class="note-header">
                            <div>
                                <span class="note-author">${escapeHtml(authorName)}</span>
                                <span class="badge ${typeBadges[note.note_type]} note-type-badge">
                                    ${typeLabels[note.note_type]}
                                </span>
                            </div>
                            <span class="note-date">${noteDate}</span>
                        </div>
                        <div class="note-text">${escapeHtml(note.note_text)}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // ==========================================
        // AGREGAR NOTA
        // ==========================================
        
        function openAddNoteModal() {
            if (!selectedIndicator) {
                showAlert('Selecciona un indicador primero', 'warning');
                return;
            }
            
            document.getElementById('addNoteForm').reset();
            addNoteModalInstance.show();
        }
        
        document.getElementById('addNoteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';
            
            try {
                const noteData = {
                    indicator_id: selectedIndicatorId,
                    note_type: document.getElementById('noteType').value,
                    note_text: document.getElementById('noteText').value.trim(),
                    created_by: currentUser.user_id
                };
                
                await supabaseRequest('/kpi_indicator_analysis_notes', {
                    method: 'POST',
                    body: JSON.stringify(noteData)
                });
                
                showAlert('Nota agregada exitosamente', 'success');
                addNoteModalInstance.hide();
                
                await loadIndicatorNotes(selectedIndicatorId);
                
            } catch (error) {
                console.error('❌ Error guardando nota:', error);
                showAlert('Error al guardar la nota', 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar Nota';
            }
        });
        
        // ==========================================
        // CARGAR PLANES DEL INDICADOR
        // ==========================================
        
        async function loadIndicatorPlans(indicatorId) {
            try {
                const query = '/kpi_improvement_plans?select=*,indicator_goals(period,goal_value,goal_justification),users!created_by(user_display_name,user_name)&indicator_id=eq.' + indicatorId + '&order=created_at.desc';
                const plans = await supabaseRequest(query);
                
                renderPlans(plans);
                
            } catch (error) {
                console.error('❌ Error cargando planes:', error);
                document.getElementById('plansContainer').innerHTML = '<p class="text-muted">Error al cargar los planes</p>';
            }
        }
        
        async function renderPlans(plans) {
            const container = document.getElementById('plansContainer');
            
            if (!plans || plans.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay planes de mejora creados para este indicador.</p>';
                return;
            }
            
            let html = '';
            
            for (const plan of plans) {
                const statusLabels = {
                    'draft': 'Borrador',
                    'active': 'Activo',
                    'completed': 'Completado',
                    'cancelled': 'Cancelado'
                };
                
                const authorName = plan.users?.user_display_name || plan.users?.user_name || 'Usuario';
                const createdDate = new Date(plan.created_at).toLocaleDateString('es-CO');
                
                const goal = plan.indicator_goals;
                const isOwner = selectedIndicator.owner_id === currentUser.user_id;
                
                // Load updates for this plan
                const updates = await loadPlanUpdates(plan.plan_id);
                
                // Load tasks for this plan
                const tasks = await loadPlanTasks(plan.plan_id);
                
                html += `
                    <div class="plan-card">
                        <div class="plan-header">
                            <h6 class="plan-name">${escapeHtml(plan.plan_name)}</h6>
                            <span class="badge status-${plan.plan_status}">${statusLabels[plan.plan_status]}</span>
                        </div>
                        
                        <div class="plan-meta">
                            <div class="plan-meta-item">
                                <span class="plan-meta-label">Meta Asociada</span>
                                <span class="plan-meta-value">
                                    Período: ${goal?.period || 'N/A'} | 
                                    Meta: ${goal?.goal_value || 'N/A'}
                                </span>
                            </div>
                            <div class="plan-meta-item">
                                <span class="plan-meta-label">Creado por</span>
                                <span class="plan-meta-value">${escapeHtml(authorName)}</span>
                            </div>
                            <div class="plan-meta-item">
                                <span class="plan-meta-label">Fecha de creación</span>
                                <span class="plan-meta-value">${createdDate}</span>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <strong>Objetivo:</strong>
                            <p class="mb-2">${escapeHtml(plan.plan_objective)}</p>
                        </div>
                        
                        ${plan.strategy_summary ? `
                            <div class="mb-2">
                                <strong>Estrategia:</strong>
                                <p class="mb-0">${escapeHtml(plan.strategy_summary)}</p>
                            </div>
                        ` : ''}
                        
                        <div class="plan-updates">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong><i class="bi bi-chat-square-text me-1"></i>Actualizaciones de Progreso</strong>
                                <button class="btn btn-sm btn-outline-primary" onclick="openAddUpdateModal('${plan.plan_id}')">
                                    <i class="bi bi-plus-circle me-1"></i>Agregar
                                </button>
                            </div>
                            <div id="updates-${plan.plan_id}">
                                ${renderPlanUpdatesHTML(updates)}
                            </div>
                        </div>
                        
                        <div class="plan-updates mt-3 pt-3 border-top">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong><i class="bi bi-check2-square me-1"></i>Tareas Vinculadas</strong>
                                <a href="../general-tools/tasks.html?plan_id=${plan.plan_id}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-plus-circle me-1"></i>Gestionar Tareas
                                </a>
                            </div>
                            <div id="tasks-${plan.plan_id}">
                                ${renderPlanTasksHTML(tasks)}
                            </div>
                        </div>
                        
                        ${isOwner ? `
                            <div class="mt-3 pt-3 border-top">
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="editPlan('${plan.plan_id}')">
                                    <i class="bi bi-pencil me-1"></i>Editar
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        async function loadPlanUpdates(planId) {
            try {
                const query = '/kpi_plan_updates?select=*,users!created_by(user_display_name,user_name)&plan_id=eq.' + planId + '&order=created_at.desc';
                return await supabaseRequest(query);
            } catch (error) {
                console.error('Error cargando actualizaciones:', error);
                return [];
            }
        }
        
        function renderPlanUpdatesHTML(updates) {
            if (!updates || updates.length === 0) {
                return '<p class="text-muted small mb-0">No hay actualizaciones aún.</p>';
            }
            
            let html = '';
            updates.forEach(update => {
                const authorName = update.users?.user_display_name || update.users?.user_name || 'Usuario';
                const updateDate = new Date(update.created_at).toLocaleString('es-CO');
                
                html += `
                    <div class="update-item">
                        <div class="update-header">
                            <span class="update-author">${escapeHtml(authorName)}</span>
                            <span class="update-date">${updateDate}</span>
                        </div>
                        <div>${escapeHtml(update.update_text)}</div>
                    </div>
                `;
            });
            
            return html;
        }
        
        // ==========================================
        // CARGAR TAREAS VINCULADAS A UN PLAN
        // ==========================================
        
        async function loadPlanTasks(planId) {
            try {
                const query = '/tasks?select=*,assigned_to_user:users!assigned_to(user_display_name,user_name)&improvement_plan_id=eq.' + planId + '&task_state=neq.cancelled&order=created_at.desc';
                return await supabaseRequest(query);
            } catch (error) {
                console.error('Error cargando tareas del plan:', error);
                return [];
            }
        }
        
        function renderPlanTasksHTML(tasks) {
            if (!tasks || tasks.length === 0) {
                return '<p class="text-muted small mb-0">No hay tareas vinculadas a este plan.</p>';
            }
            
            const statusIcons = {
                'pending': '⏳',
                'in_progress': '🔄',
                'completed': '✅',
                'blocked': '🚫'
            };
            
            const priorityBadges = {
                'low': 'secondary',
                'medium': 'primary',
                'high': 'warning',
                'urgent': 'danger'
            };
            
            const statusLabels = {
                'pending': 'Pendiente',
                'in_progress': 'En Progreso',
                'completed': 'Completado',
                'blocked': 'Bloqueado'
            };
            
            let html = '<div class="list-group list-group-flush">';
            
            tasks.forEach(task => {
                const assignedName = task.assigned_to_user?.user_display_name || task.assigned_to_user?.user_name || 'Sin asignar';
                const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString('es-CO') : 'Sin fecha';
                const isOverdue = task.due_date && new Date(task.due_date) < new Date() && task.task_state !== 'completed';
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <span style="font-size: 1.2rem;">${statusIcons[task.task_state] || '📋'}</span>
                                    <strong>${escapeHtml(task.task_description || 'Tarea sin descripción')}</strong>
                                    <span class="badge bg-${priorityBadges[task.task_priority] || 'secondary'}">${task.task_priority || 'normal'}</span>
                                </div>
                                <div class="d-flex gap-3 text-muted" style="font-size: 0.85rem;">
                                    <span><i class="bi bi-person-circle me-1"></i>${escapeHtml(assignedName)}</span>
                                    <span class="${isOverdue ? 'text-danger' : ''}">
                                        <i class="bi bi-calendar me-1"></i>${dueDate}
                                    </span>
                                    <span>${statusLabels[task.task_state] || 'Estado desconocido'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        // ==========================================
        // CREAR/EDITAR PLAN
        // ==========================================
        
        async function openCreatePlanModal() {
            if (!selectedIndicator) {
                showAlert('Selecciona un indicador primero', 'warning');
                return;
            }
            
            if (selectedIndicator.owner_id !== currentUser.user_id) {
                showAlert('Solo el propietario puede crear planes de mejora', 'warning');
                return;
            }
            
            document.getElementById('planModalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nuevo Plan de Mejora';
            document.getElementById('planSubmitBtn').innerHTML = '<i class="bi bi-check-circle me-1"></i>Crear Plan';
            document.getElementById('planForm').reset();
            document.getElementById('planId').value = '';
            document.getElementById('planIndicatorId').value = selectedIndicatorId;
            document.getElementById('planStatus').value = 'active';
            document.getElementById('goalDetails').style.display = 'none';
            
            // Load goals for this indicator
            await loadGoalsForPlan(selectedIndicatorId);
            
            planModalInstance.show();
        }
        
        async function loadGoalsForPlan(indicatorId) {
            try {
                const query = '/indicator_goals?select=*&indicator_id=eq.' + indicatorId + '&order=period.desc';
                const goals = await supabaseRequest(query);
                
                const select = document.getElementById('planGoalId');
                const warning = document.getElementById('noGoalsWarning');
                
                if (!goals || goals.length === 0) {
                    select.innerHTML = '<option value="">-- No hay metas configuradas --</option>';
                    select.disabled = true;
                    warning.style.display = 'inline';
                    return;
                }
                
                select.disabled = false;
                warning.style.display = 'none';
                
                let html = '<option value="">-- Seleccionar meta --</option>';
                goals.forEach(goal => {
                    html += `<option value="${goal.goal_id}" 
                             data-period="${goal.period || ''}" 
                             data-value="${goal.goal_value}"
                             data-justification="${goal.goal_justification || ''}">${goal.period || 'Sin período'} - Meta: ${goal.goal_value}</option>`;
                });
                
                select.innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando metas:', error);
            }
        }
        
        // Show goal details when selected
        document.getElementById('planGoalId').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const detailsDiv = document.getElementById('goalDetails');
            
            if (!this.value) {
                detailsDiv.style.display = 'none';
                return;
            }
            
            document.getElementById('goalDetailPeriod').textContent = selectedOption.dataset.period || 'N/A';
            document.getElementById('goalDetailValue').textContent = selectedOption.dataset.value;
            document.getElementById('goalDetailJustification').textContent = selectedOption.dataset.justification || 'Sin justificación';
            
            detailsDiv.style.display = 'block';
        });
        
        document.getElementById('planForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const goalId = document.getElementById('planGoalId').value;
            if (!goalId) {
                showAlert('Debes seleccionar una meta', 'warning');
                return;
            }
            
            const submitBtn = document.getElementById('planSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';
            
            try {
                const planData = {
                    indicator_id: document.getElementById('planIndicatorId').value,
                    goal_id: goalId,
                    plan_name: document.getElementById('planName').value.trim(),
                    plan_objective: document.getElementById('planObjective').value.trim(),
                    strategy_summary: document.getElementById('planStrategy').value.trim() || null,
                    plan_status: document.getElementById('planStatus').value,
                    created_by: currentUser.user_id
                };
                
                const planId = document.getElementById('planId').value;
                
                if (planId) {
                    // Update
                    planData.updated_at = new Date().toISOString();
                    await supabaseRequest('/kpi_improvement_plans?plan_id=eq.' + planId, {
                        method: 'PATCH',
                        body: JSON.stringify(planData)
                    });
                    showAlert('Plan actualizado exitosamente', 'success');
                } else {
                    // Create
                    planData.created_at = new Date().toISOString();
                    await supabaseRequest('/kpi_improvement_plans', {
                        method: 'POST',
                        body: JSON.stringify(planData)
                    });
                    showAlert('Plan creado exitosamente', 'success');
                }
                
                planModalInstance.hide();
                await loadIndicatorPlans(selectedIndicatorId);
                
            } catch (error) {
                console.error('❌ Error guardando plan:', error);
                showAlert('Error: ' + error.message, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = planId ? 
                    '<i class="bi bi-check-circle me-1"></i>Actualizar Plan' : 
                    '<i class="bi bi-check-circle me-1"></i>Crear Plan';
            }
        });
        
        function editPlan(planId) {
            showAlert('Función de edición en desarrollo', 'info');
        }
        
        // ==========================================
        // AGREGAR ACTUALIZACIÓN A PLAN
        // ==========================================
        
        function openAddUpdateModal(planId) {
            document.getElementById('updatePlanId').value = planId;
            document.getElementById('addUpdateForm').reset();
            addUpdateModalInstance.show();
        }
        
        document.getElementById('addUpdateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';
            
            try {
                const updateData = {
                    plan_id: document.getElementById('updatePlanId').value,
                    update_text: document.getElementById('updateText').value.trim(),
                    created_by: currentUser.user_id
                };
                
                await supabaseRequest('/kpi_plan_updates', {
                    method: 'POST',
                    body: JSON.stringify(updateData)
                });
                
                showAlert('Actualización agregada exitosamente', 'success');
                addUpdateModalInstance.hide();
                
                await loadIndicatorPlans(selectedIndicatorId);
                
            } catch (error) {
                console.error('❌ Error guardando actualización:', error);
                showAlert('Error al guardar la actualización', 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar Actualización';
            }
        });
        
        // ==========================================
        // MOSTRAR MENSAJES
        // ==========================================
        
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            
            const icons = {
                success: 'check-circle',
                danger: 'exclamation-triangle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            container.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="${alertId}">
                    <i class="bi bi-${icons[type]} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        
        function showError(message) {
            document.getElementById('loadingContainer').innerHTML = `
                <div class="text-center">
                    <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                    <p class="mt-3 text-danger">${message}</p>
                    <button class="btn btn-primary mt-2" onclick="window.location.reload()">
                        Recargar
                    </button>
                </div>
            `;
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        console.log('✅ Página Gestión de Mejora cargada correctamente');
    </script>
</body>
</html>
