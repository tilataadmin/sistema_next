<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura de Datos - SchoolNet</title>
    
    <!-- Bootstrap Grid + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap-grid.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <!-- Nuestros estilos principales -->
    <link href="../../assets/css/main.css" rel="stylesheet">
    
    <style>
        .variable-card {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid transparent;
        // ==========================================
        // SELECCIONAR VARIABLE Y CAPTURAR DATOS
        // ==========================================
        
        async function selectVariable(variableId) {
            try {
                selectedVariable = assignedVariablesList.find(v => v.variable_id === variableId);
                if (!selectedVariable) return;
                
                console.log('üìù Variable seleccionada:', selectedVariable.variable_name);
                
                // Actualizar info de la variable seleccionada
                document.getElementById('selectedVariableInfo').textContent = 
                    `Capturando datos para: ${selectedVariable.variable_name}`;
                
                // Limpiar estado anterior
                segmentCombination = {};
                existingValues = [];
                
                // Cargar segmentaciones de la variable
                await loadVariableSegments(variableId);
                
                // Renderizar panel de captura
                renderDataCapturePanel();
                
                // Actualizar UI de selecci√≥n
                renderVariablesList();
                
            // ==========================================
        // GESTI√ìN DE SEGMENTACIONES
        // ==========================================
        
        function selectSegmentOption(segmentId, optionId, optionValue) {
            // Limpiar selecci√≥n anterior en este segmento
            document.querySelectorAll(`[data-segment-id="${segmentId}"] .segment-option`).forEach(option => {
                option.classList.remove('selected');
            });
            
            // Seleccionar nueva opci√≥n
            document.querySelector(`[data-option-id="${optionId}"]`).classList.add('selected');
            
            // Actualizar combinaci√≥n de segmentos
            segmentCombination[segmentId] = optionValue;
            
            console.log('Combinaci√≥n de segmentos:', segmentCombination);
        }
        
        function validateSegmentSelection() {
            const requiredSegments = variableSegments.filter(s => s.is_required);
            
            for (const segment of requiredSegments) {
                if (!segmentCombination[segment.segment_id]) {
                    return `Debes seleccionar una opci√≥n para: ${segment.segment_name}`;
                }
            }
            
            return null; // Todo v√°lido
        }
        
        // ==========================================
        // CAPTURA DE DATOS
        // ==========================================
        
        function updatePeriod() {
            selectedPeriod.year_id = document.getElementById('yearSelector').value;
            
            if (selectedVariable.periodicity === 'monthly') {
                const monthSelector = document.getElementById('monthSelector');
                selectedPeriod.month = monthSelector ? monthSelector.value : null;
            } else {
                selectedPeriod.month = null;
            }
            
            console.log('Per√≠odo seleccionado:', selectedPeriod);
        }
        
        async function saveDataValue() {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
            
            try {
                // Validaciones
                if (!selectedPeriod.year_id) {
                    throw new Error('Debes seleccionar un a√±o acad√©mico');
                }
                
                if (selectedVariable.periodicity === 'monthly' && !selectedPeriod.month) {
                    throw new Error('Debes seleccionar un mes para variables mensuales');
                }
                
                const segmentError = validateSegmentSelection();
                if (segmentError) {
                    throw new Error(segmentError);
                }
                
                const value = document.getElementById('dataValue').value;
                if (!value) {
                    throw new Error('Debes ingresar un valor');
                }
                
                // Preparar datos para guardar - usar UUID real del usuario
                const dataToSave = {
                    variable_id: selectedVariable.variable_id,
                    academic_year_id: selectedPeriod.year_id,
                    month_number: selectedVariable.periodicity === 'monthly' ? parseInt(selectedPeriod.month) : null,
                    segment_combination: Object.keys(segmentCombination).length > 0 ? segmentCombination : null,
                    value_numeric: parseFloat(value),
                    value_text: null,
                    captured_by: currentUser.user_id, // Usar UUID real del usuario
                    notes: document.getElementById('dataNotes').value.trim() || null,
                    value_status: 'active'
                };
                
                console.log('Guardando valor:', dataToSave);
                
                const savedData = await supabaseRequest('/variable_values', {
                    method: 'POST',
                    body: JSON.stringify(dataToSave)
                });
                
                showMessage('Valor guardado exitosamente', 'success');
                
                // Limpiar formulario
                document.getElementById('dataValue').value = '';
                document.getElementById('dataNotes').value = '';
                
                // Recargar valores existentes
                loadExistingValues();
                loadStats();
                
            } catch (error) {
                console.error('Error guardando valor:', error);
                showMessage(`Error guardando valor: ${error.message}`, 'danger');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar Valor';
            }
        }
        
        async function loadExistingValues() {
            if (!selectedVariable || !selectedPeriod.year_id) return;
            
            try {
                let query = `/variable_values?select=*&variable_id=eq.${selectedVariable.variable_id}&academic_year_id=eq.${selectedPeriod.year_id}&value_status=eq.active&order=captured_at.desc`;
                
                if (selectedVariable.periodicity === 'monthly' && selectedPeriod.month) {
                    query += `&month_number=eq.${selectedPeriod.month}`;
                }
                
                const values = await supabaseRequest(query);
                existingValues = values || [];
                renderExistingValues();
                
            } catch (error) {
                console.error('Error cargando valores existentes:', error);
            }
        }
        
        function renderExistingValues() {
            const container = document.getElementById('existingValuesContainer');
            
            if (existingValues.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let valuesHtml = `
                <div class="existing-values">
                    <h6 class="mb-3">Valores Existentes (${existingValues.length})</h6>
            `;
            
            existingValues.forEach(value => {
                const segmentInfo = value.segment_combination ? 
                    Object.entries(value.segment_combination).map(([k, v]) => v).join(' - ') : 
                    'Sin segmentaci√≥n';
                
                valuesHtml += `
                    <div class="value-item">
                        <div>
                            <strong>${value.value_numeric}</strong>
                            <small class="text-muted ms-2">${segmentInfo}</small>
                            ${value.notes ? `<br><small class="text-muted">${value.notes}</small>` : ''}
                        </div>
                        <div>
                            <small class="text-muted">${formatDate(value.captured_at)}</small>
                            <button class="btn btn-outline-danger btn-sm ms-2" onclick="deleteValue('${value.value_id}')" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            valuesHtml += '</div>';
            container.innerHTML = valuesHtml;
        }
        
        async function deleteValue(valueId) {
            if (!confirm('¬øEst√°s seguro de eliminar este valor?')) return;
            
            try {
                await supabaseRequest(`/variable_values?value_id=eq.${valueId}`, {
                    method: 'DELETE'
                });
                
                showMessage('Valor eliminado exitosamente', 'success');
                loadExistingValues();
                loadStats();
                
            } catch (error) {
                console.error('Error eliminando valor:', error);
                showMessage(`Error eliminando valor: ${error.message}`, 'danger');
            }
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        
        function getDataTypeLabel(dataType) {
            const labels = {
                'numeric': '(N√∫mero con decimales)',
                'integer': '(N√∫mero entero)',
                'percentage': '(Porcentaje 0-100)'
            };
            return labels[dataType] || '';
        }
        
        async function loadStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                const [capturedTodayData] = await Promise.all([
                    supabaseRequest(`/variable_values?select=value_id&captured_by=eq.${currentUser.user_id}&captured_at=gte.${today}T00:00:00`)
                ]);
                
                const capturedToday = capturedTodayData ? capturedTodayData.length : 0;
                const currentYear = academicYears.find(y => y.is_current);
                
                document.getElementById('assignedVariables').textContent = assignedVariablesList.length;
                document.getElementById('capturedToday').textContent = capturedToday;
                document.getElementById('currentPeriod').textContent = currentYear ? currentYear.year_name : '-';
                document.getElementById('pendingVariables').textContent = Math.max(0, assignedVariablesList.length - capturedToday);
                
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
                ['assignedVariables', 'capturedToday', 'currentPeriod', 'pendingVariables'].forEach(id => {
                    document.getElementById(id).textContent = '-';
                });
            }
        } catch (error) {
                console.error('Error seleccionando variable:', error);
                showMessage(`Error cargando datos de la variable: ${error.message}`, 'danger');
            }
        }
        
        async function loadVariableSegments(variableId) {
            try {
                const segments = await supabaseRequest(`/variable_segments?select=*,segments(segment_name,segment_id)&variable_id=eq.${variableId}`);
                
                // Procesar segmentaciones y sus opciones
                variableSegments = [];
                
                if (segments && segments.length > 0) {
                    // Agrupar por segmentaci√≥n
                    const segmentsMap = {};
                    
                    for (const vs of segments) {
                        if (!segmentsMap[vs.segment_id]) {
                            segmentsMap[vs.segment_id] = {
                                segment_id: vs.segment_id,
                                segment_name: vs.segments.segment_name,
                                is_required: vs.is_required,
                                options: []
                            };
                        }
                    }
                    
                    // Cargar opciones para cada segmentaci√≥n
                    for (const segmentId of Object.keys(segmentsMap)) {
                        const options = await supabaseRequest(`/segment_options?select=*&segment_id=eq.${segmentId}&option_status=eq.active&order=option_order,option_name`);
                        segmentsMap[segmentId].options = options || [];
                    }
                    
                    variableSegments = Object.values(segmentsMap);
                }
                
                console.log(`‚úÖ ${variableSegments.length} segmentaciones cargadas`);
                
            } catch (error) {
                console.error('Error cargando segmentaciones:', error);
                variableSegments = [];
            }
        }
        
        function renderDataCapturePanel() {
            const panel = document.getElementById('dataEntryPanel');
            
            if (!selectedVariable) {
                panel.innerHTML = `
                    <div class="empty-selection">
                        <i class="bi bi-database" style="font-size: 4rem;"></i>
                        <h6 class="mt-3 mb-2">Ninguna variable seleccionada</h6>
                        <p class="text-center">Selecciona una variable de la lista para comenzar la captura de datos</p>
                    </div>
                `;
                return;
            }
            
            let panelHtml = `
                <!-- Selector de per√≠odo -->
                <div class="period-selector">
                    <h6 class="mb-3">Selecci√≥n de Per√≠odo</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">A√±o Acad√©mico</label>
                            <select class="form-select" id="yearSelector" onchange="updatePeriod()">
                                ${academicYears.map(year => 
                                    `<option value="${year.year_id}" ${year.year_id === selectedPeriod.year_id ? 'selected' : ''}>
                                        ${year.year_name}
                                    </option>`
                                ).join('')}
                            </select>
                        </div>
            `;
            
            if (selectedVariable.periodicity === 'monthly') {
                panelHtml += `
                        <div class="col-md-6">
                            <label class="form-label">Mes</label>
                            <select class="form-select" id="monthSelector" onchange="updatePeriod()">
                                <option value="">Seleccionar mes</option>
                                <option value="1">Mes 1 - Agosto</option>
                                <option value="2">Mes 2 - Septiembre</option>
                                <option value="3">Mes 3 - Octubre</option>
                                <option value="4">Mes 4 - Noviembre</option>
                                <option value="5">Mes 5 - Diciembre</option>
                                <option value="6">Mes 6 - Enero</option>
                                <option value="7">Mes 7 - Febrero</option>
                                <option value="8">Mes 8 - Marzo</option>
                                <option value="9">Mes 9 - Abril</option>
                                <option value="10">Mes 10 - Mayo</option>
                                <option value="11">Mes 11 - Junio</option>
                                <option value="12">Mes 12 - Julio</option>
                            </select>
                        </div>
                `;
            }
            
            panelHtml += `
                    </div>
                </div>
            `;
            
            // Segmentaciones (si existen)
            if (variableSegments.length > 0) {
                panelHtml += `<h6 class="mb-3">Selecci√≥n de Segmentaciones</h6>`;
                
                variableSegments.forEach(segment => {
                    panelHtml += `
                        <div class="segment-group">
                            <label class="form-label">
                                ${segment.segment_name}
                                ${segment.is_required ? '<span class="text-danger">*</span>' : ''}
                            </label>
                            <div class="segment-options" data-segment-id="${segment.segment_id}">
                    `;
                    
                    segment.options.forEach(option => {
                        panelHtml += `
                            <span class="segment-option" 
                                  data-option-id="${option.option_id}"
                                  data-option-value="${option.option_value}"
                                  onclick="selectSegmentOption('${segment.segment_id}', '${option.option_id}', '${option.option_value}')">
                                ${option.option_name}
                            </span>
                        `;
                    });
                    
                    panelHtml += `
                            </div>
                        </div>
                    `;
                });
            }
            
            // Formulario de captura
            panelHtml += `
                <div class="data-form">
                    <h6 class="mb-3">Captura de Valor</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Valor ${getDataTypeLabel(selectedVariable.data_type)}</label>
                            <input type="number" class="form-control" id="dataValue" 
                                   placeholder="Ingresa el valor" step="0.01" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Observaciones (Opcional)</label>
                            <input type="text" class="form-control" id="dataNotes" 
                                   placeholder="Comentarios adicionales">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" onclick="saveDataValue()" id="saveBtn">
                            <i class="bi bi-check-circle me-1"></i>Guardar Valor
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="loadExistingValues()">
                            <i class="bi bi-list me-1"></i>Ver Valores Existentes
                        </button>
                    </div>
                </div>
                
                <!-- Valores existentes -->
                <div id="existingValuesContainer"></div>
            `;
            
            panel.innerHTML = panelHtml;
        }
        
        .variable-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .variable-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(37, 99, 235, 0.05);
        }
        
        .data-entry-panel {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 500px;
        }
        
        .empty-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: var(--text-muted);
        }
        
        .period-selector {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .segment-group {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .segment-option {
            padding: 0.5rem;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            margin: 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            background: white;
        }
        
        .segment-option:hover {
            border-color: var(--primary-color);
            background-color: rgba(37, 99, 235, 0.1);
        }
        
        .segment-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(37, 99, 235, 0.1);
            font-weight: 500;
        }
        
        .data-form {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .period-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .period-annual { background-color: #e0f2fe; color: #0c4a6e; }
        .period-monthly { background-color: #f0fdf4; color: #166534; }
        
        .data-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .type-numeric { background-color: #fef3c7; color: #92400e; }
        .type-integer { background-color: #e0f2fe; color: #0c4a6e; }
        .type-percentage { background-color: #dcfce7; color: #166534; }
        
        .existing-values {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .value-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .value-item:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 768px) {
            .data-entry-panel {
                padding: 1rem;
            }
            
            .period-selector {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="main-container">
            <nav class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">SchoolNet</h4>
                    <span class="text-muted">Captura de Datos</span>
                </div>
                <a href="index.html" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Volver al M√≥dulo
                </a>
            </nav>
        </div>
    </div>

    <div class="main-container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <span class="breadcrumb-item">Indicadores</span>
            <span class="breadcrumb-item active">Captura de Datos</span>
        </nav>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Informaci√≥n sobre captura -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex">
                    <div class="me-3">
                        <i class="bi bi-info-circle text-info" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Captura de Datos de Variables</h6>
                        <p class="text-muted mb-0">
                            Registra los valores de las variables seg√∫n su periodicidad y segmentaciones configuradas. 
                            Solo puedes capturar datos de las variables asignadas a tu usuario.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Panel izquierdo: Variables asignadas -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-database me-2"></i>Variables Asignadas</h5>
                        <button class="btn btn-outline-secondary btn-sm" onclick="loadAssignedVariables()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    
                    <div class="card-body p-0">
                        <div class="p-3 border-bottom">
                            <input type="text" class="form-control" id="searchVariables" 
                                   placeholder="Buscar variables..." onkeyup="filterVariables()">
                        </div>
                        
                        <div id="variablesContainer" style="max-height: 500px; overflow-y: auto;">
                            <div class="loading-state">
                                <div class="spinner-border text-primary"></div>
                                <span>Cargando variables...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel derecho: Captura de datos -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Captura de Datos</h5>
                        <small class="text-muted" id="selectedVariableInfo">Selecciona una variable para capturar datos</small>
                    </div>
                    
                    <div class="card-body">
                        <div id="dataEntryPanel" class="data-entry-panel">
                            <div class="empty-selection">
                                <i class="bi bi-database" style="font-size: 4rem;"></i>
                                <h6 class="mt-3 mb-2">Ninguna variable seleccionada</h6>
                                <p class="text-center">Selecciona una variable de la lista para comenzar la captura de datos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen de actividad -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-activity me-2"></i>Resumen de Actividad</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <i class="bi bi-database text-primary" style="font-size: 2rem;"></i>
                            <h4 class="mt-2 mb-1" id="assignedVariables">-</h4>
                            <small class="text-muted">Variables Asignadas</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                            <h4 class="mt-2 mb-1" id="capturedToday">-</h4>
                            <small class="text-muted">Capturados Hoy</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <i class="bi bi-calendar text-info" style="font-size: 2rem;"></i>
                            <h4 class="mt-2 mb-1" id="currentPeriod">-</h4>
                            <small class="text-muted">Per√≠odo Actual</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <i class="bi bi-clock text-warning" style="font-size: 2rem;"></i>
                            <h4 class="mt-2 mb-1" id="pendingVariables">-</h4>
                            <small class="text-muted">Pendientes</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer del sistema -->
    <div class="system-footer">
        <div class="main-container">
            <p class="mb-0">SchoolNet - Captura de Datos v1.0</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VALIDACI√ìN DE ACCESO A LA P√ÅGINA
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // Validar acceso antes de continuar
                const hasAccess = await validatePageAccess('Captura de datos');
                
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                
                // Continuar con inicializaci√≥n original
                if (window.SUPABASE_CONFIG) {
                    initializePage();
                } else {
                    setTimeout(initializePage, 100);
                }
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let assignedVariablesList = [];
        let filteredVariables = [];
        let selectedVariable = null;
        let variableSegments = [];
        let academicYears = [];
        let currentUser = null;
        let selectedPeriod = {
            year_id: null,
            month: null
        };
        let segmentCombination = {};
        let existingValues = [];
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        
        async function initializePage() {
            console.log('üîß Inicializando p√°gina de captura');
            
            // Obtener usuario actual de la sesi√≥n
            const session = getSession();
            if (!session) {
                window.location.href = '../../login.html';
                return;
            }
            
            currentUser = session.user;
            console.log('üë§ Usuario actual:', currentUser.user_name);
            
            await Promise.all([
                loadAssignedVariables(),
                loadAcademicYears()
            ]);
            
            loadStats();
        }

        function getSession() {
            try {
                const session = localStorage.getItem('schoolnetSession') || 
                               sessionStorage.getItem('schoolnetSession');
                return session ? JSON.parse(session) : null;
            } catch (error) {
                console.error('Error obteniendo sesi√≥n:', error);
                return null;
            }
        }
        
        // ==========================================
        // CARGAR DATOS B√ÅSICOS
        // ==========================================
        
        async function loadAssignedVariables() {
            const container = document.getElementById('variablesContainer');
            container.innerHTML = `
                <div class="loading-state p-3">
                    <div class="spinner-border text-primary"></div>
                    <span>Cargando variables...</span>
                </div>
            `;
            
            try {
                // Cargar variables asignadas al usuario actual mediante variable_permissions
                const query = `/variable_permissions?select=variables(variable_id,variable_name,variable_description,periodicity,data_type,variable_status,users!variables_owner_id_fkey(user_name,user_display_name))&user_id=eq.${currentUser.user_id}&permission_type=in.(write,admin)`;
                
                const permissions = await supabaseRequest(query);
                
                // Extraer las variables de las asignaciones y filtrar activas
                assignedVariablesList = [];
                if (permissions && permissions.length > 0) {
                    assignedVariablesList = permissions
                        .map(p => p.variables)
                        .filter(v => v && v.variable_status === 'active');
                }
                
                filteredVariables = [...assignedVariablesList];
                renderVariablesList();
                
                console.log(`‚úÖ ${assignedVariablesList.length} variables asignadas cargadas`);
                
            } catch (error) {
                console.error('Error cargando variables asignadas:', error);
                container.innerHTML = `
                    <div class="empty-state p-3">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        <h6>Error cargando variables</h6>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadAssignedVariables()">Reintentar</button>
                    </div>
                `;
            }
        }
        
        async function loadAcademicYears() {
            try {
                const years = await supabaseRequest('/academic_years?select=year_id,year_name,is_current&year_status=eq.active&order=year_name');
                academicYears = years || [];
                
                // Seleccionar a√±o actual por defecto
                const currentYear = academicYears.find(y => y.is_current);
                if (currentYear) {
                    selectedPeriod.year_id = currentYear.year_id;
                }
                
            } catch (error) {
                console.error('Error cargando a√±os acad√©micos:', error);
                academicYears = [];
            }
        }
        
        // ==========================================
        // RENDERIZAR VARIABLES
        // ==========================================
        
        function renderVariablesList() {
            const container = document.getElementById('variablesContainer');
            
            if (filteredVariables.length === 0) {
                container.innerHTML = `
                    <div class="empty-state p-3">
                        <i class="bi bi-database text-muted"></i>
                        <h6>No hay variables asignadas</h6>
                        <p class="text-center">No tienes variables asignadas para captura de datos</p>
                    </div>
                `;
                return;
            }
            
            let variablesHtml = '';
            
            filteredVariables.forEach(variable => {
                const isSelected = selectedVariable && selectedVariable.variable_id === variable.variable_id;
                const ownerName = variable.users ? (variable.users.user_display_name || variable.users.user_name) : 'Sin propietario';
                
                variablesHtml += `
                    <div class="variable-card p-3 border-bottom ${isSelected ? 'selected' : ''}" 
                         onclick="selectVariable('${variable.variable_id}')">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="bi bi-database text-primary" style="font-size: 1.5rem;"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${variable.variable_name}</h6>
                                <div class="mb-2">
                                    <span class="period-badge period-${variable.periodicity}">${variable.periodicity.toUpperCase()}</span>
                                    <span class="data-type-badge type-${variable.data_type} ms-1">${variable.data_type.toUpperCase()}</span>
                                </div>
                                <small class="text-muted">${variable.variable_description || 'Sin descripci√≥n'}</small>
                                <div class="mt-1">
                                    <small class="text-muted">Propietario: ${ownerName}</small>
                                </div>
                            </div>
                            ${isSelected ? '<i class="bi bi-check-circle text-success"></i>' : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = variablesHtml;
        }
        
        function filterVariables() {
            const searchTerm = document.getElementById('searchVariables').value.toLowerCase();
            
            filteredVariables = assignedVariablesList.filter(variable => {
                return !searchTerm || 
                    variable.variable_name.toLowerCase().includes(searchTerm) ||
                    (variable.variable_description && variable.variable_description.toLowerCase().includes(searchTerm));
            });
            
            renderVariablesList();
        }
    </script>
</body>
</html>
