<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Indicadores - SchoolNet</title>
    
    <!-- Bootstrap Grid + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap-grid.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <!-- Nuestros estilos principales -->
    <link href="../../assets/css/main.css" rel="stylesheet">
    
    <style>
        .indicator-card {
            transition: all 0.2s ease;
            cursor: pointer;
        
        function populateOwnerSelect() {
            const select = document.getElementById('ownerId');
            select.innerHTML = '<option value="">Seleccionar propietario</option>';
            
            availableUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.user_id;
                option.textContent = user.user_display_name || user.user_name;
                select.appendChild(option);
            });
        }
        
        function populateOwnerFilter() {
            const filter = document.getElementById('filterOwner');
            filter.innerHTML = '<option value="">Todos los propietarios</option>';
            
            availableUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.user_id;
                option.textContent = user.user_display_name || user.user_name;
                filter.appendChild(option);
            });
        }
        
        function renderAvailableVariables() {
            const container = document.getElementById('availableVariables');
            
            if (availableVariables.length === 0) {
                container.innerHTML = '<small class="text-muted">No hay variables disponibles</small>';
                return;
            }
            
            let variablesHtml = '';
            availableVariables.forEach(variable => {
                variablesHtml += `
                    <span class="badge bg-secondary me-1 mb-1" style="cursor: pointer;" 
                          onclick="insertVariable('${variable.variable_name}')"
                          title="${variable.data_type}">
                        ${variable.variable_name}
                    </span>
                `;
            });
            
            container.innerHTML = variablesHtml;
        }
        
        function insertVariable(variableName) {
            const textarea = document.getElementById('formulaExpression');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            textarea.value = text.substring(0, start) + variableName + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + variableName.length, start + variableName.length);
        }
        
        // ==========================================
        // CARGAR Y MOSTRAR INDICADORES
        // ==========================================
        
        async function loadIndicators() {
            const container = document.getElementById('indicatorsContainer');
            container.innerHTML = `
                <div class="loading-state">
                    <div class="spinner-border text-primary"></div>
                    <span>Cargando indicadores...</span>
                </div>
            `;
            
            try {
                const indicators = await supabaseRequest('/indicators?select=*,users(user_name,user_display_name)&order=indicator_name.asc');
                allIndicators = indicators || [];
                filteredIndicators = [...allIndicators];
                renderIndicatorsGrid();
                loadStats();
                
                console.log(`${allIndicators.length} indicadores cargados`);
                
            } catch (error) {
                console.error('Error cargando indicadores:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        <h6>Error cargando indicadores</h6>
                        <p class="text-muted">${error.message}</p>
                        <button class="btn btn-outline-primary" onclick="loadIndicators()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Reintentar
                        </button>
                    </div>
                `;
            }
        }
        
        function renderIndicatorsGrid() {
            const container = document.getElementById('indicatorsContainer');
            
            if (filteredIndicators.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-speedometer2 text-muted"></i>
                        <h6>No hay indicadores</h6>
                        <p class="text-muted">
                            ${allIndicators.length === 0 ? 
                                'No hay indicadores registrados. Crea el primer indicador del sistema.' : 
                                'No se encontraron indicadores con los filtros aplicados.'}
                        </p>
                        ${allIndicators.length === 0 ? 
                            '<button class="btn btn-primary" onclick="showCreateForm()">Crear Primer Indicador</button>' : 
                            '<button class="btn btn-outline-secondary" onclick="clearFilters()">Limpiar Filtros</button>'}
                    </div>
                `;
                return;
            }
            
            let gridHtml = '<div class="row">';
            
            filteredIndicators.forEach(indicator => {
                const statusBadge = indicator.indicator_status === 'active' ? 'bg-success' : 
                                  indicator.indicator_status === 'testing' ? 'bg-warning' : 'bg-secondary';
                const ownerName = indicator.users ? (indicator.users.user_display_name || indicator.users.user_name) : 'Sin propietario';
                const createdDate = formatDate(indicator.created_at);
                
                gridHtml += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card indicator-card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-start mb-3">
                                    <div class="me-3">
                                        <i class="bi bi-speedometer2 text-primary" style="font-size: 2rem;"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="card-title mb-1">${indicator.indicator_name}</h6>
                                        <div class="mb-2">
                                            <span class="badge ${statusBadge} me-1">${indicator.indicator_status}</span>
                                            <span class="result-format-badge format-${indicator.result_format}">
                                                ${indicator.result_format.toUpperCase()}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <p class="card-text text-muted small mb-3">
                                    ${indicator.indicator_description || 'Sin descripción'}
                                </p>
                                
                                <div class="mb-3">
                                    <small class="text-muted d-block">Fórmula:</small>
                                    <code class="small">${indicator.formula_expression}</code>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted">Propietario: ${ownerName}</small>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Creado: ${createdDate}</small>
                                    
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editIndicator('${indicator.indicator_id}')" title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="manageGoals('${indicator.indicator_id}')" title="Gestionar Metas">
                                            <i class="bi bi-bullseye"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="viewResults('${indicator.indicator_id}')" title="Ver Resultados">
                                            <i class="bi bi-graph-up"></i>
                                        </button>
                                        <button class="btn btn-outline-${indicator.indicator_status === 'active' ? 'warning' : 'success'}" 
                                                onclick="toggleIndicatorStatus('${indicator.indicator_id}', '${indicator.indicator_status}')" 
                                                title="${indicator.indicator_status === 'active' ? 'Desactivar' : 'Activar'}">
                                            <i class="bi bi-${indicator.indicator_status === 'active' ? 'pause' : 'play'}"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            gridHtml += '</div>';
            container.innerHTML = gridHtml;
        }
        
        // ==========================================
        // FILTRADO
        // ==========================================
        
        function filterIndicators() {
            const searchTerm = document.getElementById('searchIndicators').value.toLowerCase();
            const ownerFilter = document.getElementById('filterOwner').value;
            const statusFilter = document.getElementById('filterStatus').value;
            
            filteredIndicators = allIndicators.filter(indicator => {
                const matchesSearch = !searchTerm || 
                    indicator.indicator_name.toLowerCase().includes(searchTerm) ||
                    (indicator.indicator_description && indicator.indicator_description.toLowerCase().includes(searchTerm));
                
                const matchesOwner = !ownerFilter || indicator.owner_id === ownerFilter;
                const matchesStatus = !statusFilter || indicator.indicator_status === statusFilter;
                
                return matchesSearch && matchesOwner && matchesStatus;
            });
            
            renderIndicatorsGrid();
        }
        
        function clearFilters() {
            document.getElementById('searchIndicators').value = '';
            document.getElementById('filterOwner').value = '';
            document.getElementById('filterStatus').value = '';
            filteredIndicators = [...allIndicators];
            renderIndicatorsGrid();
        }
        
        // ==========================================
        // GESTIÓN DE METAS
        // ==========================================
        
        function addGoal() {
            const goalId = 'goal_' + Date.now();
            const goalHtml = `
                <div class="goal-item" id="${goalId}">
                    <div class="row flex-grow-1">
                        <div class="col-md-6">
                            <select class="form-select form-select-sm" name="goalYear" required>
                                <option value="">Seleccionar año</option>
                                ${availableYears.map(year => 
                                    `<option value="${year.year_id}">${year.year_name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="number" class="form-control form-control-sm" 
                                   name="goalValue" placeholder="Meta" step="0.01" required>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-danger btn-sm w-100" 
                                    onclick="removeGoal('${goalId}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('goalsContainer').insertAdjacentHTML('beforeend', goalHtml);
        }
        
        function removeGoal(goalId) {
            document.getElementById(goalId).remove();
        }
        
        function collectGoalsData() {
            const goals = [];
            const goalItems = document.querySelectorAll('.goal-item');
            
            goalItems.forEach(item => {
                const yearSelect = item.querySelector('select[name="goalYear"]');
                const valueInput = item.querySelector('input[name="goalValue"]');
                
                if (yearSelect.value && valueInput.value) {
                    goals.push({
                        academic_year_id: yearSelect.value,
                        goal_value: parseFloat(valueInput.value),
                        goal_description: null
                    });
                }
            });
            
            return goals;
        }
        
        async function loadIndicatorGoals(indicatorId) {
            try {
                const goals = await supabaseRequest(`/indicator_goals?select=*,academic_years(year_name)&indicator_id=eq.${indicatorId}`);
                currentGoals = goals || [];
                renderExistingGoals();
            } catch (error) {
                console.error('Error cargando metas:', error);
                currentGoals = [];
            }
        }
        
        function renderExistingGoals() {
            const container = document.getElementById('goalsContainer');
            container.innerHTML = '';
            
            currentGoals.forEach(goal => {
                const goalId = 'goal_' + goal.goal_id;
                const goalHtml = `
                    <div class="goal-item" id="${goalId}">
                        <div class="row flex-grow-1">
                            <div class="col-md-6">
                                <select class="form-select form-select-sm" name="goalYear" required>
                                    ${availableYears.map(year => 
                                        `<option value="${year.year_id}" ${year.year_id === goal.academic_year_id ? 'selected' : ''}>
                                            ${year.year_name}
                                        </option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control form-control-sm" 
                                       name="goalValue" value="${goal.goal_value}" step="0.01" required>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-outline-danger btn-sm w-100" 
                                        onclick="removeGoal('${goalId}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', goalHtml);
            });
        }
        
        // ==========================================
        // MODAL Y FORMULARIO
        // ==========================================
        
        function showCreateForm() {
            isEditMode = false;
            currentIndicatorId = null;
            currentGoals = [];
            
            document.getElementById('modalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Crear Nuevo Indicador';
            document.getElementById('submitBtn').innerHTML = '<i class="bi bi-check-circle me-1"></i>Crear Indicador';
            document.getElementById('submitBtn').className = 'btn btn-primary';
            
            // Limpiar formulario
            document.getElementById('indicatorForm').reset();
            document.getElementById('indicatorId').value = '';
            document.getElementById('indicatorStatus').value = 'active';
            document.getElementById('resultFormat').value = 'decimal';
            document.getElementById('goalsContainer').innerHTML = '';
            
            // Mostrar modal
            document.getElementById('indicatorModal').style.display = 'flex';
            document.getElementById('indicatorName').focus();
        }
        
        function closeIndicatorModal() {
            document.getElementById('indicatorModal').style.display = 'none';
            document.getElementById('indicatorForm').reset();
            document.getElementById('goalsContainer').innerHTML = '';
            isEditMode = false;
            currentIndicatorId = null;
            currentGoals = [];
        }
        
        // ==========================================
        // CREAR INDICADOR
        // ==========================================
        
        async function createIndicator() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creando...';
            
            try {
                const formData = {
                    indicator_name: document.getElementById('indicatorName').value.trim(),
                    indicator_description: document.getElementById('indicatorDescription').value.trim() || null,
                    formula_expression: document.getElementById('formulaExpression').value.trim(),
                    result_format: document.getElementById('resultFormat').value,
                    owner_id: document.getElementById('ownerId').value,
                    indicator_status: document.getElementById('indicatorStatus').value,
                    formula_variables: null // Se puede expandir en el futuro
                };
                
                console.log('Creando indicador:', formData);
                
                const indicatorData = await supabaseRequest('/indicators', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                const newIndicator = Array.isArray(indicatorData) ? indicatorData[0] : indicatorData;
                
                // Crear metas si existen
                const goals = collectGoalsData();
                if (goals.length > 0) {
                    const goalsWithIndicator = goals.map(goal => ({
                        ...goal,
                        indicator_id: newIndicator.indicator_id,
                        created_by: formData.owner_id
                    }));
                    
                    await supabaseRequest('/indicator_goals', {
                        method: 'POST',
                        body: JSON.stringify(goalsWithIndicator)
                    });
                }
                
                showMessage(`Indicador "${newIndicator.indicator_name}" creado exitosamente`, 'success');
                closeIndicatorModal();
                loadIndicators();
                
            } catch (error) {
                console.error('Error creando indicador:', error);
                showMessage(`Error creando indicador: ${error.message}`, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Crear Indicador';
            }
        }
        
        // ==========================================
        // OTRAS FUNCIONES
        // ==========================================
        
        async function editIndicator(indicatorId) {
            // Función en desarrollo
            showMessage('Función de edición en desarrollo', 'info');
        }
        
        async function manageGoals(indicatorId) {
            // Función en desarrollo
            showMessage('Gestión de metas en desarrollo', 'info');
        }
        
        function viewResults(indicatorId) {
            // Función en desarrollo
            showMessage('Vista de resultados en desarrollo', 'info');
        }
        
        async function toggleIndicatorStatus(indicatorId, currentStatus) {
            try {
                const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                const indicator = allIndicators.find(i => i.indicator_id === indicatorId);
                
                const confirmMessage = `¿Estás seguro de ${newStatus === 'active' ? 'activar' : 'desactivar'} el indicador "${indicator.indicator_name}"?`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                await supabaseRequest(`/indicators?indicator_id=eq.${indicatorId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ 
                        indicator_status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                });
                
                showMessage(`Indicador "${indicator.indicator_name}" ${newStatus === 'active' ? 'activado' : 'desactivado'} exitosamente`, 'success');
                loadIndicators();
                
            } catch (error) {
                console.error('Error cambiando estado:', error);
                showMessage(`Error cambiando estado: ${error.message}`, 'danger');
            }
        }
        
        async function loadStats() {
            try {
                const [goals, benchmarks] = await Promise.all([
                    supabaseRequest('/indicator_goals?select=goal_id'),
                    supabaseRequest('/indicator_benchmarks?select=indicator_id')
                ]);
                
                const activeIndicators = allIndicators.filter(i => i.indicator_status === 'active').length;
                const totalGoals = goals ? goals.length : 0;
                const withBenchmarks = benchmarks ? 
                    new Set(benchmarks.map(ib => ib.indicator_id)).size : 0;
                
                document.getElementById('totalIndicators').textContent = allIndicators.length;
                document.getElementById('activeIndicators').textContent = activeIndicators;
                document.getElementById('totalGoals').textContent = totalGoals;
                document.getElementById('withBenchmarks').textContent = withBenchmarks;
                
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
                ['totalIndicators', 'activeIndicators', 'totalGoals', 'withBenchmarks'].forEach(id => {
                    document.getElementById(id).textContent = '-';
                });
            }
        }
    </script>
</body>
</html>
        
        .indicator-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .formula-input {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
        }
        
        .result-format-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .format-decimal { background-color: #e0f2fe; color: #0c4a6e; }
        .format-percentage { background-color: #f0fdf4; color: #166534; }
        .format-integer { background-color: #fef3c7; color: #92400e; }
        
        .goals-section {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .goal-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .goal-item:last-child {
            margin-bottom: 0;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                margin: 1rem;
                max-height: 85vh;
            }
            
            .modal-header,
            .modal-body {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="main-container">
            <nav class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">SchoolNet</h4>
                    <span class="text-muted">Gestión de Indicadores</span>
                </div>

    <!-- Modal de Creación/Edición de Indicador -->
    <div id="indicatorModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modalTitle"><i class="bi bi-plus-circle me-2"></i>Crear Nuevo Indicador</h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="closeIndicatorModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="indicatorForm">
                    <input type="hidden" id="indicatorId">
                    
                    <!-- Información básica -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">INFORMACIÓN BÁSICA</h6>
                        
                        <div class="mb-3">
                            <label for="indicatorName" class="form-label">Nombre del Indicador</label>
                            <input type="text" class="form-control" id="indicatorName" required 
                                   placeholder="ej: Promedio de Calificaciones por Grado">
                            <small class="form-text">Nombre descriptivo del indicador</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="indicatorDescription" class="form-label">Descripción</label>
                            <textarea class="form-control" id="indicatorDescription" rows="2"
                                    placeholder="Describe qué mide este indicador y su importancia..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="ownerId" class="form-label">Propietario</label>
                                    <select class="form-select" id="ownerId" required>
                                        <option value="">Seleccionar propietario</option>
                                    </select>
                                    <small class="form-text">Usuario responsable del indicador</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="resultFormat" class="form-label">Formato del Resultado</label>
                                    <select class="form-select" id="resultFormat" required>
                                        <option value="decimal">Decimal (ej: 85.5)</option>
                                        <option value="percentage">Porcentaje (ej: 85.5%)</option>
                                        <option value="integer">Entero (ej: 86)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="indicatorStatus" class="form-label">Estado</label>
                            <select class="form-select" id="indicatorStatus">
                                <option value="active">Activo</option>
                                <option value="inactive">Inactivo</option>
                                <option value="testing">En Pruebas</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Fórmula -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">FÓRMULA DE CÁLCULO</h6>
                        
                        <div class="mb-3">
                            <label for="formulaExpression" class="form-label">Expresión Matemática</label>
                            <textarea class="form-control formula-input" id="formulaExpression" rows="3" required
                                    placeholder="ej: (VAR_001 + VAR_002) / 2&#10;o: SUM(VAR_003) / COUNT(VAR_003)"></textarea>
                            <small class="form-text">
                                Usa nombres de variables (VAR_XXX) y operadores matemáticos (+, -, *, /, SUM, AVG, COUNT, etc.)
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Variables Disponibles</label>
                            <div id="availableVariables" class="p-2 border rounded bg-light" style="max-height: 120px; overflow-y: auto;">
                                <small class="text-muted">Cargando variables...</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Metas por año -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">METAS POR AÑO ACADÉMICO</h6>
                        
                        <div class="goals-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-muted small">Configure las metas para cada año académico</span>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addGoal()">
                                    <i class="bi bi-plus-circle me-1"></i>Agregar Meta
                                </button>
                            </div>
                            
                            <div id="goalsContainer">
                                <!-- Las metas se cargarán dinámicamente aquí -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones -->
                    <div class="d-flex gap-2 justify-content-end mt-4">
                        <button type="button" class="btn btn-outline-secondary" onclick="closeIndicatorModal()">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="bi bi-check-circle me-1"></i>Crear Indicador
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer del sistema -->
    <div class="system-footer">
        <div class="main-container">
            <p class="mb-0">SchoolNet - Gestión de Indicadores v1.0</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VALIDACIÓN DE ACCESO A LA PÁGINA
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                // Validar acceso antes de continuar
                const hasAccess = await validatePageAccess('Indicadores');
                
                if (!hasAccess) {
                    console.log('❌ Acceso denegado - deteniendo inicialización');
                    return;
                }
                
                console.log('✅ Acceso permitido - continuando con inicialización');
                
                // Continuar con inicialización original
                if (window.SUPABASE_CONFIG) {
                    initializePage();
                } else {
                    setTimeout(initializePage, 100);
                }
                
            } catch (error) {
                console.error('❌ Error en validación de acceso:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });
        
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let allIndicators = [];
        let filteredIndicators = [];
        let availableUsers = [];
        let availableVariables = [];
        let availableYears = [];
        let currentGoals = [];
        let isEditMode = false;
        let currentIndicatorId = null;
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        
        async function initializePage() {
            console.log('🔧 Inicializando página de indicadores');
            await Promise.all([
                loadIndicators(),
                loadUsers(),
                loadVariables(),
                loadAcademicYears()
            ]);
            setupEventListeners();
        }
        
        function setupEventListeners() {
            document.getElementById('indicatorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                if (isEditMode) {
                    updateIndicator();
                } else {
                    createIndicator();
                }
            });
        }
        
        // ==========================================
        // CARGAR DATOS BÁSICOS
        // ==========================================
        
        async function loadUsers() {
            try {
                const users = await supabaseRequest('/users?select=user_id,user_name,user_display_name&user_status=eq.active&order=user_name');
                availableUsers = users || [];
                populateOwnerSelect();
                populateOwnerFilter();
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                availableUsers = [];
            }
        }
        
        async function loadVariables() {
            try {
                const variables = await supabaseRequest('/variables?select=variable_id,variable_name,data_type&variable_status=eq.active&order=variable_name');
                availableVariables = variables || [];
                renderAvailableVariables();
            } catch (error) {
                console.error('Error cargando variables:', error);
                availableVariables = [];
            }
        }
        
        async function loadAcademicYears() {
            try {
                const years = await supabaseRequest('/academic_years?select=year_id,year_name&year_status=eq.active&order=year_name');
                availableYears = years || [];
            } catch (error) {
                console.error('Error cargando años académicos:', error);
                availableYears = [];
            }
        }
                <a href="index.html" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Volver al Módulo
                </a>
            </nav>
        </div>
    </div>

    <div class="main-container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <span class="breadcrumb-item">Indicadores</span>
            <span class="breadcrumb-item active">Gestión de Indicadores</span>
        </nav>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Información sobre indicadores -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex">
                    <div class="me-3">
                        <i class="bi bi-info-circle text-info" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Acerca de los Indicadores</h6>
                        <p class="text-muted mb-0">
                            Los indicadores son métricas calculadas automáticamente a partir de las variables del sistema 
                            usando fórmulas matemáticas. Cada indicador puede tener metas específicas por año académico 
                            y ser comparado con benchmarks externos.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controles principales -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Indicadores del Sistema</h5>
                    <small class="text-muted">Gestiona indicadores con fórmulas y metas</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" onclick="loadIndicators()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                    <button class="btn btn-primary" onclick="showCreateForm()">
                        <i class="bi bi-plus-circle me-1"></i>Nuevo Indicador
                    </button>
                </div>
            </div>
            
            <!-- Filtros -->
            <div class="card-body border-bottom">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchIndicators" 
                               placeholder="Buscar indicadores..." onkeyup="filterIndicators()">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterOwner" onchange="filterIndicators()">
                            <option value="">Todos los propietarios</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterStatus" onchange="filterIndicators()">
                            <option value="">Todos los estados</option>
                            <option value="active">Activos</option>
                            <option value="inactive">Inactivos</option>
                            <option value="testing">En Pruebas</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="bi bi-x-circle me-1"></i>Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor de indicadores -->
        <div id="indicatorsContainer">
            <div class="loading-state">
                <div class="spinner-border text-primary"></div>
                <span>Cargando indicadores...</span>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Estadísticas de Indicadores</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <i class="bi bi-speedometer2 text-primary" style="font-size: 2rem;"></i>
                            <h4 class="mt-2 mb-1" id="totalIndicators">-</h4>
                            <small class="text-muted">Indicadores Totales</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                            <h4 class="mt-2 mb-1" id="activeIndicators">-</h4>
                            <small class="text-muted">Indicadores Activos</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <i class="bi bi-bullseye text-warning" style="font-size: 2rem;"></i>
                            <h4 class="mt-2 mb-1" id="totalGoals">-</h4>
                            <small class="text-muted">Metas Configuradas</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <i class="bi bi-graph-up-arrow text-info" style="font-size: 2rem;"></i>
                            <h4 class="mt-2 mb-1" id="withBenchmarks">-</h4>
                            <small class="text-muted">Con Benchmarks</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
