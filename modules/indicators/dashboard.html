<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Dashboard - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .dashboard-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
            height: 100%;
        }
        
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .indicator-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin: 1rem 0;
        }
        
        .indicator-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .formula-text {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            color: #6c757d;
        }
        
        .goal-comparison {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 1rem;
        }
        
        .goal-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        
        .goal-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .difference-badge {
            font-size: 0.9rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .difference-positive {
            background-color: #d1f4e0;
            color: #0f5132;
        }
        
        .difference-negative {
            background-color: #f8d7da;
            color: #842029;
        }
        
        .status-icon {
            font-size: 1.5rem;
        }
        
        .no-data-card {
            background: #fff3cd;
            border: 2px dashed #ffc107;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .calculation-progress {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0 fw-bold">Calculando indicadores...</p>
            <p class="calculation-progress" id="calculationProgress">Iniciando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Indicadores</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Mi Dashboard
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-bar-chart-line me-2"></i>
                    Mi Dashboard de Indicadores
                </h1>
                <p class="text-muted">
                    Visualiza los resultados calculados de tus indicadores seleccionados
                </p>
            </div>
        </div>

        <!-- ALERTAS -->
        <div id="alertContainer"></div>
        <!-- Filtros y Controles -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>Filtros
                    </h5>
                    <div class="d-flex gap-2">
                        <a href="dashboard-config.html" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-gear me-1"></i>Configurar Dashboard
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="filterYear" class="form-label">A√±o Acad√©mico</label>
                        <select class="form-select" id="filterYear" onchange="calculateIndicators()">
                            <option value="">Seleccionar a√±o...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="filterMonth" class="form-label">Mes (opcional)</label>
                        <select class="form-select" id="filterMonth" onchange="calculateIndicators()">
                            <option value="">Promedio anual</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="calculateIndicators()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Actualizar Resultados
                        </button>
                    </div>
                </div>
                
                <div class="mt-3" id="filterInfo">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Selecciona un a√±o acad√©mico para visualizar los resultados
                    </small>
                </div>
            </div>
        </div>

        <!-- Resumen -->
        <div class="row mb-4" id="summarySection" style="display: none;">
            <div class="col-md-3">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-speedometer2 text-primary" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="totalIndicators">0</h4>
                        <small class="text-muted">Indicadores</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="calculatedIndicators">0</h4>
                        <small class="text-muted">Calculados</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="noDataIndicators">0</h4>
                        <small class="text-muted">Sin Datos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-bullseye text-info" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="goalsAchieved">0</h4>
                        <small class="text-muted">Metas Logradas</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor de Indicadores Calculados -->
        <div id="indicatorsContainer">
            <div class="empty-state">
                <i class="bi bi-bar-chart-line text-muted"></i>
                <h5>Selecciona un a√±o acad√©mico</h5>
                <p class="text-muted">
                    Elige un a√±o acad√©mico en los filtros superiores para visualizar tus indicadores
                </p>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VALIDACI√ìN DE ACCESO
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Ver mi dashboard');
                
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido');
                initializePage();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let currentUser = null;
        let userIndicators = [];
        let availableYears = [];
        let availableMonths = [];
        let calculatedResults = [];
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        
        async function initializePage() {
            console.log('üîß Inicializando dashboard de indicadores');
            
            try {
                getCurrentUser();
                await loadAcademicYears();
                await loadUserIndicators();
                
                console.log('‚úÖ P√°gina inicializada');
                
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al inicializar la p√°gina: ' + error.message, 'danger');
            }
        }
        
        function getCurrentUser() {
            try {
                const session = localStorage.getItem('nextSystemSession') || 
                               sessionStorage.getItem('nextSystemSession');
                if (session) {
                    const sessionData = JSON.parse(session);
                    currentUser = sessionData.user;
                    console.log('üë§ Usuario:', currentUser.user_display_name || currentUser.user_name);
                }
            } catch (error) {
                console.error('‚ùå Error obteniendo sesi√≥n:', error);
            }
        }
        
        // ==========================================
        // CARGAR A√ëOS ACAD√âMICOS
        // ==========================================
        
        async function loadAcademicYears() {
            try {
                const years = await supabaseRequest('/academic_years?select=year_id,year_name&year_status=eq.active&order=year_order.desc');
                availableYears = years || [];
                
                const select = document.getElementById('filterYear');
                select.innerHTML = '<option value="">Seleccionar a√±o...</option>';
                
                availableYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.year_id;
                    option.textContent = year.year_name;
                    if (year.is_current) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ ${availableYears.length} a√±os acad√©micos cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando a√±os:', error);
            }
        }
        
        // ==========================================
        // CARGAR MESES ACAD√âMICOS
        // ==========================================
        async function loadAcademicMonths() {
            try {
                const months = await supabaseRequest('/academic_months?select=month_id,month_number,month_name&is_active=eq.true&order=sort_order');
                availableMonths = months || [];
                
                console.log('üìÖ Meses recibidos de la BD:', availableMonths); // DEBUG
                
                const select = document.getElementById('filterMonth');
                
                if (!select) {
                    console.error('‚ùå No se encontr√≥ el elemento filterMonth');
                    return;
                }
                
                select.innerHTML = '<option value="">Promedio anual</option>';
                
                availableMonths.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month.month_number;
                    option.textContent = month.month_name;
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ ${availableMonths.length} meses insertados en el selector`); // DEBUG
                
            } catch (error) {
                console.error('‚ùå Error cargando meses:', error);
            }
        }
                
        // ==========================================
        // CARGAR INDICADORES DEL USUARIO
        // ==========================================
        
        async function loadUserIndicators() {
            try {
                // ‚úÖ CORRECTO - Especificar la relaci√≥n user_dashboard_indicators_indicator_id_fkey
                const userConfig = await supabaseRequest(
                    `/user_dashboard_indicators?select=indicator_id,indicators!user_dashboard_indicators_indicator_id_fkey(*)&user_id=eq.${currentUser.user_id}&order=display_order`
                );
                
                if (!userConfig || userConfig.length === 0) {
                    showEmptyDashboard();
                    return;
                }
                
                userIndicators = userConfig.map(item => item.indicators);
                
                console.log(`‚úÖ ${userIndicators.length} indicadores configurados`);
                
                // Cargar meses acad√©micos
                await loadAcademicMonths();
                
            } catch (error) {
                console.error('‚ùå Error cargando indicadores del usuario:', error);
                showMessage('Error al cargar tus indicadores: ' + error.message, 'danger');
            }
        }
        
        function showEmptyDashboard() {
            const container = document.getElementById('indicatorsContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-grid-3x3 text-muted"></i>
                    <h5>No tienes indicadores configurados</h5>
                    <p class="text-muted">
                        Ve a "Configurar Mi Dashboard" para seleccionar los indicadores que deseas visualizar
                    </p>
                    <a href="dashboard-config.html" class="btn btn-primary">
                        <i class="bi bi-gear me-1"></i>Configurar Dashboard
                    </a>
                </div>
            `;
        }
      // ==========================================
        // CALCULAR TODOS LOS INDICADORES
        // ==========================================
        
        async function calculateIndicators() {
            const yearId = document.getElementById('filterYear').value;
            const monthNumber = document.getElementById('filterMonth').value;
            
            if (!yearId) {
                showMessage('Selecciona un a√±o acad√©mico', 'warning');
                return;
            }
            
            if (userIndicators.length === 0) {
                showEmptyDashboard();
                return;
            }
            
            mostrarLoading();
            calculatedResults = [];
            
            try {
                console.log(`üìä Calculando ${userIndicators.length} indicadores...`);
                
                let calculatedCount = 0;
                
                for (let i = 0; i < userIndicators.length; i++) {
                    const indicator = userIndicators[i];
                    updateCalculationProgress(`Calculando ${i + 1} de ${userIndicators.length}: ${indicator.indicator_name}`);
                    
                    const result = await calculateSingleIndicator(indicator, yearId, monthNumber);
                    calculatedResults.push(result);
                    
                    if (result.calculated) {
                        calculatedCount++;
                    }
                }
                
                console.log(`‚úÖ ${calculatedCount} de ${userIndicators.length} indicadores calculados`);
                
                renderResults();
                updateSummary();
                
            } catch (error) {
                console.error('‚ùå Error calculando indicadores:', error);
                showMessage('Error al calcular indicadores: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CALCULAR UN INDICADOR INDIVIDUAL
        // ==========================================
        
        async function calculateSingleIndicator(indicator, yearId, monthNumber) {
            try {
                // Extraer variables de la f√≥rmula
                const variablePattern = /VAR_[a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë_]+/gu;
                const variablesInFormula = indicator.formula_expression.match(variablePattern) || [];
                const uniqueVariables = [...new Set(variablesInFormula)];
                
                if (uniqueVariables.length === 0) {
                    return {
                        indicator: indicator,
                        calculated: false,
                        error: 'La f√≥rmula no contiene variables v√°lidas'
                    };
                }
                
                // Obtener valores de cada variable
                const variableValues = {};
                let allValuesFound = true;
                
                for (const varName of uniqueVariables) {
                    const value = await getVariableValue(varName, yearId, monthNumber);
                    
                    if (value === null) {
                        allValuesFound = false;
                        break;
                    }
                    
                    variableValues[varName] = value;
                }
                
                if (!allValuesFound) {
                    return {
                        indicator: indicator,
                        calculated: false,
                        error: 'Sin datos capturados para alguna variable'
                    };
                }
                
                // Reemplazar variables por valores en la f√≥rmula
                let formulaWithValues = indicator.formula_expression;
                
                for (const [varName, value] of Object.entries(variableValues)) {
                    const regex = new RegExp(varName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                    formulaWithValues = formulaWithValues.replace(regex, value);
                }
                
                // Validar que solo contenga n√∫meros y operadores
                const safeFormula = formulaWithValues.replace(/\s+/g, '');
                if (!/^[0-9+\-*/().]+$/.test(safeFormula)) {
                    return {
                        indicator: indicator,
                        calculated: false,
                        error: 'F√≥rmula con caracteres no v√°lidos despu√©s de reemplazar variables'
                    };
                }
                
                // Evaluar la f√≥rmula
                const result = eval(safeFormula);
                
                // Obtener meta del a√±o (si existe)
                const goal = await getIndicatorGoal(indicator.indicator_id, yearId);
                
                return {
                    indicator: indicator,
                    calculated: true,
                    value: result,
                    goal: goal,
                    variableValues: variableValues
                };
                
            } catch (error) {
                console.error(`Error calculando indicador ${indicator.indicator_name}:`, error);
                return {
                    indicator: indicator,
                    calculated: false,
                    error: error.message
                };
            }
        }
        
        // ==========================================
        // OBTENER VALOR DE UNA VARIABLE
        // ==========================================
        
        async function getVariableValue(variableName, yearId, monthNumber) {
            try {
                // Limpiar nombre de variable (remover VAR_ prefix)
                const cleanName = variableName.replace('VAR_', '').replace(/_/g, ' ');
                
                // Buscar variable por nombre
                const variables = await supabaseRequest(`/variables?select=variable_id,periodicity&variable_name=eq.${cleanName}&variable_status=eq.active&limit=1`);
                
                if (!variables || variables.length === 0) {
                    console.warn(`Variable no encontrada: ${variableName}`);
                    return null;
                }
                
                const variable = variables[0];
                
                // Construir query seg√∫n periodicidad
                let query = `/variable_values?select=value_numeric&variable_id=eq.${variable.variable_id}&academic_year_id=eq.${yearId}&value_status=eq.active`;
                
                if (variable.periodicity === 'monthly') {
                    if (monthNumber) {
                        // Mes espec√≠fico
                        query += `&month_number=eq.${monthNumber}`;
                    } else {
                        // Sin mes = promediar todos los meses
                        const values = await supabaseRequest(query);
                        if (!values || values.length === 0) return null;
                        
                        const sum = values.reduce((acc, v) => acc + (v.value_numeric || 0), 0);
                        return sum / values.length;
                    }
                }
                
                // Obtener valor
                const values = await supabaseRequest(query + '&limit=1');
                
                if (!values || values.length === 0) {
                    return null;
                }
                
                return values[0].value_numeric;
                
            } catch (error) {
                console.error(`Error obteniendo valor de ${variableName}:`, error);
                return null;
            }
        }
        
        // ==========================================
        // OBTENER META DEL INDICADOR
        // ==========================================
        
        async function getIndicatorGoal(indicatorId, yearId) {
            try {
                const goals = await supabaseRequest(`/indicator_goals?select=goal_value&indicator_id=eq.${indicatorId}&academic_year_id=eq.${yearId}&limit=1`);
                
                if (!goals || goals.length === 0) {
                    return null;
                }
                
                return goals[0].goal_value;
                
            } catch (error) {
                console.error('Error obteniendo meta:', error);
                return null;
            }
        }
      // ==========================================
        // RENDERIZAR RESULTADOS
        // ==========================================
        
        function renderResults() {
            const container = document.getElementById('indicatorsContainer');
            
            if (calculatedResults.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-calculator text-muted"></i>
                        <h5>Sin resultados</h5>
                        <p class="text-muted">No se pudieron calcular indicadores para los filtros seleccionados</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="row">';
            
            calculatedResults.forEach(result => {
                html += renderIndicatorCard(result);
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Mostrar secci√≥n de resumen
            document.getElementById('summarySection').style.display = 'flex';
        }
        
        // ==========================================
        // RENDERIZAR TARJETA DE INDICADOR
        // ==========================================
        
        function renderIndicatorCard(result) {
            const indicator = result.indicator;
            
            // Si no se pudo calcular
            if (!result.calculated) {
                return `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card dashboard-card no-data-card">
                            <div class="card-body">
                                <h6 class="indicator-name">${escapeHtml(indicator.indicator_name)}</h6>
                                <div class="text-center py-4">
                                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                                    <p class="text-muted mt-3 mb-0">
                                        <strong>Sin datos para calcular</strong><br>
                                        <small>${escapeHtml(result.error || 'Datos no disponibles')}</small>
                                    </p>
                                </div>
                                <div class="formula-text mt-3">
                                    ${escapeHtml(indicator.formula_expression)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Formatear valor seg√∫n tipo
            const formattedValue = formatResult(result.value, indicator.result_format);
            
            // Calcular diferencia con meta
            let goalSection = '';
            if (result.goal !== null) {
                const difference = result.value - result.goal;
                const percentageDiff = (difference / result.goal * 100).toFixed(1);
                const isPositive = difference >= 0;
                const statusIcon = isPositive ? 
                    '<i class="bi bi-check-circle-fill text-success status-icon"></i>' : 
                    '<i class="bi bi-exclamation-circle-fill text-warning status-icon"></i>';
                
                goalSection = `
                    <div class="goal-comparison">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                ${statusIcon}
                            </div>
                            <div class="col">
                                <div class="goal-label">Meta del a√±o</div>
                                <div class="goal-value">${formatResult(result.goal, indicator.result_format)}</div>
                            </div>
                            <div class="col-auto">
                                <span class="difference-badge ${isPositive ? 'difference-positive' : 'difference-negative'}">
                                    ${isPositive ? '+' : ''}${percentageDiff}%
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <h6 class="indicator-name">${escapeHtml(indicator.indicator_name)}</h6>
                            
                            ${indicator.indicator_description ? 
                                `<p class="text-muted small mb-3">${escapeHtml(indicator.indicator_description)}</p>` : 
                                ''}
                            
                            <div class="text-center">
                                <div class="indicator-value" style="color: ${result.goal && result.value >= result.goal ? '#198754' : '#667eea'}">
                                    ${formattedValue}
                                </div>
                            </div>
                            
                            ${goalSection}
                            
                            <div class="formula-text mt-3">
                                ${escapeHtml(indicator.formula_expression)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // ACTUALIZAR RESUMEN
        // ==========================================
        
        function updateSummary() {
            const total = calculatedResults.length;
            const calculated = calculatedResults.filter(r => r.calculated).length;
            const noData = total - calculated;
            const goalsAchieved = calculatedResults.filter(r => 
                r.calculated && r.goal !== null && r.value >= r.goal
            ).length;
            
            document.getElementById('totalIndicators').textContent = total;
            document.getElementById('calculatedIndicators').textContent = calculated;
            document.getElementById('noDataIndicators').textContent = noData;
            document.getElementById('goalsAchieved').textContent = goalsAchieved;
        }
        
        // ==========================================
        // FORMATEAR RESULTADO
        // ==========================================
        
        function formatResult(value, format) {
            if (value === null || value === undefined) {
                return '-';
            }
            
            switch (format) {
                case 'percentage':
                    return value.toFixed(1) + '%';
                case 'integer':
                    return Math.round(value).toLocaleString('es-CO');
                case 'decimal':
                default:
                    return value.toFixed(2).toLocaleString('es-CO');
            }
        }
      // ==========================================
        // UTILIDADES
        // ==========================================
        
        function updateCalculationProgress(message) {
            const progressElement = document.getElementById('calculationProgress');
            if (progressElement) {
                progressElement.textContent = message;
            }
        }
        
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // FUNCIONES GLOBALES
        // ==========================================
        
        window.calculateIndicators = calculateIndicators;
        
        console.log('üéâ Dashboard de indicadores cargado correctamente');
    </script>
</body>
</html>
