<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.25.07.37">
    <title>Mi Dashboard - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .dashboard-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
            height: 100%;
        }
        
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .indicator-value, .variable-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin: 1rem 0;
        }
        
        .indicator-name, .variable-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .formula-text {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            color: #6c757d;
        }
        
        .goal-comparison {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 1rem;
        }
        
        .goal-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        
        .goal-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .difference-badge {
            font-size: 0.9rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .difference-positive {
            background-color: #d1f4e0;
            color: #0f5132;
        }
        
        .difference-negative {
            background-color: #f8d7da;
            color: #842029;
        }
        
        .status-icon {
            font-size: 1.5rem;
        }
        
        .no-data-card {
            background: #fff3cd;
            border: 2px dashed #ffc107;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 2rem 0 1.5rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #667eea;
        }
        
        .section-title i {
            margin-right: 0.5rem;
        }
        
        .section-separator {
            height: 3px;
            background: linear-gradient(to right, #667eea, transparent);
            margin: 3rem 0;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .calculation-progress {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }
        
        .periodicity-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            background-color: #e0f2fe;
            color: #0c4a6e;
        }
        
        .sparkline-container {
            margin: 1rem 0;
            height: 80px;
            position: relative;
        }
        
        .sparkline-container canvas {
            width: 100% !important;
            height: 80px !important;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0 fw-bold">Calculando dashboard...</p>
            <p class="calculation-progress" id="calculationProgress">Iniciando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Indicadores</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Mi Dashboard
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-bar-chart-line me-2"></i>
                    Mi Dashboard Personalizado
                </h1>
                <p class="text-muted">
                    Visualiza tus indicadores calculados y variables independientes
                </p>
            </div>
        </div>

        <!-- ALERTAS -->
        <div id="alertContainer"></div>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="indicators-tab" data-bs-toggle="tab" 
                        data-bs-target="#indicators-pane" type="button" role="tab">
                    <i class="bi bi-speedometer2 me-2"></i>Mis Indicadores y Variables
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="trends-tab" data-bs-toggle="tab" 
                        data-bs-target="#trends-pane" type="button" role="tab">
                    <i class="bi bi-graph-up me-2"></i>Tendencias
                </button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content">
            <!-- TAB 1: Mis Indicadores y Variables -->
            <div class="tab-pane fade show active" id="indicators-pane" role="tabpanel">
                
                <!-- Filtros y Controles -->
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>Filtros
                    </h5>
                    <div class="d-flex gap-2">
                        <a href="dashboard-config.html" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-gear me-1"></i>Configurar Dashboard
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="filterYear" class="form-label">A√±o Acad√©mico</label>
                        <select class="form-select" id="filterYear" onchange="calculateDashboard()">
                            <option value="">Seleccionar a√±o...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="filterMonth" class="form-label">Mes (opcional)</label>
                        <select class="form-select" id="filterMonth" onchange="calculateDashboard()">
                            <option value="">Promedio anual</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="calculateDashboard()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Actualizar Resultados
                        </button>
                    </div>
                </div>
                
                <div class="mt-3" id="filterInfo">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Selecciona un a√±o acad√©mico para visualizar los resultados
                    </small>
                </div>
            </div>
        </div>

        <!-- Resumen General -->
        <div class="row mb-4" id="summarySection" style="display: none;">
            <div class="col-md-2">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-speedometer2 text-primary" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="totalIndicators">0</h4>
                        <small class="text-muted">Indicadores</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-graph-up text-secondary" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="totalVariables">0</h4>
                        <small class="text-muted">Variables</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="calculatedItems">0</h4>
                        <small class="text-muted">Calculados</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="noDataItems">0</h4>
                        <small class="text-muted">Sin Datos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-bullseye text-info" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="goalsAchieved">0</h4>
                        <small class="text-muted">Metas Logradas</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <i class="bi bi-trophy text-warning" style="font-size: 2rem;"></i>
                        <h4 class="mt-2 mb-1" id="goalsTotal">0</h4>
                        <small class="text-muted">Metas Totales</small>
                    </div>
                </div>
            </div>
        </div>

                <!-- Contenedor Principal de Resultados -->
                <div id="resultsContainer">
                    <div class="empty-state">
                        <i class="bi bi-bar-chart-line text-muted"></i>
                        <h5>Selecciona un a√±o acad√©mico</h5>
                        <p class="text-muted">
                            Elige un a√±o acad√©mico en los filtros superiores para visualizar tu dashboard
                        </p>
                    </div>
                </div>
                
            </div>
            <!-- Fin TAB 1: Indicadores -->
            
            <!-- TAB 2: Tendencias -->
            <div class="tab-pane fade" id="trends-pane" role="tabpanel">
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Vista de Tendencias:</strong> Visualiza la evoluci√≥n hist√≥rica de tus indicadores y variables a lo largo del tiempo.
                </div>
                
                <!-- Trends Charts -->
                <div id="trendsContainer">
                    <!-- Se llenar√° din√°micamente -->
                </div>
                
                <!-- Empty State -->
                <div class="empty-state" id="emptyStateTrends" style="display: none;">
                    <i class="bi bi-graph-up"></i>
                    <h5>No hay datos suficientes para mostrar tendencias</h5>
                    <p>Se requieren al menos 3 per√≠odos de datos hist√≥ricos</p>
                </div>
            </div>
            <!-- Fin TAB 2: Tendencias -->
            
        </div>
        <!-- Fin Tab Content -->

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VALIDACI√ìN DE ACCESO
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Ver mi dashboard');
                
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido');
                initializePage();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let currentUser = null;
        let userIndicators = [];
        let userVariables = [];
        let availableYears = [];
        let availableMonths = [];
        let variablesCache = {};
        let calculatedIndicators = [];
        let calculatedVariables = [];
        let chartsInstances = {}; // Instancias de Chart.js para gr√°ficos
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        
        async function initializePage() {
            console.log('üîß Inicializando dashboard personalizado');
            
            try {
                getCurrentUser();
                
                await Promise.all([
                    loadUserIndicators(),
                    loadUserVariables(),
                    loadAcademicYears()
                ]);
                
                if ((userIndicators.length > 0 || userVariables.length > 0)) {
                    const yearSelect = document.getElementById('filterYear');
                    if (yearSelect.value) {
                        setTimeout(() => calculateDashboard(), 300);
                    }
                }
                
                console.log('‚úÖ P√°gina inicializada');
                
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al inicializar la p√°gina: ' + error.message, 'danger');
            }
        }
        
        function getCurrentUser() {
            try {
                const session = localStorage.getItem('nextSystemSession') || 
                               sessionStorage.getItem('nextSystemSession');
                if (session) {
                    const sessionData = JSON.parse(session);
                    currentUser = sessionData.user;
                    console.log('üë§ Usuario:', currentUser.user_display_name || currentUser.user_name);
                }
            } catch (error) {
                console.error('‚ùå Error obteniendo sesi√≥n:', error);
            }
        }
        
        // ==========================================
        // CARGAR A√ëOS Y MESES ACAD√âMICOS
        // ==========================================
        
        async function loadAcademicYears() {
            try {
                const systemConfig = await supabaseRequest('/system_config?select=current_academic_year_id&limit=1');
                const currentYearId = systemConfig && systemConfig.length > 0 ? systemConfig[0].current_academic_year_id : null;
                
                console.log('üìÖ A√±o acad√©mico vigente:', currentYearId);
                
                const years = await supabaseRequest('/academic_years?select=year_id,year_name&year_status=eq.active&order=year_order.desc');
                availableYears = years || [];
                
                const select = document.getElementById('filterYear');
                select.innerHTML = '<option value="">Seleccionar a√±o...</option>';
                
                availableYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.year_id;
                    option.textContent = year.year_name;
                    
                    if (currentYearId && year.year_id === currentYearId) {
                        option.selected = true;
                    }
                    
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ ${availableYears.length} a√±os acad√©micos cargados`);
        
            } catch (error) {
                console.error('‚ùå Error cargando a√±os:', error);
            }
        }
        
        function loadAcademicMonths() {
            try {
                const months = [
                    { month_number: 1, month_name: 'Enero' },
                    { month_number: 2, month_name: 'Febrero' },
                    { month_number: 3, month_name: 'Marzo' },
                    { month_number: 4, month_name: 'Abril' },
                    { month_number: 5, month_name: 'Mayo' },
                    { month_number: 6, month_name: 'Junio' },
                    { month_number: 7, month_name: 'Julio' },
                    { month_number: 8, month_name: 'Agosto' },
                    { month_number: 9, month_name: 'Septiembre' },
                    { month_number: 10, month_name: 'Octubre' },
                    { month_number: 11, month_name: 'Noviembre' },
                    { month_number: 12, month_name: 'Diciembre' }
                ];
                
                availableMonths = months;
                
                const select = document.getElementById('filterMonth');
                
                if (!select) {
                    console.error('‚ùå No se encontr√≥ el elemento filterMonth');
                    return;
                }
                
                select.innerHTML = '<option value="">Promedio anual</option>';
                
                availableMonths.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month.month_number;
                    option.textContent = month.month_name;
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ ${availableMonths.length} meses cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando meses:', error);
            }
        }
                
        // ==========================================
        // CARGAR INDICADORES Y VARIABLES DEL USUARIO
        // ==========================================
        
        async function loadUserIndicators() {
            try {
                const userConfig = await supabaseRequest(
                    `/user_dashboard_indicators?select=indicator_id,indicators!user_dashboard_indicators_indicator_id_fkey(*)&user_id=eq.${currentUser.user_id}&order=display_order`
                );
                
                if (!userConfig || userConfig.length === 0) {
                    userIndicators = [];
                    console.log('‚ÑπÔ∏è No hay indicadores configurados');
                    return;
                }
                
                userIndicators = userConfig.map(item => item.indicators);
                
                console.log(`‚úÖ ${userIndicators.length} indicadores configurados`);
                
                loadAcademicMonths();
                
            } catch (error) {
                console.error('‚ùå Error cargando indicadores del usuario:', error);
                showMessage('Error al cargar tus indicadores: ' + error.message, 'danger');
            }
        }
        
        async function loadUserVariables() {
            try {
                const userConfig = await supabaseRequest(
                    `/user_dashboard_variables?select=variable_id,variables!user_dashboard_variables_variable_id_fkey(*)&user_id=eq.${currentUser.user_id}&order=display_order`
                );
                
                if (!userConfig || userConfig.length === 0) {
                    userVariables = [];
                    console.log('‚ÑπÔ∏è No hay variables configuradas');
                    return;
                }
                
                userVariables = userConfig.map(item => item.variables);
                
                console.log(`‚úÖ ${userVariables.length} variables configuradas`);
                
            } catch (error) {
                console.error('‚ùå Error cargando variables del usuario:', error);
                showMessage('Error al cargar tus variables: ' + error.message, 'danger');
            }
        }
        
        function showEmptyDashboard() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-grid-3x3 text-muted"></i>
                    <h5>No tienes elementos configurados</h5>
                    <p class="text-muted">
                        Ve a "Configurar Mi Dashboard" para seleccionar los indicadores y variables que deseas visualizar
                    </p>
                    <a href="dashboard-config.html" class="btn btn-primary">
                        <i class="bi bi-gear me-1"></i>Configurar Dashboard
                    </a>
                </div>
            `;
        }
        
        // ==========================================
        // CALCULAR DASHBOARD COMPLETO
        // ==========================================
        
        async function calculateDashboard() {
            const yearId = document.getElementById('filterYear').value;
            const monthNumber = document.getElementById('filterMonth').value;
            
            if (!yearId) {
                showMessage('Selecciona un a√±o acad√©mico', 'warning');
                return;
            }
            
            if (userIndicators.length === 0 && userVariables.length === 0) {
                showEmptyDashboard();
                return;
            }
            
            mostrarLoading();
            calculatedIndicators = [];
            calculatedVariables = [];
            variablesCache = {}; // Limpiar cache
            
            try {
                updateCalculationProgress('Calculando indicadores y variables...');
                
                // Calcular indicadores y variables en paralelo
                const indicatorPromises = userIndicators.map(indicator => 
                    calculateSingleIndicator(indicator, yearId, monthNumber)
                );
                
                const variablePromises = userVariables.map(variable => 
                    calculateSingleVariable(variable, yearId, monthNumber)
                );
                
                calculatedIndicators = await Promise.all(indicatorPromises);
                calculatedVariables = await Promise.all(variablePromises);
                
                const calculatedCount = calculatedIndicators.filter(r => r.calculated).length + 
                                       calculatedVariables.filter(r => r.calculated).length;
                const totalCount = userIndicators.length + userVariables.length;
                
                console.log(`‚úÖ ${calculatedCount} de ${totalCount} elementos calculados`);
                
                renderResults();
                updateSummary();
                
            } catch (error) {
                console.error('‚ùå Error calculando dashboard:', error);
                showMessage('Error al calcular dashboard: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CALCULAR UN INDICADOR INDIVIDUAL
        // ==========================================
        
        async function calculateSingleIndicator(indicator, yearId, monthNumber) {
            try {
                const variablePattern = /VAR_[a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë_]+/gu;
                const variablesInFormula = indicator.formula_expression.match(variablePattern) || [];
                const uniqueVariables = [...new Set(variablesInFormula)];
                
                if (uniqueVariables.length === 0) {
                    return {
                        indicator: indicator,
                        calculated: false,
                        error: 'La f√≥rmula no contiene variables v√°lidas'
                    };
                }
                
                const variableValues = {};
                let allValuesFound = true;
                
                for (const varName of uniqueVariables) {
                    const value = await getVariableValue(varName, yearId, monthNumber);
                    
                    if (value === null) {
                        allValuesFound = false;
                        break;
                    }
                    
                    variableValues[varName] = value;
                }
                
                if (!allValuesFound) {
                    return {
                        indicator: indicator,
                        calculated: false,
                        error: 'Sin datos capturados para alguna variable'
                    };
                }
                
                let formulaWithValues = indicator.formula_expression;
                
                for (const [varName, value] of Object.entries(variableValues)) {
                    const regex = new RegExp(varName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                    formulaWithValues = formulaWithValues.replace(regex, value);
                }
                
                const safeFormula = formulaWithValues.replace(/\s+/g, '');
                if (!/^[0-9+\-*/().]+$/.test(safeFormula)) {
                    return {
                        indicator: indicator,
                        calculated: false,
                        error: 'F√≥rmula con caracteres no v√°lidos'
                    };
                }
                
                const result = eval(safeFormula);
                const goal = await getIndicatorGoal(indicator.indicator_id, yearId);
                
                return {
                    indicator: indicator,
                    calculated: true,
                    value: result,
                    goal: goal,
                    variableValues: variableValues
                };
                
            } catch (error) {
                console.error(`Error calculando indicador ${indicator.indicator_name}:`, error);
                return {
                    indicator: indicator,
                    calculated: false,
                    error: error.message
                };
            }
        }
        
        // ==========================================
        // CALCULAR UNA VARIABLE INDIVIDUAL
        // ==========================================
        
        async function calculateSingleVariable(variable, yearId, monthNumber) {
            try {
                const value = await getDirectVariableValue(variable.variable_id, variable.periodicity, yearId, monthNumber);
                
                if (value === null) {
                    return {
                        variable: variable,
                        calculated: false,
                        error: 'Sin datos capturados'
                    };
                }
                
                const goal = await getVariableGoal(variable.variable_id, yearId, monthNumber);
                
                return {
                    variable: variable,
                    calculated: true,
                    value: value,
                    goal: goal
                };
                
            } catch (error) {
                console.error(`Error calculando variable ${variable.variable_name}:`, error);
                return {
                    variable: variable,
                    calculated: false,
                    error: error.message
                };
            }
        }
        
        // ==========================================
        // OBTENER VALOR DE UNA VARIABLE (para indicadores)
        // ==========================================
        
        async function getVariableValue(variableName, yearId, monthNumber) {
            try {
                const cleanName = variableName.replace('VAR_', '').replace(/_/g, ' ');
                const cacheKey = `${cleanName}_${yearId}_${monthNumber || 'annual'}`;
                
                if (variablesCache[cacheKey] !== undefined) {
                    return variablesCache[cacheKey];
                }
                
                const variables = await supabaseRequest(`/variables?select=variable_id,periodicity&variable_name=eq.${cleanName}&variable_status=eq.active&limit=1`);
                        
                if (!variables || variables.length === 0) {
                    console.warn(`Variable no encontrada: ${variableName}`);
                    return null;
                }
                
                const variable = variables[0];
                
                let query = `/variable_values?select=value_numeric&variable_id=eq.${variable.variable_id}&academic_year_id=eq.${yearId}&value_status=eq.active`;
                
                if (variable.periodicity === 'monthly') {
                    if (monthNumber) {
                        query += `&month_number=eq.${monthNumber}`;
                    } else {
                        const values = await supabaseRequest(query);
                        if (!values || values.length === 0) return null;
                        
                        const sum = values.reduce((acc, v) => acc + (v.value_numeric || 0), 0);
                        const average = sum / values.length;
                        variablesCache[cacheKey] = average;
                        return average;
                    }
                }
                
                const values = await supabaseRequest(query + '&limit=1');
                
                if (!values || values.length === 0) {
                    variablesCache[cacheKey] = null;
                    return null;
                }
                
                const value = values[0].value_numeric;
                variablesCache[cacheKey] = value;
                return value;
                
            } catch (error) {
                console.error(`Error obteniendo valor de ${variableName}:`, error);
                variablesCache[cacheKey] = null;
                return null;
            }
        }
        
        // ==========================================
        // OBTENER VALOR DIRECTO DE VARIABLE
        // ==========================================
        
        async function getDirectVariableValue(variableId, periodicity, yearId, monthNumber) {
            try {
                const cacheKey = `direct_${variableId}_${yearId}_${monthNumber || 'annual'}`;
                
                if (variablesCache[cacheKey] !== undefined) {
                    return variablesCache[cacheKey];
                }
                
                let query = `/variable_values?select=value_numeric&variable_id=eq.${variableId}&academic_year_id=eq.${yearId}&value_status=eq.active`;
                
                if (periodicity === 'monthly') {
                    if (monthNumber) {
                        query += `&month_number=eq.${monthNumber}`;
                    } else {
                        const values = await supabaseRequest(query);
                        if (!values || values.length === 0) return null;
                        
                        const sum = values.reduce((acc, v) => acc + (v.value_numeric || 0), 0);
                        const average = sum / values.length;
                        variablesCache[cacheKey] = average;
                        return average;
                    }
                }
                
                const values = await supabaseRequest(query + '&limit=1');
                
                if (!values || values.length === 0) {
                    variablesCache[cacheKey] = null;
                    return null;
                }
                
                const value = values[0].value_numeric;
                variablesCache[cacheKey] = value;
                return value;
                
            } catch (error) {
                console.error(`Error obteniendo valor directo:`, error);
                return null;
            }
        }
        
        // ==========================================
        // OBTENER METAS
        // ==========================================
        
        async function getIndicatorGoal(indicatorId, yearId) {
            try {
                const goals = await supabaseRequest(`/indicator_goals?select=goal_value&indicator_id=eq.${indicatorId}&academic_year_id=eq.${yearId}&limit=1`);
                
                if (!goals || goals.length === 0) {
                    return null;
                }
                
                return goals[0].goal_value;
                
            } catch (error) {
                console.error('Error obteniendo meta de indicador:', error);
                return null;
            }
        }
        
        async function getVariableGoal(variableId, yearId, monthNumber) {
            try {
                let query = `/variable_goals?select=goal_value&variable_id=eq.${variableId}&academic_year_id=eq.${yearId}`;
                
                if (monthNumber) {
                    query += `&month_number=eq.${monthNumber}`;
                } else {
                    query += `&month_number=is.null`;
                }
                
                query += '&limit=1';
                
                const goals = await supabaseRequest(query);
                
                if (!goals || goals.length === 0) {
                    return null;
                }
                
                return goals[0].goal_value;
                
            } catch (error) {
                console.error('Error obteniendo meta de variable:', error);
                return null;
            }
        }
        
        // ==========================================
        // RENDERIZAR RESULTADOS
        // ==========================================
        
        function renderResults() {
            const container = document.getElementById('resultsContainer');
            
            const totalItems = calculatedIndicators.length + calculatedVariables.length;
            
            if (totalItems === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-calculator text-muted"></i>
                        <h5>Sin elementos configurados</h5>
                        <p class="text-muted">Configura tu dashboard para ver resultados</p>
                        <a href="dashboard-config.html" class="btn btn-primary">
                            <i class="bi bi-gear me-1"></i>Configurar Dashboard
                        </a>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // SECCI√ìN 1: INDICADORES CALCULADOS
            if (calculatedIndicators.length > 0) {
                html += `
                    <h2 class="section-title">
                        <i class="bi bi-speedometer2"></i>
                        Indicadores Calculados
                    </h2>
                    <div class="row">
                `;
                
                calculatedIndicators.forEach(result => {
                    html += renderIndicatorCard(result);
                });
                
                html += '</div>';
            }
            
            // SEPARADOR
            if (calculatedIndicators.length > 0 && calculatedVariables.length > 0) {
                html += '<div class="section-separator"></div>';
            }
            
            // SECCI√ìN 2: VARIABLES INDEPENDIENTES
            if (calculatedVariables.length > 0) {
                html += `
                    <h2 class="section-title">
                        <i class="bi bi-graph-up"></i>
                        Variables Independientes
                    </h2>
                    <div class="row">
                `;
                
                calculatedVariables.forEach(result => {
                    html += renderVariableCard(result);
                });
                
                html += '</div>';
            }
            
            container.innerHTML = html;
            
            document.getElementById('summarySection').style.display = 'flex';
            
            // Renderizar sparklines despu√©s de que el HTML se haya insertado
            setTimeout(() => {
                console.log('üé® Renderizando sparklines...');
                
                // Sparklines para indicadores
                calculatedIndicators.forEach(result => {
                    if (result.calculated) {
                        const canvasId = `sparkline_indicator_${result.indicator.indicator_id}`;
                        renderSparkline(
                            canvasId, 
                            result.indicator.indicator_id, 
                            'indicator', 
                            result.indicator.result_format
                        );
                    }
                });
                
                // Sparklines para variables
                calculatedVariables.forEach(result => {
                    if (result.calculated) {
                        const canvasId = `sparkline_variable_${result.variable.variable_id}`;
                        renderSparkline(
                            canvasId, 
                            result.variable.variable_id, 
                            'variable', 
                            result.variable.data_type
                        );
                    }
                });
                
                console.log('‚úÖ Sparklines renderizados');
            }, 200);
        }
        
        // ==========================================
        // RENDERIZAR TARJETA DE INDICADOR
        // ==========================================
        
        function renderIndicatorCard(result) {
            const indicator = result.indicator;
            
            if (!result.calculated) {
                return `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card dashboard-card no-data-card">
                            <div class="card-body">
                                <h6 class="indicator-name">${escapeHtml(indicator.indicator_name)}</h6>
                                <div class="text-center py-4">
                                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                                    <p class="text-muted mt-3 mb-0">
                                        <strong>Sin datos para calcular</strong><br>
                                        <small>${escapeHtml(result.error || 'Datos no disponibles')}</small>
                                    </p>
                                </div>
                                <div class="formula-text mt-3">
                                    ${escapeHtml(indicator.formula_expression)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const formattedValue = formatResult(result.value, indicator.result_format);
            
            let goalSection = '';
            if (result.goal !== null) {
                const difference = result.value - result.goal;
                const percentageDiff = (difference / result.goal * 100).toFixed(1);
                const isPositive = difference >= 0;
                const statusIcon = isPositive ? 
                    '<i class="bi bi-check-circle-fill text-success status-icon"></i>' : 
                    '<i class="bi bi-exclamation-circle-fill text-warning status-icon"></i>';
                
                goalSection = `
                    <div class="goal-comparison">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                ${statusIcon}
                            </div>
                            <div class="col">
                                <div class="goal-label">Meta del a√±o</div>
                                <div class="goal-value">${formatResult(result.goal, indicator.result_format)}</div>
                            </div>
                            <div class="col-auto">
                                <span class="difference-badge ${isPositive ? 'difference-positive' : 'difference-negative'}">
                                    ${isPositive ? '+' : ''}${percentageDiff}%
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <h6 class="indicator-name">${escapeHtml(indicator.indicator_name)}</h6>
                            
                            ${indicator.indicator_description ? 
                                `<p class="text-muted small mb-3">${escapeHtml(indicator.indicator_description)}</p>` : 
                                ''}
                            
                            <div class="text-center">
                                <div class="indicator-value" style="color: ${result.goal && result.value >= result.goal ? '#198754' : '#667eea'}">
                                    ${formattedValue}
                                </div>
                            </div>
                            
                            <!-- Sparkline -->
                            <div class="sparkline-container">
                                <canvas id="sparkline_indicator_${indicator.indicator_id}"></canvas>
                            </div>
                            
                            ${goalSection}
                            
                            <div class="formula-text mt-3">
                                ${escapeHtml(indicator.formula_expression)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // RENDERIZAR TARJETA DE VARIABLE
        // ==========================================
        
        function renderVariableCard(result) {
            const variable = result.variable;
            
            if (!result.calculated) {
                return `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card dashboard-card no-data-card">
                            <div class="card-body">
                                <h6 class="variable-name">${escapeHtml(variable.variable_name)}</h6>
                                <span class="periodicity-badge">
                                    ${variable.periodicity === 'annual' ? 'ANUAL' : 'MENSUAL'}
                                </span>
                                <div class="text-center py-4">
                                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                                    <p class="text-muted mt-3 mb-0">
                                        <strong>Sin datos capturados</strong><br>
                                        <small>${escapeHtml(result.error || 'Datos no disponibles')}</small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const formattedValue = formatResult(result.value, variable.data_type);
            
            let goalSection = '';
            if (result.goal !== null) {
                const difference = result.value - result.goal;
                const percentageDiff = (difference / result.goal * 100).toFixed(1);
                const isPositive = difference >= 0;
                const statusIcon = isPositive ? 
                    '<i class="bi bi-check-circle-fill text-success status-icon"></i>' : 
                    '<i class="bi bi-exclamation-circle-fill text-warning status-icon"></i>';
                
                goalSection = `
                    <div class="goal-comparison">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                ${statusIcon}
                            </div>
                            <div class="col">
                                <div class="goal-label">Meta</div>
                                <div class="goal-value">${formatResult(result.goal, variable.data_type)}</div>
                            </div>
                            <div class="col-auto">
                                <span class="difference-badge ${isPositive ? 'difference-positive' : 'difference-negative'}">
                                    ${isPositive ? '+' : ''}${percentageDiff}%
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="variable-name mb-0">${escapeHtml(variable.variable_name)}</h6>
                                <span class="periodicity-badge">
                                    ${variable.periodicity === 'annual' ? 'ANUAL' : 'MENSUAL'}
                                </span>
                            </div>
                            
                            ${variable.variable_description ? 
                                `<p class="text-muted small mb-3">${escapeHtml(variable.variable_description)}</p>` : 
                                ''}
                            
                            <div class="text-center">
                                <div class="variable-value" style="color: ${result.goal && result.value >= result.goal ? '#198754' : '#6c757d'}">
                                    ${formattedValue}
                                </div>
                            </div>
                            
                            <!-- Sparkline -->
                            <div class="sparkline-container">
                                <canvas id="sparkline_variable_${variable.variable_id}"></canvas>
                            </div>
                            
                            ${goalSection}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // ACTUALIZAR RESUMEN
        // ==========================================
        
        function updateSummary() {
            const totalIndicators = calculatedIndicators.length;
            const totalVariables = calculatedVariables.length;
            const calculatedItems = calculatedIndicators.filter(r => r.calculated).length + 
                                   calculatedVariables.filter(r => r.calculated).length;
            const noDataItems = (totalIndicators + totalVariables) - calculatedItems;
            
            const indicatorGoalsAchieved = calculatedIndicators.filter(r => 
                r.calculated && r.goal !== null && r.value >= r.goal
            ).length;
            
            const variableGoalsAchieved = calculatedVariables.filter(r => 
                r.calculated && r.goal !== null && r.value >= r.goal
            ).length;
            
            const totalGoalsAchieved = indicatorGoalsAchieved + variableGoalsAchieved;
            
            const indicatorGoalsTotal = calculatedIndicators.filter(r => 
                r.calculated && r.goal !== null
            ).length;
            
            const variableGoalsTotal = calculatedVariables.filter(r => 
                r.calculated && r.goal !== null
            ).length;
            
            const totalGoals = indicatorGoalsTotal + variableGoalsTotal;
            
            document.getElementById('totalIndicators').textContent = totalIndicators;
            document.getElementById('totalVariables').textContent = totalVariables;
            document.getElementById('calculatedItems').textContent = calculatedItems;
            document.getElementById('noDataItems').textContent = noDataItems;
            document.getElementById('goalsAchieved').textContent = totalGoalsAchieved;
            document.getElementById('goalsTotal').textContent = totalGoals;
        }
        
        // ==========================================
        // FORMATEAR RESULTADO
        // ==========================================
        
        function formatResult(value, format) {
            if (value === null || value === undefined) {
                return '-';
            }
            
            switch (format) {
                case 'percentage':
                    return value.toFixed(1) + '%';
                case 'integer':
                    return Math.round(value).toLocaleString('es-CO');
                case 'decimal':
                case 'numeric':
                default:
                    return value.toFixed(2).toLocaleString('es-CO');
            }
        }
        
        // ==========================================
        // GR√ÅFICOS Y SPARKLINES
        // ==========================================
        
        /**
         * Renderizar sparkline (mini gr√°fico) para un indicador o variable
         */
        async function renderSparkline(canvasId, itemId, itemType, format) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.warn('‚ö†Ô∏è Canvas no encontrado:', canvasId);
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            try {
                // Obtener datos hist√≥ricos seg√∫n el tipo
                let historicalValues = [];
                
                if (itemType === 'indicator') {
                    historicalValues = await getIndicatorHistoricalValues(itemId);
                } else if (itemType === 'variable') {
                    historicalValues = await getVariableHistoricalValues(itemId);
                }
                
                if (!historicalValues || historicalValues.length < 2) {
                    console.log('‚ÑπÔ∏è No hay suficientes datos hist√≥ricos para sparkline:', canvasId);
                    return;
                }
                
                // Preparar datos para el gr√°fico
                const labels = historicalValues.map(() => ''); // Labels vac√≠os para sparkline
                const values = historicalValues.map(v => v.value);
                
                // Destruir chart anterior si existe
                if (chartsInstances[canvasId]) {
                    chartsInstances[canvasId].destroy();
                }
                
                // Crear sparkline
                chartsInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        scales: {
                            x: { display: false },
                            y: {
                                beginAtZero: false,
                                display: false
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Sparkline renderizado:', canvasId);
                
            } catch (error) {
                console.error('‚ùå Error renderizando sparkline:', canvasId, error);
            }
        }
        
        /**
         * Obtener valores hist√≥ricos de un indicador (√∫ltimos 12 per√≠odos)
         */
        async function getIndicatorHistoricalValues(indicatorId) {
            try {
                const indicator = userIndicators.find(i => i.indicator_id === indicatorId);
                if (!indicator) return [];
                
                // Obtener a√±os disponibles
                const currentYear = parseInt(document.getElementById('filterYear').value) || new Date().getFullYear();
                const years = [];
                for (let i = 0; i < 3; i++) {
                    years.push(currentYear - i);
                }
                
                const values = [];
                
                for (const year of years) {
                    // Calcular para cada mes del a√±o
                    for (let month = 1; month <= 12; month++) {
                        try {
                            const result = await calculateIndicator(indicator, year, month);
                            if (result.calculated && result.value !== null) {
                                values.push({
                                    period: `${year}-${String(month).padStart(2, '0')}`,
                                    value: result.value
                                });
                            }
                        } catch (error) {
                            // Silenciosamente continuar si no hay datos
                        }
                    }
                }
                
                // Ordenar por per√≠odo y tomar √∫ltimos 12
                return values
                    .sort((a, b) => a.period.localeCompare(b.period))
                    .slice(-12);
                    
            } catch (error) {
                console.error('‚ùå Error obteniendo hist√≥rico de indicador:', error);
                return [];
            }
        }
        
        /**
         * Obtener valores hist√≥ricos de una variable (√∫ltimos 12 per√≠odos)
         */
        async function getVariableHistoricalValues(variableId) {
            try {
                const variable = userVariables.find(v => v.variable_id === variableId);
                if (!variable) return [];
                
                const currentYear = parseInt(document.getElementById('filterYear').value) || new Date().getFullYear();
                const years = [];
                for (let i = 0; i < 3; i++) {
                    years.push(currentYear - i);
                }
                
                const values = [];
                
                if (variable.periodicity === 'annual') {
                    // Variables anuales
                    for (const year of years) {
                        const value = await getDirectVariableValue(variableId, year, null);
                        if (value !== null) {
                            values.push({
                                period: String(year),
                                value: value
                            });
                        }
                    }
                } else {
                    // Variables mensuales
                    for (const year of years) {
                        for (let month = 1; month <= 12; month++) {
                            const value = await getDirectVariableValue(variableId, year, month);
                            if (value !== null) {
                                values.push({
                                    period: `${year}-${String(month).padStart(2, '0')}`,
                                    value: value
                                });
                            }
                        }
                    }
                }
                
                // Ordenar y tomar √∫ltimos 12
                return values
                    .sort((a, b) => a.period.localeCompare(b.period))
                    .slice(-12);
                    
            } catch (error) {
                console.error('‚ùå Error obteniendo hist√≥rico de variable:', error);
                return [];
            }
        }
        
        /**
         * Manejar cambio de tab para cargar tendencias
         */
        document.addEventListener('shown.bs.tab', function (event) {
            const targetId = event.target.getAttribute('data-bs-target');
            
            if (targetId === '#trends-pane') {
                loadTrendsData();
            }
        });
        
        /**
         * Cargar datos de tendencias
         */
        async function loadTrendsData() {
            const container = document.getElementById('trendsContainer');
            const emptyState = document.getElementById('emptyStateTrends');
            
            if (calculatedIndicators.length === 0 && calculatedVariables.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-3 text-muted">Cargando tendencias...</p></div>';
            emptyState.style.display = 'none';
            
            let hasData = false;
            let html = '';
            
            // Generar gr√°ficos de tendencias para indicadores
            for (const result of calculatedIndicators) {
                if (!result.calculated) continue;
                
                const historicalValues = await getIndicatorHistoricalValues(result.indicator.indicator_id);
                if (historicalValues.length < 3) continue;
                
                hasData = true;
                const chartId = 'trend_indicator_' + result.indicator.indicator_id;
                
                html += `
                    <div class="card mb-4">
                        <div class="card-body">
                            <h6 class="mb-3">${escapeHtml(result.indicator.indicator_name)}</h6>
                            <div style="position: relative; height: 300px;">
                                <canvas id="${chartId}"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                
                // Renderizar gr√°fico despu√©s de agregar al DOM
                setTimeout(() => {
                    renderTrendChart(chartId, historicalValues, result.indicator.result_format, result.indicator.indicator_name);
                }, 100);
            }
            
            // Generar gr√°ficos de tendencias para variables
            for (const result of calculatedVariables) {
                if (!result.calculated) continue;
                
                const historicalValues = await getVariableHistoricalValues(result.variable.variable_id);
                if (historicalValues.length < 3) continue;
                
                hasData = true;
                const chartId = 'trend_variable_' + result.variable.variable_id;
                
                html += `
                    <div class="card mb-4">
                        <div class="card-body">
                            <h6 class="mb-3">${escapeHtml(result.variable.variable_name)}</h6>
                            <div style="position: relative; height: 300px;">
                                <canvas id="${chartId}"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                
                // Renderizar gr√°fico despu√©s de agregar al DOM
                setTimeout(() => {
                    renderTrendChart(chartId, historicalValues, result.variable.data_type, result.variable.variable_name);
                }, 100);
            }
            
            if (hasData) {
                container.innerHTML = html;
            } else {
                container.innerHTML = '';
                emptyState.style.display = 'block';
            }
        }
        
        /**
         * Renderizar gr√°fico de tendencias
         */
        function renderTrendChart(chartId, historicalValues, format, label) {
            const canvas = document.getElementById(chartId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            const labels = historicalValues.map(v => v.period);
            const values = historicalValues.map(v => v.value);
            
            // Destruir chart anterior si existe
            if (chartsInstances[chartId]) {
                chartsInstances[chartId].destroy();
            }
            
            chartsInstances[chartId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatResult(context.parsed.y, format);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return formatResult(value, format);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        
        function updateCalculationProgress(message) {
            const progressElement = document.getElementById('calculationProgress');
            if (progressElement) {
                progressElement.textContent = message;
            }
        }
        
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // FUNCIONES GLOBALES
        // ==========================================
        
        window.calculateDashboard = calculateDashboard;
        
        console.log('üéâ Dashboard personalizado cargado correctamente');
    </script>
</body>
</html>
