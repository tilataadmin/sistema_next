<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Carga - SchoolNet</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
        }
        .loading-spinner {
            display: none;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .grade-excellent { background-color: #28a745; }
        .grade-good { background-color: #17a2b8; }
        .grade-regular { background-color: #ffc107; color: black; }
        .grade-poor { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3>Prueba de Carga - Sistema Académico</h3>
                        <p class="text-muted">Consultas interactivas con 3,637 registros - FILTROS CORREGIDOS</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-secondary" onclick="location.reload()">
                            Refrescar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas Rápidas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <h4 id="totalStudents">50</h4>
                        <p class="text-muted">Estudiantes</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <h4 id="totalSubjects">49</h4>
                        <p class="text-muted">Materias</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <h4 id="totalGrades">3,637</h4>
                        <p class="text-muted">Calificaciones</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <h4 id="avgGrade">3.75</h4>
                        <p class="text-muted">Promedio General</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Filtros -->
        <div class="filter-section">
            <div class="row">
                <div class="col-12 mb-3">
                    <h5>Filtros de Consulta</h5>
                </div>
            </div>
            
            <form id="filterForm">
                <div class="row">
                    <!-- Filtros de Estudiante -->
                    <div class="col-md-4">
                        <h6 class="text-primary">Estudiante</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Código Estudiante:</label>
                            <input type="text" class="form-control" id="studentCode" placeholder="EST0001">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Grado:</label>
                            <select class="form-select" id="gradeLevel">
                                <option value="">Todos los grados</option>
                                <option value="Preescolar">Preescolar</option>
                                <option value="Primero">Primero</option>
                                <option value="Segundo">Segundo</option>
                                <option value="Tercero">Tercero</option>
                                <option value="Quinto">Quinto</option>
                                <option value="Octavo">Octavo</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Sección:</label>
                            <select class="form-select" id="section">
                                <option value="">Todas las secciones</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                    </div>

                    <!-- Filtros de Materia -->
                    <div class="col-md-4">
                        <h6 class="text-success">Materia</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Departamento:</label>
                            <select class="form-select" id="department">
                                <option value="">Todos los departamentos</option>
                                <option value="Matemáticas">Matemáticas</option>
                                <option value="Ciencias">Ciencias</option>
                                <option value="Humanidades">Humanidades</option>
                                <option value="Idiomas">Idiomas</option>
                                <option value="Sociales">Sociales</option>
                                <option value="Deportes">Deportes</option>
                                <option value="Artes">Artes</option>
                                <option value="Tecnología">Tecnología</option>
                            </select>
                        </div>
                    </div>

                    <!-- Filtros de Calificación -->
                    <div class="col-md-4">
                        <h6 class="text-warning">Calificación</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Período Académico:</label>
                            <select class="form-select" id="academicPeriod">
                                <option value="">Todos los períodos</option>
                                <option value="P1">Período 1</option>
                                <option value="P2">Período 2</option>
                                <option value="P3">Período 3</option>
                                <option value="P4">Período 4</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Nota Mínima:</label>
                                <input type="number" class="form-control" id="minGrade" min="0" max="5" step="0.1" placeholder="0.0">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Nota Máxima:</label>
                                <input type="number" class="form-control" id="maxGrade" min="0" max="5" step="0.1" placeholder="5.0">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="button" class="btn btn-primary" onclick="executeQuery()">
                                    Consultar
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearFilters()">
                                    Limpiar
                                </button>
                                <button type="button" class="btn btn-info btn-sm ms-2" onclick="testPreescolar()">
                                    Test Preescolar
                                </button>
                                <button type="button" class="btn btn-info btn-sm ms-2" onclick="testOctavo()">
                                    Test Octavo
                                </button>
                            </div>
                            <div>
                                <label class="form-label me-2">Límite:</label>
                                <select class="form-select d-inline-block w-auto" id="limitRecords">
                                    <option value="100">100</option>
                                    <option value="500">500</option>
                                    <option value="1000">1,000</option>
                                    <option value="">Sin límite</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Indicador de Rendimiento -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Rendimiento:</strong>
                                <span id="queryTime">-</span>
                                <span class="text-muted ms-3">Registros:</span>
                                <span id="recordCount" class="fw-bold">-</span>
                            </div>
                            <div class="loading-spinner">
                                <div class="spinner-border spinner-border-sm text-primary"></div>
                                <span class="ms-2">Ejecutando consulta...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resultados -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Resultados de la Consulta</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>Código</th>
                                        <th>Estudiante</th>
                                        <th>Grado</th>
                                        <th>Materia</th>
                                        <th>Departamento</th>
                                        <th>Período</th>
                                        <th>Tipo</th>
                                        <th>Calificación</th>
                                        <th>Fecha</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsBody">
                                    <tr>
                                        <td colspan="9" class="text-center text-muted p-5">
                                            Seleccione los filtros y haga clic en "Consultar"
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        let currentData = [];

        // Ejecutar consulta principal - ESTRATEGIA CORREGIDA
        async function executeQuery() {
            const startTime = Date.now();
            
            try {
                document.querySelector('.loading-spinner').style.display = 'inline-block';
                document.getElementById('queryTime').textContent = 'Ejecutando...';
                
                console.log('=== INICIANDO CONSULTA ===');
                
                // Obtener filtros
                const gradeLevel = document.getElementById('gradeLevel').value;
                const section = document.getElementById('section').value;
                const studentCode = document.getElementById('studentCode').value.trim();
                const department = document.getElementById('department').value;
                const academicPeriod = document.getElementById('academicPeriod').value;
                const minGrade = document.getElementById('minGrade').value;
                const maxGrade = document.getElementById('maxGrade').value;
                const limit = document.getElementById('limitRecords').value;
                
                console.log('Filtros aplicados:', {
                    gradeLevel, section, studentCode, department, academicPeriod, minGrade, maxGrade, limit
                });
                
                // PASO 1: Si hay filtros de estudiante, obtener IDs específicos
                let studentIds = null;
                if (gradeLevel || section || studentCode) {
                    let studentQuery = '/test_students?select=student_id';
                    const studentFilters = [];
                    
                    if (gradeLevel) studentFilters.push(`grade_level=eq.${gradeLevel}`);
                    if (section) studentFilters.push(`section=eq.${section}`);
                    if (studentCode) studentFilters.push(`student_code=ilike.%${studentCode}%`);
                    
                    if (studentFilters.length > 0) {
                        studentQuery += '&' + studentFilters.join('&');
                    }
                    
                    console.log('Consulta de estudiantes:', studentQuery);
                    
                    const students = await supabaseRequest(studentQuery);
                    studentIds = students.map(s => s.student_id);
                    
                    console.log(`Estudiantes encontrados: ${studentIds.length}`);
                    
                    if (studentIds.length === 0) {
                        showNoResults();
                        return;
                    }
                }
                
                // PASO 2: Construir consulta principal
                let query = '/test_grades?select=grade_id,grade_value,grade_type,academic_period,grade_date,test_students(student_code,first_name,last_name,grade_level,section),test_subjects(subject_code,subject_name,department)';
                
                const filters = [];
                
                // Filtrar por estudiantes específicos si los tenemos
                if (studentIds && studentIds.length > 0) {
                    filters.push(`student_id=in.(${studentIds.join(',')})`);
                }
                
                // Otros filtros
                if (department) filters.push(`test_subjects.department=eq.${department}`);
                if (academicPeriod) filters.push(`academic_period=eq.${academicPeriod}`);
                if (minGrade) filters.push(`grade_value=gte.${minGrade}`);
                if (maxGrade) filters.push(`grade_value=lte.${maxGrade}`);
                
                if (filters.length > 0) {
                    query += '&' + filters.join('&');
                }
                
                query += '&order=grade_date.desc';
                
                if (limit) {
                    query += `&limit=${limit}`;
                }
                
                console.log('Consulta final:', query);
                
                // PASO 3: Ejecutar consulta
                const data = await supabaseRequest(query);
                currentData = data;
                
                const queryTime = Date.now() - startTime;
                
                // Verificar resultados
                const uniqueGrades = [...new Set(data.map(r => r.test_students.grade_level))];
                const uniqueStudents = [...new Set(data.map(r => r.test_students.student_code))];
                
                console.log('Resultados:', {
                    total: data.length,
                    grados: uniqueGrades,
                    estudiantes: uniqueStudents.length
                });
                
                // Actualizar interfaz
                document.querySelector('.loading-spinner').style.display = 'none';
                document.getElementById('queryTime').textContent = `${queryTime}ms`;
                document.getElementById('recordCount').textContent = data.length.toLocaleString();
                
                displayResults(data);
                
                showAlert(`Consulta ejecutada: ${data.length} registros, ${uniqueStudents.length} estudiantes, Grados: ${uniqueGrades.join(', ')}`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                document.querySelector('.loading-spinner').style.display = 'none';
                document.getElementById('queryTime').textContent = 'Error';
                showAlert('Error ejecutando consulta: ' + error.message, 'danger');
            }
        }

        function showNoResults() {
            const queryTime = Date.now() - performance.now();
            document.querySelector('.loading-spinner').style.display = 'none';
            document.getElementById('queryTime').textContent = `${Math.round(queryTime)}ms`;
            document.getElementById('recordCount').textContent = '0';
            
            document.getElementById('resultsBody').innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted p-5">
                        No se encontraron resultados con los filtros especificados
                    </td>
                </tr>
            `;
            
            showAlert('No se encontraron estudiantes con esos filtros', 'info');
        }

        function displayResults(data) {
            const tbody = document.getElementById('resultsBody');
            
            if (data.length === 0) {
                showNoResults();
                return;
            }
            
            tbody.innerHTML = data.map(record => {
                const student = record.test_students;
                const subject = record.test_subjects;
                const gradeClass = getGradeClass(record.grade_value);
                
                return `
                    <tr>
                        <td><code>${student.student_code}</code></td>
                        <td>${student.first_name} ${student.last_name}</td>
                        <td><span class="badge bg-secondary">${student.grade_level} - ${student.section}</span></td>
                        <td>${subject.subject_code} - ${subject.subject_name}</td>
                        <td><span class="badge bg-info">${subject.department}</span></td>
                        <td><span class="badge bg-warning text-dark">${record.academic_period}</span></td>
                        <td><span class="badge bg-light text-dark">${record.grade_type}</span></td>
                        <td><span class="badge ${gradeClass}">${record.grade_value}</span></td>
                        <td>${formatDate(record.grade_date)}</td>
                    </tr>
                `;
            }).join('');
        }

        function getGradeClass(grade) {
            if (grade >= 4.5) return 'grade-excellent';
            if (grade >= 3.5) return 'grade-good';
            if (grade >= 2.5) return 'grade-regular';
            return 'grade-poor';
        }

        function clearFilters() {
            document.getElementById('filterForm').reset();
            document.getElementById('resultsBody').innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted p-5">
                        Seleccione los filtros y haga clic en "Consultar"
                    </td>
                </tr>
            `;
            document.getElementById('queryTime').textContent = '-';
            document.getElementById('recordCount').textContent = '-';
        }

        // Funciones de prueba rápida
        async function testPreescolar() {
            document.getElementById('gradeLevel').value = 'Preescolar';
            executeQuery();
        }

        async function testOctavo() {
            document.getElementById('gradeLevel').value = 'Octavo';
            executeQuery();
        }

        function showAlert(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
        }
    </script>
</body>
</html>
