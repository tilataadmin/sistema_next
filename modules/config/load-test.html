<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Carga - SchoolNet</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
        }
        .loading-spinner {
            display: none;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .performance-indicator {
            font-size: 0.9em;
            margin-top: 10px;
        }
        .grade-badge {
            font-weight: bold;
        }
        .grade-excellent { background-color: #28a745; }
        .grade-good { background-color: #17a2b8; }
        .grade-regular { background-color: #ffc107; color: black; }
        .grade-poor { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3><i class="bi bi-speedometer2"></i> Prueba de Carga - Sistema Académico</h3>
                        <p class="text-muted">Consultas interactivas con 4,120+ registros</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-secondary" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise"></i> Refrescar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas Rápidas -->
        <div class="row mb-4" id="statsContainer">
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <i class="bi bi-person-fill text-primary" style="font-size: 2rem;"></i>
                        <h4 id="totalStudents">-</h4>
                        <p class="text-muted">Estudiantes</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <i class="bi bi-book-fill text-success" style="font-size: 2rem;"></i>
                        <h4 id="totalSubjects">-</h4>
                        <p class="text-muted">Materias</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <i class="bi bi-clipboard-data-fill text-warning" style="font-size: 2rem;"></i>
                        <h4 id="totalGrades">-</h4>
                        <p class="text-muted">Calificaciones</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <i class="bi bi-graph-up text-info" style="font-size: 2rem;"></i>
                        <h4 id="avgGrade">-</h4>
                        <p class="text-muted">Promedio General</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Filtros -->
        <div class="filter-section">
            <div class="row">
                <div class="col-12 mb-3">
                    <h5><i class="bi bi-funnel"></i> Filtros de Consulta</h5>
                </div>
            </div>
            
            <form id="filterForm">
                <div class="row">
                    <!-- Filtros de Estudiante -->
                    <div class="col-md-4">
                        <h6 class="text-primary">Estudiante</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Código Estudiante:</label>
                            <input type="text" class="form-control" id="studentCode" placeholder="EST0001">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Grado:</label>
                            <select class="form-select" id="gradeLevel">
                                <option value="">Todos los grados</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Sección:</label>
                            <select class="form-select" id="section">
                                <option value="">Todas las secciones</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Estado:</label>
                            <select class="form-select" id="studentStatus">
                                <option value="">Todos los estados</option>
                                <option value="active">Activo</option>
                                <option value="inactive">Inactivo</option>
                                <option value="graduated">Graduado</option>
                                <option value="transferred">Transferido</option>
                            </select>
                        </div>
                    </div>

                    <!-- Filtros de Materia -->
                    <div class="col-md-4">
                        <h6 class="text-success">Materia</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Materia:</label>
                            <select class="form-select" id="subjectId">
                                <option value="">Todas las materias</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Departamento:</label>
                            <select class="form-select" id="department">
                                <option value="">Todos los departamentos</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Tipo de Materia:</label>
                            <select class="form-select" id="isCore">
                                <option value="">Todas</option>
                                <option value="true">Principal</option>
                                <option value="false">Electiva</option>
                            </select>
                        </div>
                    </div>

                    <!-- Filtros de Calificación -->
                    <div class="col-md-4">
                        <h6 class="text-warning">Calificación</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Período Académico:</label>
                            <select class="form-select" id="academicPeriod">
                                <option value="">Todos los períodos</option>
                                <option value="P1">Período 1</option>
                                <option value="P2">Período 2</option>
                                <option value="P3">Período 3</option>
                                <option value="P4">Período 4</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Tipo de Evaluación:</label>
                            <select class="form-select" id="gradeType">
                                <option value="">Todos los tipos</option>
                                <option value="Parcial">Parcial</option>
                                <option value="Quiz">Quiz</option>
                                <option value="Tarea">Tarea</option>
                                <option value="Examen">Examen</option>
                                <option value="Proyecto">Proyecto</option>
                                <option value="Participación">Participación</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Nota Mínima:</label>
                                <input type="number" class="form-control" id="minGrade" min="0" max="5" step="0.1" placeholder="0.0">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Nota Máxima:</label>
                                <input type="number" class="form-control" id="maxGrade" min="0" max="5" step="0.1" placeholder="5.0">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="button" class="btn btn-primary" onclick="executeQuery()">
                                    <i class="bi bi-search"></i> Consultar
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearFilters()">
                                    <i class="bi bi-x-circle"></i> Limpiar
                                </button>
                            </div>
                            <div>
                                <label class="form-label me-2">Límite de registros:</label>
                                <select class="form-select d-inline-block w-auto" id="limitRecords">
                                    <option value="100">100</option>
                                    <option value="500">500</option>
                                    <option value="1000">1,000</option>
                                    <option value="2000">2,000</option>
                                    <option value="5000">5,000</option>
                                    <option value="">Sin límite</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Indicador de Rendimiento -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Rendimiento:</strong>
                                <span id="queryTime">-</span>
                                <span class="text-muted ms-3">Registros encontrados:</span>
                                <span id="recordCount" class="fw-bold">-</span>
                            </div>
                            <div class="loading-spinner">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <span class="ms-2">Ejecutando consulta...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resultados -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Resultados de la Consulta</h5>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="exportToCSV()">
                                <i class="bi bi-download"></i> Exportar CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container">
                            <table class="table table-striped table-hover mb-0" id="resultsTable">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>Código</th>
                                        <th>Estudiante</th>
                                        <th>Grado</th>
                                        <th>Materia</th>
                                        <th>Departamento</th>
                                        <th>Período</th>
                                        <th>Tipo</th>
                                        <th>Calificación</th>
                                        <th>Fecha</th>
                                        <th>Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsBody">
                                    <tr>
                                        <td colspan="10" class="text-center text-muted p-5">
                                            <i class="bi bi-search" style="font-size: 2rem;"></i><br>
                                            Seleccione los filtros y haga clic en "Consultar" para ver los resultados
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alertas -->
        <div id="alertContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- Config JS -->
    <script src="../../assets/js/config.js"></script>

    <script>
        let currentData = [];

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            initializePage('config', 'Prueba de Carga');
            loadInitialData();
        });

        // Cargar datos iniciales para los filtros
        async function loadInitialData() {
            try {
                await loadGeneralStats();
                await loadFilterOptions();
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
                showAlert('Error cargando datos iniciales', 'danger');
            }
        }

        // Cargar estadísticas generales
        async function loadGeneralStats() {
            try {
                const students = await supabaseRequest('/test_students?select=count');
                const subjects = await supabaseRequest('/test_subjects?select=count');
                const grades = await supabaseRequest('/test_grades?select=count');
                const avgGrade = await supabaseRequest('/test_grades?select=grade_value');

                document.getElementById('totalStudents').textContent = students.length || '-';
                document.getElementById('totalSubjects').textContent = subjects.length || '-';
                document.getElementById('totalGrades').textContent = grades.length.toLocaleString() || '-';
                
                if (avgGrade.length > 0) {
                    const avg = avgGrade.reduce((sum, item) => sum + item.grade_value, 0) / avgGrade.length;
                    document.getElementById('avgGrade').textContent = avg.toFixed(2);
                }
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }

        // Cargar opciones para filtros
        async function loadFilterOptions() {
            try {
                // Cargar grados únicos
                const students = await supabaseRequest('/test_students?select=grade_level');
                const uniqueGrades = [...new Set(students.map(s => s.grade_level))];
                const gradeLevelSelect = document.getElementById('gradeLevel');
                uniqueGrades.sort().forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade;
                    option.textContent = grade;
                    gradeLevelSelect.appendChild(option);
                });

                // Cargar materias
                const subjects = await supabaseRequest('/test_subjects?select=subject_id,subject_name,subject_code&order=subject_name.asc');
                const subjectSelect = document.getElementById('subjectId');
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.subject_id;
                    option.textContent = `${subject.subject_code} - ${subject.subject_name}`;
                    subjectSelect.appendChild(option);
                });

                // Cargar departamentos únicos
                const subjectsForDept = await supabaseRequest('/test_subjects?select=department');
                const uniqueDepartments = [...new Set(subjectsForDept.map(s => s.department))];
                const departmentSelect = document.getElementById('department');
                uniqueDepartments.sort().forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    departmentSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Error cargando opciones de filtros:', error);
            }
        }

        // Ejecutar consulta principal
        async function executeQuery() {
            const startTime = Date.now();
            
            try {
                document.querySelector('.loading-spinner').style.display = 'inline-block';
                document.getElementById('queryTime').textContent = 'Ejecutando...';
                
                let query = '/test_grades?select=grade_id,grade_value,grade_type,academic_period,grade_date,teacher_observations,test_students(student_code,first_name,last_name,grade_level,section),test_subjects(subject_code,subject_name,department,is_core)';
                
                const filters = buildFilters();
                if (filters.length > 0) {
                    query += '&' + filters.join('&');
                }
                
                query += '&order=grade_date.desc';
                
                const limit = document.getElementById('limitRecords').value;
                if (limit && limit !== '') {
                    query += `&limit=${limit}`;
                }
                
                console.log('🔍 Consulta construida:', query);
                
                const data = await supabaseRequest(query);
                currentData = data;
                
                const queryTime = Date.now() - startTime;
                
                document.querySelector('.loading-spinner').style.display = 'none';
                document.getElementById('queryTime').textContent = `${queryTime}ms`;
                document.getElementById('recordCount').textContent = data.length.toLocaleString();
                
                displayResults(data);
                
                showAlert(`Consulta ejecutada en ${queryTime}ms - ${data.length} registros encontrados`, 'success');
                
            } catch (error) {
                console.error('Error ejecutando consulta:', error);
                document.querySelector('.loading-spinner').style.display = 'none';
                document.getElementById('queryTime').textContent = 'Error';
                showAlert('Error ejecutando la consulta: ' + error.message, 'danger');
            }
        }

        // Construir filtros para la consulta
        function buildFilters() {
            const filters = [];
            
            const studentCode = document.getElementById('studentCode').value.trim();
            if (studentCode) {
                filters.push(`test_students.student_code.ilike.%${studentCode}%`);
            }
            
            const gradeLevel = document.getElementById('gradeLevel').value;
            if (gradeLevel) {
                filters.push(`test_students.grade_level.eq.${gradeLevel}`);
            }
            
            const section = document.getElementById('section').value;
            if (section) {
                filters.push(`test_students.section.eq.${section}`);
            }
            
            const studentStatus = document.getElementById('studentStatus').value;
            if (studentStatus) {
                filters.push(`test_students.student_status.eq.${studentStatus}`);
            }
            
            const subjectId = document.getElementById('subjectId').value;
            if (subjectId) {
                filters.push(`subject_id.eq.${subjectId}`);
            }
            
            const department = document.getElementById('department').value;
            if (department) {
                filters.push(`test_subjects.department.eq.${department}`);
            }
            
            const isCore = document.getElementById('isCore').value;
            if (isCore !== '') {
                filters.push(`test_subjects.is_core.eq.${isCore}`);
            }
            
            const academicPeriod = document.getElementById('academicPeriod').value;
            if (academicPeriod) {
                filters.push(`academic_period.eq.${academicPeriod}`);
            }
            
            const gradeType = document.getElementById('gradeType').value;
            if (gradeType) {
                filters.push(`grade_type.eq.${gradeType}`);
            }
            
            const minGrade = document.getElementById('minGrade').value;
            if (minGrade) {
                filters.push(`grade_value.gte.${minGrade}`);
            }
            
            const maxGrade = document.getElementById('maxGrade').value;
            if (maxGrade) {
                filters.push(`grade_value.lte.${maxGrade}`);
            }
            
            console.log('🔧 Filtros construidos:', filters);
            return filters;
        }

        // Mostrar resultados en la tabla
        function displayResults(data) {
            const tbody = document.getElementById('resultsBody');
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-muted p-5">
                            <i class="bi bi-inbox" style="font-size: 2rem;"></i><br>
                            No se encontraron resultados con los filtros especificados
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.map(record => {
                const student = record.test_students;
                const subject = record.test_subjects;
                const gradeClass = getGradeClass(record.grade_value);
                
                return `
                    <tr>
                        <td><code>${student.student_code}</code></td>
                        <td>${student.first_name} ${student.last_name}</td>
                        <td><span class="badge bg-secondary">${student.grade_level} - ${student.section}</span></td>
                        <td>${subject.subject_code} - ${subject.subject_name}</td>
                        <td><span class="badge bg-info">${subject.department}</span></td>
                        <td><span class="badge bg-warning text-dark">${record.academic_period}</span></td>
                        <td><span class="badge bg-light text-dark">${record.grade_type}</span></td>
                        <td><span class="badge ${gradeClass}">${record.grade_value}</span></td>
                        <td>${formatDate(record.grade_date)}</td>
                        <td class="text-truncate" style="max-width: 200px;" title="${record.teacher_observations || ''}">
                            ${record.teacher_observations || '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Obtener clase CSS para calificación
        function getGradeClass(grade) {
            if (grade >= 4.5) return 'badge grade-excellent';
            if (grade >= 3.5) return 'badge grade-good';
            if (grade >= 2.5) return 'badge grade-regular';
            return 'badge grade-poor';
        }

        // Limpiar filtros
        function clearFilters() {
            document.getElementById('filterForm').reset();
            document.getElementById('resultsBody').innerHTML = `
                <tr>
                    <td colspan="10" class="text-center text-muted p-5">
                        <i class="bi bi-search" style="font-size: 2rem;"></i><br>
                        Seleccione los filtros y haga clic en "Consultar" para ver los resultados
                    </td>
                </tr>
            `;
            document.getElementById('queryTime').textContent = '-';
            document.getElementById('recordCount').textContent = '-';
        }

        // Exportar a CSV
        function exportToCSV() {
            if (currentData.length === 0) {
                showAlert('No hay datos para exportar', 'warning');
                return;
            }
            
            const headers = ['Código', 'Estudiante', 'Grado', 'Sección', 'Materia', 'Departamento', 'Período', 'Tipo', 'Calificación', 'Fecha', 'Observaciones'];
            const csvContent = [
                headers.join(','),
                ...currentData.map(record => {
                    const student = record.test_students;
                    const subject = record.test_subjects;
                    return [
                        student.student_code,
                        `"${student.first_name} ${student.last_name}"`,
                        student.grade_level,
                        student.section,
                        `"${subject.subject_code} - ${subject.subject_name}"`,
                        subject.department,
                        record.academic_period,
                        record.grade_type,
                        record.grade_value,
                        record.grade_date,
                        `"${record.teacher_observations || ''}"`
                    ].join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `consulta_academica_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showAlert('Archivo CSV descargado exitosamente', 'success');
        }

        // Mostrar alertas
        function showAlert(message, type = 'info') {
            const alertId = 'alert_' + Date.now();
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="${alertId}">
                    ${message}
                    <button type="button" class="btn-close" onclick="closeAlert('${alertId}')"></button>
                </div>
            `;
            
            document.getElementById('alertContainer').innerHTML = alertHtml;
            
            setTimeout(() => closeAlert(alertId), 5000);
        }

        function closeAlert(alertId) {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }
        }
    </script>
</body>
</html>
