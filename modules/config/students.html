<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Estudiantes - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .student-name {
            font-weight: 600;
            color: #0d6efd;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #0d6efd, #0056b3);
            color: white;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .table-actions {
            white-space: nowrap;
            width: 120px;
        }
        
        .required {
            color: #dc3545;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Configuración</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gestionar Estudiantes
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE PÁGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-people me-2"></i>
                    Gestionar Estudiantes
                </h1>
                <p class="text-muted">
                    Administrar información de estudiantes del sistema
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- Estadísticas -->
        <div class="row">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <span id="totalStudents" class="stats-number">0</span>
                        <span>estudiantes registrados</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Búsqueda y controles -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label for="searchInput" class="form-label">Buscar estudiante</label>
                        <input type="text" id="searchInput" class="form-control" 
                               placeholder="Busque por nombre o apellido...">
                    </div>
                    <div class="col-md-3">
                        <button id="btnNewStudent" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>Nuevo Estudiante
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button id="btnRefresh" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de estudiantes -->
        <div class="card mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Código</th>
                                <th>Estudiante</th>
                                <th>Familia</th>
                                <th>Curso</th>
                                <th>Estado</th>
                                <th class="table-actions">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <!-- Contenido dinámico -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Paginación -->
        <div class="d-flex justify-content-center align-items-center mb-4">
            <nav aria-label="Paginación de estudiantes">
                <ul class="pagination">
                    <li class="page-item" id="prevPageItem">
                        <button class="page-link" id="btnPrevPage">
                            <i class="bi bi-chevron-left"></i> Anterior
                        </button>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link" id="pageInfo">Página 1 de 1</span>
                    </li>
                    <li class="page-item" id="nextPageItem">
                        <button class="page-link" id="btnNextPage">
                            Siguiente <i class="bi bi-chevron-right"></i>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>

    </div>
    <!-- Modal para crear/editar estudiante -->
    <div class="modal fade" id="studentModal" tabindex="-1" aria-labelledby="studentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentModalLabel">Nuevo Estudiante</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="studentForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <!-- Código del estudiante -->
                            <div class="col-md-6">
                                <label for="studentCode" class="form-label">
                                    Código <span class="required">*</span>
                                </label>
                                <input type="number" class="form-control" id="studentCode" 
                                       name="student_code" required>
                            </div>
                            
                            <!-- Familia -->
                            <div class="col-md-6">
                                <label for="familyCode" class="form-label">
                                    Familia <span class="required">*</span>
                                </label>
                                <select class="form-select" id="familyCode" name="family_id" required>
                                    <option value="">Seleccione una familia...</option>
                                </select>
                            </div>
                            
                            <!-- Nombres -->
                            <div class="col-md-6">
                                <label for="firstName" class="form-label">
                                    Nombres <span class="required">*</span>
                                </label>
                                <input type="text" class="form-control" id="firstName" 
                                       name="student_first_name" required maxlength="100">
                            </div>
                            
                            <!-- Primer apellido -->
                            <div class="col-md-6">
                                <label for="lastName1" class="form-label">
                                    Primer apellido <span class="required">*</span>
                                </label>
                                <input type="text" class="form-control" id="lastName1" 
                                       name="student_last_name_1" required maxlength="100">
                            </div>
                            
                            <!-- Segundo apellido -->
                            <div class="col-md-6">
                                <label for="lastName2" class="form-label">Segundo apellido</label>
                                <input type="text" class="form-control" id="lastName2" 
                                       name="student_last_name_2" maxlength="100">
                            </div>
                            
                            <!-- Género -->
                            <div class="col-md-6">
                                <label for="gender" class="form-label">
                                    Género <span class="required">*</span>
                                </label>
                                <select class="form-select" id="gender" name="gender_id" required>
                                    <option value="">Seleccione un género...</option>
                                </select>
                            </div>
                            
                            <!-- Fecha de nacimiento -->
                            <div class="col-md-6">
                                <label for="birthDate" class="form-label">
                                    Fecha de nacimiento <span class="required">*</span>
                                </label>
                                <input type="date" class="form-control" id="birthDate" 
                                       name="student_birthday" required>
                            </div>
                            
                            <!-- Fecha de ingreso -->
                            <div class="col-md-6">
                                <label for="entryDate" class="form-label">
                                    Fecha de ingreso <span class="required">*</span>
                                </label>
                                <input type="date" class="form-control" id="entryDate" 
                                       name="student_entry_date" required>
                            </div>
                            
                            <!-- Curso -->
                            <div class="col-md-6">
                                <label for="courseId" class="form-label">
                                    Curso <span class="required">*</span>
                                </label>
                                <select class="form-select" id="courseId" name="course_id" required>
                                    <option value="">Seleccione un curso...</option>
                                </select>
                            </div>
                            
                            <!-- Estado -->
                            <div class="col-md-6">
                                <label for="statusId" class="form-label">
                                    Estado <span class="required">*</span>
                                </label>
                                <select class="form-select" id="statusId" name="status_id" required>
                                    <option value="">Seleccione un estado...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btnSaveStudent">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- SCRIPTS - ORDEN CRÍTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentPage = 1;
        let totalPages = 1;
        let totalStudents = 0;
        let students = [];
        let families = [];
        let courses = [];
        let statuses = [];
        let genders = [];
        let isEditing = false;
        let currentStudentId = null;
        let searchTimeout = null;
        let modalInstance = null;
        
        // ==========================================
        // INICIALIZACIÓN - PATRÓN OBLIGATORIO
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                // PASO 1: SIEMPRE validar permisos primero
                const hasAccess = await validatePageAccess('Gestionar estudiantes');
                if (!hasAccess) {
                    console.log('❌ Acceso denegado - deteniendo inicialización');
                    return;
                }
                
                console.log('✅ Acceso permitido - continuando con inicialización');
                
                // PASO 2: Inicializar página
                await inicializarPagina();
                
            } catch (error) {
                console.error('❌ Error en validación de acceso:', error);
                showAlert('Error de validación de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCIÓN DE INICIALIZACIÓN
        // ==========================================
        
        async function inicializarPagina() {
            try {
                showLoading();
                
                console.log('🎓 Gestionar Estudiantes - Inicializando...');
                
                // Inicializar modal
                modalInstance = new bootstrap.Modal(document.getElementById('studentModal'));
                
                // Cargar datos iniciales
                await loadDropdownData();
                
                // Configurar eventos
                setupEventListeners();
                
                // Cargar estudiantes
                await loadStudents();
                
                hideLoading();
                console.log('✅ Página inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                showAlert('Error al cargar la página: ' + error.message, 'danger');
                hideLoading();
            }
        }
        
        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        
        async function loadDropdownData() {
            try {
                const [familiesData, coursesData, statusesData, gendersData] = await Promise.all([
                    supabaseRequest('/families?select=family_code,family_name&order=family_name.asc'),
                    supabaseRequest('/courses?select=course_id,course_name,course_order&course_status=eq.active&order=course_order.asc'),
                    supabaseRequest('/student_status?select=status_id,status_description&order=status_description.asc'),
                    supabaseRequest('/genders?select=gender_id,gender_name&order=gender_name.asc')
                ]);
                
                families = familiesData || [];
                courses = coursesData || [];
                statuses = statusesData || [];
                genders = gendersData || [];
                
                populateDropdowns();
                
                console.log('✅ Datos de dropdowns cargados');
                
            } catch (error) {
                console.error('❌ Error cargando datos de dropdowns:', error);
                throw error;
            }
        }
        
        function populateDropdowns() {
            // Families
            const familySelect = document.getElementById('familyCode');
            familySelect.innerHTML = '<option value="">Seleccione una familia...</option>';
            families.forEach(family => {
                familySelect.innerHTML += `<option value="${family.family_code}">${family.family_name}</option>`;
            });
            
            // Courses
            const courseSelect = document.getElementById('courseId');
            courseSelect.innerHTML = '<option value="">Seleccione un curso...</option>';
            courses.forEach(course => {
                courseSelect.innerHTML += `<option value="${course.course_id}">${course.course_name}</option>`;
            });
            
            // Statuses
            const statusSelect = document.getElementById('statusId');
            statusSelect.innerHTML = '<option value="">Seleccione un estado...</option>';
            statuses.forEach(status => {
                statusSelect.innerHTML += `<option value="${status.status_id}">${status.status_description}</option>`;
            });
            
            // Genders
            const genderSelect = document.getElementById('gender');
            genderSelect.innerHTML = '<option value="">Seleccione un género...</option>';
            genders.forEach(gender => {
                genderSelect.innerHTML += `<option value="${gender.gender_id}">${gender.gender_name}</option>`;
            });
        }
        async function loadStudents(search = '', page = 1) {
            try {
                showLoading();
                
                let query = '/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2,family_id,course_id,status_id';
                
                if (search.trim()) {
                    query += `&or=(student_first_name.ilike.*${search}*,student_last_name_1.ilike.*${search}*,student_last_name_2.ilike.*${search}*)`;
                }
                
                const limit = 30;
                const offset = (page - 1) * limit;
                query += `&limit=${limit}&offset=${offset}&order=student_last_name_1.asc,student_first_name.asc`;
                
                const studentsData = await supabaseRequest(query);
                
                if (studentsData && studentsData.length > 0) {
                    const [familiesData, coursesData, statusesData] = await Promise.all([
                        supabaseRequest('/families?select=family_code,family_name'),
                        supabaseRequest('/courses?select=course_id,course_name,course_order'),
                        supabaseRequest('/student_status?select=status_id,status_description')
                    ]);
                    
                    const familiesMap = {};
                    const coursesMap = {};
                    const statusesMap = {};
                    
                    if (familiesData) familiesData.forEach(f => familiesMap[f.family_code] = f);
                    if (coursesData) coursesData.forEach(c => coursesMap[c.course_id] = c);
                    if (statusesData) statusesData.forEach(s => statusesMap[s.status_id] = s);
                    
                    students = studentsData.map(student => ({
                        ...student,
                        families: familiesMap[student.family_id] || null,
                        courses: coursesMap[student.course_id] || null,
                        student_status: statusesMap[student.status_id] || null
                    }));
                } else {
                    students = [];
                }
                
                let countQuery = '/students?select=student_id';
                if (search.trim()) {
                    countQuery += `&or=(student_first_name.ilike.*${search}*,student_last_name_1.ilike.*${search}*,student_last_name_2.ilike.*${search}*)`;
                }
                const countData = await supabaseRequest(countQuery);
                totalStudents = countData ? countData.length : 0;
                totalPages = Math.ceil(totalStudents / limit);
                currentPage = page;
                
                renderStudents();
                updatePagination();
                updateStats();
                
                hideLoading();
                
            } catch (error) {
                console.error('❌ Error cargando estudiantes:', error);
                showAlert('Error al cargar estudiantes: ' + error.message, 'danger');
                hideLoading();
            }
        }
        
        // ==========================================
        // RENDERIZADO
        // ==========================================
        
        function renderStudents() {
            const tbody = document.getElementById('studentsTableBody');
            
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="text-muted">
                                <i class="bi bi-people" style="font-size: 3rem; opacity: 0.3;"></i>
                                <h5 class="mt-3">No se encontraron estudiantes</h5>
                                <p>No hay estudiantes que coincidan con su búsqueda.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = students.map(student => {
                const fullName = `${student.student_last_name_1} ${student.student_last_name_2 || ''} ${student.student_first_name}`.trim();
                const familyName = student.families ? student.families.family_name : 'Sin familia';
                const courseName = student.courses ? student.courses.course_name : 'Sin curso';
                const statusName = student.student_status ? student.student_status.status_description : 'Sin estado';
                
                return `
                    <tr>
                        <td><strong>${student.student_code}</strong></td>
                        <td class="student-name">${fullName}</td>
                        <td>${familyName}</td>
                        <td>${courseName}</td>
                        <td>${statusName}</td>
                        <td class="table-actions">
                            <button class="btn btn-sm btn-outline-primary me-1" 
                                    onclick="editStudent('${student.student_id}')" 
                                    title="Editar estudiante">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateStats() {
            document.getElementById('totalStudents').textContent = totalStudents;
        }
        
        function updatePagination() {
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('btnPrevPage');
            const nextBtn = document.getElementById('btnNextPage');
            const prevItem = document.getElementById('prevPageItem');
            const nextItem = document.getElementById('nextPageItem');
            
            pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            
            if (currentPage <= 1) {
                prevItem.classList.add('disabled');
                prevBtn.disabled = true;
            } else {
                prevItem.classList.remove('disabled');
                prevBtn.disabled = false;
            }
            
            if (currentPage >= totalPages) {
                nextItem.classList.add('disabled');
                nextBtn.disabled = true;
            } else {
                nextItem.classList.remove('disabled');
                nextBtn.disabled = false;
            }
        }
        // ==========================================
        // EVENTOS
        // ==========================================
        
        function setupEventListeners() {
            // Búsqueda con debounce
            document.getElementById('searchInput').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    loadStudents(e.target.value);
                }, 500);
            });
            
            // Botones
            document.getElementById('btnNewStudent').addEventListener('click', showNewStudentModal);
            document.getElementById('btnRefresh').addEventListener('click', () => loadStudents());
            document.getElementById('btnPrevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    loadStudents(document.getElementById('searchInput').value, currentPage - 1);
                }
            });
            document.getElementById('btnNextPage').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    loadStudents(document.getElementById('searchInput').value, currentPage + 1);
                }
            });
            
            // Formulario
            document.getElementById('studentForm').addEventListener('submit', handleSubmit);
            
            console.log('✅ Event listeners configurados');
        }
        
        // ==========================================
        // MODAL Y FORMULARIO
        // ==========================================
        
        function showNewStudentModal() {
            isEditing = false;
            currentStudentId = null;
            
            document.getElementById('studentModalLabel').textContent = 'Nuevo Estudiante';
            document.getElementById('btnSaveStudent').textContent = 'Crear Estudiante';
            
            document.getElementById('studentForm').reset();
            
            document.getElementById('studentCode').readOnly = false;
            document.getElementById('studentCode').disabled = false;
            // Restaurar familyCode a su estado normal
            document.getElementById('familyCode').style.pointerEvents = 'auto';
            document.getElementById('familyCode').style.backgroundColor = '';
            
            modalInstance.show();
            
            setTimeout(() => document.getElementById('studentCode').focus(), 500);
        }
        
        async function editStudent(studentId) {
            try {
                showLoading();
                
                if (families.length === 0 || courses.length === 0 || statuses.length === 0 || genders.length === 0) {
                    await loadDropdownData();
                }
                
                const data = await supabaseRequest('/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2,student_birthday,student_entry_date,family_id,course_id,status_id,gender_id&student_id=eq.' + studentId);
                
                if (!data || data.length === 0) {
                    throw new Error('Estudiante no encontrado');
                }
                
                const student = data[0];
                
                isEditing = true;
                currentStudentId = studentId;
                
                document.getElementById('studentModalLabel').textContent = 'Editar Estudiante';
                document.getElementById('btnSaveStudent').textContent = 'Actualizar Estudiante';
                
                document.getElementById('studentCode').value = student.student_code;
                document.getElementById('firstName').value = student.student_first_name;
                document.getElementById('lastName1').value = student.student_last_name_1;
                document.getElementById('lastName2').value = student.student_last_name_2 || '';
                document.getElementById('birthDate').value = student.student_birthday || '';
                document.getElementById('entryDate').value = student.student_entry_date || '';
                
                setTimeout(() => {
                    document.getElementById('familyCode').value = student.family_id || '';
                    document.getElementById('courseId').value = student.course_id || '';
                    document.getElementById('statusId').value = student.status_id || '';
                    document.getElementById('gender').value = student.gender_id || '';
                }, 100);
                
                document.getElementById('studentCode').readOnly = true;
                // NO deshabilitar familyCode - solo hacerlo de solo lectura visualmente
                document.getElementById('familyCode').style.pointerEvents = 'none';
                document.getElementById('familyCode').style.backgroundColor = '#e9ecef';
                
                hideLoading();
                
                modalInstance.show();
                
                setTimeout(() => document.getElementById('firstName').focus(), 500);
                
            } catch (error) {
                console.error('❌ Error cargando estudiante:', error);
                showAlert('Error al cargar datos del estudiante: ' + error.message, 'danger');
                hideLoading();
            }
        }
        
        async function handleSubmit(e) {
            e.preventDefault();
            
            try {
                showLoading();
                
                const formData = new FormData(e.target);
                const studentData = Object.fromEntries(formData.entries());
                
                if (!isEditing) {
                    try {
                        const maxIdData = await supabaseRequest('/students?select=student_id&order=student_id.desc&limit=1');
                        const nextId = maxIdData && maxIdData.length > 0 ? maxIdData[0].student_id + 1 : 1;
                        studentData.student_id = nextId;
                        console.log('Próximo student_id asignado:', nextId);
                    } catch (error) {
                        console.error('Error obteniendo próximo ID:', error);
                        studentData.student_id = Date.now();
                    }
                }
                
                Object.keys(studentData).forEach(key => {
                    if (studentData[key] === '' || studentData[key] === null || studentData[key] === undefined) {
                        if (key === 'student_last_name_2') {
                            return;
                        }
                        delete studentData[key];
                    }
                });
                
                if (!studentData.student_code || studentData.student_code.trim() === '') {
                    throw new Error('El código del estudiante es obligatorio');
                }
                if (!studentData.family_id || studentData.family_id.trim() === '') {
                    throw new Error('La familia es obligatoria');
                }
                if (!studentData.student_first_name || studentData.student_first_name.trim() === '') {
                    throw new Error('Los nombres son obligatorios');
                }
                if (!studentData.student_last_name_1 || studentData.student_last_name_1.trim() === '') {
                    throw new Error('El primer apellido es obligatorio');
                }
                if (!studentData.course_id || studentData.course_id.trim() === '') {
                    throw new Error('El curso es obligatorio');
                }
                if (!studentData.status_id || studentData.status_id.trim() === '') {
                    throw new Error('El estado es obligatorio');
                }
                if (!studentData.gender_id || studentData.gender_id.trim() === '') {
                    throw new Error('El género es obligatorio');
                }
                
                let result;
                if (isEditing) {
                    const updateUrl = '/students?student_id=eq.' + currentStudentId;
                    result = await supabaseRequest(updateUrl, {
                        method: 'PATCH',
                        body: JSON.stringify(studentData)
                    });
                    showAlert('Estudiante actualizado exitosamente', 'success');
                } else {
                    result = await supabaseRequest('/students', {
                        method: 'POST',
                        body: JSON.stringify(studentData)
                    });
                    showAlert('Estudiante creado exitosamente', 'success');
                }
                
                modalInstance.hide();
                
                await loadStudents(document.getElementById('searchInput').value, currentPage);
                
                hideLoading();
                
            } catch (error) {
                console.error('❌ Error guardando estudiante:', error);
                showAlert('Error al guardar estudiante: ' + error.message, 'danger');
                hideLoading();
            }
        }
        // ==========================================
        // UTILIDADES
        // ==========================================
        
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            
            const icons = {
                success: 'check-circle',
                danger: 'exclamation-triangle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${icons[type] || 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            alertContainer.innerHTML = alertHtml;
            
            if (type === 'success') {
                setTimeout(() => {
                    const alert = document.getElementById(alertId);
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        
        window.showNewStudentModal = showNewStudentModal;
        window.editStudent = editStudent;
        window.loadStudents = loadStudents;
        
        console.log('🎉 Gestión de Estudiantes cargada correctamente');
    </script>
</body>
</html>
