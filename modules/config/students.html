<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.12.01.11.39">
    
    <title>Gestionar Estudiantes - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .student-name {
            font-weight: 600;
            color: #0d6efd;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #0d6efd, #0056b3);
            color: white;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .table-actions {
            white-space: nowrap;
            width: 120px;
        }
        
        .required {
            color: #dc3545;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Configuraci√≥n</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gestionar Estudiantes
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-people me-2"></i>
                    Gestionar Estudiantes
                </h1>
                <p class="text-muted">
                    Administrar informaci√≥n de estudiantes del sistema
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- Estad√≠sticas -->
        <div class="row">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <span id="totalStudents" class="stats-number">0</span>
                        <span>estudiantes registrados</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- B√∫squeda y controles -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="searchInput" class="form-label">Buscar estudiante</label>
                        <input type="text" id="searchInput" class="form-control" 
                               placeholder="Busque por nombre o apellido...">
                    </div>
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">Estado</label>
                        <select id="statusFilter" class="form-select">
                            <option value="">Todos los estados</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button id="btnNewStudent" class="btn btn-primary w-100">
                            <i class="bi bi-plus-circle me-1"></i>Nuevo
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button id="btnRefresh" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                        </button>
                    </div>
                    <div class="col-md-1">
                        <button id="btnSyncPhidias" class="btn btn-success w-100" title="Sincronizar con PHIDIAS">
                            <i class="bi bi-cloud-download"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de estudiantes -->
        <div class="card mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>C√≥digo</th>
                                <th>Estudiante</th>
                                <th>Familia</th>
                                <th>Curso</th>
                                <th>Estado</th>
                                <th class="table-actions">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <!-- Contenido din√°mico -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Paginaci√≥n -->
        <div class="d-flex justify-content-center align-items-center mb-4">
            <nav aria-label="Paginaci√≥n de estudiantes">
                <ul class="pagination">
                    <li class="page-item" id="prevPageItem">
                        <button class="page-link" id="btnPrevPage">
                            <i class="bi bi-chevron-left"></i> Anterior
                        </button>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link" id="pageInfo">P√°gina 1 de 1</span>
                    </li>
                    <li class="page-item" id="nextPageItem">
                        <button class="page-link" id="btnNextPage">
                            Siguiente <i class="bi bi-chevron-right"></i>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>

    </div>
    <!-- Modal para crear/editar estudiante -->
    <div class="modal fade" id="studentModal" tabindex="-1" aria-labelledby="studentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentModalLabel">Nuevo Estudiante</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="studentForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <!-- C√≥digo del estudiante -->
                            <div class="col-md-6">
                                <label for="studentCode" class="form-label">
                                    C√≥digo <span class="required">*</span>
                                </label>
                                <input type="number" class="form-control" id="studentCode" 
                                       name="student_code" required>
                            </div>

                            <div class="col-md-6">
                                <label for="studentIdDocument" class="form-label">
                                    Documento de identidad
                                </label>
                                <input type="text" class="form-control" id="studentIdDocument" 
                                       name="student_id_document" maxlength="50"
                                       placeholder="Ej: 1234567890">
                                <small class="text-muted">C√©dula, TI, pasaporte, etc.</small>
                            </div>
                            
                            <!-- Familia -->
                            <div class="col-md-6">
                                <label for="familyCode" class="form-label">
                                    Familia <span class="required">*</span>
                                </label>
                                <select class="form-select" id="familyCode" name="family_id" required>
                                    <option value="">Seleccione una familia...</option>
                                </select>
                            </div>
                            
                            <!-- Nombres -->
                            <div class="col-md-6">
                                <label for="firstName" class="form-label">
                                    Nombres <span class="required">*</span>
                                </label>
                                <input type="text" class="form-control" id="firstName" 
                                       name="student_first_name" required maxlength="100">
                            </div>
                            
                            <!-- Primer apellido -->
                            <div class="col-md-6">
                                <label for="lastName1" class="form-label">
                                    Primer apellido <span class="required">*</span>
                                </label>
                                <input type="text" class="form-control" id="lastName1" 
                                       name="student_last_name_1" required maxlength="100">
                            </div>
                            
                            <!-- Segundo apellido -->
                            <div class="col-md-6">
                                <label for="lastName2" class="form-label">Segundo apellido</label>
                                <input type="text" class="form-control" id="lastName2" 
                                       name="student_last_name_2" maxlength="100">
                            </div>
                            
                            <!-- G√©nero -->
                            <div class="col-md-6">
                                <label for="gender" class="form-label">
                                    G√©nero <span class="required">*</span>
                                </label>
                                <select class="form-select" id="gender" name="gender_id" required>
                                    <option value="">Seleccione un g√©nero...</option>
                                </select>
                            </div>
                            
                            <!-- Fecha de nacimiento -->
                            <div class="col-md-6">
                                <label for="birthDate" class="form-label">
                                    Fecha de nacimiento <span class="required">*</span>
                                </label>
                                <input type="date" class="form-control" id="birthDate" 
                                       name="student_birthday" required>
                            </div>
                            
                            <!-- Fecha de ingreso -->
                            <div class="col-md-6">
                                <label for="entryDate" class="form-label">
                                    Fecha de ingreso <span class="required">*</span>
                                </label>
                                <input type="date" class="form-control" id="entryDate" 
                                       name="student_entry_date" required>
                            </div>
                            
                            <!-- Curso -->
                            <div class="col-md-6">
                                <label for="courseId" class="form-label">
                                    Curso <span class="required">*</span>
                                </label>
                                <select class="form-select" id="courseId" name="course_id" required>
                                    <option value="">Seleccione un curso...</option>
                                </select>
                            </div>
                            
                            <!-- Estado -->
                            <div class="col-md-6">
                                <label for="statusId" class="form-label">
                                    Estado <span class="required">*</span>
                                </label>
                                <select class="form-select" id="statusId" name="status_id" required>
                                    <option value="">Seleccione un estado...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btnSaveStudent">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- SCRIPTS - ORDEN CR√çTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentPage = 1;
        let totalPages = 1;
        let totalStudents = 0;
        let students = [];
        let families = [];
        let courses = [];
        let statuses = [];
        let genders = [];
        let currentStatusFilter = '1'; 
        let isEditing = false;
        let currentStudentId = null;
        let searchTimeout = null;
        let modalInstance = null;

        // ==========================================
        // MAPEOS ESPEC√çFICOS PARA SINCRONIZACI√ìN DE ESTUDIANTES
        // ==========================================
        const STUDENT_SYNC_MAPPINGS = {
            // G√©neros: PHIDIAS -> Tilata UUID
            gender: {
                1: '9d3e1c57-67c8-4133-b55b-9f35100e5174', // Masculino
                2: '789560c3-e8f5-47b7-bf7a-da256ac03962'  // Femenino
            },
            // Estados: PHIDIAS -> Tilata UUID
            status: {
                'activo': 'd89b6287-ee51-435d-aeeb-d0f503af4646',
                'inscrito': '44318f7a-7f5e-481f-a5c1-b062169566a7',
                'retirado': '7386162d-6aa5-4b80-bea3-718ed8f82205'
            }
        };

        // ==========================================
        // UTILIDAD PARA MANEJO CORRECTO DE FECHAS
        // ==========================================
        
        /**
         * Convierte una fecha del input date a formato YYYY-MM-DD sin afectaci√≥n de timezone
         * @param {string} dateString - Fecha en formato YYYY-MM-DD del input
         * @returns {string} - Fecha en formato YYYY-MM-DD garantizada
         */
        function formatDateForDatabase(dateString) {
            if (!dateString) return null;
            
            // Si ya viene en formato correcto, verificar que no tenga timezone
            if (dateString.includes('T')) {
                return dateString.split('T')[0];
            }
            
            // Para fechas del input type="date", retornar tal cual
            // porque ya est√°n en formato YYYY-MM-DD local
            return dateString;
        }
        
        /**
         * Obtiene la fecha actual en timezone de Colombia (UTC-5) en formato YYYY-MM-DD
         * @returns {string} - Fecha actual en formato YYYY-MM-DD
         */
        function getCurrentDateColombia() {
            // Crear fecha en timezone de Colombia
            const now = new Date();
            const colombiaOffset = -5 * 60; // UTC-5 en minutos
            const localOffset = now.getTimezoneOffset(); // Offset del navegador
            const colombiaTime = new Date(now.getTime() + (localOffset + colombiaOffset) * 60000);
            
            const year = colombiaTime.getFullYear();
            const month = String(colombiaTime.getMonth() + 1).padStart(2, '0');
            const day = String(colombiaTime.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }
        
        // ==========================================
        // INICIALIZACI√ìN - PATR√ìN OBLIGATORIO
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // PASO 1: SIEMPRE validar permisos primero
                const hasAccess = await validatePageAccess('Gestionar estudiantes');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                
                // PASO 2: Inicializar p√°gina
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showAlert('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        
        async function inicializarPagina() {
            try {
                showLoading();
                
                console.log('üéì Gestionar Estudiantes - Inicializando...');
                
                // Inicializar modal
                modalInstance = new bootstrap.Modal(document.getElementById('studentModal'));
                
                // Cargar datos iniciales
                await loadDropdownData();
                
                // Configurar eventos
                setupEventListeners();
                
                // Cargar estudiantes
                await loadStudents();
                
                hideLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showAlert('Error al cargar la p√°gina: ' + error.message, 'danger');
                hideLoading();
            }
        }
        
        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        
        async function loadDropdownData() {
            try {
                const [familiesData, coursesData, statusesData, gendersData] = await Promise.all([
                    supabaseRequest('/families?select=family_code,family_name&order=family_name.asc'),
                    supabaseRequest('/courses?select=course_id,course_name,course_order&course_status=eq.active&order=course_order.asc'),
                    supabaseRequest('/student_status?select=status_id,status_code,status_description&order=status_code.asc'),
                    supabaseRequest('/genders?select=gender_id,gender_name&order=gender_name.asc')
                ]);
                
                families = familiesData || [];
                courses = coursesData || [];
                statuses = statusesData || [];
                genders = gendersData || [];
                
                populateDropdowns();
                
                console.log('‚úÖ Datos de dropdowns cargados');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos de dropdowns:', error);
                throw error;
            }
        }

        function populateDropdowns() {
            // Families
            const familySelect = document.getElementById('familyCode');
            familySelect.innerHTML = '<option value="">Seleccione una familia...</option>';
            families.forEach(family => {
                familySelect.innerHTML += `<option value="${family.family_code}">${family.family_name}</option>`;
            });
            
            // Courses
            const courseSelect = document.getElementById('courseId');
            courseSelect.innerHTML = '<option value="">Seleccione un curso...</option>';
            courses.forEach(course => {
                courseSelect.innerHTML += `<option value="${course.course_id}">${course.course_name}</option>`;
            });
            
            // Statuses (para el modal)
            const statusSelect = document.getElementById('statusId');
            statusSelect.innerHTML = '<option value="">Seleccione un estado...</option>';
            statuses.forEach(status => {
                statusSelect.innerHTML += `<option value="${status.status_id}">${status.status_description}</option>`;
            });
            
            // Status Filter (para el filtro principal)
            const statusFilter = document.getElementById('statusFilter');
            statusFilter.innerHTML = '<option value="">Todos los estados</option>';
            statuses.forEach(status => {
                const selected = status.status_code === 1 ? 'selected' : '';
                statusFilter.innerHTML += `<option value="${status.status_code}" ${selected}>${status.status_description}</option>`;
            });
            
            // Genders
            const genderSelect = document.getElementById('gender');
            genderSelect.innerHTML = '<option value="">Seleccione un g√©nero...</option>';
            genders.forEach(gender => {
                genderSelect.innerHTML += `<option value="${gender.gender_id}">${gender.gender_name}</option>`;
            });
        }
        

        
        async function loadStudents(search = '', page = 1) {
            try {
                showLoading();
                
                let query = '/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2,family_id,course_id,status_id';
                
                // Si hay b√∫squeda por nombre, ignorar filtro de estado
                if (search.trim()) {
                    query += `&or=(student_first_name.ilike.*${search}*,student_last_name_1.ilike.*${search}*,student_last_name_2.ilike.*${search}*)`;
                } else {
                    // Si NO hay b√∫squeda, aplicar filtro de estado
                    if (currentStatusFilter) {
                        // Buscar el status_id correspondiente al status_code seleccionado
                        const selectedStatus = statuses.find(s => s.status_code.toString() === currentStatusFilter.toString());
                        if (selectedStatus) {
                            query += `&status_id=eq.${selectedStatus.status_id}`;
                        }
                    }
                }
                
                const limit = 30;
                const offset = (page - 1) * limit;
                query += `&limit=${limit}&offset=${offset}&order=student_last_name_1.asc,student_first_name.asc`;
                
                const studentsData = await supabaseRequest(query);
                
                if (studentsData && studentsData.length > 0) {
                    const [familiesData, coursesData, statusesData] = await Promise.all([
                        supabaseRequest('/families?select=family_code,family_name'),
                        supabaseRequest('/courses?select=course_id,course_name,course_order'),
                        supabaseRequest('/student_status?select=status_id,status_description')
                    ]);
                    
                    const familiesMap = {};
                    const coursesMap = {};
                    const statusesMap = {};
                    
                    if (familiesData) familiesData.forEach(f => familiesMap[f.family_code] = f);
                    if (coursesData) coursesData.forEach(c => coursesMap[c.course_id] = c);
                    if (statusesData) statusesData.forEach(s => statusesMap[s.status_id] = s);
                    
                    students = studentsData.map(student => ({
                        ...student,
                        families: familiesMap[student.family_id] || null,
                        courses: coursesMap[student.course_id] || null,
                        student_status: statusesMap[student.status_id] || null
                    }));
                } else {
                    students = [];
                }
                
                // Contar total con los mismos filtros
                let countQuery = '/students?select=student_id';
                if (search.trim()) {
                    countQuery += `&or=(student_first_name.ilike.*${search}*,student_last_name_1.ilike.*${search}*,student_last_name_2.ilike.*${search}*)`;
                } else {
                    if (currentStatusFilter) {
                        const selectedStatus = statuses.find(s => s.status_code.toString() === currentStatusFilter.toString());
                        if (selectedStatus) {
                            countQuery += `&status_id=eq.${selectedStatus.status_id}`;
                        }
                    }
                }
                const countData = await supabaseRequest(countQuery);
                totalStudents = countData ? countData.length : 0;
                totalPages = Math.ceil(totalStudents / limit);
                currentPage = page;
                
                renderStudents();
                updatePagination();
                updateStats();
                
                hideLoading();
                
            } catch (error) {
                console.error('‚ùå Error cargando estudiantes:', error);
                showAlert('Error al cargar estudiantes: ' + error.message, 'danger');
                hideLoading();
            }
        }
        
        // ==========================================
        // RENDERIZADO
        // ==========================================
        
        function renderStudents() {
            const tbody = document.getElementById('studentsTableBody');
            
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="text-muted">
                                <i class="bi bi-people" style="font-size: 3rem; opacity: 0.3;"></i>
                                <h5 class="mt-3">No se encontraron estudiantes</h5>
                                <p>No hay estudiantes que coincidan con su b√∫squeda.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = students.map(student => {
                const fullName = `${student.student_last_name_1} ${student.student_last_name_2 || ''} ${student.student_first_name}`.trim();
                const familyName = student.families ? student.families.family_name : 'Sin familia';
                const courseName = student.courses ? student.courses.course_name : 'Sin curso';
                const statusName = student.student_status ? student.student_status.status_description : 'Sin estado';
                
                return `
                    <tr>
                        <td><strong>${student.student_code}</strong></td>
                        <td class="student-name">${fullName}</td>
                        <td>${familyName}</td>
                        <td>${courseName}</td>
                        <td>${statusName}</td>
                        <td class="table-actions">
                            <button class="btn btn-sm btn-outline-primary me-1" 
                                    onclick="editStudent('${student.student_id}')" 
                                    title="Editar estudiante">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateStats() {
            document.getElementById('totalStudents').textContent = totalStudents;
        }
        
        function updatePagination() {
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('btnPrevPage');
            const nextBtn = document.getElementById('btnNextPage');
            const prevItem = document.getElementById('prevPageItem');
            const nextItem = document.getElementById('nextPageItem');
            
            pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;
            
            if (currentPage <= 1) {
                prevItem.classList.add('disabled');
                prevBtn.disabled = true;
            } else {
                prevItem.classList.remove('disabled');
                prevBtn.disabled = false;
            }
            
            if (currentPage >= totalPages) {
                nextItem.classList.add('disabled');
                nextBtn.disabled = true;
            } else {
                nextItem.classList.remove('disabled');
                nextBtn.disabled = false;
            }
        }
        // ==========================================
        // EVENTOS
        // ==========================================
        
        function setupEventListeners() {
            // B√∫squeda con debounce
            document.getElementById('searchInput').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    loadStudents(e.target.value);
                }, 500);
            });

            // Filtro de estado
            document.getElementById('statusFilter').addEventListener('change', function(e) {
                currentStatusFilter = e.target.value;
                currentPage = 1;
                const searchValue = document.getElementById('searchInput').value;
                loadStudents(searchValue, 1);
            });
            
            // Botones
            document.getElementById('btnNewStudent').addEventListener('click', showNewStudentModal);
            document.getElementById('btnRefresh').addEventListener('click', () => loadStudents());

            // Bot√≥n sincronizar PHIDIAS
            document.getElementById('btnSyncPhidias').addEventListener('click', async () => {
                if (confirm('¬øDesea sincronizar estudiantes desde PHIDIAS?\n\nEsto crear√° nuevos estudiantes y familias que no existan en el sistema.')) {
                    await syncWithPhidias();
                }
            });
            
            document.getElementById('btnPrevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    loadStudents(document.getElementById('searchInput').value, currentPage - 1);
                }
            });
            document.getElementById('btnNextPage').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    loadStudents(document.getElementById('searchInput').value, currentPage + 1);
                }
            });
            
            // Formulario
            document.getElementById('studentForm').addEventListener('submit', handleSubmit);
            
            console.log('‚úÖ Event listeners configurados');
        }
        
        // ==========================================
        // MODAL Y FORMULARIO
        // ==========================================
        
        function showNewStudentModal() {
            isEditing = false;
            currentStudentId = null;
            
            document.getElementById('studentModalLabel').textContent = 'Nuevo Estudiante';
            document.getElementById('btnSaveStudent').textContent = 'Crear Estudiante';
            
            document.getElementById('studentForm').reset();
            
            document.getElementById('studentCode').readOnly = false;
            document.getElementById('studentCode').disabled = false;
            // Restaurar familyCode a su estado normal
            document.getElementById('familyCode').style.pointerEvents = 'auto';
            document.getElementById('familyCode').style.backgroundColor = '';
            
            modalInstance.show();
            
            setTimeout(() => document.getElementById('studentCode').focus(), 500);
        }
        
        async function editStudent(studentId) {
            try {
                showLoading();
                
                if (families.length === 0 || courses.length === 0 || statuses.length === 0 || genders.length === 0) {
                    await loadDropdownData();
                }
                
                const data = await supabaseRequest('/students?select=student_id,student_code,student_first_name,student_last_name_1,student_last_name_2,student_birthday,student_entry_date,family_id,course_id,status_id,gender_id&student_id=eq.' + studentId);
                
                if (!data || data.length === 0) {
                    throw new Error('Estudiante no encontrado');
                }
                
                const student = data[0];
                
                isEditing = true;
                currentStudentId = studentId;
                
                document.getElementById('studentModalLabel').textContent = 'Editar Estudiante';
                document.getElementById('btnSaveStudent').textContent = 'Actualizar Estudiante';
                
                document.getElementById('studentCode').value = student.student_code;
                document.getElementById('firstName').value = student.student_first_name;
                document.getElementById('lastName1').value = student.student_last_name_1;
                document.getElementById('lastName2').value = student.student_last_name_2 || '';
                document.getElementById('birthDate').value = student.student_birthday || '';
                document.getElementById('entryDate').value = student.student_entry_date || '';
                document.getElementById('studentIdDocument').value = student.student_id_document || '';
                
                setTimeout(() => {
                    document.getElementById('familyCode').value = student.family_id || '';
                    document.getElementById('courseId').value = student.course_id || '';
                    document.getElementById('statusId').value = student.status_id || '';
                    document.getElementById('gender').value = student.gender_id || '';
                }, 100);
                
                document.getElementById('studentCode').readOnly = true;
                // NO deshabilitar familyCode - solo hacerlo de solo lectura visualmente
                document.getElementById('familyCode').style.pointerEvents = 'none';
                document.getElementById('familyCode').style.backgroundColor = '#e9ecef';
                
                hideLoading();
                
                modalInstance.show();
                
                setTimeout(() => document.getElementById('firstName').focus(), 500);
                
            } catch (error) {
                console.error('‚ùå Error cargando estudiante:', error);
                showAlert('Error al cargar datos del estudiante: ' + error.message, 'danger');
                hideLoading();
            }
        }

        // ‚úÖ C√ìDIGO CORREGIDO
        async function handleSubmit(e) {
            e.preventDefault();
            
            try {
                showLoading();
                
                const formData = new FormData(e.target);
                const studentData = Object.fromEntries(formData.entries());
                
                // ‚≠ê CORRECCI√ìN: Formatear fechas antes de enviar
                if (studentData.student_birthday) {
                    studentData.student_birthday = formatDateForDatabase(studentData.student_birthday);
                }
                if (studentData.student_entry_date) {
                    studentData.student_entry_date = formatDateForDatabase(studentData.student_entry_date);
                }
                
                if (!isEditing) {
                    try {
                        const maxIdData = await supabaseRequest('/students?select=student_id&order=student_id.desc&limit=1');
                        const nextId = maxIdData && maxIdData.length > 0 ? maxIdData[0].student_id + 1 : 1;
                        studentData.student_id = nextId;
                        console.log('Pr√≥ximo student_id asignado:', nextId);
                    } catch (error) {
                        console.error('Error obteniendo pr√≥ximo ID:', error);
                        studentData.student_id = Date.now();
                    }
                }
                
                Object.keys(studentData).forEach(key => {
                    if (studentData[key] === '' || studentData[key] === null || studentData[key] === undefined) {
                        if (key === 'student_last_name_2') {
                            return;
                        }
                        delete studentData[key];
                    }
                });
                
                // Validaciones...
                if (!studentData.student_code || studentData.student_code.trim() === '') {
                    throw new Error('El c√≥digo del estudiante es obligatorio');
                }
                if (!studentData.family_id || studentData.family_id.trim() === '') {
                    throw new Error('La familia es obligatoria');
                }
                if (!studentData.student_first_name || studentData.student_first_name.trim() === '') {
                    throw new Error('Los nombres son obligatorios');
                }
                if (!studentData.student_last_name_1 || studentData.student_last_name_1.trim() === '') {
                    throw new Error('El primer apellido es obligatorio');
                }
                if (!studentData.course_id || studentData.course_id.trim() === '') {
                    throw new Error('El curso es obligatorio');
                }
                if (!studentData.status_id || studentData.status_id.trim() === '') {
                    throw new Error('El estado es obligatorio');
                }
                if (!studentData.gender_id || studentData.gender_id.trim() === '') {
                    throw new Error('El g√©nero es obligatorio');
                }

                // Validar que si hay documento, no est√© duplicado
                if (studentData.student_id_document && studentData.student_id_document.trim()) {
                    try {
                        let checkQuery = `/students?select=student_id&student_id_document=eq.${encodeURIComponent(studentData.student_id_document.trim())}`;
                        
                        // Si estamos editando, excluir el estudiante actual
                        if (isEditing) {
                            checkQuery += `&student_id=neq.${currentStudentId}`;
                        }
                        
                        const existingStudent = await supabaseRequest(checkQuery);
                        
                        if (existingStudent && existingStudent.length > 0) {
                            throw new Error('Ya existe un estudiante con ese documento de identidad');
                        }
                    } catch (error) {
                        if (error.message.includes('Ya existe')) {
                            throw error;
                        }
                        console.warn('Error verificando documento:', error);
                        // Continuar si falla la verificaci√≥n (no bloquear por error de red)
                    }
                }
                
                let result;
                if (isEditing) {
                    const updateUrl = '/students?student_id=eq.' + currentStudentId;
                    result = await supabaseRequest(updateUrl, {
                        method: 'PATCH',
                        body: JSON.stringify(studentData)
                    });
                    showAlert('Estudiante actualizado exitosamente', 'success');
                } else {
                    result = await supabaseRequest('/students', {
                        method: 'POST',
                        body: JSON.stringify(studentData)
                    });
                    showAlert('Estudiante creado exitosamente', 'success');
                }
                
                modalInstance.hide();
                
                await loadStudents(document.getElementById('searchInput').value, currentPage);
                
                hideLoading();
                
            } catch (error) {
                console.error('‚ùå Error guardando estudiante:', error);
                showAlert('Error al guardar estudiante: ' + error.message, 'danger');
                hideLoading();
            }
        }

        // ==========================================
        // SINCRONIZACI√ìN CON PHIDIAS
        // ==========================================
        
        async function syncWithPhidias() {
            try {
                showLoading();
                document.getElementById('loadingOverlay').querySelector('p').textContent = 'Conectando con PHIDIAS...';
                
                // 1. Llamar API de PHIDIAS usando funci√≥n centralizada
                const phidiasData = await phidiasRequest('/course/consolidate');
                console.log('üì• Datos recibidos de PHIDIAS:', phidiasData);
                
                // 2. Obtener estudiantes existentes (solo c√≥digos)
                document.getElementById('loadingOverlay').querySelector('p').textContent = 'Verificando estudiantes existentes...';
                const existingStudents = await supabaseRequest('/students?select=student_code');
                const existingCodes = new Set(existingStudents.map(s => s.student_code));
                
                // 3. Obtener familias existentes
                const existingFamilies = await supabaseRequest('/families?select=family_code');
                const existingFamilyCodes = new Set(existingFamilies.map(f => f.family_code));
                
                // 4. Obtener cursos de Tilata para mapeo
                const tilataCourses = await supabaseRequest('/courses?select=course_id,course_name');
                const courseMap = {};
                tilataCourses.forEach(c => {
                    courseMap[c.course_name.toLowerCase().trim()] = c.course_id;
                });
                
                // 5. Procesar datos de PHIDIAS
                document.getElementById('loadingOverlay').querySelector('p').textContent = 'Procesando estudiantes...';
                
                let studentsToCreate = [];
                let familiesToCreate = [];
                let skipped = 0;
                let noMatchCourse = [];
                
                // Recorrer estructura jer√°rquica de PHIDIAS
                for (const category of phidiasData) {
                    for (const course of category.courses || []) {
                        for (const section of course.sections || []) {
                            // Construir nombre del curso para mapeo
                            const courseName = `${course.name} ${section.name}`.toLowerCase().trim();
                            const courseId = courseMap[courseName];
                            
                            for (const student of section.students || []) {
                                // Ignorar si no tiene c√≥digo
                                if (!student.code) {
                                    skipped++;
                                    continue;
                                }
                                
                                // Ignorar si ya existe
                                if (existingCodes.has(student.code)) {
                                    skipped++;
                                    continue;
                                }
                                
                                // Ignorar estados no mapeables
                                const status = student.enrollment?.status?.toLowerCase();
                                if (!STUDENT_SYNC_MAPPINGS.status[status]) {
                                    skipped++;
                                    continue;
                                }
                                
                                // Verificar que el curso existe en Tilata
                                if (!courseId) {
                                    noMatchCourse.push(`${student.firstname} ${student.lastname1} (${course.name} ${section.name})`);
                                    continue;
                                }
                                
                                // Derivar c√≥digo de familia
                                const familyCode = Math.floor(student.code / 10);
                                
                                // Crear familia si no existe
                                if (!existingFamilyCodes.has(familyCode)) {
                                    const familyName = `${student.lastname1 || ''} ${student.lastname2 || ''}`.trim();
                                    familiesToCreate.push({
                                        family_code: familyCode,
                                        family_name: familyName,
                                        student_count: 1
                                    });
                                    existingFamilyCodes.add(familyCode);
                                }
                                
                                // Preparar estudiante
                                studentsToCreate.push({
                                    student_code: student.code,
                                    student_id_document: student.document ? String(student.document) : null,
                                    student_first_name: student.firstname || '',
                                    student_last_name_1: student.lastname1 || '',
                                    student_last_name_2: student.lastname2 || null,
                                    student_birthday: phidiasTimestampToDate(student.birthday),
                                    student_entry_date: phidiasTimestampToDate(student.enrollment?.date) || getCurrentDateColombia(),
                                    family_id: familyCode,
                                    course_id: courseId,
                                    gender_id: STUDENT_SYNC_MAPPINGS.gender[student.gender] || null,
                                    status_id: STUDENT_SYNC_MAPPINGS.status[status]
                                });
                            }
                        }
                    }
                }
                
                // 6. Insertar familias nuevas
                document.getElementById('loadingOverlay').querySelector('p').textContent = 'Creando familias...';
                if (familiesToCreate.length > 0) {
                    for (let i = 0; i < familiesToCreate.length; i += 50) {
                        const batch = familiesToCreate.slice(i, i + 50);
                        await supabaseRequest('/families', {
                            method: 'POST',
                            body: JSON.stringify(batch)
                        });
                    }
                    console.log(`‚úÖ ${familiesToCreate.length} familias creadas`);
                }
                
                // 7. Insertar estudiantes nuevos
                document.getElementById('loadingOverlay').querySelector('p').textContent = 'Creando estudiantes...';
                if (studentsToCreate.length > 0) {
                    const maxIdData = await supabaseRequest('/students?select=student_id&order=student_id.desc&limit=1');
                    let nextId = maxIdData && maxIdData.length > 0 ? maxIdData[0].student_id + 1 : 1;
                    
                    studentsToCreate.forEach(s => {
                        s.student_id = nextId++;
                    });
                    
                    for (let i = 0; i < studentsToCreate.length; i += 50) {
                        const batch = studentsToCreate.slice(i, i + 50);
                        await supabaseRequest('/students', {
                            method: 'POST',
                            body: JSON.stringify(batch)
                        });
                    }
                    console.log(`‚úÖ ${studentsToCreate.length} estudiantes creados`);
                }
                
                hideLoading();
                
                // 8. Mostrar resultado
                let message = `Sincronizaci√≥n completada:<br>`;
                message += `‚Ä¢ ${studentsToCreate.length} estudiantes nuevos creados<br>`;
                message += `‚Ä¢ ${familiesToCreate.length} familias nuevas creadas<br>`;
                message += `‚Ä¢ ${skipped} registros omitidos (ya exist√≠an o sin datos)`;
                
                if (noMatchCourse.length > 0) {
                    message += `<br><br>‚ö†Ô∏è ${noMatchCourse.length} estudiantes sin curso equivalente en Tilata`;
                    console.warn('Estudiantes sin curso:', noMatchCourse);
                }
                
                showAlert(message, 'success');
                
                await loadStudents();
                
            } catch (error) {
                console.error('‚ùå Error en sincronizaci√≥n:', error);
                hideLoading();
                showAlert('Error en sincronizaci√≥n con PHIDIAS: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            
            const icons = {
                success: 'check-circle',
                danger: 'exclamation-triangle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${icons[type] || 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            alertContainer.innerHTML = alertHtml;
            
            if (type === 'success') {
                setTimeout(() => {
                    const alert = document.getElementById(alertId);
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        
        window.showNewStudentModal = showNewStudentModal;
        window.editStudent = editStudent;
        window.loadStudents = loadStudents;
        window.syncWithPhidias = syncWithPhidias;
        
        console.log('üéâ Gesti√≥n de Estudiantes cargada correctamente');
    </script>
</body>
</html>
