<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.24.18.00">
    <title>√Åreas y Asignaturas - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center;
            align-items: center; z-index: 9999;
        }
        .loading-overlay.hidden { display: none; }
        .loading-content { background: white; padding: 2rem; border-radius: 8px; text-align: center; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .area-item {
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: all 0.2s;
        }
        .area-item:hover {
            background-color: #f8f9fa;
        }
        .area-item.active {
            border-left-color: var(--system-primary-color, #1B365D);
            background-color: #e8f0fe;
        }
        .area-item .area-name {
            font-weight: 500;
        }
        .area-item .badge-count {
            font-size: 0.75rem;
        }
        .subject-row:hover {
            background-color: #f8f9fa;
        }
        .grade-badge {
            font-size: 0.75rem;
            margin: 2px;
        }
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 3rem;
            display: block;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Configuraci√≥n</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">√Åreas y Asignaturas</li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-diagram-3 me-2"></i>√Åreas y Asignaturas
                </h1>
                <p class="text-muted">Gestione las √°reas acad√©micas, sus asignaturas y los grados en que se dictan.</p>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- Contenido principal: 2 columnas -->
        <div class="row">
            <!-- COLUMNA IZQUIERDA: √Åreas -->
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-collection me-2"></i>√Åreas</h5>
                        <button class="btn btn-primary btn-sm" onclick="abrirModalArea()">
                            <i class="bi bi-plus-circle me-1"></i>Nueva
                        </button>
                    </div>
                    <div class="card-body p-0" id="areasListContainer">
                        <div class="empty-state">
                            <i class="bi bi-collection"></i>
                            <p>Cargando √°reas...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA: Asignaturas del √°rea seleccionada -->
            <div class="col-lg-8 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-book me-2"></i>
                            <span id="tituloAsignaturas">Asignaturas</span>
                        </h5>
                        <button class="btn btn-primary btn-sm" id="btnNuevaAsignatura" onclick="abrirModalAsignatura()" style="display:none;">
                            <i class="bi bi-plus-circle me-1"></i>Nueva Asignatura
                        </button>
                    </div>
                    <div class="card-body p-0" id="asignaturasContainer">
                        <div class="empty-state">
                            <i class="bi bi-arrow-left-circle"></i>
                            <p>Seleccione un √°rea para ver sus asignaturas</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Crear / Editar √Årea -->
    <div class="modal fade" id="modalArea" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAreaTitle">
                        <i class="bi bi-plus-circle me-2"></i>Nueva √Årea
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formArea" onsubmit="guardarArea(event)">
                    <div class="modal-body">
                        <input type="hidden" id="areaId">
                        <div class="mb-3">
                            <label for="areaNombre" class="form-label">Nombre del √Årea <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="areaNombre" required maxlength="100"
                                   placeholder="Ej: Ciencias Naturales">
                        </div>
                        <div class="mb-3">
                            <label for="areaDescripcion" class="form-label">Descripci√≥n</label>
                            <textarea class="form-control" id="areaDescripcion" rows="2"
                                      placeholder="Descripci√≥n opcional del √°rea"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="areaOrden" class="form-label">Orden</label>
                            <input type="number" class="form-control" id="areaOrden" min="1"
                                   placeholder="Posici√≥n para ordenar">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btnGuardarArea">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: Crear / Editar Asignatura -->
    <div class="modal fade" id="modalAsignatura" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAsignaturaTitle">
                        <i class="bi bi-plus-circle me-2"></i>Nueva Asignatura
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formAsignatura" onsubmit="guardarAsignatura(event)">
                    <div class="modal-body">
                        <input type="hidden" id="asignaturaId">
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="asignaturaNombre" class="form-label">Nombre de la Asignatura <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="asignaturaNombre" required maxlength="100"
                                       placeholder="Ej: Biolog√≠a">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="asignaturaOrden" class="form-label">Orden</label>
                                <input type="number" class="form-control" id="asignaturaOrden" min="1"
                                       placeholder="Posici√≥n">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="asignaturaDescripcion" class="form-label">Descripci√≥n</label>
                            <textarea class="form-control" id="asignaturaDescripcion" rows="2"
                                      placeholder="Descripci√≥n opcional"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Grados en que se dicta <span class="text-danger">*</span></label>
                            <p class="text-muted small mb-2">Seleccione los grados donde se ofrece esta asignatura.</p>
                            <div id="gradosCheckboxContainer" class="border rounded p-3" style="max-height: 250px; overflow-y: auto;">
                                <div class="text-center text-muted">Cargando grados...</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btnGuardarAsignatura">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let areas = [];
        let grados = [];
        let areaSeleccionada = null;
        let modalAreaInstance = null;
        let modalAsignaturaInstance = null;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Validando acceso...');
            try {
                const hasAccess = await validatePageAccess('Gestionar √°reas y asignaturas');
                if (!hasAccess) return;

                console.log('‚úÖ Acceso permitido');
                modalAreaInstance = new bootstrap.Modal(document.getElementById('modalArea'));
                modalAsignaturaInstance = new bootstrap.Modal(document.getElementById('modalAsignatura'));

                await cargarGrados();
                await cargarAreas();

                console.log('‚úÖ P√°gina inicializada correctamente');
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGAR DATOS
        // ==========================================
        async function cargarGrados() {
            try {
                grados = await supabaseRequest(
                    '/grades?select=grade_id,grade_name,section_id,sections(section_name)&grade_status=eq.active&order=grade_order'
                );
                console.log(`‚úÖ ${grados.length} grados cargados`);
            } catch (error) {
                console.error('‚ùå Error cargando grados:', error);
                grados = [];
            }
        }

        async function cargarAreas() {
            try {
                areas = await supabaseRequest(
                    '/academic_areas?select=area_id,area_name,area_description,area_order,area_status,academic_subjects(count)&order=area_order.nullslast,area_name'
                );
                console.log(`‚úÖ ${areas.length} √°reas cargadas`);
                renderizarAreas();
            } catch (error) {
                console.error('‚ùå Error cargando √°reas:', error);
                showMessage('Error al cargar las √°reas', 'danger');
            }
        }

        // ==========================================
        // RENDERIZAR √ÅREAS
        // ==========================================
        function renderizarAreas() {
            const container = document.getElementById('areasListContainer');

            if (!areas || areas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-collection"></i>
                        <p>No hay √°reas creadas</p>
                        <button class="btn btn-sm btn-primary" onclick="abrirModalArea()">
                            <i class="bi bi-plus-circle me-1"></i>Crear primera √°rea
                        </button>
                    </div>`;
                return;
            }

            let html = '<div class="list-group list-group-flush">';
            areas.forEach(area => {
                const isActive = areaSeleccionada && areaSeleccionada.area_id === area.area_id;
                const isInactive = area.area_status === 'inactive';
                const subjectCount = area.academic_subjects?.[0]?.count || 0;

                html += `
                    <div class="list-group-item area-item d-flex justify-content-between align-items-center ${isActive ? 'active' : ''} ${isInactive ? 'opacity-50' : ''}"
                         onclick="seleccionarArea('${area.area_id}')">
                        <div>
                            <div class="area-name">${area.area_name}</div>
                            ${area.area_description ? `<small class="text-muted">${area.area_description}</small>` : ''}
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-secondary badge-count" title="Asignaturas">${subjectCount}</span>
                            <div class="dropdown" onclick="event.stopPropagation()">
                                <button class="btn btn-sm btn-outline-secondary border-0" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="editarArea('${area.area_id}')">
                                        <i class="bi bi-pencil me-2"></i>Editar
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="toggleAreaStatus('${area.area_id}', '${area.area_status}')">
                                        <i class="bi bi-${isInactive ? 'check-circle' : 'x-circle'} me-2"></i>
                                        ${isInactive ? 'Activar' : 'Desactivar'}
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // ==========================================
        // SELECCIONAR √ÅREA ‚Üí CARGAR ASIGNATURAS
        // ==========================================
        async function seleccionarArea(areaId) {
            areaSeleccionada = areas.find(a => a.area_id === areaId);
            if (!areaSeleccionada) return;

            renderizarAreas(); // Actualizar selecci√≥n visual

            document.getElementById('tituloAsignaturas').textContent = `Asignaturas de ${areaSeleccionada.area_name}`;
            document.getElementById('btnNuevaAsignatura').style.display = 'inline-block';

            await cargarAsignaturas(areaId);
        }

        async function cargarAsignaturas(areaId) {
            const container = document.getElementById('asignaturasContainer');
            container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

            try {
                const asignaturas = await supabaseRequest(
                    `/academic_subjects?select=subject_id,subject_name,subject_description,subject_order,subject_status,academic_subject_grades(grade_id,grades(grade_name))&area_id=eq.${areaId}&order=subject_order.nullslast,subject_name`
                );

                if (!asignaturas || asignaturas.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-book"></i>
                            <p>No hay asignaturas en esta √°rea</p>
                            <button class="btn btn-sm btn-primary" onclick="abrirModalAsignatura()">
                                <i class="bi bi-plus-circle me-1"></i>Crear primera asignatura
                            </button>
                        </div>`;
                    return;
                }

                let html = `
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Asignatura</th>
                                    <th>Grados</th>
                                    <th>Estado</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>`;

                asignaturas.forEach(s => {
                    const isInactive = s.subject_status === 'inactive';
                    const gradosAsignados = (s.academic_subject_grades || [])
                        .map(sg => sg.grades?.grade_name)
                        .filter(Boolean)
                        .sort();

                    const gradosBadges = gradosAsignados.length > 0
                        ? gradosAsignados.map(g => `<span class="badge bg-info grade-badge">${g}</span>`).join(' ')
                        : '<span class="text-muted small">Sin grados</span>';

                    html += `
                        <tr class="subject-row ${isInactive ? 'opacity-50' : ''}">
                            <td>
                                <strong>${s.subject_name}</strong>
                                ${s.subject_description ? `<br><small class="text-muted">${s.subject_description}</small>` : ''}
                            </td>
                            <td>${gradosBadges}</td>
                            <td>
                                <span class="badge bg-${isInactive ? 'secondary' : 'success'}">${isInactive ? 'Inactiva' : 'Activa'}</span>
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editarAsignatura('${s.subject_id}')" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-${isInactive ? 'success' : 'warning'}" onclick="toggleAsignaturaStatus('${s.subject_id}', '${s.subject_status}')" title="${isInactive ? 'Activar' : 'Desactivar'}">
                                    <i class="bi bi-${isInactive ? 'check-circle' : 'x-circle'}"></i>
                                </button>
                            </td>
                        </tr>`;
                });

                html += '</tbody></table></div>';
                container.innerHTML = html;

            } catch (error) {
                console.error('‚ùå Error cargando asignaturas:', error);
                container.innerHTML = '<div class="text-center text-danger py-4">Error al cargar asignaturas</div>';
            }
        }

        // ==========================================
        // MODAL √ÅREA: Crear / Editar
        // ==========================================
        function abrirModalArea(areaId = null) {
            document.getElementById('formArea').reset();
            document.getElementById('areaId').value = '';

            if (areaId) {
                const area = areas.find(a => a.area_id === areaId);
                if (!area) return;
                document.getElementById('modalAreaTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar √Årea';
                document.getElementById('areaId').value = area.area_id;
                document.getElementById('areaNombre').value = area.area_name;
                document.getElementById('areaDescripcion').value = area.area_description || '';
                document.getElementById('areaOrden').value = area.area_order || '';
            } else {
                document.getElementById('modalAreaTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nueva √Årea';
            }

            modalAreaInstance.show();
        }

        function editarArea(areaId) {
            abrirModalArea(areaId);
        }

        async function guardarArea(event) {
            event.preventDefault();
            const btn = document.getElementById('btnGuardarArea');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';

            try {
                const areaId = document.getElementById('areaId').value;
                const data = {
                    area_name: document.getElementById('areaNombre').value.trim(),
                    area_description: document.getElementById('areaDescripcion').value.trim() || null,
                    area_order: document.getElementById('areaOrden').value ? parseInt(document.getElementById('areaOrden').value) : null
                };

                if (!data.area_name) {
                    showMessage('El nombre del √°rea es obligatorio', 'warning');
                    return;
                }

                if (areaId) {
                    await supabaseRequest(`/academic_areas?area_id=eq.${areaId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(data)
                    });
                    showMessage('√Årea actualizada correctamente', 'success');
                } else {
                    await supabaseRequest('/academic_areas', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showMessage('√Årea creada correctamente', 'success');
                }

                modalAreaInstance.hide();
                await cargarAreas();

                // Si se edit√≥ el √°rea seleccionada, refrescar t√≠tulo
                if (areaId && areaSeleccionada && areaSeleccionada.area_id === areaId) {
                    areaSeleccionada = areas.find(a => a.area_id === areaId);
                    if (areaSeleccionada) {
                        document.getElementById('tituloAsignaturas').textContent = `Asignaturas de ${areaSeleccionada.area_name}`;
                    }
                }

            } catch (error) {
                console.error('‚ùå Error guardando √°rea:', error);
                if (error.message.includes('unique') || error.message.includes('duplicate')) {
                    showMessage('Ya existe un √°rea con ese nombre', 'danger');
                } else {
                    showMessage('Error al guardar el √°rea: ' + error.message, 'danger');
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar';
            }
        }

        async function toggleAreaStatus(areaId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            const accion = newStatus === 'active' ? 'activar' : 'desactivar';

            if (!confirm(`¬øEst√° seguro de ${accion} esta √°rea?`)) return;

            try {
                await supabaseRequest(`/academic_areas?area_id=eq.${areaId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ area_status: newStatus })
                });
                showMessage(`√Årea ${newStatus === 'active' ? 'activada' : 'desactivada'} correctamente`, 'success');
                await cargarAreas();
            } catch (error) {
                console.error('‚ùå Error:', error);
                showMessage('Error al cambiar el estado del √°rea', 'danger');
            }
        }

        // ==========================================
        // MODAL ASIGNATURA: Crear / Editar
        // ==========================================
        function renderizarCheckboxGrados(gradosSeleccionados = []) {
            const container = document.getElementById('gradosCheckboxContainer');

            if (!grados || grados.length === 0) {
                container.innerHTML = '<div class="text-muted">No hay grados disponibles</div>';
                return;
            }

            // Agrupar grados por secci√≥n
            const porSeccion = {};
            grados.forEach(g => {
                const seccion = g.sections?.section_name || 'Sin secci√≥n';
                if (!porSeccion[seccion]) porSeccion[seccion] = [];
                porSeccion[seccion].push(g);
            });

            let html = '';
            Object.keys(porSeccion).forEach(seccion => {
                html += `<div class="mb-2">
                    <strong class="small text-secondary">${seccion}</strong>
                    <div class="ms-2">`;
                porSeccion[seccion].forEach(g => {
                    const checked = gradosSeleccionados.includes(g.grade_id) ? 'checked' : '';
                    html += `
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="grado_${g.grade_id}" value="${g.grade_id}" ${checked}>
                            <label class="form-check-label small" for="grado_${g.grade_id}">${g.grade_name}</label>
                        </div>`;
                });
                html += '</div></div>';
            });

            container.innerHTML = html;
        }

        function abrirModalAsignatura(subjectId = null) {
            document.getElementById('formAsignatura').reset();
            document.getElementById('asignaturaId').value = '';
            renderizarCheckboxGrados([]);

            document.getElementById('modalAsignaturaTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nueva Asignatura';
            modalAsignaturaInstance.show();
        }

        async function editarAsignatura(subjectId) {
            try {
                const data = await supabaseRequest(
                    `/academic_subjects?select=*,academic_subject_grades(grade_id)&subject_id=eq.${subjectId}`
                );
                if (!data || data.length === 0) return;

                const s = data[0];
                document.getElementById('formAsignatura').reset();
                document.getElementById('modalAsignaturaTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Asignatura';
                document.getElementById('asignaturaId').value = s.subject_id;
                document.getElementById('asignaturaNombre').value = s.subject_name;
                document.getElementById('asignaturaDescripcion').value = s.subject_description || '';
                document.getElementById('asignaturaOrden').value = s.subject_order || '';

                const gradosSeleccionados = (s.academic_subject_grades || []).map(sg => sg.grade_id);
                renderizarCheckboxGrados(gradosSeleccionados);

                modalAsignaturaInstance.show();
            } catch (error) {
                console.error('‚ùå Error cargando asignatura:', error);
                showMessage('Error al cargar la asignatura', 'danger');
            }
        }

        async function guardarAsignatura(event) {
            event.preventDefault();
            const btn = document.getElementById('btnGuardarAsignatura');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';

            try {
                if (!areaSeleccionada) {
                    showMessage('Debe seleccionar un √°rea primero', 'warning');
                    return;
                }

                const subjectId = document.getElementById('asignaturaId').value;
                const gradosSeleccionados = Array.from(
                    document.querySelectorAll('#gradosCheckboxContainer input[type="checkbox"]:checked')
                ).map(cb => cb.value);

                if (gradosSeleccionados.length === 0) {
                    showMessage('Debe seleccionar al menos un grado', 'warning');
                    return;
                }

                const data = {
                    area_id: areaSeleccionada.area_id,
                    subject_name: document.getElementById('asignaturaNombre').value.trim(),
                    subject_description: document.getElementById('asignaturaDescripcion').value.trim() || null,
                    subject_order: document.getElementById('asignaturaOrden').value ? parseInt(document.getElementById('asignaturaOrden').value) : null
                };

                if (!data.subject_name) {
                    showMessage('El nombre de la asignatura es obligatorio', 'warning');
                    return;
                }

                let savedSubjectId = subjectId;

                if (subjectId) {
                    // Editar asignatura
                    await supabaseRequest(`/academic_subjects?subject_id=eq.${subjectId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(data)
                    });

                    // Eliminar grados anteriores
                    await supabaseRequest(`/academic_subject_grades?subject_id=eq.${subjectId}`, {
                        method: 'DELETE'
                    });
                } else {
                    // Crear asignatura
                    const result = await supabaseRequest('/academic_subjects', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    savedSubjectId = result[0].subject_id;
                }

                // Insertar grados seleccionados
                if (gradosSeleccionados.length > 0) {
                    const gradosData = gradosSeleccionados.map(gradeId => ({
                        subject_id: savedSubjectId,
                        grade_id: gradeId
                    }));

                    await supabaseRequest('/academic_subject_grades', {
                        method: 'POST',
                        body: JSON.stringify(gradosData)
                    });
                }

                showMessage(subjectId ? 'Asignatura actualizada correctamente' : 'Asignatura creada correctamente', 'success');
                modalAsignaturaInstance.hide();

                // Recargar
                await cargarAreas();
                await cargarAsignaturas(areaSeleccionada.area_id);

            } catch (error) {
                console.error('‚ùå Error guardando asignatura:', error);
                if (error.message.includes('unique') || error.message.includes('duplicate')) {
                    showMessage('Ya existe una asignatura con ese nombre en esta √°rea', 'danger');
                } else {
                    showMessage('Error al guardar la asignatura: ' + error.message, 'danger');
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar';
            }
        }

        async function toggleAsignaturaStatus(subjectId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            const accion = newStatus === 'active' ? 'activar' : 'desactivar';

            if (!confirm(`¬øEst√° seguro de ${accion} esta asignatura?`)) return;

            try {
                await supabaseRequest(`/academic_subjects?subject_id=eq.${subjectId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ subject_status: newStatus })
                });
                showMessage(`Asignatura ${newStatus === 'active' ? 'activada' : 'desactivada'} correctamente`, 'success');
                await cargarAreas();
                if (areaSeleccionada) await cargarAsignaturas(areaSeleccionada.area_id);
            } catch (error) {
                console.error('‚ùå Error:', error);
                showMessage('Error al cambiar el estado de la asignatura', 'danger');
            }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function showLoading(btnId) {
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.disabled = true;
                btn.dataset.originalText = btn.innerHTML;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Procesando...';
            }
        }

        function hideLoading(btnId) {
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = btn.dataset.originalText || 'Guardar';
            }
        }

        console.log('‚úÖ P√°gina √Åreas y Asignaturas cargada');
    </script>
</body>
</html>
