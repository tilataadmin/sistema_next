<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.24.18.30">
    <title>Asignaci√≥n Acad√©mica - SchoolNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center;
            align-items: center; z-index: 9999;
        }
        .loading-overlay.hidden { display: none; }
        .loading-content { background: white; padding: 2rem; border-radius: 8px; text-align: center; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .assignment-table th {
            position: sticky;
            top: 0;
            background: #212529;
            color: white;
            z-index: 2;
            white-space: nowrap;
        }
        .assignment-table td {
            vertical-align: middle;
        }
        .assignment-table .subject-cell {
            position: sticky;
            left: 0;
            background: #f8f9fa;
            z-index: 1;
            min-width: 200px;
            font-weight: 500;
        }
        .assignment-table .area-label {
            font-size: 0.7rem;
            color: #6c757d;
            display: block;
        }
        .assignment-table select {
            min-width: 180px;
            font-size: 0.85rem;
        }
        .assignment-table select.is-assigned {
            border-color: #198754;
            background-color: #f0fdf4;
        }
        .btn-apply-all {
            font-size: 0.7rem;
            padding: 2px 6px;
            white-space: nowrap;
        }
        .filter-bar {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem 1.5rem;
        }
        .stats-bar .stat-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 3rem;
            display: block;
            margin-bottom: 1rem;
        }
        .has-changes {
            border-left: 3px solid #ffc107;
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Configuraci√≥n</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Asignaci√≥n Acad√©mica</li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-3">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-person-workspace me-2"></i>Asignaci√≥n Acad√©mica
                </h1>
                <p class="text-muted">Asigne docentes a cada asignatura por curso y a√±o acad√©mico.</p>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- Barra de filtros -->
        <div class="filter-bar mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="selectAnio" class="form-label fw-bold">
                        <i class="bi bi-calendar3 me-1"></i>A√±o Acad√©mico
                    </label>
                    <select class="form-select" id="selectAnio" onchange="onCambioFiltros()">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="selectGrado" class="form-label fw-bold">
                        <i class="bi bi-mortarboard me-1"></i>Grado
                    </label>
                    <select class="form-select" id="selectGrado" onchange="onCambioFiltros()">
                        <option value="">Seleccione un grado</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end gap-2">
                    <button class="btn btn-primary" id="btnGuardar" onclick="guardarAsignaciones()" disabled>
                        <i class="bi bi-check-circle me-1"></i>Guardar Cambios
                    </button>
                </div>
                <div class="col-md-3 d-flex align-items-end justify-content-end">
                    <div class="stats-bar" id="statsBar">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Grilla de asignaci√≥n -->
        <div class="card">
            <div class="card-body p-0" id="gridContainer">
                <div class="empty-state">
                    <i class="bi bi-funnel"></i>
                    <p>Seleccione un a√±o acad√©mico y un grado para ver la grilla de asignaci√≥n</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let aniosAcademicos = [];
        let gradosDisponibles = [];
        let docentes = [];
        let asignaturasDelGrado = [];
        let cursosDelGrado = [];
        let asignacionesActuales = {}; // clave: "subjectId_courseId" ‚Üí worker_id
        let asignacionesOriginales = {}; // para detectar cambios
        let hayCambios = false;
        let currentUserId = null;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Validando acceso...');
            try {
                const hasAccess = await validatePageAccess('Asignaci√≥n acad√©mica');
                if (!hasAccess) return;

                console.log('‚úÖ Acceso permitido');

                const session = getStoredSession();
                currentUserId = session?.user?.user_id || null;

                await cargarAniosAcademicos();
                await cargarGrados();
                await cargarDocentes();

                console.log('‚úÖ P√°gina inicializada correctamente');
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGAR DATOS MAESTROS
        // ==========================================
        async function cargarAniosAcademicos() {
            try {
                aniosAcademicos = await supabaseRequest(
                    '/academic_years?select=year_id,year_name,is_current&year_status=eq.active&order=year_order.desc'
                );

                const select = document.getElementById('selectAnio');
                select.innerHTML = '<option value="">Seleccione a√±o</option>';
                aniosAcademicos.forEach(a => {
                    const current = a.is_current ? ' (Actual)' : '';
                    select.innerHTML += `<option value="${a.year_id}" ${a.is_current ? 'selected' : ''}>${a.year_name}${current}</option>`;
                });

                console.log(`‚úÖ ${aniosAcademicos.length} a√±os acad√©micos cargados`);
            } catch (error) {
                console.error('‚ùå Error cargando a√±os:', error);
            }
        }

        async function cargarGrados() {
            try {
                gradosDisponibles = await supabaseRequest(
                    '/grades?select=grade_id,grade_name,section_id,sections(section_name)&grade_status=eq.active&order=grade_order'
                );

                const select = document.getElementById('selectGrado');
                select.innerHTML = '<option value="">Seleccione un grado</option>';

                // Agrupar por secci√≥n
                const porSeccion = {};
                gradosDisponibles.forEach(g => {
                    const sec = g.sections?.section_name || 'Sin secci√≥n';
                    if (!porSeccion[sec]) porSeccion[sec] = [];
                    porSeccion[sec].push(g);
                });

                Object.keys(porSeccion).forEach(sec => {
                    select.innerHTML += `<optgroup label="${sec}">`;
                    porSeccion[sec].forEach(g => {
                        select.innerHTML += `<option value="${g.grade_id}">${g.grade_name}</option>`;
                    });
                    select.innerHTML += '</optgroup>';
                });

                console.log(`‚úÖ ${gradosDisponibles.length} grados cargados`);
            } catch (error) {
                console.error('‚ùå Error cargando grados:', error);
            }
        }

        async function cargarDocentes() {
            try {
                // Cargar todos los workers activos ‚Äî el usuario filtrar√° visualmente
                // Se incluyen todos porque un worker puede dictar clase sin tener rol "Docente"
                const workers = await supabaseRequest(
                    '/workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2&worker_status=eq.active&order=worker_last_name_1,worker_first_name'
                );

                docentes = sortWorkersByName(workers || []);
                console.log(`‚úÖ ${docentes.length} workers cargados para asignaci√≥n`);
            } catch (error) {
                console.error('‚ùå Error cargando docentes:', error);
                docentes = [];
            }
        }

        // ==========================================
        // CAMBIO DE FILTROS
        // ==========================================
        async function onCambioFiltros() {
            const anioId = document.getElementById('selectAnio').value;
            const gradoId = document.getElementById('selectGrado').value;

            if (!anioId || !gradoId) {
                document.getElementById('gridContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-funnel"></i>
                        <p>Seleccione un a√±o acad√©mico y un grado para ver la grilla de asignaci√≥n</p>
                    </div>`;
                document.getElementById('btnGuardar').disabled = true;
                document.getElementById('statsBar').innerHTML = '';
                return;
            }

            // Verificar cambios sin guardar
            if (hayCambios) {
                if (!confirm('Hay cambios sin guardar. ¬øDesea continuar sin guardar?')) return;
            }

            await cargarGrilla(anioId, gradoId);
        }

        // ==========================================
        // CARGAR GRILLA
        // ==========================================
        async function cargarGrilla(anioId, gradoId) {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><p class="mt-2">Cargando asignaciones...</p></div>';

            try {
                // 1. Cargar asignaturas que aplican a este grado
                const subjectGrades = await supabaseRequest(
                    `/academic_subject_grades?select=subject_id,academic_subjects(subject_id,subject_name,subject_order,subject_status,area_id,academic_areas(area_name))&grade_id=eq.${gradoId}`
                );

                asignaturasDelGrado = (subjectGrades || [])
                    .map(sg => sg.academic_subjects)
                    .filter(s => s && s.subject_status === 'active')
                    .sort((a, b) => {
                        // Ordenar por √°rea y luego por orden/nombre
                        const areaA = a.academic_areas?.area_name || '';
                        const areaB = b.academic_areas?.area_name || '';
                        if (areaA !== areaB) return areaA.localeCompare(areaB);
                        if (a.subject_order && b.subject_order) return a.subject_order - b.subject_order;
                        return a.subject_name.localeCompare(b.subject_name);
                    });

                // 2. Cargar cursos del grado
                cursosDelGrado = await supabaseRequest(
                    `/courses?select=course_id,course_name&grade_id=eq.${gradoId}&course_status=eq.active&order=course_name`
                );

                if (!asignaturasDelGrado.length || !cursosDelGrado.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-exclamation-circle"></i>
                            <p>${!asignaturasDelGrado.length ? 'No hay asignaturas configuradas para este grado.' : 'No hay cursos activos para este grado.'}</p>
                            ${!asignaturasDelGrado.length ? '<a href="academic-areas.html" class="btn btn-sm btn-primary mt-2"><i class="bi bi-gear me-1"></i>Ir a √Åreas y Asignaturas</a>' : ''}
                        </div>`;
                    document.getElementById('btnGuardar').disabled = true;
                    return;
                }

                // 3. Cargar asignaciones existentes para este a√±o + estos cursos
                const courseIds = cursosDelGrado.map(c => c.course_id);
                const subjectIds = asignaturasDelGrado.map(s => s.subject_id);

                const asignaciones = await supabaseRequest(
                    `/academic_assignments?select=assignment_id,subject_id,course_id,worker_id&academic_year_id=eq.${anioId}&course_id=in.(${courseIds.join(',')})&subject_id=in.(${subjectIds.join(',')})&assignment_status=eq.active`
                );

                // Mapear asignaciones existentes
                asignacionesActuales = {};
                asignacionesOriginales = {};
                (asignaciones || []).forEach(a => {
                    const key = `${a.subject_id}_${a.course_id}`;
                    asignacionesActuales[key] = a.worker_id;
                    asignacionesOriginales[key] = a.worker_id;
                });

                // 4. Renderizar grilla
                renderizarGrilla();
                actualizarEstadisticas();
                hayCambios = false;
                document.getElementById('btnGuardar').disabled = true;

            } catch (error) {
                console.error('‚ùå Error cargando grilla:', error);
                container.innerHTML = '<div class="text-center text-danger py-4">Error al cargar la grilla de asignaci√≥n</div>';
            }
        }

        // ==========================================
        // RENDERIZAR GRILLA
        // ==========================================
        function renderizarGrilla() {
            const container = document.getElementById('gridContainer');

            let html = `
                <div class="table-responsive" style="max-height: 70vh; overflow: auto;">
                    <table class="table table-bordered table-sm mb-0 assignment-table">
                        <thead>
                            <tr>
                                <th class="subject-cell" style="background: #212529; z-index: 3;">Asignatura</th>`;

            // Headers: cursos
            cursosDelGrado.forEach(c => {
                html += `<th class="text-center">${c.course_name}</th>`;
            });
            html += `<th class="text-center" style="min-width: 100px;">Acciones</th></tr></thead><tbody>`;

            // Filas: asignaturas agrupadas por √°rea
            let areaActual = '';
            asignaturasDelGrado.forEach(s => {
                const areaName = s.academic_areas?.area_name || 'Sin √°rea';

                // Separador de √°rea
                if (areaName !== areaActual) {
                    areaActual = areaName;
                    html += `
                        <tr class="table-light">
                            <td colspan="${cursosDelGrado.length + 2}" class="fw-bold small text-secondary py-1 ps-2">
                                <i class="bi bi-collection me-1"></i>${areaName}
                            </td>
                        </tr>`;
                }

                html += `<tr id="row_${s.subject_id}">`;
                html += `<td class="subject-cell">${s.subject_name}</td>`;

                // Celdas: un select por curso
                cursosDelGrado.forEach(c => {
                    const key = `${s.subject_id}_${c.course_id}`;
                    const currentWorker = asignacionesActuales[key] || '';
                    const isAssigned = currentWorker ? 'is-assigned' : '';

                    html += `
                        <td class="p-1">
                            <select class="form-select form-select-sm ${isAssigned}"
                                    id="sel_${key}"
                                    onchange="onCambioAsignacion('${s.subject_id}', '${c.course_id}', this)">
                                <option value="">‚Äî Sin asignar ‚Äî</option>
                                ${generarOpcionesDocentes(currentWorker)}
                            </select>
                        </td>`;
                });

                // Bot√≥n aplicar a todos
                html += `
                    <td class="text-center p-1">
                        <button class="btn btn-outline-secondary btn-apply-all"
                                onclick="aplicarATodos('${s.subject_id}')"
                                title="Aplicar el docente del primer curso a todos los dem√°s">
                            <i class="bi bi-arrow-right-circle me-1"></i>Aplicar a todos
                        </button>
                    </td>`;

                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function generarOpcionesDocentes(selectedId) {
            return docentes.map(d => {
                const nombre = formatWorkerName(d);
                const selected = d.worker_id === selectedId ? 'selected' : '';
                return `<option value="${d.worker_id}" ${selected}>${nombre}</option>`;
            }).join('');
        }

        // ==========================================
        // INTERACCIONES DE LA GRILLA
        // ==========================================
        function onCambioAsignacion(subjectId, courseId, selectElement) {
            const key = `${subjectId}_${courseId}`;
            const newValue = selectElement.value || null;

            if (newValue) {
                asignacionesActuales[key] = newValue;
                selectElement.classList.add('is-assigned');
            } else {
                delete asignacionesActuales[key];
                selectElement.classList.remove('is-assigned');
            }

            detectarCambios();
        }

        function aplicarATodos(subjectId) {
            if (!cursosDelGrado.length) return;

            // Tomar el valor del primer curso
            const primerKey = `${subjectId}_${cursosDelGrado[0].course_id}`;
            const primerSelect = document.getElementById(`sel_${primerKey}`);
            const valorPrimero = primerSelect ? primerSelect.value : '';

            if (!valorPrimero) {
                showMessage('Primero asigne un docente en el primer curso de esta asignatura', 'warning');
                return;
            }

            // Aplicar a todos los cursos
            cursosDelGrado.forEach(c => {
                const key = `${subjectId}_${c.course_id}`;
                const select = document.getElementById(`sel_${key}`);
                if (select) {
                    select.value = valorPrimero;
                    asignacionesActuales[key] = valorPrimero;
                    select.classList.add('is-assigned');
                }
            });

            detectarCambios();
            showMessage('Docente aplicado a todos los cursos de esta asignatura', 'info');
        }

        function detectarCambios() {
            // Comparar actual vs original
            const todasLasClaves = new Set([
                ...Object.keys(asignacionesActuales),
                ...Object.keys(asignacionesOriginales)
            ]);

            hayCambios = false;
            for (const key of todasLasClaves) {
                const actual = asignacionesActuales[key] || null;
                const original = asignacionesOriginales[key] || null;
                if (actual !== original) {
                    hayCambios = true;
                    break;
                }
            }

            document.getElementById('btnGuardar').disabled = !hayCambios;
            actualizarEstadisticas();
        }

        // ==========================================
        // GUARDAR ASIGNACIONES
        // ==========================================
        async function guardarAsignaciones() {
            const anioId = document.getElementById('selectAnio').value;
            const gradoId = document.getElementById('selectGrado').value;

            if (!anioId || !gradoId) {
                showMessage('Seleccione a√±o y grado', 'warning');
                return;
            }

            const btn = document.getElementById('btnGuardar');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Guardando...';

            try {
                const courseIds = cursosDelGrado.map(c => c.course_id);
                const subjectIds = asignaturasDelGrado.map(s => s.subject_id);

                // 1. Eliminar asignaciones existentes para este a√±o + grado (cursos del grado)
                await supabaseRequest(
                    `/academic_assignments?academic_year_id=eq.${anioId}&course_id=in.(${courseIds.join(',')})&subject_id=in.(${subjectIds.join(',')})`,
                    { method: 'DELETE' }
                );

                // 2. Insertar todas las asignaciones actuales
                const nuevasAsignaciones = [];
                Object.entries(asignacionesActuales).forEach(([key, workerId]) => {
                    if (workerId) {
                        const [subjectId, courseId] = key.split('_');
                        nuevasAsignaciones.push({
                            academic_year_id: anioId,
                            subject_id: subjectId,
                            course_id: courseId,
                            worker_id: workerId,
                            assigned_by: currentUserId
                        });
                    }
                });

                if (nuevasAsignaciones.length > 0) {
                    await supabaseRequest('/academic_assignments', {
                        method: 'POST',
                        body: JSON.stringify(nuevasAsignaciones)
                    });
                }

                // Actualizar originales
                asignacionesOriginales = { ...asignacionesActuales };
                hayCambios = false;
                actualizarEstadisticas();

                showMessage(`Asignaciones guardadas correctamente (${nuevasAsignaciones.length} asignaciones)`, 'success');

            } catch (error) {
                console.error('‚ùå Error guardando:', error);
                showMessage('Error al guardar las asignaciones: ' + error.message, 'danger');
            } finally {
                btn.disabled = !hayCambios;
                btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar Cambios';
            }
        }

        // ==========================================
        // ESTAD√çSTICAS
        // ==========================================
        function actualizarEstadisticas() {
            const totalCeldas = asignaturasDelGrado.length * cursosDelGrado.length;
            const asignadas = Object.keys(asignacionesActuales).filter(k => asignacionesActuales[k]).length;
            const sinAsignar = totalCeldas - asignadas;
            const porcentaje = totalCeldas > 0 ? Math.round((asignadas / totalCeldas) * 100) : 0;

            const statsBar = document.getElementById('statsBar');
            let html = '';

            if (totalCeldas > 0) {
                const color = porcentaje === 100 ? 'success' : porcentaje >= 50 ? 'warning' : 'danger';
                html = `
                    <span class="stat-item bg-${color} bg-opacity-10 text-${color}">
                        <i class="bi bi-check-circle"></i> ${asignadas}/${totalCeldas} (${porcentaje}%)
                    </span>`;

                if (hayCambios) {
                    html += `<span class="stat-item bg-warning bg-opacity-10 text-warning ms-2">
                        <i class="bi bi-exclamation-triangle"></i> Sin guardar
                    </span>`;
                }
            }

            statsBar.innerHTML = html;
        }

        // ==========================================
        // PREVENIR NAVEGACI√ìN CON CAMBIOS
        // ==========================================
        window.addEventListener('beforeunload', function(e) {
            if (hayCambios) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        console.log('‚úÖ P√°gina Asignaci√≥n Acad√©mica cargada');
    </script>
</body>
</html>
