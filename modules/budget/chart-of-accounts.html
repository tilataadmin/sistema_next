<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de PUC - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        .search-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .form-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }
        
        .form-card.edit-mode {
            border-left: 5px solid #ffc107;
            background-color: #fff8e1;
        }
        
        .results-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .account-table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .account-table thead {
            background: linear-gradient(45deg, #2c5530, #3d7c47);
            color: white;
        }
        
        .account-table tbody tr:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        
        .account-code {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #2c5530;
            background-color: #e8f5e8;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .btn-action {
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }
        
        .stats-row {
            margin-bottom: 1rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .edit-indicator {
            background: linear-gradient(45deg, #ffc107, #ffeb3b);
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
        }
        
        .search-highlight {
            background-color: #fff3cd;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
        }
        
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .stat-card {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Contenedor principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Presupuesto</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Plan Único de Cuentas
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-diagram-3 me-2"></i>
                    Plan Único de Cuentas (PUC)
                </h1>
                <p class="text-muted">
                    Gestión del catálogo de cuentas contables
                </p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>
        
        <!-- Statistics Row -->
        <div class="row stats-row">
            <div class="col-md-3 col-sm-6">
                <div class="stat-card">
                    <div class="stat-icon text-primary">
                        <i class="bi bi-list-ul"></i>
                    </div>
                    <h4 class="mb-1" id="totalAccounts">0</h4>
                    <p class="text-muted mb-0">Total Cuentas</p>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stat-card">
                    <div class="stat-icon text-success">
                        <i class="bi bi-search"></i>
                    </div>
                    <h4 class="mb-1" id="searchResults">0</h4>
                    <p class="text-muted mb-0">Resultados</p>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stat-card">
                    <div class="stat-icon text-warning">
                        <i class="bi bi-plus-circle"></i>
                    </div>
                    <h4 class="mb-1" id="newAccountsToday">0</h4>
                    <p class="text-muted mb-0">Nuevas Hoy</p>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stat-card">
                    <div class="stat-icon text-info">
                        <i class="bi bi-pencil"></i>
                    </div>
                    <h4 class="mb-1" id="lastUpdate">--</h4>
                    <p class="text-muted mb-0">Última Actualización</p>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="card search-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-search"></i> Buscar Cuentas PUC
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input 
                                type="text" 
                                id="searchInput" 
                                class="form-control form-control-lg"
                                placeholder="Buscar por código o nombre de cuenta..."
                                maxlength="100"
                            >
                            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <small class="text-muted">
                            Ingrese al menos 2 caracteres para buscar
                        </small>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg" onclick="showNewAccountForm()">
                                <i class="bi bi-plus-circle"></i> Nueva Cuenta PUC
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <div id="searchInfo" class="text-muted">
                            Use el buscador para encontrar cuentas PUC o cree una nueva
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Section -->
        <div class="card form-card d-none" id="accountForm">
            <div id="editIndicator" class="edit-indicator d-none">
                <i class="bi bi-pencil-square"></i> Editando cuenta PUC
            </div>
            
            <div class="card-header">
                <h5 class="mb-0" id="formTitle">
                    <i class="bi bi-plus-circle"></i> Nueva Cuenta PUC
                </h5>
            </div>
            <div class="card-body">
                <form id="pucForm">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="accountCode" class="form-label">
                                    Código PUC <span class="text-danger">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control form-control-lg" 
                                    id="accountCode"
                                    maxlength="20"
                                    placeholder="Ej: 1105"
                                    required
                                >
                                <div class="form-text">
                                    Código único de la cuenta (máximo 20 caracteres)
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="accountName" class="form-label">
                                    Nombre de la Cuenta <span class="text-danger">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control form-control-lg" 
                                    id="accountName"
                                    maxlength="200"
                                    placeholder="Ej: Caja General"
                                    required
                                >
                                <div class="form-text">
                                    Nombre descriptivo de la cuenta (máximo 200 caracteres)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success" id="saveButton">
                                    <i class="bi bi-check-lg"></i> <span id="saveButtonText">Crear Cuenta</span>
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="hideAccountForm()">
                                    <i class="bi bi-x-lg"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card results-card">
            <div class="card-header bg-gradient text-white" style="background: linear-gradient(45deg, #2c5530, #3d7c47);">
                <h5 class="mb-0">
                    <i class="bi bi-table"></i> Cuentas PUC Registradas
                </h5>
            </div>
            <div class="card-body p-0">
                <div id="accountsContent">
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <h5>No hay cuentas registradas</h5>
                        <p>Use el buscador superior o cree una nueva cuenta PUC</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <h5>Procesando...</h5>
            <p class="text-muted mb-0">Por favor espere</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Config JS -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // Variables globales
        let currentUser = null;
        let currentEditCode = null;
        let accountsData = [];
        let searchTimeout = null;
        let isSearching = false;

        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                // Validar acceso antes de continuar
                const hasAccess = await validatePageAccess('Gestionar PUC');
                if (!hasAccess) {
                    console.log('❌ Acceso denegado - deteniendo inicialización');
                    return;
                }
                
                console.log('✅ Acceso permitido - continuando con inicialización');
                
                // Inicializar página
                initializePage('chartOfAccounts', 'Presupuesto');
                
                // Configurar eventos
                setupEventListeners();
                
                // Cargar estadísticas iniciales
                await loadStats();
                
                console.log('✅ Página inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error en validación de acceso:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });

        function setupEventListeners() {
            // Búsqueda en tiempo real
            document.getElementById('searchInput').addEventListener('input', function() {
                const term = this.value.trim();
                
                clearTimeout(searchTimeout);
                
                if (term.length >= 2) {
                    searchTimeout = setTimeout(() => {
                        searchAccounts(term);
                    }, 300);
                } else if (term.length === 0) {
                    clearResults();
                } else {
                    updateSearchInfo(0, term, 'Ingrese al menos 2 caracteres para buscar');
                }
            });

            // Formulario
            document.getElementById('pucForm').addEventListener('submit', handleFormSubmit);
            
            // Validación en tiempo real
            document.getElementById('accountCode').addEventListener('input', validateAccountCode);
            document.getElementById('accountName').addEventListener('input', validateAccountName);
        }

        async function loadStats() {
            try {
                showLoading();
                
                const accounts = await supabaseRequest('/chart_of_accounts?select=account_code,account_name,created_at,updated_at&order=account_code.asc');
                
                document.getElementById('totalAccounts').textContent = accounts ? accounts.length : 0;
                
                // Contar nuevas cuentas hoy
                const today = new Date().toISOString().split('T')[0];
                const newToday = accounts ? accounts.filter(a => 
                    a.created_at && a.created_at.startsWith(today)
                ).length : 0;
                
                document.getElementById('newAccountsToday').textContent = newToday;
                
                // Última actualización
                if (accounts && accounts.length > 0) {
                    const latest = accounts.reduce((latest, current) => 
                        new Date(current.created_at || current.updated_at || '1970-01-01') > 
                        new Date(latest.created_at || latest.updated_at || '1970-01-01') ? current : latest
                    );
                    document.getElementById('lastUpdate').textContent = formatDate(latest.updated_at || latest.created_at);
                } else {
                    document.getElementById('lastUpdate').textContent = '--';
                }
                
                // Si hay cuentas y no hay búsqueda activa, mostrar todas
                const searchInput = document.getElementById('searchInput');
                if (accounts && accounts.length > 0 && !searchInput.value.trim()) {
                    accountsData = accounts;
                    renderAccountsTable(accounts);
                    updateSearchInfo(accounts.length, '');
                    document.getElementById('searchResults').textContent = accounts.length;
                }
                
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            } finally {
                hideLoading();
            }
        }
        
        async function searchAccounts(term = '') {
            if (isSearching) return;
            
            isSearching = true;
            showLoading();
            
            try {
                let query = '/chart_of_accounts?select=*&order=account_code.asc';
                
                if (term) {
                    query += `&or=(account_code.ilike.*${term}*,account_name.ilike.*${term}*)`;
                }
                
                const results = await supabaseRequest(query);
                
                accountsData = results || [];
                renderAccountsTable(accountsData, term);
                updateSearchInfo(accountsData.length, term);
                document.getElementById('searchResults').textContent = accountsData.length;
                
            } catch (error) {
                console.error('Error buscando cuentas:', error);
                showMessage('Error al buscar cuentas PUC', 'danger');
                clearResults();
            } finally {
                hideLoading();
                isSearching = false;
            }
        }

        function renderAccountsTable(accounts, searchTerm = '') {
            const container = document.getElementById('accountsContent');
            
            if (accounts.length === 0) {
                const message = searchTerm ? 
                    `No se encontraron cuentas que coincidan con "${searchTerm}"` :
                    'No hay cuentas PUC registradas';
                    
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <h5>${message}</h5>
                        <p>${searchTerm ? 'Pruebe con otro término de búsqueda' : 'Cree una nueva cuenta PUC para comenzar'}</p>
                    </div>
                `;
                return;
            }
            
            const tableHtml = `
                <div class="table-responsive">
                    <table class="table account-table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 25%">Código PUC</th>
                                <th style="width: 55%">Nombre de la Cuenta</th>
                                <th style="width: 20%" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${accounts.map(account => `
                                <tr>
                                    <td>
                                        <span class="account-code">${highlightSearchTerm(account.account_code, searchTerm)}</span>
                                    </td>
                                    <td>${highlightSearchTerm(account.account_name, searchTerm)}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-warning btn-action" onclick="editAccount('${account.account_code}')" title="Editar cuenta">
                                                <i class="bi bi-pencil"></i> Editar
                                            </button>
                                            <button class="btn btn-danger btn-action" onclick="deleteAccount('${account.account_code}', '${escapeHtml(account.account_name)}')" title="Eliminar cuenta">
                                                <i class="bi bi-trash"></i> Eliminar
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }

        function highlightSearchTerm(text, term) {
            if (!term || !text) return escapeHtml(text || '');
            
            const escapedText = escapeHtml(text);
            const escapedTerm = escapeHtml(term);
            const regex = new RegExp(`(${escapedTerm})`, 'gi');
            
            return escapedText.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function updateSearchInfo(count, term, customMessage = '') {
            const infoElement = document.getElementById('searchInfo');
            
            if (customMessage) {
                infoElement.textContent = customMessage;
            } else if (term) {
                infoElement.textContent = `Se encontraron ${count} cuenta(s) que coinciden con "${term}"`;
            } else {
                infoElement.textContent = count > 0 ? 
                    `Mostrando ${count} cuenta(s) PUC` : 
                    'Use el buscador para encontrar cuentas PUC o cree una nueva';
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            clearResults();
            document.getElementById('searchResults').textContent = '0';
        }

        function clearResults() {
            const container = document.getElementById('accountsContent');
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h5>No hay cuentas registradas</h5>
                    <p>Use el buscador superior o cree una nueva cuenta PUC</p>
                </div>
            `;
            updateSearchInfo(0, '');
            accountsData = [];
        }

        // Funciones del formulario
        function showNewAccountForm() {
            currentEditCode = null;
            clearForm();
            
            document.getElementById('formTitle').innerHTML = '<i class="bi bi-plus-circle"></i> Nueva Cuenta PUC';
            document.getElementById('saveButtonText').textContent = 'Crear Cuenta';
            document.getElementById('editIndicator').classList.add('d-none');
            document.getElementById('accountForm').classList.remove('d-none', 'edit-mode');
            
            document.getElementById('accountForm').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('accountCode').focus();
        }

        function hideAccountForm() {
            currentEditCode = null;
            clearForm();
            document.getElementById('accountForm').classList.add('d-none');
            document.getElementById('accountForm').classList.remove('edit-mode');
        }

        function clearForm() {
            document.getElementById('pucForm').reset();
            
            document.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            
            document.querySelectorAll('.invalid-feedback').forEach(el => {
                el.remove();
            });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!validateForm()) return;
            
            const code = document.getElementById('accountCode').value.trim();
            const name = document.getElementById('accountName').value.trim();
            
            if (currentEditCode) {
                await updateAccount(currentEditCode, code, name);
            } else {
                await createAccount(code, name);
            }
        }

        function validateForm() {
            const code = document.getElementById('accountCode').value.trim();
            const name = document.getElementById('accountName').value.trim();
            let isValid = true;
            
            clearValidationErrors();
            
            if (!code) {
                showFieldError('accountCode', 'El código PUC es obligatorio');
                isValid = false;
            }
            
            if (!name) {
                showFieldError('accountName', 'El nombre de la cuenta es obligatorio');
                isValid = false;
            }
            
            return isValid;
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            field.classList.add('is-invalid');
            
            const feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            feedback.textContent = message;
            
            field.parentNode.appendChild(feedback);
        }

        function clearValidationErrors() {
            document.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            
            document.querySelectorAll('.invalid-feedback').forEach(el => {
                el.remove();
            });
        }

        async function createAccount(code, name) {
            try {
                showLoading();
                
                const newAccount = {
                    account_code: code,
                    account_name: name
                };
                
                await supabaseRequest('/chart_of_accounts', {
                    method: 'POST',
                    body: JSON.stringify(newAccount)
                });
                
                showMessage('Cuenta PUC creada exitosamente', 'success');
                hideAccountForm();
                
                await searchAccounts();
                await loadStats();
                
            } catch (error) {
                console.error('Error creando cuenta:', error);
                if (error.message.includes('duplicate key value')) {
                    showMessage('Ya existe una cuenta con ese código', 'danger');
                } else {
                    showMessage('Error al crear la cuenta PUC', 'danger');
                }
            } finally {
                hideLoading();
            }
        }

        async function editAccount(code) {
            try {
                showLoading();
                
                const account = await supabaseRequest(`/chart_of_accounts?account_code=eq.${code}`);
                
                if (!account || account.length === 0) {
                    showMessage('Cuenta no encontrada', 'danger');
                    return;
                }
                
                const accountData = account[0];
                currentEditCode = code;
                
                document.getElementById('accountCode').value = accountData.account_code;
                document.getElementById('accountName').value = accountData.account_name;
                
                document.getElementById('formTitle').innerHTML = '<i class="bi bi-pencil-square"></i> Editar Cuenta PUC';
                document.getElementById('saveButtonText').textContent = 'Actualizar Cuenta';
                document.getElementById('editIndicator').classList.remove('d-none');
                document.getElementById('accountForm').classList.remove('d-none');
                document.getElementById('accountForm').classList.add('edit-mode');
                
                document.getElementById('accountForm').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('accountCode').focus();
                
            } catch (error) {
                console.error('Error cargando cuenta:', error);
                showMessage('Error al cargar la cuenta', 'danger');
            } finally {
                hideLoading();
            }
        }

        async function updateAccount(originalCode, newCode, newName) {
            try {
                showLoading();
                
                const updatedAccount = {
                    account_code: newCode,
                    account_name: newName
                };
                
                await supabaseRequest(`/chart_of_accounts?account_code=eq.${originalCode}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updatedAccount)
                });
                
                showMessage('Cuenta PUC actualizada exitosamente', 'success');
                hideAccountForm();
                
                await searchAccounts();
                await loadStats();
                
            } catch (error) {
                console.error('Error actualizando cuenta:', error);
                if (error.message.includes('duplicate key value')) {
                    showMessage('Ya existe una cuenta con ese código o nombre', 'danger');
                } else {
                    showMessage('Error al actualizar la cuenta PUC', 'danger');
                }
            } finally {
                hideLoading();
            }
        }
        
        async function deleteAccount(code, name) {
            const confirmed = confirm(
                `¿Está seguro de que desea eliminar la cuenta PUC?\n\n` +
                `Código: ${code}\n` +
                `Nombre: ${name}\n\n` +
                `Esta acción no se puede deshacer.`
            );
            
            if (!confirmed) return;
            
            try {
                showLoading();
                
                await supabaseRequest(`/chart_of_accounts?account_code=eq.${code}`, {
                    method: 'DELETE'
                });
                
                showMessage('Cuenta PUC eliminada exitosamente', 'success');
                
                await searchAccounts();
                await loadStats();
                
            } catch (error) {
                console.error('Error eliminando cuenta:', error);
                showMessage('Error al eliminar la cuenta PUC', 'danger');
            } finally {
                hideLoading();
            }
        }

        function validateAccountCode() {
            const field = document.getElementById('accountCode');
            const value = field.value;
            
            if (value.length > 20) {
                field.value = value.substring(0, 20);
                showMessage('El código PUC no puede tener más de 20 caracteres', 'warning');
            }
        }

        function validateAccountName() {
            const field = document.getElementById('accountName');
            const value = field.value;
            
            if (value.length > 200) {
                field.value = value.substring(0, 200);
                showMessage('El nombre no puede tener más de 200 caracteres', 'warning');
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('d-none');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('d-none');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
