<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicializar a√±o presupuestal - Generales - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c5530;
            --secondary-color: #3d7c47;
            --success-color: #198754;
            --warning-color: #fd7e14;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .form-section {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
        }

        .form-section h4 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(61, 124, 71, 0.25);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .config-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #e9ecef;
        }

        .config-item label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .config-item small {
            color: #6c757d;
            font-style: italic;
        }

        .year-selector {
            background: var(--info-color);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert-custom {
            border: none;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
        }

        .btn-save {
            background: var(--success-color);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-save:hover {
            background: #157347;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .form-section {
                padding: 1rem;
            }
            
            .page-header {
                padding: 1rem 0;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando configuraci√≥n...</p>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard.html">
                <i class="bi bi-house-door"></i> SchoolNet
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/modules/budget/index.html">
                    <i class="bi bi-arrow-left"></i> Volver al M√≥dulo
                </a>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="bi bi-calendar-plus"></i> 
                        Inicializar a√±o presupuestal - Generales
                    </h1>
                    <p class="mb-0 fs-5">Configuraci√≥n de par√°metros generales del a√±o presupuestal</p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-light text-dark fs-6">
                        <i class="bi bi-gear"></i> Configuraci√≥n General
                    </span>
                </div>
            </div>
        </div>
    </div>

<!-- Main Content -->
    <div class="container">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Year Selection -->
        <div class="year-selector">
            <h4 class="mb-3">
                <i class="bi bi-calendar-check"></i> Selecci√≥n del A√±o Presupuestal
            </h4>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <select class="form-select form-select-lg" id="yearSelect" disabled>
                        <option value="">Cargando a√±os acad√©micos...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Configuration Form -->
        <form id="configForm" style="display: none;">
            
            <!-- Tolerance Settings -->
            <div class="form-section">
                <h4>
                    <i class="bi bi-exclamation-triangle text-warning"></i> 
                    Tolerancias de Ejecuci√≥n
                </h4>
                
                <div class="config-item">
                    <label for="overExecutionTolerance">Tolerancia de Sobreejecuci√≥n (%)</label>
                    <input type="number" class="form-control" id="overExecutionTolerance" 
                           min="0" max="100" step="1" value="10">
                    <small>Porcentaje m√°ximo permitido de sobreejecuci√≥n antes de requerir autorizaci√≥n especial</small>
                </div>
            </div>

            <!-- Alert Thresholds -->
            <div class="form-section">
                <h4>
                    <i class="bi bi-speedometer2 text-info"></i> 
                    Umbrales de Alertas
                </h4>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="config-item">
                            <label for="redThreshold">Umbral Rojo (%)</label>
                            <input type="number" class="form-control" id="redThreshold" 
                                   min="0" max="100" step="1" value="90">
                            <small>Ejecuci√≥n cr√≠tica - Requiere atenci√≥n inmediata</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="config-item">
                            <label for="yellowThreshold">Umbral Amarillo (%)</label>
                            <input type="number" class="form-control" id="yellowThreshold" 
                                   min="0" max="100" step="1" value="70">
                            <small>Ejecuci√≥n de precauci√≥n - Monitoreo requerido</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="config-item">
                            <label for="greenThreshold">Umbral Verde (%)</label>
                            <input type="number" class="form-control" id="greenThreshold" 
                                   min="0" max="100" step="1" value="50">
                            <small>Ejecuci√≥n normal - Estado √≥ptimo</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Responsible Persons -->
            <div class="form-section">
                <h4>
                    <i class="bi bi-person-badge text-primary"></i> 
                    Responsables del Sistema
                </h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="config-item">
                            <label for="buyerEmail">Email del Comprador</label>
                            <input type="email" class="form-control" id="buyerEmail" 
                                   placeholder="comprador@colegiotilata.edu.co">
                            <small>Responsable de las compras y adquisiciones</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-item">
                            <label for="budgetAdminEmail">Email del Administrador Presupuestal</label>
                            <input type="email" class="form-control" id="budgetAdminEmail" 
                                   placeholder="presupuesto@colegiotilata.edu.co">
                            <small>Responsable de la administraci√≥n del presupuesto</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legal Representative -->
            <div class="form-section">
                <h4>
                    <i class="bi bi-person-check text-success"></i> 
                    Representante Legal
                </h4>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="config-item">
                            <label for="legalRepName">Nombre Completo</label>
                            <input type="text" class="form-control" id="legalRepName" 
                                   placeholder="Nombre del representante legal">
                            <small>Nombre completo del representante legal</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="config-item">
                            <label for="legalRepId">Documento de Identidad</label>
                            <input type="text" class="form-control" id="legalRepId" 
                                   placeholder="C√©dula o NIT">
                            <small>N√∫mero de identificaci√≥n</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="config-item">
                            <label for="legalRepEmail">Email</label>
                            <input type="email" class="form-control" id="legalRepEmail" 
                                   placeholder="representante@colegiotilata.edu.co">
                            <small>Correo electr√≥nico oficial</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Configuration -->
            <div class="form-section">
                <h4>
                    <i class="bi bi-gear-fill text-secondary"></i> 
                    Configuraciones Adicionales
                </h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="config-item">
                            <label for="principalEmail">Email del Rector</label>
                            <input type="email" class="form-control" id="principalEmail" 
                                   placeholder="rector@colegiotilata.edu.co">
                            <small>Correo del rector para notificaciones importantes</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-item">
                            <label for="calendarId">ID del Calendario</label>
                            <input type="text" class="form-control" id="calendarId" 
                                   placeholder="calendar_id_google">
                            <small>ID del calendario de Google para eventos presupuestales</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Google Drive Folders -->
            <div class="form-section">
                <h4>
                    <i class="bi bi-folder text-warning"></i> 
                    Carpetas de Google Drive
                </h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="config-item">
                            <label for="contractsFolderId">ID Carpeta de Contratos</label>
                            <input type="text" class="form-control" id="contractsFolderId" 
                                   placeholder="folder_id_contratos">
                            <small>ID de la carpeta donde se almacenan los contratos</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-item">
                            <label for="bugsFolderId">ID Carpeta de Errores</label>
                            <input type="text" class="form-control" id="bugsFolderId" 
                                   placeholder="folder_id_errores">
                            <small>ID de la carpeta para reportes de errores</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div class="text-center">
                <button type="submit" class="btn btn-success btn-save btn-lg">
                    <i class="bi bi-check-circle"></i> 
                    Guardar Configuraci√≥n General
                </button>
            </div>

        </form>

        <!-- No Selection State -->
        <div id="noYearSelected" class="text-center py-5">
            <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
            <h4 class="text-muted mt-3">Seleccione un a√±o presupuestal</h4>
            <p class="text-muted">Seleccione el a√±o para configurar los par√°metros generales</p>
        </div>
    </div>

  <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Config JS -->
    <script src="../../assets/js/config.js"></script>

    <script>
        let currentUser = null;
        let selectedYear = null;
        let isLoading = false;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîß Inicializando p√°gina de configuraci√≥n general...');
            
            try {
                // Validar acceso a la p√°gina
                const hasAccess = await validatePageAccess('Inicializar a√±o presupuestal - Generales');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                
                // Verificar sesi√≥n activa
                const session = getStoredSession();
                if (!session || !session.user) {
                    window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                currentUser = session.user;
                console.log('üë§ Usuario actual:', currentUser.user_display_name || currentUser.user_name);
                
                // Inicializar componentes
                await initializeComponents();
                
                console.log('‚úÖ P√°gina de configuraci√≥n general inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina de configuraci√≥n', 'danger');
            }
        });

        async function initializeComponents() {
            showLoading();
            
            try {
                // Cargar a√±os acad√©micos
                await loadAcademicYears();
                
                // Setup event listeners
                setupEventListeners();
                
                hideLoading();
                showMessage('Sistema listo. Seleccione un a√±o presupuestal para configurar.', 'info');
                
            } catch (error) {
                hideLoading();
                console.error('‚ùå Error en inicializaci√≥n:', error);
                showMessage('Error al inicializar componentes: ' + error.message, 'danger');
            }
        }

        async function loadAcademicYears() {
            try {
                console.log('üìÖ Cargando a√±os acad√©micos...');
                
                const years = await supabaseRequest('/academic_years?select=year_id,year_name,is_current&order=year_order.desc');
                
                const yearSelect = document.getElementById('yearSelect');
                yearSelect.innerHTML = '<option value="">Seleccione un a√±o presupuestal...</option>';
                
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.year_id;
                    option.textContent = year.year_name;
                    
                    // Marcar a√±o actual por defecto
                    if (year.is_current) {
                        option.selected = true;
                    }
                    
                    yearSelect.appendChild(option);
                });
                
                yearSelect.disabled = false;
                
                // Si hay un a√±o seleccionado, cargar su configuraci√≥n
                if (yearSelect.value) {
                    await loadYearConfiguration(yearSelect.value);
                }
                
                console.log('‚úÖ A√±os acad√©micos cargados:', years.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando a√±os acad√©micos:', error);
                showMessage('Error al cargar a√±os acad√©micos', 'danger');
            }
        }

        function setupEventListeners() {
            const yearSelect = document.getElementById('yearSelect');
            const configForm = document.getElementById('configForm');
            
            // Cambio de a√±o
            yearSelect.addEventListener('change', async function() {
                if (this.value) {
                    selectedYear = this.value;
                    await loadYearConfiguration(this.value);
                    showConfigurationForm();
                } else {
                    hideConfigurationForm();
                }
            });
            
            // Env√≠o del formulario
            configForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveConfiguration();
            });
            
            // Validaci√≥n en tiempo real
            setupFieldValidation();
        }

        function setupFieldValidation() {
            // Validar porcentajes
            const percentageFields = ['overExecutionTolerance', 'redThreshold', 'yellowThreshold', 'greenThreshold'];
            percentageFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.addEventListener('blur', function() {
                    validatePercentage(this);
                });
            });
            
            // Validar emails
            const emailFields = ['buyerEmail', 'budgetAdminEmail', 'legalRepEmail', 'principalEmail'];
            emailFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.addEventListener('blur', function() {
                    validateEmail(this);
                });
            });
        }

        async function loadYearConfiguration(yearId) {
            try {
                showLoading();
                console.log('üîß Cargando configuraci√≥n para a√±o:', yearId);
                
                // Cargar configuraci√≥n actual del sistema
                const config = await supabaseRequest('/system_config?select=*&limit=1');
                
                if (config && config.length > 0) {
                    const systemConfig = config[0];
                    populateConfigurationForm(systemConfig);
                    console.log('‚úÖ Configuraci√≥n cargada');
                } else {
                    // Configuraci√≥n por defecto si no existe
                    loadDefaultConfiguration();
                    console.log('üìã Usando configuraci√≥n por defecto');
                }
                
                hideLoading();
                
            } catch (error) {
                hideLoading();
                console.error('‚ùå Error cargando configuraci√≥n:', error);
                showMessage('Error al cargar configuraci√≥n del a√±o', 'danger');
            }
        }

        function populateConfigurationForm(config) {
            // Tolerancias
            document.getElementById('overExecutionTolerance').value = config.over_execution_tolerance || 10;
            
            // Umbrales
            document.getElementById('redThreshold').value = config.red_threshold || 90;
            document.getElementById('yellowThreshold').value = config.yellow_threshold || 70;
            document.getElementById('greenThreshold').value = config.green_threshold || 50;
            
            // Responsables
            document.getElementById('buyerEmail').value = config.buyer_email || '';
            document.getElementById('budgetAdminEmail').value = config.budget_admin_email || '';
            
            // Representante legal
            document.getElementById('legalRepName').value = config.legal_rep_name || '';
            document.getElementById('legalRepId').value = config.legal_rep_id || '';
            document.getElementById('legalRepEmail').value = config.legal_rep_email || '';
            
            // Configuraciones adicionales
            document.getElementById('principalEmail').value = config.principal_email || '';
            document.getElementById('calendarId').value = config.calendar_id || '';
            
            // Carpetas
            document.getElementById('contractsFolderId').value = config.contracts_folder_id || '';
            document.getElementById('bugsFolderId').value = config.bugs_folder_id || '';
        }

        function loadDefaultConfiguration() {
            // Valores por defecto
            document.getElementById('overExecutionTolerance').value = 10;
            document.getElementById('redThreshold').value = 90;
            document.getElementById('yellowThreshold').value = 70;
            document.getElementById('greenThreshold').value = 50;
            
            // Limpiar otros campos
            const fields = ['buyerEmail', 'budgetAdminEmail', 'legalRepName', 'legalRepId', 
                          'legalRepEmail', 'principalEmail', 'calendarId', 'contractsFolderId', 'bugsFolderId'];
            fields.forEach(fieldId => {
                document.getElementById(fieldId).value = '';
            });
        }

        async function saveConfiguration() {
            try {
                if (isLoading) return;
                
                // Validar formulario
                if (!validateForm()) {
                    return;
                }
                
                isLoading = true;
                showLoading();
                
                const configData = collectFormData();
                
                console.log('üíæ Guardando configuraci√≥n...', configData);
                
                // Verificar si existe configuraci√≥n
                const existingConfig = await supabaseRequest('/system_config?select=config_id&limit=1');
                
                if (existingConfig && existingConfig.length > 0) {
                    // Actualizar configuraci√≥n existente
                    await supabaseRequest('/system_config?config_id=eq.' + existingConfig[0].config_id, {
                        method: 'PATCH',
                        body: JSON.stringify(configData)
                    });
                } else {
                    // Crear nueva configuraci√≥n
                    await supabaseRequest('/system_config', {
                        method: 'POST',
                        body: JSON.stringify(configData)
                    });
                }
                
                hideLoading();
                isLoading = false;
                
                showMessage('Configuraci√≥n guardada exitosamente', 'success');
                console.log('‚úÖ Configuraci√≥n guardada');
                
            } catch (error) {
                hideLoading();
                isLoading = false;
                console.error('‚ùå Error guardando configuraci√≥n:', error);
                showMessage('Error al guardar la configuraci√≥n: ' + error.message, 'danger');
            }
        }

        function collectFormData() {
            return {
                current_budget_year_id: selectedYear,
                over_execution_tolerance: parseInt(document.getElementById('overExecutionTolerance').value),
                red_threshold: document.getElementById('redThreshold').value,
                yellow_threshold: document.getElementById('yellowThreshold').value,
                green_threshold: document.getElementById('greenThreshold').value,
                buyer_email: document.getElementById('buyerEmail').value.trim(),
                budget_admin_email: document.getElementById('budgetAdminEmail').value.trim(),
                legal_rep_name: document.getElementById('legalRepName').value.trim(),
                legal_rep_id: document.getElementById('legalRepId').value.trim(),
                legal_rep_email: document.getElementById('legalRepEmail').value.trim(),
                principal_email: document.getElementById('principalEmail').value.trim(),
                calendar_id: document.getElementById('calendarId').value.trim(),
                contracts_folder_id: document.getElementById('contractsFolderId').value.trim(),
                bugs_folder_id: document.getElementById('bugsFolderId').value.trim(),
                updated_at: new Date().toISOString()
            };
        }

        function validateForm() {
            let isValid = true;
            const errors = [];
            
            // Validar a√±o seleccionado
            if (!selectedYear) {
                errors.push('Debe seleccionar un a√±o presupuestal');
                isValid = false;
            }
            
            // Validar tolerancia
            const tolerance = parseInt(document.getElementById('overExecutionTolerance').value);
            if (isNaN(tolerance) || tolerance < 0 || tolerance > 100) {
                errors.push('La tolerancia de sobreejecuci√≥n debe estar entre 0 y 100%');
                isValid = false;
            }
            
            // Validar umbrales
            const red = parseFloat(document.getElementById('redThreshold').value);
            const yellow = parseFloat(document.getElementById('yellowThreshold').value);
            const green = parseFloat(document.getElementById('greenThreshold').value);
            
            if (red <= yellow || yellow <= green) {
                errors.push('Los umbrales deben ser: Rojo > Amarillo > Verde');
                isValid = false;
            }
            
            // Validar emails si est√°n llenos
            const emails = ['buyerEmail', 'budgetAdminEmail', 'legalRepEmail', 'principalEmail'];
            emails.forEach(emailId => {
                const email = document.getElementById(emailId).value.trim();
                if (email && !isValidEmail(email)) {
                    errors.push(`Email inv√°lido en: ${document.querySelector(`label[for="${emailId}"]`).textContent}`);
                    isValid = false;
                }
            });
            
            if (!isValid) {
                showMessage('Por favor corrija los siguientes errores:<br>‚Ä¢ ' + errors.join('<br>‚Ä¢ '), 'danger');
            }
            
            return isValid;
        }

        function validatePercentage(field) {
            const value = parseFloat(field.value);
            if (isNaN(value) || value < 0 || value > 100) {
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        }

        function validateEmail(field) {
            const email = field.value.trim();
            if (email && !isValidEmail(email)) {
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showConfigurationForm() {
            document.getElementById('configForm').style.display = 'block';
            document.getElementById('noYearSelected').style.display = 'none';
        }

        function hideConfigurationForm() {
            document.getElementById('configForm').style.display = 'none';
            document.getElementById('noYearSelected').style.display = 'block';
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function getStoredSession() {
            try {
                const sessionData = localStorage.getItem('nextSystemSession') || sessionStorage.getItem('nextSystemSession');
                return sessionData ? JSON.parse(sessionData) : null;
            } catch (error) {
                return null;
            }
        }

        // Inicializar p√°gina con config.js
        if (window.SUPABASE_CONFIG) {
            initializePage('budgetGeneralConfig', 'Presupuesto');
        } else {
            setTimeout(() => initializePage('budgetGeneralConfig', 'Presupuesto'), 100);
        }
    </script>

</body>
</html>
