<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicializar Año Presupuestal - Generales - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c5530;
            --secondary-color: #3d7c47;
            --success-color: #198754;
            --warning-color: #fd7e14;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-section {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
        }

        .main-section h4 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .selector-section {
            background: var(--info-color);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .assignments-section {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--success-color);
        }

        .assignments-section.show {
            display: block;
        }

        .assignments-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .assignments-table th,
        .assignments-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .assignments-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--primary-color);
        }

        .assignments-table tr:hover {
            background-color: #f8f9fa;
        }

        .subitem-name {
            font-weight: 500;
            color: #333;
        }

        .worker-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background-color: white;
            transition: all 0.3s ease;
        }

        .worker-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(61, 124, 71, 0.25);
        }

        .worker-select.saving {
            background-color: #fff3cd;
        }

        .worker-select.saved {
            background-color: #d4edda;
        }

        .worker-select.error {
            background-color: #f8d7da;
        }

        .summary-info {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }

        .summary-info.show {
            display: block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            .main-section {
                padding: 1rem;
            }

            .assignments-table {
                font-size: 0.9rem;
            }

            .assignments-table th,
            .assignments-table td {
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-2"><strong>Procesando...</strong></p>
            <p class="mb-0 text-muted" id="loading-message">Cargando datos del sistema</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS MODERNOS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Presupuesto</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Inicializar Año Presupuestal - Generales
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO MODERNO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-person-gear me-2"></i>
                    Inicializar Año Presupuestal - Generales
                </h1>
                <p class="text-muted">
                    Asignación individual de responsables para sub-ítems generales
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>
        <!-- Year and Category Selection -->
        <div class="selector-section">
            <h4 class="mb-3">
                <i class="bi bi-funnel"></i> Selección de Filtros
            </h4>
            <div class="row justify-content-center">
                <div class="col-md-5">
                    <label class="form-label text-white">Año Presupuestal</label>
                    <select class="form-select form-select-lg" id="yearSelect" disabled>
                        <option value="">Cargando años académicos...</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="form-label text-white">Rubro Presupuestal</label>
                    <select class="form-select form-select-lg" id="categorySelect" disabled>
                        <option value="">Primero seleccione un año</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Summary Information -->
        <div class="summary-info" id="summaryInfo">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h6 class="mb-1">
                        <i class="bi bi-info-circle"></i> 
                        Asignando responsables para:
                    </h6>
                    <p class="mb-0">
                        <strong>Año:</strong> <span id="selectedYear">-</span> | 
                        <strong>Rubro:</strong> <span id="selectedCategory">-</span>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-primary btn-sm" onclick="refreshAssignments()">
                        <i class="bi bi-arrow-clockwise"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>

        <!-- Assignments Section -->
        <div class="assignments-section" id="assignmentsSection">
            <h4>
                <i class="bi bi-person-badge text-success"></i> 
                Asignación de Responsables
            </h4>
            
            <!-- Statistics -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalItems">0</div>
                    <div class="stat-label">Total Sub-ítems</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="assignedItems">0</div>
                    <div class="stat-label">Asignados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unassignedItems">0</div>
                    <div class="stat-label">Sin Asignar</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completionPercentage">0%</div>
                    <div class="stat-label">Completitud</div>
                </div>
            </div>
            
            <!-- Assignments Table -->
            <div id="assignmentsContainer">
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h6>Seleccione año y rubro</h6>
                    <p>Seleccione un año y rubro para ver los sub-ítems generales disponibles</p>
                </div>
            </div>
        </div>

        <!-- No Selection State -->
        <div id="noSelectionState" class="text-center py-5">
            <i class="bi bi-funnel text-muted" style="font-size: 3rem;"></i>
            <h4 class="text-muted mt-3">Configure los filtros</h4>
            <p class="text-muted">Seleccione año y rubro para comenzar las asignaciones</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Config JS -->
    <script src="../../assets/js/config.js"></script>

    <script>
        /**
         * JavaScript para Inicializar Año Presupuestal - Generales
         * Migrado desde Google Apps Script a Supabase/Next.js
         */

        // Variables globales
        let currentUser = null;
        let selectedYear = null;
        let selectedCategory = null;
        let yearData = [];
        let categoryData = [];
        let workerData = [];
        let currentSubitems = [];
        let saveTimeout = null;

        // Referencias DOM
        const elementos = {
            yearSelect: null,
            categorySelect: null,
            assignmentsSection: null,
            assignmentsContainer: null,
            summaryInfo: null,
            selectedYear: null,
            selectedCategory: null,
            totalItems: null,
            assignedItems: null,
            unassignedItems: null,
            completionPercentage: null,
            loadingOverlay: null,
            loadingMessage: null,
            noSelectionState: null
        };

        /**
         * Inicialización cuando se carga el DOM
         */
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔧 Iniciando inicialización de año presupuestal - Generales...');
            
            try {
                // Validar acceso a la página
                const hasAccess = await validatePageAccess('Inicializar año presupuestal - Generales');
                if (!hasAccess) {
                    console.log('❌ Acceso denegado - deteniendo inicialización');
                    return;
                }
                
                console.log('✅ Acceso permitido - continuando con inicialización');
                
                // Verificar sesión activa
                const session = getStoredSession();
                if (!session || !session.user) {
                    window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                currentUser = session.user;
                console.log('👤 Usuario actual:', currentUser.user_display_name || currentUser.user_name);
                
                // Inicializar componentes
                initializeElements();
                setupEventListeners();
                await loadInitialData();
                
                showMessage('Sistema listo. Seleccione año y rubro para comenzar.', 'info');
                console.log('✅ Página inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
            }
        });

        /**
         * Inicializa referencias a elementos DOM
         */
        function initializeElements() {
            elementos.yearSelect = document.getElementById('yearSelect');
            elementos.categorySelect = document.getElementById('categorySelect');
            elementos.assignmentsSection = document.getElementById('assignmentsSection');
            elementos.assignmentsContainer = document.getElementById('assignmentsContainer');
            elementos.summaryInfo = document.getElementById('summaryInfo');
            elementos.selectedYear = document.getElementById('selectedYear');
            elementos.selectedCategory = document.getElementById('selectedCategory');
            elementos.totalItems = document.getElementById('totalItems');
            elementos.assignedItems = document.getElementById('assignedItems');
            elementos.unassignedItems = document.getElementById('unassignedItems');
            elementos.completionPercentage = document.getElementById('completionPercentage');
            elementos.loadingOverlay = document.getElementById('loading-overlay');
            elementos.loadingMessage = document.getElementById('loading-message');
            elementos.noSelectionState = document.getElementById('noSelectionState');
        }

        /**
         * Configura event listeners
         */
        function setupEventListeners() {
            elementos.yearSelect.addEventListener('change', handleYearChange);
            elementos.categorySelect.addEventListener('change', handleCategoryChange);
        }

        /**
         * Carga datos iniciales
         */
        async function loadInitialData() {
            try {
                showLoading('Cargando datos iniciales...');
                
                // Cargar años académicos y trabajadores en paralelo
                await Promise.all([
                    loadAcademicYears(),
                    loadWorkers()
                ]);
                
                hideLoading();
                console.log('✅ Datos iniciales cargados correctamente');
                
            } catch (error) {
                console.error('❌ Error cargando datos iniciales:', error);
                showMessage('Error al cargar datos iniciales: ' + error.message, 'danger');
                hideLoading();
            }
        }

        /**
         * Carga años académicos
         */
        async function loadAcademicYears() {
            try {
                console.log('📅 Cargando años académicos...');
                
                const years = await supabaseRequest(
                    '/academic_years?select=year_id,year_name,is_current&order=year_order.desc'
                );
                
                yearData = years || [];
                renderYearSelect();
                
                console.log(`✅ ${yearData.length} años académicos cargados`);
                
            } catch (error) {
                console.error('❌ Error cargando años académicos:', error);
                throw new Error('No se pudieron cargar los años académicos');
            }
        }

        /**
         * Renderiza el select de años
         */
        function renderYearSelect() {
            elementos.yearSelect.innerHTML = '<option value="">Seleccione un año presupuestal...</option>';
            
            yearData.forEach(year => {
                const option = document.createElement('option');
                option.value = year.year_id;
                option.textContent = year.year_name;
                
                // Marcar año actual por defecto
                if (year.is_current) {
                    option.selected = true;
                }
                
                elementos.yearSelect.appendChild(option);
            });
            
            elementos.yearSelect.disabled = false;
            
            // Si hay un año seleccionado por defecto, cargar sus categorías
            if (elementos.yearSelect.value) {
                handleYearChange();
            }
        }

        /**
         * Carga trabajadores activos
         */
        async function loadWorkers() {
            try {
                console.log('👥 Cargando trabajadores...');
                
                const workers = await supabaseRequest(
                    '/workers?select=worker_id,email,worker_first_name,worker_last_name_1,worker_last_name_2&worker_status=eq.active&order=worker_first_name.asc'
                );
                
                workerData = (workers || []).map(worker => ({
                    worker_id: worker.worker_id,
                    email: worker.email,
                    full_name: `${worker.worker_first_name} ${worker.worker_last_name_1}${worker.worker_last_name_2 ? ' ' + worker.worker_last_name_2 : ''}`.trim()
                }));
                
                console.log(`✅ ${workerData.length} trabajadores cargados`);
                
            } catch (error) {
                console.error('❌ Error cargando trabajadores:', error);
                throw new Error('No se pudieron cargar los trabajadores');
            }
        }
        /**
         * Maneja el cambio de año
         */
        async function handleYearChange() {
            const yearId = elementos.yearSelect.value;
            
            if (!yearId) {
                resetCategorySelect();
                hideAssignments();
                return;
            }
            
            selectedYear = yearId;
            await loadBudgetCategories(yearId);
        }

        /**
         * Carga categorías presupuestales (rubros)
         */
        async function loadBudgetCategories(yearId) {
            try {
                showLoading('Cargando rubros presupuestales...');
                
                console.log('📊 Cargando categorías presupuestales...');
                
                const categories = await supabaseRequest(
                    '/budget_categories?select=category_id,category_name&category_status=eq.active&order=category_name.asc'
                );
                
                categoryData = categories || [];
                renderCategorySelect();
                
                hideLoading();
                console.log(`✅ ${categoryData.length} categorías cargadas`);
                
            } catch (error) {
                console.error('❌ Error cargando categorías:', error);
                showMessage('Error al cargar rubros presupuestales: ' + error.message, 'danger');
                hideLoading();
            }
        }

        /**
         * Renderiza el select de categorías
         */
        function renderCategorySelect() {
            elementos.categorySelect.innerHTML = '<option value="">Seleccione un rubro...</option>';
            
            categoryData.forEach(category => {
                const option = document.createElement('option');
                option.value = category.category_id;
                option.textContent = category.category_name;
                elementos.categorySelect.appendChild(option);
            });
            
            elementos.categorySelect.disabled = false;
        }

        /**
         * Resetea el select de categorías
         */
        function resetCategorySelect() {
            elementos.categorySelect.innerHTML = '<option value="">Primero seleccione un año</option>';
            elementos.categorySelect.disabled = true;
            hideAssignments();
        }

        /**
         * Maneja el cambio de categoría
         */
        async function handleCategoryChange() {
            const categoryId = elementos.categorySelect.value;
            
            if (!categoryId || !selectedYear) {
                hideAssignments();
                return;
            }
            
            selectedCategory = categoryId;
            await loadSubitemsForCategory(selectedYear, categoryId);
        }

        /**
         * Carga sub-ítems para la categoría seleccionada - VERSIÓN CORREGIDA
         */
        async function loadSubitemsForCategory(yearId, categoryId) {
            try {
                showLoading('Cargando sub-ítems generales...');
                
                console.log(`📋 Cargando sub-ítems para año ${yearId} y categoría ${categoryId}...`);
                
                // PASO 1: Obtener sub-ítems (consulta simple sin JOIN)
                const subitemsQuery = `/budget_items?select=item_id,item_name&category_id=eq.${categoryId}&assignment_category=eq.General&item_status=eq.active&order=item_name.asc`;
                const subitems = await supabaseRequest(subitemsQuery);
                
                // PASO 2: Obtener asignaciones existentes (consulta separada)
                const assignmentsQuery = `/budget_assignments?select=budget_item_id,worker_email&academic_year_id=eq.${yearId}&assignment_category=eq.General&assignment_status=eq.active`;
                const assignments = await supabaseRequest(assignmentsQuery);
                
                // PASO 3: Combinar en JavaScript
                currentSubitems = (subitems || []).map(subitem => {
                    const assignment = assignments.find(a => a.budget_item_id === subitem.item_id);
                    return {
                        item_id: subitem.item_id,
                        item_name: subitem.item_name,
                        assigned_worker: assignment ? assignment.worker_email : null
                    };
                });
                
                hideLoading();
                renderAssignmentsTable();
                showAssignments();
                updateStatistics();
                updateSummaryInfo();
                
                console.log(`✅ ${currentSubitems.length} sub-ítems cargados`);
                
            } catch (error) {
                console.error('❌ Error cargando sub-ítems:', error);
                showMessage('Error al cargar sub-ítems: ' + error.message, 'danger');
                hideLoading();
            }
        }
        
        /**
         * Renderiza la tabla de asignaciones
         */
        function renderAssignmentsTable() {
            if (currentSubitems.length === 0) {
                elementos.assignmentsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <h6>No hay sub-ítems generales</h6>
                        <p>No se encontraron sub-ítems de categoría "General" para este rubro</p>
                    </div>
                `;
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'assignments-table';
            
            // Crear encabezado
            table.innerHTML = `
                <thead>
                    <tr>
                        <th style="width: 60%;">Sub-ítem General</th>
                        <th style="width: 40%;">Responsable Asignado</th>
                    </tr>
                </thead>
            `;
            
            const tbody = document.createElement('tbody');
            
            currentSubitems.forEach(subitem => {
                const tr = document.createElement('tr');
                
                // Nombre del sub-ítem
                const tdName = document.createElement('td');
                tdName.innerHTML = `<span class="subitem-name">${escapeHtml(subitem.item_name)}</span>`;
                
                // Select de trabajadores
                const tdWorker = document.createElement('td');
                const select = createWorkerSelect(subitem);
                tdWorker.appendChild(select);
                
                tr.appendChild(tdName);
                tr.appendChild(tdWorker);
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            
            elementos.assignmentsContainer.innerHTML = '';
            elementos.assignmentsContainer.appendChild(table);
        }

        /**
         * Crea un select de trabajadores para un sub-ítem
         */
        function createWorkerSelect(subitem) {
            const select = document.createElement('select');
            select.className = 'worker-select';
            select.innerHTML = '<option value="">Sin asignar</option>';
            
            workerData.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.email;
                option.textContent = worker.full_name;
                
                if (subitem.assigned_worker === worker.email) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            });
            
            // Event listener para guardado automático con debouncing
            select.addEventListener('change', function() {
                saveAssignmentWithDebounce(subitem.item_id, this.value, this);
            });
            
            return select;
        }

        /**
         * Guarda asignación con debouncing
         */
        function saveAssignmentWithDebounce(itemId, workerEmail, selectElement) {
            // Feedback visual inmediato
            selectElement.className = 'worker-select saving';
            
            // Limpiar timeout anterior
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            // Programar guardado
            saveTimeout = setTimeout(() => {
                saveAssignment(itemId, workerEmail, selectElement);
            }, 800);
        }
        /**
         * Guarda una asignación individual
         */
        async function saveAssignment(itemId, workerEmail, selectElement) {
            try {
                console.log(`💾 Guardando asignación: item ${itemId} -> ${workerEmail || 'sin asignar'}`);
                
                if (!workerEmail || workerEmail.trim() === '') {
                    // Eliminar asignación
                    const deleteQuery = `/budget_assignments?budget_item_id=eq.${itemId}&academic_year_id=eq.${selectedYear}&assignment_category=eq.General`;
                    
                    await supabaseRequest(deleteQuery, {
                        method: 'DELETE'
                    });
                    
                    console.log('✅ Asignación eliminada');
                } else {
                    // Crear o actualizar asignación
                    const assignmentData = {
                        academic_year_id: selectedYear,
                        budget_item_id: itemId,
                        assignment_category: 'General',
                        category_detail: 'General',
                        worker_email: workerEmail,
                        requested_value: 0,
                        approved_value: 0,
                        executed_value: 0,
                        assignment_status: 'active'
                    };
                    
                    // Intentar actualizar primero
                    const existingQuery = `/budget_assignments?budget_item_id=eq.${itemId}&academic_year_id=eq.${selectedYear}&assignment_category=eq.General&limit=1`;
                    const existing = await supabaseRequest(existingQuery);
                    
                    if (existing && existing.length > 0) {
                        // Actualizar
                        const updateQuery = `/budget_assignments?assignment_id=eq.${existing[0].assignment_id}`;
                        await supabaseRequest(updateQuery, {
                            method: 'PATCH',
                            body: JSON.stringify({ worker_email: workerEmail })
                        });
                    } else {
                        // Crear nuevo
                        await supabaseRequest('/budget_assignments', {
                            method: 'POST',
                            body: JSON.stringify(assignmentData)
                        });
                    }
                    
                    console.log('✅ Asignación guardada');
                }
                
                // Feedback visual de éxito
                selectElement.className = 'worker-select saved';
                setTimeout(() => {
                    selectElement.className = 'worker-select';
                }, 2000);
                
                // Actualizar estadísticas
                updateCurrentSubitemsData(itemId, workerEmail);
                updateStatistics();
                
            } catch (error) {
                console.error('❌ Error guardando asignación:', error);
                selectElement.className = 'worker-select error';
                showMessage('Error al guardar asignación: ' + error.message, 'danger');
                
                setTimeout(() => {
                    selectElement.className = 'worker-select';
                }, 3000);
            }
        }

        /**
         * Actualiza los datos locales después de guardar
         */
        function updateCurrentSubitemsData(itemId, workerEmail) {
            const subitem = currentSubitems.find(s => s.item_id === itemId);
            if (subitem) {
                subitem.assigned_worker = workerEmail || null;
            }
        }

        /**
         * Actualiza estadísticas
         */
        function updateStatistics() {
            const total = currentSubitems.length;
            const assigned = currentSubitems.filter(s => s.assigned_worker).length;
            const unassigned = total - assigned;
            const completion = total > 0 ? Math.round((assigned / total) * 100) : 0;
            
            elementos.totalItems.textContent = total;
            elementos.assignedItems.textContent = assigned;
            elementos.unassignedItems.textContent = unassigned;
            elementos.completionPercentage.textContent = `${completion}%`;
        }

        /**
         * Actualiza información de resumen
         */
        function updateSummaryInfo() {
            const yearName = elementos.yearSelect.options[elementos.yearSelect.selectedIndex].text;
            const categoryName = elementos.categorySelect.options[elementos.categorySelect.selectedIndex].text;
            
            elementos.selectedYear.textContent = yearName;
            elementos.selectedCategory.textContent = categoryName;
        }

        /**
         * Muestra la sección de asignaciones
         */
        function showAssignments() {
            elementos.assignmentsSection.classList.add('show');
            elementos.summaryInfo.classList.add('show');
            elementos.noSelectionState.style.display = 'none';
        }

        /**
         * Oculta la sección de asignaciones
         */
        function hideAssignments() {
            elementos.assignmentsSection.classList.remove('show');
            elementos.summaryInfo.classList.remove('show');
            elementos.noSelectionState.style.display = 'block';
        }

        /**
         * Actualiza las asignaciones (función llamada desde el botón)
         */
        async function refreshAssignments() {
            if (selectedYear && selectedCategory) {
                await loadSubitemsForCategory(selectedYear, selectedCategory);
                showMessage('Asignaciones actualizadas', 'success');
            }
        }

        /**
         * Funciones de utilidad
         */
        function showLoading(message = 'Procesando...') {
            elementos.loadingMessage.textContent = message;
            elementos.loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            elementos.loadingOverlay.classList.add('hidden');
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getStoredSession() {
            try {
                const sessionData = localStorage.getItem('nextSystemSession') || 
                                  sessionStorage.getItem('nextSystemSession');
                return sessionData ? JSON.parse(sessionData) : null;
            } catch (error) {
                return null;
            }
        }

        // Hacer función disponible globalmente
        window.refreshAssignments = refreshAssignments;

        // Inicializar página con config.js
        if (window.SUPABASE_CONFIG) {
            initializePage('budgetGeneralInit', 'Presupuesto');
        } else {
            setTimeout(() => initializePage('budgetGeneralInit', 'Presupuesto'), 100);
        }
    </script>
</body>
</html>
