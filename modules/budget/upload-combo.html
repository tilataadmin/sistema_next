<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subir el Combo - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        .upload-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .file-drop-zone {
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }
        
        .file-drop-zone.dragover {
            border-color: #2c5530;
            background-color: #e8f5e8;
        }
        
        .file-drop-zone.has-file {
            border-color: #28a745;
            background-color: #d4edda;
        }
        
        .format-info {
            background: linear-gradient(45deg, #e3f2fd, #f3e5f5);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .progress-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .results-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }
        
        .error-list {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .summary-item {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .summary-number {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .btn-file {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .btn-file input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            background: white;
            cursor: inherit;
            display: block;
        }
        
        @media (max-width: 768px) {
            .file-drop-zone {
                padding: 2rem 1rem;
            }
            
            .upload-icon {
                font-size: 3rem;
            }
            
            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Contenedor principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Presupuesto</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Subir el Combo
                </li>
            </ol>
        </nav>

        <!-- Encabezado de página -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-upload me-2"></i>
                    Subir el Combo
                </h1>
                <p class="text-muted">
                    Carga masiva de PUC, Rubros y Sub-ítems desde archivo CSV
                </p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>
        <!-- Format Information -->
        <div class="format-info">
            <h5 class="mb-3">
                <i class="bi bi-info-circle text-primary"></i> Información de Formatos Soportados
            </h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-info mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-list-columns"></i> Modo 1: Solo PUC</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">Para carga únicamente del Plan Único de Cuentas:</p>
                            <ul class="mb-2">
                                <li><strong>Columna A:</strong> Código PUC (obligatorio)</li>
                                <li><strong>Columna D:</strong> Nombre cuenta (obligatorio)</li>
                                <li>Las demás columnas se ignoran</li>
                            </ul>
                            <div class="alert alert-info mb-0">
                                <small><strong>Nota:</strong> Filas con columna D vacía serán omitidas automáticamente.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-success mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="bi bi-stack"></i> Modo 2: Combo Completo</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">Para carga completa de estructura presupuestal:</p>
                            <ul class="mb-2">
                                <li><strong>Columna A:</strong> Nombre PUC</li>
                                <li><strong>Columna B:</strong> Tipo IVA (0, 1 ó 2)</li>
                                <li><strong>Columna C:</strong> Nombre Rubro</li>
                                <li><strong>Columna D:</strong> Nombre Sub-ítem</li>
                                <li><strong>Columna E:</strong> Categoría Asignación</li>
                                <li><strong>Columna F:</strong> Valor (omitida)</li>
                            </ul>
                            <div class="alert alert-success mb-0">
                                <small><strong>Mapeo IVA:</strong> 0=No aplica, 1=Academia, 2=Admón</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Importante:</strong> En ambos modos, la primera fila debe contener encabezados y será omitida automáticamente.
            </div>
        </div>

        <!-- Upload Mode Selection -->
        <div class="card upload-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-cloud-upload"></i> Seleccionar Tipo de Carga
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card h-100 border-info" id="pucModeCard">
                            <div class="card-header bg-info text-white text-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-list-columns"></i> Modo 1: Solo PUC
                                </h6>
                            </div>
                            <div class="card-body text-center">
                                <p class="mb-3">Carga únicamente el Plan Único de Cuentas</p>
                                <ul class="text-start mb-3">
                                    <li>Columna A: Código PUC</li>
                                    <li>Columna D: Nombre de Cuenta</li>
                                </ul>
                                <button class="btn btn-info btn-lg w-100" onclick="selectMode('puc')">
                                    <i class="bi bi-upload"></i> Cargar Solo PUC
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 border-success" id="comboModeCard">
                            <div class="card-header bg-success text-white text-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-stack"></i> Modo 2: Combo Completo
                                </h6>
                            </div>
                            <div class="card-body text-center">
                                <p class="mb-3">Carga PUC + Rubros + Sub-ítems</p>
                                <ul class="text-start mb-3">
                                    <li>A: Nombre PUC, B: Tipo IVA</li>
                                    <li>C: Rubro, D: Sub-ítem</li>
                                    <li>E: Asignación, F: Valor (omitir)</li>
                                </ul>
                                <button class="btn btn-success btn-lg w-100" onclick="selectMode('combo')">
                                    <i class="bi bi-upload"></i> Cargar Combo Completo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload Section (inicialmente oculta) -->
        <div class="card upload-card d-none" id="fileUploadSection">
            <div class="card-header" id="uploadSectionHeader">
                <h5 class="mb-0" id="uploadSectionTitle">
                    <i class="bi bi-cloud-upload"></i> Cargar Archivo CSV
                </h5>
                <div class="mt-2">
                    <button class="btn btn-outline-light btn-sm" onclick="resetMode()">
                        <i class="bi bi-arrow-left"></i> Cambiar Modo
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="alert" id="modeInstructions">
                    <!-- Instrucciones específicas del modo se insertan aquí -->
                </div>
                
                <div class="file-drop-zone" id="dropZone">
                    <div class="upload-icon">
                        <i class="bi bi-cloud-upload" id="uploadIcon"></i>
                    </div>
                    <h5 id="dropZoneTitle">Arrastra tu archivo CSV aquí</h5>
                    <p class="text-muted mb-3" id="dropZoneText">o haz clic para seleccionar un archivo</p>
                    
                    <div class="btn-file">
                        <button class="btn btn-primary btn-lg" id="selectFileBtn">
                            <i class="bi bi-folder2-open"></i> Seleccionar Archivo
                        </button>
                        <input type="file" id="csvFile" accept=".csv,text/csv">
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            Formato soportado: CSV (máximo 50MB)
                        </small>
                    </div>
                </div>
                
                <div id="fileInfo" class="mt-4 d-none">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-file-earmark-text"></i> Archivo Seleccionado</h6>
                        <div id="fileDetails"></div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-center gap-3 mt-4">
                    <button class="btn btn-success btn-lg" id="processBtn" disabled onclick="processFile()">
                        <i class="bi bi-gear"></i> Procesar Archivo
                    </button>
                    <button class="btn btn-outline-secondary btn-lg" onclick="clearFile()">
                        <i class="bi bi-x-lg"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="card progress-card d-none" id="progressCard">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-hourglass-split"></i> Procesando Archivo
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label" id="progressLabel">Inicializando...</label>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="progressBar" 
                             role="progressbar" 
                             style="width: 0%">
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <small class="text-muted" id="progressDetails">Preparando procesamiento...</small>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card results-card d-none" id="resultsCard">
            <div class="card-header" id="resultsHeader">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-data"></i> Resultados del Procesamiento
                </h5>
            </div>
            <div class="card-body">
                <div class="summary-grid" id="summaryGrid">
                    <!-- Summary items will be inserted here -->
                </div>
                
                <div id="errorSection" class="d-none">
                    <h6 class="text-danger">
                        <i class="bi bi-exclamation-triangle"></i> Errores Encontrados
                    </h6>
                    <div class="error-list" id="errorList">
                        <!-- Error list will be inserted here -->
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Procesar Otro Archivo
                    </button>
                    <a href="index.html" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver al Módulo
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Config JS -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // Variables globales
        let selectedFile = null;
        let isProcessing = false;
        let uploadMode = null;

        // Mapeo de tipos de IVA
        const IVA_MAPPING = {
            '0': 'No aplica',
            '1': 'Iva descontable - Academia', 
            '2': 'Iva descontable - Admón'
        };

        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Subir el combo');
                if (!hasAccess) {
                    console.log('❌ Acceso denegado - deteniendo inicialización');
                    return;
                }
                
                console.log('✅ Acceso permitido - continuando con inicialización');
                
                initializePage('uploadCombo', 'Presupuesto');
                setupEventListeners();
                
                console.log('✅ Página inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error en validación de acceso:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });

        function selectMode(mode) {
            uploadMode = mode;
            
            const modeSelector = document.querySelector('.upload-card');
            modeSelector.style.display = 'none';
            
            const fileSection = document.getElementById('fileUploadSection');
            fileSection.classList.remove('d-none');
            
            setupModeInterface(mode);
        }

        function setupModeInterface(mode) {
            const header = document.getElementById('uploadSectionHeader');
            const title = document.getElementById('uploadSectionTitle');
            const instructions = document.getElementById('modeInstructions');
            
            if (mode === 'puc') {
                header.className = 'card-header bg-info text-white';
                title.innerHTML = '<i class="bi bi-list-columns"></i> Cargar Solo PUC';
                instructions.className = 'alert alert-info';
                instructions.innerHTML = `
                    <h6><i class="bi bi-info-circle"></i> Modo: Solo PUC</h6>
                    <p class="mb-2">El archivo CSV debe contener:</p>
                    <ul class="mb-0">
                        <li><strong>Columna A:</strong> Código del PUC</li>
                        <li><strong>Columna D:</strong> Nombre de la cuenta (no debe estar vacía)</li>
                    </ul>
                    <p class="mt-2 mb-0"><small>Las demás columnas serán ignoradas automáticamente.</small></p>
                `;
            } else if (mode === 'combo') {
                header.className = 'card-header bg-success text-white';
                title.innerHTML = '<i class="bi bi-stack"></i> Cargar Combo Completo';
                instructions.className = 'alert alert-success';
                instructions.innerHTML = `
                    <h6><i class="bi bi-info-circle"></i> Modo: Combo Completo</h6>
                    <p class="mb-2">El archivo CSV debe contener 6 columnas en orden:</p>
                    <ul class="mb-2">
                        <li><strong>Columna A:</strong> Nombre PUC</li>
                        <li><strong>Columna B:</strong> Tipo IVA (0, 1 o 2)</li>
                        <li><strong>Columna C:</strong> Nombre del Rubro</li>
                        <li><strong>Columna D:</strong> Nombre del Sub-ítem</li>
                        <li><strong>Columna E:</strong> Categoría de Asignación</li>
                        <li><strong>Columna F:</strong> Valor (será omitida)</li>
                    </ul>
                    <p class="mb-0"><small>Se crearán/vincularán automáticamente: PUC, Rubros y Sub-ítems.</small></p>
                `;
            }
        }

        function resetMode() {
            uploadMode = null;
            clearFile();
            
            const fileSection = document.getElementById('fileUploadSection');
            fileSection.classList.add('d-none');
            
            const modeSelector = document.querySelector('.upload-card');
            modeSelector.style.display = 'block';
        }

        function setupEventListeners() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('csvFile');
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelection(files[0]);
                }
            });
            
            fileInput.addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    handleFileSelection(this.files[0]);
                }
            });
            
            dropZone.addEventListener('click', function() {
                if (!isProcessing) {
                    fileInput.click();
                }
            });
        }

        function handleFileSelection(file) {
            if (!validateFile(file)) return;
            
            selectedFile = file;
            updateFileDisplay();
            showFileInfo();
            
            document.getElementById('processBtn').disabled = false;
        }

        function validateFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showMessage('Por favor selecciona un archivo con extensión .csv', 'danger');
                return false;
            }
            
            const maxSize = 50 * 1024 * 1024;
            if (file.size > maxSize) {
                showMessage('El archivo es demasiado grande. Máximo permitido: 50MB', 'danger');
                return false;
            }
            
            return true;
        }

        function updateFileDisplay() {
            const dropZone = document.getElementById('dropZone');
            const uploadIcon = document.getElementById('uploadIcon');
            const title = document.getElementById('dropZoneTitle');
            const text = document.getElementById('dropZoneText');
            
            dropZone.classList.add('has-file');
            uploadIcon.className = 'bi bi-file-earmark-check';
            title.textContent = 'Archivo seleccionado';
            text.textContent = selectedFile.name;
        }

        function showFileInfo() {
            const fileInfo = document.getElementById('fileInfo');
            const fileDetails = document.getElementById('fileDetails');
            
            fileDetails.innerHTML = `
                <div class="row">
                    <div class="col-sm-3"><strong>Nombre:</strong></div>
                    <div class="col-sm-9">${selectedFile.name}</div>
                </div>
                <div class="row">
                    <div class="col-sm-3"><strong>Tamaño:</strong></div>
                    <div class="col-sm-9">${formatFileSize(selectedFile.size)}</div>
                </div>
                <div class="row">
                    <div class="col-sm-3"><strong>Tipo:</strong></div>
                    <div class="col-sm-9">${selectedFile.type || 'text/csv'}</div>
                </div>
                <div class="row">
                    <div class="col-sm-3"><strong>Última modificación:</strong></div>
                    <div class="col-sm-9">${formatDate(selectedFile.lastModified)}</div>
                </div>
            `;
            
            fileInfo.classList.remove('d-none');
        }

        function clearFile() {
            selectedFile = null;
            document.getElementById('csvFile').value = '';
            document.getElementById('fileInfo').classList.add('d-none');
            document.getElementById('processBtn').disabled = true;
            
            const dropZone = document.getElementById('dropZone');
            const uploadIcon = document.getElementById('uploadIcon');
            const title = document.getElementById('dropZoneTitle');
            const text = document.getElementById('dropZoneText');
            
            dropZone.classList.remove('has-file');
            uploadIcon.className = 'bi bi-cloud-upload';
            title.textContent = 'Arrastra tu archivo CSV aquí';
            text.textContent = 'o haz clic para seleccionar un archivo';
            
            document.getElementById('resultsCard').classList.add('d-none');
            document.getElementById('progressCard').classList.add('d-none');
        }

        async function processFile() {
            if (!selectedFile || isProcessing || !uploadMode) return;
            
            isProcessing = true;
            showProgress();
            
            try {
                const fileContent = await readFileAsText(selectedFile);
                
                updateProgress(10, 'Validando formato del archivo...');
                const validation = validateCSVContent(fileContent);
                if (!validation.valid) {
                    throw new Error(validation.error);
                }
                
                updateProgress(20, 'Procesando filas del CSV...');
                let result;
                
                if (uploadMode === 'puc') {
                    result = await processPUCMode(fileContent);
                } else if (uploadMode === 'combo') {
                    result = await processComboMode(fileContent);
                }
                
                updateProgress(100, 'Procesamiento completado');
                
                setTimeout(() => {
                    hideProgress();
                    showResults(result);
                    isProcessing = false;
                }, 1000);
                
            } catch (error) {
                console.error('Error procesando archivo:', error);
                hideProgress();
                showMessage('Error al procesar el archivo: ' + error.message, 'danger');
                isProcessing = false;
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('Error al leer el archivo'));
                reader.readAsText(file, 'UTF-8');
            });
        }

        function validateCSVContent(content) {
            const lines = content.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length < 2) {
                return {
                    valid: false,
                    error: 'El archivo debe tener al menos una fila de datos además del encabezado'
                };
            }
            
            return { valid: true };
        }

        async function processPUCMode(content) {
            const lines = content.split('\n').filter(line => line.trim() !== '');
            const results = {
                mode: 'PUC',
                totalLines: lines.length - 1,
                processedLines: 0,
                skippedLines: 0,
                createdAccounts: 0,
                errors: []
            };
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;
                
                try {
                    updateProgress(20 + (60 * i / lines.length), `Procesando fila ${i} de ${lines.length - 1}...`);
                    
                    const columns = parseCSVLine(line);
                    if (columns.length < 4) {
                        results.errors.push(`Fila ${i + 1}: Insuficientes columnas (${columns.length}/4 mínimas)`);
                        results.skippedLines++;
                        continue;
                    }
                    
                    const pucCode = columns[0] ? columns[0].trim() : '';
                    const pucName = columns[3] ? columns[3].trim() : '';
                    
                    if (!pucName) {
                        results.skippedLines++;
                        continue;
                    }
                    
                    if (!pucCode) {
                        results.errors.push(`Fila ${i + 1}: Código PUC vacío`);
                        results.skippedLines++;
                        continue;
                    }
                    
                    const accountExists = await checkAccountExists(pucCode);
                    if (!accountExists) {
                        await createAccount(pucCode, pucName);
                        results.createdAccounts++;
                    }
                    
                    results.processedLines++;
                    
                } catch (error) {
                    results.errors.push(`Fila ${i + 1}: ${error.message}`);
                    results.skippedLines++;
                }
            }
            
            return results;
        }

        async function processComboMode(content) {
            const lines = content.split('\n').filter(line => line.trim() !== '');
            const results = {
                mode: 'COMBO',
                totalLines: lines.length - 1,
                processedLines: 0,
                skippedLines: 0,
                createdAccounts: 0,
                createdCategories: 0,
                createdItems: 0,
                errors: []
            };
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;
                
                try {
                    updateProgress(20 + (60 * i / lines.length), `Procesando fila ${i} de ${lines.length - 1}...`);
                    
                    const columns = parseCSVLine(line);
                    if (columns.length < 6) {
                        results.errors.push(`Fila ${i + 1}: Insuficientes columnas (${columns.length}/6)`);
                        results.skippedLines++;
                        continue;
                    }
                    
                    const lineResult = await processComboLine(columns, i + 1);
                    
                    if (lineResult.success) {
                        results.processedLines++;
                        results.createdAccounts += lineResult.createdAccounts || 0;
                        results.createdCategories += lineResult.createdCategories || 0;
                        results.createdItems += lineResult.createdItems || 0;
                    } else {
                        results.errors.push(`Fila ${i + 1}: ${lineResult.error}`);
                        results.skippedLines++;
                    }
                    
                } catch (error) {
                    results.errors.push(`Fila ${i + 1}: ${error.message}`);
                    results.skippedLines++;
                }
            }
            
            return results;
        }

        function parseCSVLine(line) {
            const result = [];
            let currentColumn = '';
            let insideQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    insideQuotes = !insideQuotes;
                } else if (char === ',' && !insideQuotes) {
                    result.push(currentColumn.trim());
                    currentColumn = '';
                } else {
                    currentColumn += char;
                }
            }
            
            result.push(currentColumn.trim());
            return result;
        }

        async function processComboLine(columns, lineNumber) {
            const [pucName, tipoIva, categoryName, itemName, assignmentCategory] = columns.map(col => col.trim());
            
            if (!pucName || !categoryName || !itemName || !assignmentCategory) {
                throw new Error('Faltan datos requeridos en las columnas principales');
            }
            
            if (!['0', '1', '2'].includes(tipoIva)) {
                throw new Error(`Tipo IVA inválido: ${tipoIva}. Debe ser 0, 1 o 2`);
            }
            
            let createdAccounts = 0;
            let createdCategories = 0;
            let createdItems = 0;
            
            try {
                let accountCode = await findAccountCodeByName(pucName);
                if (!accountCode) {
                    accountCode = await createAccountByName(pucName);
                    createdAccounts = 1;
                }
                
                let categoryId = await findCategoryByName(categoryName);
                if (!categoryId) {
                    categoryId = await createCategory(categoryName);
                    createdCategories = 1;
                }
                
                const taxId = await getTaxIdByMapping(tipoIva);
                
                const itemExists = await checkItemExists(itemName);
                if (!itemExists) {
                    await createBudgetItem(itemName, categoryId, taxId, accountCode, assignmentCategory);
                    createdItems = 1;
                }
                
                return {
                    success: true,
                    createdAccounts,
                    createdCategories,
                    createdItems
                };
                
            } catch (error) {
                throw new Error(`Error procesando datos: ${error.message}`);
            }
        }

        async function findAccountCodeByName(accountName) {
            try {
                const result = await supabaseRequest('/chart_of_accounts?account_name=eq.' + encodeURIComponent(accountName) + '&select=account_code&limit=1');
                return result && result.length > 0 ? result[0].account_code : null;
            } catch (error) {
                console.error('Error buscando cuenta por nombre:', error);
                return null;
            }
        }

        async function createAccountByName(accountName) {
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.floor(Math.random() * 100).toString().padStart(2, '0');
            const autoCode = `AUTO${timestamp}${random}`;
            
            const account = {
                account_code: autoCode,
                account_name: accountName
            };
            
            await supabaseRequest('/chart_of_accounts', {
                method: 'POST',
                body: JSON.stringify(account)
            });
            
            return autoCode;
        }

        async function findCategoryByName(categoryName) {
            try {
                const result = await supabaseRequest('/budget_categories?category_name=eq.' + encodeURIComponent(categoryName) + '&select=category_id');
                return result && result.length > 0 ? result[0].category_id : null;
            } catch (error) {
                console.error('Error buscando categoría por nombre:', error);
                return null;
            }
        }

        async function getTaxIdByMapping(tipoIva) {
            const taxName = IVA_MAPPING[tipoIva];
            if (!taxName) {
                throw new Error(`Tipo IVA no válido: ${tipoIva}`);
            }
            
            try {
                const result = await supabaseRequest('/tax_types?tax_name=eq.' + encodeURIComponent(taxName) + '&select=tax_id');
                if (result && result.length > 0) {
                    return result[0].tax_id;
                }
                
                const newTax = {
                    tax_name: taxName,
                    tax_status: 'active'
                };
                
                const createdTax = await supabaseRequest('/tax_types', {
                    method: 'POST',
                    body: JSON.stringify(newTax)
                });
                
                return createdTax[0].tax_id;
                
            } catch (error) {
                console.error('Error obteniendo tax_id:', error);
                throw new Error(`No se pudo obtener o crear tipo de impuesto: ${taxName}`);
            }
        }

        async function createBudgetItem(itemName, categoryId, taxId, accountCode, assignmentCategory) {
            const item = {
                item_name: itemName,
                item_status: 'active',
                category_id: categoryId,
                debit_or_credit: 'debit',
                tax_id: taxId,
                account_code: accountCode,
                variable_account: false,
                assignment_category: assignmentCategory
            };
            
            return await supabaseRequest('/budget_items', {
                method: 'POST',
                body: JSON.stringify(item)
            });
        }

        async function checkAccountExists(accountCode) {
            try {
                const result = await supabaseRequest('/chart_of_accounts?account_code=eq.' + accountCode + '&select=account_code');
                return result && result.length > 0;
            } catch (error) {
                console.error('Error checking account:', error);
                return false;
            }
        }

        async function createAccount(accountCode, accountName) {
            const account = {
                account_code: accountCode,
                account_name: accountName
            };
            
            return await supabaseRequest('/chart_of_accounts', {
                method: 'POST',
                body: JSON.stringify(account)
            });
        }

        async function createCategory(categoryName) {
            const category = {
                category_name: categoryName,
                category_status: 'active',
                for_tuition: false,
                self_sustaining: false
            };
            
            const result = await supabaseRequest('/budget_categories', {
                method: 'POST',
                body: JSON.stringify(category)
            });
            
            return result[0].category_id;
        }

        async function checkItemExists(itemName) {
            try {
                const result = await supabaseRequest('/budget_items?item_name=eq.' + encodeURIComponent(itemName) + '&select=item_id');
                return result && result.length > 0;
            } catch (error) {
                console.error('Error checking item:', error);
                return false;
            }
        }

        function showProgress() {
            document.getElementById('progressCard').classList.remove('d-none');
            document.getElementById('resultsCard').classList.add('d-none');
        }

        function updateProgress(percentage, message) {
            const progressBar = document.getElementById('progressBar');
            const progressLabel = document.getElementById('progressLabel');
            const progressDetails = document.getElementById('progressDetails');
            
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
            progressLabel.textContent = `Progreso: ${Math.round(percentage)}%`;
            progressDetails.textContent = message;
        }

        function hideProgress() {
            document.getElementById('progressCard').classList.add('d-none');
        }

        function showResults(results) {
            const resultsCard = document.getElementById('resultsCard');
            const resultsHeader = document.getElementById('resultsHeader');
            const summaryGrid = document.getElementById('summaryGrid');
            const errorSection = document.getElementById('errorSection');
            const errorList = document.getElementById('errorList');
            
            const isSuccess = results.processedLines > 0;
            const hasErrors = results.errors.length > 0;
            
            if (results.mode === 'PUC') {
                resultsHeader.className = `card-header ${isSuccess ? 'bg-info text-white' : 'bg-warning text-dark'}`;
                resultsHeader.innerHTML = `
                    <h5 class="mb-0">
                        <i class="bi bi-list-columns"></i> Resultados - Carga Solo PUC
                    </h5>
                `;
            } else if (results.mode === 'COMBO') {
                resultsHeader.className = `card-header ${isSuccess ? 'bg-success text-white' : 'bg-warning text-dark'}`;
                resultsHeader.innerHTML = `
                    <h5 class="mb-0">
                        <i class="bi bi-stack"></i> Resultados - Combo Completo
                    </h5>
                `;
            }
            
            if (results.mode === 'PUC') {
                summaryGrid.innerHTML = `
                    <div class="summary-item">
                        <div class="summary-number text-primary">${results.totalLines}</div>
                        <div class="text-muted">Total Filas</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number text-success">${results.processedLines}</div>
                        <div class="text-muted">Procesadas</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number text-warning">${results.skippedLines}</div>
                        <div class="text-muted">Omitidas</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number text-info">${results.createdAccounts}</div>
                        <div class="text-muted">Cuentas PUC Creadas</div>
                    </div>
                `;
            } else if (results.mode === 'COMBO') {
                summaryGrid.innerHTML = `
                    <div class="summary-item">
                        <div class="summary-number text-primary">${results.totalLines}</div>
                        <div class="text-muted">Total Filas</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number text-success">${results.processedLines}</div>
                        <div class="text-muted">Procesadas</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number text-warning">${results.skippedLines}</div>
                        <div class="text-muted">Omitidas</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number text-info">${results.createdAccounts}</div>
                        <div class="text-muted">Cuentas PUC</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number text-info">${results.createdCategories}</div>
                        <div class="text-muted">Rubros</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number text-info">${results.createdItems}</div>
                        <div class="text-muted">Sub-ítems</div>
                    </div>
                `;
            }
            
            if (hasErrors) {
                errorList.innerHTML = results.errors.map(error => 
                    `<div class="mb-2"><i class="bi bi-exclamation-circle text-danger"></i> ${escapeHtml(error)}</div>`
                ).join('');
                errorSection.classList.remove('d-none');
            } else {
                errorSection.classList.add('d-none');
            }
            
            resultsCard.classList.remove('d-none');
            
            let message;
            if (results.mode === 'PUC') {
                message = isSuccess ? 
                    `Modo PUC completado. ${results.processedLines} cuentas procesadas, ${results.createdAccounts} nuevas cuentas creadas.` :
                    'No se procesaron cuentas PUC. Revise el formato del archivo.';
            } else {
                message = isSuccess ? 
                    `Combo completo procesado. ${results.processedLines} filas procesadas, ${results.createdAccounts + results.createdCategories + results.createdItems} registros creados.` :
                    'No se procesaron filas. Revise el formato del archivo y los errores mostrados.';
            }
            
            showMessage(message, isSuccess ? 'success' : 'warning');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
