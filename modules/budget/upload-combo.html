<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subir el Combo - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        .page-header {
            background: linear-gradient(135deg, #2c5530 0%, #3d7c47 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }
        
        .upload-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .file-drop-zone {
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }
        
        .file-drop-zone.dragover {
            border-color: #2c5530;
            background-color: #e8f5e8;
        }
        
        .file-drop-zone.has-file {
            border-color: #28a745;
            background-color: #d4edda;
        }
        
        .format-info {
            background: linear-gradient(45deg, #e3f2fd, #f3e5f5);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .progress-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .results-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .error-list {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .summary-item {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .summary-number {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .btn-file {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .btn-file input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            background: white;
            cursor: inherit;
            display: block;
        }
        
        .table-preview {
            font-size: 0.9rem;
        }
        
        .table-preview th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        
        @media (max-width: 768px) {
            .file-drop-zone {
                padding: 2rem 1rem;
            }
            
            .upload-icon {
                font-size: 3rem;
            }
            
            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard.html">
                <i class="bi bi-house-door"></i> SchoolNet
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/modules/budget/index.html">Presupuesto</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Subir el Combo</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> <span id="userName">Usuario</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/profile.html">Perfil</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">Cerrar Sesi√≥n</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="bi bi-upload"></i> Subir el Combo
                    </h1>
                    <p class="mb-0">Carga masiva de PUC, Rubros y Sub-√≠tems desde archivo CSV</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light" onclick="showHelp()">
                        <i class="bi bi-question-circle"></i> Ayuda
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Format Information -->
        <div class="format-info">
            <h5 class="mb-3">
                <i class="bi bi-info-circle text-primary"></i> Formato del Archivo CSV
            </h5>
            <div class="row">
                <div class="col-md-8">
                    <p class="mb-2"><strong>El archivo CSV debe contener las siguientes columnas en orden:</strong></p>
                    <ol class="mb-3">
                        <li><strong>C√≥digo PUC</strong> - C√≥digo √∫nico de la cuenta contable</li>
                        <li><strong>ID IVA</strong> - Identificador del tipo de impuesto (opcional)</li>
                        <li><strong>Nombre PUC</strong> - Nombre descriptivo de la cuenta</li>
                        <li><strong>Nombre Rubro</strong> - Categor√≠a presupuestal</li>
                        <li><strong>Nombre Sub-√≠tem</strong> - Detalle espec√≠fico del rubro</li>
                        <li><strong>Categor√≠a</strong> - Clasificaci√≥n del sub-√≠tem</li>
                    </ol>
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Nota:</strong> La primera fila debe contener los encabezados y ser√° ignorada autom√°ticamente.
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="table-responsive">
                        <table class="table table-sm table-preview table-bordered">
                            <thead>
                                <tr>
                                    <th>Columna</th>
                                    <th>Ejemplo</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>C√≥digo PUC</td><td>1105</td></tr>
                                <tr><td>ID IVA</td><td>1</td></tr>
                                <tr><td>Nombre PUC</td><td>Caja General</td></tr>
                                <tr><td>Nombre Rubro</td><td>Gastos Generales</td></tr>
                                <tr><td>Nombre Sub-√≠tem</td><td>√ötiles de Oficina</td></tr>
                                <tr><td>Categor√≠a</td><td>Operativo</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="card upload-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-cloud-upload"></i> Cargar Archivo CSV
                </h5>
            </div>
            <div class="card-body">
                <div class="file-drop-zone" id="dropZone">
                    <div class="upload-icon">
                        <i class="bi bi-cloud-upload" id="uploadIcon"></i>
                    </div>
                    <h5 id="dropZoneTitle">Arrastra tu archivo CSV aqu√≠</h5>
                    <p class="text-muted mb-3" id="dropZoneText">o haz clic para seleccionar un archivo</p>
                    
                    <div class="btn-file">
                        <button class="btn btn-primary btn-lg" id="selectFileBtn">
                            <i class="bi bi-folder2-open"></i> Seleccionar Archivo
                        </button>
                        <input type="file" id="csvFile" accept=".csv,text/csv">
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            Formato soportado: CSV (m√°ximo 50MB)
                        </small>
                    </div>
                </div>
                
                <div id="fileInfo" class="mt-4 d-none">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-file-earmark-text"></i> Archivo Seleccionado</h6>
                        <div id="fileDetails"></div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-center gap-3 mt-4">
                    <button class="btn btn-success btn-lg" id="processBtn" disabled onclick="processFile()">
                        <i class="bi bi-gear"></i> Procesar Archivo
                    </button>
                    <button class="btn btn-outline-secondary btn-lg" onclick="clearFile()">
                        <i class="bi bi-x-lg"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="card progress-card d-none" id="progressCard">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-hourglass-split"></i> Procesando Archivo
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label" id="progressLabel">Inicializando...</label>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="progressBar" 
                             role="progressbar" 
                             style="width: 0%">
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <small class="text-muted" id="progressDetails">Preparando procesamiento...</small>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card results-card d-none" id="resultsCard">
            <div class="card-header" id="resultsHeader">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-data"></i> Resultados del Procesamiento
                </h5>
            </div>
            <div class="card-body">
                <div class="summary-grid" id="summaryGrid">
                    <!-- Summary items will be inserted here -->
                </div>
                
                <div id="errorSection" class="d-none">
                    <h6 class="text-danger">
                        <i class="bi bi-exclamation-triangle"></i> Errores Encontrados
                    </h6>
                    <div class="error-list" id="errorList">
                        <!-- Error list will be inserted here -->
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Procesar Otro Archivo
                    </button>
                    <a href="/modules/budget/index.html" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver al M√≥dulo
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <h5 id="loadingTitle">Procesando archivo...</h5>
            <p class="text-muted mb-0" id="loadingMessage">Por favor espere mientras procesamos su archivo CSV</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Config JS -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // Variables globales
        let currentUser = null;
        let selectedFile = null;
        let isProcessing = false;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // Validar acceso antes de continuar
                const hasAccess = await validatePageAccess('Subir el combo');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                
                // Verificar sesi√≥n
                const session = getStoredSession();
                if (!session || !session.user) {
                    window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                currentUser = session.user;
                document.getElementById('userName').textContent = currentUser.user_display_name || currentUser.user_name;
                
                // Configurar eventos
                setupEventListeners();
                
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });

        function setupEventListeners() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('csvFile');
            
            // Drag and drop events
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelection(files[0]);
                }
            });
            
            // File input change
            fileInput.addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    handleFileSelection(this.files[0]);
                }
            });
            
            // Click on drop zone to trigger file selection
            dropZone.addEventListener('click', function() {
                if (!isProcessing) {
                    fileInput.click();
                }
            });
        }

        function handleFileSelection(file) {
            // Validar archivo
            if (!validateFile(file)) return;
            
            selectedFile = file;
            updateFileDisplay();
            showFileInfo();
            
            // Habilitar bot√≥n de procesamiento
            document.getElementById('processBtn').disabled = false;
        }

        function validateFile(file) {
            // Validar extensi√≥n
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showMessage('Por favor selecciona un archivo con extensi√≥n .csv', 'danger');
                return false;
            }
            
            // Validar tama√±o (m√°ximo 50MB)
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                showMessage('El archivo es demasiado grande. M√°ximo permitido: 50MB', 'danger');
                return false;
            }
            
            return true;
        }

        function updateFileDisplay() {
            const dropZone = document.getElementById('dropZone');
            const uploadIcon = document.getElementById('uploadIcon');
            const title = document.getElementById('dropZoneTitle');
            const text = document.getElementById('dropZoneText');
            
            dropZone.classList.add('has-file');
            uploadIcon.className = 'bi bi-file-earmark-check';
            title.textContent = 'Archivo seleccionado';
            text.textContent = selectedFile.name;
        }

        function showFileInfo() {
            const fileInfo = document.getElementById('fileInfo');
            const fileDetails = document.getElementById('fileDetails');
            
            fileDetails.innerHTML = `
                <div class="row">
                    <div class="col-sm-3"><strong>Nombre:</strong></div>
                    <div class="col-sm-9">${selectedFile.name}</div>
                </div>
                <div class="row">
                    <div class="col-sm-3"><strong>Tama√±o:</strong></div>
                    <div class="col-sm-9">${formatFileSize(selectedFile.size)}</div>
                </div>
                <div class="row">
                    <div class="col-sm-3"><strong>Tipo:</strong></div>
                    <div class="col-sm-9">${selectedFile.type || 'text/csv'}</div>
                </div>
                <div class="row">
                    <div class="col-sm-3"><strong>√öltima modificaci√≥n:</strong></div>
                    <div class="col-sm-9">${formatDate(selectedFile.lastModified)}</div>
                </div>
            `;
            
            fileInfo.classList.remove('d-none');
        }

        function clearFile() {
            selectedFile = null;
            document.getElementById('csvFile').value = '';
            document.getElementById('fileInfo').classList.add('d-none');
            document.getElementById('processBtn').disabled = true;
            
            // Resetear display
            const dropZone = document.getElementById('dropZone');
            const uploadIcon = document.getElementById('uploadIcon');
            const title = document.getElementById('dropZoneTitle');
            const text = document.getElementById('dropZoneText');
            
            dropZone.classList.remove('has-file');
            uploadIcon.className = 'bi bi-cloud-upload';
            title.textContent = 'Arrastra tu archivo CSV aqu√≠';
            text.textContent = 'o haz clic para seleccionar un archivo';
            
            // Ocultar resultados
            document.getElementById('resultsCard').classList.add('d-none');
            document.getElementById('progressCard').classList.add('d-none');
        }

        async function processFile() {
            if (!selectedFile || isProcessing) return;
            
            isProcessing = true;
            showProgress();
            
            try {
                // Leer archivo
                const fileContent = await readFileAsText(selectedFile);
                
                // Validar contenido
                updateProgress(10, 'Validando formato del archivo...');
                const validation = validateCSVContent(fileContent);
                if (!validation.valid) {
                    throw new Error(validation.error);
                }
                
                // Procesar CSV
                updateProgress(20, 'Procesando filas del CSV...');
                const result = await processCSVContent(fileContent);
                
                updateProgress(100, 'Procesamiento completado');
                
                // Mostrar resultados
                setTimeout(() => {
                    hideProgress();
                    showResults(result);
                    isProcessing = false;
                }, 1000);
                
            } catch (error) {
                console.error('Error procesando archivo:', error);
                hideProgress();
                showMessage('Error al procesar el archivo: ' + error.message, 'danger');
                isProcessing = false;
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('Error al leer el archivo'));
                reader.readAsText(file, 'UTF-8');
            });
        }

        function validateCSVContent(content) {
            const lines = content.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length < 2) {
                return {
                    valid: false,
                    error: 'El archivo debe tener al menos una fila de datos adem√°s del encabezado'
                };
            }
            
            // Validar primeras filas
            const sampleLines = lines.slice(0, Math.min(5, lines.length));
            for (let i = 0; i < sampleLines.length; i++) {
                const columns = parseCSVLine(sampleLines[i]);
                if (columns.length < 6) {
                    return {
                        valid: false,
                        error: `La fila ${i + 1} tiene solo ${columns.length} columnas. Se esperan al menos 6 columnas.`
                    };
                }
            }
            
            return { valid: true };
        }

        async function processCSVContent(content) {
            const lines = content.split('\n').filter(line => line.trim() !== '');
            const results = {
                totalLines: lines.length - 1, // -1 para excluir encabezado
                processedLines: 0,
                skippedLines: 0,
                createdAccounts: 0,
                createdCategories: 0,
                createdItems: 0,
                errors: []
            };
            
            // Procesar l√≠nea por l√≠nea (saltando encabezado)
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;
                
                try {
                    updateProgress(20 + (60 * i / lines.length), `Procesando fila ${i} de ${lines.length - 1}...`);
                    
                    const columns = parseCSVLine(line);
                    if (columns.length < 6) {
                        results.errors.push(`Fila ${i + 1}: Insuficientes columnas (${columns.length}/6)`);
                        results.skippedLines++;
                        continue;
                    }
                    
                    const lineResult = await processCSVLine(columns, i + 1);
                    
                    if (lineResult.success) {
                        results.processedLines++;
                        results.createdAccounts += lineResult.createdAccounts || 0;
                        results.createdCategories += lineResult.createdCategories || 0;
                        results.createdItems += lineResult.createdItems || 0;
                    } else {
                        results.errors.push(`Fila ${i + 1}: ${lineResult.error}`);
                        results.skippedLines++;
                    }
                    
                } catch (error) {
                    results.errors.push(`Fila ${i + 1}: ${error.message}`);
                    results.skippedLines++;
                }
            }
            
            return results;
        }

        function parseCSVLine(line) {
            const result = [];
            let currentColumn = '';
            let insideQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    insideQuotes = !insideQuotes;
                } else if (char === ',' && !insideQuotes) {
                    result.push(currentColumn.trim());
                    currentColumn = '';
                } else {
                    currentColumn += char;
                }
            }
            
            result.push(currentColumn.trim());
            return result;
        }

        async function processCSVLine(columns, lineNumber) {
            const [pucCode, ivaId, pucName, categoryName, itemName, assignmentCategory] = columns.map(col => col.trim());
            
            // Validar datos requeridos
            if (!pucCode || !pucName || !categoryName || !itemName) {
                throw new Error('Faltan datos requeridos en las columnas principales');
            }
            
            let createdAccounts = 0;
            let createdCategories = 0;
            let createdItems = 0;
            
            try {
                // 1. Procesar chart_of_accounts (PUC)
                const accountExists = await checkAccountExists(pucCode);
                if (!accountExists) {
                    await createAccount(pucCode, pucName);
                    createdAccounts = 1;
                }
                
                // 2. Procesar budget_categories (Rubros)
                const categoryExists = await checkCategoryExists(categoryName);
                let categoryId;
                if (!categoryExists) {
                    categoryId = await createCategory(categoryName);
                    createdCategories = 1;
                } else {
                    categoryId = await getCategoryId(categoryName);
                }
                
                // 3. Procesar budget_items (Sub-items)
                const itemExists = await checkItemExists(itemName);
                if (!itemExists) {
                    const debitOrCredit = calculateDebitOrCredit(pucCode);
                    await createItem(itemName, categoryId, debitOrCredit, ivaId, pucCode, assignmentCategory);
                    createdItems = 1;
                }
                
                return {
                    success: true,
                    createdAccounts,
                    createdCategories,
                    createdItems
                };
                
            } catch (error) {
                throw new Error(`Error procesando datos: ${error.message}`);
            }
        }

        async function checkAccountExists(accountCode) {
            try {
                const result = await supabaseRequest(`/chart_of_accounts?account_code=eq.${accountCode}&select=account_code`);
                return result && result.length > 0;
            } catch (error) {
                console.error('Error checking account:', error);
                return false;
            }
        }

        async function createAccount(accountCode, accountName) {
            const account = {
                account_code: accountCode,
                account_name: accountName
            };
            
            return await supabaseRequest('/chart_of_accounts', {
                method: 'POST',
                body: JSON.stringify(account)
            });
        }

        async function checkCategoryExists(categoryName) {
            try {
                const result = await supabaseRequest(`/budget_categories?category_name=eq.${encodeURIComponent(categoryName)}&select=category_id`);
                return result && result.length > 0;
            } catch (error) {
                console.error('Error checking category:', error);
                return false;
            }
        }

        async function createCategory(categoryName) {
            const category = {
                category_name: categoryName,
                category_status: 'active',
                for_tuition: false,
                self_sustaining: false
            };
            
            const result = await supabaseRequest('/budget_categories', {
                method: 'POST',
                body: JSON.stringify(category)
            });
            
            return result[0].category_id;
        }

        async function getCategoryId(categoryName) {
            const result = await supabaseRequest(`/budget_categories?category_name=eq.${encodeURIComponent(categoryName)}&select=category_id`);
            return result[0].category_id;
        }

        async function checkItemExists(itemName) {
            try {
                const result = await supabaseRequest(`/budget_items?item_name=eq.${encodeURIComponent(itemName)}&select=item_id`);
                return result && result.length > 0;
            } catch (error) {
                console.error('Error checking item:', error);
                return false;
            }
        }

        async function createItem(itemName, categoryId, debitOrCredit, ivaId, accountCode, assignmentCategory) {
            // Para esta versi√≥n inicial, usaremos un tax_id por defecto
            // TODO: Implementar lookup real cuando tax_types est√© poblada
            const defaultTaxId = await getDefaultTaxId();
            
            const item = {
                item_name: itemName,
                item_status: 'active',
                category_id: categoryId,
                debit_or_credit: debitOrCredit,
                tax_id: defaultTaxId, // Usar tax_id por defecto por ahora
                account_code: accountCode,
                variable_account: false,
                assignment_category: assignmentCategory
            };
            
            return await supabaseRequest('/budget_items', {
                method: 'POST',
                body: JSON.stringify(item)
            });
        }

        async function getDefaultTaxId() {
            // Por ahora crear un tipo de impuesto por defecto si no existe
            try {
                let taxTypes = await supabaseRequest('/tax_types?select=tax_id&limit=1');
                if (taxTypes && taxTypes.length > 0) {
                    return taxTypes[0].tax_id;
                }
                
                // Crear tipo de impuesto por defecto
                const defaultTax = {
                    tax_name: 'Sin Impuesto',
                    tax_status: 'active'
                };
                
                const result = await supabaseRequest('/tax_types', {
                    method: 'POST',
                    body: JSON.stringify(defaultTax)
                });
                
                return result[0].tax_id;
                
            } catch (error) {
                console.error('Error getting default tax:', error);
                throw new Error('No se pudo obtener o crear tipo de impuesto por defecto');
            }
        }

        function calculateDebitOrCredit(pucCode) {
            const firstDigit = pucCode.charAt(0);
            switch (firstDigit) {
                case '1':
                case '5':
                    return 'credit';
                case '2':
                case '4':
                    return 'debit';
                default:
                    return 'debit'; // Valor por defecto
            }
        }

        function showProgress() {
            document.getElementById('progressCard').classList.remove('d-none');
            document.getElementById('resultsCard').classList.add('d-none');
        }

        function updateProgress(percentage, message) {
            const progressBar = document.getElementById('progressBar');
            const progressLabel = document.getElementById('progressLabel');
            const progressDetails = document.getElementById('progressDetails');
            
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
            progressLabel.textContent = `Progreso: ${Math.round(percentage)}%`;
            progressDetails.textContent = message;
        }

        function hideProgress() {
            document.getElementById('progressCard').classList.add('d-none');
        }

        function showResults(results) {
            const resultsCard = document.getElementById('resultsCard');
            const resultsHeader = document.getElementById('resultsHeader');
            const summaryGrid = document.getElementById('summaryGrid');
            const errorSection = document.getElementById('errorSection');
            const errorList = document.getElementById('errorList');
            
            // Determinar tipo de resultado
            const isSuccess = results.processedLines > 0;
            const hasErrors = results.errors.length > 0;
            
            // Actualizar header
            resultsHeader.className = `card-header ${isSuccess ? 'bg-success text-white' : 'bg-warning text-dark'}`;
            
            // Crear resumen
            summaryGrid.innerHTML = `
                <div class="summary-item">
                    <div class="summary-number text-primary">${results.totalLines}</div>
                    <div class="text-muted">Total Filas</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number text-success">${results.processedLines}</div>
                    <div class="text-muted">Procesadas</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number text-warning">${results.skippedLines}</div>
                    <div class="text-muted">Omitidas</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number text-info">${results.createdAccounts}</div>
                    <div class="text-muted">Cuentas PUC</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number text-info">${results.createdCategories}</div>
                    <div class="text-muted">Rubros</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number text-info">${results.createdItems}</div>
                    <div class="text-muted">Sub-√≠tems</div>
                </div>
            `;
            
            // Mostrar errores si los hay
            if (hasErrors) {
                errorList.innerHTML = results.errors.map(error => 
                    `<div class="mb-2"><i class="bi bi-exclamation-circle text-danger"></i> ${escapeHtml(error)}</div>`
                ).join('');
                errorSection.classList.remove('d-none');
            } else {
                errorSection.classList.add('d-none');
            }
            
            resultsCard.classList.remove('d-none');
            
            // Mostrar mensaje final
            const message = isSuccess ? 
                `Archivo procesado exitosamente. ${results.processedLines} filas procesadas.` :
                'No se procesaron filas. Revise el formato del archivo y los errores mostrados.';
                
            showMessage(message, isSuccess ? 'success' : 'warning');
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getStoredSession() {
            try {
                const sessionData = localStorage.getItem('nextSystemSession') || sessionStorage.getItem('nextSystemSession');
                return sessionData ? JSON.parse(sessionData) : null;
            } catch (error) {
                return null;
            }
        }

        function logout() {
            localStorage.removeItem('nextSystemSession');
            sessionStorage.removeItem('nextSystemSession');
            window.location.href = '/login.html';
        }

        function showHelp() {
            alert('Ayuda para Subir el Combo:\n\n' +
                  '‚Ä¢ Formato CSV con 6 columnas separadas por comas\n' +
                  '‚Ä¢ Primera fila debe contener encabezados (ser√° ignorada)\n' +
                  '‚Ä¢ Todas las columnas son obligatorias excepto ID IVA\n' +
                  '‚Ä¢ El sistema evita duplicados autom√°ticamente\n' +
                  '‚Ä¢ M√°ximo tama√±o de archivo: 50MB\n' +
                  '‚Ä¢ Se crear√°n cuentas PUC, rubros y sub-√≠tems seg√∫n sea necesario');
        }

        // Inicializar p√°gina con config.js
        if (window.SUPABASE_CONFIG) {
            initializePage('upload-combo', 'Subir el Combo');
        } else {
            setTimeout(() => initializePage('upload-combo', 'Subir el Combo'), 100);
        }
    </script>
</body>
</html>
