<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA -->
    <meta name="page-version" content="25.11.27.13.44">
    
    <title>Visualizar Reportes - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- jsPDF y html2canvas para exportaci√≥n PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos espec√≠ficos del reporte */
        .report-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .report-header {
            background: linear-gradient(135deg, #1B365D 0%, #2c4a7c 100%);
            color: white;
            padding: 24px;
            border-radius: 8px 8px 0 0;
        }
        
        .report-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .report-header .report-meta {
            opacity: 0.85;
            font-size: 0.9rem;
            margin-top: 8px;
        }
        
        .report-body {
            padding: 0;
        }
        
        /* Tabla del reporte */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .report-table th {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 12px 16px;
            text-align: right;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .report-table th:first-child {
            text-align: left;
            width: 40%;
        }
        
        .report-table td {
            padding: 10px 16px;
            border-bottom: 1px solid #eee;
            text-align: right;
        }
        
        .report-table td:first-child {
            text-align: left;
        }
        
        /* Filas de secci√≥n */
        .row-level-1 {
            background: #e3f2fd;
            font-weight: 700;
            font-size: 0.95rem;
        }
        
        .row-level-2 {
            background: #f5f5f5;
            font-weight: 600;
        }
        
        .row-level-3 {
            background: #fafafa;
            font-weight: 500;
        }
        
        .row-line {
            font-weight: 400;
        }
        
        .row-subtotal {
            background: #fff3e0;
            font-weight: 600;
            border-top: 1px solid #ffcc80;
        }
        
        .row-total {
            background: #1B365D;
            color: white;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .row-total td {
            border-bottom: none;
        }
        
        /* Indentaci√≥n */
        .indent-0 { padding-left: 16px !important; }
        .indent-1 { padding-left: 32px !important; }
        .indent-2 { padding-left: 48px !important; }
        .indent-3 { padding-left: 64px !important; }
        .indent-line { padding-left: 80px !important; }
        
        /* Indicadores de signo */
        .sign-negative {
            color: #c62828;
        }
        
        .sign-indicator {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-left: 4px;
        }
        
        /* Valores */
        .value-positive { color: #2e7d32; }
        .value-negative { color: #c62828; }
        .value-zero { color: #9e9e9e; }
        
        /* Porcentaje de ejecuci√≥n */
        .progress-cell {
            min-width: 100px;
        }
        
        .progress-mini {
            height: 6px;
            border-radius: 3px;
            margin-top: 4px;
        }
        
        /* Resumen ejecutivo */
        .executive-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .summary-card {
            text-align: center;
            padding: 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .summary-card .label {
            font-size: 0.85rem;
            color: #666;
        }
        
        .summary-card.positive .value { color: #2e7d32; }
        .summary-card.negative .value { color: #c62828; }
        .summary-card.neutral .value { color: #1565c0; }
        
        /* Filtros */
        .filters-bar {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        
        /* Expandir/Colapsar */
        .toggle-btn {
            cursor: pointer;
            user-select: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .toggle-btn i {
            transition: transform 0.2s;
        }
        
        .toggle-btn.collapsed i {
            transform: rotate(-90deg);
        }
        
        .row-hidden {
            display: none;
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .report-container {
                box-shadow: none;
            }
            
            .report-header {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .report-table th,
            .row-level-1,
            .row-level-2,
            .row-subtotal,
            .row-total {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .report-table {
                font-size: 0.8rem;
            }
            
            .report-table th,
            .report-table td {
                padding: 8px 10px;
            }
            
            .summary-card .value {
                font-size: 1.2rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0" id="loading-text">Cargando...</p>
        </div>
    </div>

    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3 no-print">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Presupuesto</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Visualizar Reportes
                </li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4 no-print">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-bar-chart-line me-2"></i>
                    Visualizar Reportes Presupuestales
                </h1>
                <p class="text-muted">
                    Consulte y exporte los reportes presupuestales configurados.
                </p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer" class="no-print"></div>

        <!-- Filtros -->
        <div class="filters-bar no-print">
            <div class="row align-items-end">
                <div class="col-md-4 mb-3 mb-md-0">
                    <label for="select-reporte" class="form-label fw-bold">
                        <i class="bi bi-file-earmark-bar-graph me-1"></i>Reporte
                    </label>
                    <select class="form-select" id="select-reporte" onchange="cambiarReporte()">
                        <option value="">Seleccione un reporte...</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3 mb-md-0">
                    <label for="select-ano" class="form-label fw-bold">
                        <i class="bi bi-calendar3 me-1"></i>A√±o Acad√©mico
                    </label>
                    <select class="form-select" id="select-ano" onchange="generarReporte()">
                        <option value="">Seleccione un a√±o...</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3 mb-md-0">
                    <label for="select-vista" class="form-label fw-bold">
                        <i class="bi bi-eye me-1"></i>Vista
                    </label>
                    <select class="form-select" id="select-vista" onchange="generarReporte()">
                        <option value="completa">Completa (con detalle)</option>
                        <option value="resumida">Resumida (solo secciones)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary flex-grow-1" onclick="generarReporte()" id="btn-generar" disabled>
                            <i class="bi bi-arrow-clockwise me-1"></i>Generar
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown" id="btn-exportar" disabled>
                                <i class="bi bi-download"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="exportarPDF()"><i class="bi bi-file-pdf me-2"></i>Exportar PDF</a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportarExcel()"><i class="bi bi-file-excel me-2"></i>Exportar Excel</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="window.print()"><i class="bi bi-printer me-2"></i>Imprimir</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor del Reporte -->
        <div id="reporte-contenedor">
            <!-- Estado inicial: sin reporte seleccionado -->
            <div class="text-center py-5" id="estado-inicial">
                <i class="bi bi-bar-chart-line text-muted" style="font-size: 4rem;"></i>
                <h5 class="mt-3 text-muted">Seleccione un reporte y a√±o acad√©mico</h5>
                <p class="text-muted">Los datos se calcular√°n autom√°ticamente</p>
            </div>
            
            <!-- Contenido del reporte (inicialmente oculto) -->
            <div id="reporte-contenido" style="display: none;">
                
                <!-- Resumen Ejecutivo -->
                <div class="executive-summary" id="resumen-ejecutivo">
                    <h6 class="mb-3"><i class="bi bi-speedometer2 me-2"></i>Resumen Ejecutivo</h6>
                    <div class="row" id="resumen-cards">
                        <!-- Cards din√°micas -->
                    </div>
                </div>
                
                <!-- Reporte Principal -->
                <div class="report-container" id="reporte-principal">
                    <div class="report-header">
                        <h2 id="reporte-titulo">Nombre del Reporte</h2>
                        <div class="report-meta">
                            <span id="reporte-ano-label">A√±o Acad√©mico: </span>
                            <span class="mx-2">|</span>
                            <span id="reporte-fecha">Generado: </span>
                        </div>
                    </div>
                    <div class="report-body">
                        <div class="table-responsive">
                            <table class="report-table" id="tabla-reporte">
                                <thead>
                                    <tr>
                                        <th>
                                            <span class="toggle-btn" onclick="toggleTodos()" title="Expandir/Colapsar todo">
                                                <i class="bi bi-chevron-down"></i>
                                                Concepto
                                            </span>
                                        </th>
                                        <th>Aprobado</th>
                                        <th>Ejecutado</th>
                                        <th>Disponible</th>
                                        <th class="progress-cell">% Ejecuci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-body">
                                    <!-- Filas din√°micas -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Notas al pie -->
                <div class="mt-3 text-muted small" id="notas-pie">
                    <p class="mb-1"><i class="bi bi-info-circle me-1"></i>Los valores est√°n expresados en pesos colombianos (COP).</p>
                    <p class="mb-0"><i class="bi bi-clock me-1"></i>√öltima actualizaci√≥n: <span id="ultima-actualizacion"></span></p>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let reportesCache = [];
        let anosCache = [];
        let estructuraCache = { secciones: [], lineas: [] };
        let itemsCache = [];
        let asignacionesCache = [];
        let reporteActual = null;
        let datosCalculados = null;
        let estadoExpandido = {}; // Para tracking de secciones expandidas/colapsadas
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // Validar permisos
                const hasAccess = await validatePageAccess('Visualizar Reportes');
                if (!hasAccess) return;
                
                console.log('‚úÖ Acceso permitido');
                
                // Verificar sesi√≥n
                const session = getStoredSession();
                if (!session) {
                    showMessage('Sesi√≥n no v√°lida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '../../login.html', 1500);
                    return;
                }
                
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                showMessage('Error de validaci√≥n: ' + error.message, 'danger');
            }
        });
        
        async function inicializarPagina() {
            try {
                console.log('üöÄ Inicializando p√°gina...');
                mostrarLoading('Cargando datos...');
                
                // Cargar datos en paralelo
                await Promise.all([
                    cargarReportes(),
                    cargarAnosAcademicos(),
                    cargarItems()
                ]);
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        async function cargarReportes() {
            try {
                const data = await supabaseRequest('/budget_reports?select=*&report_status=eq.active&order=report_name.asc');
                reportesCache = data || [];
                
                const select = document.getElementById('select-reporte');
                select.innerHTML = '<option value="">Seleccione un reporte...</option>';
                reportesCache.forEach(r => {
                    select.innerHTML += `<option value="${r.report_id}">${r.report_name}</option>`;
                });
                
            } catch (error) {
                console.error('‚ùå Error cargando reportes:', error);
                showMessage('Error al cargar reportes', 'danger');
            }
        }
        
        async function cargarAnosAcademicos() {
            try {
                const data = await supabaseRequest('/academic_years?select=year_id,year_name,is_current&order=year_name.desc');
                anosCache = data || [];
                
                const select = document.getElementById('select-ano');
                select.innerHTML = '<option value="">Seleccione un a√±o...</option>';
                anosCache.forEach(a => {
                    const current = a.is_current ? ' (Actual)' : '';
                    select.innerHTML += `<option value="${a.year_id}" ${a.is_current ? 'selected' : ''}>${a.year_name}${current}</option>`;
                });
                
                // Si hay a√±o actual seleccionado, habilitar bot√≥n
                if (select.value) {
                    verificarHabilitarBoton();
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando a√±os:', error);
            }
        }
        
        async function cargarItems() {
            try {
                const data = await supabaseRequest('/budget_items?select=*,budget_categories(category_name)&item_status=eq.active');
                itemsCache = data || [];
            } catch (error) {
                console.error('‚ùå Error cargando √≠tems:', error);
            }
        }
        
        async function cargarEstructuraReporte(reportId) {
            try {
                // Cargar secciones
                const secciones = await supabaseRequest(
                    `/budget_report_sections?select=*&report_id=eq.${reportId}&order=section_order.asc`
                );
                
                // Cargar l√≠neas
                const seccionIds = secciones.map(s => s.section_id).join(',') || 'null';
                const lineas = await supabaseRequest(
                    `/budget_report_lines?select=*,budget_categories(category_id,category_name),budget_items(item_id,item_name,debit_or_credit,category_id)&section_id=in.(${seccionIds})&order=line_order.asc`
                );
                
                estructuraCache = {
                    secciones: secciones || [],
                    lineas: lineas || []
                };
                
                // Inicializar estado de expandido (todo expandido por defecto)
                secciones.forEach(s => {
                    if (estadoExpandido[s.section_id] === undefined) {
                        estadoExpandido[s.section_id] = true;
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Error cargando estructura:', error);
                throw error;
            }
        }
        
        async function cargarAsignaciones(yearId) {
            try {
                const data = await supabaseRequest(
                    `/budget_assignments?select=budget_item_id,approved_value,executed_value,requested_value&academic_year_id=eq.${yearId}&assignment_status=eq.active`
                );
                asignacionesCache = data || [];
            } catch (error) {
                console.error('‚ùå Error cargando asignaciones:', error);
                throw error;
            }
        }
        
        // ==========================================
        // GENERACI√ìN DEL REPORTE
        // ==========================================
        function cambiarReporte() {
            verificarHabilitarBoton();
            // Limpiar reporte anterior
            document.getElementById('reporte-contenido').style.display = 'none';
            document.getElementById('estado-inicial').style.display = 'block';
        }
        
        function verificarHabilitarBoton() {
            const reporteId = document.getElementById('select-reporte').value;
            const anoId = document.getElementById('select-ano').value;
            const btnGenerar = document.getElementById('btn-generar');
            const btnExportar = document.getElementById('btn-exportar');
            
            const habilitar = reporteId && anoId;
            btnGenerar.disabled = !habilitar;
            btnExportar.disabled = !habilitar || !datosCalculados;
        }
        
        async function generarReporte() {
            const reporteId = document.getElementById('select-reporte').value;
            const anoId = document.getElementById('select-ano').value;
            
            if (!reporteId || !anoId) {
                showMessage('Seleccione un reporte y un a√±o acad√©mico', 'warning');
                return;
            }
            
            try {
                mostrarLoading('Calculando reporte...');
                
                // Obtener datos del reporte
                reporteActual = reportesCache.find(r => r.report_id === reporteId);
                const anoActual = anosCache.find(a => a.year_id === anoId);
                
                // Cargar estructura y asignaciones
                await Promise.all([
                    cargarEstructuraReporte(reporteId),
                    cargarAsignaciones(anoId)
                ]);
                
                // Calcular valores
                datosCalculados = calcularReporte();
                
                // Renderizar
                renderizarReporte(anoActual);
                
                // Mostrar contenido
                document.getElementById('estado-inicial').style.display = 'none';
                document.getElementById('reporte-contenido').style.display = 'block';
                
                // Habilitar exportaci√≥n
                document.getElementById('btn-exportar').disabled = false;
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error generando reporte:', error);
                showMessage('Error al generar reporte: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        function calcularReporte() {
            // Crear mapa de valores por √≠tem
            const valoresPorItem = {};
            asignacionesCache.forEach(a => {
                if (!valoresPorItem[a.budget_item_id]) {
                    valoresPorItem[a.budget_item_id] = { approved: 0, executed: 0, requested: 0 };
                }
                valoresPorItem[a.budget_item_id].approved += a.approved_value || 0;
                valoresPorItem[a.budget_item_id].executed += a.executed_value || 0;
                valoresPorItem[a.budget_item_id].requested += a.requested_value || 0;
            });
            
            // Calcular valores para cada secci√≥n y l√≠nea
            const resultados = {
                secciones: {},
                lineas: {},
                totales: { approved: 0, executed: 0 }
            };
            
            // Procesar secciones de forma jer√°rquica
            const seccionesRaiz = estructuraCache.secciones.filter(s => !s.parent_section_id);
            
            seccionesRaiz.forEach(seccion => {
                const resultado = calcularSeccion(seccion, valoresPorItem, resultados);
                const signo = seccion.sign_modifier === 'negative' ? -1 : 1;
                resultados.totales.approved += resultado.approved * signo;
                resultados.totales.executed += resultado.executed * signo;
            });
            
            return resultados;
        }
        
        function calcularSeccion(seccion, valoresPorItem, resultados) {
            let totales = { approved: 0, executed: 0 };
            
            // Calcular l√≠neas directas
            const lineas = estructuraCache.lineas.filter(l => l.section_id === seccion.section_id);
            lineas.forEach(linea => {
                const valores = calcularLinea(linea, valoresPorItem);
                resultados.lineas[linea.line_id] = valores;
                totales.approved += valores.approved;
                totales.executed += valores.executed;
            });
            
            // Calcular subsecciones recursivamente
            const subsecciones = estructuraCache.secciones.filter(s => s.parent_section_id === seccion.section_id);
            subsecciones.forEach(sub => {
                const subResultado = calcularSeccion(sub, valoresPorItem, resultados);
                const signo = sub.sign_modifier === 'negative' ? -1 : 1;
                totales.approved += subResultado.approved * signo;
                totales.executed += subResultado.executed * signo;
            });
            
            resultados.secciones[seccion.section_id] = totales;
            return totales;
        }
        
        function calcularLinea(linea, valoresPorItem) {
            let valores = { approved: 0, executed: 0 };
            
            if (linea.line_type === 'item' && linea.item_id) {
                const itemValores = valoresPorItem[linea.item_id] || { approved: 0, executed: 0 };
                valores = { approved: itemValores.approved, executed: itemValores.executed };
            } else if (linea.line_type === 'category' && linea.category_id) {
                // Sumar todos los √≠tems de la categor√≠a
                const itemsCategoria = itemsCache.filter(i => i.category_id === linea.category_id);
                itemsCategoria.forEach(item => {
                    const itemValores = valoresPorItem[item.item_id] || { approved: 0, executed: 0 };
                    valores.approved += itemValores.approved;
                    valores.executed += itemValores.executed;
                });
            }
            
            // Aplicar inversi√≥n de signo
            if (linea.sign_override === 'invert') {
                valores.approved *= -1;
                valores.executed *= -1;
            }
            
            return valores;
        }
        
        // ==========================================
        // RENDERIZADO
        // ==========================================
        function renderizarReporte(anoActual) {
            // Header
            document.getElementById('reporte-titulo').textContent = reporteActual.report_name;
            document.getElementById('reporte-ano-label').textContent = `A√±o Acad√©mico: ${anoActual.year_name}`;
            document.getElementById('reporte-fecha').textContent = `Generado: ${new Date().toLocaleDateString('es-CO', { 
                day: '2-digit', 
                month: 'long', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}`;
            document.getElementById('ultima-actualizacion').textContent = new Date().toLocaleString('es-CO');
            
            // Resumen ejecutivo
            renderizarResumen();
            
            // Tabla principal
            renderizarTabla();
        }
        
        function renderizarResumen() {
            const container = document.getElementById('resumen-cards');
            const totales = datosCalculados.totales;
            const disponible = totales.approved - totales.executed;
            const porcentaje = totales.approved ? ((totales.executed / totales.approved) * 100) : 0;
            
            container.innerHTML = `
                <div class="col-6 col-md-3 mb-3 mb-md-0">
                    <div class="summary-card neutral">
                        <div class="value">${formatearMoneda(totales.approved)}</div>
                        <div class="label">Total Aprobado</div>
                    </div>
                </div>
                <div class="col-6 col-md-3 mb-3 mb-md-0">
                    <div class="summary-card ${totales.executed >= 0 ? 'neutral' : 'negative'}">
                        <div class="value">${formatearMoneda(totales.executed)}</div>
                        <div class="label">Total Ejecutado</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="summary-card ${disponible >= 0 ? 'positive' : 'negative'}">
                        <div class="value">${formatearMoneda(disponible)}</div>
                        <div class="label">Disponible</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="summary-card ${porcentaje > 100 ? 'negative' : porcentaje > 80 ? 'neutral' : 'positive'}">
                        <div class="value">${porcentaje.toFixed(1)}%</div>
                        <div class="label">% Ejecuci√≥n</div>
                    </div>
                </div>
            `;
        }
        
        function renderizarTabla() {
            const tbody = document.getElementById('tabla-body');
            const vistaResumida = document.getElementById('select-vista').value === 'resumida';
            
            let html = '';
            
            // Procesar secciones de nivel 1
            const seccionesRaiz = estructuraCache.secciones.filter(s => !s.parent_section_id);
            
            seccionesRaiz.forEach(seccion => {
                html += renderizarSeccion(seccion, 0, vistaResumida);
            });
            
            tbody.innerHTML = html;
        }
        
        function renderizarSeccion(seccion, nivel, vistaResumida) {
            const valores = datosCalculados.secciones[seccion.section_id] || { approved: 0, executed: 0 };
            const disponible = valores.approved - valores.executed;
            const porcentaje = valores.approved ? ((valores.executed / valores.approved) * 100) : 0;
            
            const isExpanded = estadoExpandido[seccion.section_id] !== false;
            const tieneHijos = estructuraCache.secciones.some(s => s.parent_section_id === seccion.section_id) ||
                              estructuraCache.lineas.some(l => l.section_id === seccion.section_id);
            
            // Clase de fila seg√∫n tipo
            let rowClass = `row-level-${nivel + 1}`;
            if (seccion.section_type === 'total') rowClass = 'row-total';
            else if (seccion.section_type === 'subtotal') rowClass = 'row-subtotal';
            
            const signoIndicator = seccion.sign_modifier === 'negative' ? '<span class="sign-indicator">(-)</span>' : '';
            
            let html = `
                <tr class="${rowClass}" data-section-id="${seccion.section_id}" data-level="${nivel}">
                    <td class="indent-${nivel}">
                        ${tieneHijos && !vistaResumida ? `
                            <span class="toggle-btn ${isExpanded ? '' : 'collapsed'}" onclick="toggleSeccion('${seccion.section_id}')">
                                <i class="bi bi-chevron-down"></i>
                            </span>
                        ` : '<span style="width: 20px; display: inline-block;"></span>'}
                        ${seccion.section_name}${signoIndicator}
                    </td>
                    <td>${formatearMoneda(valores.approved)}</td>
                    <td>${formatearMoneda(valores.executed)}</td>
                    <td class="${disponible >= 0 ? 'value-positive' : 'value-negative'}">${formatearMoneda(disponible)}</td>
                    <td class="progress-cell">
                        ${porcentaje.toFixed(1)}%
                        <div class="progress progress-mini">
                            <div class="progress-bar ${porcentaje > 100 ? 'bg-danger' : porcentaje > 80 ? 'bg-warning' : 'bg-success'}" 
                                 style="width: ${Math.min(porcentaje, 100)}%"></div>
                        </div>
                    </td>
                </tr>
            `;
            
            // Si no es vista resumida, mostrar detalles
            if (!vistaResumida) {
                const hiddenClass = isExpanded ? '' : 'row-hidden';
                
                // L√≠neas de esta secci√≥n
                const lineas = estructuraCache.lineas.filter(l => l.section_id === seccion.section_id);
                lineas.forEach(linea => {
                    const lineaValores = datosCalculados.lineas[linea.line_id] || { approved: 0, executed: 0 };
                    const lineaDisponible = lineaValores.approved - lineaValores.executed;
                    const lineaPorcentaje = lineaValores.approved ? ((lineaValores.executed / lineaValores.approved) * 100) : 0;
                    
                    const nombre = linea.custom_label || 
                                   (linea.line_type === 'item' ? linea.budget_items?.item_name : linea.budget_categories?.category_name) || 
                                   'Sin nombre';
                    
                    const signoLinea = linea.sign_override === 'invert' ? '<span class="sign-indicator">(inv)</span>' : '';
                    
                    html += `
                        <tr class="row-line ${hiddenClass}" data-parent-section="${seccion.section_id}">
                            <td class="indent-line">
                                <small>${nombre}${signoLinea}</small>
                            </td>
                            <td><small>${formatearMoneda(lineaValores.approved)}</small></td>
                            <td><small>${formatearMoneda(lineaValores.executed)}</small></td>
                            <td class="${lineaDisponible >= 0 ? 'value-positive' : 'value-negative'}">
                                <small>${formatearMoneda(lineaDisponible)}</small>
                            </td>
                            <td><small>${lineaPorcentaje.toFixed(1)}%</small></td>
                        </tr>
                    `;
                });
                
                // Subsecciones (recursivo)
                const subsecciones = estructuraCache.secciones.filter(s => s.parent_section_id === seccion.section_id);
                subsecciones.forEach(sub => {
                    // Agregar clase hidden si padre est√° colapsado
                    const subHtml = renderizarSeccion(sub, nivel + 1, vistaResumida);
                    if (!isExpanded) {
                        html += subHtml.replace(/<tr /g, `<tr data-parent-section="${seccion.section_id}" class="${hiddenClass} `);
                    } else {
                        html += subHtml;
                    }
                });
            }
            
            return html;
        }
        
        // ==========================================
        // EXPANDIR/COLAPSAR
        // ==========================================
        function toggleSeccion(sectionId) {
            estadoExpandido[sectionId] = !estadoExpandido[sectionId];
            
            const isExpanded = estadoExpandido[sectionId];
            const btn = document.querySelector(`tr[data-section-id="${sectionId}"] .toggle-btn`);
            
            if (btn) {
                btn.classList.toggle('collapsed', !isExpanded);
            }
            
            // Mostrar/ocultar hijos directos
            const hijos = document.querySelectorAll(`tr[data-parent-section="${sectionId}"]`);
            hijos.forEach(hijo => {
                hijo.classList.toggle('row-hidden', !isExpanded);
                
                // Si es una secci√≥n, tambi√©n procesar sus hijos
                const subSectionId = hijo.dataset.sectionId;
                if (subSectionId && !isExpanded) {
                    ocultarHijosRecursivo(subSectionId);
                }
            });
        }
        
        function ocultarHijosRecursivo(sectionId) {
            const hijos = document.querySelectorAll(`tr[data-parent-section="${sectionId}"]`);
            hijos.forEach(hijo => {
                hijo.classList.add('row-hidden');
                const subSectionId = hijo.dataset.sectionId;
                if (subSectionId) {
                    ocultarHijosRecursivo(subSectionId);
                }
            });
        }
        
        function toggleTodos() {
            const todoExpandido = Object.values(estadoExpandido).every(v => v);
            const nuevoEstado = !todoExpandido;
            
            estructuraCache.secciones.forEach(s => {
                estadoExpandido[s.section_id] = nuevoEstado;
            });
            
            // Re-renderizar tabla
            renderizarTabla();
        }
        
        // ==========================================
        // EXPORTACI√ìN
        // ==========================================
        async function exportarPDF() {
            if (!datosCalculados) {
                showMessage('Primero debe generar el reporte', 'warning');
                return;
            }
            
            try {
                mostrarLoading('Generando PDF...');
                
                const { jsPDF } = window.jspdf;
                const element = document.getElementById('reporte-principal');
                
                // Capturar el elemento como canvas
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                const imgData = canvas.toDataURL('image/png');
                
                // Calcular dimensiones
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                let heightLeft = imgHeight;
                let position = 0;
                
                // Primera p√°gina
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // P√°ginas adicionales si es necesario
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Descargar
                const fileName = `${reporteActual.report_name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
                
                showMessage('PDF generado correctamente', 'success');
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error exportando PDF:', error);
                showMessage('Error al generar PDF: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        function exportarExcel() {
            if (!datosCalculados) {
                showMessage('Primero debe generar el reporte', 'warning');
                return;
            }
            
            try {
                // Construir contenido CSV
                let csv = '\uFEFF'; // BOM para UTF-8
                csv += 'Concepto,Aprobado,Ejecutado,Disponible,% Ejecuci√≥n\n';
                
                // Procesar secciones
                const procesarSeccionCSV = (seccion, nivel) => {
                    const indent = '  '.repeat(nivel);
                    const valores = datosCalculados.secciones[seccion.section_id] || { approved: 0, executed: 0 };
                    const disponible = valores.approved - valores.executed;
                    const porcentaje = valores.approved ? ((valores.executed / valores.approved) * 100).toFixed(1) : '0.0';
                    
                    csv += `"${indent}${seccion.section_name}",${valores.approved},${valores.executed},${disponible},${porcentaje}%\n`;
                    
                    // L√≠neas
                    const lineas = estructuraCache.lineas.filter(l => l.section_id === seccion.section_id);
                    lineas.forEach(linea => {
                        const lineaValores = datosCalculados.lineas[linea.line_id] || { approved: 0, executed: 0 };
                        const lineaDisponible = lineaValores.approved - lineaValores.executed;
                        const lineaPorcentaje = lineaValores.approved ? ((lineaValores.executed / lineaValores.approved) * 100).toFixed(1) : '0.0';
                        const nombre = linea.custom_label || 
                                       (linea.line_type === 'item' ? linea.budget_items?.item_name : linea.budget_categories?.category_name);
                        
                        csv += `"${indent}  ${nombre}",${lineaValores.approved},${lineaValores.executed},${lineaDisponible},${lineaPorcentaje}%\n`;
                    });
                    
                    // Subsecciones
                    const subsecciones = estructuraCache.secciones.filter(s => s.parent_section_id === seccion.section_id);
                    subsecciones.forEach(sub => procesarSeccionCSV(sub, nivel + 1));
                };
                
                const seccionesRaiz = estructuraCache.secciones.filter(s => !s.parent_section_id);
                seccionesRaiz.forEach(s => procesarSeccionCSV(s, 0));
                
                // Descargar
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${reporteActual.report_name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                showMessage('Excel (CSV) generado correctamente', 'success');
                
            } catch (error) {
                console.error('‚ùå Error exportando Excel:', error);
                showMessage('Error al exportar: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        function formatearMoneda(valor) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(valor || 0);
        }
        
        function mostrarLoading(texto = 'Cargando...') {
            document.getElementById('loading-text').textContent = texto;
            document.getElementById('loading-overlay')?.classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay')?.classList.add('hidden');
        }
        
        console.log('‚úÖ M√≥dulo de visualizaci√≥n de reportes cargado');
    </script>
</body>
</html>
