<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.25.13.35">
    <title>Mi Presupuesto - Presupuesto - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSIÓN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos específicos del formulario -->
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0d6efd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tablas */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .table thead th {
            background-color: #0d6efd;
            color: white;
            font-weight: 600;
            border: none;
            padding: 12px;
            text-align: center;
            vertical-align: middle;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .table tbody td {
            padding: 12px;
            vertical-align: middle;
            font-size: 0.875rem;
        }

        .table tbody tr {
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.2s;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .valor-cell {
            text-align: right;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Botón ver */
        .btn-ver {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.875rem;
        }

        .btn-ver:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.5);
            color: white;
        }

        /* Estados de requerimientos */
        .badge-estado {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .estado-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .estado-approved {
            background-color: #d4edda;
            color: #155724;
        }

        .estado-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .estado-executed {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .estado-closed {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .estado-pre-closed {
            background-color: #e2e3e5;
            color: #383d41;
        }

        /* Modales */
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        .modal-xl {
            max-width: 1200px;
        }

        /* Detalle de texto largo */
        .detalle-cell {
            max-width: 300px;
        }

        .detalle-content {
            max-height: 60px;
            overflow-y: auto;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* Estado vacío */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        /* Card para año */
        .year-selector {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }

        /* Resumen de presupuesto */
        .budget-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .budget-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            text-align: center;
        }

        .budget-card .label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .budget-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0d6efd;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .table thead th,
            .table tbody td {
                padding: 8px;
                font-size: 0.8rem;
            }

            .detalle-cell {
                max-width: 200px;
            }

            .detalle-content {
                max-height: 40px;
            }

            .budget-summary {
                grid-template-columns: 1fr;
            }
        }

        /* Texto enriquecido en modales */
        .rich-text {
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .rich-text p {
            margin-bottom: 0.5rem;
        }
        
        .rich-text p:last-child {
            margin-bottom: 0;
        }
        
        .rich-text ul, .rich-text ol {
            margin-bottom: 0.5rem;
            padding-left: 1.5rem;
        }
        
        .rich-text strong, .rich-text b {
            font-weight: 600;
        }

        /* Fila de totales en modal */
        .fila-totales {
            background-color: #e7f1ff !important;
            font-weight: 700;
            border-top: 2px solid #0d6efd;
        }
        
        .fila-totales td {
            padding: 12px !important;
        }
        
        /* Filtro de estado en modal */
        .filtro-estado-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .filtro-estado-container label {
            font-weight: 600;
            margin-bottom: 0;
            white-space: nowrap;
        }
        
        .filtro-estado-container select {
            max-width: 200px;
        }

        
    </style>
</head>
<body>
  <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0" id="loading-message">Cargando datos...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Presupuesto</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Mi Presupuesto
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE PÁGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-wallet2 me-2"></i>
                    Mi Presupuesto
                </h1>
                <p class="text-muted">
                    Vista personal de mis asignaciones presupuestales
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- SELECTOR DE AÑO -->
        <div class="year-selector">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <label for="select-year" class="form-label">
                        <i class="bi bi-calendar3 me-2"></i>
                        <strong>Año Presupuestal</strong>
                    </label>
                    <select class="form-select" id="select-year">
                        <option value="">Cargando años...</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-info mb-0 mt-3 mt-md-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Seleccione el año para visualizar sus asignaciones
                    </div>
                </div>
            </div>
        </div>

        <!-- RESUMEN PRESUPUESTAL -->
        <div class="budget-summary" id="budget-summary" style="display: none;">
            <div class="budget-card">
                <div class="label">Total Solicitado</div>
                <div class="value" id="total-solicitado">$0</div>
            </div>
            <div class="budget-card">
                <div class="label">Total Aprobado</div>
                <div class="value" id="total-aprobado">$0</div>
            </div>
            <div class="budget-card">
                <div class="label">Total Ejecutado</div>
                <div class="value" id="total-ejecutado">$0</div>
            </div>
            <div class="budget-card">
                <div class="label">Total Disponible</div>
                <div class="value text-success" id="total-disponible">$0</div>
            </div>
        </div>

        <!-- TABLA DE ASIGNACIONES -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-check me-2"></i>Mis Asignaciones Presupuestales
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tabla-asignaciones">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Ítem</th>
                                <th style="width: 20%;">Detalle</th>
                                <th style="width: 12%;" class="text-end">Vr. Solicitado</th>
                                <th style="width: 12%;" class="text-end">Vr. Aprobado</th>
                                <th style="width: 12%;" class="text-end">Vr. Ejecutado</th>
                                <th style="width: 12%;" class="text-end">Vr. Disponible</th>
                                <th style="width: 12%;" class="text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-asignaciones">
                            <tr>
                                <td colspan="7" class="empty-state">
                                    <i class="bi bi-hourglass-split"></i>
                                    <p>Seleccione un año para ver sus asignaciones</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    <!-- MODAL DE REQUERIMIENTOS -->
    <div class="modal fade" id="modal-requerimientos" tabindex="-1" aria-labelledby="modalRequerimientosLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalRequerimientosLabel">
                        <i class="bi bi-file-text me-2"></i>Requerimientos de la Asignación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Información de la asignación -->
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Ítem:</strong> <span id="info-req-item">-</span>
                            </div>
                            <div class="col-md-6">
                                <strong>Detalle:</strong> <span id="info-req-detalle">-</span>
                            </div>
                        </div>
                    </div>
                
                    <!-- Filtro por estado -->
                    <div class="filtro-estado-container">
                        <label for="filtro-estado">
                            <i class="bi bi-funnel me-1"></i>Filtrar por estado:
                        </label>
                        <select class="form-select form-select-sm" id="filtro-estado">
                            <option value="">Todos</option>
                            <option value="pending">Pendiente</option>
                            <option value="approved">Aprobado</option>
                            <option value="rejected">Rechazado</option>
                            <option value="executed">Ejecutado</option>
                            <option value="pre-closed">Pre-cerrado</option>
                            <option value="closed">Cerrado</option>
                        </select>
                        <span class="text-muted" id="contador-requerimientos"></span>
                    </div>
                
                    <!-- Tabla de requerimientos -->
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="tabla-requerimientos">
                            <thead>
                                <tr>
                                    <th style="min-width: 130px;">Solicitante</th>
                                    <th style="min-width: 250px;">Detalle</th>
                                    <th style="min-width: 100px;" class="text-end">Vr. Solicitado</th>
                                    <th style="min-width: 100px;">Fecha Solicitud</th>
                                    <th style="min-width: 100px;" class="text-end">Vr. Facturado</th>
                                    <th style="min-width: 80px;" class="text-center">Estado</th>
                                    <th style="min-width: 100px;">Fecha Cierre</th>
                                    <th style="min-width: 100px;" class="text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-requerimientos">
                                <tr>
                                    <td colspan="8" class="empty-state">
                                        <i class="bi bi-hourglass-split"></i>
                                        <p>Cargando requerimientos...</p>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot id="tfoot-requerimientos">
                                <!-- Fila de totales se genera dinámicamente -->
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE MOVIMIENTOS -->
    <div class="modal fade" id="modal-movimientos" tabindex="-1" aria-labelledby="modalMovimientosLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMovimientosLabel">
                        <i class="bi bi-cash-stack me-2"></i>Movimientos de Facturación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Información del requerimiento -->
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Ítem:</strong> <span id="info-mov-item">-</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Asignación:</strong> <span id="info-mov-asignacion">-</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Solicitante:</strong> <span id="info-mov-solicitante">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de movimientos -->
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="tabla-movimientos">
                            <thead>
                                <tr>
                                    <th style="min-width: 200px;">Proveedor</th>
                                    <th style="min-width: 120px;">Tipo Documento</th>
                                    <th style="min-width: 150px;">Número</th>
                                    <th style="min-width: 300px;">Descripción</th>
                                    <th style="min-width: 120px;" class="text-end">Valor</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-movimientos">
                                <tr>
                                    <td colspan="5" class="empty-state">
                                        <i class="bi bi-hourglass-split"></i>
                                        <p>Cargando movimientos...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Resumen de movimientos -->
                    <div class="alert alert-success mt-3" id="resumen-movimientos" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Total de movimientos:</strong> <span id="total-movimientos-count">0</span>
                            </div>
                            <div class="col-md-6 text-end">
                                <strong>Valor total:</strong> <span id="total-movimientos-valor">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts - ORDEN CRÍTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentYear = null;
        let yearsList = [];
        let assignmentsList = [];
        let currentItemName = '';
        let currentAssignmentDetail = '';
        let currentRequestSolicitante = '';
        let currentUserEmail = '';
        let currentAssignmentId = null;
        let requerimientosData = []; // Para almacenar los datos y filtrar
        
        // Instancias de modales
        let modalRequerimientos = null;
        let modalMovimientos = null;

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 1. VALIDAR PERMISOS
                const hasAccess = await validatePageAccess('Vista particular del presupuesto');
                if (!hasAccess) return;

                // 2. OBTENER EMAIL DEL USUARIO
                const session = getStoredSession();
                if (session && session.user) {
                    currentUserEmail = session.user.user_mail;
                } else {
                    throw new Error('No se pudo obtener información del usuario');
                }

                // 3. INICIALIZAR COMPONENTES
                inicializarComponentes();
                configurarEventos();

                // 4. CARGAR AÑOS ACADÉMICOS
                await cargarYears();

            } catch (error) {
                console.error('Error en inicialización:', error);
                showMessage('Error al inicializar la página: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // INICIALIZAR COMPONENTES
        // ==========================================
        function inicializarComponentes() {
            // Inicializar modales de Bootstrap
            modalRequerimientos = new bootstrap.Modal(document.getElementById('modal-requerimientos'));
            modalMovimientos = new bootstrap.Modal(document.getElementById('modal-movimientos'));

            console.log('✅ Componentes inicializados');
        }

        // ==========================================
        // CONFIGURAR EVENTOS
        // ==========================================
        function configurarEventos() {
            // Evento de cambio en select de año
            const selectYear = document.getElementById('select-year');
            selectYear.addEventListener('change', function() {
                currentYear = this.value;
                if (currentYear) {
                    cargarAsignaciones();
                } else {
                    limpiarTablaAsignaciones();
                    ocultarResumen();
                }
            });

            // Evento de cambio en filtro de estado del modal
            const filtroEstado = document.getElementById('filtro-estado');
            filtroEstado.addEventListener('change', function() {
                renderizarTablaRequerimientos(this.value);
            });

            console.log('✅ Eventos configurados');
        }

        // ==========================================
        // CARGAR AÑOS ACADÉMICOS
        // ==========================================
        async function cargarYears() {
            mostrarLoading('Cargando años académicos...');
            
            try {
                // Obtener año presupuestal actual
                const configData = await supabaseRequest('/system_config?select=current_budget_year_id&limit=1');
                const currentYearId = configData[0]?.current_budget_year_id;

                // Obtener todos los años
                const query = '/academic_years?select=year_id,year_name&order=year_name.desc';
                const data = await supabaseRequest(query);
                
                yearsList = data;

                // Llenar el select
                const selectYear = document.getElementById('select-year');
                selectYear.innerHTML = '<option value="">Seleccione un año...</option>';
                
                yearsList.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.year_id;
                    option.textContent = year.year_name;
                    
                    // Preseleccionar el año actual
                    if (year.year_id === currentYearId) {
                        option.selected = true;
                        currentYear = year.year_id;
                    }
                    
                    selectYear.appendChild(option);
                });

                ocultarLoading();

                // Si hay año seleccionado, cargar asignaciones
                if (currentYear) {
                    await cargarAsignaciones();
                }

                console.log(`✅ ${yearsList.length} años cargados`);

            } catch (error) {
                ocultarLoading();
                console.error('Error cargando años:', error);
                showMessage('Error al cargar años académicos: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // CARGAR ASIGNACIONES (con cálculo en tiempo real)
        // ==========================================
        async function cargarAsignaciones() {
            mostrarLoading('Cargando asignaciones...');
            
            try {
                // Query para obtener asignaciones del usuario para el año seleccionado
                // Incluimos los requerimientos para calcular el ejecutado en tiempo real
                const query = `/budget_assignments?select=assignment_id,category_detail,requested_value,approved_value,executed_value,budget_item:budget_items(item_name),execution_requests(request_id,requested_value,request_status),workers!budget_assignments_worker_id_fkey!inner(email)&workers.email=eq.${currentUserEmail}&academic_year_id=eq.${currentYear}&assignment_status=eq.active&order=budget_item(item_name).asc,category_detail.asc`;

                
                const data = await supabaseRequest(query);
                
                // Estados que cuentan como "ejecutado"
                const estadosProductivos = ['approved', 'executed', 'closed', 'pre-closed'];
                
                // Procesar y calcular executed_value en tiempo real
                assignmentsList = data.map(asig => {
                    // Calcular el valor ejecutado sumando requested_value de requerimientos productivos
                    let executedCalculado = 0;
                    if (asig.execution_requests && asig.execution_requests.length > 0) {
                        executedCalculado = asig.execution_requests
                            .filter(req => estadosProductivos.includes(req.request_status))
                            .reduce((sum, req) => sum + (req.requested_value || 0), 0);
                    }
                    
                    return {
                        ...asig,
                        executed_value_calculado: executedCalculado
                    };
                });
        
                renderizarTablaAsignaciones();
                calcularResumen();
                
                ocultarLoading();
        
                console.log(`✅ ${assignmentsList.length} asignaciones cargadas`);
        
            } catch (error) {
                ocultarLoading();
                console.error('Error cargando asignaciones:', error);
                showMessage('Error al cargar asignaciones: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // RENDERIZAR TABLA DE ASIGNACIONES
        // ==========================================
        function renderizarTablaAsignaciones() {
            const tbody = document.getElementById('tbody-asignaciones');
            
            if (assignmentsList.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p>No tiene asignaciones presupuestales para este año</p>
                        </td>
                    </tr>
                `;
                return;
            }
        
            let html = '';
            assignmentsList.forEach((asig, index) => {
                const itemName = asig.budget_item?.item_name || 'Sin ítem';
                const detalle = asig.category_detail || 'Sin detalle';
                const solicitado = asig.requested_value || 0;
                const aprobado = asig.approved_value || 0;
                // Usar el valor calculado en tiempo real
                const ejecutado = asig.executed_value_calculado || 0;
                const disponible = aprobado - ejecutado;
        
                html += `
                    <tr>
                        <td><strong>${escapeHtml(itemName)}</strong></td>
                        <td>${escapeHtml(detalle)}</td>
                        <td class="valor-cell">${formatCurrency(solicitado)}</td>
                        <td class="valor-cell">${formatCurrency(aprobado)}</td>
                        <td class="valor-cell">${formatCurrency(ejecutado)}</td>
                        <td class="valor-cell">${formatCurrency(disponible)}</td>
                        <td class="text-center">
                            <button class="btn-ver" onclick="abrirModalRequerimientos('${asig.assignment_id}', '${escapeHtml(itemName)}', '${escapeHtml(detalle)}')">
                                <i class="bi bi-eye me-1"></i>Ver
                            </button>
                        </td>
                    </tr>
                `;
            });
        
            tbody.innerHTML = html;
        }

        // ==========================================
        // CALCULAR RESUMEN
        // ==========================================
        function calcularResumen() {
            if (assignmentsList.length === 0) {
                ocultarResumen();
                return;
            }
        
            let totalSolicitado = 0;
            let totalAprobado = 0;
            let totalEjecutado = 0;
            let totalDisponible = 0;
        
            assignmentsList.forEach(asig => {
                const solicitado = asig.requested_value || 0;
                const aprobado = asig.approved_value || 0;
                // Usar el valor calculado en tiempo real
                const ejecutado = asig.executed_value_calculado || 0;
                const disponible = aprobado - ejecutado;
        
                totalSolicitado += solicitado;
                totalAprobado += aprobado;
                totalEjecutado += ejecutado;
                totalDisponible += disponible;
            });
        
            // Actualizar tarjetas
            document.getElementById('total-solicitado').textContent = formatCurrency(totalSolicitado);
            document.getElementById('total-aprobado').textContent = formatCurrency(totalAprobado);
            document.getElementById('total-ejecutado').textContent = formatCurrency(totalEjecutado);
            document.getElementById('total-disponible').textContent = formatCurrency(totalDisponible);
        
            // Mostrar resumen
            document.getElementById('budget-summary').style.display = 'grid';
        }

        // ==========================================
        // OCULTAR RESUMEN
        // ==========================================
        function ocultarResumen() {
            document.getElementById('budget-summary').style.display = 'none';
        }

        // ==========================================
        // LIMPIAR TABLA DE ASIGNACIONES
        // ==========================================
        function limpiarTablaAsignaciones() {
            const tbody = document.getElementById('tbody-asignaciones');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="empty-state">
                        <i class="bi bi-hourglass-split"></i>
                        <p>Seleccione un año para ver sus asignaciones</p>
                    </td>
                </tr>
            `;
        }

        // ==========================================
        // ABRIR MODAL DE REQUERIMIENTOS
        // ==========================================
        async function abrirModalRequerimientos(assignmentId, itemName, detalle) {
            currentItemName = itemName;
            currentAssignmentDetail = detalle;
            currentAssignmentId = assignmentId;
            
            // Actualizar info
            document.getElementById('info-req-item').textContent = itemName;
            document.getElementById('info-req-detalle').textContent = detalle;
            
            // Resetear filtro
            document.getElementById('filtro-estado').value = '';
        
            // Mostrar modal
            modalRequerimientos.show();
        
            // Cargar requerimientos
            await cargarRequerimientos(assignmentId);
        }

        // ==========================================
        // CARGAR REQUERIMIENTOS
        // ==========================================
        async function cargarRequerimientos(assignmentId) {
            const tbody = document.getElementById('tbody-requerimientos');
            const tfoot = document.getElementById('tfoot-requerimientos');
            
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="empty-state">
                        <i class="bi bi-hourglass-split"></i>
                        <p>Cargando requerimientos...</p>
                    </td>
                </tr>
            `;
            tfoot.innerHTML = '';
            document.getElementById('contador-requerimientos').textContent = '';
            
            try {
                // Query para obtener requerimientos de la asignación
                const query = `/execution_requests?select=request_id,requested_at,request_details,requested_value,responded_at,closed_value,request_status,workers!execution_requests_worker_fkey(worker_first_name,worker_last_name_1,worker_last_name_2)&assignment_id=eq.${assignmentId}&order=requested_at.desc`;
                
                const data = await supabaseRequest(query);
                
                // Guardar datos para filtrado
                requerimientosData = data;
                
                // Renderizar con filtro vacío (todos)
                renderizarTablaRequerimientos('');
        
                console.log(`✅ ${data.length} requerimientos cargados`);
        
            } catch (error) {
                console.error('Error cargando requerimientos:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="bi bi-exclamation-triangle"></i>
                            <p>Error al cargar requerimientos: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }
        
        // ==========================================
        // RENDERIZAR TABLA DE REQUERIMIENTOS (con filtro y totales)
        // ==========================================
        function renderizarTablaRequerimientos(filtroEstado) {
            const tbody = document.getElementById('tbody-requerimientos');
            const tfoot = document.getElementById('tfoot-requerimientos');
            
            // Filtrar datos según el estado seleccionado
            let datosFiltrados = requerimientosData;
            if (filtroEstado && filtroEstado !== '') {
                datosFiltrados = requerimientosData.filter(req => req.request_status === filtroEstado);
            }
            
            // Actualizar contador
            const totalRegistros = requerimientosData.length;
            const registrosFiltrados = datosFiltrados.length;
            const contadorTexto = filtroEstado 
                ? `Mostrando ${registrosFiltrados} de ${totalRegistros}` 
                : `Total: ${totalRegistros}`;
            document.getElementById('contador-requerimientos').textContent = contadorTexto;
        
            if (datosFiltrados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p>${filtroEstado ? 'No hay requerimientos con el estado seleccionado' : 'No hay requerimientos para esta asignación'}</p>
                        </td>
                    </tr>
                `;
                tfoot.innerHTML = '';
                return;
            }
        
            // Variables para totales
            let totalSolicitado = 0;
            let totalFacturado = 0;
        
            let html = '';
            datosFiltrados.forEach((req, index) => {
                const solicitanteName = formatWorkerName(req.workers);
                const detalle = req.request_details || 'Sin detalle';
                const valorSolicitado = req.requested_value || 0;
                const fechaSolicitud = req.requested_at ? formatDate(req.requested_at) : 'N/A';
                const valorFacturado = req.closed_value || 0;
                const estado = req.request_status || 'pending';
                const fechaCierre = req.responded_at ? formatDate(req.responded_at) : 'Pendiente';
        
                // Acumular totales
                totalSolicitado += valorSolicitado;
                totalFacturado += valorFacturado;
        
                html += `
                    <tr>
                        <td>${escapeHtml(solicitanteName)}</td>
                        <td class="detalle-cell">
                            <div class="detalle-content rich-text">
                                ${detalle}
                            </div>
                        </td>
                        <td class="valor-cell">${formatCurrency(valorSolicitado)}</td>
                        <td>${fechaSolicitud}</td>
                        <td class="valor-cell">${formatCurrency(valorFacturado)}</td>
                        <td class="text-center">
                            <span class="badge-estado estado-${estado}">
                                ${formatEstado(estado)}
                            </span>
                        </td>
                        <td>${fechaCierre}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary" onclick="abrirModalMovimientos('${req.request_id}', '${escapeHtml(solicitanteName)}')">
                                <i class="bi bi-cash-stack me-1"></i>Movimientos
                            </button>
                        </td>
                    </tr>
                `;
            });
        
            tbody.innerHTML = html;
        
            // Renderizar fila de totales
            tfoot.innerHTML = `
                <tr class="fila-totales">
                    <td colspan="2" class="text-end"><strong>TOTALES:</strong></td>
                    <td class="valor-cell">${formatCurrency(totalSolicitado)}</td>
                    <td></td>
                    <td class="valor-cell">${formatCurrency(totalFacturado)}</td>
                    <td colspan="3"></td>
                </tr>
            `;
        }
        
        
        // ==========================================
        // ABRIR MODAL DE MOVIMIENTOS
        // ==========================================
        async function abrirModalMovimientos(requestId, solicitanteName) {
            currentRequestSolicitante = solicitanteName;
            
            // Actualizar info
            document.getElementById('info-mov-item').textContent = currentItemName;
            document.getElementById('info-mov-asignacion').textContent = currentAssignmentDetail;
            document.getElementById('info-mov-solicitante').textContent = solicitanteName;

            // Mostrar modal
            modalMovimientos.show();

            // Cargar movimientos
            await cargarMovimientos(requestId);
        }

        // ==========================================
        // CARGAR MOVIMIENTOS
        // ==========================================
        async function cargarMovimientos(requestId) {
            const tbody = document.getElementById('tbody-movimientos');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="empty-state">
                        <i class="bi bi-hourglass-split"></i>
                        <p>Cargando movimientos...</p>
                    </td>
                </tr>
            `;
            
            try {
                // Query para obtener movimientos del requerimiento
                const query = `/budget_payments?select=payment_id,payment_type,invoice_number,invoice_description,invoice_value,suppliers!budget_payments_supplier_fkey(supplier_name)&execution_request_id=eq.${requestId}&order=invoice_date.desc`;
                
                const data = await supabaseRequest(query);

                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p>No hay movimientos registrados para este requerimiento</p>
                            </td>
                        </tr>
                    `;
                    document.getElementById('resumen-movimientos').style.display = 'none';
                    return;
                }

                let html = '';
                let totalValor = 0;

                data.forEach((mov, index) => {
                    const proveedorName = mov.suppliers?.supplier_name || 'Sin proveedor';
                    const tipoDoc = mov.payment_type || 'N/A';
                    const numero = mov.invoice_number || 'N/A';
                    const descripcion = mov.invoice_description || 'Sin descripción';
                    const valor = mov.invoice_value || 0;

                    totalValor += valor;

                    html += `
                        <tr>
                            <td>${escapeHtml(proveedorName)}</td>
                            <td>${escapeHtml(tipoDoc)}</td>
                            <td>${escapeHtml(numero)}</td>
                            <td class="detalle-cell">
                                <div class="detalle-content">
                                    ${escapeHtml(descripcion)}
                                </div>
                            </td>
                            <td class="valor-cell">${formatCurrency(valor)}</td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;

                // Mostrar resumen
                document.getElementById('total-movimientos-count').textContent = data.length;
                document.getElementById('total-movimientos-valor').textContent = formatCurrency(totalValor);
                document.getElementById('resumen-movimientos').style.display = 'block';

                console.log(`✅ ${data.length} movimientos cargados - Total: ${formatCurrency(totalValor)}`);

            } catch (error) {
                console.error('Error cargando movimientos:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="bi bi-exclamation-triangle"></i>
                            <p>Error al cargar movimientos: ${error.message}</p>
                        </td>
                    </tr>
                `;
                document.getElementById('resumen-movimientos').style.display = 'none';
            }
        }

        // ==========================================
        // FORMATEAR ESTADO
        // ==========================================
        function formatEstado(estado) {
            const estados = {
                'pending': 'Pendiente',
                'approved': 'Aprobado',
                'rejected': 'Rechazado',
                'executed': 'Ejecutado',
                'closed': 'Cerrado',
                'pre-closed': 'Pre-cerrado'
            };
            return estados[estado] || estado;
        }

        // ==========================================
        // FUNCIONES DE LOADING
        // ==========================================
        function mostrarLoading(mensaje = 'Cargando...') {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            
            if (loadingOverlay) {
                loadingMessage.textContent = mensaje;
                loadingOverlay.classList.remove('hidden');
            }
        }

        function ocultarLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }

        // ==========================================
        // FUNCIONES DE FORMATEO
        // ==========================================
        function formatCurrency(valor) {
            if (!valor || isNaN(valor)) return '$0';
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(valor);
        }

        function formatWorkerName(worker) {
            if (!worker) return 'N/A';
            
            const firstName = worker.worker_first_name || '';
            const lastName1 = worker.worker_last_name_1 || '';
            const lastName2 = worker.worker_last_name_2 || '';
            
            if (lastName2 && lastName2.trim()) {
                return `${lastName1} ${lastName2} ${firstName}`.trim();
            } else {
                return `${lastName1} ${firstName}`.trim();
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (error) {
                return dateString;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================
        // HACER FUNCIONES GLOBALES
        // ==========================================
        window.abrirModalRequerimientos = abrirModalRequerimientos;
        window.abrirModalMovimientos = abrirModalMovimientos;

        console.log('✅ Página de Mi Presupuesto cargada correctamente');
    </script>
</body>
</html>
