<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista Detallada por Categoría - Presupuesto - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSIÓN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos específicos del formulario -->
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0d6efd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tablas */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .table thead th {
            background-color: #0d6efd;
            color: white;
            font-weight: 600;
            border: none;
            padding: 12px;
            text-align: center;
            vertical-align: middle;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .table tbody td {
            padding: 12px;
            vertical-align: middle;
            font-size: 0.875rem;
        }

        .table tbody tr {
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.2s;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .valor-cell {
            text-align: right;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Botones de acción */
        .btn-ver {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.875rem;
        }

        .btn-ver:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.5);
            color: white;
        }

        /* Modales anidados - diferentes z-index */
        .modal-backdrop {
            z-index: 1040;
        }

        .modal {
            z-index: 1050;
        }

        .modal.show {
            display: block !important;
        }

        .modal-backdrop.show {
            opacity: 0.5;
        }

        /* Segundo nivel de modal */
        .modal-backdrop.level-2 {
            z-index: 1060;
        }

        .modal.level-2 {
            z-index: 1070;
        }

        /* Tercer nivel de modal */
        .modal-backdrop.level-3 {
            z-index: 1080;
        }

        .modal.level-3 {
            z-index: 1090;
        }

        /* Cuarto nivel de modal */
        .modal-backdrop.level-4 {
            z-index: 1100;
        }

        .modal.level-4 {
            z-index: 1110;
        }

        /* Header de modales */
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        /* Tabla con scroll horizontal */
        .table-scroll {
            overflow-x: auto;
        }

        /* Estado vacío */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        /* Badge de diferencia */
        .diferencia-positiva {
            color: #198754;
            font-weight: 600;
        }

        .diferencia-negativa {
            color: #dc3545;
            font-weight: 600;
        }

        .diferencia-cero {
            color: #6c757d;
            font-weight: 600;
        }

        /* Detalle de texto largo */
        .detalle-cell {
            max-width: 300px;
        }

        .detalle-content {
            max-height: 60px;
            overflow-y: auto;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* Breadcrumb personalizado */
        .breadcrumb-item a {
            color: #0d6efd;
            text-decoration: none;
        }

        .breadcrumb-item a:hover {
            text-decoration: underline;
        }

        /* Card para año */
        .year-selector {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .table thead th,
            .table tbody td {
                padding: 8px;
                font-size: 0.8rem;
            }

            .detalle-cell {
                max-width: 200px;
            }

            .detalle-content {
                max-height: 40px;
            }

            .modal-dialog {
                margin: 0.5rem;
            }
        }
    </style>
</head>
<body>
  <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0" id="loading-message">Cargando datos...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Presupuesto</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Vista Detallada por Categoría
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE PÁGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-diagram-3 me-2"></i>
                    Vista Detallada por Categoría
                </h1>
                <p class="text-muted">
                    Navegación jerárquica: Categorías → Ítems → Asignaciones → Requerimientos → Pagos
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- SELECTOR DE AÑO -->
        <div class="year-selector">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <label for="select-year" class="form-label">
                        <i class="bi bi-calendar3 me-2"></i>
                        <strong>Año Presupuestal</strong>
                    </label>
                    <select class="form-select" id="select-year">
                        <option value="">Cargando años...</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-info mb-0 mt-3 mt-md-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Seleccione el año para visualizar la información presupuestal
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA DE CATEGORÍAS -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-folder me-2"></i>Categorías Presupuestales
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tabla-categorias">
                        <thead>
                            <tr>
                                <th style="width: 70%;">Categoría</th>
                                <th style="width: 30%;" class="text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-categorias">
                            <tr>
                                <td colspan="2" class="empty-state">
                                    <i class="bi bi-hourglass-split"></i>
                                    <p>Seleccione un año para ver las categorías</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    <!-- MODAL DE ÍTEMS (Nivel 2) -->
    <div class="modal fade level-2" id="modal-items" tabindex="-1" aria-labelledby="modalItemsLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalItemsLabel">
                        <i class="bi bi-list-ul me-2"></i>Ítems de la Categoría
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Información de la categoría -->
                    <div class="alert alert-info">
                        <strong>Categoría:</strong> <span id="info-categoria-nombre">-</span>
                    </div>

                    <!-- Tabla de ítems -->
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="tabla-items">
                            <thead>
                                <tr>
                                    <th style="width: 70%;">Ítem</th>
                                    <th style="width: 30%;" class="text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-items">
                                <tr>
                                    <td colspan="2" class="empty-state">
                                        <i class="bi bi-hourglass-split"></i>
                                        <p>Cargando ítems...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE ASIGNACIONES (Nivel 3) -->
    <div class="modal fade level-3" id="modal-assignments" tabindex="-1" aria-labelledby="modalAssignmentsLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAssignmentsLabel">
                        <i class="bi bi-clipboard-check me-2"></i>Asignaciones del Ítem
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Información del ítem -->
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Categoría:</strong> <span id="info-assignment-categoria">-</span>
                            </div>
                            <div class="col-md-6">
                                <strong>Ítem:</strong> <span id="info-assignment-item">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de asignaciones -->
                    <div class="table-scroll">
                        <table class="table table-hover mb-0" id="tabla-assignments">
                            <thead>
                                <tr>
                                    <th style="min-width: 150px;">Detalle</th>
                                    <th style="min-width: 150px;">Autorizador</th>
                                    <th style="min-width: 120px;" class="text-end">Vr. Solicitado</th>
                                    <th style="min-width: 120px;" class="text-end">Vr. Aprobado</th>
                                    <th style="min-width: 120px;" class="text-end">Vr. Ejecutado</th>
                                    <th style="min-width: 120px;" class="text-end">Vr. Disponible</th>
                                    <th style="min-width: 100px;" class="text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-assignments">
                                <tr>
                                    <td colspan="7" class="empty-state">
                                        <i class="bi bi-hourglass-split"></i>
                                        <p>Cargando asignaciones...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- MODAL DE REQUERIMIENTOS (Nivel 4) -->
    <div class="modal fade level-4" id="modal-requests" tabindex="-1" aria-labelledby="modalRequestsLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" style="max-width: 95%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalRequestsLabel">
                        <i class="bi bi-file-text me-2"></i>Requerimientos de la Asignación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Información de la asignación -->
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Categoría:</strong> <span id="info-request-categoria">-</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Ítem:</strong> <span id="info-request-item">-</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Asignación:</strong> <span id="info-request-detalle">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de requerimientos -->
                    <div class="table-scroll">
                        <table class="table table-hover mb-0" id="tabla-requests">
                            <thead>
                                <tr>
                                    <th style="min-width: 150px;">Solicitante</th>
                                    <th style="min-width: 110px;">Fecha Solicitud</th>
                                    <th style="min-width: 250px;">Detalle</th>
                                    <th style="min-width: 120px;" class="text-end">Vr. Solicitado</th>
                                    <th style="min-width: 150px;">Fecha Autorización</th>
                                    <th style="min-width: 120px;" class="text-end">Vr. Cierre</th>
                                    <th style="min-width: 120px;" class="text-end">Diferencia</th>
                                    <th style="min-width: 100px;" class="text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-requests">
                                <tr>
                                    <td colspan="8" class="empty-state">
                                        <i class="bi bi-hourglass-split"></i>
                                        <p>Cargando requerimientos...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE PAGOS (Nivel 5) -->
    <div class="modal fade" id="modal-payments" tabindex="-1" aria-labelledby="modalPaymentsLabel" aria-hidden="true" style="z-index: 1120;">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalPaymentsLabel">
                        <i class="bi bi-cash-stack me-2"></i>Pagos del Requerimiento
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Información del requerimiento -->
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Categoría:</strong> <span id="info-payment-categoria">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Ítem:</strong> <span id="info-payment-item">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Asignación:</strong> <span id="info-payment-asignacion">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Solicitante:</strong> <span id="info-payment-solicitante">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de pagos -->
                    <div class="table-scroll">
                        <table class="table table-hover mb-0" id="tabla-payments">
                            <thead>
                                <tr>
                                    <th style="min-width: 200px;">Proveedor</th>
                                    <th style="min-width: 110px;">Fecha</th>
                                    <th style="min-width: 120px;">Tipo Documento</th>
                                    <th style="min-width: 130px;">Número</th>
                                    <th style="min-width: 300px;">Descripción</th>
                                    <th style="min-width: 120px;" class="text-end">Valor</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-payments">
                                <tr>
                                    <td colspan="6" class="empty-state">
                                        <i class="bi bi-hourglass-split"></i>
                                        <p>Cargando pagos...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Resumen de pagos -->
                    <div class="alert alert-success mt-3" id="resumen-pagos" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Total de pagos:</strong> <span id="total-pagos-count">0</span>
                            </div>
                            <div class="col-md-6 text-end">
                                <strong>Valor total:</strong> <span id="total-pagos-valor">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts - ORDEN CRÍTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentYear = null;
        let yearsList = [];
        let categoriesList = [];
        let currentCategoryName = '';
        let currentItemName = '';
        let currentAssignmentDetail = '';
        let currentRequestSolicitante = '';
        
        // Instancias de modales
        let modalItems = null;
        let modalAssignments = null;
        let modalRequests = null;
        let modalPayments = null;

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 1. VALIDAR PERMISOS
                const hasAccess = await validatePageAccess('Vista detallada por categoría');
                if (!hasAccess) return;

                // 2. INICIALIZAR COMPONENTES
                inicializarComponentes();
                configurarEventos();

                // 3. CARGAR AÑOS ACADÉMICOS
                await cargarYears();

            } catch (error) {
                console.error('Error en inicialización:', error);
                showMessage('Error al inicializar la página: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // INICIALIZAR COMPONENTES
        // ==========================================
        function inicializarComponentes() {
            // Inicializar modales de Bootstrap
            modalItems = new bootstrap.Modal(document.getElementById('modal-items'));
            modalAssignments = new bootstrap.Modal(document.getElementById('modal-assignments'));
            modalRequests = new bootstrap.Modal(document.getElementById('modal-requests'));
            modalPayments = new bootstrap.Modal(document.getElementById('modal-payments'));

            console.log('✅ Componentes inicializados');
        }

        // ==========================================
        // CONFIGURAR EVENTOS
        // ==========================================
        function configurarEventos() {
            // Evento de cambio en select de año
            const selectYear = document.getElementById('select-year');
            selectYear.addEventListener('change', function() {
                currentYear = this.value;
                if (currentYear) {
                    cargarCategorias();
                } else {
                    limpiarTablaCategorias();
                }
            });

            console.log('✅ Eventos configurados');
        }

        // ==========================================
        // CARGAR AÑOS ACADÉMICOS
        // ==========================================
        async function cargarYears() {
            mostrarLoading('Cargando años académicos...');
            
            try {
                // Obtener año presupuestal actual
                const configData = await supabaseRequest('/system_config?select=current_budget_year_id&limit=1');
                const currentYearId = configData[0]?.current_budget_year_id;

                // Obtener todos los años
                const query = '/academic_years?select=year_id,year_name&order=year_name.desc';
                const data = await supabaseRequest(query);
                
                yearsList = data;

                // Llenar el select
                const selectYear = document.getElementById('select-year');
                selectYear.innerHTML = '<option value="">Seleccione un año...</option>';
                
                yearsList.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.year_id;
                    option.textContent = year.year_name;
                    
                    // Preseleccionar el año actual
                    if (year.year_id === currentYearId) {
                        option.selected = true;
                        currentYear = year.year_id;
                    }
                    
                    selectYear.appendChild(option);
                });

                ocultarLoading();

                // Si hay año seleccionado, cargar categorías
                if (currentYear) {
                    await cargarCategorias();
                }

                console.log(`✅ ${yearsList.length} años cargados`);

            } catch (error) {
                ocultarLoading();
                console.error('Error cargando años:', error);
                showMessage('Error al cargar años académicos: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // CARGAR CATEGORÍAS
        // ==========================================
        async function cargarCategorias() {
            mostrarLoading('Cargando categorías...');
            
            try {
                // Query para obtener categorías activas con ítems activos
                const query = `/budget_categories?select=category_id,category_name&category_status=eq.active&order=category_name.asc`;
                
                const data = await supabaseRequest(query);
                categoriesList = data;

                renderizarTablaCategorias();
                
                ocultarLoading();

                console.log(`✅ ${categoriesList.length} categorías cargadas`);

            } catch (error) {
                ocultarLoading();
                console.error('Error cargando categorías:', error);
                showMessage('Error al cargar categorías: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // RENDERIZAR TABLA DE CATEGORÍAS
        // ==========================================
        function renderizarTablaCategorias() {
            const tbody = document.getElementById('tbody-categorias');
            
            if (categoriesList.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="2" class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p>No hay categorías activas disponibles</p>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            categoriesList.forEach((categoria, index) => {
                html += `
                    <tr>
                        <td><strong>${escapeHtml(categoria.category_name)}</strong></td>
                        <td class="text-center">
                            <button class="btn-ver" onclick="abrirModalItems('${categoria.category_id}', '${escapeHtml(categoria.category_name)}')">
                                <i class="bi bi-arrow-right-circle me-1"></i>Ver Ítems
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // ==========================================
        // LIMPIAR TABLA DE CATEGORÍAS
        // ==========================================
        function limpiarTablaCategorias() {
            const tbody = document.getElementById('tbody-categorias');
            tbody.innerHTML = `
                <tr>
                    <td colspan="2" class="empty-state">
                        <i class="bi bi-hourglass-split"></i>
                        <p>Seleccione un año para ver las categorías</p>
                    </td>
                </tr>
            `;
        }

        // ==========================================
        // ABRIR MODAL DE ÍTEMS
        // ==========================================
        async function abrirModalItems(categoryId, categoryName) {
            currentCategoryName = categoryName;
            
            // Actualizar título e info
            document.getElementById('info-categoria-nombre').textContent = categoryName;

            // Mostrar modal
            modalItems.show();

            // Cargar ítems
            await cargarItems(categoryId);
        }

        // ==========================================
        // CARGAR ÍTEMS
        // ==========================================
        async function cargarItems(categoryId) {
            const tbody = document.getElementById('tbody-items');
            tbody.innerHTML = `
                <tr>
                    <td colspan="2" class="empty-state">
                        <i class="bi bi-hourglass-split"></i>
                        <p>Cargando ítems...</p>
                    </td>
                </tr>
            `;
            
            try {
                // Query para obtener ítems activos de la categoría
                const query = `/budget_items?select=item_id,item_name&category_id=eq.${categoryId}&item_status=eq.active&order=item_name.asc`;
                
                const data = await supabaseRequest(query);

                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="2" class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p>No hay ítems activos para esta categoría</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                let html = '';
                data.forEach((item, index) => {
                    html += `
                        <tr>
                            <td><strong>${escapeHtml(item.item_name)}</strong></td>
                            <td class="text-center">
                                <button class="btn-ver" onclick="abrirModalAssignments('${item.item_id}', '${escapeHtml(item.item_name)}')">
                                    <i class="bi bi-arrow-right-circle me-1"></i>Ver Asignaciones
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;

                console.log(`✅ ${data.length} ítems cargados`);

            } catch (error) {
                console.error('Error cargando ítems:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="2" class="empty-state">
                            <i class="bi bi-exclamation-triangle"></i>
                            <p>Error al cargar ítems: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }
      // ==========================================
        // ABRIR MODAL DE ASIGNACIONES
        // ==========================================
        async function abrirModalAssignments(itemId, itemName) {
            currentItemName = itemName;
            
            // Actualizar info
            document.getElementById('info-assignment-categoria').textContent = currentCategoryName;
            document.getElementById('info-assignment-item').textContent = itemName;

            // Mostrar modal
            modalAssignments.show();

            // Cargar asignaciones
            await cargarAssignments(itemId);
        }

        // ==========================================
        // CARGAR ASIGNACIONES
        // ==========================================
        async function cargarAssignments(itemId) {
            const tbody = document.getElementById('tbody-assignments');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="empty-state">
                        <i class="bi bi-hourglass-split"></i>
                        <p>Cargando asignaciones...</p>
                    </td>
                </tr>
            `;
            
            try {
                // Query para obtener asignaciones del ítem para el año seleccionado
                const query = `/budget_assignments?select=assignment_id,category_detail,approved_value,executed_value,requested_value,worker_email,workers!budget_assignments_worker_fkey(worker_first_name,worker_last_name_1,worker_last_name_2)&budget_item_id=eq.${itemId}&academic_year_id=eq.${currentYear}&assignment_status=eq.active&order=category_detail.asc`;
                
                const data = await supabaseRequest(query);

                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p>No hay asignaciones para este ítem en el año seleccionado</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                let html = '';
                data.forEach((asig, index) => {
                    const workerName = formatWorkerName(asig.workers);
                    const solicitado = asig.requested_value || 0;
                    const aprobado = asig.approved_value || 0;
                    const ejecutado = asig.executed_value || 0;
                    const disponible = aprobado - ejecutado;

                    html += `
                        <tr>
                            <td>${escapeHtml(asig.category_detail || 'Sin detalle')}</td>
                            <td>${escapeHtml(workerName)}</td>
                            <td class="valor-cell">${formatCurrency(solicitado)}</td>
                            <td class="valor-cell">${formatCurrency(aprobado)}</td>
                            <td class="valor-cell">${formatCurrency(ejecutado)}</td>
                            <td class="valor-cell">${formatCurrency(disponible)}</td>
                            <td class="text-center">
                                <button class="btn-ver" onclick="abrirModalRequests('${asig.assignment_id}', '${escapeHtml(asig.category_detail || 'Sin detalle')}')">
                                    <i class="bi bi-arrow-right-circle me-1"></i>Ver Requerimientos
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;

                console.log(`✅ ${data.length} asignaciones cargadas`);

            } catch (error) {
                console.error('Error cargando asignaciones:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="bi bi-exclamation-triangle"></i>
                            <p>Error al cargar asignaciones: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        // ==========================================
        // ABRIR MODAL DE REQUERIMIENTOS
        // ==========================================
        async function abrirModalRequests(assignmentId, assignmentDetail) {
            currentAssignmentDetail = assignmentDetail;
            
            // Actualizar info
            document.getElementById('info-request-categoria').textContent = currentCategoryName;
            document.getElementById('info-request-item').textContent = currentItemName;
            document.getElementById('info-request-detalle').textContent = assignmentDetail;

            // Mostrar modal
            modalRequests.show();

            // Cargar requerimientos
            await cargarRequests(assignmentId);
        }

        // ==========================================
        // CARGAR REQUERIMIENTOS
        // ==========================================
        async function cargarRequests(assignmentId) {
            const tbody = document.getElementById('tbody-requests');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="empty-state">
                        <i class="bi bi-hourglass-split"></i>
                        <p>Cargando requerimientos...</p>
                    </td>
                </tr>
            `;
            
            try {
                // Query para obtener requerimientos de la asignación
                const query = `/execution_requests?select=request_id,request_date,request_details,request_value,answer_date,closed_value,workers!execution_requests_worker_fkey(worker_first_name,worker_last_name_1,worker_last_name_2)&assignment_id=eq.${assignmentId}&order=request_date.desc`;
                
                const data = await supabaseRequest(query);

                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p>No hay requerimientos para esta asignación</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                let html = '';
                data.forEach((req, index) => {
                    const solicitanteName = formatWorkerName(req.workers);
                    const fechaSolicitud = req.request_date ? formatDate(req.request_date) : 'N/A';
                    const detalle = req.request_details || 'Sin detalle';
                    const valorSolicitado = req.request_value || 0;
                    const fechaAutorizacion = req.answer_date ? formatDateTime(req.answer_date) : 'Pendiente';
                    const valorCierre = req.closed_value || 0;
                    const diferencia = valorCierre - valorSolicitado;

                    // Clase para diferencia
                    let diferenciaClass = 'diferencia-cero';
                    if (diferencia > 0) diferenciaClass = 'diferencia-positiva';
                    if (diferencia < 0) diferenciaClass = 'diferencia-negativa';

                    html += `
                        <tr>
                            <td>${escapeHtml(solicitanteName)}</td>
                            <td>${fechaSolicitud}</td>
                            <td class="detalle-cell">
                                <div class="detalle-content">
                                    ${escapeHtml(detalle)}
                                </div>
                            </td>
                            <td class="valor-cell">${formatCurrency(valorSolicitado)}</td>
                            <td>${fechaAutorizacion}</td>
                            <td class="valor-cell">${formatCurrency(valorCierre)}</td>
                            <td class="valor-cell ${diferenciaClass}">${formatCurrency(diferencia)}</td>
                            <td class="text-center">
                                <button class="btn-ver" onclick="abrirModalPayments('${req.request_id}', '${escapeHtml(solicitanteName)}')">
                                    <i class="bi bi-arrow-right-circle me-1"></i>Ver Pagos
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;

                console.log(`✅ ${data.length} requerimientos cargados`);

            } catch (error) {
                console.error('Error cargando requerimientos:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="bi bi-exclamation-triangle"></i>
                            <p>Error al cargar requerimientos: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }
      // ==========================================
        // ABRIR MODAL DE PAGOS
        // ==========================================
        async function abrirModalPayments(requestId, solicitanteName) {
            currentRequestSolicitante = solicitanteName;
            
            // Actualizar info
            document.getElementById('info-payment-categoria').textContent = currentCategoryName;
            document.getElementById('info-payment-item').textContent = currentItemName;
            document.getElementById('info-payment-asignacion').textContent = currentAssignmentDetail;
            document.getElementById('info-payment-solicitante').textContent = solicitanteName;

            // Mostrar modal
            modalPayments.show();

            // Cargar pagos
            await cargarPayments(requestId);
        }

        // ==========================================
        // CARGAR PAGOS
        // ==========================================
        async function cargarPayments(requestId) {
            const tbody = document.getElementById('tbody-payments');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <i class="bi bi-hourglass-split"></i>
                        <p>Cargando pagos...</p>
                    </td>
                </tr>
            `;
            
            try {
                // Query para obtener pagos del requerimiento
                const query = `/budget_payments?select=payment_id,invoice_date,payment_type,invoice_number,invoice_description,invoice_value,suppliers!budget_payments_supplier_fkey(supplier_name)&request_id=eq.${requestId}&order=invoice_date.desc`;
                
                const data = await supabaseRequest(query);

                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p>No hay pagos registrados para este requerimiento</p>
                            </td>
                        </tr>
                    `;
                    document.getElementById('resumen-pagos').style.display = 'none';
                    return;
                }

                let html = '';
                let totalValor = 0;

                data.forEach((pago, index) => {
                    const proveedorName = pago.suppliers?.supplier_name || 'Sin proveedor';
                    const fecha = pago.invoice_date ? formatDate(pago.invoice_date) : 'N/A';
                    const tipoDoc = pago.payment_type || 'N/A';
                    const numero = pago.invoice_number || 'N/A';
                    const descripcion = pago.invoice_description || 'Sin descripción';
                    const valor = pago.invoice_value || 0;

                    totalValor += valor;

                    html += `
                        <tr>
                            <td>${escapeHtml(proveedorName)}</td>
                            <td>${fecha}</td>
                            <td>${escapeHtml(tipoDoc)}</td>
                            <td>${escapeHtml(numero)}</td>
                            <td class="detalle-cell">
                                <div class="detalle-content">
                                    ${escapeHtml(descripcion)}
                                </div>
                            </td>
                            <td class="valor-cell">${formatCurrency(valor)}</td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;

                // Mostrar resumen
                document.getElementById('total-pagos-count').textContent = data.length;
                document.getElementById('total-pagos-valor').textContent = formatCurrency(totalValor);
                document.getElementById('resumen-pagos').style.display = 'block';

                console.log(`✅ ${data.length} pagos cargados - Total: ${formatCurrency(totalValor)}`);

            } catch (error) {
                console.error('Error cargando pagos:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="bi bi-exclamation-triangle"></i>
                            <p>Error al cargar pagos: ${error.message}</p>
                        </td>
                    </tr>
                `;
                document.getElementById('resumen-pagos').style.display = 'none';
            }
        }

        // ==========================================
        // FUNCIONES DE LOADING
        // ==========================================
        function mostrarLoading(mensaje = 'Cargando...') {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            
            if (loadingOverlay) {
                loadingMessage.textContent = mensaje;
                loadingOverlay.classList.remove('hidden');
            }
        }

        function ocultarLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }

        // ==========================================
        // FUNCIONES DE FORMATEO
        // ==========================================
        function formatCurrency(valor) {
            if (!valor || isNaN(valor)) return '$0';
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(valor);
        }

        function formatWorkerName(worker) {
            if (!worker) return 'N/A';
            
            const firstName = worker.worker_first_name || '';
            const lastName1 = worker.worker_last_name_1 || '';
            const lastName2 = worker.worker_last_name_2 || '';
            
            if (lastName2 && lastName2.trim()) {
                return `${lastName1} ${lastName2} ${firstName}`.trim();
            } else {
                return `${lastName1} ${firstName}`.trim();
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (error) {
                return dateString;
            }
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            
            try {
                const date = new Date(dateTimeString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            } catch (error) {
                return dateTimeString;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================
        // HACER FUNCIONES GLOBALES
        // ==========================================
        window.abrirModalItems = abrirModalItems;
        window.abrirModalAssignments = abrirModalAssignments;
        window.abrirModalRequests = abrirModalRequests;
        window.abrirModalPayments = abrirModalPayments;

        console.log('✅ Página de Vista Detallada por Categoría cargada correctamente');
    </script>
</body>
</html>
