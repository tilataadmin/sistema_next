<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.25.13.30">
    <title>Resoluci√≥n de Solicitudes - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Configuraci√≥n del sistema -->
    <script src="../../assets/js/config.js"></script>
    
    <style>
        .solicitudes-container {
            margin: 2rem 0;
        }
        
        .solicitudes-table {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .solicitudes-table th {
            background-color: #0d6efd;
            color: white;
            font-weight: 600;
            border: none;
            font-size: 0.875rem;
            padding: 0.75rem 0.5rem;
        }
        
        .solicitudes-table td {
            vertical-align: middle;
            border-color: #e9ecef;
            font-size: 0.875rem;
            padding: 0.75rem 0.5rem;
        }
        
        .solicitudes-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Columnas espec√≠ficas */
        .col-solicitante {
            width: 15%;
            min-width: 120px;
        }
        
        .col-rubro {
            width: 15%;
            min-width: 120px;
        }
        
        .col-subitem {
            width: 15%;
            min-width: 120px;
        }
        
        .col-disponible {
            width: 12%;
            text-align: right;
        }
        
        .col-detalle {
            width: 25%;
            max-width: 200px;
        }
        
        .col-valor {
            width: 12%;
            text-align: right;
        }
        
        .col-accion {
            width: 16%;
            text-align: center;
        }
        
        /* Select de decisi√≥n */
        .decision-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: white;
            font-size: 0.8125rem;
        }
        
        .decision-select:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }
        
        .decision-select.aprobado {
            background-color: #d1eddf;
            color: #0f5132;
            border-color: #198754;
        }
        
        .decision-select.desaprobado {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        
        .decision-select.sobreejecucion {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }
        
        /* Valores monetarios */
        .valor-positivo {
            color: #198754;
            font-weight: 600;
        }
        
        .valor-negativo {
            color: #dc3545;
            font-weight: 700;
        }
        
        .valor-neutro {
            color: #0d6efd;
            font-weight: 600;
        }
        
        /* Detalle expandible */
        .detalle-corto {
            cursor: pointer;
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .detalle-corto:hover {
            text-decoration: underline;
            color: #0d6efd;
        }
        
        /* Indicadores de estado */
        .indicador-disponible {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .indicador-disponible.suficiente {
            background-color: #198754;
        }
        
        .indicador-disponible.insuficiente {
            background-color: #dc3545;
        }
        
        /* Estado vac√≠o */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            margin: 2rem 0;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
            color: #198754;
        }
        
        .loading-table {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .solicitudes-table {
                font-size: 0.8125rem;
            }
            
            .col-detalle {
                max-width: 150px;
            }
        }
        
        @media (max-width: 768px) {
            .solicitudes-table {
                font-size: 0.75rem;
            }
            
            .solicitudes-table th,
            .solicitudes-table td {
                padding: 0.5rem 0.25rem;
            }
            
            .col-solicitante,
            .col-subitem {
                min-width: 100px;
            }
            
            .col-detalle {
                max-width: 120px;
            }
        }

        /* Estilos para texto enriquecido en el modal */
        .detalle-enriquecido {
            line-height: 1.6;
        }
        
        .detalle-enriquecido p {
            margin-bottom: 0.75rem;
        }
        
        .detalle-enriquecido p:last-child {
            margin-bottom: 0;
        }
        
        .detalle-enriquecido ul,
        .detalle-enriquecido ol {
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
        }
        
        .detalle-enriquecido strong,
        .detalle-enriquecido b {
            font-weight: 600;
        }
        
    </style>
</head>
<body>
    <!-- Loading overlay inicial -->
    <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background-color: rgba(255,255,255,0.9); z-index: 9999;">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mb-0">Cargando formulario...</p>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div id="mainContainer" class="container-fluid py-4 d-none">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html" class="text-decoration-none">
                        <i class="bi bi-house-fill me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="../budget/index.html" class="text-decoration-none">Presupuesto</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Resoluci√≥n de Solicitudes</li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex align-items-center">
                    <i class="bi bi-check2-square text-primary me-3" style="font-size: 2rem;"></i>
                    <div>
                        <h1 class="h3 mb-0">Resoluci√≥n de Solicitudes</h1>
                        <p class="text-muted mb-0">Procesar solicitudes de ejecuci√≥n presupuestal pendientes de autorizaci√≥n</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer" class="mb-4"></div>

        <!-- Informaci√≥n del usuario -->
        <div id="usuarioInfo" class="alert alert-info d-none">
            <i class="bi bi-info-circle me-2"></i>
            <span id="usuarioTexto"></span>
        </div>

        <!-- Tabla de solicitudes -->
        <div class="solicitudes-container">
            <div id="tablaContainer">
                <!-- Loading state -->
                <div id="loadingTable" class="loading-table">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Cargando solicitudes...</span>
                    </div>
                    <p>Cargando solicitudes pendientes...</p>
                </div>
                
                <!-- Tabla de solicitudes -->
                <div id="tableWrapper" class="d-none">
                    <div class="table-responsive">
                        <table class="table table-hover solicitudes-table">
                            <thead>
                                <tr>
                                    <th class="col-solicitante">Solicitado por</th>
                                    <th class="col-rubro">Rubro</th>
                                    <th class="col-subitem">Sub-√≠tem</th>
                                    <th class="col-disponible">Disponible</th>
                                    <th class="col-detalle">Detalle</th>
                                    <th class="col-valor">Valor</th>
                                    <th class="col-accion">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="solicitudesTbody">
                                <!-- Datos cargados din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Estado vac√≠o -->
                <div id="emptyState" class="empty-state d-none">
                    <i class="bi bi-check-circle-fill"></i>
                    <h4>No hay solicitudes pendientes</h4>
                    <p>Todas las solicitudes han sido procesadas o no hay nuevas solicitudes para revisar.</p>
                    <p class="text-muted">Este formulario se actualizar√° autom√°ticamente cuando lleguen nuevas solicitudes.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver detalle completo -->
    <div class="modal fade" id="modalDetalle" tabindex="-1" aria-labelledby="modalDetalleLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalDetalleLabel">
                        <i class="bi bi-file-text text-primary me-2"></i>
                        Detalle de la Solicitud
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="detalleCompletoContenido" class="border rounded p-3" style="background-color: #f8f9fa; max-height: 400px; overflow-y: auto;">
                        <!-- El contenido se cargar√° din√°micamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript del formulario -->
    <script>
        // Verificar acceso y cargar p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Validar acceso antes de cargar
                const hasAccess = await validatePageAccess('Resoluci√≥n de solicitudes');
                if (!hasAccess) {
                    return; // validatePageAccess maneja la redirecci√≥n
                }
                
                // Inicializar p√°gina
                initializePage('requestResolution', 'Presupuesto');
                
                // Cargar datos iniciales
                await cargarDatosIniciales();
                
            } catch (error) {
                console.error('Error al inicializar p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        });

        // ===== VARIABLES GLOBALES =====
        let solicitudesData = [];
        let currentUserEmail = null;
        let modalDetalle;

        // ===== ELEMENTOS DEL DOM =====
        const elementos = {
            loadingOverlay: document.getElementById('loadingOverlay'),
            mainContainer: document.getElementById('mainContainer'),
            alertContainer: document.getElementById('alertContainer'),
            usuarioInfo: document.getElementById('usuarioInfo'),
            usuarioTexto: document.getElementById('usuarioTexto'),
            tablaContainer: document.getElementById('tablaContainer'),
            loadingTable: document.getElementById('loadingTable'),
            tableWrapper: document.getElementById('tableWrapper'),
            solicitudesTbody: document.getElementById('solicitudesTbody'),
            emptyState: document.getElementById('emptyState'),
            modalDetalle: document.getElementById('modalDetalle'),
            detalleCompletoContenido: document.getElementById('detalleCompletoContenido')
        };

        // ===== CARGA DE DATOS =====
        async function cargarDatosIniciales() {
            try {
                showMessage('Cargando datos del formulario...', 'info');
                
                // Obtener email del usuario actual
                await obtenerEmailUsuario();
                
                // Cargar solicitudes pendientes
                await cargarSolicitudesPendientes();
                
                // Configurar event listeners
                configurarEventListeners();
                
                // Mostrar formulario
                mostrarFormularioPrincipal();
                
            } catch (error) {
                console.error('Error al cargar datos iniciales:', error);
                showMessage('Error al cargar los datos: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        async function obtenerEmailUsuario() {
            const session = getStoredSession();
            if (!session || !session.user || !session.user.user_mail) {
                throw new Error('No se pudo obtener el email del usuario actual');
            }

            currentUserEmail = session.user.user_mail;
            
            // Mostrar informaci√≥n del usuario
            elementos.usuarioTexto.textContent = `Revisando solicitudes dirigidas a: ${currentUserEmail}`;
            elementos.usuarioInfo.classList.remove('d-none');
        }

        async function cargarSolicitudesPendientes() {
            elementos.loadingTable.classList.remove('d-none');
            elementos.tableWrapper.classList.add('d-none');
            elementos.emptyState.classList.add('d-none');
        
            try {
                // Obtener a√±o presupuestal activo
                const configQuery = 'system_config?select=current_budget_year_id&limit=1';
                const configData = await supabaseRequest('/' + configQuery);
                
                if (configData.length === 0 || !configData[0].current_budget_year_id) {
                    throw new Error('No hay a√±o presupuestal activo configurado');
                }
                
                const currentBudgetYearId = configData[0].current_budget_year_id;
                
                // Consultar solicitudes pendientes dirigidas al usuario actual del a√±o presupuestal activo
                const query = `execution_requests?select=request_id,assignment_id,requested_value,request_details,requested_at,workers!execution_requests_worker_fkey(worker_first_name,worker_last_name_1,worker_last_name_2,email),budget_assignments!inner(academic_year_id,approved_value,executed_value,budget_items(item_name,budget_categories(category_name)),workers!budget_assignments_worker_id_fkey!inner(email))&request_status=eq.pending&budget_assignments.workers.email=eq.${currentUserEmail}&budget_assignments.academic_year_id=eq.${currentBudgetYearId}&order=requested_at.desc`;
                const data = await supabaseRequest('/' + query);
                
                // Procesar datos
                solicitudesData = data.map(solicitud => {
                    const worker = solicitud.workers;
                    const assignment = solicitud.budget_assignments;
                    
                    return {
                        request_id: solicitud.request_id,
                        assignment_id: solicitud.assignment_id,
                        requested_value: solicitud.requested_value || 0,
                        request_details: solicitud.request_details || '',
                        requested_at: solicitud.requested_at,
                        solicitante_nombre: construirNombreCompleto(worker),
                        solicitante_email: worker?.email || '',
                        rubro_name: assignment?.budget_items?.budget_categories?.category_name || 'Sin rubro',
                        sub_item_name: assignment?.budget_items?.item_name || 'Sin nombre',
                        approved_value: assignment?.approved_value || 0,
                        executed_value: assignment?.executed_value || 0,
                        disponible: (assignment?.approved_value || 0) - (assignment?.executed_value || 0)
                    };
                });
                
                renderizarSolicitudes();
                
            } catch (error) {
                console.error('Error al cargar solicitudes:', error);
                showMessage('Error al cargar solicitudes: ' + error.message, 'danger');
                mostrarEstadoVacio();
            } finally {
                elementos.loadingTable.classList.add('d-none');
            }
        }
        
        // ===== RENDERIZADO DE TABLA =====
        function renderizarSolicitudes() {
            if (!solicitudesData || solicitudesData.length === 0) {
                mostrarEstadoVacio();
                return;
            }

            // Construir tabla con DocumentFragment para optimizaci√≥n
            const fragment = document.createDocumentFragment();
            
            solicitudesData.forEach(solicitud => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-request-id', solicitud.request_id);
                
                // Calcular disponible y determinar si hay sobreejecuci√≥n
                const disponible = solicitud.disponible;
                const esSobreEjecucion = disponible < solicitud.requested_value;
                
                // Formatear valores monetarios
                const disponibleFormateado = formatearMoneda(disponible);
                const valorFormateado = formatearMoneda(solicitud.requested_value);
                
                // Truncar detalle para la tabla
                const detalleCorto = truncarTexto(solicitud.request_details, 50);
                const tieneDetalleCompleto = solicitud.request_details.length > 50;
                
                // Crear opciones del select seg√∫n disponibilidad
                const opcionesSelect = esSobreEjecucion 
                    ? '<option value="">Seleccione...</option><option value="approved_overrun">Aprobado con sobreejecuci√≥n</option><option value="rejected">Desaprobado</option>'
                    : '<option value="">Seleccione...</option><option value="approved">Aprobado</option><option value="rejected">Desaprobado</option>';
                
                tr.innerHTML = `
                    <td class="col-solicitante">${escapeHtml(solicitud.solicitante_nombre)}</td>
                    <td class="col-rubro">${escapeHtml(solicitud.rubro_name)}</td>
                    <td class="col-subitem">${escapeHtml(solicitud.sub_item_name)}</td>
                    <td class="col-disponible">
                        <span class="indicador-disponible ${esSobreEjecucion ? 'insuficiente' : 'suficiente'}" 
                              title="${esSobreEjecucion ? 'Presupuesto insuficiente - Requerir√° sobreejecuci√≥n' : 'Presupuesto suficiente'}"></span>
                        <span class="${esSobreEjecucion ? 'valor-negativo' : 'valor-positivo'}">
                            ${disponibleFormateado}
                        </span>
                    </td>
                    <td class="col-detalle">
                        <div class="${tieneDetalleCompleto ? 'detalle-corto' : ''}" 
                             ${tieneDetalleCompleto ? `data-bs-toggle="modal" data-bs-target="#modalDetalle"` : ''}>
                            ${detalleCorto}
                        </div>
                    </td>
                    <td class="col-valor valor-neutro">${valorFormateado}</td>
                    <td class="col-accion">
                        <select class="decision-select form-select form-select-sm">
                            ${opcionesSelect}
                        </select>
                    </td>
                `;
                
                // Agregar event listener al select despu√©s de crear la fila
                const selectDecision = tr.querySelector('.decision-select');
                selectDecision.addEventListener('change', function() {
                    if (this.value) {
                        procesarDecision(solicitud.request_id, this.value, this, solicitud);
                    }
                });
                
                // Agregar event listener al detalle si es expandible
                if (tieneDetalleCompleto) {
                    const detalleDiv = tr.querySelector('.detalle-corto');
                    detalleDiv.addEventListener('click', function() {
                        mostrarDetalleCompleto(solicitud.request_details, solicitud.solicitante_nombre);
                    });
                }
                
                fragment.appendChild(tr);
            });
            
            elementos.solicitudesTbody.innerHTML = '';
            elementos.solicitudesTbody.appendChild(fragment);
            
            elementos.tableWrapper.classList.remove('d-none');
            elementos.emptyState.classList.add('d-none');
            
            showMessage(`Se encontraron ${solicitudesData.length} solicitudes pendientes de resoluci√≥n`, 'success');
        }

        function mostrarEstadoVacio() {
            elementos.tableWrapper.classList.add('d-none');
            elementos.emptyState.classList.remove('d-none');
            showMessage('No hay solicitudes pendientes para procesar', 'info');
        }

        // ===== EVENT LISTENERS =====
        function configurarEventListeners() {
            // Inicializar modal de Bootstrap
            modalDetalle = new bootstrap.Modal(elementos.modalDetalle);
            
            // Atajos de teclado
            document.addEventListener('keydown', function(e) {
                // F5 para refrescar solicitudes
                if (e.key === 'F5') {
                    e.preventDefault();
                    refrescarSolicitudes();
                }
                
                // Ctrl+H para mostrar ayuda
                if (e.ctrlKey && e.key === 'h') {
                    e.preventDefault();
                    mostrarAyuda();
                }
            });
        }

        // ===== MODAL DE DETALLE =====
        function mostrarDetalleCompleto(detalle, solicitante) {
            elementos.detalleCompletoContenido.innerHTML = `
                <div class="mb-3">
                    <h6 class="text-primary mb-2">
                        <i class="bi bi-person-fill me-1"></i>Solicitado por: ${escapeHtml(solicitante)}
                    </h6>
                </div>
                <div class="border-top pt-3">
                    <h6 class="mb-2">Detalle de la solicitud:</h6>
                    <div class="detalle-enriquecido bg-white p-3 border rounded">
                        ${detalle}
                    </div>
                </div>
            `;
            
            modalDetalle.show();
        }

        // ===== PROCESAMIENTO DE DECISIONES =====
        async function procesarDecision(requestId, decision, selectElement, solicitud) {
            // Confirmar acci√≥n
            const confirmMessage = getConfirmMessage(decision, solicitud);
            
            if (!confirm(confirmMessage)) {
                selectElement.value = '';
                return;
            }
            
            // Deshabilitar select y mostrar estado de procesamiento
            selectElement.disabled = true;
            selectElement.innerHTML = '<option>Procesando...</option>';
            
            try {
                await ejecutarDecision(requestId, decision, solicitud);
                
                // Aplicar estilo seg√∫n decisi√≥n
                aplicarEstiloDecision(selectElement, decision);
                showMessage(getSuccessMessage(decision), 'success');
                
                // Recargar solicitudes despu√©s de un momento
                setTimeout(() => {
                    cargarSolicitudesPendientes();
                }, 2000);
                
            } catch (error) {
                console.error('Error al procesar decisi√≥n:', error);
                showMessage('Error al procesar decisi√≥n: ' + error.message, 'danger');
                habilitarSelect(selectElement, decision);
            }
        }

        async function ejecutarDecision(requestId, decision, solicitud) {
            const timestamp = new Date().toISOString();
            
            // Actualizar estado de la solicitud
            const newStatus = decision === 'rejected' ? 'rejected' : 'approved';
            
            await supabaseRequest(`/execution_requests?request_id=eq.${requestId}`, {
                method: 'PATCH',
                body: JSON.stringify({
                    request_status: newStatus,
                    responded_at: timestamp
                })
            });
            // Si es aprobado, incrementar executed_value
            if (decision === 'approved' || decision === 'approved_overrun') {
                const currentExecuted = solicitud.executed_value || 0;
                const newExecutedValue = currentExecuted + solicitud.requested_value;
                
                await supabaseRequest(`/budget_assignments?assignment_id=eq.${solicitud.assignment_id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        executed_value: newExecutedValue
                    })
                });
                
                // Enviar notificaciones
                if (decision === 'approved_overrun') {
                    await enviarNotificacionSobreejecucion(solicitud);
                    await enviarNotificacionAprobacion(solicitud, true);  // Con sobreejecuci√≥n
                } else {
                    await enviarNotificacionAprobacion(solicitud, false); // Aprobaci√≥n normal
                }
            }
             else if (decision === 'rejected') {
                await enviarNotificacionRechazo(solicitud);
            }
        }

        function getConfirmMessage(decision, solicitud) {
            switch (decision) {
                case 'rejected':
                    return '¬øEst√° seguro de que desea RECHAZAR esta solicitud?';
                case 'approved_overrun':
                    const sobreEjecucion = solicitud.requested_value - solicitud.disponible;
                    const sobreEjecucionFormateado = formatearMoneda(sobreEjecucion);
                    return `‚ö†Ô∏è Esta decisi√≥n generar√° una SOBREEJECUCI√ìN de ${sobreEjecucionFormateado}. ¬øEst√° seguro de que desea aprobar?`;
                case 'approved':
                default:
                    return '¬øEst√° seguro de que desea APROBAR esta solicitud?';
            }
        }

        function getSuccessMessage(decision) {
            switch (decision) {
                case 'rejected':
                    return 'Solicitud rechazada exitosamente';
                case 'approved_overrun':
                    return 'Solicitud aprobada con sobreejecuci√≥n. Se ha notificado al administrador presupuestal.';
                case 'approved':
                default:
                    return 'Solicitud aprobada exitosamente';
            }
        }

        // ===== NOTIFICACIONES =====
        async function enviarNotificacionSobreejecucion(solicitud) {
            try {
                // Obtener email del budget admin desde configuraci√≥n
                const configQuery = 'system_config?select=budget_admin_email&limit=1';
                const configData = await supabaseRequest('/' + configQuery);
                
                if (configData.length === 0 || !configData[0].budget_admin_email) {
                    console.warn('No se encontr√≥ email del budget admin');
                    return;
                }
                
                const budgetAdminEmail = configData[0].budget_admin_email;
                const sobreEjecucion = solicitud.requested_value - solicitud.disponible;
                const sobreEjecucionFormateado = formatearMoneda(sobreEjecucion);
                
                const asunto = `SchoolNet - Sobreejecuci√≥n autorizada en ${solicitud.sub_item_name}`;
                
                const cuerpoHtml = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
                        <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px;">
                            <h2 style="color: #856404; margin-top: 0; margin-bottom: 10px;">‚ö†Ô∏è Notificaci√≥n de Sobreejecuci√≥n Autorizada</h2>
                            <p style="margin: 0; color: #856404; font-weight: 500;">SchoolNet - Sistema de Gesti√≥n Educativa</p>
                        </div>
                        
                        <div style="background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <p style="margin-top: 0;">Se le informa que se ha autorizado una sobreejecuci√≥n presupuestal.</p>
                            
                            <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #dee2e6;">
                                <tr style="background-color: #f8f9fa;">
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Concepto</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Detalle</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Sub-√≠tem:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">${escapeHtml(solicitud.sub_item_name)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Solicitante:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">${escapeHtml(solicitud.solicitante_nombre)} (${escapeHtml(solicitud.solicitante_email)})</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Autorizador:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">${escapeHtml(currentUserEmail)}</td>
                                </tr>
                                <tr style="background-color: #fff3cd;">
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Sobreejecuci√≥n:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-family: monospace; color: #856404; font-weight: bold;">${sobreEjecucionFormateado}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <hr style="margin: 30px 0; border: none; border-top: 1px solid #dee2e6;">
                        <p style="color: #6c757d; font-size: 12px; margin: 0; text-align: center;">
                            Este correo es generado autom√°ticamente por SchoolNet. Por favor, no responder a este mensaje.<br>
                            Colegio Tilata - Sistema de Gesti√≥n Educativa
                        </p>
                    </div>
                `;
                
                await sendNotification(budgetAdminEmail, asunto, cuerpoHtml, true);
                
            } catch (error) {
                console.error('Error enviando notificaci√≥n de sobreejecuci√≥n:', error);
            }
        }

        async function enviarNotificacionRechazo(solicitud) {
            try {
                const valorFormateado = formatearMoneda(solicitud.requested_value);
                const asunto = `SchoolNet - Solicitud rechazada para ${solicitud.sub_item_name}`;
                
                const cuerpoHtml = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
                        <div style="background-color: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin-bottom: 20px;">
                            <h2 style="color: #721c24; margin-top: 0; margin-bottom: 10px;">‚ùå Solicitud Rechazada</h2>
                            <p style="margin: 0; color: #721c24; font-weight: 500;">SchoolNet - Sistema de Gesti√≥n Educativa</p>
                        </div>
                        
                        <div style="background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <p style="margin-top: 0;">Le informamos que su solicitud presupuestal ha sido rechazada.</p>
                            
                            <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #dee2e6;">
                                <tr style="background-color: #f8f9fa;">
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Concepto</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Detalle</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Sub-√≠tem:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">${escapeHtml(solicitud.sub_item_name)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Valor solicitado:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-family: monospace;">${valorFormateado}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Rechazado por:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">${escapeHtml(currentUserEmail)}</td>
                                </tr>
                            </table>
                            
                            <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin: 20px 0;">
                                <h4 style="margin-top: 0; color: #495057;">Detalle de la solicitud:</h4>
                                <div style="background-color: white; padding: 10px; border-radius: 3px; border-left: 3px solid #dc3545;">
                                    ${solicitud.request_details}
                                </div>
                            </div>
                        </div>
                        
                        <hr style="margin: 30px 0; border: none; border-top: 1px solid #dee2e6;">
                        <p style="color: #6c757d; font-size: 12px; margin: 0; text-align: center;">
                            Este correo es generado autom√°ticamente por SchoolNet. Por favor, no responder a este mensaje.<br>
                            Colegio Tilata - Sistema de Gesti√≥n Educativa
                        </p>
                    </div>
                `;
                
                await sendNotification(solicitud.solicitante_email, asunto, cuerpoHtml, true);
                
            } catch (error) {
                console.error('Error enviando notificaci√≥n de rechazo:', error);
            }
        }

        async function enviarNotificacionAprobacion(solicitud, conSobreejecucion = false) {
            try {
                const valorFormateado = formatearMoneda(solicitud.requested_value);
                const tipoAprobacion = conSobreejecucion ? 'aprobada con sobreejecuci√≥n' : 'aprobada';
                const asunto = `SchoolNet - Solicitud ${tipoAprobacion} para ${solicitud.sub_item_name}`;
                
                const colorBanner = conSobreejecucion ? '#fff3cd' : '#d1eddf';
                const colorBorde = conSobreejecucion ? '#ffc107' : '#198754';
                const colorTexto = conSobreejecucion ? '#856404' : '#0f5132';
                const icono = conSobreejecucion ? '‚ö†Ô∏è' : '‚úÖ';
                const tituloEstado = conSobreejecucion ? 'Solicitud Aprobada con Sobreejecuci√≥n' : 'Solicitud Aprobada';
                
                const cuerpoHtml = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
                        <div style="background-color: ${colorBanner}; border-left: 4px solid ${colorBorde}; padding: 15px; margin-bottom: 20px;">
                            <h2 style="color: ${colorTexto}; margin-top: 0; margin-bottom: 10px;">${icono} ${tituloEstado}</h2>
                            <p style="margin: 0; color: ${colorTexto}; font-weight: 500;">SchoolNet - Sistema de Gesti√≥n Educativa</p>
                        </div>
                        
                        <div style="background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <p style="margin-top: 0;">Le informamos que su solicitud presupuestal ha sido <strong>${tipoAprobacion}</strong>.</p>
                            
                            <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #dee2e6;">
                                <tr style="background-color: #f8f9fa;">
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Concepto</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Detalle</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Sub-√≠tem:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">${escapeHtml(solicitud.sub_item_name)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Valor aprobado:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-family: monospace; color: ${colorTexto}; font-weight: bold;">${valorFormateado}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Aprobado por:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">${escapeHtml(currentUserEmail)}</td>
                                </tr>
                            </table>
                            
                            <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin: 20px 0;">
                                <h4 style="margin-top: 0; color: #495057;">Detalle de la solicitud:</h4>
                                <div style="background-color: white; padding: 10px; border-radius: 3px; border-left: 3px solid ${colorBorde};">
                                    ${solicitud.request_details}
                                </div>
                            </div>
                        </div>
                        
                        <hr style="margin: 30px 0; border: none; border-top: 1px solid #dee2e6;">
                        <p style="color: #6c757d; font-size: 12px; margin: 0; text-align: center;">
                            Este correo es generado autom√°ticamente por SchoolNet. Por favor, no responder a este mensaje.<br>
                            Colegio Tilata - Sistema de Gesti√≥n Educativa
                        </p>
                    </div>
                `;
                
                await sendNotification(solicitud.solicitante_email, asunto, cuerpoHtml, true);
                
            } catch (error) {
                console.error('Error enviando notificaci√≥n de aprobaci√≥n:', error);
            }
        }

        // ===== FUNCIONES DE ESTILO =====
        function aplicarEstiloDecision(selectElement, decision) {
            selectElement.disabled = true;
            selectElement.classList.remove('aprobado', 'desaprobado', 'sobreejecucion');
            
            switch (decision) {
                case 'approved':
                    selectElement.innerHTML = '<option>Aprobado</option>';
                    selectElement.classList.add('aprobado');
                    break;
                case 'rejected':
                    selectElement.innerHTML = '<option>Desaprobado</option>';
                    selectElement.classList.add('desaprobado');
                    break;
                case 'approved_overrun':
                    selectElement.innerHTML = '<option>Aprobado con sobreejecuci√≥n</option>';
                    selectElement.classList.add('sobreejecucion');
                    break;
            }
        }

        function habilitarSelect(selectElement, decision) {
            selectElement.disabled = false;
            
            // Recrear opciones seg√∫n tipo de decisi√≥n
            const esSobreEjecucion = decision === 'approved_overrun';
            const opcionesSelect = esSobreEjecucion 
                ? '<option value="">Seleccione...</option><option value="approved_overrun">Aprobado con sobreejecuci√≥n</option><option value="rejected">Desaprobado</option>'
                : '<option value="">Seleccione...</option><option value="approved">Aprobado</option><option value="rejected">Desaprobado</option>';
            
            selectElement.innerHTML = opcionesSelect;
        }

        // ===== FUNCIONES AUXILIARES =====
        function construirNombreCompleto(worker) {
            if (!worker) return 'Usuario desconocido';
            
            const apellido1 = worker.worker_last_name_1 || '';
            const apellido2 = worker.worker_last_name_2 || '';
            const nombre = worker.worker_first_name || '';
            
            let nombreCompleto = apellido1;
            if (apellido2) {
                nombreCompleto += ' ' + apellido2;
            }
            if (nombre) {
                nombreCompleto += ' ' + nombre;
            }
            
            return nombreCompleto.trim() || 'Sin nombre';
        }

        function truncarTexto(texto, maxLength) {
            if (!texto) return '';
            
            // Crear elemento temporal para extraer solo el texto
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = texto;
            const textoPlano = tempDiv.textContent || tempDiv.innerText || '';
            
            if (textoPlano.length <= maxLength) {
                return escapeHtml(textoPlano);
            }
            
            return escapeHtml(textoPlano.substring(0, maxLength).trim()) + '...';
        }

        
        function formatearMoneda(valor) {
            if (!valor || isNaN(valor)) return '$0';
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(valor);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function mostrarFormularioPrincipal() {
            elementos.loadingOverlay.classList.add('d-none');
            elementos.mainContainer.classList.remove('d-none');
        }

        function ocultarLoading() {
            elementos.loadingOverlay.classList.add('d-none');
        }

        function refrescarSolicitudes() {
            showMessage('Actualizando solicitudes...', 'info');
            cargarSolicitudesPendientes();
        }

        function mostrarAyuda() {
            const ayuda = `
                <strong>Atajos de teclado:</strong><br>
                ‚Ä¢ F5: Actualizar solicitudes<br>
                ‚Ä¢ Ctrl+H: Mostrar esta ayuda<br><br>
                <strong>Colores:</strong><br>
                ‚Ä¢ üü¢ Verde: Presupuesto suficiente<br>
                ‚Ä¢ üî¥ Rojo: Presupuesto insuficiente (sobreejecuci√≥n)<br><br>
                <strong>Estados:</strong><br>
                ‚Ä¢ Verde: Aprobado<br>
                ‚Ä¢ Amarillo: Aprobado con sobreejecuci√≥n<br>
                ‚Ä¢ Rojo: Desaprobado
            `;
            
            showMessage(ayuda, 'info');
        }
    </script>
</body>
</html>
    </script>
</body>
</html>
