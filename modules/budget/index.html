<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuesto - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSIÓN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos específicos para índices de módulos -->
    <style>
        /* Variables CSS del módulo Presupuesto */
        :root {
            --module-primary: #0d6efd;
            --module-secondary: #cfe2ff;
            --module-light: #cfe2ff;
        }
        
        /* Badges minimalistas */
        .badge-module {
            background-color: var(--module-light);
            color: var(--module-primary);
            font-weight: 500;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
        }
        
        /* Tarjetas de métricas */
        .metric-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--module-primary);
            line-height: 1;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0;
        }
        
        .metric-icon {
            color: var(--module-primary);
            font-size: 1.5rem;
        }
        
        /* Tarjetas de funciones */
        .function-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
            height: 100%;
        }
        
        .function-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            color: inherit;
            text-decoration: none;
        }
        
        .function-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background-color: var(--module-light);
            color: var(--module-primary);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }
        
        .function-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .function-description {
            font-size: 0.875rem;
            color: #6c757d;
            line-height: 1.4;
        }
        
        /* Estados de loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--module-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .metric-value {
                font-size: 1.5rem;
            }
            
            .function-icon {
                width: 40px;
                height: 40px;
                font-size: 1.25rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando módulo...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS MINIMALISTAS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Presupuesto
                </li>
            </ol>
        </nav>

        <!-- HEADER MINIMALISTA CON BADGES -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex align-items-center justify-content-between flex-wrap">
                    <div>
                        <h1 class="h3 mb-2">
                            <i class="bi bi-calculator me-2" style="color: var(--module-primary);"></i>
                            Presupuesto
                        </h1>
                        <p class="text-muted mb-2">Gestión presupuestal y financiera del colegio</p>
                        
                        <!-- BADGES CONTEXTUALES -->
                        <div class="d-flex gap-2 flex-wrap" id="module-badges">
                            <!-- Los badges se cargan dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- SECCIÓN DE MÉTRICAS -->
        <!-- SECCIÓN DE MÉTRICAS CON CARGA DIFERIDA -->
        <div class="row mb-5" id="metrics-section">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-muted mb-0">
                        <i class="bi bi-graph-up me-2"></i>Resumen del Módulo
                    </h5>
                    <!-- BOTÓN DE CARGA DE MÉTRICAS -->
                    <button class="btn btn-outline-primary btn-sm" id="btn-load-metrics" onclick="cargarMetricas()">
                        <i class="bi bi-bar-chart me-1"></i>Cargar Métricas
                    </button>
                </div>
                
                <div class="row g-3" id="metrics-container">
                    <!-- Métrica 1: Presupuesto Total -->
                    <div class="col-6 col-lg-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="metric-value" id="metric-1-value">
                                        <span class="text-muted">--</span>
                                    </div>
                                    <i class="bi bi-cash-stack metric-icon"></i>
                                </div>
                                <p class="metric-label">Presupuesto Total</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Métrica 2: Valor Ejecutado -->
                    <div class="col-6 col-lg-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="metric-value" id="metric-2-value">
                                        <span class="text-muted">--</span>
                                    </div>
                                    <i class="bi bi-graph-up-arrow metric-icon"></i>
                                </div>
                                <p class="metric-label">Valor Ejecutado</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Métrica 3: Porcentaje de Ejecución -->
                    <div class="col-6 col-lg-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="metric-value" id="metric-3-value">
                                        <span class="text-muted">--</span>
                                    </div>
                                    <i class="bi bi-percent metric-icon"></i>
                                </div>
                                <p class="metric-label">% de Ejecución</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Métrica 4: Solicitudes Pendientes -->
                    <div class="col-6 col-lg-3">
                        <div class="card metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="metric-value" id="metric-4-value">
                                        <span class="text-muted">--</span>
                                    </div>
                                    <i class="bi bi-hourglass-split metric-icon"></i>
                                </div>
                                <p class="metric-label">Solicitudes Pendientes</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- GRID DE FUNCIONES CON GRUPOS -->
        <div class="row mb-5">
            <div class="col-12">
                <h5 class="text-muted mb-3">
                    <i class="bi bi-grid-3x3-gap me-2"></i>Funciones del Módulo
                </h5>
                
                <!-- GRUPO 1: ADMINISTRACIÓN -->
                <div class="mb-4">
                    <h6 class="text-secondary mb-3">Administración</h6>
                    <div class="row g-3">
                        <!-- Función 1: Gestionar PUC -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="chart-of-accounts.html" class="function-card card h-100" data-permission="Gestionar PUC">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-list-ol"></i>
                                    </div>
                                    <h6 class="function-title">Gestionar PUC</h6>
                                    <p class="function-description">Plan Único de Cuentas contable</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 2: Subir el combo -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="upload-combo.html" class="function-card card h-100" data-permission="Subir el combo">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-upload"></i>
                                    </div>
                                    <h6 class="function-title">Subir el Combo</h6>
                                    <p class="function-description">Cargar movimientos contables</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 3: Gestionar IVA asociado -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="tax-types.html" class="function-card card h-100" data-permission="Gestionar IVA asociado">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-receipt"></i>
                                    </div>
                                    <h6 class="function-title">Gestionar IVA Asociado</h6>
                                    <p class="function-description">Tipos de impuestos del sistema</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 4: Gestionar rubros -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="budget-categories.html" class="function-card card h-100" data-permission="Gestionar rubros">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-folder"></i>
                                    </div>
                                    <h6 class="function-title">Gestionar Rubros</h6>
                                    <p class="function-description">Categorías presupuestales principales</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 5: Gestionar subítems -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="budget-items.html" class="function-card card h-100" data-permission="Gestionar subítems">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-tag"></i>
                                    </div>
                                    <h6 class="function-title">Gestionar Subítems</h6>
                                    <p class="function-description">Detalle de líneas presupuestales</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 6: Gestionar proveedores -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="suppliers.html" class="function-card card h-100" data-permission="Gestionar proveedores">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-truck"></i>
                                    </div>
                                    <h6 class="function-title">Gestionar Proveedores</h6>
                                    <p class="function-description">Base de datos de proveedores</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 7: Inicializar año presupuestal -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="initialize-budget-year.html" class="function-card card h-100" data-permission="Inicializar año presupuestal">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-calendar-plus"></i>
                                    </div>
                                    <h6 class="function-title">Inicializar Año Presupuestal</h6>
                                    <p class="function-description">Configurar nuevo periodo presupuestal</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 8: Inicializar año - Generales -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="initialize-budget-general.html" class="function-card card h-100" data-permission="Inicializar año presupuestal - Generales">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-gear"></i>
                                    </div>
                                    <h6 class="function-title">Inicializar Año - Generales</h6>
                                    <p class="function-description">Configuración general del presupuesto</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 9: Autorización de presupuesto -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="budget-authorization.html" class="function-card card h-100" data-permission="Autorización de presupuesto">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-check-circle"></i>
                                    </div>
                                    <h6 class="function-title">Autorización de Presupuesto</h6>
                                    <p class="function-description">Aprobar asignaciones presupuestales</p>
                                </div>
                            </a>
                        </div>

                        <!-- Función 10: Asociar facturas -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="associate-invoices.html" class="function-card card h-100" data-permission="Asociar facturas">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-file-earmark-text"></i>
                                    </div>
                                    <h6 class="function-title">Asociar Facturas</h6>
                                    <p class="function-description">Vincular facturas a ejecuciones</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 11: Diseño de informes -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="report-design.html" class="function-card card h-100" data-permission="Diseño de informes">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-file-bar-graph"></i>
                                    </div>
                                    <h6 class="function-title">Diseño de Informes</h6>
                                    <p class="function-description">Configurar estructura de reportes</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 12: Informe de asignaciones -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="assignments-report.html" class="function-card card h-100" data-permission="Informe de asignaciones">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-clipboard-data"></i>
                                    </div>
                                    <h6 class="function-title">Informe de Asignaciones</h6>
                                    <p class="function-description">Reporte de distribución presupuestal</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 13: Cruce contable -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="accounting-crosscheck.html" class="function-card card h-100" data-permission="Cruce contable">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-arrow-left-right"></i>
                                    </div>
                                    <h6 class="function-title">Cruce Contable</h6>
                                    <p class="function-description">Verificación con contabilidad</p>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- GRUPO 2: OPERACIÓN -->
                <div class="mb-4">
                    <h6 class="text-secondary mb-3">Operación</h6>
                    <div class="row g-3">
                        <!-- Función 14: Petición de presupuesto -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="budget-request.html" class="function-card card h-100" data-permission="Petición de presupuesto">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-file-earmark-plus"></i>
                                    </div>
                                    <h6 class="function-title">Petición de Presupuesto</h6>
                                    <p class="function-description">Solicitar asignación presupuestal</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 15: Designar solicitantes -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="assign-requesters.html" class="function-card card h-100" data-permission="Designar solicitantes">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-person-add"></i>
                                    </div>
                                    <h6 class="function-title">Designar Solicitantes</h6>
                                    <p class="function-description">Autorizar usuarios para solicitar</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 16: Solicitud de ejecución -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="execution-request.html" class="function-card card h-100" data-permission="Solicitud de ejecución">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-play-circle"></i>
                                    </div>
                                    <h6 class="function-title">Solicitud de Ejecución</h6>
                                    <p class="function-description">Ejecutar presupuesto asignado</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 17: Solicitud de cierre -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="closure-request.html" class="function-card card h-100" data-permission="Solicitud de cierre">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-lock"></i>
                                    </div>
                                    <h6 class="function-title">Solicitud de Cierre</h6>
                                    <p class="function-description">Cerrar requerimientos ejecutados</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 18: Resolución de solicitudes -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="request-resolution.html" class="function-card card h-100" data-permission="Resolución de solicitudes">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-check2-square"></i>
                                    </div>
                                    <h6 class="function-title">Resolución de Solicitudes</h6>
                                    <p class="function-description">Aprobar o rechazar peticiones</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 19: Cerrar sobreejecuciones -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="close-overruns.html" class="function-card card h-100" data-permission="Cerrar requerimientos sobrejeecutados">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-exclamation-triangle"></i>
                                    </div>
                                    <h6 class="function-title">Cerrar Sobreejecuciones</h6>
                                    <p class="function-description">Autorizar requerimientos excedidos</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 20: Iniciar traslado -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="budget-transfer.html" class="function-card card h-100" data-permission="Iniciar traslado presupuestal">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </div>
                                    <h6 class="function-title">Iniciar Traslado</h6>
                                    <p class="function-description">Trasladar entre asignaciones</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 21: Cerrar traslado -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="close-transfer.html" class="function-card card h-100" data-permission="Cerrar traslado presupuestal">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-arrow-right-square"></i>
                                    </div>
                                    <h6 class="function-title">Cerrar Traslado</h6>
                                    <p class="function-description">Finalizar traslados presupuestales</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 22: Vista detallada por rubro -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="category-detail.html" class="function-card card h-100" data-permission="Vista detallada por rubro">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-zoom-in"></i>
                                    </div>
                                    <h6 class="function-title">Vista Detallada por Rubro</h6>
                                    <p class="function-description">Análisis por categoría presupuestal</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 23: Vista particular -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="budget-overview.html" class="function-card card h-100" data-permission="Vista particular del presupuesto">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-eye"></i>
                                    </div>
                                    <h6 class="function-title">Vista Particular</h6>
                                    <p class="function-description">Vista personal del presupuesto</p>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Función 24: Consultas -->
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="budget-queries.html" class="function-card card h-100" data-permission="Consultas de presupuesto">
                                <div class="card-body">
                                    <div class="function-icon">
                                        <i class="bi bi-search"></i>
                                    </div>
                                    <h6 class="function-title">Consultas de Presupuesto</h6>
                                    <p class="function-description">Búsquedas y reportes generales</p>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // CONFIGURACIÓN DEL MÓDULO PRESUPUESTO
        // ==========================================
        
        const MODULE_CONFIG = {
            name: 'Presupuesto',
            modulePermissions: [
                // Administración
                'Gestionar PUC',
                'Subir el combo',
                'Gestionar IVA asociado',
                'Gestionar rubros',
                'Gestionar subítems',
                'Gestionar proveedores',
                'Inicializar año presupuestal',
                'Inicializar año presupuestal - Generales',
                'Autorización de presupuesto',
                'Asociar facturas',
                'Diseño de informes',
                'Informe de asignaciones',
                'Cruce contable',
                // Operación
                'Petición de presupuesto',
                'Designar solicitantes',
                'Solicitud de ejecución',
                'Solicitud de cierre',
                'Resolución de solicitudes',
                'Cerrar requerimientos sobrejeecutados',
                'Iniciar traslado presupuestal',
                'Cerrar traslado presupuestal',
                'Vista detallada por rubro',
                'Vista particular del presupuesto',
                'Consultas de presupuesto'
            ],
            color: {
                primary: '#0d6efd',
                secondary: '#cfe2ff', 
                light: '#cfe2ff'
            },
            
            metrics: [
                {
                    id: 'metric-1',
                    label: 'Presupuesto Total',
                    icon: 'cash-stack',
                    query: 'custom_budget_total',
                    format: 'currency',
                    allowedRoles: ['Estrategas', 'Gestor de Presupuesto', 'Autorizador de presupuesto']
                },
                {
                    id: 'metric-2',
                    label: 'Valor Ejecutado',
                    icon: 'graph-up-arrow',
                    query: 'custom_budget_executed',
                    format: 'currency',
                    allowedRoles: ['Estrategas', 'Gestor de Presupuesto', 'Autorizador de presupuesto']
                },
                {
                    id: 'metric-3',
                    label: '% de Ejecución',
                    icon: 'percent',
                    query: 'custom_budget_percentage',
                    format: 'percentage',
                    allowedRoles: ['Estrategas', 'Gestor de Presupuesto', 'Autorizador de presupuesto']
                },
                {
                    id: 'metric-4',
                    label: 'Solicitudes Pendientes',
                    icon: 'hourglass-split',
                    query: 'custom_pending_requests',
                    format: 'number',
                    allowedRoles: ['Estrategas', 'Gestor de Presupuesto', 'Autorizador de presupuesto']
                }
            ],
            
            badges: [
                {
                    id: 'current-budget-year',
                    label: 'Año Presupuestal',
                    value: null,
                    show: true
                }
            ]
        };
        
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let userRoles = [];
        let currentBudgetYearId = null;
        let userEmail = null;
        let metricsLoaded = false;
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log(`🔐 Validando acceso al módulo ${MODULE_CONFIG.name}...`);
            
            try {
                const hasAnyAccess = await checkAnyModulePermission();
                if (!hasAnyAccess) {
                    console.log('❌ Acceso denegado - sin permisos en el módulo');
                    showAccessDenied('Sin permisos para acceder a este módulo');
                    return;
                }
                
                console.log('✅ Acceso al módulo permitido');
                await inicializarModulo();
                
            } catch (error) {
                console.error('❌ Error validando acceso al módulo:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });
        
        // ==========================================
        // VERIFICAR ACCESO A MÓDULO
        // ==========================================
        async function checkAnyModulePermission() {
            try {
                const session = getStoredSession();
                if (!session || !session.user) {
                    return false;
                }
                
                currentUser = session.user;
                userEmail = session.user.user_mail;
                
                const isSuperAdmin = await checkUserIsSuperAdmin(currentUser.user_id);
                if (isSuperAdmin) {
                    console.log('✅ Acceso permitido - es Super Admin');
                    return true;
                }
                
                const modulePermissions = MODULE_CONFIG.modulePermissions || [];
                
                if (modulePermissions.length === 0) {
                    console.warn('⚠️ No hay permisos configurados para este módulo');
                    return true;
                }
                
                for (const permission of modulePermissions) {
                    const hasPermission = await checkUserPermission(currentUser.user_id, permission);
                    if (hasPermission) {
                        console.log(`✅ Acceso permitido con permiso: ${permission}`);
                        return true;
                    }
                }
                
                console.log('❌ Sin permisos para este módulo');
                return false;
                
            } catch (error) {
                console.error('❌ Error verificando permisos de módulo:', error);
                return false;
            }
        }

        async function checkUserIsSuperAdmin(userId) {
            try {
                const userData = await supabaseRequest(`/user_roles?select=roles(is_super_admin)&user_id=eq.${userId}`);
                return userData.some(ur => ur.roles?.is_super_admin === true);
            } catch (error) {
                console.error('❌ Error verificando super admin:', error);
                return false;
            }
        }
        
        function showAccessDenied(message) {
            document.body.innerHTML = `
                <div class="container mt-5">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card border-danger">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-shield-exclamation me-2"></i>
                                        Acceso Denegado
                                    </h5>
                                </div>
                                <div class="card-body text-center">
                                    <i class="bi bi-lock-fill text-danger" style="font-size: 3rem;"></i>
                                    <h6 class="mt-3">${message}</h6>
                                    <p class="text-muted">Contacta al administrador del sistema si necesitas acceso.</p>
                                    <div class="mt-4">
                                        <a href="../../dashboard.html" class="btn btn-primary me-2">
                                            <i class="bi bi-house me-1"></i>Ir al Dashboard
                                        </a>
                                        <button onclick="history.back()" class="btn btn-outline-secondary">
                                            <i class="bi bi-arrow-left me-1"></i>Volver
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // INICIALIZACIÓN DEL MÓDULO
        // ==========================================
        // ==========================================
        // INICIALIZACIÓN DEL MÓDULO
        // ==========================================
        async function inicializarModulo() {
            try {
                mostrarLoading();
                
                configurarColoresModulo();
                await cargarDatosUsuario();
                await cargarBadges();
                // ⚠️ CAMBIO CRÍTICO: NO cargar métricas automáticamente
                // await cargarMetricas(); // ELIMINADO
                await configurarFunciones();
                
                ocultarLoading();
                console.log(`✅ Módulo ${MODULE_CONFIG.name} inicializado correctamente`);
                console.log(`ℹ️ Métricas disponibles para carga manual`);
                
            } catch (error) {
                console.error('❌ Error inicializando módulo:', error);
                showMessage('Error al cargar el módulo: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        

        
        function configurarColoresModulo() {
            const root = document.documentElement;
            root.style.setProperty('--module-primary', MODULE_CONFIG.color.primary);
            root.style.setProperty('--module-secondary', MODULE_CONFIG.color.secondary);
            root.style.setProperty('--module-light', MODULE_CONFIG.color.light);
            
            console.log(`🎨 Colores del módulo ${MODULE_CONFIG.name} aplicados`);
        }
        
        async function cargarDatosUsuario() {
            try {
                if (currentUser) {
                    userRoles = await obtenerRolesUsuario(currentUser.user_id);
                    
                    console.log('✅ Datos de usuario cargados');
                    console.log('🔑 Roles del usuario:', userRoles);
                    console.log('📧 Email del usuario:', userEmail);
                }
            } catch (error) {
                console.error('❌ Error cargando datos de usuario:', error);
            }
        }
        
        async function obtenerRolesUsuario(userId) {
            try {
                const data = await supabaseRequest(`/user_roles?select=roles(role_name)&user_id=eq.${userId}`);
                return data.map(ur => ur.roles.role_name);
            } catch (error) {
                console.error('❌ Error obteniendo roles:', error);
                return [];
            }
        }
        
        // ==========================================
        // CARGA DE BADGES
        // ==========================================
        async function cargarBadges() {
            try {
                const badgesContainer = document.getElementById('module-badges');
                let badgesHtml = '';
                
                // Obtener año presupuestal activo
                const configData = await supabaseRequest('/system_config?select=current_budget_year_id&limit=1');
                
                if (configData.length > 0 && configData[0].current_budget_year_id) {
                    currentBudgetYearId = configData[0].current_budget_year_id;
                    
                    const yearData = await supabaseRequest(`/academic_years?select=year_name&year_id=eq.${currentBudgetYearId}`);
                    
                    if (yearData.length > 0) {
                        badgesHtml = `
                            <span class="badge-module">
                                Año Presupuestal: ${yearData[0].year_name}
                            </span>
                        `;
                    }
                }
                
                badgesContainer.innerHTML = badgesHtml;
                console.log('✅ Badges contextuales cargados');
                
            } catch (error) {
                console.error('❌ Error cargando badges:', error);
            }
        }
        
        // ==========================================
        // CARGA DE MÉTRICAS
        // ==========================================
        // ==========================================
        // 🆕 CARGA DIFERIDA DE MÉTRICAS - FUNCIÓN MANUAL
        // ==========================================
        async function cargarMetricas() {
            // Evitar múltiples cargas
            if (metricsLoaded) {
                showMessage('Las métricas ya están cargadas', 'info');
                return;
            }
            
            const btnLoadMetrics = document.getElementById('btn-load-metrics');
            
            try {
                // Cambiar estado del botón
                btnLoadMetrics.disabled = true;
                btnLoadMetrics.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Cargando...';
                
                console.log('📊 Cargando métricas según roles del usuario...');
                
                for (const metric of MODULE_CONFIG.metrics) {
                    try {
                        const tieneAccesoMetrica = verificarAccesoMetrica(metric, userRoles);
                        
                        if (!tieneAccesoMetrica) {
                            console.log(`⏭️ Métrica ${metric.id} omitida - sin roles requeridos`);
                            ocultarTarjetaMetrica(metric.id);
                            continue;
                        }
                        
                        let value = 0;
                        
                        if (metric.query.startsWith('custom_')) {
                            value = await ejecutarQueryPersonalizada(metric.query);
                        } else {
                            const data = await supabaseRequest(metric.query);
                            value = Array.isArray(data) ? data.length : (data || 0);
                        }
                        
                        const formattedValue = formatearValorMetrica(value, metric.format);
                        const elemento = document.getElementById(metric.id + '-value');
                        if (elemento) {
                            elemento.innerHTML = formattedValue;
                        }
                        
                    } catch (error) {
                        console.error(`❌ Error cargando métrica ${metric.id}:`, error);
                        const elemento = document.getElementById(metric.id + '-value');
                        if (elemento) {
                            elemento.innerHTML = '<span class="text-danger">Error</span>';
                        }
                    }
                }
                
                reorganizarGridMetricas();
                
                metricsLoaded = true;
                
                // Actualizar botón a modo "Actualizar"
                btnLoadMetrics.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Actualizar Métricas';
                btnLoadMetrics.disabled = false;
                
                console.log('✅ Métricas cargadas exitosamente');
                showMessage('Métricas cargadas correctamente', 'success');
                
            } catch (error) {
                console.error('❌ Error general cargando métricas:', error);
                btnLoadMetrics.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Error al cargar';
                btnLoadMetrics.disabled = false;
                showMessage('Error al cargar métricas: ' + error.message, 'danger');
            }
        }
                
        // ==========================================
        // QUERIES PERSONALIZADAS CON LÓGICA POR ROL
        // ==========================================
        async function ejecutarQueryPersonalizada(queryType) {
            try {
                // Verificar si es rol con vista completa
                const esVistaCompleta = userRoles.some(role => 
                    role === 'Estrategas' || 
                    role === 'Gestor de Presupuesto'
                );
                
                // Verificar si es autorizador
                const esAutorizador = userRoles.includes('Autorizador de presupuesto');
                
                if (!currentBudgetYearId) {
                    console.warn('⚠️ No hay año presupuestal activo configurado');
                    return 0;
                }
                
                let filterByUser = '';
                if (esAutorizador && !esVistaCompleta) {
                    filterByUser = `&worker_email=eq.${userEmail}`;
                }
                
                switch (queryType) {
                    case 'custom_budget_total':
                        const totalData = await supabaseRequest(`/budget_assignments?select=approved_value&academic_year_id=eq.${currentBudgetYearId}&assignment_status=eq.active${filterByUser}`);
                        return totalData.reduce((sum, item) => sum + (item.approved_value || 0), 0);
                        
                    case 'custom_budget_executed':
                        const executedData = await supabaseRequest(`/budget_assignments?select=executed_value&academic_year_id=eq.${currentBudgetYearId}&assignment_status=eq.active${filterByUser}`);
                        return executedData.reduce((sum, item) => sum + (item.executed_value || 0), 0);
                        
                    case 'custom_budget_percentage':
                        const totalBudget = await ejecutarQueryPersonalizada('custom_budget_total');
                        const executedBudget = await ejecutarQueryPersonalizada('custom_budget_executed');
                        
                        if (totalBudget === 0) return 0;
                        return Math.round((executedBudget / totalBudget) * 100);
                        
                    case 'custom_pending_requests':
                        const pendingData = await supabaseRequest(`/execution_requests?select=request_id,assignment_id&request_status=eq.pending${filterByUser ? '' : ''}`);
                        
                        if (esAutorizador && !esVistaCompleta) {
                            // Filtrar por assignments del usuario
                            const userAssignments = await supabaseRequest(`/budget_assignments?select=assignment_id&worker_email=eq.${userEmail}&academic_year_id=eq.${currentBudgetYearId}`);
                            const assignmentIds = userAssignments.map(a => a.assignment_id);
                            return pendingData.filter(r => assignmentIds.includes(r.assignment_id)).length;
                        }
                        
                        return pendingData.length;
                        
                    default:
                        console.warn('Query personalizada no reconocida:', queryType);
                        return 0;
                }
            } catch (error) {
                console.error('Error en query personalizada:', error);
                return 0;
            }
        }
        // ==========================================
        // VERIFICAR ACCESO A MÉTRICA
        // ==========================================
        function verificarAccesoMetrica(metric, userRoles) {
            if (!metric.allowedRoles || metric.allowedRoles.length === 0) {
                return true;
            }
            
            const isSuperAdmin = userRoles.some(role => 
                role.toLowerCase().includes('super')
            );
            
            if (isSuperAdmin) {
                console.log('✅ Super Admin - Acceso total a métricas');
                return true;
            }
            
            const hasAllowedRole = metric.allowedRoles.some(roleRequired => 
                userRoles.includes(roleRequired)
            );
            
            if (hasAllowedRole) {
                console.log(`✅ Acceso a métrica por rol específico`);
            }
            
            return hasAllowedRole;
        }
        
        // ==========================================
        // CONFIGURACIÓN DE FUNCIONES
        // ==========================================
        async function configurarFunciones() {
            try {
                console.log('🔒 Configurando funciones según permisos...');
                
                const functionCards = document.querySelectorAll('.function-card[data-permission]');
                
                for (const card of functionCards) {
                    const permission = card.getAttribute('data-permission');
                    
                    if (permission) {
                        const hasPermission = await checkUserPermission(currentUser.user_id, permission);
                        
                        if (!hasPermission) {
                            card.closest('.col-12, .col-md-6, .col-lg-4').style.display = 'none';
                        }
                    }
                }
                
                console.log('✅ Funciones configuradas según permisos');
                
            } catch (error) {
                console.error('❌ Error configurando funciones:', error);
            }
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        function ocultarTarjetaMetrica(metricId) {
            const elemento = document.getElementById(metricId + '-value');
            if (elemento) {
                const tarjeta = elemento.closest('.col-6, .col-lg-3');
                if (tarjeta) {
                    tarjeta.style.display = 'none';
                }
            }
        }
        
        function reorganizarGridMetricas() {
            const container = document.getElementById('metrics-container');
            const tarjetasVisibles = container.querySelectorAll('.col-6:not([style*="display: none"]), .col-lg-3:not([style*="display: none"])');
            
            if (tarjetasVisibles.length === 0) {
                document.getElementById('metrics-section').style.display = 'none';
            }
        }
        
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function formatearValorMetrica(value, format) {
            switch (format) {
                case 'percentage':
                    return value + '%';
                case 'currency':
                    return new Intl.NumberFormat('es-CO', {
                        style: 'currency',
                        currency: 'COP',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(value);
                case 'number':
                default:
                    return new Intl.NumberFormat('es-CO').format(value);
            }
        }
        
        console.log(`🎉 Módulo de Presupuesto cargado correctamente`);
        window.cargarMetricas = cargarMetricas;
    </script>
</body>
</html>

        
