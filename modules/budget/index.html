<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo Presupuesto - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        .module-header {
            background: linear-gradient(135deg, #2c5530 0%, #3d7c47 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .stats-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .section-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .function-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .function-card {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            transition: all 0.2s ease;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }
        
        .function-card:hover {
            border-color: #2c5530;
            box-shadow: 0 2px 8px rgba(44, 85, 48, 0.2);
            color: inherit;
            text-decoration: none;
        }
        
        .admin-badge {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
        }
        
        .user-badge {
            background: linear-gradient(45deg, #0d6efd, #6f42c1);
        }
        
        .coming-soon {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .coming-soon:hover {
            border-color: #e9ecef !important;
            box-shadow: none !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard.html">
                <i class="bi bi-house-door"></i> SchoolNet
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/modules/budget/index.html">Presupuesto</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> <span id="userName">Usuario</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/profile.html">Perfil</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">Cerrar Sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Module Header -->
    <div class="module-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="bi bi-calculator"></i> Módulo de Presupuesto
                    </h1>
                    <p class="mb-0 fs-5">Gestión integral del presupuesto institucional</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex justify-content-end align-items-center">
                        <span class="badge bg-light text-dark fs-6 me-2">
                            <i class="bi bi-calendar3"></i> Año <span id="currentYear">2025</span>
                        </span>
                        <span class="badge bg-success fs-6">
                            <i class="bi bi-check-circle"></i> Activo
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Dashboard Statistics -->
        <div class="row mb-4" id="dashboardStats">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <div class="text-primary mb-2">
                            <i class="bi bi-piggy-bank fs-1"></i>
                        </div>
                        <h4 class="mb-1" id="totalBudget">$0</h4>
                        <p class="text-muted mb-0">Presupuesto Total</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <div class="text-success mb-2">
                            <i class="bi bi-graph-up fs-1"></i>
                        </div>
                        <h4 class="mb-1" id="executedBudget">$0</h4>
                        <p class="text-muted mb-0">Ejecutado</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <div class="text-warning mb-2">
                            <i class="bi bi-hourglass-split fs-1"></i>
                        </div>
                        <h4 class="mb-1" id="pendingRequests">0</h4>
                        <p class="text-muted mb-0">Solicitudes Pendientes</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <div class="text-info mb-2">
                            <i class="bi bi-percent fs-1"></i>
                        </div>
                        <h4 class="mb-1" id="executionPercent">0%</h4>
                        <p class="text-muted mb-0">% Ejecución</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Administration Section -->
        <div class="card section-card" id="adminSection" style="display: none;">
            <div class="card-header bg-gradient text-white admin-badge">
                <h5 class="mb-0">
                    <i class="bi bi-gear"></i> Administración del Presupuesto
                    <span class="badge bg-white text-dark ms-2">13 Funciones</span>
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Configuración y administración central del sistema presupuestal</p>
                
                <div class="function-grid">
                    <!-- Configuraciones Básicas -->
                    <a href="chart-of-accounts.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-diagram-3 fs-4 text-primary me-3"></i>
                            <div>
                                <h6 class="mb-1">Gestionar PUC</h6>
                                <small class="text-muted">Plan Único de Cuentas</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="budget-categories.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-folder fs-4 text-success me-3"></i>
                            <div>
                                <h6 class="mb-1">Gestionar Rubros</h6>
                                <small class="text-muted">Categorías presupuestales</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="budget-items.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-list-ul fs-4 text-info me-3"></i>
                            <div>
                                <h6 class="mb-1">Gestionar Subítems</h6>
                                <small class="text-muted">Detalles de rubros</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="suppliers.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-building fs-4 text-warning me-3"></i>
                            <div>
                                <h6 class="mb-1">Gestionar Proveedores</h6>
                                <small class="text-muted">Base de datos de proveedores</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="tax-types.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-receipt fs-4 text-danger me-3"></i>
                            <div>
                                <h6 class="mb-1">Gestionar IVA</h6>
                                <small class="text-muted">Tipos de impuestos</small>
                            </div>
                        </div>
                    </a>
                    
                    <!-- Inicialización -->
                    <a href="initialize-budget-year.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-calendar-plus fs-4 text-primary me-3"></i>
                            <div>
                                <h6 class="mb-1">Inicializar Año</h6>
                                <small class="text-muted">Configurar nuevo período</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="initialize-budget-general.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-sliders fs-4 text-success me-3"></i>
                            <div>
                                <h6 class="mb-1">Inicializar año presupuestal - Generales</h6>
                                <small class="text-muted">Parámetros del sistema</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="upload-combo.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-upload fs-4 text-info me-3"></i>
                            <div>
                                <h6 class="mb-1">Subir Combo</h6>
                                <small class="text-muted">Importar datos masivos</small>
                            </div>
                        </div>
                    </a>
                    
                    <!-- Administración Avanzada -->
                    <a href="budget-authorization.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-shield-check fs-4 text-warning me-3"></i>
                            <div>
                                <h6 class="mb-1">Autorización</h6>
                                <small class="text-muted">Aprobar presupuestos</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="associate-invoices.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-link-45deg fs-4 text-danger me-3"></i>
                            <div>
                                <h6 class="mb-1">Asociar Facturas</h6>
                                <small class="text-muted">Vincular documentos</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="accounting-crosscheck.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-arrow-left-right fs-4 text-primary me-3"></i>
                            <div>
                                <h6 class="mb-1">Cruce Contable</h6>
                                <small class="text-muted">Conciliación de cuentas</small>
                            </div>
                        </div>
                    </a>
                    
                    <!-- Reportes Administrativos -->
                    <a href="report-design.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-file-earmark-bar-graph fs-4 text-success me-3"></i>
                            <div>
                                <h6 class="mb-1">Diseño de Informes</h6>
                                <small class="text-muted">Configurar reportes</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="assignments-report.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-clipboard-data fs-4 text-info me-3"></i>
                            <div>
                                <h6 class="mb-1">Informe Asignaciones</h6>
                                <small class="text-muted">Reporte de distribución</small>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div class="card section-card" id="usersSection" style="display: none;">
            <div class="card-header bg-gradient text-white user-badge">
                <h5 class="mb-0">
                    <i class="bi bi-people"></i> Operaciones de Usuario
                    <span class="badge bg-white text-dark ms-2">11 Funciones</span>
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Gestión operativa del presupuesto para usuarios finales</p>
                
                <div class="function-grid">
                    <!-- Solicitudes -->
                    <a href="budget-request.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-plus-circle fs-4 text-primary me-3"></i>
                            <div>
                                <h6 class="mb-1">Petición de Presupuesto</h6>
                                <small class="text-muted">Solicitar asignación</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="execution-request.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-play-circle fs-4 text-success me-3"></i>
                            <div>
                                <h6 class="mb-1">Solicitud de Ejecución</h6>
                                <small class="text-muted">Ejecutar presupuesto</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="closure-request.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-stop-circle fs-4 text-warning me-3"></i>
                            <div>
                                <h6 class="mb-1">Solicitud de Cierre</h6>
                                <small class="text-muted">Cerrar partidas</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="budget-transfer.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-arrow-repeat fs-4 text-info me-3"></i>
                            <div>
                                <h6 class="mb-1">Traslado Presupuestal</h6>
                                <small class="text-muted">Mover entre rubros</small>
                            </div>
                        </div>
                    </a>
                    
                    <!-- Gestión -->
                    <a href="assign-requesters.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-person-plus fs-4 text-danger me-3"></i>
                            <div>
                                <h6 class="mb-1">Designar Solicitantes</h6>
                                <small class="text-muted">Asignar responsables</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="request-resolution.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-check2-square fs-4 text-primary me-3"></i>
                            <div>
                                <h6 class="mb-1">Resolver Solicitudes</h6>
                                <small class="text-muted">Aprobar/rechazar</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="close-overruns.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-exclamation-triangle fs-4 text-warning me-3"></i>
                            <div>
                                <h6 class="mb-1">Cerrar Sobreejecuciones</h6>
                                <small class="text-muted">Gestionar excesos</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="close-transfer.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-x-circle fs-4 text-success me-3"></i>
                            <div>
                                <h6 class="mb-1">Cerrar Traslados</h6>
                                <small class="text-muted">Finalizar movimientos</small>
                            </div>
                        </div>
                    </a>
                    
                    <!-- Consultas y Reportes -->
                    <a href="budget-overview.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-eye fs-4 text-info me-3"></i>
                            <div>
                                <h6 class="mb-1">Vista del Presupuesto</h6>
                                <small class="text-muted">Resumen general</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="category-detail.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-zoom-in fs-4 text-danger me-3"></i>
                            <div>
                                <h6 class="mb-1">Detalle por Rubro</h6>
                                <small class="text-muted">Vista específica</small>
                            </div>
                        </div>
                    </a>
                    
                    <a href="budget-queries.html" class="function-card">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-search fs-4 text-primary me-3"></i>
                            <div>
                                <h6 class="mb-1">Consultas</h6>
                                <small class="text-muted">Búsquedas avanzadas</small>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- No Access Message -->
        <div class="card" id="noAccessCard" style="display: none;">
            <div class="card-body text-center py-5">
                <i class="bi bi-lock fs-1 text-muted mb-3"></i>
                <h5 class="text-muted">Sin Acceso al Módulo</h5>
                <p class="text-muted">No tienes permisos para acceder a las funciones del módulo de presupuesto.</p>
                <a href="/dashboard.html" class="btn btn-primary">
                    <i class="bi bi-house"></i> Volver al Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Config JS -->
    <script src="../../assets/js/config.js"></script>
    
    <script>
        let currentUser = null;
        let userPermissions = [];

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🏗️ Inicializando módulo de presupuesto...');
            
            try {
                // Verificar sesión activa
                const session = getStoredSession();
                if (!session || !session.user) {
                    window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                currentUser = session.user;
                document.getElementById('userName').textContent = currentUser.user_display_name || currentUser.user_name;
                
                // Cargar permisos del usuario
                await loadUserPermissions();
                
                // Configurar interfaz según permisos
                setupUserInterface();
                
                // Cargar estadísticas del dashboard
                await loadDashboardStats();
                
                console.log('✅ Módulo de presupuesto inicializado correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando módulo:', error);
                showMessage('Error al cargar el módulo de presupuesto', 'danger');
            }
        });

        async function loadUserPermissions() {
            try {
                console.log('🔍 Cargando permisos del usuario...');
                
                // Verificar si es super admin
                const superAdminQuery = `/users?select=user_roles!user_roles_user_id_fkey(role_id,roles(is_super_admin))&user_id=eq.${currentUser.user_id}`;
                const userData = await supabaseRequest(superAdminQuery);
                
                if (userData && userData.length > 0) {
                    const isSuperAdmin = userData[0].user_roles?.some(userRole => 
                        userRole.roles?.is_super_admin === true
                    );
                    
                    if (isSuperAdmin) {
                        console.log('✅ Usuario es super admin - acceso completo');
                        userPermissions = ['*']; // Acceso total
                        return;
                    }
                }
                
                // Cargar permisos específicos
                const permissionQuery = `/users?select=user_roles!user_roles_user_id_fkey(role_id,roles(role_permissions(permissions(permission_name))))&user_id=eq.${currentUser.user_id}`;
                const permissionData = await supabaseRequest(permissionQuery);
                
                if (permissionData && permissionData.length > 0) {
                    permissionData[0].user_roles?.forEach(userRole => {
                        userRole.roles?.role_permissions?.forEach(rolePermission => {
                            const permName = rolePermission.permissions?.permission_name;
                            if (permName && !userPermissions.includes(permName)) {
                                userPermissions.push(permName);
                            }
                        });
                    });
                }
                
                console.log('📋 Permisos cargados:', userPermissions.length);
                
            } catch (error) {
                console.error('❌ Error cargando permisos:', error);
                userPermissions = [];
            }
        }

        function hasPermission(permission) {
            return userPermissions.includes('*') || userPermissions.includes(permission);
        }

        function hasBudgetPermissions() {
            // Super admin tiene acceso automático a todo
            if (userPermissions.includes('*')) {
                console.log('✅ Super admin detectado - acceso total al presupuesto');
                return true;
            }
            
            // Verificar si tiene algún permiso relacionado con presupuesto
            const budgetPermissions = [
                'Gestionar PUC', 'Subir el combo', 'Gestionar IVA asociado', 'Gestionar rubros',
                'Gestionar subítems', 'Gestionar proveedores', 'Inicializar año presupuestal',
                'Inicializar año presupuestal - Generales', 'Autorización de presupuesto',
                'Asociar facturas', 'Diseño de informes', 'Informe de asignaciones',
                'Cruce contable', 'Petición de presupuesto', 'Designar solicitantes',
                'Solicitud de ejecución', 'Solicitud de cierre', 'Resolución de solicitudes',
                'Cerrar requerimientos sobreejecutados', 'Iniciar traslado presupuestal',
                'Cerrar traslado presupuestal', 'Vista detallada por rubro',
                'Vista particular del presupuesto', 'Consultas de presupuesto'
            ];
            
            const hasSpecificPermission = budgetPermissions.some(perm => userPermissions.includes(perm));
            console.log(`🔍 Permisos específicos de presupuesto: ${hasSpecificPermission}`);
            
            return hasSpecificPermission;
        }

        function setupUserInterface() {
            console.log('🎨 Configurando interfaz según permisos...');
            
            if (!hasBudgetPermissions()) {
                console.log('❌ Usuario sin permisos de presupuesto');
                document.getElementById('noAccessCard').style.display = 'block';
                document.getElementById('dashboardStats').style.display = 'none';
                return;
            }
            
            console.log('✅ Usuario con acceso al módulo de presupuesto');
            
            // Verificar permisos de administración (Super admin o permisos específicos)
            const hasAdminPerms = userPermissions.includes('*') || 
                                 hasPermission('Gestionar PUC') || 
                                 hasPermission('Gestionar rubros') || 
                                 hasPermission('Inicializar año presupuestal');
            
            if (hasAdminPerms) {
                document.getElementById('adminSection').style.display = 'block';
                console.log('✅ Mostrando sección de administración');
            }
            
            // Verificar permisos de usuario (Super admin o permisos específicos)
            const hasUserPerms = userPermissions.includes('*') || 
                                hasPermission('Petición de presupuesto') || 
                                hasPermission('Solicitud de ejecución') || 
                                hasPermission('Consultas de presupuesto');
            
            if (hasUserPerms) {
                document.getElementById('usersSection').style.display = 'block';
                console.log('✅ Mostrando sección de usuarios');
            }
            
            console.log(`📊 Resumen - Admin: ${hasAdminPerms}, Usuario: ${hasUserPerms}, Super Admin: ${userPermissions.includes('*')}`);
        }

        async function loadDashboardStats() {
            try {
                console.log('📊 Cargando estadísticas del dashboard...');
                
                // Por ahora mostrar datos demo, después conectar con la BD
                document.getElementById('totalBudget').textContent = '$2,500,000,000';
                document.getElementById('executedBudget').textContent = '$1,750,000,000';
                document.getElementById('pendingRequests').textContent = '12';
                document.getElementById('executionPercent').textContent = '70%';
                
                // TODO: Implementar consultas reales a las tablas de presupuesto
                // const budgetData = await supabaseRequest('/budget_assignments?select=*');
                
            } catch (error) {
                console.error('❌ Error cargando estadísticas:', error);
            }
        }

        function getStoredSession() {
            try {
                const sessionData = localStorage.getItem('nextSystemSession') || sessionStorage.getItem('nextSystemSession');
                return sessionData ? JSON.parse(sessionData) : null;
            } catch (error) {
                return null;
            }
        }

        function logout() {
            localStorage.removeItem('nextSystemSession');
            sessionStorage.removeItem('nextSystemSession');
            window.location.href = '/login.html';
        }

        // Inicializar página con config.js
        if (window.SUPABASE_CONFIG) {
            initializePage('budget', 'Presupuesto');
        } else {
            setTimeout(() => initializePage('budget', 'Presupuesto'), 100);
        }
    </script>
</body>
</html>
