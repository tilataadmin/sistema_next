<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA -->
    <meta name="page-version" content="25.11.27.13.49">
    
    <title>Dise√±o de Reportes - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos espec√≠ficos del dise√±ador de reportes */
        .tree-container {
            background: #f8f9fa;
            border-radius: 8px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .tree-item {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tree-item:hover {
            background: #e9ecef;
        }
        
        .tree-item.selected {
            background: #0d6efd;
            color: white;
        }
        
        .tree-item.selected .text-muted {
            color: rgba(255,255,255,0.7) !important;
        }
        
        .tree-item-level-1 { margin-left: 0; }
        .tree-item-level-2 { margin-left: 24px; }
        .tree-item-level-3 { margin-left: 48px; }
        .tree-item-line { margin-left: 72px; background: #fff; border: 1px solid #dee2e6; }
        
        .tree-item .drag-handle {
            cursor: grab;
            color: #6c757d;
        }
        
        .tree-item .drag-handle:active {
            cursor: grabbing;
        }
        
        .sign-badge {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .sign-positive { background: #d1e7dd; color: #0f5132; }
        .sign-negative { background: #f8d7da; color: #842029; }
        
        .type-badge {
            font-size: 0.7rem;
            padding: 1px 5px;
            border-radius: 3px;
            background: #e2e3e5;
            color: #41464b;
        }
        
        .config-panel {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .config-panel-header {
            background: #f8f9fa;
            padding: 12px 16px;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .report-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .report-card.active {
            border-color: #0d6efd;
            background: #f0f7ff;
        }
        
        .toolbar-btn {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
        
        .section-divider {
            border-top: 2px dashed #dee2e6;
            margin: 8px 0;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Presupuesto</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Dise√±o de Reportes
                </li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-file-earmark-bar-graph me-2"></i>
                    Dise√±o de Reportes Presupuestales
                </h1>
                <p class="text-muted">
                    Cree y configure reportes personalizados como Estados de Resultados (PyG) agrupando rubros e √≠tems presupuestales.
                </p>
            </div>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <!-- Vista de Lista de Reportes -->
        <div id="vista-lista">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-collection me-2"></i>Reportes Configurados
                    </h5>
                    <button class="btn btn-primary" onclick="abrirModalNuevoReporte()">
                        <i class="bi bi-plus-circle me-1"></i>Nuevo Reporte
                    </button>
                </div>
                <div class="card-body">
                    <div id="lista-reportes">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <div class="mt-2">Cargando reportes...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista de Editor de Reporte -->
        <div id="vista-editor" style="display: none;">
            <!-- Header del Editor -->
            <div class="card mb-3">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="volverALista()">
                                <i class="bi bi-arrow-left me-1"></i>Volver
                            </button>
                            <div>
                                <h5 class="mb-0" id="editor-titulo-reporte">Nombre del Reporte</h5>
                                <small class="text-muted" id="editor-descripcion-reporte">Descripci√≥n</small>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-info btn-sm" onclick="previsualizarReporte()">
                                <i class="bi bi-eye me-1"></i>Vista Previa
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="editarInfoReporte()">
                                <i class="bi bi-pencil me-1"></i>Editar Info
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Panel Izquierdo: √Årbol de Estructura -->
                <div class="col-lg-7 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-diagram-3 me-2"></i>Estructura del Reporte
                                </h6>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary toolbar-btn" onclick="agregarSeccion()" title="Agregar Secci√≥n">
                                        <i class="bi bi-folder-plus me-1"></i>Secci√≥n
                                    </button>
                                    <button class="btn btn-sm btn-outline-success toolbar-btn" onclick="agregarLinea()" title="Agregar L√≠nea" id="btn-agregar-linea" disabled>
                                        <i class="bi bi-plus-square me-1"></i>L√≠nea
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="tree-container p-3" id="arbol-estructura">
                                <div class="empty-state">
                                    <i class="bi bi-diagram-3"></i>
                                    <h6>Sin estructura definida</h6>
                                    <p class="mb-3">Comience agregando secciones al reporte</p>
                                    <button class="btn btn-primary btn-sm" onclick="agregarSeccion()">
                                        <i class="bi bi-folder-plus me-1"></i>Agregar Primera Secci√≥n
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel Derecho: Configuraci√≥n del Elemento -->
                <div class="col-lg-5 mb-4">
                    <div class="config-panel h-100">
                        <div class="config-panel-header">
                            <h6 class="mb-0">
                                <i class="bi bi-gear me-2"></i>
                                <span id="config-titulo">Configuraci√≥n</span>
                            </h6>
                        </div>
                        <div class="card-body" id="panel-configuracion">
                            <div class="empty-state py-5">
                                <i class="bi bi-hand-index"></i>
                                <p class="mb-0">Seleccione un elemento del √°rbol para configurarlo</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal: Nuevo/Editar Reporte -->
    <div class="modal fade" id="modal-reporte" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-reporte-titulo">
                        <i class="bi bi-plus-circle me-2"></i>Nuevo Reporte
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-reporte">
                    <div class="modal-body">
                        <input type="hidden" id="reporte-id">
                        
                        <div class="mb-3">
                            <label for="reporte-nombre" class="form-label">
                                Nombre del Reporte <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="reporte-nombre" 
                                   placeholder="Ej: Estado de Resultados Presupuestal" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="reporte-descripcion" class="form-label">Descripci√≥n</label>
                            <textarea class="form-control" id="reporte-descripcion" rows="3"
                                      placeholder="Descripci√≥n opcional del reporte..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Nueva/Editar Secci√≥n -->
    <div class="modal fade" id="modal-seccion" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-seccion-titulo">
                        <i class="bi bi-folder-plus me-2"></i>Nueva Secci√≥n
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-seccion">
                    <div class="modal-body">
                        <input type="hidden" id="seccion-id">
                        <input type="hidden" id="seccion-parent-id">
                        
                        <div class="mb-3">
                            <label for="seccion-nombre" class="form-label">
                                Nombre de la Secci√≥n <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="seccion-nombre" 
                                   placeholder="Ej: INGRESOS OPERACIONALES" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="seccion-tipo" class="form-label">Tipo</label>
                                <select class="form-select" id="seccion-tipo">
                                    <option value="group">Grupo (agrupador)</option>
                                    <option value="subtotal">Subtotal</option>
                                    <option value="total">Total General</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="seccion-signo" class="form-label">Comportamiento</label>
                                <select class="form-select" id="seccion-signo">
                                    <option value="positive">‚ûï Suma al total</option>
                                    <option value="negative">‚ûñ Resta al total</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="seccion-mostrar-subtotal" checked>
                                <label class="form-check-label" for="seccion-mostrar-subtotal">
                                    Mostrar subtotal de esta secci√≥n
                                </label>
                            </div>
                        </div>
                        
                        <div class="alert alert-info small mb-0" id="seccion-nivel-info">
                            <i class="bi bi-info-circle me-1"></i>
                            Esta ser√° una secci√≥n de <strong>Nivel 1</strong> (ra√≠z)
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Nueva/Editar L√≠nea -->
    <div class="modal fade" id="modal-linea" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-linea-titulo">
                        <i class="bi bi-plus-square me-2"></i>Nueva L√≠nea
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-linea">
                    <div class="modal-body">
                        <input type="hidden" id="linea-id">
                        <input type="hidden" id="linea-section-id">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="linea-tipo" class="form-label">Tipo de L√≠nea</label>
                                <select class="form-select" id="linea-tipo" onchange="cambiarTipoLinea()">
                                    <option value="item">√çtem espec√≠fico</option>
                                    <option value="category">Categor√≠a completa</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="linea-signo" class="form-label">Signo</label>
                                <select class="form-select" id="linea-signo">
                                    <option value="as_defined">Seg√∫n definici√≥n (normal)</option>
                                    <option value="invert">Invertir signo</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Selector de Categor√≠a -->
                        <div class="mb-3" id="container-categoria">
                            <label for="linea-categoria" class="form-label">
                                Categor√≠a <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="linea-categoria">
                                <option value="">Seleccione una categor√≠a...</option>
                            </select>
                        </div>
                        
                        <!-- Selector de √çtem -->
                        <div class="mb-3" id="container-item">
                            <label for="linea-item" class="form-label">
                                √çtem <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="linea-item">
                                <option value="">Seleccione un √≠tem...</option>
                            </select>
                            <div class="form-text" id="item-info"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="linea-etiqueta" class="form-label">
                                Etiqueta personalizada <small class="text-muted">(opcional)</small>
                            </label>
                            <input type="text" class="form-control" id="linea-etiqueta" 
                                   placeholder="Dejar vac√≠o para usar el nombre original">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Agregar L√≠nea
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Confirmaci√≥n de Eliminaci√≥n -->
    <div class="modal fade" id="modal-confirmar-eliminar" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirmar
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p id="mensaje-confirmar-eliminar">¬øEst√° seguro de eliminar este elemento?</p>
                    <input type="hidden" id="eliminar-tipo">
                    <input type="hidden" id="eliminar-id">
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarEliminacion()">
                        <i class="bi bi-trash me-1"></i>Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Vista Previa -->
    <div class="modal fade" id="modal-preview" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-eye me-2"></i>Vista Previa del Reporte
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">A√±o Acad√©mico</label>
                            <select class="form-select" id="preview-ano" onchange="actualizarPreview()">
                                <option value="">Cargando a√±os...</option>
                            </select>
                        </div>
                    </div>
                    <div id="preview-contenido">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Generando vista previa...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" onclick="exportarPDF()">
                        <i class="bi bi-file-pdf me-1"></i>Exportar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let reportesCache = [];
        let categoriasCache = [];
        let itemsCache = [];
        let estructuraCache = { secciones: [], lineas: [] };
        let reporteActual = null;
        let elementoSeleccionado = null;
        
        // Modales
        let modalReporte, modalSeccion, modalLinea, modalConfirmar, modalPreview;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // Validar permisos
                const hasAccess = await validatePageAccess('Dise√±o de informes');
                if (!hasAccess) return;
                
                console.log('‚úÖ Acceso permitido');
                
                // Verificar sesi√≥n
                const session = getStoredSession();
                if (!session) {
                    showMessage('Sesi√≥n no v√°lida. Redirigiendo...', 'warning');
                    setTimeout(() => window.location.href = '../../login.html', 1500);
                    return;
                }
                
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                showMessage('Error de validaci√≥n: ' + error.message, 'danger');
            }
        });
        
        async function inicializarPagina() {
            try {
                console.log('üöÄ Inicializando p√°gina...');
                mostrarLoading();
                
                // Inicializar modales
                modalReporte = new bootstrap.Modal(document.getElementById('modal-reporte'));
                modalSeccion = new bootstrap.Modal(document.getElementById('modal-seccion'));
                modalLinea = new bootstrap.Modal(document.getElementById('modal-linea'));
                modalConfirmar = new bootstrap.Modal(document.getElementById('modal-confirmar-eliminar'));
                modalPreview = new bootstrap.Modal(document.getElementById('modal-preview'));
                
                // Configurar eventos de formularios
                document.getElementById('form-reporte').addEventListener('submit', guardarReporte);
                document.getElementById('form-seccion').addEventListener('submit', guardarSeccion);
                document.getElementById('form-linea').addEventListener('submit', guardarLinea);
                
                // Cargar datos iniciales
                await Promise.all([
                    cargarReportes(),
                    cargarCategorias(),
                    cargarItems()
                ]);
                
                ocultarLoading();
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        async function cargarReportes() {
            try {
                const data = await supabaseRequest('/budget_reports?select=*&order=report_name.asc');
                reportesCache = data || [];
                renderizarListaReportes();
            } catch (error) {
                console.error('‚ùå Error cargando reportes:', error);
                showMessage('Error al cargar reportes', 'danger');
            }
        }
        
        async function cargarCategorias() {
            try {
                const data = await supabaseRequest('/budget_categories?select=*&category_status=eq.active&order=category_name.asc');
                categoriasCache = data || [];
                llenarSelectCategorias();
            } catch (error) {
                console.error('‚ùå Error cargando categor√≠as:', error);
            }
        }
        
        async function cargarItems() {
            try {
                const data = await supabaseRequest('/budget_items?select=*,budget_categories(category_name)&item_status=eq.active&order=item_name.asc');
                itemsCache = data || [];
                llenarSelectItems();
            } catch (error) {
                console.error('‚ùå Error cargando √≠tems:', error);
            }
        }
        
        async function cargarEstructuraReporte(reportId) {
            try {
                mostrarLoading();
                
                // Cargar secciones
                const secciones = await supabaseRequest(
                    `/budget_report_sections?select=*&report_id=eq.${reportId}&order=section_order.asc`
                );
                
                // Cargar l√≠neas con info de categor√≠a/√≠tem
                const lineas = await supabaseRequest(
                    `/budget_report_lines?select=*,budget_categories(category_name),budget_items(item_name,debit_or_credit)&section_id=in.(${secciones.map(s => s.section_id).join(',') || 'null'})&order=line_order.asc`
                );
                
                estructuraCache = {
                    secciones: secciones || [],
                    lineas: lineas || []
                };
                
                renderizarArbol();
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error cargando estructura:', error);
                showMessage('Error al cargar estructura del reporte', 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // RENDERIZADO
        // ==========================================
        function renderizarListaReportes() {
            const container = document.getElementById('lista-reportes');
            
            if (reportesCache.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-file-earmark-bar-graph"></i>
                        <h6>No hay reportes configurados</h6>
                        <p class="mb-3">Cree su primer reporte presupuestal</p>
                        <button class="btn btn-primary" onclick="abrirModalNuevoReporte()">
                            <i class="bi bi-plus-circle me-1"></i>Crear Primer Reporte
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="row">
                    ${reportesCache.map(reporte => `
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card report-card h-100" onclick="abrirEditor('${reporte.report_id}')">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="card-title mb-1">
                                                <i class="bi bi-file-earmark-bar-graph me-2 text-primary"></i>
                                                ${reporte.report_name}
                                            </h6>
                                            <p class="card-text text-muted small mb-2">
                                                ${reporte.report_description || 'Sin descripci√≥n'}
                                            </p>
                                        </div>
                                        <span class="badge ${reporte.report_status === 'active' ? 'bg-success' : 'bg-secondary'}">
                                            ${reporte.report_status === 'active' ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <div class="btn-group btn-group-sm w-100">
                                        <button class="btn btn-outline-primary" onclick="event.stopPropagation(); abrirEditor('${reporte.report_id}')">
                                            <i class="bi bi-pencil me-1"></i>Editar
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="event.stopPropagation(); prepararEliminarReporte('${reporte.report_id}', '${reporte.report_name}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function renderizarArbol() {
            const container = document.getElementById('arbol-estructura');
            
            if (estructuraCache.secciones.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-diagram-3"></i>
                        <h6>Sin estructura definida</h6>
                        <p class="mb-3">Comience agregando secciones al reporte</p>
                        <button class="btn btn-primary btn-sm" onclick="agregarSeccion()">
                            <i class="bi bi-folder-plus me-1"></i>Agregar Primera Secci√≥n
                        </button>
                    </div>
                `;
                return;
            }
            
            // Construir √°rbol jer√°rquico
            const arbolHTML = construirArbolHTML(null, 1);
            container.innerHTML = arbolHTML;
            
            // Habilitar bot√≥n de agregar l√≠nea
            document.getElementById('btn-agregar-linea').disabled = false;
        }
        
        function construirArbolHTML(parentId, nivel) {
            const secciones = estructuraCache.secciones.filter(s => s.parent_section_id === parentId);
            
            if (secciones.length === 0 && parentId === null) return '';
            
            let html = '';
            
            secciones.forEach(seccion => {
                const signClass = seccion.sign_modifier === 'negative' ? 'sign-negative' : 'sign-positive';
                const signIcon = seccion.sign_modifier === 'negative' ? '‚ûñ' : '‚ûï';
                const typeLabel = seccion.section_type === 'total' ? 'TOTAL' : 
                                  seccion.section_type === 'subtotal' ? 'SUBTOTAL' : '';
                
                html += `
                    <div class="tree-item tree-item-level-${nivel}" 
                         data-type="seccion" 
                         data-id="${seccion.section_id}"
                         data-level="${nivel}"
                         onclick="seleccionarElemento(this, 'seccion', '${seccion.section_id}')">
                        <i class="bi bi-grip-vertical drag-handle"></i>
                        <i class="bi bi-folder2${seccion.is_collapsed ? '' : '-open'} text-warning"></i>
                        <span class="flex-grow-1">${seccion.section_name}</span>
                        <span class="sign-badge ${signClass}">${signIcon}</span>
                        ${typeLabel ? `<span class="type-badge">${typeLabel}</span>` : ''}
                    </div>
                `;
                
                // Renderizar l√≠neas de esta secci√≥n
                const lineas = estructuraCache.lineas.filter(l => l.section_id === seccion.section_id);
                lineas.forEach(linea => {
                    const nombre = linea.custom_label || 
                                   (linea.line_type === 'item' ? linea.budget_items?.item_name : linea.budget_categories?.category_name) || 
                                   'Sin nombre';
                    const tipoIcon = linea.line_type === 'item' ? 'bi-file-text' : 'bi-collection';
                    const signoLabel = linea.sign_override === 'invert' ? 'üîÑ' : '';
                    
                    html += `
                        <div class="tree-item tree-item-line" 
                             data-type="linea" 
                             data-id="${linea.line_id}"
                             onclick="seleccionarElemento(this, 'linea', '${linea.line_id}')">
                            <i class="bi bi-grip-vertical drag-handle"></i>
                            <i class="bi ${tipoIcon} text-secondary"></i>
                            <span class="flex-grow-1">${nombre}</span>
                            ${signoLabel}
                            <span class="type-badge">${linea.line_type === 'item' ? '√çtem' : 'Categor√≠a'}</span>
                        </div>
                    `;
                });
                
                // Renderizar subsecciones (recursivo)
                if (nivel < 3) {
                    html += construirArbolHTML(seccion.section_id, nivel + 1);
                }
            });
            
            return html;
        }
        
        // ==========================================
        // SELECCI√ìN DE ELEMENTOS
        // ==========================================
        function seleccionarElemento(elemento, tipo, id) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.tree-item.selected').forEach(el => el.classList.remove('selected'));
            
            // Marcar nuevo elemento
            elemento.classList.add('selected');
            elementoSeleccionado = { tipo, id };
            
            // Mostrar panel de configuraci√≥n
            mostrarPanelConfiguracion(tipo, id);
        }
        
        function mostrarPanelConfiguracion(tipo, id) {
            const panel = document.getElementById('panel-configuracion');
            const titulo = document.getElementById('config-titulo');
            
            if (tipo === 'seccion') {
                const seccion = estructuraCache.secciones.find(s => s.section_id === id);
                if (!seccion) return;
                
                titulo.textContent = 'Configurar Secci√≥n';
                panel.innerHTML = `
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nombre</label>
                        <p class="mb-0">${seccion.section_name}</p>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label fw-bold">Nivel</label>
                            <p class="mb-0">${seccion.section_level}</p>
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-bold">Tipo</label>
                            <p class="mb-0">${seccion.section_type === 'group' ? 'Grupo' : seccion.section_type === 'subtotal' ? 'Subtotal' : 'Total'}</p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Comportamiento</label>
                        <p class="mb-0">
                            <span class="sign-badge ${seccion.sign_modifier === 'negative' ? 'sign-negative' : 'sign-positive'}">
                                ${seccion.sign_modifier === 'negative' ? '‚ûñ Resta' : '‚ûï Suma'} al total
                            </span>
                        </p>
                    </div>
                    <hr>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm flex-grow-1" onclick="editarSeccion('${id}')">
                            <i class="bi bi-pencil me-1"></i>Editar
                        </button>
                        ${seccion.section_level < 3 ? `
                            <button class="btn btn-outline-success btn-sm" onclick="agregarSubseccion('${id}', ${seccion.section_level})" title="Agregar subsecci√≥n">
                                <i class="bi bi-folder-plus"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-outline-danger btn-sm" onclick="prepararEliminarSeccion('${id}', '${seccion.section_name}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
            } else if (tipo === 'linea') {
                const linea = estructuraCache.lineas.find(l => l.line_id === id);
                if (!linea) return;
                
                const nombre = linea.custom_label || 
                               (linea.line_type === 'item' ? linea.budget_items?.item_name : linea.budget_categories?.category_name);
                
                titulo.textContent = 'Configurar L√≠nea';
                panel.innerHTML = `
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nombre</label>
                        <p class="mb-0">${nombre}</p>
                        ${linea.custom_label ? `<small class="text-muted">Etiqueta personalizada</small>` : ''}
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label fw-bold">Tipo</label>
                            <p class="mb-0">${linea.line_type === 'item' ? '√çtem espec√≠fico' : 'Categor√≠a completa'}</p>
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-bold">Signo</label>
                            <p class="mb-0">${linea.sign_override === 'invert' ? 'üîÑ Invertido' : 'Normal'}</p>
                        </div>
                    </div>
                    ${linea.line_type === 'item' && linea.budget_items ? `
                        <div class="mb-3">
                            <label class="form-label fw-bold">Naturaleza del √≠tem</label>
                            <p class="mb-0">
                                <span class="badge ${linea.budget_items.debit_or_credit === 'credit' ? 'bg-success' : 'bg-warning'}">
                                    ${linea.budget_items.debit_or_credit === 'credit' ? 'Cr√©dito' : 'D√©bito'}
                                </span>
                            </p>
                        </div>
                    ` : ''}
                    <hr>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm flex-grow-1" onclick="editarLinea('${id}')">
                            <i class="bi bi-pencil me-1"></i>Editar
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="prepararEliminarLinea('${id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
            }
        }
        
        // ==========================================
        // NAVEGACI√ìN
        // ==========================================
        async function abrirEditor(reportId) {
            const reporte = reportesCache.find(r => r.report_id === reportId);
            if (!reporte) return;
            
            reporteActual = reporte;
            
            // Actualizar UI del editor
            document.getElementById('editor-titulo-reporte').textContent = reporte.report_name;
            document.getElementById('editor-descripcion-reporte').textContent = reporte.report_description || 'Sin descripci√≥n';
            
            // Cargar estructura
            await cargarEstructuraReporte(reportId);
            
            // Cambiar vista
            document.getElementById('vista-lista').style.display = 'none';
            document.getElementById('vista-editor').style.display = 'block';
            
            // Limpiar selecci√≥n
            elementoSeleccionado = null;
            document.getElementById('panel-configuracion').innerHTML = `
                <div class="empty-state py-5">
                    <i class="bi bi-hand-index"></i>
                    <p class="mb-0">Seleccione un elemento del √°rbol para configurarlo</p>
                </div>
            `;
        }
        
        function volverALista() {
            reporteActual = null;
            elementoSeleccionado = null;
            estructuraCache = { secciones: [], lineas: [] };
            
            document.getElementById('vista-editor').style.display = 'none';
            document.getElementById('vista-lista').style.display = 'block';
            
            cargarReportes();
        }
        
        // ==========================================
        // CRUD REPORTES
        // ==========================================
        function abrirModalNuevoReporte() {
            document.getElementById('form-reporte').reset();
            document.getElementById('reporte-id').value = '';
            document.getElementById('modal-reporte-titulo').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nuevo Reporte';
            modalReporte.show();
        }
        
        function editarInfoReporte() {
            if (!reporteActual) return;
            
            document.getElementById('reporte-id').value = reporteActual.report_id;
            document.getElementById('reporte-nombre').value = reporteActual.report_name;
            document.getElementById('reporte-descripcion').value = reporteActual.report_description || '';
            document.getElementById('modal-reporte-titulo').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Reporte';
            modalReporte.show();
        }
        
        async function guardarReporte(e) {
            e.preventDefault();
            
            const id = document.getElementById('reporte-id').value;
            const data = {
                report_name: document.getElementById('reporte-nombre').value.trim(),
                report_description: document.getElementById('reporte-descripcion').value.trim() || null
            };
            
            try {
                mostrarLoading();
                
                if (id) {
                    // Actualizar
                    await supabaseRequest(`/budget_reports?report_id=eq.${id}`, {
                        method: 'PATCH',
                        body: JSON.stringify(data)
                    });
                    showMessage('Reporte actualizado correctamente', 'success');
                    
                    // Actualizar vista del editor
                    reporteActual = { ...reporteActual, ...data };
                    document.getElementById('editor-titulo-reporte').textContent = data.report_name;
                    document.getElementById('editor-descripcion-reporte').textContent = data.report_description || 'Sin descripci√≥n';
                } else {
                    // Crear nuevo
                    const result = await supabaseRequest('/budget_reports', {
                        method: 'POST',
                        body: JSON.stringify({ ...data, report_status: 'active' })
                    });
                    showMessage('Reporte creado correctamente', 'success');
                    
                    // Abrir editor del nuevo reporte
                    if (result && result[0]) {
                        await cargarReportes();
                        abrirEditor(result[0].report_id);
                    }
                }
                
                modalReporte.hide();
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error guardando reporte:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        function prepararEliminarReporte(id, nombre) {
            document.getElementById('eliminar-tipo').value = 'reporte';
            document.getElementById('eliminar-id').value = id;
            document.getElementById('mensaje-confirmar-eliminar').innerHTML = `
                ¬øEst√° seguro de eliminar el reporte <strong>"${nombre}"</strong>?<br>
                <small class="text-muted">Se eliminar√°n todas sus secciones y l√≠neas.</small>
            `;
            modalConfirmar.show();
        }
        
        // ==========================================
        // CRUD SECCIONES
        // ==========================================
        function agregarSeccion() {
            if (!reporteActual) return;
            
            document.getElementById('form-seccion').reset();
            document.getElementById('seccion-id').value = '';
            document.getElementById('seccion-parent-id').value = '';
            document.getElementById('seccion-mostrar-subtotal').checked = true;
            document.getElementById('modal-seccion-titulo').innerHTML = '<i class="bi bi-folder-plus me-2"></i>Nueva Secci√≥n';
            document.getElementById('seccion-nivel-info').innerHTML = '<i class="bi bi-info-circle me-1"></i>Esta ser√° una secci√≥n de <strong>Nivel 1</strong> (ra√≠z)';
            modalSeccion.show();
        }
        
        function agregarSubseccion(parentId, parentLevel) {
            if (!reporteActual) return;
            
            document.getElementById('form-seccion').reset();
            document.getElementById('seccion-id').value = '';
            document.getElementById('seccion-parent-id').value = parentId;
            document.getElementById('seccion-mostrar-subtotal').checked = true;
            document.getElementById('modal-seccion-titulo').innerHTML = '<i class="bi bi-folder-plus me-2"></i>Nueva Subsecci√≥n';
            document.getElementById('seccion-nivel-info').innerHTML = `<i class="bi bi-info-circle me-1"></i>Esta ser√° una secci√≥n de <strong>Nivel ${parentLevel + 1}</strong>`;
            modalSeccion.show();
        }
        
        function editarSeccion(id) {
            const seccion = estructuraCache.secciones.find(s => s.section_id === id);
            if (!seccion) return;
            
            document.getElementById('seccion-id').value = seccion.section_id;
            document.getElementById('seccion-parent-id').value = seccion.parent_section_id || '';
            document.getElementById('seccion-nombre').value = seccion.section_name;
            document.getElementById('seccion-tipo').value = seccion.section_type;
            document.getElementById('seccion-signo').value = seccion.sign_modifier;
            document.getElementById('seccion-mostrar-subtotal').checked = seccion.show_subtotal;
            document.getElementById('modal-seccion-titulo').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Secci√≥n';
            document.getElementById('seccion-nivel-info').innerHTML = `<i class="bi bi-info-circle me-1"></i>Secci√≥n de <strong>Nivel ${seccion.section_level}</strong>`;
            modalSeccion.show();
        }
        
        async function guardarSeccion(e) {
            e.preventDefault();
            
            const id = document.getElementById('seccion-id').value;
            const parentId = document.getElementById('seccion-parent-id').value || null;
            
            // Calcular orden
            let orden = 1;
            const hermanas = estructuraCache.secciones.filter(s => s.parent_section_id === parentId);
            if (hermanas.length > 0) {
                orden = Math.max(...hermanas.map(s => s.section_order)) + 1;
            }
            
            const data = {
                report_id: reporteActual.report_id,
                parent_section_id: parentId,
                section_name: document.getElementById('seccion-nombre').value.trim(),
                section_type: document.getElementById('seccion-tipo').value,
                sign_modifier: document.getElementById('seccion-signo').value,
                show_subtotal: document.getElementById('seccion-mostrar-subtotal').checked,
                section_order: orden
            };
            
            try {
                mostrarLoading();
                
                if (id) {
                    // Actualizar (no cambiar orden ni parent)
                    const { report_id, parent_section_id, section_order, ...updateData } = data;
                    await supabaseRequest(`/budget_report_sections?section_id=eq.${id}`, {
                        method: 'PATCH',
                        body: JSON.stringify(updateData)
                    });
                    showMessage('Secci√≥n actualizada', 'success');
                } else {
                    // Crear nueva
                    await supabaseRequest('/budget_report_sections', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showMessage('Secci√≥n creada', 'success');
                }
                
                modalSeccion.hide();
                await cargarEstructuraReporte(reporteActual.report_id);
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error guardando secci√≥n:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        function prepararEliminarSeccion(id, nombre) {
            document.getElementById('eliminar-tipo').value = 'seccion';
            document.getElementById('eliminar-id').value = id;
            document.getElementById('mensaje-confirmar-eliminar').innerHTML = `
                ¬øEst√° seguro de eliminar la secci√≥n <strong>"${nombre}"</strong>?<br>
                <small class="text-muted">Se eliminar√°n sus subsecciones y l√≠neas.</small>
            `;
            modalConfirmar.show();
        }
        
        // ==========================================
        // CRUD L√çNEAS
        // ==========================================
        function agregarLinea() {
            if (!reporteActual || estructuraCache.secciones.length === 0) {
                showMessage('Primero debe crear al menos una secci√≥n', 'warning');
                return;
            }
            
            // Si hay una secci√≥n seleccionada, usarla
            let seccionId = null;
            if (elementoSeleccionado && elementoSeleccionado.tipo === 'seccion') {
                seccionId = elementoSeleccionado.id;
            } else {
                // Usar la primera secci√≥n disponible
                seccionId = estructuraCache.secciones[0].section_id;
            }
            
            document.getElementById('form-linea').reset();
            document.getElementById('linea-id').value = '';
            document.getElementById('linea-section-id').value = seccionId;
            document.getElementById('modal-linea-titulo').innerHTML = '<i class="bi bi-plus-square me-2"></i>Nueva L√≠nea';
            cambiarTipoLinea();
            modalLinea.show();
        }
        
        function editarLinea(id) {
            const linea = estructuraCache.lineas.find(l => l.line_id === id);
            if (!linea) return;
            
            document.getElementById('linea-id').value = linea.line_id;
            document.getElementById('linea-section-id').value = linea.section_id;
            document.getElementById('linea-tipo').value = linea.line_type;
            document.getElementById('linea-signo').value = linea.sign_override;
            document.getElementById('linea-etiqueta').value = linea.custom_label || '';
            
            cambiarTipoLinea();
            
            if (linea.line_type === 'category') {
                document.getElementById('linea-categoria').value = linea.category_id;
            } else {
                document.getElementById('linea-item').value = linea.item_id;
            }
            
            document.getElementById('modal-linea-titulo').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar L√≠nea';
            modalLinea.show();
        }
        
        function cambiarTipoLinea() {
            const tipo = document.getElementById('linea-tipo').value;
            const containerCategoria = document.getElementById('container-categoria');
            const containerItem = document.getElementById('container-item');
            
            if (tipo === 'category') {
                containerCategoria.style.display = 'block';
                containerItem.style.display = 'none';
                document.getElementById('linea-categoria').required = true;
                document.getElementById('linea-item').required = false;
            } else {
                containerCategoria.style.display = 'none';
                containerItem.style.display = 'block';
                document.getElementById('linea-categoria').required = false;
                document.getElementById('linea-item').required = true;
            }
        }
        
        async function guardarLinea(e) {
            e.preventDefault();
            
            const id = document.getElementById('linea-id').value;
            const tipo = document.getElementById('linea-tipo').value;
            
            // Calcular orden
            const sectionId = document.getElementById('linea-section-id').value;
            const lineasSeccion = estructuraCache.lineas.filter(l => l.section_id === sectionId);
            const orden = id ? 
                estructuraCache.lineas.find(l => l.line_id === id)?.line_order || 1 :
                (lineasSeccion.length > 0 ? Math.max(...lineasSeccion.map(l => l.line_order)) + 1 : 1);
            
            const data = {
                section_id: sectionId,
                line_type: tipo,
                category_id: tipo === 'category' ? document.getElementById('linea-categoria').value : null,
                item_id: tipo === 'item' ? document.getElementById('linea-item').value : null,
                sign_override: document.getElementById('linea-signo').value,
                custom_label: document.getElementById('linea-etiqueta').value.trim() || null,
                line_order: orden
            };
            
            try {
                mostrarLoading();
                
                if (id) {
                    await supabaseRequest(`/budget_report_lines?line_id=eq.${id}`, {
                        method: 'PATCH',
                        body: JSON.stringify(data)
                    });
                    showMessage('L√≠nea actualizada', 'success');
                } else {
                    await supabaseRequest('/budget_report_lines', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showMessage('L√≠nea agregada', 'success');
                }
                
                modalLinea.hide();
                await cargarEstructuraReporte(reporteActual.report_id);
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error guardando l√≠nea:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        function prepararEliminarLinea(id) {
            document.getElementById('eliminar-tipo').value = 'linea';
            document.getElementById('eliminar-id').value = id;
            document.getElementById('mensaje-confirmar-eliminar').textContent = '¬øEst√° seguro de eliminar esta l√≠nea?';
            modalConfirmar.show();
        }
        
        // ==========================================
        // ELIMINACI√ìN
        // ==========================================
        async function confirmarEliminacion() {
            const tipo = document.getElementById('eliminar-tipo').value;
            const id = document.getElementById('eliminar-id').value;
            
            try {
                mostrarLoading();
                modalConfirmar.hide();
                
                if (tipo === 'reporte') {
                    await supabaseRequest(`/budget_reports?report_id=eq.${id}`, { method: 'DELETE' });
                    showMessage('Reporte eliminado', 'success');
                    await cargarReportes();
                } else if (tipo === 'seccion') {
                    await supabaseRequest(`/budget_report_sections?section_id=eq.${id}`, { method: 'DELETE' });
                    showMessage('Secci√≥n eliminada', 'success');
                    await cargarEstructuraReporte(reporteActual.report_id);
                } else if (tipo === 'linea') {
                    await supabaseRequest(`/budget_report_lines?line_id=eq.${id}`, { method: 'DELETE' });
                    showMessage('L√≠nea eliminada', 'success');
                    await cargarEstructuraReporte(reporteActual.report_id);
                }
                
                ocultarLoading();
                
            } catch (error) {
                console.error('‚ùå Error eliminando:', error);
                showMessage('Error al eliminar: ' + error.message, 'danger');
                ocultarLoading();
            }
        }
        
        // ==========================================
        // HELPERS
        // ==========================================
        function llenarSelectCategorias() {
            const select = document.getElementById('linea-categoria');
            select.innerHTML = '<option value="">Seleccione una categor√≠a...</option>';
            
            categoriasCache.forEach(cat => {
                select.innerHTML += `<option value="${cat.category_id}">${cat.category_name}</option>`;
            });
        }
        
        function llenarSelectItems() {
            const select = document.getElementById('linea-item');
            select.innerHTML = '<option value="">Seleccione un √≠tem...</option>';
            
            // Agrupar por categor√≠a
            const categorias = {};
            itemsCache.forEach(item => {
                const catName = item.budget_categories?.category_name || 'Sin categor√≠a';
                if (!categorias[catName]) categorias[catName] = [];
                categorias[catName].push(item);
            });
            
            Object.keys(categorias).sort().forEach(catName => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = catName;
                
                categorias[catName].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.item_id;
                    option.textContent = `${item.item_name} (${item.debit_or_credit === 'credit' ? 'Cr' : 'Db'})`;
                    optgroup.appendChild(option);
                });
                
                select.appendChild(optgroup);
            });
        }
        
        // ==========================================
        // VISTA PREVIA
        // ==========================================
        async function previsualizarReporte() {
            if (!reporteActual) return;
            
            // Cargar a√±os acad√©micos
            try {
                const anos = await supabaseRequest('/academic_years?select=year_id,year_name&order=year_name.desc');
                const selectAno = document.getElementById('preview-ano');
                selectAno.innerHTML = anos.map(a => 
                    `<option value="${a.year_id}">${a.year_name}</option>`
                ).join('');
                
                modalPreview.show();
                actualizarPreview();
                
            } catch (error) {
                console.error('‚ùå Error cargando preview:', error);
                showMessage('Error al cargar vista previa', 'danger');
            }
        }
        
        async function actualizarPreview() {
            const contenedor = document.getElementById('preview-contenido');
            const yearId = document.getElementById('preview-ano').value;
            
            if (!yearId) {
                contenedor.innerHTML = '<p class="text-muted text-center">Seleccione un a√±o acad√©mico</p>';
                return;
            }
            
            contenedor.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Calculando valores...</p>
                </div>
            `;
            
            try {
                // Generar HTML del reporte
                const html = await generarHTMLReporte(yearId);
                contenedor.innerHTML = html;
                
            } catch (error) {
                console.error('‚ùå Error generando preview:', error);
                contenedor.innerHTML = `<div class="alert alert-danger">Error al generar vista previa: ${error.message}</div>`;
            }
        }
        
        async function generarHTMLReporte(yearId) {
            // Obtener asignaciones del a√±o
            const asignaciones = await supabaseRequest(
                `/budget_assignments?select=budget_item_id,approved_value,executed_value,requested_value&academic_year_id=eq.${yearId}`
            );
            
            // Crear mapa de valores por √≠tem
            const valoresPorItem = {};
            asignaciones.forEach(a => {
                if (!valoresPorItem[a.budget_item_id]) {
                    valoresPorItem[a.budget_item_id] = { approved: 0, executed: 0, requested: 0 };
                }
                valoresPorItem[a.budget_item_id].approved += a.approved_value || 0;
                valoresPorItem[a.budget_item_id].executed += a.executed_value || 0;
                valoresPorItem[a.budget_item_id].requested += a.requested_value || 0;
            });
            
            // Generar tabla
            let html = `
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 50%">Concepto</th>
                                <th class="text-end">Aprobado</th>
                                <th class="text-end">Ejecutado</th>
                                <th class="text-end">Disponible</th>
                                <th class="text-end">% Ejec.</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Procesar secciones de nivel 1
            const seccionesRaiz = estructuraCache.secciones.filter(s => !s.parent_section_id);
            
            for (const seccion of seccionesRaiz) {
                const resultado = calcularValoresSeccion(seccion, valoresPorItem);
                html += generarFilasSeccion(seccion, resultado, 0, valoresPorItem);
            }
            
            html += '</tbody></table></div>';
            
            return html;
        }
        
        function calcularValoresSeccion(seccion, valoresPorItem) {
            let totales = { approved: 0, executed: 0 };
            
            // Sumar l√≠neas directas
            const lineas = estructuraCache.lineas.filter(l => l.section_id === seccion.section_id);
            lineas.forEach(linea => {
                const valores = calcularValoresLinea(linea, valoresPorItem);
                totales.approved += valores.approved;
                totales.executed += valores.executed;
            });
            
            // Sumar subsecciones
            const subsecciones = estructuraCache.secciones.filter(s => s.parent_section_id === seccion.section_id);
            subsecciones.forEach(sub => {
                const subResultado = calcularValoresSeccion(sub, valoresPorItem);
                const signo = sub.sign_modifier === 'negative' ? -1 : 1;
                totales.approved += subResultado.approved * signo;
                totales.executed += subResultado.executed * signo;
            });
            
            return totales;
        }
        
        function calcularValoresLinea(linea, valoresPorItem) {
            let valores = { approved: 0, executed: 0 };
            
            if (linea.line_type === 'item' && linea.item_id) {
                const itemValores = valoresPorItem[linea.item_id] || { approved: 0, executed: 0 };
                valores = { ...itemValores };
            } else if (linea.line_type === 'category' && linea.category_id) {
                // Sumar todos los √≠tems de la categor√≠a
                const itemsCategoria = itemsCache.filter(i => i.category_id === linea.category_id);
                itemsCategoria.forEach(item => {
                    const itemValores = valoresPorItem[item.item_id] || { approved: 0, executed: 0 };
                    valores.approved += itemValores.approved;
                    valores.executed += itemValores.executed;
                });
            }
            
            // Aplicar inversi√≥n de signo si corresponde
            if (linea.sign_override === 'invert') {
                valores.approved *= -1;
                valores.executed *= -1;
            }
            
            return valores;
        }
        
        function generarFilasSeccion(seccion, totales, nivel, valoresPorItem) {
            const indent = nivel * 20;
            const fontWeight = nivel === 0 ? 'fw-bold' : '';
            const bgClass = seccion.section_type === 'total' ? 'table-dark' : 
                           seccion.section_type === 'subtotal' ? 'table-secondary' : '';
            
            let html = `
                <tr class="${bgClass}">
                    <td class="${fontWeight}" style="padding-left: ${indent + 8}px">
                        ${seccion.section_name}
                        ${seccion.sign_modifier === 'negative' ? '<small class="text-danger ms-1">(-)</small>' : ''}
                    </td>
                    <td class="text-end ${fontWeight}">${formatearMoneda(totales.approved)}</td>
                    <td class="text-end ${fontWeight}">${formatearMoneda(totales.executed)}</td>
                    <td class="text-end ${fontWeight}">${formatearMoneda(totales.approved - totales.executed)}</td>
                    <td class="text-end ${fontWeight}">${totales.approved ? ((totales.executed / totales.approved) * 100).toFixed(1) : 0}%</td>
                </tr>
            `;
            
            // L√≠neas de la secci√≥n
            const lineas = estructuraCache.lineas.filter(l => l.section_id === seccion.section_id);
            lineas.forEach(linea => {
                const valores = calcularValoresLinea(linea, valoresPorItem);
                const nombre = linea.custom_label || 
                               (linea.line_type === 'item' ? linea.budget_items?.item_name : linea.budget_categories?.category_name);
                
                html += `
                    <tr>
                        <td style="padding-left: ${indent + 28}px">
                            <small>${nombre}</small>
                        </td>
                        <td class="text-end"><small>${formatearMoneda(valores.approved)}</small></td>
                        <td class="text-end"><small>${formatearMoneda(valores.executed)}</small></td>
                        <td class="text-end"><small>${formatearMoneda(valores.approved - valores.executed)}</small></td>
                        <td class="text-end"><small>${valores.approved ? ((valores.executed / valores.approved) * 100).toFixed(1) : 0}%</small></td>
                    </tr>
                `;
            });
            
            // Subsecciones (recursivo)
            const subsecciones = estructuraCache.secciones.filter(s => s.parent_section_id === seccion.section_id);
            subsecciones.forEach(sub => {
                const subTotales = calcularValoresSeccion(sub, valoresPorItem);
                html += generarFilasSeccion(sub, subTotales, nivel + 1, valoresPorItem);
            });
            
            return html;
        }
        
        function formatearMoneda(valor) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(valor || 0);
        }
        
        function exportarPDF() {
            showMessage('Funcionalidad de exportar PDF en desarrollo', 'info');
            // TODO: Implementar exportaci√≥n PDF con librer√≠a como jsPDF o html2pdf
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay')?.classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay')?.classList.add('hidden');
        }
        
        console.log('‚úÖ M√≥dulo de dise√±o de reportes cargado');
    </script>
</body>
</html>
