<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicializar A√±o Presupuestal - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c5530;
            --secondary-color: #3d7c47;
            --success-color: #198754;
            --warning-color: #fd7e14;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .main-section {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
        }

        .main-section h4 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .year-selector {
            background: var(--info-color);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .status-section {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--warning-color);
        }

        .status-section.show {
            display: block;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .status-card h5 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .status-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .results-section {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--success-color);
        }

        .results-section.show {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .summary-card.success {
            border-color: var(--success-color);
        }

        .summary-card.warning {
            border-color: var(--warning-color);
        }

        .summary-card.info {
            border-color: var(--info-color);
        }

        .summary-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .category-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .category-card h5 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .category-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .errors-section {
            display: none;
            background: #fff5f5;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
            border-left: 4px solid var(--danger-color);
        }

        .errors-section.show {
            display: block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-action {
            padding: 0.75rem 2rem;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-action:hover {
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .main-section {
                padding: 1rem;
            }
            
            .page-header {
                padding: 1rem 0;
            }

            .summary-grid,
            .category-grid,
            .status-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

    <body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-2"><strong>Procesando inicializaci√≥n...</strong></p>
            <p class="mb-0 text-muted" id="loading-message">Esta operaci√≥n puede tomar varios minutos</p>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard.html">
                <i class="bi bi-house-door"></i> SchoolNet
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/modules/budget/index.html">
                    <i class="bi bi-arrow-left"></i> Volver al M√≥dulo
                </a>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="bi bi-calendar-plus"></i> 
                        Inicializar A√±o Presupuestal
                    </h1>
                    <p class="mb-0 fs-5">Creaci√≥n autom√°tica de asignaciones presupuestales por categor√≠as</p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-light text-dark fs-6">
                        <i class="bi bi-gear"></i> Inicializaci√≥n Masiva
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Year Selection -->
        <div class="year-selector">
            <h4 class="mb-3">
                <i class="bi bi-calendar-check"></i> Selecci√≥n del A√±o Presupuestal
            </h4>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <select class="form-select form-select-lg" id="yearSelect" disabled>
                        <option value="">Cargando a√±os acad√©micos...</option>
                    </select>
                </div>
            </div>
            <div class="row justify-content-center mt-3">
                <div class="col-md-6 text-center">
                    <button class="btn btn-warning btn-action me-2" id="btnVerifyState" disabled>
                        <i class="bi bi-search"></i> Verificar Estado
                    </button>
                    <button class="btn btn-success btn-action" id="btnInitialize" disabled>
                        <i class="bi bi-play-fill"></i> Inicializar
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Section -->
        <div class="status-section" id="statusSection">
            <h4>
                <i class="bi bi-info-circle text-warning"></i> 
                Estado Actual del A√±o
            </h4>
            <div class="status-grid" id="statusGrid">
                <!-- Status cards will be populated here -->
            </div>
            <div class="alert alert-info">
                <i class="bi bi-lightbulb"></i>
                <strong>Informaci√≥n:</strong> Los n√∫meros muestran las asignaciones ya existentes por categor√≠a.
                La inicializaci√≥n crear√° las asignaciones faltantes autom√°ticamente.
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <h4>
                <i class="bi bi-check-circle text-success"></i> 
                Resultados de la Inicializaci√≥n
            </h4>
            
            <!-- Summary -->
            <div class="summary-grid" id="summaryGrid">
                <!-- Summary cards will be populated here -->
            </div>
            
            <!-- Category Details -->
            <h5 class="mt-4 mb-3">Detalles por Categor√≠a</h5>
            <div class="category-grid" id="categoryGrid">
                <!-- Category cards will be populated here -->
            </div>
            
            <!-- Errors Section -->
            <div class="errors-section" id="errorsSection">
                <h6 class="text-danger mb-3">
                    <i class="bi bi-exclamation-triangle"></i> Errores Encontrados
                </h6>
                <ul id="errorsList" class="mb-0">
                    <!-- Errors will be populated here -->
                </ul>
            </div>
            
            <!-- Actions after completion -->
            <div class="text-center mt-4">
                <button class="btn btn-primary btn-action" id="btnNewInitialization">
                    <i class="bi bi-arrow-repeat"></i> Nueva Inicializaci√≥n
                </button>
            </div>
        </div>

        <!-- No Selection State -->
        <div id="noYearSelected" class="text-center py-5">
            <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
            <h4 class="text-muted mt-3">Seleccione un a√±o presupuestal</h4>
            <p class="text-muted">Seleccione el a√±o para verificar su estado e inicializar las asignaciones presupuestales</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Config JS -->
    <script src="../../assets/js/config.js"></script>

        <script>
        /**
         * JavaScript para Inicializar A√±o Presupuestal - SchoolNet
         * Migrado desde Google Apps Script a Supabase/Next.js
         */

        // Variables globales
        let currentUser = null;
        let selectedYear = null;
        let yearData = [];
        let currentYearState = null;
        let isProcessing = false;

        // Referencias DOM
        const elementos = {
            yearSelect: null,
            btnVerifyState: null,
            btnInitialize: null,
            btnNewInitialization: null,
            statusSection: null,
            statusGrid: null,
            resultsSection: null,
            summaryGrid: null,
            categoryGrid: null,
            errorsSection: null,
            errorsList: null,
            loadingOverlay: null,
            loadingMessage: null,
            noYearSelected: null
        };

        /**
         * Inicializaci√≥n cuando se carga el DOM
         */

            document.addEventListener('DOMContentLoaded', async function() {
    console.log('üîß Iniciando inicializaci√≥n de a√±o presupuestal...');
    
    try {
        // PRIMERO: Inicializar elementos DOM
        initializeElements();
        
        // SEGUNDO: Verificar integridad del sistema DESPU√âS de inicializar elementos
        if (!validateSystemIntegrity()) {
            return;
        }
        
        // TERCERO: Validar acceso a la p√°gina
        const hasAccess = await validatePageAccess('Inicializar a√±o presupuestal');
        if (!hasAccess) {
            console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
            return;
        }
        
        console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
        
        // Verificar sesi√≥n activa
        const session = getStoredSession();
        if (!session || !session.user) {
            window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
            return;
        }
        
        currentUser = session.user;
        console.log('üë§ Usuario actual:', currentUser.user_display_name || currentUser.user_name);
        
        // Inicializar componentes
        setupEventListeners();
        await loadAcademicYears();
        
        showMessage('Sistema listo. Seleccione un a√±o presupuestal para continuar.', 'info');
        console.log('‚úÖ P√°gina inicializada correctamente');
        
    } catch (error) {
        console.error('‚ùå Error inicializando p√°gina:', error);
        showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
    }
});

            
        /**
         * Inicializa referencias a elementos DOM
         */
        function initializeElements() {
            elementos.yearSelect = document.getElementById('yearSelect');
            elementos.btnVerifyState = document.getElementById('btnVerifyState');
            elementos.btnInitialize = document.getElementById('btnInitialize');
            elementos.btnNewInitialization = document.getElementById('btnNewInitialization');
            elementos.statusSection = document.getElementById('statusSection');
            elementos.statusGrid = document.getElementById('statusGrid');
            elementos.resultsSection = document.getElementById('resultsSection');
            elementos.summaryGrid = document.getElementById('summaryGrid');
            elementos.categoryGrid = document.getElementById('categoryGrid');
            elementos.errorsSection = document.getElementById('errorsSection');
            elementos.errorsList = document.getElementById('errorsList');
            elementos.loadingOverlay = document.getElementById('loading-overlay');
            elementos.loadingMessage = document.getElementById('loading-message');
            elementos.noYearSelected = document.getElementById('noYearSelected');
        }

        /**
         * Configura event listeners
         */
        function setupEventListeners() {
            // Cambio de a√±o
            elementos.yearSelect.addEventListener('change', handleYearChange);
            
            // Botones principales
            elementos.btnVerifyState.addEventListener('click', verifyYearState);
            elementos.btnInitialize.addEventListener('click', confirmInitialization);
            elementos.btnNewInitialization.addEventListener('click', startNewInitialization);
            
            // Prevenir salida durante procesamiento
            window.addEventListener('beforeunload', function(e) {
                if (isProcessing) {
                    e.preventDefault();
                    e.returnValue = 'Hay una inicializaci√≥n en progreso. ¬øEst√° seguro que desea salir?';
                }
            });
            
            // Atajos de teclado
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideAllSections();
                }
            });
        }

        /**
         * Carga a√±os acad√©micos disponibles
         */
        async function loadAcademicYears() {
            try {
                showLoading('Cargando a√±os acad√©micos...');
                
                const years = await supabaseRequest('/academic_years?select=year_id,year_name,is_current&order=year_order.desc');
                yearData = years || [];
                
                renderYearSelect();
                hideLoading();
                
                console.log('‚úÖ A√±os acad√©micos cargados:', yearData.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando a√±os acad√©micos:', error);
                showMessage('Error al cargar a√±os acad√©micos', 'danger');
                hideLoading();
            }
        }

        /**
         * Renderiza el select de a√±os
         */
        function renderYearSelect() {
            elementos.yearSelect.innerHTML = '<option value="">Seleccione un a√±o presupuestal...</option>';
            
            yearData.forEach(year => {
                const option = document.createElement('option');
                option.value = year.year_id;
                option.textContent = year.year_name;
                
                // Marcar a√±o actual por defecto
                if (year.is_current) {
                    option.selected = true;
                }
                
                elementos.yearSelect.appendChild(option);
            });
            
            elementos.yearSelect.disabled = false;
            
            // Si hay un a√±o seleccionado por defecto, activar bot√≥n
            if (elementos.yearSelect.value) {
                handleYearChange();
            }
        }

        /**
         * Maneja el cambio de a√±o seleccionado
         */
        function handleYearChange() {
            const yearId = elementos.yearSelect.value;
            
            if (yearId) {
                selectedYear = yearId;
                elementos.btnVerifyState.disabled = false;
                elementos.btnInitialize.disabled = true;
                hideAllSections();
                showNoYearMessage(false);
            } else {
                selectedYear = null;
                elementos.btnVerifyState.disabled = true;
                elementos.btnInitialize.disabled = true;
                hideAllSections();
                showNoYearMessage(true);
            }
        }

        /**
         * Muestra u oculta el mensaje de "no hay a√±o seleccionado"
         */
        function showNoYearMessage(show) {
            elementos.noYearSelected.style.display = show ? 'block' : 'none';
        }

        /**
         * Oculta todas las secciones
         */
        function hideAllSections() {
            elementos.statusSection.classList.remove('show');
            elementos.resultsSection.classList.remove('show');
            elementos.errorsSection.classList.remove('show');
            currentYearState = null;
        }

        /**
         * Funciones de utilidad para loading
         */
        function showLoading(message = 'Procesando...') {
            elementos.loadingMessage.textContent = message;
            elementos.loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            elementos.loadingOverlay.classList.add('hidden');
        }

        /**
         * Funci√≥n para obtener sesi√≥n almacenada
         */
        function getStoredSession() {
            try {
                const sessionData = localStorage.getItem('nextSystemSession') || sessionStorage.getItem('nextSystemSession');
                return sessionData ? JSON.parse(sessionData) : null;
            } catch (error) {
                return null;
            }
        }

            /**
         * Verifica el estado actual del a√±o seleccionado
         */

            async function verifyYearState() {
    if (!selectedYear) {
        showMessage('Debe seleccionar un a√±o primero', 'warning');
        return;
    }
    
    try {
        console.log('üîç Iniciando verificaci√≥n del a√±o:', selectedYear);
        showLoading('Verificando estado del a√±o...');
        
        // Primero verificar que el a√±o existe
        console.log('üìã Verificando que el a√±o existe...');
        const yearCheck = await supabaseRequest(`/academic_years?select=year_id,year_name&year_id=eq.${selectedYear}`);
        console.log('üìã Resultado verificaci√≥n a√±o:', yearCheck);
        
        if (!yearCheck || yearCheck.length === 0) {
            throw new Error('El a√±o acad√©mico seleccionado no existe');
        }
        
        // Ahora obtener el estado
        console.log('üìä Obteniendo estado del a√±o...');
        const yearState = await getYearState(selectedYear);
        console.log('üìä Estado obtenido:', yearState);
        
        currentYearState = yearState;
        
        renderYearState(yearState);
        elementos.statusSection.classList.add('show');
        elementos.btnInitialize.disabled = false;
        
        hideLoading();
        showMessage('Estado del a√±o verificado. Puede proceder con la inicializaci√≥n.', 'success');
        
        // Scroll to status section
        elementos.statusSection.scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        console.error('‚ùå Error completo en verificaci√≥n:', error);
        console.error('‚ùå Stack trace:', error.stack);
        showMessage('Error al verificar estado del a√±o: ' + error.message, 'danger');
        hideLoading();
    }
}
            

        /**
         * Obtiene el estado actual del a√±o (asignaciones existentes)
         */
        async function getYearState(yearId) {
            try {
                // Obtener asignaciones existentes agrupadas por categor√≠a
                const existingAssignments = await supabaseRequest(
                    `/budget_assignments?select=assignment_category,budget_item_id&academic_year_id=eq.${yearId}`
                );

                const activeItems = await supabaseRequest(
                    `/budget_items?select=item_id,assignment_category&item_status=eq.active&assignment_category=not.eq.General`
                );
                
                // Procesar datos para el estado
                const categories = ['Secciones', 'Programas', '√Åreas', 'Grados'];
                const stateData = {};
                
                categories.forEach(category => {
                    // Contar asignaciones existentes
                    const existingCount = existingAssignments.filter(a => a.assignment_category === category).length;
                    
                    // Contar sub-√≠tems √∫nicos con asignaciones
                    const uniqueItemsWithAssignments = new Set(
                        existingAssignments
                            .filter(a => a.assignment_category === category)
                            .map(a => a.budget_item_id)
                    ).size;
                    
                    // Contar total de sub-√≠tems de esta categor√≠a
                    const totalItems = activeItems.filter(item => item.assignment_category === category).length;
                    
                    stateData[category] = {
                        totalAssignments: existingCount,
                        uniqueItemsWithAssignments: uniqueItemsWithAssignments,
                        totalItemsInCategory: totalItems,
                        completionPercentage: totalItems > 0 ? Math.round((uniqueItemsWithAssignments / totalItems) * 100) : 0
                    };
                });
                
                return stateData;
                
            } catch (error) {
                console.error('Error obteniendo estado del a√±o:', error);
                throw new Error('No se pudo obtener el estado del a√±o');
            }
        }

        /**
         * Renderiza el estado del a√±o en la interfaz
         */
        function renderYearState(stateData) {
            const categories = [
                { key: 'Secciones', name: 'Secciones', icon: 'üè¢' },
                { key: 'Programas', name: 'Programas', icon: 'üìö' },
                { key: '√Åreas', name: '√Åreas', icon: 'üéì' },
                { key: 'Grados', name: 'Grados', icon: 'üìä' }
            ];
            
            const fragment = document.createDocumentFragment();
            
            categories.forEach(category => {
                const data = stateData[category.key] || {
                    totalAssignments: 0,
                    uniqueItemsWithAssignments: 0,
                    totalItemsInCategory: 0,
                    completionPercentage: 0
                };
                
                const card = document.createElement('div');
                card.className = 'status-card';
                card.innerHTML = `
                    <h5>${category.icon} ${category.name}</h5>
                    <div class="status-number">${data.totalAssignments}</div>
                    <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.5rem;">
                        ${data.uniqueItemsWithAssignments}/${data.totalItemsInCategory} sub-√≠tems
                    </div>
                    <div style="font-size: 0.9rem; font-weight: 600; color: ${data.completionPercentage === 100 ? 'var(--success-color)' : 'var(--warning-color)'}; margin-top: 0.25rem;">
                        ${data.completionPercentage}% completo
                    </div>
                `;
                fragment.appendChild(card);
            });
            
            elementos.statusGrid.innerHTML = '';
            elementos.statusGrid.appendChild(fragment);
        }

        /**
         * Confirma la inicializaci√≥n con el usuario
         */
        function confirmInitialization() {
            if (!selectedYear) {
                showMessage('Debe seleccionar un a√±o primero', 'warning');
                return;
            }
            
            const yearName = elementos.yearSelect.options[elementos.yearSelect.selectedIndex].text;
            
            const confirmed = confirm(
                `¬øEst√° seguro que desea inicializar el a√±o presupuestal "${yearName}"?\n\n` +
                `Esta operaci√≥n crear√° autom√°ticamente las asignaciones presupuestales para:\n` +
                `‚Ä¢ Todas las secciones\n` +
                `‚Ä¢ Todos los programas\n` +
                `‚Ä¢ Todas las √°reas acad√©micas\n` +
                `‚Ä¢ Todos los grados\n\n` +
                `Solo se crear√°n las asignaciones que no existan previamente.\n` +
                `Esta operaci√≥n puede tomar varios minutos.\n\n` +
                `¬øDesea continuar?`
            );
            
            if (confirmed) {
                executeInitialization();
            }
        }

        /**
         * Ejecuta la inicializaci√≥n del a√±o presupuestal
         */
        async function executeInitialization() {
            if (isProcessing) return;
            
            try {
                isProcessing = true;
                showLoading('Iniciando proceso de inicializaci√≥n...');
                
                // Deshabilitar controles
                elementos.yearSelect.disabled = true;
                elementos.btnVerifyState.disabled = true;
                elementos.btnInitialize.disabled = true;
                
                // Ocultar secciones anteriores
                elementos.resultsSection.classList.remove('show');
                elementos.errorsSection.classList.remove('show');
                
                // Ejecutar inicializaci√≥n por categor√≠as
                const results = await performBudgetInitialization(selectedYear);
                
                // Mostrar resultados
                renderInitializationResults(results);
                elementos.resultsSection.classList.add('show');
                
                // Scroll to results
                setTimeout(() => {
                    elementos.resultsSection.scrollIntoView({ behavior: 'smooth' });
                }, 500);
                
                hideLoading();
                showMessage(`Inicializaci√≥n completada. ${results.totalCreated} asignaciones creadas, ${results.totalExisting} ya exist√≠an.`, 'success');
                
            } catch (error) {
                console.error('Error en inicializaci√≥n:', error);
                showMessage('Error durante la inicializaci√≥n: ' + error.message, 'danger');
                hideLoading();
            } finally {
                isProcessing = false;
                
                // Rehabilitar controles
                elementos.yearSelect.disabled = false;
                elementos.btnVerifyState.disabled = false;
                elementos.btnInitialize.disabled = false;
            }
        }
            /**
         * Funci√≥n principal: Ejecuta la inicializaci√≥n presupuestal completa
         */
        async function performBudgetInitialization(yearId) {
            const results = {
                processingResults: {
                    secciones: { created: 0, existing: 0, errors: [] },
                    programas: { created: 0, existing: 0, errors: [] },
                    areas: { created: 0, existing: 0, errors: [] },
                    grados: { created: 0, existing: 0, errors: [] }
                },
                totalCreated: 0,
                totalExisting: 0,
                globalErrors: []
            };

            try {
                // Obtener todas las asignaciones existentes de una vez (optimizaci√≥n cr√≠tica)
                showLoading('Consultando asignaciones existentes...');
                const existingAssignments = await getExistingAssignments(yearId);
                const existingKeys = new Set(existingAssignments.map(a => `${a.budget_item_id}-${a.assignment_category}`));

                // Procesar cada categor√≠a secuencialmente
                const categories = [
                    { name: 'secciones', function: processCategorySections },
                    { name: 'programas', function: processCategoryPrograms },
                    { name: 'areas', function: processCategoryAreas },
                    { name: 'grados', function: processCategoryGrades }
                ];

                for (const category of categories) {
                    try {
                        showLoading(`Procesando categor√≠a: ${category.name}...`);
                        const categoryResult = await category.function(yearId, existingKeys);
                        results.processingResults[category.name] = categoryResult;
                        results.totalCreated += categoryResult.created;
                        results.totalExisting += categoryResult.existing;
                    } catch (error) {
                        console.error(`Error procesando ${category.name}:`, error);
                        results.globalErrors.push(`Error en ${category.name}: ${error.message}`);
                    }
                }

                return results;

            } catch (error) {
                console.error('Error en inicializaci√≥n principal:', error);
                results.globalErrors.push(`Error general: ${error.message}`);
                return results;
            }
        }

        /**
         * Obtiene todas las asignaciones existentes para el a√±o
         */
        async function getExistingAssignments(yearId) {
            try {
                const assignments = await supabaseRequest(
                    `/budget_assignments?select=budget_item_id,assignment_category&academic_year_id=eq.${yearId}`
                );
                return assignments || [];
            } catch (error) {
                console.error('Error obteniendo asignaciones existentes:', error);
                throw new Error('No se pudieron cargar las asignaciones existentes');
            }
        }

        /**
         * Procesa categor√≠a SECCIONES: Crea asignaciones para todas las combinaciones sub-item x secci√≥n
         */
        async function processCategorySections(yearId, existingKeys) {
            const result = { created: 0, existing: 0, errors: [] };

            try {
                // Obtener sub-√≠tems activos de categor√≠a Secciones
                const budgetItems = await supabaseRequest(
                    `/budget_items?select=item_id,item_name&item_status=eq.active&assignment_category=eq.Secciones`
                );

                const sections = await supabaseRequest(
                    `/sections?select=section_id,section_name,director_email&section_status=eq.active`   
                );
                if (!budgetItems.length || !sections.length) {
                    return result;
                }

                // Crear asignaciones masivas
                const assignmentsToCreate = [];

                budgetItems.forEach(item => {
                    sections.forEach(section => {
                        const key = `${item.item_id}-Secciones`;
                        
                        if (existingKeys.has(key)) {
                            result.existing++;
                        } else {
                            assignmentsToCreate.push({
                                academic_year_id: yearId,
                                budget_item_id: item.item_id,
                                assignment_category: 'Secciones',
                                category_detail: section.section_name,
                                worker_email: section.director_email,
                                requested_value: 0,
                                approved_value: 0,
                                executed_value: 0,
                                assignment_status: 'active'
                            });
                        }
                    });
                });

                // Insertar en lotes para evitar timeouts
                if (assignmentsToCreate.length > 0) {
                    const batchSize = 50;
                    let inserted = 0;
                    
                    for (let i = 0; i < assignmentsToCreate.length; i += batchSize) {
                        const batch = assignmentsToCreate.slice(i, i + batchSize);
                        
                        await supabaseRequest('/budget_assignments', {
                            method: 'POST',
                            body: JSON.stringify(batch)
                        });
                        
                        inserted += batch.length;
                        showLoading(`Secciones: ${inserted}/${assignmentsToCreate.length} asignaciones creadas...`);
                    }
                    
                    result.created = inserted;
                }

                return result;

            } catch (error) {
                result.errors.push(`Error procesando secciones: ${error.message}`);
                return result;
            }
        }

        /**
         * Procesa categor√≠a PROGRAMAS: Crea asignaciones para todas las combinaciones sub-item x programa
         */
        async function processCategoryPrograms(yearId, existingKeys) {
            const result = { created: 0, existing: 0, errors: [] };

            try {
                // Obtener sub-√≠tems activos de categor√≠a Programas
                const budgetItems = await supabaseRequest(
                    `/budget_items?select=item_id,item_name&item_status=eq.active&assignment_category=eq.Programas`
                );

                const programs = await supabaseRequest(
                    `/programs?select=program_id,program_name,program_director_email&program_status=eq.active`
                );
                if (!budgetItems.length || !programs.length) {
                    return result;
                }

                // Crear asignaciones masivas
                const assignmentsToCreate = [];

                budgetItems.forEach(item => {
                    programs.forEach(program => {
                        const key = `${item.item_id}-Programas`;
                        
                        if (existingKeys.has(key)) {
                            result.existing++;
                        } else {
                            assignmentsToCreate.push({
                                academic_year_id: yearId,
                                budget_item_id: item.item_id,
                                assignment_category: 'Programas',
                                category_detail: program.program_name,
                                worker_email: program.program_director_email,
                                requested_value: 0,
                                approved_value: 0,
                                executed_value: 0,
                                assignment_status: 'active'
                            });
                        }
                    });
                });

                // Insertar en lotes
                if (assignmentsToCreate.length > 0) {
                    const batchSize = 50;
                    let inserted = 0;
                    
                    for (let i = 0; i < assignmentsToCreate.length; i += batchSize) {
                        const batch = assignmentsToCreate.slice(i, i + batchSize);
                        
                        await supabaseRequest('/budget_assignments', {
                            method: 'POST',
                            body: JSON.stringify(batch)
                        });
                        
                        inserted += batch.length;
                        showLoading(`Programas: ${inserted}/${assignmentsToCreate.length} asignaciones creadas...`);
                    }
                    
                    result.created = inserted;
                }

                return result;

            } catch (error) {
                result.errors.push(`Error procesando programas: ${error.message}`);
                return result;
            }
        }

            /**
         * Procesa categor√≠a √ÅREAS: Crea asignaciones para todas las combinaciones sub-item x √°rea acad√©mica
         */
        async function processCategoryAreas(yearId, existingKeys) {
            const result = { created: 0, existing: 0, errors: [] };

            try {
                // Obtener sub-√≠tems activos de categor√≠a √Åreas
                const budgetItems = await supabaseRequest(
                    `/budget_items?select=item_id,item_name&item_status=eq.active&assignment_category=eq.√Åreas`
                );

                const areas = await supabaseRequest(
                    `/academic_areas?select=area_id,area_name,area_chief_email&area_status=eq.active`
                );

                if (!budgetItems.length || !areas.length) {
                    return result;
                }

                // Crear asignaciones masivas
                const assignmentsToCreate = [];

                budgetItems.forEach(item => {
                    areas.forEach(area => {
                        const key = `${item.item_id}-√Åreas`;
                        
                        if (existingKeys.has(key)) {
                            result.existing++;
                        } else {
                            assignmentsToCreate.push({
                                academic_year_id: yearId,
                                budget_item_id: item.item_id,
                                assignment_category: '√Åreas',
                                category_detail: area.area_name,
                                worker_email: area.area_chief_email,
                                requested_value: 0,
                                approved_value: 0,
                                executed_value: 0,
                                assignment_status: 'active'
                            });
                        }
                    });
                });

                // Insertar en lotes
                if (assignmentsToCreate.length > 0) {
                    const batchSize = 50;
                    let inserted = 0;
                    
                    for (let i = 0; i < assignmentsToCreate.length; i += batchSize) {
                        const batch = assignmentsToCreate.slice(i, i + batchSize);
                        
                        await supabaseRequest('/budget_assignments', {
                            method: 'POST',
                            body: JSON.stringify(batch)
                        });
                        
                        inserted += batch.length;
                        showLoading(`√Åreas: ${inserted}/${assignmentsToCreate.length} asignaciones creadas...`);
                    }
                    
                    result.created = inserted;
                }

                return result;

            } catch (error) {
                result.errors.push(`Error procesando √°reas: ${error.message}`);
                return result;
            }
        }

        /**
         * Procesa categor√≠a GRADOS: Crea asignaciones para todas las combinaciones sub-item x grado
         */
        async function processCategoryGrades(yearId, existingKeys) {
            const result = { created: 0, existing: 0, errors: [] };

            try {
                // Obtener sub-√≠tems activos de categor√≠a Grados
                const budgetItems = await supabaseRequest(
                    `/budget_items?select=item_id,item_name&item_status=eq.active&assignment_category=eq.Grados`
                );

                const grades = await supabaseRequest(
                    `/grades?select=grade_id,grade_name,sections!inner(director_email)&grade_status=eq.active`
                );

                if (!budgetItems.length || !grades.length) {
                    return result;
                }

                // Crear asignaciones masivas
                const assignmentsToCreate = [];

                budgetItems.forEach(item => {
                    grades.forEach(grade => {
                        const key = `${item.item_id}-Grados`;
                        
                        if (existingKeys.has(key)) {
                            result.existing++;
                        } else {
                            assignmentsToCreate.push({
                                academic_year_id: yearId,
                                budget_item_id: item.item_id,
                                assignment_category: 'Grados',
                                category_detail: grade.grade_name,
                                worker_email: grade.sections?.director_email,
                                requested_value: 0,
                                approved_value: 0,
                                executed_value: 0,
                                assignment_status: 'active'
                            });
                        }
                    });
                });

                // Insertar en lotes
                if (assignmentsToCreate.length > 0) {
                    const batchSize = 50;
                    let inserted = 0;
                    
                    for (let i = 0; i < assignmentsToCreate.length; i += batchSize) {
                        const batch = assignmentsToCreate.slice(i, i + batchSize);
                        
                        await supabaseRequest('/budget_assignments', {
                            method: 'POST',
                            body: JSON.stringify(batch)
                        });
                        
                        inserted += batch.length;
                        showLoading(`Grados: ${inserted}/${assignmentsToCreate.length} asignaciones creadas...`);
                    }
                    
                    result.created = inserted;
                }

                return result;

            } catch (error) {
                result.errors.push(`Error procesando grados: ${error.message}`);
                return result;
            }
        }

        /**
         * Renderiza los resultados de la inicializaci√≥n
         */
        function renderInitializationResults(results) {
            try {
                // Renderizar resumen general
                renderSummaryCards(results);
                
                // Renderizar detalles por categor√≠a
                renderCategoryDetails(results.processingResults);
                
                // Mostrar errores si los hay
                renderErrors(results.processingResults, results.globalErrors);
                
            } catch (error) {
                console.error('Error renderizando resultados:', error);
                showMessage('Error mostrando los resultados', 'danger');
            }
        }

        /**
         * Renderiza las tarjetas de resumen
         */
        function renderSummaryCards(results) {
            const fragment = document.createDocumentFragment();
            
            // Tarjeta de creados
            const createdCard = document.createElement('div');
            createdCard.className = 'summary-card success';
            createdCard.innerHTML = `
                <div class="summary-number" style="color: var(--success-color);">${results.totalCreated}</div>
                <div>Asignaciones Creadas</div>
            `;
            fragment.appendChild(createdCard);
            
            // Tarjeta de existentes
            const existingCard = document.createElement('div');
            existingCard.className = 'summary-card info';
            existingCard.innerHTML = `
                <div class="summary-number" style="color: var(--info-color);">${results.totalExisting}</div>
                <div>Ya Exist√≠an</div>
            `;
            fragment.appendChild(existingCard);
            
            // Tarjeta de errores
            const totalErrors = results.globalErrors.length + 
                Object.values(results.processingResults).reduce((acc, cat) => acc + (cat.errors?.length || 0), 0);
                
            const errorsCard = document.createElement('div');
            errorsCard.className = totalErrors > 0 ? 'summary-card warning' : 'summary-card success';
            errorsCard.innerHTML = `
                <div class="summary-number" style="color: ${totalErrors > 0 ? 'var(--warning-color)' : 'var(--success-color)'};">${totalErrors}</div>
                <div>${totalErrors > 0 ? 'Errores' : 'Sin Errores'}</div>
            `;
            fragment.appendChild(errorsCard);
            
            elementos.summaryGrid.innerHTML = '';
            elementos.summaryGrid.appendChild(fragment);
        }

        /**
         * Renderiza los detalles por categor√≠a
         */
        function renderCategoryDetails(processingResults) {
            const categories = [
                { key: 'secciones', name: 'Secciones', icon: 'üè¢' },
                { key: 'programas', name: 'Programas', icon: 'üìö' },
                { key: 'areas', name: '√Åreas', icon: 'üéì' },
                { key: 'grados', name: 'Grados', icon: 'üìä' }
            ];
            
            const fragment = document.createDocumentFragment();
            
            categories.forEach(category => {
                const data = processingResults[category.key] || { created: 0, existing: 0, errors: [] };
                
                const card = document.createElement('div');
                card.className = 'category-card';
                card.innerHTML = `
                    <h5>${category.icon} ${category.name}</h5>
                    <div class="category-stats">
                        <span>Creados: <strong style="color: var(--success-color);">${data.created}</strong></span>
                        <span>Existentes: <strong style="color: var(--info-color);">${data.existing}</strong></span>
                    </div>
                    <div class="category-stats">
                        <span>Errores: <strong style="color: ${data.errors.length > 0 ? 'var(--danger-color)' : 'var(--success-color)'};">${data.errors.length}</strong></span>
                        <span>Total: <strong>${data.created + data.existing}</strong></span>
                    </div>
                `;
                fragment.appendChild(card);
            });
            
            elementos.categoryGrid.innerHTML = '';
            elementos.categoryGrid.appendChild(fragment);
        }

        /**
         * Renderiza los errores encontrados
         */
        function renderErrors(processingResults, globalErrors) {
            const allErrors = [...globalErrors];
            
            // Recopilar errores de todas las categor√≠as
            Object.entries(processingResults).forEach(([category, data]) => {
                if (data.errors && data.errors.length > 0) {
                    data.errors.forEach(error => {
                        allErrors.push(`${category.charAt(0).toUpperCase() + category.slice(1)}: ${error}`);
                    });
                }
            });
            
            if (allErrors.length > 0) {
                const fragment = document.createDocumentFragment();
                
                allErrors.forEach(error => {
                    const li = document.createElement('li');
                    li.textContent = error;
                    fragment.appendChild(li);
                });
                
                elementos.errorsList.innerHTML = '';
                elementos.errorsList.appendChild(fragment);
                elementos.errorsSection.classList.add('show');
            } else {
                elementos.errorsSection.classList.remove('show');
            }
        }

        /**
         * Inicia una nueva inicializaci√≥n
         */
        function startNewInitialization() {
            // Resetear estado
            selectedYear = null;
            currentYearState = null;
            isProcessing = false;
            
            // Resetear controles
            elementos.yearSelect.value = '';
            elementos.btnVerifyState.disabled = true;
            elementos.btnInitialize.disabled = true;
            
            // Ocultar secciones
            hideAllSections();
            showNoYearMessage(true);
            
            // Limpiar mensajes
            document.getElementById('alertContainer').innerHTML = '';
            
            showMessage('Seleccione un a√±o para iniciar una nueva inicializaci√≥n', 'info');
        }

            /**
         * Escapa HTML para prevenir XSS
         */
        function escapeHtml(text) {
            if (text === null || text === undefined) {
                return '';
            }
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Formatea n√∫meros con separadores de miles
         */
        function formatNumber(number) {
            if (typeof number !== 'number') return '0';
            return number.toLocaleString('es-CO');
        }

        /**
         * Manejo de errores globales de JavaScript
         */
        window.addEventListener('error', function(e) {
            console.error('Error global capturado:', e.error);
            
            if (!isProcessing) {
                showMessage('Se ha producido un error inesperado. Por favor, recargue la p√°gina.', 'danger');
            } else {
                showMessage('Error durante el procesamiento. La operaci√≥n se ha detenido.', 'danger');
                isProcessing = false;
                hideLoading();
                
                // Rehabilitar controles
                elementos.yearSelect.disabled = false;
                elementos.btnVerifyState.disabled = false;
                elementos.btnInitialize.disabled = false;
            }
        });

        /**
         * Diagn√≥stico del estado del sistema (para desarrollo)
         */
        function diagnosticInfo() {
            console.log('=== DIAGN√ìSTICO INICIALIZACI√ìN PRESUPUESTAL ===');
            console.log('Usuario actual:', currentUser?.user_display_name || 'No autenticado');
            console.log('A√±o seleccionado:', selectedYear);
            console.log('A√±os disponibles:', yearData.length);
            console.log('Estado del a√±o actual:', currentYearState);
            console.log('Procesando:', isProcessing);
            console.log('Elementos DOM inicializados:', Object.keys(elementos).filter(key => elementos[key] !== null).length);
            console.log('===============================================');
        }

        /**
         * Funci√≥n de testing para verificar conexiones (desarrollo)
         */
        async function testConnections() {
            console.log('üß™ Probando conexiones del sistema...');
            
            try {
                // Test 1: Conexi√≥n a Supabase
                const testQuery = await supabaseRequest('/academic_years?select=year_id&limit=1');
                console.log('‚úÖ Conexi√≥n Supabase: OK');
                
                // Test 2: Verificar tablas cr√≠ticas
                const tables = [
                    '/budget_items?select=item_id&limit=1',
                    '/budget_assignments?select=assignment_id&limit=1',
                    '/sections?select=section_id&limit=1',
                    '/programs?select=program_id&limit=1',
                    '/academic_areas?select=area_id&limit=1',
                    '/grades?select=grade_id&limit=1'
                ];
                
                for (const table of tables) {
                    await supabaseRequest(table);
                }
                console.log('‚úÖ Tablas cr√≠ticas: OK');
                
                // Test 3: Verificar permisos
                if (currentUser) {
                    console.log('‚úÖ Usuario autenticado: OK');
                } else {
                    console.log('‚ö†Ô∏è Usuario no autenticado');
                }
                
                console.log('üéâ Todas las conexiones funcionan correctamente');
                showMessage('Test de conexiones exitoso', 'success');
                
            } catch (error) {
                console.error('‚ùå Error en test de conexiones:', error);
                showMessage('Error en test de conexiones: ' + error.message, 'danger');
            }
        }

        /**
         * Funci√≥n para limpiar el estado y reiniciar la p√°gina
         */
        function resetPage() {
            // Confirmar con el usuario
            const confirmed = confirm(
                'Esta acci√≥n limpiar√° todo el estado actual y recargar√° la p√°gina.\n\n' +
                '¬øEst√° seguro que desea continuar?'
            );
            
            if (confirmed) {
                // Limpiar localStorage relacionado si existe
                try {
                    // No limpiar la sesi√≥n, solo datos temporales
                    localStorage.removeItem('budgetInitState');
                    sessionStorage.clear();
                } catch (error) {
                    console.warn('No se pudo limpiar storage:', error);
                }
                
                // Recargar p√°gina
                window.location.reload();
            }
        }

        /**
         * Validaci√≥n final de integridad del sistema
         */
        function validateSystemIntegrity() {
            const issues = [];
            
            // Verificar elementos cr√≠ticos
            const criticalElements = [
                'yearSelect', 'btnVerifyState', 'btnInitialize', 
                'statusSection', 'resultsSection', 'loadingOverlay'
            ];
            
            criticalElements.forEach(elementKey => {
                if (!elementos[elementKey]) {
                    issues.push(`Elemento DOM faltante: ${elementKey}`);
                }
            });
            
            // Verificar funciones cr√≠ticas
            const criticalFunctions = [
                'validatePageAccess', 'supabaseRequest', 'showMessage', 'getStoredSession'
            ];
            
            criticalFunctions.forEach(funcName => {
                if (typeof window[funcName] !== 'function') {
                    issues.push(`Funci√≥n faltante: ${funcName}`);
                }
            });
            
            if (issues.length > 0) {
                console.error('‚ö†Ô∏è Problemas de integridad del sistema:', issues);
                showMessage('Sistema con problemas. Recargue la p√°gina.', 'danger');
                return false;
            }
            
            return true;
        }

        /**
         * Inicializaci√≥n final cuando todo est√© cargado
         */
        window.addEventListener('load', function() {
            // Verificar integridad del sistema
            if (!validateSystemIntegrity()) {
                return;
            }
            
            console.log('‚úÖ Inicializaci√≥n presupuestal cargada correctamente');
            
            // Hacer funciones disponibles globalmente para debugging
            window.diagnosticInfo = diagnosticInfo;
            window.testConnections = testConnections;
            window.resetPage = resetPage;
            
            // Mensaje de bienvenida en consola
            console.log('üè´ SchoolNet - Inicializar A√±o Presupuestal');
            console.log('üìä Funciones de desarrollo disponibles:');
            console.log('   - diagnosticInfo(): Informaci√≥n del estado actual');
            console.log('   - testConnections(): Probar conexiones del sistema');
            console.log('   - resetPage(): Limpiar estado y recargar');
        });

        /**
         * Configuraci√≥n de timeouts para operaciones largas
         */
        function setupTimeoutHandlers() {
            // Timeout warning para operaciones que toman mucho tiempo
            let operationTimeout = null;
            
            const originalShowLoading = showLoading;
            showLoading = function(message) {
                originalShowLoading(message);
                
                // Limpiar timeout anterior
                if (operationTimeout) {
                    clearTimeout(operationTimeout);
                }
                
                // Warning despu√©s de 30 segundos
                operationTimeout = setTimeout(() => {
                    elementos.loadingMessage.textContent = 'La operaci√≥n est√° tardando m√°s de lo esperado...';
                }, 30000);
                
                // Error despu√©s de 2 minutos
                setTimeout(() => {
                    if (!elementos.loadingOverlay.classList.contains('hidden')) {
                        hideLoading();
                        showMessage('La operaci√≥n ha excedido el tiempo l√≠mite. Intente nuevamente.', 'danger');
                        isProcessing = false;
                        
                        // Rehabilitar controles
                        elementos.yearSelect.disabled = false;
                        elementos.btnVerifyState.disabled = false;
                        elementos.btnInitialize.disabled = false;
                    }
                }, 120000);
            };
            
            const originalHideLoading = hideLoading;
            hideLoading = function() {
                originalHideLoading();
                if (operationTimeout) {
                    clearTimeout(operationTimeout);
                    operationTimeout = null;
                }
            };
        }

        // Configurar timeouts al cargar
        setupTimeoutHandlers();

        // Inicializar p√°gina con config.js
        if (window.SUPABASE_CONFIG) {
            initializePage('initializeBudgetYear', 'Presupuesto');
        } else {
            setTimeout(() => initializePage('initializeBudgetYear', 'Presupuesto'), 100);
        }
    </script>
</body>
</html>
