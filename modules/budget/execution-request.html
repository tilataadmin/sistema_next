<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.11.27.13.17">
    <title>Solicitud de Ejecución - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Configuración del sistema -->
    <script src="../../assets/js/config.js"></script>
    
    <style>
        .asignaciones-container {
            margin: 2rem 0;
        }
        
        .asignaciones-table {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .asignaciones-table th {
            background-color: #0d6efd;
            color: white;
            font-weight: 600;
            border: none;
        }
        
        .asignaciones-table td {
            vertical-align: middle;
            border-color: #e9ecef;
        }
        
        .asignaciones-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .btn-solicitar {
            background-color: #198754;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        .btn-solicitar:hover {
            background-color: #157347;
            transform: translateY(-1px);
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            margin: 2rem 0;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        /* Editor de texto enriquecido */
        .editor-container {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: white;
        }
        
        .editor-toolbar {
            border-bottom: 1px solid #dee2e6;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 0.375rem 0.375rem 0 0;
        }
        
        .editor-toolbar button {
            background: white;
            border: 1px solid #dee2e6;
            padding: 0.25rem 0.5rem;
            margin-right: 0.25rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .editor-toolbar button:hover {
            background-color: #e9ecef;
        }
        
        .editor-content {
            min-height: 120px;
            padding: 0.75rem;
            outline: none;
            border-radius: 0 0 0.375rem 0.375rem;
        }
        
        .editor-content:empty:before {
            content: attr(data-placeholder);
            color: #6c757d;
            font-style: italic;
        }
        
        .valor-input {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        .loading-table {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        /* Estilos para badges de estado */
        .badge-pending {
            background-color: #ffc107;
            color: #212529;
        }
        
        .badge-approved {
            background-color: #198754;
            color: white;
        }
        
        .badge-rejected {
            background-color: #dc3545;
            color: white;
        }
        
        .badge-executed {
            background-color: #0d6efd;
            color: white;
        }
        
        .badge-closed, .badge-pre-closed {
            background-color: #6c757d;
            color: white;
        }
        
        .badge-scheduled {
            background-color: #6f42c1;
            color: white;
        }
        
        /* Tabla de mis solicitudes */
        .mis-solicitudes-table {
            font-size: 0.9rem;
        }
        
        .mis-solicitudes-table th {
            background-color: #6c757d;
            color: white;
            font-weight: 600;
            border: none;
            white-space: nowrap;
        }
        
        .mis-solicitudes-table td {
            vertical-align: middle;
        }
        
        .mis-solicitudes-table .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .detalle-cell {
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .detalle-cell:hover {
            white-space: normal;
            overflow: visible;
        }
        
        /* Estilos para recurrencia */
        .recurrence-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .recurrence-preview {
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-top: 0.75rem;
        }
        
        .recurrence-preview-item {
            display: flex;
            justify-content: space-between;
            padding: 0.375rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .recurrence-preview-item:last-child {
            border-bottom: none;
        }
        
        .recurrence-preview-item .month-name {
            font-weight: 500;
        }
        
        .recurrence-preview-item .year-badge {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
        }
        
        .year-current {
            background-color: #d4edda;
            color: #155724;
        }
        
        .year-next {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .recurrence-warning {
            font-size: 0.85rem;
            color: #856404;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            margin-top: 0.75rem;
        }
        
        /* Badge de recurrencia en tabla */
        .badge-recurrence {
            background-color: #6f42c1;
            color: white;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 0.25rem;
            margin-left: 0.25rem;
        }
        
        .recurrence-group-link {
            cursor: pointer;
            text-decoration: underline;
            color: #6f42c1;
        }
        
        .recurrence-group-link:hover {
            color: #5a32a3;
        }
    </style>
</head>
<body>
    <!-- Loading overlay inicial -->
    <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background-color: rgba(255,255,255,0.9); z-index: 9999;">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mb-0">Cargando formulario...</p>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div id="mainContainer" class="container-fluid py-4 d-none">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html" class="text-decoration-none">
                        <i class="bi bi-house-fill me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="../budget/index.html" class="text-decoration-none">Presupuesto</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Solicitud de Ejecución</li>
            </ol>
        </nav>

        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex align-items-center justify-content-between flex-wrap">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-file-earmark-plus text-primary me-3" style="font-size: 2rem;"></i>
                        <div>
                            <h1 class="h3 mb-0">Solicitud de Ejecución</h1>
                            <p class="text-muted mb-0">Crear solicitudes de ejecución presupuestal para asignaciones autorizadas</p>
                        </div>
                    </div>
                    <!-- Botón para ver mis solicitudes -->
                    <button type="button" class="btn btn-outline-primary mt-2 mt-md-0" id="btnVerMisSolicitudes">
                        <i class="bi bi-list-check me-1"></i>Ver mis solicitudes
                        <span id="badgeMisSolicitudes" class="badge bg-warning text-dark ms-1 d-none">0</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Contenedor de mensajes -->
        <div id="alertContainer" class="mb-4"></div>

        <!-- Información del usuario -->
        <div id="usuarioInfo" class="alert alert-info d-none">
            <i class="bi bi-info-circle me-2"></i>
            <span id="usuarioTexto"></span>
        </div>

        <!-- Tabla de asignaciones -->
        <div class="asignaciones-container">
            <div id="tablaContainer">
                <!-- Loading state -->
                <div id="loadingTable" class="loading-table">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Cargando asignaciones...</span>
                    </div>
                    <p>Cargando asignaciones disponibles...</p>
                </div>
                
                <!-- Tabla de asignaciones -->
                <div id="tableWrapper" class="d-none">
                    <div class="table-responsive">
                        <table class="table table-hover asignaciones-table">
                            <thead>
                                <tr>
                                    <th>Sub-ítem</th>
                                    <th>Detalle de la categoría</th>
                                    <th>Autorizador</th>
                                    <th style="width: 120px;">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="asignacionesTbody">
                                <!-- Datos cargados dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Estado vacío -->
                <div id="emptyState" class="empty-state d-none">
                    <i class="bi bi-clipboard-x"></i>
                    <h4>No hay asignaciones disponibles</h4>
                    <p>No se encontraron asignaciones presupuestales donde esté autorizado como solicitante.</p>
                    <p class="text-muted">Contacte al administrador si considera que debería tener asignaciones disponibles.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de solicitud (CREAR NUEVA) -->
    <div class="modal fade" id="modalSolicitud" tabindex="-1" aria-labelledby="modalSolicitudLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalSolicitudLabel">
                        <i class="bi bi-file-earmark-plus text-primary me-2"></i>
                        Nueva Solicitud de Ejecución
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formSolicitud" novalidate>
                        <!-- Información de la asignación -->
                        <div class="alert alert-light border mb-4">
                            <h6 class="alert-heading mb-2">
                                <i class="bi bi-info-circle me-1"></i>Información de la asignación
                            </h6>
                            <p id="infoAsignacion" class="mb-0 text-muted"></p>
                        </div>

                        <!-- Campo Detalle -->
                        <div class="mb-4">
                            <label for="requestDetails" class="form-label fw-bold">
                                Detalle de la solicitud <span class="text-danger">*</span>
                            </label>
                            <div class="editor-container">
                                <div class="editor-toolbar">
                                    <button type="button" onclick="formatText('bold')" title="Negrita">
                                        <i class="bi bi-type-bold"></i>
                                    </button>
                                    <button type="button" onclick="formatText('italic')" title="Cursiva">
                                        <i class="bi bi-type-italic"></i>
                                    </button>
                                    <button type="button" onclick="formatText('underline')" title="Subrayado">
                                        <i class="bi bi-type-underline"></i>
                                    </button>
                                    <button type="button" onclick="formatText('insertUnorderedList')" title="Lista">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                </div>
                                <div id="requestDetails" class="editor-content" 
                                     contenteditable="true" 
                                     data-placeholder="Describa detalladamente el propósito y justificación de la solicitud..."></div>
                            </div>
                            <div class="form-text">Proporcione una descripción clara y detallada de la solicitud.</div>
                        </div>

                        <!-- Campo Valor -->
                        <div class="mb-4">
                            <label for="requestValue" class="form-label fw-bold">
                                Valor solicitado <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="text" id="requestValue" class="form-control valor-input" 
                                       placeholder="0" required>
                            </div>
                            <div class="form-text">Ingrese el valor en pesos colombianos sin decimales.</div>
                        </div>

                        <!-- SECCIÓN DE RECURRENCIA -->
                        <div class="recurrence-section">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="enableRecurrence" role="switch">
                                <label class="form-check-label fw-bold" for="enableRecurrence">
                                    <i class="bi bi-arrow-repeat me-1"></i>Programar recurrencia mensual
                                </label>
                            </div>
                            
                            <div id="recurrenceOptions" class="d-none">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="recurrenceMonths" class="form-label">
                                            Número de meses (incluido el actual)
                                        </label>
                                        <select id="recurrenceMonths" class="form-select">
                                            <option value="2">2 meses</option>
                                            <option value="3">3 meses</option>
                                            <option value="4">4 meses</option>
                                            <option value="5">5 meses</option>
                                            <option value="6">6 meses</option>
                                            <option value="7">7 meses</option>
                                            <option value="8">8 meses</option>
                                            <option value="9">9 meses</option>
                                            <option value="10">10 meses</option>
                                            <option value="11">11 meses</option>
                                            <option value="12" selected>12 meses</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Valor total programado</label>
                                        <div class="form-control bg-light" id="totalRecurrenceValue">$0</div>
                                    </div>
                                </div>
                                
                                <div id="recurrencePreview" class="recurrence-preview mt-3">
                                    <!-- Se llena dinámicamente -->
                                </div>
                                
                                <div id="recurrenceWarning" class="recurrence-warning d-none">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    <span id="recurrenceWarningText"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Campos ocultos -->
                        <input type="hidden" id="hiddenAssignmentId">
                        <input type="hidden" id="hiddenAutorizadorEmail">
                        <input type="hidden" id="hiddenSubItemName">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="button" id="btnGuardarSolicitud" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Crear Solicitud
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de MIS SOLICITUDES -->
    <div class="modal fade" id="modalMisSolicitudes" tabindex="-1" aria-labelledby="modalMisSolicitudesLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMisSolicitudesLabel">
                        <i class="bi bi-list-check text-primary me-2"></i>
                        Mis Solicitudes de Ejecución
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading state -->
                    <div id="loadingMisSolicitudes" class="text-center py-4">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="text-muted">Cargando solicitudes...</p>
                    </div>
                    
                    <!-- Tabla de mis solicitudes -->
                    <div id="tablaMisSolicitudesWrapper" class="d-none">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mis-solicitudes-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Sub-ítem</th>
                                        <th>Detalle</th>
                                        <th class="text-end">Valor</th>
                                        <th class="text-center">Estado</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="misSolicitudesTbody">
                                    <!-- Datos cargados dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Estado vacío -->
                    <div id="emptyStateMisSolicitudes" class="text-center py-4 d-none">
                        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-muted">No tiene solicitudes registradas</h5>
                        <p class="text-muted">Las solicitudes que cree aparecerán aquí.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de EDITAR SOLICITUD -->
    <div class="modal fade" id="modalEditarSolicitud" tabindex="-1" aria-labelledby="modalEditarSolicitudLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarSolicitudLabel">
                        <i class="bi bi-pencil-square text-warning me-2"></i>
                        Editar Solicitud
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarSolicitud" novalidate>
                        <!-- Información de la solicitud -->
                        <div class="alert alert-light border mb-4">
                            <h6 class="alert-heading mb-2">
                                <i class="bi bi-info-circle me-1"></i>Información de la solicitud
                            </h6>
                            <p id="infoSolicitudEditar" class="mb-0 text-muted"></p>
                        </div>

                        <!-- Campo Detalle -->
                        <div class="mb-4">
                            <label for="editRequestDetails" class="form-label fw-bold">
                                Detalle de la solicitud <span class="text-danger">*</span>
                            </label>
                            <div class="editor-container">
                                <div class="editor-toolbar">
                                    <button type="button" onclick="formatTextEdit('bold')" title="Negrita">
                                        <i class="bi bi-type-bold"></i>
                                    </button>
                                    <button type="button" onclick="formatTextEdit('italic')" title="Cursiva">
                                        <i class="bi bi-type-italic"></i>
                                    </button>
                                    <button type="button" onclick="formatTextEdit('underline')" title="Subrayado">
                                        <i class="bi bi-type-underline"></i>
                                    </button>
                                    <button type="button" onclick="formatTextEdit('insertUnorderedList')" title="Lista">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                </div>
                                <div id="editRequestDetails" class="editor-content" 
                                     contenteditable="true" 
                                     data-placeholder="Describa detalladamente el propósito y justificación de la solicitud..."></div>
                            </div>
                        </div>

                        <!-- Campo Valor -->
                        <div class="mb-4">
                            <label for="editRequestValue" class="form-label fw-bold">
                                Valor solicitado <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="text" id="editRequestValue" class="form-control valor-input" 
                                       placeholder="0" required>
                            </div>
                        </div>

                        <!-- Campo oculto para ID de solicitud -->
                        <input type="hidden" id="hiddenRequestId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="button" id="btnActualizarSolicitud" class="btn btn-warning">
                        <i class="bi bi-check-circle me-1"></i>Actualizar Solicitud
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de VER GRUPO DE RECURRENCIA -->
    <div class="modal fade" id="modalVerRecurrencia" tabindex="-1" aria-labelledby="modalVerRecurrenciaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="modalVerRecurrenciaLabel">
                        <i class="bi bi-arrow-repeat text-purple me-2"></i>
                        Grupo de Recurrencia
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="loadingRecurrencia" class="text-center py-4">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <p class="text-muted">Cargando información...</p>
                    </div>
                    
                    <div id="contenidoRecurrencia" class="d-none">
                        <!-- Info del grupo -->
                        <div class="alert alert-light border mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Sub-ítem:</strong> <span id="recGrupoSubitem">-</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Total programado:</strong> <span id="recGrupoTotal">-</span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <strong>Ocurrencias:</strong> <span id="recGrupoOcurrencias">-</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Estado:</strong> <span id="recGrupoEstado">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabla de solicitudes del grupo -->
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mes Programado</th>
                                        <th class="text-end">Valor</th>
                                        <th class="text-center">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaRecurrenciaBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger d-none" id="btnCancelarRecurrencia">
                        <i class="bi bi-x-octagon me-1"></i>Cancelar Solicitudes Pendientes
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript del formulario -->
    <script>
        // Verificar acceso y cargar página
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Validar acceso antes de cargar
                const hasAccess = await validatePageAccess('Solicitud de ejecución');
                if (!hasAccess) {
                    return;
                }
                
                // Inicializar página
                initializePage('executionRequest', 'Presupuesto');
                
                // Cargar datos iniciales
                await cargarDatosIniciales();
                
            } catch (error) {
                console.error('Error al inicializar página:', error);
                showMessage('Error al cargar la página: ' + error.message, 'danger');
                ocultarLoading();
            }
        });

        // ===== VARIABLES GLOBALES =====
        let asignacionesData = [];
        let misSolicitudesData = [];
        let currentWorkerId = null;
        let currentWorkerEmail = null;
        let modalSolicitud;
        let modalMisSolicitudes;
        let modalEditarSolicitud;
        let modalVerRecurrencia;
        
        // Variables para recurrencia
        let academicYearsData = [];
        let currentBudgetYearId = null;
        let currentBudgetYear = null;

        // ===== ELEMENTOS DEL DOM =====
        const elementos = {
            loadingOverlay: document.getElementById('loadingOverlay'),
            mainContainer: document.getElementById('mainContainer'),
            alertContainer: document.getElementById('alertContainer'),
            usuarioInfo: document.getElementById('usuarioInfo'),
            usuarioTexto: document.getElementById('usuarioTexto'),
            tablaContainer: document.getElementById('tablaContainer'),
            loadingTable: document.getElementById('loadingTable'),
            tableWrapper: document.getElementById('tableWrapper'),
            asignacionesTbody: document.getElementById('asignacionesTbody'),
            emptyState: document.getElementById('emptyState'),
            modalSolicitud: document.getElementById('modalSolicitud'),
            formSolicitud: document.getElementById('formSolicitud'),
            infoAsignacion: document.getElementById('infoAsignacion'),
            requestDetails: document.getElementById('requestDetails'),
            requestValue: document.getElementById('requestValue'),
            hiddenAssignmentId: document.getElementById('hiddenAssignmentId'),
            hiddenAutorizadorEmail: document.getElementById('hiddenAutorizadorEmail'),
            hiddenSubItemName: document.getElementById('hiddenSubItemName'),
            btnGuardarSolicitud: document.getElementById('btnGuardarSolicitud'),
            // Elementos para mis solicitudes
            btnVerMisSolicitudes: document.getElementById('btnVerMisSolicitudes'),
            badgeMisSolicitudes: document.getElementById('badgeMisSolicitudes'),
            modalMisSolicitudes: document.getElementById('modalMisSolicitudes'),
            loadingMisSolicitudes: document.getElementById('loadingMisSolicitudes'),
            tablaMisSolicitudesWrapper: document.getElementById('tablaMisSolicitudesWrapper'),
            misSolicitudesTbody: document.getElementById('misSolicitudesTbody'),
            emptyStateMisSolicitudes: document.getElementById('emptyStateMisSolicitudes'),
            // Elementos para editar solicitud
            modalEditarSolicitud: document.getElementById('modalEditarSolicitud'),
            formEditarSolicitud: document.getElementById('formEditarSolicitud'),
            infoSolicitudEditar: document.getElementById('infoSolicitudEditar'),
            editRequestDetails: document.getElementById('editRequestDetails'),
            editRequestValue: document.getElementById('editRequestValue'),
            hiddenRequestId: document.getElementById('hiddenRequestId'),
            btnActualizarSolicitud: document.getElementById('btnActualizarSolicitud'),
            // Elementos para recurrencia
            enableRecurrence: document.getElementById('enableRecurrence'),
            recurrenceOptions: document.getElementById('recurrenceOptions'),
            recurrenceMonths: document.getElementById('recurrenceMonths'),
            recurrencePreview: document.getElementById('recurrencePreview'),
            recurrenceWarning: document.getElementById('recurrenceWarning'),
            recurrenceWarningText: document.getElementById('recurrenceWarningText'),
            totalRecurrenceValue: document.getElementById('totalRecurrenceValue')
        };

        // ===== NOMBRES DE MESES =====
        const MESES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        // ===== CARGA DE DATOS =====
        async function cargarDatosIniciales() {
            try {
                showMessage('Cargando datos del formulario...', 'info');
                
                // Obtener worker_id del usuario actual
                await obtenerWorkerIdUsuario();
                
                // Cargar configuración del año presupuestal
                await cargarConfiguracionPresupuestal();
                
                // Cargar asignaciones disponibles
                await cargarAsignacionesDisponibles();
                
                // Cargar mis solicitudes (para el badge)
                await cargarMisSolicitudes(false);
                
                // Configurar event listeners
                configurarEventListeners();
                
                // Mostrar formulario
                mostrarFormularioPrincipal();
                
            } catch (error) {
                console.error('Error al cargar datos iniciales:', error);
                showMessage('Error al cargar los datos: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        async function obtenerWorkerIdUsuario() {
            const session = getStoredSession();
            if (!session || !session.user || !session.user.user_mail) {
                throw new Error('No se pudo obtener el email del usuario actual');
            }

            const userEmail = session.user.user_mail;
            
            // Buscar worker_id por email
            const query = `workers?select=worker_id,worker_first_name,worker_last_name_1,worker_last_name_2,email&email=eq.${userEmail}&worker_status=eq.active`;
            const data = await supabaseRequest('/' + query);
            
            if (data.length === 0) {
                throw new Error('No se encontró un trabajador activo asociado a su cuenta');
            }
            
            const worker = data[0];
            currentWorkerId = worker.worker_id;
            currentWorkerEmail = worker.email;
            
            // Mostrar información del usuario
            const nombreCompleto = construirNombreCompleto(worker);
            elementos.usuarioTexto.textContent = `Usuario: ${nombreCompleto} (${userEmail})`;
            elementos.usuarioInfo.classList.remove('d-none');
        }

        async function cargarConfiguracionPresupuestal() {
            // Obtener año presupuestal activo
            const configQuery = 'system_config?select=current_budget_year_id&limit=1';
            const configData = await supabaseRequest('/' + configQuery);
            
            if (configData.length === 0 || !configData[0].current_budget_year_id) {
                throw new Error('No hay año presupuestal activo configurado');
            }
            
            currentBudgetYearId = configData[0].current_budget_year_id;
            
            // Obtener información del año actual y todos los años
            const yearsQuery = `academic_years?select=year_id,year_name,start_month,start_year,end_month,end_year,year_order&year_status=eq.active&order=year_order.asc`;
            academicYearsData = await supabaseRequest('/' + yearsQuery);
            
            // Encontrar el año actual
            currentBudgetYear = academicYearsData.find(y => y.year_id === currentBudgetYearId);
            
            if (!currentBudgetYear) {
                throw new Error('No se encontró información del año presupuestal actual');
            }
            
            console.log('✅ Año presupuestal actual:', currentBudgetYear.year_name);
        }

        async function cargarAsignacionesDisponibles() {
            if (!currentWorkerId) {
                throw new Error('Worker ID no disponible');
            }

            // Consultar asignaciones donde el usuario está autorizado como solicitante
            const query = `budget_requesters?select=assignment_id,budget_assignments(assignment_id,assignment_category,category_detail,worker_email,budget_items(item_name))&worker_id=eq.${currentWorkerId}&budget_assignments.academic_year_id=eq.${currentBudgetYearId}`;
            
            const data = await supabaseRequest('/' + query);
            
            // Procesar datos
            asignacionesData = data
                .filter(item => item.budget_assignments)
                .map(item => {
                    const assignment = item.budget_assignments;
                    return {
                        assignment_id: item.assignment_id,
                        item_name: assignment.budget_items?.item_name || 'Sin nombre',
                        assignment_category: assignment.assignment_category || '',
                        category_detail: assignment.category_detail || '',
                        autorizador_email: assignment.worker_email || '',
                        display_category: assignment.category_detail && assignment.category_detail !== assignment.assignment_category
                            ? assignment.category_detail
                            : assignment.assignment_category
                    };
                });
            
            // Ordenar por nombre del sub-ítem
            asignacionesData.sort((a, b) => a.item_name.localeCompare(b.item_name));
            
            renderizarAsignaciones();
        }

        // ===== CARGAR MIS SOLICITUDES =====
        async function cargarMisSolicitudes(mostrarMensaje = true) {
            if (!currentWorkerId) {
                console.warn('Worker ID no disponible para cargar solicitudes');
                return;
            }

            try {
                // Consultar solicitudes del usuario actual con información de la asignación y recurrencia
                const query = `execution_requests?select=request_id,assignment_id,requested_value,request_details,request_status,requested_at,responded_at,scheduled_date,is_recurring,recurrence_group_id,budget_assignments(assignment_category,category_detail,budget_items(item_name))&worker_id=eq.${currentWorkerId}&order=requested_at.desc`;
                
                const data = await supabaseRequest('/' + query);
                
                misSolicitudesData = data.map(item => {
                    const assignment = item.budget_assignments;
                    return {
                        request_id: item.request_id,
                        assignment_id: item.assignment_id,
                        requested_value: item.requested_value,
                        request_details: item.request_details,
                        request_status: item.request_status,
                        requested_at: item.requested_at,
                        responded_at: item.responded_at,
                        scheduled_date: item.scheduled_date,
                        is_recurring: item.is_recurring,
                        recurrence_group_id: item.recurrence_group_id,
                        item_name: assignment?.budget_items?.item_name || 'Sin nombre',
                        category_detail: assignment?.category_detail || assignment?.assignment_category || ''
                    };
                });
                
                // Actualizar badge con cantidad de solicitudes pendientes
                const pendientes = misSolicitudesData.filter(s => s.request_status === 'pending').length;
                if (pendientes > 0) {
                    elementos.badgeMisSolicitudes.textContent = pendientes;
                    elementos.badgeMisSolicitudes.classList.remove('d-none');
                } else {
                    elementos.badgeMisSolicitudes.classList.add('d-none');
                }
                
            } catch (error) {
                console.error('Error al cargar mis solicitudes:', error);
                if (mostrarMensaje) {
                    showMessage('Error al cargar sus solicitudes: ' + error.message, 'danger');
                }
            }
        }

        // ===== RENDERIZADO DE TABLAS =====
        function renderizarAsignaciones() {
            elementos.loadingTable.classList.add('d-none');
            
            if (!asignacionesData || asignacionesData.length === 0) {
                elementos.tableWrapper.classList.add('d-none');
                elementos.emptyState.classList.remove('d-none');
                showMessage('No se encontraron asignaciones donde esté autorizado como solicitante', 'warning');
                return;
            }

            const fragment = document.createDocumentFragment();
            
            asignacionesData.forEach((asignacion, index) => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>
                        <strong>${escapeHtml(asignacion.item_name)}</strong>
                    </td>
                    <td>${escapeHtml(asignacion.display_category)}</td>
                    <td>
                        <small class="text-muted">${escapeHtml(asignacion.autorizador_email)}</small>
                    </td>
                    <td>
                        <button class="btn btn-solicitar btn-sm" 
                                data-assignment-id="${asignacion.assignment_id}"
                                data-autorizador-email="${escapeHtml(asignacion.autorizador_email)}"
                                data-sub-item-name="${escapeHtml(asignacion.item_name)}"
                                data-category-detail="${escapeHtml(asignacion.display_category)}">
                            <i class="bi bi-plus-circle me-1"></i>Solicitar
                        </button>
                    </td>
                `;
                
                const botonSolicitar = tr.querySelector('.btn-solicitar');
                botonSolicitar.addEventListener('click', function() {
                    const assignmentId = this.dataset.assignmentId;
                    const autorizadorEmail = this.dataset.autorizadorEmail;
                    const subItemName = this.dataset.subItemName;
                    const categoryDetail = this.dataset.categoryDetail;
                    
                    abrirModalSolicitud(assignmentId, autorizadorEmail, subItemName, categoryDetail);
                });
                
                fragment.appendChild(tr);
            });
            
            elementos.asignacionesTbody.innerHTML = '';
            elementos.asignacionesTbody.appendChild(fragment);
            
            elementos.tableWrapper.classList.remove('d-none');
            elementos.emptyState.classList.add('d-none');
            
            showMessage(`Se encontraron ${asignacionesData.length} asignaciones disponibles para solicitud`, 'success');
        }

        function renderizarMisSolicitudes() {
            elementos.loadingMisSolicitudes.classList.add('d-none');
            
            if (!misSolicitudesData || misSolicitudesData.length === 0) {
                elementos.tablaMisSolicitudesWrapper.classList.add('d-none');
                elementos.emptyStateMisSolicitudes.classList.remove('d-none');
                return;
            }

            const fragment = document.createDocumentFragment();
            
            misSolicitudesData.forEach(solicitud => {
                const tr = document.createElement('tr');
                
                // Determinar fecha a mostrar
                let fechaMostrar;
                if (solicitud.scheduled_date) {
                    const fechaProg = new Date(solicitud.scheduled_date + 'T00:00:00');
                    fechaMostrar = MESES[fechaProg.getMonth()] + ' ' + fechaProg.getFullYear();
                } else {
                    fechaMostrar = new Date(solicitud.requested_at).toLocaleDateString('es-CO');
                }
                
                const valorFormateado = new Intl.NumberFormat('es-CO').format(solicitud.requested_value);
                const estadoBadge = obtenerBadgeEstado(solicitud.request_status);
                const puedeEditar = solicitud.request_status === 'pending';
                
                // Limpiar HTML del detalle
                const detalleTexto = solicitud.request_details.replace(/<[^>]*>/g, '').substring(0, 100);
                
                // Badge de recurrencia
                const recurrenceBadge = solicitud.is_recurring 
                    ? `<span class="badge-recurrence" title="Solicitud recurrente" 
                         onclick="verGrupoRecurrencia('${solicitud.recurrence_group_id}')" 
                         style="cursor: pointer;">
                         <i class="bi bi-arrow-repeat"></i>
                       </span>` 
                    : '';
                
                tr.innerHTML = `
                    <td><small>${fechaMostrar}</small>${recurrenceBadge}</td>
                    <td><strong>${escapeHtml(solicitud.item_name)}</strong></td>
                    <td class="detalle-cell" title="${escapeHtml(detalleTexto)}">
                        ${escapeHtml(detalleTexto)}${solicitud.request_details.length > 100 ? '...' : ''}
                    </td>
                    <td class="text-end"><strong>$${valorFormateado}</strong></td>
                    <td class="text-center">${estadoBadge}</td>
                    <td class="text-center">
                        ${puedeEditar ? `
                            <button class="btn btn-outline-warning btn-sm btn-editar-solicitud" 
                                    data-request-id="${solicitud.request_id}"
                                    title="Editar solicitud">
                                <i class="bi bi-pencil"></i>
                            </button>
                        ` : `
                            <span class="text-muted" title="Solo puede editar solicitudes pendientes">
                                <i class="bi bi-lock"></i>
                            </span>
                        `}
                    </td>
                `;
                
                const botonEditar = tr.querySelector('.btn-editar-solicitud');
                if (botonEditar) {
                    botonEditar.addEventListener('click', function() {
                        const requestId = this.dataset.requestId;
                        abrirModalEditarSolicitud(requestId);
                    });
                }
                
                fragment.appendChild(tr);
            });
            
            elementos.misSolicitudesTbody.innerHTML = '';
            elementos.misSolicitudesTbody.appendChild(fragment);
            
            elementos.tablaMisSolicitudesWrapper.classList.remove('d-none');
            elementos.emptyStateMisSolicitudes.classList.add('d-none');
        }

        function obtenerBadgeEstado(status) {
            const estados = {
                'pending': { clase: 'badge-pending', texto: 'Pendiente' },
                'approved': { clase: 'badge-approved', texto: 'Aprobada' },
                'rejected': { clase: 'badge-rejected', texto: 'Rechazada' },
                'executed': { clase: 'badge-executed', texto: 'Ejecutada' },
                'closed': { clase: 'badge-closed', texto: 'Cerrada' },
                'pre-closed': { clase: 'badge-pre-closed', texto: 'Pre-cerrada' },
                'scheduled': { clase: 'badge-scheduled', texto: 'Programada' }
            };
            
            const estado = estados[status] || { clase: 'bg-secondary', texto: status };
            return `<span class="badge ${estado.clase}">${estado.texto}</span>`;
        }

        // ===== EVENT LISTENERS =====
        function configurarEventListeners() {
            // Inicializar modales de Bootstrap
            modalSolicitud = new bootstrap.Modal(elementos.modalSolicitud);
            modalMisSolicitudes = new bootstrap.Modal(elementos.modalMisSolicitudes);
            modalEditarSolicitud = new bootstrap.Modal(elementos.modalEditarSolicitud);
            modalVerRecurrencia = new bootstrap.Modal(document.getElementById('modalVerRecurrencia'));
            
            // Formateo automático del campo valor (crear solicitud)
            elementos.requestValue.addEventListener('input', function(e) {
                formatearValor(e);
                actualizarPreviewRecurrencia();
            });
            elementos.requestValue.addEventListener('keypress', validarSoloNumeros);
            
            // Formateo automático del campo valor (editar solicitud)
            elementos.editRequestValue.addEventListener('input', formatearValor);
            elementos.editRequestValue.addEventListener('keypress', validarSoloNumeros);
            
            // Botón guardar solicitud
            elementos.btnGuardarSolicitud.addEventListener('click', guardarSolicitud);
            
            // Botón actualizar solicitud
            elementos.btnActualizarSolicitud.addEventListener('click', actualizarSolicitud);
            
            // Botón ver mis solicitudes
            elementos.btnVerMisSolicitudes.addEventListener('click', abrirModalMisSolicitudes);
            
            // Toggle de recurrencia
            elementos.enableRecurrence.addEventListener('change', function() {
                if (this.checked) {
                    elementos.recurrenceOptions.classList.remove('d-none');
                    actualizarPreviewRecurrencia();
                } else {
                    elementos.recurrenceOptions.classList.add('d-none');
                }
            });
            
            // Cambio en número de meses
            elementos.recurrenceMonths.addEventListener('change', actualizarPreviewRecurrencia);
            
            // Validación de formulario al cerrar modal
            elementos.modalSolicitud.addEventListener('hidden.bs.modal', function() {
                limpiarFormularioModal();
            });
            
            elementos.modalEditarSolicitud.addEventListener('hidden.bs.modal', function() {
                limpiarFormularioEditarModal();
            });
            
            // Prevenir pérdida de datos
            window.addEventListener('beforeunload', function(e) {
                if (hayDatosEnModal()) {
                    e.preventDefault();
                    e.returnValue = 'Tiene cambios sin guardar. ¿Está seguro de que desea salir?';
                }
            });
        }

        // ===== LÓGICA DE RECURRENCIA =====
        function calcularMesesRecurrencia(numMeses) {
            const meses = [];
            const ahora = new Date();
            let mesActual = ahora.getMonth(); // 0-11
            let anioActual = ahora.getFullYear();
            
            for (let i = 0; i < numMeses; i++) {
                const mes = (mesActual + i) % 12;
                const anio = anioActual + Math.floor((mesActual + i) / 12);
                
                // Determinar a qué año académico pertenece este mes
                const yearAcademico = determinarAnioAcademico(mes + 1, anio);
                
                meses.push({
                    mes: mes,
                    anio: anio,
                    nombreMes: MESES[mes],
                    yearAcademico: yearAcademico,
                    esAnioActual: yearAcademico?.year_id === currentBudgetYearId,
                    primerDiaMes: `${anio}-${String(mes + 1).padStart(2, '0')}-01`
                });
            }
            
            return meses;
        }

        function determinarAnioAcademico(mes, anio) {
            // Buscar el año académico que contiene este mes/año
            // Los años académicos van de agosto a julio típicamente
            
            for (const year of academicYearsData) {
                const inicioMes = year.start_month;
                const inicioAnio = year.start_year;
                const finMes = year.end_month;
                const finAnio = year.end_year;
                
                // Crear fechas para comparar
                const fechaConsulta = new Date(anio, mes - 1, 15);
                const fechaInicio = new Date(inicioAnio, inicioMes - 1, 1);
                const fechaFin = new Date(finAnio, finMes - 1, 28);
                
                if (fechaConsulta >= fechaInicio && fechaConsulta <= fechaFin) {
                    return year;
                }
            }
            
            return null;
        }

        function actualizarPreviewRecurrencia() {
            if (!elementos.enableRecurrence.checked) return;
            
            const numMeses = parseInt(elementos.recurrenceMonths.value);
            const valorTexto = elementos.requestValue.value.replace(/[,.]/g, '');
            const valor = parseInt(valorTexto) || 0;
            
            // Calcular meses
            const meses = calcularMesesRecurrencia(numMeses);
            
            // Actualizar valor total
            const valorTotal = valor * numMeses;
            elementos.totalRecurrenceValue.textContent = '$' + new Intl.NumberFormat('es-CO').format(valorTotal);
            
            // Renderizar preview
            let html = '';
            let mesesSinAsignacion = [];
            
            meses.forEach((m, index) => {
                const yearBadgeClass = m.esAnioActual ? 'year-current' : 'year-next';
                const yearBadgeText = m.yearAcademico ? m.yearAcademico.year_name : 'Sin año';
                
                if (!m.yearAcademico) {
                    mesesSinAsignacion.push(`${m.nombreMes} ${m.anio}`);
                }
                
                html += `
                    <div class="recurrence-preview-item">
                        <span class="month-name">
                            ${index + 1}. ${m.nombreMes} ${m.anio}
                        </span>
                        <span class="year-badge ${yearBadgeClass}">${yearBadgeText}</span>
                    </div>
                `;
            });
            
            elementos.recurrencePreview.innerHTML = html;
            
            // Mostrar advertencia si hay meses sin año académico
            if (mesesSinAsignacion.length > 0) {
                elementos.recurrenceWarningText.textContent = 
                    `Los siguientes meses no tienen año académico configurado y no se crearán solicitudes: ${mesesSinAsignacion.join(', ')}`;
                elementos.recurrenceWarning.classList.remove('d-none');
            } else {
                elementos.recurrenceWarning.classList.add('d-none');
            }
        }

        // ===== MODAL DE SOLICITUD (CREAR) =====
        function abrirModalSolicitud(assignmentId, autorizadorEmail, subItemName, categoryDetail) {
            limpiarFormularioModal();
            
            elementos.hiddenAssignmentId.value = assignmentId;
            elementos.hiddenAutorizadorEmail.value = autorizadorEmail;
            elementos.hiddenSubItemName.value = subItemName;
            
            elementos.infoAsignacion.innerHTML = `
                <strong>Sub-ítem:</strong> ${escapeHtml(subItemName)}<br>
                <strong>Categoría:</strong> ${escapeHtml(categoryDetail)}<br>
                <strong>Autorizador:</strong> ${escapeHtml(autorizadorEmail)}
            `;
            
            modalSolicitud.show();
            
            elementos.modalSolicitud.addEventListener('shown.bs.modal', function() {
                elementos.requestDetails.focus();
            }, { once: true });
        }

        function limpiarFormularioModal() {
            elementos.requestDetails.innerHTML = '';
            elementos.requestValue.value = '';
            elementos.hiddenAssignmentId.value = '';
            elementos.hiddenAutorizadorEmail.value = '';
            elementos.hiddenSubItemName.value = '';
            elementos.infoAsignacion.innerHTML = '';
            
            // Limpiar recurrencia
            elementos.enableRecurrence.checked = false;
            elementos.recurrenceOptions.classList.add('d-none');
            elementos.recurrenceMonths.value = '12';
            elementos.recurrencePreview.innerHTML = '';
            elementos.recurrenceWarning.classList.add('d-none');
            elementos.totalRecurrenceValue.textContent = '$0';
            
            elementos.formSolicitud.classList.remove('was-validated');
        }

        function hayDatosEnModal() {
            const detalle = elementos.requestDetails.innerHTML.trim();
            const valor = elementos.requestValue.value.trim();
            return detalle !== '' || valor !== '';
        }

        // ===== MODAL DE MIS SOLICITUDES =====
        async function abrirModalMisSolicitudes() {
            elementos.loadingMisSolicitudes.classList.remove('d-none');
            elementos.tablaMisSolicitudesWrapper.classList.add('d-none');
            elementos.emptyStateMisSolicitudes.classList.add('d-none');
            
            modalMisSolicitudes.show();
            
            await cargarMisSolicitudes(true);
            renderizarMisSolicitudes();
        }

        // ===== MODAL DE EDITAR SOLICITUD =====
        function abrirModalEditarSolicitud(requestId) {
            const solicitud = misSolicitudesData.find(s => s.request_id === requestId);
            
            if (!solicitud) {
                showMessage('No se encontró la solicitud', 'danger');
                return;
            }
            
            if (solicitud.request_status !== 'pending') {
                showMessage('Solo puede editar solicitudes en estado pendiente', 'warning');
                return;
            }
            
            limpiarFormularioEditarModal();
            
            elementos.hiddenRequestId.value = solicitud.request_id;
            elementos.editRequestDetails.innerHTML = solicitud.request_details;
            elementos.editRequestValue.value = new Intl.NumberFormat('es-CO').format(solicitud.requested_value);
            
            const fecha = solicitud.scheduled_date 
                ? MESES[new Date(solicitud.scheduled_date + 'T00:00:00').getMonth()] + ' ' + new Date(solicitud.scheduled_date + 'T00:00:00').getFullYear()
                : new Date(solicitud.requested_at).toLocaleDateString('es-CO');
            
            elementos.infoSolicitudEditar.innerHTML = `
                <strong>Sub-ítem:</strong> ${escapeHtml(solicitud.item_name)}<br>
                <strong>Categoría:</strong> ${escapeHtml(solicitud.category_detail)}<br>
                <strong>Fecha:</strong> ${fecha}
                ${solicitud.is_recurring ? '<br><span class="badge bg-purple">Solicitud recurrente</span>' : ''}
            `;
            
            modalMisSolicitudes.hide();
            
            setTimeout(() => {
                modalEditarSolicitud.show();
            }, 300);
        }

        function limpiarFormularioEditarModal() {
            elementos.editRequestDetails.innerHTML = '';
            elementos.editRequestValue.value = '';
            elementos.hiddenRequestId.value = '';
            elementos.infoSolicitudEditar.innerHTML = '';
            elementos.formEditarSolicitud.classList.remove('was-validated');
        }

        // ===== VER GRUPO DE RECURRENCIA =====
        async function verGrupoRecurrencia(recurrenceGroupId) {
            if (!recurrenceGroupId) return;
            
            // Mostrar modal con loading
            document.getElementById('loadingRecurrencia').classList.remove('d-none');
            document.getElementById('contenidoRecurrencia').classList.add('d-none');
            
            modalVerRecurrencia.show();
            
            try {
                // Cargar información del grupo
                const grupoQuery = `recurrence_groups?select=*&recurrence_id=eq.${recurrenceGroupId}`;
                const grupoData = await supabaseRequest('/' + grupoQuery);
                
                if (grupoData.length === 0) {
                    showMessage('No se encontró el grupo de recurrencia', 'warning');
                    modalVerRecurrencia.hide();
                    return;
                }
                
                const grupo = grupoData[0];
                
                // Cargar solicitudes del grupo
                const solicitudesQuery = `execution_requests?select=request_id,scheduled_date,requested_value,request_status&recurrence_group_id=eq.${recurrenceGroupId}&order=scheduled_date.asc`;
                const solicitudesData = await supabaseRequest('/' + solicitudesQuery);
                
                // Calcular totales
                const totalValor = solicitudesData.reduce((sum, s) => sum + (s.requested_value || 0), 0);
                const pendientes = solicitudesData.filter(s => s.request_status === 'pending').length;
                
                // Actualizar UI
                document.getElementById('recGrupoSubitem').textContent = '-'; // TODO: Obtener nombre
                document.getElementById('recGrupoTotal').textContent = '$' + new Intl.NumberFormat('es-CO').format(totalValor);
                document.getElementById('recGrupoOcurrencias').textContent = `${solicitudesData.length} de ${grupo.total_occurrences}`;
                document.getElementById('recGrupoEstado').innerHTML = obtenerBadgeEstado(grupo.recurrence_status === 'active' ? 'pending' : grupo.recurrence_status);
                
                // Renderizar tabla
                let html = '';
                solicitudesData.forEach(sol => {
                    const fecha = new Date(sol.scheduled_date + 'T00:00:00');
                    const mesNombre = MESES[fecha.getMonth()] + ' ' + fecha.getFullYear();
                    const valorFormateado = '$' + new Intl.NumberFormat('es-CO').format(sol.requested_value);
                    
                    html += `
                        <tr>
                            <td>${mesNombre}</td>
                            <td class="text-end">${valorFormateado}</td>
                            <td class="text-center">${obtenerBadgeEstado(sol.request_status)}</td>
                        </tr>
                    `;
                });
                
                document.getElementById('tablaRecurrenciaBody').innerHTML = html;
                
                // Mostrar botón de cancelar si hay pendientes
                const btnCancelar = document.getElementById('btnCancelarRecurrencia');
                if (pendientes > 0 && grupo.recurrence_status === 'active') {
                    btnCancelar.classList.remove('d-none');
                    btnCancelar.onclick = () => cancelarRecurrenciaPendiente(recurrenceGroupId);
                } else {
                    btnCancelar.classList.add('d-none');
                }
                
                // Ocultar loading y mostrar contenido
                document.getElementById('loadingRecurrencia').classList.add('d-none');
                document.getElementById('contenidoRecurrencia').classList.remove('d-none');
                
            } catch (error) {
                console.error('Error cargando grupo de recurrencia:', error);
                showMessage('Error al cargar la información: ' + error.message, 'danger');
                modalVerRecurrencia.hide();
            }
        }

        async function cancelarRecurrenciaPendiente(recurrenceGroupId) {
            if (!confirm('¿Está seguro de cancelar todas las solicitudes pendientes de esta recurrencia?')) {
                return;
            }
            
            try {
                // Actualizar solicitudes pendientes a rechazadas
                const updateQuery = `execution_requests?recurrence_group_id=eq.${recurrenceGroupId}&request_status=eq.pending`;
                await supabaseRequest('/' + updateQuery, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        request_status: 'rejected',
                        updated_at: new Date().toISOString()
                    })
                });
                
                // Actualizar estado del grupo
                const grupoQuery = `recurrence_groups?recurrence_id=eq.${recurrenceGroupId}`;
                await supabaseRequest('/' + grupoQuery, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        recurrence_status: 'cancelled',
                        cancelled_at: new Date().toISOString()
                    })
                });
                
                showMessage('Solicitudes pendientes canceladas exitosamente', 'success');
                modalVerRecurrencia.hide();
                
                // Recargar mis solicitudes
                await cargarMisSolicitudes(false);
                
            } catch (error) {
                console.error('Error cancelando recurrencia:', error);
                showMessage('Error al cancelar: ' + error.message, 'danger');
            }
        }

        // ===== GUARDADO DE SOLICITUD =====
        async function guardarSolicitud() {
            try {
                // Validar campos obligatorios
                const detalle = elementos.requestDetails.innerHTML.trim();
                const valorTexto = elementos.requestValue.value.replace(/[,.]/g, '');
                
                if (!detalle || detalle === '') {
                    showMessage('El campo "Detalle" es obligatorio', 'warning');
                    elementos.requestDetails.focus();
                    return;
                }
                
                if (!valorTexto || isNaN(valorTexto) || parseInt(valorTexto) <= 0) {
                    showMessage('El campo "Valor" debe ser un número mayor a cero', 'warning');
                    elementos.requestValue.focus();
                    return;
                }
                
                const valor = parseInt(valorTexto);
                const assignmentId = elementos.hiddenAssignmentId.value;
                const autorizadorEmail = elementos.hiddenAutorizadorEmail.value;
                const subItemName = elementos.hiddenSubItemName.value;
                
                if (!assignmentId || !autorizadorEmail || !subItemName) {
                    showMessage('Error: Datos de la asignación no válidos', 'danger');
                    return;
                }
                
                // Mostrar loading
                const btnGuardar = elementos.btnGuardarSolicitud;
                const textoOriginal = btnGuardar.innerHTML;
                btnGuardar.disabled = true;
                btnGuardar.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div>Guardando...';
                
                // Determinar si es recurrente
                const esRecurrente = elementos.enableRecurrence.checked;
                
                if (esRecurrente) {
                    await crearSolicitudesRecurrentes({
                        assignment_id: assignmentId,
                        request_details: detalle,
                        request_value: valor,
                        autorizador_email: autorizadorEmail,
                        sub_item_name: subItemName,
                        num_meses: parseInt(elementos.recurrenceMonths.value)
                    });
                } else {
                    await crearSolicitudEjecucion({
                        assignment_id: assignmentId,
                        request_details: detalle,
                        request_value: valor,
                        autorizador_email: autorizadorEmail,
                        sub_item_name: subItemName
                    });
                }
                
                // Restaurar botón
                btnGuardar.innerHTML = textoOriginal;
                btnGuardar.disabled = false;
                
                // Cerrar modal
                modalSolicitud.hide();
                
                const mensaje = esRecurrente 
                    ? 'Solicitudes recurrentes creadas exitosamente.' 
                    : 'Solicitud creada exitosamente. Se ha enviado notificación al autorizador.';
                showMessage(mensaje, 'success');
                
                // Recargar solicitudes
                setTimeout(async () => {
                    await cargarMisSolicitudes(false);
                }, 1000);
                
            } catch (error) {
                const btnGuardar = elementos.btnGuardarSolicitud;
                btnGuardar.innerHTML = '<i class="bi bi-check-circle me-1"></i>Crear Solicitud';
                btnGuardar.disabled = false;
                
                console.error('Error al guardar solicitud:', error);
                showMessage('Error al crear la solicitud: ' + error.message, 'danger');
            }
        }

        // ===== CREAR SOLICITUDES RECURRENTES =====
        async function crearSolicitudesRecurrentes(datos) {
            const session = getStoredSession();
            if (!session || !session.user) {
                throw new Error('Sesión de usuario no válida');
            }

            // Obtener worker actual
            const workerQuery = `workers?select=worker_first_name,worker_last_name_1,worker_last_name_2,email&worker_id=eq.${currentWorkerId}`;
            const workerData = await supabaseRequest('/' + workerQuery);
            
            if (workerData.length === 0) {
                throw new Error('No se encontró información del trabajador actual');
            }
            
            const currentWorker = workerData[0];
            
            // Calcular meses
            const meses = calcularMesesRecurrencia(datos.num_meses);
            const mesesValidos = meses.filter(m => m.yearAcademico !== null);
            
            if (mesesValidos.length === 0) {
                throw new Error('No hay meses válidos para crear solicitudes');
            }
            
            // Timestamp
            const ahora = new Date();
            const fechaBogota = new Date(ahora.toLocaleString("en-US", {timeZone: "America/Bogota"}));
            
            // 1. Crear grupo de recurrencia
            const grupoData = {
                original_assignment_id: datos.assignment_id,
                worker_id: currentWorkerId,
                base_value: datos.request_value,
                base_details: datos.request_details,
                total_occurrences: mesesValidos.length,
                start_month: mesesValidos[0].primerDiaMes,
                recurrence_status: 'active'
            };
            
            const grupoResult = await supabaseRequest('/recurrence_groups', {
                method: 'POST',
                body: JSON.stringify(grupoData),
                headers: { 'Prefer': 'return=representation' }
            });
            
            if (!grupoResult || grupoResult.length === 0) {
                throw new Error('No se pudo crear el grupo de recurrencia');
            }
            
            const recurrenceGroupId = grupoResult[0].recurrence_id;
            
            // 2. Crear solicitudes para cada mes
            const solicitudes = [];
            
            for (let i = 0; i < mesesValidos.length; i++) {
                const mes = mesesValidos[i];
                
                // Para el primer mes, crear como pendiente normal
                // Para los siguientes, crear como pendiente pero con fecha programada
                const solicitudData = {
                    assignment_id: datos.assignment_id,
                    worker_id: currentWorkerId,
                    worker_email: datos.autorizador_email,
                    requested_value: datos.request_value,
                    request_details: datos.request_details,
                    request_status: 'pending',
                    requested_at: fechaBogota.toISOString(),
                    scheduled_date: mes.primerDiaMes,
                    is_recurring: true,
                    recurrence_group_id: recurrenceGroupId
                };
                
                solicitudes.push(solicitudData);
            }
            
            // Insertar todas las solicitudes
            const insertResult = await supabaseRequest('/execution_requests', {
                method: 'POST',
                body: JSON.stringify(solicitudes),
                headers: { 'Prefer': 'return=representation' }
            });
            
            if (!insertResult || insertResult.length === 0) {
                throw new Error('No se pudieron crear las solicitudes');
            }
            
            // 3. Enviar notificación única al autorizador
            await enviarNotificacionRecurrencia(datos, currentWorker, mesesValidos);
            
            console.log(`✅ Creadas ${insertResult.length} solicitudes recurrentes`);
            
            return insertResult;
        }

        async function enviarNotificacionRecurrencia(datos, solicitante, meses) {
            try {
                const valorFormateado = new Intl.NumberFormat('es-CO').format(datos.request_value);
                const valorTotal = new Intl.NumberFormat('es-CO').format(datos.request_value * meses.length);
                const nombreSolicitante = construirNombreCompleto(solicitante);
                
                const asunto = 'SchoolNet - Nueva solicitud de ejecución RECURRENTE';
                
                let listaMeses = meses.map(m => `<li>${m.nombreMes} ${m.anio}</li>`).join('');
                
                const cuerpoHtml = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
                        <div style="background-color: #d1c4e9; border-left: 4px solid #7c4dff; padding: 15px; margin-bottom: 20px;">
                            <h2 style="color: #4527a0; margin-top: 0; margin-bottom: 10px;">🔄 Nueva Solicitud de Ejecución RECURRENTE</h2>
                            <p style="margin: 0; color: #4527a0; font-weight: 500;">SchoolNet - Sistema de Gestión Educativa</p>
                        </div>
                        
                        <div style="background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <p style="margin-top: 0;">Hola,</p>
                            <p><strong>${escapeHtml(nombreSolicitante)}</strong> ha creado una solicitud de ejecución presupuestal <strong>recurrente</strong>.</p>
                            
                            <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #dee2e6;">
                                <tr style="background-color: #f8f9fa;">
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Sub-ítem:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">${escapeHtml(datos.sub_item_name)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Valor mensual:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-family: monospace;">${valorFormateado}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Total (${meses.length} meses):</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-family: monospace; font-weight: bold;">${valorTotal}</td>
                                </tr>
                            </table>
                            
                            <div style="background-color: #e8eaf6; border-radius: 4px; padding: 15px; margin: 20px 0;">
                                <h4 style="margin-top: 0; color: #3f51b5;">Meses programados:</h4>
                                <ul style="margin: 0; padding-left: 20px;">
                                    ${listaMeses}
                                </ul>
                            </div>
                            
                            <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 15px; margin: 20px 0;">
                                <p style="margin: 0; color: #0c5460;"><strong>Acción requerida:</strong> Ingrese al sistema SchoolNet para revisar y gestionar estas solicitudes.</p>
                            </div>
                        </div>
                        
                        <hr style="margin: 30px 0; border: none; border-top: 1px solid #dee2e6;">
                        <p style="color: #6c757d; font-size: 12px; margin: 0; text-align: center;">
                            Este correo es generado automáticamente por SchoolNet.
                        </p>
                    </div>
                `;
                
                await sendNotification(datos.autorizador_email, asunto, cuerpoHtml, true);
                
            } catch (error) {
                console.error('Error enviando notificación de recurrencia:', error);
            }
        }

        // ===== CREAR SOLICITUD SIMPLE =====
        async function crearSolicitudEjecucion(datos) {
            const session = getStoredSession();
            if (!session || !session.user) {
                throw new Error('Sesión de usuario no válida');
            }

            const workerQuery = `workers?select=worker_first_name,worker_last_name_1,worker_last_name_2,email&worker_id=eq.${currentWorkerId}`;
            const workerData = await supabaseRequest('/' + workerQuery);
            
            if (workerData.length === 0) {
                throw new Error('No se encontró información del trabajador actual');
            }
            
            const currentWorker = workerData[0];
            
            const ahora = new Date();
            const fechaBogota = new Date(ahora.toLocaleString("en-US", {timeZone: "America/Bogota"}));
            
            const solicitudData = {
                assignment_id: datos.assignment_id,
                worker_id: currentWorkerId,
                worker_email: datos.autorizador_email,
                requested_value: datos.request_value,
                request_details: datos.request_details,
                request_status: 'pending',
                requested_at: fechaBogota.toISOString(),
                is_recurring: false
            };
            
            const resultado = await supabaseRequest('/execution_requests', {
                method: 'POST',
                body: JSON.stringify(solicitudData)
            });
            
            if (!resultado || resultado.length === 0) {
                throw new Error('No se pudo crear la solicitud');
            }
            
            await enviarNotificacionEjecucion(datos, currentWorker);
            
            return resultado[0];
        }

        async function enviarNotificacionEjecucion(datos, solicitante) {
            try {
                const valorFormateado = new Intl.NumberFormat('es-CO').format(datos.request_value);
                const nombreSolicitante = construirNombreCompleto(solicitante);
                
                const asunto = 'SchoolNet - Nueva solicitud de ejecución presupuestal';
                
                const cuerpoHtml = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
                        <div style="background-color: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin-bottom: 20px;">
                            <h2 style="color: #155724; margin-top: 0; margin-bottom: 10px;">📋 Nueva Solicitud de Ejecución Presupuestal</h2>
                            <p style="margin: 0; color: #155724; font-weight: 500;">SchoolNet - Sistema de Gestión Educativa</p>
                        </div>
                        
                        <div style="background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <p style="margin-top: 0;">Hola,</p>
                            <p><strong>${escapeHtml(nombreSolicitante)}</strong> ha creado una nueva solicitud de ejecución presupuestal.</p>
                            
                            <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border: 1px solid #dee2e6;">
                                <tr style="background-color: #f8f9fa;">
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Concepto</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold;">Detalle</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Sub-ítem:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">${escapeHtml(datos.sub_item_name)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Valor solicitado:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6; font-family: monospace; font-weight: bold;">${valorFormateado}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">Solicitante:</td>
                                    <td style="padding: 12px; border: 1px solid #dee2e6;">${escapeHtml(nombreSolicitante)} (${escapeHtml(solicitante.email)})</td>
                                </tr>
                            </table>
                            
                            <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin: 20px 0;">
                                <h4 style="margin-top: 0; color: #495057;">Detalle de la solicitud:</h4>
                                <div style="background-color: white; padding: 10px; border-radius: 3px; border-left: 3px solid #007bff;">
                                    ${datos.request_details}
                                </div>
                            </div>
                            
                            <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 15px; margin: 20px 0;">
                                <p style="margin: 0; color: #0c5460;"><strong>Acción requerida:</strong> Ingrese al sistema SchoolNet para revisar y gestionar esta solicitud.</p>
                            </div>
                        </div>
                        
                        <hr style="margin: 30px 0; border: none; border-top: 1px solid #dee2e6;">
                        <p style="color: #6c757d; font-size: 12px; margin: 0; text-align: center;">
                            Este correo es generado automáticamente por SchoolNet. Por favor, no responder a este mensaje.<br>
                            Colegio Tilata - Sistema de Gestión Educativa
                        </p>
                    </div>
                `;
                
                const emailEnviado = await sendNotification(
                    datos.autorizador_email,
                    asunto,
                    cuerpoHtml,
                    true
                );
                
                if (emailEnviado) {
                    console.log('Notificación enviada exitosamente a:', datos.autorizador_email);
                }
                
            } catch (error) {
                console.error('Error enviando notificación:', error);
            }
        }

        // ===== ACTUALIZAR SOLICITUD =====
        async function actualizarSolicitud() {
            try {
                const detalle = elementos.editRequestDetails.innerHTML.trim();
                const valorTexto = elementos.editRequestValue.value.replace(/[,.]/g, '');
                const requestId = elementos.hiddenRequestId.value;
                
                if (!detalle || detalle === '') {
                    showMessage('El campo "Detalle" es obligatorio', 'warning');
                    elementos.editRequestDetails.focus();
                    return;
                }
                
                if (!valorTexto || isNaN(valorTexto) || parseInt(valorTexto) <= 0) {
                    showMessage('El campo "Valor" debe ser un número mayor a cero', 'warning');
                    elementos.editRequestValue.focus();
                    return;
                }
                
                if (!requestId) {
                    showMessage('Error: ID de solicitud no válido', 'danger');
                    return;
                }
                
                const valor = parseInt(valorTexto);
                
                const btnActualizar = elementos.btnActualizarSolicitud;
                const textoOriginal = btnActualizar.innerHTML;
                btnActualizar.disabled = true;
                btnActualizar.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div>Actualizando...';
                
                const ahora = new Date();
                const fechaBogota = new Date(ahora.toLocaleString("en-US", {timeZone: "America/Bogota"}));
                
                const updateQuery = `execution_requests?request_id=eq.${requestId}`;
                await supabaseRequest('/' + updateQuery, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        request_details: detalle,
                        requested_value: valor,
                        updated_at: fechaBogota.toISOString()
                    })
                });
                
                btnActualizar.innerHTML = textoOriginal;
                btnActualizar.disabled = false;
                
                modalEditarSolicitud.hide();
                
                showMessage('Solicitud actualizada exitosamente', 'success');
                
                await cargarMisSolicitudes(false);
                
            } catch (error) {
                const btnActualizar = elementos.btnActualizarSolicitud;
                btnActualizar.innerHTML = '<i class="bi bi-check-circle me-1"></i>Actualizar Solicitud';
                btnActualizar.disabled = false;
                
                console.error('Error al actualizar solicitud:', error);
                showMessage('Error al actualizar la solicitud: ' + error.message, 'danger');
            }
        }

        // ===== FUNCIONES DEL EDITOR =====
        function formatText(command) {
            document.execCommand(command, false, null);
            elementos.requestDetails.focus();
        }
        
        function formatTextEdit(command) {
            document.execCommand(command, false, null);
            elementos.editRequestDetails.focus();
        }

        // ===== FUNCIONES AUXILIARES =====
        function construirNombreCompleto(worker) {
            const apellido1 = worker.worker_last_name_1 || '';
            const apellido2 = worker.worker_last_name_2 || '';
            const nombre = worker.worker_first_name || '';
            
            let nombreCompleto = apellido1;
            if (apellido2) {
                nombreCompleto += ' ' + apellido2;
            }
            if (nombre) {
                nombreCompleto += ' ' + nombre;
            }
            
            return nombreCompleto.trim();
        }

        function formatearValor(event) {
            let valor = event.target.value.replace(/[^\d]/g, '');
            if (valor) {
                valor = parseInt(valor).toLocaleString('es-CO');
            }
            event.target.value = valor;
        }

        function validarSoloNumeros(event) {
            const charCode = event.which ? event.which : event.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                event.preventDefault();
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function mostrarFormularioPrincipal() {
            elementos.loadingOverlay.classList.add('d-none');
            elementos.mainContainer.classList.remove('d-none');
        }

        function ocultarLoading() {
            elementos.loadingOverlay.classList.add('d-none');
        }

        // Hacer funciones disponibles globalmente
        window.abrirModalSolicitud = abrirModalSolicitud;
        window.formatText = formatText;
        window.formatTextEdit = formatTextEdit;
        window.verGrupoRecurrencia = verGrupoRecurrencia;
    </script>
</body>
</html>
