<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.27.06.55">
    <title>Consultas de Presupuesto - Presupuesto - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSIÓN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- SheetJS para exportar a Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Estilos específicos del formulario -->
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0d6efd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Panel de filtros */
        .panel-filtros {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }

        .panel-filtros h5 {
            color: #0d6efd;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 600;
        }

        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Pestañas */
        .tabs-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            background: #f8f9fa;
        }

        .tab-button {
            flex: 1;
            padding: 1rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .tab-button:hover {
            background: rgba(13, 110, 253, 0.05);
            color: #0d6efd;
        }

        .tab-button.active {
            color: #0d6efd;
            border-bottom-color: #0d6efd;
            background: white;
        }

        .tab-panel {
            display: none;
            padding: 1.5rem;
        }

        .tab-panel.active {
            display: block;
        }

        .tab-panel h6 {
            color: #0d6efd;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        /* Mensaje inicial */
        .mensaje-inicial {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
            font-style: italic;
        }

        .mensaje-inicial i {
            font-size: 3rem;
            display: block;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Tablas de resultados */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        .tabla-resultados {
            width: 100%;
            margin-bottom: 0;
        }

        .tabla-resultados thead th {
            background-color: #0d6efd;
            color: white;
            font-weight: 600;
            border: none;
            padding: 12px;
            text-align: center;
            vertical-align: middle;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .tabla-resultados tbody td {
            padding: 10px;
            vertical-align: middle;
            font-size: 0.875rem;
            text-align: center;
        }

        .tabla-resultados tbody tr {
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.2s;
        }

        .tabla-resultados tbody tr:hover {
            background-color: #f8f9fa;
        }

        .tabla-resultados .numero {
            text-align: right;
            font-family: monospace;
            font-weight: 600;
        }

        /* Colores de valores */
        .valor-positivo {
            color: #198754;
        }

        .valor-negativo {
            color: #dc3545;
        }

        .valor-neutral {
            color: #6c757d;
        }

        /* Fila de sobre-ejecución */
        .sobreejecucion {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        /* Contador de registros */
        .contador-registros {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #e7f3ff;
            border-radius: 6px;
            text-align: center;
            color: #0d6efd;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filtros-grid {
                grid-template-columns: 1fr;
            }

            .tabs-header {
                flex-direction: column;
            }

            .tab-button {
                border-bottom: 1px solid #dee2e6;
                border-left: 3px solid transparent;
            }

            .tab-button.active {
                border-bottom: 1px solid #dee2e6;
                border-left-color: #0d6efd;
            }

            .tabla-resultados thead th,
            .tabla-resultados tbody td {
                padding: 8px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
  <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0" id="loading-message">Cargando datos...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Presupuesto</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Consultas de Presupuesto
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE PÁGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-search me-2"></i>
                    Consultas de Presupuesto
                </h1>
                <p class="text-muted">
                    Sistema de reportes con filtros avanzados
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- PANEL DE FILTROS -->
        <div class="panel-filtros">
            <h5>
                <i class="bi bi-funnel me-2"></i>Filtros de Consulta
            </h5>
            
            <div class="filtros-grid">
                <div class="form-group">
                    <label for="filtro-categoria" class="form-label">
                        <i class="bi bi-folder me-1"></i>Categoría
                    </label>
                    <select class="form-select" id="filtro-categoria">
                        <option value="">Todas las categorías</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="filtro-item" class="form-label">
                        <i class="bi bi-list-ul me-1"></i>Ítem
                    </label>
                    <select class="form-select" id="filtro-item">
                        <option value="">Todos los ítems</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="filtro-trabajador" class="form-label">
                        <i class="bi bi-person me-1"></i>Trabajador
                    </label>
                    <select class="form-select" id="filtro-trabajador">
                        <option value="">Todos los trabajadores</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="filtro-year" class="form-label">
                        <i class="bi bi-calendar3 me-1"></i>Año
                    </label>
                    <select class="form-select" id="filtro-year">
                        <option value="">Todos los años</option>
                    </select>
                </div>
            </div>
            
            <div class="d-flex justify-content-center gap-2">
                <button id="btn-consultar" class="btn btn-primary">
                    <i class="bi bi-search me-1"></i>Consultar
                </button>
                <button id="btn-exportar" class="btn btn-success" disabled>
                    <i class="bi bi-file-earmark-excel me-1"></i>Exportar Excel
                </button>
                <button id="btn-limpiar" class="btn btn-secondary">
                    <i class="bi bi-x-circle me-1"></i>Limpiar Filtros
                </button>
            </div>
        </div>

        <!-- PESTAÑAS DE RESULTADOS -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" data-tab="asignaciones">
                    <i class="bi bi-wallet2 me-1"></i>Asignaciones
                </button>
                <button class="tab-button" data-tab="requerimientos">
                    <i class="bi bi-file-text me-1"></i>Requerimientos
                </button>
                <button class="tab-button" data-tab="sobreejecuciones">
                    <i class="bi bi-exclamation-triangle me-1"></i>Sobre-ejecuciones
                </button>
            </div>
            
            <div class="tabs-content">
                <!-- PESTAÑA: ASIGNACIONES -->
                <div id="tab-asignaciones" class="tab-panel active">
                    <h6>
                        <i class="bi bi-wallet2 me-2"></i>Asignaciones Presupuestales
                    </h6>
                    <div id="resultados-asignaciones">
                        <div class="mensaje-inicial">
                            <i class="bi bi-search"></i>
                            <p>Selecciona los filtros y presiona "Consultar" para ver las asignaciones</p>
                        </div>
                    </div>
                </div>
                
                <!-- PESTAÑA: REQUERIMIENTOS -->
                <div id="tab-requerimientos" class="tab-panel">
                    <h6>
                        <i class="bi bi-file-text me-2"></i>Requerimientos Presupuestales
                    </h6>
                    <div id="resultados-requerimientos">
                        <div class="mensaje-inicial">
                            <i class="bi bi-search"></i>
                            <p>Selecciona los filtros y presiona "Consultar" para ver los requerimientos</p>
                        </div>
                    </div>
                </div>
                
                <!-- PESTAÑA: SOBRE-EJECUCIONES -->
                <div id="tab-sobreejecuciones" class="tab-panel">
                    <h6>
                        <i class="bi bi-exclamation-triangle me-2"></i>Requerimientos Sobre-ejecutados
                    </h6>
                    <div id="resultados-sobreejecuciones">
                        <div class="mensaje-inicial">
                            <i class="bi bi-search"></i>
                            <p>Selecciona los filtros y presiona "Consultar" para ver las sobre-ejecuciones</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts - ORDEN CRÍTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let categoriesList = [];
        let itemsList = [];
        let workersList = [];
        let yearsList = [];
        let currentBudgetYearId = null; // Año vigente de presupuesto
        
        // Datos de última consulta para exportación
        let ultimaConsulta = {
            asignaciones: [],
            requerimientos: [],
            sobreejecuciones: []
        };

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 1. VALIDAR PERMISOS
                const hasAccess = await validatePageAccess('Consultas de presupuesto');
                if (!hasAccess) return;

                // 2. INICIALIZAR COMPONENTES
                configurarEventos();

                // 3. CARGAR FILTROS
                await cargarFiltros();

            } catch (error) {
                console.error('Error en inicialización:', error);
                showMessage('Error al inicializar la página: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CONFIGURAR EVENTOS
        // ==========================================
        function configurarEventos() {
            // Evento de cambio de categoría para filtrar ítems
            document.getElementById('filtro-categoria').addEventListener('change', function() {
                const categoryId = this.value;
                cargarItemsPorCategoria(categoryId);
            });

            // Evento del botón consultar
            document.getElementById('btn-consultar').addEventListener('click', realizarConsulta);

            // Evento del botón limpiar
            document.getElementById('btn-limpiar').addEventListener('click', limpiarFiltros);

            // Eventos de las pestañas
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    cambiarPestana(this.dataset.tab);
                });
            });
            
            // Evento del botón exportar
            document.getElementById('btn-exportar').addEventListener('click', exportarExcel);
            
            console.log('✅ Eventos configurados');
        }

        // ==========================================
        // CARGAR FILTROS
        // ==========================================
        async function cargarFiltros() {
            mostrarLoading('Cargando filtros...');
            
            try {
                // 1. PRIMERO cargar el año vigente (necesario para preselección)
                await cargarYearVigente();
                
                // 2. LUEGO cargar en paralelo el resto de filtros
                await Promise.all([
                    cargarCategorias(),
                    cargarTodosItems(),
                    cargarTrabajadores(),
                    cargarYears()
                ]);

                ocultarLoading();
                console.log('✅ Todos los filtros cargados');

            } catch (error) {
                ocultarLoading();
                console.error('Error cargando filtros:', error);
                showMessage('Error al cargar filtros: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // CARGAR AÑO VIGENTE DE PRESUPUESTO
        // ==========================================
        async function cargarYearVigente() {
            try {
                const query = '/system_config?select=current_budget_year_id&limit=1';
                const data = await supabaseRequest(query);
                
                if (data && data.length > 0 && data[0].current_budget_year_id) {
                    currentBudgetYearId = data[0].current_budget_year_id;
                    console.log(`✅ Año vigente de presupuesto: ${currentBudgetYearId}`);
                } else {
                    console.warn('⚠️ No se encontró año vigente de presupuesto en system_config');
                }

            } catch (error) {
                console.error('Error cargando año vigente:', error);
                // No lanzar error, continuar sin preselección
            }
        }

        // ==========================================
        // CARGAR CATEGORÍAS
        // ==========================================
        async function cargarCategorias() {
            try {
                const query = '/budget_categories?select=category_id,category_name&category_status=eq.active&order=category_name.asc';
                const data = await supabaseRequest(query);
                
                categoriesList = data;

                const select = document.getElementById('filtro-categoria');
                select.innerHTML = '<option value="">Todas las categorías</option>';
                
                categoriesList.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.category_id;
                    option.textContent = cat.category_name;
                    select.appendChild(option);
                });

                console.log(`✅ ${categoriesList.length} categorías cargadas`);

            } catch (error) {
                console.error('Error cargando categorías:', error);
                throw error;
            }
        }

        // ==========================================
        // CARGAR TODOS LOS ÍTEMS
        // ==========================================
        async function cargarTodosItems() {
            try {
                const query = '/budget_items?select=item_id,item_name,category_id,budget_categories!budget_items_category_fkey(category_name)&item_status=eq.active&order=item_name.asc';
                const data = await supabaseRequest(query);
                
                itemsList = data;

                const select = document.getElementById('filtro-item');
                select.innerHTML = '<option value="">Todos los ítems</option>';
                
                itemsList.forEach(item => {
                    const categoryName = item.budget_categories?.category_name || '';
                    const option = document.createElement('option');
                    option.value = item.item_id;
                    option.textContent = `${categoryName} - ${item.item_name}`;
                    option.dataset.categoryId = item.category_id;
                    select.appendChild(option);
                });

                console.log(`✅ ${itemsList.length} ítems cargados`);

            } catch (error) {
                console.error('Error cargando ítems:', error);
                throw error;
            }
        }

        // ==========================================
        // CARGAR ÍTEMS POR CATEGORÍA
        // ==========================================
        function cargarItemsPorCategoria(categoryId) {
            const select = document.getElementById('filtro-item');
            select.innerHTML = '<option value="">Todos los ítems</option>';

            if (!categoryId) {
                // Si no hay categoría seleccionada, mostrar todos
                itemsList.forEach(item => {
                    const categoryName = item.budget_categories?.category_name || '';
                    const option = document.createElement('option');
                    option.value = item.item_id;
                    option.textContent = `${categoryName} - ${item.item_name}`;
                    select.appendChild(option);
                });
            } else {
                // Filtrar ítems por categoría
                const itemsFiltrados = itemsList.filter(item => item.category_id === categoryId);
                
                itemsFiltrados.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.item_id;
                    option.textContent = item.item_name;
                    select.appendChild(option);
                });
            }
        }

        // ==========================================
        // CARGAR TRABAJADORES
        // ==========================================
        async function cargarTrabajadores() {
            try {
                const query = '/workers?select=worker_id,email,worker_first_name,worker_last_name_1,worker_last_name_2&worker_status=eq.active&order=worker_last_name_1.asc';
                const data = await supabaseRequest(query);
                
                workersList = data;

                const select = document.getElementById('filtro-trabajador');
                select.innerHTML = '<option value="">Todos los trabajadores</option>';
                
                workersList.forEach(worker => {
                    const nombreCompleto = formatWorkerName(worker);
                    const option = document.createElement('option');
                    option.value = worker.worker_id;
                    option.textContent = nombreCompleto;
                    select.appendChild(option);
                });

                console.log(`✅ ${workersList.length} trabajadores cargados`);

            } catch (error) {
                console.error('Error cargando trabajadores:', error);
                throw error;
            }
        }

        // ==========================================
        // CARGAR AÑOS
        // ==========================================
        async function cargarYears() {
            try {
                const query = '/academic_years?select=year_id,year_name&order=year_name.desc';
                const data = await supabaseRequest(query);
                
                yearsList = data;

                const select = document.getElementById('filtro-year');
                select.innerHTML = '<option value="">Todos los años</option>';
                
                yearsList.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.year_id;
                    option.textContent = year.year_name;
                    
                    // Preseleccionar el año vigente de presupuesto
                    if (currentBudgetYearId && year.year_id === currentBudgetYearId) {
                        option.selected = true;
                    }
                    
                    select.appendChild(option);
                });

                console.log(`✅ ${yearsList.length} años cargados`);
                
                if (currentBudgetYearId) {
                    console.log(`✅ Año vigente preseleccionado: ${currentBudgetYearId}`);
                }

            } catch (error) {
                console.error('Error cargando años:', error);
                throw error;
            }
        }

        // ==========================================
        // CAMBIAR PESTAÑA
        // ==========================================
        function cambiarPestana(tabName) {
            // Desactivar todos los botones y paneles
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Activar el botón y panel seleccionado
            const button = document.querySelector(`[data-tab="${tabName}"]`);
            const panel = document.getElementById(`tab-${tabName}`);
            
            if (button) button.classList.add('active');
            if (panel) panel.classList.add('active');
        }

        // ==========================================
        // LIMPIAR FILTROS
        // ==========================================
        function limpiarFiltros() {
            document.getElementById('filtro-categoria').value = '';
            document.getElementById('filtro-item').value = '';
            document.getElementById('filtro-trabajador').value = '';
            
            // Restablecer al año vigente o vacío si no existe
            const selectYear = document.getElementById('filtro-year');
            if (currentBudgetYearId) {
                selectYear.value = currentBudgetYearId;
            } else {
                selectYear.value = '';
            }
            
            // Recargar todos los ítems
            cargarItemsPorCategoria('');
            
            // Limpiar resultados
            limpiarResultados();
            
            showMessage('Filtros limpiados correctamente', 'info');
        }

        // ==========================================
        // LIMPIAR RESULTADOS
        // ==========================================
        function limpiarResultados() {
            document.getElementById('resultados-asignaciones').innerHTML = `
                <div class="mensaje-inicial">
                    <i class="bi bi-search"></i>
                    <p>Selecciona los filtros y presiona "Consultar" para ver las asignaciones</p>
                </div>
            `;
            
            document.getElementById('resultados-requerimientos').innerHTML = `
                <div class="mensaje-inicial">
                    <i class="bi bi-search"></i>
                    <p>Selecciona los filtros y presiona "Consultar" para ver los requerimientos</p>
                </div>
            `;
            
            document.getElementById('resultados-sobreejecuciones').innerHTML = `
                <div class="mensaje-inicial">
                    <i class="bi bi-search"></i>
                    <p>Selecciona los filtros y presiona "Consultar" para ver las sobre-ejecuciones</p>
                </div>
            `;
        }

        // ==========================================
        // REALIZAR CONSULTA
        // ==========================================
        async function realizarConsulta() {
            // Obtener pestaña activa
            const tabActiva = document.querySelector('.tab-button.active').dataset.tab;
            
            // Obtener filtros
            const filtros = obtenerFiltros();
            
            mostrarLoading('Consultando datos...');
            
            try {
                switch (tabActiva) {
                    case 'asignaciones':
                        await consultarAsignaciones(filtros);
                        break;
                    case 'requerimientos':
                        await consultarRequerimientos(filtros);
                        break;
                    case 'sobreejecuciones':
                        await consultarSobreejecuciones(filtros);
                        break;
                }
                
                ocultarLoading();
                
            } catch (error) {
                ocultarLoading();
                console.error('Error en consulta:', error);
                showMessage('Error al realizar la consulta: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // OBTENER FILTROS
        // ==========================================
        function obtenerFiltros() {
            return {
                categoria: document.getElementById('filtro-categoria').value,
                item: document.getElementById('filtro-item').value,
                trabajador: document.getElementById('filtro-trabajador').value,
                year: document.getElementById('filtro-year').value
            };
        }

        // ==========================================
        // CONSULTAR ASIGNACIONES
        // ==========================================
        async function consultarAsignaciones(filtros) {
            try {
                // Construir query base - AGREGADO budget_item_id
                let query = '/budget_assignments?select=assignment_id,category_detail,requested_value,approved_value,executed_value,worker_id,academic_year_id,budget_item_id,budget_item:budget_items!budget_assignments_item_fkey(item_name,category_id,budget_categories!budget_items_category_fkey(category_name)),academic_year:academic_years!budget_assignments_year_fkey(year_name),worker:workers!budget_assignments_worker_id_fkey(worker_first_name,worker_last_name_1,worker_last_name_2)&assignment_status=eq.active';

                
                // Aplicar filtros
                if (filtros.year) {
                    query += `&academic_year_id=eq.${filtros.year}`;
                }
                
                if (filtros.trabajador) {
                    query += `&worker_id=eq.${filtros.trabajador}`;
                }
                
                if (filtros.item) {
                    query += `&budget_item_id=eq.${filtros.item}`;
                }
                
                // Si hay filtro de categoría pero no de ítem, necesitamos filtrar por categoría
                // Esto requiere obtener primero los ítems de esa categoría
                let data = await supabaseRequest(query);
                
                if (filtros.categoria && !filtros.item) {
                    data = data.filter(asig => 
                        asig.budget_item?.category_id === filtros.categoria
                    );
                }
                
                ultimaConsulta.asignaciones = data;
                renderizarAsignaciones(data);
                document.getElementById('btn-exportar').disabled = data.length === 0;
                
                console.log(`✅ ${data.length} asignaciones consultadas`);
            } catch (error) {
                console.error('Error consultando asignaciones:', error);
                throw error;
            }
        }

        // ==========================================
        // RENDERIZAR ASIGNACIONES
        // ==========================================
        function renderizarAsignaciones(asignaciones) {
            const divResultados = document.getElementById('resultados-asignaciones');
            
            if (!asignaciones || asignaciones.length === 0) {
                divResultados.innerHTML = `
                    <div class="mensaje-inicial">
                        <i class="bi bi-inbox"></i>
                        <p>No se encontraron asignaciones con los filtros seleccionados</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="tabla-resultados table table-hover">
                        <thead>
                            <tr>
                                <th>Categoría</th>
                                <th>Ítem</th>
                                <th>Año</th>
                                <th>Trabajador</th>
                                <th>Detalle</th>
                                <th>Vr. Solicitado</th>
                                <th>Vr. Aprobado</th>
                                <th>Vr. Ejecutado</th>
                                <th>Vr. Disponible</th>
                                <th>% Ejecución</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Contador de registros mostrados
            let registrosMostrados = 0;
            
            asignaciones.forEach(asig => {
                const categoriaName = asig.budget_item?.budget_categories?.category_name || '';
                const itemName = asig.budget_item?.item_name || '';
                const yearName = asig.academic_year?.year_name || '';
                const trabajadorName = formatWorkerName(asig.worker);
                const detalle = asig.category_detail || '';
                
                const valorSolicitado = asig.requested_value || 0;
                const valorAprobado = asig.approved_value || 0;
                const valorEjecutado = asig.executed_value || 0;
                const valorDisponible = valorAprobado - valorEjecutado;
                
                const porcentajeEjecucion = valorAprobado > 0 ? 
                    ((valorEjecutado / valorAprobado) * 100).toFixed(1) : 0;
                
                // Filtrar registros donde TODOS los valores son cero
                if (valorSolicitado === 0 && valorAprobado === 0 && valorEjecutado === 0 && valorDisponible === 0 && porcentajeEjecucion == 0) {
                    return; // Saltar este registro
                }
                
                registrosMostrados++;
                
                // Clases para colores
                let disponibleClass = 'valor-positivo';
                if (valorDisponible < 0) disponibleClass = 'valor-negativo';
                
                let porcentajeClass = 'valor-negativo';
                if (porcentajeEjecucion >= 100) porcentajeClass = 'valor-positivo';
                else if (porcentajeEjecucion >= 50) porcentajeClass = 'valor-neutral';

                html += `
                    <tr>
                        <td>${escapeHtml(categoriaName)}</td>
                        <td>${escapeHtml(itemName)}</td>
                        <td>${escapeHtml(yearName)}</td>
                        <td>${escapeHtml(trabajadorName)}</td>
                        <td>${escapeHtml(detalle)}</td>
                        <td class="numero">${formatCurrency(valorSolicitado)}</td>
                        <td class="numero">${formatCurrency(valorAprobado)}</td>
                        <td class="numero">${formatCurrency(valorEjecutado)}</td>
                        <td class="numero ${disponibleClass}">${formatCurrency(valorDisponible)}</td>
                        <td class="numero ${porcentajeClass}">${porcentajeEjecucion}%</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
                <div class="contador-registros">
                    <i class="bi bi-info-circle me-2"></i>
                    Total de registros: <strong>${registrosMostrados}</strong>
                </div>
            `;

            // Si no hay registros después del filtro, mostrar mensaje
            if (registrosMostrados === 0) {
                divResultados.innerHTML = `
                    <div class="mensaje-inicial">
                        <i class="bi bi-inbox"></i>
                        <p>No se encontraron asignaciones con valores diferentes de cero</p>
                    </div>
                `;
                return;
            }

            divResultados.innerHTML = html;
        }

        // ==========================================
        // CONSULTAR REQUERIMIENTOS
        // ==========================================
        async function consultarRequerimientos(filtros) {
            try {
                // Construir query base con relaciones - CORREGIDO execution_requests_assignment_fkey
                let query = '/execution_requests?select=request_id,requested_at,requested_value,responded_at,closed_value,request_status,assignment:budget_assignments!execution_requests_assignment_fkey(budget_item_id,worker_id,budget_item:budget_items!budget_assignments_item_fkey(item_name,category_id,budget_categories!budget_items_category_fkey(category_name)),academic_year:academic_years!budget_assignments_year_fkey(year_id,year_name),authorizer:workers!budget_assignments_worker_id_fkey(worker_first_name,worker_last_name_1,worker_last_name_2)),requester:workers!execution_requests_worker_fkey(worker_first_name,worker_last_name_1,worker_last_name_2)&order=requested_at.desc';

                
                let data = await supabaseRequest(query);
                
                // Aplicar filtros post-consulta (más eficiente para relaciones complejas)
                if (filtros.year) {
                    data = data.filter(req => req.assignment?.academic_year?.year_id === filtros.year);
                }
                
                if (filtros.trabajador) {
                    data = data.filter(req => 
                        req.assignment?.worker_id === filtros.trabajador
                    );
                }
                
                if (filtros.item) {
                    data = data.filter(req => 
                        req.assignment?.budget_item_id === filtros.item
                    );
                }
                
                if (filtros.categoria && !filtros.item) {
                    data = data.filter(req => 
                        req.assignment?.budget_item?.category_id === filtros.categoria
                    );
                }
                
                ultimaConsulta.requerimientos = data;
                renderizarRequerimientos(data);
                document.getElementById('btn-exportar').disabled = data.length === 0;
                
                console.log(`✅ ${data.length} requerimientos consultados`);
            } catch (error) {
                console.error('Error consultando requerimientos:', error);
                throw error;
            }
        }

        // ==========================================
        // RENDERIZAR REQUERIMIENTOS
        // ==========================================
        function renderizarRequerimientos(requerimientos) {
            const divResultados = document.getElementById('resultados-requerimientos');
            
            if (!requerimientos || requerimientos.length === 0) {
                divResultados.innerHTML = `
                    <div class="mensaje-inicial">
                        <i class="bi bi-inbox"></i>
                        <p>No se encontraron requerimientos con los filtros seleccionados</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="tabla-resultados table table-hover">
                        <thead>
                            <tr>
                                <th style="min-width: 80px;">ID</th>
                                <th>Categoría</th>
                                <th>Ítem</th>
                                <th>Año</th>
                                <th>Solicitante</th>
                                <th>Autorizador</th>
                                <th>Fecha Solicitud</th>
                                <th>Días Respuesta</th>
                                <th>Vr. Solicitado</th>
                                <th>Vr. Cerrado</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            requerimientos.forEach(req => {
                const requestId = req.request_id ? req.request_id.substring(0, 8) : '-';
                const categoriaName = req.assignment?.budget_item?.budget_categories?.category_name || '';
                const itemName = req.assignment?.budget_item?.item_name || '';
                const yearName = req.assignment?.academic_year?.year_name || '';
                const solicitante = formatWorkerName(req.requester);
                const autorizador = formatWorkerName(req.assignment?.authorizer);
                const fechaSolicitud = req.requested_at ? formatDate(req.requested_at) : '';
                
                // Calcular días de respuesta
                let diasRespuesta = '-';
                if (req.requested_at && req.responded_at) {
                    const inicio = new Date(req.requested_at);
                    const fin = new Date(req.responded_at);
                    const diferencia = Math.floor((fin - inicio) / (1000 * 60 * 60 * 24));
                    diasRespuesta = diferencia;
                } else if (req.requested_at && !req.responded_at) {
                    diasRespuesta = 'Sin respuesta';
                }
                
                const valorSolicitado = req.requested_value || 0;
                const valorCerrado = req.closed_value || 0;
                const estado = req.request_status || 'pending';

                html += `
                    <tr>
                        <td style="font-family: monospace; font-size: 0.8rem;">${requestId}</td>
                        <td>${escapeHtml(categoriaName)}</td>
                        <td>${escapeHtml(itemName)}</td>
                        <td>${escapeHtml(yearName)}</td>
                        <td>${escapeHtml(solicitante)}</td>
                        <td>${escapeHtml(autorizador)}</td>
                        <td>${fechaSolicitud}</td>
                        <td class="numero">${diasRespuesta}</td>
                        <td class="numero">${formatCurrency(valorSolicitado)}</td>
                        <td class="numero">${formatCurrency(valorCerrado)}</td>
                        <td><span class="badge bg-${getEstadoColor(estado)}">${formatEstado(estado)}</span></td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
                <div class="contador-registros">
                    <i class="bi bi-info-circle me-2"></i>
                    Total de registros: <strong>${requerimientos.length}</strong>
                </div>
            `;

            divResultados.innerHTML = html;
        }

        // ==========================================
        // CONSULTAR SOBRE-EJECUCIONES
        // ==========================================
        async function consultarSobreejecuciones(filtros) {
            try {
                // Obtener todos los requerimientos - CORREGIDO execution_requests_assignment_fkey
                let query = '/execution_requests?select=request_id,requested_at,requested_value,closed_value,overrun_reasons,assignment:budget_assignments!execution_requests_assignment_fkey(budget_item_id,worker_id,budget_item:budget_items!budget_assignments_item_fkey(item_name,category_id,budget_categories!budget_items_category_fkey(category_name)),academic_year:academic_years!budget_assignments_year_fkey(year_id,year_name)),requester:workers!execution_requests_worker_fkey(worker_first_name,worker_last_name_1,worker_last_name_2)&order=requested_at.desc';
                let data = await supabaseRequest(query);
                
                // Filtrar solo sobre-ejecuciones (closed_value > requested_value)
                data = data.filter(req => {
                    const solicitado = req.requested_value || 0;
                    const cerrado = req.closed_value || 0;
                    return cerrado > solicitado;
                });
                
                // Aplicar filtros adicionales
                if (filtros.year) {
                    data = data.filter(req => req.assignment?.academic_year?.year_id === filtros.year);
                }
                
                if (filtros.trabajador) {
                    data = data.filter(req => 
                        req.assignment?.worker_id === filtros.trabajador
                    );
                }
                
                if (filtros.item) {
                    data = data.filter(req => 
                        req.assignment?.budget_item_id === filtros.item
                    );
                }
                
                if (filtros.categoria && !filtros.item) {
                    data = data.filter(req => 
                        req.assignment?.budget_item?.category_id === filtros.categoria
                    );
                }
                
                ultimaConsulta.sobreejecuciones = data;
                renderizarSobreejecuciones(data);
                document.getElementById('btn-exportar').disabled = data.length === 0;
                
                console.log(`✅ ${data.length} sobre-ejecuciones consultadas`);
            } catch (error) {
                console.error('Error consultando sobre-ejecuciones:', error);
                throw error;
            }
        }

        // ==========================================
        // RENDERIZAR SOBRE-EJECUCIONES
        // ==========================================
        function renderizarSobreejecuciones(sobreejecuciones) {
            const divResultados = document.getElementById('resultados-sobreejecuciones');
            
            if (!sobreejecuciones || sobreejecuciones.length === 0) {
                divResultados.innerHTML = `
                    <div class="mensaje-inicial">
                        <i class="bi bi-inbox"></i>
                        <p>No se encontraron sobre-ejecuciones con los filtros seleccionados</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table class="tabla-resultados table table-hover">
                        <thead>
                            <tr>
                                <th style="min-width: 80px;">ID</th>
                                <th>Categoría</th>
                                <th>Ítem</th>
                                <th>Año</th>
                                <th>Solicitante</th>
                                <th>Vr. Solicitado</th>
                                <th>Vr. Cerrado</th>
                                <th>Sobre-ejecución</th>
                                <th>% Sobre-ejecución</th>
                                <th style="min-width: 200px;">Razones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sobreejecuciones.forEach(sobre => {
                const requestId = sobre.request_id ? sobre.request_id.substring(0, 8) : '-';
                const categoriaName = sobre.assignment?.budget_item?.budget_categories?.category_name || '';
                const itemName = sobre.assignment?.budget_item?.item_name || '';
                const yearName = sobre.assignment?.academic_year?.year_name || '';
                const solicitante = formatWorkerName(sobre.requester);
                
                const valorSolicitado = sobre.requested_value || 0;
                const valorCerrado = sobre.closed_value || 0;
                const sobreejecucion = valorCerrado - valorSolicitado;
                const porcentajeSobre = valorSolicitado > 0 ? 
                    ((sobreejecucion / valorSolicitado) * 100).toFixed(1) : 0;
                
                const razones = sobre.overrun_reasons || 'Sin especificar';

                html += `
                    <tr class="sobreejecucion">
                        <td style="font-family: monospace; font-size: 0.8rem;">${requestId}</td>
                        <td>${escapeHtml(categoriaName)}</td>
                        <td>${escapeHtml(itemName)}</td>
                        <td>${escapeHtml(yearName)}</td>
                        <td>${escapeHtml(solicitante)}</td>
                        <td class="numero">${formatCurrency(valorSolicitado)}</td>
                        <td class="numero">${formatCurrency(valorCerrado)}</td>
                        <td class="numero valor-negativo">${formatCurrency(sobreejecucion)}</td>
                        <td class="numero valor-negativo">${porcentajeSobre}%</td>
                        <td style="font-size: 0.8rem; text-align: left;">${escapeHtml(razones)}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
                <div class="contador-registros">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Total de sobre-ejecuciones: <strong>${sobreejecuciones.length}</strong>
                </div>
            `;

            divResultados.innerHTML = html;
        }

        // ==========================================
        // FORMATEAR ESTADO
        // ==========================================
        function formatEstado(estado) {
            const estados = {
                'pending': 'Pendiente',
                'approved': 'Aprobado',
                'rejected': 'Rechazado',
                'executed': 'Ejecutado',
                'closed': 'Cerrado',
                'pre-closed': 'Pre-cerrado'
            };
            return estados[estado] || estado;
        }

        // ==========================================
        // OBTENER COLOR DE ESTADO
        // ==========================================
        function getEstadoColor(estado) {
            const colores = {
                'pending': 'warning',
                'approved': 'success',
                'rejected': 'danger',
                'executed': 'info',
                'closed': 'info',
                'pre-closed': 'secondary'
            };
            return colores[estado] || 'secondary';
        }

        // ==========================================
        // FUNCIONES DE LOADING
        // ==========================================
        function mostrarLoading(mensaje = 'Cargando...') {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            
            if (loadingOverlay) {
                loadingMessage.textContent = mensaje;
                loadingOverlay.classList.remove('hidden');
            }
        }

        function ocultarLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }

        // ==========================================
        // FUNCIONES DE FORMATEO
        // ==========================================
        function formatCurrency(valor) {
            if (!valor || isNaN(valor)) return '$0';
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(valor);
        }

        function formatWorkerName(worker) {
            if (!worker) return 'N/A';
            
            const firstName = worker.worker_first_name || '';
            const lastName1 = worker.worker_last_name_1 || '';
            const lastName2 = worker.worker_last_name_2 || '';
            
            if (lastName2 && lastName2.trim()) {
                return `${lastName1} ${lastName2} ${firstName}`.trim();
            } else {
                return `${lastName1} ${firstName}`.trim();
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (error) {
                return dateString;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================
        // EXPORTAR A EXCEL
        // ==========================================
        function exportarExcel() {
            const tabActiva = document.querySelector('.tab-button.active').dataset.tab;
            let datos = [];
            let nombreArchivo = '';
            let encabezados = [];
            
            switch (tabActiva) {
                case 'asignaciones':
                    datos = prepararDatosAsignaciones();
                    encabezados = ['Categoría', 'Ítem', 'Año', 'Trabajador', 'Detalle', 'Vr. Solicitado', 'Vr. Aprobado', 'Vr. Ejecutado', 'Vr. Disponible', '% Ejecución'];
                    nombreArchivo = 'Asignaciones_Presupuestales';
                    break;
                case 'requerimientos':
                    datos = prepararDatosRequerimientos();
                    encabezados = ['ID', 'Categoría', 'Ítem', 'Año', 'Solicitante', 'Autorizador', 'Fecha Solicitud', 'Días Respuesta', 'Vr. Solicitado', 'Vr. Cerrado', 'Estado'];
                    nombreArchivo = 'Requerimientos_Presupuestales';
                    break;
                case 'sobreejecuciones':
                    datos = prepararDatosSobreejecuciones();
                    encabezados = ['ID', 'Categoría', 'Ítem', 'Año', 'Solicitante', 'Vr. Solicitado', 'Vr. Cerrado', 'Sobre-ejecución', '% Sobre-ejecución', 'Razones'];
                    nombreArchivo = 'Sobre_Ejecuciones';
                    break;
            }
            
            if (datos.length === 0) {
                showMessage('No hay datos para exportar', 'warning');
                return;
            }
            
            // Crear libro de Excel
            const ws = XLSX.utils.aoa_to_sheet([encabezados, ...datos]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Datos');
            
            // Ajustar ancho de columnas
            const colWidths = encabezados.map(h => ({ wch: Math.max(h.length + 2, 15) }));
            ws['!cols'] = colWidths;
            
            // Descargar archivo
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `${nombreArchivo}_${fecha}.xlsx`);
            
            showMessage('Archivo exportado correctamente', 'success');
        }
        
        function prepararDatosAsignaciones() {
            return ultimaConsulta.asignaciones
                .filter(asig => {
                    const valorSolicitado = asig.requested_value || 0;
                    const valorAprobado = asig.approved_value || 0;
                    const valorEjecutado = asig.executed_value || 0;
                    return !(valorSolicitado === 0 && valorAprobado === 0 && valorEjecutado === 0);
                })
                .map(asig => {
                    const valorAprobado = asig.approved_value || 0;
                    const valorEjecutado = asig.executed_value || 0;
                    const valorDisponible = valorAprobado - valorEjecutado;
                    const porcentaje = valorAprobado > 0 ? ((valorEjecutado / valorAprobado) * 100).toFixed(1) : 0;
                    
                    return [
                        asig.budget_item?.budget_categories?.category_name || '',
                        asig.budget_item?.item_name || '',
                        asig.academic_year?.year_name || '',
                        formatWorkerName(asig.worker),
                        asig.category_detail || '',
                        asig.requested_value || 0,
                        valorAprobado,
                        valorEjecutado,
                        valorDisponible,
                        parseFloat(porcentaje)
                    ];
                });
        }
        
        function prepararDatosRequerimientos() {
            return ultimaConsulta.requerimientos.map(req => {
                let diasRespuesta = '';
                if (req.requested_at && req.responded_at) {
                    const inicio = new Date(req.requested_at);
                    const fin = new Date(req.responded_at);
                    diasRespuesta = Math.floor((fin - inicio) / (1000 * 60 * 60 * 24));
                } else if (req.requested_at && !req.responded_at) {
                    diasRespuesta = 'Sin respuesta';
                }
                
                return [
                    req.request_id ? req.request_id.substring(0, 8) : '',
                    req.assignment?.budget_item?.budget_categories?.category_name || '',
                    req.assignment?.budget_item?.item_name || '',
                    req.assignment?.academic_year?.year_name || '',
                    formatWorkerName(req.requester),
                    formatWorkerName(req.assignment?.authorizer),
                    req.requested_at ? formatDate(req.requested_at) : '',
                    diasRespuesta,
                    req.requested_value || 0,
                    req.closed_value || 0,
                    formatEstado(req.request_status || 'pending')
                ];
            });
        }
        
        function prepararDatosSobreejecuciones() {
            return ultimaConsulta.sobreejecuciones.map(sobre => {
                const valorSolicitado = sobre.requested_value || 0;
                const valorCerrado = sobre.closed_value || 0;
                const sobreejecucion = valorCerrado - valorSolicitado;
                const porcentaje = valorSolicitado > 0 ? ((sobreejecucion / valorSolicitado) * 100).toFixed(1) : 0;
                
                return [
                    sobre.request_id ? sobre.request_id.substring(0, 8) : '',
                    sobre.assignment?.budget_item?.budget_categories?.category_name || '',
                    sobre.assignment?.budget_item?.item_name || '',
                    sobre.assignment?.academic_year?.year_name || '',
                    formatWorkerName(sobre.requester),
                    valorSolicitado,
                    valorCerrado,
                    sobreejecucion,
                    parseFloat(porcentaje),
                    sobre.overrun_reasons || 'Sin especificar'
                ];
            });
        }

        console.log('✅ Página de Consultas de Presupuesto cargada correctamente');
    </script>
</body>
</html>
