<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.26.06.36">
    <title>Traslados Presupuestales - Presupuesto - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSIÓN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos específicos del formulario -->
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0d6efd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Secciones del formulario */
        .form-section {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .form-section h3 {
            margin: 0 0 1rem 0;
            color: #0d6efd;
            font-size: 1.25rem;
            border-bottom: 2px solid #cfe2ff;
            padding-bottom: 0.5rem;
        }

        /* Tabla de asignaciones */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .table thead th {
            background-color: #0d6efd;
            color: white;
            font-weight: 600;
            border: none;
            padding: 12px;
            text-align: center;
            vertical-align: middle;
            font-size: 0.875rem;
        }

        .table tbody td {
            padding: 12px;
            vertical-align: middle;
            font-size: 0.875rem;
        }

        .table tbody tr {
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.2s;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .table tbody tr.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #0d6efd;
        }

        .valor-cell {
            text-align: right;
            font-weight: 600;
            white-space: nowrap;
        }

        .disponible-positivo {
            color: #198754;
        }

        .disponible-cero {
            color: #6c757d;
        }

        /* Botones */
        .btn-transferir {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.875rem;
        }

        .btn-transferir:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.5);
        }

        /* Editor de texto enriquecido */
        .toolbar-editor {
            display: flex;
            gap: 5px;
            padding: 8px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
        }

        .toolbar-btn {
            background: white;
            border: 1px solid #dee2e6;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        .editor-content {
            min-height: 120px;
            max-height: 250px;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 0 0 6px 6px;
            background-color: white;
            outline: none;
            line-height: 1.6;
            overflow-y: auto;
        }

        .editor-content:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .editor-content:empty:before {
            content: attr(placeholder);
            color: #6c757d;
            font-style: italic;
        }

        /* Validación */
        .campo-obligatorio {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
        }

        .mensaje-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 5px;
            display: none;
        }

        /* Info boxes */
        .info-box {
            background-color: #e3f2fd;
            border-left: 4px solid #0d6efd;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .info-box strong {
            color: #0d6efd;
        }

        /* Estado vacío */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        /* Modal grande */
        .modal-xl {
            max-width: 1000px;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        /* Grid de formulario */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-grid .full-width {
            grid-column: 1 / -1;
        }

        /* Tabla seleccionable */
        .selection-table tbody tr {
            cursor: pointer;
        }

        .selection-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .selection-table tbody tr.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #0d6efd;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .modal-xl {
                max-width: 95%;
            }

            .table thead th,
            .table tbody td {
                padding: 8px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
  <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0" id="loading-message">Procesando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Presupuesto</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Traslados Presupuestales
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE PÁGINA -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-arrow-left-right me-2"></i>
                    Traslados Presupuestales
                </h1>
                <p class="text-muted">
                    Solicitar traslado de fondos entre asignaciones presupuestales
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- SECCIÓN: SELECCIÓN DE ASIGNACIÓN FUENTE -->
        <div class="form-section">
            <h3>
                <i class="bi bi-box-arrow-up-right me-2"></i>
                Selección de Asignación Fuente
            </h3>
            
            <p class="text-muted mb-3">
                Seleccione el ítem presupuestal desde donde se trasladarán los fondos
            </p>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="select-item-fuente" class="form-label">
                            Ítem Presupuestal Fuente <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="select-item-fuente" required>
                            <option value="">Cargando ítems presupuestales...</option>
                        </select>
                        <small class="form-text text-muted">
                            Solo se muestran ítems con asignaciones disponibles
                        </small>
                    </div>
                </div>
            </div>

            <!-- Tabla de asignaciones fuente -->
            <div id="tabla-fuente-container" style="display: none;">
                <h5 class="mt-4 mb-3">
                    <i class="bi bi-list-ul me-2"></i>
                    Asignaciones Disponibles
                </h5>
                
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tabla-asignaciones-fuente">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Categoría</th>
                                <th style="width: 40%;">Autorizador</th>
                                <th style="width: 20%;" class="text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-asignaciones-fuente">
                            <tr>
                                <td colspan="3" class="empty-state">
                                    <i class="bi bi-hourglass-split"></i>
                                    <p>Cargando asignaciones...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    <!-- MODAL DE TRASLADO -->
    <div class="modal fade" id="modal-traslado" tabindex="-1" aria-labelledby="modalTrasladoLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTrasladoLabel">
                        <i class="bi bi-arrow-left-right me-2"></i>Traslado Presupuestal
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="form-traslado">
                    <div class="modal-body">
                        <!-- Campos ocultos -->
                        <input type="hidden" id="source-assignment-id" value="">
                        <input type="hidden" id="destination-assignment-id" value="">

                        <!-- Formulario de traslado -->
                        <div class="mb-4">
                            <h6 class="text-primary">
                                <i class="bi bi-pencil-square me-2"></i>Datos del Traslado
                            </h6>

                            <div class="form-grid">
                                <!-- Razones del traslado -->
                                <div class="mb-3 full-width">
                                    <label class="form-label">
                                        Razones del Traslado <span class="text-danger">*</span>
                                    </label>
                                    <div class="toolbar-editor">
                                        <button type="button" class="toolbar-btn" onclick="formatText('bold')" title="Negrita">
                                            <i class="bi bi-type-bold"></i>
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="formatText('italic')" title="Cursiva">
                                            <i class="bi bi-type-italic"></i>
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="formatText('underline')" title="Subrayado">
                                            <i class="bi bi-type-underline"></i>
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="insertList('ul')" title="Lista con viñetas">
                                            <i class="bi bi-list-ul"></i>
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="insertList('ol')" title="Lista numerada">
                                            <i class="bi bi-list-ol"></i>
                                        </button>
                                    </div>
                                    <div id="razones-traslado" 
                                         class="editor-content" 
                                         contenteditable="true" 
                                         placeholder="Describa las razones que justifican este traslado presupuestal...">
                                    </div>
                                    <div id="error-razones" class="mensaje-error"></div>
                                    <small class="form-text text-muted">
                                        Explique detalladamente por qué se requiere este traslado
                                    </small>
                                </div>

                                <!-- Valor del traslado -->
                                <div class="mb-3">
                                    <label for="valor-traslado" class="form-label">
                                        Valor del Traslado <span class="text-danger">*</span>
                                    </label>
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        id="valor-traslado" 
                                        placeholder="Ej: 1.500.000"
                                        required>
                                    <div id="error-valor" class="mensaje-error"></div>
                                </div>

                                <!-- Ítem de destino -->
                                <div class="mb-3">
                                    <label for="select-item-destino" class="form-label">
                                        Ítem Presupuestal de Destino <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="select-item-destino" required>
                                        <option value="">Seleccione un ítem...</option>
                                    </select>
                                    <div id="error-item-destino" class="mensaje-error"></div>
                                    <small class="form-text text-muted">
                                        Ítem hacia donde se trasladarán los fondos
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de asignaciones destino -->
                        <div id="seccion-destino" style="display: none;">
                            <h6 class="text-primary">
                                <i class="bi bi-box-arrow-in-down-right me-2"></i>Seleccione Asignación de Destino
                            </h6>
                            
                            <p class="text-muted mb-3">
                                Haga clic en la fila de la asignación que recibirá los fondos
                            </p>

                            <div class="table-responsive">
                                <table class="table table-hover selection-table mb-0" id="tabla-asignaciones-destino">
                                    <thead>
                                        <tr>
                                            <th style="width: 30%;">Categoría</th>
                                            <th style="width: 25%;">Autorizador</th>
                                            <th style="width: 15%;" class="text-end">Vr. Aprobado</th>
                                            <th style="width: 15%;" class="text-end">Vr. Ejecutado</th>
                                            <th style="width: 15%;" class="text-end">Vr. Disponible</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-asignaciones-destino">
                                        <tr>
                                            <td colspan="5" class="text-center py-3 text-muted">
                                                Seleccione un ítem de destino para ver las asignaciones
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <button 
                            type="button" 
                            class="btn btn-primary" 
                            id="btn-procesar-traslado" 
                            onclick="procesarTraslado()"
                            disabled>
                            <i class="bi bi-check-circle me-1"></i>Procesar Traslado
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts - ORDEN CRÍTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let todosLosItems = [];
        let asignacionesFuente = [];
        let asignacionesDestino = [];
        let asignacionFuenteSeleccionada = null;
        let asignacionDestinoSeleccionada = null;
        let modalTraslado = null;
        let currentUserId = null;

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 1. VALIDAR PERMISOS
                const hasAccess = await validatePageAccess('Iniciar traslado presupuestal');
                if (!hasAccess) return;

                // 2. OBTENER USER ID
                const session = getStoredSession();
                if (session && session.user && session.user.user_id) {
                    currentUserId = session.user.user_id;
                } else {
                    throw new Error('No se pudo obtener el ID del usuario');
                }

                // 3. INICIALIZAR COMPONENTES
                inicializarComponentes();
                configurarEventos();

                // 4. CARGAR DATOS
                await cargarItemsPresupuestales();

            } catch (error) {
                console.error('Error en inicialización:', error);
                showMessage('Error al inicializar la página: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // INICIALIZAR COMPONENTES
        // ==========================================
        function inicializarComponentes() {
            // Inicializar modal de Bootstrap
            const modalElement = document.getElementById('modal-traslado');
            modalTraslado = new bootstrap.Modal(modalElement);

            console.log('✅ Componentes inicializados');
        }

        // ==========================================
        // CONFIGURAR EVENTOS
        // ==========================================
        function configurarEventos() {
            // Evento de cambio en select de ítem fuente
            const selectItemFuente = document.getElementById('select-item-fuente');
            selectItemFuente.addEventListener('change', async function() {
                const itemId = this.value;
                if (itemId) {
                    await cargarAsignacionesFuente(itemId);
                } else {
                    document.getElementById('tabla-fuente-container').style.display = 'none';
                }
            });

            // Evento de cambio en select de ítem destino (en el modal)
            const selectItemDestino = document.getElementById('select-item-destino');
            selectItemDestino.addEventListener('change', async function() {
                limpiarErrorCampo('error-item-destino');
                const itemId = this.value;
                if (itemId) {
                    await cargarAsignacionesDestino(itemId);
                } else {
                    document.getElementById('seccion-destino').style.display = 'none';
                    asignacionDestinoSeleccionada = null;
                    validarFormularioTraslado();
                }
            });

            // Evento en el campo de valor
            const valorTraslado = document.getElementById('valor-traslado');
            valorTraslado.addEventListener('input', function() {
                formatearValorMonetario(this);
                limpiarErrorCampo('error-valor');
                validarFormularioTraslado();
            });

            // Evento en el editor de razones
            const razonesTraslado = document.getElementById('razones-traslado');
            razonesTraslado.addEventListener('input', function() {
                limpiarErrorCampo('error-razones');
                validarFormularioTraslado();
            });

            // Prevenir pérdida de datos
            window.addEventListener('beforeunload', function(e) {
                const razones = document.getElementById('razones-traslado');
                const valor = document.getElementById('valor-traslado');
                
                if (razones && razones.textContent.trim() !== '' || 
                    valor && valor.value.trim() !== '') {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            console.log('✅ Eventos configurados');
        }

        // ==========================================
        // CARGAR ÍTEMS PRESUPUESTALES
        // ==========================================
        async function cargarItemsPresupuestales() {
            mostrarLoading('Cargando ítems presupuestales...');
            
            try {
                // Obtener año presupuestal actual
                const configData = await supabaseRequest('/system_config?select=current_budget_year_id&limit=1');
                
                if (!configData || configData.length === 0) {
                    throw new Error('No se encontró configuración del sistema');
                }

                const currentYearId = configData[0].current_budget_year_id;

                // Query para obtener ítems con asignaciones disponibles
                const query = `/budget_items?select=item_id,item_name,budget_assignments!inner(assignment_id,approved_value,executed_value)&item_status=eq.active&budget_assignments.academic_year_id=eq.${currentYearId}&budget_assignments.approved_value=gt.0&order=item_name.asc`;
                
                const data = await supabaseRequest(query);
                
                // Filtrar ítems que tienen al menos una asignación con disponible > 0
                const itemsConDisponible = data.filter(item => {
                    return item.budget_assignments.some(asig => {
                        const disponible = (asig.approved_value || 0) - (asig.executed_value || 0);
                        return disponible > 0;
                    });
                });

                // Eliminar duplicados y mantener solo nombres únicos
                const itemsUnicos = [];
                const idsVistos = new Set();
                
                itemsConDisponible.forEach(item => {
                    if (!idsVistos.has(item.item_id)) {
                        idsVistos.add(item.item_id);
                        itemsUnicos.push({
                            item_id: item.item_id,
                            item_name: item.item_name
                        });
                    }
                });

                todosLosItems = itemsUnicos;

                // Llenar el select de ítems fuente
                const selectFuente = document.getElementById('select-item-fuente');
                selectFuente.innerHTML = '<option value="">Seleccione un ítem presupuestal...</option>';
                
                todosLosItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.item_id;
                    option.textContent = item.item_name;
                    selectFuente.appendChild(option);
                });

                ocultarLoading();
                
                if (todosLosItems.length > 0) {
                    showMessage(`${todosLosItems.length} ítems presupuestales disponibles para traslado.`, 'info');
                } else {
                    showMessage('No hay ítems presupuestales con asignaciones disponibles.', 'warning');
                }

                console.log(`✅ ${todosLosItems.length} ítems presupuestales cargados`);

            } catch (error) {
                ocultarLoading();
                console.error('Error cargando ítems:', error);
                showMessage('Error al cargar ítems presupuestales: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // CARGAR ASIGNACIONES FUENTE
        // ==========================================
        async function cargarAsignacionesFuente(itemId) {
            mostrarLoading('Cargando asignaciones...');
            
            try {
                // Obtener año presupuestal actual
                const configData = await supabaseRequest('/system_config?select=current_budget_year_id&limit=1');
                const currentYearId = configData[0].current_budget_year_id;

                // Query para obtener asignaciones del ítem seleccionado con disponible > 0
                const query = `/budget_assignments?select=assignment_id,category_detail,worker_id,approved_value,executed_value,workers!budget_assignments_worker_id_fkey(worker_first_name,worker_last_name_1,worker_last_name_2,email)&budget_item_id=eq.${itemId}&academic_year_id=eq.${currentYearId}&approved_value=gt.0&assignment_status=eq.active&order=category_detail.asc`;
                
                const data = await supabaseRequest(query);
                
                // Filtrar solo las que tienen disponible > 0
                asignacionesFuente = data.filter(asig => {
                    const disponible = (asig.approved_value || 0) - (asig.executed_value || 0);
                    return disponible > 0;
                });

                renderizarTablaAsignacionesFuente();
                
                document.getElementById('tabla-fuente-container').style.display = 'block';
                
                ocultarLoading();

                console.log(`✅ ${asignacionesFuente.length} asignaciones fuente cargadas`);

            } catch (error) {
                ocultarLoading();
                console.error('Error cargando asignaciones fuente:', error);
                showMessage('Error al cargar asignaciones: ' + error.message, 'danger');
            }
        }
      // ==========================================
        // RENDERIZAR TABLA DE ASIGNACIONES FUENTE
        // ==========================================
        function renderizarTablaAsignacionesFuente() {
            const tbody = document.getElementById('tbody-asignaciones-fuente');
            
            if (asignacionesFuente.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p>No hay asignaciones disponibles para este ítem</p>
                            <small class="text-muted">Todas las asignaciones están completamente ejecutadas</small>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            asignacionesFuente.forEach((asig, index) => {
                const workerName = formatWorkerName(asig.workers);
                const aprobado = asig.approved_value || 0;
                const ejecutado = asig.executed_value || 0;
                const disponible = aprobado - ejecutado;

                html += `
                    <tr>
                        <td><strong>${escapeHtml(asig.category_detail || 'Sin categoría')}</strong></td>
                        <td>${escapeHtml(workerName)}</td>
                        <td class="text-center">
                            <button 
                                class="btn-transferir" 
                                onclick="abrirModalTraslado(${index})"
                                ${disponible <= 0 ? 'disabled' : ''}>
                                <i class="bi bi-arrow-right-circle me-1"></i>Trasladar
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // ==========================================
        // ABRIR MODAL DE TRASLADO
        // ==========================================
        function abrirModalTraslado(index) {
            const asignacion = asignacionesFuente[index];
            asignacionFuenteSeleccionada = asignacion;

            // Establecer ID de la asignación fuente
            document.getElementById('source-assignment-id').value = asignacion.assignment_id;

            // Limpiar formulario
            limpiarFormularioTraslado();

            // Llenar select de ítems destino (todos los ítems)
            const selectDestino = document.getElementById('select-item-destino');
            selectDestino.innerHTML = '<option value="">Seleccione un ítem...</option>';
            
            todosLosItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.item_id;
                option.textContent = item.item_name;
                selectDestino.appendChild(option);
            });

            // Mostrar modal
            modalTraslado.show();

            // Enfocar en editor
            setTimeout(() => {
                document.getElementById('razones-traslado').focus();
            }, 300);
        }

        // ==========================================
        // CARGAR ASIGNACIONES DESTINO
        // ==========================================
        async function cargarAsignacionesDestino(itemId) {
            mostrarLoading('Cargando asignaciones destino...');
            
            try {
                // Obtener año presupuestal actual
                const configData = await supabaseRequest('/system_config?select=current_budget_year_id&limit=1');
                const currentYearId = configData[0].current_budget_year_id;

                // Query para obtener TODAS las asignaciones del ítem destino
                const query = `/budget_assignments?select=assignment_id,category_detail,worker_id,approved_value,executed_value,workers!budget_assignments_worker_id_fkey(worker_first_name,worker_last_name_1,worker_last_name_2,email)&budget_item_id=eq.${itemId}&academic_year_id=eq.${currentYearId}&approved_value=gt.0&assignment_status=eq.active&order=category_detail.asc`;

                
                const data = await supabaseRequest(query);
                asignacionesDestino = data;

                renderizarTablaAsignacionesDestino();
                
                document.getElementById('seccion-destino').style.display = 'block';
                
                ocultarLoading();

                console.log(`✅ ${asignacionesDestino.length} asignaciones destino cargadas`);

            } catch (error) {
                ocultarLoading();
                console.error('Error cargando asignaciones destino:', error);
                showMessage('Error al cargar asignaciones destino: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // RENDERIZAR TABLA DE ASIGNACIONES DESTINO
        // ==========================================
        function renderizarTablaAsignacionesDestino() {
            const tbody = document.getElementById('tbody-asignaciones-destino');
            
            if (asignacionesDestino.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p>No hay asignaciones disponibles para este ítem</p>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            asignacionesDestino.forEach((asig, index) => {
                const workerName = formatWorkerName(asig.workers);
                const aprobado = asig.approved_value || 0;
                const ejecutado = asig.executed_value || 0;
                const disponible = aprobado - ejecutado;

                // No permitir seleccionar la misma asignación fuente
                const isMismaAsignacion = asig.assignment_id === document.getElementById('source-assignment-id').value;

                html += `
                    <tr onclick="${!isMismaAsignacion ? `seleccionarAsignacionDestino(${index})` : ''}" 
                        class="${isMismaAsignacion ? 'table-secondary' : ''}"
                        style="${isMismaAsignacion ? 'cursor: not-allowed; opacity: 0.5;' : ''}">
                        <td>
                            <strong>${escapeHtml(asig.category_detail || 'Sin categoría')}</strong>
                            ${isMismaAsignacion ? '<span class="badge bg-warning ms-2">Asignación Fuente</span>' : ''}
                        </td>
                        <td>${escapeHtml(workerName)}</td>
                        <td class="valor-cell">${formatCurrency(aprobado)}</td>
                        <td class="valor-cell">${formatCurrency(ejecutado)}</td>
                        <td class="valor-cell ${disponible > 0 ? 'disponible-positivo' : 'disponible-cero'}">
                            ${formatCurrency(disponible)}
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // ==========================================
        // SELECCIONAR ASIGNACIÓN DESTINO
        // ==========================================
        function seleccionarAsignacionDestino(index) {
            const asignacion = asignacionesDestino[index];
            
            // No permitir seleccionar la misma asignación fuente
            if (asignacion.assignment_id === document.getElementById('source-assignment-id').value) {
                showMessage('No puede seleccionar la misma asignación como destino', 'warning');
                return;
            }

            asignacionDestinoSeleccionada = asignacion;
            document.getElementById('destination-assignment-id').value = asignacion.assignment_id;

            // Marcar fila seleccionada
            const tbody = document.getElementById('tbody-asignaciones-destino');
            const filas = tbody.querySelectorAll('tr');
            filas.forEach(fila => fila.classList.remove('selected'));
            filas[index].classList.add('selected');

            validarFormularioTraslado();

            console.log('✅ Asignación destino seleccionada:', asignacion.category_detail);
        }

        // ==========================================
        // LIMPIAR FORMULARIO DE TRASLADO
        // ==========================================
        function limpiarFormularioTraslado() {
            document.getElementById('razones-traslado').innerHTML = '';
            document.getElementById('valor-traslado').value = '';
            document.getElementById('select-item-destino').value = '';
            document.getElementById('destination-assignment-id').value = '';
            document.getElementById('seccion-destino').style.display = 'none';
            
            asignacionDestinoSeleccionada = null;
            asignacionesDestino = [];
            
            limpiarErroresModal();
            
            document.getElementById('btn-procesar-traslado').disabled = true;
        }
      // ==========================================
        // VALIDAR FORMULARIO DE TRASLADO
        // ==========================================
        function validarFormularioTraslado() {
            const razones = document.getElementById('razones-traslado').textContent.trim();
            const valor = limpiarValorMonetario(document.getElementById('valor-traslado').value);
            const itemDestino = document.getElementById('select-item-destino').value;
            const destinoSeleccionado = document.getElementById('destination-assignment-id').value;

            const esValido = razones !== '' && 
                            valor > 0 && 
                            itemDestino !== '' && 
                            destinoSeleccionado !== '';

            document.getElementById('btn-procesar-traslado').disabled = !esValido;

            return esValido;
        }

        // ==========================================
        // VALIDAR FORMULARIO COMPLETO
        // ==========================================
        function validarFormularioCompleto() {
            let esValido = true;
            limpiarErroresModal();

            // Validar razones
            const razones = document.getElementById('razones-traslado');
            const textoRazones = razones.textContent.trim();
            
            if (textoRazones === '') {
                mostrarErrorCampo('error-razones', 'Las razones del traslado son obligatorias');
                razones.classList.add('campo-obligatorio');
                esValido = false;
            }

            // Validar valor
            const valorInput = document.getElementById('valor-traslado');
            const valor = limpiarValorMonetario(valorInput.value);

            if (valorInput.value.trim() === '' || valor <= 0) {
                mostrarErrorCampo('error-valor', 'El valor del traslado es obligatorio');
                valorInput.classList.add('campo-obligatorio');
                esValido = false;
            }

            // Validar ítem destino
            const itemDestino = document.getElementById('select-item-destino');
            if (itemDestino.value === '') {
                mostrarErrorCampo('error-item-destino', 'Debe seleccionar un ítem de destino');
                itemDestino.classList.add('campo-obligatorio');
                esValido = false;
            }

            // Validar asignación destino seleccionada
            const destinoId = document.getElementById('destination-assignment-id').value;
            if (destinoId === '') {
                showMessage('Debe seleccionar una asignación de destino de la tabla', 'warning');
                esValido = false;
            }

            return esValido;
        }

        // ==========================================
        // PROCESAR TRASLADO
        // ==========================================
        async function procesarTraslado() {
            if (!validarFormularioCompleto()) {
                return;
            }

            const sourceAssignmentId = document.getElementById('source-assignment-id').value;
            const destinationAssignmentId = document.getElementById('destination-assignment-id').value;
            const valor = limpiarValorMonetario(document.getElementById('valor-traslado').value);
            const razones = document.getElementById('razones-traslado').innerHTML.trim();

            // Confirmar acción
            if (!confirm('¿Está seguro de procesar este traslado presupuestal?')) {
                return;
            }

            mostrarLoading('Procesando traslado...');

            try {
                // VALIDACIÓN: Verificar disponibilidad en tiempo real
                const queryValidacion = `/budget_assignments?select=approved_value,executed_value&assignment_id=eq.${sourceAssignmentId}`;
                const asigValidacion = await supabaseRequest(queryValidacion);
                
                if (!asigValidacion || asigValidacion.length === 0) {
                    throw new Error('No se pudo validar la asignación fuente');
                }

                const aprobado = asigValidacion[0].approved_value || 0;
                const ejecutado = asigValidacion[0].executed_value || 0;
                const disponible = aprobado - ejecutado;

                if (valor > disponible) {
                    ocultarLoading();
                    mostrarErrorCampo('error-valor', `El valor excede el disponible actual (${formatCurrency(disponible)})`);
                    document.getElementById('valor-traslado').classList.add('campo-obligatorio');
                    showMessage(`El valor del traslado (${formatCurrency(valor)}) excede el disponible actual (${formatCurrency(disponible)})`, 'danger');
                    return;
                }

                // Obtener fecha actual
                const ahora = new Date();
                const fechaActual = ahora.toISOString().split('T')[0]; // YYYY-MM-DD

                // Insertar registro en budget_transfers
                const transferData = {
                    source_assignment_id: sourceAssignmentId,
                    destination_assignment_id: destinationAssignmentId,
                    transfer_value: valor,
                    request_reason: razones,
                    transfer_status: 'pending',
                    start_date: fechaActual,
                    requested_by: currentUserId
                };

                const resultado = await supabaseRequest('/budget_transfers', {
                    method: 'POST',
                    body: JSON.stringify(transferData)
                });

                if (!resultado || resultado.length === 0) {
                    throw new Error('No se pudo crear el traslado');
                }

                // Enviar notificación al autorizador de la fuente
                await enviarNotificacionTraslado();

                ocultarLoading();
                modalTraslado.hide();

                showMessage('Traslado presupuestal creado exitosamente. Se ha enviado notificación al autorizador.', 'success');

                // Recargar tabla de asignaciones fuente
                const itemFuenteId = document.getElementById('select-item-fuente').value;
                if (itemFuenteId) {
                    await cargarAsignacionesFuente(itemFuenteId);
                }

                console.log('✅ Traslado creado exitosamente');

            } catch (error) {
                ocultarLoading();
                console.error('Error procesando traslado:', error);
                showMessage('Error al procesar traslado: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // ENVIAR NOTIFICACIÓN DE TRASLADO
        // ==========================================
        async function enviarNotificacionTraslado() {
            try {
                const emailAutorizador = asignacionFuenteSeleccionada.workers?.email;
                const valor = limpiarValorMonetario(document.getElementById('valor-traslado').value);
                const razones = document.getElementById('razones-traslado').innerHTML.trim();

                // Obtener nombres de ítems
                const itemFuenteId = document.getElementById('select-item-fuente').value;
                const itemDestinoId = document.getElementById('select-item-destino').value;
                
                const itemFuenteNombre = todosLosItems.find(i => i.item_id === itemFuenteId)?.item_name || 'N/A';
                const itemDestinoNombre = todosLosItems.find(i => i.item_id === itemDestinoId)?.item_name || 'N/A';

                const categoriaFuente = asignacionFuenteSeleccionada.category_detail || 'Sin categoría';
                const categoriaDestino = asignacionDestinoSeleccionada.category_detail || 'Sin categoría';

                // Construir asunto y cuerpo del correo
                const asunto = 'Hay una solicitud para que conceda un traslado presupuestal';
                
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
                        <h2 style="color: #0d6efd;">Solicitud de Traslado Presupuestal</h2>
                        
                        <p>De su asignación <strong>${escapeHtml(itemFuenteNombre)} - ${escapeHtml(categoriaFuente)}</strong> se ha solicitado una reasignación para <strong>${escapeHtml(itemDestinoNombre)} - ${escapeHtml(categoriaDestino)}</strong> por valor de <strong>${formatCurrency(valor)}</strong>.</p>
                        
                        <div style="background-color: #f8f9fa; padding: 15px; border-left: 4px solid #0d6efd; margin: 20px 0;">
                            <h3 style="margin-top: 0; color: #0d6efd;">Razones del traslado:</h3>
                            <div>${razones}</div>
                        </div>
                        
                        <p>Recuerda entrar al sistema para resolver esta solicitud.</p>
                        
                        <hr style="margin: 30px 0; border: none; border-top: 1px solid #dee2e6;">
                        <p style="font-size: 12px; color: #6c757d;">
                            Este mensaje se ha generado de forma automática por el sistema SchoolNet. Por favor, no respondas a este correo.
                        </p>
                    </div>
                `;

                // Enviar notificación usando la función de config.js
                await sendNotification(emailAutorizador, asunto, htmlContent, false);
                
                console.log('✅ Notificación enviada a:', emailAutorizador);

            } catch (error) {
                console.error('Error enviando notificación:', error);
                // No lanzar error para no afectar el proceso principal
                console.warn('El traslado se creó pero falló el envío de correo');
            }
        }

        // ==========================================
        // LIMPIAR ERRORES DEL MODAL
        // ==========================================
        function limpiarErroresModal() {
            limpiarErrorCampo('error-razones');
            limpiarErrorCampo('error-valor');
            limpiarErrorCampo('error-item-destino');
            
            document.getElementById('razones-traslado').classList.remove('campo-obligatorio');
            document.getElementById('valor-traslado').classList.remove('campo-obligatorio');
            document.getElementById('select-item-destino').classList.remove('campo-obligatorio');
        }

        // ==========================================
        // MOSTRAR ERROR EN CAMPO
        // ==========================================
        function mostrarErrorCampo(idError, mensaje) {
            const errorElement = document.getElementById(idError);
            if (errorElement) {
                errorElement.textContent = mensaje;
                errorElement.style.display = 'block';
            }
        }

        // ==========================================
        // LIMPIAR ERROR DE CAMPO
        // ==========================================
        function limpiarErrorCampo(idError) {
            const errorElement = document.getElementById(idError);
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
        }
      // ==========================================
        // FUNCIONES DEL EDITOR DE TEXTO ENRIQUECIDO
        // ==========================================
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('razones-traslado').focus();
        }

        function insertList(type) {
            const command = type === 'ul' ? 'insertUnorderedList' : 'insertOrderedList';
            document.execCommand(command, false, null);
            document.getElementById('razones-traslado').focus();
        }

        // ==========================================
        // FORMATEAR VALOR MONETARIO
        // ==========================================
        function formatearValorMonetario(input) {
            // Obtener solo números
            let valor = input.value.replace(/\D/g, '');
            
            if (valor === '') {
                input.value = '';
                return;
            }

            // Formatear con separadores de miles
            valor = parseInt(valor);
            input.value = valor.toLocaleString('es-CO');
        }

        // ==========================================
        // LIMPIAR VALOR MONETARIO
        // ==========================================
        function limpiarValorMonetario(valorFormateado) {
            if (!valorFormateado) return 0;
            const valorLimpio = valorFormateado.replace(/\D/g, '');
            return parseInt(valorLimpio) || 0;
        }

        // ==========================================
        // FUNCIONES DE LOADING
        // ==========================================
        function mostrarLoading(mensaje = 'Procesando...') {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            
            if (loadingOverlay) {
                loadingMessage.textContent = mensaje;
                loadingOverlay.classList.remove('hidden');
            }
        }

        function ocultarLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }

        // ==========================================
        // FUNCIONES DE FORMATEO
        // ==========================================
        function formatCurrency(valor) {
            if (!valor || isNaN(valor)) return '$0';
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(valor);
        }

        function formatWorkerName(worker) {
            if (!worker) return 'N/A';
            
            const firstName = worker.worker_first_name || '';
            const lastName1 = worker.worker_last_name_1 || '';
            const lastName2 = worker.worker_last_name_2 || '';
            
            if (lastName2 && lastName2.trim()) {
                return `${lastName1} ${lastName2} ${firstName}`.trim();
            } else {
                return `${lastName1} ${firstName}`.trim();
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================
        // HACER FUNCIONES GLOBALES
        // ==========================================
        window.abrirModalTraslado = abrirModalTraslado;
        window.seleccionarAsignacionDestino = seleccionarAsignacionDestino;
        window.procesarTraslado = procesarTraslado;
        window.formatText = formatText;
        window.insertList = insertList;

        console.log('✅ Página de Traslados Presupuestales cargada correctamente');
    </script>
</body>
</html>
