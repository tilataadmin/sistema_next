<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petici√≥n de Presupuesto - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        :root {
            --color-primary: #2c3e50;
            --color-secondary: #3498db;
            --color-success: #27ae60;
            --color-warning: #f39c12;
            --color-danger: #e74c3c;
            --color-info: #17a2b8;
            --color-light: #f8f9fa;
            --color-dark: #343a40;
            --border-radius: 8px;
        }

        body {
            background-color: var(--color-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .page-header h1 {
            margin: 0;
            font-weight: 300;
        }

        .year-selector-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid var(--color-secondary);
        }

        .year-selector-section h3 {
            color: var(--color-primary);
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .year-selector-section select {
            font-size: 1.1rem;
            padding: 0.75rem;
            min-width: 250px;
        }

        .resumen-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .resumen-section h3 {
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-secondary);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .resumen-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background-color: var(--color-light);
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--color-secondary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
        }

        .tabla-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tabla-section h3 {
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-secondary);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .tabla-presupuesto {
            width: 100%;
        }

        .tabla-presupuesto th {
            background-color: var(--color-primary);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            border: none;
        }

        .tabla-presupuesto td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }

        .tabla-presupuesto tr:hover {
            background-color: #f8f9fa;
        }

        .col-subitem {
            width: 40%;
            font-weight: 600;
        }

        .col-detalle {
            width: 35%;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .col-valor {
            width: 25%;
        }

        .input-valor {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 1rem;
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .input-valor:focus {
            border-color: var(--color-secondary);
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .input-valor.modificado {
            background-color: #fff3cd;
            border-color: var(--color-warning);
        }

        .no-data-message {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
            font-style: italic;
            background-color: var(--color-light);
            border-radius: var(--border-radius);
            margin: 2rem 0;
        }

        .no-data-message i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }

        .acciones-section {
            background: var(--color-light);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .btn-guardar-masivo {
            background-color: var(--color-success);
            color: white;
            padding: 12px 24px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-guardar-masivo:hover:not(:disabled) {
            background-color: #219a52;
            transform: translateY(-1px);
        }

        .btn-guardar-masivo:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .formato-ayuda {
            font-size: 0.85rem;
            color: #6c757d;
            font-style: italic;
            margin-top: 0.75rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }
            
            .page-header {
                padding: 1rem;
            }
            
            .resumen-stats {
                grid-template-columns: 1fr;
            }
            
            .tabla-presupuesto {
                font-size: 0.85rem;
            }
            
            .col-subitem,
            .col-detalle,
            .col-valor {
                width: auto;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <div class="main-container">
        <!-- Navegaci√≥n de breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <div id="breadcrumbContainer"></div>
        </nav>

        <!-- Encabezado de la p√°gina -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="bi bi-clipboard-check me-2"></i>Petici√≥n de Presupuesto</h1>
                    <p class="mb-0 opacity-75">Solicitud de valores presupuestales por asignaci√≥n</p>
                </div>
                <div>
                    <button id="btn-manual" class="btn btn-outline-light" style="display: none;">
                        <i class="bi bi-book me-1"></i>Manual
                    </button>
                </div>
            </div>
        </div>

        <!-- Contenedor de mensajes -->
        <div id="alertContainer"></div>

        <!-- Selector de a√±o -->
        <div class="year-selector-section">
            <h3><i class="bi bi-calendar-event me-2"></i>Selecci√≥n de A√±o Acad√©mico</h3>
            <div class="d-flex align-items-center gap-3">
                <label for="select-anio" class="form-label mb-0 fw-semibold">A√±o Acad√©mico:</label>
                <select id="select-anio" class="form-select" disabled>
                    <option value="">Cargando a√±os acad√©micos...</option>
                </select>
            </div>
        </div>

        <!-- Contenedor principal de presupuesto (inicialmente oculto) -->
        <div id="presupuesto-container" class="d-none">
            
            <!-- Resumen estad√≠stico -->
            <div id="resumen-section" class="resumen-section">
                <h3><i class="bi bi-bar-chart me-2"></i>Resumen del Presupuesto</h3>
                <div class="resumen-stats">
                    <div class="stat-item">
                        <div id="stat-total-asignaciones" class="stat-value">0</div>
                        <div class="stat-label">Total Asignaciones</div>
                    </div>
                    <div class="stat-item">
                        <div id="stat-con-solicitud" class="stat-value">0</div>
                        <div class="stat-label">Con Valor Solicitado</div>
                    </div>
                    <div class="stat-item">
                        <div id="stat-total-solicitado" class="stat-value">$0</div>
                        <div class="stat-label">Total Solicitado</div>
                    </div>
                    <div class="stat-item">
                        <div id="stat-total-aprobado" class="stat-value">$0</div>
                        <div class="stat-label">Total Aprobado</div>
                    </div>
                </div>
            </div>

            <!-- Tabla de asignaciones presupuestales -->
            <div class="tabla-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">
                        <i class="bi bi-table me-2"></i>Asignaciones Presupuestales
                    </h3>
                    <span id="total-asignaciones-badge" class="badge bg-primary">0 asignaciones</span>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover tabla-presupuesto">
                        <thead>
                            <tr>
                                <th class="col-subitem">Sub-√≠tem Presupuestal</th>
                                <th class="col-detalle">Detalle / Categor√≠a</th>
                                <th class="col-valor">Valor Solicitado</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-presupuesto-body">
                            <!-- Los datos se cargar√°n din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Acciones -->
            <div id="acciones-section" class="acciones-section">
                <button id="btn-guardar-cambios" class="btn btn-guardar-masivo" disabled>
                    <i class="bi bi-save me-2"></i>Guardar Todos los Cambios
                </button>
                <div class="formato-ayuda">
                    <i class="bi bi-info-circle me-1"></i>
                    Formato: Use n√∫meros sin puntos ni comas (ej: 1500000 para $1.500.000)
                </div>
            </div>
        </div>

        <!-- Mensaje cuando no hay datos -->
        <div id="no-data-section" class="d-none">
            <div class="no-data-message">
                <i class="bi bi-inbox"></i>
                <h4>No se encontraron asignaciones</h4>
                <p class="mb-2">No hay asignaciones presupuestales para el a√±o seleccionado.</p>
                <p class="mb-0">Contacte al administrador si considera que deber√≠a tener asignaciones para este a√±o.</p>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Configuraci√≥n del sistema -->
    <script src="../../assets/js/config.js"></script>

  <script>
        /**
         * JavaScript para Petici√≥n de Presupuesto - SchoolNet
         * Migrado desde Google Apps Script a Next.js
         */

        // Variables globales
        let datosCompletos = {
            anios: [],
            asignaciones: [],
            asignacionesPorAnio: new Map()
        };

        // Control de modificaciones
        let modificacionesPendientes = new Map();
        let elementos = {};

        /**
         * Inicializaci√≥n cuando se carga el DOM
         */
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Petici√≥n de presupuesto');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');

                // Implementar breadcrumbs autom√°ticamente
                const breadcrumbContainer = document.getElementById('breadcrumbContainer');
                if (breadcrumbContainer) {
                    breadcrumbContainer.innerHTML = generateBreadcrumbs('Presupuesto', 'Petici√≥n de Presupuesto');
                }

                // Continuar con inicializaci√≥n
                inicializarElementos();
                configurarEventListeners();
                await cargarDatosIniciales();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });

        /**
         * Cachea referencias a elementos DOM
         */
        function inicializarElementos() {
            elementos = {
                selectAnio: document.getElementById('select-anio'),
                presupuestoContainer: document.getElementById('presupuesto-container'),
                resumenSection: document.getElementById('resumen-section'),
                tablaPresupuestoBody: document.getElementById('tabla-presupuesto-body'),
                totalAsignacionesBadge: document.getElementById('total-asignaciones-badge'),
                accionesSection: document.getElementById('acciones-section'),
                noDataSection: document.getElementById('no-data-section'),
                btnGuardarCambios: document.getElementById('btn-guardar-cambios'),
                
                // Stats del resumen
                statTotalAsignaciones: document.getElementById('stat-total-asignaciones'),
                statConSolicitud: document.getElementById('stat-con-solicitud'),
                statTotalSolicitado: document.getElementById('stat-total-solicitado'),
                statTotalAprobado: document.getElementById('stat-total-aprobado'),
                
                // Otros elementos
                loadingOverlay: document.getElementById('loading-overlay')
            };
        }

        /**
         * Configura event listeners
         */
        function configurarEventListeners() {
            // Cambio de a√±o - respuesta instant√°nea local
            elementos.selectAnio.addEventListener('change', function() {
                const yearId = parseInt(this.value);
                if (yearId) {
                    filtrarPorAnioLocal(yearId);
                } else {
                    ocultarPresupuesto();
                }
            });
            
            // Guardar cambios
            elementos.btnGuardarCambios.addEventListener('click', function() {
                if (modificacionesPendientes.size > 0) {
                    guardarCambios();
                }
            });
            
            // Atajo Ctrl+S para guardar
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (modificacionesPendientes.size > 0) {
                        guardarCambios();
                    }
                }
            });
        }

        /**
         * Carga datos iniciales
         */

      /**
 * Carga datos iniciales - VERSI√ìN CON DEBUGGING
 */
async function cargarDatosIniciales() {
    try {
        mostrarLoading('Cargando datos iniciales...');
        
        // PASO 1: Cargar a√±os acad√©micos
        console.log('üìÖ Cargando a√±os acad√©micos...');
        const aniosData = await supabaseRequest('/academic_years?select=year_id,year_name,year_order&order=year_order.desc');
        datosCompletos.anios = aniosData || [];
        console.log('‚úÖ A√±os cargados:', datosCompletos.anios.length);
        cargarSelectorAnios();
        
        // PASO 2: Obtener usuario actual para filtrar asignaciones
        const session = getStoredSession();
        console.log('üë§ Sesi√≥n obtenida:', session ? 'S√ç' : 'NO');
        
        if (!session || !session.user) {
            throw new Error('No hay sesi√≥n de usuario activa');
        }
        
        const userEmail = session.user.user_mail;
        console.log('üìß Email del usuario logueado:', userEmail);
        
        if (!userEmail) {
            throw new Error('No se pudo obtener el email del usuario actual');
        }
        
        // PASO 3: Verificar si el usuario existe en workers
        console.log('üîç Verificando usuario en tabla workers...');
        const workerVerification = await supabaseRequest(`/workers?select=worker_id,email&email=eq.${userEmail}`);
        console.log('üë∑ Worker encontrado:', workerVerification);
        
        // PASO 4: Cargar TODAS las asignaciones para debugging
        console.log('üîç Consultando TODAS las asignaciones (para debugging)...');
        const todasAsignaciones = await supabaseRequest('/budget_assignments?select=assignment_id,worker_email,assignment_status&limit=10');
        console.log('üìä Muestra de todas las asignaciones:', todasAsignaciones);
        
        // PASO 5: Cargar asignaciones del usuario espec√≠fico
        console.log('üéØ Consultando asignaciones espec√≠ficas del usuario...');
        const asignacionesQuery = `/budget_assignments?select=assignment_id,academic_year_id,budget_item_id,category_detail,requested_value,approved_value,budget_items(item_name),academic_years(year_name,year_order)&worker_email=eq.${userEmail}&assignment_status=eq.active&order=academic_years(year_order).desc,budget_items(item_name).asc`;
        
        console.log('üîó URL de consulta:', asignacionesQuery);
        
        const asignacionesData = await supabaseRequest(asignacionesQuery);
        console.log('üìã Asignaciones del usuario encontradas:', asignacionesData ? asignacionesData.length : 'NULL');
        console.log('üìã Datos completos de asignaciones:', asignacionesData);
        
        if (asignacionesData) {
            // Procesar datos para formato consistente
            datosCompletos.asignaciones = asignacionesData.map(asignacion => ({
                assignment_id: asignacion.assignment_id,
                year_id: asignacion.academic_year_id,
                budget_item_id: asignacion.budget_item_id,
                category_detail: asignacion.category_detail || 'General',
                requested_value: asignacion.requested_value || 0,
                approved_value: asignacion.approved_value || 0,
                item_name: asignacion.budget_items?.item_name || 'Sin nombre',
                year_name: asignacion.academic_years?.year_name || 'Sin a√±o',
                year_order: asignacion.academic_years?.year_order || 0
            }));
        } else {
            datosCompletos.asignaciones = [];
        }
        
        console.log('‚úÖ Asignaciones procesadas:', datosCompletos.asignaciones.length);
        
        // PASO 6: Organizar asignaciones por a√±o para b√∫squeda r√°pida
        organizarAsignacionesPorAnio();
        
        ocultarLoading();
        showMessage(`Datos cargados: ${datosCompletos.anios.length} a√±os, ${datosCompletos.asignaciones.length} asignaciones`, 'success');
        
    } catch (error) {
        console.error('‚ùå Error al cargar datos iniciales:', error);
        showMessage('Error al cargar datos iniciales: ' + error.message, 'danger');
        ocultarLoading();
    }
}

      
        /**
         * Carga el selector de a√±os acad√©micos
         */
        function cargarSelectorAnios() {
            elementos.selectAnio.innerHTML = '<option value="">-- Seleccione un a√±o acad√©mico --</option>';
            
            datosCompletos.anios.forEach(anio => {
                const option = document.createElement('option');
                option.value = anio.year_id;
                option.textContent = anio.year_name;
                elementos.selectAnio.appendChild(option);
            });
            
            elementos.selectAnio.disabled = false;
        }

        /**
         * Organiza asignaciones por a√±o para b√∫squeda r√°pida
         */
        function organizarAsignacionesPorAnio() {
            datosCompletos.asignacionesPorAnio.clear();
            
            datosCompletos.asignaciones.forEach(asignacion => {
                const yearId = asignacion.year_id;
                if (!datosCompletos.asignacionesPorAnio.has(yearId)) {
                    datosCompletos.asignacionesPorAnio.set(yearId, []);
                }
                datosCompletos.asignacionesPorAnio.get(yearId).push(asignacion);
            });
            
            console.log(`‚úÖ Datos organizados: ${datosCompletos.asignacionesPorAnio.size} a√±os con asignaciones`);
        }

        /**
         * Filtra por a√±o localmente (sin servidor)
         */
        function filtrarPorAnioLocal(yearId) {
            const asignacionesAnio = datosCompletos.asignacionesPorAnio.get(yearId) || [];
            
            if (asignacionesAnio.length > 0) {
                mostrarPresupuesto();
                renderizarTabla(asignacionesAnio);
                calcularResumen(asignacionesAnio);
                elementos.totalAsignacionesBadge.textContent = `${asignacionesAnio.length} asignaciones`;
            } else {
                mostrarNoData();
            }
        }

        /**
         * Muestra la secci√≥n de presupuesto
         */
        function mostrarPresupuesto() {
            elementos.presupuestoContainer.classList.remove('d-none');
            elementos.noDataSection.classList.add('d-none');
        }

        /**
         * Oculta la secci√≥n de presupuesto
         */
        function ocultarPresupuesto() {
            elementos.presupuestoContainer.classList.add('d-none');
            elementos.noDataSection.classList.add('d-none');
        }

        /**
         * Muestra mensaje de no hay datos
         */
        function mostrarNoData() {
            elementos.noDataSection.classList.remove('d-none');
            elementos.presupuestoContainer.classList.add('d-none');
        }

        /**
         * Muestra overlay de loading
         */
        function mostrarLoading(mensaje = 'Cargando...') {
            elementos.loadingOverlay.querySelector('p').textContent = mensaje;
            elementos.loadingOverlay.classList.remove('hidden');
        }

        /**
         * Oculta overlay de loading
         */
        function ocultarLoading() {
            elementos.loadingOverlay.classList.add('hidden');
        }

        // Aplicar branding y configuraci√≥n autom√°ticamente
        updatePageTitle('budgetRequest', 'Presupuesto');
        initializePage();

        console.log('üéâ Petici√≥n de Presupuesto - SchoolNet v1.0 - Parte 2 cargada');
    /**
         * Renderiza la tabla de asignaciones presupuestales
         */
        function renderizarTabla(asignaciones) {
            elementos.tablaPresupuestoBody.innerHTML = '';
            
            if (!asignaciones || asignaciones.length === 0) {
                elementos.tablaPresupuestoBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center py-4 text-muted">
                            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                            <p class="mb-0 mt-2">No hay asignaciones para este a√±o</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            asignaciones.forEach(asignacion => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td class="col-subitem">
                        <strong>${escapeHtml(asignacion.item_name)}</strong>
                    </td>
                    <td class="col-detalle">
                        ${escapeHtml(asignacion.category_detail)}
                    </td>
                    <td class="col-valor">
                        <input type="text" 
                               class="input-valor form-control" 
                               data-assignment-id="${asignacion.assignment_id}"
                               data-valor-original="${asignacion.requested_value || 0}"
                               value="${formatearNumero(asignacion.requested_value || 0)}"
                               placeholder="0">
                    </td>
                `;
                
                fragment.appendChild(tr);
            });
            
            elementos.tablaPresupuestoBody.appendChild(fragment);
            configurarInputsValor();
        }

        /**
         * Configura los inputs de valor con eventos
         */
        function configurarInputsValor() {
            const inputs = elementos.tablaPresupuestoBody.querySelectorAll('.input-valor');
            
            inputs.forEach(input => {
                // Cambio inmediato - sin debouncing
                input.addEventListener('input', function() {
                    const assignmentId = parseInt(this.dataset.assignmentId);
                    const valorOriginal = parseInt(this.dataset.valorOriginal);
                    
                    // Solo n√∫meros
                    let valor = this.value.replace(/[^\d]/g, '');
                    this.value = valor;
                    
                    const valorActual = parseInt(valor) || 0;
                    
                    if (valorActual !== valorOriginal) {
                        this.classList.add('modificado');
                        modificacionesPendientes.set(assignmentId, valorActual);
                    } else {
                        this.classList.remove('modificado');
                        modificacionesPendientes.delete(assignmentId);
                    }
                    
                    actualizarBotonGuardar();
                    recalcularResumen();
                });
                
                // Formatear al salir del campo
                input.addEventListener('blur', function() {
                    const valor = parseInt(this.value.replace(/[^\d]/g, '')) || 0;
                    this.value = formatearNumero(valor);
                });
                
                // Solo permitir n√∫meros
                input.addEventListener('keypress', function(e) {
                    if (!/[\d]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) {
                        e.preventDefault();
                    }
                });
                
                // Seleccionar todo al hacer focus
                input.addEventListener('focus', function() {
                    this.select();
                });
            });
        }

        /**
         * Calcula y muestra el resumen estad√≠stico
         */
        function calcularResumen(asignaciones) {
            const resumen = {
                total_asignaciones: asignaciones.length,
                asignaciones_con_solicitud: 0,
                total_solicitado: 0,
                total_aprobado: 0
            };
            
            asignaciones.forEach(asignacion => {
                const valorReq = asignacion.requested_value || 0;
                const valorApr = asignacion.approved_value || 0;
                
                if (valorReq > 0) {
                    resumen.asignaciones_con_solicitud++;
                }
                
                resumen.total_solicitado += valorReq;
                resumen.total_aprobado += valorApr;
            });
            
            mostrarResumen(resumen);
        }

        /**
         * Recalcula el resumen basado en valores actuales de inputs
         */
        function recalcularResumen() {
            let totalSolicitado = 0;
            let conSolicitud = 0;
            let totalAsignaciones = 0;
            
            const inputs = elementos.tablaPresupuestoBody.querySelectorAll('.input-valor');
            inputs.forEach(input => {
                totalAsignaciones++;
                const valor = parseInt(input.value.replace(/[^\d]/g, '')) || 0;
                totalSolicitado += valor;
                if (valor > 0) {
                    conSolicitud++;
                }
            });
            
            // Actualizar solo valores que cambian din√°micamente
            elementos.statTotalSolicitado.textContent = formatearMoneda(totalSolicitado);
            elementos.statConSolicitud.textContent = conSolicitud;
            elementos.statTotalAsignaciones.textContent = totalAsignaciones;
        }

        /**
         * Muestra el resumen estad√≠stico
         */
        function mostrarResumen(resumen) {
            elementos.statTotalAsignaciones.textContent = resumen.total_asignaciones;
            elementos.statConSolicitud.textContent = resumen.asignaciones_con_solicitud;
            elementos.statTotalSolicitado.textContent = formatearMoneda(resumen.total_solicitado);
            elementos.statTotalAprobado.textContent = formatearMoneda(resumen.total_aprobado);
        }

        /**
         * Actualiza el estado del bot√≥n de guardar
         */
        function actualizarBotonGuardar() {
            const tieneModificaciones = modificacionesPendientes.size > 0;
            elementos.btnGuardarCambios.disabled = !tieneModificaciones;
            
            if (tieneModificaciones) {
                elementos.btnGuardarCambios.innerHTML = `<i class="bi bi-save me-2"></i>Guardar ${modificacionesPendientes.size} Cambio(s)`;
                elementos.btnGuardarCambios.classList.remove('btn-secondary');
                elementos.btnGuardarCambios.classList.add('btn-guardar-masivo');
            } else {
                elementos.btnGuardarCambios.innerHTML = '<i class="bi bi-save me-2"></i>Guardar Todos los Cambios';
                elementos.btnGuardarCambios.classList.remove('btn-guardar-masivo');
                elementos.btnGuardarCambios.classList.add('btn-secondary');
            }
        }

        /**
         * Guarda los cambios pendientes
         */
        async function guardarCambios() {
            if (modificacionesPendientes.size === 0) {
                return;
            }
            
            try {
                elementos.btnGuardarCambios.disabled = true;
                elementos.btnGuardarCambios.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Guardando...';
                mostrarLoading('Guardando cambios...');
                
                // Preparar actualizaciones
                const actualizaciones = [];
                modificacionesPendientes.forEach((valor, assignmentId) => {
                    actualizaciones.push({
                        assignmentId: assignmentId,
                        requestedValue: valor
                    });
                });
                
                // Enviar actualizaciones una por una (m√°s confiable que batch)
                let actualizacionesExitosas = 0;
                for (const actualizacion of actualizaciones) {
                    try {
                        await supabaseRequest(`/budget_assignments?assignment_id=eq.${actualizacion.assignmentId}`, {
                            method: 'PATCH',
                            body: JSON.stringify({
                                requested_value: actualizacion.requestedValue
                            })
                        });
                        actualizacionesExitosas++;
                    } catch (error) {
                        console.error(`Error actualizando asignaci√≥n ${actualizacion.assignmentId}:`, error);
                    }
                }
                
                if (actualizacionesExitosas > 0) {
                    // Actualizar datos locales
                    actualizarDatosLocales();
                    
                    // Limpiar modificaciones pendientes
                    modificacionesPendientes.clear();
                    
                    // Actualizar valores originales en inputs
                    actualizarValoresOriginales();
                    
                    showMessage(`Se actualizaron ${actualizacionesExitosas} registros correctamente`, 'success');
                } else {
                    showMessage('No se pudo actualizar ning√∫n registro', 'danger');
                }
                
            } catch (error) {
                console.error('Error al guardar cambios:', error);
                showMessage('Error al guardar cambios: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
                elementos.btnGuardarCambios.disabled = false;
                actualizarBotonGuardar();
            }
        }

        /**
         * Actualiza los datos locales despu√©s de guardar
         */
        function actualizarDatosLocales() {
            modificacionesPendientes.forEach((valor, assignmentId) => {
                // Buscar en asignaciones y actualizar
                const asignacion = datosCompletos.asignaciones.find(a => a.assignment_id === assignmentId);
                if (asignacion) {
                    asignacion.requested_value = valor;
                }
            });
            
            // Reorganizar por a√±o
            organizarAsignacionesPorAnio();
        }

        /**
         * Actualiza los valores originales en los inputs despu√©s de guardar
         */
        function actualizarValoresOriginales() {
            const inputs = elementos.tablaPresupuestoBody.querySelectorAll('.input-valor');
            inputs.forEach(input => {
                const valorActual = parseInt(input.value.replace(/[^\d]/g, '')) || 0;
                input.dataset.valorOriginal = valorActual;
                input.classList.remove('modificado');
            });
        }

        /**
         * Formatea n√∫mero con separadores de miles
         */
        function formatearNumero(numero) {
            return parseInt(numero || 0).toLocaleString('es-CO');
        }

        /**
         * Formatea n√∫mero como moneda
         */
        function formatearMoneda(numero) {
            return '$' + parseInt(numero || 0).toLocaleString('es-CO');
        }

        /**
         * Escapa HTML para prevenir XSS
         */
        function escapeHtml(text) {
            if (text === null || text === undefined) {
                return '';
            }
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Manejo de errores globales de JavaScript
         */
        window.addEventListener('error', function(e) {
            console.error('Error global capturado:', e.error);
            showMessage('Se ha producido un error inesperado. Por favor, recargue la p√°gina.', 'danger');
        });

        /**
         * Prevenir p√©rdida de datos al salir
         */
        window.addEventListener('beforeunload', function(e) {
            if (modificacionesPendientes.size > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        console.log('Petici√≥n de Presupuesto - Parte 3: Renderizado y estad√≠sticas cargadas');
    </script>
</body>
</html>

    
