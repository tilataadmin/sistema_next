<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autorización de Presupuesto - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        :root {
            --color-primary: #2c3e50;
            --color-secondary: #3498db;
            --color-success: #27ae60;
            --color-warning: #f39c12;
            --color-danger: #e74c3c;
            --color-info: #17a2b8;
            --color-light: #f8f9fa;
            --color-dark: #343a40;
            --border-radius: 8px;
        }

        body {
            background-color: var(--color-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .filters-section, .navigation-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters-section h3, .navigation-section h3 {
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-secondary);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .filters-row {
            display: flex;
            gap: 1rem;
            align-items: end;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .record-navigation {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .record-counter {
            font-weight: 600;
            color: var(--color-primary);
            font-size: 1.1rem;
        }

        .nav-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .record-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .readonly-field {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }

        .currency-field {
            text-align: right;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .currency-field.editable {
            background-color: white;
            color: var(--color-primary);
            border: 2px solid var(--color-secondary);
        }

        .record-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .save-button {
            display: flex;
            gap: 0.5rem;
        }

        .no-records {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
            font-style: italic;
        }

        .loading-records {
            text-align: center;
            padding: 3rem;
            color: var(--color-secondary);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modified-indicator {
            color: var(--color-warning);
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        @media (max-width: 768px) {
            .filters-row {
                flex-direction: column;
            }
            
            .record-form {
                grid-template-columns: 1fr;
            }
            
            .nav-header {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            
            .nav-controls {
                justify-content: center;
            }
            
            .record-actions {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS MODERNOS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Presupuesto</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Autorización de Presupuesto
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO MODERNO -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-check2-square me-2"></i>
                    Autorización de Presupuesto
                </h1>
                <p class="text-muted">
                    Aprobación de valores presupuestales por asignación
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- Sección de filtros -->
        <div class="filters-section">
            <h3><i class="bi bi-funnel me-2"></i>Filtros de Búsqueda</h3>
            <div class="filters-row">
                <div class="filter-group">
                    <label for="select-anio" class="form-label">Año Académico <span class="text-danger">*</span></label>
                    <select id="select-anio" class="form-select" required>
                        <option value="">-- Seleccione un año --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="select-rubro" class="form-label">Rubro Presupuestal <span class="text-danger">*</span></label>
                    <select id="select-rubro" class="form-select" required disabled>
                        <option value="">-- Seleccione un rubro --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="form-label">&nbsp;</label>
                    <button id="btn-buscar" class="btn btn-primary w-100" disabled>
                        <i class="bi bi-search me-1"></i>Buscar Asignaciones
                    </button>
                </div>
            </div>
        </div>
        <!-- Sección de navegación de registros -->
        <div id="navigation-section" class="navigation-section hidden">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Autorización de Valores</h3>
                <span id="total-asignaciones" class="badge bg-primary">0 asignaciones</span>
            </div>

            <div class="record-navigation">
                <div class="nav-header">
                    <div class="record-counter">
                        Registro <span id="current-record">0</span> de <span id="total-records">0</span>
                        <span id="modified-indicator" class="modified-indicator hidden">● Modificado</span>
                    </div>
                    <div class="nav-controls">
                        <button id="btn-anterior" class="btn btn-outline-secondary btn-sm" disabled>
                            <i class="bi bi-chevron-left"></i> Anterior
                        </button>
                        <button id="btn-siguiente" class="btn btn-outline-secondary btn-sm" disabled>
                            Siguiente <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Formulario de registro actual -->
                <div class="record-form">
                    <div class="form-group">
                        <label for="field-subitem" class="form-label">Sub-ítem:</label>
                        <input type="text" id="field-subitem" class="form-control readonly-field" readonly>
                    </div>

                    <div class="form-group">
                        <label for="field-distribucion" class="form-label">Distribución:</label>
                        <input type="text" id="field-distribucion" class="form-control readonly-field" readonly>
                    </div>

                    <div class="form-group full-width">
                        <label for="field-responsable" class="form-label">Responsable:</label>
                        <input type="text" id="field-responsable" class="form-control readonly-field" readonly>
                    </div>

                    <div class="form-group">
                        <label for="field-valor-solicitado" class="form-label">Valor Solicitado:</label>
                        <input type="text" id="field-valor-solicitado" class="form-control readonly-field currency-field" readonly>
                    </div>

                    <div class="form-group">
                        <label for="field-valor-aprobado" class="form-label">Valor Aprobado <span class="text-danger">*</span>:</label>
                        <input type="number" id="field-valor-aprobado" class="form-control currency-field editable" 
                               placeholder="Ingrese el valor aprobado" min="0" step="1">
                        <div class="form-text">Ingrese solo números enteros (sin puntos ni comas)</div>
                    </div>
                </div>

                <!-- Controles de navegación y guardado -->
                <div class="record-actions">
                    <div class="nav-buttons">
                        <button id="btn-primer-registro" class="btn btn-outline-info btn-sm" disabled>
                            <i class="bi bi-skip-start"></i> Primero
                        </button>
                        <button id="btn-ultimo-registro" class="btn btn-outline-info btn-sm" disabled>
                            Último <i class="bi bi-skip-end"></i>
                        </button>
                    </div>

                    <div class="save-button">
                        <button id="btn-cancelar-cambios" class="btn btn-outline-warning" style="display: none;">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <button id="btn-guardar" class="btn btn-success" disabled>
                            <i class="bi bi-save me-1"></i>Guardar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje cuando no hay registros -->
        <div id="no-records" class="no-records hidden">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #dee2e6;"></i>
            <h4>No se encontraron registros</h4>
            <p>No hay asignaciones presupuestales para el año y rubro seleccionados.</p>
        </div>

        <!-- Mensaje de carga de registros -->
        <div id="loading-records" class="loading-records hidden">
            <div class="spinner"></div>
            <p>Cargando asignaciones...</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Configuración del sistema -->
    <script src="../../assets/js/config.js"></script>

    <script>
        /**
         * JavaScript para Autorización de Presupuesto - SchoolNet
         * Migrado desde Google Apps Script a Next.js
         */

        // Variables globales
        let datosCompletos = {
            anios: [],
            rubros: [],
            asignaciones: [],
            asignacionesFiltradas: []
        };

        let registroActual = 0;
        let registroModificado = false;
        let elementos = {};

        /**
         * Inicialización cuando se carga el DOM
         */
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔐 Iniciando validación de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Autorización de presupuesto');
                if (!hasAccess) {
                    console.log('❌ Acceso denegado - deteniendo inicialización');
                    return;
                }
                console.log('✅ Acceso permitido - continuando con inicialización');

                // Continuar con inicialización
                inicializarElementos();
                configurarEventListeners();
                await cargarDatosIniciales();
                
            } catch (error) {
                console.error('❌ Error en validación de acceso:', error);
                showMessage('Error de validación de permisos', 'danger');
            }
        });

        /**
         * Cachea referencias a elementos DOM
         */
        function inicializarElementos() {
            elementos = {
                loadingOverlay: document.getElementById('loading-overlay'),
                selectAnio: document.getElementById('select-anio'),
                selectRubro: document.getElementById('select-rubro'),
                btnBuscar: document.getElementById('btn-buscar'),
                navigationSection: document.getElementById('navigation-section'),
                currentRecord: document.getElementById('current-record'),
                totalRecords: document.getElementById('total-records'),
                totalAsignaciones: document.getElementById('total-asignaciones'),
                modifiedIndicator: document.getElementById('modified-indicator'),
                
                // Campos del formulario
                fieldSubitem: document.getElementById('field-subitem'),
                fieldDistribucion: document.getElementById('field-distribucion'),
                fieldResponsable: document.getElementById('field-responsable'),
                fieldValorSolicitado: document.getElementById('field-valor-solicitado'),
                fieldValorAprobado: document.getElementById('field-valor-aprobado'),
                
                // Botones
                btnAnterior: document.getElementById('btn-anterior'),
                btnSiguiente: document.getElementById('btn-siguiente'),
                btnPrimerRegistro: document.getElementById('btn-primer-registro'),
                btnUltimoRegistro: document.getElementById('btn-ultimo-registro'),
                btnGuardar: document.getElementById('btn-guardar'),
                btnCancelarCambios: document.getElementById('btn-cancelar-cambios'),
                
                // Otros elementos
                noRecords: document.getElementById('no-records'),
                loadingRecords: document.getElementById('loading-records')
            };
        }

        /**
         * Configura event listeners
         */
        function configurarEventListeners() {
            // Filtros
            elementos.selectAnio.addEventListener('change', onAnioChange);
            elementos.selectRubro.addEventListener('change', onRubroChange);
            elementos.btnBuscar.addEventListener('click', filtrarAsignaciones);
            
            // Navegación
            elementos.btnAnterior.addEventListener('click', irAnterior);
            elementos.btnSiguiente.addEventListener('click', irSiguiente);
            elementos.btnPrimerRegistro.addEventListener('click', irPrimerRegistro);
            elementos.btnUltimoRegistro.addEventListener('click', irUltimoRegistro);
            
            // Guardado
            elementos.btnGuardar.addEventListener('click', guardarRegistro);
            elementos.btnCancelarCambios.addEventListener('click', cancelarCambios);
            
            // Campo editable
            elementos.fieldValorAprobado.addEventListener('input', onValorAprobadoChange);
            elementos.fieldValorAprobado.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    formatearValorAprobado();
                    e.target.blur();
                }
            });
            
            // Teclas rápidas
            document.addEventListener('keydown', manejarTeclasRapidas);
        }
        /**
         * Carga datos iniciales
         */
        async function cargarDatosIniciales() {
            try {
                mostrarLoading('Cargando datos iniciales...');
                
                // Cargar años académicos
                console.log('📅 Cargando años académicos...');
                const aniosData = await supabaseRequest('/academic_years?select=year_id,year_name,year_order&order=year_order.desc');
                datosCompletos.anios = aniosData || [];
                console.log('✅ Años cargados:', datosCompletos.anios.length);
                await cargarSelectAnios();
                
                // Cargar rubros presupuestales
                console.log('📊 Cargando rubros presupuestales...');
                const rubrosData = await supabaseRequest('/budget_categories?select=category_id,category_name&category_status=eq.active&order=category_name.asc');
                datosCompletos.rubros = rubrosData || [];
                console.log('✅ Rubros cargados:', datosCompletos.rubros.length);
                cargarSelectRubros();
                
                ocultarLoading();
                showMessage('Datos iniciales cargados correctamente', 'success');
                
            } catch (error) {
                console.error('❌ Error al cargar datos iniciales:', error);
                showMessage('Error al cargar datos iniciales: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        /**
         * Carga el select de años académicos
         */
        async function cargarSelectAnios() {
            elementos.selectAnio.innerHTML = '<option value="">-- Seleccione un año --</option>';
            
            // Obtener el año presupuestal actual desde system_config
            let currentBudgetYearId = null;
            try {
                const configData = await supabaseRequest('/system_config?select=current_budget_year_id&limit=1');
                if (configData && configData.length > 0) {
                    currentBudgetYearId = configData[0].current_budget_year_id;
                }
            } catch (error) {
                console.error('Error obteniendo año presupuestal actual:', error);
            }
            
            // Cargar opciones de años
            datosCompletos.anios.forEach(anio => {
                const option = document.createElement('option');
                option.value = anio.year_id;
                option.textContent = anio.year_name;
                
                // Preseleccionar si es el año presupuestal actual
                if (currentBudgetYearId && anio.year_id === currentBudgetYearId) {
                    option.selected = true;
                }
                
                elementos.selectAnio.appendChild(option);
            });
            
            // Disparar el evento change si se preseleccionó un año
            if (currentBudgetYearId) {
                elementos.selectAnio.dispatchEvent(new Event('change'));
            }
        }

        /**
         * Carga el select de rubros
         */
        function cargarSelectRubros() {
            elementos.selectRubro.innerHTML = '<option value="">-- Seleccione un rubro --</option>';
            
            datosCompletos.rubros.forEach(rubro => {
                const option = document.createElement('option');
                option.value = rubro.category_id;
                option.textContent = rubro.category_name;
                elementos.selectRubro.appendChild(option);
            });
            
            elementos.selectRubro.disabled = false;
        }

        /**
         * Event handler para cambio de año
         */
        function onAnioChange() {
            const anioSeleccionado = elementos.selectAnio.value;
            if (anioSeleccionado && elementos.selectRubro.value) {
                elementos.btnBuscar.disabled = false;
            } else {
                elementos.btnBuscar.disabled = true;
                resetearFormulario();
            }
        }

        /**
         * Event handler para cambio de rubro
         */
        function onRubroChange() {
            const rubroSeleccionado = elementos.selectRubro.value;
            if (rubroSeleccionado && elementos.selectAnio.value) {
                elementos.btnBuscar.disabled = false;
            } else {
                elementos.btnBuscar.disabled = true;
                resetearFormulario();
            }
        }

        /**
         * Filtra asignaciones por año y rubro
         */
        async function filtrarAsignaciones() {
            const anioId = elementos.selectAnio.value;
            const rubroId = elementos.selectRubro.value;
            
            if (!anioId || !rubroId) {
                showMessage('Seleccione año y rubro para continuar', 'warning');
                return;
            }
            
            try {
                console.log('🔍 Filtrando asignaciones:', { anioId, rubroId });
                
                elementos.loadingRecords.classList.remove('hidden');
                elementos.navigationSection.classList.add('hidden');
                elementos.noRecords.classList.add('hidden');
                
                // PASO 1: Obtener items del rubro seleccionado
                const itemsQuery = `/budget_items?select=item_id,item_name&category_id=eq.${rubroId}`;
                const items = await supabaseRequest(itemsQuery);
                
                if (!items || items.length === 0) {
                    mostrarNoRecords();
                    showMessage('No hay items para el rubro seleccionado', 'info');
                    return;
                }
                
                console.log('📊 Items encontrados:', items.length);
                
                // PASO 2: Obtener asignaciones
                const itemIds = items.map(item => item.item_id);
                const asignacionesQuery = `/budget_assignments?select=assignment_id,budget_item_id,category_detail,worker_email,requested_value,approved_value&academic_year_id=eq.${anioId}&budget_item_id=in.(${itemIds.join(',')})&assignment_status=eq.active`;
                const asignaciones = await supabaseRequest(asignacionesQuery);
                
                if (!asignaciones || asignaciones.length === 0) {
                    mostrarNoRecords();
                    showMessage('No se encontraron asignaciones para los criterios seleccionados', 'info');
                    return;
                }
                
                // PASO 3: Obtener información de workers
                const emails = [...new Set(asignaciones.map(a => a.worker_email).filter(e => e))];
                let workersMap = new Map();
                
                if (emails.length > 0) {
                    const emailsList = emails.map(email => `"${email}"`).join(',');
                    const workersQuery = `/workers?select=email,worker_first_name,worker_last_name_1,worker_last_name_2&email=in.(${emailsList})`;
                    const workers = await supabaseRequest(workersQuery);
                    
                    if (workers) {
                        workers.forEach(w => {
                            const fullName = `${w.worker_first_name} ${w.worker_last_name_1} ${w.worker_last_name_2 || ''}`.trim();
                            workersMap.set(w.email, fullName);
                        });
                    }
                }
                
                // PASO 4: Crear mapa de items
                const itemsMap = new Map(items.map(item => [item.item_id, item.item_name]));
                
                // PASO 5: Combinar datos
                datosCompletos.asignacionesFiltradas = asignaciones.map(asignacion => {
                    return {
                        assignment_id: asignacion.assignment_id,
                        budget_item_id: asignacion.budget_item_id,
                        category_detail: asignacion.category_detail || 'General',
                        worker_email: asignacion.worker_email,
                        requested_value: Number(asignacion.requested_value) || 0,
                        approved_value: Number(asignacion.approved_value) || 0,
                        item_name: itemsMap.get(asignacion.budget_item_id) || 'Sin nombre',
                        worker_name: workersMap.get(asignacion.worker_email) || 'Sin asignar'
                    };
                });
                
                if (datosCompletos.asignacionesFiltradas.length > 0) {
                    registroActual = 0;
                    registroModificado = false;
                    mostrarSeccionNavegacion();
                    mostrarRegistroActual();
                    showMessage(`Se encontraron ${datosCompletos.asignacionesFiltradas.length} asignaciones`, 'success');
                } else {
                    mostrarNoRecords();
                    showMessage('No se encontraron asignaciones válidas', 'info');
                }
                
            } catch (error) {
                console.error('❌ Error al filtrar asignaciones:', error);
                showMessage('Error al cargar asignaciones: ' + error.message, 'danger');
                mostrarNoRecords();
            } finally {
                elementos.loadingRecords.classList.add('hidden');
            }
        }

        /**
         * Muestra el registro actual en el formulario
         */
        function mostrarRegistroActual() {
            if (datosCompletos.asignacionesFiltradas.length === 0) return;
            
            const registro = datosCompletos.asignacionesFiltradas[registroActual];
            
            // Llenar campos
            elementos.fieldSubitem.value = registro.item_name;
            elementos.fieldDistribucion.value = registro.category_detail;
            elementos.fieldResponsable.value = registro.worker_name;
            elementos.fieldValorSolicitado.value = formatearMoneda(registro.requested_value);
            
            // Valor aprobado
            let valorAprobadoMostrar = '';
            if (registro.approved_value && registro.approved_value > 0) {
                valorAprobadoMostrar = registro.approved_value.toString();
            }
            elementos.fieldValorAprobado.value = valorAprobadoMostrar;
            
            // Actualizar contador
            elementos.currentRecord.textContent = registroActual + 1;
            elementos.totalRecords.textContent = datosCompletos.asignacionesFiltradas.length;
            
            // Reset modificado
            registroModificado = false;
            actualizarEstadoBotones();
            
            // Enfocar campo editable
            elementos.fieldValorAprobado.focus();
            elementos.fieldValorAprobado.select();
        }

        /**
         * Event handler para cambio en valor aprobado
         */
        function onValorAprobadoChange() {
            registroModificado = true;
            
            // Solo números
            const valor = elementos.fieldValorAprobado.value;
            const valorLimpio = valor.replace(/[^\d]/g, '');
            
            if (valor !== valorLimpio) {
                elementos.fieldValorAprobado.value = valorLimpio;
            }
            
            actualizarEstadoBotones();
        }

        /**
         * Formatea el valor aprobado
         */
        function formatearValorAprobado() {
            const valorActual = elementos.fieldValorAprobado.value;
            
            if (valorActual && valorActual.trim() !== '') {
                const valor = limpiarFormatoMoneda(valorActual);
                
                if (valor > 0) {
                    elementos.fieldValorAprobado.value = valor.toLocaleString('es-CO');
                }
            }
        }
        /**
         * Navegación - ir al registro anterior
         */
        async function irAnterior() {
            if (registroActual > 0) {
                if (registroModificado) {
                    const guardado = await guardarRegistro();
                    if (guardado) {
                        registroActual--;
                        mostrarRegistroActual();
                    }
                } else {
                    registroActual--;
                    mostrarRegistroActual();
                }
            }
        }

        /**
         * Navegación - ir al registro siguiente
         */
        async function irSiguiente() {
            if (registroActual < datosCompletos.asignacionesFiltradas.length - 1) {
                if (registroModificado) {
                    const guardado = await guardarRegistro();
                    if (guardado) {
                        registroActual++;
                        mostrarRegistroActual();
                    }
                } else {
                    registroActual++;
                    mostrarRegistroActual();
                }
            }
        }

        /**
         * Navegación - ir al primer registro
         */
        async function irPrimerRegistro() {
            if (registroActual !== 0) {
                if (registroModificado) {
                    const guardado = await guardarRegistro();
                    if (guardado) {
                        registroActual = 0;
                        mostrarRegistroActual();
                    }
                } else {
                    registroActual = 0;
                    mostrarRegistroActual();
                }
            }
        }

        /**
         * Navegación - ir al último registro
         */
        async function irUltimoRegistro() {
            const ultimoIndice = datosCompletos.asignacionesFiltradas.length - 1;
            if (registroActual !== ultimoIndice) {
                if (registroModificado) {
                    const guardado = await guardarRegistro();
                    if (guardado) {
                        registroActual = ultimoIndice;
                        mostrarRegistroActual();
                    }
                } else {
                    registroActual = ultimoIndice;
                    mostrarRegistroActual();
                }
            }
        }

        /**
         * Guarda el registro actual
         */
        async function guardarRegistro() {
            if (!registroModificado) {
                showMessage('No hay cambios para guardar', 'info');
                return true;
            }
            
            const registro = datosCompletos.asignacionesFiltradas[registroActual];
            const nuevoValor = limpiarFormatoMoneda(elementos.fieldValorAprobado.value);
            
            if (!validarValorAprobado(nuevoValor)) {
                return false;
            }
            
            try {
                elementos.btnGuardar.disabled = true;
                elementos.btnGuardar.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Guardando...';
                
                // Actualizar en Supabase
                const updateUrl = `/budget_assignments?assignment_id=eq.${registro.assignment_id}`;
                
                await supabaseRequest(updateUrl, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        approved_value: nuevoValor
                    })
                });
                
                // Actualizar datos locales
                datosCompletos.asignacionesFiltradas[registroActual].approved_value = nuevoValor;
                
                registroModificado = false;
                showMessage('Valor aprobado actualizado correctamente', 'success');
                
                // Auto-navegación al siguiente registro
                if (registroActual < datosCompletos.asignacionesFiltradas.length - 1) {
                    setTimeout(() => {
                        registroActual++;
                        mostrarRegistroActual();
                    }, 1000);
                } else {
                    showMessage('¡Último registro completado!', 'info');
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ Error al guardar:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
                return false;
            } finally {
                elementos.btnGuardar.disabled = false;
                elementos.btnGuardar.innerHTML = '<i class="bi bi-save me-1"></i>Guardar';
                actualizarEstadoBotones();
            }
        }

        /**
         * Cancela los cambios actuales
         */
        function cancelarCambios() {
            if (registroModificado && confirm('¿Desea cancelar los cambios realizados?')) {
                mostrarRegistroActual();
                showMessage('Cambios cancelados', 'info');
            }
        }

        /**
         * Maneja teclas rápidas
         */
        function manejarTeclasRapidas(e) {
            if (datosCompletos.asignacionesFiltradas.length === 0) return;
            
            if (e.ctrlKey && e.key === 'ArrowLeft') {
                e.preventDefault();
                irAnterior();
            }
            
            if (e.ctrlKey && e.key === 'ArrowRight') {
                e.preventDefault();
                irSiguiente();
            }
            
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                guardarRegistro();
            }
            
            if (e.key === 'Escape' && registroModificado) {
                e.preventDefault();
                cancelarCambios();
            }
        }

        /**
         * Actualiza el estado de los botones
         */
        function actualizarEstadoBotones() {
            const totalRegistros = datosCompletos.asignacionesFiltradas.length;
            
            elementos.btnAnterior.disabled = registroActual === 0;
            elementos.btnSiguiente.disabled = registroActual === totalRegistros - 1;
            elementos.btnPrimerRegistro.disabled = registroActual === 0;
            elementos.btnUltimoRegistro.disabled = registroActual === totalRegistros - 1;
            elementos.btnGuardar.disabled = !registroModificado;
            
            // Mostrar/ocultar indicador de modificado
            if (registroModificado) {
                elementos.modifiedIndicator.classList.remove('hidden');
                elementos.btnCancelarCambios.style.display = 'inline-block';
            } else {
                elementos.modifiedIndicator.classList.add('hidden');
                elementos.btnCancelarCambios.style.display = 'none';
            }
        }

        /**
         * Muestra la sección de navegación
         */
        function mostrarSeccionNavegacion() {
            elementos.navigationSection.classList.remove('hidden');
            elementos.noRecords.classList.add('hidden');
            elementos.loadingRecords.classList.add('hidden');
            elementos.totalAsignaciones.textContent = `${datosCompletos.asignacionesFiltradas.length} asignaciones`;
        }

        /**
         * Muestra mensaje de no hay registros
         */
        function mostrarNoRecords() {
            elementos.noRecords.classList.remove('hidden');
            elementos.navigationSection.classList.add('hidden');
            elementos.totalAsignaciones.textContent = '0 asignaciones';
        }

        /**
         * Resetea el formulario
         */
        function resetearFormulario() {
            datosCompletos.asignacionesFiltradas = [];
            registroActual = 0;
            registroModificado = false;
            
            elementos.navigationSection.classList.add('hidden');
            elementos.noRecords.classList.add('hidden');
            elementos.loadingRecords.classList.add('hidden');
        }

        /**
         * Valida el valor aprobado
         */
        function validarValorAprobado(valor) {
            if (isNaN(valor) || !Number.isInteger(valor) || valor < 0) {
                showMessage('El valor debe ser un número entero positivo', 'warning');
                elementos.fieldValorAprobado.focus();
                return false;
            }
            return true;
        }

        /**
         * Formatea valor como moneda
         */
        function formatearMoneda(valor) {
            if (!valor || valor === 0) return '$0';
            return '$' + parseInt(valor).toLocaleString('es-CO');
        }

        /**
         * Limpia el formato de moneda y devuelve número
         */
        function limpiarFormatoMoneda(valor) {
            if (!valor) return 0;
            return parseInt(valor.toString().replace(/[^\d]/g, '')) || 0;
        }

        /**
         * Muestra overlay de loading
         */
        function mostrarLoading(mensaje = 'Cargando...') {
            elementos.loadingOverlay.querySelector('p').textContent = mensaje;
            elementos.loadingOverlay.classList.remove('hidden');
        }

        /**
         * Oculta overlay de loading
         */
        function ocultarLoading() {
            elementos.loadingOverlay.classList.add('hidden');
        }

        /**
         * Prevenir pérdida de datos al salir
         */
        window.addEventListener('beforeunload', function(e) {
            if (registroModificado) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Aplicar branding y configuración
        if (window.SUPABASE_CONFIG) {
            initializePage('budgetAuthorization', 'Presupuesto');
        } else {
            setTimeout(() => initializePage('budgetAuthorization', 'Presupuesto'), 100);
        }

        console.log('🎉 Autorización de Presupuesto - SchoolNet v1.0');
    </script>
</body>
</html>
