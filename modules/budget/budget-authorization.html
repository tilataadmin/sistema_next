<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autorizaci√≥n de Presupuesto - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        :root {
            --color-primary: #2c3e50;
            --color-secondary: #3498db;
            --color-success: #27ae60;
            --color-warning: #f39c12;
            --color-danger: #e74c3c;
            --color-info: #17a2b8;
            --color-light: #f8f9fa;
            --color-dark: #343a40;
            --border-radius: 8px;
        }

        body {
            background-color: var(--color-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .system-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-radius: var(--border-radius);
        }

        .filters-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navigation-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters-section h3, .navigation-section h3 {
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-secondary);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .filters-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 20px;
            align-items: end;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 8px;
            display: block;
        }

        .record-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--color-secondary);
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 8px;
            display: block;
        }

        .form-control.readonly-field {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            border: 1px solid #ced4da;
        }

        .currency-field {
            text-align: right;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            font-size: 16px;
        }

        .currency-field.editable {
            background-color: #fff3cd;
            border: 2px solid var(--color-warning);
            transition: all 0.3s ease;
        }

        .currency-field.editable:focus {
            background-color: #ffffff;
            border-color: var(--color-secondary);
            box-shadow: 0 0 0 0.2rem rgba(52, 144, 220, 0.25);
        }

        .record-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-nav {
            padding: 10px 20px;
            font-weight: 600;
            border-radius: var(--border-radius);
        }

        .record-counter {
            font-weight: 600;
            color: var(--color-secondary);
            font-size: 16px;
            background: #e8f4fd;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-records, .loading-records {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 2px dashed #dee2e6;
        }

        .loading-records {
            color: var(--color-secondary);
            border-color: var(--color-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .changes-indicator {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }
            
            .filters-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .record-form {
                grid-template-columns: 1fr;
            }
            
            .record-actions {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-buttons {
                justify-content: center;
                width: 100%;
            }
        }
    </style>
</head>

<body class="bg-light">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Procesando...</p>
        </div>
    </div>

    <div class="main-container">
        <!-- Navegaci√≥n de breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/modules/budget/index.html" class="text-decoration-none">
                        <i class="bi bi-arrow-left me-1"></i>Volver al M√≥dulo
                    </a>
                </li>
                <li class="breadcrumb-item">Presupuesto</li>
                <li class="breadcrumb-item active" aria-current="page">Autorizaci√≥n de presupuesto</li>
            </ol>
        </nav>

        <!-- Header del Sistema -->
        <div class="system-header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle me-3" style="font-size: 2rem;"></i>
                            <div>
                                <h1 class="h3 mb-0">Autorizaci√≥n de Presupuesto</h1>
                                <small class="opacity-75">Gestione la aprobaci√≥n de valores presupuestales por asignaci√≥n</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button id="btn-manual" class="btn btn-outline-light" style="display: none;">
                            <i class="bi bi-book me-1"></i>Manual
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor de mensajes -->
        <div id="alertContainer"></div>

        <!-- Secci√≥n de filtros -->
        <div class="filters-section">
            <h3>
                <i class="bi bi-funnel me-2"></i>Filtros de B√∫squeda
            </h3>
            <div class="filters-row">
                <div class="filter-group">
                    <label for="select-anio">
                        <i class="bi bi-calendar3 me-1"></i>
                        Seleccione el a√±o:
                    </label>
                    <select id="select-anio" class="form-select" required>
                        <option value="">-- Seleccione un a√±o --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="select-rubro">
                        <i class="bi bi-folder me-1"></i>
                        Seleccione el rubro:
                    </label>
                    <select id="select-rubro" class="form-select" required disabled>
                        <option value="">-- Seleccione un rubro --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button id="btn-buscar" class="btn btn-primary btn-lg" disabled>
                        <i class="bi bi-search me-2"></i>
                        Buscar Asignaciones
                    </button>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de navegaci√≥n de registros -->
        <div id="record-navigation" class="navigation-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">
                    <i class="bi bi-pencil-square me-2"></i>
                    Autorizaci√≥n de Presupuesto
                </h3>
                <div class="record-counter">
                    Registro <span id="current-record" class="fw-bold">0</span> de 
                    <span id="total-records" class="fw-bold">0</span>
                </div>
            </div>
            
            <!-- Formulario de registro actual -->
            <div class="record-form">
                <div class="form-group">
                    <label for="field-subitem">
                        <i class="bi bi-tag me-1"></i>
                        Sub-√≠tem:
                    </label>
                    <input type="text" id="field-subitem" class="form-control readonly-field" readonly>
                </div>
                
                <div class="form-group">
                    <label for="field-distribucion">
                        <i class="bi bi-pie-chart me-1"></i>
                        Distribuci√≥n:
                    </label>
                    <input type="text" id="field-distribucion" class="form-control readonly-field" readonly>
                </div>
                
                <div class="form-group full-width">
                    <label for="field-responsable">
                        <i class="bi bi-person-badge me-1"></i>
                        Responsable:
                    </label>
                    <input type="text" id="field-responsable" class="form-control readonly-field" readonly>
                </div>
                
                <div class="form-group">
                    <label for="field-valor-solicitado">
                        <i class="bi bi-currency-dollar me-1"></i>
                        Valor solicitado:
                    </label>
                    <input type="text" id="field-valor-solicitado" class="form-control readonly-field currency-field" readonly>
                </div>
                
                <div class="form-group">
                    <label for="field-valor-aprobado">
                        <i class="bi bi-check-circle-fill me-1 text-success"></i>
                        Valor aprobado:
                    </label>
                    <input type="number" id="field-valor-aprobado" 
                           class="form-control currency-field editable" 
                           placeholder="Ingrese el valor aprobado" 
                           min="0" step="1">
                </div>
            </div>
            
            <!-- Controles de navegaci√≥n y guardado -->
            <div class="record-actions">
                <div class="nav-buttons">
                    <button id="btn-anterior" class="btn btn-outline-secondary btn-nav" disabled>
                        <i class="bi bi-arrow-left me-1"></i>
                        Anterior
                    </button>
                    <button id="btn-siguiente" class="btn btn-outline-secondary btn-nav" disabled>
                        Siguiente
                        <i class="bi bi-arrow-right ms-1"></i>
                    </button>
                </div>
                
                <div>
                    <button id="btn-guardar" class="btn btn-success btn-lg">
                        <i class="bi bi-save me-2"></i>
                        Guardar Cambios
                    </button>
                </div>
            </div>
            
            <!-- Indicadores de cambios -->
            <div id="changes-indicator" class="changes-indicator" style="display: none;">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong>Hay cambios sin guardar.</strong> Use Ctrl+S para guardar r√°pidamente.
            </div>
        </div>

        <!-- Mensaje cuando no hay registros -->
        <div id="no-records" class="no-records" style="display: none;">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
            <h4 class="mt-3">No se encontraron registros</h4>
            <p>No hay asignaciones presupuestales para el a√±o y rubro seleccionados.</p>
            <small class="text-muted">Intente con diferentes filtros o verifique que existan datos cargados.</small>
        </div>
        
        <!-- Mensaje de carga de registros -->
        <div id="loading-records" class="loading-records" style="display: none;">
            <div class="spinner"></div>
            <h5>Cargando asignaciones...</h5>
            <p>Por favor espere mientras se consultan los datos.</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Configuraci√≥n del sistema -->
    <script src="../../assets/js/config.js"></script>

    <!-- JavaScript se continuar√° en la siguiente fracci√≥n -->
</body>
</html>

<script>
        /**
         * JavaScript para Autorizaci√≥n de Presupuesto - SchoolNet
         * Migrado desde Google Apps Script siguiendo patr√≥n establecido
         */

        // ==========================================
        // VALIDACI√ìN DE ACCESO A LA P√ÅGINA
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // Validar acceso antes de continuar
                const hasAccess = await validatePageAccess('Autorizaci√≥n de presupuesto');
                
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                console.log('üéØ Autorizaci√≥n de Presupuesto - Iniciando versi√≥n integrada');
                
                // Actualizar t√≠tulo de la p√°gina
                document.title = 'Autorizaci√≥n de Presupuesto - SchoolNet';
                
                // Inicializar elementos y datos
                inicializarElementos();
                inicializarEventos();
                await cargarDatosIniciales();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });

        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let datosCompletos = {
            anios: [],
            rubros: [],
            asignacionesFiltradas: []
        };

        let estadoFormulario = {
            registroActual: 0,
            registroModificado: false,
            cargandoDatos: false
        };

        let elementos = {};

        // ==========================================
        // FUNCIONES DE INICIALIZACI√ìN
        // ==========================================

        /**
         * Cachea referencias a elementos DOM
         */
        function inicializarElementos() {
            elementos = {
                // Filtros
                selectAnio: document.getElementById('select-anio'),
                selectRubro: document.getElementById('select-rubro'),
                btnBuscar: document.getElementById('btn-buscar'),
                
                // Navegaci√≥n de registros
                recordNavigation: document.getElementById('record-navigation'),
                currentRecord: document.getElementById('current-record'),
                totalRecords: document.getElementById('total-records'),
                
                // Campos del formulario
                fieldSubitem: document.getElementById('field-subitem'),
                fieldDistribucion: document.getElementById('field-distribucion'),
                fieldResponsable: document.getElementById('field-responsable'),
                fieldValorSolicitado: document.getElementById('field-valor-solicitado'),
                fieldValorAprobado: document.getElementById('field-valor-aprobado'),
                
                // Botones de navegaci√≥n
                btnAnterior: document.getElementById('btn-anterior'),
                btnSiguiente: document.getElementById('btn-siguiente'),
                btnGuardar: document.getElementById('btn-guardar'),
                
                // Secciones de estado
                noRecords: document.getElementById('no-records'),
                loadingRecords: document.getElementById('loading-records'),
                changesIndicator: document.getElementById('changes-indicator'),
                loadingOverlay: document.getElementById('loading-overlay')
            };

            console.log('‚úÖ Referencias DOM inicializadas correctamente');
        }

        /**
         * Configura event listeners
         */
        function inicializarEventos() {
            // Filtros - Cambios en selects
            elementos.selectAnio.addEventListener('change', onAnioChange);
            elementos.selectRubro.addEventListener('change', onRubroChange);
            elementos.btnBuscar.addEventListener('click', buscarAsignaciones);
            
            // Navegaci√≥n entre registros
            elementos.btnAnterior.addEventListener('click', irAnterior);
            elementos.btnSiguiente.addEventListener('click', irSiguiente);
            
            // Guardado de cambios
            elementos.btnGuardar.addEventListener('click', guardarRegistro);
            
            // Campo editable - Valor aprobado
            elementos.fieldValorAprobado.addEventListener('input', onValorAprobadoChange);
            elementos.fieldValorAprobado.addEventListener('blur', formatearValorAprobado);
            elementos.fieldValorAprobado.addEventListener('keydown', onKeyDown);
            
            // Teclas r√°pidas globales
            document.addEventListener('keydown', manejarTeclasRapidas);
            
            // Prevenir p√©rdida de datos al salir
            window.addEventListener('beforeunload', function(e) {
                if (estadoFormulario.registroModificado) {
                    e.preventDefault();
                    e.returnValue = 'Tienes cambios sin guardar. ¬øEst√°s seguro de salir?';
                }
            });

            console.log('‚úÖ Event listeners configurados correctamente');
        }

        // ==========================================
        // FUNCIONES DE CARGA DE DATOS
        // ==========================================

        /**
         * Carga datos iniciales
         */
        async function cargarDatosIniciales() {
            try {
                mostrarLoading('Cargando datos iniciales...');
                
                console.log('üì° Cargando a√±os acad√©micos y rubros...');
                
                // Carga paralela de a√±os y rubros
                await Promise.all([
                    cargarAniosAcademicos(),
                    cargarRubrosPresupuesto()
                ]);
                
                ocultarLoading();
                showMessage('Datos iniciales cargados correctamente', 'success');
                
            } catch (error) {
                console.error('‚ùå Error al cargar datos iniciales:', error);
                showMessage('Error al cargar datos iniciales: ' + error.message, 'danger');
                ocultarLoading();
            }
        }

        /**
         * Carga la lista de a√±os acad√©micos
         */
        async function cargarAniosAcademicos() {
            try {
                const data = await supabaseRequest('/academic_years?select=year_id,year_name,year_order&order=year_order.desc');
                datosCompletos.anios = data || [];
                
                elementos.selectAnio.innerHTML = '<option value="">-- Seleccione un a√±o --</option>';
                datosCompletos.anios.forEach(anio => {
                    const option = document.createElement('option');
                    option.value = anio.year_id;
                    option.textContent = anio.year_name;
                    elementos.selectAnio.appendChild(option);
                });
                
                console.log(`‚úÖ A√±os acad√©micos cargados: ${datosCompletos.anios.length}`);
            } catch (error) {
                console.error('Error al cargar a√±os acad√©micos:', error);
                showMessage('Error al cargar lista de a√±os acad√©micos', 'warning');
                datosCompletos.anios = [];
            }
        }

        /**
         * Carga la lista de rubros presupuestales
         */
        async function cargarRubrosPresupuesto() {
            try {
                const data = await supabaseRequest('/budget_categories?select=category_id,category_name&category_status=eq.active&order=category_name.asc');
                datosCompletos.rubros = data || [];
                
                elementos.selectRubro.innerHTML = '<option value="">-- Seleccione un rubro --</option>';
                datosCompletos.rubros.forEach(rubro => {
                    const option = document.createElement('option');
                    option.value = rubro.category_id;
                    option.textContent = rubro.category_name;
                    elementos.selectRubro.appendChild(option);
                });
                
                // Habilitar el select de rubros
                elementos.selectRubro.disabled = false;
                
                console.log(`‚úÖ Rubros presupuestales cargados: ${datosCompletos.rubros.length}`);
            } catch (error) {
                console.error('Error al cargar rubros:', error);
                showMessage('Error al cargar lista de rubros', 'warning');
                datosCompletos.rubros = [];
            }
        }

        // ==========================================
        // MANEJO DE FILTROS
        // ==========================================

        /**
         * Maneja cambios en el select de a√±o
         */
        function onAnioChange() {
            const anioSeleccionado = elementos.selectAnio.value;
            console.log('üìÖ Cambio de a√±o seleccionado:', anioSeleccionado);
            
            actualizarEstadoBusqueda();
            
            if (!anioSeleccionado) {
                resetearFormulario();
            }
        }

        /**
         * Maneja cambios en el select de rubro
         */
        function onRubroChange() {
            const rubroSeleccionado = elementos.selectRubro.value;
            console.log('üìÅ Cambio de rubro seleccionado:', rubroSeleccionado);
            
            actualizarEstadoBusqueda();
            
            if (!rubroSeleccionado) {
                resetearFormulario();
            }
        }

        /**
         * Actualiza el estado del bot√≥n de b√∫squeda
         */
        function actualizarEstadoBusqueda() {
            const anioValido = elementos.selectAnio.value !== '';
            const rubroValido = elementos.selectRubro.value !== '';
            
            // Habilitar bot√≥n de b√∫squeda solo si ambos filtros est√°n seleccionados
            elementos.btnBuscar.disabled = !(anioValido && rubroValido);
            
            if (elementos.btnBuscar.disabled) {
                resetearFormulario();
            }
        }

        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================

        /**
         * Muestra overlay de loading
         */
        function mostrarLoading(mensaje = 'Procesando...') {
            elementos.loadingOverlay.querySelector('p').textContent = mensaje;
            elementos.loadingOverlay.classList.remove('hidden');
        }

        /**
         * Oculta overlay de loading
         */
        function ocultarLoading() {
            elementos.loadingOverlay.classList.add('hidden');
        }

        /**
         * Reset del formulario
         */
        function resetearFormulario() {
            console.log('üîÑ Reseteando formulario...');
            
            datosCompletos.asignacionesFiltradas = [];
            estadoFormulario.registroActual = 0;
            estadoFormulario.registroModificado = false;
            
            // Ocultar todas las secciones
            elementos.recordNavigation.style.display = 'none';
            elementos.noRecords.style.display = 'none';
            elementos.loadingRecords.style.display = 'none';
            elementos.changesIndicator.style.display = 'none';
        }

        // ==========================================
        // APLICAR BRANDING Y CONFIGURACI√ìN
        // ==========================================

        // Aplicar branding y configuraci√≥n autom√°ticamente
        updatePageTitle('budget-authorization', 'Presupuesto');
        initializePage();

        console.log('üìä Autorizaci√≥n de Presupuesto - Parte 2 inicializada');
    </script>

    // ==========================================
        // B√öSQUEDA DE ASIGNACIONES
        // ==========================================

        /**
         * Buscar asignaciones presupuestales por a√±o y rubro
         */
        async function buscarAsignaciones() {
            const anioId = elementos.selectAnio.value;
            const categoryId = elementos.selectRubro.value;
            
            if (!anioId || !categoryId) {
                showMessage('Seleccione a√±o y rubro', 'warning');
                return;
            }
            
            try {
                estadoFormulario.cargandoDatos = true;
                mostrarLoadingRecords();
                
                console.log(`üîç Buscando asignaciones para a√±o: ${anioId}, rubro: ${categoryId}`);
                
                // Consulta optimizada: Obtener asignaciones con sus relaciones
                const query = `/budget_assignments?select=assignment_id,category_detail,worker_email,requested_value,approved_value,budget_items!inner(item_name,budget_categories!inner(category_id)),workers(worker_first_name,worker_last_name_1,worker_last_name_2)&academic_year_id=eq.${anioId}&budget_items.budget_categories.category_id=eq.${categoryId}&order=budget_items.item_name,category_detail`;
                
                const asignaciones = await supabaseRequest(query);
                
                if (!asignaciones || asignaciones.length === 0) {
                    mostrarNoRecords();
                    showMessage('No se encontraron asignaciones para los filtros seleccionados', 'info');
                    return;
                }
                
                // Procesar datos para el formulario
                datosCompletos.asignacionesFiltradas = asignaciones.map(asignacion => ({
                    assignment_id: asignacion.assignment_id,
                    sub_item_name: asignacion.budget_items?.item_name || 'Sin nombre',
                    categoria_detalle: asignacion.category_detail || 'General',
                    worker_name: construirNombreCompleto(asignacion.workers),
                    worker_email: asignacion.worker_email,
                    requested_value: asignacion.requested_value || 0,
                    approved_value: asignacion.approved_value || 0
                }));
                
                // Inicializar navegaci√≥n
                estadoFormulario.registroActual = 0;
                estadoFormulario.registroModificado = false;
                
                mostrarSeccionNavegacion();
                mostrarRegistroActual();
                
                const mensaje = `Se encontraron ${datosCompletos.asignacionesFiltradas.length} asignaciones`;
                showMessage(mensaje, 'success');
                console.log(`‚úÖ ${mensaje}`);
                
            } catch (error) {
                console.error('Error en b√∫squeda:', error);
                showMessage('Error al buscar asignaciones: ' + error.message, 'danger');
                ocultarLoadingRecords();
            } finally {
                estadoFormulario.cargandoDatos = false;
            }
        }

        /**
         * Construye el nombre completo del trabajador
         */
        function construirNombreCompleto(worker) {
            if (!worker) return 'Sin asignar';
            
            const nombres = [
                worker.worker_first_name,
                worker.worker_last_name_1,
                worker.worker_last_name_2
            ].filter(nombre => nombre && nombre.trim() !== '');
            
            return nombres.join(' ') || 'Sin nombre';
        }

        // ==========================================
        // NAVEGACI√ìN DE REGISTROS
        // ==========================================

        /**
         * Ir al registro anterior
         */
        async function irAnterior() {
            if (estadoFormulario.registroActual > 0) {
                if (estadoFormulario.registroModificado) {
                    const guardado = await guardarRegistro();
                    if (!guardado) return;
                }
                
                estadoFormulario.registroActual--;
                mostrarRegistroActual();
            }
        }

        /**
         * Ir al registro siguiente
         */
        async function irSiguiente() {
            if (estadoFormulario.registroActual < datosCompletos.asignacionesFiltradas.length - 1) {
                if (estadoFormulario.registroModificado) {
                    const guardado = await guardarRegistro();
                    if (!guardado) return;
                }
                
                estadoFormulario.registroActual++;
                mostrarRegistroActual();
            }
        }

        /**
         * Mostrar datos del registro actual
         */
        function mostrarRegistroActual() {
            if (datosCompletos.asignacionesFiltradas.length === 0) return;
            
            const registro = datosCompletos.asignacionesFiltradas[estadoFormulario.registroActual];
            
            // Llenar campos
            elementos.fieldSubitem.value = registro.sub_item_name;
            elementos.fieldDistribucion.value = registro.categoria_detalle;
            elementos.fieldResponsable.value = registro.worker_name;
            elementos.fieldValorSolicitado.value = formatearMoneda(registro.requested_value);
            elementos.fieldValorAprobado.value = registro.approved_value || '';
            
            // Actualizar contador
            elementos.currentRecord.textContent = estadoFormulario.registroActual + 1;
            elementos.totalRecords.textContent = datosCompletos.asignacionesFiltradas.length;
            
            // Actualizar botones
            actualizarEstadoBotones();
            
            // Reset estado
            estadoFormulario.registroModificado = false;
            actualizarIndicadorCambios();
            
            // Enfocar campo editable
            setTimeout(() => {
                elementos.fieldValorAprobado.focus();
                elementos.fieldValorAprobado.select();
            }, 100);
            
            console.log(`üìÑ Mostrando registro ${estadoFormulario.registroActual + 1} de ${datosCompletos.asignacionesFiltradas.length}`);
        }

        /**
         * Actualiza el estado de los botones de navegaci√≥n
         */
        function actualizarEstadoBotones() {
            const totalRegistros = datosCompletos.asignacionesFiltradas.length;
            
            elementos.btnAnterior.disabled = estadoFormulario.registroActual === 0 || estadoFormulario.cargandoDatos;
            elementos.btnSiguiente.disabled = estadoFormulario.registroActual === totalRegistros - 1 || estadoFormulario.cargandoDatos;
            elementos.btnGuardar.disabled = !estadoFormulario.registroModificado || estadoFormulario.cargandoDatos;
        }

        /**
         * Actualiza el indicador visual de cambios
         */
        function actualizarIndicadorCambios() {
            if (estadoFormulario.registroModificado) {
                elementos.changesIndicator.style.display = 'block';
            } else {
                elementos.changesIndicator.style.display = 'none';
            }
        }

        // ==========================================
        // MANEJO DEL CAMPO EDITABLE
        // ==========================================

        /**
         * Maneja cambios en el campo valor aprobado
         */
        function onValorAprobadoChange() {
            estadoFormulario.registroModificado = true;
            actualizarIndicadorCambios();
            actualizarEstadoBotones();
            
            // Solo permitir n√∫meros
            const valor = elementos.fieldValorAprobado.value;
            const valorLimpio = valor.replace(/[^\d]/g, '');
            
            if (valor !== valorLimpio) {
                elementos.fieldValorAprobado.value = valorLimpio;
            }
        }

        /**
         * Formatea el valor aprobado al perder el foco
         */
        function formatearValorAprobado() {
            const valor = limpiarFormatoMoneda(elementos.fieldValorAprobado.value);
            if (valor > 0) {
                elementos.fieldValorAprobado.value = valor.toLocaleString('es-CO');
            }
        }

        /**
         * Maneja teclas especiales en el campo valor aprobado
         */
        function onKeyDown(e) {
            const teclasPermitidas = [
                'Backspace', 'Delete', 'Tab', 'Escape', 'Enter',
                'Home', 'End', 'ArrowLeft', 'ArrowRight'
            ];
            
            if (teclasPermitidas.includes(e.key)) return;
            
            if (!/^\d$/.test(e.key)) {
                e.preventDefault();
            }
        }

        /**
         * Maneja teclas r√°pidas globales
         */
        function manejarTeclasRapidas(e) {
            if (datosCompletos.asignacionesFiltradas.length === 0) return;
            
            if (e.ctrlKey && e.key === 'ArrowLeft') {
                e.preventDefault();
                irAnterior();
            }
            
            if (e.ctrlKey && e.key === 'ArrowRight') {
                e.preventDefault();
                irSiguiente();
            }
            
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                guardarRegistro();
            }
            
            if (e.key === 'Escape' && estadoFormulario.registroModificado) {
                e.preventDefault();
                cancelarCambios();
            }
        }

        /**
         * Cancela los cambios actuales
         */
        function cancelarCambios() {
            if (confirm('¬øDesea cancelar los cambios realizados?')) {
                mostrarRegistroActual();
                showMessage('Cambios cancelados', 'info');
            }
        }

        // ==========================================
        // FUNCIONES DE VISUALIZACI√ìN
        // ==========================================

        /**
         * Muestra la secci√≥n de navegaci√≥n
         */
        function mostrarSeccionNavegacion() {
            elementos.recordNavigation.style.display = 'block';
            elementos.noRecords.style.display = 'none';
            elementos.loadingRecords.style.display = 'none';
        }

        /**
         * Muestra mensaje cuando no hay registros
         */
        function mostrarNoRecords() {
            elementos.noRecords.style.display = 'block';
            elementos.recordNavigation.style.display = 'none';
            elementos.loadingRecords.style.display = 'none';
        }

        /**
         * Muestra indicador de carga de registros
         */
        function mostrarLoadingRecords() {
            elementos.loadingRecords.style.display = 'block';
            elementos.recordNavigation.style.display = 'none';
            elementos.noRecords.style.display = 'none';
        }

        /**
         * Oculta indicador de carga de registros
         */
        function ocultarLoadingRecords() {
            elementos.loadingRecords.style.display = 'none';
        }

        // ==========================================
        // FUNCIONES DE UTILIDAD DE FORMATO
        // ==========================================

        /**
         * Formatea valor como moneda colombiana
         */
        function formatearMoneda(valor) {
            if (!valor || valor === 0) return '$0';
            return '$' + parseInt(valor).toLocaleString('es-CO');
        }

        /**
         * Limpia formato de moneda y retorna n√∫mero
         */
        function limpiarFormatoMoneda(valor) {
            if (!valor) return 0;
            return parseInt(valor.toString().replace(/[^\d]/g, '')) || 0;
        }

        console.log('üìä Autorizaci√≥n de Presupuesto - Parte 3 cargada (B√∫squeda y Navegaci√≥n)');

                // ==========================================
        // GUARDADO DE REGISTRO
        // ==========================================

        /**
         * Guarda el registro actual
         */
        async function guardarRegistro() {
            if (!estadoFormulario.registroModificado) {
                showMessage('No hay cambios para guardar', 'info');
                return true;
            }
            
            const registro = datosCompletos.asignacionesFiltradas[estadoFormulario.registroActual];
            const nuevoValor = limpiarFormatoMoneda(elementos.fieldValorAprobado.value);
            
            if (!validarValorAprobado(nuevoValor)) {
                return false;
            }
            
            const saveButton = elementos.btnGuardar;
            const originalText = saveButton.innerHTML;
            
            try {
                // Deshabilitar bot√≥n de guardado
                saveButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Guardando...';
                saveButton.disabled = true;
                
                console.log(`üíæ Guardando valor ${nuevoValor} para asignaci√≥n ${registro.assignment_id}`);
                
                // Actualizar en base de datos
                const updateData = { approved_value: nuevoValor };
                await supabaseRequest(`/budget_assignments?assignment_id=eq.${registro.assignment_id}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });
                
                // Actualizar datos locales
                registro.approved_value = nuevoValor;
                estadoFormulario.registroModificado = false;
                actualizarIndicadorCambios();
                
                showMessage('Valor guardado correctamente', 'success');
                console.log(`‚úÖ Registro ${estadoFormulario.registroActual + 1} guardado exitosamente`);
                
                // Auto-navegaci√≥n al siguiente registro
                setTimeout(async () => {
                    if (estadoFormulario.registroActual < datosCompletos.asignacionesFiltradas.length - 1) {
                        estadoFormulario.registroActual++;
                        mostrarRegistroActual();
                    } else {
                        showMessage('¬°√öltimo registro completado! Todos los valores han sido procesados.', 'info');
                    }
                }, 1000);
                
                return true;
                
            } catch (error) {
                console.error('Error guardando:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
                return false;
            } finally {
                // Restaurar bot√≥n
                saveButton.innerHTML = originalText;
                actualizarEstadoBotones();
            }
        }

        /**
         * Valida el valor aprobado
         */
        function validarValorAprobado(valor) {
            if (isNaN(valor) || !Number.isInteger(Number(valor)) || valor < 0) {
                showMessage('El valor debe ser un n√∫mero entero positivo', 'danger');
                elementos.fieldValorAprobado.focus();
                elementos.fieldValorAprobado.select();
                return false;
            }
            
            // Validar que no sea excesivamente grande
            if (valor > 999999999999) {
                showMessage('El valor es demasiado grande', 'warning');
                elementos.fieldValorAprobado.focus();
                elementos.fieldValorAprobado.select();
                return false;
            }
            
            return true;
        }

        // ==========================================
        // MANEJO DE ERRORES GLOBALES
        // ==========================================

        /**
         * Manejo de errores globales de JavaScript
         */
        window.addEventListener('error', function(e) {
            console.error('Error global capturado:', e.error);
            showMessage('Se ha producido un error inesperado. Por favor, recargue la p√°gina si persiste.', 'danger');
        });

        /**
         * Manejo de promesas rechazadas
         */
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Promesa rechazada no manejada:', e.reason);
            showMessage('Error de conexi√≥n o procesamiento. Verifique su conexi√≥n a internet.', 'warning');
        });

        // ==========================================
        // FUNCIONES DE UTILIDAD ADICIONALES
        // ==========================================

        /**
         * Escapa HTML para prevenir XSS
         */
        function escapeHtml(text) {
            if (text === null || text === undefined) {
                return '';
            }
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Formatea fecha para visualizaci√≥n
         */
        function formatearFecha(fecha) {
            if (!fecha) return '';
            
            try {
                const date = new Date(fecha);
                return date.toLocaleDateString('es-CO', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (error) {
                return '';
            }
        }

        /**
         * Obtiene estad√≠sticas b√°sicas de los datos cargados
         */
        function obtenerEstadisticas() {
            if (datosCompletos.asignacionesFiltradas.length === 0) {
                return null;
            }
            
            const datos = datosCompletos.asignacionesFiltradas;
            
            const totalSolicitado = datos.reduce((sum, item) => sum + (item.requested_value || 0), 0);
            const totalAprobado = datos.reduce((sum, item) => sum + (item.approved_value || 0), 0);
            const registrosConAprobacion = datos.filter(item => (item.approved_value || 0) > 0).length;
            const porcentajeCompletado = Math.round((registrosConAprobacion / datos.length) * 100);
            
            return {
                totalRegistros: datos.length,
                totalSolicitado: totalSolicitado,
                totalAprobado: totalAprobado,
                registrosConAprobacion: registrosConAprobacion,
                porcentajeCompletado: porcentajeCompletado
            };
        }

        /**
         * Funci√≥n de debug para desarrollo
         */
        function mostrarEstadisticas() {
            const stats = obtenerEstadisticas();
            if (stats) {
                console.log('üìä Estad√≠sticas actuales:');
                console.log(`- Total registros: ${stats.totalRegistros}`);
                console.log(`- Valor solicitado: ${formatearMoneda(stats.totalSolicitado)}`);
                console.log(`- Valor aprobado: ${formatearMoneda(stats.totalAprobado)}`);
                console.log(`- Registros con aprobaci√≥n: ${stats.registrosConAprobacion}`);
                console.log(`- Progreso: ${stats.porcentajeCompletado}%`);
            }
        }

        /**
         * Funci√≥n para exportar datos (para futuras mejoras)
         */
        function exportarDatos() {
            if (datosCompletos.asignacionesFiltradas.length === 0) {
                showMessage('No hay datos para exportar', 'warning');
                return;
            }
            
            try {
                const datos = datosCompletos.asignacionesFiltradas.map(item => ({
                    'Sub-√≠tem': item.sub_item_name,
                    'Distribuci√≥n': item.categoria_detalle,
                    'Responsable': item.worker_name,
                    'Valor Solicitado': item.requested_value,
                    'Valor Aprobado': item.approved_value
                }));
                
                const csvContent = convertirArrayACSV(datos);
                descargarCSV(csvContent, 'autorizacion_presupuesto.csv');
                
                showMessage('Datos exportados correctamente', 'success');
            } catch (error) {
                console.error('Error al exportar:', error);
                showMessage('Error al exportar datos', 'danger');
            }
        }

        /**
         * Convierte array a CSV
         */
        function convertirArrayACSV(array) {
            if (array.length === 0) return '';
            
            const headers = Object.keys(array[0]);
            const csvRows = [
                headers.join(','),
                ...array.map(row => headers.map(header => {
                    const value = row[header];
                    return typeof value === 'string' ? `"${value}"` : value;
                }).join(','))
            ];
            
            return csvRows.join('\n');
        }

        /**
         * Descarga contenido como archivo CSV
         */
        function descargarCSV(contenido, nombreArchivo) {
            const blob = new Blob([contenido], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', nombreArchivo);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // ==========================================
        // FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================

        // Hacer funciones de debug disponibles en consola para desarrollo
        window.mostrarEstadisticas = mostrarEstadisticas;
        window.exportarDatos = exportarDatos;
        window.resetearFormulario = resetearFormulario;

        // ==========================================
        // LOG DE FINALIZACI√ìN
        // ==========================================

        console.log('üìä Autorizaci√≥n de Presupuesto - Parte 4 cargada (Guardado y Finalizaci√≥n)');
        console.log('üéâ Sistema de Autorizaci√≥n de Presupuesto completamente inicializado');
        console.log('‚ö° Funciones disponibles en consola: mostrarEstadisticas(), exportarDatos(), resetearFormulario()');
        console.log('üéØ Patrones de c√≥digo siguiendo ejemplos exitosos de SchoolNet');
        
        // Mensaje de bienvenida al usuario
        setTimeout(() => {
            if (datosCompletos.anios.length > 0 && datosCompletos.rubros.length > 0) {
                showMessage(`Sistema listo. ${datosCompletos.anios.length} a√±os y ${datosCompletos.rubros.length} rubros disponibles.`, 'info');
            }
        }, 1500);

        // ==========================================
        // CIERRE DEL SCRIPT
        // ==========================================
    </script>
</body>
</html>
