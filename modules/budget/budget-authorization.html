<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autorizaci√≥n de Presupuesto - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        :root {
            --color-primary: #2c3e50;
            --color-secondary: #3498db;
            --color-success: #27ae60;
            --color-warning: #f39c12;
            --color-danger: #e74c3c;
            --color-info: #17a2b8;
            --color-light: #f8f9fa;
            --color-dark: #343a40;
            --border-radius: 8px;
        }

        body {
            background-color: var(--color-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .page-header h1 {
            margin: 0;
            font-weight: 300;
        }

        .filters-section, .navigation-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters-section h3, .navigation-section h3 {
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-secondary);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .filters-row {
            display: flex;
            gap: 1rem;
            align-items: end;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .record-navigation {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .record-counter {
            font-weight: 600;
            color: var(--color-primary);
            font-size: 1.1rem;
        }

        .nav-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .record-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .readonly-field {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }

        .currency-field {
            text-align: right;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .currency-field.editable {
            background-color: white;
            color: var(--color-primary);
            border: 2px solid var(--color-secondary);
        }

        .record-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .save-button {
            display: flex;
            gap: 0.5rem;
        }

        .no-records {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
            font-style: italic;
        }

        .loading-records {
            text-align: center;
            padding: 3rem;
            color: var(--color-secondary);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modified-indicator {
            color: var(--color-warning);
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }
            
            .filters-row {
                flex-direction: column;
            }
            
            .record-form {
                grid-template-columns: 1fr;
            }
            
            .nav-header {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            
            .nav-controls {
                justify-content: center;
            }
            
            .record-actions {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <div class="main-container">
        <!-- Navegaci√≥n de breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <div id="breadcrumbContainer"></div>
        </nav>

        <!-- Encabezado de la p√°gina -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="bi bi-check2-square me-2"></i>Autorizaci√≥n de Presupuesto</h1>
                    <p class="mb-0 opacity-75">Aprobaci√≥n de valores presupuestales por asignaci√≥n</p>
                </div>
                <div>
                    <button id="btn-manual" class="btn btn-outline-light" style="display: none;">
                        <i class="bi bi-book me-1"></i>Manual
                    </button>
                </div>
            </div>
        </div>

        <!-- Contenedor de mensajes -->
        <div id="alertContainer"></div>

        <!-- Secci√≥n de filtros -->
        <div class="filters-section">
            <h3><i class="bi bi-funnel me-2"></i>Filtros de B√∫squeda</h3>
            <div class="filters-row">
                <div class="filter-group">
                    <label for="select-anio" class="form-label">A√±o Acad√©mico <span class="text-danger">*</span></label>
                    <select id="select-anio" class="form-select" required>
                        <option value="">-- Seleccione un a√±o --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="select-rubro" class="form-label">Rubro Presupuestal <span class="text-danger">*</span></label>
                    <select id="select-rubro" class="form-select" required disabled>
                        <option value="">-- Seleccione un rubro --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="form-label">&nbsp;</label>
                    <button id="btn-buscar" class="btn btn-primary w-100" disabled>
                        <i class="bi bi-search me-1"></i>Buscar Asignaciones
                    </button>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de navegaci√≥n de registros -->
        <div id="navigation-section" class="navigation-section hidden">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Autorizaci√≥n de Valores</h3>
                <span id="total-asignaciones" class="badge bg-primary">0 asignaciones</span>
            </div>

            <div class="record-navigation">
                <div class="nav-header">
                    <div class="record-counter">
                        Registro <span id="current-record">0</span> de <span id="total-records">0</span>
                        <span id="modified-indicator" class="modified-indicator hidden">‚óè Modificado</span>
                    </div>
                    <div class="nav-controls">
                        <button id="btn-anterior" class="btn btn-outline-secondary btn-sm" disabled>
                            <i class="bi bi-chevron-left"></i> Anterior
                        </button>
                        <button id="btn-siguiente" class="btn btn-outline-secondary btn-sm" disabled>
                            Siguiente <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Formulario de registro actual -->
                <div class="record-form">
                    <div class="form-group">
                        <label for="field-subitem" class="form-label">Sub-√≠tem:</label>
                        <input type="text" id="field-subitem" class="form-control readonly-field" readonly>
                    </div>

                    <div class="form-group">
                        <label for="field-distribucion" class="form-label">Distribuci√≥n:</label>
                        <input type="text" id="field-distribucion" class="form-control readonly-field" readonly>
                    </div>

                    <div class="form-group full-width">
                        <label for="field-responsable" class="form-label">Responsable:</label>
                        <input type="text" id="field-responsable" class="form-control readonly-field" readonly>
                    </div>

                    <div class="form-group">
                        <label for="field-valor-solicitado" class="form-label">Valor Solicitado:</label>
                        <input type="text" id="field-valor-solicitado" class="form-control readonly-field currency-field" readonly>
                    </div>

                    <div class="form-group">
                        <label for="field-valor-aprobado" class="form-label">Valor Aprobado <span class="text-danger">*</span>:</label>
                        <input type="number" id="field-valor-aprobado" class="form-control currency-field editable" 
                               placeholder="Ingrese el valor aprobado" min="0" step="1">
                        <div class="form-text">Ingrese solo n√∫meros enteros (sin puntos ni comas)</div>
                    </div>
                </div>

                <!-- Controles de navegaci√≥n y guardado -->
                <div class="record-actions">
                    <div class="nav-buttons">
                        <button id="btn-primer-registro" class="btn btn-outline-info btn-sm" disabled>
                            <i class="bi bi-skip-start"></i> Primero
                        </button>
                        <button id="btn-ultimo-registro" class="btn btn-outline-info btn-sm" disabled>
                            √öltimo <i class="bi bi-skip-end"></i>
                        </button>
                    </div>

                    <div class="save-button">
                        <button id="btn-cancelar-cambios" class="btn btn-outline-warning" style="display: none;">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <button id="btn-guardar" class="btn btn-success" disabled>
                            <i class="bi bi-save me-1"></i>Guardar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje cuando no hay registros -->
        <div id="no-records" class="no-records hidden">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #dee2e6;"></i>
            <h4>No se encontraron registros</h4>
            <p>No hay asignaciones presupuestales para el a√±o y rubro seleccionados.</p>
        </div>

        <!-- Mensaje de carga de registros -->
        <div id="loading-records" class="loading-records hidden">
            <div class="spinner"></div>
            <p>Cargando asignaciones...</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Configuraci√≥n del sistema -->
    <script src="../../assets/js/config.js"></script>

    <script>
        /**
         * JavaScript para Autorizaci√≥n de Presupuesto - SchoolNet
         * Migrado desde Google Apps Script a Next.js
         */

        // Variables globales
        let datosCompletos = {
            anios: [],
            rubros: [],
            asignaciones: [],
            asignacionesFiltradas: []
        };

        let registroActual = 0;
        let registroModificado = false;
        let elementos = {};

        /**
         * Inicializaci√≥n cuando se carga el DOM
         */
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                const hasAccess = await validatePageAccess('Autorizaci√≥n de presupuesto');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');

                // Implementar breadcrumbs autom√°ticamente
                const breadcrumbContainer = document.getElementById('breadcrumbContainer');
                if (breadcrumbContainer) {
                    breadcrumbContainer.innerHTML = generateBreadcrumbs('Presupuesto', 'Autorizaci√≥n de Presupuesto');
                }

                // Continuar con inicializaci√≥n
                inicializarElementos();
                configurarEventListeners();
                await cargarDatosIniciales();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });

        /**
         * Cachea referencias a elementos DOM
         */
        function inicializarElementos() {
            elementos = {
                loadingOverlay: document.getElementById('loading-overlay'),
                selectAnio: document.getElementById('select-anio'),
                selectRubro: document.getElementById('select-rubro'),
                btnBuscar: document.getElementById('btn-buscar'),
                navigationSection: document.getElementById('navigation-section'),
                currentRecord: document.getElementById('current-record'),
                totalRecords: document.getElementById('total-records'),
                totalAsignaciones: document.getElementById('total-asignaciones'),
                modifiedIndicator: document.getElementById('modified-indicator'),
                
                // Campos del formulario
                fieldSubitem: document.getElementById('field-subitem'),
                fieldDistribucion: document.getElementById('field-distribucion'),
                fieldResponsable: document.getElementById('field-responsable'),
                fieldValorSolicitado: document.getElementById('field-valor-solicitado'),
                fieldValorAprobado: document.getElementById('field-valor-aprobado'),
                
                // Botones
                btnAnterior: document.getElementById('btn-anterior'),
                btnSiguiente: document.getElementById('btn-siguiente'),
                btnPrimerRegistro: document.getElementById('btn-primer-registro'),
                btnUltimoRegistro: document.getElementById('btn-ultimo-registro'),
                btnGuardar: document.getElementById('btn-guardar'),
                btnCancelarCambios: document.getElementById('btn-cancelar-cambios'),
                
                // Otros elementos
                noRecords: document.getElementById('no-records'),
                loadingRecords: document.getElementById('loading-records')
            };
        }

        /**
         * Configura event listeners
         */

        function configurarEventListeners() {
    // Filtros
    elementos.selectAnio.addEventListener('change', onAnioChange);
    elementos.selectRubro.addEventListener('change', onRubroChange);
    elementos.btnBuscar.addEventListener('click', filtrarAsignaciones);
    
    // Navegaci√≥n
    elementos.btnAnterior.addEventListener('click', irAnterior);
    elementos.btnSiguiente.addEventListener('click', irSiguiente);
    elementos.btnPrimerRegistro.addEventListener('click', irPrimerRegistro);
    elementos.btnUltimoRegistro.addEventListener('click', irUltimoRegistro);
    
    // Guardado
    elementos.btnGuardar.addEventListener('click', guardarRegistro);
    elementos.btnCancelarCambios.addEventListener('click', cancelarCambios);
    
    // Campo editable - eventos mejorados
    elementos.fieldValorAprobado.addEventListener('input', onValorAprobadoChange);
    
    // CAMBIO IMPORTANTE: Solo formatear cuando el usuario presiona Enter o cambia de campo de manera intencional
    elementos.fieldValorAprobado.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            formatearValorAprobado();
            e.target.blur(); // Quitar foco despu√©s de formatear
        }
    });
    
    // NO usar blur autom√°tico - solo formatear cuando sea necesario
    // elementos.fieldValorAprobado.addEventListener('blur', formatearValorAprobado); // COMENTADO
    
    // Teclas r√°pidas
    document.addEventListener('keydown', manejarTeclasRapidas);
}

        
        /**
         * Carga el select de a√±os acad√©micos
         */
        function cargarSelectAnios() {
            elementos.selectAnio.innerHTML = '<option value="">-- Seleccione un a√±o --</option>';
            
            datosCompletos.anios.forEach(anio => {
                const option = document.createElement('option');
                option.value = anio.year_id;
                option.textContent = anio.year_name;
                elementos.selectAnio.appendChild(option);
            });
        }

        /**
         * Carga el select de rubros
         */
        function cargarSelectRubros() {
            elementos.selectRubro.innerHTML = '<option value="">-- Seleccione un rubro --</option>';
            
            datosCompletos.rubros.forEach(rubro => {
                const option = document.createElement('option');
                option.value = rubro.category_id;
                option.textContent = rubro.category_name;
                elementos.selectRubro.appendChild(option);
            });
            
            elementos.selectRubro.disabled = false;
        }

        /**
         * Event handler para cambio de a√±o
         */
        function onAnioChange() {
            const anioSeleccionado = elementos.selectAnio.value;
            if (anioSeleccionado && elementos.selectRubro.value) {
                elementos.btnBuscar.disabled = false;
            } else {
                elementos.btnBuscar.disabled = true;
                resetearFormulario();
            }
        }

        /**
         * Event handler para cambio de rubro
         */
        function onRubroChange() {
            const rubroSeleccionado = elementos.selectRubro.value;
            if (rubroSeleccionado && elementos.selectAnio.value) {
                elementos.btnBuscar.disabled = false;
            } else {
                elementos.btnBuscar.disabled = true;
                resetearFormulario();
            }
        }

        /**
 * Filtra asignaciones por a√±o y rubro (VERSI√ìN CORREGIDA)
 */

        async function filtrarAsignaciones() {
    const anioId = elementos.selectAnio.value;
    const rubroId = elementos.selectRubro.value;
    
    if (!anioId || !rubroId) {
        showMessage('Seleccione a√±o y rubro para continuar', 'warning');
        return;
    }
    
    try {
        console.log('üîç Filtrando asignaciones:', { anioId, rubroId });
        
        elementos.loadingRecords.classList.remove('hidden');
        elementos.navigationSection.classList.add('hidden');
        elementos.noRecords.classList.add('hidden');
        
        // PASO 1: Obtener items del rubro seleccionado
        const itemsQuery = `/budget_items?select=item_id,item_name&category_id=eq.${rubroId}`;
        console.log('üìä Consultando items:', itemsQuery);
        const items = await supabaseRequest(itemsQuery);
        
        if (!items || items.length === 0) {
            mostrarNoRecords();
            showMessage('No hay items para el rubro seleccionado', 'info');
            return;
        }
        
        console.log('üìä Items encontrados:', items.length);
        
        // PASO 2: Obtener asignaciones - CON DEBUGGING ESPEC√çFICO PARA APPROVED_VALUE
        const itemIds = items.map(item => item.item_id);
        const asignacionesQuery = `/budget_assignments?select=assignment_id,budget_item_id,category_detail,worker_email,requested_value,approved_value&academic_year_id=eq.${anioId}&budget_item_id=in.(${itemIds.join(',')})&assignment_status=eq.active`;
        console.log('üìä Consultando asignaciones:', asignacionesQuery);
        
        const asignaciones = await supabaseRequest(asignacionesQuery);
        console.log('üìä Asignaciones RAW de Supabase:', asignaciones);
        
        // DEBUGGING ESPEC√çFICO: Mostrar los valores aprobados que vienen de la base
        if (asignaciones && asignaciones.length > 0) {
            console.log('üí∞ VALORES APROBADOS EN BASE DE DATOS:');
            asignaciones.forEach((asig, index) => {
                console.log(`   ${index + 1}. Assignment ${asig.assignment_id}:`);
                console.log(`      - requested_value: ${asig.requested_value} (tipo: ${typeof asig.requested_value})`);
                console.log(`      - approved_value: ${asig.approved_value} (tipo: ${typeof asig.approved_value})`);
                console.log(`      - worker_email: ${asig.worker_email}`);
                console.log(`      - item_id: ${asig.budget_item_id}`);
            });
        }
        
        if (!asignaciones || asignaciones.length === 0) {
            mostrarNoRecords();
            showMessage('No se encontraron asignaciones para los criterios seleccionados', 'info');
            return;
        }
        
        // PASO 3: Obtener informaci√≥n de workers
        const emails = [...new Set(asignaciones.map(a => a.worker_email).filter(e => e))];
        let workersMap = new Map();
        
        if (emails.length > 0) {
            const emailsList = emails.map(email => `"${email}"`).join(',');
            const workersQuery = `/workers?select=email,worker_first_name,worker_last_name_1,worker_last_name_2&email=in.(${emailsList})`;
            const workers = await supabaseRequest(workersQuery);
            
            if (workers) {
                workers.forEach(w => {
                    const fullName = `${w.worker_first_name} ${w.worker_last_name_1} ${w.worker_last_name_2 || ''}`.trim();
                    workersMap.set(w.email, fullName);
                });
            }
        }
        
        // PASO 4: Crear mapa de items
        const itemsMap = new Map(items.map(item => [item.item_id, item.item_name]));
        
        // PASO 5: Combinar datos - CON PRESERVACI√ìN EXACTA DE VALORES
        datosCompletos.asignacionesFiltradas = asignaciones.map((asignacion, index) => {
            const procesamientoInfo = {
                originalRequestedValue: asignacion.requested_value,
                originalApprovedValue: asignacion.approved_value,
                processedRequestedValue: asignacion.requested_value || 0,
                processedApprovedValue: asignacion.approved_value || 0
            };
            
            console.log(`üí∞ Procesando asignaci√≥n ${index + 1}:`, procesamientoInfo);
            
            return {
                assignment_id: asignacion.assignment_id,
                budget_item_id: asignacion.budget_item_id,
                category_detail: asignacion.category_detail || 'General',
                worker_email: asignacion.worker_email,
                requested_value: Number(asignacion.requested_value) || 0,
                approved_value: Number(asignacion.approved_value) || 0,
                item_name: itemsMap.get(asignacion.budget_item_id) || 'Sin nombre',
                worker_name: workersMap.get(asignacion.worker_email) || 'Sin asignar'
            };
        });
        
        console.log('‚úÖ DATOS FINALES PROCESADOS:');
        datosCompletos.asignacionesFiltradas.forEach((asig, index) => {
            console.log(`   ${index + 1}. ${asig.item_name}:`);
            console.log(`      - requested_value: ${asig.requested_value}`);
            console.log(`      - approved_value: ${asig.approved_value}`);
            console.log(`      - assignment_id: ${asig.assignment_id}`);
        });
        
        if (datosCompletos.asignacionesFiltradas.length > 0) {
            registroActual = 0;
            registroModificado = false;
            mostrarSeccionNavegacion();
            mostrarRegistroActual();
            showMessage(`Se encontraron ${datosCompletos.asignacionesFiltradas.length} asignaciones`, 'success');
        } else {
            mostrarNoRecords();
            showMessage('No se encontraron asignaciones v√°lidas', 'info');
        }
        
    } catch (error) {
        console.error('‚ùå Error al filtrar asignaciones:', error);
        showMessage('Error al cargar asignaciones: ' + error.message, 'danger');
        mostrarNoRecords();
    } finally {
        elementos.loadingRecords.classList.add('hidden');
    }
}
        
        /**
         * Navegaci√≥n - ir al registro anterior
         */
        async function irAnterior() {
            if (registroActual > 0) {
                if (registroModificado) {
                    const guardado = await guardarRegistro();
                    if (guardado) {
                        registroActual--;
                        mostrarRegistroActual();
                    }
                } else {
                    registroActual--;
                    mostrarRegistroActual();
                }
            }
        }

        /**
         * Navegaci√≥n - ir al registro siguiente
         */
        async function irSiguiente() {
            if (registroActual < datosCompletos.asignacionesFiltradas.length - 1) {
                if (registroModificado) {
                    const guardado = await guardarRegistro();
                    if (guardado) {
                        registroActual++;
                        mostrarRegistroActual();
                    }
                } else {
                    registroActual++;
                    mostrarRegistroActual();
                }
            }
        }

        /**
         * Navegaci√≥n - ir al primer registro
         */
        async function irPrimerRegistro() {
            if (registroActual !== 0) {
                if (registroModificado) {
                    const guardado = await guardarRegistro();
                    if (guardado) {
                        registroActual = 0;
                        mostrarRegistroActual();
                    }
                } else {
                    registroActual = 0;
                    mostrarRegistroActual();
                }
            }
        }

        /**
         * Navegaci√≥n - ir al √∫ltimo registro
         */
        async function irUltimoRegistro() {
            const ultimoIndice = datosCompletos.asignacionesFiltradas.length - 1;
            if (registroActual !== ultimoIndice) {
                if (registroModificado) {
                    const guardado = await guardarRegistro();
                    if (guardado) {
                        registroActual = ultimoIndice;
                        mostrarRegistroActual();
                    }
                } else {
                    registroActual = ultimoIndice;
                    mostrarRegistroActual();
                }
            }
        }

        /**
         * Muestra el registro actual en el formulario
         */
        /**
 * REEMPLAZA la funci√≥n mostrarRegistroActual() que NO tiene debugging con esta versi√≥n
 */
function mostrarRegistroActual() {
    if (datosCompletos.asignacionesFiltradas.length === 0) return;
    
    const registro = datosCompletos.asignacionesFiltradas[registroActual];
    console.log('üìã MOSTRANDO REGISTRO ACTUAL:', {
        indice: registroActual + 1,
        assignment_id: registro.assignment_id,
        item_name: registro.item_name,
        requested_value: registro.requested_value,
        approved_value: registro.approved_value,
        worker_name: registro.worker_name
    });
    
    // Llenar campos con debugging
    elementos.fieldSubitem.value = registro.item_name;
    elementos.fieldDistribucion.value = registro.category_detail;
    elementos.fieldResponsable.value = registro.worker_name;
    elementos.fieldValorSolicitado.value = formatearMoneda(registro.requested_value);
    
    // DEBUGGING ESPEC√çFICO PARA APPROVED_VALUE
    const valorAprobadoOriginal = registro.approved_value;
    let valorAprobadoMostrar = '';
    
    // CORRECCI√ìN: Verificar si el valor existe y es mayor a 0
    if (valorAprobadoOriginal && valorAprobadoOriginal > 0) {
        valorAprobadoMostrar = valorAprobadoOriginal.toString(); // Mostrar como string sin formatear
    }
    
    console.log('üí∞ VALOR APROBADO - AN√ÅLISIS:', {
        valorOriginalBD: valorAprobadoOriginal,
        valorOriginalTipo: typeof valorAprobadoOriginal,
        valorOriginalMayorCero: valorAprobadoOriginal > 0,
        valorAMostrar: valorAprobadoMostrar,
        valorEsVacio: valorAprobadoMostrar === ''
    });
    
    elementos.fieldValorAprobado.value = valorAprobadoMostrar;
    
    console.log('üí∞ CAMPO ACTUALIZADO:', {
        campoValue: elementos.fieldValorAprobado.value,
        campoVacio: elementos.fieldValorAprobado.value === ''
    });
    
    // Actualizar contador
    elementos.currentRecord.textContent = registroActual + 1;
    elementos.totalRecords.textContent = datosCompletos.asignacionesFiltradas.length;
    
    // Reset modificado
    registroModificado = false;
    actualizarEstadoBotones();
    
    // Enfocar campo editable
    elementos.fieldValorAprobado.focus();
    elementos.fieldValorAprobado.select();
}
        
        /**
         * Event handler para cambio en valor aprobado
         */

        function onValorAprobadoChange() {
    registroModificado = true;
    
    // Solo n√∫meros - permitir borrar completamente
    const valor = elementos.fieldValorAprobado.value;
    const valorLimpio = valor.replace(/[^\d]/g, '');
    
    // Actualizar solo si hay diferencia significativa
    if (valor !== valorLimpio) {
        elementos.fieldValorAprobado.value = valorLimpio;
    }
    
    actualizarEstadoBotones();
}
        
        /**
         * Formatea el valor aprobado
         */
        function formatearValorAprobado() {
    const valorActual = elementos.fieldValorAprobado.value;
    
    // Solo formatear si el campo tiene contenido y no est√° vac√≠o
    if (valorActual && valorActual.trim() !== '') {
        const valor = limpiarFormatoMoneda(valorActual);
        
        // Solo formatear si es un n√∫mero v√°lido mayor a 0
        if (valor > 0) {
            elementos.fieldValorAprobado.value = valor.toLocaleString('es-CO');
        }
    }
}

        /**
         * Cancela los cambios actuales
         */
        function cancelarCambios() {
            if (registroModificado && confirm('¬øDesea cancelar los cambios realizados?')) {
                mostrarRegistroActual();
                showMessage('Cambios cancelados', 'info');
            }
        }

        /**
         * Maneja teclas r√°pidas
         */
        function manejarTeclasRapidas(e) {
            if (datosCompletos.asignacionesFiltradas.length === 0) return;
            
            if (e.ctrlKey && e.key === 'ArrowLeft') {
                e.preventDefault();
                irAnterior();
            }
            
            if (e.ctrlKey && e.key === 'ArrowRight') {
                e.preventDefault();
                irSiguiente();
            }
            
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                guardarRegistro();
            }
            
            if (e.key === 'Escape' && registroModificado) {
                e.preventDefault();
                cancelarCambios();
            }
        }

        /**
         * Actualiza el estado de los botones
         */
        function actualizarEstadoBotones() {
            const totalRegistros = datosCompletos.asignacionesFiltradas.length;
            
            elementos.btnAnterior.disabled = registroActual === 0;
            elementos.btnSiguiente.disabled = registroActual === totalRegistros - 1;
            elementos.btnPrimerRegistro.disabled = registroActual === 0;
            elementos.btnUltimoRegistro.disabled = registroActual === totalRegistros - 1;
            elementos.btnGuardar.disabled = !registroModificado;
            
            // Mostrar/ocultar indicador de modificado
            if (registroModificado) {
                elementos.modifiedIndicator.classList.remove('hidden');
                elementos.btnCancelarCambios.style.display = 'inline-block';
            } else {
                elementos.modifiedIndicator.classList.add('hidden');
                elementos.btnCancelarCambios.style.display = 'none';
            }
        }

        /**
         * Muestra la secci√≥n de navegaci√≥n
         */
        function mostrarSeccionNavegacion() {
            elementos.navigationSection.classList.remove('hidden');
            elementos.noRecords.classList.add('hidden');
            elementos.loadingRecords.classList.add('hidden');
            elementos.totalAsignaciones.textContent = `${datosCompletos.asignacionesFiltradas.length} asignaciones`;
        }

        /**
         * Muestra mensaje de no hay registros
         */
        function mostrarNoRecords() {
            elementos.noRecords.classList.remove('hidden');
            elementos.navigationSection.classList.add('hidden');
            elementos.totalAsignaciones.textContent = '0 asignaciones';
        }

        /**
         * Resetea el formulario
         */
        function resetearFormulario() {
            datosCompletos.asignacionesFiltradas = [];
            registroActual = 0;
            registroModificado = false;
            
            elementos.navigationSection.classList.add('hidden');
            elementos.noRecords.classList.add('hidden');
            elementos.loadingRecords.classList.add('hidden');
        }

        /**
         * Valida el valor aprobado
         */
        function validarValorAprobado(valor) {
            if (isNaN(valor) || !Number.isInteger(valor) || valor < 0) {
                showMessage('El valor debe ser un n√∫mero entero positivo', 'warning');
                elementos.fieldValorAprobado.focus();
                return false;
            }
            return true;
        }

        /**
         * Formatea valor como moneda
         */
        function formatearMoneda(valor) {
            if (!valor || valor === 0) return '$0';
            return '$' + parseInt(valor).toLocaleString('es-CO');
        }

        /**
         * Limpia el formato de moneda y devuelve n√∫mero
         */
        function limpiarFormatoMoneda(valor) {
            if (!valor) return 0;
            return parseInt(valor.toString().replace(/[^\d]/g, '')) || 0;
        }

        /**
         * Muestra overlay de loading
         */
        function mostrarLoading(mensaje = 'Cargando...') {
            elementos.loadingOverlay.querySelector('p').textContent = mensaje;
            elementos.loadingOverlay.classList.remove('hidden');
        }

        /**
         * Oculta overlay de loading
         */
        function ocultarLoading() {
            elementos.loadingOverlay.classList.add('hidden');
        }

        /**
         * Manejo de errores globales de JavaScript
         */
        window.addEventListener('error', function(e) {
            console.error('Error global capturado:', e.error);
            showMessage('Se ha producido un error inesperado. Por favor, recargue la p√°gina.', 'danger');
        });

        /**
         * Prevenir p√©rdida de datos al salir
         */
        window.addEventListener('beforeunload', function(e) {
            if (registroModificado) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

/**
 * FUNCI√ìN FALTANTE: cargarDatosIniciales
 */
async function cargarDatosIniciales() {
    try {
        mostrarLoading('Cargando datos iniciales...');
        
        // Cargar a√±os acad√©micos
        console.log('üìÖ Cargando a√±os acad√©micos...');
        const aniosData = await supabaseRequest('/academic_years?select=year_id,year_name,year_order&order=year_order.desc');
        datosCompletos.anios = aniosData || [];
        console.log('‚úÖ A√±os cargados:', datosCompletos.anios.length);
        cargarSelectAnios();
        
        // Cargar rubros presupuestales
        console.log('üìä Cargando rubros presupuestales...');
        const rubrosData = await supabaseRequest('/budget_categories?select=category_id,category_name&category_status=eq.active&order=category_name.asc');
        datosCompletos.rubros = rubrosData || [];
        console.log('‚úÖ Rubros cargados:', datosCompletos.rubros.length);
        cargarSelectRubros();
        
        ocultarLoading();
        showMessage('Datos iniciales cargados correctamente', 'success');
        
    } catch (error) {
        console.error('‚ùå Error al cargar datos iniciales:', error);
        showMessage('Error al cargar datos iniciales: ' + error.message, 'danger');
        ocultarLoading();
    }
}

/**
 * FUNCI√ìN FALTANTE: cargarSelectAnios
 */
function cargarSelectAnios() {
    elementos.selectAnio.innerHTML = '<option value="">-- Seleccione un a√±o --</option>';
    
    datosCompletos.anios.forEach(anio => {
        const option = document.createElement('option');
        option.value = anio.year_id;
        option.textContent = anio.year_name;
        elementos.selectAnio.appendChild(option);
    });
}

/**
 * FUNCI√ìN FALTANTE: cargarSelectRubros
 */
function cargarSelectRubros() {
    elementos.selectRubro.innerHTML = '<option value="">-- Seleccione un rubro --</option>';
    
    datosCompletos.rubros.forEach(rubro => {
        const option = document.createElement('option');
        option.value = rubro.category_id;
        option.textContent = rubro.category_name;
        elementos.selectRubro.appendChild(option);
    });
    
    elementos.selectRubro.disabled = false;
}

/**
 * FUNCI√ìN FALTANTE: onAnioChange
 */
function onAnioChange() {
    const anioSeleccionado = elementos.selectAnio.value;
    console.log('üìÖ A√±o seleccionado:', anioSeleccionado);
    
    if (anioSeleccionado && elementos.selectRubro.value) {
        elementos.btnBuscar.disabled = false;
    } else {
        elementos.btnBuscar.disabled = true;
        resetearFormulario();
    }
}

/**
 * FUNCI√ìN FALTANTE: onRubroChange
 */
function onRubroChange() {
    const rubroSeleccionado = elementos.selectRubro.value;
    console.log('üìä Rubro seleccionado:', rubroSeleccionado);
    
    if (rubroSeleccionado && elementos.selectAnio.value) {
        elementos.btnBuscar.disabled = false;
    } else {
        elementos.btnBuscar.disabled = true;
        resetearFormulario();
    }
}

/**
 * FUNCI√ìN FALTANTE: mostrarRegistroActual
 */
function mostrarRegistroActual() {
    if (datosCompletos.asignacionesFiltradas.length === 0) return;
    
    const registro = datosCompletos.asignacionesFiltradas[registroActual];
    console.log('üìã Mostrando registro:', registroActual + 1, registro);
    
    // Llenar campos
    elementos.fieldSubitem.value = registro.item_name;
    elementos.fieldDistribucion.value = registro.category_detail;
    elementos.fieldResponsable.value = registro.worker_name;
    elementos.fieldValorSolicitado.value = formatearMoneda(registro.requested_value);
    elementos.fieldValorAprobado.value = registro.approved_value > 0 ? registro.approved_value.toLocaleString('es-CO') : '';
    
    // Actualizar contador
    elementos.currentRecord.textContent = registroActual + 1;
    elementos.totalRecords.textContent = datosCompletos.asignacionesFiltradas.length;
    
    // Reset modificado
    registroModificado = false;
    actualizarEstadoBotones();
    
    // Enfocar campo editable
    elementos.fieldValorAprobado.focus();
    elementos.fieldValorAprobado.select();
}

/**
 * FUNCI√ìN FALTANTE: mostrarSeccionNavegacion
 */
function mostrarSeccionNavegacion() {
    elementos.navigationSection.classList.remove('hidden');
    elementos.noRecords.classList.add('hidden');
    elementos.loadingRecords.classList.add('hidden');
    elementos.totalAsignaciones.textContent = `${datosCompletos.asignacionesFiltradas.length} asignaciones`;
}

/**
 * FUNCI√ìN FALTANTE: mostrarNoRecords
 */
function mostrarNoRecords() {
    elementos.noRecords.classList.remove('hidden');
    elementos.navigationSection.classList.add('hidden');
    elementos.totalAsignaciones.textContent = '0 asignaciones';
}

/**
 * FUNCI√ìN FALTANTE: resetearFormulario
 */
function resetearFormulario() {
    datosCompletos.asignacionesFiltradas = [];
    registroActual = 0;
    registroModificado = false;
    
    elementos.navigationSection.classList.add('hidden');
    elementos.noRecords.classList.add('hidden');
    elementos.loadingRecords.classList.add('hidden');
}

/**
 * FUNCI√ìN FALTANTE: mostrarLoading
 */
function mostrarLoading(mensaje = 'Cargando...') {
    elementos.loadingOverlay.querySelector('p').textContent = mensaje;
    elementos.loadingOverlay.classList.remove('hidden');
}

/**
 * FUNCI√ìN FALTANTE: ocultarLoading
 */
function ocultarLoading() {
    elementos.loadingOverlay.classList.add('hidden');
}

/**
 * FUNCI√ìN FALTANTE: validarValorAprobado
 */
function validarValorAprobado(valor) {
    if (isNaN(valor) || !Number.isInteger(valor) || valor < 0) {
        showMessage('El valor debe ser un n√∫mero entero positivo', 'warning');
        elementos.fieldValorAprobado.focus();
        return false;
    }
    return true;
}

/**
 * FUNCI√ìN FALTANTE: formatearMoneda
 */
function formatearMoneda(valor) {
    if (!valor || valor === 0) return '$0';
    return '$' + parseInt(valor).toLocaleString('es-CO');
}

/**
 * FUNCI√ìN FALTANTE: limpiarFormatoMoneda
 */
function limpiarFormatoMoneda(valor) {
    if (!valor) return 0;
    return parseInt(valor.toString().replace(/[^\d]/g, '')) || 0;
}

/**
 * FUNCI√ìN FALTANTE: actualizarEstadoBotones
 */
function actualizarEstadoBotones() {
    const totalRegistros = datosCompletos.asignacionesFiltradas.length;
    
    elementos.btnAnterior.disabled = registroActual === 0;
    elementos.btnSiguiente.disabled = registroActual === totalRegistros - 1;
    elementos.btnPrimerRegistro.disabled = registroActual === 0;
    elementos.btnUltimoRegistro.disabled = registroActual === totalRegistros - 1;
    elementos.btnGuardar.disabled = !registroModificado;
    
    // Mostrar/ocultar indicador de modificado
    if (registroModificado) {
        elementos.modifiedIndicator.classList.remove('hidden');
        elementos.btnCancelarCambios.style.display = 'inline-block';
    } else {
        elementos.modifiedIndicator.classList.add('hidden');
        elementos.btnCancelarCambios.style.display = 'none';
    }
}

/**
 * FUNCIONES FALTANTES: Navegaci√≥n
 */
async function irAnterior() {
    if (registroActual > 0) {
        if (registroModificado) {
            const guardado = await guardarRegistro();
            if (guardado) {
                registroActual--;
                mostrarRegistroActual();
            }
        } else {
            registroActual--;
            mostrarRegistroActual();
        }
    }
}

async function irSiguiente() {
    if (registroActual < datosCompletos.asignacionesFiltradas.length - 1) {
        if (registroModificado) {
            const guardado = await guardarRegistro();
            if (guardado) {
                registroActual++;
                mostrarRegistroActual();
            }
        } else {
            registroActual++;
            mostrarRegistroActual();
        }
    }
}

async function irPrimerRegistro() {
    if (registroActual !== 0) {
        if (registroModificado) {
            const guardado = await guardarRegistro();
            if (guardado) {
                registroActual = 0;
                mostrarRegistroActual();
            }
        } else {
            registroActual = 0;
            mostrarRegistroActual();
        }
    }
}

async function irUltimoRegistro() {
    const ultimoIndice = datosCompletos.asignacionesFiltradas.length - 1;
    if (registroActual !== ultimoIndice) {
        if (registroModificado) {
            const guardado = await guardarRegistro();
            if (guardado) {
                registroActual = ultimoIndice;
                mostrarRegistroActual();
            }
        } else {
            registroActual = ultimoIndice;
            mostrarRegistroActual();
        }
    }
}

function cancelarCambios() {
    if (registroModificado && confirm('¬øDesea cancelar los cambios realizados?')) {
        mostrarRegistroActual();
        showMessage('Cambios cancelados', 'info');
    }
}

function manejarTeclasRapidas(e) {
    if (datosCompletos.asignacionesFiltradas.length === 0) return;
    
    if (e.ctrlKey && e.key === 'ArrowLeft') {
        e.preventDefault();
        irAnterior();
    }
    
    if (e.ctrlKey && e.key === 'ArrowRight') {
        e.preventDefault();
        irSiguiente();
    }
    
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        guardarRegistro();
    }
    
    if (e.key === 'Escape' && registroModificado) {
        e.preventDefault();
        cancelarCambios();
    }
}
        
        // Aplicar branding y configuraci√≥n autom√°ticamente
        updatePageTitle('budgetAuthorization', 'Presupuesto');
        initializePage();

        console.log('üéâ Formulario de Autorizaci√≥n de Presupuesto - SchoolNet v1.0');
        console.log('üìä Patr√≥n: Filtrado por criterios + Navegaci√≥n de registros + Edici√≥n individual');

/**
 * FUNCI√ìN FALTANTE: guardarRegistro - Agregar antes del cierre del script
 */
async function guardarRegistro() {
    if (!registroModificado) {
        showMessage('No hay cambios para guardar', 'info');
        return true;
    }
    
    const registro = datosCompletos.asignacionesFiltradas[registroActual];
    const nuevoValor = limpiarFormatoMoneda(elementos.fieldValorAprobado.value);
    
    console.log('üíæ Guardando registro:', {
        assignment_id: registro.assignment_id,
        nuevoValor: nuevoValor,
        valorOriginal: registro.approved_value
    });
    
    if (!validarValorAprobado(nuevoValor)) {
        return false;
    }
    
    try {
        elementos.btnGuardar.disabled = true;
        elementos.btnGuardar.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Guardando...';
        
        // Actualizar en Supabase usando UUID completo
        const updateUrl = `/budget_assignments?assignment_id=eq.${registro.assignment_id}`;
        console.log('üíæ URL de actualizaci√≥n:', updateUrl);
        
        const response = await supabaseRequest(updateUrl, {
            method: 'PATCH',
            body: JSON.stringify({
                approved_value: nuevoValor
            })
        });
        
        console.log('‚úÖ Respuesta de actualizaci√≥n:', response);
        
        // Actualizar datos locales
        datosCompletos.asignacionesFiltradas[registroActual].approved_value = nuevoValor;
        
        registroModificado = false;
        showMessage('Valor aprobado actualizado correctamente', 'success');
        
        // Auto-navegaci√≥n al siguiente registro
        if (registroActual < datosCompletos.asignacionesFiltradas.length - 1) {
            setTimeout(() => {
                registroActual++;
                mostrarRegistroActual();
            }, 1000);
        } else {
            showMessage('¬°√öltimo registro completado!', 'info');
        }
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Error al guardar:', error);
        showMessage('Error al guardar: ' + error.message, 'danger');
        return false;
    } finally {
        elementos.btnGuardar.disabled = false;
        elementos.btnGuardar.innerHTML = '<i class="bi bi-save me-1"></i>Guardar';
        actualizarEstadoBotones();
    }
}

        
    </script>
</body>
</html>
