<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autorizaci√≥n de Presupuesto - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <!-- Configuraci√≥n del sistema -->
    <script src="../../assets/js/config.js"></script>
    
    <!-- Estilos espec√≠ficos -->
    <style>
        .form-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .filters-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .filters-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 20px;
            align-items: end;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            display: block;
        }
        
        .filter-group select {
            border-radius: 8px;
            border: 2px solid #ced4da;
            padding: 10px 15px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .filter-group select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        .record-navigation {
            background: #ffffff;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .nav-header h4 {
            color: #0d6efd;
            margin: 0;
            font-weight: 700;
        }
        
        .record-counter {
            font-weight: 600;
            color: #6c757d;
            font-size: 16px;
        }
        
        .record-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            display: block;
        }
        
        .form-control.readonly-field {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            border: 1px solid #ced4da;
        }
        
        .currency-field {
            text-align: right;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            font-size: 16px;
        }
        
        .currency-field.editable {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            transition: all 0.3s ease;
        }
        
        .currency-field.editable:focus {
            background-color: #ffffff;
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        .record-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-nav {
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-save {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 12px 25px;
            font-weight: 700;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .no-records, .loading-records {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #dee2e6;
        }
        
        .loading-records {
            color: #0d6efd;
            border-color: #0d6efd;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mensajes de notificaci√≥n */
        .mensaje {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            max-width: 400px;
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: 600;
            animation: slideIn 0.3s ease;
        }
        
        .mensaje-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .mensaje-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .mensaje-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .mensaje-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .filters-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .record-form {
                grid-template-columns: 1fr;
            }
            
            .nav-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .record-actions {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-buttons {
                justify-content: center;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Breadcrumbs -->
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div id="breadcrumbContainer" class="mt-3">
                    <!-- Los breadcrumbs se insertan aqu√≠ autom√°ticamente -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contenedor principal -->
    <div class="container-fluid">
        <div class="form-container">
            <!-- Encabezado -->
            <div class="text-center mb-4">
                <h2 class="text-primary fw-bold">
                    <i class="bi bi-check-circle me-2"></i>
                    Autorizaci√≥n de Presupuesto
                </h2>
                <p class="text-muted">Gestione la aprobaci√≥n de valores presupuestales por asignaci√≥n</p>
            </div>
            
            <!-- Secci√≥n de filtros -->
            <div class="filters-section">
                <h5 class="text-primary mb-3">
                    <i class="bi bi-funnel me-2"></i>
                    Filtros de B√∫squeda
                </h5>
                <div class="filters-row">
                    <div class="filter-group">
                        <label for="select-anio">
                            <i class="bi bi-calendar3 me-1"></i>
                            Seleccione el a√±o:
                        </label>
                        <select id="select-anio" class="form-select" required>
                            <option value="">-- Seleccione un a√±o --</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="select-rubro">
                            <i class="bi bi-folder me-1"></i>
                            Seleccione el rubro:
                        </label>
                        <select id="select-rubro" class="form-select" required disabled>
                            <option value="">-- Seleccione un rubro --</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button id="btn-buscar" class="btn btn-primary btn-lg" disabled>
                            <i class="bi bi-search me-2"></i>
                            Buscar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Secci√≥n de navegaci√≥n de registros -->
            <div id="record-navigation" class="record-navigation d-none">
                <div class="nav-header">
                    <h4>
                        <i class="bi bi-pencil-square me-2"></i>
                        Autorizaci√≥n de Presupuesto
                    </h4>
                    <div class="record-counter">
                        Registro <span id="current-record" class="text-primary">0</span> de 
                        <span id="total-records" class="text-primary">0</span>
                    </div>
                </div>
                
                <!-- Formulario de registro actual -->
                <div class="record-form">
                    <div class="form-group">
                        <label for="field-subitem">
                            <i class="bi bi-tag me-1"></i>
                            Sub-√≠tem:
                        </label>
                        <input type="text" id="field-subitem" class="form-control readonly-field" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="field-distribucion">
                            <i class="bi bi-pie-chart me-1"></i>
                            Distribuci√≥n:
                        </label>
                        <input type="text" id="field-distribucion" class="form-control readonly-field" readonly>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="field-responsable">
                            <i class="bi bi-person-badge me-1"></i>
                            Responsable:
                        </label>
                        <input type="text" id="field-responsable" class="form-control readonly-field" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="field-valor-solicitado">
                            <i class="bi bi-currency-dollar me-1"></i>
                            Valor solicitado:
                        </label>
                        <input type="text" id="field-valor-solicitado" class="form-control readonly-field currency-field" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="field-valor-aprobado">
                            <i class="bi bi-check-circle-fill me-1 text-success"></i>
                            Valor aprobado:
                        </label>
                        <input type="number" id="field-valor-aprobado" 
                               class="form-control currency-field editable" 
                               placeholder="Ingrese el valor aprobado" 
                               min="0" step="1">
                    </div>
                </div>
                
                <!-- Controles de navegaci√≥n y guardado -->
                <div class="record-actions">
                    <div class="nav-buttons">
                        <button id="btn-anterior" class="btn btn-outline-secondary btn-nav" disabled>
                            <i class="bi bi-arrow-left me-1"></i>
                            Anterior
                        </button>
                        <button id="btn-siguiente" class="btn btn-outline-secondary btn-nav" disabled>
                            Siguiente
                            <i class="bi bi-arrow-right ms-1"></i>
                        </button>
                    </div>
                    
                    <div>
                        <button id="btn-guardar" class="btn btn-save">
                            <i class="bi bi-save me-2"></i>
                            Guardar Cambios
                        </button>
                    </div>
                </div>
                
                <!-- Indicadores de cambios -->
                <div id="changes-indicator" class="mt-3 d-none">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Hay cambios sin guardar.</strong> Use Ctrl+S para guardar r√°pidamente.
                    </div>
                </div>
            </div>
            
            <!-- Mensaje cuando no hay registros -->
            <div id="no-records" class="no-records d-none">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
                <h4 class="mt-3">No se encontraron registros</h4>
                <p>No hay asignaciones presupuestales para el a√±o y rubro seleccionados.</p>
                <small class="text-muted">Intente con diferentes filtros o verifique que existan datos cargados.</small>
            </div>
            
            <!-- Mensaje de carga de registros -->
            <div id="loading-records" class="loading-records d-none">
                <div class="spinner"></div>
                <h5>Cargando asignaciones...</h5>
                <p>Por favor espere mientras se consultan los datos.</p>
            </div>
        </div>
    </div>
    
    <!-- Mensajes de notificaci√≥n -->
    <div id="mensaje-container">
        <!-- Los mensajes se insertan aqu√≠ din√°micamente -->
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script espec√≠fico del formulario -->
    <script src="budget-authorization.js"></script>
</body>
</html>

/**
 * FORMULARIO DE AUTORIZACI√ìN DE PRESUPUESTO
 * SchoolNet - Patr√≥n optimizado sin timeouts
 */

// ===== CACHE GLOBAL Y ESTADO =====
let datosCompletos = {
    anios: [],
    rubros: [],
    asignaciones: [],
    asignacionesFiltradas: []
};

let estadoFormulario = {
    registroActual: 0,
    registroModificado: false,
    cargandoDatos: false
};

let elementos = {};

// ===== INICIALIZACI√ìN =====
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üîê Iniciando Autorizaci√≥n de Presupuesto...');
    
    try {
        // 1. Validar permisos primero
        const hasAccess = await validatePageAccess('Autorizaci√≥n de presupuesto');
        if (!hasAccess) {
            console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
            return;
        }
        
        console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
        
        // 2. Implementar breadcrumbs
        const breadcrumbContainer = document.getElementById('breadcrumbContainer');
        if (breadcrumbContainer) {
            breadcrumbContainer.innerHTML = generateBreadcrumbs('Presupuesto', 'Autorizaci√≥n de presupuesto');
        }
        
        // 3. Inicializar elementos y eventos
        inicializarElementos();
        configurarEventListeners();
        
        // 4. Cargar datos iniciales
        await cargarDatosIniciales();
        
        console.log('üéâ Formulario inicializado correctamente');
        
    } catch (error) {
        console.error('‚ùå Error en inicializaci√≥n:', error);
        mostrarMensaje('Error al inicializar el formulario: ' + error.message, 'error');
    }
});

function inicializarElementos() {
    elementos = {
        selectAnio: document.getElementById('select-anio'),
        selectRubro: document.getElementById('select-rubro'),
        btnBuscar: document.getElementById('btn-buscar'),
        recordNavigation: document.getElementById('record-navigation'),
        currentRecord: document.getElementById('current-record'),
        totalRecords: document.getElementById('total-records'),
        fieldSubitem: document.getElementById('field-subitem'),
        fieldDistribucion: document.getElementById('field-distribucion'),
        fieldResponsable: document.getElementById('field-responsable'),
        fieldValorSolicitado: document.getElementById('field-valor-solicitado'),
        fieldValorAprobado: document.getElementById('field-valor-aprobado'),
        btnAnterior: document.getElementById('btn-anterior'),
        btnSiguiente: document.getElementById('btn-siguiente'),
        btnGuardar: document.getElementById('btn-guardar'),
        noRecords: document.getElementById('no-records'),
        loadingRecords: document.getElementById('loading-records'),
        mensajeContainer: document.getElementById('mensaje-container'),
        changesIndicator: document.getElementById('changes-indicator')
    };
}

function configurarEventListeners() {
    // Filtros
    elementos.selectAnio.addEventListener('change', onAnioChange);
    elementos.selectRubro.addEventListener('change', onRubroChange);
    elementos.btnBuscar.addEventListener('click', buscarAsignaciones);
    
    // Navegaci√≥n
    elementos.btnAnterior.addEventListener('click', irAnterior);
    elementos.btnSiguiente.addEventListener('click', irSiguiente);
    
    // Guardado
    elementos.btnGuardar.addEventListener('click', guardarRegistro);
    
    // Campo editable
    elementos.fieldValorAprobado.addEventListener('input', onValorAprobadoChange);
    elementos.fieldValorAprobado.addEventListener('blur', formatearValorAprobado);
    elementos.fieldValorAprobado.addEventListener('keydown', onKeyDown);
    
    // Teclas r√°pidas globales
    document.addEventListener('keydown', manejarTeclasRapidas);
}

// ===== CARGA DE DATOS INICIALES =====
async function cargarDatosIniciales() {
    try {
        mostrarMensaje('Cargando datos iniciales...', 'info', 2000);
        
        // Cargar a√±os acad√©micos
        const anios = await supabaseRequest('/academic_years?select=year_id,year_name,year_order&order=year_order.desc');
        datosCompletos.anios = anios || [];
        
        // Cargar rubros (budget_categories)
        const rubros = await supabaseRequest('/budget_categories?select=category_id,category_name&category_status=eq.active&order=category_name');
        datosCompletos.rubros = rubros || [];
        
        // Cargar selects
        cargarSelectAnios();
        cargarSelectRubros();
        
        console.log(`‚úÖ Datos cargados: ${datosCompletos.anios.length} a√±os, ${datosCompletos.rubros.length} rubros`);
        mostrarMensaje(`‚úÖ Datos cargados: ${datosCompletos.anios.length} a√±os, ${datosCompletos.rubros.length} rubros`, 'success');
        
    } catch (error) {
        console.error('‚ùå Error cargando datos iniciales:', error);
        mostrarMensaje('Error cargando datos iniciales: ' + error.message, 'error');
    }
}

function cargarSelectAnios() {
    elementos.selectAnio.innerHTML = '<option value="">-- Seleccione un a√±o --</option>';
    
    datosCompletos.anios.forEach(anio => {
        const option = document.createElement('option');
        option.value = anio.year_id;
        option.textContent = anio.year_name;
        elementos.selectAnio.appendChild(option);
    });
}

function cargarSelectRubros() {
    elementos.selectRubro.innerHTML = '<option value="">-- Seleccione un rubro --</option>';
    
    datosCompletos.rubros.forEach(rubro => {
        const option = document.createElement('option');
        option.value = rubro.category_id;
        option.textContent = rubro.category_name;
        elementos.selectRubro.appendChild(option);
    });
    
    elementos.selectRubro.disabled = false;
}

// ===== MANEJO DE FILTROS =====
function onAnioChange() {
    const anioSeleccionado = elementos.selectAnio.value;
    actualizarEstadoBusqueda();
    
    if (!anioSeleccionado) {
        resetearFormulario();
    }
}

function onRubroChange() {
    const rubroSeleccionado = elementos.selectRubro.value;
    actualizarEstadoBusqueda();
    
    if (!rubroSeleccionado) {
        resetearFormulario();
    }
}

function actualizarEstadoBusqueda() {
    const anioValido = elementos.selectAnio.value !== '';
    const rubroValido = elementos.selectRubro.value !== '';
    
    elementos.btnBuscar.disabled = !(anioValido && rubroValido);
    
    if (elementos.btnBuscar.disabled) {
        resetearFormulario();
    }
}

// ===== B√öSQUEDA DE ASIGNACIONES =====
async function buscarAsignaciones() {
    const anioId = elementos.selectAnio.value;
    const categoryId = elementos.selectRubro.value;
    
    if (!anioId || !categoryId) {
        mostrarMensaje('Seleccione a√±o y rubro', 'warning');
        return;
    }
    
    try {
        estadoFormulario.cargandoDatos = true;
        mostrarLoadingRecords();
        
        // Consulta optimizada: Obtener asignaciones con sus relaciones
        const query = `
            /budget_assignments?
            select=
                assignment_id,
                category_detail,
                worker_email,
                requested_value,
                approved_value,
                budget_items!inner(
                    item_name,
                    budget_categories!inner(category_id)
                ),
                workers(
                    worker_first_name,
                    worker_last_name_1,
                    worker_last_name_2
                )
            &academic_year_id=eq.${anioId}
            &budget_items.budget_categories.category_id=eq.${categoryId}
            &order=budget_items.item_name,category_detail
        `;
        
        const asignaciones = await supabaseRequest(query.replace(/\s+/g, ''));
        
        if (!asignaciones || asignaciones.length === 0) {
            mostrarNoRecords();
            mostrarMensaje('No se encontraron asignaciones para los filtros seleccionados', 'info');
            return;
        }
        
        // Procesar datos para el formulario
        datosCompletos.asignacionesFiltradas = asignaciones.map(asignacion => ({
            assignment_id: asignacion.assignment_id,
            sub_item_name: asignacion.budget_items?.item_name || 'Sin nombre',
            categoria_detalle: asignacion.category_detail || 'General',
            worker_name: construirNombreCompleto(asignacion.workers),
            worker_email: asignacion.worker_email,
            requested_value: asignacion.requested_value || 0,
            approved_value: asignacion.approved_value || 0
        }));
        
        // Inicializar navegaci√≥n
        estadoFormulario.registroActual = 0;
        estadoFormulario.registroModificado = false;
        
        mostrarSeccionNavegacion();
        mostrarRegistroActual();
        
        const mensaje = `‚úÖ ${datosCompletos.asignacionesFiltradas.length} asignaciones encontradas`;
        mostrarMensaje(mensaje, 'success');
        
        console.log(mensaje);
        
    } catch (error) {
        console.error('‚ùå Error en b√∫squeda:', error);
        mostrarMensaje('Error al buscar asignaciones: ' + error.message, 'error');
        ocultarLoadingRecords();
    } finally {
        estadoFormulario.cargandoDatos = false;
    }
}

function construirNombreCompleto(worker) {
    if (!worker) return 'Sin asignar';
    
    const nombres = [
        worker.worker_first_name,
        worker.worker_last_name_1,
        worker.worker_last_name_2
    ].filter(nombre => nombre && nombre.trim() !== '');
    
    return nombres.join(' ') || 'Sin nombre';
}

// ===== NAVEGACI√ìN DE REGISTROS =====
async function irAnterior() {
    if (estadoFormulario.registroActual > 0) {
        if (estadoFormulario.registroModificado) {
            const guardado = await guardarRegistro();
            if (!guardado) return; // Si falla el guardado, no navegar
        }
        
        estadoFormulario.registroActual--;
        mostrarRegistroActual();
    }
}

async function irSiguiente() {
    if (estadoFormulario.registroActual < datosCompletos.asignacionesFiltradas.length - 1) {
        if (estadoFormulario.registroModificado) {
            const guardado = await guardarRegistro();
            if (!guardado) return; // Si falla el guardado, no navegar
        }
        
        estadoFormulario.registroActual++;
        mostrarRegistroActual();
    }
}

function mostrarRegistroActual() {
    if (datosCompletos.asignacionesFiltradas.length === 0) return;
    
    const registro = datosCompletos.asignacionesFiltradas[estadoFormulario.registroActual];
    
    // Llenar campos
    elementos.fieldSubitem.value = registro.sub_item_name;
    elementos.fieldDistribucion.value = registro.categoria_detalle;
    elementos.fieldResponsable.value = registro.worker_name;
    elementos.fieldValorSolicitado.value = formatearMoneda(registro.requested_value);
    elementos.fieldValorAprobado.value = registro.approved_value || '';
    
    // Actualizar contador
    elementos.currentRecord.textContent = estadoFormulario.registroActual + 1;
    elementos.totalRecords.textContent = datosCompletos.asignacionesFiltradas.length;
    
    // Actualizar botones
    actualizarEstadoBotones();
    
    // Reset estado
    estadoFormulario.registroModificado = false;
    actualizarIndicadorCambios();
    
    // Enfocar campo editable
    setTimeout(() => {
        elementos.fieldValorAprobado.focus();
        elementos.fieldValorAprobado.select();
    }, 100);
}

// ===== GUARDADO DE REGISTRO =====
async function guardarRegistro() {
    if (!estadoFormulario.registroModificado) {
        mostrarMensaje('No hay cambios para guardar', 'info');
        return true;
    }
    
    const registro = datosCompletos.asignacionesFiltradas[estadoFormulario.registroActual];
    const nuevoValor = limpiarFormatoMoneda(elementos.fieldValorAprobado.value);
    
    if (!validarValorAprobado(nuevoValor)) {
        return false;
    }
    
    try {
        // Deshabilitar bot√≥n de guardado
        elementos.btnGuardar.disabled = true;
        elementos.btnGuardar.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Guardando...';
        
        // Actualizar en base de datos
        const updateData = { approved_value: nuevoValor };
        await supabaseRequest(`/budget_assignments?assignment_id=eq.${registro.assignment_id}`, {
            method: 'PATCH',
            body: JSON.stringify(updateData)
        });
        
        // Actualizar datos locales
        registro.approved_value = nuevoValor;
        estadoFormulario.registroModificado = false;
        actualizarIndicadorCambios();
        
        mostrarMensaje('‚úÖ Valor guardado correctamente', 'success');
        
        // Auto-navegaci√≥n al siguiente registro
        setTimeout(async () => {
            if (estadoFormulario.registroActual < datosCompletos.asignacionesFiltradas.length - 1) {
                estadoFormulario.registroActual++;
                mostrarRegistroActual();
            } else {
                mostrarMensaje('¬°√öltimo registro completado!', 'info');
            }
        }, 1000);
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Error guardando:', error);
        mostrarMensaje('‚ùå Error al guardar: ' + error.message, 'error');
        return false;
    } finally {
        // Restaurar bot√≥n
        elementos.btnGuardar.innerHTML = '<i class="bi bi-save me-2"></i>Guardar Cambios';
        actualizarEstadoBotones();
    }
}

// ===== MANEJO DE CAMPO EDITABLE =====
function onValorAprobadoChange() {
    estadoFormulario.registroModificado = true;
    actualizarIndicadorCambios();
    actualizarEstadoBotones();
    
    // Solo permitir n√∫meros
    const valor = elementos.fieldValorAprobado.value;
    const valorLimpio = valor.replace(/[^\d]/g, '');
    
    if (valor !== valorLimpio) {
        elementos.fieldValorAprobado.value = valorLimpio;
    }
}

function formatearValorAprobado() {
    const valor = limpiarFormatoMoneda(elementos.fieldValorAprobado.value);
    if (valor > 0) {
        elementos.fieldValorAprobado.value = valor.toLocaleString('es-CO');
    }
}

function onKeyDown(e) {
    // Permitir teclas de navegaci√≥n y control
    const teclasPermitidas = [
        'Backspace', 'Delete', 'Tab', 'Escape', 'Enter',
        'Home', 'End', 'ArrowLeft', 'ArrowRight'
    ];
    
    if (teclasPermitidas.includes(e.key)) return;
    
    // Solo permitir n√∫meros
    if (!/^\d$/.test(e.key)) {
        e.preventDefault();
    }
}

// ===== TECLAS R√ÅPIDAS =====
function manejarTeclasRapidas(e) {
    if (datosCompletos.asignacionesFiltradas.length === 0) return;
    
    // Ctrl + Flecha Izquierda: Registro anterior
    if (e.ctrlKey && e.key === 'ArrowLeft') {
        e.preventDefault();
        irAnterior();
    }
    
    // Ctrl + Flecha Derecha: Registro siguiente
    if (e.ctrlKey && e.key === 'ArrowRight') {
        e.preventDefault();
        irSiguiente();
    }
    
    // Ctrl + S: Guardar
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        guardarRegistro();
    }
    
    // Escape: Cancelar cambios
    if (e.key === 'Escape' && estadoFormulario.registroModificado) {
        e.preventDefault();
        cancelarCambios();
    }
}

// ===== FUNCIONES DE UTILIDAD =====
function mostrarSeccionNavegacion() {
    elementos.recordNavigation.classList.remove('d-none');
    elementos.noRecords.classList.add('d-none');
    elementos.loadingRecords.classList.add('d-none');
}

function mostrarNoRecords() {
    elementos.noRecords.classList.remove('d-none');
    elementos.recordNavigation.classList.add('d-none');
    elementos.loadingRecords.classList.add('d-none');
}

function mostrarLoadingRecords() {
    elementos.loadingRecords.classList.remove('d-none');
    elementos.recordNavigation.classList.add('d-none');
    elementos.noRecords.classList.add('d-none');
}

function ocultarLoadingRecords() {
    elementos.loadingRecords.classList.add('d-none');
}

function resetearFormulario() {
    datosCompletos.asignacionesFiltradas = [];
    estadoFormulario.registroActual = 0;
    estadoFormulario.registroModificado = false;
    
    elementos.recordNavigation.classList.add('d-none');
    elementos.noRecords.classList.add('d-none');
    elementos.loadingRecords.classList.add('d-none');
}

function actualizarEstadoBotones() {
    const totalRegistros = datosCompletos.asignacionesFiltradas.length;
    
    elementos.btnAnterior.disabled = estadoFormulario.registroActual === 0 || estadoFormulario.cargandoDatos;
    elementos.btnSiguiente.disabled = estadoFormulario.registroActual === totalRegistros - 1 || estadoFormulario.cargandoDatos;
    elementos.btnGuardar.disabled = !estadoFormulario.registroModificado || estadoFormulario.cargandoDatos;
}

function actualizarIndicadorCambios() {
    if (estadoFormulario.registroModificado) {
        elementos.changesIndicator.classList.remove('d-none');
    } else {
        elementos.changesIndicator.classList.add('d-none');
    }
}

function cancelarCambios() {
    if (confirm('¬øDesea cancelar los cambios realizados?')) {
        mostrarRegistroActual();
        mostrarMensaje('Cambios cancelados', 'info');
    }
}

function validarValorAprobado(valor) {
    if (isNaN(valor) || !Number.isInteger(Number(valor)) || valor < 0) {
        mostrarMensaje('El valor debe ser un n√∫mero entero positivo', 'error');
        elementos.fieldValorAprobado.focus();
        return false;
    }
    return true;
}

function formatearMoneda(valor) {
    if (!valor || valor === 0) return '$0';
    return '$' + parseInt(valor).toLocaleString('es-CO');
}

function limpiarFormatoMoneda(valor) {
    if (!valor) return 0;
    return parseInt(valor.toString().replace(/[^\d]/g, '')) || 0;
}

function mostrarMensaje(mensaje, tipo = 'info', duracion = 5000) {
    const mensajeDiv = document.createElement('div');
    mensajeDiv.className = `mensaje mensaje-${tipo}`;
    mensajeDiv.innerHTML = `
        <i class="bi bi-${getIconoTipo(tipo)} me-2"></i>
        ${mensaje}
    `;
    
    elementos.mensajeContainer.appendChild(mensajeDiv);
    
    setTimeout(() => {
        if (mensajeDiv.parentNode) {
            mensajeDiv.remove();
        }
    }, duracion);
}

function getIconoTipo(tipo) {
    const iconos = {
        success: 'check-circle-fill',
        error: 'exclamation-triangle-fill',
        warning: 'exclamation-triangle-fill',
        info: 'info-circle-fill'
    };
    return iconos[tipo] || 'info-circle-fill';
}

// Log de inicializaci√≥n
console.log('üéâ Autorizaci√≥n de Presupuesto - SchoolNet v1.0');
console.log('üìä Patr√≥n optimizado: Carga √∫nica + Navegaci√≥n fluida');

      <?php
/**
 * BACKEND PARA AUTORIZACI√ìN DE PRESUPUESTO
 * SchoolNet - Endpoints optimizados para Supabase
 * 
 * Este archivo maneja las consultas espec√≠ficas para el formulario
 * de autorizaci√≥n de presupuesto, optimizando las queries complejas
 */

header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, PATCH, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, Authorization, apikey, Prefer');

// Configuraci√≥n de Supabase desde config.js
$SUPABASE_URL = 'https://spjzvpcsgbewxupjvmfm.supabase.co';
$SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwanp2cGNzZ2Jld3h1cGp2bWZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMDk4MDEsImV4cCI6MjA3MjU4NTgwMX0.6n_rvGalz_IT2vQ1Q4fPGS0D-ijYBUmdkL3PmbyNRck';

/**
 * Funci√≥n principal para hacer requests a Supabase
 */
function supabaseRequest($endpoint, $method = 'GET', $data = null) {
    global $SUPABASE_URL, $SUPABASE_ANON_KEY;
    
    $url = $SUPABASE_URL . '/rest/v1' . $endpoint;
    
    $headers = [
        'apikey: ' . $SUPABASE_ANON_KEY,
        'Authorization: Bearer ' . $SUPABASE_ANON_KEY,
        'Content-Type: application/json',
        'Prefer: return=representation'
    ];
    
    $curl = curl_init();
    curl_setopt_array($curl, [
        CURLOPT_URL => $url,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_HTTPHEADER => $headers,
        CURLOPT_CUSTOMREQUEST => $method
    ]);
    
    if ($data && in_array($method, ['POST', 'PATCH', 'PUT'])) {
        curl_setopt($curl, CURLOPT_POSTFIELDS, json_encode($data));
    }
    
    $response = curl_exec($curl);
    $httpCode = curl_getinfo($curl, CURLINFO_HTTP_CODE);
    curl_close($curl);
    
    if ($httpCode >= 400) {
        throw new Exception("HTTP Error $httpCode: " . $response);
    }
    
    return json_decode($response, true);
}

/**
 * Manejo de rutas
 */
$request_uri = $_SERVER['REQUEST_URI'];
$path = parse_url($request_uri, PHP_URL_PATH);
$method = $_SERVER['REQUEST_METHOD'];

// Remover el path base si existe
$path = str_replace('/modules/budget/api/', '', $path);

switch ($path) {
    case 'initial-data':
        handleInitialData();
        break;
        
    case 'search-assignments':
        handleSearchAssignments();
        break;
        
    case 'update-approval':
        handleUpdateApproval();
        break;
        
    default:
        http_response_code(404);
        echo json_encode(['error' => 'Endpoint not found']);
        break;
}

/**
 * Obtener datos iniciales (a√±os y rubros)
 */
function handleInitialData() {
    try {
        // A√±os acad√©micos ordenados por a√±o
        $years = supabaseRequest('/academic_years?select=year_id,year_name,year_order&order=year_order.desc');
        
        // Categor√≠as de presupuesto activas
        $categories = supabaseRequest('/budget_categories?select=category_id,category_name&category_status=eq.active&order=category_name');
        
        echo json_encode([
            'success' => true,
            'data' => [
                'years' => $years ?: [],
                'categories' => $categories ?: []
            ]
        ]);
        
    } catch (Exception $e) {
        http_response_code(500);
        echo json_encode([
            'success' => false,
            'error' => $e->getMessage()
        ]);
    }
}

/**
 * Buscar asignaciones por a√±o y categor√≠a
 */
function handleSearchAssignments() {
    try {
        $year_id = $_GET['year_id'] ?? null;
        $category_id = $_GET['category_id'] ?? null;
        
        if (!$year_id || !$category_id) {
            throw new Exception('year_id and category_id are required');
        }
        
        // Query optimizada: obtener asignaciones con sus relaciones
        $query = "/budget_assignments?select=" .
                "assignment_id," .
                "category_detail," .
                "worker_email," .
                "requested_value," .
                "approved_value," .
                "budget_items!inner(" .
                    "item_name," .
                    "budget_categories!inner(category_id)" .
                ")," .
                "workers(" .
                    "worker_first_name," .
                    "worker_last_name_1," .
                    "worker_last_name_2" .
                ")" .
                "&academic_year_id=eq.$year_id" .
                "&budget_items.budget_categories.category_id=eq.$category_id" .
                "&order=budget_items.item_name,category_detail";
        
        $assignments = supabaseRequest($query);
        
        // Procesar los datos para el frontend
        $processed_assignments = [];
        foreach ($assignments as $assignment) {
            $worker_name = 'Sin asignar';
            if ($assignment['workers']) {
                $names = array_filter([
                    $assignment['workers']['worker_first_name'],
                    $assignment['workers']['worker_last_name_1'],
                    $assignment['workers']['worker_last_name_2']
                ]);
                $worker_name = implode(' ', $names) ?: 'Sin nombre';
            }
            
            $processed_assignments[] = [
                'assignment_id' => $assignment['assignment_id'],
                'sub_item_name' => $assignment['budget_items']['item_name'] ?? 'Sin nombre',
                'categoria_detalle' => $assignment['category_detail'] ?? 'General',
                'worker_name' => $worker_name,
                'worker_email' => $assignment['worker_email'],
                'requested_value' => $assignment['requested_value'] ?? 0,
                'approved_value' => $assignment['approved_value'] ?? 0
            ];
        }
        
        echo json_encode([
            'success' => true,
            'data' => $processed_assignments,
            'count' => count($processed_assignments)
        ]);
        
    } catch (Exception $e) {
        http_response_code(500);
        echo json_encode([
            'success' => false,
            'error' => $e->getMessage()
        ]);
    }
}

/**
 * Actualizar valor aprobado de una asignaci√≥n
 */
function handleUpdateApproval() {
    try {
        if ($_SERVER['REQUEST_METHOD'] !== 'PATCH') {
            throw new Exception('Method not allowed');
        }
        
        $input = json_decode(file_get_contents('php://input'), true);
        $assignment_id = $input['assignment_id'] ?? null;
        $approved_value = $input['approved_value'] ?? null;
        
        if (!$assignment_id || $approved_value === null) {
            throw new Exception('assignment_id and approved_value are required');
        }
        
        // Validar que el valor sea un entero positivo
        if (!is_numeric($approved_value) || $approved_value < 0 || floor($approved_value) != $approved_value) {
            throw new Exception('approved_value must be a positive integer');
        }
        
        // Actualizar en la base de datos
        $result = supabaseRequest(
            "/budget_assignments?assignment_id=eq.$assignment_id",
            'PATCH',
            ['approved_value' => (int)$approved_value]
        );
        
        echo json_encode([
            'success' => true,
            'message' => 'Valor aprobado actualizado correctamente',
            'data' => $result
        ]);
        
    } catch (Exception $e) {
        http_response_code(500);
        echo json_encode([
            'success' => false,
            'error' => $e->getMessage()
        ]);
    }
}

/**
 * Funci√≥n de log para debugging
 */
function logError($message) {
    error_log("[Budget Authorization API] " . date('Y-m-d H:i:s') . " - " . $message);
}

/**
 * Validar usuario autenticado (opcional - para futuras mejoras)
 */
function validateUser() {
    // Por ahora solo retornamos true
    // En el futuro se puede implementar validaci√≥n de JWT o sesi√≥n
    return true;
}

/**
 * Obtener estad√≠sticas r√°pidas (endpoint adicional)
 */
function handleStats() {
    try {
        $year_id = $_GET['year_id'] ?? null;
        
        if (!$year_id) {
            throw new Exception('year_id is required');
        }
        
        // Obtener estad√≠sticas b√°sicas
        $total_assignments = supabaseRequest("/budget_assignments?select=assignment_id&academic_year_id=eq.$year_id");
        $approved_assignments = supabaseRequest("/budget_assignments?select=assignment_id&academic_year_id=eq.$year_id&approved_value=gt.0");
        
        // Sumar valores totales
        $total_requested = supabaseRequest("/budget_assignments?select=requested_value&academic_year_id=eq.$year_id");
        $total_approved = supabaseRequest("/budget_assignments?select=approved_value&academic_year_id=eq.$year_id");
        
        $requested_sum = array_sum(array_column($total_requested, 'requested_value'));
        $approved_sum = array_sum(array_column($total_approved, 'approved_value'));
        
        echo json_encode([
            'success' => true,
            'data' => [
                'total_assignments' => count($total_assignments),
                'approved_assignments' => count($approved_assignments),
                'pending_assignments' => count($total_assignments) - count($approved_assignments),
                'total_requested' => $requested_sum,
                'total_approved' => $approved_sum,
                'approval_percentage' => count($total_assignments) > 0 ? 
                    round((count($approved_assignments) / count($total_assignments)) * 100, 2) : 0
            ]
        ]);
        
    } catch (Exception $e) {
        http_response_code(500);
        echo json_encode([
            'success' => false,
            'error' => $e->getMessage()
        ]);
    }
}

// Manejo de OPTIONS para CORS
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}
?>

      /**
 * FORMULARIO DE AUTORIZACI√ìN DE PRESUPUESTO - VERSI√ìN FINAL
 * SchoolNet - Integrado con backend PHP optimizado
 */

// ===== CONFIGURACI√ìN DE API =====
const API_BASE_URL = '/modules/budget/api/';

// ===== CACHE GLOBAL Y ESTADO =====
let datosCompletos = {
    anios: [],
    rubros: [],
    asignaciones: [],
    asignacionesFiltradas: []
};

let estadoFormulario = {
    registroActual: 0,
    registroModificado: false,
    cargandoDatos: false
};

let elementos = {};

// ===== INICIALIZACI√ìN =====
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üîê Iniciando Autorizaci√≥n de Presupuesto...');
    
    try {
        // 1. Validar permisos primero
        const hasAccess = await validatePageAccess('Autorizaci√≥n de presupuesto');
        if (!hasAccess) {
            console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
            return;
        }
        
        console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
        
        // 2. Implementar breadcrumbs
        const breadcrumbContainer = document.getElementById('breadcrumbContainer');
        if (breadcrumbContainer) {
            breadcrumbContainer.innerHTML = generateBreadcrumbs('Presupuesto', 'Autorizaci√≥n de presupuesto');
        }
        
        // 3. Inicializar elementos y eventos
        inicializarElementos();
        configurarEventListeners();
        
        // 4. Cargar datos iniciales
        await cargarDatosIniciales();
        
        console.log('üéâ Formulario inicializado correctamente');
        
    } catch (error) {
        console.error('‚ùå Error en inicializaci√≥n:', error);
        mostrarMensaje('Error al inicializar el formulario: ' + error.message, 'error');
    }
});

function inicializarElementos() {
    elementos = {
        selectAnio: document.getElementById('select-anio'),
        selectRubro: document.getElementById('select-rubro'),
        btnBuscar: document.getElementById('btn-buscar'),
        recordNavigation: document.getElementById('record-navigation'),
        currentRecord: document.getElementById('current-record'),
        totalRecords: document.getElementById('total-records'),
        fieldSubitem: document.getElementById('field-subitem'),
        fieldDistribucion: document.getElementById('field-distribucion'),
        fieldResponsable: document.getElementById('field-responsable'),
        fieldValorSolicitado: document.getElementById('field-valor-solicitado'),
        fieldValorAprobado: document.getElementById('field-valor-aprobado'),
        btnAnterior: document.getElementById('btn-anterior'),
        btnSiguiente: document.getElementById('btn-siguiente'),
        btnGuardar: document.getElementById('btn-guardar'),
        noRecords: document.getElementById('no-records'),
        loadingRecords: document.getElementById('loading-records'),
        mensajeContainer: document.getElementById('mensaje-container'),
        changesIndicator: document.getElementById('changes-indicator')
    };
}

function configurarEventListeners() {
    // Filtros
    elementos.selectAnio.addEventListener('change', onAnioChange);
    elementos.selectRubro.addEventListener('change', onRubroChange);
    elementos.btnBuscar.addEventListener('click', buscarAsignaciones);
    
    // Navegaci√≥n
    elementos.btnAnterior.addEventListener('click', irAnterior);
    elementos.btnSiguiente.addEventListener('click', irSiguiente);
    
    // Guardado
    elementos.btnGuardar.addEventListener('click', guardarRegistro);
    
    // Campo editable
    elementos.fieldValorAprobado.addEventListener('input', onValorAprobadoChange);
    elementos.fieldValorAprobado.addEventListener('blur', formatearValorAprobado);
    elementos.fieldValorAprobado.addEventListener('keydown', onKeyDown);
    
    // Teclas r√°pidas globales
    document.addEventListener('keydown', manejarTeclasRapidas);
}

// ===== FUNCIONES DE API =====
async function apiRequest(endpoint, options = {}) {
    const url = API_BASE_URL + endpoint;
    
    const defaultOptions = {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    };
    
    const config = { ...defaultOptions, ...options };
    
    try {
        const response = await fetch(url, config);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || `HTTP ${response.status}`);
        }
        
        return data;
        
    } catch (error) {
        console.error(`API Error (${endpoint}):`, error);
        throw error;
    }
}

// ===== CARGA DE DATOS INICIALES =====
async function cargarDatosIniciales() {
    try {
        mostrarMensaje('Cargando datos iniciales...', 'info', 2000);
        
        const response = await apiRequest('initial-data');
        
        if (response.success) {
            datosCompletos.anios = response.data.years || [];
            datosCompletos.rubros = response.data.categories || [];
            
            // Cargar selects
            cargarSelectAnios();
            cargarSelectRubros();
            
            console.log(`‚úÖ Datos cargados: ${datosCompletos.anios.length} a√±os, ${datosCompletos.rubros.length} rubros`);
            mostrarMensaje(`‚úÖ Datos cargados: ${datosCompletos.anios.length} a√±os, ${datosCompletos.rubros.length} rubros`, 'success');
        } else {
            throw new Error(response.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('‚ùå Error cargando datos iniciales:', error);
        mostrarMensaje('Error cargando datos iniciales: ' + error.message, 'error');
        
        // Fallback: cargar datos directamente de Supabase
        await cargarDatosDirectos();
    }
}

// Fallback para cargar datos directamente
async function cargarDatosDirectos() {
    try {
        console.log('üîÑ Intentando cargar datos directamente...');
        
        const anios = await supabaseRequest('/academic_years?select=year_id,year_name,year_order&order=year_order.desc');
        const rubros = await supabaseRequest('/budget_categories?select=category_id,category_name&category_status=eq.active&order=category_name');
        
        datosCompletos.anios = anios || [];
        datosCompletos.rubros = rubros || [];
        
        cargarSelectAnios();
        cargarSelectRubros();
        
        mostrarMensaje('‚úÖ Datos cargados (modo directo)', 'warning');
        
    } catch (error) {
        console.error('‚ùå Error en carga directa:', error);
        mostrarMensaje('Error cr√≠tico al cargar datos: ' + error.message, 'error');
    }
}

function cargarSelectAnios() {
    elementos.selectAnio.innerHTML = '<option value="">-- Seleccione un a√±o --</option>';
    
    datosCompletos.anios.forEach(anio => {
        const option = document.createElement('option');
        option.value = anio.year_id;
        option.textContent = anio.year_name;
        elementos.selectAnio.appendChild(option);
    });
}

function cargarSelectRubros() {
    elementos.selectRubro.innerHTML = '<option value="">-- Seleccione un rubro --</option>';
    
    datosCompletos.rubros.forEach(rubro => {
        const option = document.createElement('option');
        option.value = rubro.category_id;
        option.textContent = rubro.category_name;
        elementos.selectRubro.appendChild(option);
    });
    
    elementos.selectRubro.disabled = false;
}

// ===== MANEJO DE FILTROS =====
function onAnioChange() {
    const anioSeleccionado = elementos.selectAnio.value;
    actualizarEstadoBusqueda();
    
    if (!anioSeleccionado) {
        resetearFormulario();
    }
}

function onRubroChange() {
    const rubroSeleccionado = elementos.selectRubro.value;
    actualizarEstadoBusqueda();
    
    if (!rubroSeleccionado) {
        resetearFormulario();
    }
}

function actualizarEstadoBusqueda() {
    const anioValido = elementos.selectAnio.value !== '';
    const rubroValido = elementos.selectRubro.value !== '';
    
    elementos.btnBuscar.disabled = !(anioValido && rubroValido);
    
    if (elementos.btnBuscar.disabled) {
        resetearFormulario();
    }
}

// ===== B√öSQUEDA DE ASIGNACIONES =====
async function buscarAsignaciones() {
    const anioId = elementos.selectAnio.value;
    const categoryId = elementos.selectRubro.value;
    
    if (!anioId || !categoryId) {
        mostrarMensaje('Seleccione a√±o y rubro', 'warning');
        return;
    }
    
    try {
        estadoFormulario.cargandoDatos = true;
        mostrarLoadingRecords();
        
        // Usar API backend
        const response = await apiRequest(`search-assignments?year_id=${anioId}&category_id=${categoryId}`);
        
        if (response.success) {
            datosCompletos.asignacionesFiltradas = response.data || [];
            
            if (datosCompletos.asignacionesFiltradas.length === 0) {
                mostrarNoRecords();
                mostrarMensaje('No se encontraron asignaciones para los filtros seleccionados', 'info');
                return;
            }
            
            // Inicializar navegaci√≥n
            estadoFormulario.registroActual = 0;
            estadoFormulario.registroModificado = false;
            
            mostrarSeccionNavegacion();
            mostrarRegistroActual();
            
            const mensaje = `‚úÖ ${datosCompletos.asignacionesFiltradas.length} asignaciones encontradas`;
            mostrarMensaje(mensaje, 'success');
            
            console.log(mensaje);
        } else {
            throw new Error(response.error || 'Error en b√∫squeda');
        }
        
    } catch (error) {
        console.error('‚ùå Error en b√∫squeda:', error);
        mostrarMensaje('Error al buscar asignaciones: ' + error.message, 'error');
        ocultarLoadingRecords();
        
        // Fallback: b√∫squeda directa
        await buscarAsignacionesDirecto(anioId, categoryId);
    } finally {
        estadoFormulario.cargandoDatos = false;
    }
}

// Fallback para b√∫squeda directa
async function buscarAsignacionesDirecto(anioId, categoryId) {
    try {
        console.log('üîÑ Intentando b√∫squeda directa...');
        
        const query = `
            /budget_assignments?
            select=
                assignment_id,
                category_detail,
                worker_email,
                requested_value,
                approved_value,
                budget_items!inner(
                    item_name,
                    budget_categories!inner(category_id)
                ),
                workers(
                    worker_first_name,
                    worker_last_name_1,
                    worker_last_name_2
                )
            &academic_year_id=eq.${anioId}
            &budget_items.budget_categories.category_id=eq.${categoryId}
            &order=budget_items.item_name,category_detail
        `;
        
        const asignaciones = await supabaseRequest(query.replace(/\s+/g, ''));
        
        if (!asignaciones || asignaciones.length === 0) {
            mostrarNoRecords();
            mostrarMensaje('No se encontraron asignaciones (b√∫squeda directa)', 'info');
            return;
        }
        
        // Procesar datos
        datosCompletos.asignacionesFiltradas = asignaciones.map(asignacion => ({
            assignment_id: asignacion.assignment_id,
            sub_item_name: asignacion.budget_items?.item_name || 'Sin nombre',
            categoria_detalle: asignacion.category_detail || 'General',
            worker_name: construirNombreCompleto(asignacion.workers),
            worker_email: asignacion.worker_email,
            requested_value: asignacion.requested_value || 0,
            approved_value: asignacion.approved_value || 0
        }));
        
        estadoFormulario.registroActual = 0;
        estadoFormulario.registroModificado = false;
        
        mostrarSeccionNavegacion();
        mostrarRegistroActual();
        
        mostrarMensaje(`‚úÖ ${datosCompletos.asignacionesFiltradas.length} asignaciones (modo directo)`, 'warning');
        
    } catch (error) {
        console.error('‚ùå Error en b√∫squeda directa:', error);
        mostrarMensaje('Error cr√≠tico en b√∫squeda: ' + error.message, 'error');
        ocultarLoadingRecords();
    }
}

function construirNombreCompleto(worker) {
    if (!worker) return 'Sin asignar';
    
    const nombres = [
        worker.worker_first_name,
        worker.worker_last_name_1,
        worker.worker_last_name_2
    ].filter(nombre => nombre && nombre.trim() !== '');
    
    return nombres.join(' ') || 'Sin nombre';
}

// ===== NAVEGACI√ìN DE REGISTROS =====
async function irAnterior() {
    if (estadoFormulario.registroActual > 0) {
        if (estadoFormulario.registroModificado) {
            const guardado = await guardarRegistro();
            if (!guardado) return;
        }
        
        estadoFormulario.registroActual--;
        mostrarRegistroActual();
    }
}

async function irSiguiente() {
    if (estadoFormulario.registroActual < datosCompletos.asignacionesFiltradas.length - 1) {
        if (estadoFormulario.registroModificado) {
            const guardado = await guardarRegistro();
            if (!guardado) return;
        }
        
        estadoFormulario.registroActual++;
        mostrarRegistroActual();
    }
}

function mostrarRegistroActual() {
    if (datosCompletos.asignacionesFiltradas.length === 0) return;
    
    const registro = datosCompletos.asignacionesFiltradas[estadoFormulario.registroActual];
    
    // Llenar campos
    elementos.fieldSubitem.value = registro.sub_item_name;
    elementos.fieldDistribucion.value = registro.categoria_detalle;
    elementos.fieldResponsable.value = registro.worker_name;
    elementos.fieldValorSolicitado.value = formatearMoneda(registro.requested_value);
    elementos.fieldValorAprobado.value = registro.approved_value || '';
    
    // Actualizar contador
    elementos.currentRecord.textContent = estadoFormulario.registroActual + 1;
    elementos.totalRecords.textContent = datosCompletos.asignacionesFiltradas.length;
    
    // Actualizar botones
    actualizarEstadoBotones();
    
    // Reset estado
    estadoFormulario.registroModificado = false;
    actualizarIndicadorCambios();
    
    // Enfocar campo editable
    setTimeout(() => {
        elementos.fieldValorAprobado.focus();
        elementos.fieldValorAprobado.select();
    }, 100);
}

// ===== GUARDADO DE REGISTRO =====
async function guardarRegistro() {
    if (!estadoFormulario.registroModificado) {
        mostrarMensaje('No hay cambios para guardar', 'info');
        return true;
    }
    
    const registro = datosCompletos.asignacionesFiltradas[estadoFormulario.registroActual];
    const nuevoValor = limpiarFormatoMoneda(elementos.fieldValorAprobado.value);
    
    if (!validarValorAprobado(nuevoValor)) {
        return false;
    }
    
    try {
        // Deshabilitar bot√≥n de guardado
        elementos.btnGuardar.disabled = true;
        elementos.btnGuardar.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Guardando...';
        
        // Usar API backend
        const response = await apiRequest('update-approval', {
            method: 'PATCH',
            body: JSON.stringify({
                assignment_id: registro.assignment_id,
                approved_value: nuevoValor
            })
        });
        
        if (response.success) {
            // Actualizar datos locales
            registro.approved_value = nuevoValor;
            estadoFormulario.registroModificado = false;
            actualizarIndicadorCambios();
            
            mostrarMensaje('‚úÖ Valor guardado correctamente', 'success');
            
            // Auto-navegaci√≥n al siguiente registro
            setTimeout(async () => {
                if (estadoFormulario.registroActual < datosCompletos.asignacionesFiltradas.length - 1) {
                    estadoFormulario.registroActual++;
                    mostrarRegistroActual();
                } else {
                    mostrarMensaje('¬°√öltimo registro completado!', 'info');
                }
            }, 1000);
            
            return true;
        } else {
            throw new Error(response.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('‚ùå Error guardando:', error);
        mostrarMensaje('‚ùå Error al guardar: ' + error.message, 'error');
        
        // Fallback: guardado directo
        return await guardarDirecto(registro.assignment_id, nuevoValor);
    } finally {
        // Restaurar bot√≥n
        elementos.btnGuardar.innerHTML = '<i class="bi bi-save me-2"></i>Guardar Cambios';
        actualizarEstadoBotones();
    }
}

// Fallback para guardado directo
async function guardarDirecto(assignmentId, nuevoValor) {
    try {
        console.log('üîÑ Intentando guardado directo...');
        
        const updateData = { approved_value: nuevoValor };
        await supabaseRequest(`/budget_assignments?assignment_id=eq.${assignmentId}`, {
            method: 'PATCH',
            body: JSON.stringify(updateData)
        });
        
        // Actualizar datos locales
        const registro = datosCompletos.asignacionesFiltradas[estadoFormulario.registroActual];
        registro.approved_value = nuevoValor;
        estadoFormulario.registroModificado = false;
        actualizarIndicadorCambios();
        
        mostrarMensaje('‚úÖ Valor guardado (modo directo)', 'warning');
        return true;
        
    } catch (error) {
        console.error('‚ùå Error en guardado directo:', error);
        mostrarMensaje('‚ùå Error cr√≠tico al guardar: ' + error.message, 'error');
        return false;
    }
}

// ===== RESTO DE FUNCIONES (SIN CAMBIOS) =====
function onValorAprobadoChange() {
    estadoFormulario.registroModificado = true;
    actualizarIndicadorCambios();
    actualizarEstadoBotones();
    
    const valor = elementos.fieldValorAprobado.value;
    const valorLimpio = valor.replace(/[^\d]/g, '');
    
    if (valor !== valorLimpio) {
        elementos.fieldValorAprobado.value = valorLimpio;
    }
}

function formatearValorAprobado() {
    const valor = limpiarFormatoMoneda(elementos.fieldValorAprobado.value);
    if (valor > 0) {
        elementos.fieldValorAprobado.value = valor.toLocaleString('es-CO');
    }
}

function onKeyDown(e) {
    const teclasPermitidas = [
        'Backspace', 'Delete', 'Tab', 'Escape', 'Enter',
        'Home', 'End', 'ArrowLeft', 'ArrowRight'
    ];
    
    if (teclasPermitidas.includes(e.key)) return;
    
    if (!/^\d$/.test(e.key)) {
        e.preventDefault();
    }
}

function manejarTeclasRapidas(e) {
    if (datosCompletos.asignacionesFiltradas.length === 0) return;
    
    if (e.ctrlKey && e.key === 'ArrowLeft') {
        e.preventDefault();
        irAnterior();
    }
    
    if (e.ctrlKey && e.key === 'ArrowRight') {
        e.preventDefault();
        irSiguiente();
    }
    
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        guardarRegistro();
    }
    
    if (e.key === 'Escape' && estadoFormulario.registroModificado) {
        e.preventDefault();
        cancelarCambios();
    }
}

function mostrarSeccionNavegacion() {
    elementos.recordNavigation.classList.remove('d-none');
    elementos.noRecords.classList.add('d-none');
    elementos.loadingRecords.classList.add('d-none');
}

function mostrarNoRecords() {
    elementos.noRecords.classList.remove('d-none');
    elementos.recordNavigation.classList.add('d-none');
    elementos.loadingRecords.classList.add('d-none');
}

function mostrarLoadingRecords() {
    elementos.loadingRecords.classList.remove('d-none');
    elementos.recordNavigation.classList.add('d-none');
    elementos.noRecords.classList.add('d-none');
}

function ocultarLoadingRecords() {
    elementos.loadingRecords.classList.add('d-none');
}

function resetearFormulario() {
    datosCompletos.asignacionesFiltradas = [];
    estadoFormulario.registroActual = 0;
    estadoFormulario.registroModificado = false;
    
    elementos.recordNavigation.classList.add('d-none');
    elementos.noRecords.classList.add('d-none');
    elementos.loadingRecords.classList.add('d-none');
}

function actualizarEstadoBotones() {
    const totalRegistros = datosCompletos.asignacionesFiltradas.length;
    
    elementos.btnAnterior.disabled = estadoFormulario.registroActual === 0 || estadoFormulario.cargandoDatos;
    elementos.btnSiguiente.disabled = estadoFormulario.registroActual === totalRegistros - 1 || estadoFormulario.cargandoDatos;
    elementos.btnGuardar.disabled = !estadoFormulario.registroModificado || estadoFormulario.cargandoDatos;
}

function actualizarIndicadorCambios() {
    if (estadoFormulario.registroModificado) {
        elementos.changesIndicator.classList.remove('d-none');
    } else {
        elementos.changesIndicator.classList.add('d-none');
    }
}

function cancelarCambios() {
    if (confirm('¬øDesea cancelar los cambios realizados?')) {
        mostrarRegistroActual();
        mostrarMensaje('Cambios cancelados', 'info');
    }
}

function validarValorAprobado(valor) {
    if (isNaN(valor) || !Number.isInteger(Number(valor)) || valor < 0) {
        mostrarMensaje('El valor debe ser un n√∫mero entero positivo', 'error');
        elementos.fieldValorAprobado.focus();
        return false;
    }
    return true;
}

function formatearMoneda(valor) {
    if (!valor || valor === 0) return '$0';
    return '$' + parseInt(valor).toLocaleString('es-CO');
}

function limpiarFormatoMoneda(valor) {
    if (!valor) return 0;
    return parseInt(valor.toString().replace(/[^\d]/g, '')) || 0;
}

function mostrarMensaje(mensaje, tipo = 'info', duracion = 5000) {
    const mensajeDiv = document.createElement('div');
    mensajeDiv.className = `mensaje mensaje-${tipo}`;
    mensajeDiv.innerHTML = `
        <i class="bi bi-${getIconoTipo(tipo)} me-2"></i>
        ${mensaje}
    `;
    
    elementos.mensajeContainer.appendChild(mensajeDiv);
    
    setTimeout(() => {
        if (mensajeDiv.parentNode) {
            mensajeDiv.remove();
        }
    }, duracion);
}

function getIconoTipo(tipo) {
    const iconos = {
        success: 'check-circle-fill',
        error: 'exclamation-triangle-fill',
        warning: 'exclamation-triangle-fill',
        info: 'info-circle-fill'
    };
    return iconos[tipo] || 'info-circle-fill';
}

console.log('üéâ Autorizaci√≥n de Presupuesto - SchoolNet v2.0');
console.log('üìä Backend API + Fallback directo implementado');
