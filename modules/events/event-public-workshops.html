<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.02.20.00">
    <title>Mis Talleres - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- reCAPTCHA v3 -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LdMjF4sAAAAANCg-Gev-wyRXmdSbK9yJ039fBBT"></script>
    
    <style>
        :root {
            --primary-color: #1B365D;
            --secondary-color: #667eea;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        
        .workshops-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .workshops-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .card-header-custom {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .card-header-custom h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .participant-info {
            background: #e7f3ff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .participant-info h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .workshop-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .workshop-section h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .current-workshop {
            background: #d4edda;
            border: 2px solid #c3e6cb;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .current-workshop h5 {
            color: #155724;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .workshop-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .workshop-option:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .workshop-option input[type="radio"] {
            margin-right: 0.75rem;
        }
        
        .workshop-option.selected {
            border-color: var(--primary-color);
            background: rgba(27, 54, 93, 0.05);
        }
        
        .workshop-option.full {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f8f9fa;
        }
        
        .workshop-name {
            font-weight: 600;
            color: #212529;
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .workshop-info {
            font-size: 0.9rem;
            color: #6c757d;
            display: block;
        }
        
        .workshop-capacity {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: #e7f3ff;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        
        .workshop-capacity.full {
            background: #f8d7da;
            color: #721c24;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(27, 54, 93, 0.15);
        }
        
        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            border-radius: 10px;
            color: white;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
        }
        
        .alert-info-custom {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mb-0">Procesando...</p>
        </div>
    </div>
    
    <div class="workshops-container">
        <div class="workshops-card">
            <div class="card-header-custom">
                <h1>
                    <i class="bi bi-diagram-3 me-2"></i>
                    Mis Talleres
                </h1>
                <p class="mb-0">Gestiona tu inscripción a talleres</p>
            </div>
            
            <div class="card-body p-4" id="mainContent">
                
                <!-- Formulario de Búsqueda -->
                <div id="searchSection">
                    <p class="text-muted mb-3">
                        Ingresa tu documento para ver y modificar tus talleres inscritos
                    </p>
                    
                    <form id="searchForm">
                        <div class="mb-3">
                            <label for="participantDocument" class="form-label">
                                Número de Documento
                            </label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="participantDocument" 
                                required
                                placeholder="Ingresa tu número de documento"
                                autofocus
                            >
                        </div>
                        <button type="submit" class="btn btn-primary-custom">
                            <i class="bi bi-search me-2"></i>
                            Buscar Mis Talleres
                        </button>
                    </form>
                </div>
                
                <!-- Sección de Talleres (oculta inicialmente) -->
                <div id="workshopsSection" style="display: none;">
                    <!-- Se llenará dinámicamente -->
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // Variables globales
        let eventId = null;
        let currentRegistration = null;
        let currentEnrollments = [];
        let slotsWithGroups = [];
        let selectedWorkshops = {}; // { slotId: groupId }
        let recaptchaToken = null;
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Obtener ID del evento de URL
                const urlParams = new URLSearchParams(window.location.search);
                eventId = urlParams.get('event');
                
                if (!eventId) {
                    showError('ID de evento no especificado. Por favor usa el enlace correcto.');
                    return;
                }
                
                // Configurar formulario de búsqueda
                document.getElementById('searchForm').addEventListener('submit', handleSearch);
                
                console.log('✅ Gestión de talleres inicializada');
                
            } catch (error) {
                console.error('❌ Error:', error);
                showError('Error al cargar la página: ' + error.message);
            }
        });
        
        // ==========================================
        // BUSCAR PARTICIPANTE
        // ==========================================
        async function handleSearch(e) {
            e.preventDefault();
            
            const document = document.getElementById('participantDocument').value.trim();
            
            if (!document) {
                showNotInscribedMessage('Por favor ingresa tu documento');
                return;
            }
            
            try {
                showLoading(true);
                
                // Obtener token reCAPTCHA
                recaptchaToken = await grecaptcha.execute('6LdMjF4sAAAAANCg-Gev-wyRXmdSbK9yJ039fBBT', { action: 'workshops' });
                
                // Buscar inscripción
                const registration = await supabaseRequest(
                    `/event_registrations?select=*&event_id=eq.${eventId}&participant_document=eq.${document}&registration_status=eq.activo`
                );
                
                showLoading(false);
                
                // Validar si está inscrito
                if (!registration || registration.length === 0) {
                    showNotInscribedMessage(
                        'No estás inscrito en este evento',
                        'Por favor inscríbete primero para poder seleccionar talleres. Puedes inscribirte escaneando el código QR de inscripción al evento.'
                    );
                    return;
                }
                
                currentRegistration = registration[0];
                
                // Cargar inscripciones actuales a talleres
                await loadCurrentEnrollments();
                
                // Cargar talleres disponibles
                await loadWorkshops();
                
                // Mostrar sección de talleres
                document.getElementById('searchSection').style.display = 'none';
                document.getElementById('workshopsSection').style.display = 'block';
                
                renderWorkshopsSection();
                
            } catch (error) {
                console.error('❌ Error:', error);
                showLoading(false);
                showNotInscribedMessage(
                    'Error al buscar tus datos',
                    'Ocurrió un error al procesar tu solicitud. Por favor intenta nuevamente.'
                );
            }
        }
        
        // ==========================================
        // CARGAR INSCRIPCIONES ACTUALES
        // ==========================================
        async function loadCurrentEnrollments() {
            try {
                const enrollments = await supabaseRequest(
                    `/event_group_enrollments?select=*,event_groups(*)&registration_id=eq.${currentRegistration.registration_id}`
                );
                
                currentEnrollments = enrollments || [];
                
                // Mapear inscripciones actuales
                currentEnrollments.forEach(enrollment => {
                    if (enrollment.event_groups) {
                        selectedWorkshops[enrollment.event_groups.slot_id] = enrollment.group_id;
                    }
                });
                
                console.log('✅ Inscripciones actuales cargadas:', currentEnrollments);
                
            } catch (error) {
                console.error('❌ Error cargando inscripciones:', error);
            }
        }
        
        // ==========================================
        // CARGAR TALLERES
        // ==========================================
        async function loadWorkshops() {
            try {
                // Cargar franjas tipo "grupos"
                const slots = await supabaseRequest(
                    `/event_slots?select=*&event_id=eq.${eventId}&slot_type=eq.grupos&order=slot_date.asc,slot_start_time.asc`
                );
                
                if (!slots || slots.length === 0) {
                    return;
                }
                
                // Cargar grupos de cada franja
                for (const slot of slots) {
                    const groups = await supabaseRequest(
                        `/event_groups?select=*&slot_id=eq.${slot.slot_id}&is_active=eq.true&order=group_order.asc,group_title.asc`
                    );
                    
                    if (groups && groups.length > 0) {
                        slotsWithGroups.push({
                            slot: slot,
                            groups: groups
                        });
                    }
                }
                
                console.log(`✅ ${slotsWithGroups.length} franjas con talleres cargadas`);
                
            } catch (error) {
                console.error('❌ Error cargando talleres:', error);
            }
        }
        
        // ==========================================
        // RENDERIZAR SECCIÓN DE TALLERES
        // ==========================================
        function renderWorkshopsSection() {
            const container = document.getElementById('workshopsSection');
            
            let html = `
                <!-- Información del Participante -->
                <div class="participant-info">
                    <h3>${currentRegistration.participant_full_name}</h3>
                    <p class="mb-0 text-muted">
                        <i class="bi bi-person-badge me-2"></i>
                        ${currentRegistration.participant_document}
                    </p>
                </div>
            `;
            
            if (slotsWithGroups.length === 0) {
                html += `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No hay talleres disponibles para este evento
                    </div>
                `;
            } else {
                html += `
                    <div class="alert-info-custom">
                        <i class="bi bi-lightbulb me-2"></i>
                        <strong>Importante:</strong> Puedes cambiar tu selección de talleres siempre que haya cupos disponibles
                    </div>
                    
                    <div class="section-title">
                        <i class="bi bi-diagram-3 me-2"></i>
                        Selección de Talleres
                    </div>
                `;
                
                slotsWithGroups.forEach(({ slot, groups }) => {
                    const date = new Date(slot.slot_date).toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'long' });
                    const currentEnrollment = currentEnrollments.find(e => e.event_groups?.slot_id === slot.slot_id);
                    
                    html += `
                        <div class="workshop-section">
                            <h4>
                                <i class="bi bi-calendar3 me-2"></i>
                                ${slot.slot_title}
                            </h4>
                            <p class="text-muted small mb-3">
                                ${date} de ${slot.slot_start_time} a ${slot.slot_end_time}
                            </p>
                    `;
                    
                    // Mostrar taller actual si existe
                    if (currentEnrollment && currentEnrollment.event_groups) {
                        html += `
                            <div class="current-workshop">
                                <h5>
                                    <i class="bi bi-check-circle me-2"></i>
                                    Tu taller actual
                                </h5>
                                <strong>${currentEnrollment.event_groups.group_title}</strong>
                                ${currentEnrollment.event_groups.group_location ? `<br><small><i class="bi bi-geo-alt me-1"></i>${currentEnrollment.event_groups.group_location}</small>` : ''}
                            </div>
                            <p class="small text-muted mb-2">Selecciona otro taller si deseas cambiar:</p>
                        `;
                    } else {
                        html += `<p class="small text-muted mb-2">Selecciona un taller:</p>`;
                    }
                    
                    html += `<div id="slot-${slot.slot_id}">`;
                    
                    groups.forEach(group => {
                        const spotsLeft = group.group_capacity - group.current_enrollment;
                        const isFull = spotsLeft <= 0;
                        const isCurrentlyEnrolled = currentEnrollment?.group_id === group.group_id;
                        const capacityClass = isFull && !isCurrentlyEnrolled ? 'full' : '';
                        const optionClass = isFull && !isCurrentlyEnrolled ? 'workshop-option full' : 'workshop-option';
                        const isSelected = selectedWorkshops[slot.slot_id] === group.group_id;
                        
                        html += `
                            <label class="${optionClass} ${isSelected ? 'selected' : ''}" onclick="selectWorkshop('${slot.slot_id}', '${group.group_id}', this)">
                                <input 
                                    type="radio" 
                                    name="workshop_${slot.slot_id}" 
                                    value="${group.group_id}"
                                    ${isFull && !isCurrentlyEnrolled ? 'disabled' : ''}
                                    ${isSelected ? 'checked' : ''}
                                >
                                <div>
                                    <span class="workshop-name">${group.group_title}</span>
                                    ${group.group_description ? `<span class="workshop-info">${group.group_description}</span>` : ''}
                                    ${group.group_location ? `<span class="workshop-info"><i class="bi bi-geo-alt me-1"></i>${group.group_location}</span>` : ''}
                                    <span class="workshop-capacity ${capacityClass}">
                                        <i class="bi bi-people me-1"></i>
                                        ${isFull && !isCurrentlyEnrolled ? 'LLENO' : `${spotsLeft} cupos disponibles`}
                                    </span>
                                </div>
                            </label>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    <div class="text-center mt-4">
                        <button class="btn btn-primary-custom btn-lg" onclick="saveChanges()">
                            <i class="bi bi-save me-2"></i>
                            Guardar Cambios
                        </button>
                        <button class="btn btn-outline-secondary btn-lg ms-2" onclick="location.reload()">
                            <i class="bi bi-arrow-left me-2"></i>
                            Volver
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // SELECCIONAR TALLER
        // ==========================================
        function selectWorkshop(slotId, groupId, element) {
            // Remover selección anterior de esta franja
            const slotContainer = document.getElementById(`slot-${slotId}`);
            slotContainer.querySelectorAll('.workshop-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Agregar selección actual
            element.classList.add('selected');
            selectedWorkshops[slotId] = groupId;
            
            console.log('Talleres seleccionados:', selectedWorkshops);
        }
        
        // ==========================================
        // GUARDAR CAMBIOS
        // ==========================================
        async function saveChanges() {
            if (!confirm('¿Estás seguro de guardar los cambios en tus talleres?')) {
                return;
            }
            
            try {
                showLoading(true);
                
                // Eliminar inscripciones actuales
                await supabaseRequest(`/event_group_enrollments?registration_id=eq.${currentRegistration.registration_id}`, {
                    method: 'DELETE'
                });
                
                // Crear nuevas inscripciones
                if (Object.keys(selectedWorkshops).length > 0) {
                    const enrollments = Object.entries(selectedWorkshops).map(([slotId, groupId]) => ({
                        registration_id: currentRegistration.registration_id,
                        group_id: groupId,
                        enrollment_source: 'anticipada',
                        created_by: null
                    }));
                    
                    await supabaseRequest('/event_group_enrollments', {
                        method: 'POST',
                        body: JSON.stringify(enrollments)
                    });
                }
                
                showLoading(false);
                alert('✅ Tus talleres han sido actualizados exitosamente');
                location.reload();
                
            } catch (error) {
                console.error('❌ Error:', error);
                showLoading(false);
                alert('Error al guardar cambios: ' + error.message);
            }
        }
        
        // ==========================================
        // MOSTRAR MENSAJE DE NO INSCRITO
        // ==========================================
        function showNotInscribedMessage(title, message = '') {
            const searchSection = document.getElementById('searchSection');
            searchSection.innerHTML = `
                <div class="alert alert-warning border-2" style="border-color: #ffc107;">
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0">
                            <i class="bi bi-exclamation-triangle" style="font-size: 2.5rem; color: #ffc107;"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h4 class="alert-heading mb-2">
                                ${title}
                            </h4>
                            ${message ? `<p class="mb-3">${message}</p>` : ''}
                            <hr>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" onclick="location.reload()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>
                                    Intentar de Nuevo
                                </button>
                                <button class="btn btn-outline-secondary" onclick="goToRegistration()">
                                    <i class="bi bi-person-plus me-1"></i>
                                    Ir a Inscripción
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // IR A PÁGINA DE INSCRIPCIÓN
        // ==========================================
        function goToRegistration() {
            const baseUrl = window.location.origin;
            window.location.href = `${baseUrl}/modules/events/event-public-register.html?event=${eventId}`;
        }
        
        // ==========================================
        // MOSTRAR ERROR
        // ==========================================
        function showError(message) {
            document.getElementById('mainContent').innerHTML = `
                <div class="alert alert-danger">
                    <h4 class="alert-heading">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error
                    </h4>
                    <p class="mb-0">${message}</p>
                </div>
            `;
        }
        
        // ==========================================
        // MOSTRAR/OCULTAR LOADING
        // ==========================================
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        console.log('✅ Gestión de Talleres cargado - v26.02.02');
    </script>
</body>
</html>
