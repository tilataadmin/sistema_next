<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.02.09.57">
    <title>Registro de Asistencia - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- reCAPTCHA v3 -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LfxUJsqAAAAAMWeoOKlTtQKC9fjB4qJYHdNjxj5"></script>
    
    <style>
        :root {
            --primary-color: #1B365D;
            --secondary-color: #667eea;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .attendance-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
        }
        
        .card-header-custom {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .card-header-custom h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .card-header-custom p {
            margin-bottom: 0;
            opacity: 0.95;
        }
        
        .card-body-custom {
            padding: 2rem;
        }
        
        .event-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .event-info h2 {
            font-size: 1.25rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .event-date {
            color: #6c757d;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(27, 54, 93, 0.15);
        }
        
        .btn-submit {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            border-radius: 10px;
            color: white;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .success-message {
            background: #d4edda;
            border: 2px solid #c3e6cb;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
        }
        
        .success-icon {
            font-size: 4rem;
            color: #28a745;
            margin-bottom: 1rem;
        }
        
        .error-message {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            border-radius: 12px;
            padding: 1.5rem;
            color: #721c24;
        }
        
        .participant-info {
            background: #e7f3ff;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .participant-info .label {
            font-size: 0.85rem;
            color: #6c757d;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }
        
        .participant-info .value {
            font-size: 1rem;
            color: #212529;
            font-weight: 500;
        }
        
        .recaptcha-notice {
            font-size: 0.85rem;
            color: #6c757d;
            text-align: center;
            margin-top: 1rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
        }
    </style>
</head>
<body>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mb-0">Registrando asistencia...</p>
        </div>
    </div>
    
    <div class="attendance-card">
        <div class="card-header-custom">
            <h1>
                <i class="bi bi-clipboard-check me-2"></i>
                Registro de Asistencia
            </h1>
            <p>Confirma tu presencia en el evento</p>
        </div>
        
        <div class="card-body-custom" id="mainContent">
            
            <!-- Información del Evento -->
            <div class="event-info" id="eventInfo">
                <h2 id="eventName">Cargando evento...</h2>
                <div class="event-date">
                    <i class="bi bi-calendar3"></i>
                    <span id="eventDate">Cargando fecha...</span>
                </div>
            </div>
            
            <!-- Formulario de Registro -->
            <form id="attendanceForm">
                <div class="mb-3">
                    <label for="participantDocument" class="form-label">
                        <i class="bi bi-person-badge me-1"></i>
                        Número de Documento
                    </label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="participantDocument" 
                        required
                        placeholder="Ingresa tu número de documento"
                        autofocus
                    >
                    <div class="form-text">
                        Ingresa el documento con el que te inscribiste al evento
                    </div>
                </div>
                
                <button type="submit" class="btn btn-submit" id="btnSubmit">
                    <i class="bi bi-check-circle me-2"></i>
                    Registrar Mi Asistencia
                </button>
                
                <div class="recaptcha-notice">
                    Este sitio está protegido por reCAPTCHA
                </div>
            </form>
            
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // Variables globales
        let eventId = null;
        let eventDate = null;
        let eventToken = null;
        let currentEvent = null;
        let recaptchaToken = null;
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Obtener parámetros de URL
                const urlParams = new URLSearchParams(window.location.search);
                eventId = urlParams.get('event');
                eventDate = urlParams.get('date');
                eventToken = urlParams.get('token');
                
                // Validar parámetros
                if (!eventId || !eventDate || !eventToken) {
                    showError('Parámetros de URL inválidos. Por favor escanea el código QR nuevamente.');
                    return;
                }
                
                // Validar token
                const expectedToken = generateDayToken(eventId, eventDate);
                if (eventToken !== expectedToken) {
                    showError('Token de seguridad inválido. Este enlace no es válido.');
                    return;
                }
                
                // Cargar información del evento
                await loadEventInfo();
                
                // Configurar formulario
                document.getElementById('attendanceForm').addEventListener('submit', handleSubmit);
                
                console.log('✅ Página de asistencia inicializada');
                
            } catch (error) {
                console.error('❌ Error:', error);
                showError('Error al cargar la página: ' + error.message);
            }
        });
        
        // ==========================================
        // CARGAR INFORMACIÓN DEL EVENTO
        // ==========================================
        async function loadEventInfo() {
            try {
                const data = await supabaseRequest(`/events?select=*&event_id=eq.${eventId}`);
                
                if (!data || data.length === 0) {
                    throw new Error('Evento no encontrado');
                }
                
                currentEvent = data[0];
                
                // Validar que la fecha esté dentro del rango del evento
                const requestDate = new Date(eventDate);
                const startDate = new Date(currentEvent.event_start_date);
                const endDate = new Date(currentEvent.event_end_date);
                
                if (requestDate < startDate || requestDate > endDate) {
                    throw new Error('La fecha no corresponde a ningún día del evento');
                }
                
                // Renderizar información
                document.getElementById('eventName').textContent = currentEvent.event_name;
                
                const dateFormatted = requestDate.toLocaleDateString('es-CO', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('eventDate').textContent = dateFormatted;
                
                console.log('✅ Evento cargado:', currentEvent.event_name);
                
            } catch (error) {
                console.error('❌ Error cargando evento:', error);
                throw error;
            }
        }
        
        // ==========================================
        // MANEJAR ENVÍO DEL FORMULARIO
        // ==========================================
        async function handleSubmit(e) {
            e.preventDefault();
            
            const document = document.getElementById('participantDocument').value.trim();
            
            if (!document) {
                showMessage('Por favor ingresa tu número de documento', 'warning');
                return;
            }
            
            try {
                // Mostrar loading
                showLoading(true);
                
                // Obtener token de reCAPTCHA
                recaptchaToken = await grecaptcha.execute('6LfxUJsqAAAAAMWeoOKlTtQKC9fjB4qJYHdNjxj5', { action: 'attendance' });
                
                // Buscar participante inscrito
                const registration = await findParticipant(document);
                
                if (!registration) {
                    showLoading(false);
                    showError('No estás inscrito en este evento. Por favor verifica tu número de documento o inscríbete primero.');
                    return;
                }
                
                // Verificar si ya registró asistencia hoy
                const alreadyRegistered = await checkExistingAttendance(registration.registration_id, eventDate);
                
                if (alreadyRegistered) {
                    showLoading(false);
                    showAlreadyRegistered(registration);
                    return;
                }
                
                // Registrar asistencia
                await registerAttendance(registration);
                
                showLoading(false);
                showSuccess(registration);
                
            } catch (error) {
                console.error('❌ Error:', error);
                showLoading(false);
                showError('Error al registrar asistencia: ' + error.message);
            }
        }
        
        // ==========================================
        // BUSCAR PARTICIPANTE INSCRITO
        // ==========================================
        async function findParticipant(document) {
            try {
                const data = await supabaseRequest(
                    `/event_registrations?select=*&event_id=eq.${eventId}&participant_document=eq.${document}&registration_status=eq.activo`
                );
                
                return data && data.length > 0 ? data[0] : null;
                
            } catch (error) {
                console.error('❌ Error buscando participante:', error);
                throw error;
            }
        }
        
        // ==========================================
        // VERIFICAR ASISTENCIA EXISTENTE
        // ==========================================
        async function checkExistingAttendance(registrationId, date) {
            try {
                const data = await supabaseRequest(
                    `/event_attendance?select=attendance_id&registration_id=eq.${registrationId}&attendance_date=eq.${date}`
                );
                
                return data && data.length > 0;
                
            } catch (error) {
                console.error('❌ Error verificando asistencia:', error);
                return false; // En caso de error, permitir registro
            }
        }
        
        // ==========================================
        // REGISTRAR ASISTENCIA
        // ==========================================
        async function registerAttendance(registration) {
            try {
                const now = new Date();
                const attendanceData = {
                    registration_id: registration.registration_id,
                    event_id: eventId,
                    attendance_date: eventDate,
                    attendance_time: now.toTimeString().split(' ')[0],
                    registered_from: 'qr',
                    registered_by: null,
                    registration_ip: null // El servidor puede capturar esto si es necesario
                };
                
                await supabaseRequest('/event_attendance', {
                    method: 'POST',
                    body: JSON.stringify(attendanceData)
                });
                
                console.log('✅ Asistencia registrada exitosamente');
                
            } catch (error) {
                console.error('❌ Error registrando asistencia:', error);
                throw error;
            }
        }
        
        // ==========================================
        // MOSTRAR ÉXITO
        // ==========================================
        function showSuccess(registration) {
            const now = new Date();
            const timeFormatted = now.toLocaleTimeString('es-CO', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            document.getElementById('mainContent').innerHTML = `
                <div class="success-message">
                    <div class="success-icon">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <h3 class="text-success mb-3">¡Asistencia Registrada!</h3>
                    <div class="participant-info">
                        <div class="label">Nombre</div>
                        <div class="value">${registration.participant_full_name}</div>
                    </div>
                    <div class="participant-info">
                        <div class="label">Documento</div>
                        <div class="value">${registration.participant_document}</div>
                    </div>
                    <div class="participant-info">
                        <div class="label">Hora de Registro</div>
                        <div class="value">${timeFormatted}</div>
                    </div>
                    <p class="text-muted mt-3 mb-0">
                        Tu asistencia ha sido registrada exitosamente
                    </p>
                </div>
            `;
        }
        
        // ==========================================
        // MOSTRAR YA REGISTRADO
        // ==========================================
        function showAlreadyRegistered(registration) {
            document.getElementById('mainContent').innerHTML = `
                <div class="success-message" style="background: #fff3cd; border-color: #ffc107;">
                    <div class="success-icon" style="color: #ffc107;">
                        <i class="bi bi-info-circle-fill"></i>
                    </div>
                    <h3 style="color: #856404;" class="mb-3">Ya Registraste Tu Asistencia</h3>
                    <div class="participant-info">
                        <div class="label">Nombre</div>
                        <div class="value">${registration.participant_full_name}</div>
                    </div>
                    <div class="participant-info">
                        <div class="label">Documento</div>
                        <div class="value">${registration.participant_document}</div>
                    </div>
                    <p class="text-muted mt-3 mb-0">
                        Tu asistencia ya fue registrada anteriormente para este día
                    </p>
                </div>
            `;
        }
        
        // ==========================================
        // MOSTRAR ERROR
        // ==========================================
        function showError(message) {
            document.getElementById('mainContent').innerHTML = `
                <div class="error-message">
                    <h4 class="mb-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error
                    </h4>
                    <p class="mb-0">${message}</p>
                </div>
            `;
        }
        
        // ==========================================
        // MOSTRAR/OCULTAR LOADING
        // ==========================================
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        // ==========================================
        // GENERAR TOKEN (IGUAL QUE EN events-detail.html)
        // ==========================================
        function generateDayToken(eventId, date) {
            const str = `${eventId}-${date}-schoolnet-attendance`;
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }
        
        console.log('✅ Registro de Asistencia cargado - v26.02.02');
    </script>
</body>
</html>
