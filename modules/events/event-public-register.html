<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.03.07.32">
    <title>Inscripción al Evento - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- reCAPTCHA v3 -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LdMjF4sAAAAANCg-Gev-wyRXmdSbK9yJ039fBBT"></script>
    
    <style>
        :root {
            --primary-color: #1B365D;
            --secondary-color: #667eea;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        
        .register-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .register-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .card-header-custom {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .card-header-custom h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .event-info-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .event-info-box h2 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .event-dates {
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .required {
            color: #dc3545;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(27, 54, 93, 0.15);
        }
        
        .workshop-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .workshop-section h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .workshop-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .workshop-option:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .workshop-option input[type="radio"] {
            margin-right: 0.75rem;
        }
        
        .workshop-option.selected {
            border-color: var(--primary-color);
            background: rgba(27, 54, 93, 0.05);
        }
        
        .workshop-option.full {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f8f9fa;
        }
        
        .workshop-name {
            font-weight: 600;
            color: #212529;
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .workshop-info {
            font-size: 0.9rem;
            color: #6c757d;
            display: block;
        }
        
        .workshop-capacity {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: #e7f3ff;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        
        .workshop-capacity.full {
            background: #f8d7da;
            color: #721c24;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            border-radius: 10px;
            color: white;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .success-message {
            background: #d4edda;
            border: 2px solid #c3e6cb;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
        }
        
        .success-icon {
            font-size: 4rem;
            color: #28a745;
            margin-bottom: 1rem;
        }
        
        .recaptcha-notice {
            font-size: 0.85rem;
            color: white;
            text-align: center;
            margin-top: 1rem;
            opacity: 0.9;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
        }
        
        .no-workshops {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mb-0">Procesando inscripción...</p>
        </div>
    </div>
    
    <div class="register-container">
        <div class="register-card">
            <div class="card-header-custom">
                <h1>
                    <i class="bi bi-calendar-check me-2"></i>
                    Inscripción al Evento
                </h1>
                <p class="mb-0">Completa tus datos para participar</p>
                <div class="recaptcha-notice">
                    Este sitio está protegido por reCAPTCHA
                </div>
            </div>
            
            <div class="card-body p-4" id="mainContent">
                
                <!-- Información del Evento -->
                <div class="event-info-box" id="eventInfo">
                    <h2 id="eventName">Cargando evento...</h2>
                    <div class="event-dates">
                        <i class="bi bi-calendar3"></i>
                        <span id="eventDates">Cargando fechas...</span>
                    </div>
                    <p class="mt-2 mb-0 text-muted" id="eventDescription"></p>
                </div>
                
                <!-- Formulario de Inscripción -->
                <form id="registrationForm">
                    
                    <!-- Sección 1: Datos Personales -->
                    <div class="section-title">
                        <i class="bi bi-person-fill me-2"></i>
                        Datos Personales
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="participantDocument" class="form-label">
                                Número de Documento <span class="required">*</span>
                            </label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="participantDocument" 
                                required
                                placeholder="Ej: 1234567890"
                            >
                        </div>
                        <div class="col-md-6">
                            <label for="participantName" class="form-label">
                                Nombre Completo <span class="required">*</span>
                            </label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="participantName" 
                                required
                                placeholder="Ej: Juan Pérez García"
                            >
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="participantEmail" class="form-label">
                                Correo Electrónico <span class="required">*</span>
                            </label>
                            <input 
                                type="email" 
                                class="form-control" 
                                id="participantEmail" 
                                required
                                placeholder="correo@ejemplo.com"
                            >
                        </div>
                        <div class="col-md-6">
                            <label for="participantInstitution" class="form-label">
                                Institución
                            </label>
                            <select class="form-select" id="participantInstitution">
                                <option value="">Seleccionar institución...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="participantPosition" class="form-label">
                                Cargo
                            </label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="participantPosition"
                                placeholder="Ej: Docente, Estudiante, Administrativo"
                            >
                        </div>
                        <div class="col-md-6">
                            <label for="participantArrival" class="form-label">
                                Medio de Llegada
                            </label>
                            <select class="form-select" id="participantArrival">
                                <option value="">Seleccionar...</option>
                                <option value="Transporte público">Transporte público</option>
                                <option value="Vehículo propio">Vehículo propio</option>
                                <option value="Bicicleta">Bicicleta</option>
                                <option value="A pie">A pie</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="participantDietary" class="form-label">
                            Restricciones Alimentarias
                        </label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="participantDietary"
                            placeholder="Ej: Vegetariano, Celíaco, Ninguna"
                        >
                    </div>
                    
                    <!-- Sección 2: Selección de Talleres -->
                    <div id="workshopsSection">
                        <div class="section-title">
                            <i class="bi bi-diagram-3 me-2"></i>
                            Selección de Talleres
                        </div>
                        <p class="text-muted mb-3">
                            Selecciona un taller por cada franja disponible
                        </p>
                        <div id="workshopsContainer">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2">Cargando talleres...</p>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-submit mt-4" id="btnSubmit">
                        <i class="bi bi-check-circle me-2"></i>
                        Completar Inscripción
                    </button>
                    
                </form>
                
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // Variables globales
        let eventId = null;
        let currentEvent = null;
        let institutions = [];
        let slotsWithGroups = [];
        let selectedWorkshops = {}; // { slotId: groupId }
        let recaptchaToken = null;
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Obtener ID del evento de URL
                const urlParams = new URLSearchParams(window.location.search);
                eventId = urlParams.get('event');
                
                if (!eventId) {
                    showError('ID de evento no especificado. Por favor usa el enlace correcto.');
                    return;
                }
                
                // Cargar datos
                await loadEventInfo();
                await loadInstitutions();
                await loadWorkshops();
                
                // Configurar formulario
                document.getElementById('registrationForm').addEventListener('submit', handleSubmit);
                
                console.log('✅ Formulario de inscripción inicializado');
                
            } catch (error) {
                console.error('❌ Error:', error);
                showError('Error al cargar el formulario: ' + error.message);
            }
        });
        
        // ==========================================
        // CARGAR INFORMACIÓN DEL EVENTO
        // ==========================================
        async function loadEventInfo() {
            try {
                const data = await supabaseRequest(`/events?select=*&event_id=eq.${eventId}&event_status=eq.activo`);
                
                if (!data || data.length === 0) {
                    throw new Error('Evento no encontrado o no está activo');
                }
                
                currentEvent = data[0];
                
                // Renderizar información
                document.getElementById('eventName').textContent = currentEvent.event_name;
                
                const startDate = new Date(currentEvent.event_start_date).toLocaleDateString('es-CO');
                const endDate = new Date(currentEvent.event_end_date).toLocaleDateString('es-CO');
                document.getElementById('eventDates').textContent = `${startDate} - ${endDate}`;
                
                if (currentEvent.event_description) {
                    document.getElementById('eventDescription').textContent = currentEvent.event_description;
                }
                
                console.log('✅ Evento cargado:', currentEvent.event_name);
                
            } catch (error) {
                console.error('❌ Error cargando evento:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR INSTITUCIONES
        // ==========================================
        async function loadInstitutions() {
            try {
                const data = await supabaseRequest('/institutions?select=institution_id,institution_name&is_active=eq.true&order=institution_name.asc');
                institutions = data || [];
                
                const select = document.getElementById('participantInstitution');
                institutions.forEach(inst => {
                    const option = document.createElement('option');
                    option.value = inst.institution_id;
                    option.textContent = inst.institution_name;
                    select.appendChild(option);
                });
                
                console.log(`✅ ${institutions.length} instituciones cargadas`);
                
            } catch (error) {
                console.error('❌ Error cargando instituciones:', error);
            }
        }
        
        // ==========================================
        // CARGAR TALLERES
        // ==========================================
        async function loadWorkshops() {
            try {
                // Cargar franjas tipo "grupos"
                const slots = await supabaseRequest(
                    `/event_slots?select=*&event_id=eq.${eventId}&slot_type=eq.grupos&order=slot_date.asc,slot_start_time.asc`
                );
                
                if (!slots || slots.length === 0) {
                    renderNoWorkshops();
                    return;
                }
                
                // Cargar grupos de cada franja
                for (const slot of slots) {
                    const groups = await supabaseRequest(
                        `/event_groups?select=*&slot_id=eq.${slot.slot_id}&is_active=eq.true&order=group_order.asc,group_title.asc`
                    );
                    
                    if (groups && groups.length > 0) {
                        slotsWithGroups.push({
                            slot: slot,
                            groups: groups
                        });
                    }
                }
                
                if (slotsWithGroups.length === 0) {
                    renderNoWorkshops();
                } else {
                    renderWorkshops();
                }
                
                console.log(`✅ ${slotsWithGroups.length} franjas con talleres cargadas`);
                
            } catch (error) {
                console.error('❌ Error cargando talleres:', error);
                renderNoWorkshops();
            }
        }
        
        // ==========================================
        // RENDERIZAR TALLERES
        // ==========================================
        function renderWorkshops() {
            const container = document.getElementById('workshopsContainer');
            let html = '';
            
            slotsWithGroups.forEach(({ slot, groups }) => {
                const date = new Date(slot.slot_date).toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'long' });
                
                html += `
                    <div class="workshop-section">
                        <h4>
                            <i class="bi bi-calendar3 me-2"></i>
                            ${slot.slot_title}
                        </h4>
                        <p class="text-muted small mb-3">
                            ${date} de ${slot.slot_start_time} a ${slot.slot_end_time}
                        </p>
                        <div id="slot-${slot.slot_id}">
                `;
                
                groups.forEach(group => {
                    const spotsLeft = group.group_capacity - group.current_enrollment;
                    const isFull = spotsLeft <= 0;
                    const capacityClass = isFull ? 'full' : '';
                    const optionClass = isFull ? 'workshop-option full' : 'workshop-option';
                    
                    html += `
                        <label class="${optionClass}" onclick="selectWorkshop('${slot.slot_id}', '${group.group_id}', this)">
                            <input 
                                type="radio" 
                                name="workshop_${slot.slot_id}" 
                                value="${group.group_id}"
                                ${isFull ? 'disabled' : ''}
                            >
                            <div>
                                <span class="workshop-name">${group.group_title}</span>
                                ${group.group_description ? `<span class="workshop-info">${group.group_description}</span>` : ''}
                                ${group.group_location ? `<span class="workshop-info"><i class="bi bi-geo-alt me-1"></i>${group.group_location}</span>` : ''}
                                <span class="workshop-capacity ${capacityClass}">
                                    <i class="bi bi-people me-1"></i>
                                    ${isFull ? 'LLENO' : `${spotsLeft} cupos disponibles`}
                                </span>
                            </div>
                        </label>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // RENDERIZAR SIN TALLERES
        // ==========================================
        function renderNoWorkshops() {
            const container = document.getElementById('workshopsContainer');
            container.innerHTML = `
                <div class="no-workshops">
                    <i class="bi bi-info-circle" style="font-size: 3rem; color: #6c757d; opacity: 0.5;"></i>
                    <p class="mt-3">No hay talleres disponibles para este evento</p>
                    <p class="small text-muted">Puedes inscribirte sin seleccionar talleres</p>
                </div>
            `;
        }
        
        // ==========================================
        // SELECCIONAR TALLER
        // ==========================================
        function selectWorkshop(slotId, groupId, element) {
            // Remover selección anterior de esta franja
            const slotContainer = document.getElementById(`slot-${slotId}`);
            slotContainer.querySelectorAll('.workshop-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Agregar selección actual
            element.classList.add('selected');
            selectedWorkshops[slotId] = groupId;
            
            console.log('Talleres seleccionados:', selectedWorkshops);
        }
        
        // ==========================================
        // MANEJAR ENVÍO DEL FORMULARIO
        // ==========================================
        async function handleSubmit(e) {
            e.preventDefault();
            
            // Recopilar datos
            const formData = {
                participant_document: document.getElementById('participantDocument').value.trim(),
                participant_full_name: document.getElementById('participantName').value.trim(),
                participant_email: document.getElementById('participantEmail').value.trim(),
                institution_id: document.getElementById('participantInstitution').value || null,
                participant_position: document.getElementById('participantPosition').value.trim() || null,
                arrival_method: document.getElementById('participantArrival').value || null,
                dietary_restrictions: document.getElementById('participantDietary').value.trim() || null,
                is_internal_worker: false, // Asumimos externo por defecto en registro público
                event_id: eventId,
                registration_status: 'activo',
                registration_source: 'web',
                registration_date: new Date().toISOString()
            };
            
            try {
                showLoading(true);
                
                // Obtener token reCAPTCHA
                recaptchaToken = await grecaptcha.execute('6LdMjF4sAAAAANCg-Gev-wyRXmdSbK9yJ039fBBT', { action: 'register' });
                
                // Verificar si ya está inscrito
                const existing = await supabaseRequest(
                    `/event_registrations?select=registration_id&event_id=eq.${eventId}&participant_document=eq.${formData.participant_document}`
                );
                
                if (existing && existing.length > 0) {
                    showLoading(false);
                    showAlreadyRegistered(formData.participant_document);
                    return;
                }
                
                // Crear inscripción al evento
                const registration = await supabaseRequest('/event_registrations', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                // Obtener registration_id del registro creado
                const newRegistration = await supabaseRequest(
                    `/event_registrations?select=registration_id&event_id=eq.${eventId}&participant_document=eq.${formData.participant_document}&order=created_at.desc&limit=1`
                );
                
                const registrationId = newRegistration[0].registration_id;
                
                // Inscribir en talleres seleccionados
                if (Object.keys(selectedWorkshops).length > 0) {
                    await enrollInWorkshops(registrationId);
                }
                
                showLoading(false);
                showSuccess(formData.participant_full_name);
                
            } catch (error) {
                console.error('❌ Error:', error);
                showLoading(false);
                alert('Error al procesar inscripción: ' + error.message);
            }
        }
        
        // ==========================================
        // INSCRIBIR EN TALLERES
        // ==========================================
        async function enrollInWorkshops(registrationId) {
            try {
                const enrollments = Object.entries(selectedWorkshops).map(([slotId, groupId]) => ({
                    registration_id: registrationId,
                    group_id: groupId,
                    enrollment_source: 'anticipada',
                    created_by: null
                }));
                
                await supabaseRequest('/event_group_enrollments', {
                    method: 'POST',
                    body: JSON.stringify(enrollments)
                });
                
                console.log('✅ Inscrito en talleres exitosamente');
                
            } catch (error) {
                console.error('❌ Error inscribiendo en talleres:', error);
                // No lanzar error para no bloquear la inscripción al evento
            }
        }
        
        // ==========================================
        // MOSTRAR ÉXITO
        // ==========================================
        function showSuccess(name) {
            const workshopsList = Object.keys(selectedWorkshops).length > 0 
                ? `<p class="mt-3">También has sido inscrito en ${Object.keys(selectedWorkshops).length} taller(es)</p>`
                : '';
            
            document.getElementById('mainContent').innerHTML = `
                <div class="success-message">
                    <div class="success-icon">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <h3 class="text-success mb-3">¡Inscripción Completada!</h3>
                    <h5 class="mb-3">${name}</h5>
                    <p>Tu inscripción ha sido registrada exitosamente</p>
                    ${workshopsList}
                    <div class="mt-4">
                        <p class="text-muted small">
                            Recibirás una confirmación en tu correo electrónico
                        </p>
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // MOSTRAR YA INSCRITO
        // ==========================================
        function showAlreadyRegistered(participantDoc) {
            document.getElementById('mainContent').innerHTML = `
                <div class="alert alert-info border-2" style="border-color: #17a2b8;">
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0">
                            <i class="bi bi-info-circle" style="font-size: 3rem; color: #17a2b8;"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h4 class="alert-heading mb-2">
                                Ya Estás Inscrito
                            </h4>
                            <p class="mb-3">
                                El documento <strong>${participantDoc}</strong> ya está registrado en este evento.
                            </p>
                            <p class="mb-3">
                                <strong>¿Qué puedes hacer?</strong>
                            </p>
                            <ul class="mb-3">
                                <li>Si deseas modificar tus talleres, usa el código QR de gestión de talleres</li>
                                <li>Si este no es tu documento, verifica el número ingresado</li>
                                <li>Contacta a los organizadores si necesitas ayuda</li>
                            </ul>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="goToWorkshops()">
                                    <i class="bi bi-diagram-3 me-1"></i>
                                    Gestionar Mis Talleres
                                </button>
                                <button class="btn btn-outline-secondary" onclick="location.reload()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>
                                    Inscribir Otra Persona
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // IR A GESTIÓN DE TALLERES
        // ==========================================
        function goToWorkshops() {
            const baseUrl = window.location.origin;
            window.location.href = `${baseUrl}/modules/events/event-public-workshops.html?event=${eventId}`;
        }
        
        // ==========================================
        // MOSTRAR ERROR
        // ==========================================
        function showError(message) {
            document.getElementById('mainContent').innerHTML = `
                <div class="alert alert-danger">
                    <h4 class="alert-heading">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error
                    </h4>
                    <p class="mb-0">${message}</p>
                </div>
            `;
        }
        
        // ==========================================
        // MOSTRAR/OCULTAR LOADING
        // ==========================================
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        console.log('✅ Formulario de Inscripción cargado - v26.02.02');
    </script>
</body>
</html>
