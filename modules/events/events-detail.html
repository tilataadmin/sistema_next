<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.02.09.17">
    <title>Detalle del Evento - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --module-primary: var(--system-primary-color, #1B365D);
            --module-secondary: var(--system-secondary-color, #667eea);
        }
        
        body {
            background-color: #f8f9fa;
        }
        
        .page-header {
            background: linear-gradient(135deg, var(--module-primary) 0%, var(--module-secondary) 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 16px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .page-title {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .event-dates {
            font-size: 0.95rem;
            opacity: 0.95;
        }
        
        .breadcrumb {
            background: transparent;
            padding: 0;
            margin-bottom: 1rem;
        }
        
        .breadcrumb-item a {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
        }
        
        .breadcrumb-item.active {
            color: white;
        }
        
        .info-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        .info-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            color: #2c3e50;
            font-size: 1rem;
        }
        
        .badge-status {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        
        .badge-activo { background-color: #28a745; }
        .badge-finalizado { background-color: #6c757d; }
        .badge-cancelado { background-color: #dc3545; }
        
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }
        
        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 1rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .nav-tabs .nav-link:hover {
            border-bottom-color: var(--module-primary);
            color: var(--module-primary);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--module-primary);
            background: transparent;
            border-bottom-color: var(--module-primary);
        }
        
        .tab-content {
            padding: 2rem 0;
        }
        
        .stat-box {
            text-align: center;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--module-primary);
            display: block;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }
        
        .table-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .table thead th {
            background: var(--module-primary);
            color: white;
            font-weight: 600;
            border: none;
            padding: 1rem;
        }
        
        .slot-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .slot-header {
            background: linear-gradient(135deg, var(--module-primary) 0%, var(--module-secondary) 100%);
            color: white;
            padding: 1rem;
        }
        
        .slot-type-badge {
            background: rgba(255,255,255,0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .group-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .qr-container {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .institution-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: #e9ecef;
            border-radius: 20px;
            margin: 0.25rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="page-header">
        <div class="container-fluid">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="../../dashboard.html">
                            <i class="bi bi-house me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="index.html">Eventos</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="events-manage.html">Gestionar Eventos</a>
                    </li>
                    <li class="breadcrumb-item active">Detalle</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="page-title" id="eventName">
                        <i class="bi bi-calendar-event me-2"></i>
                        Cargando...
                    </h1>
                    <p class="event-dates mb-0" id="eventDates">
                        <i class="bi bi-calendar3 me-1"></i>
                        Cargando fechas...
                    </p>
                </div>
                <div>
                    <span class="badge badge-status" id="eventStatus">Activo</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contenido Principal -->
    <div class="container-fluid">
        
        <!-- Contenedor de Alertas -->
        <div id="alertContainer"></div>
        
        <!-- Tabs de Navegación -->
        <ul class="nav nav-tabs" id="eventTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                    <i class="bi bi-info-circle me-1"></i>
                    Información
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="slots-tab" data-bs-toggle="tab" data-bs-target="#slots" type="button" role="tab">
                    <i class="bi bi-layout-three-columns me-1"></i>
                    Franjas y Grupos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="registrations-tab" data-bs-toggle="tab" data-bs-target="#registrations" type="button" role="tab">
                    <i class="bi bi-people me-1"></i>
                    Inscripciones
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
                    <i class="bi bi-clipboard-check me-1"></i>
                    Asistencias
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
                    <i class="bi bi-graph-up me-1"></i>
                    Reportes
                </button>
            </li>
        </ul>
        
        <!-- Contenido de los Tabs -->
        <div class="tab-content" id="eventTabsContent">
            
            <!-- TAB 1: INFORMACIÓN -->
            <div class="tab-pane fade show active" id="info" role="tabpanel">
                <div class="row">
                    <!-- Información Básica -->
                    <div class="col-md-8">
                        <div class="card info-card">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-info-circle text-primary me-2"></i>
                                    Información Básica
                                </h5>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="info-label">Nombre del Evento</div>
                                        <div class="info-value" id="infoName">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-label">Fecha Inicio</div>
                                        <div class="info-value" id="infoStartDate">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-label">Fecha Fin</div>
                                        <div class="info-value" id="infoEndDate">-</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="info-label">Tipo de Participantes</div>
                                        <div class="info-value" id="infoParticipantType">-</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-label">Estado</div>
                                        <div class="info-value" id="infoStatus">-</div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="info-label">Descripción</div>
                                    <div class="info-value" id="infoDescription">Sin descripción</div>
                                </div>
                                
                                <div class="mb-0">
                                    <div class="info-label">Enlace a Encuesta</div>
                                    <div class="info-value" id="infoSurveyLink">
                                        <span class="text-muted">No configurado</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Instituciones Participantes -->
                        <div class="card info-card">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    <i class="bi bi-building text-primary me-2"></i>
                                    Instituciones Participantes
                                </h5>
                                <div id="institutionsContainer">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botón Enviar Encuesta -->
                        <div class="card info-card" id="surveyCard" style="display: none;">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    <i class="bi bi-envelope-paper text-primary me-2"></i>
                                    Encuesta Post-Evento
                                </h5>
                                <p class="text-muted">
                                    Envía el enlace de la encuesta a todos los participantes inscritos.
                                </p>
                                <button class="btn btn-primary" onclick="sendSurvey()" id="btnSendSurvey">
                                    <i class="bi bi-send me-1"></i>
                                    Enviar Encuesta a Inscritos
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estadísticas y QR -->
                    <div class="col-md-4">
                        <!-- Estadísticas -->
                        <div class="stat-box">
                            <span class="stat-number" id="statRegistrations">0</span>
                            <span class="stat-label">Inscritos</span>
                        </div>
                        
                        <div class="stat-box">
                            <span class="stat-number" id="statAttendance">0</span>
                            <span class="stat-label">Asistencias Registradas</span>
                        </div>
                        
                        <div class="stat-box">
                            <span class="stat-number" id="statSlots">0</span>
                            <span class="stat-label">Franjas</span>
                        </div>
                        
                        <div class="stat-box">
                            <span class="stat-number" id="statGroups">0</span>
                            <span class="stat-label">Grupos</span>
                        </div>
                        
                        <!-- QR Codes -->
                        <div class="card info-card">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-qr-code text-primary me-2"></i>
                                    Códigos QR
                                </h6>
                                <p class="small text-muted">
                                    Genera códigos QR para el registro de asistencia diaria
                                </p>
                                <button class="btn btn-primary btn-sm w-100" onclick="generateQRCodes()">
                                    <i class="bi bi-qr-code me-1"></i>
                                    Generar QR por Día
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB 2: FRANJAS Y GRUPOS -->
            <div class="tab-pane fade" id="slots" role="tabpanel">
                <div class="row mb-3">
                    <div class="col">
                        <h5>Franjas del Evento</h5>
                        <p class="text-muted">
                            Organiza el evento en franjas horarias. Cada franja puede ser una plenaria (todos juntos) o dividirse en grupos.
                        </p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary" onclick="openSlotModal()" id="btnCreateSlot">
                            <i class="bi bi-plus-circle me-1"></i>
                            Nueva Franja
                        </button>
                    </div>
                </div>
                
                <div id="slotsContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
            
            <!-- TAB 3: INSCRIPCIONES -->
            <div class="tab-pane fade" id="registrations" role="tabpanel">
                <div class="row mb-3">
                    <div class="col">
                        <h5>Participantes Inscritos</h5>
                        <p class="text-muted">
                            Lista de todos los participantes inscritos al evento.
                        </p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-success me-2" onclick="exportRegistrations()">
                            <i class="bi bi-file-earmark-excel me-1"></i>
                            Exportar Excel
                        </button>
                        <button class="btn btn-primary" onclick="openRegistrationModal()" id="btnCreateRegistration">
                            <i class="bi bi-person-plus me-1"></i>
                            Inscribir Manualmente
                        </button>
                    </div>
                </div>
                
                <!-- Filtros -->
                <div class="card info-card">
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="searchRegistrations" 
                                    placeholder="Buscar por nombre o documento..."
                                >
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterInstitution">
                                    <option value="">Todas las instituciones</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterRegistrationType">
                                    <option value="">Todos los tipos</option>
                                    <option value="true">Internos</option>
                                    <option value="false">Externos</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="clearRegistrationFilters()">
                                    Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla -->
                <div class="card table-card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Documento</th>
                                        <th>Nombre Completo</th>
                                        <th>Institución</th>
                                        <th>Email</th>
                                        <th>Tipo</th>
                                        <th>Fecha Inscripción</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="registrationsTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB 4: ASISTENCIAS -->
            <div class="tab-pane fade" id="attendance" role="tabpanel">
                <div class="row mb-3">
                    <div class="col">
                        <h5>Registro de Asistencias</h5>
                        <p class="text-muted">
                            Control diario de asistencia de los participantes.
                        </p>
                    </div>
                </div>
                
                <!-- Selector de Fecha -->
                <div class="card info-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label class="form-label">Seleccionar Día</label>
                                <input 
                                    type="date" 
                                    class="form-control" 
                                    id="attendanceDate"
                                    onchange="loadAttendanceByDate()"
                                >
                            </div>
                            <div class="col-md-8 text-end">
                                <div class="stat-box d-inline-block me-2" style="min-width: 150px;">
                                    <span class="stat-number" style="font-size: 1.5rem;" id="dayAttendanceCount">0</span>
                                    <span class="stat-label">Asistencias del Día</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla de Asistencias -->
                <div class="card table-card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Hora</th>
                                        <th>Documento</th>
                                        <th>Nombre</th>
                                        <th>Origen</th>
                                        <th>Grupos Asignados</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <span class="text-muted">Selecciona una fecha para ver las asistencias</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB 5: REPORTES -->
            <div class="tab-pane fade" id="reports" role="tabpanel">
                <div class="row mb-4">
                    <div class="col">
                        <h5>Reportes y Estadísticas</h5>
                        <p class="text-muted">
                            Análisis general del evento, inscripciones y asistencias.
                        </p>
                    </div>
                </div>
                
                <!-- Resumen General -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-box">
                            <span class="stat-number" id="reportTotalRegistrations">0</span>
                            <span class="stat-label">Total Inscritos</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <span class="stat-number" id="reportInternalRegistrations">0</span>
                            <span class="stat-label">Internos</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <span class="stat-number" id="reportExternalRegistrations">0</span>
                            <span class="stat-label">Externos</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <span class="stat-number" id="reportAttendanceRate">0%</span>
                            <span class="stat-label">Tasa Asistencia</span>
                        </div>
                    </div>
                </div>
                
                <!-- Gráficos y Reportes Detallados -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card info-card">
                            <div class="card-body">
                                <h6 class="card-title">Inscripciones por Institución</h6>
                                <div id="chartInstitutions">
                                    <p class="text-muted text-center py-4">
                                        Gráfico en desarrollo
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card info-card">
                            <div class="card-body">
                                <h6 class="card-title">Asistencias por Día</h6>
                                <div id="chartAttendance">
                                    <p class="text-muted text-center py-4">
                                        Gráfico en desarrollo
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="card info-card">
                            <div class="card-body">
                                <h6 class="card-title">Ocupación de Grupos</h6>
                                <div id="groupsOccupancy">
                                    <p class="text-muted text-center py-4">
                                        Tabla en desarrollo
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
    </div>
    
    <!-- Modal: Crear/Editar Franja -->
    <div class="modal fade" id="slotModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--module-primary); color: white;">
                    <h5 class="modal-title">
                        <i class="bi bi-layout-three-columns me-2"></i>
                        <span id="slotModalTitle">Nueva Franja</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="slotForm">
                    <div class="modal-body">
                        <input type="hidden" id="slotId">
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="slotTitle" class="form-label">
                                    Título de la Franja <span class="text-danger">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="slotTitle" 
                                    required
                                    placeholder="Ej: Conferencia Inaugural"
                                >
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="slotType" class="form-label">
                                    Tipo <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="slotType" required onchange="toggleGroupsSection()">
                                    <option value="plenaria">Plenaria (Todos juntos)</option>
                                    <option value="grupos">Con Grupos</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="slotDate" class="form-label">
                                    Fecha <span class="text-danger">*</span>
                                </label>
                                <input 
                                    type="date" 
                                    class="form-control" 
                                    id="slotDate" 
                                    required
                                >
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="slotStartTime" class="form-label">
                                    Hora Inicio <span class="text-danger">*</span>
                                </label>
                                <input 
                                    type="time" 
                                    class="form-control" 
                                    id="slotStartTime" 
                                    required
                                >
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="slotEndTime" class="form-label">
                                    Hora Fin <span class="text-danger">*</span>
                                </label>
                                <input 
                                    type="time" 
                                    class="form-control" 
                                    id="slotEndTime" 
                                    required
                                >
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="slotDescription" class="form-label">
                                Descripción
                            </label>
                            <textarea 
                                class="form-control" 
                                id="slotDescription" 
                                rows="2"
                                placeholder="Descripción opcional de la franja"
                            ></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>
                            Guardar Franja
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // Variables globales
        let eventId = null;
        let currentEvent = null;
        let currentUser = null;
        let isReadOnly = false;
        let registrations = [];
        let slots = [];
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Obtener ID del evento
                const urlParams = new URLSearchParams(window.location.search);
                eventId = urlParams.get('id');
                
                if (!eventId) {
                    showMessage('ID de evento no especificado', 'danger');
                    setTimeout(() => window.location.href = 'events-manage.html', 2000);
                    return;
                }
                
                // Validar acceso
                try {
                    await validatePageAccess('Gestionar eventos');
                } catch (error) {
                    // Si no tiene permiso de gestión, intentar con lectura
                    await validatePageAccess('Ver eventos');
                    isReadOnly = true;
                }
                
                // Obtener sesión
                const session = getStoredSession();
                currentUser = session.user;
                
                // Cargar colores corporativos
                await loadAndApplyBrandColors();
                
                // Cargar evento
                await loadEvent();
                
                // Ocultar botones si es readonly
                if (isReadOnly) {
                    document.getElementById('btnCreateSlot')?.remove();
                    document.getElementById('btnCreateRegistration')?.remove();
                    document.getElementById('btnSendSurvey')?.remove();
                }
                
                console.log('✅ Detalle del evento cargado');
                
            } catch (error) {
                console.error('❌ Error:', error);
                showMessage('Error al cargar el evento: ' + error.message, 'danger');
            }
        });
        
        // ==========================================
        // CARGAR EVENTO
        // ==========================================
        async function loadEvent() {
            try {
                const data = await supabaseRequest(`/events?select=*&event_id=eq.${eventId}`);
                
                if (!data || data.length === 0) {
                    throw new Error('Evento no encontrado');
                }
                
                currentEvent = data[0];
                renderEventInfo();
                await loadEventInstitutions();
                await loadEventStats();
                
                console.log('✅ Evento cargado:', currentEvent.event_name);
                
            } catch (error) {
                console.error('❌ Error cargando evento:', error);
                throw error;
            }
        }
        
        // ==========================================
        // RENDERIZAR INFORMACIÓN DEL EVENTO
        // ==========================================
        function renderEventInfo() {
            const typeLabels = {
                'interno': 'Solo Internos (Workers)',
                'externo': 'Solo Externos',
                'ambos': 'Internos y Externos'
            };
            
            const statusClasses = {
                'activo': 'badge-activo',
                'finalizado': 'badge-finalizado',
                'cancelado': 'badge-cancelado'
            };
            
            const statusLabels = {
                'activo': 'Activo',
                'finalizado': 'Finalizado',
                'cancelado': 'Cancelado'
            };
            
            // Header
            document.getElementById('eventName').textContent = currentEvent.event_name;
            
            const startDate = new Date(currentEvent.event_start_date).toLocaleDateString('es-CO');
            const endDate = new Date(currentEvent.event_end_date).toLocaleDateString('es-CO');
            document.getElementById('eventDates').innerHTML = `
                <i class="bi bi-calendar3 me-1"></i>
                ${startDate} - ${endDate}
            `;
            
            const statusBadge = document.getElementById('eventStatus');
            statusBadge.textContent = statusLabels[currentEvent.event_status];
            statusBadge.className = `badge badge-status ${statusClasses[currentEvent.event_status]}`;
            
            // Tab Información
            document.getElementById('infoName').textContent = currentEvent.event_name;
            document.getElementById('infoStartDate').textContent = startDate;
            document.getElementById('infoEndDate').textContent = endDate;
            document.getElementById('infoParticipantType').textContent = typeLabels[currentEvent.participant_type];
            document.getElementById('infoStatus').textContent = statusLabels[currentEvent.event_status];
            document.getElementById('infoDescription').textContent = currentEvent.event_description || 'Sin descripción';
            
            if (currentEvent.survey_link) {
                document.getElementById('infoSurveyLink').innerHTML = `
                    <a href="${currentEvent.survey_link}" target="_blank" class="text-primary">
                        ${currentEvent.survey_link}
                        <i class="bi bi-box-arrow-up-right ms-1"></i>
                    </a>
                `;
                document.getElementById('surveyCard').style.display = 'block';
            }
        }
        
        // ==========================================
        // CARGAR INSTITUCIONES DEL EVENTO
        // ==========================================
        async function loadEventInstitutions() {
            try {
                const data = await supabaseRequest(
                    `/event_institutions?select=institutions(institution_name,institution_type)&event_id=eq.${eventId}`
                );
                
                const container = document.getElementById('institutionsContainer');
                
                if (data.length === 0) {
                    container.innerHTML = '<p class="text-muted">No hay instituciones asociadas</p>';
                    return;
                }
                
                let html = '';
                data.forEach(ei => {
                    if (ei.institutions) {
                        html += `<span class="institution-badge">${ei.institutions.institution_name}</span>`;
                    }
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('❌ Error cargando instituciones:', error);
                document.getElementById('institutionsContainer').innerHTML = 
                    '<p class="text-danger">Error al cargar instituciones</p>';
            }
        }
        
        // ==========================================
        // CARGAR ESTADÍSTICAS
        // ==========================================
        async function loadEventStats() {
            try {
                // Contar inscripciones
                const regs = await supabaseRequest(
                    `/event_registrations?select=registration_id&event_id=eq.${eventId}&registration_status=eq.activo`
                );
                const totalRegs = regs.length;
                document.getElementById('statRegistrations').textContent = totalRegs;
                document.getElementById('reportTotalRegistrations').textContent = totalRegs;
                
                // Contar asistencias
                const att = await supabaseRequest(
                    `/event_attendance?select=attendance_id&event_id=eq.${eventId}`
                );
                document.getElementById('statAttendance').textContent = att.length;
                
                // Contar franjas
                const slotsData = await supabaseRequest(
                    `/event_slots?select=slot_id&event_id=eq.${eventId}`
                );
                document.getElementById('statSlots').textContent = slotsData.length;
                
                // Contar grupos
                const groupsData = await supabaseRequest(
                    `/event_groups?select=group_id&slot_id=in.(${slotsData.map(s => s.slot_id).join(',')})`
                );
                document.getElementById('statGroups').textContent = groupsData.length || 0;
                
                console.log('✅ Estadísticas cargadas');
                
            } catch (error) {
                console.error('❌ Error cargando estadísticas:', error);
            }
        }
        
        // ==========================================
        // FUNCIONES PLACEHOLDER (A IMPLEMENTAR)
        // ==========================================
        function generateQRCodes() {
            showMessage('Funcionalidad de QR en desarrollo', 'info');
        }
        
        function sendSurvey() {
            if (confirm('¿Enviar encuesta a todos los participantes inscritos?')) {
                showMessage('Funcionalidad de envío de encuestas en desarrollo', 'info');
            }
        }
        
        function openSlotModal() {
            showMessage('Modal de franjas en desarrollo', 'info');
        }
        
        function openRegistrationModal() {
            showMessage('Modal de inscripción manual en desarrollo', 'info');
        }
        
        function exportRegistrations() {
            showMessage('Exportación a Excel en desarrollo', 'info');
        }
        
        function clearRegistrationFilters() {
            document.getElementById('searchRegistrations').value = '';
            document.getElementById('filterInstitution').value = '';
            document.getElementById('filterRegistrationType').value = '';
        }
        
        function loadAttendanceByDate() {
            const date = document.getElementById('attendanceDate').value;
            if (date) {
                showMessage('Carga de asistencias por fecha en desarrollo', 'info');
            }
        }
        
        function toggleGroupsSection() {
            // Para el modal de franjas cuando se implemente
        }
        
        console.log('✅ Detalle del Evento cargado - v26.02.02');
    </script>
</body>
</html>
