<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="26.02.05.14.49">
    <title>Detalle del Evento - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- SheetJS para exportar Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            --module-primary: var(--system-primary-color, #1B365D);
            --module-secondary: var(--system-secondary-color, #667eea);
        }
        
        body {
            background-color: #f8f9fa;
        }
        
        .page-header {
            background: linear-gradient(135deg, var(--module-primary) 0%, var(--module-secondary) 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 16px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .page-title {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .event-dates {
            font-size: 0.95rem;
            opacity: 0.95;
        }
        
        .breadcrumb {
            background: transparent;
            padding: 0;
            margin-bottom: 1rem;
        }
        
        .breadcrumb-item a {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
        }
        
        .breadcrumb-item.active {
            color: white;
        }
        
        .info-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        
        .info-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            color: #2c3e50;
            font-size: 1rem;
        }
        
        .badge-status {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        
        .badge-activo { background-color: #28a745; }
        .badge-finalizado { background-color: #6c757d; }
        .badge-cancelado { background-color: #dc3545; }
        
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }
        
        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 1rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .nav-tabs .nav-link:hover {
            border-bottom-color: var(--module-primary);
            color: var(--module-primary);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--module-primary);
            background: transparent;
            border-bottom-color: var(--module-primary);
        }
        
        .tab-content {
            padding: 2rem 0;
        }
        
        .stat-box {
            text-align: center;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--module-primary);
            display: block;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }
        
        .table-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .table thead th {
            background: var(--module-primary);
            color: white;
            font-weight: 600;
            border: none;
            padding: 1rem;
        }
        
        .slot-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .slot-header {
            background: linear-gradient(135deg, var(--module-primary) 0%, var(--module-secondary) 100%);
            color: white;
            padding: 1rem;
        }
        
        .slot-type-badge {
            background: rgba(255,255,255,0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .group-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .qr-container {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .institution-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: #e9ecef;
            border-radius: 20px;
            margin: 0.25rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="page-header">
        <div class="container-fluid">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="../../dashboard.html">
                            <i class="bi bi-house me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="index.html">Eventos</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="events-manage.html">Gestionar Eventos</a>
                    </li>
                    <li class="breadcrumb-item active">Detalle</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="page-title" id="eventName">
                        <i class="bi bi-calendar-event me-2"></i>
                        Cargando...
                    </h1>
                    <p class="event-dates mb-0" id="eventDates">
                        <i class="bi bi-calendar3 me-1"></i>
                        Cargando fechas...
                    </p>
                </div>
                <div>
                    <span class="badge badge-status" id="eventStatus">Activo</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contenido Principal -->
    <div class="container-fluid">
        
        <!-- Contenedor de Alertas -->
        <div id="alertContainer"></div>
        
        <!-- Tabs de Navegación -->
        <ul class="nav nav-tabs" id="eventTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                    <i class="bi bi-info-circle me-1"></i>
                    Información
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="slots-tab" data-bs-toggle="tab" data-bs-target="#slots" type="button" role="tab">
                    <i class="bi bi-layout-three-columns me-1"></i>
                    Franjas y Grupos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="registrations-tab" data-bs-toggle="tab" data-bs-target="#registrations" type="button" role="tab">
                    <i class="bi bi-people me-1"></i>
                    Inscripciones
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
                    <i class="bi bi-clipboard-check me-1"></i>
                    Asistencias
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
                    <i class="bi bi-graph-up me-1"></i>
                    Reportes
                </button>
            </li>
        </ul>
        
        <!-- Contenido de los Tabs -->
        <div class="tab-content" id="eventTabsContent">
            
            <!-- TAB 1: INFORMACIÓN -->
            <div class="tab-pane fade show active" id="info" role="tabpanel">
                <div class="row">
                    <!-- Información Básica -->
                    <div class="col-md-8">
                        <div class="card info-card">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="bi bi-info-circle text-primary me-2"></i>
                                    Información Básica
                                </h5>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="info-label">Nombre del Evento</div>
                                        <div class="info-value" id="infoName">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-label">Fecha Inicio</div>
                                        <div class="info-value" id="infoStartDate">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-label">Fecha Fin</div>
                                        <div class="info-value" id="infoEndDate">-</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="info-label">Tipo de Participantes</div>
                                        <div class="info-value" id="infoParticipantType">-</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-label">Estado</div>
                                        <div class="info-value" id="infoStatus">-</div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="info-label">Descripción</div>
                                    <div class="info-value" id="infoDescription">Sin descripción</div>
                                </div>
                                
                                <div class="mb-0">
                                    <div class="info-label">Enlace a Encuesta</div>
                                    <div class="info-value" id="infoSurveyLink">
                                        <span class="text-muted">No configurado</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Instituciones Participantes -->
                        <div class="card info-card">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    <i class="bi bi-building text-primary me-2"></i>
                                    Instituciones Participantes
                                </h5>
                                <div id="institutionsContainer">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botón Enviar Encuesta -->
                        <div class="card info-card" id="surveyCard" style="display: none;">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    <i class="bi bi-envelope-paper text-primary me-2"></i>
                                    Encuesta Post-Evento
                                </h5>
                                <p class="text-muted">
                                    Envía el enlace de la encuesta a todos los participantes inscritos.
                                </p>
                                <button class="btn btn-primary" onclick="sendSurvey()" id="btnSendSurvey">
                                    <i class="bi bi-send me-1"></i>
                                    Enviar Encuesta a Inscritos
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estadísticas y QR -->
                    <div class="col-md-4">
                        <div class="stat-box">
                            <span class="stat-number" id="statRegistrations">0</span>
                            <span class="stat-label">Inscritos</span>
                        </div>
                        
                        <div class="stat-box">
                            <span class="stat-number" id="statAttendance">0</span>
                            <span class="stat-label">Asistencias Registradas</span>
                        </div>
                        
                        <div class="stat-box">
                            <span class="stat-number" id="statSlots">0</span>
                            <span class="stat-label">Franjas</span>
                        </div>
                        
                        <div class="stat-box">
                            <span class="stat-number" id="statGroups">0</span>
                            <span class="stat-label">Grupos</span>
                        </div>
                        
                        <div class="card info-card">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-qr-code text-primary me-2"></i>
                                    Códigos QR
                                </h6>
                                
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="generateAttendanceQRs()">
                                        <i class="bi bi-qr-code me-1"></i>
                                        QR de Asistencia
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="generateRegistrationQR()">
                                        <i class="bi bi-qr-code me-1"></i>
                                        QR de Inscripción
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="generateWorkshopsQR()">
                                        <i class="bi bi-qr-code me-1"></i>
                                        QR de Talleres
                                    </button>
                                </div>
                                
                                <p class="small text-muted mt-2 mb-0">
                                    Comparte estos QR para facilitar el acceso
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB 2: FRANJAS Y GRUPOS -->
            <div class="tab-pane fade" id="slots" role="tabpanel">
                <div class="row mb-3">
                    <div class="col">
                        <h5>Franjas del Evento</h5>
                        <p class="text-muted">
                            Organiza el evento en franjas horarias. Cada franja puede ser una plenaria (todos juntos) o dividirse en grupos.
                        </p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary" onclick="openSlotModal()" id="btnCreateSlot">
                            <i class="bi bi-plus-circle me-1"></i>
                            Nueva Franja
                        </button>
                    </div>
                </div>
                
                <div id="slotsContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
            
            <!-- TAB 3: INSCRIPCIONES -->
            <div class="tab-pane fade" id="registrations" role="tabpanel">
                <div class="row mb-3">
                    <div class="col">
                        <h5>Participantes Inscritos</h5>
                        <p class="text-muted">
                            Lista de todos los participantes inscritos al evento.
                        </p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-info me-2" onclick="openImportCSVModal()">
                            <i class="bi bi-file-earmark-arrow-up me-1"></i>
                            Importar CSV
                        </button>
                        <button class="btn btn-success me-2" onclick="exportRegistrations()">
                            <i class="bi bi-file-earmark-excel me-1"></i>
                            Exportar Excel
                        </button>
                        <button class="btn btn-primary" onclick="openRegistrationModal()" id="btnCreateRegistration">
                            <i class="bi bi-person-plus me-1"></i>
                            Inscribir Manualmente
                        </button>
                    </div>
                </div>
                
                <div class="card info-card">
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchRegistrations" placeholder="Buscar por nombre o documento...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterInstitution">
                                    <option value="">Todas las instituciones</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterRegistrationType">
                                    <option value="">Todos los tipos</option>
                                    <option value="true">Internos</option>
                                    <option value="false">Externos</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="clearRegistrationFilters()">
                                    Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card table-card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Documento</th>
                                        <th>Nombre Completo</th>
                                        <th>Institución</th>
                                        <th>Email</th>
                                        <th>Tipo</th>
                                        <th>Fecha Inscripción</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="registrationsTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB 4: ASISTENCIAS -->
            <div class="tab-pane fade" id="attendance" role="tabpanel">
                <div class="row mb-3">
                    <div class="col">
                        <h5>Registro de Asistencias</h5>
                        <p class="text-muted">
                            Control diario de asistencia de los participantes.
                        </p>
                    </div>
                </div>
                
                <div class="card info-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label class="form-label">Seleccionar Día</label>
                                <input type="date" class="form-control" id="attendanceDate" onchange="loadAttendanceByDate()">
                            </div>
                            <div class="col-md-8 text-end">
                                <div class="stat-box d-inline-block me-2" style="min-width: 150px;">
                                    <span class="stat-number" style="font-size: 1.5rem;" id="dayAttendanceCount">0</span>
                                    <span class="stat-label">Asistencias del Día</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card table-card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Hora</th>
                                        <th>Documento</th>
                                        <th>Nombre</th>
                                        <th>Origen</th>
                                        <th>Grupos Asignados</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <span class="text-muted">Selecciona una fecha para ver las asistencias</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB 5: REPORTES -->
            <div class="tab-pane fade" id="reports" role="tabpanel">
                <div class="row mb-4">
                    <div class="col">
                        <h5>Reportes y Estadísticas</h5>
                        <p class="text-muted">
                            Análisis general del evento, inscripciones y asistencias.
                        </p>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-box">
                            <span class="stat-number" id="reportTotalRegistrations">0</span>
                            <span class="stat-label">Total Inscritos</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <span class="stat-number" id="reportInternalRegistrations">0</span>
                            <span class="stat-label">Internos</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <span class="stat-number" id="reportExternalRegistrations">0</span>
                            <span class="stat-label">Externos</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box">
                            <span class="stat-number" id="reportAttendanceRate">0%</span>
                            <span class="stat-label">Tasa Asistencia</span>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card info-card">
                            <div class="card-body">
                                <h6 class="card-title">Inscripciones por Institución</h6>
                                <div id="chartInstitutions">
                                    <p class="text-muted text-center py-4">Gráfico en desarrollo</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card info-card">
                            <div class="card-body">
                                <h6 class="card-title">Asistencias por Día</h6>
                                <div id="chartAttendance">
                                    <p class="text-muted text-center py-4">Gráfico en desarrollo</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="card info-card">
                            <div class="card-body">
                                <h6 class="card-title">Ocupación de Grupos</h6>
                                <div id="groupsOccupancy">
                                    <p class="text-muted text-center py-4">Tabla en desarrollo</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
    </div>
    
    <!-- Modal: Crear/Editar Franja -->
    <div class="modal fade" id="slotModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--module-primary); color: white;">
                    <h5 class="modal-title">
                        <i class="bi bi-layout-three-columns me-2"></i>
                        <span id="slotModalTitle">Nueva Franja</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="slotForm">
                    <div class="modal-body">
                        <input type="hidden" id="slotId">
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="slotTitle" class="form-label">
                                    Título de la Franja <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="slotTitle" required placeholder="Ej: Conferencia Inaugural">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="slotType" class="form-label">
                                    Tipo <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="slotType" required onchange="toggleGroupsSection()">
                                    <option value="plenaria">Plenaria (Todos juntos)</option>
                                    <option value="grupos">Con Talleres</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="slotDate" class="form-label">
                                    Fecha <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="slotDate" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="slotStartTime" class="form-label">
                                    Hora Inicio <span class="text-danger">*</span>
                                </label>
                                <input type="time" class="form-control" id="slotStartTime" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="slotEndTime" class="form-label">
                                    Hora Fin <span class="text-danger">*</span>
                                </label>
                                <input type="time" class="form-control" id="slotEndTime" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="slotDescription" class="form-label">Descripción</label>
                            <textarea class="form-control" id="slotDescription" rows="2" placeholder="Descripción opcional de la franja"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>Guardar Franja
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal: Gestionar Grupos/Talleres de una Franja -->
    <div class="modal fade" id="groupsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--module-primary); color: white;">
                    <h5 class="modal-title">
                        <i class="bi bi-diagram-3 me-2"></i>
                        <span id="groupsModalTitle">Gestionar Talleres/Grupos</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-4">
                        <strong id="currentSlotInfo">Franja seleccionada</strong>
                    </div>
                    
                    <div class="mb-3">
                        <button class="btn btn-primary" onclick="openGroupForm()">
                            <i class="bi bi-plus-circle me-1"></i>
                            Agregar Taller/Grupo
                        </button>
                    </div>
                    
                    <div id="groupFormContainer" style="display: none;">
                        <div class="card mb-3" style="border: 2px solid var(--module-primary);">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <span id="groupFormTitle">Nuevo Taller/Grupo</span>
                                </h6>
                                <form id="groupForm">
                                    <input type="hidden" id="groupId">
                                    
                                    <div class="row">
                                        <div class="col-md-8 mb-3">
                                            <label for="groupTitle" class="form-label">
                                                Nombre del Taller/Grupo <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control" id="groupTitle" required placeholder="Ej: Taller de Innovación">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="groupCapacity" class="form-label">
                                                Capacidad Máxima <span class="text-danger">*</span>
                                            </label>
                                            <input type="number" class="form-control" id="groupCapacity" required min="1" placeholder="30">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-8 mb-3">
                                            <label for="groupLocation" class="form-label">Ubicación/Salón</label>
                                            <input type="text" class="form-control" id="groupLocation" placeholder="Ej: Auditorio Principal, Sala 201">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="groupOrder" class="form-label">Orden</label>
                                            <input type="number" class="form-control" id="groupOrder" min="1" placeholder="1">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="groupDescription" class="form-label">Descripción del Taller</label>
                                        <textarea class="form-control" id="groupDescription" rows="2" placeholder="Descripción del contenido del taller"></textarea>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="groupActive" checked>
                                        <label class="form-check-label" for="groupActive">
                                            Grupo activo (visible para inscripción)
                                        </label>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-save me-1"></i>Guardar Grupo
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="closeGroupForm()">Cancelar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div id="groupsListContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Importar Inscripciones desde CSV -->
    <div class="modal fade" id="importCSVModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--module-primary); color: white;">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-arrow-up me-2"></i>
                        Importar Inscripciones desde CSV
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    
                    <div id="csvStep1">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="bi bi-info-circle me-2"></i>
                                Formato del archivo CSV
                            </h6>
                            <p class="mb-2">El archivo debe contener las siguientes columnas (en este orden):</p>
                            <ol class="mb-2">
                                <li><strong>document</strong> - Número de documento (requerido)</li>
                                <li><strong>full_name</strong> - Nombre completo (requerido)</li>
                                <li><strong>email</strong> - Correo electrónico (requerido)</li>
                                <li><strong>institution</strong> - Nombre de la institución</li>
                                <li><strong>position</strong> - Cargo</li>
                                <li><strong>is_internal</strong> - Es interno: true o false (requerido)</li>
                                <li><strong>dietary_restrictions</strong> - Restricciones alimentarias</li>
                                <li><strong>arrival_method</strong> - Medio de llegada</li>
                            </ol>
                            <p class="mb-0">
                                <strong>Importante:</strong> El CSV debe usar comas (,) como separador y la primera fila debe contener los encabezados.
                            </p>
                        </div>
                        
                        <div class="mb-3">
                            <button class="btn btn-outline-primary" onclick="downloadCSVTemplate()">
                                <i class="bi bi-download me-1"></i>Descargar Plantilla CSV
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <label for="csvFileInput" class="form-label"><strong>Seleccionar archivo CSV</strong></label>
                            <input type="file" class="form-control" id="csvFileInput" accept=".csv" onchange="handleCSVFile(event)">
                        </div>
                    </div>
                    
                    <div id="csvStep2" style="display: none;">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Archivo cargado correctamente</strong>
                            <span id="csvRowCount"></span>
                        </div>
                        
                        <h6 class="mb-3">Vista Previa de los Datos:</h6>
                        
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>#</th>
                                        <th>Documento</th>
                                        <th>Nombre</th>
                                        <th>Email</th>
                                        <th>Institución</th>
                                        <th>Cargo</th>
                                        <th>Interno</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="csvPreviewBody"></tbody>
                            </table>
                        </div>
                        
                        <div id="csvErrors" class="alert alert-warning mt-3" style="display: none;">
                            <h6 class="alert-heading">
                                <i class="bi bi-exclamation-triangle me-2"></i>Advertencias
                            </h6>
                            <ul id="csvErrorsList" class="mb-0"></ul>
                        </div>
                    </div>
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnImportCSV" onclick="importCSVData()" style="display: none;">
                        <i class="bi bi-upload me-1"></i>Importar <span id="importCount"></span> Inscripciones
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Inscripción Manual -->
    <div class="modal fade" id="registrationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--module-primary); color: white;">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus me-2"></i>Inscribir Participante Manualmente
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="manualRegistrationForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="manualDocument" class="form-label">Documento <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="manualDocument" required placeholder="Número de documento">
                            </div>
                            <div class="col-md-6">
                                <label for="manualFullName" class="form-label">Nombre Completo <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="manualFullName" required placeholder="Nombre completo">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="manualEmail" class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="manualEmail" required placeholder="correo@ejemplo.com">
                            </div>
                            <div class="col-md-6">
                                <label for="manualInstitution" class="form-label">Institución</label>
                                <select class="form-select" id="manualInstitution">
                                    <option value="">Sin institución</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="manualPosition" class="form-label">Cargo</label>
                                <input type="text" class="form-control" id="manualPosition" placeholder="Ej: Docente">
                            </div>
                            <div class="col-md-6">
                                <label for="manualIsInternal" class="form-label">Tipo de Participante <span class="text-danger">*</span></label>
                                <select class="form-select" id="manualIsInternal" required>
                                    <option value="false">Externo</option>
                                    <option value="true">Interno (Trabajador)</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="manualArrivalMethod" class="form-label">Medio de Llegada</label>
                                <select class="form-select" id="manualArrivalMethod">
                                    <option value="">Seleccionar...</option>
                                    <option value="Transporte público">Transporte público</option>
                                    <option value="Vehículo propio">Vehículo propio</option>
                                    <option value="Bicicleta">Bicicleta</option>
                                    <option value="A pie">A pie</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="manualDietaryRestrictions" class="form-label">Restricciones Alimentarias</label>
                                <input type="text" class="form-control" id="manualDietaryRestrictions" placeholder="Ej: Vegetariano, Ninguna">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveManualRegistration()">
                        <i class="bi bi-save me-1"></i>Guardar Inscripción
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Detalle de Inscripción -->
    <div class="modal fade" id="registrationDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--module-primary); color: white;">
                    <h5 class="modal-title">
                        <i class="bi bi-person-badge me-2"></i>Detalle de Inscripción
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="registrationDetailContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Códigos QR para Asistencia -->
    <div class="modal fade" id="qrCodesModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--module-primary); color: white;">
                    <h5 class="modal-title">
                        <i class="bi bi-qr-code me-2"></i>Códigos QR para Registro de Asistencia
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>¿Cómo funciona?</h6>
                        <p class="mb-2">
                            Cada día del evento tiene un código QR único. Los participantes pueden escanear el QR 
                            con su celular para registrar su asistencia de ese día.
                        </p>
                        <ul class="mb-0">
                            <li>Imprime o proyecta el QR del día</li>
                            <li>Los participantes escanean con su celular</li>
                            <li>El sistema registra automáticamente su asistencia</li>
                            <li>Previene registros duplicados del mismo día</li>
                        </ul>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col">
                            <button class="btn btn-primary me-2" onclick="printAllQRCodes()">
                                <i class="bi bi-printer me-1"></i>Imprimir Todos
                            </button>
                            <button class="btn btn-outline-primary" onclick="downloadAllQRCodes()">
                                <i class="bi bi-download me-1"></i>Descargar Todos
                            </button>
                        </div>
                    </div>
                    
                    <div id="qrCodesContainer" class="row g-4">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Generando códigos QR...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: QR de Inscripción al Evento -->
    <div class="modal fade" id="qrRegistrationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--module-primary); color: white;">
                    <h5 class="modal-title"><i class="bi bi-qr-code me-2"></i>Código QR - Inscripción al Evento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>¿Para qué sirve?</h6>
                        <p class="mb-0">
                            Comparte este código QR para que las personas se inscriban directamente al evento. 
                            Al escanearlo, accederán al formulario completo de inscripción donde también podrán seleccionar sus talleres.
                        </p>
                    </div>
                    <div class="row">
                        <div class="col-md-6 text-center">
                            <h6 class="mb-3">Código QR</h6>
                            <div id="qrRegistrationCode" class="d-flex justify-content-center mb-3"></div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="printRegistrationQR()"><i class="bi bi-printer me-1"></i>Imprimir</button>
                                <button class="btn btn-outline-primary" onclick="downloadRegistrationQR()"><i class="bi bi-download me-1"></i>Descargar PNG</button>
                                <button class="btn btn-outline-secondary" onclick="copyRegistrationURL()"><i class="bi bi-link me-1"></i>Copiar URL</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Instrucciones</h6>
                            <div class="alert alert-light">
                                <ol class="mb-0">
                                    <li class="mb-2">Imprime o proyecta este código QR</li>
                                    <li class="mb-2">Los interesados escanean con su celular</li>
                                    <li class="mb-2">Completan el formulario de inscripción</li>
                                    <li class="mb-0">Seleccionan talleres (si aplica)</li>
                                </ol>
                            </div>
                            <div class="alert alert-warning">
                                <small><i class="bi bi-exclamation-triangle me-1"></i><strong>Importante:</strong> Este QR permite inscripciones hasta que el evento termine.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: QR de Gestión de Talleres -->
    <div class="modal fade" id="qrWorkshopsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--module-primary); color: white;">
                    <h5 class="modal-title"><i class="bi bi-qr-code me-2"></i>Código QR - Gestión de Talleres</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>¿Para qué sirve?</h6>
                        <p class="mb-0">
                            Comparte este código QR para que los participantes <strong>ya inscritos</strong> puedan gestionar 
                            su selección de talleres. Podrán ver a qué talleres están inscritos y cambiar su selección si lo desean.
                        </p>
                    </div>
                    <div class="row">
                        <div class="col-md-6 text-center">
                            <h6 class="mb-3">Código QR</h6>
                            <div id="qrWorkshopsCode" class="d-flex justify-content-center mb-3"></div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="printWorkshopsQR()"><i class="bi bi-printer me-1"></i>Imprimir</button>
                                <button class="btn btn-outline-primary" onclick="downloadWorkshopsQR()"><i class="bi bi-download me-1"></i>Descargar PNG</button>
                                <button class="btn btn-outline-secondary" onclick="copyWorkshopsURL()"><i class="bi bi-link me-1"></i>Copiar URL</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Instrucciones</h6>
                            <div class="alert alert-light">
                                <ol class="mb-0">
                                    <li class="mb-2">Participante escanea el QR</li>
                                    <li class="mb-2">Ingresa su documento de identidad</li>
                                    <li class="mb-2">Ve los talleres en los que está inscrito</li>
                                    <li class="mb-0">Puede cambiar su selección (si hay cupo)</li>
                                </ol>
                            </div>
                            <div class="alert alert-warning">
                                <small><i class="bi bi-exclamation-triangle me-1"></i><strong>Importante:</strong> Solo funciona para participantes ya inscritos al evento.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script>
        // Variables globales
        let eventId = null;
        let currentEvent = null;
        let currentUser = null;
        let isReadOnly = false;
        let registrations = [];
        let slots = [];
        let groups = [];
        let allInstitutions = [];
        let csvData = [];
        let slotModal = null;
        let groupModal = null;
        let importCSVModal = null;
        let qrCodesModal = null;
        let qrRegistrationModal = null;
        let qrWorkshopsModal = null;
        let currentSlotId = null;
        
        // ==========================================
        // HELPER: Parsear fecha como hora local (Colombia)
        // Evita el desfase de timezone cuando Supabase
        // devuelve fechas tipo DATE (YYYY-MM-DD) sin hora.
        // ==========================================
        function parseLocalDate(dateStr) {
            if (!dateStr) return null;
            if (dateStr instanceof Date) return dateStr;
            const str = dateStr.toString();
            // Para formato YYYY-MM-DD (sin hora), parsear como hora local
            if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
                const [year, month, day] = str.split('-').map(Number);
                return new Date(year, month - 1, day);
            }
            // Para otros formatos (con hora/timezone), usar parsing estándar
            return new Date(dateStr);
        }
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                eventId = urlParams.get('id');
                
                if (!eventId) {
                    showMessage('ID de evento no especificado', 'danger');
                    setTimeout(() => window.location.href = 'events-manage.html', 2000);
                    return;
                }
                
                try {
                    await validatePageAccess('Gestionar eventos');
                } catch (error) {
                    await validatePageAccess('Ver eventos');
                    isReadOnly = true;
                }
                
                const session = getStoredSession();
                currentUser = session.user;
                
                await loadAndApplyBrandColors();
                
                slotModal = new bootstrap.Modal(document.getElementById('slotModal'));
                groupModal = new bootstrap.Modal(document.getElementById('groupsModal'));
                importCSVModal = new bootstrap.Modal(document.getElementById('importCSVModal'));
                qrCodesModal = new bootstrap.Modal(document.getElementById('qrCodesModal'));
                qrRegistrationModal = new bootstrap.Modal(document.getElementById('qrRegistrationModal'));
                qrWorkshopsModal = new bootstrap.Modal(document.getElementById('qrWorkshopsModal'));
                
                document.getElementById('slotForm').addEventListener('submit', handleSaveSlot);
                document.getElementById('groupForm').addEventListener('submit', handleSaveGroup);
                
                await loadAllInstitutions();
                await loadEvent();
                
                if (isReadOnly) {
                    document.getElementById('btnCreateSlot')?.remove();
                    document.getElementById('btnCreateRegistration')?.remove();
                    document.getElementById('btnSendSurvey')?.remove();
                }
                
                document.getElementById('slots-tab').addEventListener('shown.bs.tab', function() {
                    if (slots.length === 0) loadSlots();
                });
                
                document.getElementById('registrations-tab').addEventListener('shown.bs.tab', function() {
                    if (registrations.length === 0) loadRegistrations();
                });
                
                document.getElementById('attendance-tab').addEventListener('shown.bs.tab', function() {
                    initAttendanceTab();
                });
                
                document.getElementById('reports-tab').addEventListener('shown.bs.tab', function() {
                    loadReports();
                });
                
                document.getElementById('searchRegistrations').addEventListener('input', filterRegistrations);
                document.getElementById('filterInstitution').addEventListener('change', filterRegistrations);
                document.getElementById('filterRegistrationType').addEventListener('change', filterRegistrations);
                
                console.log('✅ Detalle del evento cargado');
                
            } catch (error) {
                console.error('❌ Error:', error);
                showMessage('Error al cargar el evento: ' + error.message, 'danger');
            }
        });
        
        // ==========================================
        // CARGAR EVENTO
        // ==========================================
        async function loadEvent() {
            try {
                const data = await supabaseRequest(`/events?select=*&event_id=eq.${eventId}`);
                if (!data || data.length === 0) throw new Error('Evento no encontrado');
                currentEvent = data[0];
                renderEventInfo();
                await loadEventInstitutions();
                await loadEventStats();
                console.log('✅ Evento cargado:', currentEvent.event_name);
            } catch (error) {
                console.error('❌ Error cargando evento:', error);
                throw error;
            }
        }
        
        // ==========================================
        // RENDERIZAR INFORMACIÓN DEL EVENTO
        // ==========================================
        function renderEventInfo() {
            const typeLabels = {
                'interno': 'Solo Internos (Workers)',
                'externo': 'Solo Externos',
                'ambos': 'Internos y Externos'
            };
            const statusClasses = {
                'activo': 'badge-activo',
                'finalizado': 'badge-finalizado',
                'cancelado': 'badge-cancelado'
            };
            const statusLabels = {
                'activo': 'Activo',
                'finalizado': 'Finalizado',
                'cancelado': 'Cancelado'
            };
            
            document.getElementById('eventName').textContent = currentEvent.event_name;
            
            // FIX: Usar parseLocalDate para evitar desfase de timezone
            const startDate = parseLocalDate(currentEvent.event_start_date).toLocaleDateString('es-CO');
            const endDate = parseLocalDate(currentEvent.event_end_date).toLocaleDateString('es-CO');
            document.getElementById('eventDates').innerHTML = `
                <i class="bi bi-calendar3 me-1"></i>
                ${startDate} - ${endDate}
            `;
            
            const statusBadge = document.getElementById('eventStatus');
            statusBadge.textContent = statusLabels[currentEvent.event_status];
            statusBadge.className = `badge badge-status ${statusClasses[currentEvent.event_status]}`;
            
            document.getElementById('infoName').textContent = currentEvent.event_name;
            document.getElementById('infoStartDate').textContent = startDate;
            document.getElementById('infoEndDate').textContent = endDate;
            document.getElementById('infoParticipantType').textContent = typeLabels[currentEvent.participant_type];
            document.getElementById('infoStatus').textContent = statusLabels[currentEvent.event_status];
            document.getElementById('infoDescription').textContent = currentEvent.event_description || 'Sin descripción';
            
            if (currentEvent.survey_link) {
                document.getElementById('infoSurveyLink').innerHTML = `
                    <a href="${currentEvent.survey_link}" target="_blank" class="text-primary">
                        ${currentEvent.survey_link}
                        <i class="bi bi-box-arrow-up-right ms-1"></i>
                    </a>
                `;
                document.getElementById('surveyCard').style.display = 'block';
            }
        }
        
        // ==========================================
        // CARGAR INSTITUCIONES DEL EVENTO
        // ==========================================
        async function loadEventInstitutions() {
            try {
                const data = await supabaseRequest(
                    `/event_institutions?select=institutions(institution_name,institution_type)&event_id=eq.${eventId}`
                );
                const container = document.getElementById('institutionsContainer');
                if (data.length === 0) {
                    container.innerHTML = '<p class="text-muted">No hay instituciones asociadas</p>';
                    return;
                }
                let html = '';
                data.forEach(ei => {
                    if (ei.institutions) {
                        html += `<span class="institution-badge">${ei.institutions.institution_name}</span>`;
                    }
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('❌ Error cargando instituciones:', error);
                document.getElementById('institutionsContainer').innerHTML = 
                    '<p class="text-danger">Error al cargar instituciones</p>';
            }
        }
        
        // ==========================================
        // CARGAR ESTADÍSTICAS
        // ==========================================
        async function loadEventStats() {
            try {
                const regs = await supabaseRequest(
                    `/event_registrations?select=registration_id&event_id=eq.${eventId}&registration_status=eq.activo`
                );
                const totalRegs = regs.length;
                document.getElementById('statRegistrations').textContent = totalRegs;
                document.getElementById('reportTotalRegistrations').textContent = totalRegs;
                
                const att = await supabaseRequest(
                    `/event_attendance?select=attendance_id&event_id=eq.${eventId}`
                );
                document.getElementById('statAttendance').textContent = att.length;
                
                const slotsData = await supabaseRequest(
                    `/event_slots?select=slot_id&event_id=eq.${eventId}`
                );
                document.getElementById('statSlots').textContent = slotsData.length;
                
                const groupsData = await supabaseRequest(
                    `/event_groups?select=group_id&slot_id=in.(${slotsData.map(s => s.slot_id).join(',')})`
                );
                document.getElementById('statGroups').textContent = groupsData.length || 0;
                
                console.log('✅ Estadísticas cargadas');
            } catch (error) {
                console.error('❌ Error cargando estadísticas:', error);
            }
        }
        
        // ==========================================
        // ABRIR MODAL DE FRANJA
        // ==========================================
        function openSlotModal(slotId = null) {
            document.getElementById('slotModalTitle').textContent = slotId ? 'Editar Franja' : 'Nueva Franja';
            document.getElementById('slotForm').reset();
            document.getElementById('slotId').value = slotId || '';
            
            if (currentEvent) {
                document.getElementById('slotDate').min = currentEvent.event_start_date;
                document.getElementById('slotDate').max = currentEvent.event_end_date;
                if (!slotId) {
                    document.getElementById('slotDate').value = currentEvent.event_start_date;
                }
            }
            
            if (slotId) loadSlotData(slotId);
            slotModal.show();
        }
        
        async function loadSlotData(slotId) {
            try {
                const slot = slots.find(s => s.slot_id === slotId);
                if (!slot) { showMessage('Franja no encontrada', 'warning'); return; }
                document.getElementById('slotTitle').value = slot.slot_title || '';
                document.getElementById('slotType').value = slot.slot_type || 'plenaria';
                document.getElementById('slotDate').value = slot.slot_date || '';
                document.getElementById('slotStartTime').value = slot.slot_start_time || '';
                document.getElementById('slotEndTime').value = slot.slot_end_time || '';
                document.getElementById('slotDescription').value = slot.slot_description || '';
            } catch (error) {
                console.error('❌ Error cargando franja:', error);
                showMessage('Error al cargar la franja', 'danger');
            }
        }
        
        // ==========================================
        // GUARDAR FRANJA
        // ==========================================
        async function handleSaveSlot(e) {
            e.preventDefault();
            const slotId = document.getElementById('slotId').value;
            const slotData = {
                event_id: eventId,
                slot_title: document.getElementById('slotTitle').value.trim(),
                slot_type: document.getElementById('slotType').value,
                slot_date: document.getElementById('slotDate').value,
                slot_start_time: document.getElementById('slotStartTime').value,
                slot_end_time: document.getElementById('slotEndTime').value,
                slot_description: document.getElementById('slotDescription').value.trim() || null
            };
            try {
                if (slotId) {
                    await supabaseRequest(`/event_slots?slot_id=eq.${slotId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({...slotData, updated_at: new Date().toISOString()})
                    });
                    showMessage('Franja actualizada exitosamente', 'success');
                } else {
                    await supabaseRequest('/event_slots', {
                        method: 'POST',
                        body: JSON.stringify(slotData)
                    });
                    showMessage('Franja creada exitosamente', 'success');
                }
                slotModal.hide();
                await loadSlots();
                await loadEventStats();
            } catch (error) {
                console.error('❌ Error:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // CARGAR FRANJAS
        // ==========================================
        async function loadSlots() {
            try {
                const data = await supabaseRequest(
                    `/event_slots?select=*&event_id=eq.${eventId}&order=slot_date.asc,slot_start_time.asc`
                );
                slots = data || [];
                renderSlots();
                console.log(`✅ ${slots.length} franjas cargadas`);
            } catch (error) {
                console.error('❌ Error cargando franjas:', error);
                renderEmptySlots();
            }
        }
        
        // ==========================================
        // RENDERIZAR FRANJAS
        // ==========================================
        function renderSlots() {
            const container = document.getElementById('slotsContainer');
            if (slots.length === 0) { renderEmptySlots(); return; }
            
            let html = '';
            slots.forEach(slot => {
                // FIX: Usar parseLocalDate para evitar desfase de timezone
                const date = parseLocalDate(slot.slot_date).toLocaleDateString('es-CO', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const typeLabel = slot.slot_type === 'plenaria' ? 'Plenaria (Todos juntos)' : 'Con Grupos';
                
                html += `
                    <div class="slot-card">
                        <div class="slot-header">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-2">${slot.slot_title}</h6>
                                    <div class="mb-1"><i class="bi bi-calendar3 me-1"></i>${date}</div>
                                    <div><i class="bi bi-clock me-1"></i>${slot.slot_start_time} - ${slot.slot_end_time}</div>
                                </div>
                                <div>
                                    <span class="slot-type-badge">
                                        <i class="bi bi-${slot.slot_type === 'plenaria' ? 'people' : 'diagram-3'} me-1"></i>
                                        ${typeLabel}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            ${slot.slot_description ? `<p class="text-muted mb-3">${slot.slot_description}</p>` : ''}
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    ${slot.slot_type === 'grupos' ? `
                                        <button class="btn btn-sm btn-outline-primary me-1" onclick="manageGroups('${slot.slot_id}')">
                                            <i class="bi bi-diagram-3 me-1"></i>Gestionar Grupos
                                        </button>
                                    ` : ''}
                                </div>
                                <div>
                                    ${!isReadOnly ? `
                                        <button class="btn btn-sm btn-outline-primary me-1" onclick="openSlotModal('${slot.slot_id}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteSlot('${slot.slot_id}', '${slot.slot_title}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function renderEmptySlots() {
            const container = document.getElementById('slotsContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-layout-three-columns"></i>
                    <h5>No hay franjas creadas</h5>
                    <p class="text-muted">Las franjas permiten organizar el evento en bloques horarios</p>
                    ${!isReadOnly ? `
                        <button class="btn btn-primary" onclick="openSlotModal()">
                            <i class="bi bi-plus-circle me-2"></i>Crear Primera Franja
                        </button>
                    ` : ''}
                </div>
            `;
        }
        
        function confirmDeleteSlot(slotId, slotTitle) {
            if (confirm(`¿Estás seguro de eliminar la franja "${slotTitle}"?\n\nEsto eliminará todos los grupos asociados.`)) {
                deleteSlot(slotId);
            }
        }
        
        async function deleteSlot(slotId) {
            try {
                await supabaseRequest(`/event_slots?slot_id=eq.${slotId}`, { method: 'DELETE' });
                showMessage('Franja eliminada exitosamente', 'success');
                await loadSlots();
                await loadEventStats();
            } catch (error) {
                console.error('❌ Error:', error);
                showMessage('Error al eliminar: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // GESTIONAR GRUPOS DE UNA FRANJA
        // ==========================================
        async function manageGroups(slotId) {
            currentSlotId = slotId;
            const slot = slots.find(s => s.slot_id === slotId);
            if (!slot) { showMessage('Franja no encontrada', 'warning'); return; }
            
            document.getElementById('groupsModalTitle').textContent = `Gestionar Talleres/Grupos: ${slot.slot_title}`;
            
            // FIX: Usar parseLocalDate para evitar desfase de timezone
            const date = parseLocalDate(slot.slot_date).toLocaleDateString('es-CO');
            document.getElementById('currentSlotInfo').innerHTML = `
                <i class="bi bi-calendar3 me-2"></i>
                <strong>${slot.slot_title}</strong> - ${date} de ${slot.slot_start_time} a ${slot.slot_end_time}
            `;
            
            await loadGroups(slotId);
            groupModal.show();
        }
        
        async function loadGroups(slotId) {
            try {
                const data = await supabaseRequest(
                    `/event_groups?select=*&slot_id=eq.${slotId}&order=group_order.asc,group_title.asc`
                );
                groups = data || [];
                renderGroupsList();
                console.log(`✅ ${groups.length} grupos cargados`);
            } catch (error) {
                console.error('❌ Error cargando grupos:', error);
                renderEmptyGroups();
            }
        }
        
        // ==========================================
        // RENDERIZAR LISTA DE GRUPOS
        // ==========================================
        function renderGroupsList() {
            const container = document.getElementById('groupsListContainer');
            if (groups.length === 0) { renderEmptyGroups(); return; }
            
            let html = '<div class="row g-3">';
            groups.forEach(group => {
                // FIX: Usar group_capacity (nombre correcto del campo en BD)
                const occupancyPercentage = (group.current_enrollment / group.group_capacity) * 100;
                const spotsLeft = group.group_capacity - group.current_enrollment;
                
                let statusClass = 'success';
                let statusText = 'Disponible';
                if (occupancyPercentage >= 100) {
                    statusClass = 'danger';
                    statusText = 'Lleno';
                } else if (occupancyPercentage >= 80) {
                    statusClass = 'warning';
                    statusText = 'Casi lleno';
                }
                
                html += `
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${group.group_title}</h6>
                                    ${group.is_active ? 
                                        '<span class="badge bg-success">Activo</span>' : 
                                        '<span class="badge bg-secondary">Inactivo</span>'
                                    }
                                </div>
                                ${group.group_description ? `<p class="text-muted small mb-2">${group.group_description}</p>` : ''}
                                ${group.group_location ? `<div class="small mb-2"><i class="bi bi-geo-alt me-1"></i>${group.group_location}</div>` : ''}
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Ocupación</span>
                                        <span><strong>${group.current_enrollment}/${group.group_capacity}</strong></span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-${statusClass}" role="progressbar" style="width: ${occupancyPercentage}%"></div>
                                    </div>
                                    <small class="text-${statusClass}">
                                        ${statusText} - ${spotsLeft} cupos disponibles
                                    </small>
                                </div>
                                ${!isReadOnly ? `
                                    <div class="d-flex gap-1 mt-3">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editGroup('${group.group_id}')">
                                            <i class="bi bi-pencil me-1"></i>Editar
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteGroup('${group.group_id}', '${group.group_title}')">
                                            <i class="bi bi-trash me-1"></i>Eliminar
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderEmptyGroups() {
            const container = document.getElementById('groupsListContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-diagram-3"></i>
                    <h5>No hay talleres/grupos creados</h5>
                    <p class="text-muted">Crea talleres para que los participantes puedan inscribirse</p>
                    ${!isReadOnly ? `
                        <button class="btn btn-primary" onclick="openGroupForm()">
                            <i class="bi bi-plus-circle me-2"></i>Crear Primer Taller
                        </button>
                    ` : ''}
                </div>
            `;
        }
        
        // ==========================================
        // FORMULARIO DE GRUPO
        // ==========================================
        function openGroupForm(groupId = null) {
            document.getElementById('groupFormTitle').textContent = groupId ? 'Editar Taller/Grupo' : 'Nuevo Taller/Grupo';
            document.getElementById('groupForm').reset();
            document.getElementById('groupId').value = groupId || '';
            document.getElementById('groupActive').checked = true;
            
            if (groupId) {
                const group = groups.find(g => g.group_id === groupId);
                if (group) {
                    document.getElementById('groupTitle').value = group.group_title || '';
                    document.getElementById('groupCapacity').value = group.group_capacity || '';
                    document.getElementById('groupLocation').value = group.group_location || '';
                    document.getElementById('groupDescription').value = group.group_description || '';
                    document.getElementById('groupOrder').value = group.group_order || '';
                    document.getElementById('groupActive').checked = group.is_active;
                }
            }
            document.getElementById('groupFormContainer').style.display = 'block';
        }
        
        function closeGroupForm() {
            document.getElementById('groupFormContainer').style.display = 'none';
            document.getElementById('groupForm').reset();
        }
        
        function editGroup(groupId) { openGroupForm(groupId); }
        
        async function handleSaveGroup(e) {
            e.preventDefault();
            const groupId = document.getElementById('groupId').value;
            const groupData = {
                slot_id: currentSlotId,
                group_title: document.getElementById('groupTitle').value.trim(),
                group_capacity: parseInt(document.getElementById('groupCapacity').value),
                group_location: document.getElementById('groupLocation').value.trim() || null,
                group_description: document.getElementById('groupDescription').value.trim() || null,
                group_order: parseInt(document.getElementById('groupOrder').value) || null,
                is_active: document.getElementById('groupActive').checked
            };
            try {
                if (groupId) {
                    await supabaseRequest(`/event_groups?group_id=eq.${groupId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({...groupData, updated_at: new Date().toISOString()})
                    });
                    showMessage('Taller actualizado exitosamente', 'success');
                } else {
                    await supabaseRequest('/event_groups', {
                        method: 'POST',
                        body: JSON.stringify(groupData)
                    });
                    showMessage('Taller creado exitosamente', 'success');
                }
                closeGroupForm();
                await loadGroups(currentSlotId);
                await loadEventStats();
            } catch (error) {
                console.error('❌ Error:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
            }
        }
        
        function confirmDeleteGroup(groupId, groupTitle) {
            if (confirm(`¿Estás seguro de eliminar el taller "${groupTitle}"?\n\nEsto eliminará todas las inscripciones a este taller.`)) {
                deleteGroup(groupId);
            }
        }
        
        async function deleteGroup(groupId) {
            try {
                await supabaseRequest(`/event_groups?group_id=eq.${groupId}`, { method: 'DELETE' });
                showMessage('Taller eliminado exitosamente', 'success');
                await loadGroups(currentSlotId);
                await loadEventStats();
            } catch (error) {
                console.error('❌ Error:', error);
                showMessage('Error al eliminar: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // GENERAR CÓDIGOS QR DE ASISTENCIA
        // ==========================================
        function generateAttendanceQRs() {
            qrCodesModal.show();
            setTimeout(() => { renderQRCodes(); }, 500);
        }
        
        function generateRegistrationQR() {
            qrRegistrationModal.show();
            setTimeout(() => {
                const baseUrl = window.location.origin;
                const registrationUrl = `${baseUrl}/modules/events/event-public-register.html?event=${eventId}`;
                const qrContainer = document.getElementById('qrRegistrationCode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: registrationUrl, width: 250, height: 250,
                    colorDark: "#000000", colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }, 300);
        }
        
        function generateWorkshopsQR() {
            qrWorkshopsModal.show();
            setTimeout(() => {
                const baseUrl = window.location.origin;
                const workshopsUrl = `${baseUrl}/modules/events/event-public-workshops.html?event=${eventId}`;
                const qrContainer = document.getElementById('qrWorkshopsCode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: workshopsUrl, width: 250, height: 250,
                    colorDark: "#000000", colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }, 300);
        }
        
        // ==========================================
        // FUNCIONES DE QR DE INSCRIPCIÓN
        // ==========================================
        function printRegistrationQR() {
            const canvas = document.getElementById('qrRegistrationCode').querySelector('canvas');
            if (!canvas) { showMessage('Error al obtener el código QR', 'danger'); return; }
            const printWindow = window.open('', '', 'width=600,height=600');
            printWindow.document.write(`<html><head><title>QR - Inscripción al Evento</title>
                <style>body{font-family:Arial,sans-serif;text-align:center;padding:20px}h1{color:#1B365D;margin-bottom:10px}h2{color:#666;font-size:18px;margin-bottom:30px}.qr-container{margin:30px auto}.instructions{margin-top:30px;padding:20px;background:#f8f9fa;border-radius:8px;max-width:500px;margin-left:auto;margin-right:auto}</style>
                </head><body><h1>${currentEvent.event_name}</h1><h2>Inscripción al Evento</h2>
                <div class="qr-container"><img src="${canvas.toDataURL()}" style="width:350px;height:350px;"></div>
                <div class="instructions"><p><strong>Instrucciones:</strong></p><p>Escanea este código QR para inscribirte al evento y seleccionar tus talleres</p></div></body></html>`);
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
        }
        
        function downloadRegistrationQR() {
            const canvas = document.getElementById('qrRegistrationCode').querySelector('canvas');
            if (!canvas) { showMessage('Error al obtener el código QR', 'danger'); return; }
            const link = document.createElement('a');
            link.download = `QR_Inscripcion_${currentEvent.event_name.replace(/ /g, '_')}.png`;
            link.href = canvas.toDataURL();
            link.click();
            showMessage('Código QR descargado', 'success');
        }
        
        function copyRegistrationURL() {
            const url = `${window.location.origin}/modules/events/event-public-register.html?event=${eventId}`;
            navigator.clipboard.writeText(url).then(() => showMessage('URL copiada al portapapeles', 'success'))
                .catch(() => showMessage('No se pudo copiar la URL', 'warning'));
        }
        
        // ==========================================
        // FUNCIONES DE QR DE TALLERES
        // ==========================================
        function printWorkshopsQR() {
            const canvas = document.getElementById('qrWorkshopsCode').querySelector('canvas');
            if (!canvas) { showMessage('Error al obtener el código QR', 'danger'); return; }
            const printWindow = window.open('', '', 'width=600,height=600');
            printWindow.document.write(`<html><head><title>QR - Gestión de Talleres</title>
                <style>body{font-family:Arial,sans-serif;text-align:center;padding:20px}h1{color:#1B365D;margin-bottom:10px}h2{color:#666;font-size:18px;margin-bottom:30px}.qr-container{margin:30px auto}.instructions{margin-top:30px;padding:20px;background:#f8f9fa;border-radius:8px;max-width:500px;margin-left:auto;margin-right:auto}</style>
                </head><body><h1>${currentEvent.event_name}</h1><h2>Gestión de Talleres</h2>
                <div class="qr-container"><img src="${canvas.toDataURL()}" style="width:350px;height:350px;"></div>
                <div class="instructions"><p><strong>Instrucciones:</strong></p><p>Escanea este código QR para ver y modificar tu inscripción a talleres</p>
                <p class="small" style="color:#666;margin-top:10px;">(Solo para participantes ya inscritos)</p></div></body></html>`);
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
        }
        
        function downloadWorkshopsQR() {
            const canvas = document.getElementById('qrWorkshopsCode').querySelector('canvas');
            if (!canvas) { showMessage('Error al obtener el código QR', 'danger'); return; }
            const link = document.createElement('a');
            link.download = `QR_Talleres_${currentEvent.event_name.replace(/ /g, '_')}.png`;
            link.href = canvas.toDataURL();
            link.click();
            showMessage('Código QR descargado', 'success');
        }
        
        function copyWorkshopsURL() {
            const url = `${window.location.origin}/modules/events/event-public-workshops.html?event=${eventId}`;
            navigator.clipboard.writeText(url).then(() => showMessage('URL copiada al portapapeles', 'success'))
                .catch(() => showMessage('No se pudo copiar la URL', 'warning'));
        }
        
        // ==========================================
        // RENDERIZAR CÓDIGOS QR DE ASISTENCIA
        // ==========================================
        function renderQRCodes() {
            const container = document.getElementById('qrCodesContainer');
            
            // FIX: Usar parseLocalDate para evitar desfase de timezone
            const startDate = parseLocalDate(currentEvent.event_start_date);
            const endDate = parseLocalDate(currentEvent.event_end_date);
            const days = [];
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                days.push(new Date(d));
            }
            
            let html = '';
            days.forEach((date, index) => {
                const dateStr = date.toISOString().split('T')[0];
                const dateFormatted = date.toLocaleDateString('es-CO', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                const token = generateDayToken(eventId, dateStr);
                const baseUrl = window.location.origin;
                const attendanceUrl = `${baseUrl}/modules/events/event-public-attendance.html?event=${eventId}&date=${dateStr}&token=${token}`;
                
                html += `
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header" style="background: var(--module-primary); color: white;">
                                <h6 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Día ${index + 1}: ${dateFormatted}</h6>
                            </div>
                            <div class="card-body text-center">
                                <div id="qrcode-${dateStr}" class="mb-3 d-flex justify-content-center"></div>
                                <p class="small text-muted mb-2">Escanea este código para registrar asistencia del día</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="printSingleQR('${dateStr}', '${dateFormatted}')">
                                        <i class="bi bi-printer me-1"></i>Imprimir
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="downloadSingleQR('${dateStr}', '${dateFormatted}')">
                                        <i class="bi bi-download me-1"></i>Descargar PNG
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="copyAttendanceURL('${attendanceUrl}')">
                                        <i class="bi bi-link me-1"></i>Copiar URL
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            
            setTimeout(() => {
                days.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const token = generateDayToken(eventId, dateStr);
                    const baseUrl = window.location.origin;
                    const attendanceUrl = `${baseUrl}/modules/events/event-public-attendance.html?event=${eventId}&date=${dateStr}&token=${token}`;
                    const qrContainer = document.getElementById(`qrcode-${dateStr}`);
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, {
                        text: attendanceUrl, width: 200, height: 200,
                        colorDark: "#000000", colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                });
            }, 100);
        }
        
        function generateDayToken(eventId, date) {
            const str = `${eventId}-${date}-schoolnet-attendance`;
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }
        
        function printSingleQR(dateStr, dateFormatted) {
            const canvas = document.getElementById(`qrcode-${dateStr}`).querySelector('canvas');
            if (!canvas) { showMessage('Error al obtener el código QR', 'danger'); return; }
            const printWindow = window.open('', '', 'width=600,height=600');
            printWindow.document.write(`<html><head><title>QR Code - ${dateFormatted}</title>
                <style>body{font-family:Arial,sans-serif;text-align:center;padding:20px}h1{color:#1B365D;margin-bottom:10px}h2{color:#666;font-size:18px;margin-bottom:30px}.qr-container{margin:30px auto}.instructions{margin-top:30px;padding:20px;background:#f8f9fa;border-radius:8px}</style>
                </head><body><h1>${currentEvent.event_name}</h1><h2>Registro de Asistencia</h2><h2>${dateFormatted}</h2>
                <div class="qr-container"><img src="${canvas.toDataURL()}" style="width:300px;height:300px;"></div>
                <div class="instructions"><p><strong>Instrucciones:</strong></p><p>Escanea este código QR con tu celular para registrar tu asistencia</p></div></body></html>`);
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
        }
        
        function downloadSingleQR(dateStr, dateFormatted) {
            const canvas = document.getElementById(`qrcode-${dateStr}`).querySelector('canvas');
            if (!canvas) { showMessage('Error al obtener el código QR', 'danger'); return; }
            const link = document.createElement('a');
            link.download = `QR_${currentEvent.event_name.replace(/ /g, '_')}_${dateStr}.png`;
            link.href = canvas.toDataURL();
            link.click();
            showMessage('Código QR descargado', 'success');
        }
        
        function copyAttendanceURL(url) {
            navigator.clipboard.writeText(url).then(() => showMessage('URL copiada al portapapeles', 'success'))
                .catch(() => showMessage('No se pudo copiar la URL', 'warning'));
        }
        
        // ==========================================
        // IMPRIMIR TODOS LOS QR
        // ==========================================
        function printAllQRCodes() {
            // FIX: Usar parseLocalDate para evitar desfase de timezone
            const startDate = parseLocalDate(currentEvent.event_start_date);
            const endDate = parseLocalDate(currentEvent.event_end_date);
            const days = [];
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                days.push(new Date(d));
            }
            
            let htmlContent = `<html><head><title>Códigos QR - ${currentEvent.event_name}</title>
                <style>body{font-family:Arial,sans-serif;padding:20px}h1{color:#1B365D;text-align:center;margin-bottom:30px}.qr-page{page-break-after:always;text-align:center;padding:40px 20px}.qr-page:last-child{page-break-after:auto}h2{color:#666;margin-bottom:30px}.instructions{margin-top:30px;padding:20px;background:#f8f9fa;border-radius:8px;max-width:500px;margin-left:auto;margin-right:auto}@media print{.qr-page{page-break-after:always}}</style>
                </head><body><h1>${currentEvent.event_name}</h1>`;
            
            days.forEach((date, index) => {
                const dateStr = date.toISOString().split('T')[0];
                const dateFormatted = date.toLocaleDateString('es-CO', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                const canvas = document.getElementById(`qrcode-${dateStr}`)?.querySelector('canvas');
                if (canvas) {
                    htmlContent += `<div class="qr-page"><h2>Día ${index + 1}: ${dateFormatted}</h2>
                        <div><img src="${canvas.toDataURL()}" style="width:300px;height:300px;"></div>
                        <div class="instructions"><p><strong>Instrucciones:</strong></p><p>Escanea este código QR con tu celular para registrar tu asistencia</p></div></div>`;
                }
            });
            
            htmlContent += `</body></html>`;
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }
        
        // ==========================================
        // DESCARGAR TODOS LOS QR
        // ==========================================
        function downloadAllQRCodes() {
            showMessage('Descargando códigos QR...', 'info');
            // FIX: Usar parseLocalDate para evitar desfase de timezone
            const startDate = parseLocalDate(currentEvent.event_start_date);
            const endDate = parseLocalDate(currentEvent.event_end_date);
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = new Date(d).toISOString().split('T')[0];
                const dateFormatted = new Date(d).toLocaleDateString('es-CO');
                setTimeout(() => { downloadSingleQR(dateStr, dateFormatted); }, 100);
            }
        }
        
        function sendSurvey() {
            if (confirm('¿Enviar encuesta a todos los participantes inscritos?')) {
                showMessage('Funcionalidad de envío de encuestas en desarrollo', 'info');
            }
        }
        
        // ==========================================
        // FUNCIONES DE INSCRIPCIONES
        // ==========================================
        function openRegistrationModal() {
            const modal = new bootstrap.Modal(document.getElementById('registrationModal'));
            modal.show();
            document.getElementById('manualRegistrationForm').reset();
            loadInstitutionsForManual();
        }
        
        async function loadInstitutionsForManual() {
            try {
                const data = await supabaseRequest('/institutions?select=institution_id,institution_name&is_active=eq.true&order=institution_name.asc');
                const select = document.getElementById('manualInstitution');
                select.innerHTML = '<option value="">Sin institución</option>';
                data.forEach(inst => {
                    const option = document.createElement('option');
                    option.value = inst.institution_id;
                    option.textContent = inst.institution_name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando instituciones:', error);
            }
        }
        
        async function saveManualRegistration() {
            try {
                const form = document.getElementById('manualRegistrationForm');
                if (!form.checkValidity()) { form.reportValidity(); return; }
                
                const formData = {
                    participant_document: document.getElementById('manualDocument').value.trim(),
                    participant_full_name: document.getElementById('manualFullName').value.trim(),
                    participant_email: document.getElementById('manualEmail').value.trim(),
                    institution_id: document.getElementById('manualInstitution').value || null,
                    participant_position: document.getElementById('manualPosition').value.trim() || null,
                    is_internal_worker: document.getElementById('manualIsInternal').value === 'true',
                    arrival_method: document.getElementById('manualArrivalMethod').value || null,
                    dietary_restrictions: document.getElementById('manualDietaryRestrictions').value.trim() || null,
                    event_id: eventId,
                    registration_status: 'activo',
                    registration_source: 'manual',
                    registration_date: new Date().toISOString()
                };
                
                const existing = await supabaseRequest(
                    `/event_registrations?select=registration_id&event_id=eq.${eventId}&participant_document=eq.${formData.participant_document}`
                );
                if (existing && existing.length > 0) {
                    showMessage('Este documento ya está inscrito en el evento', 'warning');
                    return;
                }
                
                await supabaseRequest('/event_registrations', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                showMessage('Participante inscrito exitosamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('registrationModal')).hide();
                await loadRegistrations();
                await loadEventStats();
            } catch (error) {
                console.error('❌ Error:', error);
                showMessage('Error al inscribir: ' + error.message, 'danger');
            }
        }
        
        async function loadRegistrations() {
            try {
                const data = await supabaseRequest(
                    `/event_registrations?select=*,institutions(institution_name)&event_id=eq.${eventId}&order=registration_date.desc`
                );
                registrations = data || [];
                renderRegistrations(registrations);
                
                const institutions = [...new Set(registrations.map(r => r.institutions?.institution_name).filter(Boolean))];
                const filterSelect = document.getElementById('filterInstitution');
                filterSelect.innerHTML = '<option value="">Todas las instituciones</option>';
                institutions.forEach(inst => {
                    filterSelect.innerHTML += `<option value="${inst}">${inst}</option>`;
                });
                
                console.log(`✅ ${registrations.length} inscripciones cargadas`);
            } catch (error) {
                console.error('❌ Error cargando inscripciones:', error);
                renderEmptyRegistrations();
            }
        }
        
        function renderRegistrations(data) {
            const tbody = document.getElementById('registrationsTableBody');
            if (data.length === 0) { renderEmptyRegistrations(); return; }
            
            let html = '';
            data.forEach(reg => {
                const regDate = new Date(reg.registration_date).toLocaleDateString('es-CO');
                const typeBadge = reg.is_internal_worker ? 
                    '<span class="badge bg-primary">Interno</span>' : 
                    '<span class="badge bg-info">Externo</span>';
                
                html += `
                    <tr>
                        <td>${reg.participant_document}</td>
                        <td>${reg.participant_full_name}</td>
                        <td>${reg.institutions?.institution_name || '-'}</td>
                        <td>${reg.participant_email}</td>
                        <td>${typeBadge}</td>
                        <td>${regDate}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewRegistrationDetail('${reg.registration_id}')" title="Ver detalle">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${!isReadOnly ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteRegistration('${reg.registration_id}', '${reg.participant_full_name}')" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }
        
        function renderEmptyRegistrations() {
            document.getElementById('registrationsTableBody').innerHTML = `
                <tr><td colspan="7">
                    <div class="empty-state">
                        <i class="bi bi-people"></i>
                        <h5>No hay inscripciones</h5>
                        <p class="text-muted">Los participantes pueden inscribirse desde el formulario público</p>
                    </div>
                </td></tr>
            `;
        }
        
        function filterRegistrations() {
            const search = document.getElementById('searchRegistrations').value.toLowerCase();
            const institution = document.getElementById('filterInstitution').value;
            const type = document.getElementById('filterRegistrationType').value;
            
            const filtered = registrations.filter(reg => {
                const matchSearch = !search || 
                    reg.participant_full_name.toLowerCase().includes(search) ||
                    reg.participant_document.includes(search);
                const matchInstitution = !institution || reg.institutions?.institution_name === institution;
                const matchType = !type || 
                    (type === 'true' && reg.is_internal_worker) ||
                    (type === 'false' && !reg.is_internal_worker);
                return matchSearch && matchInstitution && matchType;
            });
            renderRegistrations(filtered);
        }
        
        function clearRegistrationFilters() {
            document.getElementById('searchRegistrations').value = '';
            document.getElementById('filterInstitution').value = '';
            document.getElementById('filterRegistrationType').value = '';
            renderRegistrations(registrations);
        }
        
        async function viewRegistrationDetail(registrationId) {
            try {
                const modal = new bootstrap.Modal(document.getElementById('registrationDetailModal'));
                modal.show();
                
                document.getElementById('registrationDetailContent').innerHTML = `
                    <div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Cargando información...</p></div>
                `;
                
                const data = await supabaseRequest(
                    `/event_registrations?select=*,institutions(institution_name)&registration_id=eq.${registrationId}`
                );
                if (!data || data.length === 0) {
                    document.getElementById('registrationDetailContent').innerHTML = '<div class="alert alert-warning">No se encontró la inscripción</div>';
                    return;
                }
                
                const reg = data[0];
                const enrollments = await supabaseRequest(
                    `/event_group_enrollments?select=*,event_groups(group_title,event_slots(slot_title,slot_date,slot_start_time))&registration_id=eq.${registrationId}`
                );
                
                let workshopsHtml = '';
                if (enrollments && enrollments.length > 0) {
                    workshopsHtml = '<div class="mb-3"><h6 class="text-primary mb-2"><i class="bi bi-diagram-3 me-2"></i>Talleres Inscritos</h6><ul class="list-group">';
                    enrollments.forEach(enr => {
                        if (enr.event_groups && enr.event_groups.event_slots) {
                            const slot = enr.event_groups.event_slots;
                            // FIX: Usar parseLocalDate
                            const date = parseLocalDate(slot.slot_date).toLocaleDateString('es-CO');
                            workshopsHtml += `<li class="list-group-item"><div><strong>${enr.event_groups.group_title}</strong></div>
                                <small class="text-muted">${slot.slot_title} - ${date} ${slot.slot_start_time}</small></li>`;
                        }
                    });
                    workshopsHtml += '</ul></div>';
                } else {
                    workshopsHtml = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>No está inscrito en talleres</div>';
                }
                
                document.getElementById('registrationDetailContent').innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label text-muted">Documento</label><p class="fw-bold">${reg.participant_document}</p></div>
                        <div class="col-md-6"><label class="form-label text-muted">Nombre Completo</label><p class="fw-bold">${reg.participant_full_name}</p></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label text-muted">Email</label><p>${reg.participant_email}</p></div>
                        <div class="col-md-6"><label class="form-label text-muted">Institución</label><p>${reg.institutions ? reg.institutions.institution_name : '<span class="text-muted">Sin institución</span>'}</p></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label text-muted">Cargo</label><p>${reg.participant_position || '<span class="text-muted">No especificado</span>'}</p></div>
                        <div class="col-md-6"><label class="form-label text-muted">Tipo</label><p>${reg.is_internal_worker ? '<span class="badge bg-primary">Interno</span>' : '<span class="badge bg-secondary">Externo</span>'}</p></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label text-muted">Medio de Llegada</label><p>${reg.arrival_method || '<span class="text-muted">No especificado</span>'}</p></div>
                        <div class="col-md-6"><label class="form-label text-muted">Restricciones Alimentarias</label><p>${reg.dietary_restrictions || '<span class="text-muted">Ninguna</span>'}</p></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label text-muted">Fecha de Inscripción</label><p>${new Date(reg.registration_date).toLocaleString('es-CO')}</p></div>
                        <div class="col-md-6"><label class="form-label text-muted">Origen</label><p><span class="badge bg-info">${reg.registration_source}</span></p></div>
                    </div>
                    <hr>
                    ${workshopsHtml}
                `;
            } catch (error) {
                console.error('❌ Error:', error);
                document.getElementById('registrationDetailContent').innerHTML = `<div class="alert alert-danger">Error al cargar el detalle: ${error.message}</div>`;
            }
        }
        
        function confirmDeleteRegistration(registrationId, participantName) {
            if (confirm(`¿Estás seguro de eliminar la inscripción de "${participantName}"?`)) {
                deleteRegistration(registrationId);
            }
        }
        
        async function deleteRegistration(registrationId) {
            try {
                await supabaseRequest(`/event_registrations?registration_id=eq.${registrationId}`, { method: 'DELETE' });
                showMessage('Inscripción eliminada exitosamente', 'success');
                await loadRegistrations();
                await loadEventStats();
            } catch (error) {
                console.error('❌ Error:', error);
                showMessage('Error al eliminar: ' + error.message, 'danger');
            }
        }
        
        async function exportRegistrations() {
            try {
                if (registrations.length === 0) { showMessage('No hay inscripciones para exportar', 'warning'); return; }
                
                const excelData = registrations.map(reg => ({
                    'Documento': reg.participant_document,
                    'Nombre Completo': reg.participant_full_name,
                    'Email': reg.participant_email,
                    'Institución': reg.institutions ? reg.institutions.institution_name : '',
                    'Cargo': reg.participant_position || '',
                    'Tipo': reg.is_internal_worker ? 'Interno' : 'Externo',
                    'Medio de Llegada': reg.arrival_method || '',
                    'Restricciones Alimentarias': reg.dietary_restrictions || '',
                    'Fecha Inscripción': new Date(reg.registration_date).toLocaleDateString('es-CO'),
                    'Origen': reg.registration_source,
                    'Estado': reg.registration_status
                }));
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                ws['!cols'] = [
                    { wch: 15 }, { wch: 30 }, { wch: 30 }, { wch: 25 }, { wch: 20 },
                    { wch: 10 }, { wch: 20 }, { wch: 25 }, { wch: 15 }, { wch: 10 }, { wch: 10 }
                ];
                XLSX.utils.book_append_sheet(wb, ws, 'Inscripciones');
                
                const eventName = currentEvent.event_name.replace(/[^a-zA-Z0-9]/g, '_');
                XLSX.writeFile(wb, `Inscripciones_${eventName}_${new Date().toISOString().split('T')[0]}.xlsx`);
                showMessage(`Excel exportado: ${registrations.length} registros`, 'success');
            } catch (error) {
                console.error('❌ Error exportando:', error);
                showMessage('Error al exportar: ' + error.message, 'danger');
            }
        }
        
        // ==========================================
        // ASISTENCIAS
        // ==========================================
        async function loadAttendanceByDate() {
            const date = document.getElementById('attendanceDate').value;
            if (!date) {
                document.getElementById('attendanceTableBody').innerHTML = '<tr><td colspan="5" class="text-center py-4"><span class="text-muted">Selecciona una fecha para ver las asistencias</span></td></tr>';
                document.getElementById('dayAttendanceCount').textContent = '0';
                return;
            }
            
            try {
                document.getElementById('attendanceTableBody').innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></td></tr>';
                
                const data = await supabaseRequest(
                    `/event_attendance?select=*,event_registrations(participant_document,participant_full_name,participant_email)&event_id=eq.${eventId}&attendance_date=eq.${date}&order=attendance_time.asc`
                );
                
                document.getElementById('dayAttendanceCount').textContent = data ? data.length : 0;
                
                if (!data || data.length === 0) {
                    document.getElementById('attendanceTableBody').innerHTML = '<tr><td colspan="5" class="text-center py-4"><i class="bi bi-inbox" style="font-size:2rem;color:#ccc;"></i><p class="text-muted mt-2 mb-0">No hay asistencias registradas para esta fecha</p></td></tr>';
                    return;
                }
                
                let html = '';
                for (const attendance of data) {
                    let timeDisplay = '';
                    if (attendance.attendance_time) {
                        const timeStr = attendance.attendance_time.toString();
                        timeDisplay = timeStr.includes('T') ? timeStr.split('T')[1].substring(0, 5) : timeStr.substring(0, 5);
                    }
                    
                    const enrollments = await supabaseRequest(
                        `/event_group_enrollments?select=event_groups(group_title)&registration_id=eq.${attendance.registration_id}`
                    );
                    
                    let groupsHtml = '<span class="text-muted">Sin talleres</span>';
                    if (enrollments && enrollments.length > 0) {
                        const groupNames = enrollments.map(e => e.event_groups ? e.event_groups.group_title : '').filter(Boolean).join(', ');
                        groupsHtml = `<small>${groupNames}</small>`;
                    }
                    
                    let originBadge = '';
                    switch(attendance.registered_from) {
                        case 'qr': originBadge = '<span class="badge bg-success">QR</span>'; break;
                        case 'manual': originBadge = '<span class="badge bg-primary">Manual</span>'; break;
                        default: originBadge = '<span class="badge bg-secondary">Otro</span>';
                    }
                    
                    html += `
                        <tr>
                            <td><strong>${timeDisplay}</strong></td>
                            <td>${attendance.event_registrations ? attendance.event_registrations.participant_document : '-'}</td>
                            <td>${attendance.event_registrations ? attendance.event_registrations.participant_full_name : '-'}</td>
                            <td>${originBadge}</td>
                            <td>${groupsHtml}</td>
                        </tr>
                    `;
                }
                document.getElementById('attendanceTableBody').innerHTML = html;
            } catch (error) {
                console.error('❌ Error cargando asistencias:', error);
                document.getElementById('attendanceTableBody').innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="alert alert-danger m-0">Error al cargar asistencias: ${error.message}</div></td></tr>`;
                document.getElementById('dayAttendanceCount').textContent = '0';
            }
        }
        
        async function initAttendanceTab() {
            if (currentEvent) {
                const dateInput = document.getElementById('attendanceDate');
                dateInput.value = currentEvent.event_start_date;
                dateInput.min = currentEvent.event_start_date;
                dateInput.max = currentEvent.event_end_date;
                await loadAttendanceByDate();
            }
        }
        
        function toggleGroupsSection() {}
        
        // ==========================================
        // IMPORTACIÓN CSV
        // ==========================================
        async function loadAllInstitutions() {
            try {
                const data = await supabaseRequest('/institutions?select=institution_id,institution_name&order=institution_name.asc');
                allInstitutions = data || [];
                console.log(`✅ ${allInstitutions.length} instituciones disponibles para CSV`);
            } catch (error) {
                console.error('❌ Error cargando instituciones:', error);
            }
        }
        
        function openImportCSVModal() {
            document.getElementById('csvStep1').style.display = 'block';
            document.getElementById('csvStep2').style.display = 'none';
            document.getElementById('btnImportCSV').style.display = 'none';
            document.getElementById('csvFileInput').value = '';
            csvData = [];
            importCSVModal.show();
        }
        
        function downloadCSVTemplate() {
            const template = `document,full_name,email,institution,position,is_internal,dietary_restrictions,arrival_method\n1234567890,Juan Pérez,juan.perez@example.com,Colegio San José,Docente,false,Ninguna,Transporte público\n9876543210,María García,maria.garcia@example.com,Universidad Nacional,Estudiante,false,Vegetariana,Vehículo propio`;
            const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `plantilla_inscripciones_${currentEvent.event_name.replace(/ /g, '_')}.csv`;
            link.click();
            showMessage('Plantilla descargada exitosamente', 'success');
        }
        
        async function handleCSVFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.name.endsWith('.csv')) { showMessage('Por favor selecciona un archivo CSV', 'warning'); return; }
            
            try {
                const text = await file.text();
                const parsed = parseCSV(text);
                if (parsed.length === 0) { showMessage('El archivo CSV está vacío', 'warning'); return; }
                
                csvData = [];
                const errors = [];
                for (let i = 0; i < parsed.length; i++) {
                    const row = parsed[i];
                    const validation = validateCSVRow(row, i + 2);
                    if (validation.valid) {
                        csvData.push(validation.data);
                    } else {
                        csvData.push({ ...validation.data, hasError: true });
                        errors.push(`Fila ${i + 2}: ${validation.error}`);
                    }
                }
                
                renderCSVPreview(csvData, errors);
                document.getElementById('csvStep1').style.display = 'none';
                document.getElementById('csvStep2').style.display = 'block';
                document.getElementById('btnImportCSV').style.display = 'block';
                
                const validCount = csvData.filter(r => !r.hasError).length;
                document.getElementById('importCount').textContent = validCount;
                document.getElementById('csvRowCount').textContent = ` - ${validCount} registros válidos de ${csvData.length} total`;
            } catch (error) {
                console.error('❌ Error procesando CSV:', error);
                showMessage('Error al procesar el archivo CSV: ' + error.message, 'danger');
            }
        }
        
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                headers.forEach((header, index) => { row[header] = values[index] || ''; });
                data.push(row);
            }
            return data;
        }
        
        function validateCSVRow(row, lineNumber) {
            const result = { valid: true, error: '', data: {} };
            
            if (!row.document || row.document.trim() === '') { result.valid = false; result.error = 'Documento es requerido'; }
            if (!row.full_name || row.full_name.trim() === '') { result.valid = false; result.error = 'Nombre completo es requerido'; }
            if (!row.email || row.email.trim() === '') { result.valid = false; result.error = 'Email es requerido'; }
            else if (!row.email.includes('@')) { result.valid = false; result.error = 'Email no válido'; }
            
            const isInternal = row.is_internal?.toLowerCase() === 'true';
            let institutionId = null;
            if (row.institution && row.institution.trim() !== '') {
                const institution = allInstitutions.find(i => i.institution_name.toLowerCase() === row.institution.toLowerCase());
                if (institution) { institutionId = institution.institution_id; }
                else { result.error = result.error || `Institución "${row.institution}" no encontrada`; }
            }
            
            result.data = {
                participant_document: row.document.trim(),
                participant_full_name: row.full_name.trim(),
                participant_email: row.email.trim(),
                institution_id: institutionId,
                participant_position: row.position?.trim() || null,
                is_internal_worker: isInternal,
                dietary_restrictions: row.dietary_restrictions?.trim() || null,
                arrival_method: row.arrival_method?.trim() || null,
                event_id: eventId,
                registration_status: 'activo',
                registration_source: 'manual',
                institutionName: row.institution?.trim() || '-'
            };
            return result;
        }
        
        function renderCSVPreview(data, errors) {
            const tbody = document.getElementById('csvPreviewBody');
            let html = '';
            data.forEach((row, index) => {
                const rowClass = row.hasError ? 'table-danger' : '';
                const statusIcon = row.hasError ? '<i class="bi bi-x-circle text-danger"></i>' : '<i class="bi bi-check-circle text-success"></i>';
                html += `<tr class="${rowClass}"><td>${index + 1}</td><td>${row.participant_document}</td><td>${row.participant_full_name}</td><td>${row.participant_email}</td><td>${row.institutionName}</td><td>${row.participant_position || '-'}</td><td>${row.is_internal_worker ? '<span class="badge bg-primary">Sí</span>' : '<span class="badge bg-info">No</span>'}</td><td class="text-center">${statusIcon}</td></tr>`;
            });
            tbody.innerHTML = html;
            
            if (errors.length > 0) {
                document.getElementById('csvErrors').style.display = 'block';
                document.getElementById('csvErrorsList').innerHTML = errors.map(e => `<li>${e}</li>`).join('');
            } else {
                document.getElementById('csvErrors').style.display = 'none';
            }
        }
        
        async function importCSVData() {
            const validData = csvData.filter(row => !row.hasError);
            if (validData.length === 0) { showMessage('No hay registros válidos para importar', 'warning'); return; }
            if (!confirm(`¿Importar inscripciones desde CSV?\n\nSe verificarán duplicados antes de importar.`)) return;
            
            try {
                const btn = document.getElementById('btnImportCSV');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verificando duplicados...';
                
                const existingRegistrations = await supabaseRequest(
                    `/event_registrations?select=participant_document&event_id=eq.${eventId}`
                );
                const existingDocuments = new Set(existingRegistrations.map(r => r.participant_document));
                
                const newRegistrations = [];
                const duplicates = [];
                const csvDocuments = new Set();
                
                validData.forEach(row => {
                    const doc = row.participant_document;
                    if (existingDocuments.has(doc)) { duplicates.push({...row, duplicateType: 'database'}); }
                    else if (csvDocuments.has(doc)) { duplicates.push({...row, duplicateType: 'csv'}); }
                    else { csvDocuments.add(doc); newRegistrations.push(row); }
                });
                
                const dbDuplicates = duplicates.filter(d => d.duplicateType === 'database').length;
                const csvDuplicates = duplicates.filter(d => d.duplicateType === 'csv').length;
                
                if (newRegistrations.length === 0) {
                    let msg = 'No hay registros nuevos para importar.\n\n';
                    if (dbDuplicates > 0) msg += `• ${dbDuplicates} ya existían en el evento\n`;
                    if (csvDuplicates > 0) msg += `• ${csvDuplicates} están repetidos en el CSV`;
                    showMessage(msg, 'warning');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-upload me-1"></i>Importar <span id="importCount"></span> Inscripciones';
                    return;
                }
                
                btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Importando ${newRegistrations.length} registros...`;
                
                const registrationsToInsert = newRegistrations.map(row => ({
                    event_id: row.event_id, participant_document: row.participant_document,
                    participant_full_name: row.participant_full_name, participant_email: row.participant_email,
                    institution_id: row.institution_id, participant_position: row.participant_position,
                    is_internal_worker: row.is_internal_worker, dietary_restrictions: row.dietary_restrictions,
                    arrival_method: row.arrival_method, registration_status: row.registration_status,
                    registration_source: row.registration_source, registration_date: new Date().toISOString()
                }));
                
                const batchSize = 50;
                let imported = 0;
                for (let i = 0; i < registrationsToInsert.length; i += batchSize) {
                    const batch = registrationsToInsert.slice(i, i + batchSize);
                    await supabaseRequest('/event_registrations', { method: 'POST', body: JSON.stringify(batch) });
                    imported += batch.length;
                    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Importando ${imported}/${newRegistrations.length}...`;
                }
                
                let message = `✅ Importación completada: ${imported} registros importados.`;
                if (duplicates.length > 0) {
                    message += ` ${duplicates.length} duplicados omitidos.`;
                }
                showMessage(message, 'success');
                importCSVModal.hide();
                await loadRegistrations();
                await loadEventStats();
            } catch (error) {
                console.error('❌ Error importando CSV:', error);
                showMessage('Error al importar: ' + error.message, 'danger');
                const btn = document.getElementById('btnImportCSV');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-upload me-1"></i>Importar <span id="importCount"></span> Inscripciones';
            }
        }
        
        // ==========================================
        // REPORTES Y ESTADÍSTICAS
        // ==========================================
        let chartInstitutions = null;
        let chartAttendance = null;
        
        async function loadReports() {
            try {
                console.log('📊 Cargando reportes...');
                await Promise.all([loadRegistrations(), loadSlots()]);
                await calculateReportStatistics();
                await generateInstitutionsChart();
                await generateAttendanceChart();
                await generateGroupsOccupancyTable();
                console.log('✅ Reportes cargados exitosamente');
            } catch (error) {
                console.error('❌ Error cargando reportes:', error);
                showMessage('Error al cargar reportes: ' + error.message, 'danger');
            }
        }
        
        async function calculateReportStatistics() {
            const totalRegistrations = registrations.length;
            document.getElementById('reportTotalRegistrations').textContent = totalRegistrations;
            
            const internals = registrations.filter(r => r.is_internal_worker === true).length;
            const externals = registrations.filter(r => r.is_internal_worker === false).length;
            document.getElementById('reportInternalRegistrations').textContent = internals;
            document.getElementById('reportExternalRegistrations').textContent = externals;
            
            try {
                const attendanceData = await supabaseRequest(`/event_attendance?select=registration_id&event_id=eq.${eventId}`);
                const uniqueAttendees = [...new Set(attendanceData.map(a => a.registration_id))].length;
                const attendanceRate = totalRegistrations > 0 ? ((uniqueAttendees / totalRegistrations) * 100).toFixed(1) : 0;
                document.getElementById('reportAttendanceRate').textContent = attendanceRate + '%';
            } catch (error) {
                console.error('Error calculando tasa de asistencia:', error);
                document.getElementById('reportAttendanceRate').textContent = '0%';
            }
        }
        
        async function generateInstitutionsChart() {
            if (chartInstitutions) chartInstitutions.destroy();
            
            const institutionCounts = {};
            registrations.forEach(reg => {
                const instName = reg.institutions ? reg.institutions.institution_name : 'Sin institución';
                institutionCounts[instName] = (institutionCounts[instName] || 0) + 1;
            });
            
            const sortedInstitutions = Object.entries(institutionCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const labels = sortedInstitutions.map(i => i[0]);
            const data = sortedInstitutions.map(i => i[1]);
            const colors = ['#1B365D', '#667eea', '#48bb78', '#ed8936', '#38b2ac', '#9f7aea', '#f56565', '#ecc94b', '#ed64a6', '#4299e1'];
            
            const container = document.getElementById('chartInstitutions');
            container.innerHTML = '<canvas id="canvasInstitutions"></canvas>';
            const ctx = document.getElementById('canvasInstitutions').getContext('2d');
            chartInstitutions = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Inscripciones', data, backgroundColor: colors, borderColor: colors, borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } }, x: { ticks: { maxRotation: 45, minRotation: 45 } } } }
            });
        }
        
        async function generateAttendanceChart() {
            if (chartAttendance) chartAttendance.destroy();
            try {
                const attendanceData = await supabaseRequest(`/event_attendance?select=attendance_date&event_id=eq.${eventId}&order=attendance_date.asc`);
                if (!attendanceData || attendanceData.length === 0) {
                    document.getElementById('chartAttendance').innerHTML = '<p class="text-muted text-center py-4">No hay datos de asistencia aún</p>';
                    return;
                }
                
                const dateCounts = {};
                attendanceData.forEach(att => { dateCounts[att.attendance_date] = (dateCounts[att.attendance_date] || 0) + 1; });
                
                const dates = Object.keys(dateCounts).sort();
                const counts = dates.map(d => dateCounts[d]);
                // FIX: Usar parseLocalDate para evitar desfase de timezone
                const labels = dates.map(d => parseLocalDate(d).toLocaleDateString('es-CO', { day: '2-digit', month: 'short' }));
                
                const container = document.getElementById('chartAttendance');
                container.innerHTML = '<canvas id="canvasAttendance"></canvas>';
                const ctx = document.getElementById('canvasAttendance').getContext('2d');
                chartAttendance = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'Asistencias', data: counts, backgroundColor: 'rgba(27,54,93,0.1)', borderColor: '#1B365D', borderWidth: 2, fill: true, tension: 0.4 }] },
                    options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                });
            } catch (error) {
                console.error('Error generando gráfico de asistencias:', error);
                document.getElementById('chartAttendance').innerHTML = '<p class="text-danger text-center py-4">Error al cargar gráfico</p>';
            }
        }
        
        async function generateGroupsOccupancyTable() {
            try {
                const allGroups = await supabaseRequest(
                    `/event_groups?select=*,event_slots!inner(slot_title,slot_date,event_id)&event_slots.event_id=eq.${eventId}`
                );
                if (!allGroups || allGroups.length === 0) {
                    document.getElementById('groupsOccupancy').innerHTML = '<p class="text-muted text-center py-4">No hay grupos/talleres configurados</p>';
                    return;
                }
                
                allGroups.sort((a, b) => {
                    const dateA = a.event_slots?.slot_date || '';
                    const dateB = b.event_slots?.slot_date || '';
                    if (dateA !== dateB) return dateA.localeCompare(dateB);
                    return (a.group_order || 0) - (b.group_order || 0);
                });
                
                let html = '<div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Franja</th><th>Taller/Grupo</th><th class="text-center">Capacidad</th><th class="text-center">Inscritos</th><th class="text-center">Disponibles</th><th>Ocupación</th><th class="text-center">Estado</th></tr></thead><tbody>';
                
                allGroups.forEach(group => {
                    const slotTitle = group.event_slots ? group.event_slots.slot_title : 'Sin franja';
                    const capacity = group.group_capacity;
                    const enrolled = group.current_enrollment;
                    const available = capacity - enrolled;
                    const percentage = capacity > 0 ? ((enrolled / capacity) * 100).toFixed(1) : 0;
                    
                    let barColor = 'bg-success';
                    if (percentage >= 80) barColor = 'bg-warning';
                    if (percentage >= 100) barColor = 'bg-danger';
                    
                    let statusBadge = '<span class="badge bg-success">Disponible</span>';
                    if (percentage >= 80 && percentage < 100) statusBadge = '<span class="badge bg-warning">Casi Lleno</span>';
                    else if (percentage >= 100) statusBadge = '<span class="badge bg-danger">Lleno</span>';
                    
                    html += `<tr><td><small>${slotTitle}</small></td><td><strong>${group.group_title}</strong></td><td class="text-center">${capacity}</td><td class="text-center"><strong>${enrolled}</strong></td><td class="text-center">${available}</td><td><div class="progress" style="height:20px;"><div class="progress-bar ${barColor}" role="progressbar" style="width:${percentage}%">${percentage}%</div></div></td><td class="text-center">${statusBadge}</td></tr>`;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('groupsOccupancy').innerHTML = html;
            } catch (error) {
                console.error('Error generando tabla de grupos:', error);
                document.getElementById('groupsOccupancy').innerHTML = '<p class="text-danger text-center py-4">Error al cargar tabla</p>';
            }
        }
        
        console.log('✅ Detalle del Evento cargado - v26.02.05');
    </script>
</body>
</html>
