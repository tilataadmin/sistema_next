<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejecutar Procedimiento - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner-border-lg {
            width: 3rem;
            height: 3rem;
        }

        /* Procedure Cards */
        .procedure-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .procedure-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .procedure-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .procedure-description {
            color: #6c757d;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .procedure-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .badge-type-interno {
            background-color: #0d6efd;
        }

        .steps-info {
            color: #6c757d;
        }

        /* Form Builder Styles */
        .form-preview {
            max-height: 60vh;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .field-container {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border: 1px solid #dee2e6;
        }

        .field-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
        }

        .required-mark {
            color: #dc3545;
            margin-left: 3px;
        }

        .field-help-text {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .prefilled-badge {
            background-color: #e7f3ff;
            color: #0d6efd;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="spinner-border text-light spinner-border-lg" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div class="text-light mt-3">Cargando...</div>
        </div>
    </div>

    <!-- Navbar placeholder -->
    <div id="navbar-placeholder"></div>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/dashboard.html">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="/modules/procedures/index.html">Procedimientos</a></li>
                <li class="breadcrumb-item active">Ejecutar Procedimiento</li>
            </ol>
        </nav>

        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="bi bi-play-circle me-2"></i>Iniciar Procedimiento</h2>
                <p class="text-muted mb-0">Selecciona un procedimiento para iniciar una nueva solicitud</p>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="search-input" 
                           placeholder="Buscar procedimiento..." 
                           onkeyup="filtrarProcedimientos()">
                </div>
            </div>
        </div>

        <!-- Alert Messages -->
        <div id="alert-container"></div>

        <!-- Procedures List -->
        <div class="row">
            <div class="col-12">
                <h5 class="mb-3">‚ö° PROCEDIMIENTOS DISPONIBLES</h5>
                <div id="procedures-list">
                    <!-- Cargado din√°micamente -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="text-muted mt-2">Cargando procedimientos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal: Iniciar Procedimiento -->
    <div class="modal fade" id="modal-execute" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        <span id="modal-procedure-name">Iniciar Procedimiento</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Informaci√≥n del procedimiento -->
                    <div class="alert alert-info" id="procedure-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <span id="procedure-description"></span>
                    </div>

                    <!-- Formulario din√°mico -->
                    <form id="form-execute">
                        <input type="hidden" id="procedure-id" name="procedure_id">
                        <input type="hidden" id="form-id" name="form_id">

                        <div id="dynamic-form-container" class="form-preview">
                            <!-- Los campos se cargan din√°micamente aqu√≠ -->
                        </div>
                    </form>

                    <!-- Informaci√≥n adicional -->
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-asterisk text-danger"></i>
                            Los campos marcados con asterisco (*) son obligatorios
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="enviarSolicitud()">
                        <i class="bi bi-check-circle me-2"></i>Enviar Solicitud
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Config.js -->
    <script src="/assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let proceduresList = [];
        let filteredProcedures = [];
        let currentProcedure = null;
        let currentForm = null;
        let currentFormFields = [];
        let modalExecute = null;
        let uploadedFiles = {}; // Almacena archivos subidos por field_id

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üîê Iniciando validaci√≥n de acceso...');
                
                // Validar permisos
                const hasAccess = await validatePageAccess('Ejecutar procedimientos');
                if (!hasAccess) {
                    console.log('‚ùå Usuario sin acceso');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - inicializando p√°gina');

                // Inicializar modal
                modalExecute = new bootstrap.Modal(document.getElementById('modal-execute'));

                // Cargar procedimientos
                await cargarProcedimientos();

                console.log('‚úÖ P√°gina inicializada correctamente');

            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al inicializar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGAR PROCEDIMIENTOS
        // ==========================================
        async function cargarProcedimientos() {
            try {
                mostrarLoading();
                console.log('üì• Cargando procedimientos internos activos...');

                const data = await supabaseRequest(
                    '/procedures?select=*,forms(form_name)&procedure_type=eq.internal&procedure_status=eq.active&order=procedure_name.asc'
                );

                proceduresList = data || [];
                filteredProcedures = proceduresList;

                console.log(`‚úÖ ${proceduresList.length} procedimientos cargados`);

                renderProcedures();

            } catch (error) {
                console.error('‚ùå Error cargando procedimientos:', error);
                showMessage('Error al cargar procedimientos: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }

        // ==========================================
        // RENDERIZAR LISTA DE PROCEDIMIENTOS
        // ==========================================
        function renderProcedures() {
            const container = document.getElementById('procedures-list');

            if (filteredProcedures.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <h5>No hay procedimientos disponibles</h5>
                        <p class="text-muted">
                            ${proceduresList.length === 0 
                                ? 'No se encontraron procedimientos internos activos.' 
                                : 'No se encontraron resultados para tu b√∫squeda.'}
                        </p>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredProcedures.forEach(proc => {
                const formName = proc.forms?.form_name || 'Sin formulario';
                
                html += `
                    <div class="procedure-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="procedure-title">
                                    <i class="bi bi-file-earmark-text me-2"></i>
                                    ${escapeHtml(proc.procedure_name)}
                                </div>
                                <div class="procedure-description">
                                    ${escapeHtml(proc.procedure_description || 'Sin descripci√≥n')}
                                </div>
                                <div class="procedure-meta">
                                    <span class="badge badge-type-interno">Interno</span>
                                    <span class="text-muted">
                                        <i class="bi bi-file-text me-1"></i>
                                        Formulario: ${escapeHtml(formName)}
                                    </span>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-primary" 
                                        onclick="iniciarProcedimiento(${proc.procedure_id})"
                                        title="Iniciar este procedimiento">
                                    <i class="bi bi-play-circle me-2"></i>Iniciar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function filtrarProcedimientos() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            filteredProcedures = proceduresList.filter(proc => {
                return proc.procedure_name.toLowerCase().includes(searchTerm) ||
                       (proc.procedure_description && proc.procedure_description.toLowerCase().includes(searchTerm));
            });

            renderProcedures();
        }
        // ==========================================
        // INICIAR PROCEDIMIENTO
        // ==========================================
        async function iniciarProcedimiento(procedureId) {
            try {
                mostrarLoading();
                console.log('üìã Cargando procedimiento:', procedureId);

                // Cargar datos del procedimiento
                const procData = await supabaseRequest(`/procedures?procedure_id=eq.${procedureId}&select=*,forms(form_id,form_name,form_description)`);
                
                if (!procData || procData.length === 0) {
                    throw new Error('Procedimiento no encontrado');
                }

                currentProcedure = procData[0];
                currentForm = currentProcedure.forms;

                if (!currentForm || !currentForm.form_id) {
                    throw new Error('Este procedimiento no tiene un formulario asociado');
                }

                // Cargar campos del formulario
                console.log('üìã Cargando campos del formulario:', currentForm.form_id);
                
                const fieldsData = await supabaseRequest(
                    `/form_fields?form_id=eq.${currentForm.form_id}&select=*&order=field_order.asc`
                );

                currentFormFields = fieldsData || [];

                if (currentFormFields.length === 0) {
                    throw new Error('Este formulario no tiene campos configurados');
                }

                // Para campos SELECT, cargar opciones
                for (const field of currentFormFields) {
                    if (field.field_type === 'select') {
                        const options = await supabaseRequest(
                            `/field_option_catalog?field_id=eq.${field.field_id}&is_active=eq.true&order=option_order.asc`
                        );
                        field.options = options || [];
                    }
                }

                console.log(`‚úÖ ${currentFormFields.length} campos cargados`);

                // Actualizar modal
                document.getElementById('modal-procedure-name').textContent = currentProcedure.procedure_name;
                document.getElementById('procedure-description').textContent = currentProcedure.procedure_description || 'Sin descripci√≥n';
                document.getElementById('procedure-id').value = currentProcedure.procedure_id;
                document.getElementById('form-id').value = currentForm.form_id;

                // Renderizar formulario
                renderDynamicForm();

                // Mostrar modal
                modalExecute.show();

            } catch (error) {
                console.error('‚ùå Error cargando procedimiento:', error);
                showMessage('Error: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }

        // ==========================================
        // RENDERIZAR FORMULARIO DIN√ÅMICO
        // ==========================================
        async function renderDynamicForm() {
            const container = document.getElementById('dynamic-form-container');
            uploadedFiles = {}; // Limpiar archivos previos

            let html = '';

            // Obtener datos del usuario autenticado para pre-llenar
            const session = getStoredSession();
            const userData = {
                user_name: session?.user?.user_display_name || '',
                user_email: session?.user?.user_email || '',
                current_date: new Date().toISOString().split('T')[0]
            };

            for (const field of currentFormFields) {
                html += `<div class="field-container">`;
                
                // Label
                const isRequired = field.is_required ? '<span class="required-mark">*</span>' : '';
                const isPrefilledBadge = field.is_prefilled ? '<span class="prefilled-badge">Auto-completado</span>' : '';
                
                html += `
                    <label class="field-label">
                        ${escapeHtml(field.field_label)}${isRequired}${isPrefilledBadge}
                    </label>
                `;

                // Valor pre-llenado
                let prefilledValue = '';
                if (field.is_prefilled && field.prefill_source) {
                    prefilledValue = userData[field.prefill_source] || '';
                }

                const requiredAttr = field.is_required ? 'required' : '';
                const fieldId = `field_${field.field_id}`;

                // Renderizar seg√∫n tipo de campo
                switch (field.field_type) {
                    case 'text':
                        html += `
                            <input type="text" 
                                   class="form-control" 
                                   id="${fieldId}" 
                                   name="${fieldId}"
                                   value="${escapeHtml(prefilledValue)}"
                                   ${field.is_prefilled ? 'readonly' : ''}
                                   ${requiredAttr}
                                   placeholder="${escapeHtml(field.field_label)}">
                        `;
                        break;

                    case 'textarea':
                        html += `
                            <textarea class="form-control" 
                                      id="${fieldId}" 
                                      name="${fieldId}"
                                      rows="3"
                                      ${requiredAttr}
                                      placeholder="${escapeHtml(field.field_label)}">${escapeHtml(prefilledValue)}</textarea>
                        `;
                        break;

                    case 'number':
                        const min = field.validation_rules?.min !== undefined ? `min="${field.validation_rules.min}"` : '';
                        const max = field.validation_rules?.max !== undefined ? `max="${field.validation_rules.max}"` : '';
                        html += `
                            <input type="number" 
                                   class="form-control" 
                                   id="${fieldId}" 
                                   name="${fieldId}"
                                   ${min} ${max}
                                   ${requiredAttr}
                                   placeholder="${escapeHtml(field.field_label)}">
                        `;
                        break;

                    case 'date':
                        html += `
                            <input type="date" 
                                   class="form-control" 
                                   id="${fieldId}" 
                                   name="${fieldId}"
                                   value="${prefilledValue}"
                                   ${field.is_prefilled ? 'readonly' : ''}
                                   ${requiredAttr}>
                        `;
                        break;

                    case 'select':
                        html += `<select class="form-select" id="${fieldId}" name="${fieldId}" ${requiredAttr}>`;
                        html += `<option value="">Seleccione una opci√≥n</option>`;
                        if (field.options && field.options.length > 0) {
                            field.options.forEach(opt => {
                                html += `<option value="${opt.option_id}">${escapeHtml(opt.option_label)}</option>`;
                            });
                        }
                        html += `</select>`;
                        break;

                    case 'file':
                        const accept = field.validation_rules?.accept || '*/*';
                        const maxSize = field.validation_rules?.maxSize || 5;
                        html += `
                            <input type="file" 
                                   class="form-control" 
                                   id="${fieldId}" 
                                   name="${fieldId}"
                                   accept="${accept}"
                                   ${requiredAttr}
                                   onchange="handleFileUpload(event, ${field.field_id})">
                            <small class="field-help-text">
                                Tama√±o m√°ximo: ${maxSize}MB
                            </small>
                        `;
                        break;
                }

                html += `</div>`;
            }

            container.innerHTML = html;
        }
        // ==========================================
        // MANEJO DE ARCHIVOS
        // ==========================================
        async function handleFileUpload(event, fieldId) {
            const file = event.target.files[0];
            if (!file) return;

            const field = currentFormFields.find(f => f.field_id === fieldId);
            const maxSize = (field.validation_rules?.maxSize || 5) * 1024 * 1024; // MB a bytes

            // Validar tama√±o
            if (file.size > maxSize) {
                showMessage(`El archivo excede el tama√±o m√°ximo de ${field.validation_rules?.maxSize || 5}MB`, 'warning');
                event.target.value = '';
                return;
            }

            try {
                mostrarLoading();
                console.log('üì§ Subiendo archivo:', file.name);

                // Obtener token de sesi√≥n del usuario
                const session = getStoredSession();
                if (!session || !session.access_token) {
                    throw new Error('No se encontr√≥ sesi√≥n v√°lida');
                }

                // Generar nombre √∫nico
                const timestamp = Date.now();
                const fileName = `${timestamp}_${file.name}`;

                console.log('üîë Usando token de usuario para autenticaci√≥n');

                // Subir a Supabase Storage con el token del usuario
                const uploadResponse = await fetch(
                    `${SUPABASE_CONFIG.apiUrl.replace('/rest/v1', '')}/storage/v1/object/schoolnet-procedures/${fileName}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${session.access_token}`,
                            'apikey': SUPABASE_CONFIG.anonKey
                        },
                        body: file
                    }
                );

                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.text();
                    console.error('‚ùå Error del Storage API:', errorData);
                    throw new Error(errorData || 'Error al subir el archivo');
                }

                const uploadResult = await uploadResponse.json();
                console.log('‚úÖ Respuesta del servidor:', uploadResult);

                // Guardar informaci√≥n del archivo
                uploadedFiles[fieldId] = {
                    file_path: `schoolnet-procedures/${fileName}`,
                    file_name: file.name,
                    file_size: file.size,
                    file_type: file.type
                };

                console.log('‚úÖ Archivo subido correctamente');
                showMessage('Archivo subido correctamente', 'success');

            } catch (error) {
                console.error('‚ùå Error subiendo archivo:', error);
                showMessage('Error al subir el archivo: ' + error.message, 'danger');
                event.target.value = '';
            } finally {
                ocultarLoading();
            }
        }

        // ==========================================
        // ENVIAR SOLICITUD
        // ==========================================
        async function enviarSolicitud() {
            try {
                const form = document.getElementById('form-execute');
                
                // Validar formulario
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                if (!confirm('¬øEst√°s seguro de enviar esta solicitud?')) {
                    return;
                }

                mostrarLoading();
                console.log('üíæ Enviando solicitud...');

                const session = getStoredSession();
                if (!session || !session.user) {
                    throw new Error('Sesi√≥n no v√°lida');
                }

                // PASO 1: Construir form_data (JSON completo como respaldo)
                const formData = {};
                currentFormFields.forEach(field => {
                    const fieldId = `field_${field.field_id}`;
                    const element = document.getElementById(fieldId);
                    
                    if (element) {
                        if (field.field_type === 'file') {
                            formData[field.field_name] = uploadedFiles[field.field_id]?.file_name || null;
                        } else if (field.field_type === 'select') {
                            const selectedOption = field.options?.find(opt => opt.option_id == element.value);
                            formData[field.field_name] = selectedOption?.option_label || element.value;
                        } else {
                            formData[field.field_name] = element.value;
                        }
                    }
                });

                // PASO 2: Crear procedure_instance
                console.log('üìù Creando instancia de procedimiento...');
                
                const instanceData = {
                    procedure_id: currentProcedure.procedure_id,
                    initiated_by_user_id: session.user.user_id,
                    initiated_by_email: session.user.user_email,
                    initiated_by_name: session.user.user_display_name,
                    form_data: formData,
                    instance_status: 'in_progress',
                    started_at: new Date().toISOString()
                };

                const newInstance = await supabaseRequest('/procedure_instances', {
                    method: 'POST',
                    body: JSON.stringify(instanceData)
                });

                if (!newInstance || newInstance.length === 0) {
                    throw new Error('No se pudo crear la instancia del procedimiento');
                }

                const instanceId = newInstance[0].instance_id;
                console.log('‚úÖ Instancia creada con ID:', instanceId);

                // PASO 3: Guardar respuestas normalizadas en form_responses
                console.log('üíæ Guardando respuestas del formulario...');

                for (const field of currentFormFields) {
                    const fieldId = `field_${field.field_id}`;
                    const element = document.getElementById(fieldId);

                    if (!element || (element.value === '' && field.field_type !== 'file')) {
                        continue; // Saltar campos vac√≠os opcionales
                    }

                    const responseData = {
                        instance_id: instanceId,
                        field_id: field.field_id
                    };

                    switch (field.field_type) {
                        case 'text':
                        case 'textarea':
                            if (element.value) {
                                responseData.response_text = element.value;
                            }
                            break;

                        case 'number':
                            if (element.value) {
                                responseData.response_number = parseFloat(element.value);
                            }
                            break;

                        case 'date':
                            if (element.value) {
                                responseData.response_date = element.value;
                            }
                            break;

                        case 'select':
                            if (element.value) {
                                responseData.selected_option_id = parseInt(element.value);
                            }
                            break;

                        case 'file':
                            if (uploadedFiles[field.field_id]) {
                                responseData.file_path = uploadedFiles[field.field_id].file_path;
                                responseData.file_name = uploadedFiles[field.field_id].file_name;
                            }
                            break;
                    }

                    // Solo insertar si hay datos
                    if (Object.keys(responseData).length > 2) {
                        await supabaseRequest('/form_responses', {
                            method: 'POST',
                            body: JSON.stringify(responseData)
                        });
                    }
                }

                console.log('‚úÖ Respuestas guardadas correctamente');

                // PASO 4: Obtener primer paso del procedimiento
                console.log('üîç Identificando primer paso...');
                
                const firstSteps = await supabaseRequest(
                    `/procedure_steps?procedure_id=eq.${currentProcedure.procedure_id}&select=*,workers(worker_id,worker_first_name,worker_last_name_1)&order=step_sequence.asc&limit=1`
                );

                if (!firstSteps || firstSteps.length === 0) {
                    throw new Error('El procedimiento no tiene pasos configurados');
                }

                const firstStep = firstSteps[0];
                console.log('‚úÖ Primer paso identificado:', firstStep.step_name);

                // PASO 5: Crear tarea para el responsable del primer paso
                console.log('üìã Creando tarea para el responsable...');

                const workerEmail = firstStep.workers?.email || 
                                   (await getWorkerEmail(firstStep.responsible_worker_id));

                const dueDate = calculateDueDate(firstStep.sla_days || 5);

                const taskData = {
                    task_description: `Paso ${firstStep.step_sequence}: ${firstStep.step_name} - Procedimiento: ${currentProcedure.procedure_name}`,
                    assigned_to_mail: workerEmail,
                    due_date: dueDate,
                    task_state: 'assigned',
                    task_priority: firstStep.sla_days <= 2 ? 'high' : 'medium',
                    module_type: 'procedures',
                    procedure_id: currentProcedure.procedure_id,
                    procedure_step_id: firstStep.step_id,
                    created_by: session.user.user_id,
                    created_by_name: session.user.user_display_name
                };

                await supabaseRequest('/tasks', {
                    method: 'POST',
                    body: JSON.stringify(taskData)
                });

                console.log('‚úÖ Tarea creada correctamente');

                // TODO: Enviar notificaciones por email (implementar despu√©s)

                // Cerrar modal
                modalExecute.hide();

                // Mostrar mensaje de √©xito
                showMessage('¬°Solicitud enviada exitosamente! Recibir√°s notificaciones sobre el avance.', 'success');

                // Esperar 2 segundos y redirigir a Mis Solicitudes
                setTimeout(() => {
                    window.location.href = '/modules/procedures/my-requests.html';
                }, 2000);

            } catch (error) {
                console.error('‚ùå Error enviando solicitud:', error);
                showMessage('Error al enviar la solicitud: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }

        // ==========================================
        // FUNCIONES AUXILIARES
        // ==========================================
        async function getWorkerEmail(workerId) {
            try {
                const worker = await supabaseRequest(`/workers?worker_id=eq.${workerId}&select=email`);
                return worker && worker.length > 0 ? worker[0].email : null;
            } catch (error) {
                console.error('Error obteniendo email del worker:', error);
                return null;
            }
        }

        function calculateDueDate(slaDays) {
            const today = new Date();
            let daysAdded = 0;
            let currentDate = new Date(today);

            while (daysAdded < slaDays) {
                currentDate.setDate(currentDate.getDate() + 1);
                const dayOfWeek = currentDate.getDay();
                
                // Saltar fines de semana (0 = Domingo, 6 = S√°bado)
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    daysAdded++;
                }
            }

            return currentDate.toISOString().split('T')[0];
        }
        // ==========================================
        // MENSAJES Y UTILIDADES
        // ==========================================
        function showMessage(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            const alertHTML = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'x-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHTML);
            
            // Auto-cerrar despu√©s de 5 segundos
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.iniciarProcedimiento = iniciarProcedimiento;
        window.enviarSolicitud = enviarSolicitud;
        window.filtrarProcedimientos = filtrarProcedimientos;
        window.handleFileUpload = handleFileUpload;

        console.log('üéâ execute.html cargado correctamente');
    </script>
</body>
</html>
