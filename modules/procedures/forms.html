<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Formularios - Procedimientos - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --module-primary: #6f42c1;
            --module-secondary: #9b6fd9;
            --module-light: #f3effa;
        }

        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .breadcrumb {
            background: transparent;
            padding: 0;
        }

        .breadcrumb-item a {
            color: var(--module-primary);
            text-decoration: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--module-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-actions {
            white-space: nowrap;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .badge {
            font-weight: 500;
        }

        .modal-lg {
            max-width: 800px;
        }

        .field-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: white;
            transition: all 0.2s;
        }

        .field-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .field-order-controls {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 0.25rem;
        }

        .option-item.inactive {
            opacity: 0.6;
            background: #e9ecef;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Procedimientos</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Gestionar Formularios
                </li>
            </ol>
        </nav>

        <!-- HEADER -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex align-items-center justify-content-between flex-wrap">
                    <div>
                        <h1 class="h3 mb-2">
                            <i class="bi bi-file-earmark-text me-2" style="color: var(--module-primary);"></i>
                            Gestionar Formularios
                        </h1>
                        <p class="text-muted mb-0">Crea y configura formularios reutilizables para procedimientos</p>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="abrirModalCrearFormulario()">
                            <i class="bi bi-plus-circle me-1"></i>Nuevo Formulario
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- FILTROS Y B√öSQUEDA -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="search-input" 
                                   placeholder="Buscar por nombre o descripci√≥n...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filter-status">
                            <option value="">Todos los estados</option>
                            <option value="active">Activos</option>
                            <option value="inactive">Inactivos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" onclick="limpiarFiltros()">
                            <i class="bi bi-x-circle me-1"></i>Limpiar filtros
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA DE FORMULARIOS -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Descripci√≥n</th>
                                <th class="text-center">Campos</th>
                                <th class="text-center">Procedimientos</th>
                                <th class="text-center">Estado</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="forms-table-body">
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    No hay formularios creados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    <!-- MODAL: CREAR/EDITAR FORMULARIO -->
    <div class="modal fade" id="modalFormulario" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalFormularioTitle">
                        <i class="bi bi-file-earmark-plus me-2"></i>Nuevo Formulario
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-formulario">
                        <input type="hidden" id="form-id" name="form_id">
                        
                        <!-- INFORMACI√ìN GENERAL -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">Informaci√≥n General</h6>
                            
                            <div class="mb-3">
                                <label for="form-name" class="form-label">
                                    Nombre del formulario <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="form-name" 
                                       name="form_name" required maxlength="200">
                            </div>

                            <div class="mb-3">
                                <label for="form-description" class="form-label">Descripci√≥n</label>
                                <textarea class="form-control" id="form-description" 
                                          name="form_description" rows="3" maxlength="500"></textarea>
                                <div class="form-text">Opcional. Explica el prop√≥sito del formulario.</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Estado</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="form_status" 
                                               id="status-active" value="active" checked>
                                        <label class="form-check-label" for="status-active">
                                            <i class="bi bi-check-circle text-success"></i> Activo
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="form_status" 
                                               id="status-inactive" value="inactive">
                                        <label class="form-check-label" for="status-inactive">
                                            <i class="bi bi-pause-circle text-secondary"></i> Inactivo
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CAMPOS DEL FORMULARIO -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                                <h6 class="mb-0">Campos del Formulario</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        onclick="abrirModalCampo()">
                                    <i class="bi bi-plus-circle me-1"></i>Agregar Campo
                                </button>
                            </div>

                            <div id="fields-container">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                                    <p class="mb-0">No hay campos agregados</p>
                                    <small>Haz clic en "Agregar Campo" para comenzar</small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="guardarFormulario()">
                        <i class="bi bi-save me-1"></i>Guardar Formulario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: AGREGAR/EDITAR CAMPO -->
    <div class="modal fade" id="modalCampo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCampoTitle">
                        <i class="bi bi-input-cursor-text me-2"></i>Agregar Campo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-campo">
                        <input type="hidden" id="field-id" name="field_id">
                        <input type="hidden" id="field-index" name="field_index">

                        <!-- INFORMACI√ìN B√ÅSICA DEL CAMPO -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="field-name" class="form-label">
                                    Nombre del campo <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="field-name" 
                                       name="field_name" required maxlength="100">
                                <div class="form-text">Identificador interno (sin espacios ni caracteres especiales)</div>
                            </div>
                            <div class="col-md-6">
                                <label for="field-label" class="form-label">
                                    Etiqueta visible <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="field-label" 
                                       name="field_label" required maxlength="200">
                                <div class="form-text">Texto que ver√° el usuario</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="field-type" class="form-label">
                                    Tipo de campo <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="field-type" name="field_type" 
                                        required onchange="actualizarOpcionesCampo()">
                                    <option value="">Seleccione...</option>
                                    <option value="text">Texto corto</option>
                                    <option value="textarea">Texto largo (textarea)</option>
                                    <option value="number">N√∫mero</option>
                                    <option value="date">Fecha</option>
                                    <option value="select">Selecci√≥n (dropdown)</option>
                                    <option value="file">Archivo</option>
                                    <option value="boolean">SI/NO</option>
                                    <option value="system_table">Selecci√≥n desde tabla del sistema</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label d-block">Opciones</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="field-required" name="is_required">
                                    <label class="form-check-label" for="field-required">
                                        Campo obligatorio
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- PRE-LLENADO AUTOM√ÅTICO -->
                        <div class="mb-3">
                            <label for="prefill-source" class="form-label">Pre-llenado autom√°tico</label>
                            <select class="form-select" id="prefill-source" name="prefill_source">
                                <option value="">Sin pre-llenado</option>
                                <option value="user_name">Nombre del usuario logueado</option>
                                <option value="user_email">Email del usuario logueado</option>
                                <option value="current_date">Fecha actual</option>
                            </select>
                            <div class="form-text">El campo se llenar√° autom√°ticamente con esta informaci√≥n</div>
                        </div>

                        <!-- VALIDACIONES (condicional seg√∫n tipo) -->
                        <div id="validation-section" class="mb-3 d-none">
                            <label class="form-label">Validaciones</label>
                            <div class="border rounded p-3 bg-light">
                                
                                <!-- Para tipo texto -->
                                <div id="validation-text" class="d-none">
                                    <label for="validation-format" class="form-label">Formato especial</label>
                                    <select class="form-select mb-2" id="validation-format">
                                        <option value="">Ninguno</option>
                                        <option value="email">Email</option>
                                        <option value="phone">Tel√©fono</option>
                                    </select>
                                </div>

                                <!-- Para tipo n√∫mero -->
                                <div id="validation-number" class="d-none">
                                    <div class="row">
                                        <div class="col-6">
                                            <label for="validation-min" class="form-label">Valor m√≠nimo</label>
                                            <input type="number" class="form-control" id="validation-min">
                                        </div>
                                        <div class="col-6">
                                            <label for="validation-max" class="form-label">Valor m√°ximo</label>
                                            <input type="number" class="form-control" id="validation-max">
                                        </div>
                                    </div>
                                </div>

                                <!-- Para tipo archivo -->
                                <div id="validation-file" class="d-none">
                                    <label for="validation-file-size" class="form-label">Tama√±o m√°ximo (MB)</label>
                                    <input type="number" class="form-control mb-2" id="validation-file-size" 
                                           value="5" min="1" max="20">
                                    
                                    <label class="form-label">Tipos de archivo permitidos</label>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       value="pdf" id="file-pdf" checked>
                                                <label class="form-check-label" for="file-pdf">PDF</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       value="doc" id="file-doc" checked>
                                                <label class="form-check-label" for="file-doc">DOC/DOCX</label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       value="xls" id="file-xls" checked>
                                                <label class="form-check-label" for="file-xls">XLS/XLSX</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       value="jpg" id="file-jpg">
                                                <label class="form-check-label" for="file-jpg">JPG/PNG</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- OPCIONES (solo para tipo SELECT) -->
                        <div id="options-section" class="mb-3 d-none">
                            <label class="form-label">
                                Opciones del campo <span class="text-danger">*</span>
                            </label>
                            <div class="border rounded p-3 bg-light">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" id="new-option-text" 
                                           placeholder="Escribe una opci√≥n...">
                                    <button type="button" class="btn btn-primary" onclick="agregarOpcion()">
                                        <i class="bi bi-plus-circle"></i> Agregar
                                    </button>
                                </div>
                                
                                <div id="options-list" class="mt-3">
                                    <!-- Las opciones se agregan din√°micamente aqu√≠ -->
                                </div>

                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> 
                                    Las opciones se pueden activar/desactivar sin perder el hist√≥rico
                                </small>
                            </div>
                        </div>
                        <!-- SELECCI√ìN DE TABLA DEL SISTEMA -->
                        <div id="system-table-section" class="mb-3 d-none">
                            <label for="system-table-name" class="form-label">
                                Tabla del sistema <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="system-table-name" name="system_table_name">
                                <option value="">Seleccione una tabla...</option>
                                <option value="academic_areas">√Åreas Acad√©micas</option>
                                <option value="courses">Cursos</option>
                                <option value="families">Familias</option>
                                <option value="genders">G√©neros</option>
                                <option value="grades">Grados</option>
                                <option value="job_roles">Roles de Trabajo</option>
                                <option value="sections">Secciones</option>
                                <option value="students">Estudiantes</option>
                                <option value="workers">Trabajadores</option>
                            </select>
                            <div class="form-text">
                                Los registros de esta tabla se mostrar√°n como opciones en el formulario
                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="guardarCampo()">
                        <i class="bi bi-check-circle me-1"></i>Guardar Campo
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- CONFIG.JS -->
    <script src="../../assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let modalFormulario = null;
        let modalCampo = null;
        let formulariosData = [];
        let camposTemporales = []; // Campos que se est√°n editando
        let campoEditandoIndex = -1; // √çndice del campo que se est√° editando
        let formIdActual = null; // ID del formulario que se est√° editando
        // ==========================================
        // CONSTANTES DEL SISTEMA
        // ==========================================
        const FORM_SYSTEM_TABLES = {
            'academic_areas': { label: '√Åreas Acad√©micas', display_field: 'area_name', order_by: 'area_name' },
            'courses': { label: 'Cursos', display_field: 'course_name', order_by: 'course_order' },
            'families': { label: 'Familias', display_field: 'family_name', order_by: 'family_name' },
            'genders': { label: 'G√©neros', display_field: 'gender_name', order_by: 'gender_name' },
            'grades': { label: 'Grados', display_field: 'grade_name', order_by: 'grade_order' },
            'job_roles': { label: 'Roles de Trabajo', display_field: 'role_name', order_by: 'role_name' },
            'sections': { label: 'Secciones', display_field: 'section_name', order_by: 'section_name' },
            'students': { label: 'Estudiantes', display_field: 'CONCAT', order_by: 'last_name1' },
            'workers': { label: 'Trabajadores', display_field: 'CONCAT', order_by: 'last_name1' }
        };

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîß Inicializando Gestionar Formularios...');
            
            try {
                mostrarLoading();

                // Validar acceso
                const hasAccess = await validatePageAccess('Gestionar formularios');
                if (!hasAccess) return;

                // Obtener usuario actual
                const session = getStoredSession();
                if (!session || !session.user) {
                    redirectToLogin();
                    return;
                }
                currentUser = session.user;

                // Inicializar modales
                modalFormulario = new bootstrap.Modal(document.getElementById('modalFormulario'));
                modalCampo = new bootstrap.Modal(document.getElementById('modalCampo'));

                // Cargar formularios
                await cargarFormularios();

                // Event listeners para filtros y b√∫squeda
                document.getElementById('search-input').addEventListener('input', filtrarFormularios);
                document.getElementById('filter-status').addEventListener('change', filtrarFormularios);

                console.log('‚úÖ M√≥dulo inicializado correctamente');

            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                showMessage('Error al cargar el m√≥dulo: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        });

        // ==========================================
        // CARGAR FORMULARIOS
        // ==========================================
        async function cargarFormularios() {
            try {
                console.log('üìã Cargando formularios...');

                // Obtener formularios con conteo de campos y procedimientos
                const forms = await supabaseRequest('/forms?select=*,form_fields(count),procedures(count)&order=created_at.desc');
                
                formulariosData = forms || [];
                renderizarTablaFormularios(formulariosData);

                console.log(`‚úÖ ${formulariosData.length} formularios cargados`);

            } catch (error) {
                console.error('‚ùå Error cargando formularios:', error);
                showMessage('Error al cargar formularios: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // RENDERIZAR TABLA DE FORMULARIOS
        // ==========================================
        function renderizarTablaFormularios(forms) {
            const tbody = document.getElementById('forms-table-body');
            
            if (!forms || forms.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            No hay formularios para mostrar
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            forms.forEach(form => {
                const fieldsCount = form.form_fields?.[0]?.count || 0;
                const proceduresCount = form.procedures?.[0]?.count || 0;
                const statusBadge = form.form_status === 'active' 
                    ? '<span class="badge bg-success">Activo</span>'
                    : '<span class="badge bg-secondary">Inactivo</span>';
                
                const canDelete = proceduresCount === 0;

                html += `
                    <tr>
                        <td>
                            <strong>${escapeHtml(form.form_name)}</strong>
                        </td>
                        <td>
                            <small class="text-muted">${escapeHtml(form.form_description) || '-'}</small>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-primary">${fieldsCount}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-info">${proceduresCount}</span>
                        </td>
                        <td class="text-center">${statusBadge}</td>
                        <td class="text-center table-actions">
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="verCamposFormulario(${form.form_id})"
                                    title="Ver campos">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="editarFormulario(${form.form_id})"
                                    title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            ${canDelete ? `
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="eliminarFormulario(${form.form_id})"
                                        title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-outline-secondary" 
                                        disabled
                                        title="No se puede eliminar: est√° en uso">
                                    <i class="bi bi-lock"></i>
                                </button>
                            `}
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // ==========================================
        // FILTRAR FORMULARIOS
        // ==========================================
        function filtrarFormularios() {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;

            const filtrados = formulariosData.filter(form => {
                // Filtro por b√∫squeda
                const matchSearch = !searchText || 
                    form.form_name.toLowerCase().includes(searchText) ||
                    (form.form_description && form.form_description.toLowerCase().includes(searchText));

                // Filtro por estado
                const matchStatus = !statusFilter || form.form_status === statusFilter;

                return matchSearch && matchStatus;
            });

            renderizarTablaFormularios(filtrados);
        }

        // ==========================================
        // LIMPIAR FILTROS
        // ==========================================
        function limpiarFiltros() {
            document.getElementById('search-input').value = '';
            document.getElementById('filter-status').value = '';
            renderizarTablaFormularios(formulariosData);
        }

        // ==========================================
        // CONSTANTES DEL SISTEMA
        // ==========================================
        const SYSTEM_TABLES = [
            { value: 'academic_areas', label: '√Åreas Acad√©micas', display_field: 'area_name', order_by: 'area_name' },
            { value: 'courses', label: 'Cursos', display_field: 'course_name', order_by: 'course_order' },
            { value: 'families', label: 'Familias', display_field: 'family_name', order_by: 'family_name' },
            { value: 'genders', label: 'G√©neros', display_field: 'gender_name', order_by: 'gender_name' },
            { value: 'grades', label: 'Grados', display_field: 'grade_name', order_by: 'grade_order' },
            { value: 'job_roles', label: 'Roles de Trabajo', display_field: 'role_name', order_by: 'role_name' },
            { value: 'sections', label: 'Secciones', display_field: 'section_name', order_by: 'section_name' },
            { value: 'students', label: 'Estudiantes', display_field: 'CONCAT', order_by: 'last_name1' },
            { value: 'workers', label: 'Trabajadores', display_field: 'CONCAT', order_by: 'last_name1' }
        ];


        
        // ==========================================
        // ABRIR MODAL CREAR FORMULARIO
        // ==========================================
        function abrirModalCrearFormulario() {
            // Resetear formulario
            document.getElementById('form-formulario').reset();
            document.getElementById('form-id').value = '';
            document.getElementById('modalFormularioTitle').innerHTML = 
                '<i class="bi bi-file-earmark-plus me-2"></i>Nuevo Formulario';
            
            // Limpiar campos temporales
            camposTemporales = [];
            formIdActual = null;
            renderizarCamposTemporales();

            modalFormulario.show();
        }

        // ==========================================
        // EDITAR FORMULARIO
        // ==========================================
        async function editarFormulario(formId) {
            try {
                mostrarLoading();

                // Obtener datos del formulario con sus campos
                const formData = await supabaseRequest(`/forms?select=*,form_fields(*)&form_id=eq.${formId}`);
                
                if (!formData || formData.length === 0) {
                    throw new Error('Formulario no encontrado');
                }

                const form = formData[0];
                formIdActual = formId;

                // Llenar datos generales
                document.getElementById('form-id').value = form.form_id;
                document.getElementById('form-name').value = form.form_name;
                document.getElementById('form-description').value = form.form_description || '';
                
                if (form.form_status === 'active') {
                    document.getElementById('status-active').checked = true;
                } else {
                    document.getElementById('status-inactive').checked = true;
                }

                // Cargar campos del formulario
                camposTemporales = [];
                if (form.form_fields && form.form_fields.length > 0) {
                    for (const field of form.form_fields) {
                        // Si el campo es tipo SELECT, cargar sus opciones
                        let options = [];
                        if (field.field_type === 'select') {
                            const optionsData = await supabaseRequest(
                                `/field_option_catalog?select=*&field_id=eq.${field.field_id}&order=option_order.asc`
                            );
                            options = optionsData || [];
                        }

                        camposTemporales.push({
                            field_id: field.field_id,
                            field_name: field.field_name,
                            field_label: field.field_label,
                            field_type: field.field_type,
                            field_order: field.field_order,
                            is_required: field.is_required,
                            validation_rules: field.validation_rules,
                            is_prefilled: field.is_prefilled,
                            prefill_source: field.prefill_source,
                            
                            system_table_name: field.system_table_name || null,
                            options: options
                        });
                    }
                }

                renderizarCamposTemporales();

                document.getElementById('modalFormularioTitle').innerHTML = 
                    '<i class="bi bi-pencil me-2"></i>Editar Formulario';
                
                modalFormulario.show();

            } catch (error) {
                console.error('‚ùå Error editando formulario:', error);
                showMessage('Error al cargar el formulario: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }

        // ==========================================
        // RENDERIZAR CAMPOS TEMPORALES
        // ==========================================
        function renderizarCamposTemporales() {
            const container = document.getElementById('fields-container');
            
            if (camposTemporales.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                        <p class="mb-0">No hay campos agregados</p>
                        <small>Haz clic en "Agregar Campo" para comenzar</small>
                    </div>
                `;
                return;
            }

            let html = '';
            camposTemporales.forEach((campo, index) => {
                const tipoIcono = {
                    'text': 'bi-input-cursor-text',
                    'textarea': 'bi-textarea-t',
                    'number': 'bi-123',
                    'date': 'bi-calendar-date',
                    'select': 'bi-list-ul',
                    'file': 'bi-paperclip',
                    'boolean': 'bi-toggle-on',
                    'system_table': 'bi-database'
                };

                const tipoLabel = {
                    'text': 'Texto corto',
                    'textarea': 'Texto largo',
                    'number': 'N√∫mero',
                    'date': 'Fecha',
                    'select': 'Selecci√≥n',
                    'file': 'Archivo',
                    'boolean': 'SI/NO',
                    'system_table': 'Tabla del sistema'
                };

                html += `
                    <div class="field-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <div class="field-order-controls">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                                            onclick="moverCampo(${index}, -1)"
                                            ${index === 0 ? 'disabled' : ''}>
                                        <i class="bi bi-arrow-up"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                                            onclick="moverCampo(${index}, 1)"
                                            ${index === camposTemporales.length - 1 ? 'disabled' : ''}>
                                        <i class="bi bi-arrow-down"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col">
                                <div class="d-flex align-items-center">
                                    <i class="bi ${tipoIcono[campo.field_type]} fs-4 text-primary me-3"></i>
                                    <div>
                                        <strong>${escapeHtml(campo.field_label)}</strong>
                                        ${campo.is_required ? '<span class="badge bg-danger ms-2">Obligatorio</span>' : ''}
                                        ${campo.is_prefilled ? '<span class="badge bg-info ms-2">Pre-llenado</span>' : ''}
                                        <br>
                                        <small class="text-muted">
                                            Tipo: ${tipoLabel[campo.field_type]} | 
                                            Nombre: ${escapeHtml(campo.field_name)}
                                            ${campo.field_type === 'system_table' && campo.system_table_name ? 
                                                ` | Tabla: ${campo.system_table_name}` : ''}
                                        </small>
                                        ${campo.field_type === 'select' && campo.options ? 
                                            `<br><small class="text-muted">${campo.options.length} opciones configuradas</small>` 
                                            : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="col-auto">
                                <button type="button" class="btn btn-sm btn-outline-secondary" 
                                        onclick="editarCampo(${index})"
                                        title="Editar campo">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                        onclick="eliminarCampo(${index})"
                                        title="Eliminar campo">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
      // ==========================================
        // ABRIR MODAL AGREGAR CAMPO
        // ==========================================
        function abrirModalCampo() {
            document.getElementById('form-campo').reset();
            document.getElementById('field-id').value = '';
            document.getElementById('field-index').value = '';
            campoEditandoIndex = -1;
            
            document.getElementById('modalCampoTitle').innerHTML = 
                '<i class="bi bi-input-cursor-text me-2"></i>Agregar Campo';
            
            // Ocultar secciones opcionales
            document.getElementById('validation-section').classList.add('d-none');
            document.getElementById('options-section').classList.add('d-none');
            document.getElementById('options-list').innerHTML = '';
            document.getElementById('system-table-name').value = '';
            

            modalCampo.show();
        }

        // ==========================================
        // EDITAR CAMPO
        // ==========================================
        function editarCampo(index) {
            campoEditandoIndex = index;
            const campo = camposTemporales[index];

            document.getElementById('field-index').value = index;
            document.getElementById('field-id').value = campo.field_id || '';
            document.getElementById('field-name').value = campo.field_name;
            document.getElementById('field-label').value = campo.field_label;
            document.getElementById('field-type').value = campo.field_type;
            document.getElementById('field-required').checked = campo.is_required;
            document.getElementById('prefill-source').value = campo.prefill_source || '';
            document.getElementById('system-table-name').value = campo.system_table_name || '';

            // Cargar validaciones si existen
            if (campo.validation_rules) {
                const rules = typeof campo.validation_rules === 'string' 
                    ? JSON.parse(campo.validation_rules) 
                    : campo.validation_rules;
                
                if (rules.format) {
                    document.getElementById('validation-format').value = rules.format;
                }
                if (rules.min !== undefined) {
                    document.getElementById('validation-min').value = rules.min;
                }
                if (rules.max !== undefined) {
                    document.getElementById('validation-max').value = rules.max;
                }
                if (rules.maxFileSize) {
                    document.getElementById('validation-file-size').value = rules.maxFileSize;
                }
                if (rules.allowedTypes) {
                    rules.allowedTypes.forEach(type => {
                        const checkbox = document.getElementById(`file-${type}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            }

            // Si es tipo SELECT, cargar opciones
            if (campo.field_type === 'select' && campo.options) {
                renderizarOpcionesCampo(campo.options);
            }

            actualizarOpcionesCampo();

            document.getElementById('modalCampoTitle').innerHTML = 
                '<i class="bi bi-pencil me-2"></i>Editar Campo';
            
            modalCampo.show();
        }

        // ==========================================
        // ACTUALIZAR OPCIONES DEL CAMPO SEG√öN TIPO
        // ==========================================
        function actualizarOpcionesCampo() {
            const fieldType = document.getElementById('field-type').value;
            
            // Ocultar todas las secciones condicionales
            document.getElementById('validation-section').classList.add('d-none');
            document.getElementById('validation-text').classList.add('d-none');
            document.getElementById('validation-number').classList.add('d-none');
            document.getElementById('validation-file').classList.add('d-none');
            document.getElementById('options-section').classList.add('d-none');
            document.getElementById('system-table-section').classList.add('d-none');

            // Mostrar secciones seg√∫n el tipo
            if (fieldType === 'text' || fieldType === 'textarea') {
                document.getElementById('validation-section').classList.remove('d-none');
                document.getElementById('validation-text').classList.remove('d-none');
            } else if (fieldType === 'number') {
                document.getElementById('validation-section').classList.remove('d-none');
                document.getElementById('validation-number').classList.remove('d-none');
            } else if (fieldType === 'file') {
                document.getElementById('validation-section').classList.remove('d-none');
                document.getElementById('validation-file').classList.remove('d-none');
            } else if (fieldType === 'select') {
                document.getElementById('options-section').classList.remove('d-none');
            } else if (fieldType === 'system_table') {
                document.getElementById('system-table-section').classList.remove('d-none');
            }
        }
        
        // ==========================================
        // AGREGAR OPCI√ìN (para campos SELECT)
        // ==========================================
        function agregarOpcion() {
            const optionText = document.getElementById('new-option-text').value.trim();
            
            if (!optionText) {
                showMessage('Por favor ingresa el texto de la opci√≥n', 'warning');
                return;
            }

            // Obtener opciones actuales
            const optionsList = document.getElementById('options-list');
            const currentOptions = Array.from(optionsList.querySelectorAll('.option-item')).map(item => ({
                option_label: item.dataset.label,
                option_value: item.dataset.value,
                is_active: item.dataset.active === 'true',
                option_order: parseInt(item.dataset.order)
            }));

            // Crear nueva opci√≥n
            const newOption = {
                option_label: optionText,
                option_value: normalizeOptionValue(optionText),
                is_active: true,
                option_order: currentOptions.length + 1
            };

            currentOptions.push(newOption);
            renderizarOpcionesCampo(currentOptions);

            document.getElementById('new-option-text').value = '';
        }

        // ==========================================
        // RENDERIZAR OPCIONES DEL CAMPO SELECT
        // ==========================================
        function renderizarOpcionesCampo(options) {
            const container = document.getElementById('options-list');
            
            if (!options || options.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-2">No hay opciones agregadas</p>';
                return;
            }

            let html = '';
            options.forEach((option, index) => {
                const activeClass = option.is_active ? '' : 'inactive';
                const activeIcon = option.is_active ? 'check-circle-fill' : 'dash-circle';
                const activeText = option.is_active ? 'Activa' : 'Inactiva';
                
                html += `
                    <div class="option-item ${activeClass}" 
                         data-label="${escapeHtml(option.option_label)}"
                         data-value="${escapeHtml(option.option_value)}"
                         data-active="${option.is_active}"
                         data-order="${option.option_order}">
                        <span class="flex-grow-1">
                            <i class="bi ${activeIcon} me-2"></i>
                            ${escapeHtml(option.option_label)}
                            <small class="text-muted">(${escapeHtml(option.option_value)})</small>
                        </span>
                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                onclick="toggleOpcionEstado(${index})"
                                title="${option.is_active ? 'Desactivar' : 'Activar'}">
                            <i class="bi bi-toggle-${option.is_active ? 'on' : 'off'}"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                onclick="eliminarOpcion(${index})"
                                title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ==========================================
        // TOGGLE ESTADO DE OPCI√ìN
        // ==========================================
        function toggleOpcionEstado(index) {
            const optionsList = document.getElementById('options-list');
            const options = Array.from(optionsList.querySelectorAll('.option-item')).map(item => ({
                option_label: item.dataset.label,
                option_value: item.dataset.value,
                is_active: item.dataset.active === 'true',
                option_order: parseInt(item.dataset.order)
            }));

            options[index].is_active = !options[index].is_active;
            renderizarOpcionesCampo(options);
        }

        // ==========================================
        // ELIMINAR OPCI√ìN
        // ==========================================
        function eliminarOpcion(index) {
            if (!confirm('¬øEst√°s seguro de eliminar esta opci√≥n?')) return;

            const optionsList = document.getElementById('options-list');
            const options = Array.from(optionsList.querySelectorAll('.option-item')).map(item => ({
                option_label: item.dataset.label,
                option_value: item.dataset.value,
                is_active: item.dataset.active === 'true',
                option_order: parseInt(item.dataset.order)
            }));

            options.splice(index, 1);
            
            // Reordenar
            options.forEach((opt, idx) => {
                opt.option_order = idx + 1;
            });

            renderizarOpcionesCampo(options);
        }

        // ==========================================
        // GUARDAR CAMPO
        // ==========================================
        function guardarCampo() {
            const fieldName = document.getElementById('field-name').value.trim();
            const fieldLabel = document.getElementById('field-label').value.trim();
            const fieldType = document.getElementById('field-type').value;
            const isRequired = document.getElementById('field-required').checked;
            const prefillSource = document.getElementById('prefill-source').value;

            // Validaciones b√°sicas
            if (!fieldName || !fieldLabel || !fieldType) {
                showMessage('Por favor completa todos los campos obligatorios', 'warning');
                return;
            }

            // Validar nombre √∫nico (excepto si estamos editando el mismo campo)
            const nombreDuplicado = camposTemporales.some((campo, idx) => 
                campo.field_name === fieldName && idx !== campoEditandoIndex
            );

            if (nombreDuplicado) {
                showMessage('Ya existe un campo con ese nombre', 'warning');
                return;
            }

            // Construir validation_rules
            let validationRules = {};

            if (fieldType === 'text') {
                const format = document.getElementById('validation-format').value;
                if (format) validationRules.format = format;
            } else if (fieldType === 'number') {
                const min = document.getElementById('validation-min').value;
                const max = document.getElementById('validation-max').value;
                if (min) validationRules.min = parseFloat(min);
                if (max) validationRules.max = parseFloat(max);
            } else if (fieldType === 'file') {
                const maxSize = document.getElementById('validation-file-size').value;
                validationRules.maxFileSize = parseInt(maxSize);
                
                const allowedTypes = [];
                ['pdf', 'doc', 'xls', 'jpg'].forEach(type => {
                    if (document.getElementById(`file-${type}`).checked) {
                        allowedTypes.push(type);
                    }
                });
                validationRules.allowedTypes = allowedTypes;
            }

            // Obtener opciones si es tipo SELECT
            let options = [];
            if (fieldType === 'select') {
                const optionsList = document.getElementById('options-list');
                options = Array.from(optionsList.querySelectorAll('.option-item')).map(item => ({
                    option_label: item.dataset.label,
                    option_value: item.dataset.value,
                    is_active: item.dataset.active === 'true',
                    option_order: parseInt(item.dataset.order)
                }));

                if (options.length === 0) {
                    showMessage('Debes agregar al menos una opci√≥n para campos de selecci√≥n', 'warning');
                    return;
                }
            }

            // Validar que se haya seleccionado una tabla si el tipo es system_table
            if (fieldType === 'system_table') {
                const systemTableName = document.getElementById('system-table-name').value;
                if (!systemTableName) {
                    showMessage('Debes seleccionar una tabla del sistema', 'warning');
                    return;
                }
            }

            // Crear objeto de campo
            const campo = {
                field_id: document.getElementById('field-id').value || null,
                field_name: fieldName,
                field_label: fieldLabel,
                field_type: fieldType,
                field_order: campoEditandoIndex >= 0 ? camposTemporales[campoEditandoIndex].field_order : camposTemporales.length + 1,
                is_required: isRequired,
                validation_rules: Object.keys(validationRules).length > 0 ? validationRules : null,
                is_prefilled: !!prefillSource,
                prefill_source: prefillSource || null,
                system_table_name: document.getElementById('system-table-name').value || null,
                options: options.length > 0 ? options : null
            };

            // Agregar o actualizar campo
            if (campoEditandoIndex >= 0) {
                camposTemporales[campoEditandoIndex] = campo;
            } else {
                camposTemporales.push(campo);
            }

            renderizarCamposTemporales();
            modalCampo.hide();
            showMessage('Campo guardado correctamente', 'success');
        }

        // ==========================================
        // MOVER CAMPO (REORDENAR)
        // ==========================================
        function moverCampo(index, direction) {
            const newIndex = index + direction;
            
            if (newIndex < 0 || newIndex >= camposTemporales.length) return;

            // Intercambiar posiciones
            [camposTemporales[index], camposTemporales[newIndex]] = 
            [camposTemporales[newIndex], camposTemporales[index]];

            // Actualizar field_order
            camposTemporales.forEach((campo, idx) => {
                campo.field_order = idx + 1;
            });

            renderizarCamposTemporales();
        }

        // ==========================================
        // ELIMINAR CAMPO
        // ==========================================
        function eliminarCampo(index) {
            if (!confirm('¬øEst√°s seguro de eliminar este campo?')) return;

            camposTemporales.splice(index, 1);
            
            // Reordenar
            camposTemporales.forEach((campo, idx) => {
                campo.field_order = idx + 1;
            });

            renderizarCamposTemporales();
            showMessage('Campo eliminado', 'info');
        }

        // ==========================================
        // GUARDAR FORMULARIO
        // ==========================================
        async function guardarFormulario() {
            try {
                const formName = document.getElementById('form-name').value.trim();
                const formDescription = document.getElementById('form-description').value.trim();
                const formStatus = document.querySelector('input[name="form_status"]:checked').value;
                const formId = document.getElementById('form-id').value;

                // Validaciones
                if (!formName) {
                    showMessage('El nombre del formulario es obligatorio', 'warning');
                    return;
                }

                if (camposTemporales.length === 0) {
                    showMessage('Debes agregar al menos un campo al formulario', 'warning');
                    return;
                }

                mostrarLoading();

                // Preparar datos del formulario
                const formData = {
                    form_name: formName,
                    form_description: formDescription,
                    form_status: formStatus,
                    created_by: currentUser.user_id,
                    updated_at: new Date().toISOString()
                };

                let savedFormId;

                if (formId) {
                    // ACTUALIZAR formulario existente
                    await supabaseRequest(`/forms?form_id=eq.${formId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(formData)
                    });
                    savedFormId = parseInt(formId);

                    // Eliminar campos existentes (se recrear√°n)
                    await supabaseRequest(`/form_fields?form_id=eq.${formId}`, {
                        method: 'DELETE'
                    });

                    console.log('‚úÖ Formulario actualizado');

                } else {
                    // CREAR nuevo formulario
                    const result = await supabaseRequest('/forms', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    savedFormId = result[0].form_id;

                    console.log('‚úÖ Formulario creado con ID:', savedFormId);
                }

                // Guardar campos
                for (const campo of camposTemporales) {
                    const fieldData = {
                        form_id: savedFormId,
                        field_name: campo.field_name,
                        field_label: campo.field_label,
                        field_type: campo.field_type,
                        field_order: campo.field_order,
                        is_required: campo.is_required,
                        validation_rules: campo.validation_rules ? JSON.stringify(campo.validation_rules) : null,
                        is_prefilled: campo.is_prefilled,
                        prefill_source: campo.prefill_source,
                        system_table_name: campo.system_table_name || null
                    };

                    const savedField = await supabaseRequest('/form_fields', {
                        method: 'POST',
                        body: JSON.stringify(fieldData)
                    });

                    const fieldId = savedField[0].field_id;

                    // Si el campo es tipo SELECT, guardar opciones
                    if (campo.field_type === 'select' && campo.options) {
                        for (const option of campo.options) {
                            await supabaseRequest('/field_option_catalog', {
                                method: 'POST',
                                body: JSON.stringify({
                                    field_id: fieldId,
                                    option_value: option.option_value,
                                    option_label: option.option_label,
                                    option_order: option.option_order,
                                    is_active: option.is_active
                                })
                            });
                        }
                    }
                }

                showMessage('Formulario guardado exitosamente', 'success');
                modalFormulario.hide();
                await cargarFormularios();

            } catch (error) {
                console.error('‚ùå Error guardando formulario:', error);
                showMessage('Error al guardar el formulario: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }

        // ==========================================
        // VER CAMPOS DEL FORMULARIO
        // ==========================================
        async function verCamposFormulario(formId) {
            try {
                mostrarLoading();

                const formData = await supabaseRequest(
                    `/forms?select=form_name,form_fields(*)&form_id=eq.${formId}`
                );

                if (!formData || formData.length === 0) {
                    throw new Error('Formulario no encontrado');
                }

                const form = formData[0];
                const fields = form.form_fields || [];

                let html = `
                    <div class="modal fade" id="modalVerCampos" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="bi bi-list-check me-2"></i>
                                        Campos de: ${escapeHtml(form.form_name)}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                `;

                if (fields.length === 0) {
                    html += '<p class="text-center text-muted">Este formulario no tiene campos configurados</p>';
                } else {
                    fields.sort((a, b) => a.field_order - b.field_order);
                    
                    fields.forEach((field, index) => {
                        html += `
                            <div class="border rounded p-3 mb-2">
                                <div class="d-flex align-items-start">
                                    <span class="badge bg-primary me-3">${index + 1}</span>
                                    <div class="flex-grow-1">
                                        <strong>${escapeHtml(field.field_label)}</strong>
                                        ${field.is_required ? '<span class="badge bg-danger ms-2">Obligatorio</span>' : ''}
                                        ${field.is_prefilled ? '<span class="badge bg-info ms-2">Pre-llenado</span>' : ''}
                                        <br>
                                        <small class="text-muted">
                                            Tipo: ${field.field_type}
                                            ${field.field_type === 'system_table' && field.system_table_name ? 
                                                ` | Tabla: ${field.system_table_name}` : ''}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                html += `
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        Cerrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Eliminar modal anterior si existe
                const modalAnterior = document.getElementById('modalVerCampos');
                if (modalAnterior) modalAnterior.remove();

                // Agregar nuevo modal
                document.body.insertAdjacentHTML('beforeend', html);
                
                const modal = new bootstrap.Modal(document.getElementById('modalVerCampos'));
                modal.show();

            } catch (error) {
                console.error('‚ùå Error viendo campos:', error);
                showMessage('Error al cargar los campos: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }

        // ==========================================
        // ELIMINAR FORMULARIO
        // ==========================================
        async function eliminarFormulario(formId) {
            if (!confirm('¬øEst√°s seguro de eliminar este formulario? Esta acci√≥n no se puede deshacer.')) {
                return;
            }

            try {
                mostrarLoading();

                // Verificar que no tenga procedimientos asociados
                const procedures = await supabaseRequest(`/procedures?select=procedure_id&form_id=eq.${formId}`);
                
                if (procedures && procedures.length > 0) {
                    showMessage('No se puede eliminar: el formulario est√° siendo usado por procedimientos', 'danger');
                    return;
                }

                // Eliminar campos y sus opciones (cascade deber√≠a manejarlo, pero por si acaso)
                const fields = await supabaseRequest(`/form_fields?select=field_id&form_id=eq.${formId}`);
                
                if (fields) {
                    for (const field of fields) {
                        await supabaseRequest(`/field_option_catalog?field_id=eq.${field.field_id}`, {
                            method: 'DELETE'
                        });
                    }
                }

                await supabaseRequest(`/form_fields?form_id=eq.${formId}`, {
                    method: 'DELETE'
                });

                // Eliminar formulario
                await supabaseRequest(`/forms?form_id=eq.${formId}`, {
                    method: 'DELETE'
                });

                showMessage('Formulario eliminado exitosamente', 'success');
                await cargarFormularios();

            } catch (error) {
                console.error('‚ùå Error eliminando formulario:', error);
                showMessage('Error al eliminar el formulario: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }

        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showMessage(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertDiv = document.createElement('div');
            alertDiv.id = alertId;
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, 5000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function normalizeOptionValue(text) {
            return text
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Eliminar acentos
                .replace(/[^a-z0-9]/g, '_') // Reemplazar caracteres especiales
                .replace(/_+/g, '_') // Eliminar guiones consecutivos
                .replace(/^_|_$/g, ''); // Eliminar guiones al inicio/final
        }

        console.log('‚úÖ Gestionar Formularios cargado correctamente');
    </script>
</body>
</html>
