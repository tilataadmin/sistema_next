<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procedimientos - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge-internal {
            background-color: #0d6efd;
        }

        .badge-external {
            background-color: #6c757d;
        }

        .status-active {
            color: #198754;
        }

        .status-inactive {
            color: #dc3545;
        }

        .table-actions {
            white-space: nowrap;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="container-fluid">
        
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Procedimientos</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Maestro de Procedimientos
                </li>
            </ol>
        </nav>

        <!-- Encabezado de P√°gina -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-diagram-3 me-2"></i>
                    Maestro de Procedimientos
                </h1>
                <p class="text-muted">
                    Configure y administre los procedimientos institucionales con sus flujos de trabajo
                </p>
            </div>
        </div>

        <!-- Contenedor de Alertas -->
        <div id="alertContainer"></div>

        <!-- Card con Tabla de Procedimientos -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>Procedimientos Configurados
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" onclick="cargarProcedimientos()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                    </button>
                    <button class="btn btn-primary" onclick="abrirModalNuevoProcedimiento()">
                        <i class="bi bi-plus-circle me-1"></i>Nuevo Procedimiento
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tabla-procedimientos">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 5%">#</th>
                                <th style="width: 20%">Nombre</th>
                                <th style="width: 25%">Descripci√≥n</th>
                                <th style="width: 10%">Tipo</th>
                                <th style="width: 15%">Formulario</th>
                                <th style="width: 10%">Estado</th>
                                <th style="width: 15%" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-procedimientos">
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <div class="mt-2">Cargando procedimientos...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let procedimientosCache = [];
        let formulariosCache = [];
        let modalProcedimiento = null;
        
        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê Iniciando validaci√≥n de acceso...');
            
            try {
                // Validar permisos
                const hasAccess = await validatePageAccess('Procedimientos');
                if (!hasAccess) {
                    console.log('‚ùå Acceso denegado - deteniendo inicializaci√≥n');
                    return;
                }
                
                console.log('‚úÖ Acceso permitido - continuando con inicializaci√≥n');
                
                // Inicializar p√°gina
                await inicializarPagina();
                
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n de acceso:', error);
                showMessage('Error de validaci√≥n de permisos', 'danger');
            }
        });
        
        // ==========================================
        // FUNCI√ìN DE INICIALIZACI√ìN
        // ==========================================
        async function inicializarPagina() {
            console.log('üöÄ Inicializando p√°gina de procedimientos...');
            
            try {
                mostrarLoading();
                
                // Cargar datos iniciales
                await cargarFormularios();
                await cargarProcedimientos();
                
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al inicializar la p√°gina: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CARGAR FORMULARIOS
        // ==========================================
        async function cargarFormularios() {
            console.log('üìã Cargando formularios disponibles...');
            
            try {
                const data = await supabaseRequest('/forms?select=form_id,form_name,form_status&form_status=eq.active&order=form_name');
                formulariosCache = data || [];
                console.log(`‚úÖ ${formulariosCache.length} formularios cargados`);
                
            } catch (error) {
                console.error('‚ùå Error cargando formularios:', error);
                throw error;
            }
        }
        
        // ==========================================
        // CARGAR PROCEDIMIENTOS
        // ==========================================
        async function cargarProcedimientos() {
            console.log('üìä Cargando procedimientos...');
            
            try {
                mostrarLoading();
                
                // Cargar procedimientos con informaci√≥n del formulario y creador
                const data = await supabaseRequest('/procedures?select=procedure_id,procedure_name,procedure_description,procedure_type,procedure_status,form_id,forms(form_name),created_by,users(user_first_name,user_last_name),created_at&order=procedure_name');
                
                procedimientosCache = data || [];
                console.log(`‚úÖ ${procedimientosCache.length} procedimientos cargados`);
                
                renderizarTablaProcedimientos();
                
            } catch (error) {
                console.error('‚ùå Error cargando procedimientos:', error);
                showMessage('Error al cargar procedimientos: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // RENDERIZAR TABLA DE PROCEDIMIENTOS
        // ==========================================
        function renderizarTablaProcedimientos() {
            console.log('üé® Renderizando tabla de procedimientos...');
            
            const tbody = document.getElementById('tbody-procedimientos');
            
            if (procedimientosCache.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-inbox" style="font-size: 3rem; color: #dee2e6;"></i>
                            <p class="text-muted mt-2 mb-0">No hay procedimientos configurados</p>
                            <button class="btn btn-sm btn-primary mt-2" onclick="abrirModalNuevoProcedimiento()">
                                <i class="bi bi-plus-circle me-1"></i>Crear Primer Procedimiento
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            procedimientosCache.forEach((proc, index) => {
                const formName = proc.forms?.form_name || 'Sin formulario';
                const typeClass = proc.procedure_type === 'internal' ? 'badge-internal' : 'badge-external';
                const typeText = proc.procedure_type === 'internal' ? 'Interno' : 'Externo';
                const statusClass = proc.procedure_status === 'active' ? 'status-active' : 'status-inactive';
                const statusIcon = proc.procedure_status === 'active' ? 'check-circle-fill' : 'x-circle-fill';
                const statusText = proc.procedure_status === 'active' ? 'Activo' : 'Inactivo';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <strong>${escapeHtml(proc.procedure_name)}</strong>
                        </td>
                        <td>
                            <small class="text-muted">
                                ${escapeHtml(proc.procedure_description || 'Sin descripci√≥n')}
                            </small>
                        </td>
                        <td>
                            <span class="badge ${typeClass}">${typeText}</span>
                        </td>
                        <td>
                            <small>${escapeHtml(formName)}</small>
                        </td>
                        <td>
                            <i class="bi bi-${statusIcon} ${statusClass}"></i>
                            <span class="${statusClass}">${statusText}</span>
                        </td>
                        <td class="text-center table-actions">
                            <button class="btn btn-sm btn-info" onclick="verProcedimiento(${proc.procedure_id})" title="Ver detalles">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="editarProcedimiento(${proc.procedure_id})" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm ${proc.procedure_status === 'active' ? 'btn-danger' : 'btn-success'}" 
                                    onclick="cambiarEstadoProcedimiento(${proc.procedure_id}, '${proc.procedure_status}')" 
                                    title="${proc.procedure_status === 'active' ? 'Desactivar' : 'Activar'}">
                                <i class="bi bi-${proc.procedure_status === 'active' ? 'toggle-off' : 'toggle-on'}"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            console.log('‚úÖ Tabla renderizada correctamente');
        }
        // ==========================================
        // VER PROCEDIMIENTO
        // ==========================================
        function verProcedimiento(procedureId) {
            console.log('üëÅÔ∏è Ver procedimiento:', procedureId);
            // TODO: Implementar modal de vista detallada
            showMessage('Funci√≥n de vista en desarrollo', 'info');
        }
        
        // ==========================================
        // EDITAR PROCEDIMIENTO
        // ==========================================
        async function editarProcedimiento(procedureId) {
            console.log('‚úèÔ∏è Editar procedimiento:', procedureId);
            
            try {
                mostrarLoading();
                
                // Verificar si tiene instancias activas
                const instances = await supabaseRequest('/procedure_instances?select=instance_id&procedure_id=eq.' + procedureId + '&instance_status=neq.completed&instance_status=neq.cancelled');
                
                if (instances && instances.length > 0) {
                    ocultarLoading();
                    showMessage('No se puede editar este procedimiento porque tiene instancias activas. Debe esperar a que se completen o cancelen.', 'warning');
                    return;
                }
                
                // TODO: Abrir modal de edici√≥n con pasos
                showMessage('Modal de edici√≥n en desarrollo', 'info');
                
            } catch (error) {
                console.error('‚ùå Error verificando instancias:', error);
                showMessage('Error al verificar instancias: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // CAMBIAR ESTADO DE PROCEDIMIENTO
        // ==========================================
        async function cambiarEstadoProcedimiento(procedureId, estadoActual) {
            console.log('üîÑ Cambiar estado del procedimiento:', procedureId);
            
            const nuevoEstado = estadoActual === 'active' ? 'inactive' : 'active';
            const accion = nuevoEstado === 'active' ? 'activar' : 'desactivar';
            
            if (!confirm(`¬øEst√° seguro de ${accion} este procedimiento?`)) {
                return;
            }
            
            try {
                mostrarLoading();
                
                await supabaseRequest('/procedures?procedure_id=eq.' + procedureId, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        procedure_status: nuevoEstado,
                        updated_at: new Date().toISOString()
                    })
                });
                
                showMessage(`Procedimiento ${accion === 'activar' ? 'activado' : 'desactivado'} exitosamente`, 'success');
                await cargarProcedimientos();
                
            } catch (error) {
                console.error('‚ùå Error cambiando estado:', error);
                showMessage('Error al cambiar estado: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // ABRIR MODAL NUEVO PROCEDIMIENTO
        // ==========================================
        function abrirModalNuevoProcedimiento() {
            console.log('‚ûï Abrir modal nuevo procedimiento');
            // TODO: Implementar modal de creaci√≥n
            showMessage('Modal de creaci√≥n en desarrollo', 'info');
        }
        
        // ==========================================
        // FUNCIONES DE UTILIDAD
        // ==========================================
        function mostrarLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function ocultarLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==========================================
        // HACER FUNCIONES DISPONIBLES GLOBALMENTE
        // ==========================================
        window.cargarProcedimientos = cargarProcedimientos;
        window.verProcedimiento = verProcedimiento;
        window.editarProcedimiento = editarProcedimiento;
        window.cambiarEstadoProcedimiento = cambiarEstadoProcedimiento;
        window.abrirModalNuevoProcedimiento = abrirModalNuevoProcedimiento;
        
        console.log('üéâ Procedures.html - Fragmento 1 cargado correctamente');
    </script>
</body>
</html>
<!-- MODAL DE PROCEDIMIENTO - Insertar antes del cierre de </div> del container-fluid -->
    
    <!-- Modal de Configuraci√≥n de Procedimiento -->
    <div class="modal fade" id="modalProcedimiento" tabindex="-1" aria-labelledby="modalProcedimientoLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalProcedimientoLabel">
                        <i class="bi bi-diagram-3 me-2"></i>
                        <span id="modal-title-text">Nuevo Procedimiento</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <!-- Tabs de Navegaci√≥n -->
                    <ul class="nav nav-tabs mb-4" id="procedureTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-panel" type="button" role="tab">
                                <i class="bi bi-info-circle me-1"></i>
                                Informaci√≥n B√°sica
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="steps-tab" data-bs-toggle="tab" data-bs-target="#steps-panel" type="button" role="tab" disabled>
                                <i class="bi bi-list-ol me-1"></i>
                                Pasos del Procedimiento
                            </button>
                        </li>
                    </ul>

                    <!-- Contenido de Tabs -->
                    <div class="tab-content" id="procedureTabContent">
                        
                        <!-- TAB 1: INFORMACI√ìN B√ÅSICA -->
                        <div class="tab-pane fade show active" id="info-panel" role="tabpanel">
                            <form id="formInfoBasica">
                                <input type="hidden" id="procedure_id" name="procedure_id">
                                
                                <!-- Nombre del Procedimiento -->
                                <div class="mb-3">
                                    <label for="procedure_name" class="form-label">
                                        Nombre del Procedimiento <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="procedure_name" 
                                           name="procedure_name" 
                                           placeholder="Ej: Solicitud de Permiso Docente"
                                           required>
                                    <div class="form-text">
                                        Nombre descriptivo que identifica el procedimiento
                                    </div>
                                </div>

                                <!-- Descripci√≥n -->
                                <div class="mb-3">
                                    <label for="procedure_description" class="form-label">
                                        Descripci√≥n
                                    </label>
                                    <textarea class="form-control" 
                                              id="procedure_description" 
                                              name="procedure_description" 
                                              rows="3"
                                              placeholder="Describe el prop√≥sito y alcance del procedimiento"></textarea>
                                    <div class="form-text">
                                        Explicaci√≥n del prop√≥sito del procedimiento
                                    </div>
                                </div>

                                <!-- Tipo de Procedimiento -->
                                <div class="mb-3">
                                    <label for="procedure_type" class="form-label">
                                        Tipo de Procedimiento <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" 
                                            id="procedure_type" 
                                            name="procedure_type" 
                                            required>
                                        <option value="">Seleccione el tipo...</option>
                                        <option value="internal">Interno (Requiere autenticaci√≥n)</option>
                                        <option value="external">Externo (P√∫blico con captcha)</option>
                                    </select>
                                    <div class="form-text">
                                        <strong>Interno:</strong> Solo usuarios del sistema pueden iniciar el procedimiento<br>
                                        <strong>Externo:</strong> Cualquier persona puede iniciar el procedimiento (con captcha)
                                    </div>
                                </div>

                                <!-- Formulario Asociado -->
                                <div class="mb-3">
                                    <label for="form_id" class="form-label">
                                        Formulario Asociado <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" 
                                            id="form_id" 
                                            name="form_id" 
                                            required>
                                        <option value="">Seleccione un formulario...</option>
                                        <!-- Opciones cargadas din√°micamente -->
                                    </select>
                                    <div class="form-text">
                                        Formulario que se utilizar√° para capturar la informaci√≥n inicial
                                    </div>
                                </div>

                                <!-- Estado -->
                                <div class="mb-3">
                                    <label for="procedure_status" class="form-label">
                                        Estado <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" 
                                            id="procedure_status" 
                                            name="procedure_status" 
                                            required>
                                        <option value="active">Activo</option>
                                        <option value="inactive">Inactivo</option>
                                    </select>
                                    <div class="form-text">
                                        <strong>Activo:</strong> El procedimiento puede ejecutarse<br>
                                        <strong>Inactivo:</strong> No se pueden iniciar nuevas instancias
                                    </div>
                                </div>

                                <!-- Botones de Acci√≥n -->
                                <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-circle me-1"></i>Cancelar
                                    </button>
                                    <div>
                                        <button type="button" class="btn btn-primary" onclick="guardarInfoBasica()">
                                            <i class="bi bi-save me-1"></i>Guardar Informaci√≥n
                                        </button>
                                        <button type="button" class="btn btn-success" onclick="guardarYContinuar()" id="btn-guardar-continuar">
                                            <i class="bi bi-arrow-right-circle me-1"></i>Guardar y Configurar Pasos
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- TAB 2: PASOS DEL PROCEDIMIENTO -->
                        <div class="tab-pane fade" id="steps-panel" role="tabpanel">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                El dise√±ador de pasos estar√° disponible en el siguiente fragmento
                            </div>
                            
                            <!-- Aqu√≠ ir√° el dise√±ador de pasos en el FRAGMENTO 3 -->
                            <div id="steps-designer-container">
                                <!-- Contenido del dise√±ador de pasos -->
                            </div>
                        </div>

                    </div>
                </div>

                <div class="modal-footer bg-light">
                    <small class="text-muted me-auto">
                        <i class="bi bi-info-circle me-1"></i>
                        Los campos marcados con <span class="text-danger">*</span> son obligatorios
                    </small>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    // ==========================================
        // VARIABLES GLOBALES ADICIONALES PARA MODAL
        // ==========================================
        let procedimientoEnEdicion = null;
        let modoEdicion = false;
        
        // ==========================================
        // ABRIR MODAL NUEVO PROCEDIMIENTO (ACTUALIZADO)
        // ==========================================
        function abrirModalNuevoProcedimiento() {
            console.log('‚ûï Abrir modal nuevo procedimiento');
            
            // Resetear modo
            modoEdicion = false;
            procedimientoEnEdicion = null;
            
            // Configurar modal para creaci√≥n
            document.getElementById('modal-title-text').textContent = 'Nuevo Procedimiento';
            document.getElementById('formInfoBasica').reset();
            document.getElementById('procedure_id').value = '';
            
            // Cargar formularios en el select
            cargarFormulariosEnSelect();
            
            // Habilitar solo el tab de informaci√≥n b√°sica
            document.getElementById('steps-tab').disabled = true;
            document.getElementById('info-tab').click();
            
            // Mostrar bot√≥n de guardar y continuar
            document.getElementById('btn-guardar-continuar').style.display = 'inline-block';
            
            // Mostrar modal
            if (!modalProcedimiento) {
                modalProcedimiento = new bootstrap.Modal(document.getElementById('modalProcedimiento'));
            }
            modalProcedimiento.show();
        }
        
        // ==========================================
        // CARGAR FORMULARIOS EN SELECT
        // ==========================================
        function cargarFormulariosEnSelect() {
            console.log('üìã Cargando formularios en select...');
            
            const select = document.getElementById('form_id');
            select.innerHTML = '<option value="">Seleccione un formulario...</option>';
            
            formulariosCache.forEach(form => {
                const option = document.createElement('option');
                option.value = form.form_id;
                option.textContent = form.form_name;
                select.appendChild(option);
            });
            
            console.log(`‚úÖ ${formulariosCache.length} formularios cargados en select`);
        }
        
        // ==========================================
        // GUARDAR INFORMACI√ìN B√ÅSICA
        // ==========================================
        async function guardarInfoBasica() {
            console.log('üíæ Guardando informaci√≥n b√°sica...');
            
            const form = document.getElementById('formInfoBasica');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            try {
                mostrarLoading();
                
                const formData = new FormData(form);
                const procedureId = formData.get('procedure_id');
                
                const datos = {
                    procedure_name: formData.get('procedure_name'),
                    procedure_description: formData.get('procedure_description') || null,
                    procedure_type: formData.get('procedure_type'),
                    form_id: parseInt(formData.get('form_id')),
                    procedure_status: formData.get('procedure_status'),
                    updated_at: new Date().toISOString()
                };
                
                if (procedureId) {
                    // ACTUALIZAR
                    console.log('üìù Actualizando procedimiento existente:', procedureId);
                    
                    await supabaseRequest('/procedures?procedure_id=eq.' + procedureId, {
                        method: 'PATCH',
                        body: JSON.stringify(datos)
                    });
                    
                    showMessage('Procedimiento actualizado exitosamente', 'success');
                    
                } else {
                    // CREAR NUEVO
                    console.log('‚ú® Creando nuevo procedimiento');
                    
                    // Agregar campos de creaci√≥n
                    const session = getStoredSession();
                    datos.created_by = session?.user?.user_id || null;
                    datos.created_at = new Date().toISOString();
                    
                    const response = await supabaseRequest('/procedures?select=procedure_id', {
                        method: 'POST',
                        body: JSON.stringify(datos)
                    });
                    
                    if (response && response.length > 0) {
                        procedimientoEnEdicion = response[0].procedure_id;
                        document.getElementById('procedure_id').value = procedimientoEnEdicion;
                        modoEdicion = true;
                        console.log('‚úÖ Procedimiento creado con ID:', procedimientoEnEdicion);
                    }
                    
                    showMessage('Procedimiento creado exitosamente', 'success');
                }
                
                // Recargar tabla
                await cargarProcedimientos();
                
                // Si solo guardamos (no continuar), cerrar modal
                modalProcedimiento.hide();
                
            } catch (error) {
                console.error('‚ùå Error guardando informaci√≥n b√°sica:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // GUARDAR Y CONTINUAR A PASOS
        // ==========================================
        async function guardarYContinuar() {
            console.log('‚è© Guardar y continuar a pasos...');
            
            const form = document.getElementById('formInfoBasica');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            try {
                mostrarLoading();
                
                const formData = new FormData(form);
                const procedureId = formData.get('procedure_id');
                
                const datos = {
                    procedure_name: formData.get('procedure_name'),
                    procedure_description: formData.get('procedure_description') || null,
                    procedure_type: formData.get('procedure_type'),
                    form_id: parseInt(formData.get('form_id')),
                    procedure_status: formData.get('procedure_status'),
                    updated_at: new Date().toISOString()
                };
                
                if (procedureId) {
                    // ACTUALIZAR
                    await supabaseRequest('/procedures?procedure_id=eq.' + procedureId, {
                        method: 'PATCH',
                        body: JSON.stringify(datos)
                    });
                    
                    procedimientoEnEdicion = parseInt(procedureId);
                    
                } else {
                    // CREAR NUEVO
                    const session = getStoredSession();
                    datos.created_by = session?.user?.user_id || null;
                    datos.created_at = new Date().toISOString();
                    
                    const response = await supabaseRequest('/procedures?select=procedure_id', {
                        method: 'POST',
                        body: JSON.stringify(datos)
                    });
                    
                    if (response && response.length > 0) {
                        procedimientoEnEdicion = response[0].procedure_id;
                        document.getElementById('procedure_id').value = procedimientoEnEdicion;
                    }
                }
                
                modoEdicion = true;
                
                // Recargar tabla
                await cargarProcedimientos();
                
                // Habilitar tab de pasos
                document.getElementById('steps-tab').disabled = false;
                
                // Cambiar al tab de pasos
                document.getElementById('steps-tab').click();
                
                showMessage('Informaci√≥n guardada. Ahora configure los pasos del procedimiento', 'success');
                
            } catch (error) {
                console.error('‚ùå Error guardando y continuando:', error);
                showMessage('Error al guardar: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // EDITAR PROCEDIMIENTO (ACTUALIZADO)
        // ==========================================
        async function editarProcedimiento(procedureId) {
            console.log('‚úèÔ∏è Editar procedimiento:', procedureId);
            
            try {
                mostrarLoading();
                
                // Verificar si tiene instancias activas
                const instances = await supabaseRequest('/procedure_instances?select=instance_id&procedure_id=eq.' + procedureId + '&instance_status=neq.completed&instance_status=neq.cancelled');
                
                if (instances && instances.length > 0) {
                    ocultarLoading();
                    showMessage('No se puede editar este procedimiento porque tiene instancias activas. Debe esperar a que se completen o cancelen.', 'warning');
                    return;
                }
                
                // Cargar datos del procedimiento
                const data = await supabaseRequest('/procedures?select=*&procedure_id=eq.' + procedureId);
                
                if (!data || data.length === 0) {
                    throw new Error('Procedimiento no encontrado');
                }
                
                const procedimiento = data[0];
                
                // Configurar modo edici√≥n
                modoEdicion = true;
                procedimientoEnEdicion = procedureId;
                
                // Configurar modal para edici√≥n
                document.getElementById('modal-title-text').textContent = 'Editar Procedimiento';
                
                // Cargar datos en el formulario
                document.getElementById('procedure_id').value = procedimiento.procedure_id;
                document.getElementById('procedure_name').value = procedimiento.procedure_name;
                document.getElementById('procedure_description').value = procedimiento.procedure_description || '';
                document.getElementById('procedure_type').value = procedimiento.procedure_type;
                document.getElementById('procedure_status').value = procedimiento.procedure_status;
                
                // Cargar formularios y seleccionar el actual
                cargarFormulariosEnSelect();
                document.getElementById('form_id').value = procedimiento.form_id;
                
                // Habilitar tab de pasos
                document.getElementById('steps-tab').disabled = false;
                
                // Ir al tab de informaci√≥n b√°sica
                document.getElementById('info-tab').click();
                
                // Ocultar bot√≥n de guardar y continuar (ya est√° creado)
                document.getElementById('btn-guardar-continuar').style.display = 'none';
                
                // Mostrar modal
                if (!modalProcedimiento) {
                    modalProcedimiento = new bootstrap.Modal(document.getElementById('modalProcedimiento'));
                }
                modalProcedimiento.show();
                
            } catch (error) {
                console.error('‚ùå Error cargando procedimiento:', error);
                showMessage('Error al cargar procedimiento: ' + error.message, 'danger');
            } finally {
                ocultarLoading();
            }
        }
        
        // ==========================================
        // ACTUALIZAR FUNCIONES GLOBALES
        // ==========================================
        window.abrirModalNuevoProcedimiento = abrirModalNuevoProcedimiento;
        window.editarProcedimiento = editarProcedimiento;
        window.guardarInfoBasica = guardarInfoBasica;
        window.guardarYContinuar = guardarYContinuar;
        
        console.log('üéâ Procedures.html - Fragmento 2 cargado correctamente');
    </script>
</body>
</html>
