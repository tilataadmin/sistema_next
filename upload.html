<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="page-version" content="25.01.03.14.30">
    <title>Prueba Upload Storage - SchoolNet</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .upload-container {
            max-width: 900px;
            margin: 2rem auto;
        }
        
        .upload-zone {
            border: 3px dashed #dee2e6;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            margin: 2rem 0;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .upload-zone:hover {
            border-color: #0d6efd;
            background: #e7f3ff;
        }
        
        .upload-zone.dragover {
            border-color: #198754;
            background: #d1e7dd;
        }
        
        .file-preview {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .test-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        
        .log-container {
            background: #212529;
            color: #0f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 2rem;
        }
        
        .log-entry {
            margin: 0.25rem 0;
        }
        
        .log-success {
            color: #0f0;
        }
        
        .log-error {
            color: #f00;
        }
        
        .log-info {
            color: #0ff;
        }
    </style>
</head>
<body>
    <!-- Navbar placeholder -->
    <div id="navbar-placeholder"></div>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/dashboard.html">Dashboard</a></li>
                <li class="breadcrumb-item active">Prueba Upload Storage</li>
            </ol>
        </nav>

        <div class="upload-container">
            <!-- Page Header -->
            <div class="text-center mb-4">
                <h2><i class="bi bi-cloud-upload me-2"></i>Prueba de Upload - Supabase Storage</h2>
                <p class="text-muted">Prueba de subida de archivos usando el rol <code>anon</code></p>
            </div>

            <!-- Test Info -->
            <div class="test-info">
                <h5><i class="bi bi-info-circle me-2"></i>Informaci√≥n de la Prueba</h5>
                <ul class="mb-0">
                    <li><strong>Bucket:</strong> <code>test-uploads</code></li>
                    <li><strong>Rol:</strong> <code>anon</code> (usuarios sin cuenta de Supabase Auth)</li>
                    <li><strong>Usuario actual:</strong> <span id="current-user-name">Cargando...</span></li>
                    <li><strong>L√≠mite:</strong> 10 MB por archivo</li>
                    <li><strong>Pol√≠ticas RLS:</strong> INSERT y SELECT habilitadas para rol <code>anon</code></li>
                </ul>
            </div>

            <!-- Upload Zone -->
            <div class="upload-zone" id="upload-zone">
                <i class="bi bi-cloud-upload" style="font-size: 4rem; color: #6c757d;"></i>
                <h4 class="mt-3">Arrastra un archivo aqu√≠</h4>
                <p class="text-muted">o haz click para seleccionar</p>
                <input type="file" id="file-input" class="d-none">
                <button type="button" class="btn btn-primary mt-3" onclick="document.getElementById('file-input').click()">
                    <i class="bi bi-folder2-open me-2"></i>Seleccionar Archivo
                </button>
            </div>

            <!-- File Preview -->
            <div id="file-preview" class="file-preview d-none">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-file-earmark me-2"></i>
                        <strong id="file-name">archivo.pdf</strong>
                        <span class="text-muted ms-2" id="file-size">0 KB</span>
                    </div>
                    <div>
                        <button type="button" class="btn btn-success" onclick="uploadFile()">
                            <i class="bi bi-upload me-2"></i>Subir Archivo
                        </button>
                        <button type="button" class="btn btn-danger" onclick="clearFile()">
                            <i class="bi bi-x-circle me-2"></i>Cancelar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Upload Progress -->
            <div id="upload-progress" class="d-none mt-3">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">
                        Subiendo...
                    </div>
                </div>
            </div>

            <!-- Upload Result -->
            <div id="upload-result" class="d-none mt-3"></div>

            <!-- Logs -->
            <div class="log-container" id="log-container">
                <div class="log-entry log-info">üîß Consola de logs inicializada...</div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Config.js -->
    <script src="/assets/js/config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let selectedFile = null;
        let supabaseClient = null;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                addLog('üîê Validando acceso...', 'info');
                
                // Validar que el usuario est√© logueado
                const session = getStoredSession();
                if (!session || !session.user) {
                    addLog('‚ùå No hay sesi√≥n activa - redirigiendo a login', 'error');
                    window.location.href = '/index.html';
                    return;
                }

                addLog('‚úÖ Usuario autenticado: ' + session.user.user_display_name, 'success');
                document.getElementById('current-user-name').textContent = session.user.user_display_name;

                // Inicializar cliente de Supabase
                addLog('üîß Inicializando cliente de Supabase...', 'info');
                addLog('üìç URL: ' + SUPABASE_CONFIG.url, 'info');
                addLog('üîë Usando anon key (primeros 20 chars): ' + SUPABASE_CONFIG.anonKey.substring(0, 20) + '...', 'info');
                
                supabaseClient = supabase.createClient(
                    SUPABASE_CONFIG.url,
                    SUPABASE_CONFIG.anonKey
                );

                addLog('‚úÖ Cliente de Supabase inicializado', 'success');
                
                // Probar conexi√≥n listando archivos del bucket
                await testStorageConnection();

                // Setup drag and drop
                setupDragAndDrop();

                addLog('‚úÖ Sistema listo para pruebas', 'success');

            } catch (error) {
                addLog('‚ùå Error en inicializaci√≥n: ' + error.message, 'error');
                console.error('Error:', error);
            }
        });

        // ==========================================
        // TEST DE CONEXI√ìN
        // ==========================================
        async function testStorageConnection() {
            try {
                addLog('üîç Probando conexi√≥n con Storage...', 'info');
                
                const { data, error } = await supabaseClient
                    .storage
                    .from('test-uploads')
                    .list('', {
                        limit: 5,
                        offset: 0
                    });

                if (error) {
                    addLog('‚ö†Ô∏è Error al listar archivos: ' + error.message, 'error');
                    addLog('üîç Detalles del error: ' + JSON.stringify(error), 'error');
                } else {
                    addLog('‚úÖ Conexi√≥n exitosa con bucket test-uploads', 'success');
                    addLog('üìÅ Archivos en bucket: ' + (data?.length || 0), 'info');
                }
            } catch (error) {
                addLog('‚ùå Error en test de conexi√≥n: ' + error.message, 'error');
            }
        }

        // ==========================================
        // DRAG AND DROP
        // ==========================================
        function setupDragAndDrop() {
            const uploadZone = document.getElementById('upload-zone');

            uploadZone.addEventListener('click', () => {
                document.getElementById('file-input').click();
            });

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            document.getElementById('file-input').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        // ==========================================
        // MANEJO DE ARCHIVO SELECCIONADO
        // ==========================================
        function handleFileSelect(file) {
            // Validar tama√±o (10MB)
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                addLog('‚ùå Archivo excede el l√≠mite de 10MB', 'error');
                alert('El archivo excede el l√≠mite de 10MB');
                return;
            }

            selectedFile = file;
            addLog('üìé Archivo seleccionado: ' + file.name + ' (' + formatFileSize(file.size) + ')', 'info');

            // Mostrar preview
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-size').textContent = formatFileSize(file.size);
            document.getElementById('file-preview').classList.remove('d-none');
            document.getElementById('upload-result').classList.add('d-none');
        }

        // ==========================================
        // SUBIR ARCHIVO
        // ==========================================
        async function uploadFile() {
            if (!selectedFile) {
                addLog('‚ö†Ô∏è No hay archivo seleccionado', 'error');
                return;
            }

            try {
                addLog('üöÄ Iniciando upload...', 'info');
                
                // Mostrar progress
                document.getElementById('upload-progress').classList.remove('d-none');
                document.getElementById('file-preview').classList.add('d-none');

                // Generar nombre √∫nico
                const timestamp = Date.now();
                const fileName = `${timestamp}_${selectedFile.name}`;
                const filePath = `test/${fileName}`;

                addLog('üìù Nombre del archivo: ' + fileName, 'info');
                addLog('üìç Ruta en bucket: ' + filePath, 'info');

                // Subir archivo
                const { data, error } = await supabaseClient
                    .storage
                    .from('test-uploads')
                    .upload(filePath, selectedFile, {
                        cacheControl: '3600',
                        upsert: false
                    });

                // Ocultar progress
                document.getElementById('upload-progress').classList.add('d-none');

                if (error) {
                    throw error;
                }

                addLog('‚úÖ Archivo subido exitosamente!', 'success');
                addLog('üì¶ Data: ' + JSON.stringify(data), 'success');

                // Obtener URL p√∫blica
                const { data: urlData } = supabaseClient
                    .storage
                    .from('test-uploads')
                    .getPublicUrl(filePath);

                addLog('üîó URL p√∫blica: ' + urlData.publicUrl, 'success');

                // Mostrar resultado
                showUploadResult(true, fileName, urlData.publicUrl);

                // Limpiar
                clearFile();

            } catch (error) {
                document.getElementById('upload-progress').classList.add('d-none');
                addLog('‚ùå Error al subir archivo: ' + error.message, 'error');
                addLog('üîç Detalles del error: ' + JSON.stringify(error), 'error');
                showUploadResult(false, error.message);
            }
        }

        // ==========================================
        // MOSTRAR RESULTADO
        // ==========================================
        function showUploadResult(success, fileName, fileUrl = null) {
            const resultDiv = document.getElementById('upload-result');
            resultDiv.classList.remove('d-none');

            if (success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle me-2"></i>¬°Upload Exitoso!</h5>
                        <p class="mb-2"><strong>Archivo:</strong> ${fileName}</p>
                        <p class="mb-2"><strong>URL:</strong></p>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" value="${fileUrl}" readonly>
                            <button class="btn btn-outline-secondary" onclick="copyToClipboard('${fileUrl}')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                        <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-primary">
                            <i class="bi bi-eye me-2"></i>Ver archivo
                        </a>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-x-circle me-2"></i>Error en Upload</h5>
                        <p class="mb-0">${fileName}</p>
                    </div>
                `;
            }
        }

        // ==========================================
        // LIMPIAR ARCHIVO
        // ==========================================
        function clearFile() {
            selectedFile = null;
            document.getElementById('file-input').value = '';
            document.getElementById('file-preview').classList.add('d-none');
            addLog('üóëÔ∏è Archivo limpiado', 'info');
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                addLog('üìã URL copiada al portapapeles', 'success');
                alert('URL copiada al portapapeles');
            });
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Tambi√©n loguear en consola
            console.log(message);
        }

        // Hacer funciones disponibles globalmente
        window.uploadFile = uploadFile;
        window.clearFile = clearFile;

        console.log('üéâ upload.html cargado correctamente');
    </script>
</body>
</html>
