<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXT - Crear Usuario</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 50px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .form-container {
            padding: 40px;
        }
        
        .form-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .form-label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .required {
            color: #e74c3c;
        }
        
        .role-item {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .role-item:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .role-item.selected {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .loading {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <div class="main-container">
                    <!-- Header -->
                    <div class="header">
                        <h1><i class="bi bi-person-plus-fill me-2"></i>NEXT - Crear Usuario</h1>
                        <p class="mb-0">Administración de Usuarios del Sistema</p>
                    </div>
                    
                    <!-- Form Container -->
                    <div class="form-container">
                        <!-- Alert Messages -->
                        <div id="alertContainer"></div>
                        
                        <!-- User Creation Form -->
                        <form id="userForm">
                            <div class="row">
                                <!-- Información Básica -->
                                <div class="col-md-6">
                                    <h5 class="mb-3"><i class="bi bi-person-circle me-2"></i>Información Básica</h5>
                                    
                                    <div class="mb-3">
                                        <label for="userName" class="form-label">Nombre de Usuario <span class="required">*</span></label>
                                        <input type="text" class="form-control" id="userName" required 
                                               placeholder="Ej: jperez" pattern="[a-zA-Z0-9_]+" 
                                               title="Solo letras, números y guión bajo">
                                        <div class="form-text">Solo letras, números y guión bajo (_)</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="displayName" class="form-label">Nombre para Mostrar</label>
                                        <input type="text" class="form-control" id="displayName" 
                                               placeholder="Ej: Juan Pérez">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="userEmail" class="form-label">Correo Electrónico <span class="required">*</span></label>
                                        <input type="email" class="form-control" id="userEmail" required 
                                               placeholder="usuario@empresa.com">
                                    </div>
                                </div>
                                
                                <!-- Autenticación -->
                                <div class="col-md-6">
                                    <h5 class="mb-3"><i class="bi bi-shield-lock me-2"></i>Autenticación</h5>
                                    
                                    <div class="mb-3">
                                        <label for="authProvider" class="form-label">Tipo de Autenticación <span class="required">*</span></label>
                                        <select class="form-select" id="authProvider" required>
                                            <option value="local">Local (Usuario y Contraseña)</option>
                                            <option value="google">Google</option>
                                            <option value="microsoft">Microsoft</option>
                                            <option value="github">GitHub</option>
                                        </select>
                                    </div>
                                    
                                    <div id="passwordSection">
                                        <div class="mb-3">
                                            <label for="userPassword" class="form-label">Contraseña Temporal <span class="required">*</span></label>
                                            <input type="password" class="form-control" id="userPassword" 
                                                   placeholder="Mínimo 8 caracteres" minlength="8">
                                            <div class="form-text">El usuario deberá cambiarla en su primer acceso</div>
                                        </div>
                                    </div>
                                    
                                    <div id="externalIdSection" style="display: none;">
                                        <div class="mb-3">
                                            <label for="externalId" class="form-label">ID Externo</label>
                                            <input type="text" class="form-control" id="externalId" 
                                                   placeholder="ID del proveedor externo">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <!-- Roles Section -->
                            <div class="row">
                                <div class="col-12">
                                    <h5 class="mb-3"><i class="bi bi-award me-2"></i>Asignación de Roles</h5>
                                    <div id="rolesContainer" class="mb-4">
                                        <div class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando roles...</span>
                                            </div>
                                            <p class="text-muted mt-2">Cargando roles disponibles...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="row">
                                <div class="col-12 text-end">
                                    <button type="button" class="btn btn-secondary me-2" onclick="clearForm()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Limpiar
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <i class="bi bi-check-circle me-1"></i>Crear Usuario
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ==========================================
        // CONFIGURACIÓN DE SUPABASE API
        // ==========================================
        
        const SUPABASE_CONFIG = {
            url: 'https://spjzvpcsgbewxupjvmfm.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwanp2cGNzZ2Jld3h1cGp2bWZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMDk4MDEsImV4cCI6MjA3MjU4NTgwMX0.6n_rvGalz_IT2vQ1Q4fPGS0D-ijYBUmdkL3PmbyNRck',
            apiUrl: 'https://spjzvpcsgbewxupjvmfm.supabase.co/rest/v1'
        };
        
        // Headers para las peticiones a Supabase
        const getHeaders = () => ({
            'apikey': SUPABASE_CONFIG.anonKey,
            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
        });
        
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        
        let availableRoles = [];
        let selectedRoles = [];
        
        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 NEXT inicializado - usando API REST directa');
            loadRoles();
            setupEventListeners();
        });
        
        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        
        function setupEventListeners() {
            // Cambio de proveedor de autenticación
            document.getElementById('authProvider').addEventListener('change', function() {
                toggleAuthProviderFields();
            });
            
            // Envío del formulario
            document.getElementById('userForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createUser();
            });
        }
        
        // ==========================================
        // FUNCIONES DE UI
        // ==========================================
        
        function toggleAuthProviderFields() {
            const authProvider = document.getElementById('authProvider').value;
            const passwordSection = document.getElementById('passwordSection');
            const externalIdSection = document.getElementById('externalIdSection');
            const passwordInput = document.getElementById('userPassword');
            
            if (authProvider === 'local') {
                passwordSection.style.display = 'block';
                externalIdSection.style.display = 'none';
                passwordInput.required = true;
            } else {
                passwordSection.style.display = 'none';
                externalIdSection.style.display = 'block';
                passwordInput.required = false;
            }
        }
        
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            alertContainer.innerHTML = alertHtml;
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
        
        function clearForm() {
            document.getElementById('userForm').reset();
            selectedRoles = [];
            loadRoles();
            toggleAuthProviderFields();
            document.getElementById('alertContainer').innerHTML = '';
        }
        
        // ==========================================
        // FUNCIONES DE API SUPABASE
        // ==========================================
        
        async function supabaseRequest(endpoint, options = {}) {
            const url = `${SUPABASE_CONFIG.apiUrl}${endpoint}`;
            const config = {
                headers: getHeaders(),
                ...options
            };
            
            try {
                console.log(`📡 API Request: ${options.method || 'GET'} ${url}`);
                const response = await fetch(url, config);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('✅ API Response:', data);
                return data;
                
            } catch (error) {
                console.error('❌ API Error:', error);
                throw error;
            }
        }
        
        // ==========================================
        // FUNCIONES DE ROLES
        // ==========================================
        
        async function loadRoles() {
            const container = document.getElementById('rolesContainer');
            container.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando roles...</span>
                    </div>
                    <p class="text-muted mt-2">Cargando roles disponibles...</p>
                </div>
            `;
            
            try {
                const roles = await supabaseRequest('/roles?select=*&role_status=eq.active&order=role_name');
                availableRoles = roles || [];
                renderRoles();
                
            } catch (error) {
                console.error('Error cargando roles:', error);
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error cargando roles: ${error.message}
                        <br><small>Verifica que las políticas RLS permitan leer la tabla 'roles'</small>
                    </div>
                `;
            }
        }
        
        function renderRoles() {
            const container = document.getElementById('rolesContainer');
            
            if (availableRoles.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No hay roles disponibles. Primero debes crear roles en el sistema.
                    </div>
                `;
                return;
            }
            
            let rolesHtml = '<p class="text-muted mb-3">Selecciona los roles que tendrá este usuario:</p>';
            
            availableRoles.forEach(role => {
                const isSelected = selectedRoles.includes(role.role_id);
                rolesHtml += `
                    <div class="role-item ${isSelected ? 'selected' : ''}" onclick="toggleRole('${role.role_id}')">
                        <div class="d-flex align-items-center">
                            <input type="checkbox" class="form-check-input me-3" ${isSelected ? 'checked' : ''} 
                                   onchange="event.stopPropagation(); toggleRole('${role.role_id}')">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    ${role.role_name}
                                    ${role.is_super_admin ? '<span class="badge bg-danger ms-2">SUPER ADMIN</span>' : ''}
                                </h6>
                                <p class="mb-0 text-muted small">${role.role_description || 'Sin descripción'}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = rolesHtml;
        }
        
        function toggleRole(roleId) {
            const index = selectedRoles.indexOf(roleId);
            if (index > -1) {
                selectedRoles.splice(index, 1);
            } else {
                selectedRoles.push(roleId);
            }
            renderRoles();
        }
        
        // ==========================================
        // FUNCIÓN PRINCIPAL: CREAR USUARIO
        // ==========================================
        
        async function createUser() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creando...';
            
            try {
                // Recoger datos del formulario
                const formData = {
                    user_name: document.getElementById('userName').value.trim(),
                    user_display_name: document.getElementById('displayName').value.trim() || null,
                    user_mail: document.getElementById('userEmail').value.trim(),
                    auth_provider: document.getElementById('authProvider').value,
                    user_password: document.getElementById('userPassword').value || null,
                    external_id: document.getElementById('externalId').value.trim() || null
                };
                
                // Validaciones básicas
                if (selectedRoles.length === 0) {
                    throw new Error('Debes seleccionar al menos un rol para el usuario');
                }
                
                console.log('📝 Creando usuario con datos:', formData);
                
                // Crear usuario
                const userData = await supabaseRequest('/users', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                // Si la respuesta es un array, tomar el primer elemento
                const newUser = Array.isArray(userData) ? userData[0] : userData;
                
                if (!newUser || !newUser.user_id) {
                    throw new Error('No se pudo crear el usuario correctamente');
                }
                
                console.log('✅ Usuario creado:', newUser);
                
                // Asignar roles
                const roleAssignments = selectedRoles.map(roleId => ({
                    user_id: newUser.user_id,
                    role_id: roleId,
                    assigned_by: null // Por ahora null, después pondremos el ID del usuario actual
                }));
                
                console.log('📝 Asignando roles:', roleAssignments);
                
                await supabaseRequest('/user_roles', {
                    method: 'POST',
                    body: JSON.stringify(roleAssignments)
                });
                
                console.log('✅ Roles asignados correctamente');
                
                // Éxito
                showAlert(`Usuario "${newUser.user_name}" creado exitosamente`, 'success');
                clearForm();
                
            } catch (error) {
                console.error('❌ Error creando usuario:', error);
                showAlert(`Error creando usuario: ${error.message}`, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Crear Usuario';
            }
        }
    </script>
</body>
</html>
