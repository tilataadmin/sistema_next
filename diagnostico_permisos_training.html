<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Permisos - Training</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Diagn√≥stico de Permisos - M√≥dulo Training</h1>
        
        <div class="alert alert-info">
            <strong>Instrucciones:</strong> Abre la consola del navegador (F12) para ver los resultados del diagn√≥stico.
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Informaci√≥n del Usuario</h5>
            </div>
            <div class="card-body" id="user-info">
                Cargando...
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Permisos del M√≥dulo Training en BD</h5>
            </div>
            <div class="card-body">
                <pre id="module-permissions"></pre>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Permisos del Usuario</h5>
            </div>
            <div class="card-body">
                <pre id="user-permissions"></pre>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">Resultado del Diagn√≥stico</h5>
            </div>
            <div class="card-body" id="result">
                Cargando...
            </div>
        </div>
    </div>

    <script src="assets/js/config.js"></script>
    <script>
        // ==========================================
        // DIAGN√ìSTICO DE PERMISOS
        // ==========================================
        
        let currentUser = null;
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîç Iniciando diagn√≥stico de permisos...');
            
            try {
                // PASO 1: Obtener sesi√≥n
                const session = getStoredSession();
                if (!session || !session.user) {
                    alert('No hay sesi√≥n activa. Redirigiendo al login...');
                    window.location.href = '/login.html';
                    return;
                }
                
                currentUser = session.user;
                console.log('‚úÖ Usuario:', currentUser);
                
                document.getElementById('user-info').innerHTML = `
                    <p><strong>ID:</strong> ${currentUser.user_id}</p>
                    <p><strong>Email:</strong> ${currentUser.user_mail}</p>
                    <p><strong>Nombre:</strong> ${currentUser.user_display_name}</p>
                `;
                
                // PASO 2: Obtener permisos del m√≥dulo training desde BD
                console.log('üì¶ Consultando permisos del m√≥dulo training...');
                const modulePermissions = await supabaseRequest(
                    '/permissions?select=permission_name&permission_module=eq.training&permission_status=eq.active'
                );
                
                console.log('üì¶ Permisos del m√≥dulo training:', modulePermissions);
                document.getElementById('module-permissions').textContent = 
                    JSON.stringify(modulePermissions.map(p => p.permission_name), null, 2);
                
                // PASO 3: Obtener roles del usuario
                console.log('üîë Consultando roles del usuario...');
                const userRolesData = await supabaseRequest(
                    `/user_roles?select=role_id,roles(role_name,is_super_admin)&user_id=eq.${currentUser.user_id}`
                );
                
                console.log('üîë Roles del usuario:', userRolesData);
                
                if (!userRolesData || userRolesData.length === 0) {
                    document.getElementById('result').innerHTML = `
                        <div class="alert alert-danger">
                            ‚ùå <strong>PROBLEMA ENCONTRADO:</strong> El usuario no tiene roles asignados.
                            <br>Soluci√≥n: Asignar rol al usuario en el m√≥dulo de Seguridad.
                        </div>
                    `;
                    return;
                }
                
                // Verificar si es super admin
                const isSuperAdmin = userRolesData.some(ur => ur.roles?.is_super_admin === true);
                console.log('üëë ¬øEs Super Admin?', isSuperAdmin);
                
                if (isSuperAdmin) {
                    document.getElementById('user-permissions').textContent = 
                        'Super Admin - tiene TODOS los permisos';
                    document.getElementById('result').innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ <strong>ACCESO PERMITIDO:</strong> El usuario es Super Admin.
                        </div>
                    `;
                    return;
                }
                
                // PASO 4: Obtener permisos del usuario - M√âTODO 1 (del dashboard)
                console.log('üîê M√©todo 1: Consultando permisos (estilo dashboard)...');
                const roleIds = userRolesData.map(ur => ur.role_id);
                const roleIdsFilter = roleIds.map(id => `role_id.eq.${id}`).join(',');
                
                const rolePermissionsData1 = await supabaseRequest(
                    `/role_permissions?select=permissions(permission_name)&or=(${roleIdsFilter})`
                );
                
                const permissions1 = new Set();
                rolePermissionsData1.forEach(rp => {
                    if (rp.permissions && rp.permissions.permission_name) {
                        permissions1.add(rp.permissions.permission_name);
                    }
                });
                
                const userPermissions1 = Array.from(permissions1);
                console.log('üîê Permisos del usuario (M√©todo 1):', userPermissions1);
                
                // PASO 5: Obtener permisos del usuario - M√âTODO 2 (del index actual)
                console.log('üîê M√©todo 2: Consultando permisos (estilo index actual)...');
                const data2 = await supabaseRequest(
                    `/users?select=user_roles(role_id,roles(role_permissions(permissions(permission_name))))&user_id=eq.${currentUser.user_id}`
                );
                
                console.log('üîê Respuesta cruda (M√©todo 2):', data2);
                
                const permissions2 = [];
                if (data2 && data2.length > 0) {
                    data2[0].user_roles?.forEach(userRole => {
                        userRole.roles?.role_permissions?.forEach(rolePermission => {
                            const permName = rolePermission.permissions?.permission_name;
                            if (permName && !permissions2.includes(permName)) {
                                permissions2.push(permName);
                            }
                        });
                    });
                }
                
                console.log('üîê Permisos del usuario (M√©todo 2):', permissions2);
                
                // Mostrar resultados
                document.getElementById('user-permissions').innerHTML = `
                    <h6>M√©todo 1 (Dashboard):</h6>
                    <pre>${JSON.stringify(userPermissions1, null, 2)}</pre>
                    <hr>
                    <h6>M√©todo 2 (Index Actual):</h6>
                    <pre>${JSON.stringify(permissions2, null, 2)}</pre>
                `;
                
                // PASO 6: Verificar si tiene al menos un permiso del m√≥dulo
                const modulePermissionNames = modulePermissions.map(p => p.permission_name);
                
                const hasAccessMethod1 = modulePermissionNames.some(perm => 
                    userPermissions1.includes(perm)
                );
                
                const hasAccessMethod2 = modulePermissionNames.some(perm => 
                    permissions2.includes(perm)
                );
                
                console.log('‚úÖ Tiene acceso (M√©todo 1)?', hasAccessMethod1);
                console.log('‚úÖ Tiene acceso (M√©todo 2)?', hasAccessMethod2);
                
                // Permisos coincidentes
                const matchingPermissions1 = modulePermissionNames.filter(perm => 
                    userPermissions1.includes(perm)
                );
                
                const matchingPermissions2 = modulePermissionNames.filter(perm => 
                    permissions2.includes(perm)
                );
                
                console.log('üéØ Permisos coincidentes (M√©todo 1):', matchingPermissions1);
                console.log('üéØ Permisos coincidentes (M√©todo 2):', matchingPermissions2);
                
                // Resultado final
                let resultHtml = '';
                
                if (hasAccessMethod1 && hasAccessMethod2) {
                    resultHtml = `
                        <div class="alert alert-success">
                            ‚úÖ <strong>ACCESO PERMITIDO:</strong> El usuario tiene ${matchingPermissions1.length} permisos del m√≥dulo.
                            <br><br>
                            <strong>Permisos encontrados:</strong>
                            <ul>
                                ${matchingPermissions1.slice(0, 5).map(p => `<li>${p}</li>`).join('')}
                                ${matchingPermissions1.length > 5 ? '<li>... y ' + (matchingPermissions1.length - 5) + ' m√°s</li>' : ''}
                            </ul>
                        </div>
                    `;
                } else if (hasAccessMethod1 && !hasAccessMethod2) {
                    resultHtml = `
                        <div class="alert alert-warning">
                            ‚ö†Ô∏è <strong>PROBLEMA ENCONTRADO:</strong> El M√©todo 1 funciona pero el M√©todo 2 NO.
                            <br><br>
                            El problema est√° en la consulta del index.html del m√≥dulo training.
                            <br>
                            <strong>Soluci√≥n:</strong> Actualizar la funci√≥n obtenerTodosLosPermisosUsuario() 
                            para usar el M√©todo 1.
                        </div>
                    `;
                } else if (!hasAccessMethod1 && hasAccessMethod2) {
                    resultHtml = `
                        <div class="alert alert-warning">
                            ‚ö†Ô∏è <strong>SITUACI√ìN EXTRA√ëA:</strong> El M√©todo 2 funciona pero el M√©todo 1 NO.
                            <br><br>
                            Esto es inesperado. Revisar configuraci√≥n de la base de datos.
                        </div>
                    `;
                } else {
                    resultHtml = `
                        <div class="alert alert-danger">
                            ‚ùå <strong>ACCESO DENEGADO:</strong> El usuario NO tiene permisos del m√≥dulo training.
                            <br><br>
                            Verificar:
                            <ul>
                                <li>Que el rol "Coordinaci√≥n administrativa" existe</li>
                                <li>Que el usuario tiene asignado este rol</li>
                                <li>Que los permisos est√°n asignados al rol en role_permissions</li>
                            </ul>
                        </div>
                    `;
                }
                
                document.getElementById('result').innerHTML = resultHtml;
                
                console.log('üéâ Diagn√≥stico completado');
                
            } catch (error) {
                console.error('‚ùå Error en diagn√≥stico:', error);
                document.getElementById('result').innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå <strong>ERROR:</strong> ${error.message}
                        <br><br>
                        Ver consola para m√°s detalles.
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
