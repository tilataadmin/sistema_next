<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA -->
    <meta name="page-version" content="25.11.09.11.02">
    
    <title>Tarifas Anuales - Configuraci√≥n - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para la tabla de tarifas */
        .fees-table {
            font-size: 0.9rem;
        }

        .fees-table th {
            background-color: var(--system-primary-color, #1B365D);
            color: white;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .fees-table td {
            vertical-align: middle;
        }

        .fees-table input[type="number"] {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .fees-table input[type="number"]:read-only {
            background-color: #f8f9fa;
            border-color: #e9ecef;
            cursor: not-allowed;
        }

        .grade-name-col {
            font-weight: 600;
            color: var(--system-primary-color, #1B365D);
        }

        .calculated-value {
            background-color: #e7f3ff;
            font-weight: 500;
        }

        .btn-save-grade {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }

        .info-badge {
            background-color: #e7f3ff;
            border-left: 4px solid #0d6efd;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
        }

        .formula-display {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .fees-table {
                font-size: 0.75rem;
            }
            
            .fees-table input {
                font-size: 0.75rem;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="index.html">Configuraci√≥n</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Tarifas Anuales
                </li>
            </ol>
        </nav>

        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="h3">
                    <i class="bi bi-cash-stack me-2"></i>
                    Tarifas Anuales por Grado
                </h1>
                <p class="text-muted">
                    Configure los costos educativos del colegio para cada grado acad√©mico
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="../../manual/config/annual-fees.html" class="btn btn-outline-info" target="_blank">
                    <i class="bi bi-book me-1"></i>Ver Manual
                </a>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- SELECTOR DE A√ëO ACAD√âMICO -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <label for="yearSelect" class="form-label mb-2">
                            <i class="bi bi-calendar-event me-2"></i>
                            <strong>A√±o Acad√©mico:</strong>
                        </label>
                        <select class="form-select form-select-lg" id="yearSelect" onchange="cargarTarifasPorAnio()">
                            <option value="">Seleccione un a√±o acad√©mico...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <div class="info-badge">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Nota:</strong> Seleccione el a√±o acad√©mico para gestionar las tarifas de cada grado.
                            Por defecto se muestra el a√±o acad√©mico vigente.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INFORMACI√ìN DE C√ÅLCULOS -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-calculator me-2"></i>C√°lculos Autom√°ticos
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-check-circle text-success me-2"></i>Matr√≠cula</h6>
                        <p class="mb-2">Se calcula autom√°ticamente como el <strong>10% del CEA</strong></p>
                        <div class="formula-display">
                            Matr√≠cula = CEA √ó 0.10
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-check-circle text-success me-2"></i>Pensi√≥n Mensual</h6>
                        <p class="mb-2">Se calcula autom√°ticamente dividiendo el saldo en <strong>10 meses</strong></p>
                        <div class="formula-display">
                            Pensi√≥n = (CEA - Matr√≠cula) √∑ 10
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mt-3 mb-0">
                    <i class="bi bi-lightbulb me-2"></i>
                    Los campos de <strong>Matr√≠cula</strong> y <strong>Pensi√≥n Mensual</strong> son de solo lectura.
                    Sus valores se actualizan autom√°ticamente al ingresar o modificar el CEA.
                </div>
            </div>
        </div>

        <!-- TABLA DE TARIFAS POR GRADO -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-table me-2"></i>Tarifas por Grado
                </h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="cargarTarifasPorAnio()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover fees-table mb-0">
                        <thead>
                            <tr>
                                <th style="width: 15%;">Grado</th>
                                <th style="width: 13%;">CEA<br><small>(Costo Educativo Anual)</small></th>
                                <th style="width: 12%;" class="calculated-value">Matr√≠cula<br><small>(10% del CEA)</small></th>
                                <th style="width: 12%;" class="calculated-value">Pensi√≥n<br><small>(Mensual)</small></th>
                                <th style="width: 12%;">Alimentaci√≥n<br><small>(Opcional)</small></th>
                                <th style="width: 12%;">Transporte<br><small>(Opcional)</small></th>
                                <th style="width: 12%;">Extracurriculares<br><small>(Opcional)</small></th>
                                <th style="width: 12%;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="feesTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="bi bi-inbox me-2"></i>
                                        Seleccione un a√±o acad√©mico para cargar los grados
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPTS - ORDEN CR√çTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let currentYearId = null;
        let allGrades = [];

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìä Iniciando p√°gina de Tarifas Anuales...');
            
            try {
                showLoading();
                
                // Cargar colores corporativos
                if (typeof loadAndApplyBrandColors === 'function') {
                    await loadAndApplyBrandColors();
                }
                
                // Validar acceso
                await validatePageAccess('Gestionar tarifas anuales');
                
                // Obtener sesi√≥n
                const session = getStoredSession();
                if (session && session.user) {
                    currentUser = session.user;
                    console.log('‚úÖ Usuario autenticado:', currentUser.user_full_name);
                }
                
                // Cargar a√±os acad√©micos
                await cargarAniosAcademicos();
                
                hideLoading();
                console.log('‚úÖ P√°gina de tarifas lista');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                hideLoading();
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGAR A√ëOS ACAD√âMICOS
        // ==========================================
        async function cargarAniosAcademicos() {
            try {
                console.log('üìÖ Cargando a√±os acad√©micos...');
                
                // Obtener a√±os acad√©micos activos
                const years = await supabaseRequest(
                    '/academic_years?year_status=eq.active&select=year_id,year_name,is_current&order=year_order.desc'
                );
                
                if (!years || years.length === 0) {
                    showMessage('No hay a√±os acad√©micos activos configurados', 'warning');
                    return;
                }
                
                const yearSelect = document.getElementById('yearSelect');
                yearSelect.innerHTML = '<option value="">Seleccione un a√±o acad√©mico...</option>';
                
                let currentYearFound = false;
                
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.year_id;
                    option.textContent = year.year_name;
                    
                    if (year.is_current) {
                        option.textContent += ' (Actual)';
                        option.selected = true;
                        currentYearId = year.year_id;
                        currentYearFound = true;
                    }
                    
                    yearSelect.appendChild(option);
                });
                
                console.log(`‚úÖ ${years.length} a√±os acad√©micos cargados`);
                
                // Si hay un a√±o actual seleccionado, cargar sus tarifas
                if (currentYearFound) {
                    await cargarTarifasPorAnio();
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando a√±os acad√©micos:', error);
                showMessage('Error al cargar a√±os acad√©micos: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // CARGAR TARIFAS POR A√ëO
        // ==========================================
        async function cargarTarifasPorAnio() {
            try {
                const yearSelect = document.getElementById('yearSelect');
                const selectedYearId = yearSelect.value;
                
                if (!selectedYearId) {
                    document.getElementById('feesTableBody').innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-inbox me-2"></i>
                                    Seleccione un a√±o acad√©mico para cargar los grados
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                showLoading();
                currentYearId = selectedYearId;
                
                console.log('üìö Cargando grados para a√±o:', selectedYearId);
                
                // Cargar grados activos del a√±o seleccionado
                const grades = await supabaseRequest(
                    `/grades?academic_year_id=eq.${selectedYearId}&grade_status=eq.active&select=grade_id,grade_name,grade_order&order=grade_order.asc`
                );
                
                if (!grades || grades.length === 0) {
                    document.getElementById('feesTableBody').innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="alert alert-warning mb-0">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    No hay grados activos configurados para este a√±o acad√©mico
                                </div>
                            </td>
                        </tr>
                    `;
                    hideLoading();
                    return;
                }
                
                allGrades = grades;
                console.log(`‚úÖ ${grades.length} grados encontrados`);
                
                // Cargar tarifas existentes para estos grados
                const existingFees = await supabaseRequest(
                    `/annual_tuition_fees?year_id=eq.${selectedYearId}&select=*`
                );
                
                console.log(`üìä ${existingFees ? existingFees.length : 0} tarifas existentes encontradas`);
                
                // Crear mapa de tarifas por grade_id
                const feesMap = {};
                if (existingFees) {
                    existingFees.forEach(fee => {
                        feesMap[fee.grade_id] = fee;
                    });
                }
                
                // Renderizar tabla
                renderFeesTable(grades, feesMap);
                
                hideLoading();
                
            } catch (error) {
                console.error('‚ùå Error cargando tarifas:', error);
                hideLoading();
                showMessage('Error al cargar tarifas: ' + error.message, 'danger');
            }
        }

        // ==========================================
        // RENDERIZAR TABLA DE TARIFAS
        // ==========================================
        function renderFeesTable(grades, feesMap) {
            const tbody = document.getElementById('feesTableBody');
            tbody.innerHTML = '';
            
            grades.forEach(grade => {
                const existingFee = feesMap[grade.grade_id] || {};
                
                const row = document.createElement('tr');
                row.id = `row-${grade.grade_id}`;
                
                row.innerHTML = `
                    <td class="grade-name-col">${grade.grade_name}</td>
                    <td>
                        <input type="number" 
                               class="form-control form-control-sm" 
                               id="cea-${grade.grade_id}"
                               min="0" 
                               step="1000"
                               value="${existingFee.total_annual_cost || 0}"
                               onchange="calcularValoresAutomaticos('${grade.grade_id}')"
                               placeholder="0">
                    </td>
                    <td class="calculated-value">
                        <input type="number" 
                               class="form-control form-control-sm" 
                               id="enrollment-${grade.grade_id}"
                               value="${existingFee.enrollment_fee || 0}"
                               readonly>
                    </td>
                    <td class="calculated-value">
                        <input type="number" 
                               class="form-control form-control-sm" 
                               id="tuition-${grade.grade_id}"
                               value="${existingFee.monthly_tuition || 0}"
                               readonly>
                    </td>
                    <td>
                        <input type="number" 
                               class="form-control form-control-sm" 
                               id="food-${grade.grade_id}"
                               min="0" 
                               step="1000"
                               value="${existingFee.food_service || 0}"
                               placeholder="0">
                    </td>
                    <td>
                        <input type="number" 
                               class="form-control form-control-sm" 
                               id="transport-${grade.grade_id}"
                               min="0" 
                               step="1000"
                               value="${existingFee.transportation || 0}"
                               placeholder="0">
                    </td>
                    <td>
                        <input type="number" 
                               class="form-control form-control-sm" 
                               id="extra-${grade.grade_id}"
                               min="0" 
                               step="1000"
                               value="${existingFee.extracurricular || 0}"
                               placeholder="0">
                    </td>
                    <td class="text-center">
                        <button class="btn btn-primary btn-save-grade" 
                                onclick="guardarTarifaGrado('${grade.grade_id}', '${grade.grade_name}')">
                            <i class="bi bi-save me-1"></i>Guardar
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
                
                // Si hay CEA, calcular valores autom√°ticos
                if (existingFee.total_annual_cost) {
                    calcularValoresAutomaticos(grade.grade_id);
                }
            });
        }

        // ==========================================
        // CALCULAR VALORES AUTOM√ÅTICOS
        // ==========================================
        function calcularValoresAutomaticos(gradeId) {
            const ceaInput = document.getElementById(`cea-${gradeId}`);
            const enrollmentInput = document.getElementById(`enrollment-${gradeId}`);
            const tuitionInput = document.getElementById(`tuition-${gradeId}`);
            
            const cea = parseFloat(ceaInput.value) || 0;
            
            // Calcular matr√≠cula (10% del CEA)
            const enrollment = Math.round(cea * 0.10);
            
            // Calcular pensi√≥n mensual ((CEA - Matr√≠cula) / 10)
            const monthlyTuition = Math.round((cea - enrollment) / 10);
            
            // Actualizar campos
            enrollmentInput.value = enrollment;
            tuitionInput.value = monthlyTuition;
            
            console.log(`üí∞ Calculado para grado ${gradeId}: CEA=${cea}, Matr√≠cula=${enrollment}, Pensi√≥n=${monthlyTuition}`);
        }

        // ==========================================
        // GUARDAR TARIFA DE UN GRADO
        // ==========================================
        async function guardarTarifaGrado(gradeId, gradeName) {
            try {
                // Validar que haya un a√±o seleccionado
                if (!currentYearId) {
                    showMessage('Debe seleccionar un a√±o acad√©mico', 'warning');
                    return;
                }
                
                // Obtener valores de los inputs
                const cea = parseFloat(document.getElementById(`cea-${gradeId}`).value) || 0;
                const enrollment = parseFloat(document.getElementById(`enrollment-${gradeId}`).value) || 0;
                const tuition = parseFloat(document.getElementById(`tuition-${gradeId}`).value) || 0;
                const food = parseFloat(document.getElementById(`food-${gradeId}`).value) || 0;
                const transport = parseFloat(document.getElementById(`transport-${gradeId}`).value) || 0;
                const extra = parseFloat(document.getElementById(`extra-${gradeId}`).value) || 0;
                
                // Validar que el CEA sea mayor a cero
                if (cea <= 0) {
                    showMessage(`El Costo Educativo Anual (CEA) de ${gradeName} debe ser mayor a cero`, 'warning');
                    return;
                }
                
                // Validar que no haya valores negativos
                if (food < 0 || transport < 0 || extra < 0) {
                    showMessage('Los valores de servicios opcionales no pueden ser negativos', 'warning');
                    return;
                }
                
                showLoading();
                
                console.log(`üíæ Guardando tarifa para ${gradeName}...`);
                
                // Preparar datos
                const feeData = {
                    year_id: currentYearId,
                    grade_id: gradeId,
                    total_annual_cost: cea,
                    enrollment_fee: enrollment,
                    monthly_tuition: tuition,
                    food_service: food,
                    transportation: transport,
                    extracurricular: extra,
                    updated_at: new Date().toISOString()
                };
                
                // Intentar INSERT primero, si falla por constraint unique, hacer UPDATE
                try {
                    // Primero verificar si existe
                    const existing = await supabaseRequest(
                        `/annual_tuition_fees?year_id=eq.${currentYearId}&grade_id=eq.${gradeId}&select=fee_id`
                    );
                    
                    if (existing && existing.length > 0) {
                        // UPDATE
                        await supabaseRequest(
                            `/annual_tuition_fees?fee_id=eq.${existing[0].fee_id}`,
                            {
                                method: 'PATCH',
                                body: JSON.stringify(feeData)
                            }
                        );
                        console.log('‚úÖ Tarifa actualizada');
                    } else {
                        // INSERT
                        await supabaseRequest(
                            '/annual_tuition_fees',
                            {
                                method: 'POST',
                                body: JSON.stringify(feeData)
                            }
                        );
                        console.log('‚úÖ Tarifa creada');
                    }
                    
                    hideLoading();
                    showMessage(`Tarifa de ${gradeName} guardada exitosamente`, 'success');
                    
                } catch (error) {
                    throw error;
                }
                
            } catch (error) {
                console.error('‚ùå Error guardando tarifa:', error);
                hideLoading();
                showMessage(`Error al guardar tarifa de ${gradeName}: ${error.message}`, 'danger');
            }
        }

        // ==========================================
        // UTILIDADES DE LOADING
        // ==========================================
        function showLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
            }
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }

        // ==========================================
        // FUNCI√ìN DE MENSAJES
        // ==========================================
        function showMessage(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) return;
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alertDiv);
            
            // Auto-remove despu√©s de 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
            
            // Scroll al mensaje
            alertContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

    </script>
</body>
</html>
