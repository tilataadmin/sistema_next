<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA -->
    <meta name="page-version" content="25.11.08.11.29">
    
    <title>Reportar Bug - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* √Årea de pegar captura */
        .paste-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .paste-area:hover {
            border-color: #0d6efd;
            background: #e7f1ff;
        }

        .paste-area.active {
            border-color: #0d6efd;
            background: #cfe2ff;
        }

        .paste-area i {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }

        /* Preview de imagen */
        .screenshot-preview {
            max-width: 100%;
            margin-top: 15px;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            display: none;
        }

        .screenshot-preview.show {
            display: block;
        }

        .screenshot-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            display: block;
        }

        .screenshot-preview .preview-controls {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            background: #e7f1ff;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .file-info.show {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .file-info small {
            color: #0d6efd;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Enviando reporte...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- ENCABEZADO DE P√ÅGINA -->
        <div class="row mb-4 mt-3">
            <div class="col">
                <h1 class="h3">
                    <i class="bi bi-bug me-2"></i>
                    Reportar Bug o Sugerencia
                </h1>
                <p class="text-muted">
                    Ay√∫danos a mejorar SchoolNet reportando problemas o sugiriendo mejoras
                </p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <!-- FORMULARIO PRINCIPAL -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Informaci√≥n del Reporte
                </h5>
            </div>
            <div class="card-body">
                <form id="bug-report-form">
                    
                    <!-- Informaci√≥n Autom√°tica (Solo lectura) -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Usuario</label>
                            <input type="text" class="form-control-plaintext" id="display-user" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">P√°gina Actual</label>
                            <input type="text" class="form-control-plaintext" id="display-page" readonly>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">M√≥dulo Detectado</label>
                            <input type="text" class="form-control-plaintext" id="display-module" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="priority" class="form-label">
                                Prioridad <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="priority" required>
                                <option value="">Seleccione...</option>
                                <option value="baja">Baja - Mejora cosm√©tica</option>
                                <option value="media" selected>Media - Funcionalidad afectada</option>
                                <option value="alta">Alta - Error importante</option>
                                <option value="critica">Cr√≠tica - Sistema no funciona</option>
                            </select>
                        </div>
                    </div>

                    <hr>

                    <!-- Descripci√≥n del Problema -->
                    <div class="mb-3">
                        <label for="description" class="form-label">
                            Descripci√≥n del Problema o Sugerencia <span class="text-danger">*</span>
                        </label>
                        <textarea 
                            class="form-control" 
                            id="description" 
                            rows="6" 
                            required
                            placeholder="Por favor describe detalladamente:&#10;- ¬øQu√© estabas intentando hacer?&#10;- ¬øQu√© esperabas que pasara?&#10;- ¬øQu√© pas√≥ en realidad?&#10;- Cualquier mensaje de error que hayas visto"
                        ></textarea>
                        <div class="form-text">
                            M√≠nimo 20 caracteres. S√© lo m√°s espec√≠fico posible.
                        </div>
                    </div>

                    <!-- Captura de Pantalla con √Årea de Pegar -->
                    <div class="mb-3">
                        <label class="form-label">
                            Captura de Pantalla (Opcional)
                        </label>
                        
                        <!-- √Årea para pegar con Ctrl+V -->
                        <div class="paste-area" id="paste-area" tabindex="0">
                            <i class="bi bi-clipboard-image"></i>
                            <h6 class="mb-2">Pega tu captura de pantalla aqu√≠</h6>
                            <p class="text-muted small mb-2">
                                Presiona <kbd>Ctrl</kbd> + <kbd>V</kbd> despu√©s de hacer clic aqu√≠
                            </p>
                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="select-file-btn">
                                    <i class="bi bi-folder2-open me-1"></i>
                                    O selecciona un archivo
                                </button>
                            </div>
                        </div>

                        <!-- Input oculto para seleccionar archivo -->
                        <input 
                            type="file" 
                            id="screenshot-input"
                            accept="image/png,image/jpeg,image/jpg"
                            style="display: none;"
                        >
                        
                        <div class="form-text mt-2">
                            <i class="bi bi-info-circle me-1"></i>
                            Formatos: PNG, JPG, JPEG. Tama√±o m√°ximo: 5MB
                        </div>
                        
                        <!-- Info del archivo -->
                        <div id="file-info" class="file-info">
                            <div>
                                <i class="bi bi-file-earmark-image me-2"></i>
                                <small id="file-details"></small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="remove-file-btn">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                        
                        <!-- Preview de la imagen -->
                        <div id="screenshot-preview" class="screenshot-preview">
                            <img id="preview-img" src="" alt="Captura de pantalla">
                            <div class="preview-controls">
                                <small class="text-muted">Vista previa de tu captura</small>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-secondary" onclick="history.back()">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">
                            <i class="bi bi-send me-1"></i>Enviar Reporte
                        </button>
                    </div>

                </form>
            </div>
        </div>

        <!-- Instrucciones adicionales -->
        <div class="alert alert-info mt-4">
            <h6 class="alert-heading">
                <i class="bi bi-lightbulb me-2"></i>Consejos para un buen reporte
            </h6>
            <ul class="mb-0">
                <li>S√© espec√≠fico sobre lo que estabas haciendo cuando ocurri√≥ el problema</li>
                <li>Incluye los pasos exactos para reproducir el error</li>
                <li>Si es posible, adjunta una captura de pantalla (puedes pegarla directamente con Ctrl+V)</li>
                <li>Menciona cualquier mensaje de error que hayas visto</li>
            </ul>
        </div>

    </div>

    <!-- SCRIPTS - ORDEN CR√çTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let referrerPage = null;
        let detectedModule = null;
        let selectedFile = null;

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üêõ Iniciando formulario de reporte de bugs...');
            
            try {
                // Obtener sesi√≥n del usuario
                const session = getStoredSession();
                if (!session || !session.user) {
                    showMessage('Debes iniciar sesi√≥n para reportar un bug', 'danger');
                    setTimeout(() => {
                        window.location.href = '../login.html';
                    }, 2000);
                    return;
                }

                currentUser = session.user;
                console.log('Usuario actual:', currentUser);
                
                // Cargar informaci√≥n autom√°tica
                await loadAutoInformation();
                
                // Configurar event listeners
                setupEventListeners();
                
                console.log('‚úÖ Formulario listo');
                
            } catch (error) {
                console.error('‚ùå Error inicializando formulario:', error);
                showMessage('Error al cargar el formulario: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // CARGAR INFORMACI√ìN AUTOM√ÅTICA
        // ==========================================
        async function loadAutoInformation() {
            // Usuario actual - manejar diferentes formatos de sesi√≥n
            let userName = 'Usuario no identificado';
            
            if (currentUser) {
                // Intentar diferentes combinaciones de campos
                const firstName = currentUser.user_first_name || currentUser.user_name || '';
                const lastName = currentUser.user_last_name || currentUser.last_name || '';
                const displayName = currentUser.user_display_name || '';
                const email = currentUser.user_mail || currentUser.email || '';
                
                if (displayName) {
                    userName = displayName;
                } else if (firstName || lastName) {
                    userName = `${firstName} ${lastName}`.trim();
                } else if (email) {
                    userName = email;
                }
            }
            
            document.getElementById('display-user').value = userName;
            console.log('Nombre de usuario mostrado:', userName);
            
            // P√°gina de referencia (de donde viene el usuario)
            referrerPage = document.referrer;
            console.log('P√°gina de referencia:', referrerPage);
            
            if (referrerPage && referrerPage.includes(window.location.hostname)) {
                // Extraer la ruta relativa
                const url = new URL(referrerPage);
                const relativePath = url.pathname;
                
                document.getElementById('display-page').value = relativePath;
                
                // Intentar detectar el m√≥dulo
                await detectModule(relativePath);
                
            } else {
                document.getElementById('display-page').value = 'No detectada (acceso directo)';
                document.getElementById('display-module').value = 'No detectado';
            }
        }

        // ==========================================
        // DETECTAR M√ìDULO DESDE LA URL
        // ==========================================
        async function detectModule(pagePath) {
            try {
                console.log('Detectando m√≥dulo para:', pagePath);
                
                // Extraer el nombre del m√≥dulo de diferentes rutas posibles
                let moduleName = null;
                let moduleDisplay = 'No detectado';
                
                // Caso 1: /modules/[modulo]/archivo.html
                const moduleMatch = pagePath.match(/\/modules\/([^\/]+)\//);
                if (moduleMatch) {
                    moduleName = moduleMatch[1];
                    moduleDisplay = `M√≥dulo: ${moduleName}`;
                }
                
                // Caso 2: /manual/[modulo]/archivo.html
                const manualMatch = pagePath.match(/\/manual\/([^\/]+)\//);
                if (manualMatch) {
                    moduleName = manualMatch[1];
                    moduleDisplay = `Manual: ${moduleName}`;
                }
                
                // Caso 3: Dashboard o p√°ginas ra√≠z
                if (pagePath.includes('dashboard.html')) {
                    moduleDisplay = 'Dashboard Principal';
                } else if (pagePath.includes('login.html')) {
                    moduleDisplay = 'Login / Autenticaci√≥n';
                } else if (pagePath === '/' || pagePath === '/index.html') {
                    moduleDisplay = 'P√°gina de Inicio';
                }
                
                document.getElementById('display-module').value = moduleDisplay;
                detectedModule = moduleName;
                
                console.log('M√≥dulo detectado:', moduleDisplay);
                
            } catch (error) {
                console.error('Error detectando m√≥dulo:', error);
                document.getElementById('display-module').value = 'Error al detectar';
            }
        }

        // ==========================================
        // CONFIGURAR EVENT LISTENERS
        // ==========================================
        function setupEventListeners() {
            const pasteArea = document.getElementById('paste-area');
            const selectFileBtn = document.getElementById('select-file-btn');
            const screenshotInput = document.getElementById('screenshot-input');
            const removeFileBtn = document.getElementById('remove-file-btn');
            const form = document.getElementById('bug-report-form');

            // Evento para pegar con Ctrl+V
            pasteArea.addEventListener('paste', handlePaste);
            
            // Hacer el √°rea focuseable
            pasteArea.addEventListener('click', () => {
                pasteArea.focus();
            });

            // Visual feedback cuando est√° enfocado
            pasteArea.addEventListener('focus', () => {
                pasteArea.classList.add('active');
            });

            pasteArea.addEventListener('blur', () => {
                pasteArea.classList.remove('active');
            });

            // Bot√≥n para seleccionar archivo
            selectFileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                screenshotInput.click();
            });

            // Cuando se selecciona un archivo desde el explorador
            screenshotInput.addEventListener('change', handleFileSelect);

            // Bot√≥n para remover archivo
            removeFileBtn.addEventListener('click', clearScreenshot);

            // Submit del formulario
            form.addEventListener('submit', handleSubmit);
        }

        // ==========================================
        // MANEJAR PEGAR IMAGEN (Ctrl+V)
        // ==========================================
        function handlePaste(event) {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    event.preventDefault();
                    
                    const blob = item.getAsFile();
                    
                    // Validar tama√±o
                    const maxSize = 5 * 1024 * 1024; // 5MB
                    if (blob.size > maxSize) {
                        showMessage('La imagen es muy grande. M√°ximo 5MB', 'warning');
                        return;
                    }
                    
                    selectedFile = blob;
                    displayScreenshot(blob, 'captura-pegada.png');
                    return;
                }
            }
            
            showMessage('No se detect√≥ ninguna imagen en el portapapeles', 'warning');
        }

        // ==========================================
        // MANEJAR SELECCI√ìN DE ARCHIVO
        // ==========================================
        function handleFileSelect(event) {
            const file = event.target.files[0];
            
            if (!file) {
                return;
            }
            
            // Validar tama√±o
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                showMessage('El archivo es muy grande. M√°ximo 5MB', 'warning');
                event.target.value = '';
                return;
            }
            
            // Validar tipo
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg'];
            if (!validTypes.includes(file.type)) {
                showMessage('Formato no v√°lido. Solo PNG, JPG, JPEG', 'warning');
                event.target.value = '';
                return;
            }
            
            selectedFile = file;
            displayScreenshot(file, file.name);
        }

        // ==========================================
        // MOSTRAR CAPTURA DE PANTALLA
        // ==========================================
        function displayScreenshot(file, fileName) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Mostrar preview
                const previewImg = document.getElementById('preview-img');
                previewImg.src = e.target.result;
                document.getElementById('screenshot-preview').classList.add('show');
                
                // Mostrar info del archivo
                const fileSize = formatFileSize(file.size);
                document.getElementById('file-details').textContent = `${fileName} (${fileSize})`;
                document.getElementById('file-info').classList.add('show');
                
                // Ocultar √°rea de pegar
                document.getElementById('paste-area').style.display = 'none';
            };
            
            reader.readAsDataURL(file);
        }

        // ==========================================
        // LIMPIAR CAPTURA DE PANTALLA
        // ==========================================
        function clearScreenshot() {
            selectedFile = null;
            
            // Limpiar preview
            document.getElementById('preview-img').src = '';
            document.getElementById('screenshot-preview').classList.remove('show');
            
            // Limpiar info
            document.getElementById('file-info').classList.remove('show');
            
            // Limpiar input
            document.getElementById('screenshot-input').value = '';
            
            // Mostrar √°rea de pegar nuevamente
            document.getElementById('paste-area').style.display = 'block';
        }

        // ==========================================
        // FORMATEAR TAMA√ëO DE ARCHIVO
        // ==========================================
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // ==========================================
        // MANEJAR ENV√çO DEL FORMULARIO
        // ==========================================
        async function handleSubmit(event) {
            event.preventDefault();
            
            const description = document.getElementById('description').value.trim();
            const priority = document.getElementById('priority').value;
            
            // Validaciones
            if (description.length < 20) {
                showMessage('La descripci√≥n debe tener al menos 20 caracteres', 'warning');
                return;
            }
            
            if (!priority) {
                showMessage('Por favor selecciona una prioridad', 'warning');
                return;
            }
            
            // Confirmar env√≠o
            if (!confirm('¬øEst√°s seguro de enviar este reporte?')) {
                return;
            }
            
            // Mostrar loading
            showLoading();
            
            try {
                let screenshotUrl = null;
                
                // Subir screenshot si existe
                if (selectedFile) {
                    screenshotUrl = await uploadScreenshot();
                }
                
                // Obtener informaci√≥n del usuario para el reporte
                const userEmail = currentUser.user_mail || currentUser.email || 'No disponible';
                const userDisplayName = document.getElementById('display-user').value;
                
                // Crear el reporte
                const reportData = {
                    user_id: currentUser.user_id,
                    module_id: null, // Ajustar seg√∫n necesites
                    page_url: referrerPage || 'Acceso directo',
                    page_title: document.getElementById('display-page').value,
                    description: description,
                    screenshot_url: screenshotUrl,
                    priority: priority,
                    report_status: 'pendiente'
                };
                
                const result = await supabaseRequest('/bug_reports', {
                    method: 'POST',
                    body: JSON.stringify(reportData)
                });
                
                console.log('‚úÖ Reporte creado:', result);
                
                // Enviar notificaci√≥n por correo al equipo de desarrollo
                try {
                    const reportId = result[0]?.report_id || 'N/A';
                    const emailSubject = `[SchoolNet] Nuevo Bug Report - Prioridad: ${priority.toUpperCase()}`;
                    const emailContent = `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                            <div style="background: #1B365D; color: white; padding: 20px; text-align: center;">
                                <h2 style="margin: 0;">üêõ Nuevo Reporte de Bug</h2>
                            </div>
                            
                            <div style="padding: 20px; background: #f8f9fa;">
                                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                                    <h3 style="color: #1B365D; margin-top: 0;">Informaci√≥n del Reporte</h3>
                                    <p><strong>ID:</strong> ${reportId}</p>
                                    <p><strong>Prioridad:</strong> <span style="color: ${priority === 'critica' ? '#dc3545' : priority === 'alta' ? '#fd7e14' : priority === 'media' ? '#ffc107' : '#28a745'}; font-weight: bold;">${priority.toUpperCase()}</span></p>
                                    <p><strong>Reportado por:</strong> ${userDisplayName}</p>
                                    <p><strong>Email:</strong> ${userEmail}</p>
                                    <p><strong>P√°gina:</strong> ${document.getElementById('display-page').value}</p>
                                    <p><strong>M√≥dulo:</strong> ${document.getElementById('display-module').value}</p>
                                </div>
                                
                                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                                    <h3 style="color: #1B365D; margin-top: 0;">Descripci√≥n del Problema</h3>
                                    <p style="white-space: pre-wrap;">${description}</p>
                                </div>
                                
                                ${screenshotUrl ? `
                                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                                    <h3 style="color: #1B365D; margin-top: 0;">Captura de Pantalla</h3>
                                    <p><a href="${screenshotUrl}" target="_blank" style="color: #0d6efd;">Ver captura adjunta</a></p>
                                </div>
                                ` : ''}
                                
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                                    <p style="margin: 0;"><strong>‚ö†Ô∏è Acci√≥n requerida:</strong> Revisa este reporte en el sistema SchoolNet lo antes posible.</p>
                                </div>
                            </div>
                            
                            <div style="background: #e9ecef; padding: 15px; text-align: center; font-size: 12px; color: #6c757d;">
                                <p style="margin: 0;">Este es un mensaje autom√°tico del sistema SchoolNet.</p>
                                <p style="margin: 5px 0 0 0;">Colegio Tilata - Sistema de Gesti√≥n Educativa</p>
                            </div>
                        </div>
                    `;
                    
                    await sendNotification(
                        'desarrollos@colegiotilata.edu.co',
                        emailSubject,
                        emailContent,
                        true // silent - no mostrar error en UI si falla
                    );
                    
                    console.log('‚úÖ Notificaci√≥n enviada al equipo de desarrollo');
                } catch (emailError) {
                    console.warn('‚ö†Ô∏è Error enviando notificaci√≥n por correo:', emailError);
                    // No interrumpir el flujo si falla el email
                }
                
                // Mostrar √©xito
                showMessage('¬°Reporte enviado exitosamente! Gracias por tu colaboraci√≥n.', 'success');
                
                // Limpiar formulario
                document.getElementById('bug-report-form').reset();
                clearScreenshot();
                
                // Redirigir despu√©s de 2 segundos
                setTimeout(() => {
                    if (referrerPage) {
                        window.location.href = referrerPage;
                    } else {
                        window.location.href = '../dashboard.html';
                    }
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error enviando reporte:', error);
                showMessage('Error al enviar el reporte: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        // ==========================================
        // SUBIR SCREENSHOT A SUPABASE STORAGE
        // ==========================================
        async function uploadScreenshot() {
            try {
                // Generar nombre √∫nico para el archivo
                const timestamp = Date.now();
                const extension = selectedFile.type === 'image/png' ? 'png' : 'jpg';
                const fileName = `screenshot_${timestamp}.${extension}`;
                
                // Subir a Supabase Storage
                const response = await fetch(
                    `${SUPABASE_CONFIG.url}/storage/v1/object/bug-screenshots/${fileName}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                            'Content-Type': selectedFile.type
                        },
                        body: selectedFile
                    }
                );
                
                if (!response.ok) {
                    throw new Error('Error subiendo la imagen');
                }
                
                // Obtener URL p√∫blica
                const publicUrl = `${SUPABASE_CONFIG.url}/storage/v1/object/public/bug-screenshots/${fileName}`;
                
                console.log('‚úÖ Screenshot subido:', publicUrl);
                return publicUrl;
                
            } catch (error) {
                console.error('‚ùå Error subiendo screenshot:', error);
                throw new Error('No se pudo subir la captura de pantalla');
            }
        }

        // ==========================================
        // UTILIDADES DE LOADING
        // ==========================================
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('submit-btn').disabled = true;
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('submit-btn').disabled = false;
        }

    </script>
</body>
</html>
