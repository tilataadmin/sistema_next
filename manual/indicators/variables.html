<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSIÓN DE LA PÁGINA -->
    <meta name="page-version" content="25.06.11.17.30">
    
    <title>Manual - Indicadores - Gestión de Variables - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSIÓN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Encabezado discreto */
        .manual-header {
            background: #f8f9fa;
            border-bottom: 2px solid var(--system-primary-color, #1B365D);
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }

        .manual-header h1 {
            font-size: 1.75rem;
            color: var(--system-primary-color, #1B365D);
            margin-bottom: 0.25rem;
        }

        .manual-header .subtitle {
            color: #6c757d;
            font-size: 0.95rem;
        }

        /* Info card */
        .info-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Tarjeta para reportar bugs */
        .bug-report-card {
            background: var(--system-secondary-color, #667eea);
            color: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .bug-report-card h5 {
            color: white;
        }

        /* Botón flotante para reportar bugs */
        .floating-bug-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            background: var(--system-primary-color, #dc3545) !important;
            border-color: var(--system-primary-color, #dc3545) !important;
        }

        .floating-bug-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
            opacity: 0.9;
        }

        .icon-large {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        /* Estilos para el contenido del manual */
        .section-title {
            color: var(--system-primary-color, #1B365D);
            border-bottom: 2px solid var(--system-primary-color, #1B365D);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            margin-top: 2rem;
        }

        .step-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--system-primary-color, #1B365D);
            color: white;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 0.75rem;
        }

        .feature-list li {
            margin-bottom: 0.5rem;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #0d6efd;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .success-box {
            background: #d1e7dd;
            border-left: 4px solid #198754;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .danger-box {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .comparison-table th,
        .comparison-table td {
            border: 1px solid #dee2e6;
            padding: 0.75rem;
            text-align: left;
        }

        .comparison-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .source-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .source-manual { background: #6c757d; color: white; }
        .source-query { background: #198754; color: white; }
        .source-api { background: #0d6efd; color: white; }
        .source-survey { background: #6f42c1; color: white; }

        .faq-item {
            margin-bottom: 1rem;
        }

        .faq-item h6 {
            color: var(--system-primary-color, #1B365D);
            margin-bottom: 0.5rem;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Cargando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">

        <!-- ENCABEZADO DISCRETO -->
        <div class="manual-header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1>
                            <i class="bi bi-book me-2"></i>
                            Manual: Indicadores
                        </h1>
                        <p class="subtitle mb-0">Gestión de Variables</p>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <a href="../../modules/indicators/variables.html" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-left me-1"></i>Volver al Módulo
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <div class="row">
            <div class="col-lg-8 mx-auto">

                <!-- INFORMACIÓN CONTEXTUAL -->
                <div class="info-card">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Manual de:</h6>
                            <h5 class="mb-1"><strong id="display-module">Indicadores</strong></h5>
                            <p class="text-muted mb-0 small" id="display-page">Gestión de Variables</p>
                        </div>
                        <div class="col-md-6 text-md-end mt-3 mt-md-0">
                            <p class="small text-muted mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Si tienes dudas o encuentras algún problema,<br>
                                puedes reportarlo usando el botón de abajo.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- ========================================== -->
                <!-- CONTENIDO DEL MANUAL -->
                <!-- ========================================== -->

                <!-- SECCIÓN 1: ¿QUÉ ES? -->
                <section>
                    <h2 class="section-title">
                        <i class="bi bi-list-columns me-2"></i>
                        ¿Qué son las Variables?
                    </h2>
                    
                    <div class="step-card">
                        <p class="lead">
                            Las <strong>variables</strong> son los componentes básicos que almacenan 
                            datos numéricos para construir indicadores. Son como "contenedores de datos" 
                            que se llenan periódicamente.
                        </p>
                        
                        <p>
                            Por ejemplo, para calcular el indicador "Tasa de Aprobación", necesitas dos 
                            variables: "Número de estudiantes aprobados" y "Total de estudiantes matriculados". 
                            El indicador usará estas variables en una fórmula matemática.
                        </p>

                        <div class="success-box">
                            <strong><i class="bi bi-lightbulb me-2"></i>Ejemplo práctico:</strong>
                            <br><br>
                            <strong>Variable:</strong> "Total de estudiantes matriculados"<br>
                            <strong>Tipo de dato:</strong> Entero<br>
                            <strong>Periodicidad:</strong> Anual<br>
                            <strong>Fuente:</strong> Consulta SQL automática<br>
                            <strong>Segmentación:</strong> Por Sexo (Masculino/Femenino)<br>
                            <br>
                            Esta variable podría almacenar: Total=500, Masculino=260, Femenino=240
                        </div>

                        <p>
                            Las variables pueden llenarse de forma <strong>manual</strong> (digitando valores) 
                            o <strong>automática</strong> (consultando bases de datos, APIs o encuestas).
                        </p>
                    </div>
                </section>

                <!-- SECCIÓN 2: TIPOS DE FUENTES DE DATOS -->
                <section>
                    <h2 class="section-title">
                        <i class="bi bi-diagram-3 me-2"></i>
                        Tipos de Fuentes de Datos
                    </h2>
                    
                    <div class="step-card">
                        <p>Existen <strong>cuatro formas</strong> de obtener los datos para una variable:</p>

                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">Fuente</th>
                                    <th style="width: 35%;">Descripción</th>
                                    <th style="width: 40%;">Cuándo usarla</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <span class="source-badge source-manual">
                                            <i class="bi bi-keyboard me-1"></i>Manual
                                        </span>
                                    </td>
                                    <td>El responsable digita los valores manualmente</td>
                                    <td>Datos externos, encuestas en papel, información que no está en el sistema</td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="source-badge source-query">
                                            <i class="bi bi-database me-1"></i>Consulta SQL
                                        </span>
                                    </td>
                                    <td>Se ejecuta una consulta automática a la base de datos</td>
                                    <td>Datos que ya existen en SchoolNet (estudiantes, matrículas, notas, etc.)</td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="source-badge source-api">
                                            <i class="bi bi-cloud me-1"></i>API Externa
                                        </span>
                                    </td>
                                    <td>Se obtienen datos desde un servicio externo</td>
                                    <td>Integración con sistemas externos (ministerio, plataformas, etc.)</td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="source-badge source-survey">
                                            <i class="bi bi-clipboard-data me-1"></i>Encuesta
                                        </span>
                                    </td>
                                    <td>Se calcula el promedio de una sección de encuesta</td>
                                    <td>Indicadores de satisfacción, clima laboral, percepción</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="info-box">
                            <strong><i class="bi bi-info-circle me-2"></i>Segmentaciones según fuente:</strong>
                            <ul class="mb-0 mt-2">
                                <li><strong>Variables manuales:</strong> Máximo 1 segmentación (para reducir errores de digitación)</li>
                                <li><strong>Variables automáticas:</strong> Múltiples segmentaciones permitidas</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN 3: CARACTERÍSTICAS PRINCIPALES -->
                <section>
                    <h2 class="section-title">
                        <i class="bi bi-star me-2"></i>
                        Características principales
                    </h2>
                    
                    <div class="step-card">
                        <ul class="feature-list">
                            <li>
                                <strong>Propiedad de variables:</strong> Cada variable tiene un propietario 
                                (quien la creó) que es el único que puede editarla o eliminarla
                            </li>
                            <li>
                                <strong>Responsable de captura:</strong> Se asigna una persona encargada 
                                de capturar los datos (recibe notificación por correo)
                            </li>
                            <li>
                                <strong>Periodicidad flexible:</strong> Anual (1 valor por año) o 
                                Mensual (12 valores por año)
                            </li>
                            <li>
                                <strong>Tipos de dato:</strong> Numérico (decimales), Entero (sin decimales), 
                                Porcentaje (0-100)
                            </li>
                            <li>
                                <strong>Segmentaciones:</strong> Permite dividir los datos por criterios 
                                como sexo, división, área, etc.
                            </li>
                            <li>
                                <strong>Categorías heredadas:</strong> Las variables heredan las categorías 
                                de los indicadores que las utilizan
                            </li>
                            <li>
                                <strong>Validación de queries:</strong> Puedes probar las consultas SQL 
                                antes de guardar la variable
                            </li>
                        </ul>

                        <h5 class="mt-4">Elementos de una variable:</h5>
                        <ul>
                            <li><strong>Nombre:</strong> Identificador descriptivo y único</li>
                            <li><strong>Descripción:</strong> Explicación de qué representa y cómo se captura</li>
                            <li><strong>Tipo de dato:</strong> Numérico, Entero o Porcentaje</li>
                            <li><strong>Periodicidad:</strong> Anual o Mensual</li>
                            <li><strong>Fuente de datos:</strong> Manual, Query, API o Encuesta</li>
                            <li><strong>Responsable:</strong> Usuario encargado de la captura</li>
                            <li><strong>Segmentaciones:</strong> Criterios de clasificación asociados</li>
                            <li><strong>Estado:</strong> Activa o Inactiva</li>
                        </ul>
                    </div>
                </section>

                <!-- SECCIÓN 4: ANTES DE COMENZAR -->
                <section>
                    <h2 class="section-title">
                        <i class="bi bi-clipboard-check me-2"></i>
                        Antes de comenzar
                    </h2>
                    
                    <div class="step-card">
                        <h5>Requisitos previos:</h5>
                        <ul>
                            <li>Tener acceso al módulo de Indicadores</li>
                            <li>Tener el permiso "Variables" asignado</li>
                            <li>Conocer qué datos necesitas capturar para tus indicadores</li>
                        </ul>

                        <h5 class="mt-4">Planificación recomendada:</h5>
                        <p>Antes de crear una variable, define:</p>
                        <ul>
                            <li>¿Qué dato específico vas a medir?</li>
                            <li>¿Con qué frecuencia se actualiza (anual o mensual)?</li>
                            <li>¿De dónde vienen los datos (sistema, externo, encuesta)?</li>
                            <li>¿Necesitas segmentar por algún criterio?</li>
                            <li>¿Quién será responsable de capturar o supervisar los datos?</li>
                        </ul>

                        <div class="warning-box">
                            <strong><i class="bi bi-exclamation-triangle me-2"></i>Importante:</strong>
                            Las variables son la base de los indicadores. Una vez que una variable 
                            tiene datos capturados o está siendo usada en indicadores, no podrá 
                            eliminarse (solo desactivarse).
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN 5: GUÍA PASO A PASO -->
                <section>
                    <h2 class="section-title">
                        <i class="bi bi-list-ol me-2"></i>
                        Guía paso a paso
                    </h2>

                    <!-- Paso 1 -->
                    <div class="step-card">
                        <h4>
                            <span class="step-number">1</span>
                            Entender el panel de variables
                        </h4>
                        
                        <p>Al ingresar a la pantalla de Gestión de Variables, encontrarás:</p>

                        <ul>
                            <li>
                                <strong>Barra de controles:</strong> Botones "Actualizar" y "Nueva Variable"
                            </li>
                            <li>
                                <strong>Filtros:</strong> Búsqueda por texto, fuente de datos, periodicidad, 
                                creador, estado y categorías
                            </li>
                            <li>
                                <strong>Tarjetas de variables:</strong> Cada variable muestra su nombre, 
                                tipo, fuente, propietario y acciones disponibles
                            </li>
                            <li>
                                <strong>Panel de estadísticas:</strong> Totales de variables por tipo
                            </li>
                        </ul>

                        <p><strong>Identificación visual de las tarjetas:</strong></p>
                        <ul>
                            <li>
                                <strong>Badge superior izquierdo:</strong> Indica la fuente de datos 
                                (gris=Manual, verde=SQL, azul=API, púrpura=Encuesta)
                            </li>
                            <li>
                                <strong>Badge superior derecho:</strong> Periodicidad 
                                (amarillo=Anual, celeste=Mensual)
                            </li>
                            <li>
                                <strong>Borde azul izquierdo:</strong> Indica que eres el propietario 
                                de esa variable
                            </li>
                            <li>
                                <strong>Etiqueta "Tuya":</strong> Confirma que creaste esa variable
                            </li>
                        </ul>

                        <div class="info-box">
                            <strong><i class="bi bi-info-circle me-2"></i>Categorías heredadas:</strong>
                            Las variables muestran las categorías de los indicadores que las utilizan. 
                            Si una variable no está asociada a ningún indicador, no mostrará categorías.
                        </div>
                    </div>

                    <!-- Paso 2 -->
                    <div class="step-card">
                        <h4>
                            <span class="step-number">2</span>
                            Crear una variable manual
                        </h4>
                        
                        <p>Las variables manuales son ideales cuando los datos vienen de fuentes externas 
                           o no están en el sistema.</p>

                        <p><strong>Para crear una variable manual:</strong></p>
                        <ol>
                            <li>Haz clic en el botón <strong>"Nueva Variable"</strong></li>
                            <li>Escribe un <strong>nombre</strong> descriptivo (ejemplo: "Inversión en infraestructura")</li>
                            <li>Agrega una <strong>descripción</strong> que explique qué representa</li>
                            <li>Selecciona el <strong>tipo de dato</strong>: Numérico, Entero o Porcentaje</li>
                            <li>
                                Selecciona el <strong>responsable de captura</strong>: la persona que 
                                digitará los valores (recibirá un correo de notificación)
                            </li>
                            <li>Deja la fuente de datos en <strong>"Manual"</strong></li>
                            <li>Elige la <strong>periodicidad</strong>: Anual o Mensual</li>
                            <li>
                                <strong>Opcionalmente</strong>, selecciona una segmentación 
                                (máximo 1 para variables manuales)
                            </li>
                            <li>Haz clic en <strong>"Crear Variable"</strong></li>
                        </ol>

                        <div class="success-box">
                            <strong><i class="bi bi-lightbulb me-2"></i>Ejemplo de variable manual:</strong>
                            <br><br>
                            <strong>Nombre:</strong> Presupuesto ejecutado<br>
                            <strong>Descripción:</strong> Monto total del presupuesto institucional ejecutado en el período<br>
                            <strong>Tipo:</strong> Numérico<br>
                            <strong>Periodicidad:</strong> Anual<br>
                            <strong>Responsable:</strong> Director Financiero<br>
                            <strong>Segmentación:</strong> Ninguna
                        </div>
                    </div>

                    <!-- Paso 3 -->
                    <div class="step-card">
                        <h4>
                            <span class="step-number">3</span>
                            Crear una variable con consulta SQL
                        </h4>
                        
                        <p>Las variables tipo Query obtienen datos automáticamente de la base de datos del sistema.</p>

                        <p><strong>Para crear una variable con consulta SQL:</strong></p>
                        <ol>
                            <li>Haz clic en <strong>"Nueva Variable"</strong></li>
                            <li>Completa nombre, descripción y tipo de dato</li>
                            <li>Selecciona el <strong>responsable</strong> (supervisará que los datos se obtengan correctamente)</li>
                            <li>En fuente de datos, selecciona <strong>"Consulta SQL"</strong></li>
                            <li>
                                Escribe la <strong>consulta SQL</strong> en el campo que aparece.
                                La consulta debe retornar un único valor numérico (usa COUNT, SUM, AVG, etc.)
                            </li>
                            <li>
                                <strong>Usa parámetros</strong> para segmentaciones:
                                <ul>
                                    <li><code>:segment_sexo_id</code> - para segmentar por sexo</li>
                                    <li><code>:academic_year_id</code> - para el año académico</li>
                                    <li><code>:month_number</code> - para el mes (si es mensual)</li>
                                </ul>
                            </li>
                            <li>
                                Haz clic en <strong>"Probar Query"</strong> para validar que funciona correctamente
                            </li>
                            <li>Selecciona las <strong>segmentaciones</strong> correspondientes a los parámetros usados</li>
                            <li>Haz clic en <strong>"Crear Variable"</strong></li>
                        </ol>

                        <div class="warning-box">
                            <strong><i class="bi bi-exclamation-triangle me-2"></i>Importante sobre queries:</strong>
                            <ul class="mb-0 mt-2">
                                <li>La consulta debe retornar un único valor numérico</li>
                                <li>Usa funciones de agregación: COUNT(*), SUM(campo), AVG(campo)</li>
                                <li>Los parámetros de segmentación se reemplazan automáticamente al ejecutar</li>
                                <li>Siempre prueba la query antes de guardar</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Paso 4 -->
                    <div class="step-card">
                        <h4>
                            <span class="step-number">4</span>
                            Crear una variable desde encuesta
                        </h4>
                        
                        <p>Las variables tipo Encuesta calculan automáticamente el promedio de una sección completa 
                           de una encuesta del sistema.</p>

                        <p><strong>Para crear una variable desde encuesta:</strong></p>
                        <ol>
                            <li>Haz clic en <strong>"Nueva Variable"</strong></li>
                            <li>Completa nombre, descripción y tipo de dato (generalmente "Numérico")</li>
                            <li>Selecciona el <strong>responsable</strong></li>
                            <li>En fuente de datos, selecciona <strong>"Encuesta"</strong></li>
                            <li>Selecciona la <strong>Encuesta Maestra</strong> de la lista desplegable</li>
                            <li>Selecciona la <strong>Sección</strong> de la encuesta que deseas medir</li>
                            <li>Configura la periodicidad y segmentaciones</li>
                            <li>Haz clic en <strong>"Crear Variable"</strong></li>
                        </ol>

                        <div class="info-box">
                            <strong><i class="bi bi-info-circle me-2"></i>¿Cómo funciona?</strong>
                            El sistema calculará automáticamente el promedio de todas las preguntas 
                            de la sección seleccionada. La aplicación específica de la encuesta se 
                            selecciona al momento de capturar los datos.
                        </div>
                    </div>

                    <!-- Paso 5 -->
                    <div class="step-card">
                        <h4>
                            <span class="step-number">5</span>
                            Asignar segmentaciones
                        </h4>
                        
                        <p>Las segmentaciones permiten dividir los datos de una variable por criterios específicos.</p>

                        <p><strong>Para asignar segmentaciones:</strong></p>
                        <ol>
                            <li>En el formulario de creación/edición, localiza la sección "Segmentaciones"</li>
                            <li>Verás una lista de segmentaciones disponibles con checkboxes</li>
                            <li>Marca las segmentaciones que deseas asociar</li>
                            <li>
                                <strong>Restricción importante:</strong>
                                <ul>
                                    <li>Variables manuales: máximo 1 segmentación</li>
                                    <li>Variables automáticas: sin límite</li>
                                </ul>
                            </li>
                            <li>Puedes usar el botón "Limpiar todo" para quitar todas las selecciones</li>
                        </ol>

                        <div class="info-box">
                            <strong><i class="bi bi-info-circle me-2"></i>¿Por qué el límite en manuales?</strong>
                            Las variables manuales requieren digitación. Si tiene muchas segmentaciones, 
                            el responsable tendría que digitar demasiados valores, aumentando el riesgo 
                            de errores. Por eso se limita a 1 segmentación.
                        </div>
                    </div>

                    <!-- Paso 6 -->
                    <div class="step-card">
                        <h4>
                            <span class="step-number">6</span>
                            Buscar y filtrar variables
                        </h4>
                        
                        <p>Cuando tengas muchas variables, puedes encontrar rápidamente la que necesitas:</p>

                        <ul>
                            <li>
                                <strong>Búsqueda por texto:</strong> Escribe parte del nombre o descripción
                            </li>
                            <li>
                                <strong>Filtro por fuente:</strong> Manuales, Consultas SQL, APIs o Encuestas
                            </li>
                            <li>
                                <strong>Filtro por periodicidad:</strong> Anuales o Mensuales
                            </li>
                            <li>
                                <strong>Filtro por creador:</strong> "Solo mis variables" o selecciona un usuario específico
                            </li>
                            <li>
                                <strong>Filtro por estado:</strong> Activas o Inactivas
                            </li>
                            <li>
                                <strong>Filtro por categorías:</strong> Selecciona una o más categorías 
                                (las variables heredan categorías de los indicadores)
                            </li>
                        </ul>

                        <p>
                            Los filtros se pueden combinar y se guardan en tu navegador para 
                            mantener tu preferencia.
                        </p>
                    </div>

                    <!-- Paso 7 -->
                    <div class="step-card">
                        <h4>
                            <span class="step-number">7</span>
                            Editar una variable
                        </h4>
                        
                        <p>Solo puedes editar las variables que tú creaste.</p>

                        <p><strong>Para editar una variable:</strong></p>
                        <ol>
                            <li>Localiza la variable (debe tener el borde azul y etiqueta "Tuya")</li>
                            <li>Haz clic en el botón <strong>lápiz</strong> <i class="bi bi-pencil"></i></li>
                            <li>Se abrirá el formulario con los datos actuales</li>
                            <li>Modifica los campos necesarios</li>
                            <li>Haz clic en <strong>"Actualizar Variable"</strong></li>
                        </ol>

                        <div class="warning-box">
                            <strong><i class="bi bi-exclamation-triangle me-2"></i>Precaución:</strong>
                            Si cambias el responsable de captura, la nueva persona recibirá una 
                            notificación por correo electrónico informándole de su nueva responsabilidad.
                        </div>
                    </div>

                    <!-- Paso 8 -->
                    <div class="step-card">
                        <h4>
                            <span class="step-number">8</span>
                            Ver detalles de una variable
                        </h4>
                        
                        <p>Puedes ver información completa de cualquier variable (aunque no sea tuya).</p>

                        <p><strong>Para ver detalles:</strong></p>
                        <ol>
                            <li>Haz clic en el botón <strong>ojo</strong> <i class="bi bi-eye"></i> de la tarjeta</li>
                            <li>
                                Se mostrará un panel con:
                                <ul>
                                    <li>Nombre y descripción completa</li>
                                    <li>Tipo de dato y periodicidad</li>
                                    <li>Fuente de datos y configuración</li>
                                    <li>Si es Query, mostrará la consulta SQL</li>
                                    <li>Segmentaciones asociadas</li>
                                    <li>Fecha de creación</li>
                                </ul>
                            </li>
                            <li>Cierra el panel con la X en la esquina</li>
                        </ol>
                    </div>

                    <!-- Paso 9 -->
                    <div class="step-card">
                        <h4>
                            <span class="step-number">9</span>
                            Activar, desactivar o eliminar
                        </h4>
                        
                        <p>Solo puedes modificar el estado de tus propias variables.</p>

                        <p><strong>Desactivar una variable:</strong></p>
                        <ol>
                            <li>Haz clic en el botón <strong>pausa</strong> <i class="bi bi-pause"></i></li>
                            <li>Confirma la acción</li>
                            <li>La variable quedará inactiva y no aparecerá en la captura de datos</li>
                        </ol>

                        <p><strong>Activar una variable:</strong></p>
                        <ol>
                            <li>Filtra por "Inactivas" para encontrarla</li>
                            <li>Haz clic en el botón <strong>play</strong> <i class="bi bi-play"></i></li>
                            <li>Confirma la acción</li>
                        </ol>

                        <p><strong>Eliminar una variable:</strong></p>
                        <ol>
                            <li>Haz clic en el botón <strong>papelera</strong> <i class="bi bi-trash"></i></li>
                            <li>El sistema validará que la variable:
                                <ul>
                                    <li>No tenga datos capturados</li>
                                    <li>No esté siendo usada en indicadores activos</li>
                                </ul>
                            </li>
                            <li>Si pasa las validaciones, confirma la eliminación</li>
                        </ol>

                        <div class="danger-box">
                            <strong><i class="bi bi-exclamation-octagon me-2"></i>Eliminación permanente:</strong>
                            La eliminación es irreversible. Si la variable tiene datos o está en uso, 
                            no podrá eliminarse. En ese caso, solo podrás desactivarla.
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN 6: SOLUCIÓN DE PROBLEMAS -->
                <section>
                    <h2 class="section-title">
                        <i class="bi bi-question-circle me-2"></i>
                        Solución de problemas comunes
                    </h2>

                    <div class="step-card">
                        <h5>No puedo editar una variable</h5>
                        <ul>
                            <li>Solo puedes editar variables que tú creaste</li>
                            <li>Verifica que la tarjeta tenga el borde azul izquierdo y la etiqueta "Tuya"</li>
                            <li>Si necesitas modificar una variable de otro usuario, contacta al propietario</li>
                        </ul>

                        <h5 class="mt-4">La prueba de Query falla</h5>
                        <ul>
                            <li>Verifica que la consulta comience con SELECT</li>
                            <li>Asegúrate de usar funciones de agregación (COUNT, SUM, AVG)</li>
                            <li>Revisa que los nombres de tablas y campos sean correctos</li>
                            <li>Si usas parámetros de segmentación, verifica que la segmentación exista</li>
                            <li>Los parámetros deben escribirse exactamente como: <code>:segment_nombre_id</code></li>
                        </ul>

                        <h5 class="mt-4">No puedo eliminar una variable</h5>
                        <ul>
                            <li>La variable tiene datos capturados: solo puedes desactivarla</li>
                            <li>La variable está en uso en indicadores: primero modifica o elimina esos indicadores</li>
                            <li>No eres el propietario: solo el creador puede eliminarla</li>
                        </ul>

                        <h5 class="mt-4">No puedo agregar más de una segmentación</h5>
                        <ul>
                            <li>Las variables manuales solo permiten 1 segmentación</li>
                            <li>Cambia la fuente de datos a "Consulta SQL" si necesitas múltiples segmentaciones</li>
                            <li>Si ya seleccionaste una, debes deseleccionarla primero para elegir otra</li>
                        </ul>

                        <h5 class="mt-4">El responsable no recibió el correo</h5>
                        <ul>
                            <li>Verifica que el usuario tenga un correo válido registrado</li>
                            <li>Revisa la carpeta de spam o correo no deseado</li>
                            <li>El sistema de notificaciones podría estar temporalmente fuera de servicio</li>
                        </ul>

                        <h5 class="mt-4">No veo las categorías en mi variable</h5>
                        <ul>
                            <li>Las categorías se heredan de los indicadores que usan la variable</li>
                            <li>Si la variable no está asociada a ningún indicador, no tendrá categorías</li>
                            <li>Primero crea un indicador que use esta variable y asígnale categorías</li>
                        </ul>
                    </div>
                </section>

                <!-- SECCIÓN 7: BUENAS PRÁCTICAS -->
                <section>
                    <h2 class="section-title">
                        <i class="bi bi-check2-circle me-2"></i>
                        Buenas prácticas
                    </h2>

                    <div class="step-card">
                        <ul class="feature-list">
                            <li>
                                <strong>Nombres descriptivos y únicos:</strong> 
                                "Total estudiantes matriculados 2024" es mejor que "Variable 1"
                            </li>
                            <li>
                                <strong>Descripciones claras:</strong> 
                                Explica qué mide, de dónde vienen los datos y cualquier consideración especial
                            </li>
                            <li>
                                <strong>Prefiere automáticas cuando sea posible:</strong> 
                                Las consultas SQL reducen errores humanos y mantienen datos actualizados
                            </li>
                            <li>
                                <strong>Prueba siempre las queries:</strong> 
                                Usa el botón "Probar Query" antes de guardar para evitar errores
                            </li>
                            <li>
                                <strong>Asigna responsables apropiados:</strong> 
                                La persona debe tener acceso a la información y tiempo para capturarla
                            </li>
                            <li>
                                <strong>Usa segmentaciones con moderación:</strong> 
                                Cada segmentación multiplica los datos a capturar
                            </li>
                            <li>
                                <strong>Desactiva en lugar de eliminar:</strong> 
                                Si una variable ya no se usa, desactívala para mantener el histórico
                            </li>
                            <li>
                                <strong>Coordina con otros usuarios:</strong> 
                                Evita duplicar variables que ya existen en el sistema
                            </li>
                        </ul>
                    </div>
                </section>

                <!-- SECCIÓN 8: PREGUNTAS FRECUENTES -->
                <section>
                    <h2 class="section-title">
                        <i class="bi bi-chat-dots me-2"></i>
                        Preguntas frecuentes
                    </h2>

                    <div class="step-card">
                        <div class="faq-item">
                            <h6>¿Puedo usar la misma variable en varios indicadores?</h6>
                            <p>
                                Sí, una variable puede ser utilizada por múltiples indicadores. 
                                Por ejemplo, "Total de estudiantes" puede usarse tanto en "Tasa de aprobación" 
                                como en "Estudiantes por docente".
                            </p>
                        </div>

                        <div class="faq-item">
                            <h6>¿Qué pasa si cambio la periodicidad de una variable?</h6>
                            <p>
                                Si cambias de anual a mensual, necesitarás capturar datos para cada mes. 
                                Si cambias de mensual a anual, solo podrás capturar un valor por año. 
                                Los datos existentes no se pierden.
                            </p>
                        </div>

                        <div class="faq-item">
                            <h6>¿Puedo ver las variables de otros usuarios?</h6>
                            <p>
                                Sí, puedes ver los detalles de cualquier variable usando el botón de ojo. 
                                Sin embargo, solo puedes editar y eliminar las variables que tú creaste.
                            </p>
                        </div>

                        <div class="faq-item">
                            <h6>¿Cómo sé qué indicadores usan mi variable?</h6>
                            <p>
                                Actualmente no hay una vista directa de esta relación. Puedes revisar 
                                los indicadores del sistema o intentar eliminar la variable: el sistema 
                                te indicará si está en uso.
                            </p>
                        </div>

                        <div class="faq-item">
                            <h6>¿Las variables automáticas se actualizan solas?</h6>
                            <p>
                                No automáticamente. Las consultas SQL se ejecutan cuando se solicita 
                                la captura de datos. El sistema no actualiza valores sin intervención 
                                del responsable o del proceso de captura.
                            </p>
                        </div>

                        <div class="faq-item">
                            <h6>¿Puedo cambiar el tipo de fuente de una variable existente?</h6>
                            <p>
                                Sí, puedes cambiar de Manual a Query o viceversa al editar la variable. 
                                Sin embargo, considera que esto puede afectar cómo se capturan los datos 
                                y las segmentaciones permitidas.
                            </p>
                        </div>

                        <div class="faq-item">
                            <h6>¿Qué significa "Categorías heredadas"?</h6>
                            <p>
                                Las variables no tienen categorías propias. Cuando un indicador usa una 
                                variable y ese indicador tiene categorías asignadas, la variable "hereda" 
                                esas categorías para facilitar los filtros.
                            </p>
                        </div>

                        <div class="faq-item">
                            <h6>¿Por qué mi query funciona en la prueba pero falla al capturar?</h6>
                            <p>
                                La prueba usa valores de ejemplo. Al capturar datos reales, los parámetros 
                                toman valores específicos. Verifica que tu query maneje correctamente 
                                todos los casos posibles de segmentación.
                            </p>
                        </div>
                    </div>
                </section>

                <!-- ========================================== -->
                <!-- FIN DEL CONTENIDO DEL MANUAL -->
                <!-- ========================================== -->

                <!-- TARJETA PARA REPORTAR BUGS -->
                <div class="bug-report-card">
                    <i class="bi bi-bug-fill icon-large"></i>
                    <h4 class="mb-3">¿Encontraste un problema o tienes una sugerencia?</h4>
                    <p class="mb-4">
                        Si experimentaste un error, algo no funciona como esperas, o tienes 
                        una sugerencia para mejorar el sistema, repórtalo aquí.
                    </p>
                    <a href="../report-bug.html" class="btn btn-light btn-lg">
                        <i class="bi bi-exclamation-triangle me-2"></i>Reportar Bug o Problema
                    </a>
                </div>

            </div>
        </div>

    </div>

    <!-- BOTÓN FLOTANTE PARA REPORTAR BUGS -->
    <a href="../report-bug.html" class="btn btn-danger btn-lg floating-bug-button" title="Reportar Bug">
        <i class="bi bi-bug-fill me-2"></i>Reportar Bug
    </a>

    <!-- SCRIPTS - ORDEN CRÍTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;

        // ==========================================
        // CONFIGURACIÓN DE LA PÁGINA
        // ==========================================
        const PAGE_CONFIG = {
            moduleName: 'Indicadores',
            modulePath: 'indicators',
            pageTitle: 'Gestión de Variables',
            pagePath: 'variables.html',
            moduleDescription: 'Administra las variables para captura de datos e indicadores'
        };

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('📖 Iniciando página de manual...');
            
            try {
                // Verificar si existe la función de colores corporativos
                if (typeof loadAndApplyBrandColors === 'function') {
                    await loadAndApplyBrandColors();
                }
                
                // Verificar sesión si la función existe
                if (typeof getStoredSession === 'function') {
                    const session = getStoredSession();
                    if (session && session.user) {
                        currentUser = session.user;
                    }
                }
                
                // Actualizar información en la página
                updatePageInfo();
                
                console.log('✅ Página de manual lista');
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                if (typeof showMessage === 'function') {
                    showMessage('Error al cargar la página: ' + error.message, 'danger');
                }
            }
        });

        // ==========================================
        // ACTUALIZAR INFORMACIÓN DE LA PÁGINA
        // ==========================================
        function updatePageInfo() {
            document.title = `Manual - ${PAGE_CONFIG.moduleName} - ${PAGE_CONFIG.pageTitle} - SchoolNet`;
        }

        // ==========================================
        // UTILIDADES DE LOADING
        // ==========================================
        function showLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
            }
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }

        // ==========================================
        // FUNCIÓN DE MENSAJES
        // ==========================================
        function showMessage(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) return;
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alertDiv);
            
            // Auto-remove después de 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

    </script>
</body>
</html>
