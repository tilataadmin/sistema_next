<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- VERSI√ìN DE LA P√ÅGINA -->
    <meta name="page-version" content="25.01.07.15.00">
    
    <title>Manual - [NOMBRE_MODULO] - SchoolNet</title>
    
    <!-- Bootstrap CSS - VERSI√ìN FIJA PROBADA -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .manual-hero {
            background: var(--system-primary-color, #1B365D);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
            border-radius: 12px;
            text-align: center;
        }

        .construction-card {
            background: #fff3cd;
            border: 2px dashed var(--system-tertiary-color, #ffc107);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .construction-icon {
            font-size: 4rem;
            color: var(--system-tertiary-color, #ffc107);
            margin-bottom: 1rem;
        }

        .suggestion-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--system-secondary-color, #667eea);
        }

        .bug-report-card {
            background: var(--system-secondary-color, #667eea);
            color: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .bug-report-card h5 {
            color: white;
        }

        .info-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .floating-bug-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            background: var(--system-primary-color, #dc3545) !important;
            border-color: var(--system-primary-color, #dc3545) !important;
        }

        .floating-bug-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
            opacity: 0.9;
        }

        .icon-large {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="mb-0">Enviando...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="container-fluid">
        
        <!-- BREADCRUMBS -->
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="../../dashboard.html">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="../../modules/[MODULO_PATH]/index.html">[NOMBRE_MODULO]</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="#">Manual</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    [NOMBRE_PAGINA]
                </li>
            </ol>
        </nav>

        <!-- HERO SECTION -->
        <div class="manual-hero">
            <div class="container">
                <i class="bi bi-book icon-large"></i>
                <h1 class="display-5 fw-bold mb-3">Manual de [NOMBRE_MODULO]</h1>
                <p class="lead mb-0">[DESCRIPCION_MODULO]</p>
            </div>
        </div>

        <!-- CONTENEDOR DE ALERTAS -->
        <div id="alertContainer"></div>

        <div class="row">
            <div class="col-lg-8 mx-auto">

                <!-- MENSAJE DE CONSTRUCCI√ìN -->
                <div class="construction-card">
                    <i class="bi bi-tools construction-icon"></i>
                    <h3 class="mb-3">üìñ Estamos trabajando en esta secci√≥n</h3>
                    <p class="lead mb-0">
                        Esta p√°gina del manual est√° en construcci√≥n. Queremos crear contenido 
                        que realmente te sea √∫til, por eso <strong>tu opini√≥n es muy importante</strong>.
                    </p>
                </div>

                <!-- INFORMACI√ìN CONTEXTUAL -->
                <div class="info-card">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Est√°s viendo el manual de:</h6>
                            <h5 class="mb-1"><strong id="display-module">[NOMBRE_MODULO]</strong></h5>
                            <p class="text-muted mb-0 small" id="display-page">[NOMBRE_PAGINA]</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <a href="../../modules/[MODULO_PATH]/[PAGINA_PATH]" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-left me-1"></i>Volver al M√≥dulo
                            </a>
                        </div>
                    </div>
                </div>

                <!-- FORMULARIO DE SUGERENCIAS -->
                <div class="suggestion-card">
                    <h4 class="mb-4">
                        <i class="bi bi-lightbulb me-2 text-warning"></i>
                        ¬øQu√© te gustar√≠a aprender sobre esta secci√≥n?
                    </h4>
                    
                    <form id="suggestion-form">
                        <div class="mb-4">
                            <label for="suggestion-text" class="form-label fw-bold">
                                Cu√©ntanos qu√© informaci√≥n necesitas
                            </label>
                            <textarea 
                                class="form-control" 
                                id="suggestion-text" 
                                rows="5"
                                required
                                placeholder="Por ejemplo:&#10;- ¬øC√≥mo puedo...?&#10;- Me gustar√≠a saber sobre...&#10;- Necesito instrucciones para...&#10;- Tengo dudas sobre..."
                            ></textarea>
                            <div class="form-text">
                                M√≠nimo 20 caracteres. S√© espec√≠fico para que podamos ayudarte mejor.
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="suggestion-priority" class="form-label fw-bold">
                                ¬øQu√© tan urgente es para ti?
                            </label>
                            <select class="form-select" id="suggestion-priority" required>
                                <option value="">Seleccione...</option>
                                <option value="baja">Baja - Solo curiosidad</option>
                                <option value="media" selected>Media - Me ser√≠a √∫til</option>
                                <option value="alta">Alta - Lo necesito pronto</option>
                            </select>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                                <i class="bi bi-send me-2"></i>Enviar Sugerencia
                            </button>
                        </div>
                    </form>
                </div>

                <!-- TARJETA PARA REPORTAR BUGS -->
                <div class="bug-report-card">
                    <i class="bi bi-bug-fill icon-large"></i>
                    <h4 class="mb-3">¬øEncontraste un problema en el sistema?</h4>
                    <p class="mb-4">
                        Si experimentaste un error, algo no funciona como esperas, o tienes 
                        una sugerencia para mejorar el sistema, rep√≥rtalo aqu√≠.
                    </p>
                    <a href="../report-bug.html" class="btn btn-light btn-lg">
                        <i class="bi bi-exclamation-triangle me-2"></i>Reportar Bug o Problema
                    </a>
                </div>

                <!-- INFORMACI√ìN ADICIONAL -->
                <div class="alert alert-info">
                    <h6 class="alert-heading">
                        <i class="bi bi-info-circle me-2"></i>¬øSab√≠as que?
                    </h6>
                    <p class="mb-0">
                        Tu retroalimentaci√≥n nos ayuda a priorizar qu√© secciones del manual 
                        crear primero. Todas las sugerencias son revisadas por el equipo de 
                        desarrollo para mejorar continuamente SchoolNet.
                    </p>
                </div>

            </div>
        </div>

    </div>

    <!-- BOT√ìN FLOTANTE PARA REPORTAR BUGS -->
    <a href="../report-bug.html" class="btn btn-danger btn-lg floating-bug-button" title="Reportar Bug">
        <i class="bi bi-bug-fill me-2"></i>Reportar Bug
    </a>

    <!-- SCRIPTS - ORDEN CR√çTICO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentUser = null;
        let currentPage = null;
        let detectedModule = null;

        // ==========================================
        // CONFIGURACI√ìN DE LA P√ÅGINA
        // ==========================================
        // PERSONALIZAR ESTOS VALORES PARA CADA P√ÅGINA
        const PAGE_CONFIG = {
            moduleName: '[NOMBRE_MODULO]',
            modulePath: '[MODULO_PATH]', // Ej: 'security', 'hr', 'config'
            pageTitle: '[NOMBRE_PAGINA]',
            pagePath: '[PAGINA_PATH]', // Ej: 'users.html', 'index.html'
            moduleDescription: '[DESCRIPCION_MODULO]'
        };

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìñ Iniciando p√°gina de manual...');
            
            try {
                // Cargar colores corporativos primero
                await loadAndApplyBrandColors();
                
                // Obtener sesi√≥n del usuario
                const session = getStoredSession();
                if (!session || !session.user) {
                    showMessage('Debes iniciar sesi√≥n para acceder al manual', 'danger');
                    setTimeout(() => {
                        window.location.href = '../../login.html';
                    }, 2000);
                    return;
                }

                currentUser = session.user;
                
                // Actualizar informaci√≥n en la p√°gina
                updatePageInfo();
                
                // Configurar formulario
                setupForm();
                
                console.log('‚úÖ P√°gina lista');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                showMessage('Error al cargar la p√°gina: ' + error.message, 'danger');
            }
        });

        // ==========================================
        // ACTUALIZAR INFORMACI√ìN DE LA P√ÅGINA
        // ==========================================
        function updatePageInfo() {
            // Actualizar breadcrumbs y enlaces
            const moduleLinks = document.querySelectorAll('[href*="[MODULO_PATH]"]');
            moduleLinks.forEach(link => {
                link.href = link.href.replace('[MODULO_PATH]', PAGE_CONFIG.modulePath);
            });

            const pageLinks = document.querySelectorAll('[href*="[PAGINA_PATH]"]');
            pageLinks.forEach(link => {
                link.href = link.href.replace('[PAGINA_PATH]', PAGE_CONFIG.pagePath);
            });

            // Actualizar textos
            document.querySelectorAll('[NOMBRE_MODULO]').forEach(el => {
                el.textContent = PAGE_CONFIG.moduleName;
            });

            document.querySelectorAll('[NOMBRE_PAGINA]').forEach(el => {
                el.textContent = PAGE_CONFIG.pageTitle;
            });

            document.querySelectorAll('[DESCRIPCION_MODULO]').forEach(el => {
                el.textContent = PAGE_CONFIG.moduleDescription;
            });

            // Actualizar title
            document.title = `Manual - ${PAGE_CONFIG.moduleName} - SchoolNet`;
        }

        // ==========================================
        // CONFIGURAR FORMULARIO
        // ==========================================
        function setupForm() {
            const form = document.getElementById('suggestion-form');
            form.addEventListener('submit', handleSubmit);
        }

        // ==========================================
        // MANEJAR ENV√çO DEL FORMULARIO
        // ==========================================
        async function handleSubmit(event) {
            event.preventDefault();
            
            const suggestionText = document.getElementById('suggestion-text').value.trim();
            const priority = document.getElementById('suggestion-priority').value;
            
            // Validaciones
            if (suggestionText.length < 20) {
                showMessage('La sugerencia debe tener al menos 20 caracteres', 'warning');
                return;
            }
            
            if (!priority) {
                showMessage('Por favor selecciona una prioridad', 'warning');
                return;
            }
            
            // Mostrar loading
            showLoading();
            
            try {
                // Detectar m√≥dulo (si es posible)
                let moduleId = null;
                try {
                    const permissions = await supabaseRequest(
                        '/permissions?select=permission_id&permission_module=eq.' + PAGE_CONFIG.modulePath
                    );
                    if (permissions && permissions.length > 0) {
                        moduleId = permissions[0].permission_id;
                    }
                } catch (err) {
                    console.warn('No se pudo detectar el m√≥dulo:', err);
                }
                
                // Crear la sugerencia
                const suggestionData = {
                    user_id: currentUser.user_id,
                    module_id: moduleId,
                    page_url: window.location.pathname,
                    page_title: PAGE_CONFIG.pageTitle,
                    suggestion_text: suggestionText,
                    priority: priority,
                    suggestion_status: 'pendiente'
                };
                
                const result = await supabaseRequest('/manual_suggestions', {
                    method: 'POST',
                    body: JSON.stringify(suggestionData)
                });
                
                console.log('‚úÖ Sugerencia enviada:', result);
                
                // Mostrar √©xito
                showMessage('¬°Gracias por tu sugerencia! La revisaremos pronto.', 'success');
                
                // Limpiar formulario
                document.getElementById('suggestion-form').reset();
                
            } catch (error) {
                console.error('‚ùå Error enviando sugerencia:', error);
                showMessage('Error al enviar la sugerencia: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }

        // ==========================================
        // UTILIDADES DE LOADING
        // ==========================================
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('submit-btn').disabled = true;
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('submit-btn').disabled = false;
        }

    </script>
</body>
</html>
