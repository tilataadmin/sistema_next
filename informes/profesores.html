<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Colegio Tilatá — Dashboard Financiero</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #1b365d;
    --primary-light: #2a4f7f;
    --primary-dark: #0f1f36;
    --secondary: #efefef;
    --accent: #c8553d;
    --accent-light: #e8856f;
    --success: #3a7d44;
    --warning: #d4a843;
    --bg: #f7f5f2;
    --card: #ffffff;
    --text: #1a1a1a;
    --text-muted: #6b7280;
    --border: #e5e2dd;
    --shadow: 0 1px 3px rgba(27,54,93,0.06), 0 8px 24px rgba(27,54,93,0.04);
    --shadow-lg: 0 4px 12px rgba(27,54,93,0.08), 0 20px 48px rgba(27,54,93,0.06);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }

  /* Header */
  .header {
    background: var(--primary);
    color: white;
    padding: 2rem 3rem;
    position: relative;
    overflow: hidden;
  }
  .header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 500px;
    height: 500px;
    border-radius: 50%;
    background: rgba(255,255,255,0.03);
  }
  .header-content {
    max-width: 1280px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }
  .header-top {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    margin-bottom: 1.5rem;
  }
  .header-logo {
    height: 48px;
    filter: brightness(0) invert(1);
  }
  .header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.75rem;
    font-weight: 400;
    letter-spacing: -0.02em;
  }
  .header p {
    opacity: 0.7;
    font-size: 0.9rem;
    font-weight: 300;
  }

  /* KPI Cards */
  .kpi-strip {
    max-width: 1280px;
    margin: -2rem auto 2rem;
    padding: 0 2rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
    position: relative;
    z-index: 2;
  }
  .kpi-card {
    background: var(--card);
    border-radius: 12px;
    padding: 1.25rem 1.5rem;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border);
    transition: transform 0.2s;
  }
  .kpi-card:hover { transform: translateY(-2px); }
  .kpi-label {
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    margin-bottom: 0.35rem;
  }
  .kpi-value {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem;
    color: var(--primary);
    line-height: 1.1;
  }
  .kpi-sub {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
  }
  .kpi-sub.negative { color: var(--accent); font-weight: 600; }
  .kpi-sub.warning { color: var(--warning); font-weight: 600; }
  .kpi-sub.positive { color: var(--success); font-weight: 600; }

  /* Main content */
  .main {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 2rem 3rem;
  }

  /* Section */
  .section {
    margin-bottom: 2rem;
  }
  .section-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.3rem;
    color: var(--primary);
    margin-bottom: 0.25rem;
  }
  .section-subtitle {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
  }

  /* Chart containers */
  .chart-card {
    background: var(--card);
    border-radius: 12px;
    padding: 1.75rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    margin-bottom: 1.5rem;
  }
  .chart-card h3 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.1rem;
    color: var(--primary);
    margin-bottom: 0.25rem;
  }
  .chart-card .chart-desc {
    font-size: 0.82rem;
    color: var(--text-muted);
    margin-bottom: 1.25rem;
  }
  .chart-wrapper {
    position: relative;
    width: 100%;
  }

  /* Grid layouts */
  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
  }

  /* Table styles */
  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82rem;
  }
  .data-table th {
    background: var(--primary);
    color: white;
    padding: 0.6rem 0.75rem;
    text-align: right;
    font-weight: 500;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .data-table th:first-child { text-align: left; border-radius: 6px 0 0 0; }
  .data-table th:last-child { border-radius: 0 6px 0 0; }
  .data-table td {
    padding: 0.5rem 0.75rem;
    text-align: right;
    border-bottom: 1px solid var(--border);
  }
  .data-table td:first-child { text-align: left; font-weight: 500; }
  .data-table tr:last-child td { font-weight: 700; border-bottom: none; }
  .data-table tr:hover { background: rgba(27,54,93,0.02); }
  .cell-negative { color: var(--accent); font-weight: 600; }
  .cell-positive { color: var(--success); font-weight: 600; }

  /* Toggle control */
  .toggle-group {
    display: inline-flex;
    background: var(--secondary);
    border-radius: 8px;
    padding: 3px;
    margin-bottom: 1rem;
  }
  .toggle-btn {
    padding: 0.4rem 1rem;
    border: none;
    background: transparent;
    border-radius: 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
  }
  .toggle-btn.active {
    background: var(--primary);
    color: white;
    box-shadow: 0 1px 4px rgba(27,54,93,0.2);
  }

  /* Responsive */
  @media (max-width: 900px) {
    .grid-2 { grid-template-columns: 1fr; }
    .header { padding: 1.5rem; }
    .kpi-strip { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 600px) {
    .kpi-strip { grid-template-columns: 1fr; }
    .main { padding: 0 1rem 2rem; }
  }

  /* Insight callout */
  .insight {
    background: linear-gradient(135deg, #fef3ee, #fef9f5);
    border-left: 3px solid var(--accent);
    padding: 1rem 1.25rem;
    border-radius: 0 8px 8px 0;
    margin-top: 1rem;
    font-size: 0.85rem;
    color: #5a3425;
  }
  .insight strong { color: var(--accent); }

  .footer {
    text-align: center;
    padding: 2rem;
    font-size: 0.75rem;
    color: var(--text-muted);
    border-top: 1px solid var(--border);
    max-width: 1280px;
    margin: 0 auto;
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-content">
    <div class="header-top">
      <img src="https://colegiotilata.edu.co/wp-content/uploads/2025/04/Logo-Tilata.png" alt="Colegio Tilatá" class="header-logo" crossorigin="anonymous" onerror="this.style.display='none'">
      <div>
        <h1>Análisis Financiero de Matrícula</h1>
        <p>Tendencias 2020–2026 · Impacto financiero · Ratio educadores</p>
      </div>
    </div>
  </div>
</div>

<!-- KPI Cards -->
<div class="kpi-strip">
  <div class="kpi-card">
    <div class="kpi-label">Estudiantes actuales</div>
    <div class="kpi-value" id="kpi-students">442</div>
    <div class="kpi-sub negative" id="kpi-students-sub">▼ 86 vs pico (528)</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Ingreso dejado de percibir</div>
    <div class="kpi-value" id="kpi-lost-revenue">—</div>
    <div class="kpi-sub negative">Acumulado vs año pico</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Ratio estudiantes / profesor</div>
    <div class="kpi-value" id="kpi-ratio">7.6 : 1</div>
    <div class="kpi-sub" style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.15rem;">Solo docentes de aula (58)</div>
    <div class="kpi-sub warning" style="margin-top: 0.35rem;">Equipo pedagógico completo (65): 6.8 : 1</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Capacidad utilizada</div>
    <div class="kpi-value" id="kpi-capacity">78.9%</div>
    <div class="kpi-sub negative">▼ desde 94.3% en 2020-21</div>
  </div>
</div>

<!-- Main content -->
<div class="main">

  <!-- Section 1: Enrollment trend -->
  <div class="section">
    <div class="chart-card">
      <h3>Tendencia de matrícula total</h3>
      <p class="chart-desc">Evolución del número de estudiantes desde 2020-2021. La línea punteada marca la capacidad instalada (560).</p>
      <div class="chart-wrapper" style="height: 320px;">
        <canvas id="chartEnrollment"></canvas>
      </div>
      <div class="insight">
        <strong>Dato clave:</strong> Se han perdido <strong>86 estudiantes</strong> desde el pico de 528 en 2020-2021, equivalente a una caída del <strong>16.3%</strong> de la matrícula.
      </div>
    </div>
  </div>

  <!-- Section 2: Financial impact -->
  <div class="section">
    <div class="chart-card">
      <h3>Impacto financiero por disminución de estudiantes</h3>
      <p class="chart-desc">Ingresos anuales dejados de percibir por pérdida de estudiantes, desglosados por grado.</p>

      <div class="toggle-group">
        <button class="toggle-btn active" onclick="toggleFinancialView('prev')">vs Año anterior</button>
        <button class="toggle-btn" onclick="toggleFinancialView('peak')">vs Año pico (528)</button>
      </div>

      <div class="chart-wrapper" style="height: 380px;">
        <canvas id="chartFinancial"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <h3>Pérdida acumulada por año</h3>
      <p class="chart-desc">Suma acumulada de ingresos no percibidos año tras año.</p>
      <div class="toggle-group">
        <button class="toggle-btn active" onclick="toggleCumulativeView('prev')">vs Año anterior</button>
        <button class="toggle-btn" onclick="toggleCumulativeView('peak')">vs Año pico</button>
      </div>
      <div class="chart-wrapper" style="height: 300px;">
        <canvas id="chartCumulative"></canvas>
      </div>
    </div>
  </div>

  <!-- Section 3: Ratio -->
  <div class="section">
    <div class="grid-2">
      <div class="chart-card">
        <h3>Ratio estudiantes por profesor / equipo pedagógico</h3>
        <p class="chart-desc">Evolución de la relación estudiantes/profesor (solo docentes de aula) y estudiantes/equipo pedagógico completo, vs benchmarks internacionales.</p>
        <div class="chart-wrapper" style="height: 280px;">
          <canvas id="chartRatio"></canvas>
        </div>
        <div class="insight">
          <strong>Alerta:</strong> Incluso midiendo solo profesores de aula, el ratio de <strong>7.6:1</strong> está por debajo de Grecia (8:1), el más alto de la OCDE. Si se incluye el equipo pedagógico completo (psicólogos, pedagogos, etc.), baja a <strong>6.8:1</strong>. Ambos están muy lejos del promedio de colegios privados en Colombia (14:1).
        </div>
      </div>

      <div class="chart-card">
        <h3>Estudiantes por grado — Actual vs Capacidad</h3>
        <p class="chart-desc">Cada grado tiene capacidad para 40 estudiantes.</p>
        <div class="chart-wrapper" style="height: 280px;">
          <canvas id="chartGrades"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Section 4: Detail table -->
  <div class="section">
    <div class="chart-card">
      <h3>Detalle de matrícula por grado y año</h3>
      <p class="chart-desc">Cifras reales de estudiantes. Se resaltan en rojo los grados con más de 5 estudiantes perdidos vs año anterior.</p>
      <div style="overflow-x: auto;">
        <table class="data-table" id="detailTable"></table>
      </div>
    </div>
  </div>

</div>

<div class="footer">
  Colegio Tilatá · Dashboard de análisis financiero · Datos actualizados al año académico 2025-2026
</div>

<script>
// ═══════════════════════════════════════════
// DATA
// ═══════════════════════════════════════════
const years = ['2020-2021','2021-2022','2022-2023','2023-2024','2024-2025','2025-2026'];
const grades = ['Pre Jardín','Jardín','Transición','1°','2°','3°','4°','5°','6°','7°','8°','9°','10°','11°'];

const students = [
  [27,26,33,33,17,11],   // Pre Jardín
  [47,32,28,31,35,23],   // Jardín
  [41,41,35,29,32,34],   // Transición
  [25,43,38,36,27,33],   // 1°
  [46,24,41,40,31,30],   // 2°
  [34,43,27,32,41,30],   // 3°
  [38,33,43,27,35,45],   // 4°
  [35,39,41,42,26,37],   // 5°
  [40,28,36,40,47,27],   // 6°
  [45,43,29,35,39,42],   // 7°
  [31,43,47,28,36,40],   // 8°
  [42,35,39,45,21,40],   // 9°
  [37,39,31,32,32,21],   // 10°
  [40,35,35,30,29,32],   // 11°
];

const cea = [
  [31047146,35115000,37924200,44750556,52349200,57584120],
  [30383866,32081012,37042814,42319611,50559183,57112977],
  [29882119,31395645,34333534,41923849,47812701,55160067],
  [29145300,30877189,33600045,38857575,47808274,52163657],
  [29057302,30115834,33045189,38027437,44311623,52158827],
  [28224061,30024911,32230378,37399466,43364965,48343980],
  [27984424,29163922,32133067,36477290,42648853,47311177],
  [28256116,28916301,31211622,36367157,41597239,46529898],
  [29386362,29197044,30946622,35324295,41471647,45382587],
  [28562441,30364933,31247077,35024377,40282412,45245566],
  [28162037,29513567,32496956,35364418,39940395,43948111],
  [27383362,29099833,31585822,36778996,40328162,43574970],
  [27129814,28295233,31143034,35747805,41941291,43998025],
  [25701933,28033234,30281934,35246671,40765361,45757948],
];

const totalStudents = years.map((_, yi) => students.reduce((s, g) => s + g[yi], 0));
totalStudents[5] = 442; // Dato real actualizado
const capacity = 560;
const educators = [71, 71, 71, 71, 71, 65]; // Total equipo pedagógico (profesores + psicólogos + pedagogos, etc.)
const teachers = [71, 71, 71, 71, 71, 58];  // Solo profesores de aula

// ═══════════════════════════════════════════
// CALCULATIONS
// ═══════════════════════════════════════════

// Financial impact vs previous year
function calcImpactVsPrev() {
  const impactByGrade = grades.map((_, gi) => {
    return years.map((_, yi) => {
      if (yi === 0) return 0;
      const diff = students[gi][yi - 1] - students[gi][yi];
      return diff > 0 ? diff * cea[gi][yi] : 0;
    });
  });
  return impactByGrade;
}

// Financial impact vs peak
function calcImpactVsPeak() {
  const impactByGrade = grades.map((_, gi) => {
    return years.map((_, yi) => {
      const peak = Math.max(...students[gi].slice(0, yi + 1));
      const diff = peak - students[gi][yi];
      return diff > 0 ? diff * cea[gi][yi] : 0;
    });
  });
  return impactByGrade;
}

function yearTotals(impactByGrade) {
  return years.map((_, yi) => impactByGrade.reduce((s, g) => s + g[yi], 0));
}

function cumulative(totals) {
  let cum = [];
  let running = 0;
  totals.forEach(v => { running += v; cum.push(running); });
  return cum;
}

const impactPrev = calcImpactVsPrev();
const impactPeak = calcImpactVsPeak();

const totalsPrev = yearTotals(impactPrev);
const totalsPeak = yearTotals(impactPeak);

const cumPrev = cumulative(totalsPrev);
const cumPeak = cumulative(totalsPeak);

// Update KPIs
function formatCOP(val) {
  if (val >= 1e9) return '$' + (val / 1e9).toFixed(1) + ' MM';
  if (val >= 1e6) return '$' + (val / 1e6).toFixed(0) + ' M';
  return '$' + val.toLocaleString('es-CO');
}

document.getElementById('kpi-lost-revenue').textContent = formatCOP(cumPeak[cumPeak.length - 1]);
document.getElementById('kpi-ratio').textContent = (totalStudents[5] / teachers[5]).toFixed(1) + ' : 1';
document.getElementById('kpi-capacity').textContent = (totalStudents[5] / capacity * 100).toFixed(1) + '%';

// ═══════════════════════════════════════════
// CHART DEFAULTS
// ═══════════════════════════════════════════
Chart.defaults.font.family = "'DM Sans', sans-serif";
Chart.defaults.font.size = 12;
Chart.defaults.color = '#6b7280';
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.pointStyleWidth = 8;

const gradeColors = [
  '#1b365d','#2a4f7f','#3d6da3','#5488b8','#6fa3cc',
  '#c8553d','#d4724a','#e09060','#e8a87c','#f0c09a',
  '#3a7d44','#5a9a5c','#7ab776','#d4a843'
];

// ═══════════════════════════════════════════
// CHART 1: Enrollment Trend
// ═══════════════════════════════════════════
new Chart(document.getElementById('chartEnrollment'), {
  type: 'line',
  data: {
    labels: years,
    datasets: [
      {
        label: 'Estudiantes',
        data: totalStudents,
        borderColor: '#1b365d',
        backgroundColor: 'rgba(27,54,93,0.08)',
        fill: true,
        tension: 0.3,
        pointRadius: 6,
        pointHoverRadius: 9,
        pointBackgroundColor: '#1b365d',
        borderWidth: 3,
      },
      {
        label: 'Capacidad (560)',
        data: Array(6).fill(560),
        borderColor: '#d4a843',
        borderDash: [8, 4],
        borderWidth: 2,
        pointRadius: 0,
        fill: false,
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'top', align: 'end' },
      tooltip: {
        backgroundColor: '#1b365d',
        titleFont: { weight: '600' },
        callbacks: {
          afterLabel: function(ctx) {
            if (ctx.datasetIndex === 0) {
              const pct = (ctx.raw / 560 * 100).toFixed(1);
              return `Capacidad utilizada: ${pct}%`;
            }
          }
        }
      }
    },
    scales: {
      y: {
        beginAtZero: false,
        min: 400,
        max: 580,
        grid: { color: 'rgba(0,0,0,0.04)' },
        ticks: { stepSize: 20 }
      },
      x: { grid: { display: false } }
    }
  }
});

// ═══════════════════════════════════════════
// CHART 2: Financial Impact (Stacked Bar)
// ═══════════════════════════════════════════
let chartFinancial;
function buildFinancialChart(mode) {
  const data = mode === 'prev' ? impactPrev : impactPeak;
  if (chartFinancial) chartFinancial.destroy();

  // Only include grades with some impact
  const datasetsData = grades.map((g, gi) => ({
    label: g,
    data: data[gi],
    backgroundColor: gradeColors[gi],
    borderWidth: 0,
    borderRadius: 2,
  })).filter(ds => ds.data.some(v => v > 0));

  chartFinancial = new Chart(document.getElementById('chartFinancial'), {
    type: 'bar',
    data: { labels: years, datasets: datasetsData },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { font: { size: 10 }, padding: 12 }
        },
        tooltip: {
          backgroundColor: '#1b365d',
          callbacks: {
            label: ctx => ctx.dataset.label + ': $' + (ctx.raw / 1e6).toFixed(1) + 'M'
          }
        }
      },
      scales: {
        x: { stacked: true, grid: { display: false } },
        y: {
          stacked: true,
          grid: { color: 'rgba(0,0,0,0.04)' },
          ticks: {
            callback: v => '$' + (v / 1e9).toFixed(1) + 'MM'
          }
        }
      }
    }
  });
}

function toggleFinancialView(mode) {
  buildFinancialChart(mode);
}

// Fix toggle selector
document.querySelectorAll('.toggle-group').forEach(group => {
  group.addEventListener('click', e => {
    if (e.target.classList.contains('toggle-btn')) {
      group.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
    }
  });
});

buildFinancialChart('prev');

// ═══════════════════════════════════════════
// CHART 3: Cumulative Loss
// ═══════════════════════════════════════════
let chartCumulative;
function buildCumulativeChart(mode) {
  const data = mode === 'prev' ? cumPrev : cumPeak;
  const barData = mode === 'prev' ? totalsPrev : totalsPeak;
  if (chartCumulative) chartCumulative.destroy();

  chartCumulative = new Chart(document.getElementById('chartCumulative'), {
    type: 'bar',
    data: {
      labels: years,
      datasets: [
        {
          type: 'bar',
          label: 'Pérdida del año',
          data: barData,
          backgroundColor: 'rgba(200,85,61,0.2)',
          borderColor: '#c8553d',
          borderWidth: 1,
          borderRadius: 4,
          order: 2,
        },
        {
          type: 'line',
          label: 'Acumulado',
          data: data,
          borderColor: '#c8553d',
          backgroundColor: 'rgba(200,85,61,0.05)',
          fill: true,
          tension: 0.3,
          pointRadius: 5,
          pointBackgroundColor: '#c8553d',
          borderWidth: 3,
          order: 1,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top', align: 'end' },
        tooltip: {
          backgroundColor: '#1b365d',
          callbacks: {
            label: ctx => ctx.dataset.label + ': $' + (ctx.raw / 1e9).toFixed(2) + ' MM'
          }
        }
      },
      scales: {
        y: {
          grid: { color: 'rgba(0,0,0,0.04)' },
          ticks: { callback: v => '$' + (v / 1e9).toFixed(1) + 'MM' }
        },
        x: { grid: { display: false } }
      }
    }
  });
}

function toggleCumulativeView(mode) {
  buildCumulativeChart(mode);
}

buildCumulativeChart('prev');

// ═══════════════════════════════════════════
// CHART 4: Student/Teacher Ratio
// ═══════════════════════════════════════════
const ratiosEducators = totalStudents.map((s, i) => +(s / educators[i]).toFixed(1));
const ratiosTeachers = totalStudents.map((s, i) => +(s / teachers[i]).toFixed(1));

new Chart(document.getElementById('chartRatio'), {
  type: 'line',
  data: {
    labels: years,
    datasets: [
      {
        label: 'Ratio — Solo profesores (58)',
        data: ratiosTeachers,
        borderColor: '#1b365d',
        backgroundColor: 'rgba(27,54,93,0.08)',
        fill: true,
        tension: 0.3,
        pointRadius: 6,
        pointBackgroundColor: '#1b365d',
        borderWidth: 3,
      },
      {
        label: 'Ratio — Equipo pedagógico (65)',
        data: ratiosEducators,
        borderColor: '#5488b8',
        backgroundColor: 'rgba(84,136,184,0.05)',
        fill: false,
        tension: 0.3,
        pointRadius: 5,
        pointBackgroundColor: '#5488b8',
        borderWidth: 2,
        borderDash: [4, 2],
      },
      {
        label: 'Privados Colombia (14:1)',
        data: Array(6).fill(14),
        borderColor: '#c8553d',
        borderDash: [6, 4],
        borderWidth: 2,
        pointRadius: 0,
        fill: false,
      },
      {
        label: 'Promedio OCDE (13:1)',
        data: Array(6).fill(13),
        borderColor: '#d4a843',
        borderDash: [6, 4],
        borderWidth: 2,
        pointRadius: 0,
        fill: false,
      },
      {
        label: 'Grecia — más alto OCDE (8:1)',
        data: Array(6).fill(8),
        borderColor: '#3a7d44',
        borderDash: [6, 4],
        borderWidth: 2,
        pointRadius: 0,
        fill: false,
      },

    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'top', align: 'end', labels: { font: { size: 10 } } },
      tooltip: {
        backgroundColor: '#1b365d',
        callbacks: {
          afterLabel: (ctx) => {
            if (ctx.datasetIndex === 0) {
              return `${totalStudents[ctx.dataIndex]} estudiantes / ${teachers[ctx.dataIndex]} profesores`;
            }
            if (ctx.datasetIndex === 1) {
              return `${totalStudents[ctx.dataIndex]} estudiantes / ${educators[ctx.dataIndex]} educadores`;
            }
          }
        }
      }
    },
    scales: {
      y: {
        min: 5,
        max: 16,
        grid: { color: 'rgba(0,0,0,0.04)' },
        ticks: { callback: v => v + ':1' }
      },
      x: { grid: { display: false } }
    }
  }
});

// ═══════════════════════════════════════════
// CHART 5: Grades bar (current year)
// ═══════════════════════════════════════════
const currentStudents = grades.map((_, gi) => students[gi][5]);

new Chart(document.getElementById('chartGrades'), {
  type: 'bar',
  data: {
    labels: grades,
    datasets: [
      {
        label: 'Estudiantes 2025-26',
        data: currentStudents,
        backgroundColor: currentStudents.map(v => v < 25 ? 'rgba(200,85,61,0.7)' : 'rgba(27,54,93,0.7)'),
        borderRadius: 4,
        borderWidth: 0,
      },
      {
        label: 'Capacidad (40)',
        data: Array(14).fill(40),
        backgroundColor: 'rgba(0,0,0,0.04)',
        borderColor: 'rgba(0,0,0,0.1)',
        borderWidth: 1,
        borderRadius: 4,
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    indexAxis: 'y',
    plugins: {
      legend: { position: 'top', align: 'end', labels: { font: { size: 10 } } },
      tooltip: {
        backgroundColor: '#1b365d',
        callbacks: {
          afterLabel: ctx => {
            if (ctx.datasetIndex === 0) {
              return `Ocupación: ${(ctx.raw / 40 * 100).toFixed(0)}%`;
            }
          }
        }
      }
    },
    scales: {
      x: { max: 50, grid: { color: 'rgba(0,0,0,0.04)' } },
      y: { grid: { display: false } }
    }
  }
});

// ═══════════════════════════════════════════
// TABLE: Detail
// ═══════════════════════════════════════════
function buildTable() {
  const table = document.getElementById('detailTable');
  let html = '<thead><tr><th>Grado</th>';
  years.forEach(y => html += `<th>${y}</th>`);
  html += '<th>Δ Total</th></tr></thead><tbody>';

  grades.forEach((g, gi) => {
    html += `<tr><td>${g}</td>`;
    students[gi].forEach((v, yi) => {
      let cls = '';
      if (yi > 0) {
        const diff = v - students[gi][yi - 1];
        if (diff < -5) cls = 'cell-negative';
        else if (diff > 5) cls = 'cell-positive';
      }
      html += `<td class="${cls}">${v}</td>`;
    });
    const delta = students[gi][5] - students[gi][0];
    const deltaCls = delta < 0 ? 'cell-negative' : delta > 0 ? 'cell-positive' : '';
    html += `<td class="${deltaCls}">${delta > 0 ? '+' : ''}${delta}</td>`;
    html += '</tr>';
  });

  // Totals row
  html += '<tr><td>TOTAL</td>';
  totalStudents.forEach(v => html += `<td>${v}</td>`);
  const totalDelta = totalStudents[5] - totalStudents[0];
  html += `<td class="cell-negative">${totalDelta}</td>`;
  html += '</tr>';

  // Educators row
  html += '<tr style="background:rgba(27,54,93,0.03)"><td>Equipo pedagógico</td>';
  educators.forEach(t => html += `<td>${t}</td>`);
  html += `<td class="cell-negative">-6</td></tr>`;

  // Teachers row
  html += '<tr style="background:rgba(27,54,93,0.03)"><td>    → Solo profesores de aula</td>';
  teachers.forEach(t => html += `<td>${t}</td>`);
  html += `<td class="cell-negative">-13</td></tr>`;

  // Ratio educators row
  html += '<tr style="background:rgba(27,54,93,0.03)"><td>Ratio Est/Eq. pedagógico</td>';
  ratiosEducators.forEach(r => html += `<td>${r}:1</td>`);
  html += '<td></td></tr>';

  // Ratio teachers row
  html += '<tr style="background:rgba(27,54,93,0.05)"><td>Ratio Est/Profesores</td>';
  ratiosTeachers.forEach(r => html += `<td>${r}:1</td>`);
  html += '<td></td></tr>';

  html += '</tbody>';
  table.innerHTML = html;
}

buildTable();
</script>

</body>
</html>
